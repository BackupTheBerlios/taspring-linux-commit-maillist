<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r7601 - Lobby/TASClient
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2011-May/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r7601%20-%20Lobby/TASClient&In-Reply-To=%3C20110501175414.1305B23AEC%40it-l.eu%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="002372.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r7601 - Lobby/TASClient</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r7601%20-%20Lobby/TASClient&In-Reply-To=%3C20110501175414.1305B23AEC%40it-l.eu%3E"
       TITLE="[Taspring-linux-commit] r7601 - Lobby/TASClient">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Sun May  1 19:54:14 CEST 2011</I>
    <P><UL>
        
        <LI>Next message: <A HREF="002372.html">[Taspring-linux-commit] r7602 - Lobby/TASClient
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2371">[ date ]</a>
              <a href="thread.html#2371">[ thread ]</a>
              <a href="subject.html#2371">[ subject ]</a>
              <a href="author.html#2371">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: satirik
Date: 2011-05-01 19:54:13 +0200 (Sun, 01 May 2011)
New Revision: 7601

Modified:
   Lobby/TASClient/BattleFormUnit.dfm
   Lobby/TASClient/BattleFormUnit.pas
   Lobby/TASClient/TASClient.dof
   Lobby/TASClient/TASClient.res
   Lobby/TASClient/Utility.pas
Log:
* setscripttags 1024 bytes length limit bug fixed
* mod options sections display order is kept now

Modified: Lobby/TASClient/BattleFormUnit.dfm
===================================================================
--- Lobby/TASClient/BattleFormUnit.dfm	2011-04-27 19:23:59 UTC (rev 7600)
+++ Lobby/TASClient/BattleFormUnit.dfm	2011-05-01 17:54:13 UTC (rev 7601)
@@ -1,6 +1,6 @@
 object BattleForm: TBattleForm
-  Left = 975
-  Top = 392
+  Left = 733
+  Top = 383
   Width = 923
   Height = 638
   Caption = 'Battle window'
@@ -12759,11 +12759,10 @@
         Align = alClient
         BiDiMode = bdLeftToRight
         ParentBiDiMode = False
-        ActiveTabIndex = 0
+        ActiveTabIndex = 4
         OnActiveTabChange = SpTBXTabControl1ActiveTabChange
         HiddenItems = &lt;&gt;
         object QuickLookTab: TSpTBXTabItem
-          Checked = True
           ImageIndex = 1
           Images = MainForm.ArrowList
           CustomWidth = 40
@@ -12787,76 +12786,9 @@
         object ModTab: TSpTBXTabItem
           Caption = 'Mod options'
           Wrapping = twWrap
+          Checked = True
           CustomWidth = 94
         end
-        object MapTabSheet: TSpTBXTabSheet
-          Left = 0
-          Top = 39
-          Width = 417
-          Height = 234
-          Caption = 'Map options'
-          ImageIndex = -1
-          DesignSize = (
-            417
-            234)
-          TabItem = 'MapTab'
-          object MapOptionsScrollBox: TTntScrollBox
-            Left = 8
-            Top = 48
-            Width = 401
-            Height = 177
-            VertScrollBar.Smooth = True
-            VertScrollBar.Tracking = True
-            Anchors = [akLeft, akTop, akRight, akBottom]
-            BiDiMode = bdLeftToRight
-            BorderStyle = bsNone
-            Color = clBtnFace
-            Ctl3D = False
-            ParentBiDiMode = False
-            ParentBackground = True
-            ParentColor = False
-            ParentCtl3D = False
-            TabOrder = 0
-            OnConstrainedResize = MapOptionsScrollBoxConstrainedResize
-          end
-          object panelMapOptionsDefault: TSpTBXPanel
-            Left = 8
-            Top = 4
-            Width = 402
-            Height = 41
-            Align = alCustom
-            Anchors = [akLeft, akTop, akRight]
-            TabOrder = 1
-            TBXStyleBackground = True
-            object btLoadMapsDefaultMPO: TSpTBXButton
-              Left = 5
-              Top = 8
-              Width = 128
-              Height = 25
-              Caption = 'Load map'#39's default'
-              TabOrder = 2
-              OnClick = btLoadMapsDefaultMPOClick
-            end
-            object btLoadDefaultMPO: TSpTBXButton
-              Left = 137
-              Top = 8
-              Width = 128
-              Height = 25
-              Caption = 'Load default'
-              TabOrder = 0
-              OnClick = btLoadDefaultMPOClick
-            end
-            object btSetAsDefaultMPO: TSpTBXButton
-              Left = 269
-              Top = 8
-              Width = 128
-              Height = 25
-              Caption = 'Set as default'
-              TabOrder = 1
-              OnClick = btSetAsDefaultMPOClick
-            end
-          end
-        end
         object SpTBXTabSheet1: TSpTBXTabSheet
           Left = 0
           Top = 39
@@ -12928,74 +12860,6 @@
             end
           end
         end
-        object ModTabSheet: TSpTBXTabSheet
-          Left = 0
-          Top = 39
-          Width = 417
-          Height = 234
-          Caption = 'Mod options'
-          ImageIndex = -1
-          DesignSize = (
-            417
-            234)
-          TabItem = 'ModTab'
-          object ModOptionsScrollBox: TTntScrollBox
-            Left = 8
-            Top = 48
-            Width = 401
-            Height = 177
-            VertScrollBar.Smooth = True
-            VertScrollBar.Tracking = True
-            Anchors = [akLeft, akTop, akRight, akBottom]
-            BiDiMode = bdLeftToRight
-            BorderStyle = bsNone
-            Color = clBtnFace
-            Ctl3D = False
-            ParentBiDiMode = False
-            ParentBackground = True
-            ParentColor = False
-            ParentCtl3D = False
-            TabOrder = 0
-            OnConstrainedResize = ModOptionsScrollBoxConstrainedResize
-          end
-          object panelModOptionsDefault: TSpTBXPanel
-            Left = 8
-            Top = 4
-            Width = 402
-            Height = 41
-            Align = alCustom
-            Anchors = [akLeft, akTop, akRight]
-            TabOrder = 1
-            TBXStyleBackground = True
-            object btLoadDefaultMDO: TSpTBXButton
-              Left = 137
-              Top = 8
-              Width = 128
-              Height = 25
-              Caption = 'Load default'
-              TabOrder = 0
-              OnClick = btLoadDefaultMDOClick
-            end
-            object btSetAsDefaultMDO: TSpTBXButton
-              Left = 269
-              Top = 8
-              Width = 128
-              Height = 25
-              Caption = 'Set as default'
-              TabOrder = 1
-              OnClick = btSetAsDefaultMDOClick
-            end
-            object btLoadModsDefaultMDO: TSpTBXButton
-              Left = 5
-              Top = 8
-              Width = 128
-              Height = 25
-              Caption = 'Load mod'#39's default'
-              TabOrder = 2
-              OnClick = btLoadModsDefaultMDOClick
-            end
-          end
-        end
         object SpTBXTabSheet2: TSpTBXTabSheet
           Left = 0
           Top = 39
@@ -13212,6 +13076,142 @@
             OnMouseMove = QuickLookRichEditMouseMove
           end
         end
+        object MapTabSheet: TSpTBXTabSheet
+          Left = 0
+          Top = 39
+          Width = 417
+          Height = 234
+          Caption = 'Map options'
+          ImageIndex = -1
+          DesignSize = (
+            417
+            234)
+          TabItem = 'MapTab'
+          object MapOptionsScrollBox: TTntScrollBox
+            Left = 8
+            Top = 48
+            Width = 401
+            Height = 177
+            VertScrollBar.Smooth = True
+            VertScrollBar.Tracking = True
+            Anchors = [akLeft, akTop, akRight, akBottom]
+            BiDiMode = bdLeftToRight
+            BorderStyle = bsNone
+            Color = clBtnFace
+            Ctl3D = False
+            ParentBiDiMode = False
+            ParentBackground = True
+            ParentColor = False
+            ParentCtl3D = False
+            TabOrder = 0
+            OnConstrainedResize = MapOptionsScrollBoxConstrainedResize
+          end
+          object panelMapOptionsDefault: TSpTBXPanel
+            Left = 8
+            Top = 4
+            Width = 402
+            Height = 41
+            Align = alCustom
+            Anchors = [akLeft, akTop, akRight]
+            TabOrder = 1
+            TBXStyleBackground = True
+            object btLoadMapsDefaultMPO: TSpTBXButton
+              Left = 5
+              Top = 8
+              Width = 128
+              Height = 25
+              Caption = 'Load map'#39's default'
+              TabOrder = 2
+              OnClick = btLoadMapsDefaultMPOClick
+            end
+            object btLoadDefaultMPO: TSpTBXButton
+              Left = 137
+              Top = 8
+              Width = 128
+              Height = 25
+              Caption = 'Load default'
+              TabOrder = 0
+              OnClick = btLoadDefaultMPOClick
+            end
+            object btSetAsDefaultMPO: TSpTBXButton
+              Left = 269
+              Top = 8
+              Width = 128
+              Height = 25
+              Caption = 'Set as default'
+              TabOrder = 1
+              OnClick = btSetAsDefaultMPOClick
+            end
+          end
+        end
+        object ModTabSheet: TSpTBXTabSheet
+          Left = 0
+          Top = 39
+          Width = 417
+          Height = 234
+          Caption = 'Mod options'
+          ImageIndex = -1
+          DesignSize = (
+            417
+            234)
+          TabItem = 'ModTab'
+          object ModOptionsScrollBox: TTntScrollBox
+            Left = 8
+            Top = 48
+            Width = 401
+            Height = 177
+            VertScrollBar.Smooth = True
+            VertScrollBar.Tracking = True
+            Anchors = [akLeft, akTop, akRight, akBottom]
+            BiDiMode = bdLeftToRight
+            BorderStyle = bsNone
+            Color = clBtnFace
+            Ctl3D = False
+            ParentBiDiMode = False
+            ParentBackground = True
+            ParentColor = False
+            ParentCtl3D = False
+            TabOrder = 0
+            OnConstrainedResize = ModOptionsScrollBoxConstrainedResize
+          end
+          object panelModOptionsDefault: TSpTBXPanel
+            Left = 8
+            Top = 4
+            Width = 402
+            Height = 41
+            Align = alCustom
+            Anchors = [akLeft, akTop, akRight]
+            TabOrder = 1
+            TBXStyleBackground = True
+            object btLoadDefaultMDO: TSpTBXButton
+              Left = 137
+              Top = 8
+              Width = 128
+              Height = 25
+              Caption = 'Load default'
+              TabOrder = 0
+              OnClick = btLoadDefaultMDOClick
+            end
+            object btSetAsDefaultMDO: TSpTBXButton
+              Left = 269
+              Top = 8
+              Width = 128
+              Height = 25
+              Caption = 'Set as default'
+              TabOrder = 1
+              OnClick = btSetAsDefaultMDOClick
+            end
+            object btLoadModsDefaultMDO: TSpTBXButton
+              Left = 5
+              Top = 8
+              Width = 128
+              Height = 25
+              Caption = 'Load mod'#39's default'
+              TabOrder = 2
+              OnClick = btLoadModsDefaultMDOClick
+            end
+          end
+        end
       end
     end
   end

Modified: Lobby/TASClient/BattleFormUnit.pas
===================================================================
--- Lobby/TASClient/BattleFormUnit.pas	2011-04-27 19:23:59 UTC (rev 7600)
+++ Lobby/TASClient/BattleFormUnit.pas	2011-05-01 17:54:13 UTC (rev 7601)
@@ -6118,6 +6118,7 @@
 var
   i: Integer;
   s: string;
+  sBefore: string;
 begin
   if not (BattleState.Status = Hosting) then Exit;
   if not AllowBattleDetailsUpdate then Exit;
@@ -6127,20 +6128,33 @@
   for i:=0 to ModOptionsList.Count -1 do
     if TLuaOption(ModOptionsList[i]).ClassType &lt;&gt; TLuaOptionSection then
     begin
+      sBefore := s;
       if s &lt;&gt; '' then
         s := s + #9;
       s := s+TLuaOption(ModOptionsList[i]).toSetScriptTagsString;
+      if Length(s)+15 &gt;= 1024 then
+      begin
+        MainForm.TryToSendCommand('SETSCRIPTTAGS', sBefore);
+        s := TLuaOption(ModOptionsList[i]).toSetScriptTagsString;
+      end;
     end;
 
   for i:=0 to MapOptionsList.Count -1 do
     if TLuaOption(MapOptionsList[i]).ClassType &lt;&gt; TLuaOptionSection then
     begin
+      sBefore := s;
       if s &lt;&gt; '' then
         s := s + #9;
       s := s+TLuaOption(MapOptionsList[i]).toSetScriptTagsString;
+      if Length(s)+15 &gt;= 1024 then
+      begin
+        MainForm.TryToSendCommand('SETSCRIPTTAGS', sBefore);
+        s := TLuaOption(MapOptionsList[i]).toSetScriptTagsString;
+      end;
     end;
 
-  MainForm.TryToSendCommand('SETSCRIPTTAGS', s);
+  if Length(s) &gt; 0 then
+    MainForm.TryToSendCommand('SETSCRIPTTAGS', s);
 end;
 
 procedure TBattleForm.FormResize(Sender: TObject);

Modified: Lobby/TASClient/TASClient.dof
===================================================================
--- Lobby/TASClient/TASClient.dof	2011-04-27 19:23:59 UTC (rev 7600)
+++ Lobby/TASClient/TASClient.dof	2011-05-01 17:54:13 UTC (rev 7601)
@@ -115,7 +115,7 @@
 MajorVer=0
 MinorVer=88
 Release=0
-Build=1286
+Build=1292
 Debug=0
 PreRelease=0
 Special=0
@@ -126,7 +126,7 @@
 [Version Info Keys]
 CompanyName=
 FileDescription=Spring RTS Engine lobby client
-FileVersion=0.88.0.1286
+FileVersion=0.88.0.1292
 InternalName=
 LegalCopyright=
 LegalTrademarks=

Modified: Lobby/TASClient/TASClient.res
===================================================================
(Binary files differ)

Modified: Lobby/TASClient/Utility.pas
===================================================================
--- Lobby/TASClient/Utility.pas	2011-04-27 19:23:59 UTC (rev 7600)
+++ Lobby/TASClient/Utility.pas	2011-05-01 17:54:13 UTC (rev 7601)
@@ -55,6 +55,8 @@
     function GetSectionPanel(luaOptionList: TList): TSpTBXGroupBox;
 
   public
+    Index: integer;
+    SectionIndex: integer; // this index doesn't match the TLuaOptionSection.Index, it's is just used to sort the lua options and keep the right sections order
     Value: String;
     DefaultValue: String;
     KeyPrefix: String;
@@ -967,6 +969,7 @@
   defaultSection^.Description := '';
   defaultSection^.Section := '';
   defaultSection^.hasChanged := False;
+  defaultSection^.Index := -1;
   addDefaultSection := false;
 
   for i:=0 to nb-1 do
@@ -1122,15 +1125,25 @@
     end;
     o^.hasChanged := False;
     o^.KeyPrefix := keyPrefix;
+    o^.Index := i;
+    o^.SectionIndex := -2;
     list.Add(o^);
   end;
 
   for i:=0 to list.Count-1 do
-    if not (TLuaOption(list[i]) is TLuaOptionSection) and (sections.IndexOf(LowerCase(TLuaOption(list[i]).Section)) = -1) then
+  begin
+    if not (TLuaOption(list[i]) is TLuaOptionSection) then
     begin
-      TLuaOption(list[i]).Section := '__defaultSection__';
-      addDefaultSection := true;
-    end;
+      if (sections.IndexOf(LowerCase(TLuaOption(list[i]).Section)) = -1) then
+      begin
+        TLuaOption(list[i]).Section := '__defaultSection__';
+        addDefaultSection := true;
+      end;
+      TLuaOption(list[i]).SectionIndex := sections.IndexOf(LowerCase(TLuaOption(list[i]).Section));
+    end
+    else
+      TLuaOption(list[i]).SectionIndex := sections.IndexOf(LowerCase(TLuaOption(list[i]).Key));
+  end;
 
   if addDefaultSection then
     list.Add(defaultSection^);
@@ -1141,24 +1154,13 @@
 
 function LuaOptionCompare(Item1, Item2: Pointer): Integer;
 var
-  str1,str2: string;
   isSection1,isSection2: Boolean;
 begin
   isSection1 := TLuaOption(Item1) is TLuaOptionSection;
   isSection2 := TLuaOption(Item2) is TLuaOptionSection;
 
-  if isSection1 then
-    str1 := TLuaOption(Item1).Key
-  else
-    str1 := TLuaOption(Item1).Section;
+  Result := CompareValue(TLuaOption(Item1).SectionIndex,TLuaOption(Item2).SectionIndex);
 
-  if isSection2 then
-    str2 := TLuaOption(Item2).Key
-  else
-    str2 := TLuaOption(Item2).Section;
-
-  Result := AnsiCompareStr(LowerCase(str1),LowerCase(str2));
-
   if (Result = 0) and (isSection1 &lt;&gt; isSection2) then
     if isSection1 then
     begin
@@ -1855,7 +1857,7 @@
   else
   begin
     InputEdit.Text := FloatToStr(Round(StrToFloat(InputEdit.Text) / StepValue)*StepValue);
-    inherited toSetScriptTagsString;
+    Result := inherited toSetScriptTagsString;
   end;
 end;
 


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message: <A HREF="002372.html">[Taspring-linux-commit] r7602 - Lobby/TASClient
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2371">[ date ]</a>
              <a href="thread.html#2371">[ thread ]</a>
              <a href="subject.html#2371">[ subject ]</a>
              <a href="author.html#2371">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
