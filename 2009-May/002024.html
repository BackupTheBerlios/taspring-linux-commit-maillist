<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r7255 - Lobby/TASClient
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2009-May/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r7255%20-%20Lobby/TASClient&In-Reply-To=%3C20090528211657.69AD83B6F0%40it-l.eu%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002022.html">
   <LINK REL="Next"  HREF="002025.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r7255 - Lobby/TASClient</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r7255%20-%20Lobby/TASClient&In-Reply-To=%3C20090528211657.69AD83B6F0%40it-l.eu%3E"
       TITLE="[Taspring-linux-commit] r7255 - Lobby/TASClient">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Thu May 28 23:16:57 CEST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="002022.html">[Taspring-linux-commit] r7254 - site/trunk/wwwroot/includes
</A></li>
        <LI>Next message: <A HREF="002025.html">[Taspring-linux-commit] r7256 - Lobby/TASClient
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2024">[ date ]</a>
              <a href="thread.html#2024">[ thread ]</a>
              <a href="subject.html#2024">[ subject ]</a>
              <a href="author.html#2024">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: satirik
Date: 2009-05-28 23:16:55 +0200 (Thu, 28 May 2009)
New Revision: 7255

Added:
   Lobby/TASClient/AutoJoinFormUnit.dfm
   Lobby/TASClient/AutoJoinFormUnit.pas
Modified:
   Lobby/TASClient/AddBotUnit.dfm
   Lobby/TASClient/AddBotUnit.pas
   Lobby/TASClient/BattleFormUnit.dfm
   Lobby/TASClient/BattleFormUnit.pas
   Lobby/TASClient/CustomizeGUIFormUnit.dfm
   Lobby/TASClient/CustomizeGUIFormUnit.pas
   Lobby/TASClient/HostBattleFormUnit.dfm
   Lobby/TASClient/HostBattleFormUnit.pas
   Lobby/TASClient/HttpGetUnit.dfm
   Lobby/TASClient/HttpGetUnit.pas
   Lobby/TASClient/LobbyScriptUnit.pas
   Lobby/TASClient/LogonFormUnit.dfm
   Lobby/TASClient/MainUnit.dfm
   Lobby/TASClient/MainUnit.pas
   Lobby/TASClient/MapListFormUnit.dfm
   Lobby/TASClient/MapListFormUnit.pas
   Lobby/TASClient/MenuFormUnit.pas
   Lobby/TASClient/Misc.pas
   Lobby/TASClient/PreferencesFormUnit.dfm
   Lobby/TASClient/PreferencesFormUnit.pas
   Lobby/TASClient/PythonScriptDebugFormUnit.pas
   Lobby/TASClient/ReplaysUnit.dfm
   Lobby/TASClient/ReplaysUnit.pas
   Lobby/TASClient/SpringDownloaderFormUnit.dfm
   Lobby/TASClient/SpringDownloaderFormUnit.pas
   Lobby/TASClient/SpringSettingsProfileFormUnit.dfm
   Lobby/TASClient/SpringSettingsProfileFormUnit.pas
   Lobby/TASClient/TASClient.dof
   Lobby/TASClient/TASClient.dpr
   Lobby/TASClient/TASClient.res
   Lobby/TASClient/Utility.pas
Log:
- new AI system added (ai options not supported yet) for both multiplayer and sp
- new quick join button with options to customize it
- translation selection added (in \lobby\locale\... )
- PYTHON : new calls in : onDownloadModStart(formName,modHash,modName) and  onDownloadMapStart(formName,mapHash,mapName)
- if choose in game picked, all the boxes are written in the script (for KoH style games)
- autolock on start option added to battle admin menu
- zoomedminimap size increased
- PYTHON : boxes added to the currentbattle dict
- mod/map options added to the replay filters
- sprinddownloader form width increased
- minimap interpolation fix removed
- new button to reset the players filter
- buttons width increase in main forms for non english languages
- disable news option added
- sort by average wind added to map list
- average wind added to the battle form map infos
- map options not written correctly bug fixed
- endless looping connections bug fixed

Modified: Lobby/TASClient/AddBotUnit.dfm
===================================================================
--- Lobby/TASClient/AddBotUnit.dfm	2009-05-28 11:37:21 UTC (rev 7254)
+++ Lobby/TASClient/AddBotUnit.dfm	2009-05-28 21:16:55 UTC (rev 7255)
@@ -1,13 +1,13 @@
 object AddBotForm: TAddBotForm
-  Left = 998
-  Top = 312
+  Left = 416
+  Top = 165
   BorderStyle = bsDialog
   Caption = 'Add bot dialog'
-  ClientHeight = 246
-  ClientWidth = 258
+  ClientHeight = 335
+  ClientWidth = 372
   Color = clBtnFace
-  Constraints.MaxHeight = 1000
-  Constraints.MaxWidth = 1680
+  Constraints.MaxHeight = 750
+  Constraints.MaxWidth = 1280
   Font.Charset = DEFAULT_CHARSET
   Font.Color = clWindowText
   Font.Height = -11
@@ -23,19 +23,22 @@
   object SpTBXTitleBar1: TSpTBXTitleBar
     Left = 0
     Top = 0
-    Width = 258
-    Height = 246
+    Width = 372
+    Height = 335
     Caption = 'Add bot dialog'
     FixedSize = True
     Options.Minimize = False
     Options.Maximize = False
     TBXStyleBackground = True
+    DesignSize = (
+      372
+      335)
     object Label1: TSpTBXLabel
       Left = 16
       Top = 40
-      Width = 65
+      Width = 67
       Height = 13
-      Caption = 'Choose AI dll:'
+      Caption = 'Choose an AI:'
       LinkFont.Charset = DEFAULT_CHARSET
       LinkFont.Color = clBlue
       LinkFont.Height = -11
@@ -43,11 +46,12 @@
       LinkFont.Style = [fsUnderline]
     end
     object ReloadButton: TSpTBXSpeedButton
-      Left = 168
-      Top = 56
+      Left = 283
+      Top = 32
       Width = 73
       Height = 22
       Caption = 'Reload'
+      Anchors = [akTop, akRight]
       OnClick = ReloadButtonClick
       LinkFont.Charset = DEFAULT_CHARSET
       LinkFont.Color = clBlue
@@ -56,11 +60,12 @@
       LinkFont.Style = [fsUnderline]
     end
     object Label2: TSpTBXLabel
-      Left = 16
-      Top = 96
+      Left = 24
+      Top = 205
       Width = 55
       Height = 13
       Caption = 'Bot'#39's name:'
+      Anchors = [akLeft, akBottom]
       LinkFont.Charset = DEFAULT_CHARSET
       LinkFont.Color = clBlue
       LinkFont.Height = -11
@@ -68,11 +73,12 @@
       LinkFont.Style = [fsUnderline]
     end
     object BotTeamColorButton: TSpTBXSpeedButton
-      Left = 136
-      Top = 160
+      Left = 128
+      Top = 267
       Width = 105
       Height = 21
       Caption = 'Team color'
+      Anchors = [akLeft, akBottom]
       OnClick = BotTeamColorButtonClick
       Images = MainForm.ColorImageList
       LinkFont.Charset = DEFAULT_CHARSET
@@ -82,11 +88,12 @@
       LinkFont.Style = [fsUnderline]
     end
     object Label3: TSpTBXLabel
-      Left = 16
-      Top = 136
+      Left = 24
+      Top = 243
       Width = 15
       Height = 13
       Caption = 'Id :'
+      Anchors = [akLeft, akBottom]
       LinkFont.Charset = DEFAULT_CHARSET
       LinkFont.Color = clBlue
       LinkFont.Height = -11
@@ -94,34 +101,27 @@
       LinkFont.Style = [fsUnderline]
     end
     object Label4: TSpTBXLabel
-      Left = 16
-      Top = 160
+      Left = 24
+      Top = 267
       Width = 33
       Height = 13
       Caption = 'Team :'
+      Anchors = [akLeft, akBottom]
       LinkFont.Charset = DEFAULT_CHARSET
       LinkFont.Color = clBlue
       LinkFont.Height = -11
       LinkFont.Name = 'MS Sans Serif'
       LinkFont.Style = [fsUnderline]
     end
-    object AIComboBox: TSpTBXComboBox
-      Left = 16
-      Top = 56
-      Width = 145
-      Height = 21
-      Style = csDropDownList
-      ItemHeight = 13
-      TabOrder = 6
-    end
     object AddBotButton: TSpTBXButton
-      Left = 40
-      Top = 208
+      Left = 203
+      Top = 299
       Width = 75
       Height = 25
       Caption = 'Add bot'
+      Anchors = [akRight, akBottom]
       Enabled = False
-      TabOrder = 7
+      TabOrder = 6
       OnClick = AddBotButtonClick
       LinkFont.Charset = DEFAULT_CHARSET
       LinkFont.Color = clBlue
@@ -130,12 +130,13 @@
       LinkFont.Style = [fsUnderline]
     end
     object Button2: TSpTBXButton
-      Left = 144
-      Top = 208
+      Left = 283
+      Top = 299
       Width = 75
       Height = 25
       Caption = 'Cancel'
-      TabOrder = 8
+      Anchors = [akRight, akBottom]
+      TabOrder = 7
       OnClick = Button2Click
       Cancel = True
       LinkFont.Charset = DEFAULT_CHARSET
@@ -145,47 +146,21 @@
       LinkFont.Style = [fsUnderline]
     end
     object BotNameEdit: TSpTBXEdit
-      Left = 88
-      Top = 96
-      Width = 113
+      Left = 96
+      Top = 203
+      Width = 137
       Height = 21
-      TabOrder = 9
+      Anchors = [akLeft, akBottom]
+      TabOrder = 8
       Text = 'Bot'
     end
-    object BotAllyButton: TTBXButton
-      Left = 72
-      Top = 162
-      Width = 41
-      Height = 20
-      AutoSize = False
-      Caption = '1'
-      Images = MainForm.MiscImageList
-      Layout = blGlyphRight
-      ParentShowHint = False
-      ShowHint = False
-      TabOrder = 10
-      OnClick = BotAllyButtonClick
-    end
-    object BotTeamButton: TTBXButton
-      Left = 72
-      Top = 138
-      Width = 41
-      Height = 20
-      AutoSize = False
-      Caption = '1'
-      Images = MainForm.MiscImageList
-      Layout = blGlyphRight
-      ParentShowHint = False
-      ShowHint = False
-      TabOrder = 11
-      OnClick = BotTeamButtonClick
-    end
     object BotSideButton: TSpTBXSpeedButton
-      Left = 136
-      Top = 136
+      Left = 128
+      Top = 243
       Width = 105
       Height = 22
       Caption = 'Side'
+      Anchors = [akLeft, akBottom]
       OnClick = BotSideButtonClick
       LinkFont.Charset = DEFAULT_CHARSET
       LinkFont.Color = clBlue
@@ -193,5 +168,91 @@
       LinkFont.Name = 'MS Sans Serif'
       LinkFont.Style = [fsUnderline]
     end
+    object BotAllyButton: TSpTBXSpinEdit
+      Left = 64
+      Top = 267
+      Width = 49
+      Height = 21
+      Anchors = [akLeft, akBottom]
+      TabOrder = 11
+      MaxValue = 200.000000000000000000
+      MinValue = 1.000000000000000000
+      SpinButton.Left = 30
+      SpinButton.Top = 0
+      SpinButton.Width = 15
+      SpinButton.Height = 17
+      SpinButton.Align = alRight
+      SpinButton.LinkFont.Charset = DEFAULT_CHARSET
+      SpinButton.LinkFont.Color = clBlue
+      SpinButton.LinkFont.Height = -11
+      SpinButton.LinkFont.Name = 'MS Sans Serif'
+      SpinButton.LinkFont.Style = [fsUnderline]
+      Value = 1.000000000000000000
+    end
+    object BotTeamButton: TSpTBXSpinEdit
+      Left = 64
+      Top = 243
+      Width = 49
+      Height = 21
+      Anchors = [akLeft, akBottom]
+      TabOrder = 12
+      MaxValue = 200.000000000000000000
+      MinValue = 1.000000000000000000
+      SpinButton.Left = 30
+      SpinButton.Top = 0
+      SpinButton.Width = 15
+      SpinButton.Height = 17
+      SpinButton.Align = alRight
+      SpinButton.LinkFont.Charset = DEFAULT_CHARSET
+      SpinButton.LinkFont.Color = clBlue
+      SpinButton.LinkFont.Height = -11
+      SpinButton.LinkFont.Name = 'MS Sans Serif'
+      SpinButton.LinkFont.Style = [fsUnderline]
+      Value = 1.000000000000000000
+    end
+    object VSTAIList: TVirtualStringTree
+      Left = 16
+      Top = 56
+      Width = 340
+      Height = 135
+      Anchors = [akLeft, akTop, akRight, akBottom]
+      ButtonStyle = bsTriangle
+      ClipboardFormats.Strings = (
+        'Unicode text')
+      Header.AutoSizeIndex = 0
+      Header.Font.Charset = DEFAULT_CHARSET
+      Header.Font.Color = clWindowText
+      Header.Font.Height = -11
+      Header.Font.Name = 'MS Sans Serif'
+      Header.Font.Style = []
+      Header.MainColumn = -1
+      Header.Options = [hoAutoResize, hoColumnResize, hoDrag, hoShowHint]
+      HintAnimation = hatFade
+      HintMode = hmHint
+      ParentShowHint = False
+      PopupMenu = AIListPopupMenu
+      ShowHint = True
+      TabOrder = 13
+      TreeOptions.AnimationOptions = [toAnimatedToggle]
+      TreeOptions.PaintOptions = [toShowButtons, toShowDropmark, toShowRoot, toShowVertGridLines, toThemeAware, toUseBlendedImages, toFullVertGridLines]
+      TreeOptions.SelectionOptions = [toRightClickSelect]
+      OnGetText = VSTAIListGetText
+      OnGetHint = VSTAIListGetHint
+      Columns = &lt;&gt;
+    end
   end
+  object AIListPopupMenu: TSpTBXPopupMenu
+    OnInitPopup = AIListPopupMenuInitPopup
+    Left = 288
+    Top = 184
+    object mnuCopyItem: TSpTBXItem
+      Caption = 'Copy'
+      OnClick = mnuCopyItemClick
+    end
+    object mnuGotoUrl: TSpTBXItem
+      Caption = 'Goto url'
+      Visible = False
+      OnClick = mnuGotoUrlClick
+    end
+  end
 end

Modified: Lobby/TASClient/AddBotUnit.pas
===================================================================
--- Lobby/TASClient/AddBotUnit.pas	2009-05-28 11:37:21 UTC (rev 7254)
+++ Lobby/TASClient/AddBotUnit.pas	2009-05-28 21:16:55 UTC (rev 7255)
@@ -5,9 +5,18 @@
 uses
   Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
   Dialogs, Buttons, StdCtrls, TBXDkPanels, SpTBXControls, SpTBXEditors,
-  TntStdCtrls, SpTBXItem;
+  TntStdCtrls, SpTBXItem, VirtualTrees, Menus, TB2Item, TBX, Clipbrd;
 
 type
+  TAIItem =
+  record
+    keys: TStringList;
+    values: TStringList;
+    descriptions: TStringList;
+    nodes: TList;
+    mainNode: PVirtualNode;
+  end;
+  PAIItem = ^TAIItem;
   TAddBotForm = class(TForm)
     SpTBXTitleBar1: TSpTBXTitleBar;
     Label1: TSpTBXLabel;
@@ -16,13 +25,16 @@
     BotTeamColorButton: TSpTBXSpeedButton;
     Label3: TSpTBXLabel;
     Label4: TSpTBXLabel;
-    AIComboBox: TSpTBXComboBox;
     AddBotButton: TSpTBXButton;
     Button2: TSpTBXButton;
     BotNameEdit: TSpTBXEdit;
-    BotAllyButton: TTBXButton;
-    BotTeamButton: TTBXButton;
     BotSideButton: TSpTBXSpeedButton;
+    BotAllyButton: TSpTBXSpinEdit;
+    BotTeamButton: TSpTBXSpinEdit;
+    VSTAIList: TVirtualStringTree;
+    AIListPopupMenu: TSpTBXPopupMenu;
+    mnuCopyItem: TSpTBXItem;
+    mnuGotoUrl: TSpTBXItem;
 
     procedure CreateParams(var Params: TCreateParams); override;
 
@@ -38,9 +50,21 @@
     procedure BotAllyButtonClick(Sender: TObject);
     procedure BotSideButtonClick(Sender: TObject);
     procedure FormShow(Sender: TObject);
+    procedure VSTAIListGetText(Sender: TBaseVirtualTree;
+      Node: PVirtualNode; Column: TColumnIndex; TextType: TVSTTextType;
+      var CellText: WideString);
+    procedure VSTAIListGetHint(Sender: TBaseVirtualTree;
+      Node: PVirtualNode; Column: TColumnIndex;
+      var LineBreakStyle: TVTTooltipLineBreakStyle;
+      var HintText: WideString);
+    procedure AIListPopupMenuInitPopup(Sender: TObject;
+      PopupView: TTBView);
+    procedure mnuCopyItemClick(Sender: TObject);
+    procedure mnuGotoUrlClick(Sender: TObject);
   private
   public
-    { Public declarations }
+    aiList: TList;
+    function getSelectedAI: PAIItem;
   end;
 
 var
@@ -49,7 +73,8 @@
 implementation
 
 uses
-  MainUnit, Misc, BattleFormUnit, PreferencesFormUnit, Utility, gnugettext;
+  MainUnit, Misc, BattleFormUnit, PreferencesFormUnit, Utility, gnugettext,
+  StrUtils;
 
 var
   BotColorIndex: Integer;
@@ -70,31 +95,37 @@
 
 procedure TAddBotForm.ReloadButtonClick(Sender: TObject);
 var
-  sr: TSearchRec;
-  FileAttrs: Integer;
-  LuaAiList: TStrings;
+  i,j: integer;
+  newAI : PAIItem;
 begin
-  AIComboBox.Items.Clear;
-  FileAttrs := faAnyFile;
+  VSTAIList.Clear;
+  for i:=0 to aiList.Count-1 do
+  begin
+    PAIItem(aiList[i]).keys.Free;
+    PAIItem(aiList[i]).values.Free;
+    PAIItem(aiList[i]).descriptions.Free;
+    PAIItem(aiList[i]).nodes.Free;
+  end;
+  aiList.Clear;
 
-  if FindFirst(ExtractFilePath(Application.ExeName) + AIDLL_FOLDER+ '/*.dll', FileAttrs, sr) = 0 then
+  for i:=0 to Utility.GetSkirmishAICount-1 do
   begin
-    if (sr.Name &lt;&gt; '.') and (sr.Name &lt;&gt; '..') then
-      AIComboBox.Items.Add(sr.Name);
-
-    while FindNext(sr) = 0 do
-      if (sr.Name &lt;&gt; '.') and (sr.Name &lt;&gt; '..') then
-        AIComboBox.Items.Add(sr.Name);
-
-    FindClose(sr);
+    New(newAI);
+    newAI.nodes := TList.Create;
+    newAI.keys := TStringList.Create;
+    newAI.values := TStringList.Create;
+    newAI.descriptions := TStringList.Create;
+    newAI.mainNode := VSTAIList.AddChild(VSTAIList.RootNode);
+    for j:=0 to Utility.GetSkirmishAIInfoCount(i)-1 do
+    begin
+      newAI.nodes.Add(VSTAIList.AddChild(newAI.mainNode));
+      newAI.keys.Add(Utility.GetInfoKey(j));
+      newAI.values.Add(Utility.GetInfoValue(j));
+      newAI.descriptions.Add(Utility.GetInfoDescription(j));
+    end;
+    aiList.Add(newAI);
   end;
-
-  LuaAiList := GetLuaAIList;
-  if LuaAiList.Count &gt; 0 then
-    AIComboBox.Items.AddStrings(LuaAiList);
-
-  AddBotButton.Enabled := AIComboBox.Items.Count &lt;&gt; 0;
-  if AIComboBox.Items.Count &lt;&gt; 0 then AIComboBox.ItemIndex := 0;
+  AddBotButton.Enabled := aiList.Count &gt; 0;
 end;
 
 procedure TAddBotForm.FormCreate(Sender: TObject);
@@ -105,6 +136,9 @@
     RemoveSpTBXTitleBarMarges(self);
   ChangeTeamColor(0);
   BotSideButton.Images := Utility.SideImageList;
+  BotAllyButton.MaxValue := MAX_TEAMS;
+  BotTeamButton.MaxValue := MAX_TEAMS;
+  aiList := TList.Create;
 end;
 
 procedure TAddBotForm.Button2Click(Sender: TObject);
@@ -116,6 +150,7 @@
 var
   Bot: TBot;
   BattleStatus: Integer;
+  botIdx : integer;
 begin
   if not Misc.VerifyName(BotNameEdit.Text) then
   begin
@@ -125,13 +160,13 @@
 
   Bot := TBot.Create('', '', '');
   Bot.SetSide(BotSideButton.Tag);
-  Bot.SetTeamNo(StrToInt(BotTeamButton.Caption)-1);
-  Bot.SetAllyNo(StrToInt(BotAllyButton.Caption)-1);
+  Bot.SetTeamNo(BotTeamButton.ValueAsInteger-1);
+  Bot.SetAllyNo(BotAllyButton.ValueAsInteger-1);
   Bot.SetHandicap(0);
   BattleStatus := Bot.BattleStatus;
   Bot.Free;
 
-  MainForm.TryToSendCommand('ADDBOT', BotNameEdit.Text + ' ' + IntToStr(BattleStatus) + ' ' + IntToStr(TeamColors[BotColorIndex]) + ' ' + AIComboBox.Text);
+  MainForm.TryToSendCommand('ADDBOT', BotNameEdit.Text + ' ' + IntToStr(BattleStatus) + ' ' + IntToStr(TeamColors[BotColorIndex]) + ' ' + getSelectedAI.values[getSelectedAI.keys.IndexOf('shortname')]);
 
   Close;
 end;
@@ -164,20 +199,20 @@
 var
   Index: Integer;
 begin
-  Index := BattleForm.ChooseNumberDialog(Sender as TControl, StrToInt(BotTeamButton.Caption)-1);
+  Index := BattleForm.ChooseNumberDialog(Sender as TControl, BotTeamButton.ValueAsInteger-1);
   if Index = -1 then Exit;
 
-  BotTeamButton.Caption := IntToStr(Index+1);
+  BotTeamButton.ValueAsInteger := Index+1;
 end;
 
 procedure TAddBotForm.BotAllyButtonClick(Sender: TObject);
 var
   Index: Integer;
 begin
-  Index := BattleForm.ChooseNumberDialog(Sender as TControl, StrToInt(BotAllyButton.Caption)-1);
+  Index := BattleForm.ChooseNumberDialog(Sender as TControl, BotAllyButton.ValueAsInteger-1);
   if Index = -1 then Exit;
 
-  BotAllyButton.Caption := IntToStr(Index+1);
+  BotAllyButton.ValueAsInteger := Index+1;
 end;
 
 procedure TAddBotForm.BotSideButtonClick(Sender: TObject);
@@ -195,4 +230,106 @@
   ReloadButton.OnClick(nil);
 end;
 
+procedure TAddBotForm.VSTAIListGetText(Sender: TBaseVirtualTree;
+  Node: PVirtualNode; Column: TColumnIndex; TextType: TVSTTextType;
+  var CellText: WideString);
+var
+  i,j,k:integer;
+begin
+  CellText := 'Loading ...';
+  for i:=0 to aiList.Count-1 do
+    if PAIItem(aiList[i]).mainNode = Node then
+    begin
+      k := PAIItem(aiList[i]).keys.IndexOf('shortname');
+      CellText := PAIItem(aiList[i]).values[k];
+      k := PAIItem(aiList[i]).keys.IndexOf('name');
+      if k &gt;= 0 then
+        CellText := CellText + ': '+ PAIItem(aiList[i]).values[k];
+      Exit;
+    end
+    else
+      for j:=0 to PAIItem(aiList[i]).nodes.Count-1 do
+        if PAIItem(aiList[i]).nodes[j] = Node then
+        begin
+          CellText := PAIItem(aiList[i]).keys[j] + ' = ' + PAIItem(aiList[i]).values[j];
+          Exit;
+        end;
+end;
+
+function TAddBotForm.getSelectedAI: PAIItem;
+var
+  i,j,k:integer;
+begin
+  Result := nil;
+  for i:=0 to aiList.Count-1 do
+    if PAIItem(aiList[i]).mainNode = VSTAIList.GetFirstSelected then
+    begin
+      Result := aiList[i];
+      Exit;
+    end
+    else
+      for j:=0 to PAIItem(aiList[i]).nodes.Count-1 do
+        if PAIItem(aiList[i]).nodes[j] = VSTAIList.GetFirstSelected then
+        begin
+          Result := aiList[i];
+          Exit;
+        end;
+end;
+
+procedure TAddBotForm.VSTAIListGetHint(Sender: TBaseVirtualTree;
+  Node: PVirtualNode; Column: TColumnIndex;
+  var LineBreakStyle: TVTTooltipLineBreakStyle; var HintText: WideString);
+var
+  i,j,k:integer;
+begin
+  LineBreakStyle :=hlbDefault;
+  HintText := 'Loading ...';
+  for i:=0 to aiList.Count-1 do
+    if PAIItem(aiList[i]).mainNode = Node then
+    begin
+      k := PAIItem(aiList[i]).keys.IndexOf('shortname');
+      HintText := PAIItem(aiList[i]).values[k];
+      k := PAIItem(aiList[i]).keys.IndexOf('name');
+      if k &gt;= 0 then
+        HintText := HintText + ': '+ PAIItem(aiList[i]).values[k];
+      Exit;
+    end
+    else
+      for j:=0 to PAIItem(aiList[i]).nodes.Count-1 do
+        if PAIItem(aiList[i]).nodes[j] = Node then
+        begin
+          HintText := PAIItem(aiList[i]).descriptions[j];
+          Exit;
+        end;
+end;
+
+procedure TAddBotForm.AIListPopupMenuInitPopup(Sender: TObject;
+  PopupView: TTBView);
+var
+  celltxt: WideString;
+  tt: TVSTTextType;
+begin
+  VSTAIListGetText(VSTAIList,VSTAIList.GetFirstSelected,0,tt,celltxt);
+  mnuGotoUrl.Visible := Pos('<A HREF="http://">http://</A>',LowerCase(celltxt)) &gt; 0;
+end;
+
+procedure TAddBotForm.mnuCopyItemClick(Sender: TObject);
+var
+  celltxt: WideString;
+  tt: TVSTTextType;
+begin
+  VSTAIListGetText(VSTAIList,VSTAIList.GetFirstSelected,0,tt,celltxt);
+  Clipboard.AsText := celltxt;
+end;
+
+procedure TAddBotForm.mnuGotoUrlClick(Sender: TObject);
+var
+  celltxt: WideString;
+  tt: TVSTTextType;
+begin
+  VSTAIListGetText(VSTAIList,VSTAIList.GetFirstSelected,0,tt,celltxt);
+  celltxt := MidStr(celltxt,Pos('<A HREF="http://">http://</A>',LowerCase(celltxt)),900000);
+  Misc.OpenURLInDefaultBrowser(celltxt);
+end;
+
 end.

Added: Lobby/TASClient/AutoJoinFormUnit.dfm
===================================================================
--- Lobby/TASClient/AutoJoinFormUnit.dfm	                        (rev 0)
+++ Lobby/TASClient/AutoJoinFormUnit.dfm	2009-05-28 21:16:55 UTC (rev 7255)
@@ -0,0 +1,356 @@
+object AutoJoinForm: TAutoJoinForm
+  Left = 382
+  Top = 205
+  BorderStyle = bsSingle
+  Caption = 'AutoJoin'
+  ClientHeight = 426
+  ClientWidth = 698
+  Color = clBtnFace
+  Constraints.MaxHeight = 750
+  Constraints.MaxWidth = 1280
+  Font.Charset = DEFAULT_CHARSET
+  Font.Color = clWindowText
+  Font.Height = -11
+  Font.Name = 'MS Sans Serif'
+  Font.Style = []
+  OldCreateOrder = False
+  Position = poMainFormCenter
+  OnCreate = FormCreate
+  OnShow = FormShow
+  PixelsPerInch = 96
+  TextHeight = 13
+  object SpTBXTitleBar1: TSpTBXTitleBar
+    Left = 0
+    Top = 0
+    Width = 698
+    Height = 426
+    Caption = 'AutoJoin'
+    FixedSize = True
+    Options.Maximize = False
+    object SpTBXGroupBox1: TSpTBXGroupBox
+      Left = 192
+      Top = 40
+      Width = 497
+      Height = 169
+      Caption = 'Autoplay preset list'
+      TabOrder = 1
+      DesignSize = (
+        497
+        169)
+      object VSTAutoplayPresetList: TVirtualStringTree
+        Left = 8
+        Top = 16
+        Width = 449
+        Height = 145
+        Anchors = [akLeft, akTop, akRight, akBottom]
+        Header.AutoSizeIndex = 0
+        Header.Font.Charset = DEFAULT_CHARSET
+        Header.Font.Color = clWindowText
+        Header.Font.Height = -11
+        Header.Font.Name = 'MS Sans Serif'
+        Header.Font.Style = []
+        Header.Options = [hoColumnResize, hoDrag, hoVisible]
+        Header.Style = hsFlatButtons
+        TabOrder = 0
+        TreeOptions.PaintOptions = [toShowButtons, toShowDropmark, toShowTreeLines, toShowVertGridLines, toThemeAware, toUseBlendedImages, toFullVertGridLines]
+        TreeOptions.SelectionOptions = [toFullRowSelect]
+        OnGetText = VSTAutoplayPresetListGetText
+        Columns = &lt;
+          item
+            Position = 0
+            WideText = 'Priority'
+          end
+          item
+            Position = 1
+            Width = 200
+            WideText = 'Filters preset name'
+          end
+          item
+            Position = 2
+            Width = 100
+            WideText = 'Sorting'
+          end
+          item
+            Position = 3
+            Width = 60
+            WideText = 'Sort. dir.'
+          end&gt;
+      end
+      object btAutoplayPriorityUp: TSpTBXButton
+        Left = 464
+        Top = 16
+        Width = 25
+        Height = 33
+        Anchors = [akTop, akRight]
+        TabOrder = 1
+        OnClick = btAutoplayPriorityUpClick
+        Images = MainForm.ArrowList
+        ImageIndex = 0
+        LinkFont.Charset = DEFAULT_CHARSET
+        LinkFont.Color = clBlue
+        LinkFont.Height = -11
+        LinkFont.Name = 'MS Sans Serif'
+        LinkFont.Style = [fsUnderline]
+      end
+      object btAutoplayPriorityDown: TSpTBXButton
+        Left = 464
+        Top = 56
+        Width = 25
+        Height = 33
+        Anchors = [akTop, akRight]
+        TabOrder = 2
+        OnClick = btAutoplayPriorityDownClick
+        Images = MainForm.ArrowList
+        ImageIndex = 1
+        LinkFont.Charset = DEFAULT_CHARSET
+        LinkFont.Color = clBlue
+        LinkFont.Height = -11
+        LinkFont.Name = 'MS Sans Serif'
+        LinkFont.Style = [fsUnderline]
+      end
+      object btAutoplayRemovePreset: TSpTBXButton
+        Left = 464
+        Top = 136
+        Width = 25
+        Height = 25
+        Caption = 'X'
+        Anchors = [akLeft, akBottom]
+        TabOrder = 3
+        OnClick = btAutoplayRemovePresetClick
+        LinkFont.Charset = DEFAULT_CHARSET
+        LinkFont.Color = clBlue
+        LinkFont.Height = -11
+        LinkFont.Name = 'MS Sans Serif'
+        LinkFont.Style = [fsUnderline]
+      end
+    end
+    object SpTBXGroupBox2: TSpTBXGroupBox
+      Left = 8
+      Top = 40
+      Width = 177
+      Height = 345
+      Caption = 'Add preset'
+      TabOrder = 2
+      object SpTBXLabel1: TSpTBXLabel
+        Left = 8
+        Top = 112
+        Width = 60
+        Height = 13
+        Caption = 'Filter preset :'
+        LinkFont.Charset = DEFAULT_CHARSET
+        LinkFont.Color = clBlue
+        LinkFont.Height = -11
+        LinkFont.Name = 'MS Sans Serif'
+        LinkFont.Style = [fsUnderline]
+      end
+      object cmbFilterPresetList: TSpTBXComboBox
+        Left = 32
+        Top = 128
+        Width = 137
+        Height = 21
+        Style = csDropDownList
+        ItemHeight = 13
+        TabOrder = 1
+      end
+      object SpTBXLabel2: TSpTBXLabel
+        Left = 8
+        Top = 152
+        Width = 39
+        Height = 13
+        Caption = 'Sorting :'
+        LinkFont.Charset = DEFAULT_CHARSET
+        LinkFont.Color = clBlue
+        LinkFont.Height = -11
+        LinkFont.Name = 'MS Sans Serif'
+        LinkFont.Style = [fsUnderline]
+      end
+      object cmbSortingList: TSpTBXComboBox
+        Left = 32
+        Top = 168
+        Width = 137
+        Height = 21
+        Style = csDropDownList
+        ItemHeight = 13
+        ItemIndex = 0
+        TabOrder = 3
+        Text = 'Host'
+        Items.Strings = (
+          'Host'
+          'Map name'
+          'State'
+          'Mod name'
+          'Avg rank'
+          'Players')
+      end
+      object SpTBXLabel3: TSpTBXLabel
+        Left = 8
+        Top = 192
+        Width = 82
+        Height = 13
+        Caption = 'Sorting direction :'
+        LinkFont.Charset = DEFAULT_CHARSET
+        LinkFont.Color = clBlue
+        LinkFont.Height = -11
+        LinkFont.Name = 'MS Sans Serif'
+        LinkFont.Style = [fsUnderline]
+      end
+      object cmbSortDir: TSpTBXComboBox
+        Left = 32
+        Top = 208
+        Width = 137
+        Height = 21
+        Style = csDropDownList
+        ItemHeight = 13
+        ItemIndex = 0
+        TabOrder = 5
+        Text = 'Asc'
+        Items.Strings = (
+          'Asc'
+          'Desc')
+      end
+      object btAddPresetToAutoplay: TSpTBXButton
+        Left = 56
+        Top = 16
+        Width = 113
+        Height = 33
+        Caption = 'Add autoplay'
+        TabOrder = 6
+        OnClick = btAddPresetToAutoplayClick
+        Images = MainForm.MiscImageList
+        ImageIndex = 4
+        LinkFont.Charset = DEFAULT_CHARSET
+        LinkFont.Color = clBlue
+        LinkFont.Height = -11
+        LinkFont.Name = 'MS Sans Serif'
+        LinkFont.Style = [fsUnderline]
+      end
+      object btAddPresetToAutospec: TSpTBXButton
+        Left = 56
+        Top = 304
+        Width = 113
+        Height = 33
+        Caption = 'Add autospec'
+        TabOrder = 7
+        OnClick = btAddPresetToAutospecClick
+        Images = MainForm.MiscImageList
+        ImageIndex = 4
+        LinkFont.Charset = DEFAULT_CHARSET
+        LinkFont.Color = clBlue
+        LinkFont.Height = -11
+        LinkFont.Name = 'MS Sans Serif'
+        LinkFont.Style = [fsUnderline]
+      end
+    end
+    object SpTBXGroupBox3: TSpTBXGroupBox
+      Left = 192
+      Top = 216
+      Width = 497
+      Height = 169
+      Caption = 'Autospec preset list'
+      TabOrder = 3
+      DesignSize = (
+        497
+        169)
+      object VSTAutospecPresetList: TVirtualStringTree
+        Left = 8
+        Top = 16
+        Width = 449
+        Height = 145
+        Anchors = [akLeft, akTop, akRight, akBottom]
+        Header.AutoSizeIndex = 0
+        Header.Font.Charset = DEFAULT_CHARSET
+        Header.Font.Color = clWindowText
+        Header.Font.Height = -11
+        Header.Font.Name = 'MS Sans Serif'
+        Header.Font.Style = []
+        Header.Options = [hoColumnResize, hoDrag, hoVisible]
+        Header.Style = hsFlatButtons
+        TabOrder = 0
+        TreeOptions.PaintOptions = [toShowButtons, toShowDropmark, toShowTreeLines, toShowVertGridLines, toThemeAware, toUseBlendedImages, toFullVertGridLines]
+        TreeOptions.SelectionOptions = [toFullRowSelect]
+        OnGetText = VSTAutospecPresetListGetText
+        Columns = &lt;
+          item
+            Position = 0
+            WideText = 'Priority'
+          end
+          item
+            Position = 1
+            Width = 200
+            WideText = 'Filters preset name'
+          end
+          item
+            Position = 2
+            Width = 100
+            WideText = 'Sorting'
+          end
+          item
+            Position = 3
+            Width = 60
+            WideText = 'Sort. dir.'
+          end&gt;
+      end
+      object btAutospecPriorityUp: TSpTBXButton
+        Left = 464
+        Top = 16
+        Width = 25
+        Height = 33
+        Anchors = [akTop, akRight]
+        TabOrder = 1
+        OnClick = btAutospecPriorityUpClick
+        Images = MainForm.ArrowList
+        ImageIndex = 0
+        LinkFont.Charset = DEFAULT_CHARSET
+        LinkFont.Color = clBlue
+        LinkFont.Height = -11
+        LinkFont.Name = 'MS Sans Serif'
+        LinkFont.Style = [fsUnderline]
+      end
+      object btAutospecPriorityDown: TSpTBXButton
+        Left = 464
+        Top = 56
+        Width = 25
+        Height = 33
+        Anchors = [akTop, akRight]
+        TabOrder = 2
+        OnClick = btAutospecPriorityDownClick
+        Images = MainForm.ArrowList
+        ImageIndex = 1
+        LinkFont.Charset = DEFAULT_CHARSET
+        LinkFont.Color = clBlue
+        LinkFont.Height = -11
+        LinkFont.Name = 'MS Sans Serif'
+        LinkFont.Style = [fsUnderline]
+      end
+      object btAutospecRemovePreset: TSpTBXButton
+        Left = 464
+        Top = 136
+        Width = 25
+        Height = 25
+        Caption = 'X'
+        Anchors = [akLeft, akBottom]
+        TabOrder = 3
+        OnClick = btAutospecRemovePresetClick
+        LinkFont.Charset = DEFAULT_CHARSET
+        LinkFont.Color = clBlue
+        LinkFont.Height = -11
+        LinkFont.Name = 'MS Sans Serif'
+        LinkFont.Style = [fsUnderline]
+      end
+    end
+    object btClose: TSpTBXButton
+      Left = 313
+      Top = 392
+      Width = 73
+      Height = 25
+      Caption = 'Close'
+      TabOrder = 4
+      OnClick = btCloseClick
+      LinkFont.Charset = DEFAULT_CHARSET
+      LinkFont.Color = clBlue
+      LinkFont.Height = -11
+      LinkFont.Name = 'MS Sans Serif'
+      LinkFont.Style = [fsUnderline]
+    end
+  end
+end

Added: Lobby/TASClient/AutoJoinFormUnit.pas
===================================================================
--- Lobby/TASClient/AutoJoinFormUnit.pas	                        (rev 0)
+++ Lobby/TASClient/AutoJoinFormUnit.pas	2009-05-28 21:16:55 UTC (rev 7255)
@@ -0,0 +1,316 @@
+unit AutoJoinFormUnit;
+
+interface
+
+uses
+  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
+  Dialogs, TBXDkPanels, SpTBXControls, VirtualTrees, SpTBXItem, StdCtrls,
+  TntStdCtrls, SpTBXEditors, IniFiles;
+
+type
+  TAutoJoinPresetItemList =
+  record
+    PresetName: string;
+    Sorting: integer;
+    SortingDirection: integer;
+  end;
+  PAutoJoinPresetItemList = ^TAutoJoinPresetItemList;
+  TAutoJoinForm = class(TForm)
+    SpTBXTitleBar1: TSpTBXTitleBar;
+    SpTBXGroupBox1: TSpTBXGroupBox;
+    VSTAutoplayPresetList: TVirtualStringTree;
+    btAutoplayPriorityUp: TSpTBXButton;
+    btAutoplayPriorityDown: TSpTBXButton;
+    btAutoplayRemovePreset: TSpTBXButton;
+    SpTBXGroupBox2: TSpTBXGroupBox;
+    SpTBXLabel1: TSpTBXLabel;
+    cmbFilterPresetList: TSpTBXComboBox;
+    SpTBXLabel2: TSpTBXLabel;
+    cmbSortingList: TSpTBXComboBox;
+    SpTBXLabel3: TSpTBXLabel;
+    cmbSortDir: TSpTBXComboBox;
+    btAddPresetToAutoplay: TSpTBXButton;
+    SpTBXGroupBox3: TSpTBXGroupBox;
+    VSTAutospecPresetList: TVirtualStringTree;
+    btAutospecPriorityUp: TSpTBXButton;
+    btAutospecPriorityDown: TSpTBXButton;
+    btAutospecRemovePreset: TSpTBXButton;
+    btAddPresetToAutospec: TSpTBXButton;
+    btClose: TSpTBXButton;
+    procedure FormCreate(Sender: TObject);
+    procedure FormShow(Sender: TObject);
+    procedure btAddPresetToAutoplayClick(Sender: TObject);
+    procedure VSTAutoplayPresetListGetText(Sender: TBaseVirtualTree;
+      Node: PVirtualNode; Column: TColumnIndex; TextType: TVSTTextType;
+      var CellText: WideString);
+    procedure btCloseClick(Sender: TObject);
+    procedure btAddPresetToAutospecClick(Sender: TObject);
+    procedure VSTAutospecPresetListGetText(Sender: TBaseVirtualTree;
+      Node: PVirtualNode; Column: TColumnIndex; TextType: TVSTTextType;
+      var CellText: WideString);
+    procedure btAutoplayPriorityUpClick(Sender: TObject);
+    procedure btAutoplayPriorityDownClick(Sender: TObject);
+    procedure btAutospecPriorityUpClick(Sender: TObject);
+    procedure btAutospecPriorityDownClick(Sender: TObject);
+    procedure btAutoplayRemovePresetClick(Sender: TObject);
+    procedure btAutospecRemovePresetClick(Sender: TObject);
+  private
+    { Private declarations }
+  public
+    autoPlayPresetList: TList;
+    autoSpecPresetList: TList;
+
+    procedure SaveAutoJoinPresetLists;
+    procedure LoadAutoJoinPresetLists;
+  end;
+
+var
+  AutoJoinForm: TAutoJoinForm;
+
+implementation
+
+uses MainUnit;
+
+{$R *.dfm}
+
+procedure TAutoJoinForm.FormCreate(Sender: TObject);
+begin
+  autoPlayPresetList := TList.Create;
+  autoSpecPresetList := TList.Create;
+end;
+
+procedure TAutoJoinForm.FormShow(Sender: TObject);
+var
+  i: integer;
+begin
+  cmbFilterPresetList.Clear;
+  cmbFilterPresetList.Items.AddStrings(MainForm.PresetListbox.Items);
+  cmbFilterPresetList.ItemIndex := 0;
+end;
+
+procedure TAutoJoinForm.btAddPresetToAutoplayClick(Sender: TObject);
+var
+  newPreset: PAutoJoinPresetItemList;
+begin
+  New(newPreset);
+  newPreset.PresetName := cmbFilterPresetList.Text;
+  newPreset.Sorting := cmbSortingList.ItemIndex;
+  newPreset.SortingDirection := cmbSortDir.ItemIndex;
+
+  autoPlayPresetList.Add(newPreset);
+  VSTAutoplayPresetList.RootNodeCount := VSTAutoplayPresetList.RootNodeCount+1;
+  VSTAutoplayPresetList.Refresh;
+end;
+
+procedure TAutoJoinForm.VSTAutoplayPresetListGetText(
+  Sender: TBaseVirtualTree; Node: PVirtualNode; Column: TColumnIndex;
+  TextType: TVSTTextType; var CellText: WideString);
+begin
+  case Column of
+    0:CellText := IntToStr(Node.Index+1);
+    1:CellText := PAutoJoinPresetItemList(autoPlayPresetList[Node.Index]).PresetName;
+    2:CellText := cmbSortingList.Items[PAutoJoinPresetItemList(autoPlayPresetList[Node.Index]).Sorting];
+    3:CellText := cmbSortDir.Items[PAutoJoinPresetItemList(autoPlayPresetList[Node.Index]).SortingDirection];
+  end;
+end;
+
+procedure TAutoJoinForm.btCloseClick(Sender: TObject);
+begin
+  Close;
+end;
+
+procedure TAutoJoinForm.btAddPresetToAutospecClick(Sender: TObject);
+var
+  newPreset: PAutoJoinPresetItemList;
+begin
+  New(newPreset);
+  newPreset.PresetName := cmbFilterPresetList.Text;
+  newPreset.Sorting := cmbSortingList.ItemIndex;
+  newPreset.SortingDirection := cmbSortDir.ItemIndex;
+
+  autoSpecPresetList.Add(newPreset);
+  VSTAutospecPresetList.RootNodeCount := VSTAutospecPresetList.RootNodeCount+1;
+  VSTAutospecPresetList.Refresh;
+end;
+
+procedure TAutoJoinForm.VSTAutospecPresetListGetText(
+  Sender: TBaseVirtualTree; Node: PVirtualNode; Column: TColumnIndex;
+  TextType: TVSTTextType; var CellText: WideString);
+begin
+  case Column of
+    0:CellText := IntToStr(Node.Index+1);
+    1:CellText := PAutoJoinPresetItemList(autoSpecPresetList[Node.Index]).PresetName;
+    2:CellText := cmbSortingList.Items[PAutoJoinPresetItemList(autoSpecPresetList[Node.Index]).Sorting];
+    3:CellText := cmbSortDir.Items[PAutoJoinPresetItemList(autoSpecPresetList[Node.Index]).SortingDirection];
+  end;
+end;
+
+procedure TAutoJoinForm.btAutoplayPriorityUpClick(Sender: TObject);
+var
+  item: PAutoJoinPresetItemList;
+  idx : integer;
+begin
+  if VSTAutoplayPresetList.GetFirstSelected = nil then
+    Exit;
+  idx := VSTAutoplayPresetList.GetFirstSelected.Index;
+  if idx = 0 then
+    Exit;
+  item := autoPlayPresetList[idx-1];
+  autoPlayPresetList[idx-1] := autoPlayPresetList[idx];
+  autoPlayPresetList[idx] := item;
+  VSTAutoplayPresetList.Refresh;
+  VSTAutoplayPresetList.Selected[VSTAutoplayPresetList.GetFirstSelected.PrevSibling] := True;
+end;
+
+procedure TAutoJoinForm.btAutoplayPriorityDownClick(Sender: TObject);
+var
+  item: PAutoJoinPresetItemList;
+  idx : integer;
+begin
+  if VSTAutoplayPresetList.GetFirstSelected = nil then
+    Exit;
+  idx := VSTAutoplayPresetList.GetFirstSelected.Index;
+  if idx = VSTAutoplayPresetList.RootNodeCount-1 then
+    Exit;
+  item := autoPlayPresetList[idx+1];
+  autoPlayPresetList[idx+1] := autoPlayPresetList[idx];
+  autoPlayPresetList[idx] := item;
+  VSTAutoplayPresetList.Refresh;
+  VSTAutoplayPresetList.Selected[VSTAutoplayPresetList.GetFirstSelected.NextSibling] := True;
+end;
+
+procedure TAutoJoinForm.btAutospecPriorityUpClick(Sender: TObject);
+var
+  item: PAutoJoinPresetItemList;
+  idx : integer;
+begin
+  if VSTAutospecPresetList.GetFirstSelected = nil then
+    Exit;
+  idx := VSTAutospecPresetList.GetFirstSelected.Index;
+  if idx = 0 then
+    Exit;
+  item := autoSpecPresetList[idx-1];
+  autoSpecPresetList[idx-1] := autoSpecPresetList[idx];
+  autoSpecPresetList[idx] := item;
+  VSTAutospecPresetList.Refresh;
+  VSTAutospecPresetList.Selected[VSTAutospecPresetList.GetFirstSelected.PrevSibling] := True;
+end;
+
+procedure TAutoJoinForm.btAutospecPriorityDownClick(Sender: TObject);
+var
+  item: PAutoJoinPresetItemList;
+  idx : integer;
+begin
+  if VSTAutospecPresetList.GetFirstSelected = nil then
+    Exit;
+  idx := VSTAutospecPresetList.GetFirstSelected.Index;
+  if idx = VSTAutospecPresetList.RootNodeCount-1 then
+    Exit;
+  item := autoSpecPresetList[idx+1];
+  autoSpecPresetList[idx+1] := autoSpecPresetList[idx];
+  autoSpecPresetList[idx] := item;
+  VSTAutospecPresetList.Refresh;
+  VSTAutospecPresetList.Selected[VSTAutospecPresetList.GetFirstSelected.NextSibling] := True;
+end;
+
+procedure TAutoJoinForm.btAutoplayRemovePresetClick(Sender: TObject);
+var
+  node: PVirtualNode;
+begin
+  if VSTAutoplayPresetList.GetFirstSelected = nil then
+    Exit;
+  autoPlayPresetList.Delete(VSTAutoplayPresetList.GetFirstSelected.Index);
+  node := VSTAutoplayPresetList.GetFirstSelected.PrevSibling;
+  if node = nil then
+    node := VSTAutoplayPresetList.GetFirstSelected.NextSibling;
+  VSTAutoplayPresetList.DeleteSelectedNodes;
+  if node &lt;&gt; nil then
+    VSTAutoplayPresetList.Selected[node] := true;
+  VSTAutoplayPresetList.Refresh;
+end;
+
+procedure TAutoJoinForm.btAutospecRemovePresetClick(Sender: TObject);
+var
+  node: PVirtualNode;
+begin
+  if VSTAutospecPresetList.GetFirstSelected = nil then
+    Exit;
+  autoSpecPresetList.Delete(VSTAutospecPresetList.GetFirstSelected.Index);
+  node := VSTAutospecPresetList.GetFirstSelected.PrevSibling;
+  if node = nil then
+    node := VSTAutospecPresetList.GetFirstSelected.NextSibling;
+  VSTAutospecPresetList.DeleteSelectedNodes;
+  if node &lt;&gt; nil then
+    VSTAutospecPresetList.Selected[node] := true;
+  VSTAutospecPresetList.Refresh;
+end;
+
+procedure TAutoJoinForm.LoadAutoJoinPresetLists;
+var
+  Ini : TIniFile;
+  i:integer;
+  FileName: String;
+  newPresetItem: PAutoJoinPresetItemList;
+begin
+  FileName := ExtractFilePath(Application.ExeName) + AUTOJOIN_SETTINGS;
+  Ini := TIniFile.Create(FileName);
+  autoPlayPresetList.Clear;
+  autoSpecPresetList.Clear;
+  VSTAutoplayPresetList.Clear;
+  i := 0;
+  while Ini.ValueExists('AutoPlay', 'PresetName_'+IntToStr(i)) do
+  begin
+    New(newPresetItem);
+    newPresetItem.PresetName := Ini.ReadString('AutoPlay', 'PresetName_'+IntToStr(i), 'Error');
+    newPresetItem.Sorting := Ini.ReadInteger('AutoPlay', 'Sorting_'+IntToStr(i), 0);
+    newPresetItem.SortingDirection := Ini.ReadInteger('AutoPlay', 'SortingDirection_'+IntToStr(i), 0);
+    autoPlayPresetList.Add(newPresetItem);
+    VSTAutoplayPresetList.RootNodeCount := VSTAutoplayPresetList.RootNodeCount+1;
+    Inc(i);
+  end;
+  i := 0;
+  while Ini.ValueExists('AutoSpec', 'PresetName_'+IntToStr(i)) do
+  begin
+    New(newPresetItem);
+    newPresetItem.PresetName := Ini.ReadString('AutoSpec', 'PresetName_'+IntToStr(i), 'Error');
+    newPresetItem.Sorting := Ini.ReadInteger('AutoSpec', 'Sorting_'+IntToStr(i), 0);
+    newPresetItem.SortingDirection := Ini.ReadInteger('AutoSpec', 'SortingDirection_'+IntToStr(i), 0);
+    autoSpecPresetList.Add(newPresetItem);
+    VSTAutospecPresetList.RootNodeCount := VSTAutospecPresetList.RootNodeCount+1;
+    Inc(i);
+  end;
+  VSTAutoplayPresetList.Refresh;
+  VSTAutospecPresetList.Refresh;
+end;
+
+procedure TAutoJoinForm.SaveAutoJoinPresetLists;
+var
+  Ini : TIniFile;
+  i:integer;
+  FileName: String;
+begin
+  try
+    FileName := ExtractFilePath(Application.ExeName) + AUTOJOIN_SETTINGS;
+    if FileExists(FileName) then
+      DeleteFile(FileName);
+    Ini := TIniFile.Create(FileName);
+    i := 0;
+    for i:=0 to autoPlayPresetList.Count-1 do
+    begin
+      Ini.WriteString('AutoPlay', 'PresetName_'+IntToStr(i), PAutoJoinPresetItemList(autoPlayPresetList[i]).PresetName);
+      Ini.WriteString('AutoPlay', 'Sorting_'+IntToStr(i), IntToStr(PAutoJoinPresetItemList(autoPlayPresetList[i]).Sorting));
+      Ini.WriteString('AutoPlay', 'SortingDirection_'+IntToStr(i), IntToStr(PAutoJoinPresetItemList(autoPlayPresetList[i]).SortingDirection));
+    end;
+    for i:=0 to autoSpecPresetList.Count-1 do
+    begin
+      Ini.WriteString('AutoSpec', 'PresetName_'+IntToStr(i), PAutoJoinPresetItemList(autoSpecPresetList[i]).PresetName);
+      Ini.WriteString('AutoSpec', 'Sorting_'+IntToStr(i), IntToStr(PAutoJoinPresetItemList(autoSpecPresetList[i]).Sorting));
+      Ini.WriteString('AutoSpec', 'SortingDirection_'+IntToStr(i), IntToStr(PAutoJoinPresetItemList(autoSpecPresetList[i]).SortingDirection));
+    end;
+  except
+    MainForm.AddMainLog('Error: Can''t write the autojoin settings.',Colors.Error);
+  end;
+end;
+
+end.
+

Modified: Lobby/TASClient/BattleFormUnit.dfm
===================================================================
--- Lobby/TASClient/BattleFormUnit.dfm	2009-05-28 11:37:21 UTC (rev 7254)
+++ Lobby/TASClient/BattleFormUnit.dfm	2009-05-28 21:16:55 UTC (rev 7255)
@@ -1,12 +1,12 @@
 object BattleForm: TBattleForm
-  Left = 551
-  Top = 302
+  Left = 320
+  Top = 52
   Width = 945
   Height = 589
   Caption = 'Battle window'
   Color = clBtnFace
-  Constraints.MaxHeight = 1000
-  Constraints.MaxWidth = 1680
+  Constraints.MaxHeight = 750
+  Constraints.MaxWidth = 1280
   Font.Charset = DEFAULT_CHARSET
   Font.Color = clWindowText
   Font.Height = -11
@@ -4084,7 +4084,7 @@
           Height = 273
           Align = alClient
           Color = clBtnFace
-          ActiveTabIndex = 1
+          ActiveTabIndex = 4
           ThemeType = tttNone
           OnActiveTabChange = SpTBXTabControl1ActiveTabChange
           HiddenItems = &lt;
@@ -4102,7 +4102,6 @@
           end
           object GameOptionsTab: TSpTBXTabItem
             Caption = 'Game options'
-            Checked = True
             CustomWidth = 80
             CustomHeight = 35
             ThemeType = tttNone
@@ -4122,95 +4121,18 @@
           object ModTab: TSpTBXTabItem
             Caption = 'Mod options'
             Wrapping = twWrap
+            Checked = True
             CustomWidth = 94
             ThemeType = tttNone
           end
-          object ModTabSheet: TSpTBXTabSheet
-            Left = 0
-            Top = 39
-            Width = 419
-            Height = 234
-            Caption = 'Mod options'
-            ImageIndex = -1
-            DesignSize = (
-              419
-              234)
-            TabItem = 'ModTab'
-            object ModOptionsScrollBox: TTntScrollBox
-              Left = 8
-              Top = 48
-              Width = 402
-              Height = 184
-              VertScrollBar.Smooth = True
-              VertScrollBar.Tracking = True
-              Anchors = [akLeft, akTop, akRight, akBottom]
-              BiDiMode = bdLeftToRight
-              BorderStyle = bsNone
-              Color = clBtnFace
-              Ctl3D = False
-              ParentBiDiMode = False
-              ParentBackground = True
-              ParentColor = False
-              ParentCtl3D = False
-              TabOrder = 0
-            end
-            object panelModOptionsDefault: TSpTBXPanel
-              Left = 8
-              Top = 4
-              Width = 402
-              Height = 41
-              Align = alCustom
-              TabOrder = 1
-              object btLoadDefaultMDO: TSpTBXButton
-                Left = 149
-                Top = 8
-                Width = 113
-                Height = 25
-                Caption = 'Load default'
-                TabOrder = 0
-                OnClick = btLoadDefaultMDOClick
-                LinkFont.Charset = DEFAULT_CHARSET
-                LinkFont.Color = clBlue
-                LinkFont.Height = -11
-                LinkFont.Name = 'MS Sans Serif'
-                LinkFont.Style = [fsUnderline]
-              end
-              object btSetAsDefaultMDO: TSpTBXButton
-                Left = 269
-                Top = 8
-                Width = 113
-                Height = 25
-                Caption = 'Set as default'
-                TabOrder = 1
-                OnClick = btSetAsDefaultMDOClick
-                LinkFont.Charset = DEFAULT_CHARSET
-                LinkFont.Color = clBlue
-                LinkFont.Height = -11
-                LinkFont.Name = 'MS Sans Serif'
-                LinkFont.Style = [fsUnderline]
-              end
-              object btLoadModsDefaultMDO: TSpTBXButton
-                Left = 29
-                Top = 8
-                Width = 113
-                Height = 25
-                Caption = 'Load mod'#39's default'
-                TabOrder = 2
-                OnClick = btLoadModsDefaultMDOClick
-                LinkFont.Charset = DEFAULT_CHARSET
-                LinkFont.Color = clBlue
-                LinkFont.Height = -11
-                LinkFont.Name = 'MS Sans Serif'
-                LinkFont.Style = [fsUnderline]
-              end
-            end
-          end
           object SpTBXTabSheet6: TSpTBXTabSheet
             Left = 0
             Top = 39
             Width = 419
             Height = 234
             ImageIndex = 1
+            Item = QuickLookTab
+            TabControl = SpTBXTabControl1
             TabItem = 'QuickLookTab'
             object QuickLookRichEdit: TRichEdit
               Left = 2
@@ -4235,6 +4157,8 @@
             Height = 234
             Caption = 'Map options'
             ImageIndex = -1
+            Item = MapTab
+            TabControl = SpTBXTabControl1
             DesignSize = (
               419
               234)
@@ -4315,6 +4239,8 @@
             Height = 234
             Caption = 'Disabled Units (0)'
             ImageIndex = -1
+            Item = DisabledUnitsTab
+            TabControl = SpTBXTabControl1
             DesignSize = (
               419
               234)
@@ -4384,6 +4310,8 @@
             Height = 234
             Caption = 'Game options'
             ImageIndex = -1
+            Item = GameOptionsTab
+            TabControl = SpTBXTabControl1
             TabItem = 'GameOptionsTab'
             object ResourcesGroupBox: TSpTBXGroupBox
               Left = 248
@@ -4611,6 +4539,88 @@
               LinkFont.Style = [fsUnderline]
             end
           end
+          object ModTabSheet: TSpTBXTabSheet
+            Left = 0
+            Top = 39
+            Width = 419
+            Height = 234
+            Caption = 'Mod options'
+            ImageIndex = -1
+            Item = ModTab
+            TabControl = SpTBXTabControl1
+            DesignSize = (
+              419
+              234)
+            TabItem = 'ModTab'
+            object ModOptionsScrollBox: TTntScrollBox
+              Left = 8
+              Top = 48
+              Width = 402
+              Height = 184
+              VertScrollBar.Smooth = True
+              VertScrollBar.Tracking = True
+              Anchors = [akLeft, akTop, akRight, akBottom]
+              BiDiMode = bdLeftToRight
+              BorderStyle = bsNone
+              Color = clBtnFace
+              Ctl3D = False
+              ParentBiDiMode = False
+              ParentBackground = True
+              ParentColor = False
+              ParentCtl3D = False
+              TabOrder = 0
+            end
+            object panelModOptionsDefault: TSpTBXPanel
+              Left = 8
+              Top = 4
+              Width = 402
+              Height = 41
+              Align = alCustom
+              TabOrder = 1
+              object btLoadDefaultMDO: TSpTBXButton
+                Left = 149
+                Top = 8
+                Width = 113
+                Height = 25
+                Caption = 'Load default'
+                TabOrder = 0
+                OnClick = btLoadDefaultMDOClick
+                LinkFont.Charset = DEFAULT_CHARSET
+                LinkFont.Color = clBlue
+                LinkFont.Height = -11
+                LinkFont.Name = 'MS Sans Serif'
+                LinkFont.Style = [fsUnderline]
+              end
+              object btSetAsDefaultMDO: TSpTBXButton
+                Left = 269
+                Top = 8
+                Width = 113
+                Height = 25
+                Caption = 'Set as default'
+                TabOrder = 1
+                OnClick = btSetAsDefaultMDOClick
+                LinkFont.Charset = DEFAULT_CHARSET
+                LinkFont.Color = clBlue
+                LinkFont.Height = -11
+                LinkFont.Name = 'MS Sans Serif'
+                LinkFont.Style = [fsUnderline]
+              end
+              object btLoadModsDefaultMDO: TSpTBXButton
+                Left = 29
+                Top = 8
+                Width = 113
+                Height = 25
+                Caption = 'Load mod'#39's default'
+                TabOrder = 2
+                OnClick = btLoadModsDefaultMDOClick
+                LinkFont.Charset = DEFAULT_CHARSET
+                LinkFont.Color = clBlue
+                LinkFont.Height = -11
+                LinkFont.Name = 'MS Sans Serif'
+                LinkFont.Style = [fsUnderline]
+              end
+            end
+          end
         end
       end
       object Panel6: TPanel
@@ -4749,7 +4759,7 @@
               end
             end
             object MapSizeLabel: TSpTBXLabel
-              Left = 44
+              Left = 60
               Top = 128
               Width = 54
               Height = 13
@@ -4762,7 +4772,7 @@
               LinkFont.Style = [fsUnderline]
             end
             object TidalStrengthLabel: TSpTBXLabel
-              Left = 22
+              Left = 38
               Top = 143
               Width = 76
               Height = 13
@@ -4775,7 +4785,7 @@
               LinkFont.Style = [fsUnderline]
             end
             object GravityLabel: TSpTBXLabel
-              Left = 53
+              Left = 69
               Top = 158
               Width = 45
               Height = 13
@@ -4788,7 +4798,7 @@
               LinkFont.Style = [fsUnderline]
             end
             object MaxMetalLabel: TSpTBXLabel
-              Left = 35
+              Left = 51
               Top = 173
               Width = 63
               Height = 13
@@ -4801,7 +4811,7 @@
               LinkFont.Style = [fsUnderline]
             end
             object ExtRadiusLabel: TSpTBXLabel
-              Left = 13
+              Left = 29
               Top = 188
               Width = 85
               Height = 13
@@ -4814,11 +4824,11 @@
               LinkFont.Style = [fsUnderline]
             end
             object WindLabel: TSpTBXLabel
-              Left = 12
+              Left = 4
               Top = 203
-              Width = 86
+              Width = 109
               Height = 13
-              Caption = 'Wind (min/max): ?'
+              Caption = 'Wind (min/max/avg): ?'
               Anchors = [akTop, akRight]
               LinkFont.Charset = DEFAULT_CHARSET
               LinkFont.Color = clBlue
@@ -4887,6 +4897,8 @@
               Height = 199
               Caption = 'RessourcesMap'
               ImageIndex = -1
+              Item = RessourcesMapTab
+              TabControl = MapsTabs
               TabItem = 'RessourcesMapTab'
               object MetalMapPanel: TSpTBXPanel
                 Left = 2
@@ -8672,6 +8684,8 @@
               Height = 199
               Caption = 'HeightMap'
               ImageIndex = -1
+              Item = HeightMapTab
+              TabControl = MapsTabs
               TabItem = 'HeightMapTab'
               object HeightMapPanel: TSpTBXPanel
                 Left = 2
@@ -12457,6 +12471,8 @@
               Height = 199
               Caption = 'Minimap'
               ImageIndex = -1
+              Item = MinimapTab
+              TabControl = MapsTabs
               TabItem = 'MinimapTab'
               object MinimapPanel: TSpTBXPanel
                 Left = 2
@@ -12675,40 +12691,6 @@
           TabOrder = 0
           OnClick = SpectateCheckBoxClick
         end
-        object MyTeamNoButton: TTBXButton
-          Left = 64
-          Top = 18
-          Width = 41
-          Height = 20
-          Hint = 
-            'Your team number. Players with the same team number will share s' +
-            'ame commander.'
-          AutoSize = False
-          Caption = '1'
-          Images = MainForm.MiscImageList
-          Layout = blGlyphRight
-          ParentShowHint = False
-          ShowHint = True
-          TabOrder = 1
-          OnClick = MyTeamNoButtonClick
-        end
-        object MyAllyNoButton: TTBXButton
-          Left = 64
-          Top = 42
-          Width = 41
-          Height = 20
-          Hint = 
-            'Your ally number. Players with same ally number will share map v' +
-            'isibility and resources (if they choose to)'
-          AutoSize = False
-          Caption = '1'
-          Images = MainForm.MiscImageList
-          Layout = blGlyphRight
-          ParentShowHint = False
-          ShowHint = True
-          TabOrder = 2
-          OnClick = MyAllyNoButtonClick
-        end
         object MySideButton: TSpTBXSpeedButton
           Left = 120
           Top = 17
@@ -12722,6 +12704,48 @@
           LinkFont.Name = 'MS Sans Serif'
           LinkFont.Style = [fsUnderline]
         end
+        object MyTeamNoButton: TSpTBXSpinEdit
+          Left = 64
+          Top = 16
+          Width = 49
+          Height = 21
+          TabOrder = 5
+          OnExit = MyTeamNoButtonExit
+          MaxValue = 200.000000000000000000
+          MinValue = 1.000000000000000000
+          SpinButton.Left = 30
+          SpinButton.Top = 0
+          SpinButton.Width = 15
+          SpinButton.Height = 17
+          SpinButton.Align = alRight
+          SpinButton.LinkFont.Charset = DEFAULT_CHARSET
+          SpinButton.LinkFont.Color = clBlue
+          SpinButton.LinkFont.Height = -11
+          SpinButton.LinkFont.Name = 'MS Sans Serif'
+          SpinButton.LinkFont.Style = [fsUnderline]
+          Value = 1.000000000000000000
+        end
+        object MyAllyNoButton: TSpTBXSpinEdit
+          Left = 64
+          Top = 40
+          Width = 49
+          Height = 21
+          TabOrder = 6
+          OnExit = MyAllyNoButtonExit
+          MaxValue = 200.000000000000000000
+          MinValue = 1.000000000000000000
+          SpinButton.Left = 30
+          SpinButton.Top = 0
+          SpinButton.Width = 15
+          SpinButton.Height = 17
+          SpinButton.Align = alRight
+          SpinButton.LinkFont.Charset = DEFAULT_CHARSET
+          SpinButton.LinkFont.Color = clBlue
+          SpinButton.LinkFont.Height = -11
+          SpinButton.LinkFont.Name = 'MS Sans Serif'
+          SpinButton.LinkFont.Style = [fsUnderline]
+          Value = 1.000000000000000000
+        end
       end
     end
     object Splitter2: TSpTBXSplitter
@@ -12751,7 +12775,7 @@
     Top = 428
   end
   object ColorPopupMenu: TSpTBXPopupMenu
-    Left = 752
+    Left = 880
     Top = 384
     object TBXColorPalette1: TTBXColorPalette
       ColorSet = TBXTeamColorSet
@@ -12772,27 +12796,9 @@
     ColCount = 5
     RowCount = 4
     OnGetColorInfo = TBXTeamColorSetGetColorInfo
-    Left = 720
+    Left = 848
     Top = 384
   end
-  object ChooseNumberPopupMenu: TSpTBXPopupMenu
-    Left = 552
-    Top = 344
-    object TBXToolPalette1: TTBXToolPalette
-      ColCount = 4
-      Images = MainForm.NumbersImageList
-      PaletteOptions = []
-      RowCount = 4
-      OnCellClick = TBXToolPalette1CellClick
-    end
-    object SpTBXItem2: TSpTBXItem
-      Caption = 'Cancel'
-    end
-  end
-  object ChooseSidePopupMenu: TSpTBXPopupMenu
-    Left = 728
-    Top = 300
-  end
   object PlayerControlPopupMenu: TSpTBXPopupMenu
     OnInitPopup = PlayerControlPopupMenuInitPopup
     Left = 304
@@ -12922,8 +12928,15 @@
     end
   end
   object AdminPopupMenu: TSpTBXPopupMenu
-    Left = 316
-    Top = 489
+    Left = 364
+    Top = 497
+    object mnuAutoLockOnStart: TSpTBXItem
+      Caption = 'Lock on start'
+      AutoCheck = True
+      Checked = True
+    end
+    object SpTBXSeparatorItem14: TSpTBXSeparatorItem
+    end
     object mnuRingAllNotRdy: TSpTBXItem
       Caption = 'Ring all not ready'
       OnClick = mnuRingAllNotRdyClick
@@ -13041,8 +13054,8 @@
     Top = 427
   end
   object LadderPopupMenu: TSpTBXPopupMenu
-    Left = 748
-    Top = 491
+    Left = 868
+    Top = 499
     object SpTBXItem9: TSpTBXItem
       Caption = 'Rules'
       OnClick = SpTBXItem9Click
@@ -13075,13 +13088,13 @@
   object QuickLookChangedTmr: TTimer
     Interval = 0
     OnTimer = QuickLookChangedTmrTimer
-    Left = 453
-    Top = 142
+    Left = 381
+    Top = 166
   end
   object SpringSettingsProfilePopupMenu: TSpTBXPopupMenu
     OnInitPopup = SpringSettingsProfilePopupMenuInitPopup
-    Left = 668
-    Top = 490
+    Left = 764
+    Top = 498
     object sspDefaultItem: TSpTBXItem
       Caption = 'default'
       OnClick = sspDefaultItemClick
@@ -13089,4 +13102,8 @@
     object SpTBXSeparatorItem13: TSpTBXSeparatorItem
     end
   end
+  object ChooseSidePopupMenu: TSpTBXPopupMenu
+    Left = 844
+    Top = 303
+  end
 end

Modified: Lobby/TASClient/BattleFormUnit.pas
===================================================================
--- Lobby/TASClient/BattleFormUnit.pas	2009-05-28 11:37:21 UTC (rev 7254)
+++ Lobby/TASClient/BattleFormUnit.pas	2009-05-28 21:16:55 UTC (rev 7255)
@@ -61,6 +61,7 @@
     procedure Enable;virtual;
     procedure Disable;virtual;
     procedure setToDefault();virtual;
+    function isDefault:Boolean;virtual;
     function toString:String;virtual;
     destructor Destroy; override;
   end;
@@ -76,6 +77,7 @@
     procedure Enable;override;
     procedure Disable;override;
     procedure setToDefault();override;
+     function isDefault:Boolean;override;
     function toString:String;override;
     destructor Destroy; override;
   end;
@@ -92,6 +94,7 @@
     procedure Enable;override;
     procedure Disable;override;
     procedure setToDefault();override;
+    function isDefault:Boolean;override;
     function toString:String;override;
     destructor Destroy; override;
   end;
@@ -109,6 +112,7 @@
     procedure Enable;override;
     procedure Disable;override;
     procedure setToDefault();override;
+    function isDefault:Boolean;override;
     function toString:String;override;
     destructor Destroy; override;
   end;
@@ -128,6 +132,7 @@
     procedure Enable;override;
     procedure Disable;override;
     procedure setToDefault();override;
+    function isDefault:Boolean;override;
     procedure OnChange(Sender: TObject);override;
     function toString:String;override;
     destructor Destroy; override;
@@ -150,6 +155,7 @@
     procedure Enable;override;
     procedure Disable;override;
     procedure setToDefault();override;
+    function isDefault:Boolean;override;
     function toString:String;override;
     function nameToString:String;
     destructor Destroy; override;
@@ -161,10 +167,6 @@
     TBXColorPalette1: TTBXColorPalette;
     TBXTeamColorSet: TTBXColorSet;
     SpTBXItem1: TSpTBXItem;
-    ChooseNumberPopupMenu: TSpTBXPopupMenu;
-    TBXToolPalette1: TTBXToolPalette;
-    SpTBXItem2: TSpTBXItem;
-    ChooseSidePopupMenu: TSpTBXPopupMenu;
     PlayerControlPopupMenu: TSpTBXPopupMenu;
     HandicapSpinEditItem: TTBXSpinEditItem;
     KickPlayerItem: TSpTBXItem;
@@ -285,8 +287,6 @@
     Label12: TSpTBXLabel;
     TeamColorSpeedButton: TSpTBXSpeedButton;
     SpectateCheckBox: TSpTBXCheckBox;
-    MyTeamNoButton: TTBXButton;
-    MyAllyNoButton: TTBXButton;
     MySideButton: TSpTBXSpeedButton;
     Splitter2: TSpTBXSplitter;
     SpTBXSplitter2: TSpTBXSplitter;
@@ -331,6 +331,11 @@
     sspDefaultItem: TSpTBXItem;
     SpTBXSeparatorItem13: TSpTBXSeparatorItem;
     QuickLookRichEdit: TRichEdit;
+    SpTBXSeparatorItem14: TSpTBXSeparatorItem;
+    mnuAutoLockOnStart: TSpTBXItem;
+    MyTeamNoButton: TSpTBXSpinEdit;
+    MyAllyNoButton: TSpTBXSpinEdit;
+    ChooseSidePopupMenu: TSpTBXPopupMenu;
 
     procedure CreateParams(var Params: TCreateParams); override;
 
@@ -433,8 +438,6 @@
       var ACol, ARow: Integer; var AllowChange: Boolean);
     procedure TBXToolPalette1CellClick(Sender: TTBXCustomToolPalette;
       var ACol, ARow: Integer; var AllowChange: Boolean);
-    procedure MyTeamNoButtonClick(Sender: TObject);
-    procedure MyAllyNoButtonClick(Sender: TObject);
     procedure VDTBattleClientsGetNodeWidth(Sender: TBaseVirtualTree;
       HintCanvas: TCanvas; Node: PVirtualNode; Column: TColumnIndex;
       var NodeWidth: Integer);
@@ -554,6 +557,8 @@
     procedure sspDefaultItemClick(Sender: TObject);
     procedure QuickLookRichEditMouseMove(Sender: TObject;
       Shift: TShiftState; X, Y: Integer);
+    procedure MyTeamNoButtonExit(Sender: TObject);
+    procedure MyAllyNoButtonExit(Sender: TObject);
   private
     History: TWideStringList;
     HistoryIndex: Integer;
@@ -868,10 +873,10 @@
   Inc(Result, BoolToInt(BattleForm.AmIReady) shl 1);
 
   // team no.:
-  Inc(Result, (StrToInt(MyTeamNoButton.Caption)-1) shl 2);
+  Inc(Result, (MyTeamNoButton.ValueAsInteger-1) shl 2);
 
   // ally no.:
-  Inc(Result, (StrToInt(MyAllyNoButton.Caption)-1) shl 6);
+  Inc(Result, (MyAllyNoButton.ValueAsInteger-1) shl 6);
 
   // mode:
   Inc(Result, BoolToInt(not SpectateCheckBox.Checked) shl 10);
@@ -893,8 +898,8 @@
   // handicap is ignored (only host can change it)
   if SideList.Count &gt; Side then ChangeSide(Side, False);
   BattleForm.AmIReady := Ready;
-  MyTeamNoButton.Caption := IntToStr(TeamNo+1);
-  MyAllyNoButton.Caption := IntToStr(AllyNo+1);
+  MyTeamNoButton.ValueAsInteger := TeamNo+1;
+  MyAllyNoButton.ValueAsInteger := AllyNo+1;
   SpectateCheckBox.Checked := not IntToBool(Mode);
 
   AllowBattleStatusUpdate := True;
@@ -1153,7 +1158,7 @@
   GravityLabel.Caption := _('Gravity: ?');
   MaxMetalLabel.Caption := _('Max. metal: ?');
   ExtRadiusLabel.Caption := _('Extractor radius: ?');
-  WindLabel.Caption := _('Wind (min/max): ?');
+  WindLabel.Caption := _('Wind (min/max/avg): ?');
   MapDescLabel.Caption := _('Description: Click on the minimap to attempt to locate map in the &quot;Online maps&quot; list!');
   MapDescLabel.Hint := MapDescLabel.Caption;
 
@@ -1306,7 +1311,7 @@
   ExtRadiusLabel.Caption := _('Extractor radius: ') + IntToStr(MapInfo.ExtractorRadius);
 //  Label6.Caption := 'Min. wind: ' + Format('%.5g', [MapInfo.MinWind]);
 //  Label7.Caption := 'Max. wind: ' + Format('%.5g', [MapInfo.MaxWind]);
-  WindLabel.Caption := _('Wind (min/max): ') + IntToStr(MapInfo.MinWind) + '-' + IntToStr(MapInfo.MaxWind);;
+  WindLabel.Caption := _('Wind (min/max/avg): ') + IntToStr(MapInfo.MinWind) + '-' + IntToStr(MapInfo.MaxWind)+ '-' + IntToStr(Round((MapInfo.MaxWind+MapInfo.MinWind)/2));
   MapDescLabel.Caption := _('Description: ') + MapInfo.Description;
   MapDescLabel.Hint := MapDescLabel.Caption;
 
@@ -1513,7 +1518,7 @@
     MainForm.TryToSendCommand('MYSTATUS', '1');
     GameTimer.Enabled := True;
     BattleState.Battle.RefreshRanksNCupsOnSuccessReport := True;
-    if (BattleState.Status = Hosting) and not BattleState.Battle.Locked then
+    if (BattleState.Status = Hosting) and not BattleState.Battle.Locked and mnuAutoLockOnStart.Checked then
       LockedCheckBoxClick(nil);
   end
   else
@@ -2144,13 +2149,13 @@
         modname := Script.ReadModName;
 
         if MetalTracker.Visible then
-          metal := Script.ReadStartMetal2;
+          metal := Script.ReadStartMetal;
 
         if EnergyTracker.Visible then
-          energy := Script.ReadStartEnergy2;
+          energy := Script.ReadStartEnergy;
 
         if UnitsTracker.Visible then
-          units := Script.ReadMaxUnits2;
+          units := Script.ReadMaxUnits;
 
         startpos := Script.ReadStartPosType;
 
@@ -2193,31 +2198,12 @@
 var
   f: TextFile;
   NumberOfTeams: Integer;
-  NumberOfAllyTeams: Integer;
   i, j: Integer;
-  Pos: Integer;
   ModFileName: string;
-  tmp: Integer;
-  tmpbool: Boolean;
-  index: Integer;
   MyPlayerNum: Integer;
   Script: TScript;
   tryToRewriteScript: Boolean;
 
-  PurgedClients: array of // without spectators and with shifted team and ally numbers. Bots are included too.
-  record
-    Bot: Boolean; // if this client is a bot
-    ClientIndex: Integer;
-    TeamNo: Integer;
-    AllyNo: Integer;
-    TeamColor: Integer;
-    Side: Integer;
-    Handicap: Integer;
-  end;
-
-  TeamToPurgedTeam: array[0..MAX_TEAMS-1] of Integer; // TeamToPurgedTeam[IndexOfTeam]: IndexOfPurgedTeam
-  AllyToPurgedAlly: array[0..MAX_TEAMS-1] of Integer; // AllyToPurgedAlly[IndexOfAllyTeam]: IndexOfPurgedAllyTeam
-
   // &quot;purging&quot; is needed for one reason: there mustn't be any gaps between team/ally numbers
 
 begin
@@ -2233,65 +2219,6 @@
   end;
   ModFileName := ModArchiveList[i];
 
-  // do the &quot;purging&quot;:
-
-  NumberOfTeams := 0;
-  for i := 0 to High(TeamToPurgedTeam) do TeamToPurgedTeam[i] := -1;
-  for i := 0 to BattleState.Battle.Clients.Count-1 do if TClient(BattleState.Battle.Clients[i]).GetMode = 1 then if TeamToPurgedTeam[TClient(BattleState.Battle.Clients[i]).GetTeamNo] = -1 then
-  begin
-    TeamToPurgedTeam[TClient(BattleState.Battle.Clients[i]).GetTeamNo] := NumberOfTeams;
-    Inc(NumberOfTeams);
-  end;
-  for i := 0 to BattleState.Battle.Bots.Count-1 do if TeamToPurgedTeam[TBot(BattleState.Battle.Bots[i]).GetTeamNo] = -1 then
-  begin
-    TeamToPurgedTeam[TBot(BattleState.Battle.Bots[i]).GetTeamNo] := NumberOfTeams;
-    Inc(NumberOfTeams);
-  end;
-
-  NumberOfAllyTeams := 0;
-  for i := 0 to High(AllyToPurgedAlly) do AllyToPurgedAlly[i] := -1;
-  for i := 0 to BattleState.Battle.Clients.Count-1 do if TClient(BattleState.Battle.Clients[i]).GetMode = 1 then if AllyToPurgedAlly[TClient(BattleState.Battle.Clients[i]).GetAllyNo] = -1 then
-  begin
-    AllyToPurgedAlly[TClient(BattleState.Battle.Clients[i]).GetAllyNo] := NumberOfAllyTeams;
-    Inc(NumberOfAllyTeams);
-  end;
-  for i := 0 to BattleState.Battle.Bots.Count-1 do if AllyToPurgedAlly[TBot(BattleState.Battle.Bots[i]).GetAllyNo] = -1 then
-  begin
-    AllyToPurgedAlly[TBot(BattleState.Battle.Bots[i]).GetAllyNo] := NumberOfAllyTeams;
-    Inc(NumberOfAllyTeams);
-  end;
-
-  // update spectator count, just in case if current one is invalid:
-  tmp := 0;
-  for i := 0 to BattleState.Battle.Clients.Count-1 do
-    if TClient(BattleState.Battle.Clients[i]).GetMode = 0 then Inc(tmp);
-  BattleState.Battle.SpectatorCount := tmp;
-
-  tmp := 0;
-  SetLength(PurgedClients, BattleState.Battle.Clients.Count - BattleState.Battle.SpectatorCount + BattleState.Battle.Bots.Count);
-  for i := 0 to BattleState.Battle.Clients.Count-1 do if TClient(BattleState.Battle.Clients[i]).GetMode = 1 then
-  begin
-    PurgedClients[tmp].Bot := False;
-    PurgedClients[tmp].ClientIndex := i;
-    PurgedClients[tmp].TeamNo := TeamToPurgedTeam[TClient(BattleState.Battle.Clients[i]).GetTeamNo];
-    PurgedClients[tmp].AllyNo := AllyToPurgedAlly[TClient(BattleState.Battle.Clients[i]).GetAllyNo];
-    PurgedClients[tmp].TeamColor := TClient(BattleState.Battle.Clients[i]).TeamColor;
-    PurgedClients[tmp].Side := TClient(BattleState.Battle.Clients[i]).GetSide;
-    PurgedClients[tmp].Handicap := TClient(BattleState.Battle.Clients[i]).GetHandicap;
-    Inc(tmp);
-  end;
-  for i := 0 to BattleState.Battle.Bots.Count-1 do
-  begin
-    PurgedClients[tmp].Bot := True;
-    PurgedClients[tmp].ClientIndex := i;
-    PurgedClients[tmp].TeamNo := TeamToPurgedTeam[TBot(BattleState.Battle.Bots[i]).GetTeamNo];
-    PurgedClients[tmp].AllyNo := AllyToPurgedAlly[TBot(BattleState.Battle.Bots[i]).GetAllyNo];
-    PurgedClients[tmp].TeamColor := TBot(BattleState.Battle.Bots[i]).TeamColor;
-    PurgedClients[tmp].Side := TBot(BattleState.Battle.Bots[i]).GetSide;
-    PurgedClients[tmp].Handicap := TBot(BattleState.Battle.Bots[i]).GetHandicap;
-    Inc(tmp);
-  end;
-
   // get my player number:
   MyPlayerNum := BattleState.Battle.Clients.IndexOf(Status.Me);
 
@@ -2335,83 +2262,93 @@
   Script.AddOrChangeKeyValue('GAME/MyPlayerName',Status.Me.Name);
   Script.AddOrChangeKeyValue('GAME/IsHost',BoolToStr(BattleState.Status = Hosting));
   Script.AddOrChangeKeyValue('GAME/NumPlayers',IntToStr(BattleState.Battle.Clients.Count));
-  Script.AddOrChangeKeyValue('GAME/NumTeams',IntToStr(NumberOfTeams));
-  Script.AddOrChangeKeyValue('GAME/NumAllyTeams',IntToStr(NumberOfAllyTeams));
 
   // players:
-  Pos := 0;
-    for i := 0 to BattleState.Battle.Clients.Count-1 do
+  for i := 0 to BattleState.Battle.Clients.Count-1 do
+  begin
+    Script.AddOrChangeKeyValue('GAME/PLAYER'+IntToStr(i)+'/Name',TClient(BattleState.Battle.Clients[i]).Name);
+    Script.AddOrChangeKeyValue('GAME/PLAYER'+IntToStr(i)+'/countryCode',TClient(BattleState.Battle.Clients[i]).Country);
+    Script.AddOrChangeKeyValue('GAME/PLAYER'+IntToStr(i)+'/Rank',IntToStr(TClient(BattleState.Battle.Clients[i]).GetRank));
+    if TClient(BattleState.Battle.Clients[i]).GetMode = 0 then
     begin
-      Script.AddOrChangeKeyValue('GAME/PLAYER'+IntToStr(i)+'/Name',TClient(BattleState.Battle.Clients[i]).Name);
-      Script.AddOrChangeKeyValue('GAME/PLAYER'+IntToStr(i)+'/countryCode',TClient(BattleState.Battle.Clients[i]).Country);
-      Script.AddOrChangeKeyValue('GAME/PLAYER'+IntToStr(i)+'/Rank',IntToStr(TClient(BattleState.Battle.Clients[i]).GetRank));
-      if TClient(BattleState.Battle.Clients[i]).GetMode = 0 then
+      Script.AddOrChangeKeyValue('GAME/PLAYER'+IntToStr(i)+'/Spectator','1');
+    end
+    else
+    begin
+      Script.AddOrChangeKeyValue('GAME/PLAYER'+IntToStr(i)+'/Spectator','0');
+      Script.AddOrChangeKeyValue('GAME/PLAYER'+IntToStr(i)+'/team',IntToStr(TClient(BattleState.Battle.Clients[i]).GetTeamNo));
+      //Inc(Pos);
+    end;
+  end;
+
+  // bots:
+  for i := 0 to BattleState.Battle.Bots.Count-1 do
+  begin
+    Script.AddOrChangeKeyValue('GAME/AI'+IntToStr(i)+'/Name',TBot(BattleState.Battle.Bots[i]).Name);
+    Script.AddOrChangeKeyValue('GAME/AI'+IntToStr(i)+'/ShortName',TBot(BattleState.Battle.Bots[i]).AIShortName);
+    Script.AddOrChangeKeyValue('GAME/AI'+IntToStr(i)+'/Team',IntToStr(TBot(BattleState.Battle.Bots[i]).GetTeamNo));
+    for j:=0 to BattleState.Battle.Clients.Count-1 do
+    begin
+      if TClient(BattleState.Battle.Clients[j]).Name = TBot(BattleState.Battle.Bots[i]).OwnerName then
       begin
-        Script.AddOrChangeKeyValue('GAME/PLAYER'+IntToStr(i)+'/Spectator','1');
-      end
-      else
-      begin
-        Script.AddOrChangeKeyValue('GAME/PLAYER'+IntToStr(i)+'/Spectator','0');
-        Script.AddOrChangeKeyValue('GAME/PLAYER'+IntToStr(i)+'/team',IntToStr(PurgedClients[Pos].TeamNo));
-        Inc(Pos);
+        Script.AddOrChangeKeyValue('GAME/AI'+IntToStr(i)+'/Host',IntToStr(j));
+        break;
       end;
     end;
+  end;
 
-  // teams:
-  for i := 0 to NumberOfTeams-1 do
-  begin
-
-    // is there a bot on the team?
-    tmpBool := False;
-    for j := 0 to High(PurgedClients) do if (PurgedClients[j].TeamNo = i) and (PurgedClients[j].Bot) then
+  for i := 0 to BattleState.Battle.Clients.Count-1 do
+    if not Script.keyExists('GAME/TEAM'+IntToStr(TClient(BattleState.Battle.Clients[i]).GetTeamNo)) then
     begin
-      tmpBool := True;
-      Break;
+      Script.AddOrChangeKeyValue('GAME/TEAM'+IntToStr(TClient(BattleState.Battle.Clients[i]).GetTeamNo)+'/TeamLeader',IntToStr(i));
+      Script.AddOrChangeKeyValue('GAME/TEAM'+IntToStr(TClient(BattleState.Battle.Clients[i]).GetTeamNo)+'/AllyTeam',IntToStr(TClient(BattleState.Battle.Clients[i]).GetAllyNo));
+      Script.AddOrChangeKeyValue('GAME/TEAM'+IntToStr(TClient(BattleState.Battle.Clients[i]).GetTeamNo)+'/RgbColor',Misc.ColorToScriptString(TClient(BattleState.Battle.Clients[i]).TeamColor));
+      Script.AddOrChangeKeyValue('GAME/TEAM'+IntToStr(TClient(BattleState.Battle.Clients[i]).GetTeamNo)+'/Side',SideList[TClient(BattleState.Battle.Clients[i]).GetSide]);
+      Script.AddOrChangeKeyValue('GAME/TEAM'+IntToStr(TClient(BattleState.Battle.Clients[i]).GetTeamNo)+'/Handicap',IntToStr(TClient(BattleState.Battle.Clients[i]).GetHandicap));
+      Inc(NumberOfTeams);
     end;
 
-    for j := 0 to High(PurgedClients) do if (PurgedClients[j].TeamNo = i) and (PurgedClients[j].Bot or not tmpBool) then
+  for i := 0 to BattleState.Battle.Bots.Count-1 do
+    if not Script.keyExists('GAME/TEAM'+IntToStr(TBot(BattleState.Battle.Bots[i]).GetTeamNo)) then
     begin
-      if tmpBool then
+      for j:=0 to BattleState.Battle.Clients.Count-1 do
       begin
-        index := MainForm.GetClientIndexEx(TBot(BattleState.Battle.Bots[PurgedClients[j].ClientIndex]).OwnerName, BattleState.Battle.Clients);
-        if index = -1 then
+        if TClient(BattleState.Battle.Clients[j]).Name = TBot(BattleState.Battle.Bots[i]).OwnerName then
         begin
-          MessageDlg(_('Error: bot owner not found in client list. Generating script file failed!'), mtError, [mbOK], 0);
-          Exit;
+          Script.AddOrChangeKeyValue('GAME/TEAM'+IntToStr(TBot(BattleState.Battle.Bots[i]).GetTeamNo)+'/TeamLeader',IntToStr(j));
+          break;
         end;
-        Script.AddOrChangeKeyValue('GAME/TEAM'+IntToStr(i)+'/TeamLeader',IntToStr(index));
-      end
-      else
-        Script.AddOrChangeKeyValue('GAME/TEAM'+IntToStr(i)+'/TeamLeader',IntToStr(PurgedClients[j].ClientIndex));
-
-      Script.AddOrChangeKeyValue('GAME/TEAM'+IntToStr(i)+'/AllyTeam',IntToStr(PurgedClients[j].AllyNo));
-      Script.AddOrChangeKeyValue('GAME/TEAM'+IntToStr(i)+'/RGBColor',FloatToStrF(Misc.ColorToR(PurgedClients[j].TeamColor) / 255, ffFixed, 5, 5) + ' ' + FloatToStrF(Misc.ColorToG(PurgedClients[j].TeamColor) / 255, ffFixed, 5, 5)+ ' ' + FloatToStrF(Misc.ColorToB(PurgedClients[j].TeamColor) / 255, ffFixed, 5, 5));
-      Script.AddOrChangeKeyValue('GAME/TEAM'+IntToStr(i)+'/Side',SideList[PurgedClients[j].Side]);
-      Script.AddOrChangeKeyValue('GAME/TEAM'+IntToStr(i)+'/Handicap',IntToStr(PurgedClients[j].Handicap));
-      if tmpBool then
-        if (Length(TBot(BattleState.Battle.Bots[PurgedClients[j].ClientIndex]).AIDll) &gt; 6) and (LeftStr(TBot(BattleState.Battle.Bots[PurgedClients[j].ClientIndex]).AIDll,6) = 'LuaAI:') then
-          Script.AddOrChangeKeyValue('GAME/TEAM'+IntToStr(i)+'/AIDLL',TBot(BattleState.Battle.Bots[PurgedClients[j].ClientIndex]).AIDll)
-        else
-          Script.AddOrChangeKeyValue('GAME/TEAM'+IntToStr(i)+'/AIDLL',AIDLL_FOLDER + '/' + TBot(BattleState.Battle.Bots[PurgedClients[j].ClientIndex]).AIDll);
-      Break;
+      end;
+      Script.AddOrChangeKeyValue('GAME/TEAM'+IntToStr(TBot(BattleState.Battle.Bots[i]).GetTeamNo)+'/AllyTeam',IntToStr(TBot(BattleState.Battle.Bots[i]).GetAllyNo));
+      Script.AddOrChangeKeyValue('GAME/TEAM'+IntToStr(TBot(BattleState.Battle.Bots[i]).GetTeamNo)+'/RgbColor',Misc.ColorToScriptString(TBot(BattleState.Battle.Bots[i]).TeamColor));
+      Script.AddOrChangeKeyValue('GAME/TEAM'+IntToStr(TBot(BattleState.Battle.Bots[i]).GetTeamNo)+'/Side',SideList[TBot(BattleState.Battle.Bots[i]).GetSide]);
+      Script.AddOrChangeKeyValue('GAME/TEAM'+IntToStr(TBot(BattleState.Battle.Bots[i]).GetTeamNo)+'/Handicap',IntToStr(TBot(BattleState.Battle.Bots[i]).GetHandicap));
+      Inc(NumberOfTeams);
+    end
+    else
+    begin
+      raise Exception.Create('An AI tries to control an existing team.');
     end;
-  end;
-  // ally teams:
-  for i := 0 to NumberOfAllyTeams-1 do
-  begin
-    Script.AddOrChangeKeyValue('GAME/ALLYTEAM'+IntToStr(i)+'/NumAllies','0'); // this number is not important
 
-    if StartPosRadioGroup.ItemIndex = 2 then
-      for j := 0 to High(BattleState.StartRects) do
-        if BattleState.StartRects[j].Enabled then if AllyToPurgedAlly[j] = i then
-        begin
-          Script.AddOrChangeKeyValue('GAME/ALLYTEAM'+IntToStr(i)+'/StartRectLeft',FloatToStr(BattleState.StartRects[j].Rect.Left / 100));
-          Script.AddOrChangeKeyValue('GAME/ALLYTEAM'+IntToStr(i)+'/StartRectTop',FloatToStr(BattleState.StartRects[j].Rect.Top / 100));
-          Script.AddOrChangeKeyValue('GAME/ALLYTEAM'+IntToStr(i)+'/StartRectRight',FloatToStr(BattleState.StartRects[j].Rect.Right / 100));
-          Script.AddOrChangeKeyValue('GAME/ALLYTEAM'+IntToStr(i)+'/StartRectBottom',FloatToStr(BattleState.StartRects[j].Rect.Bottom / 100));
-          Break;
-        end;
+  Script.AddOrChangeKeyValue('GAME/NumTeams',IntToStr(NumberOfTeams));
+
+  if StartPosRadioGroup.ItemIndex = 2 then
+  begin
+    for i:=0 to High(BattleState.StartRects) do
+      if BattleState.StartRects[i].Enabled then
+      begin
+        Script.AddOrChangeKeyValue('GAME/ALLYTEAM'+IntToStr(i)+'/NumAllies','0'); // this number is not important
+        Script.AddOrChangeKeyValue('GAME/ALLYTEAM'+IntToStr(i)+'/StartRectLeft',FloatToStr(BattleState.StartRects[i].Rect.Left / 100));
+        Script.AddOrChangeKeyValue('GAME/ALLYTEAM'+IntToStr(i)+'/StartRectTop',FloatToStr(BattleState.StartRects[i].Rect.Top / 100));
+        Script.AddOrChangeKeyValue('GAME/ALLYTEAM'+IntToStr(i)+'/StartRectRight',FloatToStr(BattleState.StartRects[i].Rect.Right / 100));
+        Script.AddOrChangeKeyValue('GAME/ALLYTEAM'+IntToStr(i)+'/StartRectBottom',FloatToStr(BattleState.StartRects[i].Rect.Bottom / 100));
+      end;
   end;
+  for i:=0 to BattleState.Battle.Clients.Count-1 do
+    Script.AddOrChangeKeyValue('GAME/ALLYTEAM'+IntToStr(TClient(BattleState.Battle.Clients[i]).GetAllyNo)+'/NumAllies','0');
+  for i:=0 to BattleState.Battle.Bots.Count-1 do
+    Script.AddOrChangeKeyValue('GAME/ALLYTEAM'+IntToStr(TBot(BattleState.Battle.Bots[i]).GetAllyNo)+'/NumAllies','0');
+
   // restrictions:
   Script.AddOrChangeKeyValue('GAME/NumRestrictions',IntToStr(BattleState.DisabledUnits.Count));
   for i := 0 to BattleState.DisabledUnits.Count-1 do
@@ -2427,7 +2364,7 @@
 
   // map options:
   for i:=0 to MapOptionsList.Count -1 do
-    if TLuaOption(ModOptionsList[i]).ClassType &lt;&gt; TLuaOptionSection then
+    if TLuaOption(MapOptionsList[i]).ClassType &lt;&gt; TLuaOptionSection then
       Script.AddOrChangeKeyValue(TLuaOption(MapOptionsList[i]).KeyPrefix + TLuaOption(MapOptionsList[i]).Key,TLuaOption(MapOptionsList[i]).toString);
 
   // unknown setscripttags
@@ -2456,7 +2393,6 @@
   end;
   until not tryToRewriteScript;
   Script.Free;
-  Finalize(PurgedClients);
 end;
 
 function TBattleForm.GenerateReplayScriptFile(FileName: string):Boolean;
@@ -2759,9 +2695,9 @@
   with GetMapItem(CurrentMapIndex) do
   begin
     if (MapInfo.Width = 0) or (MapInfo.Height = 0) then Exit;
-    if MapInfo.Width &gt; MapInfo.Height then
+    if MapInfo.Width &gt; MapInfo.Height*3/2 then
     begin
-      MinimapZoomedForm.ClientWidth := 600;
+      MinimapZoomedForm.ClientWidth := 900;
       MinimapZoomedForm.ClientHeight := Round(MinimapZoomedForm.ClientWidth * MapInfo.Height / MapInfo.Width);
     end
     else
@@ -2773,7 +2709,7 @@
 
   if (BattleState.SelectedStartRect &gt; -1) and IsBattleActive then
   begin
-    MyAllyNoButton.Caption := IntToStr(BattleState.SelectedStartRect+1);
+    MyAllyNoButton.ValueAsInteger := BattleState.SelectedStartRect+1;
     if not IsBattleActive then Exit;
     SendMyBattleStatusToServer;
     Exit;
@@ -2884,7 +2820,7 @@
   begin
     with BattleState.StartRects[BattleState.DrawingStartRect].Rect do
     begin
-      if (Abs(Right - Left) &lt; 10) or (Abs(Bottom - Top) &lt; 10) then
+      if (Abs(Right - Left) &lt; 5) or (Abs(Bottom - Top) &lt; 5) then
       begin // let's cancel the startrect, since it's too small
         RemoveStartRect(BattleState.DrawingStartRect);
         BattleState.DrawingStartRect := -1;
@@ -2911,7 +2847,7 @@
   begin
     with BattleState.StartRects[BattleState.MovingStartRect].Rect do
     begin
-      if (Abs(Right - Left) &lt; 10) or (Abs(Bottom - Top) &lt; 10) then
+      if (Abs(Right - Left) &lt; 5) or (Abs(Bottom - Top) &lt; 5) then
       begin // let's cancel the startrect, since it's too small
         RemoveStartRect(BattleState.MovingStartRect);
         MainForm.TryToSendCommand('REMOVESTARTRECT', IntToStr(BattleState.MovingStartRect));
@@ -2930,7 +2866,7 @@
   begin
     with BattleState.StartRects[BattleState.ResizingStartRect].Rect do
     begin
-      if (Abs(Right - Left) &lt; 10) or (Abs(Bottom - Top) &lt; 10) then
+      if (Abs(Right - Left) &lt; 5) or (Abs(Bottom - Top) &lt; 5) then
       begin // let's cancel the startrect, since it's too small
         RemoveStartRect(BattleState.ResizingStartRect);
         MainForm.TryToSendCommand('REMOVESTARTRECT', IntToStr(BattleState.ResizingStartRect));
@@ -3636,8 +3572,8 @@
 begin
   if FigureOutBestPossibleTeamAllyAndColor(False, team, ally, color) then
   begin
-    AddBotForm.BotTeamButton.Caption := IntToStr(team+1);
-    AddBotForm.BotAllyButton.Caption := IntToStr(ally+1);
+    AddBotForm.BotTeamButton.ValueAsInteger := team+1;
+    AddBotForm.BotAllyButton.ValueAsInteger := ally+1;
     AddBotForm.ChangeTeamColor(color);
   end;
 
@@ -3767,31 +3703,7 @@
   cell with number 1 on it. &quot;UnderControl&quot; is the control under which the
   dialog should be displayed. }
 function TBattleForm.ChooseNumberDialog(UnderControl: TControl; DefaultIndex: Integer): Integer;
-var
-  p: TPoint;
-  Item: TTBCustomItem;
 begin
-  if DefaultIndex = -1 then
-    TBXToolPalette1.SelectedCell := Point(-1, -1)
-  else
-    TBXToolPalette1.SelectedCell := Point(DefaultIndex mod TBXToolPalette1.ColCount, DefaultIndex div TBXToolPalette1.ColCount);
-
-  p := UnderControl.ClientToScreen(Point(0, UnderControl.Height));
-  Item := ChooseNumberPopupMenu.PopupEx(p.X, p.Y, nil, False);
-
-  if Item = nil then
-  begin
-    Result := -1;
-    Exit;
-  end;
-
-  if Item.ClassType &lt;&gt; TTBXToolPalette then
-  begin
-    Result := -1;
-    Exit;
-  end;
-
-  Result := Item.Tag;
 end;
 
 { returns -1 if user cancels the dialog, otherwise returns side index.
@@ -3831,36 +3743,6 @@
   Sender.Tag := ACol + ARow * (Sender as TTBXToolPalette).ColCount;
 end;
 
-procedure TBattleForm.MyTeamNoButtonClick(Sender: TObject);
-var
-  Index: Integer;
-begin
-  Index := ChooseNumberDialog(Sender as TControl, StrToInt(MyTeamNoButton.Caption)-1);
-  if Index = -1 then Exit;
-
-  if StrToInt(MyTeamNoButton.Caption)-1 = Index then Exit; // no change
-  MyTeamNoButton.Caption := IntToStr(Index+1);
-
-  // update info:
-  if not IsBattleActive then Exit;
-  SendMyBattleStatusToServer;
-end;
-
-procedure TBattleForm.MyAllyNoButtonClick(Sender: TObject);
-var
-  Index: Integer;
-begin
-  Index := ChooseNumberDialog(Sender as TControl, StrToInt(MyAllyNoButton.Caption)-1);
-  if Index = -1 then Exit;
-
-  if StrToInt(MyAllyNoButton.Caption)-1 = Index then Exit; // no change
-  MyAllyNoButton.Caption := IntToStr(Index+1);
-
-  // update info:
-  if not IsBattleActive then Exit;
-  SendMyBattleStatusToServer;
-end;
-
 procedure TBattleForm.VDTBattleClientsGetNodeWidth(
   Sender: TBaseVirtualTree; HintCanvas: TCanvas; Node: PVirtualNode;
   Column: TColumnIndex; var NodeWidth: Integer);
@@ -4530,7 +4412,7 @@
         NormalBot:
         begin
           // AI (dll file name):
-          s := TBot(BattleState.Battle.Bots[RealIndex]).AIDll;
+          s := TBot(BattleState.Battle.Bots[RealIndex]).AIShortName;
           Canvas.TextOut(R.Left + Pos, R.Top, s);
         end;
         OriginalClient:
@@ -4923,7 +4805,7 @@
 
 procedure TBattleForm.SetBotLibItemClick(Sender: TObject);
 begin
-  TBot(BattleState.Battle.Bots[(Sender as TSpTBXItem).Tag]).AIDll := (Sender as TSpTBXItem).Caption;
+  TBot(BattleState.Battle.Bots[(Sender as TSpTBXItem).Tag]).AIShortName := (Sender as TSpTBXItem).Caption;
 end;
 
 procedure TBattleForm.UnbanItemClick(Sender: TObject);
@@ -5140,13 +5022,13 @@
 procedure TBattleForm.RefreshTeamNbr;
 var
   i : integer;
-  nb : array [1..16] of Integer;
+  nb : array [1..MAX_TEAMS] of Integer;
   nbPlayers: integer;
   nbSpecs: integer;
   msg : string;
 begin
   if BattleState.Status &lt;&gt; None then begin
-    for i:= 1 to 16 do begin
+    for i:= 1 to MAX_TEAMS do begin
       nb[i] := 0;
     end;
     nbPlayers := 0;
@@ -5160,7 +5042,7 @@
         nbSpecs := nbSpecs + 1;
     end;
     msg := '';
-    for i:=1 to 16 do begin
+    for i:=1 to MAX_TEAMS do begin
       if nb[i] &gt; 0 then begin
         if msg &lt;&gt; '' then begin
           msg := msg + #13#10;
@@ -5908,11 +5790,11 @@
 function TBattleForm.LadderTeamReady:boolean;
 var
   i : integer;
-  nb : array [1..16] of Integer;
+  nb : array [1..MAX_TEAMS] of Integer;
   nbTeam : integer;
 begin
   if (BattleState.Status &lt;&gt; None) and (BattleState.LadderIndex &gt;=0) then begin
-    for i:= 1 to 16 do begin
+    for i:= 1 to MAX_TEAMS do begin
       nb[i] := 0;
     end;
     for i:=0 to BattleState.Battle.Clients.Count-1 do begin
@@ -5923,7 +5805,7 @@
     with TLadder(LadderList[BattleState.LadderIndex]) do begin
       Result := False;
       nbTeam := 0;
-      for i:= 1 to 16 do
+      for i:= 1 to MAX_TEAMS do
         if nb[i] &gt; 0 then begin
           nbTeam := nbTeam +1;
           if (nbTeam &gt; 2) or (nb[i] &lt; MinPlayersPerAllyTeam) or (nb[i] &gt; MaxPlayersPerAllyTeam) then
@@ -6409,6 +6291,11 @@
     BattleForm.RefreshQuickLookText;
 end;
 
+function TLuaOption.isDefault:Boolean;
+begin
+  Result := DefaultValue = Value;
+end;
+
 procedure TLuaOptionString.SetValue(v: String);
 begin
   inherited;
@@ -6421,6 +6308,11 @@
   InputEdit.Text := DefaultValue;
 end;
 
+function TLuaOptionString.isDefault:Boolean;
+begin
+  Result := InputEdit.Text = DefaultValue;
+end;
+
 procedure TLuaOptionList.SetValue(v: String);
 begin
   inherited;
@@ -6433,6 +6325,11 @@
   ComboBox.ItemIndex := Max(0,KeyList.IndexOf(DefaultValue));
 end;
 
+function TLuaOptionList.isDefault:Boolean;
+begin
+  Result := Max(0,KeyList.IndexOf(DefaultValue)) = ComboBox.ItemIndex;
+end;
+
 procedure TLuaOptionBool.SetValue(v: String);
 begin
   inherited;
@@ -6443,6 +6340,11 @@
 begin
 end;
 
+function TLuaOptionSection.isDefault:Boolean;
+begin
+  Result := True;
+end;
+
 procedure TLuaOptionSection.SetValue(v: String);
 begin
 end;
@@ -6453,6 +6355,12 @@
   CheckBox.Checked := StrToBool(DefaultValue);
 end;
 
+function TLuaOptionBool.isDefault:Boolean;
+begin
+  Result := StrToBool(DefaultValue) = CheckBox.Checked;
+end;
+
+
 procedure TLuaOptionNumber.SetValue(v: String);
 begin
   inherited;
@@ -6462,9 +6370,14 @@
 procedure TLuaOptionNumber.setToDefault;
 begin
   inherited;
-  InputEdit.Text := DefaultValue;
+  InputEdit.Value := StrToFloat(DefaultValue);
 end;
 
+function TLuaOptionNumber.isDefault:Boolean;
+begin
+  Result := RoundTo(InputEdit.Value,-5) = RoundTo(StrToFloat(DefaultValue),-5);
+end;
+
 procedure TLuaOption.Enable;
 begin
   // nothing
@@ -7087,6 +7000,7 @@
 procedure TBattleForm.MapsTabsActiveTabChange(Sender: TObject;
   TabIndex: Integer);
 begin
+  SetSelectedStartRect(-1);
   if TabIndex = 0 then
     MapImageMouseMove(MapImage,[],0,0)
   else if TabIndex = 1 then
@@ -7114,6 +7028,10 @@
     QuickLookRichEdit.SelAttributes.Size := 8;
     QuickLookRichEdit.SelAttributes.Color := clWindowText;
   end;
+  procedure SetNotDefaultAttr;
+  begin
+    QuickLookRichEdit.SelAttributes.Color := $b321a4;
+  end;
   procedure SetHasChangedAttr;
   begin
     QuickLookRichEdit.SelAttributes.Name := 'MS Sans Serif';
@@ -7127,7 +7045,7 @@
     QuickLookRichEdit.SelText := str+EOL;
     QuickLookHints.Add(str);
   end;
-  procedure AddLine(caption: string;value: string; valueHasChanged: boolean = false; hint: string = '');
+  procedure AddLine(caption: string;value: string;defaultValue: boolean = false; valueHasChanged: boolean = false; hint: string = '');
   begin
     if valueHasChanged then
       SetHasChangedAttr
@@ -7135,6 +7053,8 @@
       SetNormalAttr;
     QuickLookRichEdit.SelText := caption +': ';
     QuickLookRichEdit.SelAttributes.Style := [fsBold];
+    if not defaultValue then
+      SetNotDefaultAttr;
     QuickLookRichEdit.SelText := value + EOL;
     QuickLookHints.Add(hint);
   end;
@@ -7154,15 +7074,15 @@
   end;
 
   AddTitle(_('Game options'));
-  AddLine('Start position',StartPosRadioGroup.Items[StartPosRadioGroup.ItemIndex],StartPosRadioGroup.ItemIndex &lt;&gt; StartPosRadioGroup.Tag,StartPosRadioGroup.Hint);
+  AddLine('Start position',StartPosRadioGroup.Items[StartPosRadioGroup.ItemIndex],true,StartPosRadioGroup.ItemIndex &lt;&gt; StartPosRadioGroup.Tag,StartPosRadioGroup.Hint);
   if GameEndRadioGroup.Visible and (GameEndRadioGroup.ItemIndex &gt; -1) then
-    AddLine('Game end condition',GameEndRadioGroup.Items[GameEndRadioGroup.ItemIndex],GameEndRadioGroup.ItemIndex &lt;&gt; GameEndRadioGroup.Tag,GameEndRadioGroup.Hint);
+    AddLine('Game end condition',GameEndRadioGroup.Items[GameEndRadioGroup.ItemIndex],true,GameEndRadioGroup.ItemIndex &lt;&gt; GameEndRadioGroup.Tag,GameEndRadioGroup.Hint);
   if MetalTracker.Visible then
-    AddLine(lblMetal.Caption,IntToStr(MetalTracker.Value),MetalTracker.Value &lt;&gt; MetalTracker.Tag,MetalTracker.Hint);
+    AddLine(lblMetal.Caption,IntToStr(MetalTracker.Value),true,MetalTracker.Value &lt;&gt; MetalTracker.Tag,MetalTracker.Hint);
   if EnergyTracker.Visible then
-    AddLine(lblEnergy.Caption,IntToStr(EnergyTracker.Value),EnergyTracker.Value &lt;&gt; EnergyTracker.Tag,EnergyTracker.Hint);
+    AddLine(lblEnergy.Caption,IntToStr(EnergyTracker.Value),true,EnergyTracker.Value &lt;&gt; EnergyTracker.Tag,EnergyTracker.Hint);
   if UnitsTracker.Visible then
-    AddLine(lblUnits.Caption,IntToStr(UnitsTracker.Value),UnitsTracker.Value &lt;&gt; UnitsTracker.Tag,UnitsTracker.Hint);
+    AddLine(lblUnits.Caption,IntToStr(UnitsTracker.Value),true,UnitsTracker.Value &lt;&gt; UnitsTracker.Tag,UnitsTracker.Hint);
 
   if ModOptionsList.Count &gt; 0 then
   begin
@@ -7170,12 +7090,12 @@
     for i:=0 to ModOptionsList.Count-1 do
       if TLuaOption(ModOptionsList[i]).ClassType &lt;&gt; TLuaOptionSection then
         if TLuaOption(ModOptionsList[i]).ClassType = TLuaOptionBool then
-          AddLine(TLuaOption(ModOptionsList[i]).Name,BoolToStr(TLuaOption(ModOptionsList[i]).toString &lt;&gt; '0',true),TLuaOption(ModOptionsList[i]).hasChanged,TLuaOption(ModOptionsList[i]).Description)
+          AddLine(TLuaOption(ModOptionsList[i]).Name,BoolToStr(TLuaOption(ModOptionsList[i]).toString &lt;&gt; '0',true),TLuaOption(ModOptionsList[i]).isDefault,TLuaOption(ModOptionsList[i]).hasChanged,TLuaOption(ModOptionsList[i]).Description)
         else
           if TLuaOption(ModOptionsList[i]).ClassType = TLuaOptionList then
-            AddLine(TLuaOption(ModOptionsList[i]).Name,TLuaOptionList(ModOptionsList[i]).nameToString,TLuaOption(ModOptionsList[i]).hasChanged,TLuaOption(ModOptionsList[i]).Description)
+            AddLine(TLuaOption(ModOptionsList[i]).Name,TLuaOptionList(ModOptionsList[i]).nameToString,TLuaOption(ModOptionsList[i]).isDefault,TLuaOption(ModOptionsList[i]).hasChanged,TLuaOption(ModOptionsList[i]).Description)
           else
-            AddLine(TLuaOption(ModOptionsList[i]).Name,TLuaOption(ModOptionsList[i]).toString,TLuaOption(ModOptionsList[i]).hasChanged,TLuaOption(ModOptionsList[i]).Description);
+            AddLine(TLuaOption(ModOptionsList[i]).Name,TLuaOption(ModOptionsList[i]).toString,TLuaOption(ModOptionsList[i]).isDefault,TLuaOption(ModOptionsList[i]).hasChanged,TLuaOption(ModOptionsList[i]).Description);
   end;
 
   if MapOptionsList.Count &gt; 0 then
@@ -7184,12 +7104,12 @@
     for i:=0 to MapOptionsList.Count-1 do
       if TLuaOption(MapOptionsList[i]).ClassType &lt;&gt; TLuaOptionSection then
         if TLuaOption(MapOptionsList[i]).ClassType = TLuaOptionBool then
-          AddLine(TLuaOption(MapOptionsList[i]).Name,BoolToStr(TLuaOption(MapOptionsList[i]).toString &lt;&gt; '0',true),TLuaOption(MapOptionsList[i]).hasChanged,TLuaOption(MapOptionsList[i]).Description)
+          AddLine(TLuaOption(MapOptionsList[i]).Name,BoolToStr(TLuaOption(MapOptionsList[i]).toString &lt;&gt; '0',true),TLuaOption(MapOptionsList[i]).toString &lt;&gt; TLuaOption(MapOptionsList[i]).DefaultValue,TLuaOption(MapOptionsList[i]).hasChanged,TLuaOption(MapOptionsList[i]).Description)
         else
           if TLuaOption(MapOptionsList[i]).ClassType = TLuaOptionList then
-            AddLine(TLuaOption(MapOptionsList[i]).Name,TLuaOptionList(MapOptionsList[i]).nameToString,TLuaOption(MapOptionsList[i]).hasChanged,TLuaOption(MapOptionsList[i]).Description)
+            AddLine(TLuaOption(MapOptionsList[i]).Name,TLuaOptionList(MapOptionsList[i]).nameToString,TLuaOption(MapOptionsList[i]).toString &lt;&gt; TLuaOption(MapOptionsList[i]).DefaultValue,TLuaOption(MapOptionsList[i]).hasChanged,TLuaOption(MapOptionsList[i]).Description)
           else
-            AddLine(TLuaOption(MapOptionsList[i]).Name,TLuaOption(MapOptionsList[i]).toString,TLuaOption(MapOptionsList[i]).hasChanged,TLuaOption(MapOptionsList[i]).Description);
+            AddLine(TLuaOption(MapOptionsList[i]).Name,TLuaOption(MapOptionsList[i]).toString,TLuaOption(MapOptionsList[i]).toString &lt;&gt; TLuaOption(MapOptionsList[i]).DefaultValue,TLuaOption(MapOptionsList[i]).hasChanged,TLuaOption(MapOptionsList[i]).Description);
   end;
 
   if BattleState.DisabledUnits.Count &gt; 0 then
@@ -7302,4 +7222,16 @@
    end;
 end;
 
+procedure TBattleForm.MyTeamNoButtonExit(Sender: TObject);
+begin
+  if not IsBattleActive then Exit;
+  SendMyBattleStatusToServer;
+end;
+
+procedure TBattleForm.MyAllyNoButtonExit(Sender: TObject);
+begin
+  if not IsBattleActive then Exit;
+  SendMyBattleStatusToServer;
+end;
+
 end.

Modified: Lobby/TASClient/CustomizeGUIFormUnit.dfm
===================================================================
--- Lobby/TASClient/CustomizeGUIFormUnit.dfm	2009-05-28 11:37:21 UTC (rev 7254)
+++ Lobby/TASClient/CustomizeGUIFormUnit.dfm	2009-05-28 21:16:55 UTC (rev 7255)
@@ -1,6 +1,6 @@
 object CustomizeGUIForm: TCustomizeGUIForm
-  Left = 377
-  Top = 221
+  Left = 568
+  Top = 230
   Width = 712
   Height = 520
   Caption = 'Poweruser window'

Modified: Lobby/TASClient/CustomizeGUIFormUnit.pas
===================================================================
--- Lobby/TASClient/CustomizeGUIFormUnit.pas	2009-05-28 11:37:21 UTC (rev 7254)
+++ Lobby/TASClient/CustomizeGUIFormUnit.pas	2009-05-28 21:16:55 UTC (rev 7255)
@@ -349,7 +349,8 @@
   SetValuesForm.SetValues.Selection := s;
   SetValuesForm.SetValues.Refresh;
 
-  SetValuesForm.SetValues.Row := 1;
+  if SetValuesForm.SetValues.RowCount &gt; 1 then
+    SetValuesForm.SetValues.Row := 1;
 
   SetValuesForm.DisplayedProperty := Self;
   GetCursorPos(p);
@@ -402,6 +403,7 @@
   p: TProperty;
   s: TGridRect;
 begin
+  LockWindowUpdate(Self.Handle);
   Properties.Clear;
   if PropertiesListEditor.Cells[0,0] &lt;&gt; '' then
     for i:=PropertiesListEditor.RowCount-1 downto 0 do
@@ -450,6 +452,7 @@
   s.Bottom := 0;
   PropertiesListEditor.Selection := s;
   PropertiesListEditor.Refresh;
+  LockWindowUpdate(0);
 
   if propNames.Count &gt; 1 then
     PropertiesListEditor.Row := 1;

Modified: Lobby/TASClient/HostBattleFormUnit.dfm
===================================================================
--- Lobby/TASClient/HostBattleFormUnit.dfm	2009-05-28 11:37:21 UTC (rev 7254)
+++ Lobby/TASClient/HostBattleFormUnit.dfm	2009-05-28 21:16:55 UTC (rev 7255)
@@ -1,13 +1,13 @@
 object HostBattleForm: THostBattleForm
-  Left = 847
-  Top = 104
+  Left = 547
+  Top = 190
   BorderStyle = bsDialog
   Caption = 'Host battle'
   ClientHeight = 355
   ClientWidth = 331
   Color = clBtnFace
-  Constraints.MaxHeight = 1000
-  Constraints.MaxWidth = 1680
+  Constraints.MaxHeight = 750
+  Constraints.MaxWidth = 1280
   Font.Charset = DEFAULT_CHARSET
   Font.Color = clWindowText
   Font.Height = -11
@@ -325,7 +325,6 @@
     object HostLadder1: TMenuItem
       Caption = 'Host a ladder game'
       RadioItem = True
-      Visible = False
       OnClick = HostLadder1Click
     end
     object HostReplay1: TMenuItem

Modified: Lobby/TASClient/HostBattleFormUnit.pas
===================================================================
--- Lobby/TASClient/HostBattleFormUnit.pas	2009-05-28 11:37:21 UTC (rev 7254)
+++ Lobby/TASClient/HostBattleFormUnit.pas	2009-05-28 21:16:55 UTC (rev 7255)
@@ -451,6 +451,8 @@
   ModsComboBox.Items.Assign(Utility.ModList);
   ModsComboBox.ItemIndex := 0;
 
+  PlayersTracker.Maximum := MAX_TEAMS;
+
   RankComboBox.Items.Add('(No limit)');
   for i := 1 to High(Ranks) do RankComboBox.Items.Add(Ranks[i]);
   RankComboBox.ItemIndex := 0;
@@ -511,7 +513,7 @@
   RefreshButton.Visible := False;
 
   PlayersTracker.Minimum := 2;
-  PlayersTracker.Maximum := 16;
+  PlayersTracker.Maximum := MAX_TEAMS;
 
   Label3.Visible := True;
   Label8.Visible := True;
@@ -550,6 +552,7 @@
 
   if not LobbyScriptUnit.ScriptHostingReplayRunning then
   begin
+    ReplaysForm.Close;
     if ReplaysForm.ShowModal &lt;&gt; mrOK then
     begin
       ReplaysForm.WatchButton.Visible := True;
@@ -710,7 +713,7 @@
   if ladder.ModName &lt;&gt; '' then begin
     if ladder.MinPlayersPerAllyTeam = ladder.MaxPlayersPerAllyTeam then begin
       PlayersTracker.Minimum := 2;
-      PlayersTracker.Maximum := 16;
+      PlayersTracker.Maximum := MAX_TEAMS;
       PlayersTracker.Value := ladder.MinPlayersPerAllyTeam*2;
       PlayersTracker.Enabled := False;
     end

Modified: Lobby/TASClient/HttpGetUnit.dfm
===================================================================
--- Lobby/TASClient/HttpGetUnit.dfm	2009-05-28 11:37:21 UTC (rev 7254)
+++ Lobby/TASClient/HttpGetUnit.dfm	2009-05-28 21:16:55 UTC (rev 7255)
@@ -1,13 +1,13 @@
 object HttpGetForm: THttpGetForm
-  Left = 980
-  Top = 284
+  Left = 671
+  Top = 442
   BorderStyle = bsDialog
   Caption = 'File download 4'
   ClientHeight = 178
   ClientWidth = 281
   Color = clBtnFace
-  Constraints.MaxHeight = 1000
-  Constraints.MaxWidth = 1680
+  Constraints.MaxHeight = 750
+  Constraints.MaxWidth = 1280
   Font.Charset = DEFAULT_CHARSET
   Font.Color = clWindowText
   Font.Height = -11

Modified: Lobby/TASClient/HttpGetUnit.pas
===================================================================
--- Lobby/TASClient/HttpGetUnit.pas	2009-05-28 11:37:21 UTC (rev 7254)
+++ Lobby/TASClient/HttpGetUnit.pas	2009-05-28 21:16:55 UTC (rev 7255)
@@ -238,6 +238,9 @@
 end;
 
 procedure THttpGetForm.UpdateReceivedStatus;
+var
+  currentSize: integer;
+  fileSize: integer;
 begin
   if not DownloadStatus.Downloading then
   begin
@@ -246,9 +249,14 @@
     Exit;
   end;
 
-  ReceivedLabel.Caption := Format(_('Received %s KB (%i%%)'),[Misc.FormatFileSize(HttpCli1.RcvdStream.Size),Round(HttpCli1.RcvdStream.Size / HttpCli1.ContentLength * 100)]);
-  if HttpCli1.ContentLength = 0 then ProgressBar.Position := 0 else
-    ProgressBar.Position := Round(HttpCli1.RcvdStream.Size / HttpCli1.ContentLength * 100);
+  currentSize := HttpCli1.RcvdStream.Size;
+  fileSize := HttpCli1.ContentLength;
+
+  ReceivedLabel.Caption := Format(_('Received %s KB (%d%%)'),[Misc.FormatFileSize(currentSize),Round(currentSize / fileSize * 100)]);
+  if fileSize = 0 then
+    ProgressBar.Position := 0
+  else
+    ProgressBar.Position := Round(currentSize / fileSize * 100);
 end;
 
 procedure THttpGetForm.FormCreate(Sender: TObject);

Modified: Lobby/TASClient/LobbyScriptUnit.pas
===================================================================
--- Lobby/TASClient/LobbyScriptUnit.pas	2009-05-28 11:37:21 UTC (rev 7254)
+++ Lobby/TASClient/LobbyScriptUnit.pas	2009-05-28 21:16:55 UTC (rev 7255)
@@ -549,7 +549,7 @@
 var
   i: integer;
   pyO: PPyObject;
-
+  pyO2: PPyObject;
 begin
   LockCallback;
   with GetPythonEngine do
@@ -587,6 +587,21 @@
     PyDict_SetItemString(pyCurrentBattle,'MapOptions',pyO);
     Py_XDECREF(pyO);
 
+    pyO := PyDict_New();
+    for i:=0 to Length(BattleState.StartRects)-1 do
+    begin
+      pyO2 := PyDict_New();
+      PyDict_SetItemStringDecRef(pyO2,'Enabled',BattleState.StartRects[i].Enabled);
+      PyDict_SetItemStringDecRef(pyO2,'Left',BattleState.StartRects[i].Rect.Left);
+      PyDict_SetItemStringDecRef(pyO2,'Right',BattleState.StartRects[i].Rect.Right);
+      PyDict_SetItemStringDecRef(pyO2,'Bottom',BattleState.StartRects[i].Rect.Bottom);
+      PyDict_SetItemStringDecRef(pyO2,'Top',BattleState.StartRects[i].Rect.Top);
+      PyDict_SetItem(pyO,PyInt_FromLong(i),pyO2);
+      Py_XDECREF(pyO2);
+    end;
+    PyDict_SetItemString(pyCurrentBattle,'Boxes',pyO);
+    Py_XDECREF(pyO);
+
     Result := PyObjectAsVariant(pyCurrentBattle);
   end;
   UnlockCallback;

Modified: Lobby/TASClient/LogonFormUnit.dfm
===================================================================
--- Lobby/TASClient/LogonFormUnit.dfm	2009-05-28 11:37:21 UTC (rev 7254)
+++ Lobby/TASClient/LogonFormUnit.dfm	2009-05-28 21:16:55 UTC (rev 7255)
@@ -6,8 +6,8 @@
   ClientHeight = 350
   ClientWidth = 310
   Color = clBtnFace
-  Constraints.MaxHeight = 1000
-  Constraints.MaxWidth = 1680
+  Constraints.MaxHeight = 750
+  Constraints.MaxWidth = 1280
   Font.Charset = DEFAULT_CHARSET
   Font.Color = clWindowText
   Font.Height = -11
@@ -26,6 +26,8 @@
     Width = 310
     Height = 350
     Caption = 'Logon'
+    FixedSize = True
+    Options.Maximize = False
     object gbServerSettings: TSpTBXGroupBox
       Left = 16
       Top = 40

Modified: Lobby/TASClient/MainUnit.dfm
===================================================================
--- Lobby/TASClient/MainUnit.dfm	2009-05-28 11:37:21 UTC (rev 7254)
+++ Lobby/TASClient/MainUnit.dfm	2009-05-28 21:16:55 UTC (rev 7255)
@@ -1,12 +1,12 @@
 object MainForm: TMainForm
-  Left = 474
-  Top = 389
-  Width = 854
-  Height = 549
+  Left = 313
+  Top = 155
+  Width = 850
+  Height = 538
   Caption = '.'
   Color = clBtnFace
-  Constraints.MaxHeight = 1000
-  Constraints.MaxWidth = 1680
+  Constraints.MaxHeight = 750
+  Constraints.MaxWidth = 1280
   Font.Charset = DEFAULT_CHARSET
   Font.Color = clWindowText
   Font.Height = -11
@@ -24,8 +24,8 @@
   object MainTitleBar: TSpTBXTitleBar
     Left = 0
     Top = 0
-    Width = 846
-    Height = 522
+    Width = 842
+    Height = 511
     Caption = 'TASClient'
     TBXStyleBackground = True
     object DefaultSideImage: TImage
@@ -206,8 +206,8 @@
     object Panel1: TSpTBXPanel
       Left = 4
       Top = 112
-      Width = 838
-      Height = 406
+      Width = 834
+      Height = 395
       Caption = 'Panel1'
       Align = alClient
       TabOrder = 1
@@ -215,8 +215,8 @@
       TBXStyleBackground = True
       object Panel3: TPanel
         Left = 2
-        Top = 134
-        Width = 834
+        Top = 123
+        Width = 830
         Height = 270
         Align = alBottom
         BevelOuter = bvNone
@@ -224,7 +224,7 @@
         object BattlesPanel: TSpTBXPanel
           Left = 0
           Top = 0
-          Width = 834
+          Width = 830
           Height = 270
           Align = alClient
           TabOrder = 0
@@ -233,7 +233,7 @@
           object QuickJoinPanel: TSpTBXPanel
             Left = 2
             Top = 2
-            Width = 830
+            Width = 826
             Height = 25
             Hint = 'Quick join panel'
             Caption = 'QuickJoinPanel'
@@ -241,7 +241,7 @@
             TabOrder = 1
             Borders = False
             DesignSize = (
-              830
+              826
               25)
             object SpTBXLabel1: TSpTBXLabel
               Left = 0
@@ -265,14 +265,14 @@
               LinkFont.Style = [fsUnderline]
             end
             object btSpecatateNow: TSpTBXButton
-              Left = 696
+              Left = 692
               Top = 0
               Width = 132
               Height = 22
               Hint = 
-                'Will join the first full battle or with the best ratio players/m' +
-                'axplayers ratio in spectator mode.'
-              Caption = 'Spectate now'
+                'Allow you to automaticaly join battles according to your prefere' +
+                'nces'
+              Caption = 'Quick join'
               Anchors = [akTop, akRight]
               Font.Charset = DEFAULT_CHARSET
               Font.Color = clWindowText
@@ -283,39 +283,13 @@
               ParentShowHint = False
               ShowHint = True
               TabOrder = 1
-              OnClick = btSpecatateNowClick
+              DropDownMenu = AutojoinPopupMenu
               LinkFont.Charset = DEFAULT_CHARSET
               LinkFont.Color = clBlue
               LinkFont.Height = -11
               LinkFont.Name = 'MS Sans Serif'
               LinkFont.Style = [fsUnderline]
             end
-            object btPlayNow: TSpTBXButton
-              Left = 560
-              Top = 0
-              Width = 132
-              Height = 22
-              Hint = 
-                'Will try to join the battle with the best players/maxplayers rat' +
-                'io.'
-              Caption = 'Play now'
-              Anchors = [akTop, akRight]
-              Font.Charset = DEFAULT_CHARSET
-              Font.Color = clWindowText
-              Font.Height = -11
-              Font.Name = 'MS Sans Serif'
-              Font.Style = [fsBold]
-              ParentFont = False
-              ParentShowHint = False
-              ShowHint = True
-              TabOrder = 2
-              OnClick = btPlayNowClick
-              LinkFont.Charset = DEFAULT_CHARSET
-              LinkFont.Color = clBlue
-              LinkFont.Height = -11
-              LinkFont.Name = 'MS Sans Serif'
-              LinkFont.Style = [fsUnderline]
-            end
             object SpTBXLabel2: TSpTBXLabel
               Left = 80
               Top = 6
@@ -332,7 +306,7 @@
           object VDTBattles: TVirtualDrawTree
             Left = 2
             Top = 27
-            Width = 830
+            Width = 826
             Height = 56
             Align = alClient
             BevelInner = bvNone
@@ -445,7 +419,7 @@
           object FilterGroup: TSpTBXPanel
             Left = 2
             Top = 95
-            Width = 830
+            Width = 826
             Height = 173
             Caption = 'FilterGroup'
             Align = alBottom
@@ -453,12 +427,12 @@
             OnResize = FilterGroupResize
             Borders = False
             DesignSize = (
-              830
+              826
               173)
             object FiltersTabs: TSpTBXTabControl
               Left = 2
               Top = 2
-              Width = 826
+              Width = 822
               Height = 169
               Align = alClient
               Color = clBtnFace
@@ -480,18 +454,20 @@
               object SpTBXTabSheet2: TSpTBXTabSheet
                 Left = 0
                 Top = 0
-                Width = 826
+                Width = 822
                 Height = 146
                 Caption = 'Presets'
                 ImageIndex = -1
+                Item = SpTBXTabItem2
+                TabControl = FiltersTabs
                 DesignSize = (
-                  826
+                  822
                   146)
                 TabItem = 'SpTBXTabItem2'
                 object PresetListbox: TSpTBXListBox
                   Left = 152
                   Top = 26
-                  Width = 661
+                  Width = 657
                   Height = 113
                   Anchors = [akLeft, akTop, akRight]
                   ItemHeight = 16
@@ -581,18 +557,20 @@
               object SpTBXTabSheet1: TSpTBXTabSheet
                 Left = 0
                 Top = 0
-                Width = 826
+                Width = 822
                 Height = 146
                 Caption = 'Filters'
                 ImageIndex = -1
+                Item = SpTBXTabItem1
+                TabControl = FiltersTabs
                 DesignSize = (
-                  826
+                  822
                   146)
                 TabItem = 'SpTBXTabItem1'
                 object FilterList: TVirtualStringTree
                   Left = 448
                   Top = 8
-                  Width = 365
+                  Width = 361
                   Height = 129
                   Anchors = [akLeft, akTop, akRight]
                   CheckImageKind = ckSystem
@@ -641,7 +619,7 @@
                     end
                     item
                       Position = 3
-                      Width = 198
+                      Width = 194
                       WideText = 'Value'
                     end&gt;
                 end
@@ -901,7 +879,7 @@
               end
             end
             object EnableFilters: TSpTBXCheckBox
-              Left = 716
+              Left = 712
               Top = 154
               Width = 110
               Height = 18
@@ -920,7 +898,7 @@
           object FiltersButton: TSpTBXButton
             Left = 2
             Top = 83
-            Width = 830
+            Width = 826
             Height = 12
             Align = alBottom
             TabOrder = 3
@@ -937,8 +915,8 @@
       end
       object Splitter2: TSpTBXSplitter
         Left = 2
-        Top = 128
-        Width = 834
+        Top = 117
+        Width = 830
         Height = 6
         Cursor = crSizeNS
         Caption = 'Splitter2'
@@ -951,16 +929,16 @@
       object MainPanel: TSpTBXPanel
         Left = 2
         Top = 2
-        Width = 834
-        Height = 126
+        Width = 830
+        Height = 115
         Align = alClient
         TabOrder = 2
         Borders = False
         object PageControl1: TPageControl
           Left = 2
           Top = 2
-          Width = 667
-          Height = 122
+          Width = 663
+          Height = 111
           Align = alClient
           Constraints.MinHeight = 1
           MultiLine = True
@@ -972,10 +950,10 @@
           OnResize = PageControl1Resize
         end
         object Panel2: TSpTBXPanel
-          Left = 679
+          Left = 675
           Top = 2
           Width = 153
-          Height = 122
+          Height = 111
           Align = alRight
           Color = clNone
           Constraints.MinWidth = 1
@@ -988,7 +966,7 @@
             Left = 2
             Top = 52
             Width = 149
-            Height = 68
+            Height = 57
             Style = lbOwnerDrawFixed
             Align = alClient
             Font.Charset = DEFAULT_CHARSET
@@ -1088,7 +1066,7 @@
             object PlayerFiltersTextbox: TSpTBXEdit
               Left = 40
               Top = 0
-              Width = 108
+              Width = 89
               Height = 21
               Hint = 
                 'Simple filtering : separate keywords by a space. Regular express' +
@@ -1099,13 +1077,34 @@
               TabOrder = 1
               OnChange = PlayerFiltersTextboxChange
             end
+            object ClearPlayersFilterButton: TSpTBXButton
+              Left = 128
+              Top = 0
+              Width = 20
+              Height = 21
+              Caption = 'X'
+              Anchors = [akTop, akRight]
+              Font.Charset = DEFAULT_CHARSET
+              Font.Color = clWindowText
+              Font.Height = -11
+              Font.Name = 'MS Sans Serif'
+              Font.Style = [fsBold]
+              ParentFont = False
+              TabOrder = 2
+              OnClick = ClearPlayersFilterButtonClick
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
           end
         end
         object Splitter1: TSpTBXSplitter
-          Left = 669
+          Left = 665
           Top = 2
           Width = 10
-          Height = 122
+          Height = 111
           Cursor = crSizeWE
           Caption = 'Splitter1'
           Align = alRight
@@ -1116,7 +1115,7 @@
     object Panel4: TSpTBXPanel
       Left = 4
       Top = 30
-      Width = 838
+      Width = 834
       Height = 41
       Align = alTop
       Color = clNone
@@ -1238,7 +1237,7 @@
     object NewsMainPanel: TSpTBXPanel
       Left = 4
       Top = 71
-      Width = 838
+      Width = 834
       Height = 41
       Caption = 'NewsMainPanel'
       Align = alTop
@@ -1248,7 +1247,7 @@
       object ExpandNewsButton: TSpTBXButton
         Left = 2
         Top = 27
-        Width = 834
+        Width = 830
         Height = 12
         Align = alBottom
         TabOrder = 0
@@ -1264,7 +1263,7 @@
       object ScrollingNewsPanel: TSpTBXPanel
         Left = 2
         Top = -2
-        Width = 834
+        Width = 830
         Height = 29
         Align = alClient
         TabOrder = 1
@@ -1284,7 +1283,7 @@
   end
   object ButtonImageList: TImageList
     Left = 176
-    Top = 296
+    Top = 288
     Bitmap = {
       494C010119001D00040010001000FFFFFFFFFF10FFFFFFFFFFFFFFFF424D3600
       0000000000003600000028000000400000008000000001002000000000000080
@@ -2351,7 +2350,7 @@
   end
   object PlayerStateImageList: TImageList
     Left = 209
-    Top = 296
+    Top = 288
     Bitmap = {
       494C010106000900040010001000FFFFFFFFFF10FFFFFFFFFFFFFFFF424D3600
       0000000000003600000028000000400000003000000001002000000000000030
@@ -2760,7 +2759,7 @@
     Height = 32
     Width = 32
     Left = 145
-    Top = 295
+    Top = 287
     Bitmap = {
       494C010103000400040020002000FFFFFFFFFF10FFFFFFFFFFFFFFFF424D3600
       0000000000003600000028000000800000002000000001002000000000000040
@@ -3328,7 +3327,7 @@
     KeepAliveInterval = 1000
     SocksLevel = '5'
     SocksAuthentication = socksNoAuthentication
-    Left = 288
+    Left = 296
     Top = 168
   end
   object KeepAliveTimer: TTimer
@@ -3339,7 +3338,7 @@
   end
   object ReadyStateImageList: TImageList
     Left = 241
-    Top = 295
+    Top = 287
     Bitmap = {
       494C010102000400040010001000FFFFFFFFFF10FFFFFFFFFFFFFFFF424D3600
       0000000000003600000028000000400000001000000001002000000000000010
@@ -3482,7 +3481,7 @@
   end
   object BattleStatusImageList: TImageList
     Left = 273
-    Top = 295
+    Top = 287
     Bitmap = {
       494C010112001300040010001000FFFFFFFFFF10FFFFFFFFFFFFFFFF424D3600
       0000000000003600000028000000400000005000000001002000000000000050
@@ -4153,7 +4152,7 @@
   end
   object SyncImageList: TImageList
     Left = 305
-    Top = 295
+    Top = 287
     Bitmap = {
       494C010103000400040010001000FFFFFFFFFF10FFFFFFFFFFFFFFFF424D3600
       0000000000003600000028000000400000001000000001002000000000000010
@@ -4308,7 +4307,7 @@
   end
   object RanksImageList: TImageList
     Left = 337
-    Top = 295
+    Top = 287
     Bitmap = {
       494C010107000900040010001000FFFFFFFFFF10FFFFFFFFFFFFFFFF424D3600
       0000000000003600000028000000400000003000000001002000000000000030
@@ -4737,7 +4736,7 @@
   end
   object GradesImageList: TImageList
     Left = 369
-    Top = 295
+    Top = 287
     Bitmap = {
       494C01010B000E00040010001000FFFFFFFFFF10FFFFFFFFFFFFFFFF424D3600
       0000000000003600000028000000400000004000000001002000000000000040
@@ -5276,7 +5275,7 @@
   end
   object NumbersImageList: TImageList
     Left = 401
-    Top = 295
+    Top = 287
     Bitmap = {
       494C010110001300040010001000FFFFFFFFFF10FFFFFFFFFFFFFFFF424D3600
       0000000000003600000028000000400000005000000001002000000000000050
@@ -5947,7 +5946,7 @@
   end
   object MiscImageList: TImageList
     Left = 433
-    Top = 295
+    Top = 287
     Bitmap = {
       494C01010D000E00040010001000FFFFFFFFFF10FFFFFFFFFFFFFFFF424D3600
       0000000000003600000028000000400000004000000001002000000000000040
@@ -6486,7 +6485,7 @@
   end
   object ColorImageList: TImageList
     Left = 465
-    Top = 296
+    Top = 288
   end
   object ClientPopupMenu2: TSpTBXPopupMenu
     Left = 576
@@ -6610,7 +6609,7 @@
   object BattleListPopupMenu: TSpTBXPopupMenu
     OnInitPopup = BattleListPopupMenuInitPopup
     Left = 112
-    Top = 296
+    Top = 288
     object mnuBattleHost: TSpTBXSubmenuItem
       Caption = 'Host'
       LinkSubitems = PlayerSubMenu
@@ -6718,6 +6717,10 @@
       Caption = 'Messageboard'
       OnClick = mnuMessageboardClick
     end
+    object mnuSpringinfo: TSpTBXItem
+      Caption = 'Springinfo (news, tutorials, ...)'
+      OnClick = mnuSpringinfoClick
+    end
     object mnuBugTracker: TSpTBXItem
       Caption = 'Report a bug'
       Hint = 'Bug tracker'
@@ -6875,7 +6878,7 @@
   end
   object ArrowList: TImageList
     Left = 496
-    Top = 296
+    Top = 288
     Bitmap = {
       494C010102000400040010001000FFFFFFFFFF10FFFFFFFFFFFFFFFF424D3600
       0000000000003600000028000000400000001000000001002000000000000010
@@ -7042,7 +7045,7 @@
   end
   object LadderCups: TImageList
     Left = 528
-    Top = 296
+    Top = 288
     Bitmap = {
       494C010103000400040010001000FFFFFFFFFF10FFFFFFFFFFFFFFFF424D3600
       0000000000003600000028000000400000001000000001002000000000000010
@@ -7251,15 +7254,52 @@
     Left = 556
     Top = 166
   end
-  object ScrollingNewsImter: TTimer
+  object ScrollingNewsTimer: TTimer
     Interval = 600000
-    OnTimer = ScrollingNewsImterTimer
-    Left = 364
-    Top = 120
+    OnTimer = ScrollingNewsTimerTimer
+    Left = 276
+    Top = 80
   end
   object ScrollingNewsRSS: TXMLDocument
-    Left = 326
-    Top = 122
+    Left = 238
+    Top = 82
     DOMVendorDesc = 'MSXML'
   end
+  object AutojoinPopupMenu: TSpTBXPopupMenu
+    Left = 664
+    Top = 231
+    object mnuPlaynow: TSpTBXItem
+      Caption = 'Play now'
+      OnClick = mnuPlaynowClick
+    end
+    object mnuSpecnow: TSpTBXItem
+      Caption = 'Spectate now'
+      OnClick = mnuSpecnowClick
+    end
+    object SpTBXSeparatorItem22: TSpTBXSeparatorItem
+    end
+    object mnuAutoplayFirstAvailable: TSpTBXItem
+      Caption = 'Autoplay first available battle'
+      AutoCheck = True
+      RadioItem = True
+      OnClick = mnuAutoplayFirstAvailableClick
+    end
+    object mnuAutospecFirstAvailable: TSpTBXItem
+      Caption = 'Autospec first available battle'
+      AutoCheck = True
+      RadioItem = True
+      OnClick = mnuAutospecFirstAvailableClick
+    end
+    object SpTBXSeparatorItem23: TSpTBXSeparatorItem
+    end
+    object mnuAutojoinOptions: TSpTBXItem
+      Caption = 'Options'
+      OnClick = mnuAutojoinOptionsClick
+    end
+  end
+  object AutojoinTimer: TTimer
+    OnTimer = AutojoinTimerTimer
+    Left = 632
+    Top = 231
+  end
 end

Modified: Lobby/TASClient/MainUnit.pas
===================================================================
--- Lobby/TASClient/MainUnit.pas	2009-05-28 11:37:21 UTC (rev 7254)
+++ Lobby/TASClient/MainUnit.pas	2009-05-28 21:16:55 UTC (rev 7255)
@@ -525,9 +525,9 @@
   );
 
 const
-  VERSION_NUMBER = '0.46'; // Must be float value! (with a period as a decimal seperator)
+  VERSION_NUMBER = '0.47'; // Must be float value! (with a period as a decimal seperator)
   CHECK_BETA_LOBBY_URL = '<A HREF="http://tasclient.no-ip.org/TASClient_update_v3.txt">http://tasclient.no-ip.org/TASClient_update_v3.txt</A>';
-  PROGRAM_VERSION = 'TASClient ' + VERSION_NUMBER;
+  PROGRAM_VERSION = 'TASClient ' + VERSION_NUMBER + ' beta';
   KEEP_ALIVE_INTERVAL = 10000; // in milliseconds. Tells us what should be the maximum &quot;silence&quot; time before we send a ping to the server.
   ASSUME_TIMEOUT_INTERVAL = 30000; // in milliseconds. Must be greater than KEEP_ALIVE_INTERVAL! If server hasn't send any data to us within this interval, then we assume timeout occured. It's us who must make sure we get constant replies from server by pinging it.
   LOCAL_TAB = '$Local'; // caption of main (command) tab window. Must be special so that is different from channel names or user names, that is why there is a &quot;$&quot; in front of it.
@@ -554,6 +554,7 @@
   CUSTOM_TASCLIENT_FILE = 'TASClient.ini';
   GROUPS_FILE = VAR_FOLDER + '\' + 'groups.ini';
   AWAY_MSGS_FILE = VAR_FOLDER + '\' + 'away_messages.ini';
+  AUTOJOIN_SETTINGS = VAR_FOLDER + '\' + 'autojoin.ini';
   MENU_SETTINGS_FILE = VAR_FOLDER + '\' + 'menuSettings.ini';
   TIPS_FILE = VAR_FOLDER+'\tips.txt';
   SPRING_SETTINGS_PROFILE_FILE = VAR_FOLDER + '\SpringSettingsProfiles.ini';
@@ -572,8 +573,8 @@
   MAP_DOWNLOADER_ENABLED = False; // integrated map downloader is currently disabled as FileUniverse.com is no longer hosting spring content
   CANT_WRITE_SCRIPT_MSG = 'Could''nt write the start script file ''script.txt'', try again ?';
 
-  MAX_PLAYERS = 32; // max. players supported by Spring in a game
-  MAX_TEAMS = 16; // max. teams supported by Spring in a game (MAX_ALLIES would be same as MAX_TEAMS, so no need for it)
+  MAX_PLAYERS = 200; // max. players supported by Spring in a game
+  MAX_TEAMS = 100; // max. teams supported by Spring in a game (MAX_ALLIES would be same as MAX_TEAMS, so no need for it)
   MAX_POPUP = 8; // max popup notification displaying at the same time
 
   MAX_AUTOSENDMSG = 2; // limit the auto sent msg when auto specing or kicking players
@@ -637,7 +638,7 @@
 
   TFilterText =
   record
-    filterType : (HostName, MapName, ModName, Description, DisabledUnits, SpringVersion, FileName, Players);
+    filterType : (HostName, MapName, ModName, Description, DisabledUnits, SpringVersion, FileName, Players, MapModOption);
     contains: boolean;
     node : PVirtualNode;
     enabled: boolean;
@@ -875,12 +876,12 @@
   public
     Name: string;
     OwnerName: string;
-    AIDll: string;
+    AIShortName: string;
     BattleStatus: Integer;
     TeamColor: Integer; // $00BBGGRR where B = blue, G = green, R = red
 
     procedure Assign(Bot: TBot); // copies all properties of Bot to this Bot
-    constructor Create(Name: string; OwnerName: string; AIDll: string);
+    constructor Create(Name: string; OwnerName: string; AIShortName: string);
 
     // following functions extract various values from BattleStatus:
     function GetTeamNo: Integer;
@@ -961,6 +962,7 @@
     function GetBruteScript:String; // DEBUG METHOD
     function ReadKeyValue(completeKey: string):String;
     procedure AddOrChangeKeyValue(completeKey: String; value: String);
+    function keyExists(completeKey: string): boolean;
     procedure RemoveKey(completeKey: String);
     function isCorrupted: boolean;
 
@@ -979,9 +981,6 @@
     function ReadStartMetal: Integer;
     function ReadStartEnergy: Integer;
     function ReadMaxUnits: Integer;
-    function ReadStartMetal2: Integer;
-    function ReadStartEnergy2: Integer;
-    function ReadMaxUnits2: Integer;
     function ReadStartPosType: Integer;
     function ReadGameMode: Integer;
     function ReadGameMode2: Integer;
@@ -996,6 +995,25 @@
     procedure TryToRemoveUDPSourcePort;
   end;
 
+  TPresetFilters=
+  record
+    Name: String;
+    Full: Boolean;
+    InProgress: Boolean;
+    Ladder: Boolean;
+    Locked: Boolean;
+    Passworded: Boolean;
+    NatTraversal: Boolean;
+    RankLimitSupEqMine: Boolean;
+    MapNotAvailable: Boolean;
+    ModNotAvailable: Boolean;
+    Replays: Boolean;
+    Players: TFilterNumber;
+    MaxPlayers: TFilterNumber;
+    TextFilters: TList;
+  end;
+  PPresetFilters = ^TPresetFilters;
+
   TReplay = class
   public
     Grade: Byte; // 0..10 (where 0 is unrated/unknown)
@@ -1143,7 +1161,6 @@
     QuickJoinPanel: TSpTBXPanel;
     SpTBXLabel1: TSpTBXLabel;
     btSpecatateNow: TSpTBXButton;
-    btPlayNow: TSpTBXButton;
     SpTBXLabel2: TSpTBXLabel;
     VDTBattles: TVirtualDrawTree;
     FilterGroup: TSpTBXPanel;
@@ -1208,7 +1225,7 @@
     SearchButton: TSpTBXSpeedButton;
     ConnectButton: TTBXButton;
     SinglePlayerButton: TSpTBXButton;
-    ScrollingNewsImter: TTimer;
+    ScrollingNewsTimer: TTimer;
     NewsMainPanel: TSpTBXPanel;
     ExpandNewsButton: TSpTBXButton;
     ScrollingNewsPanel: TSpTBXPanel;
@@ -1217,6 +1234,17 @@
     SpTBXLabel4: TSpTBXLabel;
     PlayerFiltersTextbox: TSpTBXEdit;
     ScrollingNewsRSS: TXMLDocument;
+    AutojoinPopupMenu: TSpTBXPopupMenu;
+    mnuPlaynow: TSpTBXItem;
+    mnuSpecnow: TSpTBXItem;
+    mnuAutoplayFirstAvailable: TSpTBXItem;
+    mnuAutospecFirstAvailable: TSpTBXItem;
+    SpTBXSeparatorItem22: TSpTBXSeparatorItem;
+    SpTBXSeparatorItem23: TSpTBXSeparatorItem;
+    mnuAutojoinOptions: TSpTBXItem;
+    mnuSpringinfo: TSpTBXItem;
+    AutojoinTimer: TTimer;
+    ClearPlayersFilterButton: TSpTBXButton;
     procedure mnuOpenPrivateChatClick(Sender: TObject);
     procedure mnuSelectBattleClick(Sender: TObject);
     procedure SpTBXItem1Click(Sender: TObject);
@@ -1282,11 +1310,11 @@
     procedure FilterListHeaderClick(Sender: TVTHeader;
       Column: TColumnIndex; Button: TMouseButton; Shift: TShiftState; X,
       Y: Integer);
-    procedure SaveFiltersToFile(path : string);
-    procedure LoadFiltersFromFile(path : string);
+    procedure SaveFiltersToFile(path : string;Filters: TPresetFilters);
+    procedure LoadFiltersFromFile(path : string;var Filters: TPresetFilters);
     procedure LoadPresets;
     procedure FiltersUpdated;
-    procedure UpdateFilters;
+    procedure UpdateFilters(pFilters: TPresetFilters);
     procedure HighlighBattlesTimerTimer(Sender: TObject);
     procedure FormResize(Sender: TObject);
     procedure PlayersFilterClick(Sender: TObject);
@@ -1331,7 +1359,6 @@
       Shift: TShiftState);
     procedure SearchPlayerFormPopupMenuPopup(Sender: TObject);
     procedure mnuQuickJoinPanelClick(Sender: TObject);
-    procedure btSpecatateNowClick(Sender: TObject);
     procedure btPlayNowClick(Sender: TObject);
     procedure Splitter2Moving(Sender: TObject; var NewSize: Integer;
       var Accept: Boolean);
@@ -1343,7 +1370,6 @@
     procedure SinglePlayerButtonClick(Sender: TObject);
     procedure PyInOutSendData(Sender: TObject;
       const Data: String);
-    procedure SpTBXItem5Click(Sender: TObject);
     procedure lobbyscriptWrapperInitialization(Sender: TObject);
     procedure RichEditURLClick(Sender: TObject; URL: String);
     procedure mnuTipsClick(Sender: TObject);
@@ -1351,7 +1377,7 @@
     procedure Button10Click(Sender: TObject);
     procedure PageControl1Resize(Sender: TObject);
     function IsIncludedInList(sl: TStringList; s: string):Boolean;
-    procedure ScrollingNewsImterTimer(Sender: TObject);
+    procedure ScrollingNewsTimerTimer(Sender: TObject);
     procedure ExpandNewsButtonClick(Sender: TObject);
     procedure NewsBrowserNewWindow2(Sender: TObject; var ppDisp: IDispatch;
       var Cancel: WordBool);
@@ -1361,6 +1387,16 @@
       const pDisp: IDispatch; var URL, Flags, TargetFrameName, PostData,
       Headers: OleVariant; var Cancel: WordBool);
     procedure PlayerFiltersTextboxChange(Sender: TObject);
+    procedure mnuAutojoinOptionsClick(Sender: TObject);
+    procedure mnuSpringinfoClick(Sender: TObject);
+    procedure mnuPlaynowClick(Sender: TObject);
+    procedure mnuSpecnowClick(Sender: TObject);
+    procedure AutojoinTimerTimer(Sender: TObject);
+    procedure mnuAutoplayFirstAvailableClick(Sender: TObject);
+    procedure mnuAutospecFirstAvailableClick(Sender: TObject);
+    procedure Button1Click(Sender: TObject);
+    procedure ClearPlayersFilterButtonClick(Sender: TObject);
+    procedure SpTBXButton1Click(Sender: TObject);
   published
     MainTitleBar: TSpTBXTitleBar;
     ButtonImageList: TImageList;
@@ -1415,6 +1451,7 @@
     procedure DeinitializeFlagBitmaps;
     function GetFlagBitmap(Country: string): TBitmap; // Country must contain two-letter country code (for example: &quot;si&quot; for Slovenia)
     function GetCountryName(CountryCode: string): string;
+    function GetCountryCode(CountryName: string): string;
 
     function OpenLog(FileName: string): TFileStream;
     procedure CloseAllLogs; // closes all file streams for channels, private chats and battle log
@@ -1477,11 +1514,11 @@
 
     procedure SortClientsList(List: TList; SortStyle: Byte);
     procedure SortClientInList(client: TClient;List: TList; SortStyle: Byte);
-    procedure SortBattlesList(SortStyle: Byte; Ascending: Boolean);
+    procedure SortBattlesList(BattleList: TList; SortStyle: Byte; Ascending: Boolean);
     function CompareClients(Client1: TClient; Client2: TClient; SortStyle: Byte): Shortint; // used with SortClientsList method (and other methods?)
-    function CompareBattles(Battle1, Battle2: TBattle; SortStyle: Byte): Shortint;
+    function CompareBattles(Battle1, Battle2: TBattle; SortStyle: Byte; SortDirection: Boolean): Shortint;
     procedure RefreshBattleList();
-    function isBattleVisible(Battle:TBattle):Boolean;
+    function isBattleVisible(Battle:TBattle;Filters: TPresetFilters):Boolean;
     procedure SortBattleInList(Index: Integer; SortStyle: Byte; Ascending: Boolean);
 
     procedure AddNotification(HeaderText, MessageText: string; DisplayTime: Integer;OnClick: Boolean = false;BattleId: integer = -1);
@@ -1508,6 +1545,8 @@
 
     procedure initLobbyScript;
     procedure initFiltersPresets;
+
+    function getAutojoinBestBattle(autoJoinPresetList:TList):TBattle;
   published
     procedure ApplicationEvents1ShortCut(var Msg: TWMKey; var Handled: Boolean);
     procedure FormCreate(Sender: TObject);
@@ -1648,25 +1687,6 @@
     CurrentMsgID: Integer; // when sending commands to the server some are assigned an unique ID. This value represents last assigned ID. Currently we assign IDs consecutively (note that you may assign IDs any way you want, random, consecutive, or even not at all. IDs have only one function: to track server responses to commands sent by the client. See server's protocol description for more info)
   end;
 
-
-
-  Filters:
-  record
-    Full: Boolean;
-    InProgress: Boolean;
-    Ladder: Boolean;
-    Locked: Boolean;
-    Passworded: Boolean;
-    NatTraversal: Boolean;
-    RankLimitSupEqMine: Boolean;
-    MapNotAvailable: Boolean;
-    ModNotAvailable: Boolean;
-    Replays: Boolean;
-    Players: TFilterNumber;
-    MaxPlayers: TFilterNumber;
-    TextFilters: TList;
-  end;
-
   Pings: TList; // list of TPingInfo records (holds current ping packets info. See /ping command implementation)
 
   // NAT traversing method used with the lobby client is described in TASServer's docs!
@@ -1684,6 +1704,9 @@
   Battles: TList;
   ReplayList: TList;
 
+  CurrentFilters : TPresetFilters;
+  PresetList: TList;
+
   RefreshingBattleList:Boolean = false;
 
   FlagBitmaps: TList; // of TBitmap objects
@@ -1744,9 +1767,13 @@
   mainLogBuffer : TStringList;
   mainLogBufferColor: TIntegerList;
 
+  BattleSorting: integer;
+  BattleSortingDirection: Boolean;
+
   function Dequeue: WideString; forward;
   function Enqueue(s: WideString): Integer; forward;
   function ClientSortCompare(Item1, Item2: Pointer): Integer;
+  function BattleSortCompare(Item1, Item2: Pointer): Integer;
 
 
 implementation
@@ -1761,7 +1788,8 @@
   PythonScriptDebugFormUnit,LobbyScriptUnit, SpringDownloaderFormUnit,
   LogonFormUnit, MapSelectionFormUnit, TipsFormUnit,
   ColorsPreferenceUnit, CustomizeGUIFormUnit, SetValuesFormUnit,
-  TntWideStrings, SpringSettingsProfileFormUnit, gnugettext;
+  TntWideStrings, SpringSettingsProfileFormUnit, gnugettext,
+  AutoJoinFormUnit, AddBotUnit;
 
 {$R *.dfm}
 
@@ -2240,7 +2268,7 @@
   Battle.MaxPlayers := MaxPlayers;
   Battle.ModName := ModName;
   Battle.Clients.Add(Founder);
-  Battle.Visible :=  isBattleVisible(Battle);
+  Battle.Visible :=  isBattleVisible(Battle,CurrentFilters);
   Battle.Node := nil;
 
 
@@ -2468,7 +2496,7 @@
   j: Integer;
 begin
   j:=0;
-  with Filters do
+  with CurrentFilters do
   begin
   for i := 0 to TextFilters.Count - 1 do
     if TFilterText(TextFilters[i]^).Node &lt;&gt; nil then
@@ -2787,16 +2815,16 @@
 begin
   Self.Name := Bot.Name;
   Self.OwnerName := Bot.OwnerName;
-  Self.AIDll := Bot.AIDll;
+  Self.AIShortName := Bot.AIShortName;
   Self.BattleStatus := Bot.BattleStatus;
   Self.TeamColor := Bot.TeamColor;
 end;
 
-constructor TBot.Create(Name: string; OwnerName: string; AIDll: string);
+constructor TBot.Create(Name: string; OwnerName: string; AIShortName: string);
 begin
   Self.Name := Name;
   Self.OwnerName := OwnerName;
-  Self.AIDll := AIDll;
+  Self.AIShortName := AIShortName;
   Self.BattleStatus := 0;
   Self.TeamColor := 0;
 end;
@@ -3024,14 +3052,11 @@
 function TBattle.GetHighlightColor: TColor;
 begin
   Result := clWindow;
-  if CurrentHighLightGroup &gt; -1 then
-  begin
+  if Self.CurrentHighLightGroup &gt; -1 then
     try
-      Result := TClientGroup(ClientGroups[CurrentHighLightGroup]).Color;
+      Result := TClientGroup(ClientGroups[Self.CurrentHighLightGroup]).Color;
     except
-      // nothing
     end;
-  end;
 end;
 
 procedure TBattle.NextHighlight;
@@ -3159,6 +3184,8 @@
 begin
   tmp := ReadKeyValue('GAME/STARTMETAL');
   if tmp = '' then
+    tmp := ReadKeyValue('GAME/MODOPTIONS/STARTMETAL');
+  if tmp = '' then
   begin
     self.Corrupted := true;
     raise Exception.Create(_('Corrupted script file!'));
@@ -3177,6 +3204,8 @@
 begin
   tmp := ReadKeyValue('GAME/STARTENERGY');
   if tmp = '' then
+    tmp := ReadKeyValue('GAME/MODOPTIONS/STARTENERGY');
+  if tmp = '' then
   begin
     self.Corrupted := true;
     raise Exception.Create(_('Corrupted script file!'));
@@ -3195,23 +3224,7 @@
 begin
   tmp := ReadKeyValue('GAME/MAXUNITS');
   if tmp = '' then
-  begin
-    self.Corrupted := true;
-    raise Exception.Create(_('Corrupted script file!'));
-  end;
-  try
-    Result := StrToInt(tmp);
-  except
-    self.Corrupted := true;
-    raise Exception.Create(_('Corrupted script file!'));
-  end;
-end;
-
-function TScript.ReadStartMetal2: Integer;
-var
-  tmp: String;
-begin
-  tmp := ReadKeyValue('GAME/MODOPTIONS/STARTMETAL');
+    tmp := ReadKeyValue('GAME/MODOPTIONS/MAXUNITS');
   if tmp = '' then
   begin
     self.Corrupted := true;
@@ -3225,42 +3238,6 @@
   end;
 end;
 
-function TScript.ReadStartEnergy2: Integer;
-var
-  tmp: String;
-begin
-  tmp := ReadKeyValue('GAME/MODOPTIONS/STARTENERGY');
-  if tmp = '' then
-  begin
-    self.Corrupted := true;
-    raise Exception.Create(_('Corrupted script file!'));
-  end;
-  try
-    Result := StrToInt(tmp);
-  except
-    self.Corrupted := true;
-    raise Exception.Create('Corrupted script file!');
-  end;
-end;
-
-function TScript.ReadMaxUnits2: Integer;
-var
-  tmp: String;
-begin
-  tmp := ReadKeyValue('GAME/MODOPTIONS/MAXUNITS');
-  if tmp = '' then
-  begin
-    self.Corrupted := true;
-    raise Exception.Create(_('Corrupted script file!'));
-  end;
-  try
-    Result := StrToInt(tmp);
-  except
-    self.Corrupted := true;
-    raise Exception.Create(_('Corrupted script file!'));
-  end;
-end;
-
 function TScript.ReadStartPosType: Integer;
 var
   tmp: String;
@@ -3321,6 +3298,8 @@
 begin
   tmp := ReadKeyValue('GAME/LIMITDGUN');
   if tmp = '' then
+    tmp := ReadKeyValue('GAME/MODOPTIONS/LIMITDGUN');
+  if tmp = '' then
   begin
     self.Corrupted := true;
     raise Exception.Create(_('Corrupted script file!'));
@@ -3339,6 +3318,8 @@
 begin
   tmp := ReadKeyValue('GAME/DIMINISHINGMMS');
   if tmp = '' then
+    tmp := ReadKeyValue('GAME/MODOPTIONS/DIMINISHINGMMS');
+  if tmp = '' then
   begin
     self.Corrupted := true;
     raise Exception.Create(_('Corrupted script file!'));
@@ -3357,6 +3338,8 @@
 begin
   tmp := ReadKeyValue('GAME/GHOSTEDBUILDINGS');
   if tmp = '' then
+    tmp := ReadKeyValue('GAME/MODOPTIONS/GHOSTEDBUILDINGS');
+  if tmp = '' then
   begin
     self.Corrupted := true;
     raise Exception.Create(_('Corrupt script file!'));
@@ -3436,6 +3419,12 @@
   end;
 end;
 
+function TTDFParser.keyExists(completeKey: string): boolean;
+begin
+  Result := CompleteKeyList.IndexOf(LowerCase(completeKey)) &gt; -1;
+end;
+
+
 procedure TTDFParser.RemoveKey(completeKey: String);
 var
   i: Integer;
@@ -3644,6 +3633,12 @@
   TP_GlobalIgnoreClassProperty(TNotebook,'Pages');
   TP_GlobalIgnoreClass (TWebBrowser);
   TP_GlobalIgnoreClass (TWebBrowserWrapper);
+  TP_GlobalIgnoreClass (TExRichEdit);
+  TP_GlobalIgnoreClass (TRichEdit);
+  TP_Ignore (self,'.Caption');
+  TP_Ignore (self,'MainTitleBar.Caption');
+  TP_Ignore (self,'SortLabel');
+
   TranslateComponent(self);
 
   Left := 10;
@@ -3663,8 +3658,6 @@
     // nothing
   end;
 
-  initFiltersPresets;
-
   Randomize;
   Application.UpdateFormatSettings := False; // so that DecimalSeparator doesn't get changed by WM_WININICHANGE message. See <A HREF="http://coding.derkeiler.com/Archive/Delphi/borland.public.delphi.language.objectpascal/2003-11/0223.html">http://coding.derkeiler.com/Archive/Delphi/borland.public.delphi.language.objectpascal/2003-11/0223.html</A>
   DecimalSeparator := '.';
@@ -3795,7 +3788,6 @@
     PerformForm.LoadCommandListFromFile(ExtractFilePath(Application.ExeName) + VAR_FOLDER + '\perform.dat');
     HighlightingForm.LoadHighlightsFromFile(ExtractFilePath(Application.ExeName) + VAR_FOLDER + '\highlights.dat');
     IgnoreListForm.LoadIgnoreListFromFile(ExtractFilePath(Application.ExeName) + VAR_FOLDER + '\ignorelist.dat');
-    SpringSettingsProfileForm.LoadProfiles;
 
     // we must apply themetype and theme now and not before, since some forms
     // or controls may yet not have been created earlier:
@@ -3816,36 +3808,47 @@
     ScrollingNewsBrowser.OnBeforeNavigate2 := OnNewsBrowserBeforeNavigate2;
     ScrollingNewsBrowser.Cursor := crHandPoint;
 
+    initFiltersPresets;
+
     // make the news browser
-    NewsBrowser := TWebBrowserWrapper.Create(NewsPanel);
-    TWinControl(NewsBrowser).Parent := NewsPanel;
-    NewsBrowser.Show3DBorder := False;
-    NewsBrowser.Align := alClient;
-    NewsBrowser.Visible := True;
-    NewsBrowser.Silent := True;
-    NewsBrowser.OnDocumentComplete := OnNewsBrowserDocumentComplete;
-    NewsBrowser.OnBeforeNavigate2 := OnNewsBrowserBeforeNavigate2;
+    if Preferences.DisableNews then
+    begin
+      NewsMainPanel.Visible := False;
+      ScrollingNewsTimer.Enabled := False;
+    end
+    else
+    begin
+      NewsBrowser := TWebBrowserWrapper.Create(NewsPanel);
+      TWinControl(NewsBrowser).Parent := NewsPanel;
+      NewsBrowser.Show3DBorder := False;
+      NewsBrowser.Align := alClient;
+      NewsBrowser.Visible := True;
+      NewsBrowser.Silent := True;
+      NewsBrowser.OnDocumentComplete := OnNewsBrowserDocumentComplete;
+      NewsBrowser.OnBeforeNavigate2 := OnNewsBrowserBeforeNavigate2;
 
-    // display and expand the news
-    ScrollingNewsPanel.Align := alClient;
-    Panel1.Visible := False;
-    NewsMainPanel.Align := alClient;
-    ScrollingNewsPanel.Visible := False;
-    NewsPanel.Align := alClient;
-    NewsPanel.Visible := True;
-    ExpandNewsButton.ImageIndex := 0;
-    MainForm.WindowState := wsMinimized;
-    MainForm.Visible := True;
-    ScrollingNewsImterTimer(nil);
-    try
-      NewsBrowser.Navigate(NEWS_URL);
-    except
+      // display and expand the news
+      ScrollingNewsPanel.Align := alClient;
+      Panel1.Visible := False;
+      NewsMainPanel.Align := alClient;
+      ScrollingNewsPanel.Visible := False;
+      NewsPanel.Align := alClient;
+      NewsPanel.Visible := True;
+      ExpandNewsButton.ImageIndex := 0;
+      MainForm.WindowState := wsMinimized;
+      MainForm.Visible := True;
+      ScrollingNewsTimerTimer(nil);
+      try
+        NewsBrowser.Navigate(NEWS_URL);
+      except
+      end;
+      MainForm.Visible := False;
+      MainForm.WindowState := wsNormal;
     end;
-    MainForm.Visible := False;
-    MainForm.WindowState := wsNormal;
 
     LoadGroups;
     LoadAwayMessages;
+    AutoJoinForm.LoadAutoJoinPresetLists;
 
     // populate ColorImageList:
     UpdateColorImageList;
@@ -3972,7 +3975,7 @@
     // finally apply post-initialization preferences:
     PreferencesForm.ApplyPostInitializationPreferences;
 
-    if not RunningUnderWine then
+    if not RunningUnderWine and RunningWithMainMenu then
     begin
       SplashScreenForm.UpdateText(_('loading menu ...'));
       MenuForm.LoadSkin(Preferences.SPSkin);
@@ -4028,6 +4031,7 @@
 procedure TMainForm.FinaliseStart;
 begin
   initLobbyScript;
+  UpdateFilters(CurrentFilters);
   if Preferences.EnableSpringDownloader then
     StartSpringDownloader;
   TipsForm.ShowTips;
@@ -6349,7 +6353,7 @@
             PostMessage(BattleForm.Handle, WM_STARTGAME, 0, 0);
             // if founder of the battle we are participating in just went in-game, we must launch the game too!
           end;
-          if isBattleVisible(Battles[i]) and TBattle(Battles[i]).Visible then
+          if isBattleVisible(Battles[i],CurrentFilters) and TBattle(Battles[i]).Visible then
             SortBattleInList(i, Preferences.BattleSortStyle, Preferences.BattleSortDirection = 0)
           else
           begin
@@ -6409,7 +6413,7 @@
       Battle.Locked := tmpBool;
 
       oldVisible := Battle.Visible;
-      Battle.Visible := isBattleVisible(Battle);
+      Battle.Visible := isBattleVisible(Battle,CurrentFilters);
       if Battle.Visible &lt;&gt; oldVisible then begin
         RefreshBattleList;
       end;
@@ -6569,7 +6573,7 @@
               luaOpt := BattleForm.GetLuaOption(BattleForm.MapOptionsList,sl3[2]);
               if (BattleForm.SpTBXTabControl1.ActivePage.Item.Name &lt;&gt; 'MapTab') and (BattleState.Status &lt;&gt; Hosting) then
               begin
-                BattleForm.MapTab.FontSettings.Bold := tsTrue;
+                //BattleForm.MapTab.FontSettings.Bold := tsTrue;
               end;
             end
             else
@@ -6577,13 +6581,13 @@
               luaOpt := BattleForm.GetLuaOption(BattleForm.ModOptionsList,sl3[2]);
               if (BattleForm.SpTBXTabControl1.ActivePage.Item.Name &lt;&gt; 'ModTab') and (BattleState.Status &lt;&gt; Hosting) then
               begin
-                BattleForm.ModTab.FontSettings.Bold := tsTrue;
+                //BattleForm.ModTab.FontSettings.Bold := tsTrue;
               end;
             end;
 
             if (BattleForm.SpTBXTabControl1.ActivePage.Item.Name &lt;&gt; 'GameOptionsTab') and (BattleState.Status &lt;&gt; Hosting) and not tmpBool then
             begin
-              BattleForm.GameOptionsTab.FontSettings.Bold := tsFalse;
+              //BattleForm.GameOptionsTab.FontSettings.Bold := tsFalse;
             end;
 
             if luaOpt &lt;&gt; nil then
@@ -7498,7 +7502,7 @@
     Break;
   end;
 
-  if not found then if Length(ServerList) &gt; 0 then
+  if not found and (Length(ServerList) &gt; 0) then
   begin
     // try the first server in the list
     Reconnect(ServerList[0].Address,ServerList[0].Port);
@@ -7727,6 +7731,7 @@
     splitedString[completionWordIndex] := ValidClientsList[0]
   else
   begin
+    j := 0;
     for i:=0 to ValidClientsList.Count-1 do
       if LowerCase(ValidClientsList[i]) = LowerCase(splitedString[completionWordIndex]) then
       begin
@@ -8037,7 +8042,10 @@
   end;
   realIndex := i;
 
-  ClientName := TClient(cList[realIndex]).Name;
+  if realIndex&gt;-1 then
+    ClientName := TClient(cList[realIndex]).Name
+  else
+    AddMainLog('Error: Player not found in global player list. (2)',Colors.Error);
 
   OpenPrivateChat(ClientName);
 end;
@@ -8060,6 +8068,7 @@
 begin
   with Sender as TVirtualDrawTree, PaintInfo do
   begin
+    try
     Battle := GetBattleFromNode(Node);
 
     R := ContentRect;
@@ -8170,6 +8179,9 @@
        DrawTextW(Canvas.Handle, PWideChar(S), Length(S), R, DT_TOP or DT_LEFT or DT_VCENTER or DT_SINGLELINE, False);
  //     Canvas.TextOut(ContentRect.Left, ContentRect.Top, s);
     end;
+    except
+      Canvas.TextOut(ContentRect.Left, ContentRect.Top, 'Error');
+    end;
   end;
 
 end;
@@ -8192,6 +8204,7 @@
   with Sender as TVirtualDrawTree do
     AMargin := TextMargin;
 
+  try
 
   Battle := GetBattleFromNode(Node);
 
@@ -8221,6 +8234,10 @@
       NodeWidth := Canvas.TextWidth(s) + 2 * AMargin; // players
     end;
   end; // case
+
+  except
+    NodeWidth := Canvas.TextWidth('Error') + 2 * AMargin;
+  end;
 end;
 
 procedure TMainForm.VDTBattlesChecked(Sender: TBaseVirtualTree;
@@ -8313,6 +8330,8 @@
       Exit;
     end;
   end;
+  mnuAutoplayFirstAvailable.Checked := False;
+  mnuAutospecFirstAvailable.Checked := False;
   BattleState.TryingToJoinLadderBattle := Battle.IsLadderBattle;
   BattleState.LadderIndex := -1;
   TryToSendCommand('JOINBATTLE', IntToStr(Battle.ID) + IFF(Password &lt;&gt; '', ' ' + Password, ''));
@@ -8351,7 +8370,8 @@
   PerformForm.SaveCommandListToFile(ExtractFilePath(Application.ExeName) + VAR_FOLDER + '\perform.dat');
   HighlightingForm.SaveHighlightsToFile(ExtractFilePath(Application.ExeName) + VAR_FOLDER + '\highlights.dat');
   IgnoreListForm.SaveIgnoreListToFile(ExtractFilePath(Application.ExeName) + VAR_FOLDER + '\ignorelist.dat');
-  SaveFiltersToFile(FILTERS_FOLDER + '\default.ini');
+  SaveFiltersToFile(FILTERS_FOLDER + '\default.ini',CurrentFilters);
+  AutoJoinForm.SaveAutoJoinPresetLists;
   ReplaysForm.SaveReplayFiltersToFile(REPLAY_FILTERS_FOLDER + '\default.ini');
   if not RunningUnderWine then
     MenuForm.SaveSettings;
@@ -8541,11 +8561,13 @@
   end;
 end;
 
-function TMainForm.CompareBattles(Battle1, Battle2: TBattle; SortStyle: Byte): Shortint;
+function TMainForm.CompareBattles(Battle1, Battle2: TBattle; SortStyle: Byte; SortDirection: Boolean): Shortint;
 var
   avgRank1,avgRank2: float;
   i:integer;
+  asc: ShortInt;
 begin
+  if SortDirection then asc := 1 else asc := -1;
   case SortStyle of
     0: Result := 0; // no sorting
     // sort by battle status:
@@ -8559,11 +8581,22 @@
     // sort by mod:
     2: if AnsiCompareText(Battle1.ModName, Battle2.ModName) = 0 then Result := 0 else if AnsiCompareText(Battle1.ModName, Battle2.ModName) &gt; 0 then Result := 1 else Result := -1;
     // sort by players:
-    3: if Battle1.Clients.Count - Battle1.SpectatorCount = Battle2.Clients.Count - Battle2.SpectatorCount then Result := 0 else if Battle1.Clients.Count - Battle1.SpectatorCount &gt; Battle2.Clients.Count - Battle2.SpectatorCount then Result := -1 else Result := 1;
+    3:  if Battle1.Clients.Count - Battle1.SpectatorCount = Battle2.Clients.Count - Battle2.SpectatorCount then
+          if Battle1.SpectatorCount = Battle2.SpectatorCount then
+            Result := 0
+          else if Battle1.SpectatorCount &gt; Battle2.SpectatorCount then
+            Result := -1
+          else
+            Result := 1
+        else if Battle1.Clients.Count - Battle1.SpectatorCount &gt; Battle2.Clients.Count - Battle2.SpectatorCount then
+          Result := -1
+        else
+          Result := 1;
     // sort by map:
     4: if AnsiCompareText(Battle1.Map, Battle2.Map) = 0 then Result := 0 else if AnsiCompareText(Battle1.Map, Battle2.Map) &gt; 0 then Result := 1 else Result := -1;
     // sort by host:
     5: if AnsiCompareText(TClient(Battle1.Clients[0]).Name, TClient(Battle2.Clients[0]).Name) = 0 then Result := 0 else if AnsiCompareText(TClient(Battle1.Clients[0]).Name, TClient(Battle2.Clients[0]).Name) &gt; 0 then Result := 1 else Result := -1;
+    // sort by average rank
     6:
     begin
       avgRank1 := 0;
@@ -8581,6 +8614,7 @@
   else
     Result := 0;
   end; // case
+  Result := asc*Result;
 end;
 
 procedure TMainForm.SortClientsList(List: TList; SortStyle: Byte);
@@ -8592,6 +8626,10 @@
 begin
   Result := MainForm.CompareClients(TClient(Item1), TClient(Item2), Preferences.SortStyle);
 end;
+function BattleSortCompare(Item1, Item2: Pointer): Integer;
+begin
+  Result := MainForm.CompareBattles(TBattle(Item1), TBattle(Item2), BattleSorting, BattleSortingDirection);
+end;
 
 procedure TMainForm.SortClientInList(client: TClient;List: TList; SortStyle: Byte);
 var
@@ -8627,24 +8665,15 @@
 
 { will sort &quot;Battles&quot; list. It won't invalidate (repaint) VDTBattles tree! Call VDTBattles.Invalidate to do that manually.
   If Ascending is False, then the list will be sorted in descending order. }
-procedure TMainForm.SortBattlesList(SortStyle: Byte; Ascending: Boolean);
+procedure TMainForm.SortBattlesList(BattleList: TList; SortStyle: Byte; Ascending: Boolean);
 var
   i, j: Integer;
   tmp: TBattle;
   tmpNode: PVirtualNode;
-  asc: ShortInt;
 begin
-  if Ascending then asc := 1 else asc := -1;
-  // simple bubble sort:
-  for i := Battles.count-1 downto 0 do
-    for j := 0 to i-1 do
-      if asc * CompareBattles(TBattle(Battles[j]), TBattle(Battles[j+1]), SortStyle) &gt; 0 then
-      begin
-        // swap:
-        tmp := Battles[j];
-        Battles[j] := Battles[j+1];
-        Battles[j+1] := tmp;
-      end;
+  BattleSorting := SortStyle;
+  BattleSortingDirection := Ascending;
+  BattleList.Sort(BattleSortCompare);
 
   tmpNode := nil;
   tmpNode := VDTBattles.GetFirst();
@@ -8655,7 +8684,7 @@
     end;
 end;
 
-function TMainForm.isBattleVisible(Battle:TBattle):Boolean;
+function TMainForm.isBattleVisible(Battle:TBattle;Filters: TPresetFilters):Boolean;
 var
   i,j: integer;
   tmpStr: string;
@@ -8707,14 +8736,12 @@
       (Filters.NatTraversal or (Battle.NATType = 0)) and
       (Filters.Replays or (Battle.BattleType = 0)) and
       (Filters.RankLimitSupEqMine or (Battle.RankLimit &lt;= Status.Me.GetRank)) and
-      (
-      (Filters.Replays and (Battle.BattleType = 1)) or
-      not Filters.Players.enabled or
-      ((Filters.Players.filterType = Sup) and ((Battle.Clients.Count-Battle.SpectatorCount) &gt; Filters.Players.value)) or
-      ((Filters.Players.filterType = Inf) and ((Battle.Clients.Count-Battle.SpectatorCount) &lt; Filters.Players.value)) or
-      ((Filters.Players.filterType = Equal) and ((Battle.Clients.Count-Battle.SpectatorCount) = Filters.Players.value))
-      ) and (
-      not Filters.MaxPlayers.enabled or
+      (not Filters.Players.enabled or
+      ((Filters.Players.filterType = Sup) and (Battle.Clients.Count-Battle.SpectatorCount &gt; Filters.Players.value)) or
+      ((Filters.Players.filterType = Inf) and (Battle.Clients.Count-Battle.SpectatorCount &lt; Filters.Players.value)) or
+      ((Filters.Players.filterType = Equal) and (Battle.Clients.Count-Battle.SpectatorCount = Filters.Players.value))
+      ) and
+      (not Filters.MaxPlayers.enabled or
       ((Filters.MaxPlayers.filterType = Sup) and (Battle.MaxPlayers &gt; Filters.MaxPlayers.value)) or
       ((Filters.MaxPlayers.filterType = Inf) and (Battle.MaxPlayers &lt; Filters.MaxPlayers.value)) or
       ((Filters.MaxPlayers.filterType = Equal) and (Battle.MaxPlayers = Filters.MaxPlayers.value))
@@ -8725,7 +8752,6 @@
 var
   i,j:integer;
   BattleNodeCount : integer;
-  asc: ShortInt;
   tmp : TBattle;
   PTmpNode : PVirtualNode;
   nb:integer;
@@ -8735,22 +8761,12 @@
 
   while RefreshingBattleList do;
   RefreshingBattleList := true;
-  
-  if Preferences.BattleSortDirection=0 then asc := 1 else asc := -1;
-  // simple bubble sort:
-  for i := Battles.count-1 downto 0 do
-    for j := 0 to i-1 do
-      if asc * CompareBattles(TBattle(Battles[j]), TBattle(Battles[j+1]), Preferences.BattleSortStyle) &gt; 0 then
-      begin
-        // swap:
-        tmp := Battles[j];
-        Battles[j] := Battles[j+1];
-        Battles[j+1] := tmp;
-      end;
 
+  SortBattlesList(Battles,Preferences.BattleSortStyle,Preferences.BattleSortDirection=0);
+
   j:=0;
   for i:=0 to Battles.Count-1 do begin
-    TBattle(Battles[i]).Visible := isBattleVisible(Battles[i]);
+    TBattle(Battles[i]).Visible := isBattleVisible(Battles[i],CurrentFilters);
     if TBattle(Battles[i]).Visible then begin
       j:=j+1;
       //VDTBattles.DeleteNode(TBattle(Battles[i]).Node);
@@ -8792,13 +8808,10 @@
   i,j: Integer;
   tmp: TBattle;
   tmpNode: PVirtualNode;
-  asc: ShortInt;
 begin
 
   if (Index &lt; 0) or (Index &gt; Battles.Count-1) then Exit; // this should not happen!
 
-  if Ascending then asc := 1 else asc := -1;
-
   // sort down:
   {*for i := Index+1 to Battles.Count-1 do
     if (asc * CompareBattles(TBattle(Battles[Index]), TBattle(Battles[i]), SortStyle) &gt; 0) or not TBattle(Battles[i]).Visible then
@@ -8836,7 +8849,7 @@
     else break;
   end;*}
   for i := Index+1 to Battles.Count-1 do
-    if (asc * CompareBattles(TBattle(Battles[Index]), TBattle(Battles[i]), SortStyle) &gt; 0) then
+    if (CompareBattles(TBattle(Battles[Index]), TBattle(Battles[i]), SortStyle, Ascending) &gt; 0) then
     begin
         // swap:
         tmp := Battles[i];
@@ -8848,7 +8861,7 @@
 
   // sort up:
   for i := Index-1 downto 0 do begin
-    if (asc * CompareBattles(TBattle(Battles[Index]), TBattle(Battles[i]), SortStyle) &lt; 0) then
+    if (CompareBattles(TBattle(Battles[Index]), TBattle(Battles[i]), SortStyle, Ascending) &lt; 0) then
     begin
         // swap:
         tmp := Battles[i];
@@ -8892,6 +8905,8 @@
   Battle := GetBattleFromNode(Node);
 
   with (Sender as TVirtualDrawTree) do
+    try
+
     if Header.Columns[Column].Text = 'Players' then
       R := Rect(0, 0, Canvas.TextWidth(Battle.ClientsToString) + 20, 18)
     else if Header.Columns[Column].Text = 'Mod' then
@@ -8928,6 +8943,9 @@
       R := Rect(0, 0, Canvas.TextWidth(Battle.Description) + 20, 18)
     else if Header.Columns[Column].Text = 'Avg Players rank' then
       R := Rect(0, 0, Canvas.TextWidth(Header.Columns[Column].Hint) + 20, 18);
+    except
+      R := Rect(0, 0, Canvas.TextWidth('Error') + 20, 18);
+    end;
 end;
 
 procedure TMainForm.VDTBattlesDrawHint(Sender: TBaseVirtualTree;
@@ -8939,6 +8957,8 @@
 begin
   with Sender as TVirtualDrawTree, HintCanvas do
   begin
+    try
+
     Battle := GetBattleFromNode(Node);
     Pen.Color := clBlack;
     Brush.Color := $00ffdddd; { 0 b g r }
@@ -8982,7 +9002,7 @@
           Font.Style := [];
           TextOut(120, 10+TextHeight(MapName), _('Map size: ')+IntToStr(MapInfo.Width div 64)+'x'+IntToStr(MapInfo.Height div 64));
           TextOut(120, 10+TextHeight(MapName)*2, _('Max. metal: ')+FloatToStr(RoundTo(MapInfo.MaxMetal,-3)));
-          TextOut(120, 10+TextHeight(MapName)*3, _('Wind (min/max): ')+IntToStr(MapInfo.MinWind)+'-'+IntToStr(MapInfo.MaxWind));
+          TextOut(120, 10+TextHeight(MapName)*3, _('Wind (min/max/avg): ')+IntToStr(MapInfo.MinWind)+'-'+IntToStr(MapInfo.MaxWind));
           DrawMultilineText(MapInfo.Description,HintCanvas,Rect(120,10+10+TextHeight(MapName)*4,R.Right-10,R.Bottom-5),alHLeft,alVTop,JustLeft,true);
         end;
       end
@@ -8996,6 +9016,10 @@
     else if Header.Columns[Column].Text = 'Avg Players rank' then
       TextOut(5, 2, Header.Columns[Column].Hint);
 
+    except
+      TextOut(5, 2, 'Error');
+    end;
+
   end;
 end;
 
@@ -9027,14 +9051,28 @@
 var
   i: Integer;
 begin
-  for i := 0 to High(CountryNames) do if Copy(CountryNames[i], Length(CountryNames[i])-1, 2) = CountryCode then
-  begin
-    Result := Copy(CountryNames[i], 1, Length(CountryNames[i])-2);
-    Exit;
-  end;
+  for i := 0 to High(CountryNames) do
+    if LowerCase(RightStr(CountryNames[i], Length(CountryCode))) = LowerCase(CountryCode) then
+    begin
+      Result := LeftStr(CountryNames[i],Length(CountryNames[i])-Length(CountryCode)-1);
+      Exit;
+    end;
   Result := 'Unknown country'; // should not happen
 end;
 
+function TMainForm.GetCountryCode(CountryName: string): string;
+var
+  i: Integer;
+begin
+  for i := 0 to High(CountryNames) do
+    if LowerCase(LeftStr(CountryNames[i], Length(CountryName))) = LowerCase(CountryName) then
+    begin
+      Result := RightStr(CountryNames[i],Length(CountryNames[i])-Length(CountryName)-1);
+      Exit;
+    end;
+  Result := 'Unknown country'; // should not happen
+end;
+
 procedure TMainForm.ClientsListBoxMouseMove(Sender: TObject;
   Shift: TShiftState; X, Y: Integer);
 var
@@ -9173,6 +9211,9 @@
 procedure TMainForm.VDTBattlesHeaderClick(Sender: TVTHeader;
   Column: TColumnIndex; Button: TMouseButton; Shift: TShiftState; X,
   Y: Integer);
+var
+  tmpNode: PVirtualNode;
+  i: integer;
 begin
   // note: when moving columns, their indexes remain the same!
   // (so the header of the first column may not have index 0)
@@ -9185,7 +9226,16 @@
   Preferences.BattleSortStyle := PreferencesForm.ColumnToBattleSortStyle(Column);
   VDTBattles.Header.SortColumn := Column;
   if Preferences.BattleSortDirection = 0 then VDTBattles.Header.SortDirection := sdAscending else VDTBattles.Header.SortDirection := sdDescending;
-  SortBattlesList(Preferences.BattleSortStyle, Preferences.BattleSortDirection = 0);
+  SortBattlesList(Battles ,Preferences.BattleSortStyle, Preferences.BattleSortDirection = 0);
+
+  tmpNode := nil;
+  tmpNode := VDTBattles.GetFirst();
+  for i:=0 to Battles.Count-1 do
+    if TBattle(Battles[i]).Visible then begin
+      TBattle(Battles[i]).Node := tmpNode;
+      tmpNode := VDTBattles.GetNext(tmpNode);
+    end;
+
   VDTBattles.Invalidate;
 end;
 
@@ -9631,7 +9681,7 @@
 
 procedure TMainForm.mnuSpringHomePageClick(Sender: TObject);
 begin
-  Misc.OpenURLInDefaultBrowser('<A HREF="http://spring.clan-sy.com/">http://spring.clan-sy.com/</A>');
+  Misc.OpenURLInDefaultBrowser('<A HREF="http://springrts.com/">http://springrts.com/</A>');
 end;
 
 procedure TMainForm.CheckNewVersion;
@@ -9872,7 +9922,7 @@
   f^.node := nil;
   f^.contains := ContainsRadio.Checked;
   f^.value := FilterValueTextBox.Text;
-  Filters.TextFilters.Add(f);
+  CurrentFilters.TextFilters.Add(f);
   f^.Node := FilterList.AddChild(FilterList.RootNode);
   f^.Node.CheckType := ctCheckBox;
   f^.Node.CheckState := csCheckedNormal;
@@ -9887,17 +9937,17 @@
   if PlayersSignButton.Caption = '&gt;' then
   begin
     PlayersSignButton.Caption := '&lt;';
-    Filters.Players.filterType := Inf;
+    CurrentFilters.Players.filterType := Inf;
   end
   else if PlayersSignButton.Caption = '&lt;' then
   begin
     PlayersSignButton.Caption := '=';
-    Filters.Players.filterType := Equal;
+    CurrentFilters.Players.filterType := Equal;
   end
   else
   begin
     PlayersSignButton.Caption := '&gt;';
-    Filters.Players.filterType := Sup;
+    CurrentFilters.Players.filterType := Sup;
   end;
   FiltersUpdated;
 end;
@@ -9907,17 +9957,17 @@
   if MaxPlayersSignButton.Caption = '&gt;' then
   begin
     MaxPlayersSignButton.Caption := '&lt;';
-    Filters.MaxPlayers.filterType := Inf;
+    CurrentFilters.MaxPlayers.filterType := Inf;
   end
   else if MaxPlayersSignButton.Caption = '&lt;' then
   begin
     MaxPlayersSignButton.Caption := '=';
-    Filters.MaxPlayers.filterType := Equal;
+    CurrentFilters.MaxPlayers.filterType := Equal;
   end
   else
   begin
     MaxPlayersSignButton.Caption := '&gt;';
-    Filters.MaxPlayers.filterType := Sup;
+    CurrentFilters.MaxPlayers.filterType := Sup;
   end;
   FiltersUpdated;
 end;
@@ -9925,77 +9975,77 @@
 procedure TMainForm.PlayersValueTextBoxChange(Sender: TObject);
 begin
   if not PlayersValueTextBox.Focused then Exit;
-  Filters.Players.value := PlayersValueTextBox.AsInteger;
+  CurrentFilters.Players.value := PlayersValueTextBox.AsInteger;
   FiltersUpdated;
 end;
 
 procedure TMainForm.MaxPlayersValueTextBoxChange(Sender: TObject);
 begin
   if not MaxPlayersValueTextBox.Focused then Exit;
-  Filters.MaxPlayers.value := MaxPlayersValueTextBox.AsInteger;
+  CurrentFilters.MaxPlayers.value := MaxPlayersValueTextBox.AsInteger;
   FiltersUpdated;
 end;
 
 procedure TMainForm.FullFilterClick(Sender: TObject);
 begin
   if not FullFilter.Focused then Exit;
-  Filters.Full := FullFilter.Checked;
+  CurrentFilters.Full := FullFilter.Checked;
   FiltersUpdated;
 end;
 
 procedure TMainForm.InProgressFilterClick(Sender: TObject);
 begin
   if not InProgressFilter.Focused then Exit;
-  Filters.InProgress := InProgressFilter.Checked;
+  CurrentFilters.InProgress := InProgressFilter.Checked;
   FiltersUpdated;
 end;
 
 procedure TMainForm.LadderFilterClick(Sender: TObject);
 begin
   if not LadderFilter.Focused then Exit;
-  Filters.Ladder := LadderFilter.Checked;
+  CurrentFilters.Ladder := LadderFilter.Checked;
   FiltersUpdated;
 end;
 
 procedure TMainForm.LockedFilterClick(Sender: TObject);
 begin
   if not LockedFilter.Focused then Exit;
-  Filters.Locked := LockedFilter.Checked;
+  CurrentFilters.Locked := LockedFilter.Checked;
   FiltersUpdated;
 end;
 
 procedure TMainForm.PasswordedFilterClick(Sender: TObject);
 begin
   if not PasswordedFilter.Focused then Exit;
-  Filters.Passworded := PasswordedFilter.Checked;
+  CurrentFilters.Passworded := PasswordedFilter.Checked;
   FiltersUpdated;
 end;
 
 procedure TMainForm.NatTraversalFilterClick(Sender: TObject);
 begin
   if not NatTraversalFilter.Focused then Exit;
-  Filters.NatTraversal := NatTraversalFilter.Checked;
+  CurrentFilters.NatTraversal := NatTraversalFilter.Checked;
   FiltersUpdated;
 end;
 
 procedure TMainForm.RankLimitFilterClick(Sender: TObject);
 begin
   if not RankLimitFilter.Focused then Exit;
-  Filters.RankLimitSupEqMine := RankLimitFilter.Checked;
+  CurrentFilters.RankLimitSupEqMine := RankLimitFilter.Checked;
   FiltersUpdated;
 end;
 
 procedure TMainForm.MapsNotAvailableFilterClick(Sender: TObject);
 begin
   if not MapsNotAvailableFilter.Focused then Exit;
-  Filters.MapNotAvailable := MapsNotAvailableFilter.Checked;
+  CurrentFilters.MapNotAvailable := MapsNotAvailableFilter.Checked;
   FiltersUpdated;
 end;
 
 procedure TMainForm.ModsNotAvailableFilterClick(Sender: TObject);
 begin
   if not ModsNotAvailableFilter.Focused then Exit;
-  Filters.ModNotAvailable := ModsNotAvailableFilter.Checked;
+  CurrentFilters.ModNotAvailable := ModsNotAvailableFilter.Checked;
   FiltersUpdated;
 end;
 
@@ -10005,7 +10055,7 @@
 var
   filter : TFilterText;
 begin
-  filter := TFilterText(Filters.TextFilters[GetFilterIndexFromNode(node)]^);
+  filter := TFilterText(CurrentFilters.TextFilters[GetFilterIndexFromNode(node)]^);
 
   CellText := 'error';
 
@@ -10037,7 +10087,7 @@
 procedure TMainForm.ReplaysFilterClick(Sender: TObject);
 begin
   if not ReplaysFilter.Focused then Exit;
-  Filters.Replays := ReplaysFilter.Checked;
+  CurrentFilters.Replays := ReplaysFilter.Checked;
   FiltersUpdated;
 end;
 
@@ -10054,7 +10104,7 @@
   n := FilterList.GetFirstSelected;
   while n &lt;&gt; nil do
   begin
-    Filters.TextFilters.Delete(GetFilterIndexFromNode(n));
+    CurrentFilters.TextFilters.Delete(GetFilterIndexFromNode(n));
     n := FilterList.GetNextSelected(n);
   end;
   FilterList.DeleteSelectedNodes;
@@ -10063,7 +10113,7 @@
 
 procedure TMainForm.ClearFilterListButtonClick(Sender: TObject);
 begin
-  Filters.TextFilters.Clear;
+  CurrentFilters.TextFilters.Clear;
   FilterList.Clear;
   FiltersUpdated;
 end;
@@ -10081,7 +10131,12 @@
   text1: String;
   text2: String;
 begin
-  filter := TFilterText(Filters.TextFilters[GetFilterIndexFromNode(Node1)]^);
+  Result := 1;
+  try
+    filter := TFilterText(Filters.TextFilters[GetFilterIndexFromNode(Node1)]^);
+  except
+    Exit;
+  end;
 
   case Column of
     1:
@@ -10101,7 +10156,11 @@
     3:text1 := filter.value;
   end;
 
-  filter2 := TFilterText(Filters.TextFilters[GetFilterIndexFromNode(Node2)]^);
+  try
+    filter2 := TFilterText(Filters.TextFilters[GetFilterIndexFromNode(Node2)]^);
+  except
+    Exit;
+  end;
 
   case Column of
     1:
@@ -10140,7 +10199,7 @@
   end;
 end;
 
-procedure TMainForm.SaveFiltersToFile(path : string);
+procedure TMainForm.SaveFiltersToFile(path : string;Filters: TPresetFilters);
 var
   Filename : String;
   Ini : TIniFile;
@@ -10152,6 +10211,7 @@
       DeleteFile(Filename);
     Ini := TIniFile.Create(Filename);
     i := 0;
+    Ini.WriteString('PresetInfo','Name',Filters.Name);
     Ini.WriteBool('StaticFilters','Full',Filters.Full);
     Ini.WriteBool('StaticFilters','InProgress',Filters.InProgress);
     Ini.WriteBool('StaticFilters','Ladder',Filters.Ladder);
@@ -10204,7 +10264,7 @@
   end;
 end;
 
-procedure TMainForm.LoadFiltersFromFile(path : string);
+procedure TMainForm.LoadFiltersFromFile(path : string;var Filters: TPresetFilters);
 var
   Filename : String;
   Ini : TIniFile;
@@ -10215,6 +10275,8 @@
   Filename := path; //VAR_FOLDER + '\' + 'filters.ini';
   Ini := TIniFile.Create(Filename);
   i := 0;
+  Randomize;
+  Filters.Name := Ini.ReadString('PresetInfo','Name','Preset_'+IntToStr(RandomRange(1,MaxInt)));
   Filters.Full := Ini.ReadBool('StaticFilters', 'Full', True);
   Filters.InProgress := Ini.ReadBool('StaticFilters', 'InProgress', True);
   Filters.Ladder := Ini.ReadBool('StaticFilters', 'Ladder', True);
@@ -10278,6 +10340,7 @@
 var
   FileAttrs: Integer;
   sr: TSearchRec;
+  newPreset: PPresetFilters;
 begin
   FileAttrs := faAnyFile;
   if FindFirst(FILTERS_FOLDER + '\*.ini', FileAttrs, sr) = 0 then
@@ -10285,7 +10348,11 @@
     repeat
       if (sr.Name &lt;&gt; '.') and (sr.Name &lt;&gt; '..') and (sr.Name &lt;&gt; 'default.ini') then
       begin
-        PresetListbox.Items.Add(LeftStr(''+sr.Name,Length(''+sr.Name)-4));
+        New(newPreset);
+        newPreset.TextFilters := TList.Create;
+        LoadFiltersFromFile(FILTERS_FOLDER+'\'+sr.Name,newPreset^);
+        PresetListbox.Items.Add(newPreset.Name);
+        PresetList.Add(newPreset);
       end;
     until FindNext(sr) &lt;&gt; 0;
     FindClose(sr);
@@ -10298,48 +10365,49 @@
   RefreshBattleList;
 end;
 
-procedure TMainForm.UpdateFilters;
+procedure TMainForm.UpdateFilters(pFilters: TPresetFilters);
 var
   i: integer;
 begin
-  FullFilter.Checked := Filters.Full;
-  InProgressFilter.Checked := Filters.InProgress;
-  LadderFilter.Checked := Filters.Ladder;
-  LockedFilter.Checked := Filters.Locked;
-  PasswordedFilter.Checked := Filters.Passworded;
-  NatTraversalFilter.Checked := Filters.NatTraversal;
-  MapsNotAvailableFilter.Checked := Filters.MapNotAvailable;
-  ModsNotAvailableFilter.Checked := Filters.ModNotAvailable;
-  ReplaysFilter.Checked := Filters.Replays;
-  RankLimitFilter.Checked := Filters.RankLimitSupEqMine;
-  PlayersFilter.Checked := Filters.Players.enabled;
-  MaxPlayersFilter.Checked := Filters.MaxPlayers.enabled;
+  FullFilter.Checked := pFilters.Full;
+  InProgressFilter.Checked := pFilters.InProgress;
+  LadderFilter.Checked := pFilters.Ladder;
+  LockedFilter.Checked := pFilters.Locked;
+  PasswordedFilter.Checked := pFilters.Passworded;
+  NatTraversalFilter.Checked := pFilters.NatTraversal;
+  MapsNotAvailableFilter.Checked := pFilters.MapNotAvailable;
+  ModsNotAvailableFilter.Checked := pFilters.ModNotAvailable;
+  ReplaysFilter.Checked := pFilters.Replays;
+  RankLimitFilter.Checked := pFilters.RankLimitSupEqMine;
+  PlayersFilter.Checked := pFilters.Players.enabled;
+  MaxPlayersFilter.Checked := pFilters.MaxPlayers.enabled;
 
-  if Filters.Players.filterType = Sup then
+  if pFilters.Players.filterType = Sup then
     PlayersSignButton.Caption := '&gt;'
-  else if Filters.Players.filterType = Inf then
+  else if pFilters.Players.filterType = Inf then
     PlayersSignButton.Caption := '&lt;'
   else
     PlayersSignButton.Caption := '=';
-  PlayersValueTextBox.Value := Filters.Players.value;
+  PlayersValueTextBox.value := pFilters.Players.value;
 
-  if Filters.MaxPlayers.filterType = Sup then
+
+  if pFilters.MaxPlayers.filterType = Sup then
     MaxPlayersSignButton.Caption := '&gt;'
-  else if Filters.MaxPlayers.filterType = Inf then
+  else if pFilters.MaxPlayers.filterType = Inf then
     MaxPlayersSignButton.Caption := '&lt;'
   else
     MaxPlayersSignButton.Caption := '=';
-  MaxPlayersValueTextBox.Value := Filters.MaxPlayers.value;
+  MaxPlayersValueTextBox.Value := pFilters.MaxPlayers.value;
 
   FilterList.Clear;
-  for i:=0 to Filters.TextFilters.Count -1 do
+  for i:=0 to pFilters.TextFilters.Count -1 do
   begin
-    TFilterText(Filters.TextFilters[i]^).Node := FilterList.AddChild(FilterList.RootNode);
-    TFilterText(Filters.TextFilters[i]^).Node.CheckType := ctCheckBox;
-    if TFilterText(Filters.TextFilters[i]^).enabled then
-      TFilterText(Filters.TextFilters[i]^).Node.CheckState := csCheckedNormal
+    TFilterText(pFilters.TextFilters[i]^).Node := FilterList.AddChild(FilterList.RootNode);
+    TFilterText(pFilters.TextFilters[i]^).Node.CheckType := ctCheckBox;
+    if TFilterText(pFilters.TextFilters[i]^).enabled then
+      TFilterText(pFilters.TextFilters[i]^).Node.CheckState := csCheckedNormal
     else
-      TFilterText(Filters.TextFilters[i]^).Node.CheckState := csUncheckedNormal;
+      TFilterText(pFilters.TextFilters[i]^).Node.CheckState := csUncheckedNormal;
   end;
 end;
 
@@ -10364,14 +10432,14 @@
 procedure TMainForm.PlayersFilterClick(Sender: TObject);
 begin
   if not PlayersFilter.Focused then Exit;
-  Filters.Players.enabled := PlayersFilter.Checked;
+  CurrentFilters.Players.enabled := PlayersFilter.Checked;
   FiltersUpdated;
 end;
 
 procedure TMainForm.MaxPlayersFilterClick(Sender: TObject);
 begin
   if not MaxPlayersFilter.Focused then Exit;
-  Filters.MaxPlayers.enabled := MaxPlayersFilter.Checked;
+  CurrentFilters.MaxPlayers.enabled := MaxPlayersFilter.Checked;
   FiltersUpdated;
 end;
 
@@ -10745,8 +10813,10 @@
         if tmp = -1 then break;
       end;
       realIndex := i;
-
-      Client := TClient(cList[realIndex]);
+      if realIndex &gt; -1 then
+        Client := TClient(cList[realIndex])
+      else
+        AddMainLog('Error: Player not found in the global player list.',Colors.Error);
   end
   else
     Client := RichEditSelectedClient;
@@ -11026,7 +11096,7 @@
 
 procedure TMainForm.SpTBXItem3Click(Sender: TObject);
 begin
-    Misc.OpenURLInDefaultBrowser('<A HREF="http://spring.clan-sy.com/websvn/log.php?repname=spring&amp;path=%2FLobby%2FTASClient%2F">http://spring.clan-sy.com/websvn/log.php?repname=spring&amp;path=%2FLobby%2FTASClient%2F</A>');
+    Misc.OpenURLInDefaultBrowser('<A HREF="http://springrts.com/websvn/log.php?repname=Spring&amp;path=%2FLobby%2FTASClient%2F&amp;rev=0&amp;sc=0&amp;isdir=1">http://springrts.com/websvn/log.php?repname=Spring&amp;path=%2FLobby%2FTASClient%2F&amp;rev=0&amp;sc=0&amp;isdir=1</A>');
 end;
 
 procedure TMainForm.mnuBattleDlMapClick(Sender: TObject);
@@ -11121,41 +11191,6 @@
   PreferencesForm.DisplayQuickJoinPanelCheckBox.Checked := QuickJoinPanel.Visible;
 end;
 
-procedure TMainForm.btSpecatateNowClick(Sender: TObject);
-var
-  i: integer;
-  selected : integer;
-  ratioPlayerMaxPlayer : double;
-begin
-  if BattleForm.IsBattleActive then
-    Exit;
-  ratioPlayerMaxPlayer := 0;
-  selected := -1;
-  for i:=0 to Battles.Count-1 do
-  begin
-    with TBattle(Battles[i]) do
-    begin
-      if not IsBattleInProgress and not Password and (BattleType = 0) and not Locked then
-      begin
-        if IsBattleFull then
-        begin
-          JoinBattle(TBattle(Battles[i]), true);
-          Exit;
-        end;
-        if (Clients.Count-SpectatorCount)/MaxPlayers &gt; ratioPlayerMaxPlayer then
-        begin
-          ratioPlayerMaxPlayer := (Clients.Count-SpectatorCount)/MaxPlayers;
-          selected := i;
-        end;
-      end;
-    end;
-  end;
-  if selected &gt; -1 then
-    JoinBattle(TBattle(Battles[selected]), true)
-  else
-    MessageDlg(_('Sorry, there is no battle available.'),mtInformation,[mbOk],0);
-end;
-
 procedure TMainForm.btPlayNowClick(Sender: TObject);
 var
   i: integer;
@@ -11214,22 +11249,30 @@
 end;
 
 procedure TMainForm.btSavePresetClick(Sender: TObject);
+var
+  newPreset: PPresetFilters;
 begin
   if PresetListbox.Items.IndexOf(PresetNameTextbox.Text) &gt;= 0 then
   begin
     MessageDlg(_('That preset name already exists. Please choose another one.'),mtWarning,[mbOk],0);
     Exit;
   end;
-  SaveFiltersToFile(FILTERS_FOLDER + '\'+PresetNameTextbox.Text+'.ini');
+  CurrentFilters.Name := PresetNameTextbox.Text;
+  SaveFiltersToFile(FILTERS_FOLDER + '\'+PresetNameTextbox.Text+'.ini',CurrentFilters);
   PresetListbox.Items.Add(PresetNameTextbox.Text);
   PresetListbox.Selected[PresetListbox.Count-1] := true;
+  New(newPreset);
+  newPreset.TextFilters := TList.Create;
+  LoadFiltersFromFile(FILTERS_FOLDER + '\'+PresetNameTextbox.Text+'.ini',newPreset^);
+  newPreset.Name := PresetNameTextbox.Text;
+  PresetList.Add(newPreset);
 end;
 
 procedure TMainForm.PresetListboxClick(Sender: TObject);
 begin
-  if (PresetListbox.ItemIndex = 0) and not FileExists(FILTERS_FOLDER + '\' + PresetListbox.Items[PresetListbox.ItemIndex] + '.ini') then Exit;
-  LoadFiltersFromFile(FILTERS_FOLDER + '\' + PresetListbox.Items[PresetListbox.ItemIndex] + '.ini');
-  UpdateFilters;
+  if (PresetListbox.ItemIndex &lt; 1) then Exit;
+  CurrentFilters := PPresetFilters(PresetList[PresetListbox.ItemIndex-1])^;
+  UpdateFilters(CurrentFilters);
   RefreshBattleList;
 end;
 
@@ -11237,6 +11280,8 @@
 begin
   if PresetListbox.ItemIndex = 0 then Exit;
   DeleteFile(FILTERS_FOLDER + '\' + PresetListbox.Items[PresetListbox.ItemIndex] + '.ini');
+  if PresetListbox.ItemIndex &gt; 0 then
+    PresetList.Delete(PresetListbox.ItemIndex-1);
   PresetListbox.Items.Delete(PresetListbox.ItemIndex);
   PresetListbox.Selected[0] := true;
 end;
@@ -11314,15 +11359,6 @@
   SendMessage(PythonScriptDebugForm.Handle, WM_REFRESHOUTPUT, 0, 0);
 end;
 
-procedure TMainForm.SpTBXItem5Click(Sender: TObject);
-begin
-  HostBattlePopupMenu.Items.Add(TSpTBXItem.Create(HostBattlePopupMenu));
-  with HostBattlePopupMenu.Items[HostBattlePopupMenu.Items.Count-1] as TSpTBXItem do
-  begin
-    Caption := 'mega teuf';
-  end;
-end;
-
 procedure TMainForm.lobbyscriptWrapperInitialization(Sender: TObject);
 begin
   if Preferences.ScriptsDisabled then Exit;
@@ -11332,15 +11368,17 @@
 
 procedure TMainForm.initFiltersPresets;
 begin
+  PresetList := TList.Create;
   FiltersTabs.ActiveTabIndex := 0;
+  CurrentFilters.TextFilters := TList.Create;
+  LoadPresets;
+  LoadFiltersFromFile(FILTERS_FOLDER + '\default.ini',CurrentFilters);
+  UpdateFilters(CurrentFilters);
+  PresetListbox.Selected[0] := true;
   FilterGroup.Height := 0;
-  Filters.TextFilters := TList.Create;
-  LoadFiltersFromFile(FILTERS_FOLDER + '\default.ini');
-  UpdateFilters;
-  PresetListbox.Selected[0] := true;
-  LoadPresets;
-end;
+end;    
 
+
 procedure TMainForm.RichEditURLClick(Sender: TObject; URL: String);
 var
   r : boolean;
@@ -11410,7 +11448,7 @@
     end;
 end;
 
-procedure TMainForm.ScrollingNewsImterTimer(Sender: TObject);
+procedure TMainForm.ScrollingNewsTimerTimer(Sender: TObject);
 var
    StartItemNode : IXMLNode;
    ANode : IXMLNode;
@@ -11532,4 +11570,146 @@
   UpdateClientsListBox;
 end;
 
+procedure TMainForm.mnuAutojoinOptionsClick(Sender: TObject);
+begin
+  AutoJoinForm.ShowModal;
+end;
+
+procedure TMainForm.mnuSpringinfoClick(Sender: TObject);
+begin
+  Misc.OpenURLInDefaultBrowser('<A HREF="http://www.springinfo.info/">http://www.springinfo.info/</A>');
+end;
+
+function TMainForm.getAutojoinBestBattle(autoJoinPresetList:TList):TBattle;
+var
+  BattleList: TList;
+  SortStyle: byte;
+  i,j,k: integer;
+  curPreset : PPresetFilters;
+begin
+  Result := nil;
+  if autoJoinPresetList.Count = 0 then
+    Exit;
+
+  BattleList := TList.Create;
+  BattleList.Assign(Battles);
+
+  for i:=0 to autoJoinPresetList.Count-1 do
+  begin
+    curPreset := nil;
+    if LowerCase(PAutoJoinPresetItemList(autoJoinPresetList[i]).PresetName) = 'default' then
+      curPreset := @CurrentFilters
+    else
+    for j:=0 to PresetList.Count-1 do
+    begin
+      if LowerCase(PPresetFilters(PresetList[j]).Name) = LowerCase(PAutoJoinPresetItemList(autoJoinPresetList[i]).PresetName) then
+      begin
+        curPreset := PPresetFilters(PresetList[j]);
+        break;
+      end;
+    end;
+    if curPreset &lt;&gt; nil then
+    begin
+      case PAutoJoinPresetItemList(autoJoinPresetList[i]).Sorting of
+        0: SortStyle := 5; // host
+        1: SortStyle := 4; // map
+        2: SortStyle := 1; // state
+        3: SortStyle := 2; // mod
+        4: SortStyle := 6; // avg rank
+        5: SortStyle := 3; // players
+      end;
+      SortBattlesList(BattleList,SortStyle,PAutoJoinPresetItemList(autoJoinPresetList[i]).SortingDirection=0);
+      for k:=0 to BattleList.Count-1 do
+        if isBattleVisible(TBattle(BattleList[k]),curPreset^) then
+        begin
+          Result := TBattle(BattleList[k]);
+          Exit;
+        end;
+    end;
+  end;
+end;
+
+procedure TMainForm.mnuPlaynowClick(Sender: TObject);
+var
+  Battle:TBattle;
+begin
+  Battle := getAutojoinBestBattle(AutoJoinForm.autoPlayPresetList);
+  if Battle = nil then
+  begin
+    MessageDlg(_('Sorry, there is no battle matching your preset filters.'),mtInformation,[mbOK],0);
+    Exit;
+  end;
+  JoinBattle(Battle);
+end;
+
+procedure TMainForm.mnuSpecnowClick(Sender: TObject);
+var
+  Battle:TBattle;
+begin
+  Battle := getAutojoinBestBattle(AutoJoinForm.autoSpecPresetList);
+  if Battle = nil then
+  begin
+    MessageDlg(_('Sorry, there is no battle matching your preset filters.'),mtInformation,[mbOK],0);
+    Exit;
+  end;
+  JoinBattle(Battle,True);
+end;
+
+procedure TMainForm.AutojoinTimerTimer(Sender: TObject);
+var
+  Battle:TBattle;
+begin
+
+  if mnuAutoplayFirstAvailable.Checked and not BattleForm.IsBattleActive then
+  begin
+    Battle := getAutojoinBestBattle(AutoJoinForm.autoPlayPresetList);
+    if Battle = nil then
+    begin
+      Exit;
+    end;
+    JoinBattle(Battle);
+    mnuAutoplayFirstAvailable.Checked := False;
+    Exit;
+  end;
+  if mnuAutospecFirstAvailable.Checked and not BattleForm.IsBattleActive then
+  begin
+    Battle := getAutojoinBestBattle(AutoJoinForm.autoSpecPresetList);
+    if Battle = nil then
+    begin
+      Exit;
+    end;
+    JoinBattle(Battle,True);
+    mnuAutospecFirstAvailable.Checked := False;
+    Exit;
+  end;
+end;
+
+procedure TMainForm.mnuAutoplayFirstAvailableClick(Sender: TObject);
+begin
+  mnuAutospecFirstAvailable.Checked := False;
+end;
+
+procedure TMainForm.mnuAutospecFirstAvailableClick(Sender: TObject);
+begin
+  mnuAutoplayFirstAvailable.Checked := False;
+end;
+
+procedure TMainForm.Button1Click(Sender: TObject);
+var
+  s: string;
+begin
+  s := Format('%i %i',[8,9]);
+  AddMainLog(s,Colors.Error);
+end;
+
+procedure TMainForm.ClearPlayersFilterButtonClick(Sender: TObject);
+begin
+  PlayerFiltersTextbox.Text := '';
+end;
+
+procedure TMainForm.SpTBXButton1Click(Sender: TObject);
+begin
+  AddBotForm.Show;
+end;
+
 end.

Modified: Lobby/TASClient/MapListFormUnit.dfm
===================================================================
--- Lobby/TASClient/MapListFormUnit.dfm	2009-05-28 11:37:21 UTC (rev 7254)
+++ Lobby/TASClient/MapListFormUnit.dfm	2009-05-28 21:16:55 UTC (rev 7255)
@@ -1,6 +1,6 @@
 object MapListForm: TMapListForm
-  Left = 949
-  Top = 210
+  Left = 189
+  Top = 147
   Width = 650
   Height = 400
   Caption = 'Map list'
@@ -1164,7 +1164,7 @@
     TabOrder = 1
   end
   object ChooseGradePopupMenu: TSpTBXPopupMenu
-    Left = 440
+    Left = 368
     Top = 4
     object RemoveGradeItem: TSpTBXItem
       Caption = 'Remove grade'
@@ -1192,7 +1192,7 @@
     Left = 416
   end
   object SortStylePopupMenu: TSpTBXPopupMenu
-    Left = 472
-    Top = 8
+    Left = 288
+    Top = 32
   end
 end

Modified: Lobby/TASClient/MapListFormUnit.pas
===================================================================
--- Lobby/TASClient/MapListFormUnit.pas	2009-05-28 11:37:21 UTC (rev 7254)
+++ Lobby/TASClient/MapListFormUnit.pas	2009-05-28 21:16:55 UTC (rev 7255)
@@ -47,7 +47,7 @@
     procedure AddMap; // will automatically add next map from the utility.pas' MapList list
     function ChooseGradeDialog(UnderControl: TControl; DefaultIndex: Integer): Integer;
 
-    function CompareMapItems(Map1: TMapItem; Map2: TMapItem; SortStyle: Byte): Integer;
+    //function CompareMapItems(Map1: TMapItem; Map2: TMapItem; SortStyle: Byte): Integer;
     procedure SortMapList(SortStyle: Byte);
     procedure FilterMapList(s:String);
     procedure SortMapInList(Index: Integer; SortStyle: Byte);
@@ -166,6 +166,7 @@
     procedure MapImagemouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
   end;
 
+  function CompareMapItems(Item1, Item2: Pointer): Integer;
   function GetMapItem(Index: Integer): TMapItem;
   function FindMapItem(Hash: string): TMapItem; // returns nil if not found
 
@@ -979,9 +980,9 @@
   tmp: Integer;
   mi: TMapItem;
 begin
-
+  SortedMaps.Sort(CompareMapItems);
   // simple bubble sort:
-  for i := SortedMaps.Count-1 downto 0 do
+  {for i := SortedMaps.Count-1 downto 0 do
     for j := 0 to i-1 do
       if CompareMapItems(TMapItem(SortedMaps[j]), TMapItem(SortedMaps[j+1]), SortStyle) &gt; 0 then
       begin
@@ -990,7 +991,7 @@
         mi := SortedMaps[j];
         SortedMaps[j] := SortedMaps[j+1];
         SortedMaps[j+1] := mi;
-      end;
+      end;}
 
    FilterMapList(txtSearch.Text);
 end;
@@ -1040,7 +1041,7 @@
 
   // sort down:
   for i := Index+1 to SortedMaps.Count-1 do
-    if CompareMapItems(TMapItem(SortedMaps[Index]), TMapItem(SortedMaps[i]), SortStyle) &gt; 0 then
+    if CompareMapItems(SortedMaps[Index], SortedMaps[i]) &gt; 0 then
     begin
       tmp := TMapItem(SortedMaps[i]).MainPanel.Top;
       TMapItem(SortedMaps[i]).MainPanel.Top := TMapItem(SortedMaps[Index]).MainPanel.Top;
@@ -1056,7 +1057,7 @@
 
   // sort up:
   for i := Index-1 downto 0 do
-    if CompareMapItems(TMapItem(SortedMaps[Index]), TMapItem(SortedMaps[i]), SortStyle) &lt; 0 then
+    if CompareMapItems(SortedMaps[Index], SortedMaps[i]) &lt; 0 then
     begin
       tmp := TMapItem(SortedMaps[i]).MainPanel.Top;
       TMapItem(SortedMaps[i]).MainPanel.Top := TMapItem(SortedMaps[Index]).MainPanel.Top;
@@ -1075,11 +1076,14 @@
 { returns 0 if both maps are equal (by comparing by SortStyle), positive value if first is &quot;greater&quot; than second, or negative value
   otherwise. Note that resuls it not normalized, i.e. it doesn't return only -1,0,1, but can return arbitrary large positive
   and negative numbers. }
-function TMapListForm.CompareMapItems(Map1: TMapItem; Map2: TMapItem; SortStyle: Byte): Integer;
+function CompareMapItems(Item1, Item2: Pointer): Integer;
 var
   globalGradeVotes1,globalGradeVotes2 : integer;
+  Map1,Map2: TMapItem;
 begin
-  case SortStyle of
+  Map1 := TMapItem(Item1);
+  Map2 := TMapItem(Item2);
+  case Preferences.MapSortStyle of
     // no sorting
     0: Result := 0;
     // sort by map name:
@@ -1095,6 +1099,7 @@
       globalGradeVotes2 := Round((Map2.GlobalGrade - 5)*Map2.TotalVotes);
       if globalGradeVotes1 = globalGradeVotes2 then Result := 0 else if globalGradeVotes1 &gt; globalGradeVotes2 then Result := -1 else Result := 1;
     end;
+    5: Result := Round((Map2.MapInfo.MaxWind+Map2.MapInfo.MinWind)/2) - Round((Map1.MapInfo.MaxWind+Map1.MapInfo.MinWind)/2);
   else
     Result := 0;
   end;

Modified: Lobby/TASClient/MenuFormUnit.pas
===================================================================
--- Lobby/TASClient/MenuFormUnit.pas	2009-05-28 11:37:21 UTC (rev 7254)
+++ Lobby/TASClient/MenuFormUnit.pas	2009-05-28 21:16:55 UTC (rev 7255)
@@ -47,7 +47,7 @@
     property TemplateVarValue: TStringList read FTemplateVarValue;
   end;
 
-  TAIItem =
+  TSPAIItem =
   record
     AIType: string;
     Id: integer;
@@ -858,10 +858,10 @@
 
     varHtmlCode := '';
     templateStr := ReadFile2(CurrentPath+'aiItem.html');
-    for i := 0 to AddBotForm.AIComboBox.Items.Count-1 do
+    for i := 0 to AddBotForm.aiList.Count-1 do
     begin
       tmp := templateStr;
-      tmp := StringReplace(tmp,'[aiName]',AddBotForm.AIComboBox.Items[i],[rfReplaceAll,rfIgnoreCase]);
+      tmp := StringReplace(tmp,'[aiName]',PAIItem(AddBotForm.aiList[i]).values[PAIItem(AddBotForm.aiList[i]).keys.IndexOf('shortname')],[rfReplaceAll,rfIgnoreCase]);
 
       varHtmlCode := varHtmlCode + tmp;
     end;
@@ -925,13 +925,13 @@
       tmp := templateStr;
       tmp := StringReplace(tmp,'[SideList]',varHtmlCode2,[rfReplaceAll,rfIgnoreCase]);
       tmp := StringReplace(tmp,'[PlayerId]',IntToStr(i+2),[rfReplaceAll,rfIgnoreCase]);
-      tmp := StringReplace(tmp,'[PlayerUniqueId]',IntToStr(TAIItem(AIPlayerList[i]^).UniqueId),[rfReplaceAll,rfIgnoreCase]);
-      tmp := StringReplace(tmp,'[PlayerName]',TAIItem(AIPlayerList[i]^).Name,[rfReplaceAll,rfIgnoreCase]);
-      tmp := StringReplace(tmp,'[AIType]',TAIItem(AIPlayerList[i]^).AIType,[rfReplaceAll,rfIgnoreCase]);
-      tmp := StringReplace(tmp,'[SelectedSide]',IntToStr(TAIItem(AIPlayerList[i]^).Side),[rfReplaceAll,rfIgnoreCase]);
-      tmp := StringReplace(tmp,'[SelectedId]',IntToStr(TAIItem(AIPlayerList[i]^).Id),[rfReplaceAll,rfIgnoreCase]);
-      tmp := StringReplace(tmp,'[SelectedTeam]',IntToStr(TAIItem(AIPlayerList[i]^).Team),[rfReplaceAll,rfIgnoreCase]);
-      tmp := StringReplace(tmp,'[Handicap]',IntToStr(TAIItem(AIPlayerList[i]^).Handicap),[rfReplaceAll,rfIgnoreCase]);
+      tmp := StringReplace(tmp,'[PlayerUniqueId]',IntToStr(TSPAIItem(AIPlayerList[i]^).UniqueId),[rfReplaceAll,rfIgnoreCase]);
+      tmp := StringReplace(tmp,'[PlayerName]',TSPAIItem(AIPlayerList[i]^).Name,[rfReplaceAll,rfIgnoreCase]);
+      tmp := StringReplace(tmp,'[AIType]',TSPAIItem(AIPlayerList[i]^).AIType,[rfReplaceAll,rfIgnoreCase]);
+      tmp := StringReplace(tmp,'[SelectedSide]',IntToStr(TSPAIItem(AIPlayerList[i]^).Side),[rfReplaceAll,rfIgnoreCase]);
+      tmp := StringReplace(tmp,'[SelectedId]',IntToStr(TSPAIItem(AIPlayerList[i]^).Id),[rfReplaceAll,rfIgnoreCase]);
+      tmp := StringReplace(tmp,'[SelectedTeam]',IntToStr(TSPAIItem(AIPlayerList[i]^).Team),[rfReplaceAll,rfIgnoreCase]);
+      tmp := StringReplace(tmp,'[Handicap]',IntToStr(TSPAIItem(AIPlayerList[i]^).Handicap),[rfReplaceAll,rfIgnoreCase]);
       varHtmlCode := varHtmlCode + tmp;
     end;
 
@@ -959,13 +959,13 @@
       tmp := templateStr;
       tmp := StringReplace(tmp,'[SideList]',varHtmlCode2,[rfReplaceAll,rfIgnoreCase]);
       tmp := StringReplace(tmp,'[PlayerId]',IntToStr(i+2),[rfReplaceAll,rfIgnoreCase]);
-      tmp := StringReplace(tmp,'[PlayerUniqueId]',IntToStr(TAIItem(AIPlayerList[i]^).UniqueId),[rfReplaceAll,rfIgnoreCase]);
-      tmp := StringReplace(tmp,'[PlayerName]',TAIItem(AIPlayerList[i]^).Name,[rfReplaceAll,rfIgnoreCase]);
-      tmp := StringReplace(tmp,'[AIType]',TAIItem(AIPlayerList[i]^).AIType,[rfReplaceAll,rfIgnoreCase]);
-      tmp := StringReplace(tmp,'[SelectedSide]',IntToStr(TAIItem(AIPlayerList[i]^).Side),[rfReplaceAll,rfIgnoreCase]);
-      tmp := StringReplace(tmp,'[SelectedId]',IntToStr(TAIItem(AIPlayerList[i]^).Id),[rfReplaceAll,rfIgnoreCase]);
-      tmp := StringReplace(tmp,'[SelectedTeam]',IntToStr(TAIItem(AIPlayerList[i]^).Team),[rfReplaceAll,rfIgnoreCase]);
-      tmp := StringReplace(tmp,'[Handicap]',IntToStr(TAIItem(AIPlayerList[i]^).Handicap),[rfReplaceAll,rfIgnoreCase]);
+      tmp := StringReplace(tmp,'[PlayerUniqueId]',IntToStr(TSPAIItem(AIPlayerList[i]^).UniqueId),[rfReplaceAll,rfIgnoreCase]);
+      tmp := StringReplace(tmp,'[PlayerName]',TSPAIItem(AIPlayerList[i]^).Name,[rfReplaceAll,rfIgnoreCase]);
+      tmp := StringReplace(tmp,'[AIType]',TSPAIItem(AIPlayerList[i]^).AIType,[rfReplaceAll,rfIgnoreCase]);
+      tmp := StringReplace(tmp,'[SelectedSide]',IntToStr(TSPAIItem(AIPlayerList[i]^).Side),[rfReplaceAll,rfIgnoreCase]);
+      tmp := StringReplace(tmp,'[SelectedId]',IntToStr(TSPAIItem(AIPlayerList[i]^).Id),[rfReplaceAll,rfIgnoreCase]);
+      tmp := StringReplace(tmp,'[SelectedTeam]',IntToStr(TSPAIItem(AIPlayerList[i]^).Team),[rfReplaceAll,rfIgnoreCase]);
+      tmp := StringReplace(tmp,'[Handicap]',IntToStr(TSPAIItem(AIPlayerList[i]^).Handicap),[rfReplaceAll,rfIgnoreCase]);
       varHtmlCode := varHtmlCode + tmp;
     end;
 
@@ -1251,16 +1251,16 @@
     script.AddOrChangeKeyValue('GAME/modoptions/startmetal',IntToStr(StartMetal));
   script.AddOrChangeKeyValue('GAME/HostIP','localhost');
   script.AddOrChangeKeyValue('GAME/HostPort','8452');
-  script.AddOrChangeKeyValue('GAME/MyPlayerNum','0');
   script.AddOrChangeKeyValue('GAME/MyPlayerName','Me');
   script.AddOrChangeKeyValue('GAME/IsHost','1');
   script.AddOrChangeKeyValue('GAME/NumPlayers','1');
+  script.AddOrChangeKeyValue('GAME/NumUsers','1');
 
   il.Clear;
   il.Add(MePlayer.Id);
   for i:=0 to AIPlayerList.Count-1 do
-    if il.IndexOf(TAIItem(AIPlayerList[i]^).Id) = -1 then
-      il.Add(TAIItem(AIPlayerList[i]^).Id);
+    if il.IndexOf(TSPAIItem(AIPlayerList[i]^).Id) = -1 then
+      il.Add(TSPAIItem(AIPlayerList[i]^).Id);
   script.AddOrChangeKeyValue('GAME/NumTeams',IntToStr(il.Count));
 
   if il.Count &lt; AIPlayerList.Count then
@@ -1274,11 +1274,11 @@
   il.Clear;
   il.Add(MePlayer.Team);
   for i:=0 to AIPlayerList.Count-1 do
-    if il.IndexOf(TAIItem(AIPlayerList[i]^).Team) = -1 then
-      il.Add(TAIItem(AIPlayerList[i]^).Team);
-  script.AddOrChangeKeyValue('GAME/NumAllyTeams',IntToStr(il.Count));
+    if il.IndexOf(TSPAIItem(AIPlayerList[i]^).Team) = -1 then
+      il.Add(TSPAIItem(AIPlayerList[i]^).Team);
+  //script.AddOrChangeKeyValue('GAME/NumAllyTeams',IntToStr(il.Count));
 
-  script.AddOrChangeKeyValue('GAME/PLAYER0/name','Player');
+  script.AddOrChangeKeyValue('GAME/PLAYER0/name','Me');
   script.AddOrChangeKeyValue('GAME/PLAYER0/Spectator','0');
   script.AddOrChangeKeyValue('GAME/PLAYER0/team',IntToStr(MePlayer.Id));
 
@@ -1319,30 +1319,29 @@
 
   for i:=0 to AIPlayerList.Count-1 do
   begin
-    if TAIItem(AIPlayerList[i]^).Id &lt;&gt; MePlayer.Id then
+    if TSPAIItem(AIPlayerList[i]^).Id &lt;&gt; MePlayer.Id then
     begin
+      script.AddOrChangeKeyValue('GAME/AI'+IntToStr(i)+'/Name','AI_'+IntToStr(i+1));
+      script.AddOrChangeKeyValue('GAME/AI'+IntToStr(i)+'/ShortName',TSPAIItem(AIPlayerList[i]^).AIType);
+      script.AddOrChangeKeyValue('GAME/AI'+IntToStr(i)+'/Team',IntToStr(i+1));
+      script.AddOrChangeKeyValue('GAME/AI'+IntToStr(i)+'/Host','0');
+
       script.AddOrChangeKeyValue('GAME/TEAM'+IntToStr(i+1)+'/TeamLeader','0');
-      script.AddOrChangeKeyValue('GAME/TEAM'+IntToStr(i+1)+'/AllyTeam',IntToStr(TAIItem(AIPlayerList[i]^).Team));
+      script.AddOrChangeKeyValue('GAME/TEAM'+IntToStr(i+1)+'/AllyTeam',IntToStr(TSPAIItem(AIPlayerList[i]^).Team));
       tmpInt := RandomRange(0,Colors.Count-1);
       script.AddOrChangeKeyValue('GAME/TEAM'+IntToStr(i+1)+'/RGBColor',Colors[tmpInt]);
       Colors.Delete(tmpInt);
-      script.AddOrChangeKeyValue('GAME/TEAM'+IntToStr(i+1)+'/Side',Utility.SideList[TAIItem(AIPlayerList[i]^).Side]);
-      script.AddOrChangeKeyValue('GAME/TEAM'+IntToStr(i+1)+'/Handicap',IntToStr(TAIItem(AIPlayerList[i]^).Handicap));
+      script.AddOrChangeKeyValue('GAME/TEAM'+IntToStr(i+1)+'/Side',Utility.SideList[TSPAIItem(AIPlayerList[i]^).Side]);
+      script.AddOrChangeKeyValue('GAME/TEAM'+IntToStr(i+1)+'/Handicap',IntToStr(TSPAIItem(AIPlayerList[i]^).Handicap));
 
       if GameMode = 0 then
       begin
-        script.AddOrChangeKeyValue('GAME/TEAM'+IntToStr(i+1)+'/StartPosX',IntToStr(Round(TAIItem(AIPlayerList[i]^).StartPosX*TMapItem(MapListForm.Maps[BattleForm.CurrentMapIndex]).MapInfo.Width*8)));
-        script.AddOrChangeKeyValue('GAME/TEAM'+IntToStr(i+1)+'/StartPosZ',IntToStr(Round(TAIItem(AIPlayerList[i]^).StartPosY*TMapItem(MapListForm.Maps[BattleForm.CurrentMapIndex]).MapInfo.Height*8)));
+        script.AddOrChangeKeyValue('GAME/TEAM'+IntToStr(i+1)+'/StartPosX',IntToStr(Round(TSPAIItem(AIPlayerList[i]^).StartPosX*TMapItem(MapListForm.Maps[BattleForm.CurrentMapIndex]).MapInfo.Width*8)));
+        script.AddOrChangeKeyValue('GAME/TEAM'+IntToStr(i+1)+'/StartPosZ',IntToStr(Round(TSPAIItem(AIPlayerList[i]^).StartPosY*TMapItem(MapListForm.Maps[BattleForm.CurrentMapIndex]).MapInfo.Height*8)));
       end;
 
-      TeamAllyCounter.Items[TAIItem(AIPlayerList[i]^).Team] := TeamAllyCounter.Items[TAIItem(AIPlayerList[i]^).Team]+1;
-      if (Length(TAIItem(AIPlayerList[i]^).AIType) &gt; 6) and (LeftStr(TAIItem(AIPlayerList[i]^).AIType,6) = 'LuaAI:') then
-        script.AddOrChangeKeyValue('GAME/TEAM'+IntToStr(i+1)+'/AIDLL',TAIItem(AIPlayerList[i]^).AIType)
-      else
-        script.AddOrChangeKeyValue('GAME/TEAM'+IntToStr(i+1)+'/AIDLL',AIDLL_FOLDER + '/'+ TAIItem(AIPlayerList[i]^).AIType);
-    end
-    else
-      script.AddOrChangeKeyValue('GAME/TEAM0/AIDLL',AIDLL_FOLDER + '/'+ TAIItem(AIPlayerList[i]^).AIType);
+      TeamAllyCounter.Items[TSPAIItem(AIPlayerList[i]^).Team] := TeamAllyCounter.Items[TSPAIItem(AIPlayerList[i]^).Team]+1;
+    end;
 
   end;
 
@@ -1361,11 +1360,13 @@
   begin
      // mod options:
      for i:=0 to ModOptionsList.Count -1 do
-      script.AddOrChangeKeyValue(TLuaOption(ModOptionsList[i]).KeyPrefix + TLuaOption(ModOptionsList[i]).Key,TLuaOption(ModOptionsList[i]).toString);
+      if TLuaOption(ModOptionsList[i]).ClassType &lt;&gt; TLuaOptionSection then
+        script.AddOrChangeKeyValue(TLuaOption(ModOptionsList[i]).KeyPrefix + TLuaOption(ModOptionsList[i]).Key,TLuaOption(ModOptionsList[i]).toString);
 
      // map options:
      for i:=0 to MapOptionsList.Count -1 do
-      script.AddOrChangeKeyValue(TLuaOption(MapOptionsList[i]).KeyPrefix + TLuaOption(MapOptionsList[i]).Key,TLuaOption(MapOptionsList[i]).toString);
+      if TLuaOption(ModOptionsList[i]).ClassType &lt;&gt; TLuaOptionSection then
+        script.AddOrChangeKeyValue(TLuaOption(MapOptionsList[i]).KeyPrefix + TLuaOption(MapOptionsList[i]).Key,TLuaOption(MapOptionsList[i]).toString);
   end;
 
   il.Free;
@@ -1399,7 +1400,7 @@
 begin
   Result := -1;
   for i:=0 to AIPlayerList.Count-1 do
-    if TAIItem(AIPlayerList[i]^).Id = id then
+    if TSPAIItem(AIPlayerList[i]^).Id = id then
     begin
       Result := i;
       Exit;
@@ -1417,7 +1418,7 @@
   tmpStr: string;
   sl: TStringList;
   sl2: TStringList;
-  bot: ^TAIItem;
+  bot: ^TSPAIItem;
   browsePage: ^TBrowsePage;
 begin
   if AutorisedURLFiles.IndexOf(LowerCase(URL)) &gt;= 0 then
@@ -1645,7 +1646,7 @@
 
       MePlayer.Side := 0;
       for i:=0 to AIPlayerList.Count-1 do
-        TAIItem(AIPlayerList[i]^).Side := 0;
+        TSPAIItem(AIPlayerList[i]^).Side := 0;
 
       LoadMenu('modMain.html',ModMain);
       Exit;
@@ -1841,7 +1842,7 @@
     begin
       tmp := StrToInt(MidStr(command,11,99999));
 
-      freeIds.Add(TAIItem(AIPlayerList[tmp-2]^).Id);
+      freeIds.Add(TSPAIItem(AIPlayerList[tmp-2]^).Id);
       AIPlayerList.Delete(tmp-2);
 
       browsePage := BrowseHistory.Peek;
@@ -1869,7 +1870,7 @@
         end
         else
         begin
-          TAIItem(AIPlayerList[tmp-2]^).Side := StrToInt(sl[1]);
+          TSPAIItem(AIPlayerList[tmp-2]^).Side := StrToInt(sl[1]);
         end;
       except
         MessageDlg(_('Invalid changeside usage : ')+command,mtError,[mbOk],0);
@@ -1901,7 +1902,7 @@
         end
         else
         begin
-          TAIItem(AIPlayerList[tmp-2]^).Id := StrToInt(sl[1]);
+          TSPAIItem(AIPlayerList[tmp-2]^).Id := StrToInt(sl[1]);
         end;
       except
         MessageDlg(_('Invalid changeid usage : ')+command,mtError,[mbOk],0);
@@ -1933,7 +1934,7 @@
         end
         else
         begin
-          TAIItem(AIPlayerList[tmp-2]^).Team := StrToInt(sl[1]);
+          TSPAIItem(AIPlayerList[tmp-2]^).Team := StrToInt(sl[1]);
         end;
       except
         MessageDlg(_('Invalid changeally usage : ')+command,mtError,[mbOk],0);
@@ -1965,7 +1966,7 @@
         end
         else
         begin
-          TAIItem(AIPlayerList[tmp-2]^).Handicap := StrToInt(sl[1]);
+          TSPAIItem(AIPlayerList[tmp-2]^).Handicap := StrToInt(sl[1]);
         end;
       except
         MessageDlg(_('Invalid changehandicap usage : ')+command,mtError,[mbOk],0);
@@ -1998,8 +1999,8 @@
         end
         else
         begin
-          TAIItem(AIPlayerList[tmp-2]^).StartPosX := StrToFloat(sl[1]);
-          TAIItem(AIPlayerList[tmp-2]^).StartPosY := StrToFloat(sl[2]);
+          TSPAIItem(AIPlayerList[tmp-2]^).StartPosX := StrToFloat(sl[1]);
+          TSPAIItem(AIPlayerList[tmp-2]^).StartPosY := StrToFloat(sl[2]);
         end;
       except
         MessageDlg(_('Invalid changestartpos usage : ')+command,mtError,[mbOk],0);

Modified: Lobby/TASClient/Misc.pas
===================================================================
--- Lobby/TASClient/Misc.pas	2009-05-28 11:37:21 UTC (rev 7254)
+++ Lobby/TASClient/Misc.pas	2009-05-28 21:16:55 UTC (rev 7255)
@@ -1411,7 +1411,7 @@
   time := GetTickCount;
   Output := TStringList.Create;
 //*** -&gt; this code caused crashes on Wine: DSiExecuteAndCapture('spring.exe /V', Output, ExtractFilePath(Application.ExeName), ExitCode);
-  CaptureProgramOutput('spring.exe /V', Output);
+  CaptureProgramOutput('spring.exe -V', Output);
 
   if Output.Text = '' then
   begin
@@ -2530,7 +2530,10 @@
     else if (TWinControl(controlList[i]).ClassType = TSpTBXTabSheet) then
       TSpTBXTabSheet(controlList[i]).TabControl.ActivePage := TSpTBXTabSheet(controlList[i])
     else if (TWinControl(controlList[i]).ClassParent = TForm) then
+    begin
       TForm(controlList[i]).Show;
+      while not TForm(controlList[i]).Visible do;
+    end;
 
   c.SetFocus;
 end;

Modified: Lobby/TASClient/PreferencesFormUnit.dfm
===================================================================
--- Lobby/TASClient/PreferencesFormUnit.dfm	2009-05-28 11:37:21 UTC (rev 7254)
+++ Lobby/TASClient/PreferencesFormUnit.dfm	2009-05-28 21:16:55 UTC (rev 7255)
@@ -1,13 +1,13 @@
 object PreferencesForm: TPreferencesForm
-  Left = 1073
-  Top = 229
+  Left = 370
+  Top = 106
   BorderStyle = bsDialog
   Caption = 'Preferences'
-  ClientHeight = 434
+  ClientHeight = 462
   ClientWidth = 415
   Color = clBtnFace
-  Constraints.MaxHeight = 1000
-  Constraints.MaxWidth = 1680
+  Constraints.MaxHeight = 750
+  Constraints.MaxWidth = 1280
   Font.Charset = DEFAULT_CHARSET
   Font.Color = clWindowText
   Font.Height = -11
@@ -25,7 +25,7 @@
     Left = 0
     Top = 0
     Width = 415
-    Height = 434
+    Height = 462
     Caption = 'Preferences'
     FixedSize = True
     Options.Minimize = False
@@ -33,7 +33,7 @@
     TBXStyleBackground = True
     object SpTBXTabControl1: TSpTBXTabControl
       Left = 8
-      Top = 32
+      Top = 64
       Width = 401
       Height = 353
       Color = clBtnFace
@@ -69,134 +69,164 @@
         Caption = 'Scripts'
         CustomWidth = 56
       end
-      object SpTBXTabSheet5: TSpTBXTabSheet
+      object SpTBXTabSheet7: TSpTBXTabSheet
         Left = 0
         Top = 23
         Width = 401
         Height = 330
-        Caption = 'Account'
+        Caption = 'Scripts'
         ImageIndex = -1
-        TabItem = 'SpTBXTabItem5'
-        object GroupBox2: TSpTBXGroupBox
+        Item = SpTBXTabItem7
+        TabControl = SpTBXTabControl1
+        TabItem = 'SpTBXTabItem7'
+        object ScriptsDebugWindowBt: TSpTBXButton
+          Left = 132
+          Top = 56
+          Width = 137
+          Height = 25
+          Caption = 'Debug Window'
+          TabOrder = 0
+          OnClick = ScriptsDebugWindowBtClick
+          LinkFont.Charset = DEFAULT_CHARSET
+          LinkFont.Color = clBlue
+          LinkFont.Height = -11
+          LinkFont.Name = 'MS Sans Serif'
+          LinkFont.Style = [fsUnderline]
+        end
+        object ScriptsReloadBt: TSpTBXButton
+          Left = 132
+          Top = 88
+          Width = 137
+          Height = 25
+          Caption = 'Reload scripts'
+          TabOrder = 1
+          OnClick = ScriptsReloadBtClick
+          LinkFont.Charset = DEFAULT_CHARSET
+          LinkFont.Color = clBlue
+          LinkFont.Height = -11
+          LinkFont.Name = 'MS Sans Serif'
+          LinkFont.Style = [fsUnderline]
+        end
+        object ScriptsLoadNewBt: TSpTBXButton
+          Left = 132
+          Top = 120
+          Width = 137
+          Height = 25
+          Caption = 'Load new scripts'
+          TabOrder = 2
+          OnClick = ScriptsLoadNewBtClick
+          LinkFont.Charset = DEFAULT_CHARSET
+          LinkFont.Color = clBlue
+          LinkFont.Height = -11
+          LinkFont.Name = 'MS Sans Serif'
+          LinkFont.Style = [fsUnderline]
+        end
+        object ScriptsAdvancedOptionsBt: TSpTBXButton
+          Left = 132
+          Top = 152
+          Width = 137
+          Height = 25
+          Caption = 'Advanced options'
+          TabOrder = 3
+          Visible = False
+          OnClick = ScriptsAdvancedOptionsBtClick
+          LinkFont.Charset = DEFAULT_CHARSET
+          LinkFont.Color = clBlue
+          LinkFont.Height = -11
+          LinkFont.Name = 'MS Sans Serif'
+          LinkFont.Style = [fsUnderline]
+        end
+        object EnableScriptsCheckBox: TSpTBXCheckBox
+          Left = 104
+          Top = 24
+          Width = 193
+          Height = 15
+          Caption = 'Enable scripts BETA (requires restart)'
+          TabOrder = 4
+        end
+      end
+      object SpTBXTabSheet1: TSpTBXTabSheet
+        Left = 0
+        Top = 23
+        Width = 401
+        Height = 330
+        Caption = 'Skins'
+        ImageIndex = -1
+        Item = SpTBXTabItem1
+        TabControl = SpTBXTabControl1
+        TabItem = 'SpTBXTabItem1'
+        object GroupBox5: TSpTBXGroupBox
           Left = 16
           Top = 8
-          Width = 369
+          Width = 361
           Height = 305
-          Caption = 'Account details'
+          Caption = 'Skin manager'
           Color = clNone
           ParentColor = False
           TabOrder = 0
-          object RegisterAccountButton: TSpTBXSpeedButton
-            Left = 56
-            Top = 160
-            Width = 185
-            Height = 25
-            Caption = 'Create new account'
-            OnClick = RegisterAccountButtonClick
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
-          object Label4: TSpTBXLabel
-            Left = 24
-            Top = 40
-            Width = 51
-            Height = 13
-            Caption = 'Username:'
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
-          object Label5: TSpTBXLabel
-            Left = 24
-            Top = 72
-            Width = 49
-            Height = 13
-            Caption = 'Password:'
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
-          object UsernameEdit: TSpTBXEdit
-            Left = 120
-            Top = 40
-            Width = 121
+          object ThemesComboBox: TSpTBXComboBox
+            Left = 48
+            Top = 144
+            Width = 177
             Height = 21
+            Style = csDropDownList
+            ItemHeight = 13
             TabOrder = 0
-            OnChange = UsernameEditChange
+            OnChange = ThemesComboBoxChange
           end
-          object PasswordEdit: TSpTBXEdit
-            Left = 120
-            Top = 72
-            Width = 121
-            Height = 21
+          object SpTBXRadioButton1: TSpTBXRadioButton
+            Left = 48
+            Top = 56
+            Width = 44
+            Height = 15
+            Caption = 'None'
             TabOrder = 1
-            OnChange = PasswordEditChange
-            PasswordCharW = '*'
+            TabStop = True
+            OnClick = SpTBXRadioButton1Click
+            Checked = True
           end
-          object LadderPasswordEdit: TSpTBXEdit
-            Left = 120
-            Top = 104
-            Width = 121
-            Height = 21
-            Enabled = False
-            TabOrder = 5
-            PasswordCharW = '*'
+          object SpTBXRadioButton2: TSpTBXRadioButton
+            Left = 48
+            Top = 72
+            Width = 62
+            Height = 15
+            Caption = 'Windows'
+            TabOrder = 2
+            OnClick = SpTBXRadioButton2Click
           end
-          object SpTBXLabel1: TSpTBXLabel
-            Left = 24
-            Top = 104
-            Width = 87
+          object Label3: TSpTBXLabel
+            Left = 32
+            Top = 120
+            Width = 85
             Height = 13
-            Caption = 'Ladder password :'
+            Caption = 'Choose TBX skin:'
             LinkFont.Charset = DEFAULT_CHARSET
             LinkFont.Color = clBlue
             LinkFont.Height = -11
             LinkFont.Name = 'MS Sans Serif'
             LinkFont.Style = [fsUnderline]
           end
-          object ChangeLadderPasswordButton: TSpTBXButton
-            Left = 248
-            Top = 104
-            Width = 41
-            Height = 21
-            Caption = 'Edit'
-            TabOrder = 7
-            OnClick = ChangeLadderPasswordButtonClick
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
+          object SpTBXRadioButton3: TSpTBXRadioButton
+            Left = 48
+            Top = 88
+            Width = 76
+            Height = 15
+            Caption = 'TBX themes'
+            TabOrder = 4
+            OnClick = SpTBXRadioButton3Click
           end
-          object RegisterLadderAccountButton: TSpTBXButton
-            Left = 56
-            Top = 192
-            Width = 185
-            Height = 25
-            Caption = 'Create new ladder account'
-            TabOrder = 8
-            OnClick = RegisterLadderAccountButtonClick
+          object Label11: TSpTBXLabel
+            Left = 32
+            Top = 32
+            Width = 60
+            Height = 13
+            Caption = 'Theme style:'
             LinkFont.Charset = DEFAULT_CHARSET
             LinkFont.Color = clBlue
             LinkFont.Height = -11
             LinkFont.Name = 'MS Sans Serif'
             LinkFont.Style = [fsUnderline]
           end
-          object RememberPasswordsCheckBox: TSpTBXCheckBox
-            Left = 120
-            Top = 128
-            Width = 117
-            Height = 15
-            Caption = 'remember passwords'
-            TabOrder = 9
-          end
         end
       end
       object SpTBXTabSheet3: TSpTBXTabSheet
@@ -206,6 +236,8 @@
         Height = 330
         Caption = 'Interface'
         ImageIndex = -1
+        Item = SpTBXTabItem3
+        TabControl = SpTBXTabControl1
         TabItem = 'SpTBXTabItem3'
         object GroupBox4: TSpTBXGroupBox
           Left = 16
@@ -359,282 +391,14 @@
             Caption = 'Load units icons and names when joining (slower)'
             TabOrder = 15
           end
-        end
-      end
-      object SpTBXTabSheet7: TSpTBXTabSheet
-        Left = 0
-        Top = 23
-        Width = 401
-        Height = 330
-        Caption = 'Scripts'
-        ImageIndex = -1
-        TabItem = 'SpTBXTabItem7'
-        object ScriptsDebugWindowBt: TSpTBXButton
-          Left = 132
-          Top = 56
-          Width = 137
-          Height = 25
-          Caption = 'Debug Window'
-          TabOrder = 0
-          OnClick = ScriptsDebugWindowBtClick
-          LinkFont.Charset = DEFAULT_CHARSET
-          LinkFont.Color = clBlue
-          LinkFont.Height = -11
-          LinkFont.Name = 'MS Sans Serif'
-          LinkFont.Style = [fsUnderline]
-        end
-        object ScriptsReloadBt: TSpTBXButton
-          Left = 132
-          Top = 88
-          Width = 137
-          Height = 25
-          Caption = 'Reload scripts'
-          TabOrder = 1
-          OnClick = ScriptsReloadBtClick
-          LinkFont.Charset = DEFAULT_CHARSET
-          LinkFont.Color = clBlue
-          LinkFont.Height = -11
-          LinkFont.Name = 'MS Sans Serif'
-          LinkFont.Style = [fsUnderline]
-        end
-        object ScriptsLoadNewBt: TSpTBXButton
-          Left = 132
-          Top = 120
-          Width = 137
-          Height = 25
-          Caption = 'Load new scripts'
-          TabOrder = 2
-          OnClick = ScriptsLoadNewBtClick
-          LinkFont.Charset = DEFAULT_CHARSET
-          LinkFont.Color = clBlue
-          LinkFont.Height = -11
-          LinkFont.Name = 'MS Sans Serif'
-          LinkFont.Style = [fsUnderline]
-        end
-        object ScriptsAdvancedOptionsBt: TSpTBXButton
-          Left = 132
-          Top = 152
-          Width = 137
-          Height = 25
-          Caption = 'Advanced options'
-          TabOrder = 3
-          Visible = False
-          OnClick = ScriptsAdvancedOptionsBtClick
-          LinkFont.Charset = DEFAULT_CHARSET
-          LinkFont.Color = clBlue
-          LinkFont.Height = -11
-          LinkFont.Name = 'MS Sans Serif'
-          LinkFont.Style = [fsUnderline]
-        end
-        object EnableScriptsCheckBox: TSpTBXCheckBox
-          Left = 104
-          Top = 24
-          Width = 193
-          Height = 15
-          Caption = 'Enable scripts BETA (requires restart)'
-          TabOrder = 4
-        end
-      end
-      object SpTBXTabSheet1: TSpTBXTabSheet
-        Left = 0
-        Top = 23
-        Width = 401
-        Height = 330
-        Caption = 'Skins'
-        ImageIndex = -1
-        TabItem = 'SpTBXTabItem1'
-        object GroupBox5: TSpTBXGroupBox
-          Left = 16
-          Top = 8
-          Width = 361
-          Height = 305
-          Caption = 'Skin manager'
-          Color = clNone
-          ParentColor = False
-          TabOrder = 0
-          object ThemesComboBox: TSpTBXComboBox
-            Left = 48
-            Top = 144
-            Width = 177
-            Height = 21
-            Style = csDropDownList
-            ItemHeight = 13
-            TabOrder = 0
-            OnChange = ThemesComboBoxChange
-          end
-          object SpTBXRadioButton1: TSpTBXRadioButton
-            Left = 48
-            Top = 56
-            Width = 44
-            Height = 15
-            Caption = 'None'
-            TabOrder = 1
-            TabStop = True
-            OnClick = SpTBXRadioButton1Click
-            Checked = True
-          end
-          object SpTBXRadioButton2: TSpTBXRadioButton
-            Left = 48
-            Top = 72
-            Width = 62
-            Height = 15
-            Caption = 'Windows'
-            TabOrder = 2
-            OnClick = SpTBXRadioButton2Click
-          end
-          object Label3: TSpTBXLabel
-            Left = 32
-            Top = 120
-            Width = 85
-            Height = 13
-            Caption = 'Choose TBX skin:'
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
-          object SpTBXRadioButton3: TSpTBXRadioButton
-            Left = 48
-            Top = 88
-            Width = 76
-            Height = 15
-            Caption = 'TBX themes'
-            TabOrder = 4
-            OnClick = SpTBXRadioButton3Click
-          end
-          object Label11: TSpTBXLabel
-            Left = 32
-            Top = 32
-            Width = 60
-            Height = 13
-            Caption = 'Theme style:'
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
-        end
-      end
-      object SpTBXTabSheet2: TSpTBXTabSheet
-        Left = 0
-        Top = 23
-        Width = 401
-        Height = 330
-        Caption = 'HTTP'
-        ImageIndex = -1
-        TabItem = 'SpTBXTabItem2'
-        object GroupBox6: TSpTBXGroupBox
-          Left = 16
-          Top = 8
-          Width = 369
-          Height = 305
-          Caption = 'Proxy settings'
-          Color = clNone
-          ParentColor = False
-          TabOrder = 0
-          object UseProxyCheckBox: TSpTBXCheckBox
+          object DisableNewsCheckBox: TSpTBXCheckBox
             Left = 24
-            Top = 32
-            Width = 65
+            Top = 264
+            Width = 159
             Height = 15
-            Caption = 'Use proxy'
-            TabOrder = 0
-            OnClick = UseProxyCheckBoxClick
-            Checked = True
-            State = cbChecked
+            Caption = 'Disable news (requires restart)'
+            TabOrder = 16
           end
-          object ProxyPanel: TSpTBXPanel
-            Left = 24
-            Top = 56
-            Width = 321
-            Height = 113
-            Caption = 'ProxyPanel'
-            Color = clNone
-            ParentColor = False
-            TabOrder = 1
-            object ProxyEdit: TSpTBXEdit
-              Left = 64
-              Top = 8
-              Width = 241
-              Height = 21
-              TabOrder = 0
-            end
-            object Label7: TSpTBXLabel
-              Left = 8
-              Top = 8
-              Width = 41
-              Height = 13
-              Caption = 'Address:'
-              LinkFont.Charset = DEFAULT_CHARSET
-              LinkFont.Color = clBlue
-              LinkFont.Height = -11
-              LinkFont.Name = 'MS Sans Serif'
-              LinkFont.Style = [fsUnderline]
-            end
-            object Label8: TSpTBXLabel
-              Left = 8
-              Top = 32
-              Width = 22
-              Height = 13
-              Caption = 'Port:'
-              LinkFont.Charset = DEFAULT_CHARSET
-              LinkFont.Color = clBlue
-              LinkFont.Height = -11
-              LinkFont.Name = 'MS Sans Serif'
-              LinkFont.Style = [fsUnderline]
-            end
-            object JvProxyPortEdit: TJvValidateEdit
-              Left = 64
-              Top = 32
-              Width = 49
-              Height = 21
-              Alignment = taLeftJustify
-              CriticalPoints.MaxValueIncluded = False
-              CriticalPoints.MinValueIncluded = False
-              EditText = '0'
-              TabOrder = 3
-            end
-            object ProxyUserEdit: TSpTBXEdit
-              Left = 64
-              Top = 56
-              Width = 121
-              Height = 21
-              TabOrder = 4
-            end
-            object Label9: TSpTBXLabel
-              Left = 8
-              Top = 56
-              Width = 51
-              Height = 13
-              Caption = 'Username:'
-              LinkFont.Charset = DEFAULT_CHARSET
-              LinkFont.Color = clBlue
-              LinkFont.Height = -11
-              LinkFont.Name = 'MS Sans Serif'
-              LinkFont.Style = [fsUnderline]
-            end
-            object Label10: TSpTBXLabel
-              Left = 8
-              Top = 80
-              Width = 49
-              Height = 13
-              Caption = 'Password:'
-              LinkFont.Charset = DEFAULT_CHARSET
-              LinkFont.Color = clBlue
-              LinkFont.Height = -11
-              LinkFont.Name = 'MS Sans Serif'
-              LinkFont.Style = [fsUnderline]
-            end
-            object ProxyPassEdit: TSpTBXEdit
-              Left = 64
-              Top = 80
-              Width = 121
-              Height = 21
-              TabOrder = 7
-            end
-          end
         end
       end
       object SpTBXTabSheet4: TSpTBXTabSheet
@@ -644,6 +408,8 @@
         Height = 330
         Caption = 'Program'
         ImageIndex = -1
+        Item = SpTBXTabItem4
+        TabControl = SpTBXTabControl1
         TabItem = 'SpTBXTabItem4'
         object GroupBox3: TSpTBXGroupBox
           Left = 16
@@ -876,6 +642,260 @@
           end
         end
       end
+      object SpTBXTabSheet5: TSpTBXTabSheet
+        Left = 0
+        Top = 23
+        Width = 401
+        Height = 330
+        Caption = 'Account'
+        ImageIndex = -1
+        Item = SpTBXTabItem5
+        TabControl = SpTBXTabControl1
+        TabItem = 'SpTBXTabItem5'
+        object GroupBox2: TSpTBXGroupBox
+          Left = 16
+          Top = 8
+          Width = 369
+          Height = 305
+          Caption = 'Account details'
+          Color = clNone
+          ParentColor = False
+          TabOrder = 0
+          object RegisterAccountButton: TSpTBXSpeedButton
+            Left = 56
+            Top = 160
+            Width = 185
+            Height = 25
+            Caption = 'Create new account'
+            OnClick = RegisterAccountButtonClick
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
+          end
+          object Label4: TSpTBXLabel
+            Left = 24
+            Top = 40
+            Width = 51
+            Height = 13
+            Caption = 'Username:'
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
+          end
+          object Label5: TSpTBXLabel
+            Left = 24
+            Top = 72
+            Width = 49
+            Height = 13
+            Caption = 'Password:'
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
+          end
+          object UsernameEdit: TSpTBXEdit
+            Left = 120
+            Top = 40
+            Width = 121
+            Height = 21
+            TabOrder = 0
+            OnChange = UsernameEditChange
+          end
+          object PasswordEdit: TSpTBXEdit
+            Left = 120
+            Top = 72
+            Width = 121
+            Height = 21
+            TabOrder = 1
+            OnChange = PasswordEditChange
+            PasswordCharW = '*'
+          end
+          object LadderPasswordEdit: TSpTBXEdit
+            Left = 120
+            Top = 104
+            Width = 121
+            Height = 21
+            Enabled = False
+            TabOrder = 5
+            PasswordCharW = '*'
+          end
+          object SpTBXLabel1: TSpTBXLabel
+            Left = 24
+            Top = 104
+            Width = 87
+            Height = 13
+            Caption = 'Ladder password :'
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
+          end
+          object ChangeLadderPasswordButton: TSpTBXButton
+            Left = 248
+            Top = 104
+            Width = 41
+            Height = 21
+            Caption = 'Edit'
+            TabOrder = 7
+            OnClick = ChangeLadderPasswordButtonClick
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
+          end
+          object RegisterLadderAccountButton: TSpTBXButton
+            Left = 56
+            Top = 192
+            Width = 185
+            Height = 25
+            Caption = 'Create new ladder account'
+            TabOrder = 8
+            OnClick = RegisterLadderAccountButtonClick
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
+          end
+          object RememberPasswordsCheckBox: TSpTBXCheckBox
+            Left = 120
+            Top = 128
+            Width = 117
+            Height = 15
+            Caption = 'remember passwords'
+            TabOrder = 9
+          end
+        end
+      end
+      object SpTBXTabSheet2: TSpTBXTabSheet
+        Left = 0
+        Top = 23
+        Width = 401
+        Height = 330
+        Caption = 'HTTP'
+        ImageIndex = -1
+        Item = SpTBXTabItem2
+        TabControl = SpTBXTabControl1
+        TabItem = 'SpTBXTabItem2'
+        object GroupBox6: TSpTBXGroupBox
+          Left = 16
+          Top = 8
+          Width = 369
+          Height = 305
+          Caption = 'Proxy settings'
+          Color = clNone
+          ParentColor = False
+          TabOrder = 0
+          object UseProxyCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 32
+            Width = 65
+            Height = 15
+            Caption = 'Use proxy'
+            TabOrder = 0
+            OnClick = UseProxyCheckBoxClick
+            Checked = True
+            State = cbChecked
+          end
+          object ProxyPanel: TSpTBXPanel
+            Left = 24
+            Top = 56
+            Width = 321
+            Height = 113
+            Caption = 'ProxyPanel'
+            Color = clNone
+            ParentColor = False
+            TabOrder = 1
+            object ProxyEdit: TSpTBXEdit
+              Left = 64
+              Top = 8
+              Width = 241
+              Height = 21
+              TabOrder = 0
+            end
+            object Label7: TSpTBXLabel
+              Left = 8
+              Top = 8
+              Width = 41
+              Height = 13
+              Caption = 'Address:'
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object Label8: TSpTBXLabel
+              Left = 8
+              Top = 32
+              Width = 22
+              Height = 13
+              Caption = 'Port:'
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object JvProxyPortEdit: TJvValidateEdit
+              Left = 64
+              Top = 32
+              Width = 49
+              Height = 21
+              Alignment = taLeftJustify
+              CriticalPoints.MaxValueIncluded = False
+              CriticalPoints.MinValueIncluded = False
+              EditText = '0'
+              TabOrder = 3
+            end
+            object ProxyUserEdit: TSpTBXEdit
+              Left = 64
+              Top = 56
+              Width = 121
+              Height = 21
+              TabOrder = 4
+            end
+            object Label9: TSpTBXLabel
+              Left = 8
+              Top = 56
+              Width = 51
+              Height = 13
+              Caption = 'Username:'
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object Label10: TSpTBXLabel
+              Left = 8
+              Top = 80
+              Width = 49
+              Height = 13
+              Caption = 'Password:'
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object ProxyPassEdit: TSpTBXEdit
+              Left = 64
+              Top = 80
+              Width = 121
+              Height = 21
+              TabOrder = 7
+            end
+          end
+        end
+      end
       object SpTBXTabSheet6: TSpTBXTabSheet
         Left = 0
         Top = 23
@@ -883,6 +903,8 @@
         Height = 330
         Caption = 'Server'
         ImageIndex = -1
+        Item = SpTBXTabItem6
+        TabControl = SpTBXTabControl1
         TabItem = 'SpTBXTabItem6'
         object GroupBox1: TSpTBXGroupBox
           Left = 16
@@ -990,7 +1012,7 @@
     end
     object ApplyAndCloseButton: TSpTBXButton
       Left = 43
-      Top = 392
+      Top = 424
       Width = 145
       Height = 25
       Caption = 'Apply and close'
@@ -1004,7 +1026,7 @@
     end
     object CancelAndCloseButton: TSpTBXButton
       Left = 227
-      Top = 392
+      Top = 424
       Width = 145
       Height = 25
       Caption = 'Cancel and close'
@@ -1017,6 +1039,27 @@
       LinkFont.Name = 'MS Sans Serif'
       LinkFont.Style = [fsUnderline]
     end
+    object LanguageCombobox: TSpTBXComboBox
+      Left = 272
+      Top = 40
+      Width = 137
+      Height = 21
+      Style = csDropDownList
+      ItemHeight = 13
+      TabOrder = 4
+    end
+    object SpTBXLabel2: TSpTBXLabel
+      Left = 208
+      Top = 42
+      Width = 54
+      Height = 13
+      Caption = 'Language :'
+      LinkFont.Charset = DEFAULT_CHARSET
+      LinkFont.Color = clBlue
+      LinkFont.Height = -11
+      LinkFont.Name = 'MS Sans Serif'
+      LinkFont.Style = [fsUnderline]
+    end
   end
   object AddressPopupMenu: TSpTBXPopupMenu
     Left = 372

Modified: Lobby/TASClient/PreferencesFormUnit.pas
===================================================================
--- Lobby/TASClient/PreferencesFormUnit.pas	2009-05-28 11:37:21 UTC (rev 7254)
+++ Lobby/TASClient/PreferencesFormUnit.pas	2009-05-28 21:16:55 UTC (rev 7255)
@@ -12,7 +12,7 @@
   JvSpeedbar, JvExExtCtrls, JvCaptionPanel, JvExComCtrls, JvComCtrls, JvButton,
   JvMovableBevel, TntStdCtrls, SpTBXEditors, TBXThemes, TBXDkPanels,
   SpTBXControls, SpTBXItem, TBX, SpTBXTabs, TB2Item, VirtualTrees, HttpProt,
-  RichEdit2, ExRichEdit, MainUnit,WSocket,TntComCtrls;
+  RichEdit2, ExRichEdit, MainUnit,WSocket,TntComCtrls, languagecodes;
 
 type
 
@@ -87,6 +87,9 @@
     EnableSpringDownloader: Boolean;
 
     UseLogonForm : boolean;
+    DisableNews: boolean;
+
+    LanguageCode: String;
   end;
 
   TPreferencesForm = class(TForm)
@@ -190,6 +193,9 @@
     UseLogonFormCheckBox: TSpTBXCheckBox;
     TipsButton: TSpTBXButton;
     SpringSettingsProfilesButton: TSpTBXButton;
+    DisableNewsCheckBox: TSpTBXCheckBox;
+    LanguageCombobox: TSpTBXComboBox;
+    SpTBXLabel2: TSpTBXLabel;
 
     function BattleSortStyleToColumn(SortStyle: Integer): Integer;
     function ColumnToBattleSortStyle(Column: Integer): Integer;
@@ -243,6 +249,8 @@
   private
     { Private declarations }
   public
+    LangCodes: TStringList;
+    
     procedure PopulateServerListMenu;
   end;
 
@@ -297,7 +305,7 @@
                                         UseProxy: False; HighlightColor: 'Green'; UseNotificationsForHighlights: True; UseIgnoreList: False; WarnIfUsingNATTraversing: True;
                                         AutoFocusOnPM: True; MapSortStyle: 1; ThemeType: thtTBX; Theme: 'Miranda'; DisableAllSounds: False; SortLocal: False;
                                         DisplayQuickJoinPanel : True; LimitChatLogs: False; ChatLogsLimit: 800; SPSkin: 'default.ssk'; ScriptsDisabled : False;
-                                        EnableScripts : True;ScriptWarningMsgShown: False; EnableSpringDownloader : True; UseLogonForm : True);
+                                        EnableScripts : True;ScriptWarningMsgShown: False; EnableSpringDownloader : True; UseLogonForm : True; DisableNews : False);
 
 var
   PreferencesForm: TPreferencesForm;
@@ -312,12 +320,13 @@
   ServerList: array of TServerListItem;
 
   // note: you shouldn't change order of sort styles or certain parts of code may not work anymore! (e.g.: when we receive MAPGRADES command, we sort map list only if sorting style is set to &quot;sort by global grade&quot;)
-  MapSortStyleDescriptions: array[0..4] of string = (
+  MapSortStyleDescriptions: array[0..5] of string = (
     'No sorting',
     'By name',
     'By map size',
     'By my grade',
-    'By global grade'
+    'By global grade',
+    'By average wind'
   );
 
 implementation
@@ -386,7 +395,8 @@
     try Preferences.DisableAllSounds := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'DisableAllSounds'); except end;
     try Preferences.SortLocal := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'SortLocal'); except end;
     try Preferences.UploadReplay := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'AskUploadReplay'); except end;
-    try Preferences.DisplayQuickJoinPanel := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'DisplayQuickJoinPanel'); except end;
+    try Preferences.DisplayQuickJoinPanel := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'DisplayQuickJoinPanelv2'); except end;
+    try Preferences.LanguageCode := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'LanguageCode'); except end;
     try
       Preferences.EnableScripts := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'ScriptsEnabled2');
       Preferences.ScriptsDisabled := not Preferences.EnableScripts;
@@ -398,6 +408,7 @@
       Preferences.ChatLogsLimit := max(ChatLogsLimitTracker.Min,min(ChatLogsLimitTracker.Max,Preferences.ChatLogsLimit));
     except end;
     try Preferences.SPSkin := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'SPTheme'); except end;
+    try Preferences.DisableNews := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'DisableNews'); except end;
 
 
     try CommonFont.Name := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'FontName'); except end;
@@ -459,7 +470,9 @@
     //try BattleForm.Panel6.Width := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'Splitter3'); except end;
     try BattleForm.KeepRatioItem.Checked := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'KeepMinimapRatio'); except end;
     try BattleForm.SpringSettingsProfile := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'SpringSettingsProfile'); except end;
+    try BattleForm.mnuAutoLockOnStart.Checked := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'AutoLockOnStart'); except end;
 
+
     {--&gt;} AllowBattleDetailsUpdate := False;
     //try BattleForm.StartPosRadioGroup.ItemIndex := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'StartPos'); except end;
     //try BattleForm.GameEndRadioGroup.ItemIndex := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'GameEnd'); except end;
@@ -573,6 +586,7 @@
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'Splitter3', rdInteger, BattleForm.Panel6.Width);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'KeepMinimapRatio', rdInteger, Misc.BoolToInt(BattleForm.KeepRatioItem.Checked));
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'SpringSettingsProfile', rdString, BattleForm.SpringSettingsProfile);
+    Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'AutoLockOnStart', rdInteger, Misc.BoolToInt(BattleForm.mnuAutoLockOnStart.Checked));
 
     //Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'StartPos', rdInteger, BattleForm.StartPosRadioGroup.ItemIndex);
     //Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'GameEnd', rdInteger, BattleForm.GameEndRadioGroup.ItemIndex);
@@ -690,12 +704,14 @@
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'AskUploadReplay', rdInteger, Preferences.UploadReplay);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'FontName', rdString, CommonFont.Name);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'FontSize', rdInteger, CommonFont.Size);
-    Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'DisplayQuickJoinPanel', rdInteger, Preferences.DisplayQuickJoinPanel);
+    Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'DisplayQuickJoinPanelv2', rdInteger, Preferences.DisplayQuickJoinPanel);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'ScriptsEnabled2', rdInteger, Preferences.EnableScripts);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'ScriptWarningMsgShown', rdInteger, Preferences.ScriptWarningMsgShown);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'LimitChatLogs', rdInteger, Preferences.LimitChatLogs);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'ChatLogsLimit', rdInteger, Preferences.ChatLogsLimit);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'SPTheme', rdString, Preferences.SPSkin);
+    Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'DisableNews', rdInteger, Preferences.DisableNews);
+    Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'LanguageCode', rdString, Preferences.LanguageCode);
 
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences\ChatColors', 'MyText', rdInteger, Colors.MyText);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences\ChatColors', 'AdminText', rdInteger, Colors.AdminText);
@@ -887,7 +903,13 @@
   p.ChatLogsLimit := ChatLogsLimitTracker.Position;
 
   p.EnableScripts := EnableScriptsCheckBox.Checked;
+  p.DisableNews := DisableNewsCheckBox.Checked;
 
+  try
+    p.LanguageCode := LangCodes[LanguageCombobox.ItemIndex];
+  except
+  end;
+
   // there is no need to set p.ThemeType or p.Theme here since those are directly updated to Preferences when we change them in GUI at runtime
 
   // update changes:
@@ -898,6 +920,8 @@
 
 { applies preferences from variable p to VCL controls (radio buttons, check boxes, etc.) }
 procedure TPreferencesForm.UpdatePreferencesFrom(p: TPreferences);
+var
+  i:integer;
 begin
   ServerAddressEdit.Text := p.ServerIP;
   ServerPortEdit.Text := p.ServerPort;
@@ -976,6 +1000,22 @@
   ChatLogsLimitTracker.Position := p.ChatLogsLimit;
   ChatLogsLimitTrackerChange(nil);
 
+  DisableNewsCheckBox.Checked := p.DisableNews;
+
+  UseLanguage(p.LanguageCode);
+  for i:=0 to LangCodes.Count-1 do
+  begin
+    if Pos(LangCodes[i],GetCurrentLanguage)&gt;0 then
+      LanguageCombobox.ItemIndex := i;
+  end;
+  for i:=0 to Screen.FormCount-1 do
+  begin
+    try
+      RetranslateComponent(Screen.Forms[i]);
+    except
+    end;
+  end;
+
   case p.ThemeType of
     thtNone: SpTBXRadioButton1.Checked := True;
     thtWindows: SpTBXRadioButton2.Checked := True;
@@ -1005,6 +1045,8 @@
 end;
 
 procedure TPreferencesForm.FormCreate(Sender: TObject);
+var
+  i:integer;
 begin
   TranslateComponent(self);
   
@@ -1020,7 +1062,7 @@
   ServerList[0].Port := '8200';
 
   ServerList[1].Name := _('Backup server #1 (springbackup1.servegame.com )');
-  ServerList[1].Address := 'springbackup1.servegame.com ';
+  ServerList[1].Address := 'springbackup1.servegame.com';
   ServerList[1].Port := '8200';
 
   ServerList[2].Name := _('Backup server #2 (springbackup2.servegame.org)');
@@ -1031,6 +1073,16 @@
   ServerList[3].Address := 'localhost';
   ServerList[3].Port := '8200';
 
+  LangCodes := TStringList.Create;
+  LangCodes.Clear;
+  LanguageCombobox.Items.Clear;
+  DefaultInstance.GetListOfLanguages ('default',LangCodes);
+  for i:=0 to LangCodes.Count-1 do
+  begin
+    LanguageCombobox.Items.Add(getlanguagename(LangCodes[i]));
+    if Pos(LangCodes[i],GetCurrentLanguage)&gt;0 then
+      LanguageCombobox.ItemIndex := i;
+  end;
 
   PopulateServerListMenu;
 
@@ -1617,4 +1669,5 @@
   SpringSettingsProfileForm.ShowModal;
 end;
 
+
 end.

Modified: Lobby/TASClient/PythonScriptDebugFormUnit.pas
===================================================================
--- Lobby/TASClient/PythonScriptDebugFormUnit.pas	2009-05-28 11:37:21 UTC (rev 7254)
+++ Lobby/TASClient/PythonScriptDebugFormUnit.pas	2009-05-28 21:16:55 UTC (rev 7255)
@@ -69,12 +69,23 @@
 procedure TPythonScriptDebugForm.FormCreate(Sender: TObject);
 var
   s: string;
+  FileName: string;
+  fh: integer;
 begin
   TranslateComponent(self);
+
+  FileName := ExtractFilePath(Application.ExeName)+'TASClient_Scripts_Err.txt';
   
   printList := TStringList.Create;
   try
-    debugOutput := TFileStream.Create(ExtractFilePath(Application.ExeName)+'TASClient_script_log.txt',fmCreate or fmOpenReadWrite or fmShareDenyNone);
+    if not FileExists(FileName) then
+    begin
+      fh := FileCreate(FileName);
+      if fh = -1 then Exit;
+      FileClose(fh);
+    end;
+
+    debugOutput := TFileStream.Create(FileName,fmOpenReadWrite or fmShareDenyNone);
     debugOutput.Position := debugOutput.Size;
     MainForm.TryToAddLog(debugOutput,EOL+'--------------------');
     MainForm.TryToAddLog(debugOutput,DateToStr(Date)+' - '+TimeToStr(Time));

Modified: Lobby/TASClient/ReplaysUnit.dfm
===================================================================
--- Lobby/TASClient/ReplaysUnit.dfm	2009-05-28 11:37:21 UTC (rev 7254)
+++ Lobby/TASClient/ReplaysUnit.dfm	2009-05-28 21:16:55 UTC (rev 7255)
@@ -1,12 +1,12 @@
 object ReplaysForm: TReplaysForm
-  Left = 764
-  Top = 351
-  Width = 809
-  Height = 640
+  Left = 330
+  Top = 110
+  Width = 790
+  Height = 599
   Caption = 'Replays'
   Color = clBtnFace
-  Constraints.MaxHeight = 1000
-  Constraints.MaxWidth = 1680
+  Constraints.MaxHeight = 750
+  Constraints.MaxWidth = 1280
   Constraints.MinHeight = 100
   Constraints.MinWidth = 100
   Font.Charset = DEFAULT_CHARSET
@@ -23,18 +23,18 @@
   object SpTBXTitleBar1: TSpTBXTitleBar
     Left = 0
     Top = 0
-    Width = 801
-    Height = 613
+    Width = 782
+    Height = 572
     Caption = 'Replays'
     TBXStyleBackground = True
     DesignSize = (
-      801
-      613)
+      782
+      572)
     object VDTReplays: TVirtualDrawTree
       Left = 4
       Top = 270
-      Width = 793
-      Height = 98
+      Width = 774
+      Height = 57
       Align = alClient
       BevelInner = bvNone
       BevelOuter = bvNone
@@ -56,7 +56,7 @@
       TabOrder = 0
       TreeOptions.AutoOptions = [toAutoDropExpand, toAutoScrollOnExpand, toAutoSort, toAutoTristateTracking, toAutoDeleteMovedNodes]
       TreeOptions.MiscOptions = [toAcceptOLEDrop, toCheckSupport, toFullRepaintOnResize, toInitOnSave, toToggleOnDblClick, toWheelPanning]
-      TreeOptions.PaintOptions = [toHideFocusRect, toShowButtons, toShowDropmark, toThemeAware, toUseBlendedImages]
+      TreeOptions.PaintOptions = [toHideFocusRect, toShowButtons, toShowDropmark, toShowVertGridLines, toThemeAware, toUseBlendedImages, toFullVertGridLines]
       TreeOptions.SelectionOptions = [toFullRowSelect]
       OnClick = VDTReplaysClick
       OnColumnDblClick = VDTReplaysColumnDblClick
@@ -121,15 +121,15 @@
     end
     object BottomPanel: TPanel
       Left = 4
-      Top = 378
-      Width = 793
+      Top = 337
+      Width = 774
       Height = 231
       Align = alBottom
       BevelOuter = bvNone
       Constraints.MinHeight = 231
       TabOrder = 3
       DesignSize = (
-        793
+        774
         231)
       object SpTBXLabel1: TSpTBXLabel
         Left = 0
@@ -169,37 +169,39 @@
       object PageControl1: TSpTBXTabControl
         Left = 104
         Top = 0
-        Width = 686
+        Width = 667
         Height = 193
         Anchors = [akLeft, akTop, akRight, akBottom]
         Color = clBtnFace
-        ActiveTabIndex = 3
+        ActiveTabIndex = 1
         HiddenItems = &lt;&gt;
         object PlayersTab: TSpTBXTabItem
           Caption = 'Players'
         end
         object SpTBXTabItem3: TSpTBXTabItem
           Caption = 'Game settings'
+          Checked = True
         end
         object CommentsTab: TSpTBXTabItem
           Caption = 'Comments'
         end
         object SpTBXTabItem1: TSpTBXTabItem
           Caption = 'Script'
-          Checked = True
         end
         object SpTBXTabSheet2: TSpTBXTabSheet
           Left = 0
           Top = 23
-          Width = 686
+          Width = 667
           Height = 170
           Caption = 'Comments'
           ImageIndex = -1
+          Item = CommentsTab
+          TabControl = PageControl1
           TabItem = 'CommentsTab'
           object CommentsRichEdit: TRichEdit
             Left = 2
             Top = 0
-            Width = 682
+            Width = 663
             Height = 168
             Align = alClient
             ScrollBars = ssBoth
@@ -208,15 +210,119 @@
             OnChange = CommentsRichEditChange
           end
         end
+        object SpTBXTabSheet3: TSpTBXTabSheet
+          Left = 0
+          Top = 23
+          Width = 667
+          Height = 170
+          Caption = 'Players'
+          ImageIndex = -1
+          Item = PlayersTab
+          TabControl = PageControl1
+          TabItem = 'PlayersTab'
+          object VDTPlayers: TVirtualDrawTree
+            Left = 2
+            Top = 0
+            Width = 663
+            Height = 168
+            Align = alClient
+            Header.AutoSizeIndex = 7
+            Header.Font.Charset = DEFAULT_CHARSET
+            Header.Font.Color = clWindowText
+            Header.Font.Height = -11
+            Header.Font.Name = 'MS Sans Serif'
+            Header.Font.Style = []
+            Header.Options = [hoAutoResize, hoColumnResize, hoDrag, hoShowHint, hoShowSortGlyphs, hoVisible]
+            Header.SortColumn = 2
+            Header.Style = hsFlatButtons
+            ParentShowHint = False
+            ShowHint = True
+            TabOrder = 0
+            TreeOptions.AutoOptions = [toAutoDropExpand, toAutoScrollOnExpand, toAutoSort, toAutoTristateTracking, toAutoDeleteMovedNodes]
+            TreeOptions.MiscOptions = [toAcceptOLEDrop, toCheckSupport, toFullRepaintOnResize, toInitOnSave, toToggleOnDblClick, toWheelPanning]
+            TreeOptions.PaintOptions = [toShowButtons, toShowDropmark, toThemeAware, toUseBlendedImages]
+            TreeOptions.SelectionOptions = [toFullRowSelect]
+            OnCompareNodes = VDTPlayersCompareNodes
+            OnDrawNode = VDTPlayersDrawNode
+            OnHeaderClick = VDTPlayersHeaderClick
+            Columns = &lt;
+              item
+                Position = 0
+                Width = 200
+                WideText = 'Player'
+              end
+              item
+                Position = 1
+                WideText = 'Id'
+              end
+              item
+                Position = 2
+                Width = 60
+                WideText = 'Team'
+              end
+              item
+                Position = 3
+                Width = 60
+                WideText = 'MP/M'
+                WideHint = 'Mouse movement in pixel per minute'
+              end
+              item
+                Position = 4
+                WideText = 'MC/M'
+                WideHint = 'Mouse clicks per minute'
+              end
+              item
+                Position = 5
+                WideText = 'KP/M'
+                WideHint = 'Keyboard presses per minute'
+              end
+              item
+                Position = 6
+                Width = 60
+                WideText = 'Cmds/M'
+                WideHint = 'Commands per minute'
+              end
+              item
+                Position = 7
+                Width = 129
+                WideText = 'ACS'
+                WideHint = 'Averange commands size (units affected per command)'
+              end&gt;
+          end
+        end
+        object SpTBXTabSheet1: TSpTBXTabSheet
+          Left = 0
+          Top = 23
+          Width = 667
+          Height = 170
+          Caption = 'Script'
+          ImageIndex = -1
+          Item = SpTBXTabItem1
+          TabControl = PageControl1
+          TabItem = 'SpTBXTabItem1'
+          object ScriptRichEdit: TRichEdit
+            Left = 2
+            Top = 0
+            Width = 663
+            Height = 168
+            Align = alClient
+            ReadOnly = True
+            ScrollBars = ssBoth
+            TabOrder = 0
+            WordWrap = False
+          end
+        end
         object SpTBXTabSheet4: TSpTBXTabSheet
           Left = 0
           Top = 23
-          Width = 686
+          Width = 667
           Height = 170
           Caption = 'Game settings'
           ImageIndex = -1
+          Item = SpTBXTabItem3
+          TabControl = PageControl1
           DesignSize = (
-            686
+            667
             170)
           TabItem = 'SpTBXTabItem3'
           object frmGameOptions: TSpTBXGroupBox
@@ -377,7 +483,7 @@
           object SpTBXGroupBox1: TSpTBXGroupBox
             Left = 472
             Top = 8
-            Width = 202
+            Width = 183
             Height = 153
             Caption = 'Map/Mod options'
             Anchors = [akLeft, akTop, akRight, akBottom]
@@ -385,7 +491,7 @@
             object lstLuaOptions: TSpTBXListBox
               Left = 3
               Top = 16
-              Width = 196
+              Width = 177
               Height = 134
               Align = alClient
               BorderStyle = bsNone
@@ -395,107 +501,9 @@
             end
           end
         end
-        object SpTBXTabSheet3: TSpTBXTabSheet
-          Left = 0
-          Top = 23
-          Width = 686
-          Height = 170
-          Caption = 'Players'
-          ImageIndex = -1
-          TabItem = 'PlayersTab'
-          object VDTPlayers: TVirtualDrawTree
-            Left = 2
-            Top = 0
-            Width = 682
-            Height = 168
-            Align = alClient
-            Header.AutoSizeIndex = 7
-            Header.Font.Charset = DEFAULT_CHARSET
-            Header.Font.Color = clWindowText
-            Header.Font.Height = -11
-            Header.Font.Name = 'MS Sans Serif'
-            Header.Font.Style = []
-            Header.Options = [hoAutoResize, hoColumnResize, hoDrag, hoShowHint, hoShowSortGlyphs, hoVisible]
-            Header.SortColumn = 2
-            Header.Style = hsFlatButtons
-            ParentShowHint = False
-            ShowHint = True
-            TabOrder = 0
-            TreeOptions.AutoOptions = [toAutoDropExpand, toAutoScrollOnExpand, toAutoSort, toAutoTristateTracking, toAutoDeleteMovedNodes]
-            TreeOptions.MiscOptions = [toAcceptOLEDrop, toCheckSupport, toFullRepaintOnResize, toInitOnSave, toToggleOnDblClick, toWheelPanning]
-            TreeOptions.PaintOptions = [toShowButtons, toShowDropmark, toThemeAware, toUseBlendedImages]
-            TreeOptions.SelectionOptions = [toFullRowSelect]
-            OnCompareNodes = VDTPlayersCompareNodes
-            OnDrawNode = VDTPlayersDrawNode
-            OnHeaderClick = VDTPlayersHeaderClick
-            Columns = &lt;
-              item
-                Position = 0
-                Width = 200
-                WideText = 'Player'
-              end
-              item
-                Position = 1
-                WideText = 'Id'
-              end
-              item
-                Position = 2
-                Width = 60
-                WideText = 'Team'
-              end
-              item
-                Position = 3
-                Width = 60
-                WideText = 'MP/M'
-                WideHint = 'Mouse movement in pixel per minute'
-              end
-              item
-                Position = 4
-                WideText = 'MC/M'
-                WideHint = 'Mouse clicks per minute'
-              end
-              item
-                Position = 5
-                WideText = 'KP/M'
-                WideHint = 'Keyboard presses per minute'
-              end
-              item
-                Position = 6
-                Width = 60
-                WideText = 'Cmds/M'
-                WideHint = 'Commands per minute'
-              end
-              item
-                Position = 7
-                Width = 148
-                WideText = 'ACS'
-                WideHint = 'Averange commands size (units affected per command)'
-              end&gt;
-          end
-        end
-        object SpTBXTabSheet1: TSpTBXTabSheet
-          Left = 0
-          Top = 23
-          Width = 686
-          Height = 170
-          Caption = 'Script'
-          ImageIndex = -1
-          TabItem = 'SpTBXTabItem1'
-          object ScriptRichEdit: TRichEdit
-            Left = 2
-            Top = 0
-            Width = 682
-            Height = 168
-            Align = alClient
-            ReadOnly = True
-            ScrollBars = ssBoth
-            TabOrder = 0
-            WordWrap = False
-          end
-        end
       end
       object HostReplayButton: TSpTBXButton
-        Left = 635
+        Left = 616
         Top = 200
         Width = 75
         Height = 25
@@ -511,7 +519,7 @@
         LinkFont.Style = [fsUnderline]
       end
       object WatchButton: TSpTBXButton
-        Left = 627
+        Left = 608
         Top = 200
         Width = 75
         Height = 25
@@ -526,7 +534,7 @@
         LinkFont.Style = [fsUnderline]
       end
       object CloseButton: TSpTBXButton
-        Left = 715
+        Left = 696
         Top = 200
         Width = 75
         Height = 25
@@ -643,8 +651,8 @@
     end
     object SpTBXSplitter1: TSpTBXSplitter
       Left = 4
-      Top = 368
-      Width = 793
+      Top = 327
+      Width = 774
       Height = 10
       Cursor = crSizeNS
       Caption = 'SpTBXSplitter1'
@@ -653,18 +661,18 @@
     object PanelTop: TPanel
       Left = 4
       Top = 30
-      Width = 793
+      Width = 774
       Height = 240
       Align = alTop
       BevelOuter = bvNone
       TabOrder = 5
       DesignSize = (
-        793
+        774
         240)
       object FiltersButton: TSpTBXButton
         Left = 0
         Top = 228
-        Width = 793
+        Width = 774
         Height = 12
         Align = alBottom
         TabOrder = 0
@@ -680,7 +688,7 @@
       object FiltersTabs: TSpTBXTabControl
         Left = 0
         Top = 0
-        Width = 793
+        Width = 774
         Height = 225
         Align = alTop
         Color = clBtnFace
@@ -696,12 +704,14 @@
         object SpTBXTabSheet6: TSpTBXTabSheet
           Left = 0
           Top = 23
-          Width = 793
+          Width = 774
           Height = 202
           Caption = 'Presets'
           ImageIndex = -1
+          Item = PresetsTab
+          TabControl = FiltersTabs
           DesignSize = (
-            793
+            774
             202)
           TabItem = 'PresetsTab'
           object SpTBXGroupBox2: TSpTBXGroupBox
@@ -783,7 +793,7 @@
           object PresetListbox: TSpTBXListBox
             Left = 152
             Top = 26
-            Width = 633
+            Width = 614
             Height = 167
             Anchors = [akLeft, akTop, akRight]
             ItemHeight = 16
@@ -796,10 +806,12 @@
         object SpTBXTabSheet5: TSpTBXTabSheet
           Left = 0
           Top = 23
-          Width = 793
+          Width = 774
           Height = 202
           Caption = 'Filters'
           ImageIndex = -1
+          Item = FiltersTab
+          TabControl = FiltersTabs
           TabItem = 'FiltersTab'
           object SpTBXGroupBox4: TSpTBXGroupBox
             Left = 8
@@ -1211,9 +1223,7 @@
               Height = 19
               Style = csOwnerDrawFixed
               ItemHeight = 13
-              ItemIndex = 1
               TabOrder = 0
-              Text = 'Map'
               Items.Strings = (
                 'Host'
                 'Map'
@@ -1221,7 +1231,8 @@
                 'Disabled units'
                 'Spring Version'
                 'File Name'
-                'Players')
+                'Players'
+                'Map/Mod option')
             end
             object ContainsRadio: TSpTBXRadioButton
               Left = 15
@@ -1246,6 +1257,11 @@
               Top = 72
               Width = 105
               Height = 21
+              Hint = 
+                'For map/mod option type '#39'key=value'#39' or just '#39'key'#39' or just '#39'value' +
+                #39
+              ParentShowHint = False
+              ShowHint = True
               TabOrder = 3
             end
             object AddToFilterListButton: TSpTBXButton
@@ -1294,7 +1310,7 @@
           object FilterList: TVirtualStringTree
             Left = 601
             Top = 8
-            Width = 184
+            Width = 165
             Height = 185
             Align = alCustom
             Anchors = [akLeft, akTop, akRight]
@@ -1342,14 +1358,14 @@
               end
               item
                 Position = 3
-                Width = 17
+                Width = 10
                 WideText = 'Value'
               end&gt;
           end
         end
       end
       object chkEnableFilters: TSpTBXCheckBox
-        Left = 680
+        Left = 661
         Top = 2
         Width = 110
         Height = 18
@@ -1368,8 +1384,8 @@
     object LoadingPanel: TSpTBXPanel
       Left = 176
       Top = 286
-      Width = 233
-      Height = 75
+      Width = 214
+      Height = 34
       Anchors = [akLeft, akTop, akRight, akBottom]
       Color = clNone
       Font.Charset = DEFAULT_CHARSET

Modified: Lobby/TASClient/ReplaysUnit.pas
===================================================================
--- Lobby/TASClient/ReplaysUnit.pas	2009-05-28 11:37:21 UTC (rev 7254)
+++ Lobby/TASClient/ReplaysUnit.pas	2009-05-28 21:16:55 UTC (rev 7255)
@@ -1638,6 +1638,7 @@
 var
   i,j,k:integer;
   tmpStr: String;
+  sl: TStrings;
 begin
   if not chkEnableFilters.Checked then
   begin
@@ -1662,6 +1663,15 @@
           tmpStr := Replay.SpringVersion
         else if filterType = FileName then
           tmpStr := Replay.FileName
+        else if filterType = MapModOption then
+        begin
+          sl := Replay.Script.GetSubKeys('GAME/modoptions');
+          for j:=0 to sl.Count-1 do
+            tmpStr := tmpStr + ' ' + sl[j]+'='+Replay.Script.ReadKeyValue('GAME/modoptions/'+sl[j]);
+          sl := Replay.Script.GetSubKeys('GAME/mapoptions');
+          for j:=0 to sl.Count-1 do
+            tmpStr := tmpStr + ' ' + sl[j]+'='+Replay.Script.ReadKeyValue('GAME/mapoptions/'+sl[j]);
+        end
         else if filterType = Players then
           for k:=0 to Replay.PlayerList.Count-1 do
             tmpStr := tmpStr + TReplayPlayer(Replay.PlayerList[k]^).UserName + ' '
@@ -1909,7 +1919,9 @@
     else if tmpStr = 'FileName' then
       TFilterText(f^).filterType := FileName
     else if tmpStr = 'Players' then
-      TFilterText(f^).filterType := Players;
+      TFilterText(f^).filterType := Players
+    else if tmpStr = 'MapModOption' then
+      TFilterText(f^).filterType := MapModOption;
 
     TFilterText(f^).value := Ini.ReadString('TextFilter'+IntToStr(i),'Value','');
     TFilterText(f^).contains := Ini.ReadBool('TextFilter'+IntToStr(i),'Contains',True);
@@ -2117,7 +2129,9 @@
         else if filterType = FileName then
           Ini.WriteString('TextFilter'+IntToStr(i), 'Type', 'FileName')
         else if filterType = Players then
-          Ini.WriteString('TextFilter'+IntToStr(i), 'Type', 'Players');
+          Ini.WriteString('TextFilter'+IntToStr(i), 'Type', 'Players')
+        else if filterType = MapModOption then
+          Ini.WriteString('TextFilter'+IntToStr(i), 'Type', 'MapModOption');
 
         Ini.WriteBool('TextFilter'+IntToStr(i), 'Contains', contains);
         Ini.WriteString('TextFilter'+IntToStr(i), 'Value', value);
@@ -2157,7 +2171,9 @@
       else if filter.filterType = FileName then
         CellText := 'File Name'
       else if filter.filterType = Players then
-        CellText := 'Players';
+        CellText := 'Players'
+      else if filter.filterType = MapModOption then
+        CellText := 'Map/Mod option';
     2:
       if filter.contains then
         CellText := 'with'
@@ -2579,6 +2595,7 @@
     4:f^.filterType := SpringVersion;
     5:f^.filterType := FileName;
     6:f^.filterType := Players;
+    7:f^.filterType := MapModOption;
   end;
   f^.node := nil;
   f^.contains := ContainsRadio.Checked;
@@ -2845,7 +2862,7 @@
           Font.Style := [];
           TextOut(120, 10+TextHeight(MapName), 'Map size: '+IntToStr(MapInfo.Width div 64)+'x'+IntToStr(MapInfo.Height div 64));
           TextOut(120, 10+TextHeight(MapName)*2, 'Max. metal: '+FloatToStr(RoundTo(MapInfo.MaxMetal,-3)));
-          TextOut(120, 10+TextHeight(MapName)*3, 'Wind (min/max): '+IntToStr(MapInfo.MinWind)+'-'+IntToStr(MapInfo.MaxWind));
+          TextOut(120, 10+TextHeight(MapName)*3, 'Wind (min/max/avg): '+IntToStr(MapInfo.MinWind)+'-'+IntToStr(MapInfo.MaxWind)+ '-' + IntToStr(Floor((MapInfo.MaxWind+MapInfo.MinWind)/2)));
           DrawMultilineText(MapInfo.Description,HintCanvas,Rect(120,10+10+TextHeight(MapName)*4,R.Right-10,R.Bottom-5),alHLeft,alVTop,JustLeft,true);
         end;
       end;

Modified: Lobby/TASClient/SpringDownloaderFormUnit.dfm
===================================================================
--- Lobby/TASClient/SpringDownloaderFormUnit.dfm	2009-05-28 11:37:21 UTC (rev 7254)
+++ Lobby/TASClient/SpringDownloaderFormUnit.dfm	2009-05-28 21:16:55 UTC (rev 7255)
@@ -1,13 +1,13 @@
 object SpringDownloaderForm: TSpringDownloaderForm
-  Left = 299
-  Top = 241
+  Left = 360
+  Top = 374
   BorderStyle = bsDialog
   Caption = 'Downloading ...'
   ClientHeight = 174
-  ClientWidth = 375
+  ClientWidth = 455
   Color = clBtnFace
-  Constraints.MaxHeight = 1000
-  Constraints.MaxWidth = 1680
+  Constraints.MaxHeight = 750
+  Constraints.MaxWidth = 1280
   Font.Charset = DEFAULT_CHARSET
   Font.Color = clWindowText
   Font.Height = -11
@@ -22,17 +22,21 @@
   object SpTBXTitleBar1: TSpTBXTitleBar
     Left = 0
     Top = 0
-    Width = 375
+    Width = 455
     Height = 174
     Caption = 'Downloading ...'
     FixedSize = True
     Options.Maximize = False
+    DesignSize = (
+      455
+      174)
     object ProgressBar: TSpTBXProgressBar
       Left = 16
       Top = 64
-      Width = 345
+      Width = 425
       Height = 25
       Caption = '0%'
+      Anchors = [akLeft, akTop, akRight]
       Font.Charset = DEFAULT_CHARSET
       Font.Color = clWindowText
       Font.Height = -11
@@ -44,11 +48,12 @@
       Smooth = True
     end
     object CancelButton: TSpTBXButton
-      Left = 272
+      Left = 352
       Top = 136
       Width = 89
       Height = 25
       Caption = 'Cancel'
+      Anchors = [akTop, akRight]
       TabOrder = 2
       OnClick = CancelButtonClick
       LinkFont.Charset = DEFAULT_CHARSET
@@ -95,11 +100,12 @@
       LinkFont.Style = [fsUnderline]
     end
     object DetailsButton: TSpTBXButton
-      Left = 272
+      Left = 352
       Top = 96
       Width = 89
       Height = 33
       Caption = 'Show details'
+      Anchors = [akTop, akRight]
       TabOrder = 6
       OnClick = DetailsButtonClick
       LinkFont.Charset = DEFAULT_CHARSET

Modified: Lobby/TASClient/SpringDownloaderFormUnit.pas
===================================================================
--- Lobby/TASClient/SpringDownloaderFormUnit.pas	2009-05-28 11:37:21 UTC (rev 7254)
+++ Lobby/TASClient/SpringDownloaderFormUnit.pas	2009-05-28 21:16:55 UTC (rev 7255)
@@ -56,7 +56,8 @@
 
 implementation
 
-uses BattleFormUnit,PreferencesFormUnit, MainUnit, StrUtils, Misc, ComObj, gnugettext;
+uses  BattleFormUnit,PreferencesFormUnit, MainUnit, StrUtils, Misc, ComObj, gnugettext,
+      LobbyScriptUnit;
 
 {$R *.dfm}
 
@@ -125,7 +126,10 @@
     Exit;
   Application.CreateForm(TSpringDownloaderForm, newDownloadForm);
   newDownloadForm.StartDownload('MOD',modHash,modName,joinBattleWhenDownloadComplete);
-  newDownloadForm.Show;
+  AcquireMainThread;
+  try if not Preferences.ScriptsDisabled then handlers.onDownloadModStart(LobbyScriptUnit.GetStringFromComponent(newDownloadForm),modHash,modName); except end;
+  ReleaseMainThread;
+  Misc.ShowAndSetFocus(newDownloadForm.DetailsButton);
 end;
 
 procedure DownloadMap(mapHash : integer; mapName: string; noBrowser : boolean = False);
@@ -145,7 +149,10 @@
     Exit;
   Application.CreateForm(TSpringDownloaderForm, newDownloadForm);
   newDownloadForm.StartDownload('MAP',mapHash,mapName);
-  newDownloadForm.Show;
+  AcquireMainThread;
+  try if not Preferences.ScriptsDisabled then handlers.onDownloadMapStart(LobbyScriptUnit.GetStringFromComponent(newDownloadForm),mapHash,mapName); except end;
+  ReleaseMainThread;
+  Misc.ShowAndSetFocus(newDownloadForm.DetailsButton);
 end;
 
 procedure TSpringDownloaderForm.tmrProgressTimer(Sender: TObject);

Modified: Lobby/TASClient/SpringSettingsProfileFormUnit.dfm
===================================================================
--- Lobby/TASClient/SpringSettingsProfileFormUnit.dfm	2009-05-28 11:37:21 UTC (rev 7254)
+++ Lobby/TASClient/SpringSettingsProfileFormUnit.dfm	2009-05-28 21:16:55 UTC (rev 7255)
@@ -1,13 +1,13 @@
 object SpringSettingsProfileForm: TSpringSettingsProfileForm
-  Left = 668
-  Top = 394
+  Left = 581
+  Top = 190
   BorderStyle = bsSingle
   Caption = 'Spring settings profiles'
   ClientHeight = 385
   ClientWidth = 398
   Color = clBtnFace
-  Constraints.MaxHeight = 1000
-  Constraints.MaxWidth = 1680
+  Constraints.MaxHeight = 750
+  Constraints.MaxWidth = 1280
   Font.Charset = DEFAULT_CHARSET
   Font.Color = clWindowText
   Font.Height = -11

Modified: Lobby/TASClient/SpringSettingsProfileFormUnit.pas
===================================================================
--- Lobby/TASClient/SpringSettingsProfileFormUnit.pas	2009-05-28 11:37:21 UTC (rev 7254)
+++ Lobby/TASClient/SpringSettingsProfileFormUnit.pas	2009-05-28 21:16:55 UTC (rev 7255)
@@ -59,6 +59,8 @@
 
   cpNames := TStringList.Create;
   cpFiles := TStringList.Create;
+
+  SpringSettingsProfileForm.LoadProfiles;
 end;
 
 procedure TSpringSettingsProfileForm.bePlayingSubEditButton0Click(

Modified: Lobby/TASClient/TASClient.dof
===================================================================
--- Lobby/TASClient/TASClient.dof	2009-05-28 11:37:21 UTC (rev 7254)
+++ Lobby/TASClient/TASClient.dof	2009-05-28 21:16:55 UTC (rev 7255)
@@ -100,7 +100,7 @@
 DebugSourceDirs=
 UsePackages=0
 [Parameters]
-RunParams=
+RunParams=-menu
 HostApplication=C:\Program Files\Spring\TASClient.exe
 Launcher=
 UseLauncher=0
@@ -113,9 +113,9 @@
 IncludeVerInfo=1
 AutoIncBuild=1
 MajorVer=0
-MinorVer=3
+MinorVer=47
 Release=0
-Build=586
+Build=594
 Debug=0
 PreRelease=0
 Special=0
@@ -125,8 +125,8 @@
 CodePage=1252
 [Version Info Keys]
 CompanyName=
-FileDescription=TA Spring lobby client
-FileVersion=0.3.0.586
+FileDescription=Spring RTS Engine lobby client
+FileVersion=0.47.0.594
 InternalName=
 LegalCopyright=
 LegalTrademarks=
@@ -134,15 +134,14 @@
 ProductName=TASClient
 ProductVersion=1.0.0.0
 Comments=
-[Excluded Packages]
-c:\program files\borland\delphi7\Projects\Bpl\pack.bpl=(untitled)
 [HistoryLists\hlUnitAliases]
 Count=1
 Item0=WinTypes=Windows;WinProcs=Windows;DbiTypes=BDE;DbiProcs=BDE;DbiErrs=BDE;
 [HistoryLists\hlSearchPath]
-Count=2
+Count=3
 Item0=hics32-1_5_1
-Item1=E:\Tools\Developpement\spring_0.74b3_src\SVN\LobbyComponents\graphics32-1_5_1
+Item1=$(DELPHI)\Lib\Debug;C:\Tools\DEVELO~1\TASCLI~1\01_JCL\lib\d7\debug;hics32-1_5_1
+Item2=E:\Tools\Developpement\spring_0.74b3_src\SVN\LobbyComponents\graphics32-1_5_1
 [HistoryLists\hlUnitOutputDirectory]
 Count=1
 Item0=C:\Program Files\TASpring

Modified: Lobby/TASClient/TASClient.dpr
===================================================================
--- Lobby/TASClient/TASClient.dpr	2009-05-28 11:37:21 UTC (rev 7254)
+++ Lobby/TASClient/TASClient.dpr	2009-05-28 21:16:55 UTC (rev 7255)
@@ -113,13 +113,14 @@
   SpringDownloaderFormUnit in 'SpringDownloaderFormUnit.pas' {SpringDownloaderForm},
   LogonFormUnit in 'LogonFormUnit.pas' {LogonForm},
   MapSelectionFormUnit in 'MapSelectionFormUnit.pas' {MapSelectionForm},
-  OKCANCL1 in 'C:\Program Files\Borland\Delphi7\ObjRepos\OKCANCL1.pas' {OKBottomDlg},
+  OKCANCL1 in '..\..\..\Program Files\Borland\Delphi7\ObjRepos\OKCANCL1.pas' {OKBottomDlg},
   TipsFormUnit in 'TipsFormUnit.pas' {TipsForm},
   CustomizeGUIFormUnit in 'CustomizeGUIFormUnit.pas' {CustomizeGUIForm},
   SetValuesFormUnit in 'SetValuesFormUnit.pas' {SetValuesForm},
   TemplateEditorFormUnit in 'TemplateEditorFormUnit.pas' {TemplateEditorForm},
   SpringSettingsProfileFormUnit in 'SpringSettingsProfileFormUnit.pas' {SpringSettingsProfileForm},
-  gnugettext in 'C:\Program Files\dxgettext\gnugettext.pas';
+  gnugettext in '..\..\..\Program Files\dxgettext\gnugettext.pas',
+  AutoJoinFormUnit in 'AutoJoinFormUnit.pas' {AutoJoinForm};
 
 var
   i: Integer;
@@ -235,6 +236,7 @@
   Application.CreateForm(TSetValuesForm, SetValuesForm);
   Application.CreateForm(TTemplateEditorForm, TemplateEditorForm);
   Application.CreateForm(TSpringSettingsProfileForm, SpringSettingsProfileForm);
+  Application.CreateForm(TAutoJoinForm, AutoJoinForm);
   //Application.CreateForm(TSpringDownloaderForm, SpringDownloaderForm);
   if not MainUnit.RunningUnderWine then
     Application.CreateForm(TMenuForm, MenuForm);

Modified: Lobby/TASClient/TASClient.res
===================================================================
(Binary files differ)

Modified: Lobby/TASClient/Utility.pas
===================================================================
--- Lobby/TASClient/Utility.pas	2009-05-28 11:37:21 UTC (rev 7254)
+++ Lobby/TASClient/Utility.pas	2009-05-28 21:16:55 UTC (rev 7255)
@@ -135,9 +135,15 @@
 {since 0.77}function InitSubDirsVFS(const path: PChar; const pattern: PChar; const modes: PChar): Integer; stdcall; external 'UnitSync.dll' name 'InitSubDirsVFS';
 {since 0.68}function FindFilesVFS(handle: Integer; nameBuf: PChar; size: Integer): Integer; stdcall; external 'UnitSync.dll' name 'FindFilesVFS';
 {------------------------------------------------------------------------------}
-{since 0.76}function GetLuaAICount: Integer; stdcall; external 'UnitSync.dll' name 'GetLuaAICount';
-{since 0.76}function GetLuaAIName(aiIndex: Integer): PChar; stdcall; external 'UnitSync.dll' name 'GetLuaAIName';
-{since 0.76}function GetLuaAIDesc(aiIndex: Integer): PChar; stdcall; external 'UnitSync.dll' name 'GetLuaAIDesc';
+{since 0.76 DEPRECATED}function GetLuaAICount: Integer; stdcall; external 'UnitSync.dll' name 'GetLuaAICount';
+{since 0.76 DEPRECATED}function GetLuaAIName(aiIndex: Integer): PChar; stdcall; external 'UnitSync.dll' name 'GetLuaAIName';
+{since 0.76 DEPRECATED}function GetLuaAIDesc(aiIndex: Integer): PChar; stdcall; external 'UnitSync.dll' name 'GetLuaAIDesc';
+{since 0.79}function GetSkirmishAICount: Integer; stdcall; external 'UnitSync.dll' name 'GetSkirmishAICount';
+{since 0.79}function GetSkirmishAIInfoCount(index:integer): Integer; stdcall; external 'UnitSync.dll' name 'GetSkirmishAIInfoCount';
+{since 0.79}function GetInfoKey(index: integer): PChar; stdcall; external 'UnitSync.dll' name 'GetInfoKey';
+{since 0.79}function GetInfoValue(index: integer): PChar; stdcall; external 'UnitSync.dll' name 'GetInfoValue';
+{since 0.79}function GetInfoDescription(index: integer): PChar; stdcall; external 'UnitSync.dll' name 'GetInfoDescription';
+{since 0.79}function GetSkirmishAIOptionCount(index: integer): PChar; stdcall; external 'UnitSync.dll' name 'GetSkirmishAIOptionCount';
 {------------------------------------------------------------------------------}
 {since 0.76}function GetMapOptionCount(mapName: PChar): Integer; stdcall; external 'UnitSync.dll' name 'GetMapOptionCount';
 {since 0.76}function GetModOptionCount: Integer; stdcall; external 'UnitSync.dll' name 'GetModOptionCount';
@@ -426,17 +432,17 @@
 
     for x := 0 to bmp.Width -1 do
     begin
-      if  ((x+1) mod 4 = 0) and (x &lt;&gt; bmp.Width -1) then // vertical deinterlace
+      {*if  ((x+1) mod 4 = 0) and (x &lt;&gt; bmp.Width -1) then // vertical deinterlace
       begin
         color := Misc.RGB16BitsToColor((Misc.Color16BitsToR(minimap[y * mipsize + x-1])+Misc.Color16BitsToR(minimap[y * mipsize + x+1])) div 2,(Misc.Color16BitsToG(minimap[y * mipsize + x-1])+Misc.Color16BitsToG(minimap[y * mipsize + x+1])) div 2,(Misc.Color16BitsToB(minimap[y * mipsize + x-1])+Misc.Color16BitsToB(minimap[y * mipsize + x+1])) div 2);
         P[x*2+0] := Lo(color);
         P[x*2+1] := Hi(color);
       end
       else
-      begin
+      begin*}
         P[x*2+0] := Lo(minimap[y * mipsize + x]);
         P[x*2+1] := Hi(minimap[y * mipsize + x]);
-      end;
+      //end;
     end;
   end;
 


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002022.html">[Taspring-linux-commit] r7254 - site/trunk/wwwroot/includes
</A></li>
	<LI>Next message: <A HREF="002025.html">[Taspring-linux-commit] r7256 - Lobby/TASClient
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2024">[ date ]</a>
              <a href="thread.html#2024">[ thread ]</a>
              <a href="subject.html#2024">[ subject ]</a>
              <a href="author.html#2024">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
