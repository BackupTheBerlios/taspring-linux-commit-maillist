<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r6447 - in branches/0.77-branch: . AI	Lobby/TASClient Lobby/TASClient/Python Lobby/TASClient/Python/engine	Lobby/TASClient/Python/scripts/subf	installer/builddata/springcontent/gamedata installer/sections	rts rts/Game rts/Game/UI rts/Lua rts/Map rts/Map/SM3/terrain	rts/Map/SMF rts/Rendering/GL rts/Rendering/Textures	rts/Rendering/UnitModels rts/Sim/Features rts/Sim/Misc	rts/Sim/MoveTypes rts/Sim/Objects rts/Sim/Projectiles	rts/Sim/Projectiles/WeaponProjectiles rts/Sim/Units/CommandAI	rts/Sim/Weapons rts/System rts/System/Net rts/System/Platform	rts/System/Platform/Win rts/System/Sync rts/build/cmake	rts/lib rts/lib/gml rts/lib/streflop tools/DedicatedServer	tools/SpringInstaller tools/SpringInstaller/debian tools/unitsync
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-September/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6447%20-%20in%20branches/0.77-branch%3A%20.%20AI%0A%09Lobby/TASClient%20Lobby/TASClient/Python%20Lobby/TASClient/Python/engine%0A%09Lobby/TASClient/Python/scripts/subf%0A%09installer/builddata/springcontent/gamedata%20installer/sections%0A%09rts%20rts/Game%20rts/Game/UI%20rts/Lua%20rts/Map%20rts/Map/SM3/terrain%0A%09rts/Map/SMF%20rts/Rendering/GL%20rts/Rendering/Textures%0A%09rts/Rendering/UnitModels%20rts/Sim/Features%20rts/Sim/Misc%0A%09rts/Sim/MoveTypes%20rts/Sim/Objects%20rts/Sim/Projectiles%0A%09rts/Sim/Projectiles/WeaponProjectiles%20rts/Sim/Units/CommandAI%0A%09rts/Sim/Weapons%20rts/System%20rts/System/Net%20rts/System/Platform%0A%09rts/System/Platform/Win%20rts/System/Sync%20rts/build/cmake%0A%09rts/lib%20rts/lib/gml%20rts/lib/streflop%20tools/DedicatedServer%0A%09tools/SpringInstaller%20tools/SpringInstaller/debian%20tools/unitsync&In-Reply-To=%3C20080923155112.AB02E48A4%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001216.html">
   <LINK REL="Next"  HREF="001218.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r6447 - in branches/0.77-branch: . AI	Lobby/TASClient Lobby/TASClient/Python Lobby/TASClient/Python/engine	Lobby/TASClient/Python/scripts/subf	installer/builddata/springcontent/gamedata installer/sections	rts rts/Game rts/Game/UI rts/Lua rts/Map rts/Map/SM3/terrain	rts/Map/SMF rts/Rendering/GL rts/Rendering/Textures	rts/Rendering/UnitModels rts/Sim/Features rts/Sim/Misc	rts/Sim/MoveTypes rts/Sim/Objects rts/Sim/Projectiles	rts/Sim/Projectiles/WeaponProjectiles rts/Sim/Units/CommandAI	rts/Sim/Weapons rts/System rts/System/Net rts/System/Platform	rts/System/Platform/Win rts/System/Sync rts/build/cmake	rts/lib rts/lib/gml rts/lib/streflop tools/DedicatedServer	tools/SpringInstaller tools/SpringInstaller/debian tools/unitsync</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6447%20-%20in%20branches/0.77-branch%3A%20.%20AI%0A%09Lobby/TASClient%20Lobby/TASClient/Python%20Lobby/TASClient/Python/engine%0A%09Lobby/TASClient/Python/scripts/subf%0A%09installer/builddata/springcontent/gamedata%20installer/sections%0A%09rts%20rts/Game%20rts/Game/UI%20rts/Lua%20rts/Map%20rts/Map/SM3/terrain%0A%09rts/Map/SMF%20rts/Rendering/GL%20rts/Rendering/Textures%0A%09rts/Rendering/UnitModels%20rts/Sim/Features%20rts/Sim/Misc%0A%09rts/Sim/MoveTypes%20rts/Sim/Objects%20rts/Sim/Projectiles%0A%09rts/Sim/Projectiles/WeaponProjectiles%20rts/Sim/Units/CommandAI%0A%09rts/Sim/Weapons%20rts/System%20rts/System/Net%20rts/System/Platform%0A%09rts/System/Platform/Win%20rts/System/Sync%20rts/build/cmake%0A%09rts/lib%20rts/lib/gml%20rts/lib/streflop%20tools/DedicatedServer%0A%09tools/SpringInstaller%20tools/SpringInstaller/debian%20tools/unitsync&In-Reply-To=%3C20080923155112.AB02E48A4%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r6447 - in branches/0.77-branch: . AI	Lobby/TASClient Lobby/TASClient/Python Lobby/TASClient/Python/engine	Lobby/TASClient/Python/scripts/subf	installer/builddata/springcontent/gamedata installer/sections	rts rts/Game rts/Game/UI rts/Lua rts/Map rts/Map/SM3/terrain	rts/Map/SMF rts/Rendering/GL rts/Rendering/Textures	rts/Rendering/UnitModels rts/Sim/Features rts/Sim/Misc	rts/Sim/MoveTypes rts/Sim/Objects rts/Sim/Projectiles	rts/Sim/Projectiles/WeaponProjectiles rts/Sim/Units/CommandAI	rts/Sim/Weapons rts/System rts/System/Net rts/System/Platform	rts/System/Platform/Win rts/System/Sync rts/build/cmake	rts/lib rts/lib/gml rts/lib/streflop tools/DedicatedServer	tools/SpringInstaller tools/SpringInstaller/debian tools/unitsync">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Tue Sep 23 17:51:12 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001216.html">[Taspring-linux-commit] r6446 - trunk/tools/unitsync
</A></li>
        <LI>Next message: <A HREF="001218.html">[Taspring-linux-commit] r6448 - trunk/rts/Sim/Misc
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1217">[ date ]</a>
              <a href="thread.html#1217">[ thread ]</a>
              <a href="subject.html#1217">[ subject ]</a>
              <a href="author.html#1217">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: Auswaschbar
Date: 2008-09-23 17:51:10 +0200 (Tue, 23 Sep 2008)
New Revision: 6447

Added:
   branches/0.77-branch/Lobby/TASClient/Python/scripts/subf/frenchTranslationTest.py
   branches/0.77-branch/rts/Map/SMF/SmfMapFile.cpp
   branches/0.77-branch/rts/Map/SMF/SmfMapFile.h
Modified:
   branches/0.77-branch/AI/CMakeLists.txt
   branches/0.77-branch/CMakeLists.txt
   branches/0.77-branch/Lobby/TASClient/AutoTeamsUnit.pas
   branches/0.77-branch/Lobby/TASClient/BattleFormUnit.dfm
   branches/0.77-branch/Lobby/TASClient/BattleFormUnit.pas
   branches/0.77-branch/Lobby/TASClient/LobbyScriptUnit.pas
   branches/0.77-branch/Lobby/TASClient/MainUnit.dfm
   branches/0.77-branch/Lobby/TASClient/MainUnit.pas
   branches/0.77-branch/Lobby/TASClient/ManageGroups.dfm
   branches/0.77-branch/Lobby/TASClient/ManageGroups.pas
   branches/0.77-branch/Lobby/TASClient/Misc.pas
   branches/0.77-branch/Lobby/TASClient/Python/api.txt
   branches/0.77-branch/Lobby/TASClient/Python/engine/handlers.py
   branches/0.77-branch/Lobby/TASClient/Python/scripts/subf/layoutTest.py
   branches/0.77-branch/Lobby/TASClient/Python/scripts/subf/windowedTASClient.py
   branches/0.77-branch/Lobby/TASClient/ReplaysUnit.pas
   branches/0.77-branch/Lobby/TASClient/TASClient.dof
   branches/0.77-branch/Lobby/TASClient/TASClient.res
   branches/0.77-branch/Lobby/TASClient/TipsFormUnit.pas
   branches/0.77-branch/Lobby/TASClient/Utility.pas
   branches/0.77-branch/installer/builddata/springcontent/gamedata/weapondefs_post.lua
   branches/0.77-branch/installer/sections/springlobby.nsh
   branches/0.77-branch/installer/sections/tasclient.nsh
   branches/0.77-branch/rts/CMakeLists.txt
   branches/0.77-branch/rts/Game/Game.cpp
   branches/0.77-branch/rts/Game/GameServer.cpp
   branches/0.77-branch/rts/Game/PlayerBase.cpp
   branches/0.77-branch/rts/Game/PlayerRoster.cpp
   branches/0.77-branch/rts/Game/Team.h
   branches/0.77-branch/rts/Game/UI/GameInfo.cpp
   branches/0.77-branch/rts/Game/WaitCommandsAI.cpp
   branches/0.77-branch/rts/Lua/LuaOpenGL.cpp
   branches/0.77-branch/rts/Lua/LuaRules.cpp
   branches/0.77-branch/rts/Lua/LuaWeaponDefs.cpp
   branches/0.77-branch/rts/Map/Ground.cpp
   branches/0.77-branch/rts/Map/SM3/terrain/Lightcalc.cpp
   branches/0.77-branch/rts/Map/SM3/terrain/QuadRenderData.cpp
   branches/0.77-branch/rts/Map/SM3/terrain/Terrain.cpp
   branches/0.77-branch/rts/Map/SM3/terrain/TerrainTexEnvCombine.cpp
   branches/0.77-branch/rts/Map/SM3/terrain/TerrainTextureGLSL.cpp
   branches/0.77-branch/rts/Map/SMF/BFGroundDrawer.cpp
   branches/0.77-branch/rts/Map/SMF/BFGroundDrawer.h
   branches/0.77-branch/rts/Map/SMF/BFGroundTextures.cpp
   branches/0.77-branch/rts/Map/SMF/SmfReadMap.cpp
   branches/0.77-branch/rts/Map/SMF/SmfReadMap.h
   branches/0.77-branch/rts/Rendering/GL/myGL.cpp
   branches/0.77-branch/rts/Rendering/Textures/nv_dds.cpp
   branches/0.77-branch/rts/Rendering/UnitModels/UnitDrawer.cpp
   branches/0.77-branch/rts/Rendering/UnitModels/UnitDrawer.h
   branches/0.77-branch/rts/Sim/Features/Feature.cpp
   branches/0.77-branch/rts/Sim/Misc/LosHandler.h
   branches/0.77-branch/rts/Sim/Misc/RadarHandler.h
   branches/0.77-branch/rts/Sim/MoveTypes/GroundMoveType.cpp
   branches/0.77-branch/rts/Sim/MoveTypes/MoveType.cpp
   branches/0.77-branch/rts/Sim/MoveTypes/TAAirMoveType.cpp
   branches/0.77-branch/rts/Sim/Objects/SolidObject.h
   branches/0.77-branch/rts/Sim/Projectiles/ExplosionGenerator.cpp
   branches/0.77-branch/rts/Sim/Projectiles/WeaponProjectiles/WeaponProjectile.cpp
   branches/0.77-branch/rts/Sim/Projectiles/WeaponProjectiles/WeaponProjectile.h
   branches/0.77-branch/rts/Sim/Units/CommandAI/AirCAI.cpp
   branches/0.77-branch/rts/Sim/Units/CommandAI/BuilderCAI.cpp
   branches/0.77-branch/rts/Sim/Units/CommandAI/CommandAI.cpp
   branches/0.77-branch/rts/Sim/Units/CommandAI/MobileCAI.cpp
   branches/0.77-branch/rts/Sim/Weapons/Cannon.cpp
   branches/0.77-branch/rts/Sim/Weapons/Weapon.cpp
   branches/0.77-branch/rts/Sim/Weapons/WeaponDefHandler.cpp
   branches/0.77-branch/rts/Sim/Weapons/WeaponDefHandler.h
   branches/0.77-branch/rts/Sim/Weapons/bombdropper.cpp
   branches/0.77-branch/rts/System/BaseNetProtocol.h
   branches/0.77-branch/rts/System/EventHandler.h
   branches/0.77-branch/rts/System/GlobalStuff.cpp
   branches/0.77-branch/rts/System/GlobalStuff.h
   branches/0.77-branch/rts/System/Net/UDPConnection.cpp
   branches/0.77-branch/rts/System/Net/UDPListener.cpp
   branches/0.77-branch/rts/System/NetProtocol.cpp
   branches/0.77-branch/rts/System/NetProtocol.h
   branches/0.77-branch/rts/System/Platform/Win/CrashHandler.cpp
   branches/0.77-branch/rts/System/Platform/Win/WinFileSystemHandler.cpp
   branches/0.77-branch/rts/System/Platform/Win/WinVersion.cpp
   branches/0.77-branch/rts/System/Platform/byteorder.h
   branches/0.77-branch/rts/System/Sync/SyncDebugger.cpp
   branches/0.77-branch/rts/build/cmake/TestCXXAcceptsVisibilityFlag.cmake
   branches/0.77-branch/rts/lib/CMakeLists.txt
   branches/0.77-branch/rts/lib/gml/gml.cpp
   branches/0.77-branch/rts/lib/gml/gml.h
   branches/0.77-branch/rts/lib/gml/gmlcls.h
   branches/0.77-branch/rts/lib/gml/gmldef.h
   branches/0.77-branch/rts/lib/gml/gmlfun.h
   branches/0.77-branch/rts/lib/streflop/CMakeLists.txt
   branches/0.77-branch/tools/DedicatedServer/CMakeLists.txt
   branches/0.77-branch/tools/SpringInstaller/debian/changelog
   branches/0.77-branch/tools/SpringInstaller/fileSystem.ml
   branches/0.77-branch/tools/SpringInstaller/release.sh
   branches/0.77-branch/tools/SpringInstaller/spring_installer.ml
   branches/0.77-branch/tools/unitsync/CMakeLists.txt
   branches/0.77-branch/tools/unitsync/unitsync.cpp
   branches/0.77-branch/tools/unitsync/unitsync_api.h
Log:
* update to rev 6446


Modified: branches/0.77-branch/AI/CMakeLists.txt
===================================================================
--- branches/0.77-branch/AI/CMakeLists.txt	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/AI/CMakeLists.txt	2008-09-23 15:51:10 UTC (rev 6447)
@@ -1,6 +1,6 @@
 include_directories(${CMAKE_SOURCE_DIR}/rts ${CMAKE_SOURCE_DIR}/rts/ExternalAI ${CMAKE_SOURCE_DIR}/rts/System)
 
-add_definitions(-fPIC)
+add_definitions(${PIC_FLAG} -D_REENTRANT -D_GNU_SOURCE=1)
 aux_source_directory(${CMAKE_SOURCE_DIR}/rts/System/creg creg)
 list (APPEND creg ${CMAKE_SOURCE_DIR}/rts/System/float3)
 

Modified: branches/0.77-branch/CMakeLists.txt
===================================================================
--- branches/0.77-branch/CMakeLists.txt	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/CMakeLists.txt	2008-09-23 15:51:10 UTC (rev 6447)
@@ -1,6 +1,6 @@
 ### Cmake 2.4 lacks some cross-compiling features and fails on windows
 cmake_minimum_required(VERSION 2.6)
-Project(Spring)
+project(Spring)
 
 LIST(APPEND CMAKE_MODULE_PATH &quot;${CMAKE_CURRENT_SOURCE_DIR}/rts/build/cmake&quot;)
 
@@ -25,6 +25,15 @@
 	ADD_DEFINITIONS(-DDIRECT_CONTROL_ALLOWED)
 endif (DIRECT_CONTROL)
 
+IF (UNIX)
+	ADD_DEFINITIONS(-DNO_AVI)
+ELSEIF (UNIX)
+	SET(NO_AVI FALSE CACHE BOOL &quot;Disable in-game video recording&quot;)
+	if (NO_AVI)
+		ADD_DEFINITIONS(-DNO_AVI)
+	endif (NO_AVI)
+ENDIF(UNIX)
+
 SET(SPRING_DATADIR ${CMAKE_INSTALL_PREFIX}/${DATADIR} CACHE STRING &quot;Path to game content (in addition to /etc/spring/datadir)&quot;)
 if (SPRING_DATADIR)
 	ADD_DEFINITIONS(-DSPRING_DATADIR=&quot;${SPRING_DATADIR}&quot;)
@@ -44,22 +53,29 @@
 	# AIs need it
 	FIND_PACKAGE(SDL REQUIRED)
 	INCLUDE_DIRECTORIES(${SDL_INCLUDE_DIR})
+
+	FIND_PACKAGE(Boost 1.34.0 COMPONENTS thread regex REQUIRED)
 endif (MINGW)
 
 ### Compiler flags and defines based on build type
 INCLUDE(TestCXXAcceptsVisibilityFlag)
-set (MARCH_FLAG native CACHE STRING &quot;Passed to GCC for CPU-dependend optimization&quot;)
-SET(CMAKE_CXX_FLAGS &quot;-march=${MARCH_FLAG} -fsingle-precision-constant -frounding-math -fsignaling-nans -mieee-fp -mfpmath=387 -pipe -fno-strict-aliasing&quot;)
+set (MARCH_FLAG native CACHE STRING &quot;CPU optimization (use i686 for generic optimization)&quot;)
+SET(CMAKE_CXX_FLAGS &quot;-march=${MARCH_FLAG} -fsingle-precision-constant -frounding-math -fsignaling-nans -mieee-fp -mfpmath=387 -pipe -fno-strict-aliasing ${VISIBILITY_HIDDEN} ${VISIBILITY_INLINES_HIDDEN}&quot;)
+# ADD_DEFINITIONS(-DSTREFLOP_X87) breaks AI compiling
 IF (UNIX)
 	SET(CMAKE_CXX_FLAGS &quot;${CMAKE_CXX_FLAGS} -pthread&quot;)
 ENDIF (UNIX)
-SET(CMAKE_CXX_FLAGS_DEBUG   &quot;${CMAKE_CXX_FLAGS} -ggdb1 -O1 -Wall -DDEBUG -D_DEBUG -DNO_CATCH_EXCEPTIONS&quot;)
-SET(CMAKE_CXX_FLAGS_DEBUG2  &quot;${CMAKE_CXX_FLAGS} -ggdb2 -O0 -Wall -DDEBUG -D_DEBUG -DNO_CATCH_EXCEPTIONS&quot;)
-SET(CMAKE_CXX_FLAGS_DEBUG3  &quot;${CMAKE_CXX_FLAGS} -ggdb3 -O0 -Wall -DDEBUG -D_DEBUG -DNO_CATCH_EXCEPTIONS&quot;)
-SET(CMAKE_CXX_FLAGS_RELEASE &quot;${CMAKE_CXX_FLAGS} ${VISIBILITY_HIDDEN} -O2 -DNDEBUG -fomit-frame-pointer&quot;)
-SET(CMAKE_CXX_FLAGS_RELWITHDEBINFO &quot;${CMAKE_CXX_FLAGS} ${VISIBILITY_HIDDEN} -g -O2 -DNDEBUG&quot;)
-SET(CMAKE_CXX_FLAGS_PROFILE   &quot;${CMAKE_CXX_FLAGS} -O2 -pg -Wall -DNDEBUG&quot;)
+SET(CMAKE_CXX_FLAGS_DEBUG   &quot;-ggdb1 -O1 -Wall -DDEBUG -D_DEBUG -DNO_CATCH_EXCEPTIONS&quot;)
+SET(CMAKE_CXX_FLAGS_DEBUG2  &quot;-ggdb2 -O0 -Wall -DDEBUG -D_DEBUG -DNO_CATCH_EXCEPTIONS&quot;)
+SET(CMAKE_CXX_FLAGS_DEBUG3  &quot;-ggdb3 -O0 -Wall -DDEBUG -D_DEBUG -DNO_CATCH_EXCEPTIONS&quot;)
+SET(CMAKE_CXX_FLAGS_RELEASE &quot;-O2 -DNDEBUG -fomit-frame-pointer&quot;)
+SET(CMAKE_CXX_FLAGS_RELWITHDEBINFO &quot;-g -O2 -DNDEBUG&quot;)
+SET(CMAKE_CXX_FLAGS_PROFILE   &quot;-O2 -pg -Wall -DNDEBUG&quot;)
+if (NOT MINGW)
+	set (PIC_FLAG &quot;-fpic&quot;)
+endif (NOT MINGW)
 
+### Where the other CMakeLists.txt are
 Add_Subdirectory(rts)
 Add_Subdirectory(AI)
 Add_Subdirectory(tools/DedicatedServer)
@@ -67,6 +83,7 @@
 Add_Subdirectory(tools/DemoAnalyser)
 Add_Subdirectory(tools/DemoDumper)
 
+### make the basefiles (aka sdz's)
 if (UNIX OR CMAKE_CROSSCOMPILING)
 	add_custom_target(gamedata ALL COMMAND sh make_gamedata_arch.sh WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/installer)
 else (UNIX OR CMAKE_CROSSCOMPILING)

Modified: branches/0.77-branch/Lobby/TASClient/AutoTeamsUnit.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/AutoTeamsUnit.pas	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/Lobby/TASClient/AutoTeamsUnit.pas	2008-09-23 15:51:10 UTC (rev 6447)
@@ -93,6 +93,14 @@
     s2 : TStrings;
     i: integer;
   begin
+    i := Client.GetGroup;
+    if i &gt; -1 then
+      if TClientGroup(ClientGroups[i]).BalanceInSameTeam then
+      begin
+        Result := TClientGroup(ClientGroups[i]).Name + '64qss87';
+        Exit;
+      end;
+
     s1 := TStringList.Create;
     s2 := TStringList.Create;
     Result := '';

Modified: branches/0.77-branch/Lobby/TASClient/BattleFormUnit.dfm
===================================================================
--- branches/0.77-branch/Lobby/TASClient/BattleFormUnit.dfm	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/Lobby/TASClient/BattleFormUnit.dfm	2008-09-23 15:51:10 UTC (rev 6447)
@@ -4039,6 +4039,7 @@
         Height = 21
         TabOrder = 1
         WordWrap = False
+        OnChange = InputEditChange
         OnKeyDown = InputEditKeyDown
         OnKeyPress = InputEditKeyPress
       end

Modified: branches/0.77-branch/Lobby/TASClient/BattleFormUnit.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/BattleFormUnit.pas	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/Lobby/TASClient/BattleFormUnit.pas	2008-09-23 15:51:10 UTC (rev 6447)
@@ -523,6 +523,7 @@
     procedure MapListFilterTextBoxChange(Sender: TObject;
       const Text: WideString);
     procedure MapsPopupMenuPopup(Sender: TObject);
+    procedure InputEditChange(Sender: TObject);
   private
     History: TWideStringList;
     HistoryIndex: Integer;
@@ -1456,7 +1457,7 @@
     VDTBattleClients.Header.Columns[8].MaxWidth := 0;
   end;
 
-  AddTextToChat('Joined battle'+EOL, Colors.Info, 1);
+  AddTextToChat('Joined battle', Colors.Info, 1);
 
   ResetStartRects;
   BattleForm.Caption := 'Battle window (' + BattleState.Battle.ModName + ')'; // this has no effect since battle form was skinned using TSpTBXTitleBar!
@@ -6709,4 +6710,9 @@
   MapSelectionForm.FilterTextBox.SetFocus;
 end;
 
+procedure TBattleForm.InputEditChange(Sender: TObject);
+begin
+  MainForm.InputEditChange(Sender);
+end;
+
 end.

Modified: branches/0.77-branch/Lobby/TASClient/LobbyScriptUnit.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/LobbyScriptUnit.pas	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/Lobby/TASClient/LobbyScriptUnit.pas	2008-09-23 15:51:10 UTC (rev 6447)
@@ -1562,6 +1562,9 @@
 function TGUI.GetControlProperties(component: string): Variant;
 var
   c : TWinControl;
+  i : integer;
+  propNames : TStringList;
+  propValues : TList;
 begin
   Result := GetPythonEngine.PyObjectAsVariant(GetPythonEngine.Py_None);
   try
@@ -1576,35 +1579,21 @@
     SafeDecRef(pyProperties);
     pyProperties := PyDict_New();
 
-    PyDict_SetItemStringDecRef(pyProperties,'x',c.Left);
-    PyDict_SetItemStringDecRef(pyProperties,'y',c.Top);
-    PyDict_SetItemStringDecRef(pyProperties,'width',c.Width);
-    PyDict_SetItemStringDecRef(pyProperties,'height',c.Height);
 
-    if c.Align = alNone then
-      PyDict_SetItemStringDecRef(pyProperties,'align',0)
-    else if c.Align = alTop then
-      PyDict_SetItemStringDecRef(pyProperties,'align',1)
-    else if c.Align = alBottom then
-      PyDict_SetItemStringDecRef(pyProperties,'align',2)
-    else if c.Align = alLeft then
-      PyDict_SetItemStringDecRef(pyProperties,'align',3)
-    else if c.Align = alRight then
-      PyDict_SetItemStringDecRef(pyProperties,'align',4)
-    else if c.Align = alClient then
-      PyDict_SetItemStringDecRef(pyProperties,'align',5)
-    else
-      PyDict_SetItemStringDecRef(pyProperties,'align',6);
+    propNames := TStringList.Create;
+    propValues := TList.Create;
+    GetProperties(c,propNames,propValues);
 
+    for i := 0 to propNames.Count-1 do
+      PyDict_SetItemStringDecRef(pyProperties,PChar(propNames[i]),Variant(propValues[i]^));
+
     PyDict_SetItemStringDecRef(pyProperties,'leftAnchor',akLeft in c.Anchors);
     PyDict_SetItemStringDecRef(pyProperties,'rightAnchor',akRight in c.Anchors);
     PyDict_SetItemStringDecRef(pyProperties,'topAnchor',akTop in c.Anchors);
     PyDict_SetItemStringDecRef(pyProperties,'bottomAnchor',akBottom in c.Anchors);
 
-    PyDict_SetItemStringDecRef(pyProperties,'visible',c.Visible);
+    PyDict_SetItemStringDecRef(pyProperties,'Parent',GetStringFromComponent(c.GetParentComponent));
 
-    PyDict_SetItemStringDecRef(pyProperties,'parent',GetStringFromComponent(c.GetParentComponent));
-
     Result := PyObjectAsVariant(pyProperties);
   end;
   UnlockGUI;
@@ -1616,7 +1605,11 @@
   properties: PPyObject;
   x,y,width,height,align : integer;
   leftAnchor,rightAnchor,topAnchor,bottomAnchor,visible : boolean;
+  keys,values : PPyObject;
+  key: string;
+  value : Variant;
   parent: string;
+  i: integer;
 begin
   Result := False;
 
@@ -1627,39 +1620,32 @@
 
       if not PyDict_Check(properties) then Exit;
 
-      x := PyLong_AsLong(PyDict_GetItem(properties,PyString_FromString('x')));
-      y := PyLong_AsLong(PyDict_GetItem(properties,PyString_FromString('y')));
-      width := PyLong_AsLong(PyDict_GetItem(properties,PyString_FromString('width')));
-      height := PyLong_AsLong(PyDict_GetItem(properties,PyString_FromString('height')));
-      align := PyLong_AsLong(PyDict_GetItem(properties,PyString_FromString('align')));
+      keys := PyDict_Keys(properties);
+      values := PyDict_Values(properties);
 
+      c := GetComponentFromString(component) as TWinControl;
+
+      for i:=0 to PyList_Size(keys)-1 do
+      begin
+        key := PyString_AsString(PyList_GetItem(keys,i));
+        value := PyObjectAsVariant(PyList_GetItem(values,i));
+        if LowerCase(key) &lt;&gt; 'parent' then
+          SetProperty(c,key,value);
+      end;
+
+      parent := PyString_AsString(PyDict_GetItem(properties,PyString_FromString('parent')));
+
       leftAnchor := PyLong_AsLong(PyDict_GetItem(properties,PyString_FromString('leftAnchor'))) &lt;&gt; 0;
       rightAnchor := PyLong_AsLong(PyDict_GetItem(properties,PyString_FromString('rightAnchor'))) &lt;&gt; 0;
       topAnchor := PyLong_AsLong(PyDict_GetItem(properties,PyString_FromString('topAnchor'))) &lt;&gt; 0;
       bottomAnchor := PyLong_AsLong(PyDict_GetItem(properties,PyString_FromString('bottomAnchor'))) &lt;&gt; 0;
 
-      visible := PyLong_AsLong(PyDict_GetItem(properties,PyString_FromString('visible'))) &lt;&gt; 0;
-
-      parent := PyString_AsString(PyDict_GetItem(properties,PyString_FromString('parent')));
     end;
 
-    c := GetComponentFromString(component) as TWinControl;
-
     c.Parent := GetComponentFromString(parent) as TWinControl;
-    case align of
-      0:c.Align := alNone;
-      1:c.Align := alTop;
-      2:c.Align := alBottom;
-      3:c.Align := alLeft;
-      4:c.Align := alRight;
-      5:c.Align := alClient;
-      6:c.Align := alCustom;
-    end;
+
+
     c.Anchors := [];
-    c.Width := width;
-    c.Height := height;
-    c.Top := y;
-    c.Left := x;
     if leftAnchor then
       c.Anchors := c.Anchors + [akLeft];
     if rightAnchor then
@@ -1669,8 +1655,6 @@
     if bottomAnchor then
       c.Anchors := c.Anchors + [akBottom];
 
-    c.Visible := visible;
-
     Result := True;
   except
     Result := False;
@@ -1984,6 +1968,12 @@
   c : TComponent;
   sl: TStringList;
 begin
+  if component = nil then
+  begin
+    Result := '';
+    Exit;
+  end;
+  
   sl := TStringList.Create;
   c := component;
 

Modified: branches/0.77-branch/Lobby/TASClient/MainUnit.dfm
===================================================================
--- branches/0.77-branch/Lobby/TASClient/MainUnit.dfm	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/Lobby/TASClient/MainUnit.dfm	2008-09-23 15:51:10 UTC (rev 6447)
@@ -1,6 +1,6 @@
 object MainForm: TMainForm
-  Left = 430
-  Top = 367
+  Left = 419
+  Top = 218
   Width = 773
   Height = 535
   Caption = '.'
@@ -326,7 +326,7 @@
               LinkFont.Style = [fsUnderline]
             end
             object btSpecatateNow: TSpTBXButton
-              Left = 375
+              Left = 487
               Top = 0
               Width = 97
               Height = 22
@@ -352,7 +352,7 @@
               LinkFont.Style = [fsUnderline]
             end
             object btPlayNow: TSpTBXButton
-              Left = 269
+              Left = 381
               Top = 0
               Width = 97
               Height = 22

Modified: branches/0.77-branch/Lobby/TASClient/MainUnit.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/MainUnit.pas	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/Lobby/TASClient/MainUnit.pas	2008-09-23 15:51:10 UTC (rev 6447)
@@ -524,7 +524,7 @@
 const
   VERSION_NUMBER = '0.38'; // Must be float value! (with a period as a decimal seperator)
   CHECK_BETA_LOBBY_URL = '<A HREF="http://tasclient.no-ip.org/TASClient_update_v2.txt">http://tasclient.no-ip.org/TASClient_update_v2.txt</A>';
-  PROGRAM_VERSION = 'TASClient ' + VERSION_NUMBER + ' RC24';
+  PROGRAM_VERSION = 'TASClient ' + VERSION_NUMBER + ' RC26';
   KEEP_ALIVE_INTERVAL = 10000; // in milliseconds. Tells us what should be the maximum &quot;silence&quot; time before we send a ping to the server.
   ASSUME_TIMEOUT_INTERVAL = 30000; // in milliseconds. Must be greater than KEEP_ALIVE_INTERVAL! If server hasn't send any data to us within this interval, then we assume timeout occured. It's us who must make sure we get constant replies from server by pinging it.
   LOCAL_TAB = '$Local'; // caption of main (command) tab window. Must be special so that is different from channel names or user names, that is why there is a &quot;$&quot; in front of it.
@@ -973,6 +973,7 @@
     ChatColor : integer;
     ReplaceRank: boolean;
     Rank: integer;
+    BalanceInSameTeam: boolean;
 
     constructor Create(Name: string; Color: Integer);
     destructor Destroy;
@@ -1284,7 +1285,6 @@
       const Data: String);
     procedure SpTBXItem5Click(Sender: TObject);
     procedure lobbyscriptWrapperInitialization(Sender: TObject);
-    procedure Button1Click(Sender: TObject);
     procedure RichEditURLClick(Sender: TObject; URL: String);
     procedure mnuTipsClick(Sender: TObject);
   published
@@ -1358,6 +1358,7 @@
     procedure InputEditKeyPress(Sender: TObject; var Key: Char);
     procedure InputEditClick(Sender: TObject);
     procedure InputEditKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
+    procedure InputEditChange(Sender: TObject);
     function CheckServerVersion(ServerVersion: string): Boolean;
     procedure ProcessCommand(s: WideString; CameFromBattleScreen: Boolean);
     procedure ProcessRemoteCommand(s: WideString); // processes command received from server
@@ -2016,8 +2017,12 @@
   index: Integer;
 begin
   if not FlagBitmapsInitialized then raise Exception.CreateFmt('Erro: FlagBitmaps not initialized! Please report this error!', []);
-  
-  index := FlagBitmapsReverseTable[Ord(Country[1]), Ord(Country[2])];
+
+  try
+    index := FlagBitmapsReverseTable[Ord(Country[1]), Ord(Country[2])];
+  except
+    index := -1;
+  end;
   if index = -1 then index := FlagBitmapsReverseTable[Ord('x'), Ord('x')];
   Result := FlagBitmaps[index];
 end;
@@ -3713,6 +3718,8 @@
 
     initLobbyScript;
 
+    TipsForm.LoadTips;
+
     KeepAliveTimer.Enabled := True;
     HighlighBattlesTimer.Enabled := True;
 
@@ -3852,6 +3859,7 @@
   tmped.OnKeyPress := InputEditKeyPress;
   tmped.OnKeyDown := InputEditKeyDown;
   tmped.OnClick := InputEditClick;
+  tmped.OnChange := InputEditChange;
   tmped.Font.Assign(CommonFont);
   tmped.Align := alBottom;
   tmped.WordWrap := False;
@@ -6704,9 +6712,11 @@
    SelectedClient: TClient;
    mapIndex: integer;
    r: boolean;
+   charPosOnLine: integer;
 begin
    with TExRichEdit(Sender) do
    begin
+    try
      GetCursorPos(pt);
      pt := TExRichEdit(Sender).ScreenToClient(pt);
      //Pt := Point(X, Y) ;
@@ -6714,6 +6724,7 @@
      if ci &lt; 0 then Exit;
      lix := Perform(EM_EXLINEFROMCHAR, 0, ci) ;
      co := ci - Perform(EM_LINEINDEX, lix, 0) ;
+     charPosOnLine := co;
      if -1 + Lines.Count &lt; lix then Exit;
      s := Lines[lix];
      Inc(co) ;
@@ -6726,7 +6737,7 @@
      SelectedWord := Copy(s, k, j - k) ;
 
      AcquireMainThread;
-     try if not Preferences.DisableScripts then r := handlers.onChatDblClick(SelectedWord,Lines[lix]); except end;
+     try if not Preferences.DisableScripts then r := handlers.onChatDblClick(charPosOnLine,Lines[lix]); except end;
      ReleaseMainThread;
 
      if r then Exit;
@@ -6746,8 +6757,12 @@
             BattleForm.ChangeMap(mapIndex);
             if BattleState.Status = Hosting then
               BattleForm.SendBattleInfoToServer;
+            
           end;
      end;
+    except
+      
+    end;
    end;
 end;
 
@@ -6766,6 +6781,7 @@
   begin
    with TExRichEdit(Sender) do
    begin
+    try
      Pt := Point(X, Y) ;
      ci := Perform(Messages.EM_CHARFROMPOS, 0, Integer(@Pt)) ;
      if ci &lt; 0 then Exit;
@@ -6792,6 +6808,9 @@
        ClientPopupMenu.Popup(TExRichEdit(Sender).ClientToScreen(pt).X,TExRichEdit(Sender).ClientToScreen(pt).Y);
        RichEditSelectedClient := nil;
      end;
+    except
+      RichEditSelectedClient := nil;
+    end;
    end;
   end;
 end;
@@ -6895,6 +6914,22 @@
     (Sender as TTntMemo).Tag := 0;
 end;
 
+procedure TMainForm.InputEditChange(Sender: TObject);
+var
+  selStart,selLength: integer;
+begin
+  selStart := (Sender as TTntMemo).SelStart;
+  selLength := (Sender as TTntMemo).SelLength;
+
+  if (Sender as TTntMemo).Lines.Count &gt; 1 then
+    (Sender as TTntMemo).ScrollBars := ssVertical
+  else
+    (Sender as TTntMemo).ScrollBars := ssNone;
+
+  (Sender as TTntMemo).SelStart := selStart;
+  (Sender as TTntMemo).SelLength := selLength;
+end;
+
 procedure TMainForm.PageControl1MouseDown(Sender: TObject;
   Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
 var
@@ -8622,7 +8657,6 @@
     end;
   except
   end;
-  (Sender as TTntListBox).Refresh;
 end;
 
 procedure TMainForm.RichEditPopupMenuPopup(Sender: TObject);
@@ -8886,6 +8920,9 @@
   Self.NotifyOnConnect := False;
   Self.EnableChatColor := False;
   Self.ChatColor := Color;
+  Self.ReplaceRank := False;
+  Self.Rank := 0;
+  Self.BalanceInSameTeam := False;
 end;
 
 destructor TClientGroup.Destroy;
@@ -9013,6 +9050,7 @@
       Ini.WriteString(IntToStr(i), 'ChatColor', IntToStr(TClientGroup(ClientGroups[i]).ChatColor));
       Ini.WriteString(IntToStr(i), 'ReplaceRank', BoolToStr(TClientGroup(ClientGroups[i]).ReplaceRank));
       Ini.WriteString(IntToStr(i), 'Rank', IntToStr(TClientGroup(ClientGroups[i]).Rank));
+      Ini.WriteString(IntToStr(i), 'BalanceInSameTeam', BoolToStr(TClientGroup(ClientGroups[i]).BalanceInSameTeam));
       Ini.WriteString(IntToStr(i), 'Clients', Misc.JoinStringList(TClientGroup(ClientGroups[i]).Clients,' '));
     end;
     Ini.Free;
@@ -9048,6 +9086,7 @@
     cg.ChatColor := StrToInt(Ini.ReadString(IntToStr(i), 'ChatColor', '0'));
     cg.ReplaceRank := StrToBool(Ini.ReadString(IntToStr(i), 'ReplaceRank', '0'));
     cg.Rank := StrToInt(Ini.ReadString(IntToStr(i), 'Rank', '0'));
+    cg.BalanceInSameTeam := StrToBool(Ini.ReadString(IntToStr(i), 'BalanceInSameTeam', '0'));
     Misc.ParseDelimited(cg.Clients,Ini.ReadString(IntToStr(i), 'Clients', 'Empty'),' ','');
     ClientGroups.Add(cg);
     i := i+1;
@@ -10795,13 +10834,6 @@
   LoadPresets;
 end;
 
-procedure TMainForm.Button1Click(Sender: TObject);
-begin
-  AddMainLog(GetComponentFromString('MainForm').Owner.ClassName,Colors.Normal);
-  //(GetComponentFromString('MainForm.Panel2') as TWinControl).Parent := Panel1;
-
-end;
-
 procedure TMainForm.RichEditURLClick(Sender: TObject; URL: String);
 var
   r : boolean;

Modified: branches/0.77-branch/Lobby/TASClient/ManageGroups.dfm
===================================================================
--- branches/0.77-branch/Lobby/TASClient/ManageGroups.dfm	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/Lobby/TASClient/ManageGroups.dfm	2008-09-23 15:51:10 UTC (rev 6447)
@@ -3,7 +3,7 @@
   Top = 100
   BorderStyle = bsDialog
   Caption = 'Manage groups'
-  ClientHeight = 384
+  ClientHeight = 410
   ClientWidth = 516
   Color = clBtnFace
   Constraints.MaxHeight = 1000
@@ -25,7 +25,7 @@
     Left = 0
     Top = 0
     Width = 516
-    Height = 384
+    Height = 410
     Caption = 'Manage groups'
     FixedSize = True
     Options.Maximize = False
@@ -49,7 +49,7 @@
     end
     object SpTBXPanel1: TSpTBXPanel
       Left = 8
-      Top = 332
+      Top = 356
       Width = 497
       Height = 41
       Caption = 'SpTBXPanel1'
@@ -123,8 +123,13 @@
       Left = 240
       Top = 40
       Width = 265
-      Height = 280
+      Height = 297
+      Hint = 
+        'Act like if all member of the group were in the same clan when b' +
+        'alancing teams.'
       Caption = 'SpTBXPanel2'
+      ParentShowHint = False
+      ShowHint = True
       TabOrder = 4
       object Label1: TLabel
         Left = 8
@@ -394,6 +399,32 @@
         OnChange = ReplaceRankCmbChange
         OnDrawItem = ReplaceRankCmbDrawItem
       end
+      object SpTBXLabel11: TSpTBXLabel
+        Left = 8
+        Top = 272
+        Width = 110
+        Height = 13
+        Hint = 
+          'Act like if all member of the group were in the same clan when b' +
+          'alancing teams.'
+        Caption = 'Balance in same team :'
+        ParentShowHint = False
+        ShowAccelChar = False
+        ShowHint = True
+        LinkFont.Charset = DEFAULT_CHARSET
+        LinkFont.Color = clBlue
+        LinkFont.Height = -11
+        LinkFont.Name = 'MS Sans Serif'
+        LinkFont.Style = [fsUnderline]
+      end
+      object BalanceInSameTeamCheckBox: TSpTBXCheckBox
+        Left = 128
+        Top = 272
+        Width = 14
+        Height = 15
+        TabOrder = 26
+        OnClick = BalanceInSameTeamCheckBoxClick
+      end
     end
   end
 end

Modified: branches/0.77-branch/Lobby/TASClient/ManageGroups.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/ManageGroups.pas	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/Lobby/TASClient/ManageGroups.pas	2008-09-23 15:51:10 UTC (rev 6447)
@@ -44,6 +44,8 @@
     Label1: TLabel;
     ReplaceRankCheckBox: TSpTBXCheckBox;
     ReplaceRankCmb: TSpTBXComboBox;
+    SpTBXLabel11: TSpTBXLabel;
+    BalanceInSameTeamCheckBox: TSpTBXCheckBox;
     procedure FormShow(Sender: TObject);
     procedure cmbGroupsChange(Sender: TObject);
     procedure btRemoveClick(Sender: TObject);
@@ -68,6 +70,7 @@
       Rect: TRect; State: TOwnerDrawState);
     procedure ReplaceRankCheckBoxClick(Sender: TObject);
     procedure ReplaceRankCmbChange(Sender: TObject);
+    procedure BalanceInSameTeamCheckBoxClick(Sender: TObject);
   private
     { Private declarations }
   public
@@ -130,6 +133,7 @@
   ChatColorPanel.Color := TClientGroup(ClientGroups[cmbGroups.ItemIndex]).ChatColor;
   ReplaceRankCheckBox.Checked := TClientGroup(ClientGroups[cmbGroups.ItemIndex]).ReplaceRank;
   ReplaceRankCmb.ItemIndex := TClientGroup(ClientGroups[cmbGroups.ItemIndex]).Rank;
+  BalanceInSameTeamCheckBox.Checked := TClientGroup(ClientGroups[cmbGroups.ItemIndex]).BalanceInSameTeam;
 end;
 
 procedure TManageGroupsForm.btRemoveClick(Sender: TObject);
@@ -306,4 +310,10 @@
   TClientGroup(ClientGroups[cmbGroups.ItemIndex]).Rank := ReplaceRankCmb.ItemIndex;
 end;
 
+procedure TManageGroupsForm.BalanceInSameTeamCheckBoxClick(
+  Sender: TObject);
+begin
+  TClientGroup(ClientGroups[cmbGroups.ItemIndex]).BalanceInSameTeam := BalanceInSameTeamCheckBox.Checked;
+end;
+
 end.

Modified: branches/0.77-branch/Lobby/TASClient/Misc.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/Misc.pas	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/Lobby/TASClient/Misc.pas	2008-09-23 15:51:10 UTC (rev 6447)
@@ -13,7 +13,7 @@
   SpTBXItem,JvSpin,Dialogs, Classes, ComCtrls, Windows, Graphics, MMSystem,
   Controls, Registry, SysUtils,RichEdit2, ExRichEdit, WSocket, Winsock,
   ESBDates, GpTimeZone, JvColorCombo, Forms,StdCtrls,HttpProt,TntComCtrls,
-  JclUnicode,TntSysUtils,PreferencesFormUnit,Variants;
+  JclUnicode,TntSysUtils,PreferencesFormUnit,Variants,typinfo;
 
 type
   TColorData = Array[0..128000] Of TRGBTriple;
@@ -35,6 +35,7 @@
     constructor Create(Suspended : Boolean);
   end;
 
+
 procedure ParseDelimited(const sl : TStrings; const value : string; const delimiter : string;const delimiter2: string) ;overload;
 procedure ParseDelimited(const sl : TWideStrings; const value : string; const delimiter : WideString;const delimiter2: WideString) ;overload;
 function JoinStringList(sl : TStrings;delimiter: String;startIndex: integer = 0):String;
@@ -130,7 +131,7 @@
 Function TextSize2(Text: string; AWidth: integer; Font: TFont = nil): TPoint;
 function VariantToString(AVar: OleVariant): string;
 function GetLongPathNameA(lpFileName:LPCTSTR;lpBuffer:LPTSTR;nBufferLength:DWORD): integer;stdcall; external 'Kernel32.dll';
-function  GetLongPathName(FileName: string): string;
+function GetLongPathName(FileName: string): string;
 Function DelTree(DirName : string): LongInt;
 Function CopyTree(DirFrom : string; DirTo : string): LongInt;
 Function MoveTree(DirFrom : string; DirTo : string): LongInt;
@@ -140,6 +141,8 @@
 procedure MakePath(Path: string);
 function URLDecode(const S: string): string;
 function URLEncode(const S: string; const InQueryString: Boolean): string;
+procedure SetProperty(Obj:TObject; propName: string; value: Variant);
+procedure GetProperties(Obj:TObject; nameList : TStrings; valueList : TList);
 
 implementation
 
@@ -2269,4 +2272,73 @@
   end;
 end;
 
+procedure SetProperty(Obj:TObject; propName: string; value: Variant);
+var
+  PropList:PPropList;
+  count,i,count2 : Integer;
+  PT : PTypeData;
+begin
+  PT:=GetTypeData(Obj.ClassInfo);
+  Count := PT.PropCount;
+  GetMem(PropList,Count * SizeOf(PPropInfo));
+  count2 := GetPropList(Obj.ClassInfo, tkAny, PropList);
+  for i:=0 to count2 -1 do
+    if LowerCase(Proplist[i].Name) = LowerCase(propName) then
+    begin
+      case Proplist[i].PropType^.Kind of
+        tkInteger :   SetOrdProp(Obj,Proplist[i].Name,Integer(value));
+        tkString :    SetStrProp(Obj,Proplist[i].Name,String(value));
+        tkWString :   SetStrProp(Obj,Proplist[i].Name,WideString(value));
+        tkFloat :     SetFloatProp(Obj,Proplist[i].Name,Extended(value));
+        tkEnumeration:
+          if (GetEnumName(Proplist[i].PropType^,0) = 'False') and (GetEnumName(Proplist[i].PropType^,1) = 'True') then
+            if Boolean(value) then
+              SetEnumProp(Obj,Proplist[i].Name,'True')
+            else
+              SetEnumProp(Obj,Proplist[i].Name,'False')
+          else
+            SetEnumProp(Obj,Proplist[i].Name,String(value));
+      end;
+      Exit;
+    end;
+end;
+
+procedure GetProperties(Obj:TObject; nameList : TStrings; valueList : TList);
+var
+  PropList:PPropList;
+  count,i,count2 : Integer;
+  PT : PTypeData;
+  v: ^Variant;
+  canAdd: boolean;
+begin
+  nameList.Clear;
+  valueList.Clear;
+  canAdd := True;
+
+  PT:=GetTypeData(Obj.ClassInfo);
+  Count := PT.PropCount;
+  GetMem(PropList,Count * SizeOf(PPropInfo));
+  count2 := GetPropList(Obj.ClassInfo, tkAny, PropList);
+  for i:=0 to count2 -1 do
+  begin
+    if canAdd then
+      New(v);
+    canAdd := True;
+    case Proplist[i].PropType^.Kind of
+      tkInteger :     v^ := Variant(GetOrdProp(Obj,Proplist[i].Name));
+      tkString :      v^ := Variant(GetStrProp(Obj,Proplist[i].Name));
+      tkWString :     v^ := Variant(GetWideStrProp(Obj,Proplist[i].Name));
+      tkFloat :       v^ := Variant(GetFloatProp(Obj,Proplist[i].Name));
+      tkEnumeration:  v^ := Variant(GetEnumProp(Obj,Proplist[i].Name));
+    else
+      canAdd := False;
+    end;
+    if canAdd then
+    begin
+      nameList.Add(Proplist[i].Name);
+      valueList.Add(v);
+    end;
+  end;
+end;
+
 end.

Modified: branches/0.77-branch/Lobby/TASClient/Python/api.txt
===================================================================
--- branches/0.77-branch/Lobby/TASClient/Python/api.txt	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/Lobby/TASClient/Python/api.txt	2008-09-23 15:51:10 UTC (rev 6447)
@@ -1,3 +1,23 @@
+Callins
+-------
+
+- handleCommand(s)
+- handleIn(s) return dontLetLobbyHandleIt : boolean
+- onLoggedIn
+- onDisconnect
+- HandleOut(s) return dontLetLobbyHandleIt : boolean
+- onLogin
+- onConnected
+- onClose
+- onSettingsChanged
+- onGroupsChanged
+- onMapsReloaded
+- onReplaysReloaded
+- onModsReloaded
+- onURLClick(url) return dontLetLobbyHandleIt : boolean
+- onChatDblClick(charPos,line) return dontLetLobbyHandleIt : boolean
+
+
 Callback class
 --------------
 
@@ -33,36 +53,10 @@
 - SetServers(dict)
 - ChangeMap(mapName)
 
-Callin :
 
-- handleCommand(s)
-- handleIn(s) return dontLetLobbyHandleIt : boolean
-- onLoggedIn
-- onDisconnect
-- HandleOut(s) return dontLetLobbyHandleIt : boolean
-- onLogin
-- onConnected
-- onClose
-- onSettingsChanged
-- onGroupsChanged
-- onMapsReloaded
-- onReplaysReloaded
-- onModsReloaded
-- onURLClick(url) return dontLetLobbyHandleIt : boolean
-- onChatDblClick(word,line) return dontLetLobbyHandleIt : boolean
-
-
-
 GUI Class
 ---------
 
-callin :
-
-- onSettingsChanged
-- onGroupsChanged
-
-callout :
-
 menuName = [HostBattle, Help, HelpWiki, HelpDownload, BattleItem (returning the BattleId), PlayerItem (Returning the Player Name), PlayerItemModeration (Returning the Player Name), BattlePlayerItem (Returning the Player Name), BattleMinimap, BattleAdmin, BattleAdminBalance, BattleAdminRankLimit, BattleLadder, ReplayItem (Returning the Replay index)] 
 
 - AddItemToMenu(menuName/SubmenuId,caption,callbackModuleName,callbackFunctionName,argsTuple) return itemId
@@ -81,7 +75,7 @@
 - AddSplitter(name, parent)
 - AddTabsPanel(name, parent)
 - AddTab(caption, name, TabsPanelName)
-- AddForm(name, caption, borderStyle (1-&gt;5))
+- AddForm(name, caption, borderStyle (0-&gt;5))
 
 
 
@@ -95,13 +89,8 @@
 - GetPresetList
 - GetHightlightList
 - SetHighlightlist
-- ChangeMap(mapName)
 - GetBattleSettings
 - SetBattleSettings(startPos, gameEndCond, LimitDGun, GhostedBuildings, DiminishMM, LockGameSpeed, StartMetal, StartEnergy, MaxUnits)
-- GetMapOptions
-- SetMapOptions(dict)
-- GetModOptions
-- SetModOptions(dict)
 
 LowPriority
 - SetPerformList

Modified: branches/0.77-branch/Lobby/TASClient/Python/engine/handlers.py
===================================================================
--- branches/0.77-branch/Lobby/TASClient/Python/engine/handlers.py	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/Lobby/TASClient/Python/engine/handlers.py	2008-09-23 15:51:10 UTC (rev 6447)
@@ -220,8 +220,8 @@
 def onURLClick(url):
 	return _handle_callin('onURLClick',url)
 	
-def onChatDblClick(word,line):
-	return _handle_callin('onChatDblClick',word+' '+line)
+def onChatDblClick(charPos,line):
+	return _handle_callin('onChatDblClick',charPos+' '+line)
 	
 def handleCommand(cmd):
 	spaces = cmd.count(' ')

Copied: branches/0.77-branch/Lobby/TASClient/Python/scripts/subf/frenchTranslationTest.py (from rev 6446, trunk/Lobby/TASClient/Python/scripts/subf/frenchTranslationTest.py)
===================================================================
--- branches/0.77-branch/Lobby/TASClient/Python/scripts/subf/frenchTranslationTest.py	                        (rev 0)
+++ branches/0.77-branch/Lobby/TASClient/Python/scripts/subf/frenchTranslationTest.py	2008-09-23 15:51:10 UTC (rev 6447)
@@ -0,0 +1,32 @@
+#!/usr/bin/python
+# -*- coding: latin-1 -*-
+
+import lobbyscript
+
+api = lobbyscript.Callback()
+gui = lobbyscript.GUI()
+
+def changeControlProp(cont,prop,value):
+  p = gui.GetControlProperties(cont)
+  p[prop] = value
+  gui.SetControlProperties(cont,p)
+  
+def translate(cont,value):
+  changeControlProp(cont,'Caption',value)
+
+
+def _init():
+  translate('MainForm.BattleScreenSpeedButton','Cr&#233;er Partie')
+  translate('MainForm.HelpButton','Aide/Liens')
+  translate('MainForm.SearchButton','Rechercher un fichier')
+  translate('MainForm.SpTBXLabel1','Liste des parties')
+  translate('MainForm.SpTBXLabel2','(Double clic pour rejoindre)')
+  translate('MainForm.btPlayNow','Jouer maintenant')
+  translate('MainForm.btSpecatateNow','Regarder maintenant')
+  
+  changeControlProp('MainForm.SearchButton','Width',150)
+  changeControlProp('MainForm.SpTBXLabel2','Left',150)
+  changeControlProp('MainForm.btPlayNow','Width',110)
+  changeControlProp('MainForm.btSpecatateNow','Width',110)
+  
+  
\ No newline at end of file

Modified: branches/0.77-branch/Lobby/TASClient/Python/scripts/subf/layoutTest.py
===================================================================
--- branches/0.77-branch/Lobby/TASClient/Python/scripts/subf/layoutTest.py	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/Lobby/TASClient/Python/scripts/subf/layoutTest.py	2008-09-23 15:51:10 UTC (rev 6447)
@@ -13,24 +13,24 @@
   # move the player list to the right of the chat with battle list under
   gui.AddPanel('testPanel','MainForm.Panel1')
    
-  changeComponentProp('MainForm.Panel2','align',4)
+  changeComponentProp('MainForm.Panel2','align','alRight')
   changeComponentProp('MainForm.Panel2','parent','MainForm.Panel1.testPanel')
   
-  changeComponentProp('MainForm.Splitter1','align',3)
+  changeComponentProp('MainForm.Splitter1','align','alLeft')
   changeComponentProp('MainForm.Splitter1','parent','MainForm.Panel1.testPanel')
-  changeComponentProp('MainForm.Splitter1','align',4)
+  changeComponentProp('MainForm.Splitter1','align','alRight')
   
-  changeComponentProp('MainForm.PageControl1','align',5)
+  changeComponentProp('MainForm.PageControl1','align','alClient')
   changeComponentProp('MainForm.PageControl1','parent','MainForm.Panel1.testPanel')
   
-  changeComponentProp('MainForm.Panel4','align',1) 
+  changeComponentProp('MainForm.Panel4','align','alTop') 
 
-  changeComponentProp('MainForm.Panel1.testPanel','align',5)
+  changeComponentProp('MainForm.Panel1.testPanel','align','alClient')
   
   #move minimap to a new tab
   gui.AddTab('Map','MapTabTest','BattleForm.SpTBXTabControl1')
   
   changeComponentProp('BattleForm.Panel6','parent','BattleForm.MapTabTest')
-  changeComponentProp('BattleForm.Panel6','align',5)
+  changeComponentProp('BattleForm.Panel6','align','alClient')
   
-  changeComponentProp('BattleForm.Panel5','align',1)
\ No newline at end of file
+  changeComponentProp('BattleForm.Panel5','align','alTop')
\ No newline at end of file

Modified: branches/0.77-branch/Lobby/TASClient/Python/scripts/subf/windowedTASClient.py
===================================================================
--- branches/0.77-branch/Lobby/TASClient/Python/scripts/subf/windowedTASClient.py	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/Lobby/TASClient/Python/scripts/subf/windowedTASClient.py	2008-09-23 15:51:10 UTC (rev 6447)
@@ -12,12 +12,12 @@
 def _init():
   gui.AddForm('PlayerListForm','Player List',2)
   changeComponentProp('MainForm.Panel2','parent','PlayerListForm')
-  changeComponentProp('MainForm.Panel2','align',5)
+  changeComponentProp('MainForm.Panel2','align','alClient')
   
   gui.AddForm('BattleListForm','Battle List',2)
   changeComponentProp('MainForm.Panel3','parent','BattleListForm')
-  changeComponentProp('MainForm.Panel3','align',5)
+  changeComponentProp('MainForm.Panel3','align','alClient')
   
-  gui.AddForm('ToolBarForm','TASClient Toolbar',2)
+  gui.AddForm('ToolBarForm','TASClient Toolbar','alBottom')
   changeComponentProp('MainForm.Panel4','parent','ToolBarForm')
-  changeComponentProp('MainForm.Panel4','align',5)
\ No newline at end of file
+  changeComponentProp('MainForm.Panel4','align','alClient')
\ No newline at end of file

Modified: branches/0.77-branch/Lobby/TASClient/ReplaysUnit.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/ReplaysUnit.pas	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/Lobby/TASClient/ReplaysUnit.pas	2008-09-23 15:51:10 UTC (rev 6447)
@@ -1223,13 +1223,15 @@
   Replay: TReplay;
   Pos: integer;
   s: WideString;
+  s2: string;
   tmp : WideString;
   textAlign: Cardinal;
   i: integer;
+  dt: TDateTime;
 begin
   if not (Sender as TVirtualDrawTree).Visible then
     Exit;
-    
+
   with Sender as TVirtualDrawTree, PaintInfo do
   begin
     Replay := GetReplayFromNode(Node);
@@ -1267,7 +1269,10 @@
       6: // game length
         if Replay.Version = 1 then
         begin
-          s := TimeToStr(EncodeTime(Replay.demoHeader.gameTime div 3600,(Replay.demoHeader.gameTime div 60) mod 60,Replay.demoHeader.gameTime mod 60,0));
+          dt := EncodeTime(Replay.demoHeader.gameTime div 3600,(Replay.demoHeader.gameTime div 60) mod 60,Replay.demoHeader.gameTime mod 60,0);
+          DateTimeToString(s2,'hh:nn:ss',dt);
+          s := s2;
+          //s := TimeToStr(EncodeTime(Replay.demoHeader.gameTime div 3600,(Replay.demoHeader.gameTime div 60) mod 60,Replay.demoHeader.gameTime mod 60,0));
         end
         else
           s:= 'n/a';

Modified: branches/0.77-branch/Lobby/TASClient/TASClient.dof
===================================================================
--- branches/0.77-branch/Lobby/TASClient/TASClient.dof	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/Lobby/TASClient/TASClient.dof	2008-09-23 15:51:10 UTC (rev 6447)
@@ -100,7 +100,7 @@
 DebugSourceDirs=
 UsePackages=0
 [Parameters]
-RunParams=-menu
+RunParams=
 HostApplication=C:\Program Files\Spring\TASClient.exe
 Launcher=
 UseLauncher=0
@@ -115,7 +115,7 @@
 MajorVer=0
 MinorVer=3
 Release=0
-Build=467
+Build=472
 Debug=0
 PreRelease=0
 Special=0
@@ -126,7 +126,7 @@
 [Version Info Keys]
 CompanyName=
 FileDescription=TA Spring lobby client
-FileVersion=0.3.0.467
+FileVersion=0.3.0.472
 InternalName=
 LegalCopyright=
 LegalTrademarks=
@@ -134,6 +134,8 @@
 ProductName=TASClient
 ProductVersion=1.0.0.0
 Comments=
+[Excluded Packages]
+C:\Program Files\Borland\Delphi7\Projects\Bpl\Jcl70.bpl=JEDI Code Library RTL package
 [HistoryLists\hlUnitAliases]
 Count=1
 Item0=WinTypes=Windows;WinProcs=Windows;DbiTypes=BDE;DbiProcs=BDE;DbiErrs=BDE;

Modified: branches/0.77-branch/Lobby/TASClient/TASClient.res
===================================================================
(Binary files differ)

Modified: branches/0.77-branch/Lobby/TASClient/TipsFormUnit.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/TipsFormUnit.pas	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/Lobby/TASClient/TipsFormUnit.pas	2008-09-23 15:51:10 UTC (rev 6447)
@@ -85,6 +85,7 @@
 var
   i: integer;
 begin
+  if TipList.Count = 0 then Exit;
   if not chkShowTips.Checked and not forceShow then Exit;
 
   currentForm := tipType;
@@ -109,8 +110,6 @@
 
   if not SpTBXTitleBar1.Active then
     RemoveSpTBXTitleBarMarges(self);
-
-  LoadTips;
 end;
 
 procedure TTipsForm.btNextTipClick(Sender: TObject);

Modified: branches/0.77-branch/Lobby/TASClient/Utility.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/Utility.pas	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/Lobby/TASClient/Utility.pas	2008-09-23 15:51:10 UTC (rev 6447)
@@ -65,7 +65,7 @@
 function GetModValidMapList: TStringList;
 function GetMapArchive(mapName: String):String;
 function GetArchiveDescriptor(FileName: string): String;
-function ExtractVFSDir(Dir: string;ExtractTo: string): boolean;
+//function ExtractVFSDir(Dir: string;ExtractTo: string): boolean;
 
 var
   ModList: TStrings; // names of mods
@@ -152,6 +152,8 @@
 {since 0.68}procedure ReadFileVFS(handle: Integer; buf: Pointer; length: Integer); stdcall; external 'UnitSync.dll' name 'ReadFileVFS';
 {since 0.68}function FileSizeVFS(handle: Integer): Integer; stdcall; external 'UnitSync.dll' name 'FileSizeVFS';
 {since 0.68}function InitFindVFS(const pattern: PChar): Integer; stdcall; external 'UnitSync.dll' name 'InitFindVFS';
+{since 0.77}//function InitDirListVFS(const path: PChar; const pattern: PChar; const modes: PChar): Integer; stdcall; external 'UnitSync.dll' name 'InitDirListVFS';
+{since 0.77}//function InitSubDirsVFS(const path: PChar; const pattern: PChar; const modes: PChar): Integer; stdcall; external 'UnitSync.dll' name 'InitSubDirsVFS';
 {since 0.68}function FindFilesVFS(handle: Integer; nameBuf: PChar; size: Integer): Integer; stdcall; external 'UnitSync.dll' name 'FindFilesVFS';
 {------------------------------------------------------------------------------}
 {since 0.76}function GetLuaAICount: Integer; stdcall; external 'UnitSync.dll' name 'GetLuaAICount';
@@ -163,6 +165,7 @@
 {since 0.76}function GetOptionKey(optIndex: Integer): PChar; stdcall; external 'UnitSync.dll' name 'GetOptionKey';
 {since 0.76}function GetOptionName(optIndex: Integer): PChar; stdcall; external 'UnitSync.dll' name 'GetOptionName';
 {since 0.77}//function GetOptionSection(optIndex: Integer): PChar; stdcall; external 'UnitSync.dll' name 'GetOptionSection';
+{since 0.77}//function GetOptionStyle(optIndex: Integer): PChar; stdcall; external 'UnitSync.dll' name 'GetOptionStyle';
 {since 0.76}function GetOptionDesc(optIndex: Integer): PChar; stdcall; external 'UnitSync.dll' name 'GetOptionDesc';
 {since 0.76}function GetOptionType(optIndex: Integer): Integer; stdcall; external 'UnitSync.dll' name 'GetOptionType';
 {since 0.76}function GetOptionBoolDef(optIndex: Integer): Boolean; stdcall; external 'UnitSync.dll' name 'GetOptionBoolDef';
@@ -811,14 +814,17 @@
   end;
 end;
 
-function ExtractVFSDir(Dir: string;ExtractTo: string): boolean;
+{function ExtractVFSDir(Dir: string;ExtractTo: string): boolean;
 var
   archiveHwd,fileHwd,size: integer;
   fileContent: string;
   res: integer;
   s: string;
+  subDirs: TStringList;
+  i: integer;
+  fs: TFileStream;
 begin
-  res := InitFindVFS(PChar(Dir+'\*\*'));
+  res := InitDirListVFS(PChar(Dir),'*',nil);
   SetLength(s, 255);
   res := FindFilesVFS(res, PChar(s), 255);
 
@@ -828,34 +834,45 @@
   end
   else
   begin
+    if not DirectoryExists(ExtractTo) then
+      MkDir(ExtractTo);
+
+    // copy the files
     while res &lt;&gt; 0 do
     begin
-      MainForm.AddMainLog(s, Colors.Info);
-      SetLength(s, 255);
+      // copy one file
+      fileHwd := OpenFileVFS(PChar(s));
+      if fileHwd &lt;&gt; 0 then
+      begin
+        size := FileSizeVFS(fileHwd);
+        SetLength(fileContent,size);
+        ReadFileVFS(fileHwd,PChar(fileContent),size);
+        fs := TFileStream.Create(ExtractTo+'\'+ExtractFileName(StringReplace(Trim(s),'/','\',[rfReplaceAll])),fmOpenWrite or fmCreate );
+        fs.WriteBuffer(fileContent[1],size);
+        fs.Free;
+        CloseFileVFS(fileHwd);
+      end;
+      // get next filename
       res := FindFilesVFS(res, PChar(s), 255);
     end;
-  end;
 
-
-  {Result := '';
-  archiveHwd := OpenArchive(PChar(FileName));
-  if archiveHwd &lt;&gt; 0 then
-  begin
-    fileHwd := OpenArchiveFile(archiveHwd,'descriptor.tdf');
-    if fileHwd &lt;&gt; 0 then
+    // make the subdirs list
+    subDirs := TStringList.Create;
+    res := InitSubDirsVFS(PChar(Dir),'*',nil);
+    SetLength(s, 255);
+    res := FindFilesVFS(res, PChar(s), 255);
+    while res &lt;&gt; 0 do
     begin
-      size := SizeArchiveFile(archiveHwd, fileHwd);
-      fileContent := '';
-      SetLength(fileContent,size);
-      ReadArchiveFile(archiveHwd,fileHwd,PChar(fileContent),size);
-      Result := fileContent;
-      CloseArchiveFile(archiveHwd,fileHwd);
+      subDirs.Add(Trim(s));
+      res := FindFilesVFS(res, PChar(s), 255);
     end;
-    CloseArchive(archiveHwd);
-  end;}
-end;
 
+    for i:=0 to subDirs.Count-1 do
+      ExtractVFSDir(subDirs[i],ExtractTo+'\'+ExtractFileNameFromUrl(LeftStr(subDirs[i],Length(subDirs[i])-1)));
+  end;
+end;}
 
+
 { ------------------------------------------------------------------------ }
 
 initialization

Modified: branches/0.77-branch/installer/builddata/springcontent/gamedata/weapondefs_post.lua
===================================================================
--- branches/0.77-branch/installer/builddata/springcontent/gamedata/weapondefs_post.lua	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/installer/builddata/springcontent/gamedata/weapondefs_post.lua	2008-09-23 15:51:10 UTC (rev 6447)
@@ -1,89 +1,167 @@
---------------------------------------------------------------------------------
---------------------------------------------------------------------------------
---
---  file:    weapondefs_post.lua
---  brief:   weaponDef post processing
---  author:  Dave Rodgers
---
---  Copyright (C) 2008.
---  Licensed under the terms of the GNU GPL, v2 or later.
---
---------------------------------------------------------------------------------
---------------------------------------------------------------------------------
---
---  Per-unitDef weaponDefs
---
-
-local function isbool(x)   return (type(x) == 'boolean') end
-local function istable(x)  return (type(x) == 'table')   end
-local function isnumber(x) return (type(x) == 'number')  end
-local function isstring(x) return (type(x) == 'string')  end
-
-
---------------------------------------------------------------------------------
-
-local function ProcessUnitDef(udName, ud)
-
-  local wds = ud.weapondefs
-  if (not istable(wds)) then
-    return
-  end
-
-  -- add this unitDef's weaponDefs
-  for wdName, wd in pairs(wds) do
-    if (isstring(wdName) and istable(wd)) then
-      local fullName = udName .. '_' .. wdName
-      WeaponDefs[fullName] = wd
-      wd.filename = ud.filename
-    end
-  end
-
-  -- convert the weapon names
-  local weapons = ud.weapons
-  if (istable(weapons)) then
-    for i = 1, 32 do
-      local w = weapons[i]
-      if (istable(w)) then
-        if (isstring(w.def)) then
-          local ldef = string.lower(w.def)
-          local fullName = udName .. '_' .. ldef
-          local wd = WeaponDefs[fullName]
-          if (istable(wd)) then
-            w.name = fullName
-          end
-        end
-        w.def = nil
-      end
-    end
-  end
-
-  -- convert the death explosions
-  if (isstring(ud.explodeas)) then
-    local fullName = udName .. '_' .. ud.explodeas
-    if (WeaponDefs[fullName]) then
-      ud.explodeas = fullName
-    end
-  end
-  if (isstring(ud.selfdestructas)) then
-    local fullName = udName .. '_' .. ud.selfdestructas
-    if (WeaponDefs[fullName]) then
-      ud.selfdestructas = fullName
-    end
-  end
-end
-
-
---------------------------------------------------------------------------------
-
--- Process the unitDefs
-local UnitDefs = DEFS.unitDefs
-
-for udName, ud in pairs(UnitDefs) do
-  if (isstring(udName) and istable(ud)) then
-    ProcessUnitDef(udName, ud)
-  end
-end
-
-
---------------------------------------------------------------------------------
---------------------------------------------------------------------------------
+--------------------------------------------------------------------------------
+--------------------------------------------------------------------------------
+--
+--  file:    weapondefs_post.lua
+--  brief:   weaponDef post processing
+--  author:  Dave Rodgers
+--
+--  Copyright (C) 2008.
+--  Licensed under the terms of the GNU GPL, v2 or later.
+--
+--------------------------------------------------------------------------------
+--------------------------------------------------------------------------------
+--
+--  Per-unitDef weaponDefs
+--
+
+local function isbool(x)   return (type(x) == 'boolean') end
+local function istable(x)  return (type(x) == 'table')   end
+local function isnumber(x) return (type(x) == 'number')  end
+local function isstring(x) return (type(x) == 'string')  end
+
+local function tobool(val)
+  local t = type(val)
+  if (t == 'nil') then
+    return false
+  elseif (t == 'boolean') then
+    return val
+  elseif (t == 'number') then
+    return (val ~= 0)
+  elseif (t == 'string') then
+    return ((val ~= '0') and (val ~= 'false'))
+  end
+  return false
+end
+
+--------------------------------------------------------------------------------
+
+local function BackwardCompability(wdName,wd)
+  -- weapon reloadTime and stockpileTime were seperated in 77b1
+  if (tobool(wd.stockpile) and (wd.stockpiletime==nil)) then
+    wd.stockpiletime = wd.reloadtime
+    wd.reloadtime    = 2             -- 2 seconds
+  end
+
+  -- auto detect ota weapontypes
+  if (wd.weapontype==nil) then
+    local rendertype = tonumber(wd.rendertype) or 0
+    if (tobool(wd.dropped)) then
+      wd.weapontype = &quot;AircraftBomb&quot;;
+    elseif (tobool(wd.vlaunch)) then
+      wd.weapontype = &quot;StarburstLauncher&quot;;
+    elseif (tobool(wd.beamlaser)) then
+      wd.weapontype = &quot;BeamLaser&quot;;
+    elseif (tobool(wd.isshield)) then
+      wd.weapontype = &quot;Shield&quot;;
+    elseif (tobool(wd.waterweapon)) then
+      wd.weapontype = &quot;TorpedoLauncher&quot;;
+    elseif (wdName:lower():find(&quot;disintegrator&quot;,1,true)) then
+      wd.weaponType = &quot;DGun&quot;
+    elseif (tobool(wd.lineofsight)) then
+      if (rendertype==7) then
+        wd.weapontype = &quot;LightingCannon&quot;;
+
+      -- swta fix (outdated?)
+      elseif (wd.model and wd.model:lower():find(&quot;laser&quot;,1,true)) then
+        wd.weapontype = &quot;LaserCannon&quot;;
+
+      elseif (tobool(wd.beamweapon)) then
+        wd.weapontype = &quot;LaserCannon&quot;;
+      elseif (tobool(wd.smoketrail)) then
+        wd.weapontype = &quot;MissileLauncher&quot;;
+      elseif (rendertype==4 and tonumber(wd.color)==2) then
+        wd.weapontype = &quot;EmgCannon&quot;;
+      elseif (rendertype==5) then
+        wd.weapontype = &quot;Flame&quot;;
+      --elseif(rendertype==1) then
+      --  wd.weapontype = &quot;MissileLauncher&quot;;
+      else
+        wd.weapontype = &quot;Cannon&quot;;
+      end
+    else
+      wd.weapontype = &quot;Cannon&quot;;
+    end
+  end
+end
+
+--------------------------------------------------------------------------------
+
+local function ProcessUnitDef(udName, ud)
+
+  local wds = ud.weapondefs
+  if (not istable(wds)) then
+    return
+  end
+
+  -- add this unitDef's weaponDefs
+  for wdName, wd in pairs(wds) do
+    if (isstring(wdName) and istable(wd)) then
+      local fullName = udName .. '_' .. wdName
+      WeaponDefs[fullName] = wd
+      wd.filename = ud.filename
+    end
+  end
+
+  -- convert the weapon names
+  local weapons = ud.weapons
+  if (istable(weapons)) then
+    for i = 1, 32 do
+      local w = weapons[i]
+      if (istable(w)) then
+        if (isstring(w.def)) then
+          local ldef = string.lower(w.def)
+          local fullName = udName .. '_' .. ldef
+          local wd = WeaponDefs[fullName]
+          if (istable(wd)) then
+            w.name = fullName
+          end
+        end
+        w.def = nil
+      end
+    end
+  end
+
+  -- convert the death explosions
+  if (isstring(ud.explodeas)) then
+    local fullName = udName .. '_' .. ud.explodeas
+    if (WeaponDefs[fullName]) then
+      ud.explodeas = fullName
+    end
+  end
+  if (isstring(ud.selfdestructas)) then
+    local fullName = udName .. '_' .. ud.selfdestructas
+    if (WeaponDefs[fullName]) then
+      ud.selfdestructas = fullName
+    end
+  end
+end
+
+--------------------------------------------------------------------------------
+
+local function ProcessWeaponDef(wdName, wd)
+
+  -- backward compability
+  BackwardCompability(wdName,wd)
+end
+
+--------------------------------------------------------------------------------
+
+-- Process the unitDefs
+local UnitDefs = DEFS.unitDefs
+
+for udName, ud in pairs(UnitDefs) do
+  if (isstring(udName) and istable(ud)) then
+    ProcessUnitDef(udName, ud)
+  end
+end
+
+
+for wdName, wd in pairs(WeaponDefs) do
+  if (isstring(wdName) and istable(wd)) then
+    ProcessWeaponDef(wdName, wd)
+  end
+end
+
+
+--------------------------------------------------------------------------------
+--------------------------------------------------------------------------------

Modified: branches/0.77-branch/installer/sections/springlobby.nsh
===================================================================
--- branches/0.77-branch/installer/sections/springlobby.nsh	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/installer/sections/springlobby.nsh	2008-09-23 15:51:10 UTC (rev 6447)
@@ -1,7 +1,7 @@
 !ifdef INSTALL
   SetOutPath &quot;$INSTDIR&quot;
   inetc::get \
-             &quot;<A HREF="http://installer.clan-sy.com/springlobby.exe">http://installer.clan-sy.com/springlobby.exe</A>&quot; &quot;$INSTDIR\springlobby.exe&quot;  
+             &quot;<A HREF="http://www.springlobby.info/installer/springlobby.exe">http://www.springlobby.info/installer/springlobby.exe</A>&quot; &quot;$INSTDIR\springlobby.exe&quot;
   File &quot;..\external\SDL_mixer.dll&quot;
   File &quot;..\external\wxbase28u_xml_gcc_custom.dll&quot;
   File &quot;..\external\wxmsw28u_aui_gcc_custom.dll&quot;

Modified: branches/0.77-branch/installer/sections/tasclient.nsh
===================================================================
--- branches/0.77-branch/installer/sections/tasclient.nsh	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/installer/sections/tasclient.nsh	2008-09-23 15:51:10 UTC (rev 6447)
@@ -20,6 +20,7 @@
 
   SetOutPath &quot;$INSTDIR\lobby\var&quot;
   File &quot;..\Lobby\TASClient\lobby\var\groups.ini&quot;
+  File &quot;..\Lobby\TASClient\lobby\var\tips.txt&quot;
 
   Call GetDotNETVersion
   Pop $0

Modified: branches/0.77-branch/rts/CMakeLists.txt
===================================================================
--- branches/0.77-branch/rts/CMakeLists.txt	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/CMakeLists.txt	2008-09-23 15:51:10 UTC (rev 6447)
@@ -1,3 +1,5 @@
+ADD_DEFINITIONS(-DSTREFLOP_X87) # should be in ../CMakeLists.txt
+
 ### Spring defines
 SET(USE_MMGR FALSE CACHE BOOL &quot;Use memory manager?&quot;)
 if (USE_MMGR)
@@ -19,17 +21,6 @@
 	ADD_DEFINITIONS(-DSYNCDEBUG)
 endif (SYNCDEBUG)
 
-IF (UNIX)
-	ADD_DEFINITIONS(-DNO_AVI)
-ELSEIF (UNIX)
-	SET(NO_AVI FALSE CACHE BOOL &quot;Disable in-game video recording&quot;)
-	if (NO_AVI)
-		ADD_DEFINITIONS(-DNO_AVI)
-	endif (NO_AVI)
-ENDIF(UNIX)
-
-ADD_DEFINITIONS(-DSTREFLOP_X87)
-
 ### Find include directories and add platform specific libraries
 IF (MINGW)
 	FIND_PACKAGE(Win32Libs REQUIRED)

Modified: branches/0.77-branch/rts/Game/Game.cpp
===================================================================
--- branches/0.77-branch/rts/Game/Game.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Game/Game.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -503,7 +503,11 @@
 
 	net-&gt;loading = false;
 	thread.join();
+#ifdef USE_GML
+	logOutput.Print(&quot;Spring %s MT (%d threads)&quot;,VERSION_STRING, gmlThreadCount);
+#else
 	logOutput.Print(&quot;Spring %s&quot;,VERSION_STRING);
+#endif
 	//sending your playername to the server indicates that you are finished loading
 	net-&gt;Send(CBaseNetProtocol::Get().SendPlayerName(gu-&gt;myPlayerNum, p-&gt;name));
 

Modified: branches/0.77-branch/rts/Game/GameServer.cpp
===================================================================
--- branches/0.77-branch/rts/Game/GameServer.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Game/GameServer.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -432,7 +432,10 @@
 				if(newSpeed&lt;0.1f)
 					newSpeed=0.1f;
 				if(newSpeed!=internalSpeed)
+				{
+					internalSpeed = newSpeed;
 					Broadcast(CBaseNetProtocol::Get().SendInternalSpeed(newSpeed));
+				}
 			}
 		}
 	}

Modified: branches/0.77-branch/rts/Game/PlayerBase.cpp
===================================================================
--- branches/0.77-branch/rts/Game/PlayerBase.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Game/PlayerBase.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -1,7 +1,6 @@
 #include &quot;PlayerBase.h&quot;
 
 
-
 PlayerBase::PlayerBase() :
 team(0),
 rank(-1),

Modified: branches/0.77-branch/rts/Game/PlayerRoster.cpp
===================================================================
--- branches/0.77-branch/rts/Game/PlayerRoster.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Game/PlayerRoster.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -8,6 +8,7 @@
 #include &quot;PlayerRoster.h&quot;
 #include &quot;Player.h&quot;
 #include &quot;Team.h&quot;
+#include &lt;assert.h&gt;
 
 static int CompareAllies     (const void* a, const void* b);
 static int CompareTeamIDs    (const void* a, const void* b);

Modified: branches/0.77-branch/rts/Game/Team.h
===================================================================
--- branches/0.77-branch/rts/Game/Team.h	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Game/Team.h	2008-09-23 15:51:10 UTC (rev 6447)
@@ -6,7 +6,6 @@
 
 #include &lt;string&gt;
 #include &lt;vector&gt;
-#include &lt;set&gt;
 #include &lt;map&gt;
 #include &lt;list&gt;
 #include &quot;Platform/byteorder.h&quot;

Modified: branches/0.77-branch/rts/Game/UI/GameInfo.cpp
===================================================================
--- branches/0.77-branch/rts/Game/UI/GameInfo.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Game/UI/GameInfo.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -165,8 +165,13 @@
 	}
 	
 	labels.push_back(&quot;Game Version:&quot;);
+#ifdef USE_GML
+	char ver[64];
+	sprintf(ver, &quot;%s MT (%d threads)&quot;, VERSION_STRING, gmlThreadCount);
+	values.push_back(ver);
+#else
 	values.push_back(VERSION_STRING);
-
+#endif
 	labels.push_back(&quot;Game Speed:&quot;);
 	values.push_back(gs-&gt;speedFactor);
 

Modified: branches/0.77-branch/rts/Game/WaitCommandsAI.cpp
===================================================================
--- branches/0.77-branch/rts/Game/WaitCommandsAI.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Game/WaitCommandsAI.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -24,8 +24,8 @@
 #include &quot;UI/CursorIcons.h&quot;
 #include &quot;creg/STL_Map.h&quot;
 #include &quot;creg/STL_List.h&quot;
+#include &lt;assert.h&gt;
 
-
 CWaitCommandsAI waitCommandsAI;
 
 

Modified: branches/0.77-branch/rts/Lua/LuaOpenGL.cpp
===================================================================
--- branches/0.77-branch/rts/Lua/LuaOpenGL.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Lua/LuaOpenGL.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -1592,6 +1592,7 @@
 		} else {
 			int tmpLod = lua_toint(L, 3);
 			if (tmpLod &lt; 0) {
+				lod = 0;
 				useLOD = false;
 			} else {
 				lod = std::min(unit-&gt;lodCount - 1, (unsigned int)tmpLod);

Modified: branches/0.77-branch/rts/Lua/LuaRules.cpp
===================================================================
--- branches/0.77-branch/rts/Lua/LuaRules.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Lua/LuaRules.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -39,8 +39,8 @@
 #include &quot;System/LogOutput.h&quot;
 #include &quot;System/FileSystem/FileHandler.h&quot;
 #include &quot;System/Platform/FileSystem.h&quot;
+#include &lt;assert.h&gt;
 
-
 CLuaRules* luaRules = NULL;
 
 string CLuaRules::configString;

Modified: branches/0.77-branch/rts/Lua/LuaWeaponDefs.cpp
===================================================================
--- branches/0.77-branch/rts/Lua/LuaWeaponDefs.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Lua/LuaWeaponDefs.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -284,7 +284,6 @@
 		*((const struct WeaponDef::Visuals*)data);
 	lua_newtable(L);
 	HSTR_PUSH_STRING(L, &quot;modelName&quot;,   v.modelName);
-	HSTR_PUSH_NUMBER(L, &quot;renderType&quot;,  v.renderType);
 	HSTR_PUSH_NUMBER(L, &quot;colorR&quot;,      v.color.x);
 	HSTR_PUSH_NUMBER(L, &quot;colorG&quot;,      v.color.y);
 	HSTR_PUSH_NUMBER(L, &quot;colorB&quot;,      v.color.z);

Modified: branches/0.77-branch/rts/Map/Ground.cpp
===================================================================
--- branches/0.77-branch/rts/Map/Ground.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Map/Ground.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -12,6 +12,7 @@
 #include &quot;Sim/Projectiles/Projectile.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Sim/Misc/GeometricObjects.h&quot;
+#include &lt;assert.h&gt;
 
 //////////////////////////////////////////////////////////////////////
 // Construction/Destruction

Modified: branches/0.77-branch/rts/Map/SM3/terrain/Lightcalc.cpp
===================================================================
--- branches/0.77-branch/rts/Map/SM3/terrain/Lightcalc.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Map/SM3/terrain/Lightcalc.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -37,6 +37,7 @@
 
 #include &lt;SDL.h&gt;
 #include &lt;IL/il.h&gt;
+#include &lt;assert.h&gt;
 
 namespace terrain {
 

Modified: branches/0.77-branch/rts/Map/SM3/terrain/QuadRenderData.cpp
===================================================================
--- branches/0.77-branch/rts/Map/SM3/terrain/QuadRenderData.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Map/SM3/terrain/QuadRenderData.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -33,6 +33,7 @@
 #include &quot;TerrainBase.h&quot;
 #include &quot;TerrainNode.h&quot;
 #include &quot;TerrainTexture.h&quot;
+#include &lt;assert.h&gt;
 
 namespace terrain {
 	using namespace std;

Modified: branches/0.77-branch/rts/Map/SM3/terrain/Terrain.cpp
===================================================================
--- branches/0.77-branch/rts/Map/SM3/terrain/Terrain.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Map/SM3/terrain/Terrain.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -43,6 +43,7 @@
 #include &quot;TerrainTexture.h&quot;
 #include &quot;TerrainNode.h&quot;
 #include &quot;FileSystem/FileHandler.h&quot;
+#include &lt;assert.h&gt;
 
 // define this for big endian machines
 //#define SWAP_SHORT

Modified: branches/0.77-branch/rts/Map/SM3/terrain/TerrainTexEnvCombine.cpp
===================================================================
--- branches/0.77-branch/rts/Map/SM3/terrain/TerrainTexEnvCombine.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Map/SM3/terrain/TerrainTexEnvCombine.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -32,6 +32,7 @@
 
 #include &quot;TerrainTexture.h&quot;
 #include &quot;TerrainTexEnvCombine.h&quot;
+#include &lt;assert.h&gt;
 
 namespace terrain {
 

Modified: branches/0.77-branch/rts/Map/SM3/terrain/TerrainTextureGLSL.cpp
===================================================================
--- branches/0.77-branch/rts/Map/SM3/terrain/TerrainTextureGLSL.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Map/SM3/terrain/TerrainTextureGLSL.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -40,6 +40,7 @@
 
 #include &lt;fstream&gt;
 #include &lt;list&gt;
+#include &lt;assert.h&gt;
 
 namespace terrain {
 using namespace std;

Modified: branches/0.77-branch/rts/Map/SMF/BFGroundDrawer.cpp
===================================================================
--- branches/0.77-branch/rts/Map/SMF/BFGroundDrawer.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Map/SMF/BFGroundDrawer.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -197,6 +197,34 @@
 	ma = GetVertexArray();
 }
 
+
+inline void CBFGroundDrawer::FindRange(int &amp;xs, int &amp;xe, std::vector&lt;fline&gt; &amp;left, std::vector&lt;fline&gt; &amp;right, int y, int lod) {
+	int xt0, xt1;
+	std::vector&lt;fline&gt;::iterator fli;
+
+	for (fli = left.begin(); fli != left.end(); fli++) {
+		float xtf = fli-&gt;base / SQUARE_SIZE + fli-&gt;dir * y;
+		xt0 = ((int)xtf) / lod * lod - lod;
+		xt1 = ((int)(xtf + fli-&gt;dir * lod)) / lod * lod - lod;
+
+		if (xt0 &gt; xt1)
+			xt0 = xt1;
+		if (xt0 &gt; xs)
+			xs = xt0;
+	}
+	for (fli = right.begin(); fli != right.end(); fli++) {
+		float xtf = fli-&gt;base / SQUARE_SIZE + fli-&gt;dir * y;
+		xt0 = ((int)xtf) / lod * lod + lod;
+		xt1 = ((int)(xtf + fli-&gt;dir * lod)) / lod * lod + lod;
+
+		if (xt0 &lt; xt1)
+			xt0 = xt1;
+		if (xt0 &lt; xe)
+			xe = xt0;
+	}
+}
+
+
 #define CLAMP(i) std::max(0, std::min((i), maxIdx))
 
 inline void CBFGroundDrawer::DoDrawGroundRow(int bty, unsigned int overrideVP) {
@@ -215,9 +243,10 @@
 	std::vector&lt;fline&gt;::iterator fli;
 
 	//! only process the necessary big squares in the x direction
+	int bigSquareSizeY = bty * bigSquareSize;
 	for (fli = left.begin(); fli != left.end(); fli++) {
-		x0 = ((fli-&gt;base / SQUARE_SIZE + fli-&gt;dir *  (bty * bigSquareSize)                 ));
-		x1 = ((fli-&gt;base / SQUARE_SIZE + fli-&gt;dir * ((bty * bigSquareSize) + bigSquareSize)));
+		x0 = fli-&gt;base / SQUARE_SIZE + fli-&gt;dir * bigSquareSizeY;
+		x1 = x0 + fli-&gt;dir * bigSquareSize;
 
 		if (x0 &gt; x1)
 			x0 = x1;
@@ -228,8 +257,8 @@
 			sx = (int) x0;
 	}
 	for (fli = right.begin(); fli != right.end(); fli++) {
-		x0 = ((fli-&gt;base / SQUARE_SIZE + fli-&gt;dir *  (bty * bigSquareSize)                 )) + bigSquareSize;
-		x1 = ((fli-&gt;base / SQUARE_SIZE + fli-&gt;dir * ((bty * bigSquareSize) + bigSquareSize))) + bigSquareSize;
+		x0 = fli-&gt;base / SQUARE_SIZE + fli-&gt;dir * bigSquareSizeY + bigSquareSize;
+		x1 = x0 + fli-&gt;dir * bigSquareSize;
 
 		if (x0 &lt; x1)
 			x0 = x1;
@@ -240,6 +269,8 @@
 			ex = (int) x0;
 	}
 
+	float cx2 = cam2-&gt;pos.x / SQUARE_SIZE;
+	float cy2 = cam2-&gt;pos.z / SQUARE_SIZE;
 
 	for (int btx = sx; btx &lt; ex; ++btx) {
 		//! must be in drawLos mode or shadows must be off
@@ -258,9 +289,6 @@
 		ma-&gt;Initialize();
 
 		for (int lod = 1; lod &lt; neededLod; lod &lt;&lt;= 1) {
-			float cx2 = (cam2-&gt;pos.x / (SQUARE_SIZE));
-			float cy2 = (cam2-&gt;pos.z / (SQUARE_SIZE));
-
 			float oldcamxpart = 0.0f;
 			float oldcamypart = 0.0f;
 
@@ -275,23 +303,39 @@
 				int cyo = (cy / hlod) * hlod;
 				float cx2o = (cxo / lod) * lod;
 				float cy2o = (cyo / lod) * lod;
-				oldcamxpart = (cx2 - cx2o) / (lod);
-				oldcamypart = (cy2 - cy2o) / (lod);
+				oldcamxpart = (cx2 - cx2o) / lod;
+				oldcamypart = (cy2 - cy2o) / lod;
 			}
 
 			cx = (cx / lod) * lod;
 			cy = (cy / lod) * lod;
-			int ysquaremod = ((cy) % (dlod)) / lod;
-			int xsquaremod = ((cx) % (dlod)) / lod;
+			int ysquaremod = (cy % dlod) / lod;
+			int xsquaremod = (cx % dlod) / lod;
 
-			float camxpart = (cx2 - ((cx / (dlod)) * dlod)) / (dlod);
-			float camypart = (cy2 - ((cy / (dlod)) * dlod)) / (dlod);
+			float camxpart = (cx2 - ((cx / dlod) * dlod)) / dlod;
+			float camypart = (cy2 - ((cy / dlod) * dlod)) / dlod;
 
-			int minty =  bty      * bigSquareSize;
-			int maxty = (bty + 1) * bigSquareSize;
-			int mintx =  btx      * bigSquareSize;
-			int maxtx = (btx + 1) * bigSquareSize;
+			float mcxp=1.0f-camxpart;
+			float hcxp=0.5f*camxpart;
+			float hmcxp=0.5f*mcxp;
 
+			float mcyp=1.0f-camypart;
+			float hcyp=0.5f*camypart;
+			float hmcyp=0.5f*mcyp;
+
+			float mocxp=1.0f-oldcamxpart;
+			float hocxp=0.5f*oldcamxpart;
+			float hmocxp=0.5f*mocxp;
+
+			float mocyp=1.0f-oldcamypart;
+			float hocyp=0.5f*oldcamypart;
+			float hmocyp=0.5f*mocyp;
+
+			int minty = bty * bigSquareSize;
+			int maxty = minty + bigSquareSize;
+			int mintx = btx * bigSquareSize;
+			int maxtx = mintx + bigSquareSize;
+
 			int minly = cy + (-viewRadius + 3 - ysquaremod) * lod;
 			int maxly = cy + ( viewRadius - 1 - ysquaremod) * lod;
 			int minlx = cx + (-viewRadius + 3 - xsquaremod) * lod;
@@ -302,170 +346,163 @@
 			int ystart = max(minly, minty);
 			int yend   = min(maxly, maxty);
 
+			int vrhlod = viewRadius * hlod;
+
 			for (y = ystart; y &lt; yend; y += lod) {
 				int xs = xstart;
 				int xe = xend;
-				int xt0, xt1;
-				std::vector&lt;fline&gt;::iterator fli;
+				FindRange(xs, xe, left, right, y, lod);
 
+				int ylod = y + lod;
+				int yhlod = y + hlod;
 
-				for (fli = left.begin(); fli != left.end(); fli++) {
-					xt0 = ((int) (fli-&gt;base / (SQUARE_SIZE) + fli-&gt;dir *  y       )) / lod * lod - lod;
-					xt1 = ((int) (fli-&gt;base / (SQUARE_SIZE) + fli-&gt;dir * (y + lod))) / lod * lod - lod;
-
-					if (xt0 &gt; xt1) xt0 = xt1;
-					if (xt0 &gt; xs) xs = xt0;
-				}
-				for (fli = right.begin(); fli != right.end(); fli++) {
-					xt0 = ((int) (fli-&gt;base / (SQUARE_SIZE) + fli-&gt;dir *  y       )) / lod * lod + lod;
-					xt1 = ((int) (fli-&gt;base / (SQUARE_SIZE) + fli-&gt;dir * (y + lod))) / lod * lod + lod;
-
-					if (xt0 &lt; xt1) xt0 = xt1;
-					if (xt0 &lt; xe) xe = xt0;
-				}
-
 				int nloop=(xe-xs)/lod+1;
 				ma-&gt;EnlargeArrays(52*nloop, 14*nloop+1); //! includes one extra for final endstrip
 
+				int yhdx = y * heightDataX;
+				int ylhdx = yhdx + lod * heightDataX;
+				int yhhdx = yhdx + hlod * heightDataX;
+
 				for (x = xs; x &lt; xe; x += lod) {
+					int xlod = x + lod;
+					int xhlod = x + hlod;
 					//! info: all triangle quads start in the top left corner
 					if ((lod == 1) ||
-						(x &gt; (cx) + viewRadius * hlod) || (x &lt; (cx) - viewRadius * hlod) ||
-						(y &gt; (cy) + viewRadius * hlod) || (y &lt; (cy) - viewRadius * hlod)) {
+						(x &gt; cx + vrhlod) || (x &lt; cx - vrhlod) ||
+						(y &gt; cy + vrhlod) || (y &lt; cy - vrhlod)) {
 						//! normal terrain (all vertices in one LOD)
 						if (!inStrip) {
-							DrawVertexAQ(ma, x, y      );
-							DrawVertexAQ(ma, x, y + lod);
+							DrawVertexAQ(ma, x, y);
+							DrawVertexAQ(ma, x, ylod);
 							inStrip = true;
 						}
 
-						DrawVertexAQ(ma, x + lod, y      );
-						DrawVertexAQ(ma, x + lod, y + lod);
-					} else {
+						DrawVertexAQ(ma, xlod, y);
+						DrawVertexAQ(ma, xlod, ylod);
+					}
+					else {
 						//! border between 2 different LODs
-						if ((x &gt;= (cx) + viewRadius * hlod)) {
+						if ((x &gt;= cx + vrhlod)) {
 							//! lower LOD to the right
-							int idx1 = CLAMP((y       ) * heightDataX + x), idx1LOD = CLAMP(idx1 + lod), idx1HLOD = CLAMP(idx1 + hlod);
-							int idx2 = CLAMP((y +  lod) * heightDataX + x), idx2LOD = CLAMP(idx2 + lod), idx2HLOD = CLAMP(idx2 + hlod);
-							int idx3 = CLAMP((y + hlod) * heightDataX + x),                              idx3HLOD = CLAMP(idx3 + hlod);
-							float h1 = (heightData[idx1] + heightData[idx2   ]) * 0.5f * (1 - oldcamxpart) + heightData[idx3    ] * (oldcamxpart);
-							float h2 = (heightData[idx1] + heightData[idx1LOD]) * 0.5f * (1 - oldcamxpart) + heightData[idx1HLOD] * (oldcamxpart);
-							float h3 = (heightData[idx2] + heightData[idx1LOD]) * 0.5f * (1 - oldcamxpart) + heightData[idx3HLOD] * (oldcamxpart);
-							float h4 = (heightData[idx2] + heightData[idx2LOD]) * 0.5f * (1 - oldcamxpart) + heightData[idx2HLOD] * (oldcamxpart);
+							int idx1 = CLAMP(yhdx + x),  idx1LOD = CLAMP(idx1 + lod), idx1HLOD = CLAMP(idx1 + hlod);
+							int idx2 = CLAMP(ylhdx + x), idx2LOD = CLAMP(idx2 + lod), idx2HLOD = CLAMP(idx2 + hlod);
+							int idx3 = CLAMP(yhhdx + x),                              idx3HLOD = CLAMP(idx3 + hlod);
+							float h1 = (heightData[idx1] + heightData[idx2   ]) * hmocxp + heightData[idx3    ] * oldcamxpart;
+							float h2 = (heightData[idx1] + heightData[idx1LOD]) * hmocxp + heightData[idx1HLOD] * oldcamxpart;
+							float h3 = (heightData[idx2] + heightData[idx1LOD]) * hmocxp + heightData[idx3HLOD] * oldcamxpart;
+							float h4 = (heightData[idx2] + heightData[idx2LOD]) * hmocxp + heightData[idx2HLOD] * oldcamxpart;
 
 							if (inStrip) {
 								EndStripQ(ma);
 								inStrip = false;
 							}
 
-							DrawVertexAQ(ma, x,        y           );
-							DrawVertexAQ(ma, x,        y + hlod, h1);
-							DrawVertexAQ(ma, x + hlod, y,        h2);
-							DrawVertexAQ(ma, x + hlod, y + hlod, h3);
+							DrawVertexAQ(ma, x, y);
+							DrawVertexAQ(ma, x, yhlod, h1);
+							DrawVertexAQ(ma, xhlod, y, h2);
+							DrawVertexAQ(ma, xhlod, yhlod, h3);
 							EndStripQ(ma);
-							DrawVertexAQ(ma, x,        y + hlod, h1);
-							DrawVertexAQ(ma, x,        y +  lod    );
-							DrawVertexAQ(ma, x + hlod, y + hlod, h3);
-							DrawVertexAQ(ma, x + hlod, y +  lod, h4);
+							DrawVertexAQ(ma, x, yhlod, h1);
+							DrawVertexAQ(ma, x, ylod);
+							DrawVertexAQ(ma, xhlod, yhlod, h3);
+							DrawVertexAQ(ma, xhlod, ylod, h4);
 							EndStripQ(ma);
-							DrawVertexAQ(ma, x + hlod, y +  lod, h4);
-							DrawVertexAQ(ma, x +  lod, y +  lod    );
-							DrawVertexAQ(ma, x + hlod, y + hlod, h3);
-							DrawVertexAQ(ma, x +  lod, y           );
-							DrawVertexAQ(ma, x + hlod, y,        h2);
+							DrawVertexAQ(ma, xhlod, ylod, h4);
+							DrawVertexAQ(ma, xlod, ylod);
+							DrawVertexAQ(ma, xhlod, yhlod, h3);
+							DrawVertexAQ(ma, xlod, y);
+							DrawVertexAQ(ma, xhlod, y, h2);
 							EndStripQ(ma);
-						}else
-
-						if ((x &lt;= (cx) - viewRadius * hlod)) {
+						}
+						else if ((x &lt;= cx - vrhlod)) {
 							//! lower LOD to the left
-							int idx1 = CLAMP((y       ) * heightDataX + x), idx1LOD = CLAMP(idx1 + lod), idx1HLOD = CLAMP(idx1 + hlod);
-							int idx2 = CLAMP((y +  lod) * heightDataX + x), idx2LOD = CLAMP(idx2 + lod), idx2HLOD = CLAMP(idx2 + hlod);
-							int idx3 = CLAMP((y + hlod) * heightDataX + x), idx3LOD = CLAMP(idx3 + lod), idx3HLOD = CLAMP(idx3 + hlod);
-							float h1 = (heightData[idx1LOD] + heightData[idx2LOD]) * 0.5f * (oldcamxpart) + heightData[idx3LOD ] * (1 - oldcamxpart);
-							float h2 = (heightData[idx1   ] + heightData[idx1LOD]) * 0.5f * (oldcamxpart) + heightData[idx1HLOD] * (1 - oldcamxpart);
-							float h3 = (heightData[idx2   ] + heightData[idx1LOD]) * 0.5f * (oldcamxpart) + heightData[idx3HLOD] * (1 - oldcamxpart);
-							float h4 = (heightData[idx2   ] + heightData[idx2LOD]) * 0.5f * (oldcamxpart) + heightData[idx2HLOD] * (1 - oldcamxpart);
+							int idx1 = CLAMP(yhdx + x),  idx1LOD = CLAMP(idx1 + lod), idx1HLOD = CLAMP(idx1 + hlod);
+							int idx2 = CLAMP(ylhdx + x), idx2LOD = CLAMP(idx2 + lod), idx2HLOD = CLAMP(idx2 + hlod);
+							int idx3 = CLAMP(yhhdx + x), idx3LOD = CLAMP(idx3 + lod), idx3HLOD = CLAMP(idx3 + hlod);
+							float h1 = (heightData[idx1LOD] + heightData[idx2LOD]) * hocxp + heightData[idx3LOD ] * mocxp;
+							float h2 = (heightData[idx1   ] + heightData[idx1LOD]) * hocxp + heightData[idx1HLOD] * mocxp;
+							float h3 = (heightData[idx2   ] + heightData[idx1LOD]) * hocxp + heightData[idx3HLOD] * mocxp;
+							float h4 = (heightData[idx2   ] + heightData[idx2LOD]) * hocxp + heightData[idx2HLOD] * mocxp;
 
 							if (inStrip) {
 								EndStripQ(ma);
 								inStrip = false;
 							}
 
-							DrawVertexAQ(ma, x +  lod, y + hlod, h1);
-							DrawVertexAQ(ma, x +  lod, y           );
-							DrawVertexAQ(ma, x + hlod, y + hlod, h3);
-							DrawVertexAQ(ma, x + hlod, y,        h2);
+							DrawVertexAQ(ma, xlod, yhlod, h1);
+							DrawVertexAQ(ma, xlod, y);
+							DrawVertexAQ(ma, xhlod, yhlod, h3);
+							DrawVertexAQ(ma, xhlod, y, h2);
 							EndStripQ(ma);
-							DrawVertexAQ(ma, x +  lod, y +  lod    );
-							DrawVertexAQ(ma, x +  lod, y + hlod, h1);
-							DrawVertexAQ(ma, x + hlod, y +  lod, h4);
-							DrawVertexAQ(ma, x + hlod, y + hlod, h3);
+							DrawVertexAQ(ma, xlod, ylod);
+							DrawVertexAQ(ma, xlod, yhlod, h1);
+							DrawVertexAQ(ma, xhlod, ylod, h4);
+							DrawVertexAQ(ma, xhlod, yhlod, h3);
 							EndStripQ(ma);
-							DrawVertexAQ(ma, x + hlod, y,        h2);
-							DrawVertexAQ(ma, x,        y           );
-							DrawVertexAQ(ma, x + hlod, y + hlod, h3);
-							DrawVertexAQ(ma, x,        y +  lod    );
-							DrawVertexAQ(ma, x + hlod, y +  lod, h4);
+							DrawVertexAQ(ma, xhlod, y, h2);
+							DrawVertexAQ(ma, x, y);
+							DrawVertexAQ(ma, xhlod, yhlod, h3);
+							DrawVertexAQ(ma, x, ylod);
+							DrawVertexAQ(ma, xhlod, ylod, h4);
 							EndStripQ(ma);
 						}
 
-						if ((y &gt;= (cy) + viewRadius * hlod)) {
+						if ((y &gt;= cy + vrhlod)) {
 							//! lower LOD above
-							int idx1 = (y       ) * heightDataX + x, idx1LOD = CLAMP(idx1 + lod), idx1HLOD = CLAMP(idx1 + hlod);
-							int idx2 = (y +  lod) * heightDataX + x, idx2LOD = CLAMP(idx2 + lod);
-							int idx3 = (y + hlod) * heightDataX + x, idx3LOD = CLAMP(idx3 + lod), idx3HLOD = CLAMP(idx3 + hlod);
-							float h1 = (heightData[idx1   ] + heightData[idx1LOD]) * 0.5f * (1 - oldcamypart) + heightData[idx1HLOD] * (oldcamypart);
-							float h2 = (heightData[idx1   ] + heightData[idx2   ]) * 0.5f * (1 - oldcamypart) + heightData[idx3    ] * (oldcamypart);
-							float h3 = (heightData[idx2   ] + heightData[idx1LOD]) * 0.5f * (1 - oldcamypart) + heightData[idx3HLOD] * (oldcamypart);
-							float h4 = (heightData[idx2LOD] + heightData[idx1LOD]) * 0.5f * (1 - oldcamypart) + heightData[idx3LOD ] * (oldcamypart);
+							int idx1 = yhdx + x,  idx1LOD = CLAMP(idx1 + lod), idx1HLOD = CLAMP(idx1 + hlod);
+							int idx2 = ylhdx + x, idx2LOD = CLAMP(idx2 + lod);
+							int idx3 = yhhdx + x, idx3LOD = CLAMP(idx3 + lod), idx3HLOD = CLAMP(idx3 + hlod);
+							float h1 = (heightData[idx1   ] + heightData[idx1LOD]) * hmocyp + heightData[idx1HLOD] * oldcamypart;
+							float h2 = (heightData[idx1   ] + heightData[idx2   ]) * hmocyp + heightData[idx3    ] * oldcamypart;
+							float h3 = (heightData[idx2   ] + heightData[idx1LOD]) * hmocyp + heightData[idx3HLOD] * oldcamypart;
+							float h4 = (heightData[idx2LOD] + heightData[idx1LOD]) * hmocyp + heightData[idx3LOD ] * oldcamypart;
 
 							if (inStrip) {
 								EndStripQ(ma);
 								inStrip = false;
 							}
 
-							DrawVertexAQ(ma, x,        y           );
-							DrawVertexAQ(ma, x,        y + hlod, h2);
-							DrawVertexAQ(ma, x + hlod, y,        h1);
-							DrawVertexAQ(ma, x + hlod, y + hlod, h3);
-							DrawVertexAQ(ma, x +  lod, y           );
-							DrawVertexAQ(ma, x +  lod, y + hlod, h4);
+							DrawVertexAQ(ma, x, y);
+							DrawVertexAQ(ma, x, yhlod, h2);
+							DrawVertexAQ(ma, xhlod, y, h1);
+							DrawVertexAQ(ma, xhlod, yhlod, h3);
+							DrawVertexAQ(ma, xlod, y);
+							DrawVertexAQ(ma, xlod, yhlod, h4);
 							EndStripQ(ma);
-							DrawVertexAQ(ma, x,        y + hlod, h2);
-							DrawVertexAQ(ma, x,        y +  lod    );
-							DrawVertexAQ(ma, x + hlod, y + hlod, h3);
-							DrawVertexAQ(ma, x +  lod, y +  lod    );
-							DrawVertexAQ(ma, x +  lod, y + hlod, h4);
+							DrawVertexAQ(ma, x, yhlod, h2);
+							DrawVertexAQ(ma, x, ylod);
+							DrawVertexAQ(ma, xhlod, yhlod, h3);
+							DrawVertexAQ(ma, xlod, ylod);
+							DrawVertexAQ(ma, xlod, yhlod, h4);
 							EndStripQ(ma);
-						}else
-
-						if ((y &lt;= (cy) - viewRadius * hlod)) {
+						}
+						else if ((y &lt;= cy - vrhlod)) {
 							//! lower LOD beneath
-							int idx1 = CLAMP((y       ) * heightDataX + x), idx1LOD = CLAMP(idx1 + lod);
-							int idx2 = CLAMP((y +  lod) * heightDataX + x), idx2LOD = CLAMP(idx2 + lod), idx2HLOD = CLAMP(idx2 + hlod);
-							int idx3 = CLAMP((y + hlod) * heightDataX + x), idx3LOD = CLAMP(idx3 + lod), idx3HLOD = CLAMP(idx3 + hlod);
-							float h1 = (heightData[idx2   ] + heightData[idx2LOD]) * 0.5f * (oldcamypart) + heightData[idx2HLOD] * (1 - oldcamypart);
-							float h2 = (heightData[idx1   ] + heightData[idx2   ]) * 0.5f * (oldcamypart) + heightData[idx3    ] * (1 - oldcamypart);
-							float h3 = (heightData[idx2   ] + heightData[idx1LOD]) * 0.5f * (oldcamypart) + heightData[idx3HLOD] * (1 - oldcamypart);
-							float h4 = (heightData[idx2LOD] + heightData[idx1LOD]) * 0.5f * (oldcamypart) + heightData[idx3LOD ] * (1 - oldcamypart);
+							int idx1 = CLAMP(yhdx + x),  idx1LOD = CLAMP(idx1 + lod);
+							int idx2 = CLAMP(ylhdx + x), idx2LOD = CLAMP(idx2 + lod), idx2HLOD = CLAMP(idx2 + hlod);
+							int idx3 = CLAMP(yhhdx + x), idx3LOD = CLAMP(idx3 + lod), idx3HLOD = CLAMP(idx3 + hlod);
+							float h1 = (heightData[idx2   ] + heightData[idx2LOD]) * hocyp + heightData[idx2HLOD] * mocyp;
+							float h2 = (heightData[idx1   ] + heightData[idx2   ]) * hocyp + heightData[idx3    ] * mocyp;
+							float h3 = (heightData[idx2   ] + heightData[idx1LOD]) * hocyp + heightData[idx3HLOD] * mocyp;
+							float h4 = (heightData[idx2LOD] + heightData[idx1LOD]) * hocyp + heightData[idx3LOD ] * mocyp;
 
 							if (inStrip) {
 								EndStripQ(ma);
 								inStrip = false;
 							}
 
-							DrawVertexAQ(ma, x,        y + hlod, h2);
-							DrawVertexAQ(ma, x,        y +  lod    );
-							DrawVertexAQ(ma, x + hlod, y + hlod, h3);
-							DrawVertexAQ(ma, x + hlod, y +  lod, h1);
-							DrawVertexAQ(ma, x +  lod, y + hlod, h4);
-							DrawVertexAQ(ma, x +  lod, y +  lod    );
+							DrawVertexAQ(ma, x, yhlod, h2);
+							DrawVertexAQ(ma, x, ylod);
+							DrawVertexAQ(ma, xhlod, yhlod, h3);
+							DrawVertexAQ(ma, xhlod, ylod, h1);
+							DrawVertexAQ(ma, xlod, yhlod, h4);
+							DrawVertexAQ(ma, xlod, ylod);
 							EndStripQ(ma);
-							DrawVertexAQ(ma, x +  lod, y + hlod, h4);
-							DrawVertexAQ(ma, x +  lod, y           );
-							DrawVertexAQ(ma, x + hlod, y + hlod, h3);
-							DrawVertexAQ(ma, x,        y           );
-							DrawVertexAQ(ma, x,        y + hlod, h2);
+							DrawVertexAQ(ma, xlod, yhlod, h4);
+							DrawVertexAQ(ma, xlod, y);
+							DrawVertexAQ(ma, xhlod, yhlod, h3);
+							DrawVertexAQ(ma, x, y);
+							DrawVertexAQ(ma, x, yhlod, h2);
 							EndStripQ(ma);
 						}
 					}
@@ -482,33 +519,31 @@
 			int nloop=(yed-yst)/lod+1;
 			ma-&gt;EnlargeArrays(8*nloop, 2*nloop);
 
-			// rita yttre begr?snings yta mot n?ta lod
+			//! rita yttre begr?snings yta mot n?ta lod
 			if (maxlx &lt; maxtx &amp;&amp; maxlx &gt;= mintx) {
 				x = maxlx;
+				int xlod = x + lod;
 				for (y = yst; y &lt; yed; y += lod) {
-					DrawVertexAQ(ma, x, y      );
+					DrawVertexAQ(ma, x, y);
 					DrawVertexAQ(ma, x, y + lod);
 
-					if (y % (dlod)) {
+					if (y % dlod) {
 						int idx1 = CLAMP((y      ) * heightDataX + x), idx1LOD = CLAMP(idx1 + lod);
 						int idx2 = CLAMP((y + lod) * heightDataX + x), idx2LOD = CLAMP(idx2 + lod);
 						int idx3 = CLAMP((y - lod) * heightDataX + x), idx3LOD = CLAMP(idx3 + lod);
-						float h = ((heightData[idx3LOD] +
-							heightData[idx2LOD]) * 0.5f) * (1 - camxpart) +
-							heightData[idx1LOD] * (camxpart);
+						float h = (heightData[idx3LOD] + heightData[idx2LOD]) * hmcxp +	heightData[idx1LOD] * camxpart;
 
-						DrawVertexAQ(ma, x + lod, y,       h);
-						DrawVertexAQ(ma, x + lod, y + lod   );
-					} else {
+						DrawVertexAQ(ma, xlod, y, h);
+						DrawVertexAQ(ma, xlod, y + lod);
+					}
+					else {
 						int idx1 = CLAMP((y       ) * heightDataX + x), idx1LOD = CLAMP(idx1 + lod);
 						int idx2 = CLAMP((y +  lod) * heightDataX + x), idx2LOD = CLAMP(idx2 + lod);
 						int idx3 = CLAMP((y + dlod) * heightDataX + x), idx3LOD = CLAMP(idx3 + lod);
-						float h = (heightData[idx1LOD] +
-							heightData[idx3LOD]) * 0.5f * (1 - camxpart) +
-							heightData[idx2LOD] * (camxpart);
+						float h = (heightData[idx1LOD] + heightData[idx3LOD]) * hmcxp + heightData[idx2LOD] * camxpart;
 
-						DrawVertexAQ(ma, x + lod, y);
-						DrawVertexAQ(ma, x + lod, y + lod, h);
+						DrawVertexAQ(ma, xlod, y);
+						DrawVertexAQ(ma, xlod, y + lod, h);
 					}
 					EndStripQ(ma);
 				}
@@ -516,30 +551,28 @@
 
 			if (minlx &gt; mintx &amp;&amp; minlx &lt; maxtx) {
 				x = minlx - lod;
+				int xlod = x + lod;
 				for (y = yst; y &lt; yed; y += lod) {
-					if (y % (dlod)) {
+					if (y % dlod) {
 						int idx1 = CLAMP((y      ) * heightDataX + x);
 						int idx2 = CLAMP((y + lod) * heightDataX + x);
 						int idx3 = CLAMP((y - lod) * heightDataX + x);
-						float h = ((heightData[idx3] +
-							heightData[idx2]) * 0.5f) * (camxpart) +
-							heightData[idx1] * (1 - camxpart);
+						float h = (heightData[idx3] + heightData[idx2]) * hcxp + heightData[idx1] * mcxp;
 
-						DrawVertexAQ(ma, x, y,       h);
-						DrawVertexAQ(ma, x, y + lod   );
-					} else {
+						DrawVertexAQ(ma, x, y, h);
+						DrawVertexAQ(ma, x, y + lod);
+					}
+					else {
 						int idx1 = CLAMP((y       ) * heightDataX + x);
 						int idx2 = CLAMP((y +  lod) * heightDataX + x);
 						int idx3 = CLAMP((y + dlod) * heightDataX + x);
-						float h = (heightData[idx1] +
-							heightData[idx3]) * 0.5f * (camxpart) +
-							heightData[idx2] * (1 - camxpart);
+						float h = (heightData[idx1] + heightData[idx3]) * hcxp + heightData[idx2] * mcxp;
 
 						DrawVertexAQ(ma, x, y);
 						DrawVertexAQ(ma, x, y + lod, h);
 					}
-					DrawVertexAQ(ma, x + lod, y      );
-					DrawVertexAQ(ma, x + lod, y + lod);
+					DrawVertexAQ(ma, xlod, y);
+					DrawVertexAQ(ma, xlod, y + lod);
 					EndStripQ(ma);
 				}
 			}
@@ -548,58 +581,36 @@
 				y = maxly;
 				int xs = max(xstart - lod, mintx);
 				int xe = min(xend + lod,   maxtx);
-				int xt0, xt1;
-				std::vector&lt;fline&gt;::iterator fli;
+				FindRange(xs, xe, left, right, y, lod);
 
-
-				for (fli = left.begin(); fli != left.end(); fli++) {
-					xt0 = ((int) (fli-&gt;base / (SQUARE_SIZE) + fli-&gt;dir *  y       )) / lod * lod - lod;
-					xt1 = ((int) (fli-&gt;base / (SQUARE_SIZE) + fli-&gt;dir * (y + lod))) / lod * lod - lod;
-
-					if (xt0 &gt; xt1) xt0 = xt1;
-					if (xt0 &gt; xs) xs = xt0;
-				}
-				for (fli = right.begin(); fli != right.end(); fli++) {
-					xt0 = ((int) (fli-&gt;base / (SQUARE_SIZE) + fli-&gt;dir *  y       )) / lod * lod + lod;
-					xt1 = ((int) (fli-&gt;base / (SQUARE_SIZE) + fli-&gt;dir * (y + lod))) / lod * lod + lod;
-
-					if (xt0 &lt; xt1) xt0 = xt1;
-					if (xt0 &lt; xe) xe = xt0;
-				}
-
-
 				if (xs &lt; xe) {
 					x = xs;
-					int nloop=(xe-xs)/lod+2; // one extra for if statment
+					int ylod = y + lod;
+					int nloop=(xe-xs)/lod+2; //! one extra for if statment
 					ma-&gt;EnlargeArrays(2*nloop, 1);
-					if (x % (dlod)) {
-						int idx2     = CLAMP((y + lod) * heightDataX + x),
-							idx2PLOD = CLAMP(idx2 + lod),
-							idx2MLOD = CLAMP(idx2 - lod);
-						float h = ((heightData[idx2MLOD] +
-							heightData[idx2PLOD]) * 0.5f) * (1 - camypart) +
-							heightData[idx2    ] * (camypart);
+					int ylhdx=(y + lod) * heightDataX;
+					if (x % dlod) {
+						int idx2 = CLAMP(ylhdx + x), idx2PLOD = CLAMP(idx2 + lod), idx2MLOD = CLAMP(idx2 - lod);
+						float h = (heightData[idx2MLOD] + heightData[idx2PLOD]) * hmcyp + heightData[idx2] * camypart;
 
 						DrawVertexAQ(ma, x, y);
-						DrawVertexAQ(ma, x, y + lod, h);
-					} else {
-						DrawVertexAQ(ma, x, y      );
-						DrawVertexAQ(ma, x, y + lod);
+						DrawVertexAQ(ma, x, ylod, h);
 					}
+					else {
+						DrawVertexAQ(ma, x, y);
+						DrawVertexAQ(ma, x, ylod);
+					}
 					for (x = xs; x &lt; xe; x += lod) {
-						if (x % (dlod)) {
-							DrawVertexAQ(ma, x + lod, y      );
-							DrawVertexAQ(ma, x + lod, y + lod);
-						} else {
-							int idx2      = CLAMP((y + lod) * heightDataX + x),
-								idx2PLOD  = CLAMP(idx2 +  lod),
-								idx2PLOD2 = CLAMP(idx2 + dlod);
-							float h = (heightData[idx2PLOD2] +
-								heightData[idx2     ]) * 0.5f * (1 - camypart) +
-								heightData[idx2PLOD ] * (camypart);
+						if (x % dlod) {
+							DrawVertexAQ(ma, x + lod, y);
+							DrawVertexAQ(ma, x + lod, ylod);
+						}
+						else {
+							int idx2 = CLAMP(ylhdx + x), idx2PLOD  = CLAMP(idx2 +  lod), idx2PLOD2 = CLAMP(idx2 + dlod);
+							float h = (heightData[idx2PLOD2] + heightData[idx2]) * hmcyp + heightData[idx2PLOD] * camypart;
 
 							DrawVertexAQ(ma, x + lod, y);
-							DrawVertexAQ(ma, x + lod, y + lod, h);
+							DrawVertexAQ(ma, x + lod, ylod, h);
 						}
 					}
 					EndStripQ(ma);
@@ -610,59 +621,37 @@
 				y = minly - lod;
 				int xs = max(xstart - lod, mintx);
 				int xe = min(xend + lod,   maxtx);
-				int xt0, xt1;
-				std::vector&lt;fline&gt;::iterator fli;
+				FindRange(xs, xe, left, right, y, lod);
 
-
-				for (fli = left.begin(); fli != left.end(); fli++) {
-					xt0 = ((int) (fli-&gt;base / (SQUARE_SIZE) + fli-&gt;dir *  y       )) / lod * lod - lod;
-					xt1 = ((int) (fli-&gt;base / (SQUARE_SIZE) + fli-&gt;dir * (y + lod))) / lod * lod - lod;
-
-					if (xt0 &gt; xt1) xt0 = xt1;
-					if (xt0 &gt; xs) xs = xt0;
-				}
-				for (fli = right.begin(); fli != right.end(); fli++) {
-					xt0 = ((int) (fli-&gt;base / (SQUARE_SIZE) + fli-&gt;dir *  y       )) / lod * lod + lod;
-					xt1 = ((int) (fli-&gt;base / (SQUARE_SIZE) + fli-&gt;dir * (y + lod))) / lod * lod + lod;
-
-					if (xt0 &lt; xt1) xt0 = xt1;
-					if (xt0 &lt; xe) xe = xt0;
-				}
-
-
 				if (xs &lt; xe) {
 					x = xs;
-					int nloop=(xe-xs)/lod+2; // one extra for if statment
+					int ylod = y + lod;
+					int nloop=(xe-xs)/lod+2; //! one extra for if statment
 					ma-&gt;EnlargeArrays(2*nloop, 1);
-					if (x % (dlod)) {
-						int idx1     = CLAMP((y) * heightDataX + x),
-							idx1PLOD = CLAMP(idx1 + lod),
-							idx1MLOD = CLAMP(idx1 - lod);
-						float h = ((heightData[idx1MLOD] +
-							heightData[idx1PLOD]) * 0.5f) * (camypart) +
-							heightData[idx1    ] * (1 - camypart);
+					int yhdx=y * heightDataX;
+					if (x % dlod) {
+						int idx1 = CLAMP(yhdx + x), idx1PLOD = CLAMP(idx1 + lod), idx1MLOD = CLAMP(idx1 - lod);
+						float h = (heightData[idx1MLOD] + heightData[idx1PLOD]) * hcyp + heightData[idx1] * mcyp;
 
-						DrawVertexAQ(ma, x, y,       h);
-						DrawVertexAQ(ma, x, y + lod   );
-					} else {
-						DrawVertexAQ(ma, x, y      );
-						DrawVertexAQ(ma, x, y + lod);
+						DrawVertexAQ(ma, x, y, h);
+						DrawVertexAQ(ma, x, ylod);
 					}
+					else {
+						DrawVertexAQ(ma, x, y);
+						DrawVertexAQ(ma, x, ylod);
+					}
 
 					for (x = xs; x &lt; xe; x+= lod) {
-						if (x % (dlod)) {
-							DrawVertexAQ(ma, x + lod, y      );
-							DrawVertexAQ(ma, x + lod, y + lod);
-						} else {
-							int idx1      = CLAMP((y) * heightDataX + x),
-								idx1PLOD  = CLAMP(idx1 +  lod),
-								idx1PLOD2 = CLAMP(idx1 + dlod);
-							float h = (heightData[idx1PLOD2] +
-								heightData[idx1     ]) * 0.5f * (camypart) +
-								heightData[idx1PLOD ] * (1 - camypart);
+						if (x % dlod) {
+							DrawVertexAQ(ma, x + lod, y);
+							DrawVertexAQ(ma, x + lod, ylod);
+						}
+						else {
+							int idx1 = CLAMP(yhdx + x), idx1PLOD  = CLAMP(idx1 +  lod), idx1PLOD2 = CLAMP(idx1 + dlod);
+							float h = (heightData[idx1PLOD2] + heightData[idx1]) * hcyp + heightData[idx1PLOD] * mcyp;
 
-							DrawVertexAQ(ma, x + lod, y,       h);
-							DrawVertexAQ(ma, x + lod, y + lod   );
+							DrawVertexAQ(ma, x + lod, y, h);
+							DrawVertexAQ(ma, x + lod, ylod);
 						}
 					}
 					EndStripQ(ma);
@@ -673,7 +662,6 @@
 	}
 }
 
-
 void CBFGroundDrawer::Draw(bool drawWaterReflection, bool drawUnitReflection, unsigned int overrideVP)
 {
 	if (wireframe) {
@@ -801,8 +789,8 @@
 	int x,y;
 	int lod=1&lt;&lt;nlod;
 
-	float cx2 = (camera-&gt;pos.x / (SQUARE_SIZE));
-	float cy2 = (camera-&gt;pos.z / (SQUARE_SIZE));
+	float cx2 = camera-&gt;pos.x / SQUARE_SIZE;
+	float cy2 = camera-&gt;pos.z / SQUARE_SIZE;
 
 	float oldcamxpart = 0.0f;
 	float oldcamypart = 0.0f;
@@ -817,17 +805,17 @@
 		int cyo = (cy / hlod) * hlod;
 		float cx2o = (cxo / lod) * lod;
 		float cy2o = (cyo / lod) * lod;
-		oldcamxpart = (cx2 - cx2o) / (lod);
-		oldcamypart = (cy2 - cy2o) / (lod);
+		oldcamxpart = (cx2 - cx2o) / lod;
+		oldcamypart = (cy2 - cy2o) / lod;
 	}
 
 	cx = (cx / lod) * lod;
 	cy = (cy / lod) * lod;
-	int ysquaremod = ((cy) % (dlod)) / lod;
-	int xsquaremod = ((cx) % (dlod)) / lod;
+	int ysquaremod = (cy % dlod) / lod;
+	int xsquaremod = (cx % dlod) / lod;
 
-	float camxpart = (cx2 - ((cx / (dlod)) * dlod)) / (dlod);
-	float camypart = (cy2 - ((cy / (dlod)) * dlod)) / (dlod);
+	float camxpart = (cx2 - (cx / dlod) * dlod) / dlod;
+	float camypart = (cy2 - (cy / dlod) * dlod) / dlod;
 
 	int minty = 0;
 	int maxty = gs-&gt;mapy;
@@ -844,124 +832,156 @@
 	int ystart = max(minly, minty);
 	int yend   = min(maxly, maxty);
 
+	int lhdx=lod*heightDataX;
+	int hhdx=hlod*heightDataX;
+	int dhdx=dlod*heightDataX;
+
+	float mcxp=1.0f-camxpart;
+	float hcxp=0.5f*camxpart;
+	float hmcxp=0.5f*mcxp;
+
+	float mcyp=1.0f-camypart;
+	float hcyp=0.5f*camypart;
+	float hmcyp=0.5f*mcyp;
+
+	float mocxp=1.0f-oldcamxpart;
+	float hocxp=0.5f*oldcamxpart;
+	float hmocxp=0.5f*mocxp;
+
+	float mocyp=1.0f-oldcamypart;
+	float hocyp=0.5f*oldcamypart;
+	float hmocyp=0.5f*mocyp;
+
+	int vrhlod = viewRadius * hlod;
+
 	for (y = ystart; y &lt; yend; y += lod) {
 		int xs = xstart;
 		int xe = xend;
+		int ylod = y + lod;
+		int yhlod = y + hlod;
 
 		int nloop=(xe-xs)/lod+1;
-		ma-&gt;EnlargeArrays(52*nloop, 14*nloop+1); // includes one extra for final endstrip
+		ma-&gt;EnlargeArrays(52*nloop, 14*nloop+1); //! includes one extra for final endstrip
+		int ydx=y*heightDataX;
 		for (x = xs; x &lt; xe; x += lod) {
+			int xlod = x + lod;
+			int xhlod = x + hlod;
 			if ((lod == 1) ||
-				(x &gt; (cx) + viewRadius * hlod) || (x &lt; (cx) - viewRadius * hlod) ||
-				(y &gt; (cy) + viewRadius * hlod) || (y &lt; (cy) - viewRadius * hlod)) {
+				(x &gt; cx + vrhlod) || (x &lt; cx - vrhlod) ||
+				(y &gt; cy + vrhlod) || (y &lt; cy - vrhlod)) {
 					if (!inStrip) {
 						DrawVertexAQ(ma, x, y      );
-						DrawVertexAQ(ma, x, y + lod);
+						DrawVertexAQ(ma, x, ylod);
 						inStrip = true;
 					}
-					DrawVertexAQ(ma, x + lod, y      );
-					DrawVertexAQ(ma, x + lod, y + lod);
-			} else {  //inre begr?sning mot f?eg?nde lod
-				if((x&gt;=(cx)+viewRadius*hlod)){
-					float h1=(heightData[(y)*heightDataX+x]+heightData[(y+lod)*heightDataX+x])*0.5f*(1-oldcamxpart)+heightData[(y+hlod)*heightDataX+x]*(oldcamxpart);
-					float h2=(heightData[(y)*heightDataX+x]+heightData[(y)*heightDataX+x+lod])*0.5f*(1-oldcamxpart)+heightData[(y)*heightDataX+x+hlod]*(oldcamxpart);
-					float h3=(heightData[(y+lod)*heightDataX+x]+heightData[(y)*heightDataX+x+lod])*0.5f*(1-oldcamxpart)+heightData[(y+hlod)*heightDataX+x+hlod]*(oldcamxpart);
-					float h4=(heightData[(y+lod)*heightDataX+x]+heightData[(y+lod)*heightDataX+x+lod])*0.5f*(1-oldcamxpart)+heightData[(y+lod)*heightDataX+x+hlod]*(oldcamxpart);
+					DrawVertexAQ(ma, xlod, y      );
+					DrawVertexAQ(ma, xlod, ylod);
+			} 
+			else {  //! inre begr?sning mot f?eg?nde lod
+				int yhdx=ydx+x;
+				int ylhdx=yhdx+lhdx;
+				int yhhdx=yhdx+hhdx;
 
+				if(x&gt;=cx+vrhlod){
+					float h1=(heightData[yhdx ] + heightData[ylhdx    ]) * hmocxp + heightData[yhhdx     ] * oldcamxpart;
+					float h2=(heightData[yhdx ] + heightData[yhdx+lod ]) * hmocxp + heightData[yhdx+hlod ] * oldcamxpart;
+					float h3=(heightData[ylhdx] + heightData[yhdx+lod ]) * hmocxp + heightData[yhhdx+hlod] * oldcamxpart;
+					float h4=(heightData[ylhdx] + heightData[ylhdx+lod]) * hmocxp + heightData[ylhdx+hlod] * oldcamxpart;
+
 					if(inStrip){
 						EndStripQ(ma);
 						inStrip=false;
 					}
 					DrawVertexAQ(ma, x,y);
-					DrawVertexAQ(ma, x,y+hlod,h1);
-					DrawVertexAQ(ma, x+hlod,y,h2);
-					DrawVertexAQ(ma, x+hlod,y+hlod,h3);
+					DrawVertexAQ(ma, x,yhlod,h1);
+					DrawVertexAQ(ma, xhlod,y,h2);
+					DrawVertexAQ(ma, xhlod,yhlod,h3);
 					EndStripQ(ma);
-					DrawVertexAQ(ma, x,y+hlod,h1);
-					DrawVertexAQ(ma, x,y+lod);
-					DrawVertexAQ(ma, x+hlod,y+hlod,h3);
-					DrawVertexAQ(ma, x+hlod,y+lod,h4);
+					DrawVertexAQ(ma, x,yhlod,h1);
+					DrawVertexAQ(ma, x,ylod);
+					DrawVertexAQ(ma, xhlod,yhlod,h3);
+					DrawVertexAQ(ma, xhlod,ylod,h4);
 					EndStripQ(ma);
-					DrawVertexAQ(ma, x+hlod,y+lod,h4);
-					DrawVertexAQ(ma, x+lod,y+lod);
-					DrawVertexAQ(ma, x+hlod,y+hlod,h3);
-					DrawVertexAQ(ma, x+lod,y);
-					DrawVertexAQ(ma, x+hlod,y,h2);
+					DrawVertexAQ(ma, xhlod,ylod,h4);
+					DrawVertexAQ(ma, xlod,ylod);
+					DrawVertexAQ(ma, xhlod,yhlod,h3);
+					DrawVertexAQ(ma, xlod,y);
+					DrawVertexAQ(ma, xhlod,y,h2);
 					EndStripQ(ma);
 				}
-				if((x&lt;=(cx)-viewRadius*hlod)){
-					float h1=(heightData[(y)*heightDataX+x+lod]+heightData[(y+lod)*heightDataX+x+lod])*0.5f*(oldcamxpart)+heightData[(y+hlod)*heightDataX+x+lod]*(1-oldcamxpart);
-					float h2=(heightData[(y)*heightDataX+x]+heightData[(y)*heightDataX+x+lod])*0.5f*(oldcamxpart)+heightData[(y)*heightDataX+x+hlod]*(1-oldcamxpart);
-					float h3=(heightData[(y+lod)*heightDataX+x]+heightData[(y)*heightDataX+x+lod])*0.5f*(oldcamxpart)+heightData[(y+hlod)*heightDataX+x+hlod]*(1-oldcamxpart);
-					float h4=(heightData[(y+lod)*heightDataX+x]+heightData[(y+lod)*heightDataX+x+lod])*0.5f*(oldcamxpart)+heightData[(y+lod)*heightDataX+x+hlod]*(1-oldcamxpart);
+				if(x&lt;=cx-vrhlod){
+					float h1=(heightData[yhdx+lod] + heightData[ylhdx+lod]) * hocxp + heightData[yhhdx+lod ] * mocxp;
+					float h2=(heightData[yhdx    ] + heightData[yhdx+lod ]) * hocxp + heightData[yhdx+hlod ] * mocxp;
+					float h3=(heightData[ylhdx   ] + heightData[yhdx+lod ]) * hocxp + heightData[yhhdx+hlod] * mocxp;
+					float h4=(heightData[ylhdx   ] + heightData[ylhdx+lod]) * hocxp + heightData[ylhdx+hlod] * mocxp;
 
 					if(inStrip){
 						EndStripQ(ma);
 						inStrip=false;
 					}
-					DrawVertexAQ(ma, x+lod,y+hlod,h1);
-					DrawVertexAQ(ma, x+lod,y);
-					DrawVertexAQ(ma, x+hlod,y+hlod,h3);
-					DrawVertexAQ(ma, x+hlod,y,h2);
+					DrawVertexAQ(ma, xlod,yhlod,h1);
+					DrawVertexAQ(ma, xlod,y);
+					DrawVertexAQ(ma, xhlod,yhlod,h3);
+					DrawVertexAQ(ma, xhlod,y,h2);
 					EndStripQ(ma);
-					DrawVertexAQ(ma, x+lod,y+lod);
-					DrawVertexAQ(ma, x+lod,y+hlod,h1);
-					DrawVertexAQ(ma, x+hlod,y+lod,h4);
-					DrawVertexAQ(ma, x+hlod,y+hlod,h3);
+					DrawVertexAQ(ma, xlod,ylod);
+					DrawVertexAQ(ma, xlod,yhlod,h1);
+					DrawVertexAQ(ma, xhlod,ylod,h4);
+					DrawVertexAQ(ma, xhlod,yhlod,h3);
 					EndStripQ(ma);
-					DrawVertexAQ(ma, x+hlod,y,h2);
+					DrawVertexAQ(ma, xhlod,y,h2);
 					DrawVertexAQ(ma, x,y);
-					DrawVertexAQ(ma, x+hlod,y+hlod,h3);
-					DrawVertexAQ(ma, x,y+lod);
-					DrawVertexAQ(ma, x+hlod,y+lod,h4);
+					DrawVertexAQ(ma, xhlod,yhlod,h3);
+					DrawVertexAQ(ma, x,ylod);
+					DrawVertexAQ(ma, xhlod,ylod,h4);
 					EndStripQ(ma);
 				}
-				if((y&gt;=(cy)+viewRadius*hlod)){
-					float h1=(heightData[(y)*heightDataX+x]+heightData[(y)*heightDataX+x+lod])*0.5f*(1-oldcamypart)+heightData[(y)*heightDataX+x+hlod]*(oldcamypart);
-					float h2=(heightData[(y)*heightDataX+x]+heightData[(y+lod)*heightDataX+x])*0.5f*(1-oldcamypart)+heightData[(y+hlod)*heightDataX+x]*(oldcamypart);
-					float h3=(heightData[(y+lod)*heightDataX+x]+heightData[(y)*heightDataX+x+lod])*0.5f*(1-oldcamypart)+heightData[(y+hlod)*heightDataX+x+hlod]*(oldcamypart);
-					float h4=(heightData[(y+lod)*heightDataX+x+lod]+heightData[(y)*heightDataX+x+lod])*0.5f*(1-oldcamypart)+heightData[(y+hlod)*heightDataX+x+lod]*(oldcamypart);
+				if(y&gt;=cy+vrhlod){
+					float h1=(heightData[yhdx     ] + heightData[yhdx+lod]) * hmocyp + heightData[yhdx+hlod ] * oldcamypart;
+					float h2=(heightData[yhdx     ] + heightData[ylhdx   ]) * hmocyp + heightData[yhhdx     ] * oldcamypart;
+					float h3=(heightData[ylhdx    ] + heightData[yhdx+lod]) * hmocyp + heightData[yhhdx+hlod] * oldcamypart;
+					float h4=(heightData[ylhdx+lod] + heightData[yhdx+lod]) * hmocyp + heightData[yhhdx+lod ] * oldcamypart;
 
 					if(inStrip){
 						EndStripQ(ma);
 						inStrip=false;
 					}
 					DrawVertexAQ(ma, x,y);
-					DrawVertexAQ(ma, x,y+hlod,h2);
-					DrawVertexAQ(ma, x+hlod,y,h1);
-					DrawVertexAQ(ma, x+hlod,y+hlod,h3);
-					DrawVertexAQ(ma, x+lod,y);
-					DrawVertexAQ(ma, x+lod,y+hlod,h4);
+					DrawVertexAQ(ma, x,yhlod,h2);
+					DrawVertexAQ(ma, xhlod,y,h1);
+					DrawVertexAQ(ma, xhlod,yhlod,h3);
+					DrawVertexAQ(ma, xlod,y);
+					DrawVertexAQ(ma, xlod,yhlod,h4);
 					EndStripQ(ma);
-					DrawVertexAQ(ma, x,y+hlod,h2);
-					DrawVertexAQ(ma, x,y+lod);
-					DrawVertexAQ(ma, x+hlod,y+hlod,h3);
-					DrawVertexAQ(ma, x+lod,y+lod);
-					DrawVertexAQ(ma, x+lod,y+hlod,h4);
+					DrawVertexAQ(ma, x,yhlod,h2);
+					DrawVertexAQ(ma, x,ylod);
+					DrawVertexAQ(ma, xhlod,yhlod,h3);
+					DrawVertexAQ(ma, xlod,ylod);
+					DrawVertexAQ(ma, xlod,yhlod,h4);
 					EndStripQ(ma);
 				}
-				if((y&lt;=(cy)-viewRadius*hlod)){
-					float h1=(heightData[(y+lod)*heightDataX+x]+heightData[(y+lod)*heightDataX+x+lod])*0.5f*(oldcamypart)+heightData[(y+lod)*heightDataX+x+hlod]*(1-oldcamypart);
-					float h2=(heightData[(y)*heightDataX+x]+heightData[(y+lod)*heightDataX+x])*0.5f*(oldcamypart)+heightData[(y+hlod)*heightDataX+x]*(1-oldcamypart);
-					float h3=(heightData[(y+lod)*heightDataX+x]+heightData[(y)*heightDataX+x+lod])*0.5f*(oldcamypart)+heightData[(y+hlod)*heightDataX+x+hlod]*(1-oldcamypart);
-					float h4=(heightData[(y+lod)*heightDataX+x+lod]+heightData[(y)*heightDataX+x+lod])*0.5f*(oldcamypart)+heightData[(y+hlod)*heightDataX+x+lod]*(1-oldcamypart);
+				if(y&lt;=cy-vrhlod){
+					float h1=(heightData[ylhdx    ] + heightData[ylhdx+lod]) * hocyp + heightData[ylhdx+hlod] * mocyp;
+					float h2=(heightData[yhdx     ] + heightData[ylhdx    ]) * hocyp + heightData[yhhdx     ] * mocyp;
+					float h3=(heightData[ylhdx    ] + heightData[yhdx+lod ]) * hocyp + heightData[yhhdx+hlod] * mocyp;
+					float h4=(heightData[ylhdx+lod] + heightData[yhdx+lod ]) * hocyp + heightData[yhhdx+lod ] * mocyp;
 
 					if(inStrip){
 						EndStripQ(ma);
 						inStrip=false;
 					}
-					DrawVertexAQ(ma, x,y+hlod,h2);
-					DrawVertexAQ(ma, x,y+lod);
-					DrawVertexAQ(ma, x+hlod,y+hlod,h3);
-					DrawVertexAQ(ma, x+hlod,y+lod,h1);
-					DrawVertexAQ(ma, x+lod,y+hlod,h4);
-					DrawVertexAQ(ma, x+lod,y+lod);
+					DrawVertexAQ(ma, x,yhlod,h2);
+					DrawVertexAQ(ma, x,ylod);
+					DrawVertexAQ(ma, xhlod,yhlod,h3);
+					DrawVertexAQ(ma, xhlod,ylod,h1);
+					DrawVertexAQ(ma, xlod,yhlod,h4);
+					DrawVertexAQ(ma, xlod,ylod);
 					EndStripQ(ma);
-					DrawVertexAQ(ma, x+lod,y+hlod,h4);
-					DrawVertexAQ(ma, x+lod,y);
-					DrawVertexAQ(ma, x+hlod,y+hlod,h3);
+					DrawVertexAQ(ma, xlod,yhlod,h4);
+					DrawVertexAQ(ma, xlod,y);
+					DrawVertexAQ(ma, xhlod,yhlod,h3);
 					DrawVertexAQ(ma, x,y);
-					DrawVertexAQ(ma, x,y+hlod,h2);
+					DrawVertexAQ(ma, x,yhlod,h2);
 					EndStripQ(ma);
 				}
 			}
@@ -976,38 +996,45 @@
 	int yed=min(yend + lod, maxty);
 	int nloop=(yed-yst)/lod+1;
 	ma-&gt;EnlargeArrays(8*nloop, 2*nloop);
-	//rita yttre begr?snings yta mot n?ta lod
+
+	//!rita yttre begr?snings yta mot n?ta lod
 	if(maxlx&lt;maxtx &amp;&amp; maxlx&gt;=mintx){
 		x=maxlx;
+		int xlod = x + lod;
 		for(y=yst;y&lt;yed;y+=lod){
 			DrawVertexAQ(ma, x,y);
 			DrawVertexAQ(ma, x,y+lod);
-			if(y%(lod*2)){
-				float h=((heightData[(y-lod)*heightDataX+x+lod]+heightData[(y+lod)*heightDataX+x+lod])*0.5f)*(1-camxpart)+heightData[(y)*heightDataX+x+lod]*(camxpart);
-				DrawVertexAQ(ma, x+lod,y,h);
-				DrawVertexAQ(ma, x+lod,y+lod);
-			} else {
-				DrawVertexAQ(ma, x+lod,y);
-				float h=(heightData[(y)*heightDataX+x+lod]+heightData[(y+lod*2)*heightDataX+x+lod])*0.5f*(1-camxpart)+heightData[(y+lod)*heightDataX+x+lod]*(camxpart);
-				DrawVertexAQ(ma, x+lod,y+lod,h);
+			int yhdx=y*heightDataX+x; 
+			if(y%dlod){
+				float h=(heightData[yhdx-lhdx+lod]+heightData[yhdx+lhdx+lod]) * hmcxp + heightData[yhdx+lod] * camxpart;
+				DrawVertexAQ(ma, xlod,y,h);
+				DrawVertexAQ(ma, xlod,y+lod);
+			} 
+			else {
+				DrawVertexAQ(ma, xlod,y);
+				float h=(heightData[yhdx+lod]+heightData[yhdx+dhdx+lod]) * hmcxp + heightData[yhdx+lhdx+lod] * camxpart;
+				DrawVertexAQ(ma, xlod,y+lod,h);
 			}
 			EndStripQ(ma);
 		}
 	}
 	if(minlx&gt;mintx &amp;&amp; minlx&lt;maxtx){
 		x=minlx-lod;
+		int xlod = x + lod;
 		for(y=yst;y&lt;yed;y+=lod){
-			if(y%(lod*2)){
-				float h=((heightData[(y-lod)*heightDataX+x]+heightData[(y+lod)*heightDataX+x])*0.5f)*(camxpart)+heightData[(y)*heightDataX+x]*(1-camxpart);
+			int yhdx=y*heightDataX+x; 
+			if(y%dlod){
+				float h=(heightData[yhdx-lhdx]+heightData[yhdx+lhdx]) * hcxp + heightData[yhdx] * mcxp;
 				DrawVertexAQ(ma, x,y,h);
 				DrawVertexAQ(ma, x,y+lod);
-			} else {
+			} 
+			else {
 				DrawVertexAQ(ma, x,y);
-				float h=(heightData[(y)*heightDataX+x]+heightData[(y+lod*2)*heightDataX+x])*0.5f*(camxpart)+heightData[(y+lod)*heightDataX+x]*(1-camxpart);
+				float h=(heightData[yhdx]+heightData[yhdx+dhdx]) * hcxp + heightData[yhdx+lhdx] * mcxp;
 				DrawVertexAQ(ma, x,y+lod,h);
 			}
-			DrawVertexAQ(ma, x+lod,y);
-			DrawVertexAQ(ma, x+lod,y+lod);
+			DrawVertexAQ(ma, xlod,y);
+			DrawVertexAQ(ma, xlod,y+lod);
 			EndStripQ(ma);
 		}
 	}
@@ -1017,24 +1044,30 @@
 		int xe=min(xend+lod,maxtx);
 		if(xs&lt;xe){
 			x=xs;
-			int nloop=(xe-xs)/lod+2; // one extra for if statment
+			int ylod = y + lod;
+			int nloop=(xe-xs)/lod+2; //! one extra for if statment
 			ma-&gt;EnlargeArrays(2*nloop, 1);
-			if(x%(lod*2)){
+			int ydx=y*heightDataX;
+			if(x%dlod){
 				DrawVertexAQ(ma, x,y);
-				float h=((heightData[(y+lod)*heightDataX+x-lod]+heightData[(y+lod)*heightDataX+x+lod])*0.5f)*(1-camypart)+heightData[(y+lod)*heightDataX+x]*(camypart);
-				DrawVertexAQ(ma, x,y+lod,h);
-			} else {
+				int ylhdx=ydx+x+lhdx; 
+				float h=(heightData[ylhdx-lod]+heightData[ylhdx+lod]) * hmcyp + heightData[ylhdx] * camypart;
+				DrawVertexAQ(ma, x,ylod,h);
+			} 
+			else {
 				DrawVertexAQ(ma, x,y);
-				DrawVertexAQ(ma, x,y+lod);
+				DrawVertexAQ(ma, x,ylod);
 			}
 			for(x=xs;x&lt;xe;x+=lod){
-				if(x%(lod*2)){
+				if(x%dlod){
 					DrawVertexAQ(ma, x+lod,y);
-					DrawVertexAQ(ma, x+lod,y+lod);
-				} else {
+					DrawVertexAQ(ma, x+lod,ylod);
+				} 
+				else {
 					DrawVertexAQ(ma, x+lod,y);
-					float h=(heightData[(y+lod)*heightDataX+x+2*lod]+heightData[(y+lod)*heightDataX+x])*0.5f*(1-camypart)+heightData[(y+lod)*heightDataX+x+lod]*(camypart);
-					DrawVertexAQ(ma, x+lod,y+lod,h);
+					int ylhdx=ydx+x+lhdx; 
+					float h=(heightData[ylhdx+dlod]+heightData[ylhdx]) * hmcyp + heightData[ylhdx+lod] * camypart;
+					DrawVertexAQ(ma, x+lod,ylod,h);
 				}
 			}
 			EndStripQ(ma);
@@ -1046,30 +1079,35 @@
 		int xe=min(xend+lod,maxtx);
 		if(xs&lt;xe){
 			x=xs;
-			int nloop=(xe-xs)/lod+2; // one extra for if statment
+			int ylod = y + lod;
+			int nloop=(xe-xs)/lod+2; //! one extra for if statment
 			ma-&gt;EnlargeArrays(2*nloop, 1);
-			if(x%(lod*2)){
-				float h=((heightData[(y)*heightDataX+x-lod]+heightData[(y)*heightDataX+x+lod])*0.5f)*(camypart)+heightData[(y)*heightDataX+x]*(1-camypart);
+			int ydx=y*heightDataX;
+			if(x%dlod){
+				int yhdx=ydx+x;
+				float h=(heightData[yhdx-lod]+heightData[yhdx+lod]) * hcyp + heightData[yhdx] * mcyp;
 				DrawVertexAQ(ma, x,y,h);
-				DrawVertexAQ(ma, x,y+lod);
-			} else {
+				DrawVertexAQ(ma, x,ylod);
+			} 
+			else {
 				DrawVertexAQ(ma, x,y);
-				DrawVertexAQ(ma, x,y+lod);
+				DrawVertexAQ(ma, x,ylod);
 			}
 			for(x=xs;x&lt;xe;x+=lod){
-				if(x%(lod*2)){
+				if(x%dlod){
 					DrawVertexAQ(ma, x+lod,y);
-					DrawVertexAQ(ma, x+lod,y+lod);
-				} else {
-					float h=(heightData[(y)*heightDataX+x+2*lod]+heightData[(y)*heightDataX+x])*0.5f*(camypart)+heightData[(y)*heightDataX+x+lod]*(1-camypart);
+					DrawVertexAQ(ma, x+lod,ylod);
+				} 
+				else {
+					int yhdx=ydx+x;
+					float h=(heightData[yhdx+dlod]+heightData[yhdx]) * hcyp + heightData[yhdx+lod] * mcyp;
 					DrawVertexAQ(ma, x+lod,y,h);
-					DrawVertexAQ(ma, x+lod,y+lod);
+					DrawVertexAQ(ma, x+lod,ylod);
 				}
 			}
 			EndStripQ(ma);
 		}
 	}
-
 	DrawGroundVertexArrayQ(ma);
 }
 

Modified: branches/0.77-branch/rts/Map/SMF/BFGroundDrawer.h
===================================================================
--- branches/0.77-branch/rts/Map/SMF/BFGroundDrawer.h	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Map/SMF/BFGroundDrawer.h	2008-09-23 15:51:10 UTC (rev 6447)
@@ -68,6 +68,7 @@
 	void CreateWaterPlanes(const bool &amp;camOufOfMap);
 	inline void DrawWaterPlane(bool);
 
+	void FindRange(int &amp;xs, int &amp;xe, std::vector&lt;fline&gt; &amp;left, std::vector&lt;fline&gt; &amp;right, int y, int lod);
 	void DoDrawGroundRow(int bty, unsigned int overrideVP);
 	static void DoDrawGroundRowMT(void *c,int bty) {((CBFGroundDrawer *)c)-&gt;DoDrawGroundRow(bty,((CBFGroundDrawer *)c)-&gt;mt_overrideVP);}
 	void DrawVertexAQ(CVertexArray *ma, int x, int y);

Modified: branches/0.77-branch/rts/Map/SMF/BFGroundTextures.cpp
===================================================================
--- branches/0.77-branch/rts/Map/SMF/BFGroundTextures.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Map/SMF/BFGroundTextures.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -26,10 +26,11 @@
 		usePBO = true;
 	}
 
-	CFileHandler* ifs = rm-&gt;ifs;
+	// todo: refactor: put reading code in CSmfFile and keep errorhandling/progress reporting here..
+	CFileHandler* ifs = rm-&gt;GetFile().GetFileHandler();
 	map = rm;
 
-	SMFHeader* header = &amp;map-&gt;header;
+	const SMFHeader* header = &amp;map-&gt;GetFile().GetHeader();
 	ifs-&gt;Seek(header-&gt;tilesPtr);
 
 	tileSize = header-&gt;tilesize;

Copied: branches/0.77-branch/rts/Map/SMF/SmfMapFile.cpp (from rev 6446, trunk/rts/Map/SMF/SmfMapFile.cpp)
===================================================================
--- branches/0.77-branch/rts/Map/SMF/SmfMapFile.cpp	                        (rev 0)
+++ branches/0.77-branch/rts/Map/SMF/SmfMapFile.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -0,0 +1,169 @@
+/* Author: Tobi Vollebregt */
+
+#include &quot;StdAfx.h&quot;     // ugh
+#include &quot;SmfMapFile.h&quot;
+#include &quot;mapfile.h&quot;
+#include &quot;mmgr.h&quot;
+
+using std::string;
+
+
+CSmfMapFile::CSmfMapFile(const string&amp; mapname)
+	: ifs(string(&quot;maps/&quot;) + mapname), featureFileOffset(0)
+{
+	memset(&amp;header, 0, sizeof(header));
+	memset(&amp;featureHeader, 0, sizeof(featureHeader));
+
+	if (!ifs.FileExists())
+		throw content_error(&quot;Couldn't open map file &quot; + mapname);
+	READPTR_MAPHEADER(header, (&amp;ifs));
+
+	if (strcmp(header.magic, &quot;spring map file&quot;) != 0 ||
+	    header.version != 1 || header.tilesize != 32 ||
+	    header.texelPerSquare != 8 || header.squareSize != 8)
+		throw content_error(&quot;Incorrect map file &quot; + mapname);
+}
+
+
+void CSmfMapFile::ReadMinimap(void* data)
+{
+	ifs.Seek(header.minimapPtr);
+	ifs.Read(data, MINIMAP_SIZE);
+}
+
+
+void CSmfMapFile::ReadHeightmap(unsigned short* heightmap)
+{
+	const int hmx = header.mapx + 1;
+	const int hmy = header.mapy + 1;
+
+	ifs.Seek(header.heightmapPtr);
+	ifs.Read(heightmap, hmx * hmy * sizeof(short));
+
+	for (int y = 0; y &lt; hmx * hmy; ++y) {
+		heightmap[y] = swabword(heightmap[y]);
+	}
+}
+
+
+void CSmfMapFile::ReadHeightmap(float* heightmap, float base, float mod)
+{
+	const int hmx = header.mapx + 1;
+	const int hmy = header.mapy + 1;
+	unsigned short* temphm = SAFE_NEW unsigned short[hmx * hmy];
+
+	ifs.Seek(header.heightmapPtr);
+	ifs.Read(temphm, hmx * hmy * 2);
+
+	for (int y = 0; y &lt; hmx * hmy; ++y) {
+		heightmap[y] = base + swabword(temphm[y]) * mod;
+	}
+
+	delete[] temphm;
+}
+
+
+void CSmfMapFile::ReadFeatureInfo()
+{
+	ifs.Seek(header.featurePtr);
+	READ_MAPFEATUREHEADER(featureHeader, (&amp;ifs));
+
+	featureTypes.resize(featureHeader.numFeatureType);
+
+	for(int a = 0; a &lt; featureHeader.numFeatureType; ++a) {
+		char c;
+		ifs.Read(&amp;c, 1);
+		while (c) {
+			featureTypes[a] += c;
+			ifs.Read(&amp;c, 1);
+		}
+	}
+	featureFileOffset = ifs.GetPos();
+}
+
+
+void CSmfMapFile::ReadFeatureInfo(MapFeatureInfo* f)
+{
+	assert(featureFileOffset != 0);
+	ifs.Seek(featureFileOffset);
+	for(int a = 0; a &lt; featureHeader.numFeatures; ++a) {
+		MapFeatureStruct ffs;
+		READ_MAPFEATURESTRUCT(ffs, (&amp;ifs));
+
+		f[a].featureType = ffs.featureType;
+		f[a].pos = float3(ffs.xpos, ffs.ypos, ffs.zpos);
+		f[a].rotation = ffs.rotation;
+	}
+}
+
+
+const char* CSmfMapFile::GetFeatureType(int typeID) const
+{
+	assert(typeID &gt;= 0 &amp;&amp; typeID &lt; featureHeader.numFeatureType);
+	return featureTypes[typeID].c_str();
+}
+
+
+bool CSmfMapFile::ReadInfoMap(const string&amp; name, unsigned char* data, MapBitmapInfo* bmInfo)
+{
+	if (name == &quot;grass&quot;) {
+		bmInfo-&gt;width = header.mapx / 4;
+		bmInfo-&gt;height = header.mapy / 4;
+
+		if (data != NULL) {
+			ReadGrassMap(data);
+		}
+		return true;
+	}
+	else if(name == &quot;metal&quot;) {
+		bmInfo-&gt;width = header.mapx / 2;
+		bmInfo-&gt;height = header.mapy / 2;
+
+		if (data != NULL) {
+			ifs.Seek(header.metalmapPtr);
+			ifs.Read(data, bmInfo-&gt;width * bmInfo-&gt;height);
+		}
+		return true;
+	}
+	else if(name == &quot;type&quot;) {
+		bmInfo-&gt;width = header.mapx / 2;
+		bmInfo-&gt;height = header.mapy / 2;
+
+		if (data != NULL) {
+			ifs.Seek(header.typeMapPtr);
+			ifs.Read(data, bmInfo-&gt;width * bmInfo-&gt;height);
+		}
+		return true;
+	}
+
+	return false;
+}
+
+
+void CSmfMapFile::ReadGrassMap(void *data)
+{
+	ifs.Seek(sizeof(SMFHeader));
+
+	for (int a = 0; a &lt; header.numExtraHeaders; ++a) {
+		int size;
+		ifs.Read(&amp;size, 4);
+		size = swabdword(size);
+		int type;
+		ifs.Read(&amp;type, 4);
+		type = swabdword(type);
+		if (type == MEH_Vegetation) {
+			int pos;
+			ifs.Read(&amp;pos, 4);
+			pos = swabdword(pos);
+			ifs.Seek(pos);
+			ifs.Read(data, header.mapx * header.mapy / 16);
+			/* char; no swabbing. */
+			break; //we arent interested in other extensions anyway
+		}
+		else {
+			// assumes we can use data as scratch memory
+			assert(size - 8 &lt;= header.mapx * header.mapy / 16);
+			ifs.Read(data, size - 8);
+		}
+	}
+}

Copied: branches/0.77-branch/rts/Map/SMF/SmfMapFile.h (from rev 6446, trunk/rts/Map/SMF/SmfMapFile.h)
===================================================================
--- branches/0.77-branch/rts/Map/SMF/SmfMapFile.h	                        (rev 0)
+++ branches/0.77-branch/rts/Map/SMF/SmfMapFile.h	2008-09-23 15:51:10 UTC (rev 6447)
@@ -0,0 +1,48 @@
+/* Author: Tobi Vollebregt */
+
+#ifndef SMFMAPFILE_H
+#define SMFMAPFILE_H
+
+#include &quot;FileSystem/FileHandler.h&quot;
+#include &quot;Map/ReadMap.h&quot;
+#include &quot;mapfile.h&quot;
+#include &lt;string&gt;
+#include &lt;vector&gt;
+
+
+class CSmfMapFile
+{
+public:
+
+	CSmfMapFile(const std::string&amp; mapname);
+
+	void ReadMinimap(void* data);
+	void ReadHeightmap(unsigned short* heightmap);
+	void ReadHeightmap(float* heightmap, float base, float mod);
+	void ReadFeatureInfo();
+	void ReadFeatureInfo(MapFeatureInfo* f);
+	bool ReadInfoMap(const std::string&amp; name, unsigned char* infomap, MapBitmapInfo* bmInfo);
+
+	int GetNumFeatures()     const { return featureHeader.numFeatures; }
+	int GetNumFeatureTypes() const { return featureHeader.numFeatureType; }
+
+	const char* GetFeatureType(int typeID) const;
+
+	const SMFHeader&amp; GetHeader() const { return header; }
+
+	// todo: do not use, just here for backward compatibility with BFGroundTextures.cpp
+	CFileHandler* GetFileHandler() { return &ifs; }
+
+private:
+
+	void ReadGrassMap(void* data);
+
+	SMFHeader header;
+	CFileHandler ifs;
+
+	MapFeatureHeader featureHeader;
+	std::vector&lt;std::string&gt; featureTypes;
+	int featureFileOffset;
+};
+
+#endif // SMFMAPFILE_H

Modified: branches/0.77-branch/rts/Map/SMF/SmfReadMap.cpp
===================================================================
--- branches/0.77-branch/rts/Map/SMF/SmfReadMap.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Map/SMF/SmfReadMap.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -35,6 +35,7 @@
 
 
 CSmfReadMap::CSmfReadMap(std::string mapname)
+	: file(mapname)
 {
 	PrintLoadMsg(&quot;Opening map file&quot;);
 
@@ -49,17 +50,8 @@
 		waterHeightColors[a*4+3]=1;
 	}
 
-	PUSH_CODE_MODE;
-	ENTER_MIXED;
-	ifs=SAFE_NEW CFileHandler(string(&quot;maps/&quot;)+mapname);
-	if(!ifs-&gt;FileExists())
-		throw content_error(&quot;Couldn't open map file &quot; + mapname);
-	POP_CODE_MODE;
-	READPTR_MAPHEADER(header,ifs);
+	const SMFHeader&amp; header = file.GetHeader();
 
-	if(strcmp(header.magic,&quot;spring map file&quot;)!=0 || header.version!=1 || header.tilesize!=32 || header.texelPerSquare!=8 || header.squareSize!=8)
-		throw content_error(&quot;Incorrect map file &quot; + mapname);
-
 	width=header.mapx;
 	height=header.mapy;
 	gs-&gt;mapx=header.mapx;
@@ -85,18 +77,8 @@
 	const float base = minH;
 	const float mod = (maxH - minH) / 65536.0f;
 
-	const int hmx = gs-&gt;mapx + 1;
-	const int hmy = gs-&gt;mapy + 1;
-	unsigned short* temphm = SAFE_NEW unsigned short[hmx * hmy];
-	ifs-&gt;Seek(header.heightmapPtr);
-	ifs-&gt;Read(temphm, hmx * hmy * 2);
+	file.ReadHeightmap(heightmap, base, mod);
 
-	for (int y = 0; y &lt; hmx * hmy; ++y) {
-		heightmap[y] = base + swabword(temphm[y]) * mod;
-	}
-
-	delete[] temphm;
-
 	CReadMap::Initialize();
 
 	for (unsigned int a = 0; a &lt; mapname.size(); ++a) {
@@ -124,8 +106,8 @@
 	PrintLoadMsg(&quot;Creating overhead texture&quot;);
 
 	unsigned char* buf=SAFE_NEW unsigned char[MINIMAP_SIZE];
-	ifs-&gt;Seek(header.minimapPtr);
-	ifs-&gt;Read(buf,MINIMAP_SIZE);
+	file.ReadMinimap(buf);
+
 	glGenTextures(1, &amp;minimapTex);
 	glBindTexture(GL_TEXTURE_2D, minimapTex);
 	glTexParameteri(GL_TEXTURE_2D,GL_TEXTURE_MAG_FILTER,GL_LINEAR);
@@ -163,20 +145,20 @@
 
 	groundDrawer=SAFE_NEW CBFGroundDrawer(this);
 
-	ReadFeatureInfo ();
+	file.ReadFeatureInfo ();
 }
 
-CSmfReadMap::~CSmfReadMap(void)
+
+CSmfReadMap::~CSmfReadMap()
 {
-	delete[] featureTypes;
 	delete groundDrawer;
-	delete ifs;
 	delete[] heightmap;
 	if (detailTex) glDeleteTextures (1, &amp;detailTex);
 	if (minimapTex) glDeleteTextures (1, &amp;minimapTex);
 	if (shadowTex) glDeleteTextures (1, &amp;shadowTex);
 }
 
+
 void CSmfReadMap::HeightmapUpdated(int x1, int x2, int y1, int y2)
 {
 	x1-=x1&amp;3;
@@ -229,6 +211,7 @@
 
 }
 
+
 float3 CSmfReadMap::GetLightValue(int x, int y)
 {
 	float3 n1 = facenormals[((y * gs-&gt;mapx) + x) * 2] +
@@ -315,8 +298,11 @@
 	glDisable(GL_TEXTURE_2D);
 }
 
+
 void CSmfReadMap::GridVisibility (CCamera *cam, int quadSize, float maxdist, CReadMap::IQuadDrawer *qd, int extraSize)
 {
+	const SMFHeader&amp; header = file.GetHeader();
+
 	int cx=(int)(cam-&gt;pos.x/(SQUARE_SIZE*quadSize));
 	int cy=(int)(cam-&gt;pos.z/(SQUARE_SIZE*quadSize));
 
@@ -337,7 +323,7 @@
 	int exi=cx+drawSquare;
 	if(exi&gt;drawQuadsX-1)
 		exi=drawQuadsX-1;
- 
+
 	for(int y=sy;y&lt;=ey;y++){
 		int sx=sxi;
 		int ex=exi;
@@ -367,118 +353,50 @@
 	}
 }
 
+
 int CSmfReadMap::GetNumFeatures ()
 {
-	return featureHeader.numFeatures;
+	return file.GetNumFeatures();
 }
 
+
 int CSmfReadMap::GetNumFeatureTypes ()
 {
-	return featureHeader.numFeatureType;
+	return file.GetNumFeatureTypes();
 }
 
+
 void CSmfReadMap::GetFeatureInfo (MapFeatureInfo* f)
 {
-	ifs-&gt;Seek (featureFileOffset);
-	for(int a=0;a&lt;featureHeader.numFeatures;++a){
-		MapFeatureStruct ffs;
-		READ_MAPFEATURESTRUCT(ffs, ifs);
-
-		f[a].featureType = ffs.featureType;
-		f[a].pos = float3(ffs.xpos, ffs.ypos, ffs.zpos);
-		f[a].rotation = ffs.rotation;
-	}
+	file.ReadFeatureInfo(f);
 }
 
+
 const char *CSmfReadMap::GetFeatureType (int typeID)
 {
-	assert (typeID &gt;= 0 &amp;&amp; typeID &lt; featureHeader.numFeatureType);
-	return featureTypes[typeID].c_str();
+	return file.GetFeatureType(typeID);
 }
 
+
 unsigned char *CSmfReadMap::GetInfoMap (const std::string&amp; name, MapBitmapInfo* bmInfo)
 {
-	if (name == &quot;grass&quot;) {
-		bmInfo-&gt;width = header.mapx / 4;
-		bmInfo-&gt;height = header.mapy / 4;
+	// get size
+	if (!file.ReadInfoMap(name, NULL, bmInfo))
+		return NULL;
 
-		unsigned char *data = SAFE_NEW unsigned char[bmInfo-&gt;width*bmInfo-&gt;height];
-		ReadGrassMap (data);
-		return data;
-	}
-	else if(name == &quot;metal&quot;) {
-		bmInfo-&gt;width = header.mapx/2;
-		bmInfo-&gt;height = header.mapy/2;
-
-		unsigned char *data = SAFE_NEW unsigned char[bmInfo-&gt;width*bmInfo-&gt;height];
-		ifs-&gt;Seek(header.metalmapPtr);
-		ifs-&gt;Read(data,header.mapx/2*header.mapy/2);
-        return data;
-	}
-	else if(name == &quot;type&quot;) {
-		bmInfo-&gt;width = header.mapx/2;
-		bmInfo-&gt;height = header.mapy/2;
-		unsigned char *data = SAFE_NEW unsigned char[bmInfo-&gt;width*bmInfo-&gt;height];
-		ifs-&gt;Seek(header.typeMapPtr);
-		ifs-&gt;Read(data,gs-&gt;mapx*gs-&gt;mapy/4);
-		return data;
-	}
-
-	return false;
+	// get data
+	unsigned char* data = SAFE_NEW unsigned char[bmInfo-&gt;width * bmInfo-&gt;height];
+	file.ReadInfoMap(name, data, bmInfo);
+	return data;
 }
 
+
 void CSmfReadMap::FreeInfoMap (const std::string&amp; name, unsigned char *data)
 {
 	delete[] data;
 }
 
 
-void CSmfReadMap::ReadGrassMap(void *data)
-{
-	CFileHandler* fh=ifs;
-	fh-&gt;Seek(sizeof(SMFHeader));
-
-	for(int a=0;a&lt;header.numExtraHeaders;++a){
-		int size;
-		fh-&gt;Read(&amp;size,4);
-		size=swabdword(size);
-		int type;
-		fh-&gt;Read(&amp;type,4);
-		type=swabdword(type);
-		if(type==MEH_Vegetation){
-			int pos;
-			fh-&gt;Read(&amp;pos,4);
-			pos=swabdword(pos);
-			fh-&gt;Seek(pos);
-			fh-&gt;Read(data,gs-&gt;mapx*gs-&gt;mapy/16);
-			/* char; no swabbing. */
-			break;	//we arent interested in other extensions anyway
-		} else {
-			unsigned char buf[100];	//todo: fix this if we create larger extensions
-			fh-&gt;Read(buf,size-8);
-		}
-	}
-}
-
-void CSmfReadMap::ReadFeatureInfo()
-{
-	ifs-&gt;Seek(header.featurePtr);
-	READ_MAPFEATUREHEADER(featureHeader, ifs);
-
-	featureTypes=SAFE_NEW string[featureHeader.numFeatureType];
-
-	for(int a=0;a&lt;featureHeader.numFeatureType;++a){
-		char c;
-		ifs-&gt;Read(&amp;c,1);
-		while(c){
-			featureTypes[a]+=c;
-			ifs-&gt;Read(&amp;c,1);
-		}
-	}
-	featureFileOffset = ifs-&gt;GetPos();
-}
-
-
 void CSmfReadMap::ConfigureAnisotropy()
 {
 	if (!GLEW_EXT_texture_filter_anisotropic) {

Modified: branches/0.77-branch/rts/Map/SMF/SmfReadMap.h
===================================================================
--- branches/0.77-branch/rts/Map/SMF/SmfReadMap.h	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Map/SMF/SmfReadMap.h	2008-09-23 15:51:10 UTC (rev 6447)
@@ -1,9 +1,7 @@
 #ifndef SMFREADMAP_H
 #define SMFREADMAP_H
 
-#include &quot;Map/ReadMap.h&quot;
-#include &lt;string&gt;
-#include &quot;mapfile.h&quot;
+#include &quot;SmfMapFile.h&quot;
 
 class CBFGroundDrawer;
 
@@ -13,7 +11,7 @@
 	CR_DECLARE(CSmfReadMap)
 
 	CSmfReadMap(std::string mapname);
-	~CSmfReadMap(void);
+	~CSmfReadMap();
 
 	void HeightmapUpdated(int x1, int x2, int y1, int y2);
 	GLuint GetShadingTexture () { return shadowTex; }
@@ -38,34 +36,31 @@
 	int GetNumFeatures ();
 	void GetFeatureInfo (MapFeatureInfo* f);// returns all feature info in MapFeatureInfo[NumFeatures]
 	const char *GetFeatureType (int typeID);
-	
+
 	unsigned char *GetInfoMap (const std::string&amp; name, MapBitmapInfo* bm);
 	void FreeInfoMap(const std::string&amp; name, unsigned char *data);
 
-	std::string detailTexName;
-	GLuint detailTex;
-	SMFHeader header;
-	CFileHandler *ifs;
+	// todo: do not use, just here for backward compatibility with BFGroundTextures.cpp
+	CSmfMapFile&amp; GetFile() { return file; }
 
 	bool usePBO;
 	float anisotropy;
 
-	unsigned char waterHeightColors[1024*4];
 protected:
-	void ReadGrassMap (void *data);
-	void ReadFeatureInfo ();
-
 	void ConfigureAnisotropy();
 
+	CSmfMapFile file;
+
+	std::string detailTexName;
+	GLuint detailTex;
+
+	unsigned char waterHeightColors[1024*4];
+
 	GLuint shadowTex;
 	GLuint minimapTex;
 
 	float* heightmap;
 
-	MapFeatureHeader featureHeader;
-	std::string* featureTypes;
-	int featureFileOffset;
-
 	CBFGroundDrawer *groundDrawer;
 
 	float3 GetLightValue(int x, int y);

Modified: branches/0.77-branch/rts/Rendering/GL/myGL.cpp
===================================================================
--- branches/0.77-branch/rts/Rendering/GL/myGL.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Rendering/GL/myGL.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -279,7 +279,11 @@
 		glEnd();
 	}
 	font-&gt;glPrintCentered (0.5f,0.48f, 2.0f, text);
+#ifdef USE_GML
+	font-&gt;glPrintCentered(0.5f,0.06f,1.0f,&quot;Spring %s MT (%d threads)&quot;, VERSION_STRING, gmlThreadCount);
+#else
 	font-&gt;glPrintCentered(0.5f,0.06f,1.0f,&quot;Spring %s&quot;, VERSION_STRING);
+#endif
 	font-&gt;glPrintCentered(0.5f,0.02f,0.6f,&quot;This program is distributed under the GNU General Public License, see license.html for more info&quot;);
 	if (swapbuffers) {
 		SDL_GL_SwapBuffers();

Modified: branches/0.77-branch/rts/Rendering/Textures/nv_dds.cpp
===================================================================
--- branches/0.77-branch/rts/Rendering/Textures/nv_dds.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Rendering/Textures/nv_dds.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -690,15 +690,18 @@
     if (is_compressed())
     {
         // get function pointer if needed
+#ifndef USE_GML
         if (glCompressedTexImage1DARB == NULL)
         {
             GET_EXT_POINTER(glCompressedTexImage1DARB, 
                             PFNGLCOMPRESSEDTEXIMAGE1DARBPROC);
         }
-        
+
         if (glCompressedTexImage1DARB == NULL)
             return false;
-        
+#else
+        ::
+#endif                
         glCompressedTexImage1DARB(GL_TEXTURE_1D, 0, m_format, 
             baseImage.get_width(), 0, baseImage.get_size(), baseImage);
         
@@ -706,6 +709,9 @@
         for (unsigned int i = 0; i &lt; baseImage.get_num_mipmaps(); i++)
         {
             const CSurface &amp;mipmap = baseImage.get_mipmap(i);
+#ifdef USE_GML
+            ::
+#endif
             glCompressedTexImage1DARB(GL_TEXTURE_1D, i+1, m_format, 
                 mipmap.get_width(), 0, mipmap.get_size(), mipmap);
         }
@@ -769,6 +775,7 @@
     if (is_compressed())
     {
         // load function pointer if needed
+#ifndef USE_GML
         if (glCompressedTexImage2DARB == NULL)
         {
             GET_EXT_POINTER(glCompressedTexImage2DARB, 
@@ -777,7 +784,9 @@
         
         if (glCompressedTexImage2DARB == NULL)
             return false;
-        
+#else
+        ::
+#endif
         glCompressedTexImage2DARB(target, 0, m_format, image.get_width(), 
             image.get_height(), 0, image.get_size(), image);
         
@@ -785,7 +794,9 @@
         for (unsigned int i = 0; i &lt; image.get_num_mipmaps(); i++)
         {
             const CSurface &amp;mipmap = image.get_mipmap(i);
-
+#ifdef USE_GML
+            ::
+#endif
             glCompressedTexImage2DARB(target, i+1, m_format, 
                 mipmap.get_width(), mipmap.get_height(), 0, 
                 mipmap.get_size(), mipmap);
@@ -835,6 +846,7 @@
     if (is_compressed())
     {
         // retrieve function pointer if needed
+#ifndef USE_GML
         if (glCompressedTexImage3DARB == NULL)
         {
             GET_EXT_POINTER(glCompressedTexImage3DARB, 
@@ -843,7 +855,9 @@
 
         if (glCompressedTexImage3DARB == NULL)
             return false;
-
+#else
+        ::
+#endif
         glCompressedTexImage3DARB(GL_TEXTURE_3D, 0, m_format,  
             baseImage.get_width(), baseImage.get_height(), baseImage.get_depth(),
             0, baseImage.get_size(), baseImage);
@@ -852,7 +866,9 @@
         for (unsigned int i = 0; i &lt; baseImage.get_num_mipmaps(); i++)
         {
             const CSurface &amp;mipmap = baseImage.get_mipmap(i);
-
+#ifdef USE_GML
+            ::
+#endif
             glCompressedTexImage3DARB(GL_TEXTURE_3D, i+1, m_format, 
                 mipmap.get_width(), mipmap.get_height(), mipmap.get_depth(), 
                 0, mipmap.get_size(), mipmap);

Modified: branches/0.77-branch/rts/Rendering/UnitModels/UnitDrawer.cpp
===================================================================
--- branches/0.77-branch/rts/Rendering/UnitModels/UnitDrawer.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Rendering/UnitModels/UnitDrawer.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -1891,8 +1891,12 @@
 
 void CUnitDrawer::ApplyUnitTransformMatrix(CUnit* unit)
 {
+#ifdef USE_GML
+	CMatrix44f m;
+#else
 	static CMatrix44f m;
 	m.LoadIdentity();
+#endif
 	unit-&gt;GetTransformMatrix(m);
 	glMultMatrixf(&amp;m[0]);
 }

Modified: branches/0.77-branch/rts/Rendering/UnitModels/UnitDrawer.h
===================================================================
--- branches/0.77-branch/rts/Rendering/UnitModels/UnitDrawer.h	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Rendering/UnitModels/UnitDrawer.h	2008-09-23 15:51:10 UTC (rev 6447)
@@ -47,11 +47,16 @@
 	volatile bool mt_drawReflection;
 	volatile bool mt_drawRefraction;
   #ifdef DIRECT_CONTROL_ALLOWED
-	CUnit * volatile mt_excludeUnit;
+	CUnit* volatile mt_excludeUnit;
   #endif
-	static void DoDrawUnitMT(void *c,CUnit *unit) {
-		CUnitDrawer* const ud = (CUnitDrawer*)c;
+
+	static void DoDrawUnitMT(void* c, CUnit* unit) {
+		CUnitDrawer* const ud = (CUnitDrawer*) c;
+		#ifdef DIRECT_CONTROL_ALLOWED
 		ud-&gt;DoDrawUnit(unit, ud-&gt;mt_drawReflection, ud-&gt;mt_drawRefraction, ud-&gt;mt_excludeUnit);
+		#else
+		ud-&gt;DoDrawUnit(unit, ud-&gt;mt_drawReflection, ud-&gt;mt_drawRefraction, NULL);
+		#endif
 	}
 #endif
 

Modified: branches/0.77-branch/rts/Sim/Features/Feature.cpp
===================================================================
--- branches/0.77-branch/rts/Sim/Features/Feature.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Sim/Features/Feature.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -24,6 +24,7 @@
 #include &quot;Sim/Projectiles/Unsynced/SmokeProjectile.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
+#include &lt;assert.h&gt;
 
 CR_BIND_DERIVED(CFeature, CSolidObject, )
 

Modified: branches/0.77-branch/rts/Sim/Misc/LosHandler.h
===================================================================
--- branches/0.77-branch/rts/Sim/Misc/LosHandler.h	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Sim/Misc/LosHandler.h	2008-09-23 15:51:10 UTC (rev 6447)
@@ -13,6 +13,7 @@
 #include &quot;Sim/Objects/WorldObject.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;RadarHandler.h&quot;
+#include &lt;assert.h&gt;
 
 #define MAX_LOS_TABLE 110
 

Modified: branches/0.77-branch/rts/Sim/Misc/RadarHandler.h
===================================================================
--- branches/0.77-branch/rts/Sim/Misc/RadarHandler.h	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Sim/Misc/RadarHandler.h	2008-09-23 15:51:10 UTC (rev 6447)
@@ -5,8 +5,8 @@
 
 #include &quot;Object.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
+#include &lt;assert.h&gt;
 
-
 #define RADAR_SIZE 8
 
 

Modified: branches/0.77-branch/rts/Sim/MoveTypes/GroundMoveType.cpp
===================================================================
--- branches/0.77-branch/rts/Sim/MoveTypes/GroundMoveType.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Sim/MoveTypes/GroundMoveType.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -609,7 +609,7 @@
 Changes the heading of the owner.
 */
 void CGroundMoveType::ChangeHeading(short wantedHeading) {
-	short heading = owner-&gt;heading;
+	SyncedSshort&amp; heading = owner-&gt;heading;
 
 	deltaHeading = wantedHeading - heading;
 

Modified: branches/0.77-branch/rts/Sim/MoveTypes/MoveType.cpp
===================================================================
--- branches/0.77-branch/rts/Sim/MoveTypes/MoveType.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Sim/MoveTypes/MoveType.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -5,6 +5,7 @@
 #include &quot;Map/Ground.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
+#include &lt;assert.h&gt;
 
 CR_BIND_DERIVED_INTERFACE(AMoveType, CObject);
 

Modified: branches/0.77-branch/rts/Sim/MoveTypes/TAAirMoveType.cpp
===================================================================
--- branches/0.77-branch/rts/Sim/MoveTypes/TAAirMoveType.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Sim/MoveTypes/TAAirMoveType.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -528,7 +528,7 @@
 		return;
 	}
 
-	short&amp; heading = owner-&gt;heading;
+	SyncedSshort&amp; heading = owner-&gt;heading;
 	short deltaHeading = wantedHeading - heading;
 
 	if (forceHeading) {

Modified: branches/0.77-branch/rts/Sim/Objects/SolidObject.h
===================================================================
--- branches/0.77-branch/rts/Sim/Objects/SolidObject.h	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Sim/Objects/SolidObject.h	2008-09-23 15:51:10 UTC (rev 6447)
@@ -45,7 +45,7 @@
 	int xsize;									// The x-size of this object, according to its footprint.
 	int ysize;									// The z-size of this object, according to its footprint. (NOTE: This one should have been called zsize!)
 	float height;								// The height of this object.
-	short heading;								// Contains the same information as frontdir, but in a short signed integer.
+	SyncedSshort heading;								// Contains the same information as frontdir, but in a short signed integer.
 	
 	// Positional properties.
 	PhysicalState physicalState;				// The current state of the object within the gameworld. I.e Flying or OnGround.

Modified: branches/0.77-branch/rts/Sim/Projectiles/ExplosionGenerator.cpp
===================================================================
--- branches/0.77-branch/rts/Sim/Projectiles/ExplosionGenerator.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Sim/Projectiles/ExplosionGenerator.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -23,6 +23,7 @@
 #include &quot;Sim/Projectiles/Unsynced/SpherePartProjectile.h&quot;
 #include &quot;Sim/Projectiles/Unsynced/WakeProjectile.h&quot;
 #include &quot;Sim/Projectiles/Unsynced/WreckProjectile.h&quot;
+#include &lt;assert.h&gt;
 
 using std::min;
 using std::max;

Modified: branches/0.77-branch/rts/Sim/Projectiles/WeaponProjectiles/WeaponProjectile.cpp
===================================================================
--- branches/0.77-branch/rts/Sim/Projectiles/WeaponProjectiles/WeaponProjectile.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Sim/Projectiles/WeaponProjectiles/WeaponProjectile.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -118,29 +118,6 @@
 {
 }
 
-CWeaponProjectile *CWeaponProjectile::CreateWeaponProjectile(const float3&amp; pos,
-		const float3&amp; speed, CUnit* owner, CUnit *target,
-		const float3 &amp;targetPos, const WeaponDef* weaponDef)
-{
-	switch(weaponDef-&gt;visuals.renderType)
-	{
-	case WEAPON_RENDERTYPE_LASER:
-		return SAFE_NEW CLaserProjectile(pos, speed, owner, 30,
-				weaponDef-&gt;visuals.color, weaponDef-&gt;visuals.color2,
-				weaponDef-&gt;intensity, weaponDef,
-				(int)(weaponDef-&gt;range/weaponDef-&gt;projectilespeed));
-		break;
-	case WEAPON_RENDERTYPE_PLASMA:
-		break;
-	case WEAPON_RENDERTYPE_FIREBALL:
-		return SAFE_NEW CFireBallProjectile(pos,speed,owner,target,targetPos,weaponDef);
-		break;
-	}
-
-	//gniarf!
-	return NULL;
-}
-
 void CWeaponProjectile::Collision()
 {
 	if(!weaponDef-&gt;noExplode || gs-&gt;frameNum&amp;1)

Modified: branches/0.77-branch/rts/Sim/Projectiles/WeaponProjectiles/WeaponProjectile.h
===================================================================
--- branches/0.77-branch/rts/Sim/Projectiles/WeaponProjectiles/WeaponProjectile.h	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Sim/Projectiles/WeaponProjectiles/WeaponProjectile.h	2008-09-23 15:51:10 UTC (rev 6447)
@@ -24,7 +24,6 @@
 	virtual void Collision(CUnit* unit);
 	virtual void Update();
 	virtual int ShieldRepulse(CPlasmaRepulser* shield, float3 shieldPos, float shieldForce, float shieldMaxSpeed) { return 0; };	//return 0=unaffected,1=instant repulse,2=gradual repulse
-	static CWeaponProjectile* CreateWeaponProjectile(const float3&amp; pos, const float3&amp; speed, CUnit* owner, CUnit* target, const float3 &amp;targetPos, const WeaponDef *weaponDef);
 
 	virtual void DrawUnitPart();
 	// should not be here

Modified: branches/0.77-branch/rts/Sim/Units/CommandAI/AirCAI.cpp
===================================================================
--- branches/0.77-branch/rts/Sim/Units/CommandAI/AirCAI.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Sim/Units/CommandAI/AirCAI.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -17,7 +17,9 @@
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
 #include &quot;System/myMath.h&quot;
 #include &quot;System/LogOutput.h&quot;
+#include &lt;assert.h&gt;
 
+
 CR_BIND_DERIVED(CAirCAI,CMobileCAI , );
 
 CR_REG_METADATA(CAirCAI, (

Modified: branches/0.77-branch/rts/Sim/Units/CommandAI/BuilderCAI.cpp
===================================================================
--- branches/0.77-branch/rts/Sim/Units/CommandAI/BuilderCAI.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Sim/Units/CommandAI/BuilderCAI.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -33,6 +33,7 @@
 #include &quot;Sim/Units/UnitTypes/TransportUnit.h&quot;
 #include &quot;myMath.h&quot;
 #include &quot;creg/STL_Map.h&quot;
+#include &lt;assert.h&gt;
 
 
 CR_BIND_DERIVED(CBuilderCAI ,CMobileCAI , );

Modified: branches/0.77-branch/rts/Sim/Units/CommandAI/CommandAI.cpp
===================================================================
--- branches/0.77-branch/rts/Sim/Units/CommandAI/CommandAI.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Sim/Units/CommandAI/CommandAI.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -31,6 +31,7 @@
 #include &quot;myMath.h&quot;
 #include &quot;creg/STL_Set.h&quot;
 #include &quot;creg/STL_Deque.h&quot;
+#include &lt;assert.h&gt;
 
 #define TARGET_LOST_TIMER 120	// in calls to SlowUpdate() (approx. once every second)
 

Modified: branches/0.77-branch/rts/Sim/Units/CommandAI/MobileCAI.cpp
===================================================================
--- branches/0.77-branch/rts/Sim/Units/CommandAI/MobileCAI.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Sim/Units/CommandAI/MobileCAI.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -23,6 +23,7 @@
 #include &quot;Sim/Weapons/DGunWeapon.h&quot;
 #include &quot;System/LogOutput.h&quot;
 #include &quot;myMath.h&quot;
+#include &lt;assert.h&gt;
 
 CR_BIND_DERIVED(CMobileCAI ,CCommandAI , );
 
@@ -289,9 +290,8 @@
 				}
 			}
 		} else if(owner-&gt;currentFuel &lt;
-				(owner-&gt;moveType-&gt;repairBelowHealth * owner-&gt;unitDef-&gt;maxFuel)
-				&amp;&amp; commandQue.empty() || commandQue.front().id == CMD_PATROL
-				|| commandQue.front().id == CMD_FIGHT) {
+				(owner-&gt;moveType-&gt;repairBelowHealth * owner-&gt;unitDef-&gt;maxFuel) &amp;&amp; 
+				(commandQue.empty() || commandQue.front().id == CMD_PATROL || commandQue.front().id == CMD_FIGHT)) {
 			CAirBaseHandler::LandingPad* lp =
 				airBaseHandler-&gt;FindAirBase(owner, owner-&gt;unitDef-&gt;minAirBasePower);
 			if(lp) {

Modified: branches/0.77-branch/rts/Sim/Weapons/Cannon.cpp
===================================================================
--- branches/0.77-branch/rts/Sim/Weapons/Cannon.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Sim/Weapons/Cannon.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -176,14 +176,10 @@
 	} else {
 		ttl=predict*2;
 	}
+
 	SAFE_NEW CExplosiveProjectile(weaponMuzzlePos, dir * projectileSpeed, owner,
 		weaponDef, ttl, areaOfEffect, gravity);
-	//CWeaponProjectile::CreateWeaponProjectile(weaponPos,owner-&gt;speed,owner, NULL, float3(0,0,0), weaponDef);
 
-//	SAFE_NEW CSmokeProjectile(weaponPos,dir*0.01f,90,0.1f,0.02f,owner,0.6f);
-//	CHeatCloudProjectile* p=SAFE_NEW CHeatCloudProjectile(weaponPos,dir*0.02f,8,0.6f,owner);
-//	p-&gt;Update();
-//	p-&gt;maxheat=p-&gt;heat;
 	if(fireSoundId &amp;&amp; (!weaponDef-&gt;soundTrigger || salvoLeft==salvoSize-1))
 		sound-&gt;PlaySample(fireSoundId,owner,fireSoundVolume);
 //	if(weaponMuzzlePos.y &lt; 30)

Modified: branches/0.77-branch/rts/Sim/Weapons/Weapon.cpp
===================================================================
--- branches/0.77-branch/rts/Sim/Weapons/Weapon.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Sim/Weapons/Weapon.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -337,7 +337,8 @@
 	{
 		if ((weaponDef-&gt;stockpile ||
 		     (gs-&gt;Team(owner-&gt;team)-&gt;metal &gt;= metalFireCost &amp;&amp;
-		      gs-&gt;Team(owner-&gt;team)-&gt;energy &gt;= energyFireCost))) {
+		      gs-&gt;Team(owner-&gt;team)-&gt;energy &gt;= energyFireCost)))
+		{
 			std::vector&lt;int&gt; args;
 			args.push_back(0);
 			owner-&gt;cob-&gt;Call(COBFN_QueryPrimary + weaponNum, args);
@@ -362,10 +363,7 @@
 					owner-&gt;UseMetal(metalFireCost);
 					owner-&gt;currentFuel = std::max(0.0f, owner-&gt;currentFuel - fuelUsage);
 				}
-				if(weaponDef-&gt;stockpile)
-					reloadStatus=gs-&gt;frameNum+60;
-				else
-					reloadStatus=gs-&gt;frameNum+(int)(reloadTime/owner-&gt;reloadSpeed);
+				reloadStatus=gs-&gt;frameNum+(int)(reloadTime/owner-&gt;reloadSpeed);
 
 				salvoLeft=salvoSize;
 				nextSalvo=gs-&gt;frameNum;

Modified: branches/0.77-branch/rts/Sim/Weapons/WeaponDefHandler.cpp
===================================================================
--- branches/0.77-branch/rts/Sim/Weapons/WeaponDefHandler.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Sim/Weapons/WeaponDefHandler.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -50,7 +50,7 @@
 		weaponID[wd.name] = wid;
 
 		const LuaTable wdTable = rootTable.SubTable(wd.name);
-		ParseTAWeapon(wdTable, wd);
+		ParseWeapon(wdTable, wd);
 	}
 }
 
@@ -61,18 +61,15 @@
 }
 
 
-void CWeaponDefHandler::ParseTAWeapon(const LuaTable&amp; wdTable, WeaponDef&amp; wd)
+void CWeaponDefHandler::ParseWeapon(const LuaTable&amp; wdTable, WeaponDef&amp; wd)
 {
-	bool lineofsight;
 	bool ballistic;
 	//bool twophase;
-	bool beamweapon;
 	bool manualBombSettings; //Allow the user to manually specify the burst and burstrate for his AircraftBomb
 	//bool guided;
 	//bool vlaunch;
-	int rendertype;
 	int color;
-	int beamlaser;
+	int color2;
 	//bool tracking;
 	//bool selfprop;
 	//bool turret;
@@ -81,9 +78,9 @@
 
 	wd.tdfId = wdTable.GetInt(&quot;id&quot;, 0);
 
-	wd.filename = wdTable.GetString(&quot;filename&quot;, &quot;unknown&quot;);
-	wd.description = wdTable.GetString(&quot;name&quot;, &quot;Weapon&quot;);
-	wd.cegTag = wdTable.GetString(&quot;cegTag&quot;, &quot;&quot;);
+	wd.filename    = wdTable.GetString(&quot;filename&quot;, &quot;unknown&quot;);
+	wd.description = wdTable.GetString(&quot;name&quot;,     &quot;Weapon&quot;);
+	wd.cegTag      = wdTable.GetString(&quot;cegTag&quot;,   &quot;&quot;);
 
 	wd.avoidFriendly = wdTable.GetBool(&quot;avoidFriendly&quot;, true);
 	wd.avoidFeature  = wdTable.GetBool(&quot;avoidFeature&quot;,  true);
@@ -101,23 +98,15 @@
 
 	wd.dropped  = wdTable.GetBool(&quot;dropped&quot;, false);
 	manualBombSettings = wdTable.GetBool(&quot;manualBombSettings&quot;, false);
-	lineofsight = wdTable.GetBool(&quot;lineOfSight&quot;, false);
-	ballistic   = wdTable.GetBool(&quot;ballistic&quot;,  false);
-	wd.twophase = wdTable.GetBool(&quot;twoPhase&quot;,   false);
-	beamweapon  = wdTable.GetBool(&quot;beamWeapon&quot;, false);
-	wd.guided   = wdTable.GetBool(&quot;guidance&quot;,   false);
-	rendertype  = wdTable.GetInt(&quot;renderType&quot;,  0);
-	color       = wdTable.GetInt(&quot;color&quot;,       0);
-	beamlaser   = wdTable.GetInt(&quot;beamlaser&quot;,   0);
-	wd.vlaunch  = wdTable.GetBool(&quot;vlaunch&quot;,    false);
-	wd.selfprop = wdTable.GetBool(&quot;selfprop&quot;,   false);
-	wd.turret   = wdTable.GetBool(&quot;turret&quot;,     false);
+	ballistic   = wdTable.GetBool(&quot;ballistic&quot;,   false);
+	wd.twophase = wdTable.GetBool(&quot;twoPhase&quot;,    false);
+	wd.guided   = wdTable.GetBool(&quot;guidance&quot;,    false);
+	wd.vlaunch  = wdTable.GetBool(&quot;vlaunch&quot;,     false);
+	wd.selfprop = wdTable.GetBool(&quot;selfprop&quot;,    false);
+	wd.turret   = wdTable.GetBool(&quot;turret&quot;,      false);
 	wd.highTrajectory = wdTable.GetInt(&quot;highTrajectory&quot;, 2);
-	wd.noSelfDamage = wdTable.GetBool(&quot;noSelfDamage&quot;, false);
-	wd.impactOnly   = wdTable.GetBool(&quot;impactOnly&quot;,   false);
-	wd.visuals.modelName = wdTable.GetString(&quot;model&quot;, &quot;&quot;);
-	wd.visuals.smokeTrail = wdTable.GetBool(&quot;smokeTrail&quot;, false);
-	wd.visuals.alwaysVisible = wdTable.GetBool(&quot;alwaysVisible&quot;, false);
+	wd.noSelfDamage   = wdTable.GetBool(&quot;noSelfDamage&quot;, false);
+	wd.impactOnly     = wdTable.GetBool(&quot;impactOnly&quot;,   false);
 
 	wd.waterweapon   = wdTable.GetBool(&quot;waterWeapon&quot;,     false);
 	wd.fireSubmersed = wdTable.GetBool(&quot;fireSubmersed&quot;,   wd.waterweapon);
@@ -130,86 +119,36 @@
 	wd.beamtime      = wdTable.GetFloat(&quot;beamTime&quot;,       1.0f);
 	wd.beamburst     = wdTable.GetBool(&quot;beamburst&quot;,       false);
 		
-	wd.waterBounce = wdTable.GetBool(&quot;waterBounce&quot;, false);
-	wd.groundBounce = wdTable.GetBool(&quot;groundBounce&quot;, false);
-	wd.bounceSlip = wdTable.GetFloat(&quot;bounceSlip&quot;, 1);
-	wd.bounceRebound = wdTable.GetFloat(&quot;bounceRebound&quot;, 1);
-	wd.numBounce = wdTable.GetInt(&quot;numBounce&quot;, -1);
+	wd.waterBounce   = wdTable.GetBool(&quot;waterBounce&quot;,    false);
+	wd.groundBounce  = wdTable.GetBool(&quot;groundBounce&quot;,   false);
+	wd.bounceSlip    = wdTable.GetFloat(&quot;bounceSlip&quot;,    1.0f);
+	wd.bounceRebound = wdTable.GetFloat(&quot;bounceRebound&quot;, 1.0f);
+	wd.numBounce     = wdTable.GetInt(&quot;numBounce&quot;,       -1);
 
-	wd.thickness      = wdTable.GetFloat(&quot;thickness&quot;,       2.0f);
-	wd.corethickness  = wdTable.GetFloat(&quot;coreThickness&quot;,   0.25f);
+	wd.thickness      = wdTable.GetFloat(&quot;thickness&quot;,      2.0f);
+	wd.corethickness  = wdTable.GetFloat(&quot;coreThickness&quot;,  0.25f);
 	wd.laserflaresize = wdTable.GetFloat(&quot;laserFlareSize&quot;, 15.0f);
-	wd.intensity      = wdTable.GetFloat(&quot;intensity&quot;,       0.9f);
-	wd.duration       = wdTable.GetFloat(&quot;duration&quot;,        0.05f);
-	wd.falloffRate    = wdTable.GetFloat(&quot;fallOffRate&quot;,     0.5f);
-	wd.lodDistance    = wdTable.GetInt(&quot;lodDistance&quot;, 1000);
+	wd.intensity      = wdTable.GetFloat(&quot;intensity&quot;,      0.9f);
+	wd.duration       = wdTable.GetFloat(&quot;duration&quot;,       0.05f);
+	wd.falloffRate    = wdTable.GetFloat(&quot;fallOffRate&quot;,    0.5f);
+	wd.lodDistance    = wdTable.GetInt(&quot;lodDistance&quot;,      1000);
 
-	wd.visuals.sizeDecay  = wdTable.GetFloat(&quot;sizeDecay&quot;,  0.0f);
-	wd.visuals.alphaDecay = wdTable.GetFloat(&quot;alphaDecay&quot;, 1.0f);
-	wd.visuals.separation = wdTable.GetFloat(&quot;separation&quot;, 1.0f);
-	wd.visuals.noGap  = wdTable.GetBool(&quot;noGap&quot;, true);
-	wd.visuals.stages = wdTable.GetInt(&quot;stages&quot;, 5);
+	wd.visuals.modelName     = wdTable.GetString(&quot;model&quot;,       &quot;&quot;);
+	wd.visuals.smokeTrail    = wdTable.GetBool(&quot;smokeTrail&quot;,    false);
+	wd.visuals.alwaysVisible = wdTable.GetBool(&quot;alwaysVisible&quot;, false);
+	wd.visuals.sizeDecay     = wdTable.GetFloat(&quot;sizeDecay&quot;,    0.0f);
+	wd.visuals.alphaDecay    = wdTable.GetFloat(&quot;alphaDecay&quot;,   1.0f);
+	wd.visuals.separation    = wdTable.GetFloat(&quot;separation&quot;,   1.0f);
+	wd.visuals.noGap         = wdTable.GetBool(&quot;noGap&quot;,         true);
+	wd.visuals.stages        = wdTable.GetInt(&quot;stages&quot;,         5);
 
-	if (wd.name.find(&quot;disintegrator&quot;) != string::npos) {	//fulhack
-		wd.visuals.renderType = WEAPON_RENDERTYPE_FIREBALL;
-	} else if (wd.visuals.modelName.compare(&quot;&quot;) != 0) {
-		wd.visuals.renderType = WEAPON_RENDERTYPE_MODEL;
-	} else if (beamweapon) {
-		wd.visuals.renderType = WEAPON_RENDERTYPE_LASER;
-	} else {
-		wd.visuals.renderType = WEAPON_RENDERTYPE_PLASMA;
-	}
-
 	wd.gravityAffected = false;
 	if (wd.dropped || ballistic) {
 		wd.gravityAffected = true;
 	}
 
-	if (wd.dropped) {
-		wd.type = &quot;AircraftBomb&quot;;
+	wd.type = wdTable.GetString(&quot;weaponType&quot;, &quot;Cannon&quot;);
 
-	}	else if (wd.vlaunch) {
-		wd.type = &quot;StarburstLauncher&quot;;
-
-	}	else if (beamlaser) {
-		wd.type = &quot;BeamLaser&quot;;
-
-	}	else if (wd.isShield) {
-		wd.type = &quot;Shield&quot;;
-
-	} else if (wd.waterweapon) {
-		wd.type = &quot;TorpedoLauncher&quot;;
-
-	} else if (wd.name.find(&quot;disintegrator&quot;) != string::npos) {
-		wd.type = &quot;DGun&quot;;
-
-	} else if (lineofsight) {
-		if (rendertype==7) {
-			wd.type = &quot;LightingCannon&quot;;
-		} else if (beamweapon) {
-			wd.type = &quot;LaserCannon&quot;;
-		} else if (wd.visuals.modelName.find(&quot;laser&quot;) != string::npos) {
-			wd.type = &quot;LaserCannon&quot;;		//swta fix
-		} else if (/*selfprop &amp;&amp; */wd.visuals.smokeTrail) {
-			wd.type = &quot;MissileLauncher&quot;;
-		} else if (rendertype == 4 &amp;&amp; color == 2) {
-			wd.type = &quot;EmgCannon&quot;;
-		} else if (rendertype == 5) {
-			wd.type = &quot;Flame&quot;;
-		//	} else if(rendertype == 1) {
-		//		wd.type = &quot;MissileLauncher&quot;;
-		} else {
-			wd.type = &quot;Cannon&quot;;
-		}
-	} else {
-		wd.type = &quot;Cannon&quot;;
-	}
-
-	string ttype = wdTable.GetString(&quot;weaponType&quot;, &quot;&quot;);
-	if (ttype != &quot;&quot;) {
-		wd.type = ttype;
-	}
-
 //	logOutput.Print(&quot;%s as %s&quot;,weaponname.c_str(),wd.type.c_str());
 
 	const bool melee = (wd.type == &quot;Melee&quot;);
@@ -404,7 +343,8 @@
 
 	wd.onlyForward = !wd.turret &amp;&amp; (wd.type != &quot;StarburstLauncher&quot;);
 
-	const int color2 = wdTable.GetInt(&quot;color2&quot;, 0);
+	color  = wdTable.GetInt(&quot;color&quot;,  0);
+	color2 = wdTable.GetInt(&quot;color2&quot;, 0);
 
 	const float3 rgbcol = hs2rgb(color / float(255), color2 / float(255));
 	wd.visuals.color  = wdTable.GetFloat3(&quot;rgbColor&quot;,  rgbcol);

Modified: branches/0.77-branch/rts/Sim/Weapons/WeaponDefHandler.h
===================================================================
--- branches/0.77-branch/rts/Sim/Weapons/WeaponDefHandler.h	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Sim/Weapons/WeaponDefHandler.h	2008-09-23 15:51:10 UTC (rev 6447)
@@ -19,11 +19,6 @@
 #define WEAPONTYPE_STARBURSTLAUNCHER 11
 #define WEAPONTYPE_UNKNOWN 12
 
-#define WEAPON_RENDERTYPE_MODEL 1
-#define WEAPON_RENDERTYPE_LASER 2
-#define WEAPON_RENDERTYPE_PLASMA 3
-#define WEAPON_RENDERTYPE_FIREBALL 4
-
 class LuaTable;
 class CColorMap;
 class CExplosionGenerator;
@@ -143,23 +138,22 @@
 
 	unsigned int onlyTargetCategory;
 
-	float wobble;								// how much the missile will wobble around its course
-	float dance;								// how much the missile will dance
-	float trajectoryHeight;						// how high trajectory missiles will try to fly in
+	float wobble;             // how much the missile will wobble around its course
+	float dance;              // how much the missile will dance
+	float trajectoryHeight;   // how high trajectory missiles will try to fly in
 
 	struct Visuals
 	{
 		float3 color;
 		float3 color2;
 
-		int renderType;
 		//bool hasmodel;
 		std::string modelName;
 		CColorMap *colorMap;
 
 		bool smokeTrail;
 		bool beamweapon;
-		bool hardStop;	//whether the shot should fade out or stop and contract at max range
+		bool hardStop;   //whether the shot should fade out or stop and contract at max range
 
 		AtlasedTexture *texture1;
 		AtlasedTexture *texture2;
@@ -258,7 +252,7 @@
 		int numWeaponDefs;
 
 	private:
-		void ParseTAWeapon(const LuaTable&amp; wdTable, WeaponDef&amp; wd);
+		void ParseWeapon(const LuaTable&amp; wdTable, WeaponDef&amp; wd);
 		float3 hs2rgb(float h, float s);
 };
 

Modified: branches/0.77-branch/rts/Sim/Weapons/bombdropper.cpp
===================================================================
--- branches/0.77-branch/rts/Sim/Weapons/bombdropper.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/Sim/Weapons/bombdropper.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -128,7 +128,7 @@
 				weaponDef, 1000, areaOfEffect,
 				weaponDef-&gt;myGravity==0 ? mapInfo-&gt;map.gravity : -(weaponDef-&gt;myGravity));
 	}
-	//CWeaponProjectile::CreateWeaponProjectile(owner-&gt;pos,owner-&gt;speed,owner, NULL, float3(0,0,0), damages, weaponDef);
+
 	if(fireSoundId &amp;&amp; (!weaponDef-&gt;soundTrigger || salvoLeft==salvoSize-1))
 		sound-&gt;PlaySample(fireSoundId,owner,fireSoundVolume);
 }

Modified: branches/0.77-branch/rts/System/BaseNetProtocol.h
===================================================================
--- branches/0.77-branch/rts/System/BaseNetProtocol.h	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/System/BaseNetProtocol.h	2008-09-23 15:51:10 UTC (rev 6447)
@@ -96,8 +96,9 @@
 };
 
 /**
<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">- at brief</A> High level network code layer
-Provides protocoldependent functions over our CNet-Class. It includes all functions needed to send stuff without handling with the internals.
<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">+ at brief</A> A factory used to make often-used network messages.
+
+Use this if you want to create a network message. Implemented as a singleton.
  */
 class CBaseNetProtocol
 {

Modified: branches/0.77-branch/rts/System/EventHandler.h
===================================================================
--- branches/0.77-branch/rts/System/EventHandler.h	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/System/EventHandler.h	2008-09-23 15:51:10 UTC (rev 6447)
@@ -154,7 +154,7 @@
 		
 		class EventInfo {
 			public:
-				EventInfo() : propBits(0), list(NULL) {}
+				EventInfo() : list(NULL), propBits(0) {}
 				EventInfo(const std::string&amp; _name, EventClientList* _list, int _bits)
 				: name(_name), list(_list), propBits(_bits) {}
 				~EventInfo() {}
@@ -566,7 +566,7 @@
 	const int count = listStockpileChanged.size();
 	for (int i = 0; i &lt; count; i++) {
 		CEventClient* ec = listStockpileChanged[i];
-		const int ecAllyTeam = ec-&gt;GetReadAllyTeam();
+		//const int ecAllyTeam = ec-&gt;GetReadAllyTeam();
 		if (ec-&gt;CanReadAllyTeam(unitAllyTeam)) {
 			ec-&gt;StockpileChanged(unit, weapon, oldCount);
 		}

Modified: branches/0.77-branch/rts/System/GlobalStuff.cpp
===================================================================
--- branches/0.77-branch/rts/System/GlobalStuff.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/System/GlobalStuff.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -19,6 +19,7 @@
 #include &quot;Lua/LuaRules.h&quot;
 #include &quot;SDL_types.h&quot;
 #include &quot;SDL_timer.h&quot;
+#include &lt;assert.h&gt;
 
 /**
  * @brief global synced

Modified: branches/0.77-branch/rts/System/GlobalStuff.h
===================================================================
--- branches/0.77-branch/rts/System/GlobalStuff.h	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/System/GlobalStuff.h	2008-09-23 15:51:10 UTC (rev 6447)
@@ -406,13 +406,13 @@
 
 	/**
 	 * @brief set ally
-	 * @param teamA first team
-	 * @param teamB second team
+	 * @param allyteamA first allyteam
+	 * @param allyteamB second allyteam
 	 * @param allied whether or not these two teams are allied
 	 *
-	 * Sets two teams to be allied or not
+	 * Sets two allyteams to be allied or not
 	 */
-	void SetAlly(int teamA,int teamB, bool allied) { allies[teamA][teamB]=allied; }
+	void SetAlly(int allyteamA,int allyteamB, bool allied) { allies[allyteamA][allyteamB]=allied; }
 
 private:
 	/**

Modified: branches/0.77-branch/rts/System/Net/UDPConnection.cpp
===================================================================
--- branches/0.77-branch/rts/System/Net/UDPConnection.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/System/Net/UDPConnection.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -1,4 +1,3 @@
-#include &quot;StdAfx.h&quot;
 #include &lt;SDL_timer.h&gt;
 #include &lt;boost/version.hpp&gt;
 #include &lt;boost/format.hpp&gt;

Modified: branches/0.77-branch/rts/System/Net/UDPListener.cpp
===================================================================
--- branches/0.77-branch/rts/System/Net/UDPListener.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/System/Net/UDPListener.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -1,4 +1,3 @@
-#include &quot;StdAfx.h&quot;
 #include &lt;boost/weak_ptr.hpp&gt;
 #include &lt;boost/noncopyable.hpp&gt;
 #include &lt;boost/shared_ptr.hpp&gt;

Modified: branches/0.77-branch/rts/System/NetProtocol.cpp
===================================================================
--- branches/0.77-branch/rts/System/NetProtocol.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/System/NetProtocol.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -40,7 +40,6 @@
 	server.reset(conn);
 	server-&gt;SendData(CBaseNetProtocol::Get().SendAttemptConnect(wantedNumber, NETWORK_VERSION));
 	server-&gt;Flush(true);
-	isLocal = false;
 
 	if (!gameSetup || !gameSetup-&gt;hostDemo)	//TODO do we really want this?
 	{
@@ -54,7 +53,6 @@
 {
 	server.reset(new netcode::CLocalConnection);
 	server-&gt;Flush();
-	isLocal = true;
 	if (!localDemoPlayback)
 	{
 		record.reset(new CDemoRecorder());

Modified: branches/0.77-branch/rts/System/NetProtocol.h
===================================================================
--- branches/0.77-branch/rts/System/NetProtocol.h	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/System/NetProtocol.h	2008-09-23 15:51:10 UTC (rev 6447)
@@ -14,9 +14,9 @@
 };
 
 /**
<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">- at brief</A> Even higher level network code layer
<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">+ at brief</A> Client interface for handling communication with the game server.
 
-The top of the networking stack.
+Even when playing singleplayer, this is the way of communicating with the server. It keeps the connection alive, and is able to send and receive raw binary packets transparently over the network.
 */
 class CNetProtocol
 {
@@ -34,13 +34,20 @@
 	 */
 	void InitLocalClient(const unsigned wantedNumber);
 
+	/// Are we still connected (or did the connection timed out)?
 	bool Active() const;
+
+	/// This checks if any data has been already received
 	bool Connected() const;
 
+	/**
+	@brief Wheter a demo is played local
+	@todo remove
+	*/
 	bool localDemoPlayback;
 
 	/**
-	@brief Take a look at the messages that will be returned by GetData().
+	@brief Take a look at the messages in the recieve buffer (read-only)
 	@return A RawPacket holding the data, or 0 if no data
 	@param ahead How many packets to look ahead. A typical usage would be:
 	for (int ahead = 0; (packet = net-&gt;Peek(ahead)) != NULL; ++ahead) {}
@@ -48,26 +55,30 @@
 	boost::shared_ptr&lt;const netcode::RawPacket&gt; Peek(unsigned ahead) const;
 
 	/**
-	@brief Receive data from Client
-	@return The data packet, or 0 if there is no data
-	@throw network_error If there is no such connection
+	@brief Receive a single message (and remove it from the recieve buffer)
+	@return The first data packet from the buffer, or 0 if there is no data
 	
-	Receives only one message (even if there are more in the recieve buffer), so call this until you get a 0 in return
+	Receives only one message at a time (even if there are more in the recieve buffer), so call this until you get a 0 in return. When a demo recorder is present it will be recorded.
 	 */
 	boost::shared_ptr&lt;const netcode::RawPacket&gt; GetData();
 	
+	/**
+	@brief Send a message to the server
+	*/
 	void Send(boost::shared_ptr&lt;const netcode::RawPacket&gt; pkt);
+	///@overload
 	void Send(const netcode::RawPacket* pkt);
 	
 	CDemoRecorder* GetDemoRecorder() const { return record.get(); }
 
-	/// updates our network while the game loads to prevent timeouts
+	/// updates our network while the game loads to prevent timeouts (runs until \a loading is false)
 	void UpdateLoop();
+	
+	/// Must be called to send / recieve packets
 	void Update();
 	volatile bool loading;
 
 private:
-	bool isLocal;
 	boost::scoped_ptr&lt;netcode::CConnection&gt; server;
 	boost::scoped_ptr&lt;CDemoRecorder&gt; record;
 };

Modified: branches/0.77-branch/rts/System/Platform/Win/CrashHandler.cpp
===================================================================
--- branches/0.77-branch/rts/System/Platform/Win/CrashHandler.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/System/Platform/Win/CrashHandler.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -9,6 +9,7 @@
 #include &quot;Game/GameVersion.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;NetProtocol.h&quot;
+#include &quot;Rendering/GL/myGL.h&quot;
 
 namespace CrashHandler {
 
@@ -120,8 +121,11 @@
 {
 	// Prologue.
 	logOutput.RemoveAllSubscribers();
+#ifdef USE_GML
+	PRINT(&quot;Spring %s MT (%d threads) has crashed.&quot;, VERSION_STRING, gmlThreadCount);
+#else
 	PRINT(&quot;Spring %s has crashed.&quot;, VERSION_STRING);
-
+#endif
 	// Initialize IMAGEHLP.DLL.
 	SymInitialize(GetCurrentProcess(), &quot;.&quot;, TRUE);
 

Modified: branches/0.77-branch/rts/System/Platform/Win/WinFileSystemHandler.cpp
===================================================================
--- branches/0.77-branch/rts/System/Platform/Win/WinFileSystemHandler.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/System/Platform/Win/WinFileSystemHandler.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -1 +1,2 @@
+#include &quot;StdAfx.h&quot;
 #include &quot;Platform/Linux/UnixFileSystemHandler.cpp&quot;

Modified: branches/0.77-branch/rts/System/Platform/Win/WinVersion.cpp
===================================================================
--- branches/0.77-branch/rts/System/Platform/Win/WinVersion.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/System/Platform/Win/WinVersion.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -1,3 +1,4 @@
+#include &quot;StdAfx.h&quot;
 #include &lt;sstream&gt;
 #include &lt;string&gt;
 

Modified: branches/0.77-branch/rts/System/Platform/byteorder.h
===================================================================
--- branches/0.77-branch/rts/System/Platform/byteorder.h	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/System/Platform/byteorder.h	2008-09-23 15:51:10 UTC (rev 6447)
@@ -20,6 +20,8 @@
 #ifndef BYTEORDER_H
 #define BYTEORDER_H
 
+#include &lt;string.h&gt;
+
 /*
  * The swabbing stuff looks backwards, but the files
  * are _originally_ little endian (win32 x86).
@@ -33,10 +35,10 @@
 #if __BYTE_ORDER == __BIG_ENDIAN
 #define swabword(w)	(bswap_16(w))
 #define swabdword(w)	(bswap_32(w))
-/* 
+/*
    My brother tells me that a C compiler must store floats in memory
    by a particular standard, except for the endianness; hence, this
-   will work on all C compilers. 
+   will work on all C compilers.
  */
 static inline float swabfloat(float w) {
 	char octets[4];

Modified: branches/0.77-branch/rts/System/Sync/SyncDebugger.cpp
===================================================================
--- branches/0.77-branch/rts/System/Sync/SyncDebugger.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/System/Sync/SyncDebugger.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -11,7 +11,7 @@
 #include &quot;SyncDebugger.h&quot;
 #include &quot;Logger.h&quot;
 
-
+#include &lt;map&gt;
 #ifndef WIN32
 /* for backtrace() function */
 # include &lt;execinfo.h&gt;
@@ -177,10 +177,14 @@
 		for (unsigned i = 0; i &lt; historybt[index].bt_size; ++i) {
 			// the &quot;{%p}&quot; part is resolved to &quot;functionname [filename:lineno]&quot;
 			// by the CLogger class.
+#ifndef _WIN32
+			logger.AddLine(&quot;%s#%u {%p}&quot;, prefix, i, historybt[index].bt[i]);
+#else
 			if (sizeof(void*) == 8)
 				logger.AddLine(&quot;%s#%u {%llx}&quot;, prefix, i, (uint64_t)historybt[index].bt[i]);
 			else
 				logger.AddLine(&quot;%s#%u {%x}&quot;, prefix, i, (uint32_t)historybt[index].bt[i]);
+#endif
 		}
 	}
 }

Modified: branches/0.77-branch/rts/build/cmake/TestCXXAcceptsVisibilityFlag.cmake
===================================================================
--- branches/0.77-branch/rts/build/cmake/TestCXXAcceptsVisibilityFlag.cmake	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/build/cmake/TestCXXAcceptsVisibilityFlag.cmake	2008-09-23 15:51:10 UTC (rev 6447)
@@ -1,17 +1,30 @@
 # - Test whether the C++ compiler supports &quot;-fvisibility=hidden&quot;
 # Once done this will define
 #
-# VISIBILITY_HIDDEN - -fvisibility=hidden if supported, an empty string otherwise.
+# VISIBILITY_HIDDEN - -fvisibility=hidden   if supported, an empty string otherwise.
+# VISIBILITY_INLINES_HIDDEN - -fvisibility-inlines-hidden   likewise
 #
 # Copyright (C) 2008 Tobi Vollebregt
+# Copyright (C) 2008 Karl-Robert Ernst
 #
+# Note: gcc for windows supports these flags, but give lots of errors when compiling, so use only for linux builds
 
-IF(NOT DEFINED CMAKE_CXX_FLAGS)
-	INCLUDE(TestCXXAcceptsFlag)
-	CHECK_CXX_ACCEPTS_FLAG(-fvisibility=hidden VISIBILITY_HIDDEN)
-	IF(VISIBILITY_HIDDEN)
-		SET(VISIBILITY_HIDDEN -fvisibility=hidden)
-	ELSE(VISIBILITY_HIDDEN)
+INCLUDE(TestCXXAcceptsFlag)
+
+IF(NOT DEFINED VISIBILITY_HIDDEN)
+	CHECK_CXX_ACCEPTS_FLAG(-fvisibility=hidden HAS_VISIBILITY_HIDDEN)
+	IF(HAS_VISIBILITY_HIDDEN AND NOT MINGW)
+		SET(VISIBILITY_HIDDEN &quot;-fvisibility=hidden&quot;)
+	ELSE(HAS_VISIBILITY_HIDDEN AND NOT MINGW)
 		SET(VISIBILITY_HIDDEN &quot;&quot;)
-	ENDIF(VISIBILITY_HIDDEN )
-ENDIF(NOT DEFINED CMAKE_CXX_FLAGS) 
+	ENDIF(HAS_VISIBILITY_HIDDEN AND NOT MINGW)
+ENDIF(NOT DEFINED VISIBILITY_HIDDEN)
+	
+IF(NOT DEFINED VISIBILITY_INLINES_HIDDEN)
+	CHECK_CXX_ACCEPTS_FLAG(-fvisibility-inlines-hidden HAS_VISIBILITY_INLINES_HIDDEN)
+	IF(HAS_VISIBILITY_INLINES_HIDDEN AND NOT MINGW)
+		SET(VISIBILITY_INLINES_HIDDEN &quot;-fvisibility-inlines-hidden&quot;)
+	ELSE(HAS_VISIBILITY_INLINES_HIDDEN AND NOT MINGW)
+		SET(VISIBILITY_INLINES_HIDDEN &quot;&quot;)
+	ENDIF(HAS_VISIBILITY_INLINES_HIDDEN AND NOT MINGW)
+ENDIF(NOT DEFINED VISIBILITY_INLINES_HIDDEN)

Modified: branches/0.77-branch/rts/lib/CMakeLists.txt
===================================================================
--- branches/0.77-branch/rts/lib/CMakeLists.txt	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/lib/CMakeLists.txt	2008-09-23 15:51:10 UTC (rev 6447)
@@ -1,28 +1,25 @@
 INCLUDE_DIRECTORIES(streflop lua/include luabind ${CMAKE_SOURCE_DIR}/rts/System)
 
+ADD_DEFINITIONS(${PIC_FLAG}) # all libraries need to be position independent (gives compiler warnings on 64bit-linux
+
 AUX_SOURCE_DIRECTORY(lua/src lualibfiles)
 ADD_LIBRARY(lua STATIC ${lualibfiles})
 TARGET_LINK_LIBRARIES(lua streflop)
 if (UNIX)
-	SET_TARGET_PROPERTIES(lua PROPERTIES COMPILE_FLAGS &quot;-DLUA_USE_MKSTEMP -fpic&quot;)
-else (UNIX)
-	SET_TARGET_PROPERTIES(lua PROPERTIES COMPILE_FLAGS -fpic)
+	SET_TARGET_PROPERTIES(lua PROPERTIES COMPILE_FLAGS -DLUA_USE_MKSTEMP)
 endif (UNIX)
 
 AUX_SOURCE_DIRECTORY(luabind/src luabindfiles)
 ADD_LIBRARY(luabind STATIC EXCLUDE_FROM_ALL ${luabindfiles})
 TARGET_LINK_LIBRARIES(luabind lua)
-SET_TARGET_PROPERTIES(luabind PROPERTIES COMPILE_FLAGS &quot;-fpic&quot;)
 
 ADD_DEFINITIONS(-D_SZ_ONE_DIRECTORY)
 AUX_SOURCE_DIRECTORY(7zip 7zipfiles)
 ADD_LIBRARY(7zip STATIC EXCLUDE_FROM_ALL ${7zipfiles})
-SET_TARGET_PROPERTIES(7zip PROPERTIES COMPILE_FLAGS -fpic)
 
 AUX_SOURCE_DIRECTORY(hpiutil2 hpifiles)
 ADD_LIBRARY(hpiutil2 STATIC EXCLUDE_FROM_ALL ${hpifiles})
 TARGET_LINK_LIBRARIES(hpiutil2 z)
-SET_TARGET_PROPERTIES(hpiutil2 PROPERTIES COMPILE_FLAGS -fpic)
 
 AUX_SOURCE_DIRECTORY(gml gmlfiles)
 ADD_LIBRARY(gml STATIC EXCLUDE_FROM_ALL ${gmlfiles})
@@ -31,7 +28,6 @@
 else (MINGW)
 	TARGET_LINK_LIBRARIES(gml GL GLU)
 endif (MINGW)
-SET_TARGET_PROPERTIES(gml PROPERTIES COMPILE_FLAGS &quot;-fpic&quot;)
 
 IF (UNIX)
 	ADD_LIBRARY(minizip STATIC EXCLUDE_FROM_ALL minizip/unzip minizip/zip minizip/ioapi)
@@ -39,6 +35,5 @@
 	ADD_LIBRARY(minizip STATIC EXCLUDE_FROM_ALL minizip/unzip minizip/zip minizip/iowin32 minizip/ioapi)
 ENDIF (UNIX)
 TARGET_LINK_LIBRARIES(minizip z)
-SET_TARGET_PROPERTIES(minizip PROPERTIES COMPILE_FLAGS -fpic)
 
 ADD_SUBDIRECTORY(streflop)
\ No newline at end of file

Modified: branches/0.77-branch/rts/lib/gml/gml.cpp
===================================================================
--- branches/0.77-branch/rts/lib/gml/gml.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/lib/gml/gml.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -31,8 +31,8 @@
 // Please note: Some functions may require more advanced coding to implement
 // If a function is not yet supported by GML, a compile error pointing to 'GML_FUNCTION_NOT_IMPLEMENTED' will occur
 
+#include &quot;StdAfx.h&quot;
 #ifdef USE_GML
-#include &quot;StdAfx.h&quot;
 #include &quot;gmlcls.h&quot;
 
 #define EXEC_RUN (BYTE *)NULL
@@ -112,13 +112,13 @@
 	if(gmlInited)
 		return;
 	for(int i=0; i&lt;sizeof(gmlIntParams)/sizeof(GLenum); ++i) {
-   	GLint gi;
- 	  glGetIntegerv(gmlIntParams[i],&amp;gi);
+		GLint gi;
+		glGetIntegerv(gmlIntParams[i],&amp;gi);
 		gmlGetIntegervCache[gmlIntParams[i]]=gi;
 	}
 	for(int i=0; i&lt;sizeof(gmlFloatParams)/sizeof(GLenum); ++i) {
-   	GLfloat fi;
- 	  glGetFloatv(gmlFloatParams[i],&amp;fi);
+		GLfloat fi;
+		glGetFloatv(gmlFloatParams[i],&amp;fi);
 		gmlGetFloatvCache[gmlFloatParams[i]]=fi;
 	}
 	for(int i=0; i&lt;sizeof(gmlStringParams)/sizeof(GLenum); ++i) {
@@ -134,12 +134,18 @@
 EXTERN inline GLhandleARB glCreateShader_FRAGMENT() {
 	return glCreateShader(GL_FRAGMENT_SHADER);
 }
+EXTERN inline GLhandleARB glCreateShader_GEOMETRY_EXT() {
+	return glCreateShader(GL_GEOMETRY_SHADER_EXT);
+}
 EXTERN inline GLhandleARB glCreateShaderObjectARB_VERTEX() {
 	return glCreateShaderObjectARB(GL_VERTEX_SHADER_ARB);
 }
 EXTERN inline GLhandleARB glCreateShaderObjectARB_FRAGMENT() {
 	return glCreateShaderObjectARB(GL_FRAGMENT_SHADER_ARB);
 }
+EXTERN inline GLhandleARB glCreateShaderObjectARB_GEOMETRY_EXT() {
+	return glCreateShaderObjectARB(GL_GEOMETRY_SHADER_EXT);
+}
 gmlQueue gmlQueues[GML_MAX_NUM_THREADS];
 
 boost::thread *gmlThreads[GML_MAX_NUM_THREADS];
@@ -150,9 +156,11 @@
 
 gmlSingleItemServer&lt;GLhandleARB, GLhandleARB (*)(void)&gt; gmlShaderServer_VERTEX(&amp;glCreateShader_VERTEX, 2, 0);
 gmlSingleItemServer&lt;GLhandleARB, GLhandleARB (*)(void)&gt; gmlShaderServer_FRAGMENT(&amp;glCreateShader_FRAGMENT, 2, 0);
+gmlSingleItemServer&lt;GLhandleARB, GLhandleARB (*)(void)&gt; gmlShaderServer_GEOMETRY_EXT(&amp;glCreateShader_GEOMETRY_EXT, 2, 0);
 
 gmlSingleItemServer&lt;GLhandleARB, GLhandleARB (*)(void)&gt; gmlShaderObjectARBServer_VERTEX(&amp;glCreateShaderObjectARB_VERTEX, 2, 0);
 gmlSingleItemServer&lt;GLhandleARB, GLhandleARB (*)(void)&gt; gmlShaderObjectARBServer_FRAGMENT(&amp;glCreateShaderObjectARB_FRAGMENT, 2, 0);
+gmlSingleItemServer&lt;GLhandleARB, GLhandleARB (*)(void)&gt; gmlShaderObjectARBServer_GEOMETRY_EXT(&amp;glCreateShaderObjectARB_GEOMETRY_EXT, 2, 0);
 gmlSingleItemServer&lt;GLUquadric *, GLUquadric *(GML_GLAPIENTRY *)(void)&gt; gmlQuadricServer(&amp;gluNewQuadric, 100, 25);
 
 gmlMultiItemServer&lt;GLuint, GLsizei, void (GML_GLAPIENTRY *)(GLsizei,GLuint *)&gt; gmlTextureServer(&amp;glGenTextures, 100, 25);
@@ -198,7 +206,7 @@
 	else {
 		*(BYTE * volatile *)&amp;Write=Queue2=(BYTE *)realloc(Queue2,newsize);
 		Size2=Queue2+newsize;
-	}  
+	}
 	*(BYTE * volatile *)&amp;WritePos=Write+oldpos;
 	*(BYTE * volatile *)&amp;WriteSize=Write+newsize;
 
@@ -330,7 +338,7 @@
 		if(!critical)
 			return FALSE;
 		boost::thread::yield();
-	} 
+	}
 }
 
 void gmlQueue::ReleaseRead() {
@@ -377,7 +385,7 @@
 
 void gmlQueue::SyncRequest() {
 #if GML_ALTERNATE_SYNCMODE
-  // make sure server is finished with other queue
+	// make sure server is finished with other queue
 	if(Write==Queue1) {
 		while(*(BYTE * volatile *)&amp;Pos2!=Queue2)
 			boost::thread::yield();
@@ -578,23 +586,23 @@
 //glLight
 #define GML_MAKESUBHANDLER2(flag,fun,arg,name)\
 	if(GML_D(name,ClientState) &amp; (1&lt;&lt;(flag-GL_VERTEX_ARRAY))) {\
- 		fun(0,(GLboolean *)((GML_D(name,ClientState) &amp; GML_##arg##_ARRAY_BUFFER)?GML_D(name,arg##pointer):ptr));\
+		fun(0,(GLboolean *)((GML_D(name,ClientState) &amp; GML_##arg##_ARRAY_BUFFER)?GML_D(name,arg##pointer):ptr));\
 		ptr+=GML_D(name,arg##totalsize);\
 	}
 #define GML_MAKESUBHANDLER3(flag,fun,arg,name)\
 	if(GML_D(name,ClientState) &amp; (1&lt;&lt;(flag-GL_VERTEX_ARRAY))) {\
- 		fun(GML_D(name,arg##type),0,(GML_D(name,ClientState) &amp; GML_##arg##_ARRAY_BUFFER)?GML_D(name,arg##pointer):ptr);\
+		fun(GML_D(name,arg##type),0,(GML_D(name,ClientState) &amp; GML_##arg##_ARRAY_BUFFER)?GML_D(name,arg##pointer):ptr);\
 		ptr+=GML_D(name,arg##totalsize);\
 	}
 #define GML_MAKESUBHANDLER4(flag,fun,arg,name)\
 	if(GML_D(name,ClientState) &amp; (1&lt;&lt;(flag-GL_VERTEX_ARRAY))) {\
- 		fun(GML_D(name,arg##size),GML_D(name,arg##type),0,(GML_D(name,ClientState) &amp; GML_##arg##_ARRAY_BUFFER)?GML_D(name,arg##pointer):ptr);\
+		fun(GML_D(name,arg##size),GML_D(name,arg##type),0,(GML_D(name,ClientState) &amp; GML_##arg##_ARRAY_BUFFER)?GML_D(name,arg##pointer):ptr);\
 		ptr+=GML_D(name,arg##totalsize);\
 	}
 #define GML_MAKESUBHANDLERVA(name)\
 	for(int i=0; i&lt;GML_D(name,VAcount); ++i) {\
 		VAstruct *va=(VAstruct *)ptr;\
- 		glVertexAttribPointer(va-&gt;target,va-&gt;size,va-&gt;type,va-&gt;normalized,0,va-&gt;buffer?va-&gt;pointer:(ptr+sizeof(VAstruct)));\
+		glVertexAttribPointer(va-&gt;target,va-&gt;size,va-&gt;type,va-&gt;normalized,0,va-&gt;buffer?va-&gt;pointer:(ptr+sizeof(VAstruct)));\
 		ptr+=va-&gt;totalsize;\
 	}
 
@@ -907,7 +915,7 @@
 	BYTE *ptr=NULL;
 
 	while(p&lt;e) {
-//	 	GML_DEBUG(&quot;Cmd &quot;,*(int *)p, 2);
+//		GML_DEBUG(&quot;Cmd &quot;,*(int *)p, 2);
 		QueueHandler(p,ptr);
 //		++procs;
 	}
@@ -990,7 +998,7 @@
 			if(p==e)
 				break;
 		}
-//	 	GML_DEBUG(&quot;CmdSync &quot;,*(int *)p, 2);
+//		GML_DEBUG(&quot;CmdSync &quot;,*(int *)p, 2);
 		QueueHandler(p,ptr);
 //		++procs;
 	}

Modified: branches/0.77-branch/rts/lib/gml/gml.h
===================================================================
--- branches/0.77-branch/rts/lib/gml/gml.h	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/lib/gml/gml.h	2008-09-23 15:51:10 UTC (rev 6447)
@@ -16,7 +16,6 @@
 
 #include &lt;set&gt;
 #include &lt;map&gt;
-#include &lt;GL/glew.h&gt;
 
 #include &quot;gmlcls.h&quot;
 
@@ -69,9 +68,11 @@
 
 extern gmlSingleItemServer&lt;GLhandleARB, GLhandleARB (*)(void)&gt; gmlShaderServer_VERTEX;
 extern gmlSingleItemServer&lt;GLhandleARB, GLhandleARB (*)(void)&gt; gmlShaderServer_FRAGMENT;
+extern gmlSingleItemServer&lt;GLhandleARB, GLhandleARB (*)(void)&gt; gmlShaderServer_GEOMETRY_EXT;
 
 extern gmlSingleItemServer&lt;GLhandleARB, GLhandleARB (*)(void)&gt; gmlShaderObjectARBServer_VERTEX;
 extern gmlSingleItemServer&lt;GLhandleARB, GLhandleARB (*)(void)&gt; gmlShaderObjectARBServer_FRAGMENT;
+extern gmlSingleItemServer&lt;GLhandleARB, GLhandleARB (*)(void)&gt; gmlShaderObjectARBServer_GEOMETRY_EXT;
 
 extern void gmlInit();
 
@@ -86,6 +87,8 @@
 		return gmlShaderServer_VERTEX.GetItems();
 	if(type==GL_FRAGMENT_SHADER)
 		return gmlShaderServer_FRAGMENT.GetItems();
+	if(type==GL_GEOMETRY_SHADER_EXT)
+		return gmlShaderServer_GEOMETRY_EXT.GetItems();
 	return 0;
 }
 EXTERN inline GLhandleARB gmlCreateShaderObjectARB(GLenum type) {
@@ -93,6 +96,8 @@
 		return gmlShaderObjectARBServer_VERTEX.GetItems();
 	if(type==GL_FRAGMENT_SHADER_ARB)
 		return gmlShaderObjectARBServer_FRAGMENT.GetItems();
+	if(type==GL_GEOMETRY_SHADER_EXT)
+		return gmlShaderObjectARBServer_GEOMETRY_EXT.GetItems();
 	return 0;
 }
 EXTERN inline GLUquadric *gmluNewQuadric() {

Modified: branches/0.77-branch/rts/lib/gml/gmlcls.h
===================================================================
--- branches/0.77-branch/rts/lib/gml/gmlcls.h	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/lib/gml/gmlcls.h	2008-09-23 15:51:10 UTC (rev 6447)
@@ -28,9 +28,9 @@
 #include &lt;set&gt;
 
 #ifdef USE_GML
-#define GML_ENABLE 1
+#	define GML_ENABLE 1
 #else
-#define GML_ENABLE 0 // manually enable opengl multithreading here
+#	define GML_ENABLE 0 // manually enable opengl multithreading here
 #endif
 
 #define GML_ENABLE_SIM (GML_ENABLE &amp;&amp; 1) // runs the sim in a separate thread
@@ -108,9 +108,10 @@
 #endif
 
 #if !defined(WIN32) &amp;&amp; !defined(_WIN32) &amp;&amp; !defined(__WIN32__) //defined(__linux__) || defined(__APPLE__) || defined(__FreeBSD__)
-#define GML_USE_SPEEDY_TLS 1
+#	define GML_USE_SPEEDY_TLS 1
+#include &quot;System/Platform/errorhandler.h&quot;
 #else
-#define GML_USE_SPEEDY_TLS 0
+#	define GML_USE_SPEEDY_TLS 0
 #endif
 #if GML_USE_SPEEDY_TLS
 #	include &quot;speedy-tls.h&quot;
@@ -121,28 +122,28 @@
 #if GML_ENABLE
 #	ifdef _MSC_VER
 #		if GML_MSC_TLS_OPT
-static inline unsigned long get_threadnum(void) {
-	unsigned long val;
+inline int get_threadnum(void) {
+	int val;
 	__asm {
-#if !defined(_WIN64) || !GML_64BIT_USE_GS
+#			if !defined(_WIN64) || !GML_64BIT_USE_GS
 		mov EAX, FS:[14h]
-#else
+#			else
 		mov EAX, GS:[28h]
-#endif
+#			endif
 		mov [val], EAX
 	}
 	return val;
 }
 #			define gmlThreadNumber get_threadnum()
 #			undef set_threadnum
-static inline void set_threadnum(unsigned long val) {
+inline void set_threadnum(int val) {
 	__asm {
 		mov EAX, [val]
-#if !defined(_WIN64) || !GML_64BIT_USE_GS
+#			if !defined(_WIN64) || !GML_64BIT_USE_GS
 		mov FS:[14h], EAX
-#else
+#			else
 		mov GS:[28h], EAX
-#endif
+#			endif
 	}
 }
 #		else
@@ -150,33 +151,33 @@
 #		endif
 #	else
 #		if GML_GCC_TLS_FIX || GML_USE_SPEEDY_TLS
-static inline unsigned long get_threadnum(void) {
-	unsigned long val;
-#			if GML_GCC_TLS_FIX
+inline int get_threadnum(void) {
+	int val;
+#			if GML_USE_SPEEDY_TLS
+	speedy_tls_get_int32(0, 0, 4, val);
+#			else
 #				if !defined(_WIN64) || !GML_64BIT_USE_GS
 	__asm__(&quot;mov %%fs:0x14, %0&quot; : &quot;=r&quot; (val) : : );
 #				else
 	__asm__(&quot;mov %%gs:0x28, %0&quot; : &quot;=r&quot; (val) : : );
 #				endif
-#			else
-	speedy_tls_get_int32(0, 0, sizeof(unsigned long), val);
 #			endif
 	return val;
 }
 #			define gmlThreadNumber get_threadnum()
 #			undef set_threadnum
-static inline void set_threadnum(unsigned long val) {
-#			if GML_GCC_TLS_FIX
+inline void set_threadnum(int val) {
+#			if GML_USE_SPEEDY_TLS
+	if (speedy_tls_init(sizeof(int))&lt;0) { // this works because we only set the thread number once per thread
+		handleerror(NULL, &quot;Failed to initialize Thread Local Storage&quot;, &quot;GML error:&quot;, MBF_OK | MBF_EXCL);
+	}
+	speedy_tls_put_int32(0, 0, 4, val);
+#			else
 #				if !defined(_WIN64) || !GML_64BIT_USE_GS
 	__asm__ __volatile__(&quot;mov %0,%%fs:0x14&quot; : : &quot;r&quot; (val));
 #				else
 	__asm__ __volatile__(&quot;mov %0,%%gs:0x28&quot; : : &quot;r&quot; (val));
 #				endif
-#			else
-	if (speedy_tls_init(sizeof(unsigned long))&lt;0) { // this works because we only set the thread number once per thread
-		handleerror(NULL, &quot;Failed to initialize Thread Local Storage&quot;, &quot;GML error:&quot;, MBF_OK | MBF_EXCL);
-	}
-	speedy_tls_put_int32(0, 0, sizeof(unsigned long), val);
 #			endif
 }
 #		else
@@ -290,7 +291,7 @@
 };
 
 #if !defined(BOOST_HAS_THREADS) || (!defined(BOOST_AC_USE_PTHREADS) &amp;&amp; (BOOST_VERSION&lt;103500 || !(defined(__GNUC__) &amp;&amp; (defined(__i386__) || defined(__x86_64__)))) &amp;&amp; (defined(WIN32) || defined(_WIN32) || defined(__WIN32__)))
-#define gmlCount boost::detail::atomic_count
+#	define gmlCount boost::detail::atomic_count
 #else
 class gmlCount : public boost::detail::atomic_count {
 public:

Modified: branches/0.77-branch/rts/lib/gml/gmldef.h
===================================================================
--- branches/0.77-branch/rts/lib/gml/gmldef.h	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/lib/gml/gmldef.h	2008-09-23 15:51:10 UTC (rev 6447)
@@ -459,8 +459,8 @@
 #define glRasterPos2i gmlRasterPos2i
 #define glReadBuffer gmlReadBuffer
 #define glScissor gmlScissor
-#define glShaderSource
-#define glShaderSourceARB
+#define glShaderSource gmlShaderSource
+#define glShaderSourceARB gmlShaderSourceARB
 #define glTexCoord2fv gmlTexCoord2fv
 #define glTexParameterfv gmlTexParameterfv
 #define glTranslated gmlTranslated

Modified: branches/0.77-branch/rts/lib/gml/gmlfun.h
===================================================================
--- branches/0.77-branch/rts/lib/gml/gmlfun.h	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/lib/gml/gmlfun.h	2008-09-23 15:51:10 UTC (rev 6447)
@@ -663,7 +663,7 @@
 		GLint sl=(len?strlen(C[i]):D[i])+1;\
 		datasize+=sl;\
 		((intptr_t *)&amp;(p-&gt;C))[i]=sl;\
-			--sl;\
+		--sl;\
 		while(qd-&gt;WritePos+datasize&gt;=qd-&gt;WriteSize)\
 			p=(gml##name##Data *)qd-&gt;WaitRealloc(&amp;e);\
 		memcpy(e,C[i],sl);\

Modified: branches/0.77-branch/rts/lib/streflop/CMakeLists.txt
===================================================================
--- branches/0.77-branch/rts/lib/streflop/CMakeLists.txt	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/rts/lib/streflop/CMakeLists.txt	2008-09-23 15:51:10 UTC (rev 6447)
@@ -3,7 +3,7 @@
 AUX_SOURCE_DIRECTORY(libm/ldbl-96 libm_ldbl96_source)
 
 # FIXME: Random.cpp fails if it libm/headers is in include directory
-# th&lt;ts why it is set in cxxflags as a workaround
+# thats why it is set in cxxflags as a workaround
 #INCLUDE_DIRECTORIES(libm/headers)
 
 SET(cxxflags &quot;-w -O3 -I${CMAKE_CURRENT_SOURCE_DIR}/libm/headers&quot;)
@@ -19,4 +19,3 @@
 #	${libm_dbl64_source}
 #	${libm_ldbl96_source}
 )
-SET_TARGET_PROPERTIES(streflop PROPERTIES COMPILE_FLAGS -fpic)

Modified: branches/0.77-branch/tools/DedicatedServer/CMakeLists.txt
===================================================================
--- branches/0.77-branch/tools/DedicatedServer/CMakeLists.txt	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/tools/DedicatedServer/CMakeLists.txt	2008-09-23 15:51:10 UTC (rev 6447)
@@ -1,13 +1,6 @@
-IF (MINGW)
-ELSE (MINGW)
-	FIND_PACKAGE(SDL REQUIRED)
-	INCLUDE_DIRECTORIES(${SDL_INCLUDE_DIR})
+ADD_DEFINITIONS(-DSTREFLOP_X87) # should be in ../../CMakeLists.txt
+ADD_DEFINITIONS(-DDEDICATED ${PIC_FLAG} -DNO_AVI)
 
-	FIND_PACKAGE(Boost 1.34.0 COMPONENTS thread regex REQUIRED)
-ENDIF (MINGW)
-
-ADD_DEFINITIONS( -DSTREFLOP_X87 -D_SZ_ONE_DIRECTORY -DNO_AVI -DDEDICATED -DSYNCCHECK -fPIC)
-
 AUX_SOURCE_DIRECTORY(../../rts/System/Net/ netfiles)
 INCLUDE_DIRECTORIES(../../rts/System/Net/ ../../rts/System/ ../../rts/lib/lua/include)
 INCLUDE_DIRECTORIES(../../rts/ ../../rts/Game ../../rts/lib/7zip ../../rts/System)
@@ -57,10 +50,13 @@
 	../../rts/Lua/LuaUtils
 	../../rts/Map/MapParser
 	../../rts/Rendering/Textures/TAPalette)
-TARGET_LINK_LIBRARIES(server SDL boost_thread-mt hpiutil2 7zip minizip lua boost_regex-mt)
-IF (MINGW)
-	TARGET_LINK_LIBRARIES(server ws2_32)
-ENDIF (MINGW)
+TARGET_LINK_LIBRARIES(server SDL hpiutil2 7zip minizip lua)
+if (MINGW)
+	TARGET_LINK_LIBRARIES (server ws2_32 boost_thread-mt boost_regex-mt)
+else (MINGW)
+	TARGET_LINK_LIBRARIES (server ${Boost_REGEX_LIBRARY} ${Boost_THREAD_LIBRARY})
+	ADD_DEFINITIONS (-fvisibility=default ) #overwrite hidden visibility
+endif (MINGW)
 
 ADD_EXECUTABLE(dedicated main)
 TARGET_LINK_LIBRARIES(dedicated server)

Modified: branches/0.77-branch/tools/SpringInstaller/debian/changelog
===================================================================
--- branches/0.77-branch/tools/SpringInstaller/debian/changelog	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/tools/SpringInstaller/debian/changelog	2008-09-23 15:51:10 UTC (rev 6447)
@@ -1,5 +1,5 @@
-spring-installer (20080908-1) hardy; urgency=low
+spring-installer (20080917-0ubuntu1) hardy; urgency=low
 
   * Initial release
 
- -- Chris Clearwater &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">chris at detrino.org</A>&gt;  Mon, 08 Sep 2008 02:59:24 -0700
+ -- Chris Clearwater &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">chris at detrino.org</A>&gt;  Wed, 17 Sep 2008 11:05:05 -0700

Modified: branches/0.77-branch/tools/SpringInstaller/fileSystem.ml
===================================================================
--- branches/0.77-branch/tools/SpringInstaller/fileSystem.ml	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/tools/SpringInstaller/fileSystem.ml	2008-09-23 15:51:10 UTC (rev 6447)
@@ -1,22 +1,31 @@
+let fold_left f accu in_chan block_size =
+  let string = String.create block_size in
+
+  let rec loop accu =
+    let n = input in_chan string 0 block_size in
+      if n = 0 then
+        accu
+      else
+        loop (f accu string n) in    
+
+    loop accu
+        
 let copy src dst =
-  let string = String.create 4096 in
   let in_chan = open_in_bin src in
   let out_chan = open_out_bin dst in
-    
-  let rec f () =
-    let n = input in_chan string 0 (String.length string) in
-      if n = 0 then
-        ()
-      else
-        begin
-          output out_chan string 0 n;
-          f ()
-        end in
-    
-    f ();
+  let f () string n = output out_chan string 0 n in
+    fold_left f () in_chan 4096;
     close_in in_chan;
     close_out out_chan
       
+let read src =
+  let in_chan = open_in_bin src in
+  let buffer = Buffer.create 4096 in
+  let f () string n = Buffer.add_substring buffer string 0 n in
+    fold_left f () in_chan 4096;
+    close_in in_chan;
+    Buffer.contents buffer
+    
 let move src dst =
   if src != dst then
     try
@@ -26,3 +35,25 @@
       Sys.remove src
   else
     ()
+
+let size path = (Unix.stat path).Unix.st_size
+
+let make_dir path =
+  if Sys.file_exists path then
+    if Sys.is_directory path then
+      ()
+    else
+      raise (Sys_error 
+               (Printf.sprintf
+                  &quot;Error creating directory %s: File exists but is not a directory&quot;
+                  path))
+  else
+    try
+      Unix.mkdir path 0o755;
+    with
+        Unix.Unix_error (error, _, _) -&gt;
+          raise (Sys_error
+                   (Printf.sprintf
+                      &quot;Error creating directory %s: %s&quot;
+                      path
+                      (Unix.error_message error)))

Modified: branches/0.77-branch/tools/SpringInstaller/release.sh
===================================================================
--- branches/0.77-branch/tools/SpringInstaller/release.sh	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/tools/SpringInstaller/release.sh	2008-09-23 15:51:10 UTC (rev 6447)
@@ -10,7 +10,7 @@
 cd &quot;$TMPDIR&quot;
 tar -zcvf &quot;$SOURCETARGZ&quot; &quot;$SOURCEDIR&quot;
 cd &quot;$SOURCEDIR&quot;
-dpkg-buildpackage
+debuild -S -sa
 cd &quot;$TMPDIR&quot;
 rm -rf &quot;$SOURCEDIR&quot;
 cd $TARGET

Modified: branches/0.77-branch/tools/SpringInstaller/spring_installer.ml
===================================================================
--- branches/0.77-branch/tools/SpringInstaller/spring_installer.ml	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/tools/SpringInstaller/spring_installer.ml	2008-09-23 15:51:10 UTC (rev 6447)
@@ -42,13 +42,14 @@
   let spring_dir_entry = GEdit.entry
     ~packing:(table#attach ~left:1 ~top:0 ~expand:`X)
     () in
+
   let spring_dir_entry_defaults () = spring_dir_entry#set_text datadir in
   let spring_dir_entry_get () = spring_dir_entry#text in
 
-  (* Filename *)
+  (* Install as *)
 
   let _ = GMisc.label
-    ~text:&quot;Filename&quot;
+    ~text:&quot;Install as&quot;
     ~packing:(table#attach ~left:0 ~top:1)
     () in
     
@@ -56,7 +57,8 @@
     ~packing:(table#attach ~left:1 ~top:1 ~expand:`X)
     () in
 
-  let basename_entry_defaults () = basename_entry#set_text (Filename.basename path) in
+  let basename_entry_defaults () =
+    basename_entry#set_text (Filename.basename path) in
   let basename_entry_get () = basename_entry#text in
 
   (* Archive Kind *)
@@ -92,14 +94,14 @@
     ~packing:(vbox#pack ~fill:false ~expand:false)
     () in
     
-  (* Exit *)
+  (* Cancel *)
 
-  let exit_button = GButton.button
-    ~label:&quot;Exit&quot;
+  let cancel_button = GButton.button
+    ~label:&quot;Cancel&quot;
     ~packing:button_box#pack
     () in
 
-  let _ = exit_button#connect#clicked ~callback:GMain.Main.quit in
+  let _ = cancel_button#connect#clicked ~callback:GMain.Main.quit in
 
   (* Defaults *)
     
@@ -126,6 +128,8 @@
       let dest_dir = Filename.concat spring_dir sub_dir in
       let dest = Filename.concat dest_dir basename in
         try
+          FileSystem.make_dir spring_dir;
+          FileSystem.make_dir dest_dir;
           FileSystem.move path dest;
           die (Printf.sprintf &quot;%s was successfully installed&quot; dest)
         with

Modified: branches/0.77-branch/tools/unitsync/CMakeLists.txt
===================================================================
--- branches/0.77-branch/tools/unitsync/CMakeLists.txt	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/tools/unitsync/CMakeLists.txt	2008-09-23 15:51:10 UTC (rev 6447)
@@ -1,6 +1,7 @@
 IF (MINGW)
-	set (unitsync_libs glew32 opengl32 glu32 devil ilu)
+	set (unitsync_libs glew32 opengl32 glu32 devil ilu python25)
 	set (PYTHONLIBS_FOUND TRUE) # Python libs are part of the mingwlibs package
+	INCLUDE_DIRECTORIES(${MINGWLIBS}/include/python2.5)
 	set (JNI_FOUND TRUE)
 ELSE (MINGW)
 	FIND_PACKAGE(SDL REQUIRED)
@@ -11,9 +12,12 @@
 	
 	FIND_PACKAGE(GLEW REQUIRED)
 	
+	set (unitsync_libs ${GLEW_LIBRARIES} IL openal GL GLU)
+	
 	FIND_PACKAGE(PythonLibs)
 	if (PYTHONLIBS_FOUND)
 		INCLUDE_DIRECTORIES(${PYTHON_INCLUDE_PATH})
+		list (APPEND unitsync_libs ${PYTHON_LIBRARIES})
 	else (PYTHONLIBS_FOUND)
 		message (&quot;No python libraries found, python bindings disabled&quot;)
 	endif (PYTHONLIBS_FOUND)
@@ -26,10 +30,9 @@
 		message (&quot;No Java includes found, java bindings disabled&quot;)
 	endif (JAVA_INCLUDE_PATH)
 	
-	set (unitsync_libs ${GLEW_LIBRARIES} IL openal GL GLU)
 ENDIF (MINGW)
 
-ADD_DEFINITIONS( -D_SZ_ONE_DIRECTORY -DNO_AVI -DSYNCCHECK -DUNITSYNC -DBITMAP_NO_OPENGL)
+ADD_DEFINITIONS( -DUNITSYNC -DBITMAP_NO_OPENGL ${PIC_FLAG})
 
 INCLUDE_DIRECTORIES(../../rts/System/Net/ ../../rts/lib/lua/include)
 INCLUDE_DIRECTORIES(../../rts/ ../../rts/Game ../../rts/lib/7zip ../../rts/System)
@@ -72,7 +75,6 @@
 if (PYTHONLIBS_FOUND)
 	TARGET_LINK_LIBRARIES(unitsync ${PYTHON_LIBRARIES})
 endif (PYTHONLIBS_FOUND)
-SET_TARGET_PROPERTIES( unitsync PROPERTIES COMPILE_FLAGS -fPIC)
 install (TARGETS unitsync DESTINATION ${LIBDIR})
 
 

Modified: branches/0.77-branch/tools/unitsync/unitsync.cpp
===================================================================
--- branches/0.77-branch/tools/unitsync/unitsync.cpp	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/tools/unitsync/unitsync.cpp	2008-09-23 15:51:10 UTC (rev 6447)
@@ -1071,6 +1071,7 @@
 	string name;
 	string desc;
 	string section;
+	string style;
 
 	string type; // &quot;bool&quot;, &quot;number&quot;, &quot;string&quot;, &quot;list&quot;, &quot;section&quot;
 
@@ -1119,6 +1120,7 @@
 	opt.desc = optTbl.GetString(&quot;desc&quot;, opt.name);
 
 	opt.section = optTbl.GetString(&quot;section&quot;, &quot;&quot;);
+	opt.style = optTbl.GetString(&quot;style&quot;, &quot;&quot;);
 
 	opt.type = optTbl.GetString(&quot;type&quot;, &quot;&quot;);
 	opt.type = StringToLower(opt.type);
@@ -1313,6 +1315,14 @@
 	return GetStr(options[optIndex].section);
 }
 
+DLL_EXPORT const char* __stdcall GetOptionStyle(int optIndex)
+{
+	if (InvalidOptionIndex(optIndex)) {
+		return NULL;
+	}
+	return GetStr(options[optIndex].style);
+}
+
 DLL_EXPORT const char* __stdcall GetOptionDesc(int optIndex)
 {
 	if (InvalidOptionIndex(optIndex)) {

Modified: branches/0.77-branch/tools/unitsync/unitsync_api.h
===================================================================
--- branches/0.77-branch/tools/unitsync/unitsync_api.h	2008-09-22 23:52:01 UTC (rev 6446)
+++ branches/0.77-branch/tools/unitsync/unitsync_api.h	2008-09-23 15:51:10 UTC (rev 6447)
@@ -67,6 +67,7 @@
 DLL_EXPORT const char*  __stdcall GetOptionKey(int optIndex);
 DLL_EXPORT const char*  __stdcall GetOptionName(int optIndex);
 DLL_EXPORT const char* __stdcall GetOptionSection(int optIndex);
+DLL_EXPORT const char* __stdcall GetOptionStyle(int optIndex);
 DLL_EXPORT const char*  __stdcall GetOptionDesc(int optIndex);
 DLL_EXPORT int          __stdcall GetOptionType(int optIndex);
 DLL_EXPORT int          __stdcall GetOptionBoolDef(int optIndex);


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001216.html">[Taspring-linux-commit] r6446 - trunk/tools/unitsync
</A></li>
	<LI>Next message: <A HREF="001218.html">[Taspring-linux-commit] r6448 - trunk/rts/Sim/Misc
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1217">[ date ]</a>
              <a href="thread.html#1217">[ thread ]</a>
              <a href="subject.html#1217">[ subject ]</a>
              <a href="author.html#1217">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
