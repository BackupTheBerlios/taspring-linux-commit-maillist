<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r6479 - in branches/springie: . planetwars	planetwars/Springie planetwars/Springie/autohost	planetwars/Springie/doc planetwars/Springie/spring	planetwars/Springie/utils planetwars/libs
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-September/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6479%20-%20in%20branches/springie%3A%20.%20planetwars%0A%09planetwars/Springie%20planetwars/Springie/autohost%0A%09planetwars/Springie/doc%20planetwars/Springie/spring%0A%09planetwars/Springie/utils%20planetwars/libs&In-Reply-To=%3C20080928230149.06DEE4996%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001248.html">
   <LINK REL="Next"  HREF="001250.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r6479 - in branches/springie: . planetwars	planetwars/Springie planetwars/Springie/autohost	planetwars/Springie/doc planetwars/Springie/spring	planetwars/Springie/utils planetwars/libs</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6479%20-%20in%20branches/springie%3A%20.%20planetwars%0A%09planetwars/Springie%20planetwars/Springie/autohost%0A%09planetwars/Springie/doc%20planetwars/Springie/spring%0A%09planetwars/Springie/utils%20planetwars/libs&In-Reply-To=%3C20080928230149.06DEE4996%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r6479 - in branches/springie: . planetwars	planetwars/Springie planetwars/Springie/autohost	planetwars/Springie/doc planetwars/Springie/spring	planetwars/Springie/utils planetwars/libs">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Mon Sep 29 01:01:48 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001248.html">[Taspring-linux-commit] r6478 - branches/springie
</A></li>
        <LI>Next message: <A HREF="001250.html">[Taspring-linux-commit] r6480 - in trunk/Lobby/BattleHubFramework:	nbproject nbproject/private src/aflobby	src/org/darkstars/battlehub/framework	src/org/darkstars/battlehub/framework/downloader	src/org/darkstars/battlehub/framework/protocol/tasserver	src/org/darkstars/battlehub/framework/spring
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1249">[ date ]</a>
              <a href="thread.html#1249">[ thread ]</a>
              <a href="subject.html#1249">[ subject ]</a>
              <a href="author.html#1249">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: Licho
Date: 2008-09-29 01:01:48 +0200 (Mon, 29 Sep 2008)
New Revision: 6479

Added:
   branches/springie/planetwars/
   branches/springie/planetwars/libs/
   branches/springie/planetwars/libs/PlanetWarsShared.dll
Modified:
   branches/springie/planetwars/Springie.sln
   branches/springie/planetwars/Springie/FormMain.Designer.cs
   branches/springie/planetwars/Springie/FormMain.cs
   branches/springie/planetwars/Springie/Main.cs
   branches/springie/planetwars/Springie/MainConfig.cs
   branches/springie/planetwars/Springie/Springie.csproj
   branches/springie/planetwars/Springie/autohost/AutoHost.cs
   branches/springie/planetwars/Springie/autohost/AutoHostConfig.cs
   branches/springie/planetwars/Springie/autohost/AutoHost_commands.cs
   branches/springie/planetwars/Springie/autohost/AutoManager.cs
   branches/springie/planetwars/Springie/autohost/Polls.cs
   branches/springie/planetwars/Springie/doc/devlog.txt
   branches/springie/planetwars/Springie/spring/Spring.cs
   branches/springie/planetwars/Springie/spring/Talker.cs
   branches/springie/planetwars/Springie/utils/Stats.cs
   branches/springie/planetwars/Springie/utils/UnknownFilesLinker.cs
Log:
initial planetwars support (<A HREF="http://caspring.org/wiki/PlanetWars">http://caspring.org/wiki/PlanetWars</A>)


Copied: branches/springie/planetwars (from rev 6476, trunk/tools/springie)


Property changes on: branches/springie/planetwars
___________________________________________________________________
Name: svn:ignore
   + *.suo
Ankh.Load
!zaloha
!runs
!resources
_ReSharper.Springie
Springie.resharper
Springie.4.0.resharper
Springie.4.0.resharper.user
bin
Springie.4.1.resharper.user


Modified: branches/springie/planetwars/Springie/FormMain.Designer.cs
===================================================================
--- trunk/tools/springie/Springie/FormMain.Designer.cs	2008-09-28 21:53:42 UTC (rev 6476)
+++ branches/springie/planetwars/Springie/FormMain.Designer.cs	2008-09-28 23:01:48 UTC (rev 6479)
@@ -191,6 +191,7 @@
       this.showhideHostingWindowToolStripMenuItem.Name = &quot;showhideHostingWindowToolStripMenuItem&quot;;
       this.showhideHostingWindowToolStripMenuItem.Size = new System.Drawing.Size(175, 22);
       this.showhideHostingWindowToolStripMenuItem.Text = &quot;Hide hosting window&quot;;
+      this.showhideHostingWindowToolStripMenuItem.Click += new System.EventHandler(this.showhideHostingWindowToolStripMenuItem_Click);
       // 
       // tabControl
       // 

Modified: branches/springie/planetwars/Springie/FormMain.cs
===================================================================
--- trunk/tools/springie/Springie/FormMain.cs	2008-09-28 21:53:42 UTC (rev 6476)
+++ branches/springie/planetwars/Springie/FormMain.cs	2008-09-28 23:01:48 UTC (rev 6479)
@@ -219,6 +219,7 @@
 
         foreach (ToolStripMenuItem t in springToolStripMenuItem.DropDownItems) t.Enabled = true;
         UpdateSpringPriorityMenu(hostingPriorityMenu, main.config.HostingProcessPriority);
+        showhideHostingWindowToolStripMenuItem.Checked = main.Spring.SpringWindowHidden;
 
         UpdateStatusInfo();
       }
@@ -432,6 +433,12 @@
       main.Spring.Reload(true, true);
     }
 
+    private void showhideHostingWindowToolStripMenuItem_Click(object sender, EventArgs e)
+    {
+      ToolStripMenuItem i = sender as ToolStripMenuItem;
+      main.Spring.SpringWindowHidden = !main.Spring.SpringWindowHidden;
+      i.Checked = main.Spring.SpringWindowHidden;
+    }
 
 
     private void UpdateStatusInfo()

Modified: branches/springie/planetwars/Springie/Main.cs
===================================================================
--- trunk/tools/springie/Springie/Main.cs	2008-09-28 21:53:42 UTC (rev 6476)
+++ branches/springie/planetwars/Springie/Main.cs	2008-09-28 23:01:48 UTC (rev 6479)
@@ -3,6 +3,7 @@
 using System.Timers;
 using System.Windows.Forms;
 using System.Xml.Serialization;
+using PlanetWarsShared.Springie;
 using Springie.autohost;
 using Springie.Client;
 using Springie.SpringNamespace;
@@ -18,7 +19,8 @@
     public MainConfig config;
     private Timer recon;
     private Spring spring;
-
+  	public ISpringieServer PlanetWars;
+		
     private Stats stats;
 
     private TasClient tas;
@@ -110,6 +112,8 @@
         }
       }
 
+			if (config.PlanetWarsEnabled) PlanetWars = (ISpringieServer)Activator.GetObject(typeof(ISpringieServer), config.PlanetWarsServer);
+
       tas = new TasClient();
       tas.ConnectionLost += new EventHandler&lt;TasEventArgs&gt;(tas_ConnectionLost);
       tas.Connected += new EventHandler&lt;TasEventArgs&gt;(tas_Connected);

Modified: branches/springie/planetwars/Springie/MainConfig.cs
===================================================================
--- trunk/tools/springie/Springie/MainConfig.cs	2008-09-28 21:53:42 UTC (rev 6476)
+++ branches/springie/planetwars/Springie/MainConfig.cs	2008-09-28 23:01:48 UTC (rev 6479)
@@ -23,7 +23,7 @@
     }
     #endregion
 
-    public const string SpringieVersion = &quot;Springie 1.18&quot;;
+    public const string SpringieVersion = &quot;Springie 1.19&quot;;
     private string accountName = &quot;login&quot;;
     private string accountPassword = &quot;pass&quot;;
     private bool allowInGameJoin = false;
@@ -48,6 +48,8 @@
     private bool statsEnabledReal = true;
     private string statsUrlAddressReal = &quot;<A HREF="http://springie.licho.eu/">http://springie.licho.eu/</A>&quot;;
     private int springCoreAffinity = 1;
+		private string planetWarsServer = &quot;<A HREF="tcp://licho.eu:1666/IServer">tcp://licho.eu:1666/IServer</A>&quot;;
+		private bool planetWarsEnabled;
 
     [Description(&quot;Should Springie automatically update itself to latest version?&quot;)]
     [Category(&quot;Springie&quot;)]
@@ -57,7 +59,20 @@
       set { autoUpdate = value; }
     }
 
-    [Description(&quot;If you run CA updater on the server Springie can autorehost for stable or latest version of it&quot;)]
+
+
+
+
+  	[Description(&quot;Location of PlanetWars server&quot;)]
+		[Category(&quot;PlanetWars&quot;)]
+		public string PlanetWarsServer
+  	{
+  		get { return planetWarsServer; }
+  		set { planetWarsServer = value; }
+  	}
+
+
+  	[Description(&quot;If you run CA updater on the server Springie can autorehost for stable or latest version of it&quot;)]
     [Category(&quot;Springie&quot;)]
     public CaUpdateMode CaUpdating
     {
@@ -245,5 +260,13 @@
       get { return springCoreAffinity; }
       set { springCoreAffinity = value; }
     }
+
+		[Description(&quot;Enable PlanetWars? Needs stats enabled to work properly&quot;)]
+		[Category(&quot;PlanetWars&quot;)]
+		public bool PlanetWarsEnabled
+  	{
+  		get { return planetWarsEnabled; }
+  		set { planetWarsEnabled = value; }
+  	}
   } ;
 }
\ No newline at end of file

Modified: branches/springie/planetwars/Springie/Springie.csproj
===================================================================
--- trunk/tools/springie/Springie/Springie.csproj	2008-09-28 21:53:42 UTC (rev 6476)
+++ branches/springie/planetwars/Springie/Springie.csproj	2008-09-28 23:01:48 UTC (rev 6479)
@@ -2,7 +2,7 @@
   &lt;PropertyGroup&gt;
     &lt;Configuration Condition=&quot; '$(Configuration)' == '' &quot;&gt;Debug&lt;/Configuration&gt;
     &lt;Platform Condition=&quot; '$(Platform)' == '' &quot;&gt;AnyCPU&lt;/Platform&gt;
-    &lt;ProductVersion&gt;9.0.21022&lt;/ProductVersion&gt;
+    &lt;ProductVersion&gt;9.0.30729&lt;/ProductVersion&gt;
     &lt;SchemaVersion&gt;2.0&lt;/SchemaVersion&gt;
     &lt;ProjectGuid&gt;{DD5A4F64-6C82-4F75-9EED-992378EC65FC}&lt;/ProjectGuid&gt;
     &lt;OutputType&gt;WinExe&lt;/OutputType&gt;
@@ -77,7 +77,7 @@
   &lt;/PropertyGroup&gt;
   &lt;PropertyGroup Condition=&quot; '$(Configuration)|$(Platform)' == 'Debug|x86' &quot;&gt;
     &lt;DebugSymbols&gt;true&lt;/DebugSymbols&gt;
-    &lt;OutputPath&gt;bin\x86\Debug\&lt;/OutputPath&gt;
+    &lt;OutputPath&gt;..\bin\&lt;/OutputPath&gt;
     &lt;DefineConstants&gt;DEBUG;TRACE&lt;/DefineConstants&gt;
     &lt;DebugType&gt;Full&lt;/DebugType&gt;
     &lt;PlatformTarget&gt;x86&lt;/PlatformTarget&gt;
@@ -87,7 +87,7 @@
     &lt;ErrorReport&gt;prompt&lt;/ErrorReport&gt;
   &lt;/PropertyGroup&gt;
   &lt;PropertyGroup Condition=&quot; '$(Configuration)|$(Platform)' == 'Release|x86' &quot;&gt;
-    &lt;OutputPath&gt;bin\x86\Release\&lt;/OutputPath&gt;
+    &lt;OutputPath&gt;..\bin\&lt;/OutputPath&gt;
     &lt;DefineConstants&gt;TRACE&lt;/DefineConstants&gt;
     &lt;Optimize&gt;true&lt;/Optimize&gt;
     &lt;DebugType&gt;pdbonly&lt;/DebugType&gt;
@@ -98,6 +98,10 @@
     &lt;ErrorReport&gt;prompt&lt;/ErrorReport&gt;
   &lt;/PropertyGroup&gt;
   &lt;ItemGroup&gt;
+    &lt;Reference Include=&quot;PlanetWarsShared, Version=1.0.0.0, Culture=neutral, processorArchitecture=MSIL&quot;&gt;
+      &lt;SpecificVersion&gt;False&lt;/SpecificVersion&gt;
+      &lt;HintPath&gt;..\libs\PlanetWarsShared.dll&lt;/HintPath&gt;
+    &lt;/Reference&gt;
     &lt;Reference Include=&quot;System&quot; /&gt;
     &lt;Reference Include=&quot;System.Data&quot; /&gt;
     &lt;Reference Include=&quot;System.Drawing&quot; /&gt;

Modified: branches/springie/planetwars/Springie/autohost/AutoHost.cs
===================================================================
--- trunk/tools/springie/Springie/autohost/AutoHost.cs	2008-09-28 21:53:42 UTC (rev 6476)
+++ branches/springie/planetwars/Springie/autohost/AutoHost.cs	2008-09-28 23:01:48 UTC (rev 6479)
@@ -7,6 +7,7 @@
 using System.Timers;
 using System.Windows.Forms;
 using System.Xml.Serialization;
+using PlanetWarsShared.Springie;
 using Springie.AutoHostNamespace;
 using Springie.Client;
 using Springie.SpringNamespace;
@@ -267,12 +268,41 @@
       Battle b = tas.GetBattle();
 
       if (b != null &amp;&amp; b.ContainsUser(e.ServerParams[0], out u)) {
-        /*if (u.SyncStatus == SyncStatuses.Unsynced) {
+      	/*if (u.SyncStatus == SyncStatuses.Unsynced) {
           SayBattle(&quot;kicking &quot; + u.name + &quot; - has incorrect spring or mod version&quot;);
           tas.Kick(u.name);
         }*/
 
-        if (KickSpectators &amp;&amp; u.IsSpectator == true &amp;&amp; u.name != tas.UserName) {
+
+      	if (Program.main.config.PlanetWarsEnabled &amp;&amp; u.name != tas.UserName) {
+      		try {
+      			var pw = Program.main.PlanetWars;
+						var info = pw.GetPlayerInfo(u.name);
+      			var factions = pw.GetFactions();
+						if (info == null)
+					  {
+							if (!u.IsSpectator) {
+								tas.ForceSpectator(u.name);
+								SayBattle(string.Format(&quot;{0} cannot play, he is not registered, register using PlanetWars client or !register command&quot;, u.name), false);
+								return;
+							}
+						}  else {
+							var hisFaction = factions.IndexOf(factions.Find((f) =&gt; f.Name == info.FactionInterface.Name));
+							if (u.AllyNumber != hisFaction) {
+								tas.ForceAlly(u.name, hisFaction);
+								SayBattle(string.Format(&quot;{0} must play in team {1}&quot;, u.name, hisFaction+1), false);
+								return;
+							}
+						}
+
+      		} catch(Exception ex) {
+      			SayBattle(string.Format(&quot;Warning, PlanetWars problem: {0} &quot;, ex.Message), false);
+      		}
+				}	
+
+
+
+    	if (KickSpectators &amp;&amp; u.IsSpectator == true &amp;&amp; u.name != tas.UserName) {
           SayBattle(config.KickSpectatorText);
           ComKick(TasSayEventArgs.Default, new string[] {u.name});
         }
@@ -280,7 +310,7 @@
 
         int cnt = 0;
         foreach (UserBattleStatus ubs in b.Users) if (!ubs.IsSpectator &amp;&amp; ubs.IsReady) cnt++;
-        string usname;
+        List&lt;string&gt; usname;
         int allyno;
         if (!manager.Enabled) {
           if ((cnt == config.MaxPlayers || (autoLock &gt; 0 &amp;&amp; autoLock == cnt)) &amp;&amp; AllReadyAndSynced(out usname) &amp;&amp; AllUniqueTeams(out usname) &amp;&amp; BalancedTeams(out allyno)) {
@@ -295,20 +325,42 @@
     private void tas_BattleMapChanged(object sender, TasEventArgs e)
     {
       if (config.DisplayMapLink) SayBattle(&quot;maplink: &quot; + linker.GetMapBounceLink(tas.GetBattle().Map.Name));
-      foreach (UserBattleStatus p in tas.GetBattle().Users) {
-        //ring all people that host changed the map
-        tas.Ring(p.name);
-      }
-      Battle b = tas.GetBattle();
-      string mapName = b.Map.ArchiveName.ToLower();
-      if (MapBoxes.ContainsKey(mapName)) {
-        for (int i = 0; i &lt; b.Rectangles.Count; ++i) tas.RemoveBattleRectangle(i);
-        Dictionary&lt;int, BattleRect&gt; dict = MapBoxes[mapName];
-        foreach (KeyValuePair&lt;int, BattleRect&gt; v in dict) tas.AddBattleRectangle(v.Key, v.Value);
-      }
+
+			if (Program.main.config.PlanetWarsEnabled)
+			{
+				try {
+					var pw = Program.main.PlanetWars;
+
+					string name = tas.GetBattle().Map.Name;
+					var mapInfo = pw.GetAttackOptions().Find(m =&gt; m.MapName == name);
+					for (int i = 0; i &lt; tas.GetBattle().Rectangles.Count; ++i) tas.RemoveBattleRectangle(i);
+					for (int i = 0; i &lt; mapInfo.StartBoxes.Count; ++i) {
+						var mi = mapInfo.StartBoxes[i];
+						tas.AddBattleRectangle(i, new BattleRect(mi.Left, mi.Top, mi.Right, mi.Bottom));
+					}
+
+					foreach (string command in mapInfo.AutohostCommands) {
+						tas.Say(TasClient.SayPlace.Channel, tas.UserName, command, false);
+					}
+
+					SayBattle(&quot;Planet changed succesfully!&quot;);
+				} catch(Exception ex) {
+					SayBattle(string.Format(&quot;Error setting planet starting boxes: {0}&quot;, ex.Message));
+				}
+			}
+			else {
+				Battle b = tas.GetBattle();
+				string mapName = b.Map.ArchiveName.ToLower();
+				if (MapBoxes.ContainsKey(mapName)) {
+					for (int i = 0; i &lt; b.Rectangles.Count; ++i) tas.RemoveBattleRectangle(i);
+					Dictionary&lt;int, BattleRect&gt; dict = MapBoxes[mapName];
+					foreach (KeyValuePair&lt;int, BattleRect&gt; v in dict) tas.AddBattleRectangle(v.Key, v.Value);
+				}
+			}
     }
 
 
+
     private void HandleKickSpecServerLocking()
     {
       if (!spring.IsRunning &amp;&amp; (KickSpectators || lockedByKickSpec)) {
@@ -366,7 +418,9 @@
         SayBattle(welc, false);
       }
       if (Program.main.config.AllowInGameJoin &amp;&amp; spring.IsRunning) {
-        SayBattle(&quot;GAME IS CURRENTLY IN PROGRESS, PLEASE WAIT TILL IT ENDS!&quot;, false);
+				var started = DateTime.Now.Subtract(spring.GameStarted);
+				started = new TimeSpan((int)started.TotalHours, started.Minutes, started.Seconds);
+				SayBattle(string.Format(&quot;GAME IS CURRENTLY IN PROGRESS, PLEASE WAIT TILL IT ENDS! Running for {0}&quot;, started), false);
         SayBattle(&quot;If you say !notify, I will PM you when game ends.&quot;, false);
       }
       if (config.DisplayMapLink) SayBattle(&quot;maplink: &quot; + linker.GetMapBounceLink(tas.GetBattle().Map.Name), false);
@@ -385,6 +439,11 @@
           }
         }
       }
+
+			if (Program.main.config.PlanetWarsEnabled) {
+				var current = Program.main.PlanetWars.GetOffensiveFaction();
+				SayBattle(string.Format(&quot;Currently {0} picks a planet&quot;, current.Name), false);
+			}
     }
 
 
@@ -697,11 +756,11 @@
             Respond(e, &quot;reload finished&quot;);
             break;
 
-          case &quot;team&quot;:
+          case &quot;id&quot;:
             ComTeam(e, words);
             break;
 
-          case &quot;ally&quot;:
+          case &quot;team&quot;:
             ComAlly(e, words);
             break;
 
@@ -841,6 +900,24 @@
           case &quot;votesetoptions&quot;:
             StartVote(new VoteSetOptions(tas, spring, this), e, words);
             break;
+
+					case &quot;listplanets&quot;:
+						ComListPlanets(e, words);
+        		break;
+
+					case &quot;register&quot;:
+						ComRegister(e, words);
+						break;
+
+
+					case &quot;planet&quot;:
+						ComPlanet(e, words);
+        		break;
+
+					case &quot;voteplanet&quot;:
+						if (Program.main.config.PlanetWarsEnabled) StartVote(new VotePlanet(tas,spring,this),e,words);
+						else Respond(e, &quot;PlanetWars not enabled on this host&quot;);
+        		break;
         }
       }
     }

Modified: branches/springie/planetwars/Springie/autohost/AutoHostConfig.cs
===================================================================
--- trunk/tools/springie/Springie/autohost/AutoHostConfig.cs	2008-09-28 21:53:42 UTC (rev 6476)
+++ branches/springie/planetwars/Springie/autohost/AutoHostConfig.cs	2008-09-28 23:01:48 UTC (rev 6479)
@@ -288,6 +288,8 @@
 
       AddMissing(new CommandConfig(&quot;random&quot;, 1, &quot;&lt;allycount&gt; - assigns people to &lt;allycount&gt; random alliances, e.g. !random - makes 2 random alliances&quot;, 10), addedCommands);
 
+			AddMissing(new CommandConfig(&quot;register&quot;, 5, &quot;&lt;side&gt; &lt;password&gt; - registers player for PlanetWars, e.g. !register arm secretPassword&quot;, 1), addedCommands);
+
       AddMissing(new CommandConfig(&quot;balance&quot;, 1, &quot;&lt;allycount&gt; - assigns people to &lt;allycount&gt; rank balanced alliances, e.g. !balance - makes 2 random but balanced alliances&quot;, 10), addedCommands);
 
       AddMissing(new CommandConfig(&quot;start&quot;, 1, &quot; - starts game&quot;, 5), addedCommands);
@@ -295,6 +297,12 @@
       AddMissing(new CommandConfig(&quot;ring&quot;, 0, &quot;[&lt;filters&gt;..] - rings all unready or specific player(s), e.g. !ring - rings unready, !ring icho - rings Licho&quot;, 5, new TasSayEventArgs.Places[] {TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game}), addedCommands);
 
       AddMissing(new CommandConfig(&quot;listmaps&quot;, 0, &quot;[&lt;filters&gt;..] - lists maps on server, e.g. !listmaps altor div&quot;, 10), addedCommands);
+			
+			AddMissing(new CommandConfig(&quot;listplanets&quot;, 5, &quot;[&lt;filters&gt;..] - lists planets open for attack !listmaps quantumia&quot;, 1), addedCommands);
+			AddMissing(new CommandConfig(&quot;planet&quot;, 5, &quot;[&lt;filters&gt;..] - picks a planet (you must be commander-in-chief)&quot;, 1), addedCommands);
+			AddMissing(new CommandConfig(&quot;voteplanet&quot;, 5, &quot;[&lt;filters&gt;..] - starts a vote for new planet&quot;, 1), addedCommands);
+      
+
       AddMissing(new CommandConfig(&quot;listmods&quot;, 0, &quot;[&lt;filters&gt;..] - lists mods on server, e.g. !listmods absolute 2.23&quot;, 5), addedCommands);
       AddMissing(new CommandConfig(&quot;map&quot;, 2, &quot;[&lt;filters&gt;..] - changes server map, eg. !map altor div&quot;), addedCommands);
 
@@ -348,10 +356,10 @@
 
       AddMissing(new CommandConfig(&quot;reload&quot;, 2, &quot; - reloads mod and map list (can take long time)&quot;, 30), addedCommands);
 
+      AddMissing(new CommandConfig(&quot;id&quot;, 2, &quot;&lt;idnumber&gt; [&lt;playername&gt;..] - forces given player to an id&quot;), addedCommands);
+
       AddMissing(new CommandConfig(&quot;team&quot;, 2, &quot;&lt;teamnumber&gt; [&lt;playername&gt;..] - forces given player to a team&quot;), addedCommands);
 
-      AddMissing(new CommandConfig(&quot;ally&quot;, 2, &quot;&lt;allynumber&gt; [&lt;playername&gt;..] - forces given player to an alliance&quot;), addedCommands);
-
       AddMissing(new CommandConfig(&quot;helpall&quot;, 0, &quot;- lists all commands known to Springie (sorted by command level)&quot;, 5), addedCommands);
 
       AddMissing(new CommandConfig(&quot;fixcolors&quot;, 1, &quot;- changes too similar colors to more different (note that color difference is highly subjective and impossible to model mathematically, so it won't always produce results satisfying for all)&quot;, 10), addedCommands);

Modified: branches/springie/planetwars/Springie/autohost/AutoHost_commands.cs
===================================================================
--- trunk/tools/springie/Springie/autohost/AutoHost_commands.cs	2008-09-28 21:53:42 UTC (rev 6476)
+++ branches/springie/planetwars/Springie/autohost/AutoHost_commands.cs	2008-09-28 23:01:48 UTC (rev 6479)
@@ -3,6 +3,8 @@
 using System.Globalization;
 using System.Text.RegularExpressions;
 using System.Threading;
+using PlanetWarsShared;
+using PlanetWarsShared.Springie;
 using Springie.Client;
 using Springie.SpringNamespace;
 
@@ -93,7 +95,21 @@
       return FilterMaps(words, tas, spring, ladder, out vals, out indexes);
     }
 
+  	public int FilterPlanets(string[] words, out string[] vals, out int[] indexes)
+    {
+    	var pw = Program.main.PlanetWars;
+    	var options = pw.GetAttackOptions();
 
+			string[] temp = new string[options.Count];
+      int cnt = 0;
+      foreach (var planet in options) {
+      	temp[cnt++] = planet.Name;
+      }
+      return Filter(temp, words, out vals, out indexes);
+    }
+
+
+
     internal static int FilterPresets(string[] words, AutoHost autohost, out string[] vals, out int[] indexes)
     {
       string[] temp = new string[autohost.presets.Count];
@@ -159,7 +175,26 @@
       } else Respond(e, &quot;no such map found&quot;);
     }
 
+		private void ComListPlanets(TasSayEventArgs e, string[] words)
+		{
+			string[] vals;
+			int[] indexes;
+			if (!Program.main.config.PlanetWarsEnabled) {
+				Respond(e, &quot;This is not PlanetWars host&quot;);
+				return;
+			}
+			try {
+				if (FilterPlanets(words, out vals, out indexes) &gt; 0) {
+					Respond(e, &quot;Planets available for attack are:&quot;);
+					for (int i = 0; i &lt; vals.Length; ++i) Respond(e, string.Format(&quot;{0}: {1}&quot;, indexes[i], vals[i]));
+				} else Respond(e, &quot;no such planet found&quot;);
+			} catch(Exception ex) {
+				Respond(e, string.Format(&quot;Error getting planets: {0}&quot;, ex.Message));
+			}
+		}
 
+
+
     private void ComListMods(TasSayEventArgs e, string[] words)
     {
       string[] vals;
@@ -231,41 +266,71 @@
     }
 
 
-    public bool AllReadyAndSynced(out string usname)
+		private void ComPlanet(TasSayEventArgs e, string[] words)
+		{
+			if (!Program.main.config.PlanetWarsEnabled) {
+				Respond(e, &quot;This is not a PlanetWars host&quot;);
+				return;
+			}
+			
+      if (words.Length == 0)
+			{
+				Respond(e, &quot;You must specify planet name&quot;);
+				return;
+			}
+			string[] vals;
+			int[] indexes;
+			if (FilterPlanets(words, out vals, out indexes) &gt; 0)
+			{
+				var pw = Program.main.PlanetWars;
+				var info = pw.GetPlayerInfo(e.UserName);
+				var fact = pw.GetOffensiveFaction();
+				if (info != null &amp;&amp; info.IsLeader) {
+					if (info.FactionInterface.Name == fact.Name) {
+						SayBattle(string.Format(&quot;changing planet to {0} by {1}&quot;, vals[0], e.UserName));
+						var planet = pw.GetAttackOptions().Find((m) =&gt; m.Name == vals[0]);
+						tas.ChangeMap(spring.UnitSync.MapList[planet.MapName]);
+					} else Respond(e, string.Format(&quot;It's currently {0} turn&quot;,fact.Name ));
+				} else Respond(e,&quot;You are not a commander-in-chief&quot;);
+			}
+			else Respond(e, &quot;Cannot find such planet.&quot;);
+		}
+
+
+
+
+    public bool AllReadyAndSynced(out List&lt;string&gt; usname)
     {
-      usname = &quot;&quot;;
-      int cnt = 0;
+      usname = new List&lt;string&gt;();
       foreach (UserBattleStatus p in tas.GetBattle().Users) {
         if (p.IsSpectator) continue;
-        else cnt++;
         if (p.SyncStatus != SyncStatuses.Synced || !p.IsReady) {
-          usname = p.name;
-          return false;
+          usname.Add(p.name);
         }
       }
-      if (cnt == 0) return false;
-      else return true;
+      return usname.Count == 0;
     }
 
-    public bool AllUniqueTeams(out string username)
+    public bool AllUniqueTeams(out List&lt;string&gt; username)
     {
       List&lt;int&gt; teams = new List&lt;int&gt;();
-      username = &quot;&quot;;
+      username = new List&lt;string&gt;();
       foreach (UserBattleStatus p in tas.GetBattle().Users) {
         if (p.IsSpectator) continue;
         if (teams.Contains(p.TeamNumber)) {
-          username = p.name;
-          return false;
+          username.Add(p.name);
         } else teams.Add(p.TeamNumber);
       }
-      return true;
+      return username.Count == 0;
     }
 
+    
     public bool BalancedTeams(out int allyno)
     {
       int[] counts = new int[16];
       allyno = 0;
 
+
       foreach (UserBattleStatus p in tas.GetBattle().Users) {
         if (p.IsSpectator) continue;
         counts[p.AllyNumber]++;
@@ -294,14 +359,15 @@
 
     public void ComStart(TasSayEventArgs e, string[] words)
     {
-      string usname;
+      List&lt;string&gt; usname;
       if (!AllReadyAndSynced(out usname)) {
-        SayBattle(&quot;cannot start, &quot; + usname + &quot; not ready and synced&quot;);
+        
+        SayBattle(&quot;cannot start, &quot; + Utils.Glue(usname.ToArray()) + &quot; not ready and synced&quot;);
         return;
       }
 
       if (!AllUniqueTeams(out usname)) {
-        SayBattle(&quot;cannot start, &quot; + usname + &quot; is sharing teams. Use !forcestart to override&quot;);
+        SayBattle(&quot;cannot start, &quot; + Utils.Glue(usname.ToArray()) + &quot; is sharing teams. Use !forcestart to override&quot;);
         return;
       }
 
@@ -310,23 +376,27 @@
         SayBattle(&quot;cannot start, alliance &quot; + (allyno + 1).ToString() + &quot; not fair. Use !forcestart to override&quot;);
         return;
       }
-      SayBattle(&quot;please wait, game is about to start&quot;);
 
-      StopVote();
+			if (CheckAndSendPlanetWarsStart(e)) {
 
-      Battle b = tas.GetBattle();
-      if (b != null) {
-        string curMap = b.Map.ArchiveName.ToLower();
+				SayBattle(&quot;please wait, game is about to start&quot;);
 
-        Dictionary&lt;int, BattleRect&gt; nd = new Dictionary&lt;int, BattleRect&gt;();
-        foreach (KeyValuePair&lt;int, BattleRect&gt; v in b.Rectangles) nd.Add(v.Key, v.Value);
+				StopVote();
 
-        if (MapBoxes.ContainsKey(curMap)) MapBoxes[curMap] = nd;
-        else MapBoxes.Add(curMap, nd);
-        SaveConfig();
-      }
-      tas.ChangeLock(true);
-      tas.StartGame();
+				Battle b = tas.GetBattle();
+				if (b != null) {
+					string curMap = b.Map.ArchiveName.ToLower();
+
+					Dictionary&lt;int, BattleRect&gt; nd = new Dictionary&lt;int, BattleRect&gt;();
+					foreach (KeyValuePair&lt;int, BattleRect&gt; v in b.Rectangles) nd.Add(v.Key, v.Value);
+
+					if (MapBoxes.ContainsKey(curMap)) MapBoxes[curMap] = nd;
+					else MapBoxes.Add(curMap, nd);
+					SaveConfig();
+				}
+				tas.ChangeLock(true);
+				tas.StartGame();
+			}
     }
 
     public void ComForceStart(TasSayEventArgs e, string[] words)
@@ -336,11 +406,14 @@
         SayBattle(&quot;cannot start, &quot; + usname + &quot; not ready and synced&quot;);
         return;
       }*/
-      SayBattle(&quot;please wait, game is about to start&quot;);
+			if (CheckAndSendPlanetWarsStart(e)) {
 
-      StopVote();
-      tas.ChangeLock(true);
-      tas.StartGame();
+				SayBattle(&quot;please wait, game is about to start&quot;);
+
+				StopVote();
+				tas.ChangeLock(true);
+				tas.StartGame();
+			}
     }
 
     public void ComForce(TasSayEventArgs e, string[] words)
@@ -351,6 +424,45 @@
       } else Respond(e, &quot;cannot force, game not started&quot;);
     }
 
+		private bool CheckAndSendPlanetWarsStart(TasSayEventArgs e)
+		{
+			if (Program.main.config.PlanetWarsEnabled)
+			{
+				try {
+					bool ok = true;
+					var pw = Program.main.PlanetWars;
+					var currentMapName = tas.GetBattle().Map.Name;
+					var fmap = pw.GetAttackOptions().Find(p =&gt; p.MapName == currentMapName);
+					if (fmap == null) {
+						SayBattle(&quot;This planet is not currently allowed, select another one&quot;);
+						return false;
+					}
+
+					var actual = new List&lt;IPlayer&gt;();
+					foreach (UserBattleStatus user in tas.GetBattle().Users) {
+						if (!user.IsSpectator) {
+							var info = pw.GetPlayerInfo(user.name);
+							actual.Add(info);
+							string side = tas.GetBattle().Mod.Sides[user.Side];
+							if (!string.Equals(side, info.FactionInterface.Side, StringComparison.InvariantCultureIgnoreCase)) {
+								SayBattle(string.Format(&quot;{0} must switch to {1}&quot;, user.name, info.FactionInterface.Side), false);
+								ok = false;
+							}
+						}
+					}
+					if (ok) {
+						pw.SendBattleStarted(tas.GetBattle().Map.Name, actual);
+					}
+
+					return ok;
+				} catch (Exception ex) {
+					SayBattle(string.Format(&quot;Error when checking PlanetWars teams: {0}&quot;, ex.Message),false);
+ 				 return false;
+ 				}
+			}
+			else return true;
+		}
+
     public void ComSplit(TasSayEventArgs e, string[] words)
     {
       if (words.Length != 2) {
@@ -1219,5 +1331,27 @@
       }
     }
     #endregion
+
+  	private void ComRegister(TasSayEventArgs e, string[] words)
+  	{
+  		if (!Program.main.config.PlanetWarsEnabled) {
+  			Respond(e, &quot;This is not PlanetWars host&quot;);
+  			return;
+  		}
+			if (words.Length != 2) {
+				Respond(e, &quot;This command needs 2 parameters - side and password (you can PM it to me)&quot;);
+				return;
+			}
+
+			try {
+				var pw = Program.main.PlanetWars;
+				var response = pw.Register(new AuthInfo() {Login = e.UserName, Password = words[1]}, words[0]);
+				if (response != RegistrationOutcome.Success) {
+					Respond(e, string.Format(&quot;Problem registering: {0}&quot;, response.ToString()));
+				} else Respond(e, &quot;Registration succesfull&quot;);
+			} catch(Exception ex) {
+				Respond(e, string.Format(&quot;Error when registering: {0}&quot;, ex.Message));
+			}
+  	}
   }
 }
\ No newline at end of file

Modified: branches/springie/planetwars/Springie/autohost/AutoManager.cs
===================================================================
--- trunk/tools/springie/Springie/autohost/AutoManager.cs	2008-09-28 21:53:42 UTC (rev 6476)
+++ branches/springie/planetwars/Springie/autohost/AutoManager.cs	2008-09-28 23:01:48 UTC (rev 6479)
@@ -1,4 +1,5 @@
 &#65279;using System;
+using System.Collections.Generic;
 using System.Threading;
 using System.Timers;
 using Springie.autohost;
@@ -12,7 +13,6 @@
   {
     private const int KickAfter = 300;
     private const int RingEvery = 60;
-    private const int SpecAfkAfter = 60;
     private const int SpecForceAfter = 120;
 
     private AutoHost ah;
@@ -24,9 +24,6 @@
 
     private int to;
 
-    private DateTime waitForReadySince = DateTime.Now;
-    private bool waitReady = false;
-
     public AutoManager(AutoHost ah, TasClient tas, Spring spring)
     {
       this.ah = ah;
@@ -41,7 +38,9 @@
       get { return from &gt; 0; }
     }
 
+    Dictionary&lt;string, DateTime&gt; problemSince = new Dictionary&lt;string, DateTime&gt;();
 
+
     private void timer_Elapsed(object sender, ElapsedEventArgs e)
     {
       lock (timer) {
@@ -51,13 +50,18 @@
             Battle b = tas.GetBattle();
             if (b != null) {
               int plrCnt = b.CountPlayers();
-              if (plrCnt &gt;= from &amp;&amp; plrCnt &lt;= to) {
-                string notReady;
+              if (plrCnt &gt;= from) {
+                List&lt;string&gt; notReady;
+
+                if (!ah.AllUniqueTeams(out notReady)) {
+                  ah.ComFix(TasSayEventArgs.Default, new string[] { });
+                  return;
+                }
+
                 bool isReady = ah.AllReadyAndSynced(out notReady);
                 if (plrCnt%2 == 0) {
                   int allyno;
-                  if (!ah.BalancedTeams(out allyno)) {
-                    ah.ComFix(TasSayEventArgs.Default, new string[] {});
+                  if (!ah.BalancedTeams(out allyno)) { //teams are not balanced but even number - fix colors and balance
                     ah.ComFixColors(TasSayEventArgs.Default, new string[] {});
                     ah.BalanceTeams(2, false);
                   }
@@ -67,34 +71,48 @@
                   if (!spring.IsRunning) ah.ComStart(TasSayEventArgs.Default, new string[] {});
                 } else {
                   DateTime now = DateTime.Now;
-                  if (!waitReady) {
-                    waitReady = true;
-                    waitForReadySince = now;
-                  }
+
+                  // we have enough people, but its odd number and server locked = unlock for more
                   if (plrCnt &gt; from &amp;&amp; plrCnt%2 == 1 &amp;&amp; b.IsLocked) ah.ComAutoLock(TasSayEventArgs.Default, new string[] {(plrCnt + 1).ToString()});
 
-                  if (now.Subtract(lastRing).TotalSeconds &gt; RingEvery) {
-                    lastRing = now;
-                    ah.ComRing(TasSayEventArgs.Default, new string[] {});
-                  }
 
-                  if (plrCnt &gt; from &amp;&amp; now.Subtract(waitForReadySince).TotalSeconds &gt; SpecForceAfter) ah.ComForceSpectator(TasSayEventArgs.Default, new string[] {notReady});
+                  if (plrCnt % 2 == 0) { // even number of players
+                    
+                    if (now.Subtract(lastRing).TotalSeconds &gt; RingEvery) { // we ring them
+                      lastRing = now;
+                      ah.ComRing(TasSayEventArgs.Default, new string[] {});
+                    }
 
-                  if (now.Subtract(waitForReadySince).TotalSeconds &gt; SpecAfkAfter) ah.ComForceSpectatorAfk(TasSayEventArgs.Default, new string[] {});
-                  if (now.Subtract(waitForReadySince).TotalSeconds &gt; KickAfter) ah.ComKick(TasSayEventArgs.Default, new string[] {notReady});
+                    DateTime worstTime = DateTime.MaxValue;
+                    String worstName = &quot;&quot;;
+                    foreach (string s in notReady) { // find longest offending player
+                      if (!problemSince.ContainsKey(s)) problemSince[s] = DateTime.Now;
+                      if (problemSince[s] &lt; worstTime) {
+                        worstTime = problemSince[s];
+                        worstName = s;
+                      }
+                    }
+                    foreach (string s in new List&lt;string&gt;(problemSince.Keys)) { // delete not offending plaeyrs
+                      if (!notReady.Contains(s)) problemSince.Remove(s);
+                    }
+
+
+                    if (now.Subtract(worstTime).TotalSeconds &gt; SpecForceAfter) ah.ComForceSpectator(TasSayEventArgs.Default, new string[] { worstName }); // spec longest offending person
+                    if (now.Subtract(worstTime).TotalSeconds &gt; KickAfter) ah.ComKick(TasSayEventArgs.Default, new string[] {worstName}); // kick longest offending
+                  } else { // teams are not even delet offender list
+                    problemSince.Clear();
+                  }
+                  
+                  
                 }
-              } else {
+              } else { // not enough players, make sure we unlock and clear offenders
                 if (b.IsLocked &amp;&amp; plrCnt &lt; from) ah.ComAutoLock(TasSayEventArgs.Default, new string[] {to.ToString()});
-                else if (plrCnt &gt; to) {
-                  string notready;
-                  if (!ah.AllReadyAndSynced(out notready)) ah.ComForceSpectator(TasSayEventArgs.Default, new string[] {notready});
-                }
-                waitReady = false;
+                problemSince.Clear();
               }
             }
-          } else {
+          } else { // spring running, reset timer and delete offenders
             lastRing = DateTime.Now;
-            waitReady = false;
+            problemSince.Clear();
           }
         } finally {
           timer.Start();

Modified: branches/springie/planetwars/Springie/autohost/Polls.cs
===================================================================
--- trunk/tools/springie/Springie/autohost/Polls.cs	2008-09-28 21:53:42 UTC (rev 6476)
+++ branches/springie/planetwars/Springie/autohost/Polls.cs	2008-09-28 23:01:48 UTC (rev 6479)
@@ -549,4 +549,102 @@
     }
     #endregion
   }
+
+
+	public class VotePlanet : AbstractPoll, IVotable
+	{
+		private string planet;
+		private string faction;
+
+		public VotePlanet(TasClient tas, Spring spring, AutoHost ah) : base(tas, spring, ah)
+		{
+			this.tas = tas;
+			this.spring = spring;
+			this.ah = ah;
+
+			var pw = Program.main.PlanetWars;
+			var fact = pw.GetOffensiveFaction();
+			faction = fact.Name;
+
+			users.Clear();
+			votes.Clear();
+
+			initialUserCount = 0;
+			Battle b = tas.GetBattle();
+			if (b != null)
+			{
+				foreach (UserBattleStatus us in b.Users)
+				{
+					if (us.name != tas.UserName &amp;&amp; !us.IsSpectator &amp;&amp; pw.GetPlayerInfo(us.name).FactionInterface.Name == faction)
+					{
+						users.Add(us.name);
+						votes.Add(0);
+						initialUserCount++;
+					}
+				}
+			}
+		}
+
+		#region IVotable Members
+		bool IVotable.Init(TasSayEventArgs e, string[] words)
+		{
+			
+			if (words.Length == 0)
+			{
+				AutoHost.Respond(tas, spring, e, &quot;You must specify planet name&quot;);
+				return false;
+			}
+			string[] vals;
+			int[] indexes;
+			if (ah.FilterPlanets(words, out vals, out indexes) &gt; 0)
+			{
+				planet = vals[0];
+				ah.SayBattle(string.Format(&quot;Do you want to change planet to {0}? !vote 1 = yes, !vote 2 = no&quot;, planet));
+				return true;
+			}
+			else
+			{
+				AutoHost.Respond(tas, spring, e, &quot;Cannot find such planet&quot;);
+				return false;
+			}
+		}
+
+		public bool Vote(TasSayEventArgs e, string[] words)
+		{
+			int vote;
+			var pw = Program.main.PlanetWars;
+
+
+			if (e.UserName != &quot;&quot;) { // this is needed due to &quot;timeout&quot; hackthing with vote
+				var info = pw.GetPlayerInfo(e.UserName);
+
+				if (info == null || info.FactionInterface.Name != faction) {
+					AutoHost.Respond(tas, spring, e, string.Format(&quot;{0}, it's not your faction's turn&quot;, e.UserName));
+					return false;
+				}
+
+				if (!RegisterVote(e, words, out vote)) {
+					AutoHost.Respond(tas, spring, e, &quot;You must vote valid option/not be a spectator&quot;);
+					return false;
+				}
+			}
+
+			int winVote;
+			if (CheckEnd(out winVote))
+			{
+				if (winVote == 1)
+				{
+					ah.SayBattle(&quot;vote successful - changing planet to &quot; + planet);
+					var sel = pw.GetAttackOptions().Find((p) =&gt; p.Name == planet);
+					tas.ChangeMap(spring.UnitSync.MapList[sel.MapName]);
+				}
+				else ah.SayBattle(&quot;not enough votes, planet stays&quot;);
+				return true;
+			}
+			else return false;
+		}
+		#endregion
+	}
+
+
 }
\ No newline at end of file

Modified: branches/springie/planetwars/Springie/doc/devlog.txt
===================================================================
--- trunk/tools/springie/Springie/doc/devlog.txt	2008-09-28 21:53:42 UTC (rev 6476)
+++ branches/springie/planetwars/Springie/doc/devlog.txt	2008-09-28 23:01:48 UTC (rev 6479)
@@ -11,11 +11,11 @@
 ===============
 TODO
 ===============
-* CAutohostInterface or full dedicated server support
+* CAutohostInterface or full dedicated server support - done in the previous version
 * fix linux compatibility
 * <A HREF="http://replays.unknown-files.net/bot_upload.php?title=title&amp;description=description">http://replays.unknown-files.net/bot_upload.php?title=title&amp;description=description</A>
-* ranked servers
 * gui - add player lists by channel
 * demo upload
 * kick with reason - stop
 * reenable alternative way to determine that game has ended (people in lobby not in game)
+* autoconnect to backup
\ No newline at end of file

Modified: branches/springie/planetwars/Springie/spring/Spring.cs
===================================================================
--- trunk/tools/springie/Springie/spring/Spring.cs	2008-09-28 21:53:42 UTC (rev 6476)
+++ branches/springie/planetwars/Springie/spring/Spring.cs	2008-09-28 23:01:48 UTC (rev 6479)
@@ -1,64 +1,96 @@
 using System;
 using System.Collections.Generic;
-using System.Text;
+using System.Diagnostics;
 using System.IO;
-using System.Diagnostics;
 using System.Threading;
 using Microsoft.Win32;
-using System.Timers;
 using Springie.Client;
 
 namespace Springie.SpringNamespace
 {
   public class SpringLogEventArgs : EventArgs
   {
-    string username;
-    public string Username { get { return username; } }
+    private List&lt;string&gt; args = new List&lt;string&gt;();
+    private string line;
+    private string username;
 
-    string line;
-    public string Line { get { return line; } }
+    public SpringLogEventArgs(string username, string line)
+    {
+      this.line = line;
+      this.username = username;
+    }
 
-    List&lt;string&gt; args = new List&lt;string&gt;();
-    public List&lt;string&gt; Args
+    public string Username
     {
-      get { return args; }
+      get { return username; }
     }
 
-    public SpringLogEventArgs(string username): this(username, &quot;&quot;) {}
+    public string Line
+    {
+      get { return line; }
+    }
 
-    public SpringLogEventArgs(string username, string line)
+    public List&lt;string&gt; Args
     {
-      this.line = line;
-      this.username = username;
+      get { return args; }
     }
-  };
+  } ;
 
   /// &lt;summary&gt;
   /// represents one install location of spring game
   /// &lt;/summary&gt;
   public class Spring : IDisposable
   {
-    public event EventHandler&lt;SpringLogEventArgs&gt; PlayerSaid;
-    public event EventHandler&lt;SpringLogEventArgs&gt; PlayerJoined;
-    public event EventHandler&lt;SpringLogEventArgs&gt; PlayerLeft;
-    public event EventHandler&lt;SpringLogEventArgs&gt; PlayerDisconnected;
-    public event EventHandler&lt;SpringLogEventArgs&gt; PlayerLost; // player lost the game
-    public event EventHandler&lt;SpringLogEventArgs&gt; GameOver; // game has ended
+    public const string ExecutableName = &quot;spring.exe&quot;;
+    public const string InfoLogName = &quot;infolog.txt&quot;;
+    public const int MaxAllies = 10;
+    public const int MaxTeams = 32;
+    private const string PathDivider = &quot;/&quot;;
+    private const string springRegistryKey = &quot;HKEY_CURRENT_USER\\Software\\SJ\\spring&quot;;
+    private int fullScreen;
+    private DateTime gameStarted;
+    private int luaUi;
+    private Thread outputReader;
 
-    public event EventHandler SpringExited;
-    public event EventHandler SpringStarted;
+    private string path;
 
-    public const string ExecutableName = &quot;dedicated.exe&quot;;
-    public const int MaxTeams = 32;
-    public const int MaxAllies = 10;
-//    const string PathDivider = &quot;/&quot;;
+    private List&lt;Battle.GrPlayer&gt; players;
+    private Process process;
 
-    Talker talker;
-    string path;
-    public string Path { get { return path; } }
-    Process process;
+    private bool springWindowHidden = true;
+    private Talker talker;
+    private UnitSync unitSync;
+    private int xResolution;
+    private int yResolution;
 
+    public Spring(string path)
+    {
+      if (string.IsNullOrEmpty(path)) path = Directory.GetCurrentDirectory();
 
+      if (!path.EndsWith(PathDivider)) path += PathDivider; // ensure that path ends with \\
+      this.path = path;
+
+      if (!File.Exists(path + ExecutableName)) throw new Exception(ExecutableName + &quot; not found in &quot; + path);
+
+      // init unitsync and load basic info
+      unitSync = new UnitSync(path);
+    }
+
+    public string Path
+    {
+      get { return path; }
+    }
+
+    public bool SpringWindowHidden
+    {
+      get { return springWindowHidden; }
+      set
+      {
+        springWindowHidden = value;
+        UpdateSpringVisibility();
+      }
+    }
+
     public ProcessPriorityClass ProcessPriority
     {
       get
@@ -66,50 +98,40 @@
         if (IsRunning) return process.PriorityClass;
         else return Program.main.config.HostingProcessPriority;
       }
-      set
-      {
-        if (IsRunning) {
-          process.PriorityClass = value;
-        }
-      }
-
+      set { if (IsRunning) process.PriorityClass = value; }
     }
 
 
-
     public bool IsRunning
     {
-      get
-      {
-        return (process != null &amp;&amp; !process.HasExited);
-      }
+      get { return (process != null &amp;&amp; process.MainWindowHandle != IntPtr.Zero &amp;&amp; !process.HasExited); }
     }
-    DateTime gameStarted;
+
     public DateTime GameStarted
     {
       get { return gameStarted; }
     }
 
-    UnitSync unitSync;
     public UnitSync UnitSync
     {
       get { return unitSync; }
     }
 
-    public Spring(string path)
-    {
-      if (string.IsNullOrEmpty(path)) path = Directory.GetCurrentDirectory();
+    #region IDisposable Members
+    public void Dispose() {}
+    #endregion
 
-      if (!path.EndsWith(&quot;/&quot;)) path += &quot;/&quot;; // ensure that path ends with \\
-      this.path = path;
+    public event EventHandler&lt;SpringLogEventArgs&gt; PlayerSaid;
+    public event EventHandler&lt;SpringLogEventArgs&gt; PlayerJoined;
+    public event EventHandler&lt;SpringLogEventArgs&gt; PlayerLeft;
+    public event EventHandler&lt;SpringLogEventArgs&gt; PlayerDisconnected;
+    public event EventHandler&lt;SpringLogEventArgs&gt; PlayerLost; // player lost the game
+    public event EventHandler&lt;SpringLogEventArgs&gt; GameOver; // game has ended
 
-      if (!File.Exists(path + ExecutableName)) throw new Exception(ExecutableName + &quot; not found in &quot; + path);
+    public event EventHandler SpringExited;
+    public event EventHandler SpringStarted;
 
-      // init unitsync and load basic info
-      unitSync = new UnitSync(path);
-    }
 
-
     /// &lt;summary&gt;
     /// Reloads map and or mod list
     /// &lt;/summary&gt;
@@ -124,86 +146,114 @@
     public void StartGame(Battle battle)
     {
       if (!IsRunning) {
+        ConfigMaker.Generate(path + &quot;springie.txt&quot;, battle, out players);
 
-        List&lt;Battle.GrPlayer&gt; players;
-        talker = new Talker();
-        talker.SpringEvent += new EventHandler&lt;Talker.SpringEventArgs&gt;(talker_SpringEvent);
-        string configName = &quot;springie&quot; + Program.main.AutoHost.config.HostingPort + &quot;.txt&quot;;
-        ConfigMaker.Generate(path + configName, battle, talker.LoopbackPort, out players);
-        talker.SetPlayers(players);
+        process = new Process();
+        process.StartInfo.CreateNoWindow = true;
 
+        if (Program.main.config.SpringStartsMinimized) process.StartInfo.Arguments = &quot;/minimise &quot;;
+        else process.StartInfo.Arguments = &quot;&quot;;
+        process.StartInfo.Arguments += &quot;springie.txt&quot;;
 
-        process = new Process();
-        process.StartInfo.CreateNoWindow = true;
-        process.StartInfo.Arguments += configName;
+        process.StartInfo.RedirectStandardOutput = true;
         process.StartInfo.WorkingDirectory = path;
         process.StartInfo.FileName = path + ExecutableName;
         process.StartInfo.UseShellExecute = false;
         process.Exited += new EventHandler(springProcess_Exited);
-        
+
+        Thread.Sleep(2000); // give time to user's spring to start and ignore upcoming registry hax
+        PrepareRegistry();
         process.Start();
         process.ProcessorAffinity = (IntPtr)Program.main.config.SpringCoreAffinity;
 
         gameStarted = DateTime.Now;
         process.WaitForInputIdle();
 
-    
+        outputReader = new Thread(SpringOutputReader);
+        outputReader.Name = &quot;SpringOutputReader&quot;;
+        outputReader.Start(this);
+        talker = new Talker(process);
+
+        RestoreRegistry();
         if (IsRunning &amp;&amp; SpringStarted != null) SpringStarted(this, EventArgs.Empty);
-        
-        System.Threading.Thread.Sleep(1000);
+
+        SpringWindowHidden = Program.main.config.SpringStartsHidden;
+        Thread.Sleep(1000);
         ProcessPriority = Program.main.config.HostingProcessPriority;
       }
     }
 
-    void talker_SpringEvent(object sender, Talker.SpringEventArgs e)
+    private static void SpringOutputReader(object param)
     {
-      switch (e.EventType) {
-        case Talker.SpringEventType.PLAYER_JOINED:
-          if (PlayerJoined != null) PlayerJoined(this, new SpringLogEventArgs(e.PlayerName));
-          break;
+      Spring s = (Spring)param;
+      do {
+        string l;
+        try {
+          l = s.process.StandardOutput.ReadLine();
+        } catch {
+          return;
+        }
+        if (l == null || !s.IsRunning || l.Length == 0) return;
+        s.ProcessLogLine(l);
+      } while (true);
+    }
 
-        case Talker.SpringEventType.PLAYER_LEFT:
-          if (e.Param == 0) if (PlayerDisconnected != null) PlayerDisconnected(this, new SpringLogEventArgs(e.PlayerName));
-            else if (PlayerLeft != null) PlayerLeft(this, new SpringLogEventArgs(e.PlayerName));
-          break;
 
-        case Talker.SpringEventType.PLAYER_CHAT:
-          if (PlayerSaid != null) PlayerSaid(this, new SpringLogEventArgs(e.PlayerName, e.Text));
-          break;
+    private void ProcessLogLine(string l)
+    {
+      string[] words;
 
-        case Talker.SpringEventType.PLAYER_DEFEATED:
-          if (PlayerLost != null) PlayerLost(this, new SpringLogEventArgs(e.PlayerName));
-          break;
-
-        case Talker.SpringEventType.SERVER_GAMEOVER:
-//          if (GameOver != null) GameOver(this, new SpringLogEventArgs(e.PlayerName));
-          break;
-        
-        case Talker.SpringEventType.SERVER_QUIT:
-          if (GameOver != null) GameOver(this, new SpringLogEventArgs(e.PlayerName));
-          break;
-
+      if (l.StartsWith(&quot;Player&quot;)) {
+        words = l.Split(' ');
+        if (l.Length &gt; 2) {
+          if (words[2] == &quot;joined&quot;) {
+            // player joined
+            if (PlayerJoined != null) PlayerJoined(this, new SpringLogEventArgs(words[1], l));
+          } else if (words[2] == &quot;left&quot;) {
+            // player left
+            if (PlayerLeft != null) PlayerLeft(this, new SpringLogEventArgs(words[1], l));
+          }
+        }
+      } else if (l[0] == '&lt;') {
+        // player said something
+        words = l.Split(new char[] {'&lt;', '&gt;', ' '}, 2, StringSplitOptions.RemoveEmptyEntries);
+        if (PlayerSaid != null &amp;&amp; words.Length &gt; 1) PlayerSaid(this, new SpringLogEventArgs(words[0], words[1]));
+      } else if (l.StartsWith(&quot;Lost connection to&quot;)) {
+        // lost connection to player
+        words = l.Split(' ');
+        if (words.Length &gt; 3) if (PlayerDisconnected != null) PlayerDisconnected(this, new SpringLogEventArgs(words[3], l));
+      } else if (l.StartsWith(&quot;Team&quot;)) {
+        words = l.Split(new char[] {'(', ')'});
+        if (words.Length &gt; 1) if (PlayerLost != null) PlayerLost(this, new SpringLogEventArgs(words[1], l));
+      } else if (l == &quot;Game over&quot;) {
+        string luser = &quot;&quot;;
+        SpringLogEventArgs e = new SpringLogEventArgs(luser, l);
+        if (GameOver != null) GameOver(this, e);
       }
-
     }
 
-
-
-    
     public void ForceStart()
     {
       if (IsRunning) {
-        talker.SendText(&quot;.forcestart&quot;);
+        talker.SendPressKey(Talker.VK_CONTROL);
+        talker.SendPressKey(Talker.VK_ENTER);
+        talker.SendReleaseKey(Talker.VK_ENTER);
+        talker.SendReleaseKey(Talker.VK_CONTROL);
       }
     }
 
     public void ExitGame()
     {
       if (IsRunning) {
-        // TODO talker method to exit spring
-//        process.WaitForExit(1000);
-//        if (!IsRunning) return;
+        lock (talker) {
+          talker.SendPressKey(Talker.VK_LSHIFT);
+          talker.SendPressKey(Talker.VK_ESC);
+          talker.SendReleaseKey(Talker.VK_ESC);
+          talker.SendReleaseKey(Talker.VK_LSHIFT);
+        }
 
+        process.WaitForExit(1000);
+        if (!IsRunning) return;
         process.CloseMainWindow();
         process.WaitForExit(1000);
         if (!IsRunning) return;
@@ -214,17 +264,26 @@
     public void SayGame(string text)
     {
       if (IsRunning) {
-        talker.SendText(text);
+        lock (talker) {
+          talker.SendKey(Talker.VK_ENTER);
+          talker.SendText(text);
+          talker.SendKey(Talker.VK_ENTER);
+        }
       }
     }
 
     public void Kick(string name)
     {
+      for (int i = 0; i &lt; players.Count; ++i) {
+        if (players[i].user.name == name) {
+          SayGame(&quot;.kickbynum &quot; + i);
+          break;
+        }
+      }
       SayGame(&quot;.kick &quot; + name);
     }
 
-
-    void springProcess_Exited(object sender, EventArgs e)
+    private void springProcess_Exited(object sender, EventArgs e)
     {
       process = null;
       talker.Close();
@@ -232,19 +291,45 @@
       if (SpringExited != null) SpringExited(this, EventArgs.Empty);
     }
 
+    //int soundVolume;
+    private void PrepareRegistry()
+    {
+      //soundVolume = (int)Registry.GetValue(springRegistryKey, &quot;SoundVolume&quot;, 0);
+      fullScreen = (int)Registry.GetValue(springRegistryKey, &quot;Fullscreen&quot;, 0);
+      xResolution = (int)Registry.GetValue(springRegistryKey, &quot;XResolution&quot;, 0);
+      yResolution = (int)Registry.GetValue(springRegistryKey, &quot;YResolution&quot;, 0);
+      //luaUi = (int)Registry.GetValue(springRegistryKey, &quot;LuaUI&quot;, 0);
 
+      //Registry.SetValue(springRegistryKey, &quot;SoundVolume&quot;, 0);
+      Registry.SetValue(springRegistryKey, &quot;Fullscreen&quot;, Program.main.config.SpringFullscreen ? 1 : 0);
+      Registry.SetValue(springRegistryKey, &quot;XResolution&quot;, Program.main.config.SpringResolutionX);
+      Registry.SetValue(springRegistryKey, &quot;YResolution&quot;, Program.main.config.SpringResolutionY);
+      Registry.SetValue(springRegistryKey, &quot;StdoutDebug&quot;, 1);
+      //Registry.SetValue(springRegistryKey, &quot;LuaUI&quot;, 0);
+    }
+
+    private void RestoreRegistry()
+    {
+      //Registry.SetValue(springRegistryKey, &quot;SoundVolume&quot;, soundVolume);
+      //Registry.SetValue(springRegistryKey, &quot;Fullscreen&quot;, fullScreen);
+      //Registry.SetValue(springRegistryKey, &quot;XResolution&quot;, xResolution);
+      //Registry.SetValue(springRegistryKey, &quot;YResolution&quot;, yResolution);
+      //Registry.SetValue(springRegistryKey, &quot;StdoutDebug&quot;, 0);
+      //Registry.SetValue(springRegistryKey, &quot;LuaUI&quot;, luaUi);
+    }
+
     public string GetMapArchiveName(string mapname)
     {
       return unitSync.GetMapArchiveName(mapname);
     }
 
 
-    #region IDisposable Members
-
-    public void Dispose()
+    private void UpdateSpringVisibility()
     {
+      if (IsRunning) {
+        if (springWindowHidden) Talker.ShowWindow(process.MainWindowHandle, Talker.SW_HIDE);
+        else Talker.ShowWindow(process.MainWindowHandle, Talker.SW_NORMAL);
+      }
     }
-
-    #endregion
   }
-}
+}
\ No newline at end of file

Modified: branches/springie/planetwars/Springie/spring/Talker.cs
===================================================================
--- trunk/tools/springie/Springie/spring/Talker.cs	2008-09-28 21:53:42 UTC (rev 6476)
+++ branches/springie/planetwars/Springie/spring/Talker.cs	2008-09-28 23:01:48 UTC (rev 6479)
@@ -1,161 +1,182 @@
 using System;
+using System.Collections.Generic;
+using System.Diagnostics;
 using System.Runtime.InteropServices;
-using System.Collections.Generic;
 using System.Threading;
-using System.Diagnostics;
-using System.Net.Sockets;
-using System.Net;
-using System.Text;
-using Springie.Client;
 
 namespace Springie.SpringNamespace
 {
-  class Talker : IDisposable
+  /// &lt;summary&gt;
+  /// Class for sending keyboard related windows commands
+  /// &lt;/summary&gt;
+  internal class Talker : IDisposable
   {
-    public enum SpringEventType : byte
-    {
-      /// Server has started ()
-      SERVER_STARTED = 0,
+    public const int FL_CTRL = 1 &lt;&lt; 9;
 
-      /// Server is about to exit ()
-      SERVER_QUIT = 1,
+    /// &lt;summary&gt;
+    /// flag to be added to scan code to simulate shift+key
+    /// &lt;/summary&gt;
+    public const int FL_SHIFT = 1 &lt;&lt; 8;
 
-      /// Game starts ()
-      SERVER_STARTPLAYING = 2,
+    public const int SW_FORCEMINIMIZE = 11;
 
-      /// Game has ended ()
-      SERVER_GAMEOVER = 3,
+    public const int SW_HIDE = 0;
+    public const int SW_MAX = 11;
+    public const int SW_MAXIMIZE = 3;
+    public const int SW_MINIMIZE = 6;
+    public const int SW_NORMAL = 1;
+    public const int SW_RESTORE = 9;
+    public const int SW_SHOW = 5;
+    public const int SW_SHOWDEFAULT = 10;
+    public const int SW_SHOWMAXIMIZED = 3;
+    public const int SW_SHOWMINIMIZED = 2;
+    public const int SW_SHOWMINNOACTIVE = 7;
+    public const int SW_SHOWNA = 8;
+    public const int SW_SHOWNOACTIVATE = 4;
+    public const int SW_SHOWNORMAL = 1;
+    public const int VK_CONTROL = 17;
+    public const int VK_ENTER = 0x0D;
+    public const int VK_ESC = 0x1B;
+    public const int VK_LSHIFT = 0xA0;
+    public const int VK_RCONTROL = 0xA3;
+    private const int WM_CHAR = 0x0102;
+    private const int WM_KEYDOWN = 0x0100;
+    private const int WM_KEYUP = 0x0101;
+    private bool exitThread = false;
 
-      /// Player has joined the game (uchar playernumber, string name)
-      PLAYER_JOINED = 10,
+    private Queue&lt;Message&gt; messageQueue = new Queue&lt;Message&gt;();
+    private object myLock = new object();
+    private Process process;
+    private Semaphore semaphore = new Semaphore(0, int.MaxValue);
+    private Thread senderThread;
+    private IntPtr target = new IntPtr();
 
-      /// Player has left (uchar playernumber, uchar reason (0: lost connection, 1: left, 2: kicked) )
-      PLAYER_LEFT = 11,
+    /// &lt;summary&gt;
+    /// Constructs Talker class
+    /// &lt;/summary&gt;
+    /// &lt;param name=&quot;targetHandle&quot;&gt;Handle to target window&lt;/param&gt;
+    public Talker(Process process)
+    {
+      this.process = process;
+      target = process.MainWindowHandle;
+      senderThread = new Thread(new ParameterizedThreadStart(ExecuteMessages));
+      senderThread.Name = &quot;Talker&quot;;
+      senderThread.Start(this);
+    }
 
-      /// Player has updated its ready-state (uchar playernumber, uchar state (0: not ready, 1: ready, 2: state not changed) )
-      PLAYER_READY = 12,
-
-      /// Player has sent a chat message (uchar playernumber, string text)
-      PLAYER_CHAT = 13,
-
-      /// Player has been defeated (uchar playernumber)
-      PLAYER_DEFEATED = 14
-    };
-
-    public class SpringEventArgs : EventArgs
+    #region IDisposable Members
+    public void Dispose()
     {
-      public SpringEventType EventType;
-      public string PlayerName;
-      public byte PlayerNumber = 0;
-      public byte Param;
-      public string Text;
+      Close();
     }
+    #endregion
 
+    [DllImport(&quot;User32.Dll&quot;)]
+    public static extern IntPtr FindWindow(String className, String windowName);
 
+    [DllImport(&quot;User32.Dll&quot;)]
+    public static extern IntPtr FindWindowEx(IntPtr hwndParent, IntPtr hwndChildAfter, string lpszClass, string lpszWindow);
 
 
+    [DllImport(&quot;User32.Dll&quot;)]
+    public static extern bool PostMessage(IntPtr hWnd, int msg, int wParam, int lParam);
 
-    protected bool close = false;
+    [DllImport(&quot;User32.Dll&quot;)]
+    public static extern bool ShowWindow(IntPtr hWnd, int nCmdShow);
 
-    int loopbackPort;
-    public int LoopbackPort
+    /// &lt;summary&gt;
+    /// transforms char to scan code
+    /// &lt;/summary&gt;
+    /// &lt;param name=&quot;ch&quot;&gt;char&lt;/param&gt;
+    /// &lt;returns&gt;scan code (one byte actually)&lt;/returns&gt;
+    [DllImport(&quot;User32.Dll&quot;)]
+    public static extern int VkKeyScan(char ch);
+
+    private void AddMessage(IntPtr target, int mess, int lparam, int wparam)
     {
-      get
-      {
-        return loopbackPort;
+      lock (myLock) {
+        messageQueue.Enqueue(new Message(target, mess, lparam, wparam));
+        semaphore.Release();
       }
     }
 
-    Thread thread;
-    UdpClient udp;
-    int springTalkPort;
-    List&lt;Battle.GrPlayer&gt; initialPlayers;
 
-    public event EventHandler&lt;SpringEventArgs&gt; SpringEvent;
+    private static void ExecuteMessages(object param)
+    {
+      Talker t = (Talker)param;
+      while (!t.exitThread) {
+        t.semaphore.WaitOne();
+        if (t.exitThread) return;
+        Queue&lt;Message&gt; temp;
+        lock (t.myLock) {
+          temp = new Queue&lt;Message&gt;(t.messageQueue);
+          t.messageQueue.Clear();
+        }
+        while (temp.Count &gt; 0) {
+          Message m = temp.Dequeue();
+          PostMessage(m.target, m.message, m.lparam, m.wparam);
+          if (m.lparam == VK_LSHIFT || m.lparam == VK_ENTER || m.lparam == VK_ESC || m.lparam == VK_CONTROL) Thread.Sleep(100);
+        }
+      }
+    }
 
 
-    public void SendText(string text)
+    /// &lt;summary&gt;
+    /// Sends one complete key press
+    /// &lt;/summary&gt;
+    /// &lt;param name=&quot;virtCode&quot;&gt;&lt;/param&gt;
+    public void SendKey(int virtCode)
     {
-      byte[] bytes = Encoding.ASCII.GetBytes(text);
-      udp.Send(bytes, bytes.Length, &quot;127.0.0.1&quot;, springTalkPort);
+      SendPressKey(virtCode);
+      SendReleaseKey(virtCode);
     }
 
-    
-    public void SetPlayers(List&lt;Battle.GrPlayer&gt; players) {
-      initialPlayers = players;
+    public void SendPressKey(int virtCode)
+    {
+      AddMessage(target, WM_KEYDOWN, virtCode, 1);
     }
 
-
-    public Talker()
+    public void SendReleaseKey(int virtCode)
     {
-      udp = new UdpClient(0);
-      loopbackPort = ((IPEndPoint)udp.Client.LocalEndPoint).Port;
-
-      thread = new Thread(delegate() { Listener(); });
-      thread.Start();
+      AddMessage(target, WM_KEYUP, virtCode, 1 + 1 &lt;&lt; 30 + 1 &lt;&lt; 31);
     }
 
-    private void Listener()
+
+    /// &lt;summary&gt;
+    /// Sends text - transforms chars to scan codes
+    /// &lt;/summary&gt;
+    /// &lt;param name=&quot;text&quot;&gt;text to be sent&lt;/param&gt;
+    public void SendText(string text)
     {
-      while (!close) {
-        IPEndPoint endpoint = new IPEndPoint(IPAddress.Loopback, 0);
-        byte[] data = udp.Receive(ref endpoint);
-        if (endpoint.Port != loopbackPort) {
-          springTalkPort = endpoint.Port;
-        }
-        if (data.Length &gt; 0) {
-          SpringEventArgs sea = new SpringEventArgs();
-
-          sea.EventType = (SpringEventType)data[0];
-
-          switch (sea.EventType) {
-            case SpringEventType.PLAYER_JOINED:
-              sea.PlayerNumber = data[1];
-              sea.PlayerName = Encoding.ASCII.GetString(data, 2, data.Length - 2);
-              break;
-            case SpringEventType.PLAYER_LEFT:
-              sea.PlayerNumber = data[1];
-              sea.Param = data[2];
-              break;
-            case SpringEventType.PLAYER_READY:
-              sea.PlayerNumber = data[1];
-              sea.Param = data[2];
-              break;
-
-            case SpringEventType.PLAYER_CHAT:
-              sea.PlayerNumber = data[1];
-              sea.Text = Encoding.ASCII.GetString(data, 2, data.Length - 2);
-              break;
-
-            case SpringEventType.PLAYER_DEFEATED:
-              sea.PlayerNumber = data[1];
-              break;
-          }
-          if (sea.PlayerName == null) {
-            sea.PlayerName = initialPlayers[sea.PlayerNumber].user.name;
-          }
-
-          if (SpringEvent != null) SpringEvent(this, sea);
-        }
+      for (int i = 0; i &lt; text.Length; ++i) {
+        int scan = VkKeyScan(text[i]);
+        SendKey(scan);
       }
     }
 
     public void Close()
     {
-      close = true;
-      UdpClient udclose = new UdpClient();
-      udclose.Send(new byte[2] { 0, (byte)SpringEventType.SERVER_QUIT }, 1, &quot;127.0.0.1&quot;, loopbackPort);
-      thread.Join(1000);
+      exitThread = true;
+      semaphore.Release(10);
+      senderThread.Join();
     }
 
-
-    #region IDisposable Members
-
-    public void Dispose()
+    #region Nested type: Message
+    private class Message
     {
-      Close();
-    }
+      public int lparam;
+      public int message;
+      public IntPtr target;
+      public int wparam;
 
+      public Message(IntPtr target, int message, int lparam, int wparam)
+      {
+        this.target = target;
+        this.message = message;
+        this.lparam = lparam;
+        this.wparam = wparam;
+      }
+    } ;
     #endregion
   }
-}
+}
\ No newline at end of file

Modified: branches/springie/planetwars/Springie/utils/Stats.cs
===================================================================
--- trunk/tools/springie/Springie/utils/Stats.cs	2008-09-28 21:53:42 UTC (rev 6476)
+++ branches/springie/planetwars/Springie/utils/Stats.cs	2008-09-28 23:01:48 UTC (rev 6479)
@@ -9,6 +9,7 @@
 using System.Xml.Serialization;
 using Springie.Client;
 using Springie.SpringNamespace;
+using PlanetWarsShared.Springie;
 
 namespace Springie
 {
@@ -21,7 +22,7 @@
     private List&lt;Account&gt; accounts = new List&lt;Account&gt;();
     private Battle battle;
     private string password = &quot;&quot;;
-    private Dictionary&lt;string, Player&gt; players = new Dictionary&lt;string, Player&gt;();
+    private Dictionary&lt;string, EndGamePlayerInfo&gt; players = new Dictionary&lt;string, EndGamePlayerInfo&gt;();
     private Spring spring;
     private DateTime startTime;
     private TasClient tas;
@@ -110,10 +111,20 @@
     {
       string query = String.Format(&quot;a=battle&amp;map={0}&amp;mod={1}&amp;title={2}&amp;start={3}&amp;duration={4}&quot;, battle.Map.Name, battle.Mod.Name, battle.Title, Utils.ToUnix(startTime), Utils.ToUnix(DateTime.Now.Subtract(startTime)));
 
-      foreach (Player p in players.Values) if (!p.Spectator &amp;&amp; p.AliveTillEnd) foreach (Player pset in players.Values) if (pset.AllyNumber == p.AllyNumber &amp;&amp; !pset.Spectator) pset.OnVictoryTeam = true;
+      foreach (EndGamePlayerInfo p in players.Values) if (!p.Spectator &amp;&amp; p.AliveTillEnd) foreach (EndGamePlayerInfo pset in players.Values) if (pset.AllyNumber == p.AllyNumber &amp;&amp; !pset.Spectator) pset.OnVictoryTeam = true;
 
-      foreach (Player p in players.Values) query += &quot;&amp;player[]=&quot; + p;
+      foreach (EndGamePlayerInfo p in players.Values) query += &quot;&amp;player[]=&quot; + p;
 
+			if (Program.main.config.PlanetWarsEnabled) {
+				try {
+					var pw = Program.main.PlanetWars;
+					pw.SendBattleResult(battle.Map.Name, players.Values);
+					Program.main.AutoHost.SayBattle(&quot;Planet status updated!&quot;);
+				} catch(Exception ex) {
+					Program.main.AutoHost.SayBattle(string.Format(&quot;Error sending planet battle result :(( {0}&quot;, ex.Message), true);
+				}
+			}
+
       // send only if there were at least 2 players in game
       if (players.Count &gt; 1) SendCommand(gatherScript, query, true, true);
     }
@@ -139,7 +150,7 @@
     private bool RegisterPlayerInCombat(string name)
     {
       if (players.ContainsKey(name)) return true;
-      Player p = new Player();
+      EndGamePlayerInfo p = new EndGamePlayerInfo();
       p.Name = name;
       int idx = battle.GetUserIndex(name);
       if (idx != -1) {
@@ -163,8 +174,8 @@
 
     private void spring_SpringStarted(object sender, EventArgs e)
     {
-      battle = tas.GetBattle();
-      players = new Dictionary&lt;string, Player&gt;();
+    	battle = tas.GetBattle();
+      players = new Dictionary&lt;string, EndGamePlayerInfo&gt;();
       startTime = DateTime.Now;
     }
 
@@ -235,32 +246,5 @@
       }
     } ;
     #endregion
-
-    #region Nested type: Player
-    private class Player
-    {
-      public bool AliveTillEnd = true;
-      public int AllyNumber = 0;
-      public TimeSpan DisconnectTime;
-      public string Ip = &quot;&quot;;
-      public TimeSpan LeaveTime;
-      public TimeSpan LoseTime;
-      public string Name = &quot;&quot;;
-      public bool OnVictoryTeam = false;
-      public int Rank = 0; // - actually rank + 1 .. starts at 1 and not 0
-      public string Side = &quot;&quot;; // mod side
-      public bool Spectator = false;
-
-      public override string ToString()
-      {
-        string ret = &quot;&quot;;
-        ret += Name + &quot;|&quot; + Ip + &quot;|&quot; + (Spectator ? &quot;1&quot; : &quot;0&quot;) + &quot;|&quot;;
-        ret += (OnVictoryTeam ? &quot;1&quot; : &quot;0&quot;) + &quot;|&quot; + (AliveTillEnd ? &quot;1&quot; : &quot;0&quot;) + &quot;|&quot;;
-        ret += Utils.ToUnix(DisconnectTime) + &quot;|&quot; + Utils.ToUnix(LeaveTime) + &quot;|&quot;;
-        ret += Side + &quot;|&quot; + Utils.ToUnix(LoseTime) + &quot;|&quot; + AllyNumber + &quot;|&quot; + Rank;
-        return ret;
-      }
-    } ;
-    #endregion
   }
 }
\ No newline at end of file

Modified: branches/springie/planetwars/Springie/utils/UnknownFilesLinker.cs
===================================================================
--- trunk/tools/springie/Springie/utils/UnknownFilesLinker.cs	2008-09-28 21:53:42 UTC (rev 6476)
+++ branches/springie/planetwars/Springie/utils/UnknownFilesLinker.cs	2008-09-28 23:01:48 UTC (rev 6479)
@@ -49,7 +49,7 @@
     public string GetMapBounceLink(string name)
     {
       name = spring.GetMapArchiveName(name);
-      return &quot;<A HREF="http://spring.jobjol.nl/search_result.php?select_select=select_file_name&amp;search=">http://spring.jobjol.nl/search_result.php?select_select=select_file_name&amp;search=</A>&quot; + Uri.EscapeDataString(name);
+      return &quot;<A HREF="http://spring.jobjol.nl/search_result.php?select_select=select_file_name&amp;search=">http://spring.jobjol.nl/search_result.php?select_select=select_file_name&amp;search=</A>&quot; + Uri.EscapeDataString(name) + &quot;  Or use CaDownloader to auto get maps for game: <A HREF="http://caspring.org/wiki/CaUpdater">http://caspring.org/wiki/CaUpdater</A>&quot;;
     }
 
     /// &lt;summary&gt;
@@ -59,6 +59,7 @@
     /// &lt;returns&gt;Search results&lt;/returns&gt;
     public string GetResults(string name, FileType type)
     {
+      return &quot;Use CaDownloader to get maps and mods automatically: <A HREF="http://caspring.org/wiki/CaUpdater">http://caspring.org/wiki/CaUpdater</A>&quot;;
       if (cachedResults.ContainsKey(name)) return cachedResults[name];
 
       WebClient wc = new WebClient();

Modified: branches/springie/planetwars/Springie.sln
===================================================================
--- trunk/tools/springie/Springie.sln	2008-09-28 21:53:42 UTC (rev 6476)
+++ branches/springie/planetwars/Springie.sln	2008-09-28 23:01:48 UTC (rev 6479)
@@ -9,8 +9,8 @@
 		Release|Any cpu = Release|Any cpu
 	EndGlobalSection
 	GlobalSection(ProjectConfigurationPlatforms) = postSolution
-		{DD5A4F64-6C82-4F75-9EED-992378EC65FC}.Debug|Any cpu.ActiveCfg = Release|x86
-		{DD5A4F64-6C82-4F75-9EED-992378EC65FC}.Debug|Any cpu.Build.0 = Release|x86
+		{DD5A4F64-6C82-4F75-9EED-992378EC65FC}.Debug|Any cpu.ActiveCfg = Debug|x86
+		{DD5A4F64-6C82-4F75-9EED-992378EC65FC}.Debug|Any cpu.Build.0 = Debug|x86
 		{DD5A4F64-6C82-4F75-9EED-992378EC65FC}.Release|Any cpu.ActiveCfg = Release|x86
 		{DD5A4F64-6C82-4F75-9EED-992378EC65FC}.Release|Any cpu.Build.0 = Release|x86
 	EndGlobalSection

Added: branches/springie/planetwars/libs/PlanetWarsShared.dll
===================================================================
(Binary files differ)


Property changes on: branches/springie/planetwars/libs/PlanetWarsShared.dll
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001248.html">[Taspring-linux-commit] r6478 - branches/springie
</A></li>
	<LI>Next message: <A HREF="001250.html">[Taspring-linux-commit] r6480 - in trunk/Lobby/BattleHubFramework:	nbproject nbproject/private src/aflobby	src/org/darkstars/battlehub/framework	src/org/darkstars/battlehub/framework/downloader	src/org/darkstars/battlehub/framework/protocol/tasserver	src/org/darkstars/battlehub/framework/spring
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1249">[ date ]</a>
              <a href="thread.html#1249">[ thread ]</a>
              <a href="subject.html#1249">[ subject ]</a>
              <a href="author.html#1249">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
