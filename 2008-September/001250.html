<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r6480 - in trunk/Lobby/BattleHubFramework:	nbproject nbproject/private src/aflobby	src/org/darkstars/battlehub/framework	src/org/darkstars/battlehub/framework/downloader	src/org/darkstars/battlehub/framework/protocol/tasserver	src/org/darkstars/battlehub/framework/spring
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-September/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6480%20-%20in%20trunk/Lobby/BattleHubFramework%3A%0A%09nbproject%20nbproject/private%20src/aflobby%0A%09src/org/darkstars/battlehub/framework%0A%09src/org/darkstars/battlehub/framework/downloader%0A%09src/org/darkstars/battlehub/framework/protocol/tasserver%0A%09src/org/darkstars/battlehub/framework/spring&In-Reply-To=%3C20080929112839.739414A79%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001249.html">
   <LINK REL="Next"  HREF="001251.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r6480 - in trunk/Lobby/BattleHubFramework:	nbproject nbproject/private src/aflobby	src/org/darkstars/battlehub/framework	src/org/darkstars/battlehub/framework/downloader	src/org/darkstars/battlehub/framework/protocol/tasserver	src/org/darkstars/battlehub/framework/spring</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6480%20-%20in%20trunk/Lobby/BattleHubFramework%3A%0A%09nbproject%20nbproject/private%20src/aflobby%0A%09src/org/darkstars/battlehub/framework%0A%09src/org/darkstars/battlehub/framework/downloader%0A%09src/org/darkstars/battlehub/framework/protocol/tasserver%0A%09src/org/darkstars/battlehub/framework/spring&In-Reply-To=%3C20080929112839.739414A79%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r6480 - in trunk/Lobby/BattleHubFramework:	nbproject nbproject/private src/aflobby	src/org/darkstars/battlehub/framework	src/org/darkstars/battlehub/framework/downloader	src/org/darkstars/battlehub/framework/protocol/tasserver	src/org/darkstars/battlehub/framework/spring">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Mon Sep 29 13:28:39 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001249.html">[Taspring-linux-commit] r6479 - in branches/springie: . planetwars	planetwars/Springie planetwars/Springie/autohost	planetwars/Springie/doc planetwars/Springie/spring	planetwars/Springie/utils planetwars/libs
</A></li>
        <LI>Next message: <A HREF="001251.html">[Taspring-linux-commit] r6481 - trunk/rts/Sim/Path
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1250">[ date ]</a>
              <a href="thread.html#1250">[ thread ]</a>
              <a href="subject.html#1250">[ subject ]</a>
              <a href="author.html#1250">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: tnowell
Date: 2008-09-29 13:28:38 +0200 (Mon, 29 Sep 2008)
New Revision: 6480

Added:
   trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/BrowserLauncher.java
   trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/CUnZipper.java
   trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/downloader/
   trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/downloader/CDownloadFile.form
   trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/downloader/CDownloadFile.java
   trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/downloader/IDownloaderListener.java
   trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/spring/
   trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/spring/CAutoHostUDPInterface.java
   trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/spring/CJNATest.java
   trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/spring/IAutoHostUDPListener.java
   trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/spring/IJNAUnitsync.java
Modified:
   trunk/Lobby/BattleHubFramework/nbproject/build-impl.xml
   trunk/Lobby/BattleHubFramework/nbproject/genfiles.properties
   trunk/Lobby/BattleHubFramework/nbproject/private/private.properties
   trunk/Lobby/BattleHubFramework/nbproject/project.properties
   trunk/Lobby/BattleHubFramework/nbproject/project.xml
   trunk/Lobby/BattleHubFramework/src/aflobby/CUnitSyncJNIBindings.java
   trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/CBasicTASChannelModel.java
   trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/CConnection.java
   trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/CCore.java
   trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/CErrorWindow.form
   trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/CErrorWindow.java
   trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/CEvent.java
   trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/CEventTypes.java
   trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/CPlayer.java
   trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/ICentralClass.java
   trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/IModule.java
   trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/Misc.java
   trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/protocol/tasserver/CBasicTASServerProtocol.java
Log:
An update committing a tonne of changes and fixes I should have committed a while ago

note: this commit may require jna.jar as a library dependency but if requested you can remove the JNA test files from the project and remove the dependency as its not required.

- moved various files into the framework project
- added a few simple JNA test classes, these should not be considered fully functional alternatives to JNI
- architectural changes in progress
-- Message types and on remove and add events etc, 'event/message channels' so that the old way of all events go to all listeners isn't necessary any more
-- CEvent has a lot fo static strings which are now being moved into CEventTypes for clarification
-- sent protocol traffic event channel added
- corrected an issue with differing unicode encodings to fix compatibility with uberserver
- corrected some issues with image paths in player class
- improved timeout values
- moved error windows and the file downloader utility classes into the framework


Modified: trunk/Lobby/BattleHubFramework/nbproject/build-impl.xml
===================================================================
--- trunk/Lobby/BattleHubFramework/nbproject/build-impl.xml	2008-09-28 23:01:48 UTC (rev 6479)
+++ trunk/Lobby/BattleHubFramework/nbproject/build-impl.xml	2008-09-29 11:28:38 UTC (rev 6480)
@@ -35,18 +35,37 @@
         &lt;property file=&quot;nbproject/private/configs/${config}.properties&quot;/&gt;
         &lt;property file=&quot;nbproject/private/private.properties&quot;/&gt;
     &lt;/target&gt;
-    &lt;target depends=&quot;-pre-init,-init-private&quot; name=&quot;-init-user&quot;&gt;
+    &lt;target depends=&quot;-pre-init,-init-private&quot; name=&quot;-init-libraries&quot;&gt;
+        &lt;property location=&quot;.\lib\nblibraries.properties&quot; name=&quot;libraries.1.path&quot;/&gt;
+        &lt;dirname file=&quot;${libraries.1.path}&quot; property=&quot;libraries.1.dir.nativedirsep&quot;/&gt;
+        &lt;pathconvert dirsep=&quot;/&quot; property=&quot;libraries.1.dir&quot;&gt;
+            &lt;path path=&quot;${libraries.1.dir.nativedirsep}&quot;/&gt;
+        &lt;/pathconvert&gt;
+        &lt;basename file=&quot;${libraries.1.path}&quot; property=&quot;libraries.1.basename&quot; suffix=&quot;.properties&quot;/&gt;
+        &lt;touch file=&quot;${libraries.1.dir}/${libraries.1.basename}-private.properties&quot;/&gt;
+        &lt;loadproperties srcfile=&quot;${libraries.1.dir}/${libraries.1.basename}-private.properties&quot;&gt;
+            &lt;filterchain&gt;
+                &lt;replacestring from=&quot;$${base}&quot; to=&quot;${libraries.1.dir}&quot;/&gt;
+            &lt;/filterchain&gt;
+        &lt;/loadproperties&gt;
+        &lt;loadproperties srcfile=&quot;${libraries.1.path}&quot;&gt;
+            &lt;filterchain&gt;
+                &lt;replacestring from=&quot;$${base}&quot; to=&quot;${libraries.1.dir}&quot;/&gt;
+            &lt;/filterchain&gt;
+        &lt;/loadproperties&gt;
+    &lt;/target&gt;
+    &lt;target depends=&quot;-pre-init,-init-private,-init-libraries&quot; name=&quot;-init-user&quot;&gt;
         &lt;property file=&quot;${user.properties.file}&quot;/&gt;
         &lt;!-- The two properties below are usually overridden --&gt;
         &lt;!-- by the active platform. Just a fallback. --&gt;
         &lt;property name=&quot;default.javac.source&quot; value=&quot;1.4&quot;/&gt;
         &lt;property name=&quot;default.javac.target&quot; value=&quot;1.4&quot;/&gt;
     &lt;/target&gt;
-    &lt;target depends=&quot;-pre-init,-init-private,-init-user&quot; name=&quot;-init-project&quot;&gt;
+    &lt;target depends=&quot;-pre-init,-init-private,-init-libraries,-init-user&quot; name=&quot;-init-project&quot;&gt;
         &lt;property file=&quot;nbproject/configs/${config}.properties&quot;/&gt;
         &lt;property file=&quot;nbproject/project.properties&quot;/&gt;
     &lt;/target&gt;
-    &lt;target depends=&quot;-pre-init,-init-private,-init-user,-init-project,-init-macrodef-property&quot; name=&quot;-do-init&quot;&gt;
+    &lt;target depends=&quot;-pre-init,-init-private,-init-libraries,-init-user,-init-project,-init-macrodef-property&quot; name=&quot;-do-init&quot;&gt;
         &lt;available file=&quot;${manifest.file}&quot; property=&quot;manifest.available&quot;/&gt;
         &lt;condition property=&quot;manifest.available+main.class&quot;&gt;
             &lt;and&gt;
@@ -123,7 +142,7 @@
         &lt;!-- Empty placeholder for easier customization. --&gt;
         &lt;!-- You can override this target in the ../build.xml file. --&gt;
     &lt;/target&gt;
-    &lt;target depends=&quot;-pre-init,-init-private,-init-user,-init-project,-do-init&quot; name=&quot;-init-check&quot;&gt;
+    &lt;target depends=&quot;-pre-init,-init-private,-init-libraries,-init-user,-init-project,-do-init&quot; name=&quot;-init-check&quot;&gt;
         &lt;fail unless=&quot;src.dir&quot;&gt;Must set src.dir&lt;/fail&gt;
         &lt;fail unless=&quot;test.src.dir&quot;&gt;Must set test.src.dir&lt;/fail&gt;
         &lt;fail unless=&quot;build.dir&quot;&gt;Must set build.dir&lt;/fail&gt;
@@ -304,7 +323,7 @@
             &lt;/jar&gt;
         &lt;/presetdef&gt;
     &lt;/target&gt;
-    &lt;target depends=&quot;-pre-init,-init-private,-init-user,-init-project,-do-init,-post-init,-init-check,-init-macrodef-property,-init-macrodef-javac,-init-macrodef-junit,-init-macrodef-nbjpda,-init-macrodef-debug,-init-macrodef-java,-init-presetdef-jar&quot; name=&quot;init&quot;/&gt;
+    &lt;target depends=&quot;-pre-init,-init-private,-init-libraries,-init-user,-init-project,-do-init,-post-init,-init-check,-init-macrodef-property,-init-macrodef-javac,-init-macrodef-junit,-init-macrodef-nbjpda,-init-macrodef-debug,-init-macrodef-java,-init-presetdef-jar&quot; name=&quot;init&quot;/&gt;
     &lt;!--
                 ===================
                 COMPILATION SECTION

Modified: trunk/Lobby/BattleHubFramework/nbproject/genfiles.properties
===================================================================
--- trunk/Lobby/BattleHubFramework/nbproject/genfiles.properties	2008-09-28 23:01:48 UTC (rev 6479)
+++ trunk/Lobby/BattleHubFramework/nbproject/genfiles.properties	2008-09-29 11:28:38 UTC (rev 6480)
@@ -1,8 +1,8 @@
-build.xml.data.CRC32=b9936c08
+build.xml.data.CRC32=0bbc455d
 build.xml.script.CRC32=baa70c3a
 build.xml.stylesheet.CRC32=be360661
 # This file is used by a NetBeans-based IDE to track changes in generated files such as build-impl.xml.
 # Do not edit this file. You may delete it but then the IDE will never regenerate such files for you.
-nbproject/build-impl.xml.data.CRC32=b9936c08
-nbproject/build-impl.xml.script.CRC32=39020141
+nbproject/build-impl.xml.data.CRC32=0bbc455d
+nbproject/build-impl.xml.script.CRC32=d08caf33
 nbproject/build-impl.xml.stylesheet.CRC32=487672f9

Modified: trunk/Lobby/BattleHubFramework/nbproject/private/private.properties
===================================================================
--- trunk/Lobby/BattleHubFramework/nbproject/private/private.properties	2008-09-28 23:01:48 UTC (rev 6479)
+++ trunk/Lobby/BattleHubFramework/nbproject/private/private.properties	2008-09-29 11:28:38 UTC (rev 6480)
@@ -1,2 +1,6 @@
+do.depend=false
+do.jar=true
+javac.debug=true
+javadoc.preview=true
 jaxws.endorsed.dir=C:\\Program Files (x86)\\NetBeans 6.1\\java2\\modules\\ext\\jaxws21\\api
 user.properties.file=C:\\Users\\AF-Standard\\.netbeans\\6.1\\build.properties

Modified: trunk/Lobby/BattleHubFramework/nbproject/project.properties
===================================================================
--- trunk/Lobby/BattleHubFramework/nbproject/project.properties	2008-09-28 23:01:48 UTC (rev 6479)
+++ trunk/Lobby/BattleHubFramework/nbproject/project.properties	2008-09-29 11:28:38 UTC (rev 6480)
@@ -1,3 +1,5 @@
+application.title=BattleHubFramework
+application.vendor=AF-Standard
 build.classes.dir=${build.dir}/classes
 build.classes.excludes=**/*.java,**/*.form
 # This directory is removed when the project is cleaned:
@@ -16,9 +18,11 @@
 dist.jar=${dist.dir}/BattleHubFramework.jar
 dist.javadoc.dir=${dist.dir}/javadoc
 excludes=
+file.reference.jna.jar=lib/jna.jar
 includes=**
 jar.compress=false
-javac.classpath=
+javac.classpath=\
+    ${file.reference.jna.jar}
 # Space-separated list of extra javac options
 javac.compilerargs=
 javac.deprecation=false

Modified: trunk/Lobby/BattleHubFramework/nbproject/project.xml
===================================================================
--- trunk/Lobby/BattleHubFramework/nbproject/project.xml	2008-09-28 23:01:48 UTC (rev 6479)
+++ trunk/Lobby/BattleHubFramework/nbproject/project.xml	2008-09-29 11:28:38 UTC (rev 6480)
@@ -12,5 +12,8 @@
                 &lt;root id=&quot;test.src.dir&quot;/&gt;
             &lt;/test-roots&gt;
         &lt;/data&gt;
+        &lt;libraries xmlns=&quot;<A HREF="http://www.netbeans.org/ns/ant-project-libraries/1">http://www.netbeans.org/ns/ant-project-libraries/1</A>&quot;&gt;
+            &lt;definitions&gt;.\lib\nblibraries.properties&lt;/definitions&gt;
+        &lt;/libraries&gt;
     &lt;/configuration&gt;
 &lt;/project&gt;

Modified: trunk/Lobby/BattleHubFramework/src/aflobby/CUnitSyncJNIBindings.java
===================================================================
--- trunk/Lobby/BattleHubFramework/src/aflobby/CUnitSyncJNIBindings.java	2008-09-28 23:01:48 UTC (rev 6479)
+++ trunk/Lobby/BattleHubFramework/src/aflobby/CUnitSyncJNIBindings.java	2008-09-29 11:28:38 UTC (rev 6480)
@@ -38,7 +38,11 @@
     /**
      * A boolean signifying if the library is loaded. If the library is
      */
-    public static boolean loaded = false;
+    private static boolean loaded = false;
+    
+    public static boolean IsLoaded(){
+        return loaded;
+    }
 
     public static void LoadUnitSync(String libpath) throws UnsatisfiedLinkError{
 
@@ -118,7 +122,7 @@
     public static native int        GetMapCount             ();
     public static native String     GetMapName              (int index);
 
-    //public static native int      GetMapInfoEx(String name, MapInfo outInfo, int version);
+    //public static native String     GetMapInfo(String name);
 
     //public static native void*    GetMinimap(String filename, int miplevel);
     

Added: trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/BrowserLauncher.java
===================================================================
--- trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/BrowserLauncher.java	                        (rev 0)
+++ trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/BrowserLauncher.java	2008-09-29 11:28:38 UTC (rev 6480)
@@ -0,0 +1,61 @@
+//  Bare Bones Browser Launch                          //
+//  Version 1.5                                        //
+//  December 10, 2005                                  //
+//  Supports: Mac OS X, GNU/Linux, Unix, Windows XP    //
+//  Example Usage:                                     //
+//     String url = &quot;<A HREF="http://www.centerkey.com/">http://www.centerkey.com/</A>&quot;;       //
+//     BareBonesBrowserLaunch.openURL(url);            //
+//  Public Domain Software -- Free to Use as You Like  //
+/////////////////////////////////////////////////////////
+// numerous functiosn ahve been rplaced or modified with replacement versions for windows from:
+package org.darkstars.battlehub.framework;
+
+import java.net.URI;
+import javax.swing.JOptionPane;
+
+public class BrowserLauncher {
+
+    private static final String errMsg = java.util.ResourceBundle.getBundle(&quot;org.darkstars.battlehub.languages&quot;).getString(&quot;BrowserLauncher.Error_attempting_to_launch_web_browser&quot;);
+
+    public static void openURL(String url) {
+        java.awt.Desktop desktop = java.awt.Desktop.getDesktop();
+        if (desktop.isSupported(java.awt.Desktop.Action.BROWSE)) {
+            URI uri = null;
+            try {
+                uri = new URI(url);
+                desktop.browse(uri);
+            }
+            catch(Exception e) {
+                JOptionPane.showMessageDialog(null, errMsg + &quot;:\n&quot; + e.getLocalizedMessage());
+            }
+        }
+        
+        /*String osName = System.getProperty(&quot;os.name&quot;);
+        try {
+            if (osName.startsWith(&quot;Mac OS&quot;)) {
+                Class fileMgr = Class.forName(&quot;com.apple.eio.FileManager&quot;);
+                @SuppressWarnings(value = &quot;unchecked&quot;)
+                Method openURL = fileMgr.getDeclaredMethod(&quot;openURL&quot;, new Class[]{String.class});
+                openURL.invoke(null, new Object[]{url});
+            } else if (osName.startsWith(&quot;Windows&quot;)) {
+                Runtime.getRuntime().exec(&quot;rundll32 url.dll,FileProtocolHandler &quot; + url);
+            } else {
+                //assume Unix or Linux
+                String[] browsers = {&quot;opera&quot;, &quot;firefox&quot;, &quot;konqueror&quot;, &quot;epiphany&quot;, &quot;mozilla&quot;, &quot;netscape&quot;};
+                String browser = null;
+                for (int count = 0; count &lt; browsers.length &amp;&amp; browser == null; count++) {
+                    if (Runtime.getRuntime().exec(new String[]{&quot;which&quot;, browsers[count]}).waitFor() == 0) {
+                        browser = browsers[count];
+                    }
+                }
+                if (browser == null) {
+                    throw new Exception(java.util.ResourceBundle.getBundle(&quot;org.darkstars.battlehub.languages&quot;).getString(&quot;BrowserLauncher.Could_not_find_web_browser&quot;));
+                } else {
+                    Runtime.getRuntime().exec(new String[]{browser, url});
+                }
+            }
+        } catch (Exception e) {
+            
+        }*/
+    }
+}

Modified: trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/CBasicTASChannelModel.java
===================================================================
--- trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/CBasicTASChannelModel.java	2008-09-28 23:01:48 UTC (rev 6479)
+++ trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/CBasicTASChannelModel.java	2008-09-29 11:28:38 UTC (rev 6480)
@@ -81,4 +81,12 @@
         //
     }
 
+    public void OnEvent(CEvent e) {
+        throw new UnsupportedOperationException(&quot;Not supported yet.&quot;);
+    }
+
+    public void OnRemove(int channel) {
+        throw new UnsupportedOperationException(&quot;Not supported yet.&quot;);
+    }
+
 }

Modified: trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/CConnection.java
===================================================================
--- trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/CConnection.java	2008-09-28 23:01:48 UTC (rev 6479)
+++ trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/CConnection.java	2008-09-29 11:28:38 UTC (rev 6480)
@@ -9,16 +9,16 @@
 package org.darkstars.battlehub.framework;
 
 import java.io.BufferedReader;
-import java.io.DataOutputStream;
 import java.io.IOException;
 import java.io.InputStreamReader;
+import java.io.OutputStreamWriter;
+import java.io.PrintWriter;
 import java.net.Socket;
+import java.net.SocketException;
 import java.net.UnknownHostException;
 import java.util.ArrayList;
 import java.util.Timer;
 import java.util.TimerTask;
-import java.util.logging.Level;
-import java.util.logging.Logger;
 
 
 /**
@@ -88,7 +88,8 @@
     public ArrayList&lt;String&gt; messages = new ArrayList&lt;String&gt;();
     Socket socket = null;
     BufferedReader sockin = null;
-    DataOutputStream sockout = null;
+//    DataOutputStream sockout = null;
+    PrintWriter sockout = null;
     int second_interim = 0;
     Timer updates = null;
     Timer pingtask = null;
@@ -169,8 +170,9 @@
                 getTraffic().Add(&quot;Connecting to &quot; + server + &quot;:&quot; + port + &quot; ...&quot;);
         }
         socket = new Socket(server, port);
-        sockout = new DataOutputStream(socket.getOutputStream());
-        sockin = new BufferedReader(new InputStreamReader(socket.getInputStream()));
+        sockout = new PrintWriter(new OutputStreamWriter(socket.getOutputStream(), &quot;utf-8&quot;), true);
+//        sockout = new DataOutputStream(socket.getOutputStream());
+        sockin = new BufferedReader(new InputStreamReader(socket.getInputStream(),&quot;utf-8&quot;));
 
         if (sockin == null) {
             if(getTraffic() != null){
@@ -199,7 +201,7 @@
             updates.schedule(new JCUpdateTask(this), 5, 10); //subsequent rate
             pingtask = new Timer();
             pingtask.schedule(new JCPingTask(this), 500, 8000); //subsequent rate
-            socket.setSoTimeout(5000);
+            socket.setSoTimeout(2500);
             return true;
         }
         /*} catch (UnknownHostException e) {
@@ -255,7 +257,7 @@
                 }
                 
                 logged_in = false;
-                CEvent e2 = new CEvent(CEvent.DISCONNECT);
+                CEvent e2 = new CEvent(CEventTypes.DISCONNECT);
                 distributor.NewGUIEvent(e2);
             } catch (IOException ex) {
                 if(getTraffic() != null){
@@ -295,7 +297,7 @@
         if (!IsConnected()) {
             if (connected) {
                 // DISCONNECTED!!!!!!!!!! AHK AHK AHK AHK
-                CEvent e2 = new CEvent(CEvent.DISCONNECTED);
+                CEvent e2 = new CEvent(CEventTypes.DISCONNECTED);
                 distributor.NewGUIEvent(e2);
                 logged_in = false;
             }
@@ -319,6 +321,17 @@
                             break;
                         }
                     }
+                } catch (SocketException ex) {
+                    if(getTraffic() != null){
+                        getTraffic().Add(ex.toString());
+                        StackTraceElement[] si = ex.getStackTrace();
+                        for (int i = 0; i &lt; si.length; i++) {
+                            getTraffic().Add(si[i].toString());
+                        }
+                    }
+                    CEvent e2 = new CEvent(CEventTypes.DISCONNECTED);
+                    distributor.NewGUIEvent(e2);
+                    logged_in = false;
                 } catch (IOException ex) {
                     if(getTraffic() != null){
                         getTraffic().Add(ex.toString());
@@ -327,6 +340,9 @@
                             getTraffic().Add(si[i].toString());
                         }
                     }
+                    CEvent e2 = new CEvent(CEventTypes.DISCONNECTED);
+                    distributor.NewGUIEvent(e2);
+                    logged_in = false;
                     
                 }
                 if (second_interim == 0) {
@@ -341,7 +357,7 @@
                 int i = 0;
 
                 if(!socket.isClosed()){
-                    try {
+//                    try {
                         while (traffic_cache_out.isEmpty() == false) {
 
 
@@ -358,7 +374,15 @@
                             
                             // recheck the socket to see if it hasnt closed while the loops active
                             if(socket.isConnected()){
-                                sockout.writeBytes(msg + &quot;\n&quot;); //println(msg);
+                                
+                                sockout.println(msg);
+                                if(sockout.checkError()){
+                                    //
+                                    CEvent e2 = new CEvent(CEvent.DISCONNECTED);
+                                    distributor.NewGUIEvent(e2);
+                                    logged_in = false;
+                                }
+//                                sockout.writeBytes(msg + &quot;\n&quot;); //println(msg);
                             }else{
                                 break;
                             }
@@ -373,14 +397,17 @@
 
                         }
                         sockout.flush();
-                    } catch (java.net.SocketException e){
-                        //
-                        CEvent e2 = new CEvent(CEvent.DISCONNECTED);
-                        distributor.NewGUIEvent(e2);
-                        logged_in = false;
-                    }catch (IOException ex) {
-                        Logger.getLogger(CConnection.class.getName()).log(Level.SEVERE, null, ex);
-                    }
+//                    } catch (java.net.SocketException e){
+//                        //
+//                        CEvent e2 = new CEvent(CEvent.DISCONNECTED);
+//                        distributor.NewGUIEvent(e2);
+//                        logged_in = false;
+//                    }catch (IOException ex) {
+//                        Logger.getLogger(CConnection.class.getName()).log(Level.SEVERE, null, ex);
+//                        CEvent e2 = new CEvent(CEvent.DISCONNECTED);
+//                        distributor.NewGUIEvent(e2);
+//                        logged_in = false;
+//                    }
                 }
 
             //}

Modified: trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/CCore.java
===================================================================
--- trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/CCore.java	2008-09-28 23:01:48 UTC (rev 6479)
+++ trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/CCore.java	2008-09-29 11:28:38 UTC (rev 6480)
@@ -4,7 +4,8 @@
  */
 package org.darkstars.battlehub.framework;
 
-import java.util.ArrayList;
+import java.util.HashMap;
+import java.util.Map;
 import javax.swing.event.EventListenerList;
 
 /**
@@ -13,114 +14,126 @@
  */
 public class CCore implements IModule {
 
-    private EventListenerList modules = new EventListenerList();
-    private ArrayList&lt;CEvent&gt; GUIeventqueue = new ArrayList&lt;CEvent&gt;();
-    private ArrayList&lt;CEvent&gt; eventqueue = new ArrayList&lt;CEvent&gt;();
+    //private EventListenerList modules = new EventListenerList();
+    
+    private Map&lt;Integer,EventListenerList&gt; channelModules;
 
     /**
+     * Glorified error value, and default channel value used when a CEvent 
+     * object has not been given a channel in its constructor.
      * 
+     * Usually found on events that use the old way fo doing things e.g. 
+     * NewEvent NewGUIEvent
+     * 
+     * @see NewEvent()
+     * @see NewGUIEvent()
+     */
+    public final static int UNDEFINED_CHANNEL = 0;
+    
+    /**
+     * This channel is used for delivering raw server traffic, raw protocol.
+     */
+    public final static int RCVD_SERVER_TRAFFIC = 1;
+    
+    /**
+     * This channel is used for delivering messages that the lobby has sent to 
+     * the end server. If you send &quot;HELLO WORLD&quot; to the server a message 
+     * containing &quot;HELLO WORLD&quot; will be sent on this channel.
+     */
+    public final static int SENT_SERVER_TRAFFIC = 2;
+    
+    /**
+     * This is basically intended to manage the NewGUIEvent() call that is now 
+     * deprecated
+     * 
+     * @see NewGUIEvent()
+     * @deprecated
+     */
+    @Deprecated
+    public final static int LOBBY_GUI_EVENTS = 3;
+    
+    /**
+     * These events do not actually occur in the protocol, and are intended to 
+     * be protocol agnostic. Ideally this channel would be used rather than 
+     * actual protocol, and the only place raw protocol should occur is at the 
+     * protocol layer when translated to and from the end server.
+     */
+    public final static int PROTOCOL_EVENTS = 4;
+    
+    /**
+     * Issues an Update() call
+     */
+    public final static int TIMER_UPDATE = 5;
+    
+    /**
+     * Used for the creation of UI objects and the messages that add them to 
+     * other UI components or remove them. Additions, movements, and removals 
+     * basically.
+     * 
+     * Note: The modification and handling of UI objects that have already been
+     * placed, such as click events or other processing is outside the scope of 
+     * this event channel.
+     */
+    public final static int UI_OBJECT_MANAGEMENT = 6;
+    
+    public CCore(){
+        // create our hashmap of event listeners
+        channelModules = new HashMap&lt;Integer, EventListenerList&gt;();
+        
+        // create the old deprecated channels for backwards compatibility.
+        CreateChannel(LOBBY_GUI_EVENTS);
+        CreateChannel(RCVD_SERVER_TRAFFIC);
+        CreateChannel(TIMER_UPDATE);
+    }
+    /**
+     * 
      * @param L
      */
     @Override
-    public void Init(final ICentralClass LM){
+    public void Init(final ICentralClass LM) {
         //
     }
 
     /**
+     * A CEvent object created for timer updates once so that it neednt be 
+     * recreated and garbage collected every time an Update call is needed.
+     */
+    private CEvent timeupd = new CEvent(&quot;TIMER&quot;, false, TIMER_UPDATE);
+    
+    /**
      * Calls the update method of registered event handlers and dispatches
      * events.
      */
     @Override
+    @Deprecated
     public void Update() {
-
-        // check if a previous Update call is still running
-        //if(isUpdating){
-        // we're already running an update!
-        //    return;
-        //}
-
-        // specify that the update method is now running
-        /*isUpdating = true;
-
-
-        if (eventqueue.isEmpty() == false) {
-            Object[] queue = eventqueue.toArray();
-            eventqueue.clear();
-            
-            int eCount = queue.length;
-
-            for (int ie = 0; ie &lt; eCount; ie++) {
-                CEvent e = (CEvent) queue[ie];
-
-                if (e == null) {
-                    continue;
-                }
-                
-
-
-                fireEvent(e, 1);
-            }
-
-            eventqueue.clear();
-        }
-
-        if (GUIeventqueue.isEmpty() == false) {
-
-            Object[] queue = GUIeventqueue.toArray();
-            GUIeventqueue.clear();
-            
-            int eCount = queue.length;
-
-            for (int ie = 0; ie &lt; eCount; ie++) {
-                CEvent e = (CEvent) queue[ie];
-
-                if (e == null) {
-                    continue;
-                }
-                
-
-                fireEvent(e, 0);
-            }
-        }*/
-
-        //synchronized(modules)
-
-        /*ArrayList&lt;IModule&gt; tm = new ArrayList&lt;IModule&gt;();
-        synchronized(modules){
-        tm.addAll(modules);
-        }*/
-
-
-        fireEvent(null,2);
-    //
-
-    // specify that the update method is no longer running
-    //isUpdating = false;
+        FireEvent(timeupd, CCore.TIMER_UPDATE);
     }
-    //public boolean isUpdating = false;
 
     /**
      * 
      * @param e
      */
     @Override
+    @Deprecated
     public void NewEvent(CEvent e) {
-        fireEvent(e, 1);
-/*        synchronized (eventqueue) {
-            eventqueue.add(e);
-        }
-*/    }
+        assert(e != null);
+//        if(e.IsValid()){
+            FireEvent(e, CCore.RCVD_SERVER_TRAFFIC);
+//        }
+    }
 
     /**
      * 
      * @param e
      */
     @Override
+    @Deprecated
     public void NewGUIEvent(CEvent e) {
-        fireEvent(e, 0);
-//        synchronized (GUIeventqueue) {
-//            GUIeventqueue.add(e);
-  //      }
+        assert(e != null);
+        //if(e.IsValid()){
+            FireEvent(e, CCore.LOBBY_GUI_EVENTS);
+       // }
     }
 
     /**
@@ -128,40 +141,78 @@
      * 
      * @param module the module to be added
      */
+    @Deprecated
     public void AddModule(IModule module) {
-        //
-        //synchronized(modules){
-        modules.add(IModule.class, module);
-    //if(modules.contains(module)==false){
-    //    modules.add(module);
-    //}
-    //}
+        AddModule(module, CCore.RCVD_SERVER_TRAFFIC);
+        AddModule(module, CCore.LOBBY_GUI_EVENTS);
+        AddModule(module, CCore.TIMER_UPDATE);
     }
+    
+    /**
+     * Adds a new module to the given event channel system.
+     * 
+     * @param module the module to be added
+     * @param channel the channel the module is to be registered to
+     */
+    public void AddModule(IModule module, int channel) {
+        if(HasChannel(channel)==false){
+            CreateChannel(channel);
+        }
+        GetChannelModules(channel).add(IModule.class, module);
+    }
 
     /**
      * Removes a module from the event system.
      * 
      * @param module the module to be removed
      */
+    @Deprecated
     public void RemoveModule(IModule module) {
-        assert(module != null);
-        //synchronized(modules){
-        module.OnRemove();
-        modules.remove(IModule.class, module);
-    //}
+        if(module != null){
+            module.OnRemove();
+            
+            // make sure the object is removed from the default backwards compat channels
+            channelModules.get(RCVD_SERVER_TRAFFIC).remove(IModule.class, module);
+            channelModules.get(LOBBY_GUI_EVENTS).remove(IModule.class, module);
+            channelModules.get(TIMER_UPDATE).remove(IModule.class, module);
+        }
     }
     
     /**
+     * Removes a module from the event system.
+     * 
+     * @param module the module to be removed
+     * @param channel the event channel this objects to be removed from
+     */
+    public void RemoveModule(IModule module, int channel) {
+        if(module != null){
+            module.OnRemove(channel);
+            channelModules.get(channel).remove(IModule.class, module);
+        }
+    }
+
+    /**
      * Empties all modules from this event system
      */
-    public void RemoveAllModules(){
+    @Deprecated
+    public void RemoveAllModules() {
         //
-        Object[] listeners = modules.getListenerList().clone();
-        if(listeners != null){
-            for(int i = 0; i&lt;listeners.length; i++){
+        RemoveAllChannelModules(CCore.RCVD_SERVER_TRAFFIC);
+        RemoveAllChannelModules(CCore.LOBBY_GUI_EVENTS);
+        RemoveAllChannelModules(CCore.TIMER_UPDATE);
+    }
+    
+    /**
+     * Empties all modules from a given message channel
+     */
+    public void RemoveAllChannelModules(int channel) {
+        //
+        Object[] listeners = GetChannelModules(channel).getListenerList().clone();
+        if (listeners != null) {
+            for (int i = 0; i &lt; listeners.length; i++) {
                 Object o = listeners[i];
                 if (o.getClass() == IModule.class) {
-                    RemoveModule( (IModule) o);
+                    RemoveModule((IModule) o,channel);
                 }
             }
         }
@@ -169,28 +220,98 @@
 
     @Override
     public void OnRemove() {
-
     }
-    
-    
-
-    private synchronized void fireEvent(final CEvent e, int type) {
-        Object[] listeners = modules.getListenerList();
+//synchronized
+    @Deprecated
+    private  void FireEvent(CEvent e, int channel) {
+        
+        assert(e != null);
+        if(channel != CCore.RCVD_SERVER_TRAFFIC){
+            
+            if( channel != CCore.LOBBY_GUI_EVENTS){
+                if(channel != CCore.TIMER_UPDATE){
+                    FireEvent(e);
+                    return;
+                }
+            }
+        }
+        if(!HasChannel(channel)){
+            return;
+        }
+        Object[] listeners = GetChannelModules(channel).getListenerList();
         // loop through each listener and pass on the event if needed
         int numListeners = listeners.length;
         for (int i = 0; i &lt; numListeners; i += 2) {
+            if(!e.IsValid()){
+                break;
+            }
             if (listeners[i] == IModule.class) {
                 // pass the event to the listeners event dispatch method
-                if (type == 0) {
+                if (channel == CCore.LOBBY_GUI_EVENTS) {
                     ((IModule) listeners[i + 1]).NewGUIEvent(e);
-                } else if (type == 1) {
+                } else if (channel == CCore.RCVD_SERVER_TRAFFIC) {
                     ((IModule) listeners[i + 1]).NewEvent(e);
-                } else if (type == 2) {
+                } else if (channel == CCore.TIMER_UPDATE) {
                     ((IModule) listeners[i + 1]).Update();
                 }
 
             }
         }
     }
+    
+    //synchronized
+    
+    public  void FireEvent(CEvent e) {
+        int channel = e.GetMessageChannel();
+        if(channel == CCore.UNDEFINED_CHANNEL){
+            throw new RuntimeException(&quot;undefined channel used for event&quot;);
+        }
+        if(!HasChannel(channel)){
+            return;
+        }
+        Object[] listeners = GetChannelModules(channel).getListenerList();
+        // loop through each listener and pass on the event if needed
+        int numListeners = listeners.length;
+        for (int i = 0; i &lt; numListeners; i += 2) {
+            if(!e.IsValid()){
+                break;
+            }
+            if (listeners[i] == IModule.class) {
+                // pass the event to the listeners event dispatch method
+                ((IModule) listeners[i + 1]).OnEvent(e);
+            }
+        }
+    }
+    
+    public boolean HasChannel(int channel){
+        return channelModules.containsKey(channel);
+    }
+    
+    public boolean HasChannelListeners(int channel){
+        //
+        if(!HasChannel(channel)){
+            return false;
+        }
+        return (GetChannelModules(channel).getListenerCount()&gt; 0);
+    }
+    
+    public void CreateChannel(int channel){
+        if(!HasChannel(channel)){
+            channelModules.put(channel, new EventListenerList());
+        }
+    }
+    
+    protected EventListenerList GetChannelModules(int channel){
+        //
+        return channelModules.get(channel);
+    }
+
+    public void OnEvent(CEvent e) {
+        throw new UnsupportedOperationException(&quot;Not supported yet.&quot;);
+    }
+
+    public void OnRemove(int channel) {
+        throw new UnsupportedOperationException(&quot;Not supported yet.&quot;);
+    }
 }
 

Modified: trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/CErrorWindow.form
===================================================================
--- trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/CErrorWindow.form	2008-09-28 23:01:48 UTC (rev 6479)
+++ trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/CErrorWindow.form	2008-09-29 11:28:38 UTC (rev 6480)
@@ -30,7 +30,11 @@
                   &lt;Component id=&quot;jLabel2&quot; alignment=&quot;0&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
                   &lt;Component id=&quot;noticeLabel&quot; alignment=&quot;0&quot; pref=&quot;631&quot; max=&quot;32767&quot; attributes=&quot;0&quot;/&gt;
                   &lt;Component id=&quot;jLabel1&quot; alignment=&quot;0&quot; pref=&quot;631&quot; max=&quot;32767&quot; attributes=&quot;0&quot;/&gt;
-                  &lt;Component id=&quot;copyButton&quot; alignment=&quot;0&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                  &lt;Group type=&quot;102&quot; alignment=&quot;0&quot; attributes=&quot;0&quot;&gt;
+                      &lt;Component id=&quot;copyButton&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                      &lt;EmptySpace max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                      &lt;Component id=&quot;jButton1&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                  &lt;/Group&gt;
               &lt;/Group&gt;
               &lt;EmptySpace max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
           &lt;/Group&gt;
@@ -48,7 +52,10 @@
               &lt;EmptySpace min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
               &lt;Component id=&quot;jScrollPane1&quot; pref=&quot;248&quot; max=&quot;32767&quot; attributes=&quot;0&quot;/&gt;
               &lt;EmptySpace min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
-              &lt;Component id=&quot;copyButton&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+              &lt;Group type=&quot;103&quot; groupAlignment=&quot;3&quot; attributes=&quot;0&quot;&gt;
+                  &lt;Component id=&quot;copyButton&quot; alignment=&quot;3&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                  &lt;Component id=&quot;jButton1&quot; alignment=&quot;3&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+              &lt;/Group&gt;
               &lt;EmptySpace min=&quot;-2&quot; pref=&quot;11&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
           &lt;/Group&gt;
       &lt;/Group&gt;
@@ -105,5 +112,13 @@
         &lt;Property name=&quot;text&quot; type=&quot;java.lang.String&quot; value=&quot;Please make sure you have the latest version of this program&quot;/&gt;
       &lt;/Properties&gt;
     &lt;/Component&gt;
+    &lt;Component class=&quot;javax.swing.JButton&quot; name=&quot;jButton1&quot;&gt;
+      &lt;Properties&gt;
+        &lt;Property name=&quot;text&quot; type=&quot;java.lang.String&quot; value=&quot;Open the Trac Bug Report Page&quot;/&gt;
+      &lt;/Properties&gt;
+      &lt;Events&gt;
+        &lt;EventHandler event=&quot;actionPerformed&quot; listener=&quot;java.awt.event.ActionListener&quot; parameters=&quot;java.awt.event.ActionEvent&quot; handler=&quot;jButton1ActionPerformed&quot;/&gt;
+      &lt;/Events&gt;
+    &lt;/Component&gt;
   &lt;/SubComponents&gt;
 &lt;/Form&gt;

Modified: trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/CErrorWindow.java
===================================================================
--- trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/CErrorWindow.java	2008-09-28 23:01:48 UTC (rev 6479)
+++ trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/CErrorWindow.java	2008-09-29 11:28:38 UTC (rev 6480)
@@ -3,7 +3,6 @@
  *
  * Created on 03 February 2008, 22:55
  */
-
 package org.darkstars.battlehub.framework;
 
 import java.awt.datatransfer.Clipboard;
@@ -17,29 +16,31 @@
  * @author  tarendai-std
  */
 public class CErrorWindow extends javax.swing.JFrame implements ClipboardOwner {
+
     Throwable e;
     String msg;
+    public static String username = null;
+
     /** Creates new form CErrorWindow
      * @param e 
      */
     public CErrorWindow(Throwable e) {
         this.e = e;
-        msg = e.toString()+&quot;\n&quot;;
-        msg += e.getLocalizedMessage()+&quot;\n&quot;;
-        for(StackTraceElement se : e.getStackTrace()){
-            msg += &quot;\t&quot;+se.toString()+&quot;\n&quot;;
+        msg = e.toString() + &quot;\n&quot;;
+        msg += e.getLocalizedMessage() + &quot;\n&quot;;
+        for (StackTraceElement se : e.getStackTrace()) {
+            msg += &quot;\t&quot; + se.toString() + &quot;\n&quot;;
         }
-        Runnable doWorkRunnable = new Runnable() {
+        SwingUtilities.invokeLater(new Runnable() {
 
             @Override
-                    public void run() {
-                        initComponents();
-                        setVisible(true);
-                    }
-        };
-        SwingUtilities.invokeLater(doWorkRunnable);
+            public void run() {
+                initComponents();
+                setVisible(true);
+            }
+        });
     }
-    
+
     /** This method is called from within the constructor to
      * initialize the form.
      * WARNING: Do NOT modify this code. The content of this method is
@@ -54,6 +55,7 @@
         noticeLabel = new javax.swing.JLabel();
         copyButton = new javax.swing.JButton();
         jLabel2 = new javax.swing.JLabel();
+        jButton1 = new javax.swing.JButton();
 
         setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
         setTitle(&quot;UnCaught Exception&quot;);
@@ -78,6 +80,13 @@
         jLabel2.setFont(jLabel2.getFont().deriveFont(jLabel2.getFont().getStyle() | java.awt.Font.BOLD, jLabel2.getFont().getSize()+1));
         jLabel2.setText(&quot;Please make sure you have the latest version of this program&quot;);
 
+        jButton1.setText(&quot;Open the Trac Bug Report Page&quot;);
+        jButton1.addActionListener(new java.awt.event.ActionListener() {
+            public void actionPerformed(java.awt.event.ActionEvent evt) {
+                jButton1ActionPerformed(evt);
+            }
+        });
+
         javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
         getContentPane().setLayout(layout);
         layout.setHorizontalGroup(
@@ -89,7 +98,10 @@
                     .addComponent(jLabel2)
                     .addComponent(noticeLabel, javax.swing.GroupLayout.DEFAULT_SIZE, 631, Short.MAX_VALUE)
                     .addComponent(jLabel1, javax.swing.GroupLayout.DEFAULT_SIZE, 631, Short.MAX_VALUE)
-                    .addComponent(copyButton))
+                    .addGroup(layout.createSequentialGroup()
+                        .addComponent(copyButton)
+                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
+                        .addComponent(jButton1)))
                 .addContainerGap())
         );
         layout.setVerticalGroup(
@@ -104,7 +116,9 @@
                 .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                 .addComponent(jScrollPane1, javax.swing.GroupLayout.DEFAULT_SIZE, 248, Short.MAX_VALUE)
                 .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
-                .addComponent(copyButton)
+                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
+                    .addComponent(copyButton)
+                    .addComponent(jButton1))
                 .addGap(11, 11, 11))
         );
 
@@ -112,12 +126,22 @@
     }// &lt;/editor-fold&gt;//GEN-END:initComponents
 
     private void copyButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_copyButtonActionPerformed
-        Clipboard clipboard = getToolkit ().getSystemClipboard ();
-        String errorText = errorTextPane.getText ();
-        
-        StringSelection fieldContent = new StringSelection (errorText);
-        clipboard.setContents (fieldContent, this);
+        Clipboard clipboard = getToolkit().getSystemClipboard();
+        String errorText = errorTextPane.getText();
+
+        StringSelection fieldContent = new StringSelection(errorText);
+        clipboard.setContents(fieldContent, this);
     }//GEN-LAST:event_copyButtonActionPerformed
+
+private void jButton1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton1ActionPerformed
+    String url = &quot;<A HREF="http://battlehub.darkstars.co.uk/trac/newticket?type=defect">http://battlehub.darkstars.co.uk/trac/newticket?type=defect</A>&quot;;
+    if(username != null){
+        if(username.trim().equals(&quot;&quot;)==false){
+            url += &quot;&amp;reporter=&quot;+username.trim();
+        }
+    }
+    BrowserLauncher.openURL(url);
+}//GEN-LAST:event_jButton1ActionPerformed
     
     /**
      * @param args the command line arguments
@@ -133,6 +157,7 @@
     // Variables declaration - do not modify//GEN-BEGIN:variables
     private javax.swing.JButton copyButton;
     private javax.swing.JTextPane errorTextPane;
+    private javax.swing.JButton jButton1;
     private javax.swing.JLabel jLabel1;
     private javax.swing.JLabel jLabel2;
     private javax.swing.JScrollPane jScrollPane1;

Modified: trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/CEvent.java
===================================================================
--- trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/CEvent.java	2008-09-28 23:01:48 UTC (rev 6479)
+++ trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/CEvent.java	2008-09-29 11:28:38 UTC (rev 6480)
@@ -33,9 +33,6 @@
     
     @Deprecated public final static String TOGGLERAWTRAFFIC =&quot;TOGGLETRAFFIC&quot;;
     
-    @Deprecated public final static String TIMER =&quot;TIMER&quot;;
-    
-    
     @Deprecated public final static String NEWUSRADDED = &quot;NEWUSRADDED&quot;;
     
     
@@ -57,19 +54,75 @@
     
     
     public String[] data;
+    public String dataLine;
     public String parameters=&quot;&quot;;
     public Object object;
+    private boolean valid = true;
+    private boolean consumable = false;
     
+    private IModule source = null;
+    
+    private int messageChannel = 0;
+    
     /**
-     * Creates a new instance of CEvent
+     * Creates a new instance of CEvent. A default value of 0 is used for the
+     * missing messageChannel parameters, and the event is also set of
+     * non-consumable by default.
      *
-     * @param s 
+     * @param s a message or line of server traffic
      */
     public CEvent (final String s) {
+        Init(s,false,0);
+    }
+    
+    /**
+     * Creates a new instance of CEvent. A default value of 0 is used for the
+     * missing messageChannel parameters
+     * 
+     * @param s a message or line of server traffic
+     * @param isConsumable a boolean signifying if this message or event can be
+     * 'consumed' preventing further distribution
+     */
+    public CEvent (final String s, final boolean isConsumable) {
+        Init(s,isConsumable,0);
+    }
+    
+    /**
+     * 
+     * @param s a message or line of server traffic
+     * @param isConsumable a boolean signifying if this message or event can be
+     * 'consumed' preventing further distribution
+     * @param messageChannel an integer representing the 'channel' this message 
+     * will be sent along, only objects implementing IModule that listen to that
+     * channel will recieve this message.
+     */
+    public CEvent (final String s, final boolean isConsumable, int messageChannel) {
+        Init(s,isConsumable,messageChannel);
+    }
+    
+    /**
+     * Initializes this object. Should be called from one of the CEvent
+     * constructors. This is basically a helper method to prevent code
+     * replication in the constructors.
+     * 
+     * @param s a line of data, usually a message or piece of server traffic
+     * @param isConsumable a boolean signifying if this message or event can be
+     * 'consumed' preventing further distribution
+     * @param messageChannel an integer representing the 'channel' this message 
+     * will be sent along, only objects implementing IModule that listen to that
+     * channel will recieve this message.
+     */
+    public void Init(final String s, final boolean isConsumable, final int messageChannel){
+        //
+        this.messageChannel = messageChannel;
+        dataLine = s;
+        consumable = isConsumable;
         data = s.split (&quot; &quot;);
         
         if(data.length &gt;1){
             parameters = s.substring(data[0].length()+1);
+        } else{
+            parameters = s;
         }
     }
     
@@ -86,4 +139,116 @@
         return s.equalsIgnoreCase (data[0]);
     }
     
+    /**
+     * 
+     * @return
+     */
+    public boolean IsValid(){
+        return valid;
+    }
+    
+    /**
+     * 
+     */
+    public void InValidate(){
+        valid = false;
+    }
+    
+    /**
+     * 
+     * @return
+     */
+    public boolean IsConsumable(){
+        return consumable;
+    }
+    
+    /**
+     * Consumes this event or message, preventing further distribution. This
+     * call is pretty much the same as InValidate and only exists in order to
+     * make code clearer.
+     * 
+     * I would expect the hotspot compiler to optimize this
+     * method out after an initial call.
+     * 
+     * @see CEvent.InValidate()
+     */
+    public void Consume(){
+        //
+        InValidate();
+    }
+    
+    /**
+     * 
+     * @param m
+     */
+    public void SetSource(IModule m){
+        //
+        source = m;
+    }
+    
+    /**
+     * 
+     * @return
+     */
+    public IModule GetSource(){
+        //
+        return source;
+    }
+    
+    /**
+     * Retrieves the whole string component of this message as a single string 
+     * value. This does not serialize the whole object into a string, and if
+     * this message does not contain a string value then no string will be
+     * returned.
+     * 
+     * The intended use of this method is for when further parsing of a line of
+     * traffic from the server is needed, such as when tab delimeters are used.
+     * 
+     * @return A string containing the original string data value passed 
+     * unparsed
+     */
+    public String GetDataLine(){
+        return dataLine;
+    }
+    
+    /**
+     * Retrieves a data field from the data string at the given index. This
+     * method however does nto check if the given index is out of bounds or not,
+     * so please do a check on the FieldCount method in order to handle this 
+     * correctly and safely.
+     * 
+     * @param index The index of the requested data object
+     * @return The data at the requested index
+     * 
+     * @see FieldCount()
+     */
+    public String GetData(int index){
+        //
+        return data[index];
+    }
+    
+    /**
+     * Retrieves the number of fields in this message. This includes all the
+     * parameters and the initial command value
+     * 
+     * @return an integer signifying the number of data fields
+     */
+    public int FieldCount(){
+        //
+        return data.length;
+    }
+    
+    /**
+     * This event will only be recieved by objects implementing the IModule 
+     * #interface that register to listen for channels indicated by an integer 
+     * value. This method returns the channel this message ro event is intended
+     * for.
+     * 
+     * @return The message channel this event/message is intended for
+     */
+    public int GetMessageChannel(){
+        //
+        return messageChannel;
+    }
+    
 }

Modified: trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/CEventTypes.java
===================================================================
--- trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/CEventTypes.java	2008-09-28 23:01:48 UTC (rev 6479)
+++ trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/CEventTypes.java	2008-09-29 11:28:38 UTC (rev 6480)
@@ -26,7 +26,7 @@
     
     public final static String TOGGLERAWTRAFFIC =&quot;TOGGLETRAFFIC&quot;;
     
-    public final static String TIMER =&quot;TIMER&quot;;
+    //public final static String TIMER =&quot;TIMER&quot;;
     
     
     public final static String NEWUSRADDED = &quot;NEWUSRADDED&quot;;

Modified: trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/CPlayer.java
===================================================================
--- trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/CPlayer.java	2008-09-28 23:01:48 UTC (rev 6479)
+++ trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/CPlayer.java	2008-09-29 11:28:38 UTC (rev 6480)
@@ -9,12 +9,11 @@
 
 package org.darkstars.battlehub.framework;
 
-
 /**
  *
  * @author AF
  */
-public class CPlayer {
+public class CPlayer implements IModule{
 
     //extends Thread
     public  String  name;
@@ -45,30 +44,30 @@
         return statString;
     }
 
-    public String GetRankHTML() {
-        return &quot;&lt;img src = \&quot;file:/&quot;+ Misc.GetAbsoluteLobbyFolderPath() + &quot;images/ranks_small/&quot; + rank + &quot;.png\&quot;&gt;&lt;/img&gt;&quot;;
+    public String GetRankHTML(ICentralClass c) {
+        return &quot;&lt;img src = \&quot;file:/&quot;+ c.GetAbsoluteLobbyFolderPath() + &quot;images/ranks_small/&quot; + rank + &quot;.png\&quot;&gt;&lt;/img&gt;&quot;;
     }
 
-    public String GetSmallRankHTML() {
-        return &quot;&lt;img src = \&quot;file:/&quot;+ Misc.GetAbsoluteLobbyFolderPath() + &quot;images/ranks_small/&quot; + rank + &quot;.png\&quot;&gt;&lt;/img&gt;&quot;;
+    public String GetSmallRankHTML(ICentralClass c) {
+        return &quot;&lt;img src = \&quot;file:/&quot;+ c.GetAbsoluteLobbyFolderPath() + &quot;images/ranks_small/&quot; + rank + &quot;.png\&quot;&gt;&lt;/img&gt;&quot;;
     }
 
-    public String GetNormalRankHTML() {
-        return &quot;&lt;img src = \&quot;file:/&quot;+ Misc.GetAbsoluteLobbyFolderPath() + &quot;images/ranks/&quot; + rank + &quot;.png\&quot;&gt;&lt;/img&gt;&quot;;
+    public String GetNormalRankHTML(ICentralClass c) {
+        return &quot;&lt;img src = \&quot;file:/&quot;+ c.GetAbsoluteLobbyFolderPath() + &quot;images/ranks/&quot; + rank + &quot;.png\&quot;&gt;&lt;/img&gt;&quot;;
     }
 
-    public String GetFlagHTML() {
-        return &quot;&lt;img src = \&quot;file:/&quot;+ Misc.GetAbsoluteLobbyFolderPath() + &quot;images/flags/&quot; + getCountry() + &quot;.png\&quot;&gt;&lt;/img&gt;&quot;;
+    public String GetFlagHTML(ICentralClass c) {
+        return &quot;&lt;img src = \&quot;file:/&quot;+ c.GetAbsoluteLobbyFolderPath() + &quot;images/flags/&quot; + getCountry() + &quot;.png\&quot;&gt;&lt;/img&gt;&quot;;
 //        return &quot;&lt;img src=\&quot;\&quot;&gt;&lt;/img&gt;&quot;;
     }
 
-    public String GetSmallFlagHTML() {
-        return &quot;&lt;img src = \&quot;file:/&quot;+ Misc.GetAbsoluteLobbyFolderPath() + &quot;images/flags/&quot; + getCountry() + &quot;.png\&quot;&gt;&lt;/img&gt;&quot;;
+    public String GetSmallFlagHTML(ICentralClass c) {
+        return &quot;&lt;img src = \&quot;file:/&quot;+ c.GetAbsoluteLobbyFolderPath() + &quot;images/flags/&quot; + getCountry() + &quot;.png\&quot;&gt;&lt;/img&gt;&quot;;
 //        return &quot;&lt;img src=\&quot;\&quot;&gt;&lt;/img&gt;&quot;;
     }
 
-    public String GetNormalFlagHTML() {
-        return &quot;&lt;img src = \&quot;file:/&quot;+ Misc.GetAbsoluteLobbyFolderPath() + &quot;images/flags/&quot; + getCountry() + &quot;.png\&quot;&gt;&lt;/img&gt;&quot;;
+    public String GetNormalFlagHTML(ICentralClass c) {
+        return &quot;&lt;img src = \&quot;file:/&quot;+ c.GetAbsoluteLobbyFolderPath() + &quot;images/flags/&quot; + getCountry() + &quot;.png\&quot;&gt;&lt;/img&gt;&quot;;
 //        return &quot;&lt;img src=\&quot;\&quot;&gt;&lt;/img&gt;&quot;;
     }
 
@@ -79,12 +78,12 @@
     
     public void NewEvent(final CEvent e) {
         //privmsg.NewEvent(e);
-        if (e.data[0].equalsIgnoreCase(&quot;CLIENTSTATUS&quot;)) {
+        if (e.IsEvent(&quot;CLIENTSTATUS&quot;)) {
             if (e.data[1].equalsIgnoreCase(name)) {
                 setStatus(Integer.parseInt(e.data[2]));
                 
             }
-        } else if (e.data[0].equalsIgnoreCase(&quot;CLIENTIPPORT&quot;)) {
+        } else if (e.IsEvent(&quot;CLIENTIPPORT&quot;)) {
             //  * CLIENTIPPORT username ip port
             setIp(e.data[2]);
         }
@@ -138,4 +137,20 @@
             statString = &quot;Ingame&quot;;
         }
     }
+
+    public void Init(ICentralClass L) {
+        //throw new UnsupportedOperationException(&quot;Not supported yet.&quot;);
+    }
+
+    public void OnRemove() {
+        //throw new UnsupportedOperationException(&quot;Not supported yet.&quot;);
+    }
+
+    public void OnEvent(CEvent e) {
+        throw new UnsupportedOperationException(&quot;Not supported yet.&quot;);
+    }
+
+    public void OnRemove(int channel) {
+        throw new UnsupportedOperationException(&quot;Not supported yet.&quot;);
+    }
 }

Added: trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/CUnZipper.java
===================================================================
--- trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/CUnZipper.java	                        (rev 0)
+++ trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/CUnZipper.java	2008-09-29 11:28:38 UTC (rev 6480)
@@ -0,0 +1,171 @@
+/*
+ * To change this template, choose Tools | Templates
+ * and open the template in the editor.
+ */
+
+package org.darkstars.battlehub.framework;
+
+import java.io.File;
+import java.io.FileNotFoundException;
+import java.io.FileOutputStream;
+import java.io.IOException;
+import java.io.InputStream;
+import java.io.OutputStream;
+import java.util.Enumeration;
+import java.util.logging.Level;
+import java.util.logging.Logger;
+import java.util.zip.ZipEntry;
+import java.util.zip.ZipFile;
+
+/**
+ *
+ * Based on code from here:
+ * <A HREF="http://www.java-tips.org/java-se-tips/java.util.zip/how-to-extract-file-files-from-a-zip-file-3.html">http://www.java-tips.org/java-se-tips/java.util.zip/how-to-extract-file-files-from-a-zip-file-3.html</A>
+ * @author AF-Standard
+ */
+public class CUnZipper {
+//    public static void GetZipFiles(String filename, String destination){
+//        
+//        
+//        GetZipFiles(new File(filename),destination);
+//    }
+    
+    public static void unzipArchive(File archive, File outputDir) {
+        try {
+            ZipFile zipfile = new ZipFile(archive);
+            for (Enumeration e = zipfile.entries(); e.hasMoreElements(); ) {
+                ZipEntry entry = (ZipEntry) e.nextElement();
+                unzipEntry(zipfile, entry, outputDir);
+            }
+        } catch (Exception e) {
+            CErrorWindow ew = new CErrorWindow(e);
+            //log.error(&quot;Error while extracting file &quot; + archive, e);
+        }
+    }
+
+    private static void unzipEntry(ZipFile zipfile, ZipEntry entry, File outputDir) throws IOException {
+
+        if (entry.isDirectory()) {
+            createDir(new File(outputDir, entry.getName()));
+            return;
+        }
+
+        File outputFile = new File(outputDir, entry.getName());
+        if (!outputFile.getParentFile().exists()){
+            createDir(outputFile.getParentFile());
+        }
+
+        //log.debug(&quot;Extracting: &quot; + entry);
+//        BufferedInputStream inputStream = new BufferedInputStream(zipfile.getInputStream(entry));
+//        BufferedOutputStream outputStream = new BufferedOutputStream(new FileOutputStream(outputFile));
+
+        try {
+            copy(zipfile.getInputStream(entry),outputFile);
+            //IOUtils.copy(inputStreamzipfile.getInputStream(entry), outputStream);
+        } catch(Exception e){
+            CErrorWindow ew = new CErrorWindow(e);
+        }finally {
+        
+//            outputStream.close();
+//            inputStream.close();
+        }
+    }
+
+    // Copies src file to dst file.
+    // If the dst file does not exist, it is created
+    static void copy(InputStream in, File dst){// throws IOException {
+        // throws IOException {
+//        if(!dst.canWrite()){
+//            //
+//            CErrorWindow ew = new CErrorWindow(new RuntimeException(&quot;Error target file cannot be written to CanWrite() returned false&quot;));
+//        }
+        OutputStream out = null;
+        try {
+            out = new FileOutputStream(dst);
+
+            // Transfer bytes from in to out
+            byte[] buf = new byte[1024];
+            int len;
+            while ((len = in.read(buf)) &gt; 0) {
+                out.write(buf, 0, len);
+            }
+            out.flush();
+            in.close();
+            out.close();
+        } catch (FileNotFoundException ex) {
+            Logger.getLogger(CUnZipper.class.getName()).log(Level.SEVERE, null, ex);
+            CErrorWindow ew = new CErrorWindow(ex);
+        } catch (IOException ex) {
+            CErrorWindow ew = new CErrorWindow(ex);
+            Logger.getLogger(CUnZipper.class.getName()).log(Level.SEVERE, null, ex);
+        } finally {
+            try {
+                out.close();
+            } catch (IOException ex) {
+                CErrorWindow ew = new CErrorWindow(ex);
+                Logger.getLogger(CUnZipper.class.getName()).log(Level.SEVERE, null, ex);
+            }
+        }
+        if(!dst.exists()){
+            //
+            CErrorWindow ew = new CErrorWindow(new RuntimeException(&quot;Error extracted file does not exist, verification failed&quot;));
+        }
+    }
+
+    private static void createDir(File dir) {
+        //log.debug(&quot;Creating dir &quot;+dir.getName());
+        if(!dir.mkdirs()) throw new RuntimeException(&quot;Can not create dir &quot;+dir);
+    }
+
+//    public static void GetZipFiles(File filename, String destination){
+//        try {
+//            
+//            ///////////////////////////////
+////            String destinationname = &quot;d:\\servlet\\testZip\\&quot;;
+//            byte[] buf = new byte[1024];
+//            ZipInputStream zipinputstream = null;
+//            ZipEntry zipentry;
+//            zipinputstream = new ZipInputStream(new FileInputStream(filename));
+//
+//            zipentry = zipinputstream.getNextEntry();
+//            while (zipentry != null){ 
+//                //for each entry to be extracted
+//                String entryName = zipentry.getName();
+//                System.out.println(&quot;entryname &quot;+entryName);
+//                
+//                File newFile = new File(entryName);
+//                String directory = newFile.getParent();
+//                
+//                if(directory == null){
+//                    if(newFile.isDirectory()){
+//                        break;
+//                    }
+//                }
+//                File of = new File(destination+entryName);
+//                if(of.exists()){
+//                    of.delete();
+//                }
+//                if(of.canWrite()){
+//                    FileOutputStream fileoutputstream = new FileOutputStream(of);
+//                    int n;
+//                    while ((n = zipinputstream.read(buf, 0, 1024)) &gt; -1){
+//                        fileoutputstream.write(buf, 0, n);
+//                    }
+//
+//                    fileoutputstream.close();
+//                } else{
+//                    //
+//                    JOptionPane.showMessageDialog(null, &quot;Error writting file: &quot;+destination+entryName);
+//                }
+//                zipinputstream.closeEntry();
+//                zipentry = zipinputstream.getNextEntry();
+//
+//            }//while
+//
+//            zipinputstream.close();
+//        }catch (Exception e){
+//            e.printStackTrace();
+//            CErrorWindow ew = new CErrorWindow(e);
+//        }
+//    }
+}

Modified: trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/ICentralClass.java
===================================================================
--- trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/ICentralClass.java	2008-09-28 23:01:48 UTC (rev 6479)
+++ trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/ICentralClass.java	2008-09-29 11:28:38 UTC (rev 6480)
@@ -16,4 +16,5 @@
     public CCore GetCore();
     public IProtocol GetProtocol();
     public void Shutdown();
+    public String GetAbsoluteLobbyFolderPath();
 }

Modified: trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/IModule.java
===================================================================
--- trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/IModule.java	2008-09-28 23:01:48 UTC (rev 6479)
+++ trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/IModule.java	2008-09-29 11:28:38 UTC (rev 6480)
@@ -17,9 +17,52 @@
  * @author Tom
  */
 public interface IModule extends EventListener {
+    
+    /**
+     * 
+     * @param L
+     */
     public void Init(ICentralClass L);
+    
+    /**
+     * 
+     */
     public void Update();
+    
+    /**
+     * 
+     * @param e
+     * 
+     * @see OnEvent(CEvent e)
+     */
+    @Deprecated
     public void NewEvent(final CEvent e);
+    
+    /**
+     * 
+     * @param e
+     */
+    @Deprecated
     public void NewGUIEvent(final CEvent e);
+    
+    /**
+     * This signifies that an event has been fired and this object has been
+     * registered to recieved this event or events of a similar nature.
+     * 
+     * @param e the event that has been fired
+     */
+    public void OnEvent(final CEvent e);
+    
+    /**
+     * Called when this object is removed from the messaging system
+     */
     public void OnRemove();
+    
+    /**
+     * Called when this object is removed from a message/event channel
+     * 
+     * @param channel the itneger representing the ID of that message/event 
+     * channel
+     */
+    public void OnRemove(int channel);
 }

Modified: trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/Misc.java
===================================================================
--- trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/Misc.java	2008-09-28 23:01:48 UTC (rev 6479)
+++ trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/Misc.java	2008-09-29 11:28:38 UTC (rev 6480)
@@ -8,12 +8,10 @@
  * To change this template, choose Tools | Template Manager
  * and open the template in the editor.
  */
-
 /**
  *
  * @author AF
  */
-
 import java.io.BufferedReader;
 import java.io.File;
 import java.io.IOException;
@@ -33,17 +31,16 @@
 import java.util.logging.Logger;
 import java.util.regex.Matcher;
 import java.util.regex.Pattern;
-import org.darkstars.battlehub.framework.CBase64Coder;
 
 public class Misc {
 
     public static final byte EOL = 13;
     private static String hex = &quot;0123456789ABCDEF&quot;;
-    
+
     public static String getOrdinalFor(int value) {
         int hundredRemainder = value % 100;
         int tenRemainder = value % 10;
-        if(hundredRemainder - tenRemainder == 10) {
+        if (hundredRemainder - tenRemainder == 10) {
             return &quot;th&quot;;
         }
 
@@ -60,8 +57,61 @@
     }
 
     public static String chat_string_create_urls(String input) {
+
+        String regex = &quot;\\b&quot; +
+                &quot;(&quot; +
+                &quot;    (www\\.)&quot; +
+                &quot;    |&quot; +
+                &quot;    (&quot; +
+                &quot;        (ftps?)&quot; +
+                &quot;        |&quot; +
+                &quot;        (file)&quot; +
+                &quot;        |&quot; +
+                &quot;        (svn)&quot; +
+                &quot;        |&quot; +
+                &quot;        (git)&quot; +
+                &quot;        |&quot; +
+                &quot;        (ssh)&quot; +
+                &quot;        |&quot; +
+                &quot;        (https?)&quot; +
+                &quot;    )://&quot; +
+                &quot;)&quot; +
+                &quot;([a-zA-Z0-9_\\-\\?=~&amp;\\+\\./%\\#]+)&quot;;
         
-        String strRegex = &quot;(@)?(href=\&quot;)?(<A HREF="http://">http://</A>)?[A-Za-z]+(\\.\\w+)+(/[&amp;\\n=?\\+\\%/\\.\\w]+)?&quot;;
+//        regex += &quot;{&quot;;
+//        regex += &quot;  \\\\b&quot; ;
+        // Match the leading part (<A HREF="proto://hostname,">proto://hostname,</A> or just hostname)
+//        regex += &quot;  (&quot; ;
+        // <A HREF="http://,">http://,</A> or <A HREF="https://">https://</A> leading part
+//        regex += &quot;    (https?)://[-\\w]+(\\.\\w[-\\w]*)+&quot; ;
+//        regex += &quot;  |&quot; ;
+        // or, try to find a hostname with more specific sub-expression
+//        regex += &quot;    (?i: [a-z0-9] (?:[-a-z0-9]*[a-z0-9])? \\\\. )+ &quot;;// sub domains
+        // Now ending .com, etc. For these, require lowercase
+//        regex += &quot;    (?-i: com\\b&quot; ;
+//        regex += &quot;        | edu\\b&quot; ;
+//        regex += &quot;        | biz\\b&quot; ;
+//        regex += &quot;        | gov\\b&quot; ;
+//        regex += &quot;        | in(?:t|fo)\\\\b &quot;;// .int or .info
+//        regex += &quot;        | mil\\b&quot; ;
+//        regex += &quot;        | net\\b&quot; ;
+//        regex += &quot;        | org\\b&quot; ;
+//        regex += &quot;        | [a-z][a-z]\\\\.[a-z][a-z]\\\\b &quot;;// two-letter country code
+        //regex += &quot;    )&quot; ;
+        //regex += &quot;  )&quot; ;
+        // Allow an optional port number
+        //regex += &quot;  ( : \\\\d+ )?&quot; ;
+        // The rest of the URL is optional, and begins with / 
+        //regex += &quot;  (&quot; ;
+        //regex += &quot;    /&quot; ;
+        // The rest are heuristics for what seems to work well
+        //regex += &quot;    [^.!,?;\&quot;\\\\'&lt;&gt;()\\[\\]\\{\\}\\s\\x7F-\\\\xFF]*&quot; ;
+        //regex += &quot;    (&quot; ;
+        //regex += &quot;      [.!,?]+ [^.!,?;&#8221;\\\\&#8217;&lt;&gt;()\\\\[\\\\]\\{\\\\}\\s\\\\x7F-\\\\xFF]+&quot; ;
+        //regex += &quot;    )*&quot; ;
+        //regex += &quot;  )?&quot; ;
+        //regex += &quot;}&quot;;//ix
+        //String strRegex = &quot;(@)?(href=\&quot;)?(<A HREF="http://">http://</A>)?[A-Za-z]+(\\.\\w+)+(/[&amp;\\n=?\\+\\%/\\.\\w]+)?&quot;;
 //                &quot;^(https?://)&quot;
 //        + &quot;?(([0-9a-z_!~*'().&amp;=+$%-]+: )?[0-9a-z_!~*'().&amp;=+$%-]+@)?&quot; //user@
 //        + &quot;(([0-9]{1,3}\\.){3}[0-9]{1,3}&quot; // IP- 199.194.52.184
@@ -72,14 +122,14 @@
 //        + &quot;(:[0-9]{1,4})?&quot; // port number- :80
 //        + &quot;((/?)|&quot; // a slash isn't required if there is no file name&lt;a href=&gt;&lt;/a&gt;
 //        + &quot;(/[0-9a-z_!~*'().;?:@&amp;=+$,%#-]+)+/?)$&quot;;
-        
-        Pattern re = Pattern.compile(strRegex/*&quot;&lt;a\\s+href=[^&gt;]+&gt;&quot;,Pattern.CASE_INSENSITIVE | Pattern.DOTALL*/);
+
+        Pattern re = Pattern.compile(regex, Pattern.CASE_INSENSITIVE | Pattern.COMMENTS);
         Matcher m = re.matcher(input);
         String result = m.replaceAll(&quot;&lt;a href=\\\&quot;$0\\\&quot;&gt;$0&lt;/a&gt;&quot;);
         //result = Misc.toHTML(result);
         return result;
 
-        //&quot;(http:|ftp:|teamspeak:|https:|ftps:|file|www\\.|ftp\\.|://)[a-z0-9/~_:#?&amp;=\\.-]*[a-z0-9/]&quot; jjjjjjjjjj
+    //&quot;(http:|ftp:|teamspeak:|https:|ftps:|file|www\\.|ftp\\.|://)[a-z0-9/~_:#?&amp;=\\.-]*[a-z0-9/]&quot; jjjjjjjjjj
 //return input.replaceAll (&quot;[^\&quot;]((http:|ftp:|teamspeak:|https:|ftps:|file|www\\.|ftp\\.|://)[a-z0-9/~_:#?&amp;=\\.-]*[a-z0-9/])[^\&quot;]&quot;,&quot;&lt;a href=\&quot;$1\&quot;&gt;$1&lt;/a&gt;&quot;).replaceAll (&quot;href=\&quot;www.&quot;,&quot;href=\&quot;<A HREF="http://www.">http://www.</A>&quot;);
 //        String t = input; //
 //        t.replaceAll(&quot;((http:|ftp:|teamspeak:|https:|ftps:|file:|www|ftp\\.|://)[a-zA-Z0-9%/~_:;#?&amp;=\\.-]*[a-zA-Z0-9%/])&quot;, &quot;&gt;$0&quot;);
@@ -207,11 +257,11 @@
             Enumeration e = NetworkInterface.getNetworkInterfaces();
 
             while (e.hasMoreElements()) {
-                NetworkInterface netface = (NetworkInterface) e.nextElement ();
+                NetworkInterface netface = (NetworkInterface) e.nextElement();
                 Enumeration e2 = netface.getInetAddresses();
 
                 while (e2.hasMoreElements()) {
-                    InetAddress ip = (InetAddress) e2.nextElement ();
+                    InetAddress ip = (InetAddress) e2.nextElement();
                     if (!ip.isLoopbackAddress() &amp;&amp; ip.getHostAddress().indexOf(&quot;:&quot;) == -1) {
                         return ip.getHostAddress();
                     }
@@ -316,16 +366,16 @@
             String inputLine;
 
             while ((inputLine = in.readLine()) != null) {
-                q += inputLine+&quot;\n&quot;;
+                q += inputLine + &quot;\n&quot;;
             }
             in.close();
             return q;
         } catch (MalformedURLException ex) {
             ex.printStackTrace();
             return defvalue;
-        } catch(UnknownHostException e){
+        } catch (UnknownHostException e) {
             return defvalue;
-        }catch (IOException ex) {
+        } catch (IOException ex) {
             ex.printStackTrace();
             return defvalue;
         }
@@ -507,81 +557,21 @@
         String javaVersion = System.getProperty(&quot;java.version&quot;);
         return javaVersion.startsWith(&quot;1.5&quot;);
     }
-
     public static boolean dev_environment = false;
-    /*public static String GetLobbyFolderPath() {
-    return &quot;lobby/aflobby/&quot;;
-    }*/
-    public static String GetAbsoluteLobbyFolderPath() {
-        if (!dev_environment) {
-            try {
-                // Get current classloader
-                Misc m = new Misc();
-                URL u = m.getClass().getProtectionDomain().getCodeSource().getLocation();
-                File f = new File(u.toURI());
-                String s = f.getParent().replaceAll(&quot;\\\\&quot;, &quot;/&quot;) + &quot;/lobby/battlehub/&quot;;
-                if (!isWindows()) {
-                    s = &quot;/&quot; + s;
-                }
-                s = s.replaceAll(&quot;%20&quot;, &quot; &quot;);
-                //System.out.println(f.getParent());
-                return s;
-            } catch (URISyntaxException ex) {
-                Logger.getLogger(Misc.class.getName()).log(Level.SEVERE, null, ex);
-            }
-            return null;
-        } else {
-            File f2 = new File(&quot;lobby/battlehub/&quot;);
-            try {
-                //pathSeparator = &quot;/&quot;;
-                //            try {
-                String s = f2.toURI().toURL().toString().substring(6);
-                if (isWindows() == false) {
-                    s = &quot;/&quot; + s;
-                }
-                s = s.replaceAll(&quot;%20&quot;, &quot; &quot;);
-                s = s.replaceAll(&quot;\\\\&quot;, &quot;/&quot;);
-                if (!isWindows()) {
-                    s = &quot;/&quot;+s;
-                }
 
-                //System.out.println(&quot;\&quot;&quot; + s + &quot;\&quot;&quot;);
-                return s;
-            } catch (MalformedURLException ex) {
-                ex.printStackTrace();
-            }
-            return &quot;&quot;;
-        }
-        /*
-        File f = new File(&quot;lobby/aflobby/&quot;);
-        try {
-        //pathSeparator = &quot;/&quot;;
-        //            try {
-        String s =  f.toURI().toURL().toString().substring(6).replaceAll(&quot;%20&quot;, &quot; &quot;);
-        if(isWindows()==false){
-        s = &quot;/&quot;+s;
-        }
-        if((s.endsWith(&quot;/&quot;)==false)&amp;&amp;(s.endsWith(&quot;\\&quot;)==false)){
-        s +=&quot;/&quot;;
-        }
-        return s;
-        } catch (MalformedURLException ex) {
-        ex.printStackTrace();
-        }
-        return &quot;&quot;;*/
-    }
+    
 
-    public static String GetMinimapPath() {
+    public static String GetMinimapPath(ICentralClass c) {
         //
-        return GetAbsoluteLobbyFolderPath() + &quot;minimaps/&quot;;
-        //return &quot;&quot;;
+        return c.GetAbsoluteLobbyFolderPath() + &quot;minimaps/&quot;;
+    //return &quot;&quot;;
     }
 
     public static int bitStringToInt(String bitString) {
         int intValue = 0;
         for (int i = 1; i &lt;= bitString.length(); i++) {
             int currBit = Integer.parseInt(bitString.substring(i - 1, i));
-            intValue += currBit * Math.pow(2d, (double) (i-1));
+            intValue += currBit * Math.pow(2d, (double) (i - 1));
         }
 
         return intValue;

Added: trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/downloader/CDownloadFile.form
===================================================================
--- trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/downloader/CDownloadFile.form	                        (rev 0)
+++ trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/downloader/CDownloadFile.form	2008-09-29 11:28:38 UTC (rev 6480)
@@ -0,0 +1,81 @@
+&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;
+
+&lt;Form version=&quot;1.3&quot; maxVersion=&quot;1.5&quot; type=&quot;org.netbeans.modules.form.forminfo.JFrameFormInfo&quot;&gt;
+  &lt;Properties&gt;
+    &lt;Property name=&quot;defaultCloseOperation&quot; type=&quot;int&quot; value=&quot;2&quot;/&gt;
+    &lt;Property name=&quot;title&quot; type=&quot;java.lang.String&quot; value=&quot;Downloading&quot;/&gt;
+    &lt;Property name=&quot;resizable&quot; type=&quot;boolean&quot; value=&quot;false&quot;/&gt;
+  &lt;/Properties&gt;
+  &lt;SyntheticProperties&gt;
+    &lt;SyntheticProperty name=&quot;formSizePolicy&quot; type=&quot;int&quot; value=&quot;1&quot;/&gt;
+  &lt;/SyntheticProperties&gt;
+  &lt;AuxValues&gt;
+    &lt;AuxValue name=&quot;FormSettings_autoResourcing&quot; type=&quot;java.lang.Integer&quot; value=&quot;0&quot;/&gt;
+    &lt;AuxValue name=&quot;FormSettings_autoSetComponentName&quot; type=&quot;java.lang.Boolean&quot; value=&quot;false&quot;/&gt;
+    &lt;AuxValue name=&quot;FormSettings_generateMnemonicsCode&quot; type=&quot;java.lang.Boolean&quot; value=&quot;false&quot;/&gt;
+    &lt;AuxValue name=&quot;FormSettings_i18nAutoMode&quot; type=&quot;java.lang.Boolean&quot; value=&quot;false&quot;/&gt;
+    &lt;AuxValue name=&quot;FormSettings_layoutCodeTarget&quot; type=&quot;java.lang.Integer&quot; value=&quot;1&quot;/&gt;
+    &lt;AuxValue name=&quot;FormSettings_listenerGenerationStyle&quot; type=&quot;java.lang.Integer&quot; value=&quot;0&quot;/&gt;
+    &lt;AuxValue name=&quot;FormSettings_variablesLocal&quot; type=&quot;java.lang.Boolean&quot; value=&quot;false&quot;/&gt;
+    &lt;AuxValue name=&quot;FormSettings_variablesModifier&quot; type=&quot;java.lang.Integer&quot; value=&quot;2&quot;/&gt;
+  &lt;/AuxValues&gt;
+
+  &lt;Layout&gt;
+    &lt;DimensionLayout dim=&quot;0&quot;&gt;
+      &lt;Group type=&quot;103&quot; groupAlignment=&quot;0&quot; attributes=&quot;0&quot;&gt;
+          &lt;Group type=&quot;102&quot; attributes=&quot;0&quot;&gt;
+              &lt;EmptySpace max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+              &lt;Group type=&quot;103&quot; groupAlignment=&quot;0&quot; attributes=&quot;0&quot;&gt;
+                  &lt;Component id=&quot;jLabel2&quot; alignment=&quot;0&quot; min=&quot;-2&quot; pref=&quot;232&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                  &lt;Component id=&quot;DLprogressbar&quot; alignment=&quot;0&quot; pref=&quot;511&quot; max=&quot;32767&quot; attributes=&quot;0&quot;/&gt;
+                  &lt;Component id=&quot;DLprogresslabel&quot; alignment=&quot;0&quot; min=&quot;-2&quot; pref=&quot;204&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+                  &lt;Component id=&quot;jLabel3&quot; alignment=&quot;0&quot; pref=&quot;511&quot; max=&quot;32767&quot; attributes=&quot;0&quot;/&gt;
+              &lt;/Group&gt;
+              &lt;EmptySpace max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+          &lt;/Group&gt;
+      &lt;/Group&gt;
+    &lt;/DimensionLayout&gt;
+    &lt;DimensionLayout dim=&quot;1&quot;&gt;
+      &lt;Group type=&quot;103&quot; groupAlignment=&quot;0&quot; attributes=&quot;0&quot;&gt;
+          &lt;Group type=&quot;102&quot; alignment=&quot;0&quot; attributes=&quot;0&quot;&gt;
+              &lt;EmptySpace max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+              &lt;Component id=&quot;jLabel2&quot; min=&quot;-2&quot; pref=&quot;40&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+              &lt;EmptySpace type=&quot;unrelated&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+              &lt;Component id=&quot;jLabel3&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+              &lt;EmptySpace min=&quot;-2&quot; pref=&quot;9&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+              &lt;Component id=&quot;DLprogressbar&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+              &lt;EmptySpace type=&quot;unrelated&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+              &lt;Component id=&quot;DLprogresslabel&quot; min=&quot;-2&quot; max=&quot;-2&quot; attributes=&quot;0&quot;/&gt;
+              &lt;EmptySpace pref=&quot;20&quot; max=&quot;32767&quot; attributes=&quot;0&quot;/&gt;
+          &lt;/Group&gt;
+      &lt;/Group&gt;
+    &lt;/DimensionLayout&gt;
+  &lt;/Layout&gt;
+  &lt;SubComponents&gt;
+    &lt;Component class=&quot;javax.swing.JProgressBar&quot; name=&quot;DLprogressbar&quot;&gt;
+      &lt;Properties&gt;
+        &lt;Property name=&quot;indeterminate&quot; type=&quot;boolean&quot; value=&quot;true&quot;/&gt;
+      &lt;/Properties&gt;
+    &lt;/Component&gt;
+    &lt;Component class=&quot;javax.swing.JLabel&quot; name=&quot;DLprogresslabel&quot;&gt;
+      &lt;Properties&gt;
+        &lt;Property name=&quot;text&quot; type=&quot;java.lang.String&quot; value=&quot;Downloading X of YMB at ZKBps&quot;/&gt;
+      &lt;/Properties&gt;
+    &lt;/Component&gt;
+    &lt;Component class=&quot;javax.swing.JLabel&quot; name=&quot;jLabel2&quot;&gt;
+      &lt;Properties&gt;
+        &lt;Property name=&quot;font&quot; type=&quot;java.awt.Font&quot; editor=&quot;org.netbeans.beaninfo.editors.FontEditor&quot;&gt;
+          &lt;Font name=&quot;Arial&quot; size=&quot;18&quot; style=&quot;1&quot;/&gt;
+        &lt;/Property&gt;
+        &lt;Property name=&quot;text&quot; type=&quot;java.lang.String&quot; value=&quot;Downloading&quot;/&gt;
+      &lt;/Properties&gt;
+    &lt;/Component&gt;
+    &lt;Component class=&quot;javax.swing.JLabel&quot; name=&quot;jLabel3&quot;&gt;
+      &lt;Properties&gt;
+        &lt;Property name=&quot;text&quot; type=&quot;java.lang.String&quot; editor=&quot;org.netbeans.modules.form.RADConnectionPropertyEditor&quot;&gt;
+          &lt;Connection code=&quot;&quot;from: &quot;+address&quot; type=&quot;code&quot;/&gt;
+        &lt;/Property&gt;
+      &lt;/Properties&gt;
+    &lt;/Component&gt;
+  &lt;/SubComponents&gt;
+&lt;/Form&gt;

Added: trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/downloader/CDownloadFile.java
===================================================================
--- trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/downloader/CDownloadFile.java	                        (rev 0)
+++ trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/downloader/CDownloadFile.java	2008-09-29 11:28:38 UTC (rev 6480)
@@ -0,0 +1,239 @@
+/*
+ * CDownloadFile.java
+ *
+ * Created on 14 September 2007, 06:04
+ */
+
+package org.darkstars.battlehub.framework.downloader;
+
+import java.io.BufferedOutputStream;
+import java.io.File;
+import java.io.FileOutputStream;
+import java.io.IOException;
+import java.io.InputStream;
+import java.io.OutputStream;
+import java.net.URL;
+import java.net.URLConnection;
+import java.util.List;
+import javax.swing.SwingUtilities;
+import javax.swing.SwingWorker;
+import javax.swing.event.EventListenerList;
+
+/**
+ *
+ * @author  AF-StandardUsr
+ */
+public class CDownloadFile extends javax.swing.JFrame {
+
+    private EventListenerList modules = new EventListenerList();
+    
+    private String address = &quot;&quot;;
+    private File targetFile;
+
+    /** Creates new form CDownloadFile */
+    public CDownloadFile(String address, String localFileName) {
+        Init(address,new File(localFileName));
+    }
+    
+    public CDownloadFile(String address, File localFile) {
+        
+        Init(address,localFile);
+        
+    }
+    
+    private void Init(String address, File localFile){
+        //
+        this.address = address;
+        this.targetFile = localFile;
+        
+        SwingUtilities.invokeLater( new Runnable() {
+
+            @Override
+            public void run() {
+                initComponents();
+                setVisible(false);
+            }
+        });
+    }
+
+    private static class CDLProgressData {
+
+        private final int percentage;
+        private final String progresslabel;
+
+        CDLProgressData(int percentage, String label) {
+            this.percentage = percentage;
+            this.progresslabel = label;
+        }
+    }
+
+    public void StartDownload() {
+        SwingUtilities.invokeLater( new Runnable() {
+
+            @Override
+            public void run() {
+                setVisible(true);
+            }
+        });
+        
+        SwingWorker worker = new SwingWorker&lt;Void, CDLProgressData&gt;() {
+
+            @Override
+            public Void doInBackground() {
+                OutputStream out = null;
+                URLConnection conn = null;
+                InputStream in = null;
+                try {
+                    URL url = new URL(address);
+                    out = new BufferedOutputStream(new FileOutputStream(targetFile));
+                    conn = url.openConnection();
+                    in = conn.getInputStream();
+                    byte[] buffer = new byte[1024];
+                    int numRead;
+                    long numWritten = 0;
+                    while ((numRead = in.read(buffer)) != -1) {
+                        out.write(buffer, 0, numRead);
+                        numWritten += numRead;
+                        int prog = -1;
+                        if(conn.getContentLength() != -1){
+                            prog = (int) numWritten/(conn.getContentLength()/100);
+                        }
+                        publish(new CDLProgressData(prog, &quot;&quot; + (numWritten/1024)+&quot;KB of &quot;+ (conn.getContentLength()/1024)+&quot;KB&quot;));
+                    }
+                    out.flush();
+                    FireDownloadFinishedEvent(targetFile);
+                    //System.out.println(targetfile + &quot;\t&quot; + numWritten);
+                } catch (Exception exception) {
+                    exception.printStackTrace();
+                } finally {
+                    try {
+                        if (in != null) {
+                            in.close();
+                        }
+                        if (out != null) {
+                            out.close();
+                        }
+                    } catch (IOException ioe) {
+                    } finally {
+                        //
+                        
+                    }
+                }
+                return null;
+            }
+
+            @Override
+            protected void process(List&lt;CDLProgressData&gt; pairs) {
+                CDLProgressData pair = pairs.get(pairs.size() - 1);
+                DLprogresslabel.setText(&quot;Downloading: &quot;+pair.progresslabel);
+                if(pair.percentage==-1){
+                    DLprogressbar.setIndeterminate(true);
+                }else{
+                    DLprogressbar.setIndeterminate(false);
+                    DLprogressbar.setValue(pair.percentage);
+                }
+                
+            }
+
+            @Override
+            public void done() {
+                //Remove the &quot;Loading images&quot; label.
+                DLprogresslabel.setText(&quot;download complete&quot;);
+            }
+        };
+        worker.execute();
+    }
+    
+    public void RegisterListener(IDownloaderListener i){
+        assert(i != null);
+        modules.add(IDownloaderListener.class, i);
+    }
+    
+    public void FireDownloadFinishedEvent(File f){
+        //
+        Object[] listeners = modules.getListenerList();
+        // loop through each listener and pass on the event if needed
+        int numListeners = listeners.length;
+        
+        for (int i = 0; i &lt; numListeners; i += 2) {
+            if (listeners[i] == IDownloaderListener.class) {
+                // pass the event to the listeners event dispatch method
+                ((IDownloaderListener)listeners[i+1]).DownloadFinished(f);
+            }
+        }
+        synchronized(this){
+            notifyAll();
+        }
+//        for (int i = 0; i &lt; numListeners; i++) {
+//            if(listeners[i] == null){
+//                continue;
+//            }
+//            //if (listeners[i].getClass() == IDownloaderListener.class) {
+//                // pass the event to the listeners event dispatch method
+//                
+//            //}
+//        }
+    }
+
+    /** This method is called from within the constructor to
+     * initialize the form.
+     * WARNING: Do NOT modify this code. The content of this method is
+     * always regenerated by the Form Editor.
+     */
+    // &lt;editor-fold defaultstate=&quot;collapsed&quot; desc=&quot;Generated Code&quot;&gt;//GEN-BEGIN:initComponents
+    private void initComponents() {
+
+        DLprogressbar = new javax.swing.JProgressBar();
+        DLprogresslabel = new javax.swing.JLabel();
+        jLabel2 = new javax.swing.JLabel();
+        jLabel3 = new javax.swing.JLabel();
+
+        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
+        setTitle(&quot;Downloading&quot;);
+        setResizable(false);
+
+        DLprogressbar.setIndeterminate(true);
+
+        DLprogresslabel.setText(&quot;Downloading X of YMB at ZKBps&quot;);
+
+        jLabel2.setFont(new java.awt.Font(&quot;Arial&quot;, 1, 18));
+        jLabel2.setText(&quot;Downloading&quot;);
+
+        jLabel3.setText(&quot;from: &quot;+address);
+
+        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
+        getContentPane().setLayout(layout);
+        layout.setHorizontalGroup(
+            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
+            .addGroup(layout.createSequentialGroup()
+                .addContainerGap()
+                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
+                    .addComponent(jLabel2, javax.swing.GroupLayout.PREFERRED_SIZE, 232, javax.swing.GroupLayout.PREFERRED_SIZE)
+                    .addComponent(DLprogressbar, javax.swing.GroupLayout.DEFAULT_SIZE, 511, Short.MAX_VALUE)
+                    .addComponent(DLprogresslabel, javax.swing.GroupLayout.PREFERRED_SIZE, 204, javax.swing.GroupLayout.PREFERRED_SIZE)
+                    .addComponent(jLabel3, javax.swing.GroupLayout.DEFAULT_SIZE, 511, Short.MAX_VALUE))
+                .addContainerGap())
+        );
+        layout.setVerticalGroup(
+            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
+            .addGroup(layout.createSequentialGroup()
+                .addContainerGap()
+                .addComponent(jLabel2, javax.swing.GroupLayout.PREFERRED_SIZE, 40, javax.swing.GroupLayout.PREFERRED_SIZE)
+                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
+                .addComponent(jLabel3)
+                .addGap(9, 9, 9)
+                .addComponent(DLprogressbar, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
+                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
+                .addComponent(DLprogresslabel)
+                .addContainerGap(20, Short.MAX_VALUE))
+        );
+
+        pack();
+    }// &lt;/editor-fold&gt;//GEN-END:initComponents
+    // Variables declaration - do not modify//GEN-BEGIN:variables
+    private javax.swing.JProgressBar DLprogressbar;
+    private javax.swing.JLabel DLprogresslabel;
+    private javax.swing.JLabel jLabel2;
+    private javax.swing.JLabel jLabel3;
+    // End of variables declaration//GEN-END:variables
+}
\ No newline at end of file

Added: trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/downloader/IDownloaderListener.java
===================================================================
--- trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/downloader/IDownloaderListener.java	                        (rev 0)
+++ trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/downloader/IDownloaderListener.java	2008-09-29 11:28:38 UTC (rev 6480)
@@ -0,0 +1,18 @@
+/*
+ * To change this template, choose Tools | Templates
+ * and open the template in the editor.
+ */
+
+package org.darkstars.battlehub.framework.downloader;
+
+import java.io.File;
+import java.util.EventListener;
+
+/**
+ *
+ * @author AF-Standard
+ */
+public interface IDownloaderListener extends EventListener {
+
+    public void DownloadFinished(File f);
+}

Modified: trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/protocol/tasserver/CBasicTASServerProtocol.java
===================================================================
--- trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/protocol/tasserver/CBasicTASServerProtocol.java	2008-09-28 23:01:48 UTC (rev 6479)
+++ trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/protocol/tasserver/CBasicTASServerProtocol.java	2008-09-29 11:28:38 UTC (rev 6480)
@@ -12,6 +12,7 @@
 import java.util.TreeMap;
 import org.darkstars.battlehub.framework.CBasicTASChannelModel;
 import org.darkstars.battlehub.framework.CConnection;
+import org.darkstars.battlehub.framework.CCore;
 import org.darkstars.battlehub.framework.CEvent;
 import org.darkstars.battlehub.framework.CEventTypes;
 import org.darkstars.battlehub.framework.CStringHelper;
@@ -134,13 +135,16 @@
     public void LeaveChannel(String channelname, String reason) {
         SendTraffic(&quot;LEAVE &quot; + channelname);
 
-        CEvent e = new CEvent(CEvent.CHANNELCLOSED + &quot; &quot; + channelname);
+        CEvent e = new CEvent(CEventTypes.CHANNELCLOSED + &quot; &quot; + channelname);
         L.GetCore().NewGUIEvent(e);
     }
 
     @Override
     public void SendTraffic(String s) {
         c.SendLine(s);
+        if(L.GetCore().HasChannelListeners(CCore.SENT_SERVER_TRAFFIC)){
+            L.GetCore().FireEvent(new CEvent(s,false,CCore.SENT_SERVER_TRAFFIC));
+        }
     }
 
     @Override
@@ -239,7 +243,7 @@
             return result;
         } catch (UnknownHostException e) {
             //LMain.Toasts.AddMessage(&quot;Error, unknown server: &quot; + e.getLocalizedMessage());
-            CEvent ev = new CEvent(CEvent.DISCONNECTUNKNOWNHOST);
+            CEvent ev = new CEvent(CEventTypes.DISCONNECTUNKNOWNHOST);
             L.GetCore().NewGUIEvent(ev);
         } catch (ConnectException e) {
             //LMain.Toasts.AddMessage(&quot;Error connecting: &quot; + e.getLocalizedMessage());
@@ -253,6 +257,14 @@
         return false;
     }
 
+    public void OnEvent(CEvent e) {
+        throw new UnsupportedOperationException(&quot;Not supported yet.&quot;);
+    }
 
+    public void OnRemove(int channel) {
+        throw new UnsupportedOperationException(&quot;Not supported yet.&quot;);
+    }
 
+
+
 }

Added: trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/spring/CAutoHostUDPInterface.java
===================================================================
--- trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/spring/CAutoHostUDPInterface.java	                        (rev 0)
+++ trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/spring/CAutoHostUDPInterface.java	2008-09-29 11:28:38 UTC (rev 6480)
@@ -0,0 +1,106 @@
+/*
+ * To change this template, choose Tools | Templates
+ * and open the template in the editor.
+ */
+package org.darkstars.battlehub.framework.spring;
+
+import java.net.DatagramPacket;
+import java.net.DatagramSocket;
+import java.net.SocketException;
+import java.util.logging.Level;
+import java.util.logging.Logger;
+import javax.swing.event.EventListenerList;
+
+/**
+ *
+ * @author AF-Standard
+ */
+public class CAutoHostUDPInterface implements Runnable {
+
+    private EventListenerList listeners = new EventListenerList();
+    int port;
+    DatagramSocket dsocket;
+    DatagramPacket packet;
+    byte[] buffer;
+    boolean valid = false;
+    Thread T;
+
+    public CAutoHostUDPInterface(int port) {
+        try {
+            //
+            this.port = port;
+
+            // Create a socket to listen on the port.
+            dsocket = new DatagramSocket(port);
+
+            // Create a buffer to read datagrams into. If a
+            // packet is larger than this buffer, the
+            // excess will simply be discarded!
+            buffer = new byte[2048];
+
+            // Create a packet to receive data into the buffer
+            packet = new DatagramPacket(buffer, buffer.length);
+            
+            T = new Thread(this);
+            valid = true;
+        } catch (SocketException ex) {
+            Logger.getLogger(CAutoHostUDPInterface.class.getName()).log(Level.SEVERE, null, ex);
+        }
+    }
+
+    public void start(){
+        T.start();
+    }
+    
+    public void stop(){
+        T.interrupt();
+    }
+    
+    @Override
+    public void run() {
+        //
+        if (!valid) {
+            return;
+        }
+        try {
+
+            // Now loop forever, waiting to receive packets and printing them.
+            while (true) {
+                // Wait to receive a datagram
+                dsocket.receive(packet);
+
+                // Convert the contents to a string, and display them
+                String msg = new String(buffer, 0, packet.getLength());
+                fireEvent(packet.getAddress().getHostName() + &quot;: &quot; + msg);
+
+                // Reset the length of the packet before reusing it.
+                packet.setLength(buffer.length);
+            }
+        } catch (Exception e) {
+            System.err.println(e);
+        }
+    }
+
+    public synchronized void registerAnyEventListener(IAutoHostUDPListener i) {
+        //
+        listeners.add(IAutoHostUDPListener.class, i);
+    }
+    
+    public synchronized void unregisterAnyEventListener(IAutoHostUDPListener i) {
+        //
+        listeners.remove(IAutoHostUDPListener.class, i);
+    }
+
+    private synchronized void fireEvent(final String e) {
+        Object[] listenersArray = listeners.getListenerList();
+        
+        // loop through each listener and pass on the event if needed
+        int numListeners = listenersArray.length;
+        for (int i = 0; i &lt; numListeners; i += 2) {
+            if (listenersArray[i] == IAutoHostUDPListener.class) {
+                // pass the event to the listeners event dispatch method
+                ((IAutoHostUDPListener) listenersArray[i + 1]).NewAutoHostUDPString(e);
+            }
+        }
+    }
+}

Added: trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/spring/CJNATest.java
===================================================================
--- trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/spring/CJNATest.java	                        (rev 0)
+++ trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/spring/CJNATest.java	2008-09-29 11:28:38 UTC (rev 6480)
@@ -0,0 +1,25 @@
+/*
+ * To change this template, choose Tools | Templates
+ * and open the template in the editor.
+ */
+
+package org.darkstars.battlehub.framework.spring;
+
+import com.sun.jna.Native;
+
+/**
+ *
+ * @author AF-Standard
+ */
+public class CJNATest {
+
+    public CJNATest(String lib){
+        //
+        IJNAUnitsync ius = null;
+        ius = (IJNAUnitsync) Native.loadLibrary(lib, IJNAUnitsync.class);
+        ius.Init(true, 0);
+//        ius.Message(&quot;boo&quot;);
+        ius.UnInit();
+        ius = null;
+    }
+}

Added: trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/spring/IAutoHostUDPListener.java
===================================================================
--- trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/spring/IAutoHostUDPListener.java	                        (rev 0)
+++ trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/spring/IAutoHostUDPListener.java	2008-09-29 11:28:38 UTC (rev 6480)
@@ -0,0 +1,16 @@
+/*
+ * To change this template, choose Tools | Templates
+ * and open the template in the editor.
+ */
+package org.darkstars.battlehub.framework.spring;
+
+import java.util.EventListener;
+
+/**
+ *
+ * @author AF-Standard
+ */
+public interface IAutoHostUDPListener extends EventListener {
+
+    public void NewAutoHostUDPString(String msg);
+}

Added: trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/spring/IJNAUnitsync.java
===================================================================
--- trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/spring/IJNAUnitsync.java	                        (rev 0)
+++ trunk/Lobby/BattleHubFramework/src/org/darkstars/battlehub/framework/spring/IJNAUnitsync.java	2008-09-29 11:28:38 UTC (rev 6480)
@@ -0,0 +1,168 @@
+/*
+ * To change this template, choose Tools | Templates
+ * and open the template in the editor.
+ */
+
+package org.darkstars.battlehub.framework.spring;
+
+import com.sun.jna.win32.StdCallLibrary;
+
+/*
+DLL_EXPORT int          __stdcall Init(bool isServer, int id);
+ DLL_EXPORT void         __stdcall UnInit();
+ DLL_EXPORT int          __stdcall ProcessUnits(void);
+DLL_EXPORT int          __stdcall ProcessUnitsNoChecksum(void);
+
+
+ */
+/**
+ *
+ * @author AF-Standard
+ */
+public interface IJNAUnitsync extends StdCallLibrary {
+//    String GetSpringVersion();
+//    void Message(String p_szMessage);
+    
+    int Init(boolean isServer, int id);
+    void UnInit();
+    
+//    int ProcessUnits();
+//    int ProcessUnitsNoChecksum();
+//    
+//    String GetCurrentList();
+//    void AddClient(int id, String unitList);
+//    void RemoveClient(int id);
+//    String GetClientDiff(int id);
+//    void InstallClientDiff(String diff);
+//    
+//    
+//    int GetUnitCount();
+//    String GetUnitName(int unit);
+//    String GetFullUnitName(int unit);
+//    
+//    
+//    int IsUnitDisabled(int unit);
+//    int IsUnitDisabledByClient(int unit, int clientId);
+//    
+//    
+//    int GetMapCount();
+//    
+//    
+//    
+//    int GetPrimaryModCount();
+//    
+//    
+//    
+//    int GetPrimaryModArchiveCount(int index);
+//    
+//    
+//    int GetSideCount();
+//    
+//    
+//    void CloseFileVFS(int handle);
+//    
+//    
+//    int FileSizeVFS(int handle);
+//    
+//    
+//    void CloseArchive(int archive);
+//    
+//    void CloseArchiveFile(int archive, int handle);
+//    int SizeArchiveFile(int archive, int handle);
+    
+}
+
+/*
+DLL_EXPORT 
+
+
+
+
+DLL_EXPORT 
+DLL_EXPORT void         __stdcall 
+DLL_EXPORT 
+DLL_EXPORT 
+DLL_EXPORT 
+DLL_EXPORT const char*  __stdcall 
+DLL_EXPORT const char*  __stdcall 
+DLL_EXPORT 
+DLL_EXPORT 
+DLL_EXPORT void         __stdcall AddArchive(const char* name);
+DLL_EXPORT void         __stdcall AddAllArchives(const char* root);
+DLL_EXPORT unsigned int __stdcall GetArchiveChecksum(const char* arname);
+DLL_EXPORT 
+DLL_EXPORT const char*  __stdcall GetMapName(int index);
+DLL_EXPORT int          __stdcall GetMapInfoEx(const char* name, MapInfo* outInfo, int version);
+DLL_EXPORT int          __stdcall GetMapInfo(const char* name, MapInfo* outInfo);
+DLL_EXPORT void*        __stdcall GetMinimap(const char* filename, int miplevel);
+DLL_EXPORT int          __stdcall GetMapArchiveCount(const char* mapName);
+DLL_EXPORT const char*  __stdcall GetMapArchiveName(int index);
+DLL_EXPORT unsigned int __stdcall GetMapChecksumFromName(const char* mapName);
+DLL_EXPORT unsigned int __stdcall GetMapChecksum(int index);
+DLL_EXPORT 
+DLL_EXPORT const char*  __stdcall GetPrimaryModName(int index);
+DLL_EXPORT const char*	__stdcall GetPrimaryModShortName(int index);
+DLL_EXPORT const char*	__stdcall GetPrimaryModGame(int index);
+DLL_EXPORT const char*	__stdcall GetPrimaryModShortGame(int index);
+DLL_EXPORT const char*	__stdcall GetPrimaryModVersion(int index);
+DLL_EXPORT const char*	__stdcall GetPrimaryModMutator(int index);
+DLL_EXPORT const char*	__stdcall GetPrimaryModDescription(int index);
+DLL_EXPORT const char*  __stdcall GetPrimaryModArchive(int index);
+DLL_EXPORT 
+DLL_EXPORT const char*  __stdcall GetPrimaryModArchiveList(int arnr);
+DLL_EXPORT int           GetPrimaryModIndex(const char* name);
+DLL_EXPORT unsigned int  GetPrimaryModChecksum(int index);
+DLL_EXPORT unsigned int  GetPrimaryModChecksumFromName(const char* name);
+DLL_EXPORT 
+DLL_EXPORT const char*   GetSideName(int side);
+DLL_EXPORT int           OpenFileVFS(const char* name);
+DLL_EXPORT 
+DLL_EXPORT void          ReadFileVFS(int handle, void* buf, int length);
+DLL_EXPORT 
+DLL_EXPORT int           InitFindVFS(const char* pattern);
+DLL_EXPORT int           FindFilesVFS(int handle, char* nameBuf, int size);
+DLL_EXPORT int           OpenArchive(const char* name);
+DLL_EXPORT 
+DLL_EXPORT int           FindFilesArchive(int archive, int cur, char* nameBuf, int* size);
+DLL_EXPORT int           OpenArchiveFile(int archive, const char* name);
+DLL_EXPORT int           ReadArchiveFile(int archive, int handle, void* buffer, int numBytes);
+DLL_EXPORT 
+
+// lua custom lobby settings
+DLL_EXPORT int          __stdcall GetMapOptionCount(const char* name);
+DLL_EXPORT int          __stdcall GetModOptionCount();
+
+DLL_EXPORT const char*  __stdcall GetOptionKey(int optIndex);
+DLL_EXPORT const char*  __stdcall GetOptionName(int optIndex);
+DLL_EXPORT const char*  __stdcall GetOptionDesc(int optIndex);
+DLL_EXPORT int          __stdcall GetOptionType(int optIndex);
+
+// Bool Options
+DLL_EXPORT int          __stdcall GetOptionBoolDef(int optIndex);
+
+// Number Options
+DLL_EXPORT float        __stdcall GetOptionNumberDef(int optIndex);
+DLL_EXPORT float        __stdcall GetOptionNumberMin(int optIndex);
+DLL_EXPORT float        __stdcall GetOptionNumberMax(int optIndex);
+DLL_EXPORT float        __stdcall GetOptionNumberStep(int optIndex);
+
+// String Options
+DLL_EXPORT const char*  __stdcall GetOptionStringDef(int optIndex);
+DLL_EXPORT int          __stdcall GetOptionStringMaxLen(int optIndex);
+
+// List Options
+DLL_EXPORT int          __stdcall GetOptionListCount(int optIndex);
+DLL_EXPORT const char*  __stdcall GetOptionListDef(int optIndex);
+DLL_EXPORT const char*  __stdcall GetOptionListItemKey(int optIndex, int itemIndex);
+DLL_EXPORT const char*  __stdcall GetOptionListItemName(int optIndex, int itemIndex);
+DLL_EXPORT const char*  __stdcall GetOptionListItemDesc(int optIndex, int itemIndex);
+
+// Spring settings callback
+
+DLL_EXPORT const char*	__stdcall GetSpringConfigString( const char* name, const char* defvalue );
+DLL_EXPORT int			__stdcall GetSpringConfigInt( const char* name, const int defvalue );
+DLL_EXPORT float		__stdcall GetSpringConfigFloat( const char* name, const float defvalue );
+DLL_EXPORT void			__stdcall SetSpringConfigString( const char* name, const char* value );
+DLL_EXPORT void			__stdcall SetSpringConfigInt( const char* name, const int value );
+DLL_EXPORT void			__stdcall SetSpringConfigFloat( const char* name, const float value );
+ */
\ No newline at end of file


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001249.html">[Taspring-linux-commit] r6479 - in branches/springie: . planetwars	planetwars/Springie planetwars/Springie/autohost	planetwars/Springie/doc planetwars/Springie/spring	planetwars/Springie/utils planetwars/libs
</A></li>
	<LI>Next message: <A HREF="001251.html">[Taspring-linux-commit] r6481 - trunk/rts/Sim/Path
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1250">[ date ]</a>
              <a href="thread.html#1250">[ thread ]</a>
              <a href="subject.html#1250">[ subject ]</a>
              <a href="author.html#1250">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
