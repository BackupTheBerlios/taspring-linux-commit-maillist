<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r6351 - trunk/Lobby/TASClient
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-September/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6351%20-%20trunk/Lobby/TASClient&In-Reply-To=%3C20080902191145.BB9C24A33%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001120.html">
   <LINK REL="Next"  HREF="001122.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r6351 - trunk/Lobby/TASClient</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6351%20-%20trunk/Lobby/TASClient&In-Reply-To=%3C20080902191145.BB9C24A33%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r6351 - trunk/Lobby/TASClient">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Tue Sep  2 21:11:45 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001120.html">[Taspring-linux-commit] r6350 - in trunk/tools/ArchiveMoverLinux: .	libmlsevenzip libmlsevenzip/libsevenzip	libmlsevenzip/libsevenzip/Archive	libmlsevenzip/libsevenzip/Archive/7z	libmlsevenzip/libsevenzip/LzmaLib libmlsevenzip/libsevenzip/LzmaUtil
</A></li>
        <LI>Next message: <A HREF="001122.html">[Taspring-linux-commit] r6352 - in trunk/rts: System lib/gml
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1121">[ date ]</a>
              <a href="thread.html#1121">[ thread ]</a>
              <a href="subject.html#1121">[ subject ]</a>
              <a href="author.html#1121">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: satirik
Date: 2008-09-02 21:11:44 +0200 (Tue, 02 Sep 2008)
New Revision: 6351

Added:
   trunk/Lobby/TASClient/MapSelectionFormUnit.dfm
   trunk/Lobby/TASClient/MapSelectionFormUnit.pas
Modified:
   trunk/Lobby/TASClient/BattleFormUnit.dfm
   trunk/Lobby/TASClient/BattleFormUnit.pas
   trunk/Lobby/TASClient/MainUnit.dfm
   trunk/Lobby/TASClient/MainUnit.pas
   trunk/Lobby/TASClient/MapListFormUnit.pas
   trunk/Lobby/TASClient/TASClient.dof
   trunk/Lobby/TASClient/TASClient.dpr
   trunk/Lobby/TASClient/TASClient.res
Log:
* map selection list improved

Modified: trunk/Lobby/TASClient/BattleFormUnit.dfm
===================================================================
--- trunk/Lobby/TASClient/BattleFormUnit.dfm	2008-09-02 15:36:04 UTC (rev 6350)
+++ trunk/Lobby/TASClient/BattleFormUnit.dfm	2008-09-02 19:11:44 UTC (rev 6351)
@@ -1,7 +1,7 @@
 object BattleForm: TBattleForm
-  Left = 168
-  Top = 122
-  Width = 787
+  Left = 684
+  Top = 169
+  Width = 783
   Height = 586
   Caption = 'Battle window'
   Color = clBtnFace
@@ -24,13 +24,13 @@
   object SpTBXTitleBar1: TSpTBXTitleBar
     Left = 0
     Top = 0
-    Width = 779
+    Width = 775
     Height = 559
     Caption = 'Battle window'
     object Splitter1: TSplitter
       Left = 4
       Top = 413
-      Width = 771
+      Width = 767
       Height = 3
       Cursor = crVSplit
       Align = alTop
@@ -40,7 +40,7 @@
     object Splitter2: TSplitter
       Left = 4
       Top = 305
-      Width = 771
+      Width = 767
       Height = 3
       Cursor = crVSplit
       Align = alTop
@@ -50,7 +50,7 @@
     object Panel3: TSpTBXPanel
       Left = 4
       Top = 514
-      Width = 771
+      Width = 767
       Height = 41
       Align = alBottom
       Color = clNone
@@ -59,7 +59,7 @@
       BorderType = pbrRaised
       TBXStyleBackground = True
       DesignSize = (
-        771
+        767
         41)
       object StartButton: TSpTBXButton
         Left = 104
@@ -153,7 +153,7 @@
         LinkFont.Style = [fsUnderline]
       end
       object LadderRulesButton: TSpTBXButton
-        Left = 685
+        Left = 681
         Top = 8
         Width = 75
         Height = 25
@@ -184,11 +184,19 @@
         LinkFont.Style = [fsUnderline]
         ThemeType = thtTBX
       end
+      object Button1: TButton
+        Left = 640
+        Top = 8
+        Width = 33
+        Height = 25
+        Caption = 'Button1'
+        TabOrder = 8
+      end
     end
     object Panel2: TPanel
       Left = 4
       Top = 416
-      Width = 771
+      Width = 767
       Height = 98
       Align = alClient
       TabOrder = 2
@@ -4064,12 +4072,12 @@
     object Panel1: TPanel
       Left = 4
       Top = 30
-      Width = 771
+      Width = 767
       Height = 275
       Align = alTop
       TabOrder = 3
       object Panel5: TPanel
-        Left = 351
+        Left = 347
         Top = 1
         Width = 419
         Height = 273
@@ -4083,14 +4091,13 @@
           Height = 273
           Align = alClient
           Color = clBtnFace
-          ActiveTabIndex = 0
+          ActiveTabIndex = 2
           TabAutofit = True
           ThemeType = tttNone
           OnActiveTabChange = SpTBXTabControl1ActiveTabChange
           HiddenItems = &lt;&gt;
           object GameOptionsTab: TSpTBXTabItem
             Caption = 'Game options'
-            Checked = True
             CustomWidth = 103
             CustomHeight = 30
             ThemeType = tttNone
@@ -4104,6 +4111,7 @@
           object MapTab: TSpTBXTabItem
             Caption = 'Map options'
             Wrapping = twWrap
+            Checked = True
             CustomWidth = 103
             ThemeType = tttNone
           end
@@ -4113,86 +4121,6 @@
             CustomWidth = 103
             ThemeType = tttNone
           end
-          object MapTabSheet: TSpTBXTabSheet
-            Left = 0
-            Top = 34
-            Width = 419
-            Height = 239
-            Caption = 'Map options'
-            ImageIndex = -1
-            DesignSize = (
-              419
-              239)
-            TabItem = 'MapTab'
-            object MapOptionsScrollBox: TTntScrollBox
-              Left = 8
-              Top = 48
-              Width = 402
-              Height = 189
-              VertScrollBar.Smooth = True
-              VertScrollBar.Tracking = True
-              Anchors = [akLeft, akTop, akRight, akBottom]
-              BiDiMode = bdLeftToRight
-              BorderStyle = bsNone
-              Color = clBtnFace
-              Ctl3D = False
-              ParentBiDiMode = False
-              ParentBackground = True
-              ParentColor = False
-              ParentCtl3D = False
-              TabOrder = 0
-            end
-            object panelMapOptionsDefault: TSpTBXPanel
-              Left = 8
-              Top = 4
-              Width = 402
-              Height = 41
-              Align = alCustom
-              TabOrder = 1
-              object btLoadDefaultMPO: TSpTBXButton
-                Left = 149
-                Top = 8
-                Width = 113
-                Height = 25
-                Caption = 'Load default'
-                TabOrder = 0
-                OnClick = btLoadDefaultMPOClick
-                LinkFont.Charset = DEFAULT_CHARSET
-                LinkFont.Color = clBlue
-                LinkFont.Height = -11
-                LinkFont.Name = 'MS Sans Serif'
-                LinkFont.Style = [fsUnderline]
-              end
-              object btSetAsDefaultMPO: TSpTBXButton
-                Left = 269
-                Top = 8
-                Width = 113
-                Height = 25
-                Caption = 'Set as default'
-                TabOrder = 1
-                OnClick = btSetAsDefaultMPOClick
-                LinkFont.Charset = DEFAULT_CHARSET
-                LinkFont.Color = clBlue
-                LinkFont.Height = -11
-                LinkFont.Name = 'MS Sans Serif'
-                LinkFont.Style = [fsUnderline]
-              end
-              object btLoadMapsDefaultMPO: TSpTBXButton
-                Left = 29
-                Top = 8
-                Width = 113
-                Height = 25
-                Caption = 'Load map'#39's default'
-                TabOrder = 2
-                OnClick = btLoadMapsDefaultMPOClick
-                LinkFont.Charset = DEFAULT_CHARSET
-                LinkFont.Color = clBlue
-                LinkFont.Height = -11
-                LinkFont.Name = 'MS Sans Serif'
-                LinkFont.Style = [fsUnderline]
-              end
-            end
-          end
           object SpTBXTabSheet1: TSpTBXTabSheet
             Left = 0
             Top = 34
@@ -4612,12 +4540,92 @@
               LinkFont.Style = [fsUnderline]
             end
           end
+          object MapTabSheet: TSpTBXTabSheet
+            Left = 0
+            Top = 34
+            Width = 419
+            Height = 239
+            Caption = 'Map options'
+            ImageIndex = -1
+            DesignSize = (
+              419
+              239)
+            TabItem = 'MapTab'
+            object MapOptionsScrollBox: TTntScrollBox
+              Left = 8
+              Top = 48
+              Width = 402
+              Height = 189
+              VertScrollBar.Smooth = True
+              VertScrollBar.Tracking = True
+              Anchors = [akLeft, akTop, akRight, akBottom]
+              BiDiMode = bdLeftToRight
+              BorderStyle = bsNone
+              Color = clBtnFace
+              Ctl3D = False
+              ParentBiDiMode = False
+              ParentBackground = True
+              ParentColor = False
+              ParentCtl3D = False
+              TabOrder = 0
+            end
+            object panelMapOptionsDefault: TSpTBXPanel
+              Left = 8
+              Top = 4
+              Width = 402
+              Height = 41
+              Align = alCustom
+              TabOrder = 1
+              object btLoadDefaultMPO: TSpTBXButton
+                Left = 149
+                Top = 8
+                Width = 113
+                Height = 25
+                Caption = 'Load default'
+                TabOrder = 0
+                OnClick = btLoadDefaultMPOClick
+                LinkFont.Charset = DEFAULT_CHARSET
+                LinkFont.Color = clBlue
+                LinkFont.Height = -11
+                LinkFont.Name = 'MS Sans Serif'
+                LinkFont.Style = [fsUnderline]
+              end
+              object btSetAsDefaultMPO: TSpTBXButton
+                Left = 269
+                Top = 8
+                Width = 113
+                Height = 25
+                Caption = 'Set as default'
+                TabOrder = 1
+                OnClick = btSetAsDefaultMPOClick
+                LinkFont.Charset = DEFAULT_CHARSET
+                LinkFont.Color = clBlue
+                LinkFont.Height = -11
+                LinkFont.Name = 'MS Sans Serif'
+                LinkFont.Style = [fsUnderline]
+              end
+              object btLoadMapsDefaultMPO: TSpTBXButton
+                Left = 29
+                Top = 8
+                Width = 113
+                Height = 25
+                Caption = 'Load map'#39's default'
+                TabOrder = 2
+                OnClick = btLoadMapsDefaultMPOClick
+                LinkFont.Charset = DEFAULT_CHARSET
+                LinkFont.Color = clBlue
+                LinkFont.Height = -11
+                LinkFont.Name = 'MS Sans Serif'
+                LinkFont.Style = [fsUnderline]
+              end
+            end
+          end
         end
       end
       object Panel6: TPanel
         Left = 1
         Top = 1
-        Width = 350
+        Width = 346
         Height = 273
         Align = alClient
         BevelOuter = bvNone
@@ -4626,7 +4634,7 @@
         object MapPanel: TSpTBXPanel
           Left = 0
           Top = 0
-          Width = 350
+          Width = 346
           Height = 273
           Align = alClient
           Color = clNone
@@ -4636,12 +4644,12 @@
           OnResize = MapPanelResize
           TBXStyleBackground = True
           DesignSize = (
-            350
+            346
             273)
           object Bevel2: TBevel
             Left = 0
             Top = 219
-            Width = 350
+            Width = 346
             Height = 46
             Anchors = [akLeft, akRight, akBottom]
             Shape = bsTopLine
@@ -4649,7 +4657,7 @@
           object MapImage: TImageEx
             Left = 5
             Top = 5
-            Width = 221
+            Width = 217
             Height = 216
             Cursor = crHandPoint
             Hint = 'No map'
@@ -4665,7 +4673,7 @@
           object MapDescLabel: TSpTBXLabel
             Left = 8
             Top = 224
-            Width = 334
+            Width = 330
             Height = 41
             Caption = 'MapDescLabel'
             Anchors = [akLeft, akRight, akBottom]
@@ -4681,7 +4689,7 @@
             LinkFont.Style = [fsUnderline]
           end
           object TidalStrengthLabel: TSpTBXLabel
-            Left = 237
+            Left = 233
             Top = 143
             Width = 76
             Height = 13
@@ -4694,7 +4702,7 @@
             LinkFont.Style = [fsUnderline]
           end
           object GravityLabel: TSpTBXLabel
-            Left = 237
+            Left = 233
             Top = 158
             Width = 45
             Height = 13
@@ -4707,7 +4715,7 @@
             LinkFont.Style = [fsUnderline]
           end
           object MaxMetalLabel: TSpTBXLabel
-            Left = 237
+            Left = 233
             Top = 173
             Width = 63
             Height = 13
@@ -4720,7 +4728,7 @@
             LinkFont.Style = [fsUnderline]
           end
           object ExtRadiusLabel: TSpTBXLabel
-            Left = 237
+            Left = 233
             Top = 188
             Width = 85
             Height = 13
@@ -4733,7 +4741,7 @@
             LinkFont.Style = [fsUnderline]
           end
           object WindLabel: TSpTBXLabel
-            Left = 237
+            Left = 233
             Top = 203
             Width = 86
             Height = 13
@@ -4746,7 +4754,7 @@
             LinkFont.Style = [fsUnderline]
           end
           object SpTBXPanel1: TSpTBXPanel
-            Left = 229
+            Left = 225
             Top = 4
             Width = 113
             Height = 122
@@ -4766,12 +4774,11 @@
             object MapsButton: TTBXButton
               Left = 8
               Top = 7
-              Width = 97
+              Width = 81
               Height = 17
               BorderSize = 2
               Caption = 'More maps ...'
-              DropDownCombo = True
-              DropDownMenu = MapsPopupMenu
+              SmartFocus = False
               TabOrder = 0
               OnClick = MapsButtonClick
             end
@@ -4815,9 +4822,22 @@
               TabOrder = 4
               OnClick = DownloadMapButtonClick
             end
+            object DropDownMapSelectionButton: TSpTBXButton
+              Left = 88
+              Top = 7
+              Width = 17
+              Height = 17
+              TabOrder = 5
+              DropDownMenu = MapsPopupMenu
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
           end
           object MapSizeLabel: TSpTBXLabel
-            Left = 237
+            Left = 233
             Top = 128
             Width = 54
             Height = 13
@@ -4835,17 +4855,17 @@
     object Panel4: TPanel
       Left = 4
       Top = 308
-      Width = 771
+      Width = 767
       Height = 105
       Align = alTop
       TabOrder = 4
       DesignSize = (
-        771
+        767
         105)
       object VDTBattleClients: TVirtualDrawTree
         Left = 8
         Top = 8
-        Width = 461
+        Width = 457
         Height = 89
         Anchors = [akLeft, akTop, akRight, akBottom]
         Font.Charset = DEFAULT_CHARSET
@@ -4932,7 +4952,7 @@
           end&gt;
       end
       object MyOptionsGroupBox: TSpTBXGroupBox
-        Left = 521
+        Left = 517
         Top = 5
         Width = 242
         Height = 92
@@ -5044,7 +5064,7 @@
         end
       end
       object lblTeamNbr: TSpTBXLabel
-        Left = 474
+        Left = 470
         Top = 8
         Width = 44
         Height = 13
@@ -5210,14 +5230,6 @@
     object SpTBXSeparatorItem9: TSpTBXSeparatorItem
     end
   end
-  object MapsPopupMenu: TSpTBXPopupMenu
-    Left = 184
-    Top = 48
-    object MapsPopupStringList: TSpTBXStringList
-      MaxVisibleItems = 20
-      OnClick = MapsPopupMenuItemClick
-    end
-  end
   object BalanceTeamsPopupMenu: TSpTBXPopupMenu
     Left = 492
     Top = 425
@@ -5391,4 +5403,12 @@
     object SpTBXSeparatorItem12: TSpTBXSeparatorItem
     end
   end
+  object MapsPopupMenu: TSpTBXFormPopupMenu
+    TrackButton = tbLeftButton
+    OnPopup = MapsPopupMenuPopup
+    BorderStyle = pbsSizeableRightBottom
+    PopupFocus = True
+    Left = 189
+    Top = 40
+  end
 end

Modified: trunk/Lobby/TASClient/BattleFormUnit.pas
===================================================================
--- trunk/Lobby/TASClient/BattleFormUnit.pas	2008-09-02 15:36:04 UTC (rev 6350)
+++ trunk/Lobby/TASClient/BattleFormUnit.pas	2008-09-02 19:11:44 UTC (rev 6351)
@@ -21,11 +21,11 @@
   JvTransparentButton, JvgSpeedButton, JvgShadow, JvgButton, JvExStdCtrls,
   JvXPCore, JvXPButtons, TBXToolPals, TB2Item, TBX, SpTBXItem, TBXDkPanels,
   SpTBXControls, TBXExtItems, TB2ExtItems, SpTBXEditors, SpTBXTabs, JvLED,
-  ImageEx, JvSticker, JvExExtCtrls, JvImage, JvShape, JvLabel, TBXLists,
+  ImageEx, JvSticker, JvExExtCtrls, JvImage, JvShape, JvLabel,
   SpTBXLists, ImgList, SpTBXjanTracker, SpTBXFormPopupMenu,IniFiles,
   HttpProt,MsMultiPartFormData, JvComponentBase, JvDSADialogs, Spin, Mask,
   JvExMask, JvSpin, TntStdCtrls, TntForms, TntComCtrls,RichEdit,JclUnicode,
-  RichEdit2, ExRichEdit, class_TIntegerList;
+  RichEdit2, ExRichEdit, class_TIntegerList, TBXLists;
 
 type
 
@@ -179,8 +179,6 @@
     SpTBXSeparatorItem1: TSpTBXSeparatorItem;
     SpTBXSeparatorItem2: TSpTBXSeparatorItem;
     SpTBXItem7: TSpTBXItem;
-    MapsPopupMenu: TSpTBXPopupMenu;
-    MapsPopupStringList: TSpTBXStringList;
     ForceSpectatorModeItem: TSpTBXItem;
     SpTBXTitleBar1: TSpTBXTitleBar;
     Panel3: TSpTBXPanel;
@@ -311,6 +309,9 @@
     SpTBXSeparatorItem11: TSpTBXSeparatorItem;
     SpTBXSeparatorItem12: TSpTBXSeparatorItem;
     DownloadMapButton: TTBXButton;
+    Button1: TButton;
+    MapsPopupMenu: TSpTBXFormPopupMenu;
+    DropDownMapSelectionButton: TSpTBXButton;
 
     procedure CreateParams(var Params: TCreateParams); override;
 
@@ -340,7 +341,8 @@
     procedure ChangeMapToFirstOne;
     procedure ChangeMap(MapIndex: Integer); // 'MapIndex' refers to index in Utility.MapList
     procedure CheckMapSync;
-    procedure PopulatePopupMenuMapList; // will populate 'MapsPopupMenu' with map names
+    procedure PopulatePopupMenuMapList;
+    procedure PopulatePopupMenuMapListF(filter: string = ''); // will populate 'MapsPopupMenu' with map names
     procedure MapsPopupMenuItemClick(Sender: TObject);
 
     procedure OnStartGameMessage(var Msg: TMessage); message WM_STARTGAME;
@@ -516,10 +518,12 @@
     procedure VDTDisabledUnitsDrawNode(Sender: TBaseVirtualTree;
       const PaintInfo: TVTPaintInfo);
     procedure ChatExRichEditDblClick(Sender: TObject);
-    procedure Button1Click(Sender: TObject);
     procedure ChatRichEditMouseDown(Sender: TObject; Button: TMouseButton;
       Shift: TShiftState; X, Y: Integer);
     procedure DownloadMapButtonClick(Sender: TObject);
+    procedure MapListFilterTextBoxChange(Sender: TObject;
+      const Text: WideString);
+    procedure MapsPopupMenuPopup(Sender: TObject);
   private
     History: TWideStringList;
     HistoryIndex: Integer;
@@ -668,7 +672,8 @@
   InitWaitFormUnit, AddBotUnit, Math, OnlineMapsUnit, ReplaysUnit, StrUtils,
   CustomColorUnit, StringParser, MapListFormUnit, AutoTeamsUnit,
   AutoStartRectsUnit, ColorPicker, UploadReplayUnit, ProgressBarWindow,
-  TntWideStrings, LobbyScriptUnit, SpringDownloaderFormUnit;
+  TntWideStrings, LobbyScriptUnit, SpringDownloaderFormUnit,
+  MapSelectionFormUnit;
 
 {$R *.dfm}
 
@@ -1104,7 +1109,7 @@
   MapDescLabel.Hint := MapDescLabel.Caption;
 
   FCurrentMapIndex := -1;
-  MapsPopupStringList.ItemIndex := -1;
+  MapSelectionForm.MapListBox.ItemIndex := -1;
 
   MapImage.Hint := 'No map';
 
@@ -1131,7 +1136,7 @@
 
 procedure TBattleForm.ChangeMapToFirstOne;
 begin
-  ChangeMap(Utility.MapList.IndexOf(MapsPopupStringList.Strings.Strings[0]));
+  ChangeMap(Utility.MapList.IndexOf(MapSelectionForm.MapListBox.Items.Strings[0]));
 end;
 
 procedure TBattleForm.ChangeMap(MapIndex: Integer);
@@ -1180,7 +1185,7 @@
   Preferences.LastOpenMap := GetMapItem(MapIndex).MapName;
 
   FCurrentMapIndex := MapIndex;
-  MapsPopupStringList.ItemIndex := MapIndex;
+  MapSelectionForm.MapListBox.ItemIndex := MapIndex;
 
   MapImage.Hint := GetMapItem(MapIndex).MapName;
 
@@ -1200,51 +1205,46 @@
 end;
 
 procedure TBattleForm.PopulatePopupMenuMapList;
+begin
+  PopulatePopupMenuMapListF(MapSelectionForm.FilterTextBox.Text);
+end;
+
+procedure TBattleForm.PopulatePopupMenuMapListF(filter: string = '');
 var
   i: Integer;
   validMaps: TStringList;
 begin
-  MapsPopupStringList.Strings.Clear;
-  if not BattleForm.IsBattleActive then
-  begin
-    MapsPopupStringList.Strings.Assign(Utility.MapList);
-    Exit;
-  end;
+  MapSelectionForm.MapListBox.Items.BeginUpdate;
+  MapSelectionForm.MapListBox.Items.Clear;
 
-  if BattleState.LadderIndex &gt; -1 then
-  begin
-    for i:=0 to Utility.MapList.Count-1 do
-      if (TLadder(LadderList[BattleState.LadderIndex]).Maps.IndexOf(Utility.MapList[i]) &gt;= 0) and ((Utility.ModValidMaps.Count =0) or (Utility.ModValidMaps.IndexOf(Utility.MapList[i]) &gt;= 0)) then
-        MapsPopupStringList.Strings.Add(Utility.MapList[i]);
-  end
-  else
-  begin
-    if Utility.ModValidMaps.Count = 0 then
-      MapsPopupStringList.Strings.Assign(Utility.MapList)
-    else
-      for i:=0 to validMaps.Count-1 do
-        if Utility.MapList.IndexOf(Utility.ModValidMaps[i]) &gt;= 0 then
-          MapsPopupStringList.Strings.Add(Utility.ModValidMaps[i]);
-  end;
+  for i:=0 to Utility.MapList.Count-1 do
+    if (
+      ((filter = '') or (Pos(LowerCase(filter),LowerCase(Utility.MapList[i])) &gt; 0)) and // filter
+      ((Utility.ModValidMaps = nil) or (Utility.ModValidMaps.Count = 0) or (Utility.MapList.IndexOf(Utility.ModValidMaps[i]) &gt;= 0)) and // valid maps
+      ((BattleState.LadderIndex = -1) or (TLadder(LadderList[BattleState.LadderIndex]).Maps.IndexOf(Utility.MapList[i]) &gt;= 0)) // ladder maps
+    ) then
+      MapSelectionForm.MapListBox.Items.Add(Utility.MapList[i]);
+  MapSelectionForm.MapListBox.Items.EndUpdate;
 end;
 
 procedure TBattleForm.MapsPopupMenuItemClick(Sender: TObject);
 var
   index : integer;
 begin
-  index :=  Utility.MapList.IndexOf(MapsPopupStringList.Strings.Strings[MapsPopupStringList.ItemIndex]);
+  if MapSelectionForm.MapListBox.ItemIndex = -1 then Exit;
+  index :=  Utility.MapList.IndexOf(MapSelectionForm.MapListBox.Items.Strings[MapSelectionForm.MapListBox.ItemIndex]);
   if IsBattleActive and (BattleState.Status = Joined) then
   begin
     //*** MessageDlg('Only battle host is able to change map!', mtWarning, [mbOK], 0);
     MainForm.TryToSendCommand('SAYBATTLEEX', 'suggests ' + Utility.MapList[index]);
-    MapsPopupStringList.ItemIndex := CurrentMapIndex;
+    MapSelectionForm.MapListBox.ItemIndex := CurrentMapIndex;
     Exit;
   end;
 
   if IsBattleActive and (BattleState.Battle.BattleType = 1) then
   begin
     MessageDlg('Cannot change map while hosting battle replay!', mtWarning, [mbOK], 0);
-    MapsPopupStringList.ItemIndex := CurrentMapIndex;
+    MapSelectionForm.MapListBox.ItemIndex := CurrentMapIndex;
     Exit;
   end;
 
@@ -1426,13 +1426,8 @@
 
   // display only mod maps
   validMaps := GetModValidMapList;
-  if validMaps.Count &gt;0 then
-  begin
-    MapsPopupStringList.Strings.Clear;
-    for i:=0 to validMaps.Count-1 do
-      if Utility.MapList.IndexOf(validMaps[i]) &gt; -1 then
-        MapsPopupStringList.Strings.Add(validMaps[i]);
-  end;
+
+  PopulatePopupMenuMapList;
   
   // update map:
   if (CurrentMapIndex = -1) or (Battle.Map &lt;&gt; GetMapItem(CurrentMapIndex).MapName) then
@@ -1666,14 +1661,7 @@
 
   // display only mod maps
   validMaps := GetModValidMapList;
-  if validMaps.Count &gt;0 then
-  begin
-    MapsPopupStringList.Strings.Clear;
-    for i:=0 to validMaps.Count-1 do
-      if Utility.MapList.IndexOf(validMaps[i]) &gt; -1 then
-        MapsPopupStringList.Strings.Add(validMaps[i]);
-    ChangeMap(Utility.MapList.IndexOf(MapsPopupStringList.Strings[0]))
-  end;
+  PopulatePopupMenuMapList;
 
   // load map options
   if CurrentMapIndex &gt; -1 then
@@ -1815,14 +1803,14 @@
     if not Preferences.DisableAllSounds then PlayResSound('battle');
   end;
 
-  MapsPopupStringList.Strings.Assign(Utility.MapList);
+  PopulatePopupMenuMapList;
 
   BattleState.Status := None;
 
   BattleState.DisabledUnits.Clear;
   PopulateDisabledUnitsVDT;
 
-  MapsPopupStringList.Enabled := True;
+  MapSelectionForm.MapListBox.Enabled := True;
 
   StartPosRadioGroup.Enabled := False;
   GameEndRadioGroup.Enabled := False;
@@ -1875,6 +1863,8 @@
   if UnknownScriptTagList.ValueList &lt;&gt; nil then
     UnknownScriptTagList.ValueList.Clear;
 
+  MapSelectionForm.FilterTextBox.Text := '';
+
   MainForm.ResetAutoKickMsgSentCounters;
   MainForm.ResetAutoSpecMsgSentCounters;
 //*** anything else?
@@ -2416,6 +2406,7 @@
   Left := 10;
   Top := 10;
   BattleState.DisabledUnits := TStringList.Create;
+  BattleState.LadderIndex := -1;
 
   FCurrentMapIndex := -1;
 
@@ -5627,9 +5618,9 @@
 
 procedure TLadderMapThread.Initialize;
 begin
-    BattleForm.MapsPopupStringList.Enabled := false;
-    BattleForm.MapsPopupStringList.Strings.Clear;
-    BattleForm.MapsPopupStringList.Strings.Add('Loading ladder map list ...');
+    MapSelectionForm.MapListBox.Enabled := false;
+    MapSelectionForm.MapListBox.Items.Clear;
+    MapSelectionForm.MapListBox.Items.Add('Loading ladder map list ...');
     BattleForm.StartButton.Enabled := False;
 end;
 
@@ -5643,13 +5634,13 @@
 begin
   if BattleState.Status = Hosting then
     BattleForm.StartButton.Enabled := StartButtonEnabled;
-  BattleForm.MapsPopupStringList.Enabled := True;
+  MapSelectionForm.MapListBox.Enabled := True;
   BattleForm.MapPanelResize(nil);
 end;
 
 procedure TLadderMapThread.ShowMessageStatus;
 begin
-  BattleForm.MapsPopupStringList.Strings.Strings[0] := StatusMsg;
+  MapSelectionForm.MapListBox.Items.Strings[0] := StatusMsg;
 end;
 
 procedure TLadderMapThread.UpdateMessageStatus(msg : string);
@@ -5719,7 +5710,7 @@
 
     if BattleState.Status = Hosting then
     begin
-      if MapsPopupStringList.Strings.Count &gt; 0 then
+      if MapSelectionForm.MapListBox.Items.Count &gt; 0 then
       begin
         Synchronize(ChangeMapToFirstOne);
         if IsBattleActive and (BattleState.Status = Hosting) then
@@ -6581,7 +6572,7 @@
   map : TMapItem;
   mapImgSpaceWidth,mapImgSpaceHeight : double;
 begin
-  //if not MapsPopupStringList.Enabled then
+  //if not MapSelectionForm.MapListBox.Enabled then
     //Exit;
   mapImgSpaceWidth := MapPanel.Width-134;
   mapImgSpaceHeight := MapPanel.Height-62;
@@ -6747,12 +6738,6 @@
    end;
 end;
 
-procedure TBattleForm.Button1Click(Sender: TObject);
-begin
-  Utility.ExtractVFSDir('lups','');
-end;
-
-
 procedure TBattleForm.ChatRichEditMouseDown(Sender: TObject;
   Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
 begin
@@ -6769,4 +6754,16 @@
   end;
 end;
 
+procedure TBattleForm.MapListFilterTextBoxChange(Sender: TObject;
+  const Text: WideString);
+begin
+  PopulatePopupMenuMapListF(Text);
+end;
+
+procedure TBattleForm.MapsPopupMenuPopup(Sender: TObject);
+begin
+  MapSelectionForm.SetFocus;
+  MapSelectionForm.FilterTextBox.SetFocus;
+end;
+
 end.

Modified: trunk/Lobby/TASClient/MainUnit.dfm
===================================================================
--- trunk/Lobby/TASClient/MainUnit.dfm	2008-09-02 15:36:04 UTC (rev 6350)
+++ trunk/Lobby/TASClient/MainUnit.dfm	2008-09-02 19:11:44 UTC (rev 6351)
@@ -1,6 +1,6 @@
 object MainForm: TMainForm
-  Left = 480
-  Top = 329
+  Left = 1001
+  Top = 120
   Width = 729
   Height = 543
   Caption = '.'
@@ -6458,8 +6458,8 @@
   end
   object SearchFormPopupMenu: TSpTBXFormPopupMenu
     PopupFocus = True
-    Left = 548
-    Top = 78
+    Left = 452
+    Top = 86
   end
   object BattleListPopupMenu: TSpTBXPopupMenu
     OnInitPopup = BattleListPopupMenuInitPopup
@@ -6524,7 +6524,7 @@
     end
   end
   object HelpPopupMenu: TSpTBXPopupMenu
-    Left = 448
+    Left = 368
     Top = 86
     object mnuHelp: TSpTBXItem
       Caption = 'Help'

Modified: trunk/Lobby/TASClient/MainUnit.pas
===================================================================
--- trunk/Lobby/TASClient/MainUnit.pas	2008-09-02 15:36:04 UTC (rev 6350)
+++ trunk/Lobby/TASClient/MainUnit.pas	2008-09-02 19:11:44 UTC (rev 6351)
@@ -522,7 +522,7 @@
 const
   VERSION_NUMBER = '0.38'; // Must be float value! (with a period as a decimal seperator)
   CHECK_BETA_LOBBY_URL = '<A HREF="http://tasclient.no-ip.org/TASClient_update_v2.txt">http://tasclient.no-ip.org/TASClient_update_v2.txt</A>';
-  PROGRAM_VERSION = 'TASClient ' + VERSION_NUMBER + ' RC10';
+  PROGRAM_VERSION = 'TASClient ' + VERSION_NUMBER + ' RC11';
   KEEP_ALIVE_INTERVAL = 10000; // in milliseconds. Tells us what should be the maximum &quot;silence&quot; time before we send a ping to the server.
   ASSUME_TIMEOUT_INTERVAL = 30000; // in milliseconds. Must be greater than KEEP_ALIVE_INTERVAL! If server hasn't send any data to us within this interval, then we assume timeout occured. It's us who must make sure we get constant replies from server by pinging it.
   LOCAL_TAB = '$Local'; // caption of main (command) tab window. Must be special so that is different from channel names or user names, that is why there is a &quot;$&quot; in front of it.
@@ -1664,7 +1664,7 @@
   LoginProgressFormUnit, GpIFF, SearchFormUnit, ManageGroups, ColorPicker,
   AwayMessageFormUnit,JclStrings, SearchPlayerFormUnit, MenuFormUnit, Utility,
   PythonScriptDebugFormUnit,LobbyScriptUnit, SpringDownloaderFormUnit,
-  SyncObjs, LogonFormUnit;
+  SyncObjs, LogonFormUnit, MapSelectionFormUnit;
 
 {$R *.dfm}
 
@@ -3708,6 +3708,7 @@
 
     SearchFormPopupMenu.PopupForm := SearchForm;
     SearchPlayerFormPopupMenu.PopupForm := SearchPlayerForm;
+    BattleForm.MapsPopupMenu.PopupForm := MapSelectionForm;
 
     if Preferences.ConnectOnStartup and  not RunningWithMainMenu then
     begin

Modified: trunk/Lobby/TASClient/MapListFormUnit.pas
===================================================================
--- trunk/Lobby/TASClient/MapListFormUnit.pas	2008-09-02 15:36:04 UTC (rev 6350)
+++ trunk/Lobby/TASClient/MapListFormUnit.pas	2008-09-02 19:11:44 UTC (rev 6351)
@@ -176,7 +176,7 @@
 implementation
 
 uses BattleFormUnit, PreferencesFormUnit, InitWaitFormUnit,
-  SpTBXLists, TntWideStrings;
+  SpTBXLists, TntWideStrings, MapSelectionFormUnit;
 
 {$R *.dfm}
 
@@ -1005,7 +1005,7 @@
   for i := 0 to SortedMaps.Count - 1 do begin
     sl := TStringList.Create;
 
-    TMapItem(SortedMaps[i]).MainPanel.Visible := (not BattleForm.IsBattleActive) or (BattleForm.MapsPopupStringList.Strings.IndexOf(TMapItem(SortedMaps[i]).MapName) &gt;= 0);
+    TMapItem(SortedMaps[i]).MainPanel.Visible := (not BattleForm.IsBattleActive) or (MapSelectionForm.MapListBox.Items.IndexOf(TMapItem(SortedMaps[i]).MapName) &gt;= 0);
 
     Misc.ParseDelimited(sl,s,' ','');
     for k:=0 to sl.Count -1 do

Added: trunk/Lobby/TASClient/MapSelectionFormUnit.dfm
===================================================================
--- trunk/Lobby/TASClient/MapSelectionFormUnit.dfm	                        (rev 0)
+++ trunk/Lobby/TASClient/MapSelectionFormUnit.dfm	2008-09-02 19:11:44 UTC (rev 6351)
@@ -0,0 +1,59 @@
+object MapSelectionForm: TMapSelectionForm
+  Left = 1003
+  Top = 185
+  Width = 257
+  Height = 355
+  Caption = 'MapSelectionForm'
+  Color = clBtnFace
+  Font.Charset = DEFAULT_CHARSET
+  Font.Color = clWindowText
+  Font.Height = -11
+  Font.Name = 'MS Sans Serif'
+  Font.Style = []
+  OldCreateOrder = False
+  DesignSize = (
+    249
+    328)
+  PixelsPerInch = 96
+  TextHeight = 13
+  object MapListBox: TSpTBXListBox
+    Left = 4
+    Top = 40
+    Width = 241
+    Height = 284
+    Anchors = [akLeft, akTop, akRight, akBottom]
+    ItemHeight = 16
+    TabOrder = 0
+    OnDblClick = MapListBoxDblClick
+  end
+  object SpTBXLabel1: TSpTBXLabel
+    Left = 8
+    Top = 10
+    Width = 28
+    Height = 13
+    Caption = 'Filter :'
+    LinkFont.Charset = DEFAULT_CHARSET
+    LinkFont.Color = clBlue
+    LinkFont.Height = -11
+    LinkFont.Name = 'MS Sans Serif'
+    LinkFont.Style = [fsUnderline]
+  end
+  object FilterTextBox: TSpTBXEdit
+    Left = 40
+    Top = 8
+    Width = 199
+    Height = 21
+    Anchors = [akLeft, akTop, akRight]
+    TabOrder = 2
+    OnChange = FilterTextBoxChange
+  end
+  object Panel1: TPanel
+    Left = 8
+    Top = 33
+    Width = 231
+    Height = 2
+    Anchors = [akLeft, akTop, akRight]
+    BevelOuter = bvLowered
+    TabOrder = 3
+  end
+end

Added: trunk/Lobby/TASClient/MapSelectionFormUnit.pas
===================================================================
--- trunk/Lobby/TASClient/MapSelectionFormUnit.pas	                        (rev 0)
+++ trunk/Lobby/TASClient/MapSelectionFormUnit.pas	2008-09-02 19:11:44 UTC (rev 6351)
@@ -0,0 +1,40 @@
+unit MapSelectionFormUnit;
+
+interface
+
+uses
+  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
+  Dialogs, ExtCtrls, StdCtrls, SpTBXEditors, TBXDkPanels, SpTBXControls,
+  TntStdCtrls;
+
+type
+  TMapSelectionForm = class(TForm)
+    MapListBox: TSpTBXListBox;
+    SpTBXLabel1: TSpTBXLabel;
+    FilterTextBox: TSpTBXEdit;
+    Panel1: TPanel;
+    procedure FilterTextBoxChange(Sender: TObject);
+    procedure MapListBoxDblClick(Sender: TObject);
+  end;
+
+var
+  MapSelectionForm: TMapSelectionForm;
+
+implementation
+
+uses BattleFormUnit;
+
+{$R *.dfm}
+
+procedure TMapSelectionForm.FilterTextBoxChange(Sender: TObject);
+begin
+  BattleForm.PopulatePopupMenuMapListF(FilterTextBox.Text);
+end;
+
+procedure TMapSelectionForm.MapListBoxDblClick(Sender: TObject);
+begin
+  BattleForm.MapsPopupMenuItemClick(nil);
+  Close;
+end;
+
+end.

Modified: trunk/Lobby/TASClient/TASClient.dof
===================================================================
--- trunk/Lobby/TASClient/TASClient.dof	2008-09-02 15:36:04 UTC (rev 6350)
+++ trunk/Lobby/TASClient/TASClient.dof	2008-09-02 19:11:44 UTC (rev 6351)
@@ -115,7 +115,7 @@
 MajorVer=0
 MinorVer=3
 Release=0
-Build=429
+Build=434
 Debug=0
 PreRelease=0
 Special=0
@@ -126,7 +126,7 @@
 [Version Info Keys]
 CompanyName=
 FileDescription=TA Spring lobby client
-FileVersion=0.3.0.429
+FileVersion=0.3.0.434
 InternalName=
 LegalCopyright=
 LegalTrademarks=

Modified: trunk/Lobby/TASClient/TASClient.dpr
===================================================================
--- trunk/Lobby/TASClient/TASClient.dpr	2008-09-02 15:36:04 UTC (rev 6350)
+++ trunk/Lobby/TASClient/TASClient.dpr	2008-09-02 19:11:44 UTC (rev 6351)
@@ -111,7 +111,8 @@
   PythonScriptDebugFormUnit in 'PythonScriptDebugFormUnit.pas' {PythonScriptDebugForm},
   LobbyScriptUnit in 'LobbyScriptUnit.pas',
   SpringDownloaderFormUnit in 'SpringDownloaderFormUnit.pas' {SpringDownloaderForm},
-  LogonFormUnit in 'LogonFormUnit.pas' {LogonForm};
+  LogonFormUnit in 'LogonFormUnit.pas' {LogonForm},
+  MapSelectionFormUnit in 'MapSelectionFormUnit.pas' {MapSelectionForm};
 
 var
   i: Integer;
@@ -183,6 +184,8 @@
 
   Application.Title := 'TASClient';
   Application.CreateForm(TMainForm, MainForm);
+  Application.CreateForm(TMapSelectionForm, MapSelectionForm);
+  Application.CreateForm(TLogonForm, LogonForm);
   Application.CreateForm(TColorPickerForm, ColorPickerForm);
   Application.CreateForm(TPreferencesForm, PreferencesForm);
   Application.CreateForm(TBattleForm, BattleForm);
@@ -220,7 +223,6 @@
   Application.CreateForm(TColorsPreference, ColorsPreference);
   Application.CreateForm(TSearchPlayerForm, SearchPlayerForm);
   Application.CreateForm(TPythonScriptDebugForm, PythonScriptDebugForm);
-  Application.CreateForm(TLogonForm, LogonForm);
   //Application.CreateForm(TSpringDownloaderForm, SpringDownloaderForm);
   if not MainUnit.RunningUnderWine then
     Application.CreateForm(TMenuForm, MenuForm);

Modified: trunk/Lobby/TASClient/TASClient.res
===================================================================
(Binary files differ)


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001120.html">[Taspring-linux-commit] r6350 - in trunk/tools/ArchiveMoverLinux: .	libmlsevenzip libmlsevenzip/libsevenzip	libmlsevenzip/libsevenzip/Archive	libmlsevenzip/libsevenzip/Archive/7z	libmlsevenzip/libsevenzip/LzmaLib libmlsevenzip/libsevenzip/LzmaUtil
</A></li>
	<LI>Next message: <A HREF="001122.html">[Taspring-linux-commit] r6352 - in trunk/rts: System lib/gml
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1121">[ date ]</a>
              <a href="thread.html#1121">[ thread ]</a>
              <a href="subject.html#1121">[ subject ]</a>
              <a href="author.html#1121">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
