<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r6389 - trunk/Lobby/TASClient
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-September/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6389%20-%20trunk/Lobby/TASClient&In-Reply-To=%3C20080908175545.DB07D4A47%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001158.html">
   <LINK REL="Next"  HREF="001160.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r6389 - trunk/Lobby/TASClient</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6389%20-%20trunk/Lobby/TASClient&In-Reply-To=%3C20080908175545.DB07D4A47%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r6389 - trunk/Lobby/TASClient">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Mon Sep  8 19:55:45 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001158.html">[Taspring-linux-commit] r6388 - trunk/tools/SpringInstaller
</A></li>
        <LI>Next message: <A HREF="001160.html">[Taspring-linux-commit] r6390 - trunk/tools/unitsync
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1159">[ date ]</a>
              <a href="thread.html#1159">[ thread ]</a>
              <a href="subject.html#1159">[ subject ]</a>
              <a href="author.html#1159">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: satirik
Date: 2008-09-08 19:55:44 +0200 (Mon, 08 Sep 2008)
New Revision: 6389

Modified:
   trunk/Lobby/TASClient/! readme !.txt
   trunk/Lobby/TASClient/BattleFormUnit.dfm
   trunk/Lobby/TASClient/BattleFormUnit.pas
   trunk/Lobby/TASClient/ColorsPreferenceUnit.dfm
   trunk/Lobby/TASClient/ColorsPreferenceUnit.pas
   trunk/Lobby/TASClient/MainUnit.dfm
   trunk/Lobby/TASClient/MainUnit.pas
   trunk/Lobby/TASClient/Misc.pas
   trunk/Lobby/TASClient/PreferencesFormUnit.dfm
   trunk/Lobby/TASClient/PreferencesFormUnit.pas
   trunk/Lobby/TASClient/ReplaysUnit.dfm
   trunk/Lobby/TASClient/ReplaysUnit.pas
   trunk/Lobby/TASClient/TASClient.dof
   trunk/Lobby/TASClient/TASClient.res
   trunk/Lobby/TASClient/UploadReplayUnit.dfm
   trunk/Lobby/TASClient/UploadReplayUnit.pas
Log:
* readme updated
* upload replays back to life
* 'Ask what to do with replay after each replay' option added, you can upload the replay delete the replay or keep it. The form should be automaticaly shown to the hoster of each ladder battles
* every time you open a new chat tab, it will automaticaly add the last 30 logged lines
* old msg color added to the colors preference form

Modified: trunk/Lobby/TASClient/! readme !.txt
===================================================================
--- trunk/Lobby/TASClient/! readme !.txt	2008-09-08 10:12:58 UTC (rev 6388)
+++ trunk/Lobby/TASClient/! readme !.txt	2008-09-08 17:55:44 UTC (rev 6389)
@@ -1,8 +1,8 @@
-UPDATED: 12 Aug 2008
+UPDATED: 8 Sep 2008
 
 *** In order to compile the sources, you'll have to install some free 3rd-party components: ***
 
-*** This archive should contains everything you need to compile the lobby : <A HREF="http://tasclient.it-l.eu/TASClient_SDK.7z">http://tasclient.it-l.eu/TASClient_SDK.7z</A>
+*** The following archive should contains everything you need to compile the lobby : <A HREF="http://tasclient.it-l.eu/TASClient_SDK.7z">http://tasclient.it-l.eu/TASClient_SDK.7z</A> ***
 
 - TjanTracker (Included with these sources - just install janTracker.pas)
 - Virtual TreeView component: <A HREF="http://www.lischke-online.de/VirtualTreeview/">http://www.lischke-online.de/VirtualTreeview/</A>
@@ -11,6 +11,7 @@
 - RichEditURL (Included with these sources - just install RichEditURL.pas)
 - TExImage (Included with these sources - just install ImageEx.pas)
 - JVCL (<A HREF="http://homepages.borland.com/jedi/jvcl/">http://homepages.borland.com/jedi/jvcl/</A>) - download JVCL+JCL bundle
+- 7zipJCL (autoupdate feature) <A HREF="http://www.rg-software.de/rg/index.php?option=com_content&amp;task=view&amp;id=29&amp;Itemid=51">http://www.rg-software.de/rg/index.php?option=com_content&amp;task=view&amp;id=29&amp;Itemid=51</A>
 - Python For Delphi (<A HREF="http://mmm-experts.com/Products.aspx?ProductID=3">http://mmm-experts.com/Products.aspx?ProductID=3</A>)
 
 Note: All components that are included with the sources are located
@@ -47,7 +48,6 @@
 - SpTBXLib 1.8.1 (<A HREF="http://club.telepolis.com/silverpointdev/sptbxlib/index.htm">http://club.telepolis.com/silverpointdev/sptbxlib/index.htm</A>)
 - Additional TBX themes (<A HREF="http://www.rmklever.com/zipfiles/TBXThemes21.zip">http://www.rmklever.com/zipfiles/TBXThemes21.zip</A>)
 - PngImage (for the macosx theme only)
-- 7zipJCL (autoupdate feature) <A HREF="http://www.rg-software.de/rg/index.php?option=com_content&amp;task=view&amp;id=29&amp;Itemid=51">http://www.rg-software.de/rg/index.php?option=com_content&amp;task=view&amp;id=29&amp;Itemid=51</A>
 
 To install these components, you should use Silverpoint MultiInstaller
 (<A HREF="http://club.telepolis.com/silverpointdev/multiinstaller/index.htm">http://club.telepolis.com/silverpointdev/multiinstaller/index.htm</A>),
@@ -70,12 +70,22 @@
   no tick here - it should be disabled)).
 
 *** Command line arguments ***
-- -wine: use to force Wine compatibility mode
 
+-wine
+	use to force Wine compatibility mode
+-server address:port
+	change the default server and port
+-menu
+	show the SP menu first
+-menudev
+	use the Spring\Interface dir to get the skin files instead of the skin archive
+	
+
 *** Credits for various graphics: ***
 
-- Neuralize (most buttons, client status symbols and battle icons)
-- RuneCrafter (splash screen and other stuff) 
+- Yatta (new status icons)
+- Neuralize (most buttons, old client status symbols and old battle icons)
+- RuneCrafter (old splash screen and other stuff) 
 - Maelstrom (NAT warning icon, &quot;bot mode&quot; icon)
 - IceXuick (map grade icons, some popup menu icons)
 - Some icons are taken from the TBX components (demo app)
\ No newline at end of file

Modified: trunk/Lobby/TASClient/BattleFormUnit.dfm
===================================================================
--- trunk/Lobby/TASClient/BattleFormUnit.dfm	2008-09-08 10:12:58 UTC (rev 6388)
+++ trunk/Lobby/TASClient/BattleFormUnit.dfm	2008-09-08 17:55:44 UTC (rev 6389)
@@ -1,6 +1,6 @@
 object BattleForm: TBattleForm
-  Left = 699
-  Top = 143
+  Left = 761
+  Top = 68
   Width = 783
   Height = 586
   Caption = 'Battle window'

Modified: trunk/Lobby/TASClient/BattleFormUnit.pas
===================================================================
--- trunk/Lobby/TASClient/BattleFormUnit.pas	2008-09-08 10:12:58 UTC (rev 6388)
+++ trunk/Lobby/TASClient/BattleFormUnit.pas	2008-09-08 17:55:44 UTC (rev 6389)
@@ -388,7 +388,7 @@
     procedure UnitsTrackerMouseUpAfterChange(Sender: TObject);
     procedure StartPosRadioGroupClick(Sender: TObject);
     procedure GameTimerTimer(Sender: TObject);
-    procedure UploadReplay;
+    procedure UploadReplayAndLadderReport;
     procedure InputEditKeyPress(Sender: TObject; var Key: Char);
     procedure InputEditKeyDown(Sender: TObject; var Key: Word;
       Shift: TShiftState);
@@ -3132,7 +3132,7 @@
       MainForm.TryToSendCommand('MYSTATUS', '0'); // let's tell the server we returned from the game
 
       CloseHandle(BattleState.Process.proc_info.hProcess);
-      UploadReplay;
+      UploadReplayAndLadderReport;
     end
   else
   begin
@@ -3142,11 +3142,11 @@
 
     TerminateProcess(BattleState.Process.proc_info.hProcess, 0);
     CloseHandle(BattleState.Process.proc_info.hProcess);
-    UploadReplay;
+    UploadReplayAndLadderReport;
   end;
 end;
 
-procedure TBattleForm.UploadReplay;
+procedure TBattleForm.UploadReplayAndLadderReport;
 var
   sr: TSearchRec;
   FileAttrs: Integer;
@@ -3154,7 +3154,6 @@
   s,su: string;
   FileName : string;
   i,j:integer;
-  teamCount : array[0..15] of integer;
   LadderUpThread : TUploadLadderDataThread;
 begin
   if (not Preferences.UploadReplay and ((BattleState.LadderIndex = -1) or (BattleState.Status = Joined))) or (BattleState.Battle.BattleType=1) then begin
@@ -3165,8 +3164,7 @@
     end;
     Exit;
   end;
-  {Replay upload disabled while the Replay site is down
-  
+
   FileAttrs := faAnyFile;
 
   if FindFirst(ExtractFilePath(Application.ExeName) + 'demos\*.sdf', FileAttrs, sr) = 0 then
@@ -3185,56 +3183,22 @@
     FindClose(sr);
   end;
 
-  ReplaysForm.ReadScriptFromDemo(FileName,s);
-  su := UpperCase(s);
-
   UploadReplayForm.FileName := FileName;
 
-  i := Pos('MAPNAME=', su);
-  i := i + 8;
-  j := PosEx(';', su, i);
-  if (i&lt;&gt;0) and (j&lt;&gt;0) then UploadReplayForm.MapName := Copy(s, i, j-i-4)
-  else Exit; // corrupt script file
-
-  i := Pos('GAMETYPE=', su);
-  i := i + 9;
-  j := PosEx(';', su, i);
-  if (i&lt;&gt;0) and (j&lt;&gt;0) then UploadReplayForm.ModName := Copy(s, i, j-i-4)
-  else Exit; // corrupt script file
-
-  for i:=0 to 15 do
-    teamCount[i] := 0;
-
-  i := Pos('AllyTeam=',s);
-  while i &gt; 0 do begin
-    i := i+9;
-    j := PosEx(';',s,i);
-    Inc(teamCount[StrToInt(Copy(s,i,j-i))]);
-    i := PosEx('AllyTeam=',s,i);
-  end;
-  UploadReplayForm.NbPlayers := '';
-  for i:= 0 to 15 do
-    if teamCount[i] &gt; 0 then
-      if UploadReplayForm.NbPlayers = '' then
-        UploadReplayForm.NbPlayers := IntToStr(teamCount[i])
-      else
-        UploadReplayForm.NbPlayers := UploadReplayForm.NbPlayers + 'v' + IntToStr(teamCount[i]);
-
-
   if BattleState.LadderIndex &gt;= 0 then
-    UploadReplayForm.Title := 'Ladder battle : ' + TLadder(LadderList[BattleState.LadderIndex]).Name;
-  }
+    UploadReplayForm.Description := 'Ladder battle : ' + TLadder(LadderList[BattleState.LadderIndex]).Name;
+
   UploadReplayForm.UploadedReplayId := '';
-  //UploadReplayForm.ShowModal;
+  UploadReplayForm.AutoUpload := True;
 
+  UploadReplayForm.ShowModal;
+
   if (BattleState.LadderIndex &gt;= 0) and (Status.Me.GetMode &lt;&gt; 0) then begin
     ProgressBarForm.Close;
     ProgressBarForm.TakeAction := 2;
     ProgressBarForm.ShowModal;
   end;
 
-  //MessageDlg(FileName,mtInformation,[mbOk],0);
-
 end;
 
 

Modified: trunk/Lobby/TASClient/ColorsPreferenceUnit.dfm
===================================================================
--- trunk/Lobby/TASClient/ColorsPreferenceUnit.dfm	2008-09-08 10:12:58 UTC (rev 6388)
+++ trunk/Lobby/TASClient/ColorsPreferenceUnit.dfm	2008-09-08 17:55:44 UTC (rev 6389)
@@ -1,9 +1,9 @@
 object ColorsPreference: TColorsPreference
-  Left = 496
-  Top = 203
+  Left = 311
+  Top = 144
   BorderStyle = bsDialog
   Caption = 'Color Preferences'
-  ClientHeight = 462
+  ClientHeight = 480
   ClientWidth = 490
   Color = clBtnFace
   Constraints.MaxHeight = 1000
@@ -23,13 +23,13 @@
     Left = 0
     Top = 0
     Width = 490
-    Height = 462
+    Height = 480
     Caption = 'Colors and Font Preference'
     FixedSize = True
     Options.Maximize = False
     object btOk: TSpTBXButton
       Left = 311
-      Top = 424
+      Top = 440
       Width = 73
       Height = 25
       Caption = 'Ok'
@@ -43,7 +43,7 @@
     end
     object btRest: TSpTBXButton
       Left = 22
-      Top = 424
+      Top = 440
       Width = 88
       Height = 25
       Caption = 'Reset'
@@ -63,7 +63,7 @@
     end
     object btCancel: TSpTBXButton
       Left = 397
-      Top = 424
+      Top = 440
       Width = 70
       Height = 25
       Caption = 'Cancel'
@@ -79,7 +79,7 @@
       Left = 24
       Top = 40
       Width = 193
-      Height = 313
+      Height = 337
       Caption = 'Chat colors'
       Font.Charset = DEFAULT_CHARSET
       Font.Color = clWindowText
@@ -532,6 +532,43 @@
         LinkFont.Style = [fsUnderline]
         ThemeType = thtTBX
       end
+      object SpTBXLabel16: TSpTBXLabel
+        Left = 16
+        Top = 308
+        Width = 72
+        Height = 13
+        Caption = 'Old messages :'
+        LinkFont.Charset = DEFAULT_CHARSET
+        LinkFont.Color = clBlue
+        LinkFont.Height = -11
+        LinkFont.Name = 'MS Sans Serif'
+        LinkFont.Style = [fsUnderline]
+      end
+      object Panel15: TPanel
+        Left = 101
+        Top = 307
+        Width = 57
+        Height = 21
+        BevelOuter = bvNone
+        BorderStyle = bsSingle
+        Color = clBlack
+        TabOrder = 37
+      end
+      object SpTBXButton16: TSpTBXButton
+        Left = 160
+        Top = 307
+        Width = 25
+        Height = 20
+        Caption = '...'
+        TabOrder = 38
+        OnClick = SpTBXButton16Click
+        LinkFont.Charset = DEFAULT_CHARSET
+        LinkFont.Color = clBlue
+        LinkFont.Height = -11
+        LinkFont.Name = 'MS Sans Serif'
+        LinkFont.Style = [fsUnderline]
+        ThemeType = thtTBX
+      end
     end
     object SpTBXGroupBox2: TSpTBXGroupBox
       Left = 224
@@ -654,7 +691,7 @@
     end
     object SpTBXGroupBox3: TSpTBXGroupBox
       Left = 24
-      Top = 360
+      Top = 384
       Width = 193
       Height = 49
       Caption = 'Chat font'
@@ -694,6 +731,6 @@
     Font.Name = 'MS Sans Serif'
     Font.Style = []
     Left = 136
-    Top = 376
+    Top = 400
   end
 end

Modified: trunk/Lobby/TASClient/ColorsPreferenceUnit.pas
===================================================================
--- trunk/Lobby/TASClient/ColorsPreferenceUnit.pas	2008-09-08 10:12:58 UTC (rev 6388)
+++ trunk/Lobby/TASClient/ColorsPreferenceUnit.pas	2008-09-08 17:55:44 UTC (rev 6389)
@@ -64,6 +64,9 @@
     lblFontName: TSpTBXLabel;
     SpTBXButton15: TSpTBXButton;
     FontDialog1: TFontDialog;
+    SpTBXLabel16: TSpTBXLabel;
+    Panel15: TPanel;
+    SpTBXButton16: TSpTBXButton;
     procedure FormCreate(Sender: TObject);
     procedure SpTBXButton0Click(Sender: TObject);
     procedure SpTBXButton1Click(Sender: TObject);
@@ -85,6 +88,7 @@
     procedure SpTBXButton15Click(Sender: TObject);
     procedure FormShow(Sender: TObject);
     procedure SpTBXButton14Click(Sender: TObject);
+    procedure SpTBXButton16Click(Sender: TObject);
   private
     { Private declarations }
   public
@@ -173,6 +177,7 @@
   Colors.BotText := Panel12.Color;
   Colors.MyText := Panel13.Color;
   Colors.AdminText := Panel14.Color;
+  Colors.OldMsgs := Panel15.Color;
   ApplyFont;
 
   ModalResult := mrOk;
@@ -200,6 +205,7 @@
   Panel12.Color := clGray;
   Panel13.Color := $0092726e;
   Panel14.Color := $000366A3;
+  Panel15.Color := $00c3c3c3;
 
   CommonFont.Name := 'Fixedsys';
   CommonFont.Size := 8;
@@ -272,6 +278,7 @@
   Panel12.Color := Colors.BotText;
   Panel13.Color := Colors.MyText;
   Panel14.Color := Colors.AdminText;
+  Panel15.Color := Colors.OldMsgs;
   lblFontName.Caption := CommonFont.Name+'@'+IntToStr(CommonFont.Size);
 end;
 
@@ -280,4 +287,9 @@
   Panel14.Color := InputColor('Choose a color ...',Panel14.Color);
 end;
 
+procedure TColorsPreference.SpTBXButton16Click(Sender: TObject);
+begin
+  Panel15.Color := InputColor('Choose a color ...',Panel15.Color);
+end;
+
 end.

Modified: trunk/Lobby/TASClient/MainUnit.dfm
===================================================================
--- trunk/Lobby/TASClient/MainUnit.dfm	2008-09-08 10:12:58 UTC (rev 6388)
+++ trunk/Lobby/TASClient/MainUnit.dfm	2008-09-08 17:55:44 UTC (rev 6389)
@@ -3187,6 +3187,7 @@
     Top = 168
   end
   object KeepAliveTimer: TTimer
+    Enabled = False
     OnTimer = KeepAliveTimerTimer
     Left = 256
     Top = 168
@@ -6869,6 +6870,7 @@
       000000000000}
   end
   object HighlighBattlesTimer: TTimer
+    Enabled = False
     OnTimer = HighlighBattlesTimerTimer
     Left = 148
     Top = 166

Modified: trunk/Lobby/TASClient/MainUnit.pas
===================================================================
--- trunk/Lobby/TASClient/MainUnit.pas	2008-09-08 10:12:58 UTC (rev 6388)
+++ trunk/Lobby/TASClient/MainUnit.pas	2008-09-08 17:55:44 UTC (rev 6389)
@@ -490,6 +490,7 @@
     BotText: TColor; // bot text color in battle client list
     MyText: TColor; // my chat text color
     AdminText: TColor;
+    OldMsgs: TColor;
   end;
 
   TTeamColors = array[0..19] of TColor;
@@ -523,7 +524,7 @@
 const
   VERSION_NUMBER = '0.38'; // Must be float value! (with a period as a decimal seperator)
   CHECK_BETA_LOBBY_URL = '<A HREF="http://tasclient.no-ip.org/TASClient_update_v2.txt">http://tasclient.no-ip.org/TASClient_update_v2.txt</A>';
-  PROGRAM_VERSION = 'TASClient ' + VERSION_NUMBER + ' RC17';
+  PROGRAM_VERSION = 'TASClient ' + VERSION_NUMBER + ' RC18';
   KEEP_ALIVE_INTERVAL = 10000; // in milliseconds. Tells us what should be the maximum &quot;silence&quot; time before we send a ping to the server.
   ASSUME_TIMEOUT_INTERVAL = 30000; // in milliseconds. Must be greater than KEEP_ALIVE_INTERVAL! If server hasn't send any data to us within this interval, then we assume timeout occured. It's us who must make sure we get constant replies from server by pinging it.
   LOCAL_TAB = '$Local'; // caption of main (command) tab window. Must be special so that is different from channel names or user names, that is why there is a &quot;$&quot; in front of it.
@@ -1508,7 +1509,7 @@
     Key: Word; // unique ping packet ID (we use it to identify the packet so we don't mingle it with other ping packets if more were sent at the same time)
   end;
 var
-  Colors: TColors = (Normal:clBlack; Data: clGreen; Error:clRed; Info:clBlue; MinorInfo: clNavy; ChanJoin: clGreen; ChanLeft: clNavy; MOTD: clMaroon; SayEx: clPurple; Topic: clMaroon; ClientAway: $009F9F9F; MapModUnavailable: $00ed00d5;BotText:clGray; MyText: $0092726e;AdminText: $000366A3 );
+  Colors: TColors = (Normal:clBlack; Data: clGreen; Error:clRed; Info:clBlue; MinorInfo: clNavy; ChanJoin: clGreen; ChanLeft: clNavy; MOTD: clMaroon; SayEx: clPurple; Topic: clMaroon; ClientAway: $009F9F9F; MapModUnavailable: $00ed00d5;BotText:clGray; MyText: $0092726e;AdminText: $000366A3; OldMsgs: $00c3c3c3 );
   Debug:
   record
     Enabled: Boolean; // show some debugging information
@@ -2030,7 +2031,7 @@
       FileClose(fh);
     end;
 
-    Result := TFileStream.Create(FileName, fmOpenWrite or fmShareDenyWrite);
+    Result := TFileStream.Create(FileName, fmOpenReadWrite or fmShareDenyWrite);
     Result.Position := Result.Size;
     TryToAddLog(Result, '');
     TryToAddLog(Result, 'Logging started on ' + FormatDateTime('ddd mmm dd hh:nn:ss yyyy', Now));
@@ -3694,6 +3695,9 @@
 
     initLobbyScript;
 
+    KeepAliveTimer.Enabled := True;
+    HighlighBattlesTimer.Enabled := True;
+
     // finally:
     if RunningWithMainMenu then
       MenuForm.Show
@@ -3864,7 +3868,12 @@
   begin
     FileName := ExtractFilePath(Application.ExeName) + LOG_FOLDER + '\' + tmpts.Caption + '.log';
     tmpts.LogFile := OpenLog(FileName);
-    if tmpts.LogFile = nil then AddMainLog('Error: unable to access file: ' + FileName, Colors.Error);
+    if tmpts.LogFile = nil then
+      AddMainLog('Error: unable to access file: ' + FileName, Colors.Error)
+    else
+    begin
+      AddTextToRichEdit(tmpre,ReadLastLogFileLines(tmpts.LogFile,30),Colors.OldMsgs,True,0);
+    end;
   end;
 
   // finally:

Modified: trunk/Lobby/TASClient/Misc.pas
===================================================================
--- trunk/Lobby/TASClient/Misc.pas	2008-09-08 10:12:58 UTC (rev 6388)
+++ trunk/Lobby/TASClient/Misc.pas	2008-09-08 17:55:44 UTC (rev 6389)
@@ -56,6 +56,7 @@
 function VersionStringToFloat(Version: string): Single;
 function GetFileSize(FileName: string): Integer;
 function ReadFile2(FileName: string): string;
+function ReadLastLogFileLines(FileStream: TFileStream; nbLines : integer ): String;
 procedure SaveFile(FileName: string;content: string);
 function VerifyName(Name: string): Boolean;
 function GetRegistryData(RootKey: HKEY; Key, Value: string): Variant;
@@ -397,15 +398,8 @@
   pMax: TPoint;
   mask : Word;
 begin
-  // enable auto URL detection each time because sometimes the links disapears
-  //mask := SendMessage(RichEdit.Handle, EM_GETEVENTMASK, 0, 0);
-  //SendMessage(RichEdit.Handle, EM_SETEVENTMASK, 0, mask or ENM_LINK);
-  //SendMessage(RichEdit.Handle, EM_AUTOURLDETECT, Integer(True), 0);
-
   Text := Tnt_WideStringReplace(Text,#$0B,' ',[rfReplaceAll]);
 
-
-
   // save the scroll pos
   SelStart := RichEdit.SelStart;
   SelLength := RichEdit.SelLength;
@@ -431,7 +425,7 @@
     if RichEdit.SelStart = 0 then // to avoid the first empty line
       RichEdit.WideSelText := Text
     else
-      RichEdit.WideSelText :=  EOL + Text;
+      RichEdit.WideSelText :=  Text+EOL;
 
     // this will automatically highlight any keywords and pop-up notification windows (if set so):
     HighlightingForm.CheckLastLineForHighlights(RichEdit, ChatTextPos);
@@ -567,6 +561,46 @@
   FileStream.Free;
 end;
 
+function ReadLastLogFileLines(FileStream: TFileStream; nbLines : integer ): String;
+var
+  i: integer;
+  c: string;
+  readSize: integer;
+  line : string;
+  previousEOL: integer;
+begin
+  FileStream.Seek(-1,soFromEnd);
+  if FileStream.Size &lt; 2 then Exit;
+  SetLength(c,1);
+
+  previousEOL := FileStream.Size;
+  i := 0;
+  repeat
+    FileStream.Seek(-2,soFromCurrent);
+    FileStream.ReadBuffer(Pointer(c)^,1);
+    if c = #13 then
+    begin
+      readSize := previousEOL-FileStream.Position-1;
+      if readSize &gt; 0 then
+      begin
+        SetLength(line,readSize);
+        FileStream.ReadBuffer(Pointer(line)^,readSize);
+        FileStream.Seek(-readSize,soFromCurrent);
+        if (LeftStr(LowerCase(line),16) &lt;&gt; #10+'logging started') and (line &lt;&gt; #10) then // not counting the logging started msgs
+        begin
+          Result := line + Result;
+          Inc(i);
+        end;
+      end;
+      previousEOL := FileStream.Position;
+    end;
+  until (i &gt;= nbLines) or (FileStream.Position &lt;= 2);
+
+  Result := TrimLeft(Result)+EOL;
+
+  FileStream.Seek(-1,soFromEnd);
+end;
+
 procedure SaveFile(FileName: string;content: string);
 var
   FileStream: TFileStream;

Modified: trunk/Lobby/TASClient/PreferencesFormUnit.dfm
===================================================================
--- trunk/Lobby/TASClient/PreferencesFormUnit.dfm	2008-09-08 10:12:58 UTC (rev 6388)
+++ trunk/Lobby/TASClient/PreferencesFormUnit.dfm	2008-09-08 17:55:44 UTC (rev 6389)
@@ -1,6 +1,6 @@
 object PreferencesForm: TPreferencesForm
-  Left = 1006
-  Top = 225
+  Left = 569
+  Top = 124
   BorderStyle = bsDialog
   Caption = 'Preferences'
   ClientHeight = 413
@@ -37,7 +37,7 @@
       Width = 401
       Height = 329
       Color = clBtnFace
-      ActiveTabIndex = 2
+      ActiveTabIndex = 3
       TabAutofit = True
       HiddenItems = &lt;&gt;
       object SpTBXTabItem6: TSpTBXTabItem
@@ -50,11 +50,11 @@
       end
       object SpTBXTabItem4: TSpTBXTabItem
         Caption = 'Program'
-        Checked = True
         CustomWidth = 56
       end
       object SpTBXTabItem3: TSpTBXTabItem
         Caption = 'Interface'
+        Checked = True
         CustomWidth = 56
       end
       object SpTBXTabItem2: TSpTBXTabItem
@@ -586,169 +586,6 @@
           TabOrder = 4
         end
       end
-      object SpTBXTabSheet3: TSpTBXTabSheet
-        Left = 0
-        Top = 23
-        Width = 401
-        Height = 306
-        Caption = 'Interface'
-        ImageIndex = -1
-        TabItem = 'SpTBXTabItem3'
-        object GroupBox4: TSpTBXGroupBox
-          Left = 16
-          Top = 8
-          Width = 369
-          Height = 281
-          Caption = 'Interface preferences'
-          Color = clNone
-          ParentColor = False
-          TabOrder = 0
-          object CheckBox1: TSpTBXCheckBox
-            Left = 24
-            Top = 24
-            Width = 104
-            Height = 15
-            Caption = 'Timestamp events'
-            TabOrder = 0
-            Checked = True
-            State = cbChecked
-          end
-          object CheckBox3: TSpTBXCheckBox
-            Left = 24
-            Top = 40
-            Width = 128
-            Height = 15
-            Caption = 'Filter join/left messages'
-            TabOrder = 1
-          end
-          object CheckBox4: TSpTBXCheckBox
-            Left = 24
-            Top = 72
-            Width = 108
-            Height = 15
-            Caption = 'Show country flags'
-            TabOrder = 2
-            Checked = True
-            State = cbChecked
-          end
-          object CheckBox5: TSpTBXCheckBox
-            Left = 24
-            Top = 88
-            Width = 147
-            Height = 15
-            Caption = 'Mark unknown maps/mods'
-            TabOrder = 3
-            Checked = True
-            State = cbChecked
-          end
-          object CheckBox6: TSpTBXCheckBox
-            Left = 24
-            Top = 104
-            Width = 251
-            Height = 15
-            Caption = 'Use taskbar button for each form (requires restart)'
-            TabOrder = 4
-          end
-          object WarnNATCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 120
-            Width = 271
-            Height = 15
-            Caption = 'Display warning icons on battles using NAT traversing'
-            TabOrder = 5
-            Checked = True
-            State = cbChecked
-          end
-          object AutoFocusOnPMCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 136
-            Width = 262
-            Height = 15
-            Caption = 'Automatically switch focus to new private messages'
-            TabOrder = 6
-            Checked = True
-            State = cbChecked
-          end
-          object DisableAllSoundsCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 152
-            Width = 103
-            Height = 15
-            Caption = 'Disable all sounds'
-            TabOrder = 7
-          end
-          object UploadReplayCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 248
-            Width = 245
-            Height = 15
-            Caption = 'Ask to upload replay after the end of each battle'
-            TabOrder = 8
-            Visible = False
-          end
-          object SortLocalCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 168
-            Width = 132
-            Height = 15
-            Caption = 'Sort the $local player list'
-            TabOrder = 9
-          end
-          object DisplayQuickJoinPanelCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 184
-            Width = 131
-            Height = 15
-            Caption = 'Display Quick join panel'
-            TabOrder = 10
-          end
-          object FilterBattleJoinLeftCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 56
-            Width = 157
-            Height = 15
-            Caption = 'Filter battle join/left messages'
-            TabOrder = 11
-          end
-          object AutoCompletionCurrentChannelCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 200
-            Width = 252
-            Height = 15
-            Caption = 'Auto-completion from current channel'#39's players list'
-            TabOrder = 12
-          end
-          object ChatLogsLimitCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 216
-            Width = 145
-            Height = 15
-            Caption = 'Limit chat logs to 800 lines '
-            TabOrder = 13
-          end
-          object ChatLogsLimitTracker: TSpTBXTrackBar
-            Left = 184
-            Top = 216
-            Width = 121
-            Height = 17
-            Max = 3000
-            Min = 50
-            Frequency = 100
-            Position = 800
-            TabOrder = 14
-            ThumbLength = 10
-            OnChange = ChatLogsLimitTrackerChange
-          end
-          object DisplayUnitsIconsAndNamesCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 232
-            Width = 251
-            Height = 15
-            Caption = 'Load units icons and names when joining (slower)'
-            TabOrder = 15
-          end
-        end
-      end
       object SpTBXTabSheet4: TSpTBXTabSheet
         Left = 0
         Top = 23
@@ -974,6 +811,168 @@
           end
         end
       end
+      object SpTBXTabSheet3: TSpTBXTabSheet
+        Left = 0
+        Top = 23
+        Width = 401
+        Height = 306
+        Caption = 'Interface'
+        ImageIndex = -1
+        TabItem = 'SpTBXTabItem3'
+        object GroupBox4: TSpTBXGroupBox
+          Left = 16
+          Top = 8
+          Width = 369
+          Height = 281
+          Caption = 'Interface preferences'
+          Color = clNone
+          ParentColor = False
+          TabOrder = 0
+          object CheckBox1: TSpTBXCheckBox
+            Left = 24
+            Top = 24
+            Width = 104
+            Height = 15
+            Caption = 'Timestamp events'
+            TabOrder = 0
+            Checked = True
+            State = cbChecked
+          end
+          object CheckBox3: TSpTBXCheckBox
+            Left = 24
+            Top = 40
+            Width = 128
+            Height = 15
+            Caption = 'Filter join/left messages'
+            TabOrder = 1
+          end
+          object CheckBox4: TSpTBXCheckBox
+            Left = 24
+            Top = 72
+            Width = 108
+            Height = 15
+            Caption = 'Show country flags'
+            TabOrder = 2
+            Checked = True
+            State = cbChecked
+          end
+          object CheckBox5: TSpTBXCheckBox
+            Left = 24
+            Top = 88
+            Width = 147
+            Height = 15
+            Caption = 'Mark unknown maps/mods'
+            TabOrder = 3
+            Checked = True
+            State = cbChecked
+          end
+          object CheckBox6: TSpTBXCheckBox
+            Left = 24
+            Top = 104
+            Width = 251
+            Height = 15
+            Caption = 'Use taskbar button for each form (requires restart)'
+            TabOrder = 4
+          end
+          object WarnNATCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 120
+            Width = 271
+            Height = 15
+            Caption = 'Display warning icons on battles using NAT traversing'
+            TabOrder = 5
+            Checked = True
+            State = cbChecked
+          end
+          object AutoFocusOnPMCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 136
+            Width = 262
+            Height = 15
+            Caption = 'Automatically switch focus to new private messages'
+            TabOrder = 6
+            Checked = True
+            State = cbChecked
+          end
+          object DisableAllSoundsCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 152
+            Width = 103
+            Height = 15
+            Caption = 'Disable all sounds'
+            TabOrder = 7
+          end
+          object UploadReplayCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 248
+            Width = 222
+            Height = 15
+            Caption = 'Ask what to do with replay after each battle'
+            TabOrder = 8
+          end
+          object SortLocalCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 168
+            Width = 132
+            Height = 15
+            Caption = 'Sort the $local player list'
+            TabOrder = 9
+          end
+          object DisplayQuickJoinPanelCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 184
+            Width = 131
+            Height = 15
+            Caption = 'Display Quick join panel'
+            TabOrder = 10
+          end
+          object FilterBattleJoinLeftCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 56
+            Width = 157
+            Height = 15
+            Caption = 'Filter battle join/left messages'
+            TabOrder = 11
+          end
+          object AutoCompletionCurrentChannelCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 200
+            Width = 252
+            Height = 15
+            Caption = 'Auto-completion from current channel'#39's players list'
+            TabOrder = 12
+          end
+          object ChatLogsLimitCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 216
+            Width = 145
+            Height = 15
+            Caption = 'Limit chat logs to 800 lines '
+            TabOrder = 13
+          end
+          object ChatLogsLimitTracker: TSpTBXTrackBar
+            Left = 184
+            Top = 216
+            Width = 121
+            Height = 17
+            Max = 3000
+            Min = 50
+            Frequency = 100
+            Position = 800
+            TabOrder = 14
+            ThumbLength = 10
+            OnChange = ChatLogsLimitTrackerChange
+          end
+          object DisplayUnitsIconsAndNamesCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 232
+            Width = 251
+            Height = 15
+            Caption = 'Load units icons and names when joining (slower)'
+            TabOrder = 15
+          end
+        end
+      end
     end
     object ApplyAndCloseButton: TSpTBXButton
       Left = 43

Modified: trunk/Lobby/TASClient/PreferencesFormUnit.pas
===================================================================
--- trunk/Lobby/TASClient/PreferencesFormUnit.pas	2008-09-08 10:12:58 UTC (rev 6388)
+++ trunk/Lobby/TASClient/PreferencesFormUnit.pas	2008-09-08 17:55:44 UTC (rev 6389)
@@ -390,7 +390,7 @@
 
     try CommonFont.Name := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'FontName'); except end;
     try CommonFont.Size := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'FontSize'); except end;
-    ((MainForm.PageControl1.Pages[0] as TMyTabSheet).Controls[1] as TExRichEdit).Font.Assign(CommonFont);
+    try ((MainForm.PageControl1.Pages[0] as TMyTabSheet).Controls[1] as TExRichEdit).Font.Assign(CommonFont); except end;
     try Colors.Normal := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences\ChatColors', 'Normal'); except end;
     try Colors.MyText := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences\ChatColors', 'MyText'); except end;
     try Colors.AdminText := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences\ChatColors', 'AdminText'); except end;
@@ -403,6 +403,7 @@
     try Colors.MOTD := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences\ChatColors', 'MOTD'); except end;
     try Colors.SayEx := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences\ChatColors', 'SayEx'); except end;
     try Colors.Topic := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences\ChatColors', 'Topic'); except end;
+    try Colors.OldMsgs := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences\ChatColors', 'OldMsgs'); except end;
     try Colors.ClientAway := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences\OtherColors', 'ClientAway'); except end;
     try Colors.MapModUnavailable := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences\OtherColors', 'MapModUnavailable'); except end;
     try Colors.BotText := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences\OtherColors', 'BotText'); except end;
@@ -689,6 +690,7 @@
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences\ChatColors', 'MOTD', rdInteger, Colors.MOTD);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences\ChatColors', 'SayEx', rdInteger, Colors.SayEx);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences\ChatColors', 'Topic', rdInteger, Colors.Topic);
+    Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences\ChatColors', 'OldMsgs', rdInteger, Colors.OldMsgs);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences\OtherColors', 'ClientAway', rdInteger, Colors.ClientAway);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences\OtherColors', 'MapModUnavailable', rdInteger, Colors.MapModUnavailable);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences\OtherColors', 'BotText', rdInteger, Colors.BotText);

Modified: trunk/Lobby/TASClient/ReplaysUnit.dfm
===================================================================
--- trunk/Lobby/TASClient/ReplaysUnit.dfm	2008-09-08 10:12:58 UTC (rev 6388)
+++ trunk/Lobby/TASClient/ReplaysUnit.dfm	2008-09-08 17:55:44 UTC (rev 6389)
@@ -1,6 +1,6 @@
 object ReplaysForm: TReplaysForm
-  Left = 609
-  Top = 235
+  Left = 875
+  Top = 194
   Width = 809
   Height = 640
   Caption = 'Replays'
@@ -133,7 +133,7 @@
         231)
       object SpTBXLabel1: TSpTBXLabel
         Left = 0
-        Top = 152
+        Top = 176
         Width = 32
         Height = 13
         Caption = 'Grade:'
@@ -145,7 +145,7 @@
       end
       object GradeComboBox: TSpTBXComboBox
         Left = 0
-        Top = 168
+        Top = 192
         Width = 97
         Height = 21
         Style = csDropDownList
@@ -543,7 +543,7 @@
       end
       object DownloadButton: TSpTBXButton
         Left = 0
-        Top = 126
+        Top = 150
         Width = 97
         Height = 22
         Caption = 'Dowload replays'
@@ -557,13 +557,12 @@
       end
       object UploadButton: TSpTBXButton
         Left = 0
-        Top = 203
+        Top = 126
         Width = 97
         Height = 22
         Caption = 'Upload'
         Enabled = False
         TabOrder = 7
-        Visible = False
         OnClick = UploadButtonClick
         LinkFont.Charset = DEFAULT_CHARSET
         LinkFont.Color = clBlue

Modified: trunk/Lobby/TASClient/ReplaysUnit.pas
===================================================================
--- trunk/Lobby/TASClient/ReplaysUnit.pas	2008-09-08 10:12:58 UTC (rev 6388)
+++ trunk/Lobby/TASClient/ReplaysUnit.pas	2008-09-08 17:55:44 UTC (rev 6389)
@@ -1162,32 +1162,14 @@
 procedure TReplaysForm.UploadButtonClick(Sender: TObject);
 var
   i,j:integer;
-  teamCount : array[0..15] of integer;
   Replay: TReplay;
 begin
-  { disable while the replay site is down
   Replay := GetReplayFromNode(VDTReplays.FocusedNode);
-  for i:=0 to 15 do
-    teamCount[i] := 0;
+  UploadReplayForm.AutoUpload := False;
   UploadReplayForm.FileName := Replay.FullFileName;
   UploadReplayForm.MapName := Copy(Replay.Script.ReadKeyValue('GAME/mapname'),0,Length(Replay.Script.ReadKeyValue('GAME/mapname'))-4);
   UploadReplayForm.ModName := Copy(Replay.Script.ReadKeyValue('GAME/gametype'),0,Length(Replay.Script.ReadKeyValue('GAME/mapname'))-4);
-  i := Pos('AllyTeam=',ScriptRichEdit.Text);
-  while i &gt; 0 do begin
-    i := i+9;
-    j := PosEx(';',ScriptRichEdit.Text,i);
-    Inc(teamCount[StrToInt(Copy(ScriptRichEdit.Text,i,j-i))]);
-    i := PosEx('AllyTeam=',ScriptRichEdit.Text,i);
-  end;
-  UploadReplayForm.NbPlayers := '';
-  for i:= 0 to 15 do
-    if teamCount[i] &gt; 0 then
-      if UploadReplayForm.NbPlayers = '' then
-        UploadReplayForm.NbPlayers := IntToStr(teamCount[i])
-      else
-        UploadReplayForm.NbPlayers := UploadReplayForm.NbPlayers + 'v' + IntToStr(teamCount[i]);
   UploadReplayForm.ShowModal;
-  }
 end;
 
 function TReplaysForm.GetReplayFromNode(Node: PVirtualNode): TReplay;
@@ -1397,8 +1379,9 @@
   VDTReplays.SortTree(VDTReplays.Header.SortColumn,VDTReplays.Header.SortDirection);
 
   RenameButton.Enabled := ReplayList.Count &gt; 0;
-  DeleteButton.Enabled := ReplayList.Count &gt; 0;
-  GradeComboBox.Enabled := ReplayList.Count &gt; 0;
+  DeleteButton.Enabled := RenameButton.Enabled;
+  GradeComboBox.Enabled := RenameButton.Enabled;
+  UploadButton.Enabled := RenameButton.Enabled;
 
   ReplaysForm.VDTReplays.FocusedNode := ReplaysForm.VDTReplays.GetFirst;
   ReplaysForm.VDTReplays.Selected[ReplaysForm.VDTReplays.FocusedNode] := true;
@@ -1420,7 +1403,9 @@
     SaveButton.Enabled := False;
   end
   else
-    SaveButton.Enabled := true;
+  begin
+    SaveButton.Enabled := True;
+  end;
 end;
 
 procedure TReplaysForm.VDTReplaysClick(Sender: TObject);

Modified: trunk/Lobby/TASClient/TASClient.dof
===================================================================
--- trunk/Lobby/TASClient/TASClient.dof	2008-09-08 10:12:58 UTC (rev 6388)
+++ trunk/Lobby/TASClient/TASClient.dof	2008-09-08 17:55:44 UTC (rev 6389)
@@ -115,7 +115,7 @@
 MajorVer=0
 MinorVer=3
 Release=0
-Build=455
+Build=456
 Debug=0
 PreRelease=0
 Special=0
@@ -126,7 +126,7 @@
 [Version Info Keys]
 CompanyName=
 FileDescription=TA Spring lobby client
-FileVersion=0.3.0.455
+FileVersion=0.3.0.456
 InternalName=
 LegalCopyright=
 LegalTrademarks=

Modified: trunk/Lobby/TASClient/TASClient.res
===================================================================
(Binary files differ)

Modified: trunk/Lobby/TASClient/UploadReplayUnit.dfm
===================================================================
--- trunk/Lobby/TASClient/UploadReplayUnit.dfm	2008-09-08 10:12:58 UTC (rev 6388)
+++ trunk/Lobby/TASClient/UploadReplayUnit.dfm	2008-09-08 17:55:44 UTC (rev 6389)
@@ -1,9 +1,10 @@
 object UploadReplayForm: TUploadReplayForm
-  Left = 586
-  Top = 410
-  Width = 410
-  Height = 307
+  Left = 498
+  Top = 230
+  BorderStyle = bsDialog
   Caption = 'UploadReplayForm'
+  ClientHeight = 345
+  ClientWidth = 407
   Color = clBtnFace
   Constraints.MaxHeight = 1000
   Constraints.MaxWidth = 1680
@@ -16,64 +17,107 @@
   Position = poScreenCenter
   Scaled = False
   OnActivate = FormActivate
+  OnCreate = FormCreate
   PixelsPerInch = 96
   TextHeight = 13
   object SpTBXTitleBar1: TSpTBXTitleBar
     Left = 0
     Top = 0
-    Width = 402
-    Height = 280
+    Width = 407
+    Height = 345
     Caption = 'Upload replay'
     Options.Maximize = False
-    object SpTBXLabel2: TSpTBXLabel
+    object SpTBXGroupBox1: TSpTBXGroupBox
       Left = 16
       Top = 40
-      Width = 59
-      Height = 13
-      Caption = 'Description :'
-      LinkFont.Charset = DEFAULT_CHARSET
-      LinkFont.Color = clBlue
-      LinkFont.Height = -11
-      LinkFont.Name = 'MS Sans Serif'
-      LinkFont.Style = [fsUnderline]
+      Width = 377
+      Height = 233
+      Caption = 'Upload Description'
+      TabOrder = 1
+      object DescriptionRtBox: TRichEdit
+        Left = 8
+        Top = 24
+        Width = 361
+        Height = 201
+        Lines.Strings = (
+          'DescriptionRtBox')
+        TabOrder = 0
+      end
     end
-    object CancelButton: TSpTBXButton
-      Left = 213
-      Top = 240
-      Width = 73
-      Height = 25
-      Caption = 'Cancel'
+    object SpTBXGroupBox2: TSpTBXGroupBox
+      Left = 16
+      Top = 280
+      Width = 377
+      Height = 49
+      Caption = 'Action'
+      Font.Charset = DEFAULT_CHARSET
+      Font.Color = clWindowText
+      Font.Height = -11
+      Font.Name = 'MS Sans Serif'
+      Font.Style = [fsBold]
+      ParentFont = False
       TabOrder = 2
-      OnClick = CancelButtonClick
-      LinkFont.Charset = DEFAULT_CHARSET
-      LinkFont.Color = clBlue
-      LinkFont.Height = -11
-      LinkFont.Name = 'MS Sans Serif'
-      LinkFont.Style = [fsUnderline]
+      object UploadButton: TSpTBXButton
+        Left = 40
+        Top = 16
+        Width = 89
+        Height = 25
+        Caption = 'Upload &amp;&amp; Keep'
+        Font.Charset = DEFAULT_CHARSET
+        Font.Color = clWindowText
+        Font.Height = -11
+        Font.Name = 'MS Sans Serif'
+        Font.Style = []
+        ParentFont = False
+        TabOrder = 0
+        OnClick = UploadButtonClick
+        LinkFont.Charset = DEFAULT_CHARSET
+        LinkFont.Color = clBlue
+        LinkFont.Height = -11
+        LinkFont.Name = 'MS Sans Serif'
+        LinkFont.Style = [fsUnderline]
+      end
+      object CancelButton: TSpTBXButton
+        Left = 144
+        Top = 16
+        Width = 89
+        Height = 25
+        Caption = 'Keep'
+        Font.Charset = DEFAULT_CHARSET
+        Font.Color = clWindowText
+        Font.Height = -11
+        Font.Name = 'MS Sans Serif'
+        Font.Style = [fsBold]
+        ParentFont = False
+        TabOrder = 1
+        OnClick = CancelButtonClick
+        LinkFont.Charset = DEFAULT_CHARSET
+        LinkFont.Color = clBlue
+        LinkFont.Height = -11
+        LinkFont.Name = 'MS Sans Serif'
+        LinkFont.Style = [fsUnderline]
+      end
+      object DeleteButton: TSpTBXButton
+        Left = 248
+        Top = 16
+        Width = 89
+        Height = 25
+        Caption = 'Delete'
+        Font.Charset = DEFAULT_CHARSET
+        Font.Color = clWindowText
+        Font.Height = -11
+        Font.Name = 'MS Sans Serif'
+        Font.Style = []
+        ParentFont = False
+        TabOrder = 2
+        OnClick = DeleteButtonClick
+        LinkFont.Charset = DEFAULT_CHARSET
+        LinkFont.Color = clBlue
+        LinkFont.Height = -11
+        LinkFont.Name = 'MS Sans Serif'
+        LinkFont.Style = [fsUnderline]
+      end
     end
-    object UploadButton: TSpTBXButton
-      Left = 117
-      Top = 240
-      Width = 73
-      Height = 25
-      Caption = 'Upload'
-      TabOrder = 3
-      OnClick = UploadButtonClick
-      LinkFont.Charset = DEFAULT_CHARSET
-      LinkFont.Color = clBlue
-      LinkFont.Height = -11
-      LinkFont.Name = 'MS Sans Serif'
-      LinkFont.Style = [fsUnderline]
-    end
-    object DescriptionRtBox: TRichEdit
-      Left = 88
-      Top = 40
-      Width = 305
-      Height = 193
-      Lines.Strings = (
-        'DescriptionRtBox')
-      TabOrder = 4
-    end
   end
   object IdHTTP1: TIdHTTP
     MaxLineAction = maException

Modified: trunk/Lobby/TASClient/UploadReplayUnit.pas
===================================================================
--- trunk/Lobby/TASClient/UploadReplayUnit.pas	2008-09-08 10:12:58 UTC (rev 6388)
+++ trunk/Lobby/TASClient/UploadReplayUnit.pas	2008-09-08 17:55:44 UTC (rev 6389)
@@ -11,17 +11,21 @@
 type
   TUploadReplayForm = class(TForm)
     SpTBXTitleBar1: TSpTBXTitleBar;
-    SpTBXLabel2: TSpTBXLabel;
-    CancelButton: TSpTBXButton;
-    UploadButton: TSpTBXButton;
-    DescriptionRtBox: TRichEdit;
     IdHTTP1: TIdHTTP;
     IdAntiFreeze1: TIdAntiFreeze;
+    SpTBXGroupBox1: TSpTBXGroupBox;
+    DescriptionRtBox: TRichEdit;
+    SpTBXGroupBox2: TSpTBXGroupBox;
+    UploadButton: TSpTBXButton;
+    CancelButton: TSpTBXButton;
+    DeleteButton: TSpTBXButton;
     procedure UploadButtonClick(Sender: TObject);
     procedure IdHTTP1Work(Sender: TObject; AWorkMode: TWorkMode;
       const AWorkCount: Integer);
     procedure FormActivate(Sender: TObject);
     procedure CancelButtonClick(Sender: TObject);
+    procedure FormCreate(Sender: TObject);
+    procedure DeleteButtonClick(Sender: TObject);
   private
     { Private declarations }
   public
@@ -31,6 +35,7 @@
     ModName : string;
     NbPlayers : string;
     UploadedReplayId : string;
+    AutoUpload: boolean;
   end;
   TUploadThread = class(TTASClientThread)
   private
@@ -99,13 +104,13 @@
   Misc.ParseDelimited(ResponseStrList,ResponseStr,' ','');
   if (ResponseStrList.Count &gt; 0) and (ResponseStrList[0] = 'SUCCESS') then begin
     MessageDlgThread('Your replay has been successfully uploaded. Its link has been added to your clipboard.', mtInformation,[mbOk], 0);
-    //Clipboard.Open;
-    //Clipboard.SetTextBuf(PChar('<A HREF="http://replays.unknown-files.net/?">http://replays.unknown-files.net/?</A>'+ResponseStrList[1]));
-    //Clipboard.Close;
+    Clipboard.Open;
+    Clipboard.SetTextBuf(PChar(ResponseStrList[1]));
+    Clipboard.Close;
     UploadedReplayId := ResponseStrList[1];
   end
   else
-    MessageDlgThread(ResponseStr, mtError,[mbOk], 0);
+    MessageDlgThread('The upload failed. Contact TradeMark in the lobby to get help.', mtError,[mbOk], 0);
   PostMessage(Handle, WM_CLOSE, 0, 0); // close form
   end;
 end;
@@ -142,7 +147,21 @@
 
 procedure TUploadReplayForm.CancelButtonClick(Sender: TObject);
 begin
-  PostMessage(Handle, WM_CLOSE, 0, 0); // close form
+  Close;
 end;
 
+procedure TUploadReplayForm.FormCreate(Sender: TObject);
+begin
+  if not SpTBXTitleBar1.Active then
+    RemoveSpTBXTitleBarMarges(self);
+end;
+
+procedure TUploadReplayForm.DeleteButtonClick(Sender: TObject);
+begin
+  DeleteFile(FileName);
+  if not AutoUpload then
+    ReplaysForm.ReloadButtonClick(nil);
+  Close;
+end;
+
 end.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001158.html">[Taspring-linux-commit] r6388 - trunk/tools/SpringInstaller
</A></li>
	<LI>Next message: <A HREF="001160.html">[Taspring-linux-commit] r6390 - trunk/tools/unitsync
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1159">[ date ]</a>
              <a href="thread.html#1159">[ thread ]</a>
              <a href="subject.html#1159">[ subject ]</a>
              <a href="author.html#1159">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
