<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r6405 - trunk/Lobby/TASClient
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-September/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6405%20-%20trunk/Lobby/TASClient&In-Reply-To=%3C20080911161703.E24A849BD%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001174.html">
   <LINK REL="Next"  HREF="001176.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r6405 - trunk/Lobby/TASClient</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6405%20-%20trunk/Lobby/TASClient&In-Reply-To=%3C20080911161703.E24A849BD%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r6405 - trunk/Lobby/TASClient">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Thu Sep 11 18:17:03 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001174.html">[Taspring-linux-commit] r6404 - trunk/rts/lib/gml
</A></li>
        <LI>Next message: <A HREF="001176.html">[Taspring-linux-commit] r6406 - in trunk/rts: Game System/Sync
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1175">[ date ]</a>
              <a href="thread.html#1175">[ thread ]</a>
              <a href="subject.html#1175">[ subject ]</a>
              <a href="author.html#1175">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: satirik
Date: 2008-09-11 18:17:03 +0200 (Thu, 11 Sep 2008)
New Revision: 6405

Modified:
   trunk/Lobby/TASClient/MainUnit.dfm
   trunk/Lobby/TASClient/MainUnit.pas
   trunk/Lobby/TASClient/ManageGroups.dfm
   trunk/Lobby/TASClient/ManageGroups.pas
   trunk/Lobby/TASClient/PreferencesFormUnit.pas
   trunk/Lobby/TASClient/TASClient.dof
   trunk/Lobby/TASClient/TASClient.res
Log:
* group chat color option added

Modified: trunk/Lobby/TASClient/MainUnit.dfm
===================================================================
--- trunk/Lobby/TASClient/MainUnit.dfm	2008-09-10 23:46:41 UTC (rev 6404)
+++ trunk/Lobby/TASClient/MainUnit.dfm	2008-09-11 16:17:03 UTC (rev 6405)
@@ -1,6 +1,6 @@
 object MainForm: TMainForm
-  Left = 322
-  Top = 278
+  Left = 482
+  Top = 342
   Width = 773
   Height = 535
   Caption = '.'
@@ -552,7 +552,7 @@
                 object FilterList: TVirtualStringTree
                   Left = 424
                   Top = 8
-                  Width = 28
+                  Width = 145
                   Height = 129
                   Anchors = [akLeft, akTop, akRight]
                   CheckImageKind = ckSystem
@@ -873,7 +873,7 @@
                 object PresetListbox: TSpTBXListBox
                   Left = 152
                   Top = 26
-                  Width = 308
+                  Width = 417
                   Height = 113
                   Anchors = [akLeft, akTop, akRight]
                   ItemHeight = 16
@@ -2621,7 +2621,7 @@
     Left = 145
     Top = 295
     Bitmap = {
-      494C010103000400040020002000FFFFFFFFFF00FFFFFFFFFFFFFFFF424D3600
+      494C010103000400040020002000FFFFFFFFFF10FFFFFFFFFFFFFFFF424D3600
       0000000000003600000028000000800000002000000001002000000000000040
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
@@ -3153,7 +3153,8 @@
       F000000FF000000FF000000F00000000F800001FF800001FF800001F00000000
       FC00003FFC00003FFC00003F00000000FE00007FFE00007FFF00007F00000000
       FF8001FFFF8001FFFF8001FF00000000FFE007FFFFE007FFFFF007FF00000000
-      FFFFFFFFFFFFFFFFFFFFFFFF00000000}
+      FFFFFFFFFFFFFFFFFFFFFFFF0000000000000000000000000000000000000000
+      000000000000}
   end
   object Socket: TWSocket
     LineMode = False

Modified: trunk/Lobby/TASClient/MainUnit.pas
===================================================================
--- trunk/Lobby/TASClient/MainUnit.pas	2008-09-10 23:46:41 UTC (rev 6404)
+++ trunk/Lobby/TASClient/MainUnit.pas	2008-09-11 16:17:03 UTC (rev 6405)
@@ -524,7 +524,7 @@
 const
   VERSION_NUMBER = '0.38'; // Must be float value! (with a period as a decimal seperator)
   CHECK_BETA_LOBBY_URL = '<A HREF="http://tasclient.no-ip.org/TASClient_update_v2.txt">http://tasclient.no-ip.org/TASClient_update_v2.txt</A>';
-  PROGRAM_VERSION = 'TASClient ' + VERSION_NUMBER + ' RC19';
+  PROGRAM_VERSION = 'TASClient ' + VERSION_NUMBER + ' RC20';
   KEEP_ALIVE_INTERVAL = 10000; // in milliseconds. Tells us what should be the maximum &quot;silence&quot; time before we send a ping to the server.
   ASSUME_TIMEOUT_INTERVAL = 30000; // in milliseconds. Must be greater than KEEP_ALIVE_INTERVAL! If server hasn't send any data to us within this interval, then we assume timeout occured. It's us who must make sure we get constant replies from server by pinging it.
   LOCAL_TAB = '$Local'; // caption of main (command) tab window. Must be special so that is different from channel names or user names, that is why there is a &quot;$&quot; in front of it.
@@ -969,6 +969,8 @@
     NotifyOnBattleEnd : boolean;
     NotifyOnConnect : boolean;
     HighlightBattles : boolean;
+    EnableChatColor : boolean;
+    ChatColor : integer;
 
     constructor Create(Name: string; Color: Integer);
     destructor Destroy;
@@ -1158,7 +1160,8 @@
     procedure mnuManageGroupsClick(Sender: TObject);
     procedure mnuNewGroupClick(Sender: TObject);
     procedure AddToGroupItemClick(Sender: TObject);
-    procedure RefreshClientSort;
+    procedure ResortClientsLists;
+    procedure SortClientInLists(client: TClient);
     procedure ClientsListBoxClick(Sender: TObject);
     procedure mnuRemoveFromGroupClick(Sender: TObject);
     procedure mnuHelpClick(Sender: TObject);
@@ -2399,14 +2402,21 @@
 end;
 
 function TClient.GetChatTextColor: TColor;
+var
+  g : integer;
 begin
   if Self.Name = MainUnit.Status.Username then
     Result := Colors.MyText
   else
-    if Self.GetAccess then
+  begin
+    g := Self.GetGroup;
+    if (g &gt; -1) and TClientGroup(ClientGroups[g]).EnableChatColor then
+      Result := TClientGroup(ClientGroups[g]).ChatColor
+    else if Self.GetAccess then
       Result := Colors.AdminText
     else
       Result := Colors.Normal;
+  end;
 end;
 
 function TClient.isComSharing: Boolean;
@@ -8384,7 +8394,7 @@
   (Sender as TMenuItem).Checked := True;
   Preferences.SortStyle := (Sender as TMenuItem).Tag;
   SortLabel.Caption := (Sender as TMenuItem).Caption;
-  RefreshClientSort;
+  ResortClientsLists;
 end;
 
 procedure TMainForm.VDTBattlesGetHintSize(Sender: TBaseVirtualTree;
@@ -8584,7 +8594,7 @@
   begin
     (Items[Items.IndexOf(AutoScroll1)] as TSpTBXItem).Visible := RunningUnderWine;
     (Items[Items.IndexOf(AutoScroll1)] as TSpTBXItem).Checked := (PageControl1.ActivePage as TMyTabSheet).AutoScroll;
-    (Items[Items.IndexOf(AutoJoin1)] as TSpTBXItem).Visible := (PageControl1.ActivePage.Caption &lt;&gt; '$Local') and (PageControl1.ActivePage.Caption &lt;&gt; '#main') and (LeftStr(PageControl1.ActivePage.Caption,1) = '#');
+    (Items[Items.IndexOf(AutoJoin1)] as TSpTBXItem).Visible := (PageControl1.ActivePage.Caption &lt;&gt; LOCAL_TAB) and (PageControl1.ActivePage.Caption &lt;&gt; '#main') and (LeftStr(PageControl1.ActivePage.Caption,1) = '#');
     (Items[Items.IndexOf(AutoJoin1)] as TSpTBXItem).Checked := True;
     for i:=0 to PerformForm.CommandsListBox.Count-1 do
       if (AnsiUpperCase(PerformForm.CommandsListBox.Items[i]) = '/J '+AnsiUpperCase(PageControl1.ActivePage.Caption)) or (AnsiUpperCase(PerformForm.CommandsListBox.Items[i]) = '/JOIN '+AnsiUpperCase(PageControl1.ActivePage.Caption)) then
@@ -8835,6 +8845,8 @@
   Self.NotifyOnJoin := False;
   Self.NotifyOnBattleEnd := False;
   Self.NotifyOnConnect := False;
+  Self.EnableChatColor := False;
+  Self.ChatColor := Color;
 end;
 
 destructor TClientGroup.Destroy;
@@ -8873,7 +8885,7 @@
     group := TClientGroup.Create(InputString,InputColor('Choose a group highlight color ...',clWhite));
     group.Clients.Add(SelectedUserName);
     ClientGroups.Add(group);
-    RefreshClientSort;
+    SortClientInLists(Client);
     group.GroupUpdated;
   end;
 end;
@@ -8891,11 +8903,11 @@
     TClientGroup(ClientGroups[Client.GetGroup]).Clients.Delete(TClientGroup(ClientGroups[Client.GetGroup]).Clients.IndexOf(Client.Name));
 
   TClientGroup(ClientGroups[(Sender as TSpTBXItem).Tag]).Clients.Add(SelectedUserName);
-  RefreshClientSort;
+  SortClientInLists(Client);;
   TClientGroup(ClientGroups[(Sender as TSpTBXItem).Tag]).GroupUpdated;
 end;
 
-procedure TMainForm.RefreshClientSort;
+procedure TMainForm.ResortClientsLists;
 var
   i:integer;
 begin
@@ -8906,6 +8918,17 @@
   UpdateClientsListBox;
 end;
 
+procedure TMainForm.SortClientInLists(client: TClient);
+var
+  i:integer;
+begin
+  if Preferences.SortLocal then
+    SortClientInList(client,AllClients, Preferences.SortStyle);
+  for i := 1 {start from 1 to skip LOCAL_TAB} to PageControl1.PageCount-1 do
+    SortClientInList(client,(PageControl1.Pages[i] as TMyTabSheet).Clients, Preferences.SortStyle);
+  UpdateClientsListBox;
+end;
+
 procedure TMainForm.ClientsListBoxClick(Sender: TObject);
 begin
   ClientsListBox.Refresh;
@@ -8921,7 +8944,7 @@
   Client := GetClient(SelectedUserName);
   g := TClientGroup(ClientGroups[Client.GetGroup]);
   g.Clients.Delete(TClientGroup(ClientGroups[Client.GetGroup]).Clients.IndexOf(Client.Name));
-  RefreshClientSort;
+  SortClientInLists(Client);
   MainForm.ClientsListBox.Refresh;
   g.GroupUpdated;
 end;
@@ -8947,6 +8970,8 @@
       Ini.WriteString(IntToStr(i), 'NotifyOnBattleEnd', BoolToStr(TClientGroup(ClientGroups[i]).NotifyOnBattleEnd));
       Ini.WriteString(IntToStr(i), 'NotifyOnConnect', BoolToStr(TClientGroup(ClientGroups[i]).NotifyOnConnect));
       Ini.WriteString(IntToStr(i), 'HighlightBattles', BoolToStr(TClientGroup(ClientGroups[i]).HighlightBattles));
+      Ini.WriteString(IntToStr(i), 'EnableChatColor', BoolToStr(TClientGroup(ClientGroups[i]).EnableChatColor));
+      Ini.WriteString(IntToStr(i), 'ChatColor', IntToStr(TClientGroup(ClientGroups[i]).ChatColor));
       Ini.WriteString(IntToStr(i), 'Clients', Misc.JoinStringList(TClientGroup(ClientGroups[i]).Clients,' '));
     end;
     Ini.Free;
@@ -8978,6 +9003,8 @@
     cg.NotifyOnBattleEnd := StrToBool(Ini.ReadString(IntToStr(i), 'NotifyOnBattleEnd', '0'));
     cg.NotifyOnConnect := StrToBool(Ini.ReadString(IntToStr(i), 'NotifyOnConnect', '0'));
     cg.HighlightBattles := StrToBool(Ini.ReadString(IntToStr(i), 'HighlightBattles', '0'));
+    cg.EnableChatColor := StrToBool(Ini.ReadString(IntToStr(i), 'EnableChatColor', '0'));
+    cg.ChatColor := StrToInt(Ini.ReadString(IntToStr(i), 'ChatColor', '0'));
     Misc.ParseDelimited(cg.Clients,Ini.ReadString(IntToStr(i), 'Clients', 'Empty'),' ','');
     ClientGroups.Add(cg);
     i := i+1;

Modified: trunk/Lobby/TASClient/ManageGroups.dfm
===================================================================
--- trunk/Lobby/TASClient/ManageGroups.dfm	2008-09-10 23:46:41 UTC (rev 6404)
+++ trunk/Lobby/TASClient/ManageGroups.dfm	2008-09-11 16:17:03 UTC (rev 6405)
@@ -1,8 +1,8 @@
 object ManageGroupsForm: TManageGroupsForm
-  Left = 871
-  Top = 171
+  Left = 1117
+  Top = 302
   BorderStyle = bsDialog
-  Caption = 'ManageGroupsForm'
+  Caption = 'Manage groups'
   ClientHeight = 374
   ClientWidth = 473
   Color = clBtnFace
@@ -328,6 +328,53 @@
         TabOrder = 18
         OnClick = HighlightBattlesCheckboxClick
       end
+      object SpTBXLabel10: TSpTBXLabel
+        Left = 8
+        Top = 224
+        Width = 54
+        Height = 13
+        Caption = 'Chat color :'
+        LinkFont.Charset = DEFAULT_CHARSET
+        LinkFont.Color = clBlue
+        LinkFont.Height = -11
+        LinkFont.Name = 'MS Sans Serif'
+        LinkFont.Style = [fsUnderline]
+      end
+      object ChatColorPanel: TPanel
+        Left = 144
+        Top = 222
+        Width = 41
+        Height = 21
+        Anchors = [akTop, akRight]
+        BevelOuter = bvNone
+        BorderStyle = bsSingle
+        Color = clBlack
+        TabOrder = 20
+      end
+      object btChooseChatColor: TSpTBXButton
+        Left = 192
+        Top = 222
+        Width = 25
+        Height = 20
+        Caption = '...'
+        Anchors = [akTop, akRight]
+        TabOrder = 21
+        OnClick = btChooseChatColorClick
+        LinkFont.Charset = DEFAULT_CHARSET
+        LinkFont.Color = clBlue
+        LinkFont.Height = -11
+        LinkFont.Name = 'MS Sans Serif'
+        LinkFont.Style = [fsUnderline]
+        ThemeType = thtTBX
+      end
+      object ChatColorCheckBox: TSpTBXCheckBox
+        Left = 120
+        Top = 224
+        Width = 14
+        Height = 15
+        TabOrder = 22
+        OnClick = ChatColorCheckBoxClick
+      end
     end
   end
 end

Modified: trunk/Lobby/TASClient/ManageGroups.pas
===================================================================
--- trunk/Lobby/TASClient/ManageGroups.pas	2008-09-10 23:46:41 UTC (rev 6404)
+++ trunk/Lobby/TASClient/ManageGroups.pas	2008-09-11 16:17:03 UTC (rev 6405)
@@ -37,6 +37,10 @@
     SpTBXLabel9: TSpTBXLabel;
     HighlightBattlesCheckbox: TSpTBXCheckBox;
     btAddPlayer: TSpTBXButton;
+    SpTBXLabel10: TSpTBXLabel;
+    ChatColorPanel: TPanel;
+    btChooseChatColor: TSpTBXButton;
+    ChatColorCheckBox: TSpTBXCheckBox;
     procedure FormShow(Sender: TObject);
     procedure cmbGroupsChange(Sender: TObject);
     procedure btRemoveClick(Sender: TObject);
@@ -55,6 +59,8 @@
     procedure HighlightBattlesCheckboxClick(Sender: TObject);
     procedure btAddPlayerClick(Sender: TObject);
     procedure FormClose(Sender: TObject; var Action: TCloseAction);
+    procedure ChatColorCheckBoxClick(Sender: TObject);
+    procedure btChooseChatColorClick(Sender: TObject);
   private
     { Private declarations }
   public
@@ -73,10 +79,25 @@
 procedure TManageGroupsForm.FormShow(Sender: TObject);
 var
   i:Integer;
+  client: TClient;
+  g : integer;
 begin
   cmbGroups.Clear;
   for i:=0 to ClientGroups.Count-1 do
     cmbGroups.Items.Add(TClientGroup(ClientGroups[i]).Name);
+
+  client := MainForm.GetClient(SelectedUserName);
+  if client &lt;&gt; nil then
+  begin
+    g := client.GetGroup;
+    if g &gt; -1 then
+    begin
+      cmbGroups.ItemIndex := g;
+      cmbGroupsChange(Sender);
+      Exit
+    end;
+  end;
+
   if cmbGroups.Items.Count &gt; 0 then
     cmbGroups.ItemIndex := 0;
   cmbGroupsChange(Sender);
@@ -98,6 +119,8 @@
   NotifyOnBattlEndCheckBox.Checked := TClientGroup(ClientGroups[cmbGroups.ItemIndex]).NotifyOnBattleEnd;
   NotifyOnConnectCheckBox.Checked := TClientGroup(ClientGroups[cmbGroups.ItemIndex]).NotifyOnConnect;
   HighlightBattlesCheckbox.Checked := TClientGroup(ClientGroups[cmbGroups.ItemIndex]).HighlightBattles;
+  ChatColorCheckBox.Checked := TClientGroup(ClientGroups[cmbGroups.ItemIndex]).EnableChatColor;
+  ChatColorPanel.Color := TClientGroup(ClientGroups[cmbGroups.ItemIndex]).ChatColor;
 end;
 
 procedure TManageGroupsForm.btRemoveClick(Sender: TObject);
@@ -111,7 +134,7 @@
     lstClients.Items.Delete(i);
   end;
   MainForm.SaveGroups;
-  MainForm.ClientsListBox.Refresh;
+  MainForm.ResortClientsLists;
 end;
 
 procedure TManageGroupsForm.btRenameClick(Sender: TObject);
@@ -134,7 +157,7 @@
 begin
   ColorPanel.Color := InputColor('Choose a group color ...',ColorPanel.Color);
   TClientGroup(ClientGroups[cmbGroups.ItemIndex]).Color := ColorPanel.Color;
-  MainForm.ClientsListBox.Refresh;
+  MainForm.UpdateClientsListBox;
 end;
 
 procedure TManageGroupsForm.btRemoveGroupClick(Sender: TObject);
@@ -152,6 +175,7 @@
   end;
   cmbGroups.ItemIndex := 0;
   cmbGroupsChange(Sender);
+  MainForm.ResortClientsLists;
 end;
 
 procedure TManageGroupsForm.txtNameChange(Sender: TObject);
@@ -214,6 +238,7 @@
 procedure TManageGroupsForm.btAddPlayerClick(Sender: TObject);
 var
   InputString: string;
+  client: TClient;
 begin
   InputString := '';
   if InputQuery('New group ...', 'Enter the group name :', InputString) and (InputString &lt;&gt; '') then
@@ -221,6 +246,10 @@
     TClientGroup(ClientGroups[cmbGroups.ItemIndex]).Clients.Add(InputString);
     lstClients.Items.Add(InputString);
     lstClients.Refresh;
+
+    client := MainForm.GetClient(InputString);
+    if client &lt;&gt; nil then
+      MainForm.SortClientInLists(client);
   end;
 end;
 
@@ -232,4 +261,15 @@
   ReleaseMainThread;
 end;
 
+procedure TManageGroupsForm.ChatColorCheckBoxClick(Sender: TObject);
+begin
+  TClientGroup(ClientGroups[cmbGroups.ItemIndex]).EnableChatColor := ChatColorCheckBox.Checked;
+end;
+
+procedure TManageGroupsForm.btChooseChatColorClick(Sender: TObject);
+begin
+  ChatColorPanel.Color := InputColor('Choose a group color ...',ChatColorPanel.Color);
+  TClientGroup(ClientGroups[cmbGroups.ItemIndex]).ChatColor := ChatColorPanel.Color;
+end;
+
 end.

Modified: trunk/Lobby/TASClient/PreferencesFormUnit.pas
===================================================================
--- trunk/Lobby/TASClient/PreferencesFormUnit.pas	2008-09-10 23:46:41 UTC (rev 6404)
+++ trunk/Lobby/TASClient/PreferencesFormUnit.pas	2008-09-11 16:17:03 UTC (rev 6405)
@@ -1052,7 +1052,7 @@
     UpdatePreferencesTo(Preferences); // save changes to p
     UpdatePreferencesFrom(Preferences); // update changes from p
     if Preferences.SortLocal then
-      MainForm.RefreshClientSort;
+      MainForm.ResortClientsLists;
     if Preferences.EnableSpringDownloader &lt;&gt; oldPref.EnableSpringDownloader then
       if Preferences.EnableSpringDownloader then
         StartSpringDownloader

Modified: trunk/Lobby/TASClient/TASClient.dof
===================================================================
--- trunk/Lobby/TASClient/TASClient.dof	2008-09-10 23:46:41 UTC (rev 6404)
+++ trunk/Lobby/TASClient/TASClient.dof	2008-09-11 16:17:03 UTC (rev 6405)
@@ -115,7 +115,7 @@
 MajorVer=0
 MinorVer=3
 Release=0
-Build=457
+Build=459
 Debug=0
 PreRelease=0
 Special=0
@@ -126,7 +126,7 @@
 [Version Info Keys]
 CompanyName=
 FileDescription=TA Spring lobby client
-FileVersion=0.3.0.457
+FileVersion=0.3.0.459
 InternalName=
 LegalCopyright=
 LegalTrademarks=

Modified: trunk/Lobby/TASClient/TASClient.res
===================================================================
(Binary files differ)


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001174.html">[Taspring-linux-commit] r6404 - trunk/rts/lib/gml
</A></li>
	<LI>Next message: <A HREF="001176.html">[Taspring-linux-commit] r6406 - in trunk/rts: Game System/Sync
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1175">[ date ]</a>
              <a href="thread.html#1175">[ thread ]</a>
              <a href="subject.html#1175">[ subject ]</a>
              <a href="author.html#1175">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
