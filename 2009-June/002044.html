<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r7275 - Lobby/TASClient
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2009-June/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r7275%20-%20Lobby/TASClient&In-Reply-To=%3C20090621000152.B350E3B7F0%40it-l.eu%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002043.html">
   <LINK REL="Next"  HREF="002045.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r7275 - Lobby/TASClient</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r7275%20-%20Lobby/TASClient&In-Reply-To=%3C20090621000152.B350E3B7F0%40it-l.eu%3E"
       TITLE="[Taspring-linux-commit] r7275 - Lobby/TASClient">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Sun Jun 21 02:01:52 CEST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="002043.html">[Taspring-linux-commit] r7274 - Lobby/TASClient
</A></li>
        <LI>Next message: <A HREF="002045.html">[Taspring-linux-commit] r7276 - Lobby/TASClient
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2044">[ date ]</a>
              <a href="thread.html#2044">[ thread ]</a>
              <a href="subject.html#2044">[ subject ]</a>
              <a href="author.html#2044">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: satirik
Date: 2009-06-21 02:01:50 +0200 (Sun, 21 Jun 2009)
New Revision: 7275

Modified:
   Lobby/TASClient/BattleFormUnit.dfm
   Lobby/TASClient/BattleFormUnit.pas
   Lobby/TASClient/MainUnit.dfm
   Lobby/TASClient/MainUnit.pas
   Lobby/TASClient/MapListFormUnit.dfm
   Lobby/TASClient/MapListFormUnit.pas
   Lobby/TASClient/MenuFormUnit.pas
   Lobby/TASClient/PreferencesFormUnit.dfm
   Lobby/TASClient/PreferencesFormUnit.pas
   Lobby/TASClient/ReplaysUnit.dfm
   Lobby/TASClient/ReplaysUnit.pas
   Lobby/TASClient/TASClient.dof
   Lobby/TASClient/TASClient.dpr
   Lobby/TASClient/TASClient.res
   Lobby/TASClient/Utility.pas
Log:
* 'disable minimaps and maps info loading at start' option added (disable the map list window too), disabled by default
* 'load metal and height minimaps' option added, disabled by default (changing map should be a lot faster)
* SP form not loaded in normal mode

Modified: Lobby/TASClient/BattleFormUnit.dfm
===================================================================
--- Lobby/TASClient/BattleFormUnit.dfm	2009-06-20 19:55:37 UTC (rev 7274)
+++ Lobby/TASClient/BattleFormUnit.dfm	2009-06-21 00:01:50 UTC (rev 7275)
@@ -4058,6 +4058,7 @@
         SelectedInOut = False
         PlainRTF = False
         UndoLimit = 0
+        AllowInPlace = False
       end
       object InputEdit: TTntMemo
         Left = 264

Modified: Lobby/TASClient/BattleFormUnit.pas
===================================================================
--- Lobby/TASClient/BattleFormUnit.pas	2009-06-20 19:55:37 UTC (rev 7274)
+++ Lobby/TASClient/BattleFormUnit.pas	2009-06-21 00:01:50 UTC (rev 7275)
@@ -1244,66 +1244,76 @@
     Exit; // no need to change anything, we already have this map loaded!
   end;
 
-  TMapItem(MapListForm.Maps[MapIndex]).LoadMinimap(False);
-
+  TMapItem(MapListForm.Maps[MapIndex]).LoadMapInfo;
   Utility.LoadMiniMap(TMapItem(MapListForm.Maps[MapIndex]).MapName,MapImage.Picture.Bitmap);
+  TMapItem(MapListForm.Maps[MapIndex]).LoadMinimap(False,MapImage.Picture.Bitmap);
 
   // load height map in the corresponding TImage
-  try
-    MapHeight := Utility.getHeightMap(Utility.MapList[MapIndex],MapHeightWidth,MapHeightHeight);
-  except
-    MapHeightWidth := 64;
-    MapHeightHeight := 64;
-    SetLength(MapHeight,MapHeightWidth*MapHeightHeight);
-  end;
-  HeightMapImage.Picture.Graphic.Width := MapHeightWidth;
-  HeightMapImage.Picture.Graphic.Height := MapHeightHeight;
-  HeightMapImage.Picture.Bitmap.PixelFormat := pf24bit;
+  if Preferences.LoadMetalHeightMinimaps then
+  begin
+    try
+      MapHeight := Utility.getHeightMap(Utility.MapList[MapIndex],MapHeightWidth,MapHeightHeight);
+    except
+      MapHeightWidth := 64;
+      MapHeightHeight := 64;
+      SetLength(MapHeight,MapHeightWidth*MapHeightHeight);
+    end;
+    HeightMapImage.Picture.Graphic.Width := MapHeightWidth;
+    HeightMapImage.Picture.Graphic.Height := MapHeightHeight;
+    HeightMapImage.Picture.Bitmap.PixelFormat := pf24bit;
 
-  for j:=0 to MapHeightHeight-1 do
-  begin
-    P := HeightMapImage.Picture.Bitmap.ScanLine[j];
-    for i:=0 to MapHeightWidth-1 do
+    for j:=0 to MapHeightHeight-1 do
     begin
-      v := Ord(MapHeight[j*MapHeightWidth+i]);
-      P[i*3] := v;
-      P[i*3+1] := v;
-      P[i*3+2] := v;
+      P := HeightMapImage.Picture.Bitmap.ScanLine[j];
+      for i:=0 to MapHeightWidth-1 do
+      begin
+        v := Ord(MapHeight[j*MapHeightWidth+i]);
+        P[i*3] := v;
+        P[i*3+1] := v;
+        P[i*3+2] := v;
+      end;
     end;
-  end;
 
-  HeightMapImage.Refresh;
+    HeightMapImage.Refresh;
 
-  // load the metal map in the corresponding TImage
-  try
-    MapMetal := Utility.getMetalMap(Utility.MapList[MapIndex],MapMetalWidth,MapMetalHeight);
-  except
-    MapMetalWidth := 64;
-    MapMetalHeight := 64;
-    SetLength(MapMetal,MapMetalWidth*MapMetalHeight);
-  end;
-  MetalMapImage.Picture.Graphic.Width := MapMetalWidth;
-  MetalMapImage.Picture.Graphic.Height := MapMetalHeight;
-  MetalMapImage.Picture.Bitmap.PixelFormat := pf24bit;
+    // load the metal map in the corresponding TImage
+    try
+      MapMetal := Utility.getMetalMap(Utility.MapList[MapIndex],MapMetalWidth,MapMetalHeight);
+    except
+      MapMetalWidth := 64;
+      MapMetalHeight := 64;
+      SetLength(MapMetal,MapMetalWidth*MapMetalHeight);
+    end;
+    MetalMapImage.Picture.Graphic.Width := MapMetalWidth;
+    MetalMapImage.Picture.Graphic.Height := MapMetalHeight;
+    MetalMapImage.Picture.Bitmap.PixelFormat := pf24bit;
 
-  for j:=0 to MapMetalHeight-1 do
-  begin
-    P := MetalMapImage.Picture.Bitmap.ScanLine[j];
-    for i:=0 to MapMetalWidth-1 do
+    for j:=0 to MapMetalHeight-1 do
     begin
-      v := Ord(MapMetal[j*MapMetalWidth+i]);
-      P[i*3] := 0;
-      P[i*3+1] := v;
-      P[i*3+2] := 0;
+      P := MetalMapImage.Picture.Bitmap.ScanLine[j];
+      for i:=0 to MapMetalWidth-1 do
+      begin
+        v := Ord(MapMetal[j*MapMetalWidth+i]);
+        P[i*3] := 0;
+        P[i*3+1] := v;
+        P[i*3+2] := 0;
+      end;
     end;
-  end;
 
-  MetalMapImage.Refresh;
+    MetalMapImage.Refresh;
 
-  // get the total amount of metal of that map
-  TotalMetal := 0;
-  for i:=1 to Length(MapMetal) do
-    TotalMetal := TotalMetal + Ord(MapMetal[i]);
+    // get the total amount of metal of that map
+    TotalMetal := 0;
+    for i:=1 to Length(MapMetal) do
+      TotalMetal := TotalMetal + Ord(MapMetal[i]);
+  end
+  else
+  begin
+    MetalMapImage.Canvas.Draw(0,0,NoMapImage.Picture.Bitmap);
+    MetalMapImage.Canvas.TextOut(0,Floor(MetalMapImage.Picture.Height/2-MetalMapImage.Canvas.TextHeight('M')/2),'Metal minimap loading disabled');
+    HeightMapImage.Canvas.Draw(0,0,NoMapImage.Picture.Bitmap);
+    HeightMapImage.Canvas.TextOut(0,Floor(HeightMapImage.Picture.Height/2-HeightMapImage.Canvas.TextHeight('M')/2),'Height minimap loading disabled');
+  end;
 
   MapInfo := GetMapItem(MapIndex).MapInfo;
 

Modified: Lobby/TASClient/MainUnit.dfm
===================================================================
--- Lobby/TASClient/MainUnit.dfm	2009-06-20 19:55:37 UTC (rev 7274)
+++ Lobby/TASClient/MainUnit.dfm	2009-06-21 00:01:50 UTC (rev 7275)
@@ -1,6 +1,6 @@
 object MainForm: TMainForm
-  Left = 221
-  Top = 92
+  Left = 220
+  Top = 119
   Width = 850
   Height = 538
   Caption = '.'

Modified: Lobby/TASClient/MainUnit.pas
===================================================================
--- Lobby/TASClient/MainUnit.pas	2009-06-20 19:55:37 UTC (rev 7274)
+++ Lobby/TASClient/MainUnit.pas	2009-06-21 00:01:50 UTC (rev 7275)
@@ -565,9 +565,9 @@
   );
 
 const
-  VERSION_NUMBER = '0.48'; // Must be float value! (with a period as a decimal seperator)
+  VERSION_NUMBER = '0.49'; // Must be float value! (with a period as a decimal seperator)
   CHECK_BETA_LOBBY_URL = '<A HREF="http://tasclient.no-ip.org/TASClient_update_v3.txt">http://tasclient.no-ip.org/TASClient_update_v3.txt</A>';
-  PROGRAM_VERSION = 'TASClient ' + VERSION_NUMBER;
+  PROGRAM_VERSION = 'TASClient ' + VERSION_NUMBER + ' beta';
   KEEP_ALIVE_INTERVAL = 10000; // in milliseconds. Tells us what should be the maximum &quot;silence&quot; time before we send a ping to the server.
   ASSUME_TIMEOUT_INTERVAL = 30000; // in milliseconds. Must be greater than KEEP_ALIVE_INTERVAL! If server hasn't send any data to us within this interval, then we assume timeout occured. It's us who must make sure we get constant replies from server by pinging it.
   LOCAL_TAB = '$Local'; // caption of main (command) tab window. Must be special so that is different from channel names or user names, that is why there is a &quot;$&quot; in front of it.
@@ -4057,7 +4057,7 @@
 
 
     // cache all minimaps if user chooses to do so:
-    if not MapListForm.AreAllMinimapsLoaded then
+    if not MapListForm.AreAllMinimapsLoaded and not Preferences.DisableMapDetailsLoading then
     begin
       if not SplashScreenForm.Active then
         FlashWindow(SplashScreenForm.Handle,True);
@@ -8560,7 +8560,7 @@
   SaveFiltersToFile(FILTERS_FOLDER + '\default.ini',CurrentFilters);
   AutoJoinForm.SaveAutoJoinPresetLists;
   ReplaysForm.SaveReplayFiltersToFile(REPLAY_FILTERS_FOLDER + '\default.ini');
-  if not RunningUnderWine then
+  if RunningWithMainMenu then
     MenuForm.SaveSettings;
   SaveGroups;
 
@@ -9183,7 +9183,8 @@
       begin
         with TMapItem(MapListForm.Maps[Utility.MapList.IndexOf(Battle.Map)]) do
         begin
-          Draw(10,10,MapImage.Picture.Bitmap);
+          if MapImage &lt;&gt; nil then
+            Draw(10,10,MapImage.Picture.Bitmap);
           Font.Style := [fsBold];
           TextOut(120, 10, MapName);
           Font.Style := [];

Modified: Lobby/TASClient/MapListFormUnit.dfm
===================================================================
--- Lobby/TASClient/MapListFormUnit.dfm	2009-06-20 19:55:37 UTC (rev 7274)
+++ Lobby/TASClient/MapListFormUnit.dfm	2009-06-21 00:01:50 UTC (rev 7275)
@@ -1,6 +1,6 @@
 object MapListForm: TMapListForm
-  Left = 189
-  Top = 147
+  Left = 522
+  Top = 175
   Width = 650
   Height = 400
   Caption = 'Map list'

Modified: Lobby/TASClient/MapListFormUnit.pas
===================================================================
--- Lobby/TASClient/MapListFormUnit.pas	2009-06-20 19:55:37 UTC (rev 7274)
+++ Lobby/TASClient/MapListFormUnit.pas	2009-06-21 00:01:50 UTC (rev 7275)
@@ -137,10 +137,10 @@
     AuthorCommentsRichEdit: TRichEdit;
     MyCommentsRichEdit: TRichEdit;
 
-    constructor Create(AOwner: TWinControl; X, Y: Integer; Index: Integer);
+    constructor Create(AOwner: TWinControl; X, Y: Integer; Index: Integer; noControl: boolean = false);
     destructor Destroy; override;
     procedure LoadMapInfo; // will automatically attempt to load it from cache, or else it will read it from the map file itself
-    function LoadMinimap(CacheOnly: Boolean): Boolean; // will automatically attempt to load it from cache, or else it will read it from the map file itself. If CacheOnly is true, then it will attempt to read map from the cache only and not also from the map file itfself in case if reading from cache fails.
+    function LoadMinimap(CacheOnly: Boolean; Bitmap: TBitmap = nil): Boolean; // will automatically attempt to load it from cache, or else it will read it from the map file itself. If CacheOnly is true, then it will attempt to read map from the cache only and not also from the map file itfself in case if reading from cache fails.
     procedure ApplyMapInfo(MapInfo: TMapInfo);
     procedure GradeButtonClick(Sender: TObject);
     procedure MyCommentsRichEditChange(Sender: TObject);
@@ -238,11 +238,11 @@
 
 procedure TMapListForm.AddMap;
 begin
-  Maps.Add(TMapItem.Create(ScrollBox1, 10, Maps.Count * MAP_ITEM_HEIGHT - ScrollBox1.VertScrollBar.Position, Maps.Count));
+  Maps.Add(TMapItem.Create(ScrollBox1, 10, Maps.Count * MAP_ITEM_HEIGHT - ScrollBox1.VertScrollBar.Position, Maps.Count,Preferences.DisableMapDetailsLoading));
   TotalMapsLabel.Caption := _('Total maps: ') + IntToStr(Maps.Count);
 end;
 
-constructor TMapItem.Create(AOwner: TWinControl; X, Y: Integer; Index: Integer);
+constructor TMapItem.Create(AOwner: TWinControl; X, Y: Integer; Index: Integer; noControl: boolean = false);
 var
   temp: TSpTBXTabItem;
 begin
@@ -257,6 +257,10 @@
   MapInfoLoaded := False;
   MapImageLoaded := False;
 
+  MainPanel := nil;
+
+  if noControl then Exit;
+
   MainPanel := TMapItemPanel.Create(AOwner);
   MainPanel.Left := X;
   MainPanel.Top := Y;
@@ -271,20 +275,7 @@
   MainPanel.ParentMapItem := Self;
   MainPanel.Parent := AOwner;
 
-  MapImage := TImage.Create(MainPanel);
-  MapImage.Left := 5;
-  MapImage.Top := 20;
-  MapImage.Width := 100;
-  MapImage.Height := 100;
-  MapImage.Picture.Bitmap.Width := 100;
-  MapImage.Picture.Bitmap.Height := 100;
-  MapImage.Stretch := False; // we will set 'Stretch' to true later when we'll load the actual minimap
-  MapImage.Canvas.StretchDraw(Rect(0, 0, MapImage.Width, MapImage.Height), MapListForm.NoPreviewImage.Picture.Bitmap);
-  MapImage.Transparent := False;
-  MapImage.AutoSize := False;
-  MapImage.OnMouseDown := MapImageMouseDown;
-  MapImage.OnMouseUp := MapImageMouseUp;
-  MapImage.Parent := MainPanel;
+  MapImage := nil;
 
   NameLabel := TLabel.Create(MainPanel);
   NameLabel.Caption := MapName;
@@ -497,16 +488,19 @@
       // read grade:
       Stream.ReadBuffer(i, SizeOf(i));
       MyGrade := i;
-      GradeButton.ImageIndex := i;
+      if MainPanel &lt;&gt; nil then
+        GradeButton.ImageIndex := i;
       // read global (public) grade and number of votes:
       Stream.ReadBuffer(GlobalGrade, SizeOf(GlobalGrade));
       Stream.ReadBuffer(TotalVotes, SizeOf(TotalVotes));
-      PublicGradeLabel.Caption := Format('%2.1f (%d votes)', [GlobalGrade, TotalVotes]);
+      if MainPanel &lt;&gt; nil then
+        PublicGradeLabel.Caption := Format('%2.1f (%d votes)', [GlobalGrade, TotalVotes]);
       // read comments:
       Stream.ReadBuffer(len, SizeOf(len));
       SetLength(s, len);
       Stream.ReadBuffer(s[1], len);
-      MyCommentsRichEdit.Text := s;
+      if MainPanel &lt;&gt; nil then
+        MyCommentsRichEdit.Text := s;
     except
       MainForm.AddMainLog('Error reading from cache: ' + Filename, Colors.Error);
       Exit;
@@ -548,7 +542,9 @@
     Stream.WriteBuffer(GlobalGrade, SizeOf(GlobalGrade));
     Stream.WriteBuffer(TotalVotes, SizeOf(TotalVotes));
     // write comments:
-    s := MyCommentsRichEdit.Text;
+    s := '';
+    if MainPanel &lt;&gt; nil then
+      s := MyCommentsRichEdit.Text;
     len := Length(s);
     Stream.WriteBuffer(len, SizeOf(len));
     Stream.WriteBuffer(s[1], Length(s));
@@ -617,27 +613,54 @@
     TryToWriteInfoToCache; // cache it
   end;
 
-  ApplyMapInfo(MapInfo);
+  if MainPanel &lt;&gt; nil then
+  begin
+    ApplyMapInfo(MapInfo);
 
-  NameLabel.Caption := Copy(MapName, 1, Length(MapName) - Length(ExtractFileExt(MapName))) + ' (Size: ' + IntToStr(MapInfo.Width div 64) + ' x ' + IntToStr(MapInfo.Height div 64) + ')';
+    NameLabel.Caption := Copy(MapName, 1, Length(MapName) - Length(ExtractFileExt(MapName))) + ' (Size: ' + IntToStr(MapInfo.Width div 64) + ' x ' + IntToStr(MapInfo.Height div 64) + ')';
 
-  GradeButton.Enabled := True; // user may now grade the map
+    GradeButton.Enabled := True; // user may now grade the map
+  end;
 
   MapInfoLoaded := True;
 end;
 
-function TMapItem.LoadMinimap(CacheOnly: Boolean): Boolean; // will automatically attempt to load it from cache, or else it will read it from the map file itself. If CacheOnly is true, then it will attempt to read map from the cache only and not also from the map file itfself in case if reading from cache fails.
+function TMapItem.LoadMinimap(CacheOnly: Boolean; Bitmap: TBitmap = nil): Boolean; // will automatically attempt to load it from cache, or else it will read it from the map file itself. If CacheOnly is true, then it will attempt to read map from the cache only and not also from the map file itfself in case if reading from cache fails.
 var
-  Bitmap: TBitmap;
+  localBitmap: boolean;
 begin
   Result := False;
+  localBitmap := true;
 
+  if MapImage = nil then
+  begin
+    MapImage := TImage.Create(MainPanel);
+    MapImage.Left := 5;
+    MapImage.Top := 20;
+    MapImage.Width := 100;
+    MapImage.Height := 100;
+    MapImage.Picture.Bitmap.Width := 100;
+    MapImage.Picture.Bitmap.Height := 100;
+    MapImage.Stretch := False; // we will set 'Stretch' to true later when we'll load the actual minimap
+    MapImage.Canvas.StretchDraw(Rect(0, 0, MapImage.Width, MapImage.Height), MapListForm.NoPreviewImage.Picture.Bitmap);
+    MapImage.Transparent := False;
+    MapImage.AutoSize := False;
+    MapImage.OnMouseDown := MapImageMouseDown;
+    MapImage.OnMouseUp := MapImageMouseUp;
+    MapImage.Parent := MainPanel;
+  end;
+
   if not TryToReadMapImageFromCache then
   begin
     if CacheOnly then Exit;
     // ok lets read the map info from the map file and cache it right afterwards:
-    Bitmap := TBitmap.Create;
-    Utility.LoadMiniMap(MapName, Bitmap);
+    if Bitmap = nil then
+    begin
+      Bitmap := TBitmap.Create;
+      Utility.LoadMiniMap(MapName, Bitmap);
+      localBitmap := false;
+    end;
+
     MapImage.Picture.Bitmap.Canvas.Brush.Color := clBlack;
     MapImage.Picture.Bitmap.Canvas.FillRect(MapImage.Picture.Bitmap.Canvas.ClipRect);
     if (Self.MapInfo.Height &gt; 0) and (Self.MapInfo.Width &gt; 0) then
@@ -653,7 +676,8 @@
       end;
 
     MapImage.Picture.Bitmap.Canvas.StretchDraw(Rect(0, 0, MapImage.Picture.Bitmap.Width, MapImage.Picture.Bitmap.Height), Bitmap);
-    Bitmap.Free;
+    if localBitmap then
+      Bitmap.Free;
 
     TryToWriteMapImageToCache; // cache it
   end;
@@ -1002,6 +1026,8 @@
   sl:TStrings;
   nbItemPerLine: integer;
 begin
+  if Preferences.DisableMapDetailsLoading then Exit;
+
   nbItemPerLine := Max(1,Floor(ScrollBox1.ClientWidth /  MAP_ITEM_WIDTH));
   j:=0;
   ScrollBox1.Visible := False;

Modified: Lobby/TASClient/MenuFormUnit.pas
===================================================================
--- Lobby/TASClient/MenuFormUnit.pas	2009-06-20 19:55:37 UTC (rev 7274)
+++ Lobby/TASClient/MenuFormUnit.pas	2009-06-21 00:01:50 UTC (rev 7275)
@@ -534,8 +534,6 @@
 
   LoadSettings;
 
-
-
   if MainUnit.RunningWithMainMenuDev then
     MenuCurrentPath := ExtractFilePath(Application.ExeName) + 'Interface\'
   else

Modified: Lobby/TASClient/PreferencesFormUnit.dfm
===================================================================
--- Lobby/TASClient/PreferencesFormUnit.dfm	2009-06-20 19:55:37 UTC (rev 7274)
+++ Lobby/TASClient/PreferencesFormUnit.dfm	2009-06-21 00:01:50 UTC (rev 7275)
@@ -3,7 +3,7 @@
   Top = 106
   BorderStyle = bsDialog
   Caption = 'Preferences'
-  ClientHeight = 462
+  ClientHeight = 483
   ClientWidth = 415
   Color = clBtnFace
   Constraints.MaxHeight = 750
@@ -25,7 +25,7 @@
     Left = 0
     Top = 0
     Width = 415
-    Height = 462
+    Height = 483
     Caption = 'Preferences'
     FixedSize = True
     Options.Minimize = False
@@ -35,14 +35,13 @@
       Left = 8
       Top = 64
       Width = 401
-      Height = 353
+      Height = 369
       Color = clBtnFace
-      ActiveTabIndex = 0
+      ActiveTabIndex = 3
       TabAutofit = True
       HiddenItems = &lt;&gt;
       object SpTBXTabItem6: TSpTBXTabItem
         Caption = 'Server'
-        Checked = True
         CustomWidth = 56
       end
       object SpTBXTabItem5: TSpTBXTabItem
@@ -55,6 +54,7 @@
       end
       object SpTBXTabItem3: TSpTBXTabItem
         Caption = 'Interface'
+        Checked = True
         CustomWidth = 56
       end
       object SpTBXTabItem2: TSpTBXTabItem
@@ -69,343 +69,11 @@
         Caption = 'Scripts'
         CustomWidth = 56
       end
-      object SpTBXTabSheet7: TSpTBXTabSheet
-        Left = 0
-        Top = 23
-        Width = 401
-        Height = 330
-        Caption = 'Scripts'
-        ImageIndex = -1
-        Item = SpTBXTabItem7
-        TabControl = SpTBXTabControl1
-        TabItem = 'SpTBXTabItem7'
-        object ScriptsDebugWindowBt: TSpTBXButton
-          Left = 132
-          Top = 56
-          Width = 137
-          Height = 25
-          Caption = 'Debug Window'
-          TabOrder = 0
-          OnClick = ScriptsDebugWindowBtClick
-          LinkFont.Charset = DEFAULT_CHARSET
-          LinkFont.Color = clBlue
-          LinkFont.Height = -11
-          LinkFont.Name = 'MS Sans Serif'
-          LinkFont.Style = [fsUnderline]
-        end
-        object ScriptsReloadBt: TSpTBXButton
-          Left = 132
-          Top = 88
-          Width = 137
-          Height = 25
-          Caption = 'Reload scripts'
-          TabOrder = 1
-          OnClick = ScriptsReloadBtClick
-          LinkFont.Charset = DEFAULT_CHARSET
-          LinkFont.Color = clBlue
-          LinkFont.Height = -11
-          LinkFont.Name = 'MS Sans Serif'
-          LinkFont.Style = [fsUnderline]
-        end
-        object ScriptsLoadNewBt: TSpTBXButton
-          Left = 132
-          Top = 120
-          Width = 137
-          Height = 25
-          Caption = 'Load new scripts'
-          TabOrder = 2
-          OnClick = ScriptsLoadNewBtClick
-          LinkFont.Charset = DEFAULT_CHARSET
-          LinkFont.Color = clBlue
-          LinkFont.Height = -11
-          LinkFont.Name = 'MS Sans Serif'
-          LinkFont.Style = [fsUnderline]
-        end
-        object ScriptsAdvancedOptionsBt: TSpTBXButton
-          Left = 132
-          Top = 152
-          Width = 137
-          Height = 25
-          Caption = 'Advanced options'
-          TabOrder = 3
-          Visible = False
-          OnClick = ScriptsAdvancedOptionsBtClick
-          LinkFont.Charset = DEFAULT_CHARSET
-          LinkFont.Color = clBlue
-          LinkFont.Height = -11
-          LinkFont.Name = 'MS Sans Serif'
-          LinkFont.Style = [fsUnderline]
-        end
-        object EnableScriptsCheckBox: TSpTBXCheckBox
-          Left = 104
-          Top = 24
-          Width = 193
-          Height = 15
-          Caption = 'Enable scripts BETA (requires restart)'
-          TabOrder = 4
-        end
-      end
-      object SpTBXTabSheet1: TSpTBXTabSheet
-        Left = 0
-        Top = 23
-        Width = 401
-        Height = 330
-        Caption = 'Skins'
-        ImageIndex = -1
-        Item = SpTBXTabItem1
-        TabControl = SpTBXTabControl1
-        TabItem = 'SpTBXTabItem1'
-        object GroupBox5: TSpTBXGroupBox
-          Left = 16
-          Top = 8
-          Width = 361
-          Height = 305
-          Caption = 'Skin manager'
-          Color = clNone
-          ParentColor = False
-          TabOrder = 0
-          object ThemesComboBox: TSpTBXComboBox
-            Left = 48
-            Top = 144
-            Width = 177
-            Height = 21
-            Style = csDropDownList
-            ItemHeight = 13
-            TabOrder = 0
-            OnChange = ThemesComboBoxChange
-          end
-          object SpTBXRadioButton1: TSpTBXRadioButton
-            Left = 48
-            Top = 56
-            Width = 44
-            Height = 15
-            Caption = 'None'
-            TabOrder = 1
-            TabStop = True
-            OnClick = SpTBXRadioButton1Click
-            Checked = True
-          end
-          object SpTBXRadioButton2: TSpTBXRadioButton
-            Left = 48
-            Top = 72
-            Width = 62
-            Height = 15
-            Caption = 'Windows'
-            TabOrder = 2
-            OnClick = SpTBXRadioButton2Click
-          end
-          object Label3: TSpTBXLabel
-            Left = 32
-            Top = 120
-            Width = 85
-            Height = 13
-            Caption = 'Choose TBX skin:'
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
-          object SpTBXRadioButton3: TSpTBXRadioButton
-            Left = 48
-            Top = 88
-            Width = 76
-            Height = 15
-            Caption = 'TBX themes'
-            TabOrder = 4
-            OnClick = SpTBXRadioButton3Click
-          end
-          object Label11: TSpTBXLabel
-            Left = 32
-            Top = 32
-            Width = 60
-            Height = 13
-            Caption = 'Theme style:'
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
-        end
-      end
-      object SpTBXTabSheet3: TSpTBXTabSheet
-        Left = 0
-        Top = 23
-        Width = 401
-        Height = 330
-        Caption = 'Interface'
-        ImageIndex = -1
-        Item = SpTBXTabItem3
-        TabControl = SpTBXTabControl1
-        TabItem = 'SpTBXTabItem3'
-        object GroupBox4: TSpTBXGroupBox
-          Left = 16
-          Top = 8
-          Width = 369
-          Height = 305
-          Caption = 'Interface preferences'
-          Color = clNone
-          ParentColor = False
-          TabOrder = 0
-          object CheckBox1: TSpTBXCheckBox
-            Left = 24
-            Top = 24
-            Width = 104
-            Height = 15
-            Caption = 'Timestamp events'
-            TabOrder = 0
-            Checked = True
-            State = cbChecked
-          end
-          object CheckBox3: TSpTBXCheckBox
-            Left = 24
-            Top = 40
-            Width = 128
-            Height = 15
-            Caption = 'Filter join/left messages'
-            TabOrder = 1
-          end
-          object CheckBox4: TSpTBXCheckBox
-            Left = 24
-            Top = 72
-            Width = 108
-            Height = 15
-            Caption = 'Show country flags'
-            TabOrder = 2
-            Checked = True
-            State = cbChecked
-          end
-          object CheckBox5: TSpTBXCheckBox
-            Left = 24
-            Top = 88
-            Width = 147
-            Height = 15
-            Caption = 'Mark unknown maps/mods'
-            TabOrder = 3
-            Checked = True
-            State = cbChecked
-          end
-          object CheckBox6: TSpTBXCheckBox
-            Left = 24
-            Top = 104
-            Width = 251
-            Height = 15
-            Caption = 'Use taskbar button for each form (requires restart)'
-            TabOrder = 4
-          end
-          object WarnNATCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 120
-            Width = 271
-            Height = 15
-            Caption = 'Display warning icons on battles using NAT traversing'
-            TabOrder = 5
-            Checked = True
-            State = cbChecked
-          end
-          object AutoFocusOnPMCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 136
-            Width = 262
-            Height = 15
-            Caption = 'Automatically switch focus to new private messages'
-            TabOrder = 6
-            Checked = True
-            State = cbChecked
-          end
-          object DisableAllSoundsCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 152
-            Width = 103
-            Height = 15
-            Caption = 'Disable all sounds'
-            TabOrder = 7
-          end
-          object UploadReplayCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 248
-            Width = 227
-            Height = 15
-            Caption = 'Ask what to do with replays after each battle'
-            TabOrder = 8
-          end
-          object SortLocalCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 168
-            Width = 132
-            Height = 15
-            Caption = 'Sort the $local player list'
-            TabOrder = 9
-          end
-          object DisplayQuickJoinPanelCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 184
-            Width = 131
-            Height = 15
-            Caption = 'Display Quick join panel'
-            TabOrder = 10
-          end
-          object FilterBattleJoinLeftCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 56
-            Width = 157
-            Height = 15
-            Caption = 'Filter battle join/left messages'
-            TabOrder = 11
-          end
-          object AutoCompletionCurrentChannelCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 200
-            Width = 252
-            Height = 15
-            Caption = 'Auto-completion from current channel'#39's players list'
-            TabOrder = 12
-          end
-          object ChatLogsLimitCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 216
-            Width = 145
-            Height = 15
-            Caption = 'Limit chat logs to 800 lines '
-            TabOrder = 13
-          end
-          object ChatLogsLimitTracker: TSpTBXTrackBar
-            Left = 184
-            Top = 216
-            Width = 121
-            Height = 17
-            Max = 3000
-            Min = 50
-            Frequency = 100
-            Position = 800
-            TabOrder = 14
-            ThumbLength = 10
-            OnChange = ChatLogsLimitTrackerChange
-          end
-          object DisplayUnitsIconsAndNamesCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 232
-            Width = 251
-            Height = 15
-            Caption = 'Load units icons and names when joining (slower)'
-            TabOrder = 15
-          end
-          object DisableNewsCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 264
-            Width = 159
-            Height = 15
-            Caption = 'Disable news (requires restart)'
-            TabOrder = 16
-          end
-        end
-      end
       object SpTBXTabSheet4: TSpTBXTabSheet
         Left = 0
         Top = 23
         Width = 401
-        Height = 330
+        Height = 346
         Caption = 'Program'
         ImageIndex = -1
         Item = SpTBXTabItem4
@@ -642,11 +310,124 @@
           end
         end
       end
+      object SpTBXTabSheet6: TSpTBXTabSheet
+        Left = 0
+        Top = 23
+        Width = 401
+        Height = 346
+        Caption = 'Server'
+        ImageIndex = -1
+        Item = SpTBXTabItem6
+        TabControl = SpTBXTabControl1
+        TabItem = 'SpTBXTabItem6'
+        object GroupBox1: TSpTBXGroupBox
+          Left = 16
+          Top = 8
+          Width = 369
+          Height = 329
+          Caption = 'Server settings'
+          Color = clNone
+          ParentColor = False
+          TabOrder = 0
+          object Label1: TSpTBXLabel
+            Left = 16
+            Top = 32
+            Width = 74
+            Height = 13
+            Caption = 'Server address:'
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
+          end
+          object Label2: TSpTBXLabel
+            Left = 16
+            Top = 56
+            Width = 55
+            Height = 13
+            Caption = 'Server port:'
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
+          end
+          object ServerPortEdit: TSpTBXEdit
+            Left = 96
+            Top = 56
+            Width = 41
+            Height = 21
+            TabOrder = 1
+            Text = '8200'
+          end
+          object CheckBox10: TSpTBXCheckBox
+            Left = 16
+            Top = 128
+            Width = 197
+            Height = 15
+            Caption = 'Connect to backup host if primary fails'
+            TabOrder = 2
+            Checked = True
+            State = cbChecked
+          end
+          object CheckBox2: TSpTBXCheckBox
+            Left = 16
+            Top = 144
+            Width = 108
+            Height = 15
+            Caption = 'Connect on startup'
+            TabOrder = 3
+          end
+          object CheckBox7: TSpTBXCheckBox
+            Left = 16
+            Top = 160
+            Width = 226
+            Height = 15
+            Caption = 'Join #main once connected (recommended)'
+            TabOrder = 4
+          end
+          object ServerAddressEdit: TSpTBXButtonEdit
+            Left = 96
+            Top = 32
+            Width = 249
+            Height = 21
+            TabOrder = 0
+            EditButton.Left = 225
+            EditButton.Top = 0
+            EditButton.Width = 20
+            EditButton.Height = 17
+            EditButton.Caption = '...'
+            EditButton.Align = alRight
+            EditButton.DropDownArrow = False
+            EditButton.DropDownMenu = AddressPopupMenu
+            EditButton.LinkFont.Charset = DEFAULT_CHARSET
+            EditButton.LinkFont.Color = clBlue
+            EditButton.LinkFont.Height = -11
+            EditButton.LinkFont.Name = 'MS Sans Serif'
+            EditButton.LinkFont.Style = [fsUnderline]
+          end
+          object JvXPButton1: TSpTBXButton
+            Left = 272
+            Top = 56
+            Width = 73
+            Height = 21
+            Caption = 'Perform ...'
+            TabOrder = 7
+            OnClick = JvXPButton1Click
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
+          end
+        end
+      end
       object SpTBXTabSheet5: TSpTBXTabSheet
         Left = 0
         Top = 23
         Width = 401
-        Height = 330
+        Height = 346
         Caption = 'Account'
         ImageIndex = -1
         Item = SpTBXTabItem5
@@ -656,7 +437,7 @@
           Left = 16
           Top = 8
           Width = 369
-          Height = 305
+          Height = 329
           Caption = 'Account details'
           Color = clNone
           ParentColor = False
@@ -722,6 +503,7 @@
             Height = 21
             Enabled = False
             TabOrder = 5
+            Visible = False
             PasswordCharW = '*'
           end
           object SpTBXLabel1: TSpTBXLabel
@@ -730,6 +512,7 @@
             Width = 87
             Height = 13
             Caption = 'Ladder password :'
+            Visible = False
             LinkFont.Charset = DEFAULT_CHARSET
             LinkFont.Color = clBlue
             LinkFont.Height = -11
@@ -743,6 +526,7 @@
             Height = 21
             Caption = 'Edit'
             TabOrder = 7
+            Visible = False
             OnClick = ChangeLadderPasswordButtonClick
             LinkFont.Charset = DEFAULT_CHARSET
             LinkFont.Color = clBlue
@@ -757,6 +541,7 @@
             Height = 25
             Caption = 'Create new ladder account'
             TabOrder = 8
+            Visible = False
             OnClick = RegisterLadderAccountButtonClick
             LinkFont.Charset = DEFAULT_CHARSET
             LinkFont.Color = clBlue
@@ -778,7 +563,7 @@
         Left = 0
         Top = 23
         Width = 401
-        Height = 330
+        Height = 346
         Caption = 'HTTP'
         ImageIndex = -1
         Item = SpTBXTabItem2
@@ -788,7 +573,7 @@
           Left = 16
           Top = 8
           Width = 369
-          Height = 305
+          Height = 329
           Caption = 'Proxy settings'
           Color = clNone
           ParentColor = False
@@ -896,123 +681,358 @@
           end
         end
       end
-      object SpTBXTabSheet6: TSpTBXTabSheet
+      object SpTBXTabSheet1: TSpTBXTabSheet
         Left = 0
         Top = 23
         Width = 401
-        Height = 330
-        Caption = 'Server'
+        Height = 346
+        Caption = 'Skins'
         ImageIndex = -1
-        Item = SpTBXTabItem6
+        Item = SpTBXTabItem1
         TabControl = SpTBXTabControl1
-        TabItem = 'SpTBXTabItem6'
-        object GroupBox1: TSpTBXGroupBox
+        TabItem = 'SpTBXTabItem1'
+        object GroupBox5: TSpTBXGroupBox
           Left = 16
           Top = 8
-          Width = 369
-          Height = 305
-          Caption = 'Server settings'
+          Width = 361
+          Height = 329
+          Caption = 'Skin manager'
           Color = clNone
           ParentColor = False
           TabOrder = 0
-          object Label1: TSpTBXLabel
-            Left = 16
-            Top = 32
-            Width = 74
+          object ThemesComboBox: TSpTBXComboBox
+            Left = 48
+            Top = 144
+            Width = 177
+            Height = 21
+            Style = csDropDownList
+            ItemHeight = 13
+            TabOrder = 0
+            OnChange = ThemesComboBoxChange
+          end
+          object SpTBXRadioButton1: TSpTBXRadioButton
+            Left = 48
+            Top = 56
+            Width = 44
+            Height = 15
+            Caption = 'None'
+            TabOrder = 1
+            TabStop = True
+            OnClick = SpTBXRadioButton1Click
+            Checked = True
+          end
+          object SpTBXRadioButton2: TSpTBXRadioButton
+            Left = 48
+            Top = 72
+            Width = 62
+            Height = 15
+            Caption = 'Windows'
+            TabOrder = 2
+            OnClick = SpTBXRadioButton2Click
+          end
+          object Label3: TSpTBXLabel
+            Left = 32
+            Top = 120
+            Width = 85
             Height = 13
-            Caption = 'Server address:'
+            Caption = 'Choose TBX skin:'
             LinkFont.Charset = DEFAULT_CHARSET
             LinkFont.Color = clBlue
             LinkFont.Height = -11
             LinkFont.Name = 'MS Sans Serif'
             LinkFont.Style = [fsUnderline]
           end
-          object Label2: TSpTBXLabel
-            Left = 16
-            Top = 56
-            Width = 55
+          object SpTBXRadioButton3: TSpTBXRadioButton
+            Left = 48
+            Top = 88
+            Width = 76
+            Height = 15
+            Caption = 'TBX themes'
+            TabOrder = 4
+            OnClick = SpTBXRadioButton3Click
+          end
+          object Label11: TSpTBXLabel
+            Left = 32
+            Top = 32
+            Width = 60
             Height = 13
-            Caption = 'Server port:'
+            Caption = 'Theme style:'
             LinkFont.Charset = DEFAULT_CHARSET
             LinkFont.Color = clBlue
             LinkFont.Height = -11
             LinkFont.Name = 'MS Sans Serif'
             LinkFont.Style = [fsUnderline]
           end
-          object ServerPortEdit: TSpTBXEdit
-            Left = 96
-            Top = 56
-            Width = 41
-            Height = 21
+        end
+      end
+      object SpTBXTabSheet7: TSpTBXTabSheet
+        Left = 0
+        Top = 23
+        Width = 401
+        Height = 346
+        Caption = 'Scripts'
+        ImageIndex = -1
+        Item = SpTBXTabItem7
+        TabControl = SpTBXTabControl1
+        TabItem = 'SpTBXTabItem7'
+        object ScriptsDebugWindowBt: TSpTBXButton
+          Left = 132
+          Top = 56
+          Width = 137
+          Height = 25
+          Caption = 'Debug Window'
+          TabOrder = 0
+          OnClick = ScriptsDebugWindowBtClick
+          LinkFont.Charset = DEFAULT_CHARSET
+          LinkFont.Color = clBlue
+          LinkFont.Height = -11
+          LinkFont.Name = 'MS Sans Serif'
+          LinkFont.Style = [fsUnderline]
+        end
+        object ScriptsReloadBt: TSpTBXButton
+          Left = 132
+          Top = 88
+          Width = 137
+          Height = 25
+          Caption = 'Reload scripts'
+          TabOrder = 1
+          OnClick = ScriptsReloadBtClick
+          LinkFont.Charset = DEFAULT_CHARSET
+          LinkFont.Color = clBlue
+          LinkFont.Height = -11
+          LinkFont.Name = 'MS Sans Serif'
+          LinkFont.Style = [fsUnderline]
+        end
+        object ScriptsLoadNewBt: TSpTBXButton
+          Left = 132
+          Top = 120
+          Width = 137
+          Height = 25
+          Caption = 'Load new scripts'
+          TabOrder = 2
+          OnClick = ScriptsLoadNewBtClick
+          LinkFont.Charset = DEFAULT_CHARSET
+          LinkFont.Color = clBlue
+          LinkFont.Height = -11
+          LinkFont.Name = 'MS Sans Serif'
+          LinkFont.Style = [fsUnderline]
+        end
+        object ScriptsAdvancedOptionsBt: TSpTBXButton
+          Left = 132
+          Top = 152
+          Width = 137
+          Height = 25
+          Caption = 'Advanced options'
+          TabOrder = 3
+          Visible = False
+          OnClick = ScriptsAdvancedOptionsBtClick
+          LinkFont.Charset = DEFAULT_CHARSET
+          LinkFont.Color = clBlue
+          LinkFont.Height = -11
+          LinkFont.Name = 'MS Sans Serif'
+          LinkFont.Style = [fsUnderline]
+        end
+        object EnableScriptsCheckBox: TSpTBXCheckBox
+          Left = 104
+          Top = 24
+          Width = 193
+          Height = 15
+          Caption = 'Enable scripts BETA (requires restart)'
+          TabOrder = 4
+        end
+      end
+      object SpTBXTabSheet3: TSpTBXTabSheet
+        Left = 0
+        Top = 23
+        Width = 401
+        Height = 346
+        Caption = 'Interface'
+        ImageIndex = -1
+        Item = SpTBXTabItem3
+        TabControl = SpTBXTabControl1
+        TabItem = 'SpTBXTabItem3'
+        object GroupBox4: TSpTBXGroupBox
+          Left = 16
+          Top = 8
+          Width = 369
+          Height = 329
+          Caption = 'Interface preferences'
+          Color = clNone
+          ParentColor = False
+          TabOrder = 0
+          object CheckBox1: TSpTBXCheckBox
+            Left = 24
+            Top = 24
+            Width = 104
+            Height = 15
+            Caption = 'Timestamp events'
+            TabOrder = 0
+            Checked = True
+            State = cbChecked
+          end
+          object CheckBox3: TSpTBXCheckBox
+            Left = 24
+            Top = 40
+            Width = 128
+            Height = 15
+            Caption = 'Filter join/left messages'
             TabOrder = 1
-            Text = '8200'
           end
-          object CheckBox10: TSpTBXCheckBox
-            Left = 16
-            Top = 128
-            Width = 197
+          object CheckBox4: TSpTBXCheckBox
+            Left = 24
+            Top = 72
+            Width = 108
             Height = 15
-            Caption = 'Connect to backup host if primary fails'
+            Caption = 'Show country flags'
             TabOrder = 2
             Checked = True
             State = cbChecked
           end
-          object CheckBox2: TSpTBXCheckBox
-            Left = 16
-            Top = 144
-            Width = 108
+          object CheckBox5: TSpTBXCheckBox
+            Left = 24
+            Top = 88
+            Width = 147
             Height = 15
-            Caption = 'Connect on startup'
+            Caption = 'Mark unknown maps/mods'
             TabOrder = 3
+            Checked = True
+            State = cbChecked
           end
-          object CheckBox7: TSpTBXCheckBox
-            Left = 16
-            Top = 160
-            Width = 226
+          object CheckBox6: TSpTBXCheckBox
+            Left = 24
+            Top = 104
+            Width = 251
             Height = 15
-            Caption = 'Join #main once connected (recommended)'
+            Caption = 'Use taskbar button for each form (requires restart)'
             TabOrder = 4
           end
-          object ServerAddressEdit: TSpTBXButtonEdit
-            Left = 96
-            Top = 32
-            Width = 249
-            Height = 21
-            TabOrder = 0
-            EditButton.Left = 225
-            EditButton.Top = 0
-            EditButton.Width = 20
-            EditButton.Height = 17
-            EditButton.Caption = '...'
-            EditButton.Align = alRight
-            EditButton.DropDownArrow = False
-            EditButton.DropDownMenu = AddressPopupMenu
-            EditButton.LinkFont.Charset = DEFAULT_CHARSET
-            EditButton.LinkFont.Color = clBlue
-            EditButton.LinkFont.Height = -11
-            EditButton.LinkFont.Name = 'MS Sans Serif'
-            EditButton.LinkFont.Style = [fsUnderline]
+          object WarnNATCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 120
+            Width = 271
+            Height = 15
+            Caption = 'Display warning icons on battles using NAT traversing'
+            TabOrder = 5
+            Checked = True
+            State = cbChecked
           end
-          object JvXPButton1: TSpTBXButton
-            Left = 272
-            Top = 56
-            Width = 73
-            Height = 21
-            Caption = 'Perform ...'
+          object AutoFocusOnPMCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 136
+            Width = 262
+            Height = 15
+            Caption = 'Automatically switch focus to new private messages'
+            TabOrder = 6
+            Checked = True
+            State = cbChecked
+          end
+          object DisableAllSoundsCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 152
+            Width = 103
+            Height = 15
+            Caption = 'Disable all sounds'
             TabOrder = 7
-            OnClick = JvXPButton1Click
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
           end
+          object UploadReplayCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 248
+            Width = 227
+            Height = 15
+            Caption = 'Ask what to do with replays after each battle'
+            TabOrder = 8
+          end
+          object SortLocalCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 168
+            Width = 132
+            Height = 15
+            Caption = 'Sort the $local player list'
+            TabOrder = 9
+          end
+          object DisplayQuickJoinPanelCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 184
+            Width = 131
+            Height = 15
+            Caption = 'Display Quick join panel'
+            TabOrder = 10
+          end
+          object FilterBattleJoinLeftCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 56
+            Width = 157
+            Height = 15
+            Caption = 'Filter battle join/left messages'
+            TabOrder = 11
+          end
+          object AutoCompletionCurrentChannelCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 200
+            Width = 252
+            Height = 15
+            Caption = 'Auto-completion from current channel'#39's players list'
+            TabOrder = 12
+          end
+          object ChatLogsLimitCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 216
+            Width = 145
+            Height = 15
+            Caption = 'Limit chat logs to 800 lines '
+            TabOrder = 13
+          end
+          object ChatLogsLimitTracker: TSpTBXTrackBar
+            Left = 184
+            Top = 216
+            Width = 121
+            Height = 17
+            Max = 3000
+            Min = 50
+            Frequency = 100
+            Position = 800
+            TabOrder = 14
+            ThumbLength = 10
+            OnChange = ChatLogsLimitTrackerChange
+          end
+          object DisplayUnitsIconsAndNamesCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 232
+            Width = 251
+            Height = 15
+            Caption = 'Load units icons and names when joining (slower)'
+            TabOrder = 15
+          end
+          object DisableNewsCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 264
+            Width = 159
+            Height = 15
+            Caption = 'Disable news (requires restart)'
+            TabOrder = 16
+          end
+          object DoNotLoadMapInfos: TSpTBXCheckBox
+            Left = 24
+            Top = 280
+            Width = 240
+            Height = 15
+            Caption = 'Disable minimaps and maps info loading at start'
+            TabOrder = 17
+          end
+          object LoadMetalHeightMaps: TSpTBXCheckBox
+            Left = 24
+            Top = 296
+            Width = 169
+            Height = 15
+            Caption = 'Load metal and height minimaps'
+            TabOrder = 18
+          end
         end
       end
     end
     object ApplyAndCloseButton: TSpTBXButton
       Left = 43
-      Top = 424
+      Top = 440
       Width = 145
       Height = 25
       Caption = 'Apply and close'
@@ -1026,7 +1046,7 @@
     end
     object CancelAndCloseButton: TSpTBXButton
       Left = 227
-      Top = 424
+      Top = 440
       Width = 145
       Height = 25
       Caption = 'Cancel and close'

Modified: Lobby/TASClient/PreferencesFormUnit.pas
===================================================================
--- Lobby/TASClient/PreferencesFormUnit.pas	2009-06-20 19:55:37 UTC (rev 7274)
+++ Lobby/TASClient/PreferencesFormUnit.pas	2009-06-21 00:01:50 UTC (rev 7275)
@@ -90,6 +90,8 @@
     DisableNews: boolean;
 
     LanguageCode: String;
+    DisableMapDetailsLoading: Boolean;
+    LoadMetalHeightMinimaps: Boolean;
   end;
 
   TPreferencesForm = class(TForm)
@@ -196,6 +198,8 @@
     DisableNewsCheckBox: TSpTBXCheckBox;
     LanguageCombobox: TSpTBXComboBox;
     SpTBXLabel2: TSpTBXLabel;
+    DoNotLoadMapInfos: TSpTBXCheckBox;
+    LoadMetalHeightMaps: TSpTBXCheckBox;
 
     function BattleSortStyleToColumn(SortStyle: Integer): Integer;
     function ColumnToBattleSortStyle(Column: Integer): Integer;
@@ -305,7 +309,8 @@
                                         UseProxy: False; HighlightColor: 'Green'; UseNotificationsForHighlights: True; UseIgnoreList: False; WarnIfUsingNATTraversing: True;
                                         AutoFocusOnPM: True; MapSortStyle: 1; ThemeType: thtTBX; Theme: 'Miranda'; DisableAllSounds: False; SortLocal: False;
                                         DisplayQuickJoinPanel : True; LimitChatLogs: False; ChatLogsLimit: 800; SPSkin: 'default.ssk'; ScriptsDisabled : False;
-                                        EnableScripts : True;ScriptWarningMsgShown: False; EnableSpringDownloader : True; UseLogonForm : True; DisableNews : False);
+                                        EnableScripts : True;ScriptWarningMsgShown: False; EnableSpringDownloader : True; UseLogonForm : True; DisableNews : False;
+                                        DisableMapDetailsLoading: False; LoadMetalHeightMinimaps: False);
 
 var
   PreferencesForm: TPreferencesForm;
@@ -410,6 +415,8 @@
     except end;
     try Preferences.SPSkin := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'SPTheme'); except end;
     try Preferences.DisableNews := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'DisableNews'); except end;
+    try Preferences.DisableMapDetailsLoading := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'DisableMapDetailsLoading'); except end;
+    try Preferences.LoadMetalHeightMinimaps := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'LoadMetalHeightMinimaps'); except end;
 
 
     try CommonFont.Name := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'FontName'); except end;
@@ -713,6 +720,8 @@
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'SPTheme', rdString, Preferences.SPSkin);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'DisableNews', rdInteger, Preferences.DisableNews);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'LanguageCode', rdString, Preferences.LanguageCode);
+    Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'DisableMapDetailsLoading', rdInteger, Preferences.DisableMapDetailsLoading);
+    Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'LoadMetalHeightMinimaps', rdInteger, Preferences.LoadMetalHeightMinimaps);
 
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences\ChatColors', 'MyText', rdInteger, Colors.MyText);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences\ChatColors', 'AdminText', rdInteger, Colors.AdminText);
@@ -911,6 +920,9 @@
   except
   end;
 
+  p.DisableMapDetailsLoading := DoNotLoadMapInfos.Checked;
+  p.LoadMetalHeightMinimaps := LoadMetalHeightMaps.Checked;
+
   // there is no need to set p.ThemeType or p.Theme here since those are directly updated to Preferences when we change them in GUI at runtime
 
   // update changes:
@@ -1002,6 +1014,8 @@
   ChatLogsLimitTrackerChange(nil);
 
   DisableNewsCheckBox.Checked := p.DisableNews;
+  DoNotLoadMapInfos.Checked := p.DisableMapDetailsLoading;
+  LoadMetalHeightMaps.Checked := p.LoadMetalHeightMinimaps;
 
   UseLanguage(p.LanguageCode);
   for i:=0 to LangCodes.Count-1 do

Modified: Lobby/TASClient/ReplaysUnit.dfm
===================================================================
--- Lobby/TASClient/ReplaysUnit.dfm	2009-06-20 19:55:37 UTC (rev 7274)
+++ Lobby/TASClient/ReplaysUnit.dfm	2009-06-21 00:01:50 UTC (rev 7275)
@@ -1,6 +1,6 @@
 object ReplaysForm: TReplaysForm
-  Left = 711
-  Top = 134
+  Left = 655
+  Top = 73
   Width = 790
   Height = 599
   Caption = 'Replays'

Modified: Lobby/TASClient/ReplaysUnit.pas
===================================================================
--- Lobby/TASClient/ReplaysUnit.pas	2009-06-20 19:55:37 UTC (rev 7274)
+++ Lobby/TASClient/ReplaysUnit.pas	2009-06-21 00:01:50 UTC (rev 7275)
@@ -2856,7 +2856,8 @@
       begin
         with TMapItem(MapListForm.Maps[Utility.MapList.IndexOf(Replay.Script.ReadMapName)]) do
         begin
-          Draw(10,10,MapImage.Picture.Bitmap);
+          if MapImage &lt;&gt; nil then
+            Draw(10,10,MapImage.Picture.Bitmap);
           Font.Style := [fsBold];
           TextOut(120, 10, MapName);
           Font.Style := [];

Modified: Lobby/TASClient/TASClient.dof
===================================================================
--- Lobby/TASClient/TASClient.dof	2009-06-20 19:55:37 UTC (rev 7274)
+++ Lobby/TASClient/TASClient.dof	2009-06-21 00:01:50 UTC (rev 7275)
@@ -115,7 +115,7 @@
 MajorVer=0
 MinorVer=47
 Release=0
-Build=614
+Build=618
 Debug=0
 PreRelease=0
 Special=0
@@ -126,7 +126,7 @@
 [Version Info Keys]
 CompanyName=
 FileDescription=Spring RTS Engine lobby client
-FileVersion=0.47.0.614
+FileVersion=0.47.0.618
 InternalName=
 LegalCopyright=
 LegalTrademarks=

Modified: Lobby/TASClient/TASClient.dpr
===================================================================
--- Lobby/TASClient/TASClient.dpr	2009-06-20 19:55:37 UTC (rev 7274)
+++ Lobby/TASClient/TASClient.dpr	2009-06-21 00:01:50 UTC (rev 7275)
@@ -357,7 +357,7 @@
   if MainUnit.Debug.Enabled then
     Misc.TryToAddLog(MainUnit.StartDebugLog,'Creating AutoJoinForm ...');
   Application.CreateForm(TAutoJoinForm, AutoJoinForm);
-  if not MainUnit.RunningUnderWine then
+  if MainUnit.RunningWithMainMenu then
   begin
     if MainUnit.Debug.Enabled then
       Misc.TryToAddLog(MainUnit.StartDebugLog,'Creating MenuForm ...');

Modified: Lobby/TASClient/TASClient.res
===================================================================
(Binary files differ)

Modified: Lobby/TASClient/Utility.pas
===================================================================
--- Lobby/TASClient/Utility.pas	2009-06-20 19:55:37 UTC (rev 7274)
+++ Lobby/TASClient/Utility.pas	2009-06-21 00:01:50 UTC (rev 7275)
@@ -385,10 +385,14 @@
      MapCheckSums.Add(IntToHex(CheckSum, 8));
      MapMainArchive.Add(GetMapArchiveName(0));
      MapListForm.AddMap;
-     TMapItem(MapListForm.Maps[MapListForm.Maps.Count-1]).LoadMapInfo;
-     TMapItem(MapListForm.Maps[MapListForm.Maps.Count-1]).LoadMinimap(True);
-     //TMapItem(MapListForm.Maps[MapListForm.Maps.Count-1]).Boxes := TScript.Create(boxes);
 
+     if not Preferences.DisableMapDetailsLoading then
+     begin
+      TMapItem(MapListForm.Maps[MapListForm.Maps.Count-1]).LoadMapInfo;
+      TMapItem(MapListForm.Maps[MapListForm.Maps.Count-1]).LoadMinimap(True);
+      //TMapItem(MapListForm.Maps[MapListForm.Maps.Count-1]).Boxes := TScript.Create(boxes);
+     end;
+
 //*** debug     MainForm.AddMainLog(MapName + ' ... ' + IntToStr(c) + ':' + MapCheckSums[MapCheckSums.Count-1], Colors.Info);
   end;
   MapListForm.SortedMaps.Assign(MapListForm.Maps);


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002043.html">[Taspring-linux-commit] r7274 - Lobby/TASClient
</A></li>
	<LI>Next message: <A HREF="002045.html">[Taspring-linux-commit] r7276 - Lobby/TASClient
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2044">[ date ]</a>
              <a href="thread.html#2044">[ thread ]</a>
              <a href="subject.html#2044">[ subject ]</a>
              <a href="author.html#2044">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
