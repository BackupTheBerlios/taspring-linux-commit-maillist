<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r7276 - Lobby/TASClient
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2009-June/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r7276%20-%20Lobby/TASClient&In-Reply-To=%3C20090621212643.C0D363B7F1%40it-l.eu%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002044.html">
   <LINK REL="Next"  HREF="002046.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r7276 - Lobby/TASClient</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r7276%20-%20Lobby/TASClient&In-Reply-To=%3C20090621212643.C0D363B7F1%40it-l.eu%3E"
       TITLE="[Taspring-linux-commit] r7276 - Lobby/TASClient">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Sun Jun 21 23:26:43 CEST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="002044.html">[Taspring-linux-commit] r7275 - Lobby/TASClient
</A></li>
        <LI>Next message: <A HREF="002046.html">[Taspring-linux-commit] r7277 - Lobby/TASClient
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2045">[ date ]</a>
              <a href="thread.html#2045">[ thread ]</a>
              <a href="subject.html#2045">[ subject ]</a>
              <a href="author.html#2045">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: satirik
Date: 2009-06-21 23:26:42 +0200 (Sun, 21 Jun 2009)
New Revision: 7276

Modified:
   Lobby/TASClient/BattleFormUnit.dfm
   Lobby/TASClient/BattleFormUnit.pas
   Lobby/TASClient/Misc.pas
   Lobby/TASClient/TASClient.dof
   Lobby/TASClient/TASClient.res
Log:
* reloading map list crash bug fixed (or not)

Modified: Lobby/TASClient/BattleFormUnit.dfm
===================================================================
--- Lobby/TASClient/BattleFormUnit.dfm	2009-06-21 00:01:50 UTC (rev 7275)
+++ Lobby/TASClient/BattleFormUnit.dfm	2009-06-21 21:26:42 UTC (rev 7276)
@@ -1,6 +1,6 @@
 object BattleForm: TBattleForm
-  Left = 552
-  Top = 32
+  Left = 332
+  Top = 38
   Width = 945
   Height = 589
   Caption = 'Battle window'
@@ -4900,32 +4900,32 @@
             object HeightMapTab: TSpTBXTabItem
               Caption = 'HeightMap'
             end
-            object SpTBXTabSheet4: TSpTBXTabSheet
+            object SpTBXTabSheet5: TSpTBXTabSheet
               Left = 0
               Top = 23
               Width = 358
               Height = 199
-              Caption = 'RessourcesMap'
+              Caption = 'HeightMap'
               ImageIndex = -1
-              Item = RessourcesMapTab
+              Item = HeightMapTab
               TabControl = MapsTabs
-              TabItem = 'RessourcesMapTab'
-              object MetalMapPanel: TSpTBXPanel
+              TabItem = 'HeightMapTab'
+              object HeightMapPanel: TSpTBXPanel
                 Left = 2
                 Top = 0
                 Width = 354
                 Height = 197
-                Caption = 'MetalMapPanel'
+                Caption = 'HeightMapPanel'
                 Align = alClient
                 TabOrder = 0
-                OnResize = MetalMapPanelResize
+                OnResize = HeightMapPanelResize
                 Borders = False
                 TBXStyleBackground = True
-                object MetalMapImage: TImage
+                object HeightMapImage: TImage
                   Left = 0
                   Top = 0
-                  Width = 89
-                  Height = 73
+                  Width = 105
+                  Height = 81
                   Picture.Data = {
                     07544269746D6170F6D40100424DF6D40100000000003600000028000000C800
                     0000C80000000100180000000000C0D40100120B0000120B0000000000000000
@@ -8687,32 +8687,32 @@
                 end
               end
             end
-            object SpTBXTabSheet5: TSpTBXTabSheet
+            object SpTBXTabSheet4: TSpTBXTabSheet
               Left = 0
               Top = 23
               Width = 358
               Height = 199
-              Caption = 'HeightMap'
+              Caption = 'RessourcesMap'
               ImageIndex = -1
-              Item = HeightMapTab
+              Item = RessourcesMapTab
               TabControl = MapsTabs
-              TabItem = 'HeightMapTab'
-              object HeightMapPanel: TSpTBXPanel
+              TabItem = 'RessourcesMapTab'
+              object MetalMapPanel: TSpTBXPanel
                 Left = 2
                 Top = 0
                 Width = 354
                 Height = 197
-                Caption = 'HeightMapPanel'
+                Caption = 'MetalMapPanel'
                 Align = alClient
                 TabOrder = 0
-                OnResize = HeightMapPanelResize
+                OnResize = MetalMapPanelResize
                 Borders = False
                 TBXStyleBackground = True
-                object HeightMapImage: TImage
+                object MetalMapImage: TImage
                   Left = 0
                   Top = 0
-                  Width = 105
-                  Height = 81
+                  Width = 89
+                  Height = 73
                   Picture.Data = {
                     07544269746D6170F6D40100424DF6D40100000000003600000028000000C800
                     0000C80000000100180000000000C0D40100120B0000120B0000000000000000

Modified: Lobby/TASClient/BattleFormUnit.pas
===================================================================
--- Lobby/TASClient/BattleFormUnit.pas	2009-06-21 00:01:50 UTC (rev 7275)
+++ Lobby/TASClient/BattleFormUnit.pas	2009-06-21 21:26:42 UTC (rev 7276)
@@ -533,7 +533,6 @@
     procedure OnlineMapsButtonClick(Sender: TObject);
     procedure OnlineModsButtonClick(Sender: TObject);
     procedure MinimapPanelResize(Sender: TObject);
-    procedure Button1Click(Sender: TObject);
     procedure Button2Click(Sender: TObject);
     procedure MetalMapPanelResize(Sender: TObject);
     procedure HeightMapPanelResize(Sender: TObject);
@@ -1245,9 +1244,17 @@
   end;
 
   TMapItem(MapListForm.Maps[MapIndex]).LoadMapInfo;
+  MapImage.Visible := False;
   Utility.LoadMiniMap(TMapItem(MapListForm.Maps[MapIndex]).MapName,MapImage.Picture.Bitmap);
   TMapItem(MapListForm.Maps[MapIndex]).LoadMinimap(False,MapImage.Picture.Bitmap);
+  MapImage.Visible := True;
 
+  TotalMetal := 0;
+  MapMetalWidth := 0;
+  MapMetalHeight := 0;
+  MapHeightWidth := 0;
+  MapHeightHeight := 0;
+
   // load height map in the corresponding TImage
   if Preferences.LoadMetalHeightMinimaps then
   begin
@@ -1309,9 +1316,9 @@
   end
   else
   begin
-    MetalMapImage.Canvas.Draw(0,0,NoMapImage.Picture.Bitmap);
+    MetalMapImage.Picture.Bitmap.Assign(NoMapImage.Picture.Bitmap);
+    HeightMapImage.Picture.Bitmap.Assign(NoMapImage.Picture.Bitmap);
     MetalMapImage.Canvas.TextOut(0,Floor(MetalMapImage.Picture.Height/2-MetalMapImage.Canvas.TextHeight('M')/2),'Metal minimap loading disabled');
-    HeightMapImage.Canvas.Draw(0,0,NoMapImage.Picture.Bitmap);
     HeightMapImage.Canvas.TextOut(0,Floor(HeightMapImage.Picture.Height/2-HeightMapImage.Canvas.TextHeight('M')/2),'Height minimap loading disabled');
   end;
 
@@ -2967,15 +2974,16 @@
     Rectangle((Sender as TPaintBox).ClientRect);
 
     metal := 0;
-    for i:=Round(BattleState.StartRects[(Sender as TPaintBox).Tag].Rect.Top*MapMetalHeight/100) to Round(BattleState.StartRects[(Sender as TPaintBox).Tag].Rect.Bottom*MapMetalHeight/100)-1 do
-      for j:=Round(BattleState.StartRects[(Sender as TPaintBox).Tag].Rect.Left*MapMetalWidth/100)+1 to Round(BattleState.StartRects[(Sender as TPaintBox).Tag].Rect.Right*MapMetalWidth/100) do
-        metal := metal + Ord(MapMetal[i*MapMetalWidth+j]);
-
     s := IntToStr((Sender as TPaintBox).Tag + 1);
-    if TotalMetal &gt; 0 then
-      s := s + '/M='+FloatToStr(RoundTo(metal*100/TotalMetal,-1))+'%'
-    else
-      s := s + '/M=none';
+    if (TotalMetal&gt;0) and Preferences.LoadMetalHeightMinimaps then
+    begin
+      for i:=Round(BattleState.StartRects[(Sender as TPaintBox).Tag].Rect.Top*MapMetalHeight/100) to Round(BattleState.StartRects[(Sender as TPaintBox).Tag].Rect.Bottom*MapMetalHeight/100)-1 do
+        for j:=Round(BattleState.StartRects[(Sender as TPaintBox).Tag].Rect.Left*MapMetalWidth/100)+1 to Round(BattleState.StartRects[(Sender as TPaintBox).Tag].Rect.Right*MapMetalWidth/100) do
+          metal := metal + Ord(MapMetal[i*MapMetalWidth+j]);
+
+      s := s + '/M='+FloatToStr(RoundTo(metal*100/TotalMetal,-1))+'%';
+    end;
+    
     Brush.Style := bsClear;
     Font.Style := [fsBold];
     
@@ -4871,6 +4879,7 @@
 var
   i:integer;
 begin
+  TotalMetal := 0;
   if (BattleState.Status = Hosting) and (BattleState.Battle.BattleType = 1) then
   begin
     // this should not happen though since we don't allow player to host a replay if he doesn't have the correct map!
@@ -6798,18 +6807,6 @@
   RefreshStartRectsPosAndSize;
 end;
 
-procedure TBattleForm.Button1Click(Sender: TObject);
-var
-  i,j:integer;
-begin
-  MapImage.Picture.Graphic.Width := MapMetalWidth;
-  MapImage.Picture.Graphic.Height := MapMetalHeight;
-
-  for j:=0 to MapMetalHeight-1 do
-    for i:=0 to MapMetalWidth-1 do
-      MapImage.Picture.Bitmap.Canvas.Pixels[i,j] := RGB(0,Ord(MapMetal[j*MapMetalWidth+i]),0);
-end;
-
 procedure TBattleForm.Button2Click(Sender: TObject);
 var
   i,j,v:integer;

Modified: Lobby/TASClient/Misc.pas
===================================================================
--- Lobby/TASClient/Misc.pas	2009-06-21 00:01:50 UTC (rev 7275)
+++ Lobby/TASClient/Misc.pas	2009-06-21 21:26:42 UTC (rev 7276)
@@ -432,6 +432,8 @@
 begin
   Text := Tnt_WideStringReplace(Text,#$0B,' ',[rfReplaceAll]);
 
+  RichEdit.BeginUpdate;
+
   // save the scroll pos
   SelStart := RichEdit.SelStart;
   SelLength := RichEdit.SelLength;
@@ -465,6 +467,7 @@
     RichEdit.SelStart := SelStart;
     RichEdit.SelLength := SelLength;
 
+    RichEdit.EndUpdate;
     if not Scroll or (p.Y &lt; Max(0,pMax.Y-20)) then
       SendMessage(RichEdit.Handle, WM_USER + 222 {EM_SETSCROLLPOS}, 0, LPARAM(@p))
     else
@@ -473,7 +476,9 @@
       RichEdit.ScrollToBottom;
     end;
 
+
   except
+    RichEdit.EndUpdate;
   end;
 end;
 

Modified: Lobby/TASClient/TASClient.dof
===================================================================
--- Lobby/TASClient/TASClient.dof	2009-06-21 00:01:50 UTC (rev 7275)
+++ Lobby/TASClient/TASClient.dof	2009-06-21 21:26:42 UTC (rev 7276)
@@ -115,7 +115,7 @@
 MajorVer=0
 MinorVer=47
 Release=0
-Build=618
+Build=619
 Debug=0
 PreRelease=0
 Special=0
@@ -126,7 +126,7 @@
 [Version Info Keys]
 CompanyName=
 FileDescription=Spring RTS Engine lobby client
-FileVersion=0.47.0.618
+FileVersion=0.47.0.619
 InternalName=
 LegalCopyright=
 LegalTrademarks=

Modified: Lobby/TASClient/TASClient.res
===================================================================
(Binary files differ)


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002044.html">[Taspring-linux-commit] r7275 - Lobby/TASClient
</A></li>
	<LI>Next message: <A HREF="002046.html">[Taspring-linux-commit] r7277 - Lobby/TASClient
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2045">[ date ]</a>
              <a href="thread.html#2045">[ thread ]</a>
              <a href="subject.html#2045">[ subject ]</a>
              <a href="author.html#2045">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
