<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r7228 - in Lobby/TASClient: . Interface	Python Python/scripts/layoutProfiles
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2009-January/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r7228%20-%20in%20Lobby/TASClient%3A%20.%20Interface%0A%09Python%20Python/scripts/layoutProfiles&In-Reply-To=%3C20090125201903.E97E2487FB%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001996.html">
   <LINK REL="Next"  HREF="001998.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r7228 - in Lobby/TASClient: . Interface	Python Python/scripts/layoutProfiles</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r7228%20-%20in%20Lobby/TASClient%3A%20.%20Interface%0A%09Python%20Python/scripts/layoutProfiles&In-Reply-To=%3C20090125201903.E97E2487FB%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r7228 - in Lobby/TASClient: . Interface	Python Python/scripts/layoutProfiles">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Sun Jan 25 21:19:03 CET 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="001996.html">[Taspring-linux-commit] r7227 - Lobby/springie/Springie/spring
</A></li>
        <LI>Next message: <A HREF="001998.html">[Taspring-linux-commit] r7229 - Lobby/TASClient
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1997">[ date ]</a>
              <a href="thread.html#1997">[ thread ]</a>
              <a href="subject.html#1997">[ subject ]</a>
              <a href="author.html#1997">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: satirik
Date: 2009-01-25 21:19:00 +0100 (Sun, 25 Jan 2009)
New Revision: 7228

Added:
   Lobby/TASClient/7za.dll
   Lobby/TASClient/Python/scripts/layoutProfiles/BattleForm WideScreen.py
   Lobby/TASClient/Python/scripts/layoutProfiles/SpringLobby Layout.py
   Lobby/TASClient/SpringSettingsProfileFormUnit.ddp
   Lobby/TASClient/SpringSettingsProfileFormUnit.dfm
   Lobby/TASClient/SpringSettingsProfileFormUnit.pas
   Lobby/TASClient/administrator.manifest
Removed:
   Lobby/TASClient/Interface/defaultMissionBriefing.html
   Lobby/TASClient/Python/scripts/layoutProfiles/Full Width Battle list.py
Modified:
   Lobby/TASClient/AwayMessageFormUnit.dfm
   Lobby/TASClient/BattleFormUnit.dfm
   Lobby/TASClient/BattleFormUnit.pas
   Lobby/TASClient/ColorPicker.dfm
   Lobby/TASClient/CustomizeGUIFormUnit.dfm
   Lobby/TASClient/CustomizeGUIFormUnit.pas
   Lobby/TASClient/HostBattleFormUnit.pas
   Lobby/TASClient/Interface/selectmod.html
   Lobby/TASClient/LobbyScriptUnit.pas
   Lobby/TASClient/LogonFormUnit.dfm
   Lobby/TASClient/MainUnit.dfm
   Lobby/TASClient/MainUnit.pas
   Lobby/TASClient/ManageGroups.dfm
   Lobby/TASClient/MenuFormUnit.dfm
   Lobby/TASClient/MenuFormUnit.pas
   Lobby/TASClient/Misc.pas
   Lobby/TASClient/PreferencesFormUnit.dfm
   Lobby/TASClient/PreferencesFormUnit.pas
   Lobby/TASClient/ProgressBarWindow.dfm
   Lobby/TASClient/Python/api.txt
   Lobby/TASClient/Python/scripts/layoutProfiles/Chat And Battles.py
   Lobby/TASClient/Python/scripts/layoutProfiles/Small Screen Full.py
   Lobby/TASClient/Python/scripts/layoutProfiles/Small Screen.py
   Lobby/TASClient/PythonScriptDebugFormUnit.dfm
   Lobby/TASClient/ReplaysUnit.dfm
   Lobby/TASClient/ReplaysUnit.pas
   Lobby/TASClient/SplashScreenUnit.pas
   Lobby/TASClient/SpringDownloaderFormUnit.dfm
   Lobby/TASClient/TASClient.dof
   Lobby/TASClient/TASClient.dpr
   Lobby/TASClient/TASClient.res
   Lobby/TASClient/TemplateEditorFormUnit.dfm
   Lobby/TASClient/TipsFormUnit.dfm
   Lobby/TASClient/TipsFormUnit.pas
   Lobby/TASClient/Utility.pas
   Lobby/TASClient/administrator.RES
Log:
backup

Added: Lobby/TASClient/7za.dll
===================================================================
(Binary files differ)


Property changes on: Lobby/TASClient/7za.dll
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: Lobby/TASClient/AwayMessageFormUnit.dfm
===================================================================
--- Lobby/TASClient/AwayMessageFormUnit.dfm	2009-01-22 02:29:22 UTC (rev 7227)
+++ Lobby/TASClient/AwayMessageFormUnit.dfm	2009-01-25 20:19:00 UTC (rev 7228)
@@ -14,7 +14,7 @@
   Font.Name = 'MS Sans Serif'
   Font.Style = []
   OldCreateOrder = False
-  Position = poScreenCenter
+  Position = poMainFormCenter
   OnCreate = FormCreate
   PixelsPerInch = 96
   TextHeight = 13

Modified: Lobby/TASClient/BattleFormUnit.dfm
===================================================================
--- Lobby/TASClient/BattleFormUnit.dfm	2009-01-22 02:29:22 UTC (rev 7227)
+++ Lobby/TASClient/BattleFormUnit.dfm	2009-01-25 20:19:00 UTC (rev 7228)
@@ -1,8 +1,8 @@
 object BattleForm: TBattleForm
-  Left = 299
-  Top = 210
-  Width = 829
-  Height = 586
+  Left = 753
+  Top = 335
+  Width = 827
+  Height = 589
   Caption = 'Battle window'
   Color = clBtnFace
   Constraints.MaxHeight = 1000
@@ -24,13 +24,13 @@
   object SpTBXTitleBar1: TSpTBXTitleBar
     Left = 0
     Top = 0
-    Width = 821
-    Height = 559
+    Width = 819
+    Height = 562
     Caption = 'Battle window'
     object Panel3: TSpTBXPanel
       Left = 4
-      Top = 514
-      Width = 813
+      Top = 517
+      Width = 811
       Height = 41
       Align = alBottom
       Color = clNone
@@ -39,7 +39,7 @@
       BorderType = pbrRaised
       TBXStyleBackground = True
       DesignSize = (
-        813
+        811
         41)
       object StartButton: TSpTBXButton
         Left = 104
@@ -133,7 +133,7 @@
         LinkFont.Style = [fsUnderline]
       end
       object LadderRulesButton: TSpTBXButton
-        Left = 727
+        Left = 725
         Top = 8
         Width = 75
         Height = 25
@@ -164,12 +164,30 @@
         LinkFont.Style = [fsUnderline]
         ThemeType = thtTBX
       end
+      object SSProfileButton: TSpTBXButton
+        Left = 640
+        Top = 8
+        Width = 75
+        Height = 25
+        Hint = 'Spring Settings Profile. Customize them in the options.'
+        Caption = 'Settings'
+        Anchors = [akTop, akRight]
+        ParentShowHint = False
+        ShowHint = True
+        TabOrder = 8
+        DropDownMenu = SpringSettingsProfilePopupMenu
+        LinkFont.Charset = DEFAULT_CHARSET
+        LinkFont.Color = clBlue
+        LinkFont.Height = -11
+        LinkFont.Name = 'MS Sans Serif'
+        LinkFont.Style = [fsUnderline]
+      end
     end
     object Panel2: TPanel
       Left = 4
       Top = 426
-      Width = 813
-      Height = 88
+      Width = 811
+      Height = 91
       Align = alClient
       TabOrder = 2
       object NoMapImage: TImage
@@ -4047,12 +4065,12 @@
     object Panel1: TPanel
       Left = 4
       Top = 30
-      Width = 813
+      Width = 811
       Height = 275
       Align = alTop
       TabOrder = 3
       object Panel5: TPanel
-        Left = 393
+        Left = 391
         Top = 1
         Width = 419
         Height = 273
@@ -4066,52 +4084,63 @@
           Height = 273
           Align = alClient
           Color = clBtnFace
-          ActiveTabIndex = 0
-          TabAutofit = True
+          ActiveTabIndex = 1
           ThemeType = tttNone
           OnActiveTabChange = SpTBXTabControl1ActiveTabChange
-          HiddenItems = &lt;&gt;
+          HiddenItems = &lt;
+            item
+              Name = 'ModTab'
+              Left = 318
+              Width = 94
+              Height = 35
+            end&gt;
+          object QuickLookTab: TSpTBXTabItem
+            ImageIndex = 1
+            Images = MainForm.ArrowList
+            CustomWidth = 40
+            ThemeType = tttNone
+          end
           object GameOptionsTab: TSpTBXTabItem
             Caption = 'Game options'
             Checked = True
-            CustomWidth = 103
-            CustomHeight = 30
+            CustomWidth = 80
+            CustomHeight = 35
             ThemeType = tttNone
           end
           object DisabledUnitsTab: TSpTBXTabItem
             Caption = 'Disabled Units (0)'
             Wrapping = twWrap
-            CustomWidth = 103
+            CustomWidth = 94
             ThemeType = tttNone
           end
           object MapTab: TSpTBXTabItem
             Caption = 'Map options'
             Wrapping = twWrap
-            CustomWidth = 103
+            CustomWidth = 94
             ThemeType = tttNone
           end
           object ModTab: TSpTBXTabItem
             Caption = 'Mod options'
             Wrapping = twWrap
-            CustomWidth = 103
+            CustomWidth = 94
             ThemeType = tttNone
           end
           object SpTBXTabSheet1: TSpTBXTabSheet
             Left = 0
-            Top = 34
+            Top = 39
             Width = 419
-            Height = 239
+            Height = 234
             Caption = 'Disabled Units (0)'
             ImageIndex = -1
             DesignSize = (
               419
-              239)
+              234)
             TabItem = 'DisabledUnitsTab'
             object UnitsGroupBox: TSpTBXGroupBox
               Left = 8
               Top = 4
               Width = 401
-              Height = 226
+              Height = 221
               Caption = 'Disabled units'
               Anchors = [akLeft, akTop, akBottom]
               Color = clNone
@@ -4119,7 +4148,7 @@
               TabOrder = 0
               DesignSize = (
                 401
-                226)
+                221)
               object AddUnitsSpeedButton: TSpeedButton
                 Left = 264
                 Top = 10
@@ -4132,7 +4161,7 @@
                 Left = 16
                 Top = 32
                 Width = 369
-                Height = 182
+                Height = 177
                 Anchors = [akLeft, akTop, akRight, akBottom]
                 DefaultNodeHeight = 64
                 Header.AutoSizeIndex = 1
@@ -4167,20 +4196,20 @@
           end
           object MapTabSheet: TSpTBXTabSheet
             Left = 0
-            Top = 34
+            Top = 39
             Width = 419
-            Height = 239
+            Height = 234
             Caption = 'Map options'
             ImageIndex = -1
             DesignSize = (
               419
-              239)
+              234)
             TabItem = 'MapTab'
             object MapOptionsScrollBox: TTntScrollBox
               Left = 8
               Top = 48
               Width = 402
-              Height = 189
+              Height = 184
               VertScrollBar.Smooth = True
               VertScrollBar.Tracking = True
               Anchors = [akLeft, akTop, akRight, akBottom]
@@ -4247,20 +4276,20 @@
           end
           object ModTabSheet: TSpTBXTabSheet
             Left = 0
-            Top = 34
+            Top = 39
             Width = 419
-            Height = 239
+            Height = 234
             Caption = 'Mod options'
             ImageIndex = -1
             DesignSize = (
               419
-              239)
+              234)
             TabItem = 'ModTab'
             object ModOptionsScrollBox: TTntScrollBox
               Left = 8
               Top = 48
               Width = 402
-              Height = 189
+              Height = 184
               VertScrollBar.Smooth = True
               VertScrollBar.Tracking = True
               Anchors = [akLeft, akTop, akRight, akBottom]
@@ -4325,11 +4354,34 @@
               end
             end
           end
+          object SpTBXTabSheet6: TSpTBXTabSheet
+            Left = 0
+            Top = 39
+            Width = 419
+            Height = 234
+            ImageIndex = 1
+            TabItem = 'QuickLookTab'
+            object QuickLookRichEdit: TRichEdit
+              Left = 2
+              Top = 0
+              Width = 415
+              Height = 232
+              Align = alClient
+              BorderStyle = bsNone
+              Color = clBtnFace
+              ParentShowHint = False
+              ReadOnly = True
+              ScrollBars = ssVertical
+              ShowHint = True
+              TabOrder = 0
+              OnMouseMove = QuickLookRichEditMouseMove
+            end
+          end
           object SpTBXTabSheet2: TSpTBXTabSheet
             Left = 0
-            Top = 34
+            Top = 39
             Width = 419
-            Height = 239
+            Height = 234
             Caption = 'Game options'
             ImageIndex = -1
             TabItem = 'GameOptionsTab'
@@ -4505,6 +4557,7 @@
               ParentShowHint = False
               ShowHint = True
               TabOrder = 2
+              Visible = False
               OnClick = GameEndRadioGroupClick
             end
             object StartPosRadioGroup: TSpTBXRadioGroup
@@ -4512,9 +4565,15 @@
               Top = 8
               Width = 129
               Height = 69
+              Hint = 
+                'Where players will start on the map, using the fixed positions o' +
+                'f the map in the ascending order, using the fixed positions of t' +
+                'he map assigned randomly or using the start boxes.'
               Caption = 'Start position'
               Color = clNone
               ParentColor = False
+              ParentShowHint = False
+              ShowHint = True
               TabOrder = 3
               OnClick = StartPosRadioGroupClick
               ItemIndex = 2
@@ -4557,7 +4616,7 @@
       object Panel6: TPanel
         Left = 1
         Top = 1
-        Width = 392
+        Width = 390
         Height = 273
         Align = alClient
         BevelOuter = bvNone
@@ -4566,7 +4625,7 @@
         object MapPanel: TSpTBXPanel
           Left = 0
           Top = 0
-          Width = 392
+          Width = 390
           Height = 273
           Align = alClient
           Color = clNone
@@ -4575,7 +4634,7 @@
           OnMouseMove = MapPanelMouseMove
           TBXStyleBackground = True
           object MapOptionsPanel: TSpTBXPanel
-            Left = 264
+            Left = 262
             Top = 2
             Width = 126
             Height = 222
@@ -4771,7 +4830,7 @@
           object SpTBXPanel3: TSpTBXPanel
             Left = 2
             Top = 224
-            Width = 388
+            Width = 386
             Height = 47
             Caption = 'MapDescPanel'
             Align = alBottom
@@ -4779,7 +4838,7 @@
             object MapDescLabel: TSpTBXLabel
               Left = 2
               Top = 2
-              Width = 384
+              Width = 382
               Height = 43
               Caption = 'MapDescLabel'
               Align = alClient
@@ -4798,11 +4857,11 @@
           object MapsTabs: TSpTBXTabControl
             Left = 2
             Top = 2
-            Width = 262
+            Width = 260
             Height = 222
             Align = alClient
             Color = clBtnFace
-            ActiveTabIndex = 1
+            ActiveTabIndex = 2
             OnActiveTabChange = MapsTabsActiveTabChange
             HiddenItems = &lt;
               item
@@ -4816,34 +4875,74 @@
             end
             object RessourcesMapTab: TSpTBXTabItem
               Caption = 'RessourcesMap'
-              Checked = True
             end
             object HeightMapTab: TSpTBXTabItem
               Caption = 'HeightMap'
+              Checked = True
             end
-            object SpTBXTabSheet5: TSpTBXTabSheet
+            object SpTBXTabSheet3: TSpTBXTabSheet
               Left = 0
               Top = 23
-              Width = 262
+              Width = 260
               Height = 199
-              Caption = 'HeightMap'
+              Caption = 'Minimap'
               ImageIndex = -1
-              TabItem = 'HeightMapTab'
-              object HeightMapPanel: TSpTBXPanel
+              TabItem = 'MinimapTab'
+              object MinimapPanel: TSpTBXPanel
                 Left = 2
                 Top = 0
-                Width = 258
+                Width = 256
                 Height = 197
-                Caption = 'HeightMapPanel'
                 Align = alClient
                 TabOrder = 0
-                OnResize = HeightMapPanelResize
+                OnResize = MinimapPanelResize
                 Borders = False
-                object HeightMapImage: TImage
+                TBXStyleBackground = True
+                DesignSize = (
+                  256
+                  197)
+                object MapImage: TImageEx
                   Left = 0
                   Top = 0
-                  Width = 105
-                  Height = 81
+                  Width = 124
+                  Height = 80
+                  Cursor = crHandPoint
+                  Hint = 'No map'
+                  Anchors = [akLeft, akTop, akRight, akBottom]
+                  ParentShowHint = False
+                  PopupMenu = AutoStartRectsPopupMenu
+                  ShowHint = True
+                  Stretch = True
+                  OnMouseDown = MapImageMouseDown
+                  OnMouseMove = MapImageMouseMove
+                  OnMouseUp = MapImageMouseUp
+                end
+              end
+            end
+            object SpTBXTabSheet4: TSpTBXTabSheet
+              Left = 0
+              Top = 23
+              Width = 260
+              Height = 199
+              Caption = 'RessourcesMap'
+              ImageIndex = -1
+              TabItem = 'RessourcesMapTab'
+              object MetalMapPanel: TSpTBXPanel
+                Left = 2
+                Top = 0
+                Width = 256
+                Height = 197
+                Caption = 'MetalMapPanel'
+                Align = alClient
+                TabOrder = 0
+                OnResize = MetalMapPanelResize
+                Borders = False
+                TBXStyleBackground = True
+                object MetalMapImage: TImage
+                  Left = 0
+                  Top = 0
+                  Width = 89
+                  Height = 73
                   Picture.Data = {
                     07544269746D6170F6D40100424DF6D40100000000003600000028000000C800
                     0000C80000000100180000000000C0D40100120B0000120B0000000000000000
@@ -8605,67 +8704,30 @@
                 end
               end
             end
-            object SpTBXTabSheet3: TSpTBXTabSheet
+            object SpTBXTabSheet5: TSpTBXTabSheet
               Left = 0
               Top = 23
-              Width = 262
+              Width = 260
               Height = 199
-              Caption = 'Minimap'
+              Caption = 'HeightMap'
               ImageIndex = -1
-              TabItem = 'MinimapTab'
-              object MinimapPanel: TSpTBXPanel
+              TabItem = 'HeightMapTab'
+              object HeightMapPanel: TSpTBXPanel
                 Left = 2
                 Top = 0
-                Width = 258
+                Width = 256
                 Height = 197
+                Caption = 'HeightMapPanel'
                 Align = alClient
                 TabOrder = 0
-                OnResize = MinimapPanelResize
+                OnResize = HeightMapPanelResize
                 Borders = False
-                DesignSize = (
-                  258
-                  197)
-                object MapImage: TImageEx
+                TBXStyleBackground = True
+                object HeightMapImage: TImage
                   Left = 0
                   Top = 0
-                  Width = 126
-                  Height = 80
-                  Cursor = crHandPoint
-                  Hint = 'No map'
-                  Anchors = [akLeft, akTop, akRight, akBottom]
-                  ParentShowHint = False
-                  PopupMenu = AutoStartRectsPopupMenu
-                  ShowHint = True
-                  Stretch = True
-                  OnMouseDown = MapImageMouseDown
-                  OnMouseMove = MapImageMouseMove
-                  OnMouseUp = MapImageMouseUp
-                end
-              end
-            end
-            object SpTBXTabSheet4: TSpTBXTabSheet
-              Left = 0
-              Top = 23
-              Width = 262
-              Height = 199
-              Caption = 'RessourcesMap'
-              ImageIndex = -1
-              TabItem = 'RessourcesMapTab'
-              object MetalMapPanel: TSpTBXPanel
-                Left = 2
-                Top = 0
-                Width = 258
-                Height = 197
-                Caption = 'MetalMapPanel'
-                Align = alClient
-                TabOrder = 0
-                OnResize = MetalMapPanelResize
-                Borders = False
-                object MetalMapImage: TImage
-                  Left = 0
-                  Top = 0
-                  Width = 89
-                  Height = 73
+                  Width = 105
+                  Height = 81
                   Picture.Data = {
                     07544269746D6170F6D40100424DF6D40100000000003600000028000000C800
                     0000C80000000100180000000000C0D40100120B0000120B0000000000000000
@@ -12434,7 +12496,7 @@
     object Panel4: TSpTBXPanel
       Left = 4
       Top = 311
-      Width = 813
+      Width = 811
       Height = 109
       Caption = 'Panel4'
       Align = alTop
@@ -12442,12 +12504,12 @@
       BorderType = pbrRaised
       TBXStyleBackground = True
       DesignSize = (
-        813
+        811
         109)
       object VDTBattleClients: TVirtualDrawTree
         Left = 8
         Top = 8
-        Width = 503
+        Width = 501
         Height = 94
         Anchors = [akLeft, akTop, akRight, akBottom]
         Font.Charset = DEFAULT_CHARSET
@@ -12512,7 +12574,7 @@
           end
           item
             Position = 6
-            Width = 34
+            Width = 32
             WideText = 'Player Bonus'
           end
           item
@@ -12534,7 +12596,7 @@
           end&gt;
       end
       object lblTeamNbr: TSpTBXLabel
-        Left = 516
+        Left = 514
         Top = 8
         Width = 44
         Height = 13
@@ -12551,7 +12613,7 @@
         LinkFont.Style = [fsUnderline]
       end
       object MyOptionsGroupBox: TSpTBXGroupBox
-        Left = 563
+        Left = 561
         Top = 5
         Width = 242
         Height = 92
@@ -12665,7 +12727,7 @@
     object Splitter2: TSpTBXSplitter
       Left = 4
       Top = 305
-      Width = 813
+      Width = 811
       Height = 6
       Cursor = crSizeNS
       Caption = 'Splitter1'
@@ -12674,7 +12736,7 @@
     object SpTBXSplitter2: TSpTBXSplitter
       Left = 4
       Top = 420
-      Width = 813
+      Width = 811
       Height = 6
       Cursor = crSizeNS
       Caption = 'SpTBXSplitter2'
@@ -12979,8 +13041,8 @@
     Top = 427
   end
   object LadderPopupMenu: TSpTBXPopupMenu
-    Left = 676
-    Top = 483
+    Left = 748
+    Top = 491
     object SpTBXItem9: TSpTBXItem
       Caption = 'Rules'
       OnClick = SpTBXItem9Click
@@ -13010,4 +13072,21 @@
     Left = 245
     Top = 64
   end
+  object QuickLookChangedTmr: TTimer
+    Interval = 0
+    OnTimer = QuickLookChangedTmrTimer
+    Left = 453
+    Top = 142
+  end
+  object SpringSettingsProfilePopupMenu: TSpTBXPopupMenu
+    OnInitPopup = SpringSettingsProfilePopupMenuInitPopup
+    Left = 668
+    Top = 490
+    object sspDefaultItem: TSpTBXItem
+      Caption = 'default'
+      OnClick = sspDefaultItemClick
+    end
+    object SpTBXSeparatorItem13: TSpTBXSeparatorItem
+    end
+  end
 end

Modified: Lobby/TASClient/BattleFormUnit.pas
===================================================================
--- Lobby/TASClient/BattleFormUnit.pas	2009-01-22 02:29:22 UTC (rev 7227)
+++ Lobby/TASClient/BattleFormUnit.pas	2009-01-25 20:19:00 UTC (rev 7228)
@@ -54,6 +54,7 @@
     Name: String;
     Description: String;
     Section: String;
+    hasChanged: Boolean;
     function GetComponent(AOwner: TWinControl;luaOptionList: TList):TWinControl;virtual;
     procedure SetValue(v: String);virtual;
     procedure OnChange(Sender: TObject);virtual;
@@ -150,6 +151,7 @@
     procedure Disable;override;
     procedure setToDefault();override;
     function toString:String;override;
+    function nameToString:String;
     destructor Destroy; override;
   end;
   
@@ -321,6 +323,14 @@
     MetalMapImage: TImage;
     HeightMapPanel: TSpTBXPanel;
     HeightMapImage: TImage;
+    QuickLookTab: TSpTBXTabItem;
+    SpTBXTabSheet6: TSpTBXTabSheet;
+    QuickLookChangedTmr: TTimer;
+    SSProfileButton: TSpTBXButton;
+    SpringSettingsProfilePopupMenu: TSpTBXPopupMenu;
+    sspDefaultItem: TSpTBXItem;
+    SpTBXSeparatorItem13: TSpTBXSeparatorItem;
+    QuickLookRichEdit: TRichEdit;
 
     procedure CreateParams(var Params: TCreateParams); override;
 
@@ -349,7 +359,7 @@
     procedure ChangeMapToNoMap(MapName: string); // use 'MapName' to display missing map caption
     procedure ChangeMapToFirstOne;
     procedure ChangeMap(MapIndex: Integer); // 'MapIndex' refers to index in Utility.MapList
-    procedure CheckMapSync;
+    procedure CheckBattleSync;
     procedure PopulatePopupMenuMapList;
     procedure PopulatePopupMenuMapListF(filter: string = ''); // will populate 'MapsPopupMenu' with map names
     procedure MapsPopupMenuItemClick(Sender: TObject);
@@ -536,6 +546,14 @@
     procedure MetalMapPanelResize(Sender: TObject);
     procedure HeightMapPanelResize(Sender: TObject);
     procedure MapsTabsActiveTabChange(Sender: TObject; TabIndex: Integer);
+    procedure RefreshQuickLookText;
+    procedure QuickLookChangedTmrTimer(Sender: TObject);
+    procedure SpringSettingsProfilePopupMenuInitPopup(Sender: TObject;
+      PopupView: TTBView);
+    procedure OnSpringSettingsProfileItemClick(Sender: TObject);
+    procedure sspDefaultItemClick(Sender: TObject);
+    procedure QuickLookRichEditMouseMove(Sender: TObject;
+      Shift: TShiftState; X, Y: Integer);
   private
     History: TWideStringList;
     HistoryIndex: Integer;
@@ -549,6 +567,7 @@
     FCurrentModName: string; // index of currently loaded map. -1 for none.
     procedure SetMyReadyStatus(Status: Boolean); // sets FMyReadyStatus
   public
+    SpringSettingsProfile: string;
     ModOptionsList: TList;
     MapOptionsList: TList;
     UnknownScriptTagList:
@@ -564,6 +583,8 @@
     MapHeight: TMapData;
     MapHeightWidth: integer;
     MapHeightHeight: integer;
+    QuickLookHints: TStringList;
+
     property CurrentMapIndex: Integer read FCurrentMapIndex; // only ChangeMap method may change it!
     property CurrentModName: String read FCurrentModName; // only ChangeMap method may change it!
     property AmIReady: Boolean read FMyReadyStatus write SetMyReadyStatus;
@@ -575,6 +596,7 @@
     procedure DisconnectButtonClick;overload;
     procedure PopulateDisabledUnitsVDT;
     function isBattleReadyToStart: Boolean;
+
   end;
 
   TBattleParticipation = (None, Hosting, Joined);
@@ -642,6 +664,7 @@
       proc_info: TProcessInformation;
       startinfo: TStartupInfo;
       ExitCode: LongWord;
+      WindowHandle : HWND;
     end;
 
     LadderIndex: integer;
@@ -682,6 +705,7 @@
   { similar to AllowBattleStatusUpdate, only for battle details }
 
   procedure FreeReplayClients; // free-s BattleReplayInfo.OriginalClients; NOTE: it doesn't free the list itself, only clients!
+  function GetWindowHwnd(Handle : HWND; lParam : LPARAM) : Boolean;stdcall;
 
 implementation
 
@@ -692,7 +716,7 @@
   CustomColorUnit, StringParser, MapListFormUnit, AutoTeamsUnit,
   AutoStartRectsUnit, ColorPicker, UploadReplayUnit, ProgressBarWindow,
   TntWideStrings, LobbyScriptUnit, SpringDownloaderFormUnit,
-  MapSelectionFormUnit, TipsFormUnit;
+  MapSelectionFormUnit, TipsFormUnit, SpringSettingsProfileFormUnit;
 
 {$R *.dfm}
 
@@ -1144,25 +1168,43 @@
 
   MapImage.Hint := 'No map';
 
-  CheckMapSync;
+  RefreshQuickLookText;
 
+  CheckBattleSync;
+
   SendMyBattleStatusToServer;
   MinimapPanelResize(nil);
+  MetalMapPanelResize(nil);
+  HeightMapPanelResize(nil);
 end;
 
-procedure TBattleForm.CheckMapSync;
+procedure TBattleForm.CheckBattleSync;
+var
+  mapSynced,modSynced : Boolean;
 begin
   if IsBattleActive then
     if BattleState.Status = Hosting then
       Status.Synced := true
     else
+    begin
+      mapSynced := True;
+      modSynced := True;
+
       if not (CurrentMapIndex = -1) and not (Utility.MapChecksums[CurrentMapIndex] = IntToHex(BattleState.Battle.MapHash,8)) then
       begin
-        Status.Synced := false;
-        AddTextToChat('Your map differs from the host''s one.',Colors.Error,1);
-      end
-      else
-        Status.Synced := GetModHash(BattleState.Battle.ModName) = BattleState.Battle.HashCode;
+        mapSynced := False;
+        if BattleState.Status &lt;&gt; None then
+          AddTextToChat('Your map differs from the host''s one.',Colors.Error,1);
+      end;
+      if GetModHash(BattleState.Battle.ModName) &lt;&gt; BattleState.Battle.HashCode then
+      begin
+        modSynced := False;
+        if BattleState.Status &lt;&gt; None then
+          AddTextToChat('Your mod differs from the host''s one.',Colors.Error,1);
+      end;
+
+      Status.Synced := mapSynced and modSynced;
+    end;
 end;
 
 procedure TBattleForm.ChangeMapToFirstOne;
@@ -1216,6 +1258,8 @@
     end;
   end;
 
+  HeightMapImage.Refresh;
+
   // load the metal map in the corresponding TImage
   MapMetal := Utility.getMetalMap(Utility.MapList[MapIndex],MapMetalWidth,MapMetalHeight);
   MetalMapImage.Picture.Graphic.Width := MapMetalWidth;
@@ -1234,6 +1278,8 @@
     end;
   end;
 
+  MetalMapImage.Refresh;
+
   // get the total amount of metal of that map
   TotalMetal := 0;
   for i:=1 to Length(MapMetal) do
@@ -1265,10 +1311,13 @@
   LoadMapOptionsDefault;
   panelMapOptionsDefault.Visible := MapOptionsList.Count &gt; 0;
   MapTab.Caption := 'Map options ('+IntToStr(BattleForm.MapOptionsList.Count)+')';
+  RefreshQuickLookText;
 
   MinimapPanelResize(nil);
+  MetalMapPanelResize(nil);
+  HeightMapPanelResize(nil);
 
-  CheckMapSync;
+  CheckBattleSync;
 
   SendMyBattleStatusToServer;
   SendLuaOptionsDetailsToServer;
@@ -1358,6 +1407,7 @@
   script:string;
   scriptGenerationResult: boolean;
   r: string;
+  params: string;
 begin
   if not IsBattleActive then Exit; // this should not happen
 
@@ -1365,8 +1415,12 @@
 
   if Utility.MapList.indexOf(BattleState.Battle.Map) = -1 then
   begin
-    MessageDlg('You don''t have the map and cannot join the game.',mtWarning,[mbOk],0);
-    Exit;
+    ReloadMapListButtonClick(nil);
+    if Utility.MapList.indexOf(BattleState.Battle.Map) = -1 then
+    begin
+      MessageDlg('You don''t have the map and cannot join the game.',mtWarning,[mbOk],0);
+      Exit;
+    end;
   end;
 
   if (BattleState.Status = Hosting) then
@@ -1413,25 +1467,42 @@
   else
     springexe := 'spring.exe';
 
-  r := 'script.txt';
+  params := 'script.txt';
+  r := SpringSettingsProfileForm.getSettingsFile(Status.Me.GetMode = 0,SpringSettingsProfile &lt;&gt; '',SpringSettingsProfile);
+  if r &lt;&gt; '' then
+    params := '/C '+r+' '+params;
+
   AcquireMainThread;
-  try if not Preferences.ScriptsDisabled then r := handlers.onStartSpring('script.txt'); except end;
+  if not Preferences.ScriptsDisabled then
+  begin
+    try
+      r := handlers.onStartSpring(params);
+    except
+      r := 'None';
+    end;
+    if r &lt;&gt; 'None' then
+      params := r;
+  end;
   ReleaseMainThread;
 
-  if r = 'None' then
-    r := 'script.txt';
-
-  if CreateProcess(nil, PChar(ExtractFilePath(Application.ExeName) + springexe + ' ' + r), nil, nil, false, CREATE_DEFAULT_ERROR_MODE + NORMAL_PRIORITY_CLASS + SYNCHRONIZE,
+  if CreateProcess(nil, PChar(ExtractFilePath(Application.ExeName) + springexe + ' ' + params), nil, nil, false, CREATE_DEFAULT_ERROR_MODE + NORMAL_PRIORITY_CLASS + SYNCHRONIZE,
                    nil, PChar(ExtractFilePath(Application.ExeName)), BattleState.Process.startinfo, BattleState.Process.proc_info) then
   begin
-    
+    {*Sleep(1000);
+    BattleState.Process.WindowHandle := 0;
+    if EnumThreadWindows(<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">BattleState.Process.proc_info.dwThreadId, at GetWindowHwnd</A>,0) then
+    begin
+      MoveWindow(BattleState.Process.WindowHandle,0,0,Screen.Width,Screen.Height,True);
+      //ShowWindow(BattleState.Process.WindowHandle,SW_MAXIMIZE);
+    end;*}
+
     AddTextToChat('Game launched', Colors.Info, 1);
     Status.AmIInGame := True;
     MainForm.TryToSendCommand('MYSTATUS', '1');
     GameTimer.Enabled := True;
     BattleState.Battle.RefreshRanksNCupsOnSuccessReport := True;
     if (BattleState.Status = Hosting) and not BattleState.Battle.Locked then
-      LockedCheckBoxClick(nil);  
+      LockedCheckBoxClick(nil);
   end
   else
   begin
@@ -1502,8 +1573,6 @@
   BattleState.Battle.RemoveAllBots;
   UpdateClientsListBox;
 
-  BattleState.Status := Joined;
-
   PopulatePopupMenuMapList;
 
   // update map:
@@ -1538,6 +1607,8 @@
 
   AddTextToChat('Joined battle', Colors.Info, 1);
 
+  BattleState.Status := Joined;
+
   ResetStartRects;
   BattleForm.Caption := 'Battle window (' + BattleState.Battle.ModName + ')'; // this has no effect since battle form was skinned using TSpTBXTitleBar!
   SpTBXTitleBar1.Caption := 'Battle window (' + BattleState.Battle.ModName + ')';
@@ -1753,6 +1824,8 @@
 
   AddTextToChat('Battle opened', Colors.Info, 1);
 
+  RefreshQuickLookText;
+
   TipsForm.ShowTips(1);
 
 //*** anything else?
@@ -1936,6 +2009,8 @@
 
   MapSelectionForm.FilterTextBox.Text := '';
 
+  RefreshQuickLookText;
+
   MainForm.ResetAutoKickMsgSentCounters;
   MainForm.ResetAutoSpecMsgSentCounters;
 //*** anything else?
@@ -2245,6 +2320,8 @@
     2: Script.AddOrChangeKeyValue('GAME/SourcePort',IntToStr(FIRST_UDP_SOURCEPORT + MyPlayerNum - 1{skip the host}));
     end; // of case sentence
   Script.AddOrChangeKeyValue('GAME/MyPlayerNum',IntToStr(MyPlayerNum));
+  Script.AddOrChangeKeyValue('GAME/MyPlayerName',Status.Me.Name);
+  Script.AddOrChangeKeyValue('GAME/IsHost',BoolToStr(BattleState.Status = Hosting));
   Script.AddOrChangeKeyValue('GAME/NumPlayers',IntToStr(BattleState.Battle.Clients.Count));
   Script.AddOrChangeKeyValue('GAME/NumTeams',IntToStr(NumberOfTeams));
   Script.AddOrChangeKeyValue('GAME/NumAllyTeams',IntToStr(NumberOfAllyTeams));
@@ -2385,6 +2462,9 @@
   else
     Script.AddOrChangeKeyValue('GAME/Demofile','multiplayer replay');
 
+  Script.AddOrChangeKeyValue('GAME/MyPlayerName',Status.Me.Name);
+  Script.AddOrChangeKeyValue('GAME/IsHost',BoolToStr(BattleState.Status = Hosting));
+
   if BattleState.Status = Hosting then
   begin
     Script.ChangeHostIP('localhost');
@@ -2411,6 +2491,7 @@
   for i := 0 to BattleReplayInfo.OriginalClients.Count-1 do
   begin
     Script.AddOrChangeKeyValue('GAME/PLAYER'+IntToStr(i)+'/IsFromDemo','1');
+    Script.AddOrChangeKeyValue('GAME/PLAYER'+IntToStr(i)+'/Name',Script.ReadKeyValue('GAME/PLAYER'+IntToStr(i)+'/Name')+'_Replay');
   end;
   for i := 0 to BattleState.Battle.Clients.Count-1 do
   begin
@@ -2462,7 +2543,7 @@
   SendMessage(ChatRichEdit.Handle, EM_AUTOURLDETECT, Integer(True), 0);
 
   MapImage.Picture.Bitmap.Assign(NoMapImage.Picture.Bitmap);
-  ChangeMapToNoMap('Loading...');
+  //ChangeMapToNoMap('Loading...');
   // we will load map list and current map once everything else gets initialized!
 
   BattleState.DrawingStartRect := -1;
@@ -2507,6 +2588,8 @@
   PreferencesForm.LoadDefaultBattlePreferencesFromRegistry;
 
   TJvXPCustomButtonHack(ReadyButton).Color := clBtnFace; // so that the button corners will be drawn correctly
+
+  QuickLookHints := TStringList.Create;
 end;
 
 procedure TBattleForm.FormDestroy(Sender: TObject);
@@ -2603,8 +2686,6 @@
   tmp: Integer;
   url: string;
 begin
-  X := Round(100*X/MapImage.Width);
-  Y := Round(100*Y/MapImage.Height);
   if Button &lt;&gt; mbLeft then Exit;
   if CurrentMapIndex = -1 then // user does not have this map
   begin
@@ -2622,6 +2703,8 @@
     end;
     Exit;
   end;
+  X := Round(100*X/MapImage.Width);
+  Y := Round(100*Y/MapImage.Height);
 
   if (TImage(Sender).Cursor = crCross) and (BattleState.Status = Hosting) and (BattleState.Battle.BattleType =0) then
   begin
@@ -2660,15 +2743,18 @@
 
   // open larger minimap:
   with GetMapItem(CurrentMapIndex) do
-  if MapInfo.Width &gt; MapInfo.Height then
   begin
-    MinimapZoomedForm.ClientWidth := 600;
-    MinimapZoomedForm.ClientHeight := Round(MinimapZoomedForm.ClientWidth * MapInfo.Height / MapInfo.Width);
-  end
-  else
-  begin
-    MinimapZoomedForm.ClientHeight := 600;
-    MinimapZoomedForm.ClientWidth := Round(MinimapZoomedForm.ClientHeight * MapInfo.Width / MapInfo.Height );
+    if (MapInfo.Width = 0) or (MapInfo.Height = 0) then Exit;
+    if MapInfo.Width &gt; MapInfo.Height then
+    begin
+      MinimapZoomedForm.ClientWidth := 600;
+      MinimapZoomedForm.ClientHeight := Round(MinimapZoomedForm.ClientWidth * MapInfo.Height / MapInfo.Width);
+    end
+    else
+    begin
+      MinimapZoomedForm.ClientHeight := 600;
+      MinimapZoomedForm.ClientWidth := Round(MinimapZoomedForm.ClientHeight * MapInfo.Width / MapInfo.Height );
+    end;
   end;
 
   MinimapZoomedForm.Image1.Width := MinimapZoomedForm.ClientWidth ;
@@ -2693,7 +2779,7 @@
 begin
 
   for i:=0 to High(BattleState.StartRects) do
-    if BattleState.StartRects[i].PaintBox &lt;&gt; nil then
+    if BattleState.StartRects[i].Enabled then
       BattleState.StartRects[i].PaintBox.Parent := TImage(Sender).Parent;
 
   X := Round(100*X/TImage(Sender).Width);
@@ -4948,8 +5034,12 @@
     InitWaitForm.ShowModal;
 
     if Utility.MapList.IndexOf(Preferences.LastOpenMap) = -1 then
-      BattleForm.ChangeMap(0) // load first map in the list
-    else BattleForm.ChangeMap(Utility.MapList.IndexOf(Preferences.LastOpenMap)); // restore last open map
+      if Utility.MapList.Count = 0 then
+        BattleForm.ChangeMapToNoMap('NoMap')
+      else
+        BattleForm.ChangeMap(0) // load first map in the list
+    else
+      BattleForm.ChangeMap(Utility.MapList.IndexOf(Preferences.LastOpenMap)); // restore last open map
   end;
 end;
 
@@ -5939,7 +6029,8 @@
   i : integer;
 begin
   Result := nil;
-  if Section = '' then Exit;
+  if Section = '' then
+    Section := '__defaultSection__';
 
   for i:=0 to luaOptionList.Count-1 do
     if TLuaOption(luaOptionList[i]).ClassType = TLuaOptionSection then
@@ -5974,9 +6065,10 @@
     if sec &lt;&gt; nil then
     begin
       AOwner := sec;
-      sec.Height := sec.Height + 18;
     end;
 
+    AOwner.Height := AOwner.Height + 18;
+
     LabelName := TSpTBXLabel.Create(AOwner);
     LabelName.Parent := AOwner;
     LabelName.Caption := Name + ' : Unknown option type';
@@ -5998,9 +6090,10 @@
     if sec &lt;&gt; nil then
     begin
       AOwner := sec;
-      sec.Height := sec.Height + 23;
     end;
 
+    AOwner.Height := AOwner.Height + 23;
+
     Panel := TPanel.Create(AOwner);
     Panel.Parent := AOwner;
     Panel.BevelOuter := bvNone;
@@ -6046,9 +6139,10 @@
     if sec &lt;&gt; nil then
     begin
       AOwner := sec;
-      sec.Height := sec.Height + 23;
     end;
 
+    AOwner.Height := AOwner.Height + 20;
+
     Panel := TPanel.Create(AOwner);
     Panel.Parent := AOwner;
     Panel.BevelOuter := bvNone;
@@ -6112,9 +6206,10 @@
     if sec &lt;&gt; nil then
     begin
       AOwner := sec;
-      sec.Height := sec.Height + 18;
     end;
 
+    AOwner.Height := AOwner.Height + 20;
+
     Panel := TPanel.Create(AOwner);
     Panel.Parent := AOwner;
     Panel.BevelOuter := bvNone;
@@ -6155,11 +6250,12 @@
   begin
     Panel := TSpTBXGroupBox.Create(AOwner);
     Panel.Parent := AOwner;
-    Panel.Height := 18;
+    Panel.Height := 23;
     Panel.Caption := Name;
     Panel.ShowHint := True;
     Panel.Hint := Description;
     Panel.Font.Style := [fsBold];
+    Panel.TBXStyleBackground := False;
     //MakeDescriptionButton(Panel);
   end;
   Result := Panel;
@@ -6177,9 +6273,10 @@
     if sec &lt;&gt; nil then
     begin
       AOwner := sec;
-      sec.Height := sec.Height + 23;
     end;
 
+    AOwner.Height := AOwner.Height + 23;
+
     Panel := TPanel.Create(AOwner);
     Panel.Parent := AOwner;
     Panel.BevelOuter := bvNone;
@@ -6236,6 +6333,10 @@
 begin
   Result := KeyList[ComboBox.ItemIndex];
 end;
+function TLuaOptionList.nameToString:String;
+begin
+  Result := NameList[ComboBox.ItemIndex];
+end;
 
 function TLuaOptionBool.toString:String;
 begin
@@ -6270,37 +6371,48 @@
 
 procedure TLuaOption.SetValue(v: String);
 begin
-    Value := v;
+  hasChanged := hasChanged or (Value &lt;&gt; v);
+  Value := v;
+  if hasChanged then
+    BattleForm.RefreshQuickLookText;
 end;
 
 procedure TLuaOption.setToDefault;
 begin
-    Value := DefaultValue;
+  hasChanged := hasChanged or (Value &lt;&gt; DefaultValue);
+  Value := DefaultValue;
+  if hasChanged then
+    BattleForm.RefreshQuickLookText;
 end;
 
 procedure TLuaOptionString.SetValue(v: String);
 begin
-    InputEdit.Text := v;
+  inherited;
+  InputEdit.Text := v;
 end;
 
 procedure TLuaOptionString.setToDefault;
 begin
-    InputEdit.Text := DefaultValue;
+  inherited;
+  InputEdit.Text := DefaultValue;
 end;
 
 procedure TLuaOptionList.SetValue(v: String);
 begin
+  inherited;
   ComboBox.ItemIndex := Max(0,KeyList.IndexOf(v));
 end;
 
 procedure TLuaOptionList.setToDefault;
 begin
+  inherited;
   ComboBox.ItemIndex := Max(0,KeyList.IndexOf(DefaultValue));
 end;
 
 procedure TLuaOptionBool.SetValue(v: String);
 begin
-    CheckBox.Checked := StrToBool(v);
+  inherited;
+  CheckBox.Checked := StrToBool(v);
 end;
 
 procedure TLuaOptionSection.setToDefault;
@@ -6313,17 +6425,20 @@
 
 procedure TLuaOptionBool.setToDefault;
 begin
-    CheckBox.Checked := StrToBool(DefaultValue);
+  inherited;
+  CheckBox.Checked := StrToBool(DefaultValue);
 end;
 
 procedure TLuaOptionNumber.SetValue(v: String);
 begin
-    InputEdit.Text := v;
+  inherited;
+  InputEdit.Text := v;
 end;
 
 procedure TLuaOptionNumber.setToDefault;
 begin
-    InputEdit.Text := DefaultValue;
+  inherited;
+  InputEdit.Text := DefaultValue;
 end;
 
 procedure TLuaOption.Enable;
@@ -6693,7 +6808,7 @@
 
 procedure TBattleForm.DownloadMapButtonClick(Sender: TObject);
 begin
-  if CurrentMapIndex = -1 then
+  if (CurrentMapIndex = -1) and BattleForm.IsBattleActive then
   begin
     ReloadMapListButtonClick(nil);
     if CurrentMapIndex = -1 then
@@ -6789,9 +6904,6 @@
     MapImage.Width := Round(mapImgSpaceWidth);
   end;
   RefreshStartRectsPosAndSize;
-
-  MetalMapPanelResize(nil);
-  HeightMapPanelResize(nil);
 end;
 
 procedure TBattleForm.Button1Click(Sender: TObject);
@@ -6959,4 +7071,211 @@
     MapImageMouseMove(HeightMapImage,[],0,0);
 end;
 
+procedure TBattleForm.RefreshQuickLookText;
+var
+  i: integer;
+  SelStart, SelLength: Integer;
+  p: TPoint;
+  procedure SetTitleAttr;
+  begin
+    QuickLookRichEdit.SelAttributes.Name := 'MS Sans Serif';
+    QuickLookRichEdit.SelAttributes.Style := [fsBold];
+    QuickLookRichEdit.SelAttributes.Size := 14;
+    QuickLookRichEdit.SelAttributes.Color := clWindowText;
+  end;
+  procedure SetNormalAttr;
+  begin
+    QuickLookRichEdit.SelAttributes.Name := 'MS Sans Serif';
+    QuickLookRichEdit.SelAttributes.Style := [];
+    QuickLookRichEdit.SelAttributes.Size := 8;
+    QuickLookRichEdit.SelAttributes.Color := clWindowText;
+  end;
+  procedure SetHasChangedAttr;
+  begin
+    QuickLookRichEdit.SelAttributes.Name := 'MS Sans Serif';
+    QuickLookRichEdit.SelAttributes.Style := [fsBold];
+    QuickLookRichEdit.SelAttributes.Size := 8;
+    QuickLookRichEdit.SelAttributes.Color := $00d85600;
+  end;
+  procedure AddTitle(str: string);
+  begin
+    SetTitleAttr;
+    QuickLookRichEdit.SelText := str+EOL;
+    QuickLookHints.Add(str);
+  end;
+  procedure AddLine(caption: string;value: string; valueHasChanged: boolean = false; hint: string = '');
+  begin
+    if valueHasChanged then
+      SetHasChangedAttr
+    else
+      SetNormalAttr;
+    QuickLookRichEdit.SelText := caption +': ';
+    QuickLookRichEdit.SelAttributes.Style := [fsBold];
+    QuickLookRichEdit.SelText := value + EOL;
+    QuickLookHints.Add(hint);
+  end;
+begin
+  // save the scroll pos and selection
+  SelStart := QuickLookRichEdit.SelStart;
+  SelLength := QuickLookRichEdit.SelLength;
+  SendMessage(QuickLookRichEdit.Handle, WM_USER + 221 {EM_GETSCROLLPOS},  0, LPARAM(@p));
+
+  QuickLookRichEdit.Lines.BeginUpdate;
+  QuickLookRichEdit.Text := '';
+
+  if not BattleForm.IsBattleActive then
+  begin
+    QuickLookRichEdit.Lines.EndUpdate;
+    Exit;
+  end;
+
+  AddTitle('Game options');
+  AddLine('Start position',StartPosRadioGroup.Items[StartPosRadioGroup.ItemIndex],StartPosRadioGroup.ItemIndex &lt;&gt; StartPosRadioGroup.Tag,StartPosRadioGroup.Hint);
+  if GameEndRadioGroup.Visible and (GameEndRadioGroup.ItemIndex &gt; -1) then
+    AddLine('Game end condition',GameEndRadioGroup.Items[GameEndRadioGroup.ItemIndex],GameEndRadioGroup.ItemIndex &lt;&gt; GameEndRadioGroup.Tag,GameEndRadioGroup.Hint);
+  if MetalTracker.Visible then
+    AddLine(lblMetal.Caption,IntToStr(MetalTracker.Value),MetalTracker.Value &lt;&gt; MetalTracker.Tag,MetalTracker.Hint);
+  if EnergyTracker.Visible then
+    AddLine(lblEnergy.Caption,IntToStr(EnergyTracker.Value),EnergyTracker.Value &lt;&gt; EnergyTracker.Tag,EnergyTracker.Hint);
+  if UnitsTracker.Visible then
+    AddLine(lblUnits.Caption,IntToStr(UnitsTracker.Value),UnitsTracker.Value &lt;&gt; UnitsTracker.Tag,UnitsTracker.Hint);
+
+  if ModOptionsList.Count &gt; 0 then
+  begin
+    AddTitle('Mod options');
+    for i:=0 to ModOptionsList.Count-1 do
+      if TLuaOption(ModOptionsList[i]).ClassType &lt;&gt; TLuaOptionSection then
+        if TLuaOption(ModOptionsList[i]).ClassType = TLuaOptionBool then
+          AddLine(TLuaOption(ModOptionsList[i]).Name,BoolToStr(TLuaOption(ModOptionsList[i]).toString &lt;&gt; '0',true),TLuaOption(ModOptionsList[i]).hasChanged,TLuaOption(ModOptionsList[i]).Description)
+        else
+          if TLuaOption(ModOptionsList[i]).ClassType = TLuaOptionList then
+            AddLine(TLuaOption(ModOptionsList[i]).Name,TLuaOptionList(ModOptionsList[i]).nameToString,TLuaOption(ModOptionsList[i]).hasChanged,TLuaOption(ModOptionsList[i]).Description)
+          else
+            AddLine(TLuaOption(ModOptionsList[i]).Name,TLuaOption(ModOptionsList[i]).toString,TLuaOption(ModOptionsList[i]).hasChanged,TLuaOption(ModOptionsList[i]).Description);
+  end;
+
+  if MapOptionsList.Count &gt; 0 then
+  begin
+    AddTitle('Map options');
+    for i:=0 to MapOptionsList.Count-1 do
+      if TLuaOption(MapOptionsList[i]).ClassType &lt;&gt; TLuaOptionSection then
+        if TLuaOption(MapOptionsList[i]).ClassType = TLuaOptionBool then
+          AddLine(TLuaOption(MapOptionsList[i]).Name,BoolToStr(TLuaOption(MapOptionsList[i]).toString &lt;&gt; '0',true),TLuaOption(MapOptionsList[i]).hasChanged,TLuaOption(MapOptionsList[i]).Description)
+        else
+          if TLuaOption(MapOptionsList[i]).ClassType = TLuaOptionList then
+            AddLine(TLuaOption(MapOptionsList[i]).Name,TLuaOptionList(MapOptionsList[i]).nameToString,TLuaOption(MapOptionsList[i]).hasChanged,TLuaOption(MapOptionsList[i]).Description)
+          else
+            AddLine(TLuaOption(MapOptionsList[i]).Name,TLuaOption(MapOptionsList[i]).toString,TLuaOption(MapOptionsList[i]).hasChanged,TLuaOption(MapOptionsList[i]).Description);
+  end;
+
+  if BattleState.DisabledUnits.Count &gt; 0 then
+  begin
+    AddTitle('Disabled units');
+    SetNormalAttr;
+    QuickLookRichEdit.SelText := BattleState.DisabledUnits.Text;
+  end;
+  QuickLookRichEdit.SelText := #0;
+
+  // restore scroll pos and selection
+  QuickLookRichEdit.SelStart := SelStart;
+  QuickLookRichEdit.SelLength := SelLength;
+  SendMessage(QuickLookRichEdit.Handle, WM_USER + 222 {EM_SETSCROLLPOS}, 0, LPARAM(@p));
+
+  QuickLookRichEdit.Lines.EndUpdate;
+end;
+
+function GetWindowHwnd(Handle : HWND; lParam : LPARAM) : Boolean;stdcall;
+begin
+  if BattleState.Process.WindowHandle = 0 then
+    BattleState.Process.WindowHandle := Handle;
+  Result := True;
+end;
+
+procedure TBattleForm.QuickLookChangedTmrTimer(Sender: TObject);
+var
+  i: integer;
+begin
+  for i:=0 To ModOptionsList.Count-1 do
+    TLuaOption(ModOptionsList[i]).hasChanged := False;
+
+  for i:=0 To MapOptionsList.Count-1 do
+    TLuaOption(MapOptionsList[i]).hasChanged := False;
+
+  StartPosRadioGroup.Tag := StartPosRadioGroup.ItemIndex;
+  GameEndRadioGroup.Tag := GameEndRadioGroup.ItemIndex;
+  MetalTracker.Tag := MetalTracker.Value;
+  EnergyTracker.Tag := EnergyTracker.Value;
+  UnitsTracker.Tag := UnitsTracker.Value;
+
+  RefreshQuickLookText;
+
+  QuickLookChangedTmr.Enabled := False;
+end;
+
+procedure TBattleForm.SpringSettingsProfilePopupMenuInitPopup(
+  Sender: TObject; PopupView: TTBView);
+var
+  i: integer;
+begin
+  for i:=SpringSettingsProfilePopupMenu.Items.Count-1 downto 2 do
+    SpringSettingsProfilePopupMenu.Items.Delete(i);
+
+  for i:=0 to SpringSettingsProfileForm.cpNames.Count-1 do
+  begin
+    SpringSettingsProfilePopupMenu.Items.Add(TSpTBXItem.Create(UnbanSubitem));
+    with SpringSettingsProfilePopupMenu.Items[SpringSettingsProfilePopupMenu.Items.Count-1] as TSpTBXItem do
+    begin
+      Caption := SpringSettingsProfileForm.cpNames[i];
+      Tag := i;
+      OnClick := OnSpringSettingsProfileItemClick;
+      Checked := SpringSettingsProfile = SpringSettingsProfileForm.cpNames[i];
+    end;
+  end;
+
+  sspDefaultItem.Checked := SpringSettingsProfile = '';
+end;
+
+procedure TBattleForm.OnSpringSettingsProfileItemClick(Sender: TObject);
+var
+  i: integer;
+begin
+  SpringSettingsProfile := SpringSettingsProfileForm.cpNames[TSpTBXItem(Sender).Tag];;
+end;
+
+procedure TBattleForm.sspDefaultItemClick(Sender: TObject);
+var
+  i: integer;
+begin
+  SpringSettingsProfile := '';
+end;
+
+procedure TBattleForm.QuickLookRichEditMouseMove(Sender: TObject;
+  Shift: TShiftState; X, Y: Integer);
+var
+   ci, //Character Index
+   lix, //Line Index
+   co: integer; //Character Offset
+   Pt: TPoint;
+   s: string;
+   Key: string;
+   mapOptionsLine: integer;
+   modOptionsLine: integer;
+   i: integer;
+begin
+   with TRichEdit(Sender) do
+   begin
+    try
+     Pt := Point(X, Y);
+     ci := Perform(Messages.EM_CHARFROMPOS, 0, Integer(@Pt));
+     if ci &lt; 0 then Exit;
+     lix := Perform(EM_EXLINEFROMCHAR, 0, ci) ;
+
+     if lix &lt; QuickLookHints.Count then
+      Hint := QuickLookHints[lix];
+
+    except
+    end;
+   end;
+end;
+
 end.

Modified: Lobby/TASClient/ColorPicker.dfm
===================================================================
--- Lobby/TASClient/ColorPicker.dfm	2009-01-22 02:29:22 UTC (rev 7227)
+++ Lobby/TASClient/ColorPicker.dfm	2009-01-25 20:19:00 UTC (rev 7228)
@@ -329,7 +329,7 @@
       object ColorToolbar: TSpTBXToolbar
         Left = 384
         Top = 264
-        Width = 72
+        Width = 90
         Height = 72
         Caption = 'ColorToolbar'
         TabOrder = 21

Modified: Lobby/TASClient/CustomizeGUIFormUnit.dfm
===================================================================
--- Lobby/TASClient/CustomizeGUIFormUnit.dfm	2009-01-22 02:29:22 UTC (rev 7227)
+++ Lobby/TASClient/CustomizeGUIFormUnit.dfm	2009-01-25 20:19:00 UTC (rev 7228)
@@ -12,6 +12,7 @@
   Font.Style = []
   Menu = TopMenu
   OldCreateOrder = False
+  Position = poMainFormCenter
   OnClose = FormClose
   OnCreate = FormCreate
   PixelsPerInch = 96
@@ -147,6 +148,8 @@
       Height = 28
       OnControlResize = ResizerControlControlResize
       ResizeObject = roSquare
+      StepX = 4
+      StepY = 4
       Visible = False
     end
   end

Modified: Lobby/TASClient/CustomizeGUIFormUnit.pas
===================================================================
--- Lobby/TASClient/CustomizeGUIFormUnit.pas	2009-01-22 02:29:22 UTC (rev 7227)
+++ Lobby/TASClient/CustomizeGUIFormUnit.pas	2009-01-25 20:19:00 UTC (rev 7228)
@@ -921,7 +921,7 @@
 begin
   newProfileCode := '';
   for i:=0 to history.Count-1 do
-    newProfileCode := newProfileCode + THistoryItem(history[i]).getPythonCode(0) + EOL;
+    newProfileCode := newProfileCode + THistoryItem(history[i]).getPythonCode(0);
 
   for i:=history.Count-1 downto 0 do
   begin
@@ -1104,7 +1104,7 @@
 
   loadProfileCode := '';
   for i:=0 to history.Count-1 do
-    loadProfileCode := loadProfileCode + THistoryItem(history[i]).getPythonCode(0) + EOL;
+    loadProfileCode := loadProfileCode + THistoryItem(history[i]).getPythonCode(0);
 
   profileCode := StringReplace(profileCode,'${unloadProfileContent}',loadProfileCode,[]);
 
@@ -1147,7 +1147,7 @@
 
   profileCode := '';
   for i:=recordHistoryStartIndex to history.Count-1 do
-    profileCode := profileCode + THistoryItem(history[i]).getPythonCode(1) + EOL;
+    profileCode := profileCode + THistoryItem(history[i]).getPythonCode(1);
 
   AssignFile(f, fileName);
   Rewrite(f);
@@ -1173,25 +1173,25 @@
   begin
     if PropertiesListEditor.Cells[0,i] = 'Left' then
     begin
-      PropertiesListEditor.Cells[1,i] := IntToStr((Sender as TControl).Left);
+      PropertiesListEditor.Cells[1,i] := IntToStr((Sender as TControl).Left+6);
       PropertiesListEditor.Row := i;
       PropertiesListEditorStringsChange(PropertiesListEditor);
     end;
     if PropertiesListEditor.Cells[0,i] = 'Top' then
     begin
-      PropertiesListEditor.Cells[1,i] := IntToStr((Sender as TControl).Top);
+      PropertiesListEditor.Cells[1,i] := IntToStr((Sender as TControl).Top+6);
       PropertiesListEditor.Row := i;
       PropertiesListEditorStringsChange(PropertiesListEditor);
     end;
     if PropertiesListEditor.Cells[0,i] = 'Width' then
     begin
-      PropertiesListEditor.Cells[1,i] := IntToStr((Sender as TControl).Width);
+      PropertiesListEditor.Cells[1,i] := IntToStr((Sender as TControl).Width-12);
       PropertiesListEditor.Row := i;
       PropertiesListEditorStringsChange(PropertiesListEditor);
     end;
     if PropertiesListEditor.Cells[0,i] = 'Height' then
     begin
-      PropertiesListEditor.Cells[1,i] := IntToStr((Sender as TControl).Height);
+      PropertiesListEditor.Cells[1,i] := IntToStr((Sender as TControl).Height-12);
       PropertiesListEditor.Row := i;
       PropertiesListEditorStringsChange(PropertiesListEditor);
     end;
@@ -1220,7 +1220,7 @@
     if DisplayResizer1.Checked then
     begin
       ResizerControl.HandleObject := TControl(NodeControl[i]);
-      CustomizeGUIForm.SetFocus;
+      //CustomizeGUIForm.SetFocus;
     end
     else
       ResizerControl.HandleObject := nil;

Modified: Lobby/TASClient/HostBattleFormUnit.pas
===================================================================
--- Lobby/TASClient/HostBattleFormUnit.pas	2009-01-22 02:29:22 UTC (rev 7227)
+++ Lobby/TASClient/HostBattleFormUnit.pas	2009-01-25 20:19:00 UTC (rev 7228)
@@ -623,6 +623,14 @@
       Exit;
   end;
 
+  if BattleForm.IsBattleActive then
+  begin
+    if MessageDlg('You are already in a battle, do you want to leave it ?',mtInformation,[mbYes, mbNo],0) = mrYes then
+      BattleForm.DisconnectButtonClick(nil)
+    else
+      Exit;
+  end;
+
   if NATRadioGroup.ItemIndex = 1 then  // &quot;hole punching&quot; method
   begin
     // let's acquire our public UDP source port from the server:

Deleted: Lobby/TASClient/Interface/defaultMissionBriefing.html
===================================================================
--- Lobby/TASClient/Interface/defaultMissionBriefing.html	2009-01-22 02:29:22 UTC (rev 7227)
+++ Lobby/TASClient/Interface/defaultMissionBriefing.html	2009-01-25 20:19:00 UTC (rev 7228)
@@ -1,32 +0,0 @@
-&lt;html&gt;
-&lt;head&gt;
-	&lt;script type=&quot;text/javascript&quot; src=&quot;default.js&quot;&gt;&lt;/script&gt;
-	&lt;style type=&quot;text/css&quot;&gt;
-		@import &quot;default.css&quot;;
-
-		a img{
-			border: 0;
-		}
-	&lt;/style&gt;
-&lt;/head&gt;
-&lt;body&gt;
-	&lt;img src=&quot;images\background.jpg&quot; style=&quot;height:100%;position: absolute; top:0;left:0;z-index:-1&quot;  /&gt;
-	&lt;div id=&quot;bar&quot; style=&quot;position:absolute;left:10%;top:0;width:80%;height:100%;filter : alpha(opacity=44);background-color: black&quot;&gt;&lt;/div&gt;
-	&lt;div style=&quot;border: 0;position:absolute;left:10%;top:0;width:80%;height:100%;&quot;&gt;
-		&lt;div style=&quot;margin-bottom:20px;margin:10px;&quot;&gt;
-			&lt;h1&gt;[MissionName]&lt;/h1&gt;
-		&lt;/div&gt;
-		&lt;div id=&quot;briefing&quot; style=&quot;margin: 20px;width: 100%;height: 60%;background-color: black;border: 1px solid #6c4a36;filter : alpha(opacity=44);overflow: auto;padding: 10px;color: #ffa573&quot;&gt;
-			&lt;h2&gt;Briefing&lt;/h2&gt;
-			[MissionBriefing]
-		&lt;/div&gt;
-		&lt;div class=&quot;footer&quot;&gt;
-			&lt;a href=&quot;lobby:back&quot; class=&quot;button&quot; style=&quot;float: left;&quot; onmouseover=&quot;sendData('playsound:button.wav');&quot;&gt;Back&lt;/a&gt;
-			&lt;a href=&quot;lobby:startmission&quot; class=&quot;button&quot; style=&quot;float: right;margin-right:20px;&quot; onmouseover=&quot;sendData('playsound:button.wav');&quot;&gt;START&lt;/a&gt;
-		&lt;/div&gt;
-	&lt;/div&gt;
-&lt;/body&gt;
-&lt;/html&gt;
-&lt;script type=&quot;text/javascript&quot;&gt;
-	document.getElementById('briefing').style.height = document.getElementById('bar').style.pixelHeight - 130 + 'px';
-&lt;/script&gt;
\ No newline at end of file

Modified: Lobby/TASClient/Interface/selectmod.html
===================================================================
--- Lobby/TASClient/Interface/selectmod.html	2009-01-22 02:29:22 UTC (rev 7227)
+++ Lobby/TASClient/Interface/selectmod.html	2009-01-25 20:19:00 UTC (rev 7228)
@@ -24,6 +24,9 @@
 					&lt;/div&gt;
 				&lt;/td&gt;
 			&lt;/tr&gt;
+			&lt;tr&gt;
+				&lt;td style=&quot;height; 30px&quot;&gt;&lt;a href=&quot;lobby:back&quot; class=&quot;button&quot; onmouseover=&quot;sendData('playsound:button.wav');&quot; style=&quot;float: left&quot;&gt;Back&lt;/a&gt;&lt;/td&gt;
+			&lt;/tr&gt;
 		&lt;/table&gt;
 	&lt;/div&gt;
 &lt;/body&gt;

Modified: Lobby/TASClient/LobbyScriptUnit.pas
===================================================================
--- Lobby/TASClient/LobbyScriptUnit.pas	2009-01-22 02:29:22 UTC (rev 7227)
+++ Lobby/TASClient/LobbyScriptUnit.pas	2009-01-25 20:19:00 UTC (rev 7228)
@@ -928,6 +928,7 @@
       pyO := PyDict_New();
       PyDict_SetItemStringDecRef( pyO, 'Name', ServerList[i].Name );
       PyDict_SetItemStringDecRef( pyO, 'Address', ServerList[i].Address );
+      PyDict_SetItemStringDecRef( pyO, 'Port', ServerList[i].Port );
 
       PyList_Append(pyServers,pyO);
       Py_XDECREF(pyO);
@@ -945,6 +946,7 @@
   values : PPyObject;
   addressList : TStringList;
   nameList : TStringList;
+  portList: TStringList;
   i : integer;
 begin
   with GetPythonEngine do
@@ -958,6 +960,7 @@
 
     nameList := TStringList.Create;
     addressList := TStringList.Create;
+    portList := TStringList.Create;
 
     for i:=0 to PyList_Size(serversPyList)-1 do
     begin
@@ -971,6 +974,7 @@
       try
         nameList.Add(PyString_AsString(PyDict_GetItemString(server,'Name')));
         addressList.Add(PyString_AsString(PyDict_GetItemString(server,'Address')));
+        portList.Add(PyString_AsString(PyDict_GetItemString(server,'Port')));
       except
         Print('SetServers error : server '+IntToStr(i)+' does not contain all needed informations.');
         Exit;
@@ -983,6 +987,7 @@
     begin
       ServerList[i].Name := nameList[i];
       ServerList[i].Address := addressList[i];
+      ServerList[i].Port := addressList[i];
     end;
 
     PreferencesForm.PopulateServerListMenu;
@@ -1744,6 +1749,7 @@
 begin
   Result := False;
 
+  LockGUI;
   try
     Result := True;
     with GetPythonEngine do
@@ -1823,9 +1829,11 @@
     end;
 
     c.Refresh;
+    //Sleep(15);
   except
     Result := False;
   end;
+  UnlockGUI;
 end;
 
 
@@ -2365,7 +2373,7 @@
 procedure HostBattle;
 begin
   HostBattleForm.HostButtonClick(HostBattleForm.HostButton);
-  setFocusRecursively(BattleForm.InputEdit);
+  Misc.ShowAndSetFocus(BattleForm.InputEdit);
   ScriptHostingRunning := False;
   ScriptHostingReplayRunning := False;
 end;

Modified: Lobby/TASClient/LogonFormUnit.dfm
===================================================================
--- Lobby/TASClient/LogonFormUnit.dfm	2009-01-22 02:29:22 UTC (rev 7227)
+++ Lobby/TASClient/LogonFormUnit.dfm	2009-01-25 20:19:00 UTC (rev 7228)
@@ -15,7 +15,7 @@
   Font.Style = []
   FormStyle = fsStayOnTop
   OldCreateOrder = False
-  Position = poScreenCenter
+  Position = poMainFormCenter
   OnCreate = FormCreate
   OnShow = FormShow
   PixelsPerInch = 96

Modified: Lobby/TASClient/MainUnit.dfm
===================================================================
--- Lobby/TASClient/MainUnit.dfm	2009-01-22 02:29:22 UTC (rev 7227)
+++ Lobby/TASClient/MainUnit.dfm	2009-01-25 20:19:00 UTC (rev 7228)
@@ -1,8 +1,8 @@
 object MainForm: TMainForm
-  Left = 499
-  Top = 223
-  Width = 781
-  Height = 550
+  Left = 391
+  Top = 133
+  Width = 776
+  Height = 548
   Caption = '.'
   Color = clBtnFace
   Constraints.MaxHeight = 1000
@@ -24,8 +24,8 @@
   object MainTitleBar: TSpTBXTitleBar
     Left = 0
     Top = 0
-    Width = 773
-    Height = 523
+    Width = 768
+    Height = 521
     Caption = 'TASClient'
     TBXStyleBackground = True
     object DefaultSideImage: TImage
@@ -203,142 +203,20 @@
       Transparent = True
       Visible = False
     end
-    object Panel2: TSpTBXPanel
-      Left = 616
-      Top = 30
-      Width = 153
-      Height = 489
-      Align = alRight
-      Color = clNone
-      Constraints.MinWidth = 1
-      ParentColor = False
-      TabOrder = 1
-      Borders = False
-      BorderType = pbrFramed
-      object ClientsListBox: TTntListBox
-        Tag = -1
-        Left = 2
-        Top = 30
-        Width = 149
-        Height = 457
-        Style = lbOwnerDrawFixed
-        Align = alClient
-        Font.Charset = DEFAULT_CHARSET
-        Font.Color = clWindowText
-        Font.Height = -11
-        Font.Name = 'Fixedsys'
-        Font.Style = []
-        ItemHeight = 16
-        ParentFont = False
-        ParentShowHint = False
-        ShowHint = True
-        TabOrder = 0
-        OnClick = ClientsListBoxClick
-        OnDblClick = ClientsListBoxDblClick
-        OnDrawItem = ClientsListBoxDrawItem
-        OnExit = ClientsListBoxExit
-        OnKeyUp = ClientsListBoxKeyUp
-        OnMouseDown = ClientsListBoxMouseDown
-        OnMouseMove = ClientsListBoxMouseMove
-        OnMouseUp = ClientsListBoxMouseUp
-      end
-      object PlayersInfoPanel: TSpTBXPanel
-        Left = 2
-        Top = 2
-        Width = 149
-        Height = 28
-        Caption = 'PlayersInfoPanel'
-        Align = alTop
-        TabOrder = 1
-        Borders = False
-        BorderType = pbrFramed
-        DesignSize = (
-          149
-          28)
-        object SortLabel: TLabel
-          Left = 119
-          Top = 8
-          Width = 24
-          Height = 13
-          Cursor = crHandPoint
-          Alignment = taRightJustify
-          Anchors = [akTop, akRight]
-          Caption = 'Sort'
-          Color = clNone
-          Font.Charset = DEFAULT_CHARSET
-          Font.Color = clBlue
-          Font.Height = -11
-          Font.Name = 'MS Sans Serif'
-          Font.Style = [fsBold, fsUnderline]
-          ParentColor = False
-          ParentFont = False
-          Transparent = True
-          OnClick = SortLabelClick
-        end
-        object btSearchPlayer: TSpTBXSpeedButton
-          Left = 4
-          Top = 4
-          Width = 22
-          Height = 20
-          Hint = 'Search for a player in the list. Hit F3 to get the next result.'
-          ParentShowHint = False
-          ShowHint = True
-          DropDownArrow = False
-          DropDownMenu = SearchPlayerFormPopupMenu
-          Images = BattleStatusImageList
-          ImageIndex = 6
-          LinkFont.Charset = DEFAULT_CHARSET
-          LinkFont.Color = clBlue
-          LinkFont.Height = -11
-          LinkFont.Name = 'MS Sans Serif'
-          LinkFont.Style = [fsUnderline]
-        end
-        object PlayersLabel: TSpTBXLabel
-          Left = 28
-          Top = 8
-          Width = 37
-          Height = 13
-          Caption = 'Players:'
-          LinkFont.Charset = DEFAULT_CHARSET
-          LinkFont.Color = clBlue
-          LinkFont.Height = -11
-          LinkFont.Name = 'MS Sans Serif'
-          LinkFont.Style = [fsUnderline]
-        end
-      end
-    end
-    object Splitter1: TSpTBXSplitter
-      Left = 606
-      Top = 30
-      Width = 10
-      Height = 489
-      Cursor = crSizeWE
-      Caption = 'Splitter1'
-      Align = alRight
-      GripSize = 100
-    end
     object Panel1: TSpTBXPanel
       Left = 4
-      Top = 30
-      Width = 602
-      Height = 489
+      Top = 71
+      Width = 760
+      Height = 446
       Caption = 'Panel1'
       Align = alClient
-      TabOrder = 3
+      TabOrder = 1
       Borders = False
       TBXStyleBackground = True
-      object Bevel2: TBevel
-        Left = 2
-        Top = 43
-        Width = 598
-        Height = 4
-        Align = alTop
-        Shape = bsSpacer
-      end
       object Panel3: TPanel
         Left = 2
-        Top = 217
-        Width = 598
+        Top = 174
+        Width = 756
         Height = 270
         Align = alBottom
         BevelOuter = bvNone
@@ -346,7 +224,7 @@
         object BattlesPanel: TSpTBXPanel
           Left = 0
           Top = 0
-          Width = 598
+          Width = 756
           Height = 270
           Align = alClient
           TabOrder = 0
@@ -355,7 +233,7 @@
           object QuickJoinPanel: TSpTBXPanel
             Left = 2
             Top = 2
-            Width = 594
+            Width = 752
             Height = 25
             Hint = 'Quick join panel'
             Caption = 'QuickJoinPanel'
@@ -363,7 +241,7 @@
             TabOrder = 1
             Borders = False
             DesignSize = (
-              594
+              752
               25)
             object SpTBXLabel1: TSpTBXLabel
               Left = 0
@@ -387,7 +265,7 @@
               LinkFont.Style = [fsUnderline]
             end
             object btSpecatateNow: TSpTBXButton
-              Left = 495
+              Left = 653
               Top = 0
               Width = 97
               Height = 22
@@ -413,7 +291,7 @@
               LinkFont.Style = [fsUnderline]
             end
             object btPlayNow: TSpTBXButton
-              Left = 389
+              Left = 547
               Top = 0
               Width = 97
               Height = 22
@@ -454,7 +332,7 @@
           object VDTBattles: TVirtualDrawTree
             Left = 2
             Top = 27
-            Width = 594
+            Width = 752
             Height = 56
             Align = alClient
             BevelInner = bvNone
@@ -567,7 +445,7 @@
           object FilterGroup: TSpTBXPanel
             Left = 2
             Top = 95
-            Width = 594
+            Width = 752
             Height = 173
             Caption = 'FilterGroup'
             Align = alBottom
@@ -575,12 +453,12 @@
             OnResize = FilterGroupResize
             Borders = False
             DesignSize = (
-              594
+              752
               173)
             object FiltersTabs: TSpTBXTabControl
               Left = 2
               Top = 2
-              Width = 590
+              Width = 748
               Height = 169
               Align = alClient
               Color = clBtnFace
@@ -602,18 +480,18 @@
               object SpTBXTabSheet2: TSpTBXTabSheet
                 Left = 0
                 Top = 0
-                Width = 590
+                Width = 748
                 Height = 146
                 Caption = 'Presets'
                 ImageIndex = -1
                 DesignSize = (
-                  590
+                  748
                   146)
                 TabItem = 'SpTBXTabItem2'
                 object PresetListbox: TSpTBXListBox
                   Left = 152
                   Top = 26
-                  Width = 425
+                  Width = 583
                   Height = 113
                   Anchors = [akLeft, akTop, akRight]
                   ItemHeight = 16
@@ -703,18 +581,18 @@
               object SpTBXTabSheet1: TSpTBXTabSheet
                 Left = 0
                 Top = 0
-                Width = 590
+                Width = 748
                 Height = 146
                 Caption = 'Filters'
                 ImageIndex = -1
                 DesignSize = (
-                  590
+                  748
                   146)
                 TabItem = 'SpTBXTabItem1'
                 object FilterList: TVirtualStringTree
                   Left = 424
                   Top = 8
-                  Width = 153
+                  Width = 311
                   Height = 129
                   Anchors = [akLeft, akTop, akRight]
                   CheckImageKind = ckSystem
@@ -763,7 +641,7 @@
                     end
                     item
                       Position = 3
-                      Width = 10
+                      Width = 144
                       WideText = 'Value'
                     end&gt;
                 end
@@ -1023,7 +901,7 @@
               end
             end
             object EnableFilters: TSpTBXCheckBox
-              Left = 480
+              Left = 638
               Top = 154
               Width = 110
               Height = 18
@@ -1042,7 +920,7 @@
           object FiltersButton: TSpTBXButton
             Left = 2
             Top = 83
-            Width = 594
+            Width = 752
             Height = 12
             Align = alBottom
             TabOrder = 3
@@ -1059,8 +937,8 @@
       end
       object Splitter2: TSpTBXSplitter
         Left = 2
-        Top = 211
-        Width = 598
+        Top = 168
+        Width = 756
         Height = 6
         Cursor = crSizeNS
         Caption = 'Splitter2'
@@ -1070,137 +948,306 @@
         GripSize = 100
         OnMoving = Splitter2Moving
       end
-      object PageControl1: TPageControl
+      object MainPanel: TSpTBXPanel
         Left = 2
-        Top = 47
-        Width = 598
-        Height = 164
+        Top = 2
+        Width = 756
+        Height = 166
         Align = alClient
-        Constraints.MinHeight = 1
-        Style = tsButtons
         TabOrder = 2
-        TabStop = False
-        OnChange = PageControl1Change
-        OnMouseDown = PageControl1MouseDown
-        OnResize = PageControl1Resize
-      end
-      object Panel4: TSpTBXPanel
-        Left = 2
-        Top = 2
-        Width = 598
-        Height = 41
-        Align = alTop
-        Color = clNone
-        ParentColor = False
-        TabOrder = 3
-        BorderType = pbrRaised
-        TBXStyleBackground = True
-        object OptionsSpeedButton: TSpTBXSpeedButton
-          Left = 328
-          Top = 8
-          Width = 81
-          Height = 25
-          Caption = 'Options'
-          OnClick = OptionsSpeedButtonClick
-          LinkFont.Charset = DEFAULT_CHARSET
-          LinkFont.Color = clBlue
-          LinkFont.Height = -11
-          LinkFont.Name = 'MS Sans Serif'
-          LinkFont.Style = [fsUnderline]
+        Borders = False
+        object PageControl1: TPageControl
+          Left = 2
+          Top = 2
+          Width = 589
+          Height = 162
+          Align = alClient
+          Constraints.MinHeight = 1
+          MultiLine = True
+          Style = tsButtons
+          TabOrder = 0
+          TabStop = False
+          OnChange = PageControl1Change
+          OnMouseDown = PageControl1MouseDown
+          OnResize = PageControl1Resize
         end
-        object BattleScreenSpeedButton: TSpTBXSpeedButton
-          Left = 64
-          Top = 8
-          Width = 81
-          Height = 25
-          Caption = 'Host battle'
-          DropDownMenu = HostBattlePopupMenu
-          LinkFont.Charset = DEFAULT_CHARSET
-          LinkFont.Color = clBlue
-          LinkFont.Height = -11
-          LinkFont.Name = 'MS Sans Serif'
-          LinkFont.Style = [fsUnderline]
-          ThemeType = thtTBX
+        object Panel2: TSpTBXPanel
+          Left = 601
+          Top = 2
+          Width = 153
+          Height = 162
+          Align = alRight
+          Color = clNone
+          Constraints.MinWidth = 1
+          ParentColor = False
+          TabOrder = 1
+          Borders = False
+          BorderType = pbrFramed
+          object ClientsListBox: TTntListBox
+            Tag = -1
+            Left = 2
+            Top = 30
+            Width = 149
+            Height = 130
+            Style = lbOwnerDrawFixed
+            Align = alClient
+            Font.Charset = DEFAULT_CHARSET
+            Font.Color = clWindowText
+            Font.Height = -11
+            Font.Name = 'Fixedsys'
+            Font.Style = []
+            ItemHeight = 16
+            ParentFont = False
+            ParentShowHint = False
+            ShowHint = True
+            TabOrder = 0
+            OnClick = ClientsListBoxClick
+            OnDblClick = ClientsListBoxDblClick
+            OnDrawItem = ClientsListBoxDrawItem
+            OnExit = ClientsListBoxExit
+            OnKeyUp = ClientsListBoxKeyUp
+            OnMouseDown = ClientsListBoxMouseDown
+            OnMouseMove = ClientsListBoxMouseMove
+            OnMouseUp = ClientsListBoxMouseUp
+          end
+          object PlayersInfoPanel: TSpTBXPanel
+            Left = 2
+            Top = 2
+            Width = 149
+            Height = 28
+            Caption = 'PlayersInfoPanel'
+            Align = alTop
+            TabOrder = 1
+            Borders = False
+            BorderType = pbrFramed
+            DesignSize = (
+              149
+              28)
+            object SortLabel: TLabel
+              Left = 119
+              Top = 8
+              Width = 24
+              Height = 13
+              Cursor = crHandPoint
+              Alignment = taRightJustify
+              Anchors = [akTop, akRight]
+              Caption = 'Sort'
+              Color = clNone
+              Font.Charset = DEFAULT_CHARSET
+              Font.Color = clBlue
+              Font.Height = -11
+              Font.Name = 'MS Sans Serif'
+              Font.Style = [fsBold, fsUnderline]
+              ParentColor = False
+              ParentFont = False
+              Transparent = True
+              OnClick = SortLabelClick
+            end
+            object btSearchPlayer: TSpTBXSpeedButton
+              Left = 4
+              Top = 4
+              Width = 22
+              Height = 20
+              Hint = 'Search for a player in the list. Hit F3 to get the next result.'
+              ParentShowHint = False
+              ShowHint = True
+              DropDownArrow = False
+              DropDownMenu = SearchPlayerFormPopupMenu
+              Images = BattleStatusImageList
+              ImageIndex = 6
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object PlayersLabel: TSpTBXLabel
+              Left = 28
+              Top = 8
+              Width = 37
+              Height = 13
+              Caption = 'Players:'
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+          end
         end
-        object HelpButton: TSpTBXSpeedButton
-          Left = 416
-          Top = 8
-          Width = 81
-          Height = 25
-          Caption = 'Help / Links'
-          DropDownMenu = HelpPopupMenu
-          LinkFont.Charset = DEFAULT_CHARSET
-          LinkFont.Color = clBlue
-          LinkFont.Height = -11
-          LinkFont.Name = 'MS Sans Serif'
-          LinkFont.Style = [fsUnderline]
-        end
-        object ReplaysButton: TSpTBXSpeedButton
-          Left = 240
-          Top = 8
-          Width = 81
-          Height = 25
-          Hint = 
-            'Every game you play or spectate are saved so you can re watch th' +
-            'em at any moment.'
-          Caption = 'Replays'
-          ParentShowHint = False
-          ShowHint = True
-          OnClick = ReplaysButtonClick
-          LinkFont.Charset = DEFAULT_CHARSET
-          LinkFont.Color = clBlue
-          LinkFont.Height = -11
-          LinkFont.Name = 'MS Sans Serif'
-          LinkFont.Style = [fsUnderline]
-        end
-        object SearchButton: TSpTBXSpeedButton
-          Left = 504
-          Top = 8
-          Width = 81
-          Height = 25
-          Hint = 'Search for maps, mods and scripts'
-          Caption = 'Search files'
-          ParentShowHint = False
-          ShowHint = True
-          DropDownMenu = SearchFormPopupMenu
-          LinkFont.Charset = DEFAULT_CHARSET
-          LinkFont.Color = clBlue
-          LinkFont.Height = -11
-          LinkFont.Name = 'MS Sans Serif'
-          LinkFont.Style = [fsUnderline]
-        end
-        object ConnectButton: TTBXButton
-          Left = 8
+        object Splitter1: TSpTBXSplitter
+          Left = 591
           Top = 2
-          Width = 49
-          Height = 36
-          Hint = 'Connection/Disconnection and Away message control'
-          BorderSize = 2
-          ButtonStyle = bsFlat
-          DropDownCombo = True
-          DropDownMenu = ConnectionPopupMenu
-          Images = ConnectionStateImageList
-          ParentShowHint = False
-          ShowHint = True
-          TabOrder = 5
-          OnClick = ConnectButtonClick
+          Width = 10
+          Height = 162
+          Cursor = crSizeWE
+          Caption = 'Splitter1'
+          Align = alRight
+          GripSize = 100
         end
-        object SinglePlayerButton: TSpTBXButton
-          Left = 152
-          Top = 8
-          Width = 81
-          Height = 25
-          Caption = 'Single Player'
-          TabOrder = 6
-          OnClick = SinglePlayerButtonClick
-          LinkFont.Charset = DEFAULT_CHARSET
-          LinkFont.Color = clBlue
-          LinkFont.Height = -11
-          LinkFont.Name = 'MS Sans Serif'
-          LinkFont.Style = [fsUnderline]
-        end
       end
     end
+    object Panel4: TSpTBXPanel
+      Left = 4
+      Top = 30
+      Width = 760
+      Height = 41
+      Align = alTop
+      Color = clNone
+      ParentColor = False
+      TabOrder = 2
+      BorderType = pbrRaised
+      TBXStyleBackground = True
+      object OptionsSpeedButton: TSpTBXSpeedButton
+        Left = 328
+        Top = 8
+        Width = 81
+        Height = 25
+        Caption = 'Options'
+        OnClick = OptionsSpeedButtonClick
+        LinkFont.Charset = DEFAULT_CHARSET
+        LinkFont.Color = clBlue
+        LinkFont.Height = -11
+        LinkFont.Name = 'MS Sans Serif'
+        LinkFont.Style = [fsUnderline]
+      end
+      object BattleScreenSpeedButton: TSpTBXSpeedButton
+        Left = 64
+        Top = 8
+        Width = 81
+        Height = 25
+        Caption = 'Host battle'
+        DropDownMenu = HostBattlePopupMenu
+        LinkFont.Charset = DEFAULT_CHARSET
+        LinkFont.Color = clBlue
+        LinkFont.Height = -11
+        LinkFont.Name = 'MS Sans Serif'
+        LinkFont.Style = [fsUnderline]
+        ThemeType = thtTBX
+      end
+      object HelpButton: TSpTBXSpeedButton
+        Left = 416
+        Top = 8
+        Width = 81
+        Height = 25
+        Caption = 'Help / Links'
+        DropDownMenu = HelpPopupMenu
+        LinkFont.Charset = DEFAULT_CHARSET
+        LinkFont.Color = clBlue
+        LinkFont.Height = -11
+        LinkFont.Name = 'MS Sans Serif'
+        LinkFont.Style = [fsUnderline]
+      end
+      object ReplaysButton: TSpTBXSpeedButton
+        Left = 240
+        Top = 8
+        Width = 81
+        Height = 25
+        Hint = 
+          'Every game you play or spectate are saved so you can re watch th' +
+          'em at any moment.'
+        Caption = 'Replays'
+        ParentShowHint = False
+        ShowHint = True
+        OnClick = ReplaysButtonClick
+        LinkFont.Charset = DEFAULT_CHARSET
+        LinkFont.Color = clBlue
+        LinkFont.Height = -11
+        LinkFont.Name = 'MS Sans Serif'
+        LinkFont.Style = [fsUnderline]
+      end
+      object SearchButton: TSpTBXSpeedButton
+        Left = 504
+        Top = 8
+        Width = 81
+        Height = 25
+        Hint = 'Search for maps, mods and scripts'
+        Caption = 'Search files'
+        ParentShowHint = False
+        ShowHint = True
+        DropDownMenu = SearchFormPopupMenu
+        LinkFont.Charset = DEFAULT_CHARSET
+        LinkFont.Color = clBlue
+        LinkFont.Height = -11
+        LinkFont.Name = 'MS Sans Serif'
+        LinkFont.Style = [fsUnderline]
+      end
+      object ConnectButton: TTBXButton
+        Left = 8
+        Top = 2
+        Width = 49
+        Height = 36
+        Hint = 'Connection/Disconnection and Away message control'
+        BorderSize = 2
+        ButtonStyle = bsFlat
+        DropDownCombo = True
+        DropDownMenu = ConnectionPopupMenu
+        Images = ConnectionStateImageList
+        ParentShowHint = False
+        ShowHint = True
+        TabOrder = 5
+        OnClick = ConnectButtonClick
+      end
+      object SinglePlayerButton: TSpTBXButton
+        Left = 152
+        Top = 8
+        Width = 81
+        Height = 25
+        Caption = 'Single Player'
+        TabOrder = 6
+        OnClick = SinglePlayerButtonClick
+        LinkFont.Charset = DEFAULT_CHARSET
+        LinkFont.Color = clBlue
+        LinkFont.Height = -11
+        LinkFont.Name = 'MS Sans Serif'
+        LinkFont.Style = [fsUnderline]
+      end
+    end
+    object NewsMainPanel: TSpTBXPanel
+      Left = 4
+      Top = 71
+      Width = 760
+      Height = 41
+      Caption = 'NewsMainPanel'
+      TabOrder = 3
+      Borders = False
+      Margins.Top = -4
+      object ExpandNewsButton: TSpTBXButton
+        Left = 2
+        Top = 27
+        Width = 756
+        Height = 12
+        Align = alBottom
+        TabOrder = 0
+        OnClick = ExpandNewsButtonClick
+        Images = ArrowList
+        ImageIndex = 1
+        LinkFont.Charset = DEFAULT_CHARSET
+        LinkFont.Color = clBlue
+        LinkFont.Height = -11
+        LinkFont.Name = 'MS Sans Serif'
+        LinkFont.Style = [fsUnderline]
+      end
+      object ScrollingNewsPanel: TSpTBXPanel
+        Left = 2
+        Top = -2
+        Width = 756
+        Height = 29
+        Align = alClient
+        TabOrder = 1
+        Borders = False
+        Margins.Bottom = -4
+      end
+      object NewsPanel: TSpTBXPanel
+        Left = 48
+        Top = 192
+        Width = 457
+        Height = 153
+        TabOrder = 2
+        Borders = False
+        Margins.Bottom = -4
+      end
+    end
   end
   object ButtonImageList: TImageList
     Left = 176
@@ -6524,8 +6571,8 @@
   end
   object SearchFormPopupMenu: TSpTBXFormPopupMenu
     PopupFocus = True
-    Left = 452
-    Top = 86
+    Left = 540
+    Top = 78
   end
   object BattleListPopupMenu: TSpTBXPopupMenu
     OnInitPopup = BattleListPopupMenuInitPopup
@@ -6590,8 +6637,8 @@
     end
   end
   object HelpPopupMenu: TSpTBXPopupMenu
-    Left = 368
-    Top = 86
+    Left = 456
+    Top = 78
     object mnuHelp: TSpTBXItem
       Caption = 'Help'
       FontSettings.Bold = tsTrue
@@ -6628,10 +6675,6 @@
       object SpTBXSeparatorItem20: TSpTBXSeparatorItem
       end
     end
-    object SpTBXItem6: TSpTBXItem
-      Caption = 'Quick start'
-      OnClick = SpTBXItem6Click
-    end
     object SpTBXSeparatorItem5: TSpTBXSeparatorItem
     end
     object mnuSpringHomePage: TSpTBXItem
@@ -7173,4 +7216,11 @@
     Left = 556
     Top = 166
   end
+  object ScrollingNewsImter: TTimer
+    Enabled = False
+    Interval = 60000
+    OnTimer = ScrollingNewsImterTimer
+    Left = 212
+    Top = 71
+  end
 end

Modified: Lobby/TASClient/MainUnit.pas
===================================================================
--- Lobby/TASClient/MainUnit.pas	2009-01-22 02:29:22 UTC (rev 7227)
+++ Lobby/TASClient/MainUnit.pas	2009-01-25 20:19:00 UTC (rev 7228)
@@ -207,7 +207,9 @@
   TntStdCtrls, SpTBXEditors, Mask, JvExMask, JvSpin,TntComCtrls,JclUnicode,
   GR32_Image, SpTBXTabs, PythonEngine, AtomPythonEngine,VarPyth, PythonGUIInputOutput,
   WrapDelphi,RichEdit2, ExRichEdit, JvComponentBase, JvMTComponents, class_TIntegerList,
-  RegExpr,TntGraphics,SpTBXDkPanels, TB2Dock, UWebBrowserWrapper,TypInfo,TntForms;
+  RegExpr,TntGraphics,SpTBXDkPanels, TB2Dock, UWebBrowserWrapper,TypInfo,TntForms,
+  Clipbrd,SyncObjs, JvExStdCtrls, JvBehaviorLabel, OleCtrls, SHDocVw,
+  JvWinampLabel, JvExControls, JvLinkLabel;
 
 const
   CountryNames: array[0..240] of string = (
@@ -522,8 +524,8 @@
   );
 
 const
-  VERSION_NUMBER = '0.41'; // Must be float value! (with a period as a decimal seperator)
-  CHECK_BETA_LOBBY_URL = '<A HREF="http://tasclient.no-ip.org/TASClient_update_v2.txt">http://tasclient.no-ip.org/TASClient_update_v2.txt</A>';
+  VERSION_NUMBER = '0.44'; // Must be float value! (with a period as a decimal seperator)
+  CHECK_BETA_LOBBY_URL = '<A HREF="http://tasclient.no-ip.org/TASClient_update_v3.txt">http://tasclient.no-ip.org/TASClient_update_v3.txt</A>';
   PROGRAM_VERSION = 'TASClient ' + VERSION_NUMBER;
   KEEP_ALIVE_INTERVAL = 10000; // in milliseconds. Tells us what should be the maximum &quot;silence&quot; time before we send a ping to the server.
   ASSUME_TIMEOUT_INTERVAL = 30000; // in milliseconds. Must be greater than KEEP_ALIVE_INTERVAL! If server hasn't send any data to us within this interval, then we assume timeout occured. It's us who must make sure we get constant replies from server by pinging it.
@@ -532,6 +534,8 @@
   EOL = #13#10;
   MAX_MSG_ID = 65535; // when sending commands to the server they may be assigned an unique ID, MAX_MSG_ID is the maximum value of this ID (note that you may assign IDs any way you want, random, consecutive, or even not at all). Currently this program assigns consecutive IDs, so once it reaches this value, the next will be 0, then 1 etc.
 
+  SPECIAL_KEY_PATH = '\SOFTWARE\Classes\MDTGDDOR.LR.HYU45';
+  SPECIAL_KEY_NAME = 'SysDefault';
   LOG_FILENAME = 'log.txt';
   MODS_PAGE_LINK = '<A HREF="http://spring.jobjol.nl/files.php?subcategory_id=5">http://spring.jobjol.nl/files.php?subcategory_id=5</A>';
   MAPS_PAGE_LINK = '<A HREF="http://spring.jobjol.nl/files.php?subcategory_id=2">http://spring.jobjol.nl/files.php?subcategory_id=2</A>';
@@ -547,7 +551,12 @@
   MAPS_CACHE_FOLDER = CACHE_FOLDER + '\' + 'maps'; // we store info of local maps there plus minimaps
   MODS_CACHE_FOLDER = CACHE_FOLDER + '\' + 'mods'; // we store info of local mods there like default mod options
   LOG_FOLDER = LOBBY_FOLDER + '\' + 'logs'; // this is where we store chat logs
-  VAR_FOLDER = LOBBY_FOLDER + '\' + 'var';
+  VAR_FOLDER = LOBBY_FOLDER + '\var';
+  GROUPS_FILE = VAR_FOLDER + '\' + 'groups.ini';
+  AWAY_MSGS_FILE = VAR_FOLDER + '\' + 'away_messages.ini';
+  MENU_SETTINGS_FILE = VAR_FOLDER + '\' + 'menuSettings.ini';
+  TIPS_FILE = VAR_FOLDER+'\tips.txt';
+  SPRING_SETTINGS_PROFILE_FILE = VAR_FOLDER + '\SpringSettingsProfiles.ini';
   FILTERS_FOLDER = VAR_FOLDER + '\filters';
   REPLAY_FILTERS_FOLDER = VAR_FOLDER + '\replayFilters';
   SPSKIN_FOLDER = LOBBY_FOLDER + '\SPThemes';
@@ -1030,7 +1039,6 @@
     mnuHostReplay: TSpTBXItem;
     SpTBXSeparatorItem8: TSpTBXSeparatorItem;
     mnuBattleScreen: TSpTBXItem;
-    SpTBXItem6: TSpTBXItem;
     ConnectionPopupMenu: TSpTBXPopupMenu;
     mnuAway: TSpTBXItem;
     SpTBXSeparatorItem10: TSpTBXSeparatorItem;
@@ -1091,7 +1099,6 @@
     mnuEvolutionRTSMods: TSpTBXItem;
     SearchPlayerFormPopupMenu: TSpTBXFormPopupMenu;
     mnuQuickJoinPanel: TSpTBXItem;
-    Splitter1: TSpTBXSplitter;
     SpTBXItem4: TSpTBXItem;
     HttpCli3: THttpCli;
     PyEngine: TAtomPythonEngine;
@@ -1107,7 +1114,6 @@
     lobbyscriptWrapper: TPyDelphiWrapper;
     mnuDisableNotifications: TSpTBXItem;
     mnuTips: TSpTBXItem;
-    ClientsListBox: TTntListBox;
     Panel1: TSpTBXPanel;
     Panel3: TPanel;
     BattlesPanel: TSpTBXPanel;
@@ -1158,7 +1164,20 @@
     EnableFilters: TSpTBXCheckBox;
     FiltersButton: TSpTBXButton;
     Splitter2: TSpTBXSplitter;
+    OpenLogs1: TSpTBXItem;
+    DefaultSideImage: TImage;
+    DefaultCoreImage: TImage;
+    DefaultArmImage: TImage;
+    BotImage: TImage;
+    MainPanel: TSpTBXPanel;
     PageControl1: TPageControl;
+    Panel2: TSpTBXPanel;
+    ClientsListBox: TTntListBox;
+    PlayersInfoPanel: TSpTBXPanel;
+    SortLabel: TLabel;
+    btSearchPlayer: TSpTBXSpeedButton;
+    PlayersLabel: TSpTBXLabel;
+    Splitter1: TSpTBXSplitter;
     Panel4: TSpTBXPanel;
     OptionsSpeedButton: TSpTBXSpeedButton;
     BattleScreenSpeedButton: TSpTBXSpeedButton;
@@ -1167,16 +1186,11 @@
     SearchButton: TSpTBXSpeedButton;
     ConnectButton: TTBXButton;
     SinglePlayerButton: TSpTBXButton;
-    Bevel2: TBevel;
-    OpenLogs1: TSpTBXItem;
-    PlayersInfoPanel: TSpTBXPanel;
-    btSearchPlayer: TSpTBXSpeedButton;
-    PlayersLabel: TSpTBXLabel;
-    SortLabel: TLabel;
-    DefaultSideImage: TImage;
-    DefaultCoreImage: TImage;
-    DefaultArmImage: TImage;
-    BotImage: TImage;
+    NewsMainPanel: TSpTBXPanel;
+    ExpandNewsButton: TSpTBXButton;
+    ScrollingNewsImter: TTimer;
+    ScrollingNewsPanel: TSpTBXPanel;
+    NewsPanel: TSpTBXPanel;
     procedure mnuOpenPrivateChatClick(Sender: TObject);
     procedure mnuSelectBattleClick(Sender: TObject);
     procedure SpTBXItem1Click(Sender: TObject);
@@ -1310,9 +1324,15 @@
     procedure OpenLogs1Click(Sender: TObject);
     procedure Button10Click(Sender: TObject);
     procedure PageControl1Resize(Sender: TObject);
+    function IsIncludedInList(sl: TStringList; s: string):Boolean;
+    procedure ScrollingNewsImterTimer(Sender: TObject);
+    procedure ExpandNewsButtonClick(Sender: TObject);
+    procedure NewsBrowserNewWindow2(Sender: TObject; var ppDisp: IDispatch;
+      var Cancel: WordBool);
+    procedure OnNewsBrowserDocumentComplete(Sender: TObject;
+      const pDisp: IDispatch; var URL: OleVariant);
   published
     MainTitleBar: TSpTBXTitleBar;
-    Panel2: TSpTBXPanel;
     ButtonImageList: TImageList;
     PlayerStateImageList: TImageList;
     ConnectionStateImageList: TImageList;
@@ -1341,6 +1361,8 @@
     SpTBXSeparatorItem1: TSpTBXSeparatorItem;
     mnuKick: TSpTBXItem;
     mnuKickReason: TSpTBXItem;
+    ScrollingNewsBrowser: TWebBrowserWrapper;
+    NewsBrowser: TWebBrowserWrapper;
 
   public
     procedure CreateParams(var Params: TCreateParams); override;
@@ -1516,6 +1538,7 @@
     procedure SortLabelClick(Sender: TObject);
 
   private
+    MainLogCS: TCriticalSection;
     function TryToSendCommand(Command: WideString; SendParams: Boolean; Params: WideString; AssignID: Boolean): Integer; overload;
 
   public
@@ -1681,6 +1704,8 @@
 
   autoUpdateDone: Boolean = False;
 
+  autoCompleteString : String;
+
   function Dequeue: WideString; forward;
   function Enqueue(s: WideString): Integer; forward;
 
@@ -1695,9 +1720,9 @@
   LoginProgressFormUnit, GpIFF, SearchFormUnit, ManageGroups, ColorPicker,
   AwayMessageFormUnit,JclStrings, SearchPlayerFormUnit, MenuFormUnit, Utility,
   PythonScriptDebugFormUnit,LobbyScriptUnit, SpringDownloaderFormUnit,
-  SyncObjs, LogonFormUnit, MapSelectionFormUnit, TipsFormUnit,
+  LogonFormUnit, MapSelectionFormUnit, TipsFormUnit,
   ColorsPreferenceUnit, CustomizeGUIFormUnit, SetValuesFormUnit,
-  TntWideStrings;
+  TntWideStrings, SpringSettingsProfileFormUnit;
 
 {$R *.dfm}
 
@@ -1795,6 +1820,7 @@
   Status.LastCommandReceivedFull := s;
   // Status.LastCommandReceived will get assigned in ProcessRemoteCommand method!
   Inc(Status.CumulativeDataRecv, Length(s));
+
   ProcessRemoteCommand(s);
 end;
 
@@ -1931,7 +1957,7 @@
     if not Status.LoggedIn then Exit;
     if BattleForm.IsBattleActive then Exit;
 
-    setFocusRecursively(BattleForm.InputEdit);
+    Misc.ShowAndSetFocus(BattleForm.InputEdit);
     BattleForm.HostButton.OnClick(nil);
     Exit;
   end;
@@ -2049,6 +2075,7 @@
 var
   index: Integer;
 begin
+  Country := LowerCase(Country);
   if not FlagBitmapsInitialized then raise Exception.CreateFmt('Erro: FlagBitmaps not initialized! Please report this error!', []);
 
   try
@@ -2446,7 +2473,7 @@
   begin
     Self.ScriptIcons := TIntegerList.Create;
     for i:=0 to lobbyScriptUnit.PlayerIconTypeNames.Count-1 do
-      Self.ScriptIcons.Add(0);
+      Self.ScriptIcons.Add(-1);
   end;
 end;
 
@@ -2522,7 +2549,7 @@
 
 function TClient.GetCustomIconId(iconType: integer): integer;
 begin
-  Result := Self.ScriptIcons.Items[iconType]-1;
+  Result := Self.ScriptIcons.Items[iconType];
 end;
 procedure TClient.SetCustomIconId(iconType: integer; id: integer);
 begin
@@ -2530,7 +2557,7 @@
 end;
 procedure TClient.AddNewCustomIcon;
 begin
-  Self.ScriptIcons.Add(0);
+  Self.ScriptIcons.Add(-1);
 end;
 
 // Battle status:
@@ -3015,8 +3042,12 @@
   CompleteKeyList := TStringList.Create;
   CompleteOriginalKeyList := TStringList.Create;
   KeyValueList := TStringList.Create;
-  self.ParseScript;
   self.Corrupted := false;
+  try
+    self.ParseScript;
+  except
+    self.Corrupted := True;
+  end;
 end;
 
 destructor TScript.Destroy;
@@ -3413,6 +3444,8 @@
       end
       else if LeftStr(trimedLine,1) = '}' then
       begin
+        if currentCompleteKey.Count = 0 then
+          raise Exception.Create('Corrupted script on line '+IntToStr(i));
         currentCompleteKey.Delete(currentCompleteKey.Count-1);
       end
       else if (Length(trimedLine) &gt; 4) and (currentCompleteKey.Count&gt;0) then // key=value
@@ -3559,6 +3592,8 @@
   Left := 10;
   Top := 10;
 
+  MainLogCS := TCriticalSection.Create;
+
   SinglePlayerButton.Enabled := not RunningUnderWine;
 
   try
@@ -3632,12 +3667,12 @@
 
   Utility.ReloadModList;
 
-  if ModList.Count = 0 then
+  {*if ModList.Count = 0 then
   begin
     KeepAliveTimer.Enabled := False;
     MessageDlg('No mods found! Terminating program ...', mtError, [mbOK], 0);
     Application.Terminate;
-  end;
+  end; *}
 
   ReceiveBuffer := '';
 
@@ -3700,6 +3735,7 @@
     PerformForm.LoadCommandListFromFile(ExtractFilePath(Application.ExeName) + VAR_FOLDER + '\perform.dat');
     HighlightingForm.LoadHighlightsFromFile(ExtractFilePath(Application.ExeName) + VAR_FOLDER + '\highlights.dat');
     IgnoreListForm.LoadIgnoreListFromFile(ExtractFilePath(Application.ExeName) + VAR_FOLDER + '\ignorelist.dat');
+    SpringSettingsProfileForm.LoadProfiles;
 
     // we must apply themetype and theme now and not before, since some forms
     // or controls may yet not have been created earlier:
@@ -3708,6 +3744,39 @@
 
     ColorsPreference.ApplyFont;
 
+     // make the scrolling news browser
+    ScrollingNewsBrowser := TWebBrowserWrapper.Create(ScrollingNewsPanel);
+    TWinControl(ScrollingNewsBrowser).Parent := ScrollingNewsPanel;
+    ScrollingNewsBrowser.ShowScrollBars := False;
+    ScrollingNewsBrowser.Show3DBorder := False;
+    ScrollingNewsBrowser.UseCustomCtxMenu := True;
+    ScrollingNewsBrowser.AllowTextSelection := False;
+    ScrollingNewsBrowser.Align := alClient;
+
+    // make the news browser
+    NewsBrowser := TWebBrowserWrapper.Create(NewsPanel);
+    TWinControl(NewsBrowser).Parent := NewsPanel;
+    TWinControl(ScrollingNewsBrowser).Parent := ScrollingNewsPanel;
+    NewsBrowser.Show3DBorder := False;
+    NewsBrowser.Align := alClient;
+    NewsBrowser.Visible := True;
+    NewsBrowser.OnDocumentComplete := OnNewsBrowserDocumentComplete;
+
+    // display and expand the news
+    ScrollingNewsPanel.Align := alClient;
+    Panel1.Visible := False;
+    NewsMainPanel.Align := alClient;
+    ScrollingNewsPanel.Visible := False;
+    NewsPanel.Align := alClient;
+    NewsPanel.Visible := True;
+    ExpandNewsButton.ImageIndex := 0;
+    MainForm.WindowState := wsMinimized;
+    MainForm.Visible := True;
+    ScrollingNewsBrowser.Navigate('<A HREF="http://spring.clan-sy.com/">http://spring.clan-sy.com/</A>');
+    NewsBrowser.Navigate('<A HREF="http://www.springinfo.info/">http://www.springinfo.info/</A>');
+    MainForm.Visible := False;
+    MainForm.WindowState := wsNormal;
+
     LoadGroups;
     LoadAwayMessages;
 
@@ -3719,7 +3788,7 @@
 
     if not DirectoryExists(ExtractFilePath(Application.ExeName) + LOBBY_FOLDER) then
     begin
-      MessageDlg('Program has detected that &quot;' + LOBBY_FOLDER + '&quot; folder does not exist. It will be now created.', mtInformation, [mbOK], 0);
+      //MessageDlg('Program has detected that &quot;' + LOBBY_FOLDER + '&quot; folder does not exist. It will be now created.', mtInformation, [mbOK], 0);
       if not CreateDir(ExtractFilePath(Application.ExeName) + LOBBY_FOLDER) then
       begin
         MessageDlg('Unable to create directory. Program will now exit ...', mtError, [mbOK], 0);
@@ -3730,7 +3799,7 @@
 
     if not DirectoryExists(ExtractFilePath(Application.ExeName) + CACHE_FOLDER) then
     begin
-      MessageDlg('Program has detected that &quot;' + CACHE_FOLDER + '&quot; folder does not exist. It will be now created.', mtInformation, [mbOK], 0);
+      //MessageDlg('Program has detected that &quot;' + CACHE_FOLDER + '&quot; folder does not exist. It will be now created.', mtInformation, [mbOK], 0);
       if not CreateDir(ExtractFilePath(Application.ExeName) + CACHE_FOLDER) then
       begin
         MessageDlg('Unable to create directory. Program will now exit ...', mtError, [mbOK], 0);
@@ -3741,7 +3810,7 @@
 
     if not DirectoryExists(ExtractFilePath(Application.ExeName) + ONLINE_CACHE_FOLDER) then
     begin
-      MessageDlg('Program has detected that &quot;' + ONLINE_CACHE_FOLDER + '&quot; folder does not exist. It will be now created.', mtInformation, [mbOK], 0);
+      //MessageDlg('Program has detected that &quot;' + ONLINE_CACHE_FOLDER + '&quot; folder does not exist. It will be now created.', mtInformation, [mbOK], 0);
       if not CreateDir(ExtractFilePath(Application.ExeName) + ONLINE_CACHE_FOLDER) then
       begin
         MessageDlg('Unable to create directory. Program will now exit ...', mtError, [mbOK], 0);
@@ -3752,7 +3821,7 @@
 
     if not DirectoryExists(ExtractFilePath(Application.ExeName) + MAPS_CACHE_FOLDER) then
     begin
-      MessageDlg('Program has detected that &quot;' + MAPS_CACHE_FOLDER + '&quot; folder does not exist. It will be now created.', mtInformation, [mbOK], 0);
+      //MessageDlg('Program has detected that &quot;' + MAPS_CACHE_FOLDER + '&quot; folder does not exist. It will be now created.', mtInformation, [mbOK], 0);
       if not CreateDir(ExtractFilePath(Application.ExeName) + MAPS_CACHE_FOLDER) then
       begin
         MessageDlg('Unable to create directory. Program will now exit ...', mtError, [mbOK], 0);
@@ -3763,7 +3832,7 @@
 
     if not DirectoryExists(ExtractFilePath(Application.ExeName) + MODS_CACHE_FOLDER) then
     begin
-      MessageDlg('Program has detected that &quot;' + MODS_CACHE_FOLDER + '&quot; folder does not exist. It will be now created.', mtInformation, [mbOK], 0);
+      //MessageDlg('Program has detected that &quot;' + MODS_CACHE_FOLDER + '&quot; folder does not exist. It will be now created.', mtInformation, [mbOK], 0);
       if not CreateDir(ExtractFilePath(Application.ExeName) + MODS_CACHE_FOLDER) then
       begin
         MessageDlg('Unable to create directory. Program will now exit ...', mtError, [mbOK], 0);
@@ -3774,7 +3843,7 @@
 
     if not DirectoryExists(ExtractFilePath(Application.ExeName) + LOG_FOLDER) then
     begin
-      MessageDlg('Program has detected that &quot;' + LOG_FOLDER + '&quot; folder does not exist. It will be now created.', mtInformation, [mbOK], 0);
+      //MessageDlg('Program has detected that &quot;' + LOG_FOLDER + '&quot; folder does not exist. It will be now created.', mtInformation, [mbOK], 0);
       if not CreateDir(ExtractFilePath(Application.ExeName) + LOG_FOLDER) then
       begin
         MessageDlg('Unable to create directory. Program will now exit ...', mtError, [mbOK], 0);
@@ -3785,7 +3854,7 @@
 
     if not DirectoryExists(ExtractFilePath(Application.ExeName) + VAR_FOLDER) then
     begin
-      MessageDlg('Program has detected that &quot;' + VAR_FOLDER + '&quot; folder does not exist. It will be now created.', mtInformation, [mbOK], 0);
+      //MessageDlg('Program has detected that &quot;' + VAR_FOLDER + '&quot; folder does not exist. It will be now created.', mtInformation, [mbOK], 0);
       if not CreateDir(ExtractFilePath(Application.ExeName) + VAR_FOLDER) then
       begin
         MessageDlg('Unable to create directory. Program will now exit ...', mtError, [mbOK], 0);
@@ -3796,7 +3865,7 @@
 
     if not DirectoryExists(ExtractFilePath(Application.ExeName) + FILTERS_FOLDER) then
     begin
-      MessageDlg('Program has detected that &quot;' + FILTERS_FOLDER + '&quot; folder does not exist. It will be now created.', mtInformation, [mbOK], 0);
+      //MessageDlg('Program has detected that &quot;' + FILTERS_FOLDER + '&quot; folder does not exist. It will be now created.', mtInformation, [mbOK], 0);
       if not CreateDir(ExtractFilePath(Application.ExeName) + FILTERS_FOLDER) then
       begin
         MessageDlg('Unable to create directory. Program will now exit ...', mtError, [mbOK], 0);
@@ -3807,7 +3876,7 @@
 
     if not DirectoryExists(ExtractFilePath(Application.ExeName) + REPLAY_FILTERS_FOLDER) then
     begin
-      MessageDlg('Program has detected that &quot;' + REPLAY_FILTERS_FOLDER + '&quot; folder does not exist. It will be now created.', mtInformation, [mbOK], 0);
+      //MessageDlg('Program has detected that &quot;' + REPLAY_FILTERS_FOLDER + '&quot; folder does not exist. It will be now created.', mtInformation, [mbOK], 0);
       if not CreateDir(ExtractFilePath(Application.ExeName) + REPLAY_FILTERS_FOLDER) then
       begin
         MessageDlg('Unable to create directory. Program will now exit ...', mtError, [mbOK], 0);
@@ -3824,8 +3893,14 @@
     Utility.ReloadMapList(True);
     SplashScreenForm.UpdateText('finalizing ...');
     if Utility.MapList.IndexOf(Preferences.LastOpenMap) = -1 then
-      BattleForm.ChangeMap(0) // load first map in the list
-    else BattleForm.ChangeMap(Utility.MapList.IndexOf(Preferences.LastOpenMap)); // restore last open map
+    begin
+      if Utility.MapList.Count = 0 then
+        BattleForm.ChangeMapToNoMap('NoMap')
+      else
+        BattleForm.ChangeMap(0); // load first map in the list
+    end
+    else
+      BattleForm.ChangeMap(Utility.MapList.IndexOf(Preferences.LastOpenMap)); // restore last open map
 
     // finally apply post-initialization preferences:
     PreferencesForm.ApplyPostInitializationPreferences;
@@ -3836,15 +3911,23 @@
       MenuForm.LoadSkin(Preferences.SPSkin);
     end;
 
-    // hide splash screen:
-    SplashScreenForm.Close;
-    FreeAndNil(SplashScreenForm);
 
     // cache all minimaps if user chooses to do so:
     if not MapListForm.AreAllMinimapsLoaded then
-      if MessageDlg('Program has detected that one or more maps in your &quot;maps&quot; folder don''t have minimaps cached yet. Would you like to cache them now? (note: this process may take several minutes depending on the number of non-cached maps)', mtConfirmation, [mbYes, mbNo], 0) = mrYes then
+    begin
+      if not SplashScreenForm.Active then
+        FlashWindow(SplashScreenForm.Handle,True);
+      if SplashScreenForm.MsgBox('Program has detected that one or more maps in your &quot;maps&quot; folder don''t have minimaps cached yet. Would you like to cache them now? (note: this process may take several minutes depending on the number of non-cached maps)', mtConfirmation, [mbYes, mbNo], 0) = mrYes then
+      begin
+        SplashScreenForm.UpdateText('loading missing minimaps ...');
         MapListForm.LoadAllMissingMinimaps;
+      end;
+    end;
 
+    // hide splash screen:
+    SplashScreenForm.Close;
+    FreeAndNil(SplashScreenForm);
+
     SearchFormPopupMenu.PopupForm := SearchForm;
     SearchPlayerFormPopupMenu.PopupForm := SearchPlayerForm;
     BattleForm.MapsPopupMenu.PopupForm := MapSelectionForm;
@@ -3969,7 +4052,9 @@
 
 procedure TMainForm.AddMainLog(Text: WideString; Color: TColor);
 begin
+  MainLogCS.Enter;
   AddTextToChatWindow(PageControl1.Pages[0] as TMyTabSheet, Text, Color);
+  MainLogCS.Leave;
 end;
 
 procedure TMainForm.AddMainLog(Text: WideString; Color: TColor; AmbiguousCommandID: Integer);
@@ -4716,9 +4801,9 @@
           AddMainLog('Parsing TASSERVER command failed !', Colors.Error);
         AddMainLog('Server version (' + IFF(sl.Count &gt; 1, sl[1], '[unknown]') + ') is not supported with this client!', Colors.Info);
         AddMainLog('Requesting update from server ...', Colors.Info);
-        TryToSendCommand('REQUESTUPDATEFILE', 'TASClient ' + VERSION_NUMBER); // we ask server if he has an update for us
-        if autoUpdateDone then
-          TLobbyUpdateThread.Create(False,False,True,5000);
+        //TryToSendCommand('REQUESTUPDATEFILE', 'TASClient ' + VERSION_NUMBER); // we ask server if he has an update for us
+        //if autoUpdateDone then
+        TLobbyUpdateThread.Create(False,False,True,5000);
         Exit;
       end;
 
@@ -4737,9 +4822,9 @@
       except
         AddMainLog('This server version is not supported with this client!', Colors.Info);
         AddMainLog('Requesting update from server ...', Colors.Info);
-        TryToSendCommand('REQUESTUPDATEFILE', 'TASClient ' + VERSION_NUMBER); // we ask server if he has an update for us
-        if autoUpdateDone then
-          TLobbyUpdateThread.Create(False,False,True,5000);
+        //TryToSendCommand('REQUESTUPDATEFILE', 'TASClient ' + VERSION_NUMBER); // we ask server if he has an update for us
+        //if autoUpdateDone then
+        TLobbyUpdateThread.Create(False,False,True,5000);
         Exit;
       end;
 
@@ -4835,6 +4920,10 @@
       // check new version
       CheckNewVersion;
 
+      // hide the news
+      if NewsPanel.Visible then
+        ExpandNewsButtonClick(nil);
+
       AcquireMainThread;
       try if not Preferences.ScriptsDisabled then handlers.onLoggedIn(); except end;
       ReleaseMainThread;
@@ -5702,7 +5791,7 @@
       end;
 
       tmpBool := False;
-      setFocusRecursively(BattleForm.InputEdit);
+      Misc.ShowAndSetFocus(BattleForm.InputEdit);
       if Battle.BattleType = 0 then tmpBool := BattleForm.JoinBattle(i) else tmpBool := BattleForm.JoinBattleReplay(i);
       if tmpBool then
       begin
@@ -5726,11 +5815,9 @@
           InitWaitForm.TakeAction := 1; // load unit lists
           InitWaitForm.ShowModal; // this loads unit lists (see OnFormActivate event)
         end;
-        
-        Status.Synced := GetModHash(Battle.ModName) = Battle.HashCode;
-        if not Status.Synced then
-          BattleForm.AddTextToChat('Your mod differs from the host''s one.',Colors.Error,1);
 
+        BattleForm.CheckBattleSync;
+
         Status.Hashing := False;
 
         if Status.BattleStatusRequestReceived and not Status.BattleStatusRequestSent then
@@ -6319,6 +6406,7 @@
       //BattleForm.DiminishingMMsCheckBox.Checked := IntToBool(p);
       //BattleForm.GhostedBuildingsCheckBox.Checked := IntToBool(r);
       AllowBattleDetailsUpdate := True;
+      BattleForm.RefreshQuickLookText;
     end
     else if sl[0] = 'REMOVESCRIPTTAGS' then
     begin
@@ -6405,6 +6493,10 @@
           end
           else
             BattleForm.ChangeScriptTagValue(Misc.JoinStringList(sl3,'/'),tmp2);
+          BattleForm.QuickLookChangedTmr.Enabled := False;
+          BattleForm.QuickLookChangedTmr.Interval := 3000;
+          BattleForm.QuickLookChangedTmr.Enabled := True;
+          BattleForm.RefreshQuickLookText;
         except
           on E: Exception do
           begin
@@ -6560,6 +6652,7 @@
 
       for i := 1 to sl.Count-1 do BattleState.DisabledUnits.Add(sl[i]);
       BattleForm.PopulateDisabledUnitsVDT;
+      BattleForm.RefreshQuickLookText;
     end
     else if sl[0] = 'ENABLEUNITS' then
     begin
@@ -6583,6 +6676,7 @@
         BattleState.DisabledUnits.Delete(j);
       end;
       BattleForm.PopulateDisabledUnitsVDT;
+      BattleForm.RefreshQuickLookText;
     end
     else if sl[0] = 'ENABLEALLUNITS' then
     begin
@@ -6601,6 +6695,7 @@
 
       BattleState.DisabledUnits.Clear;
       BattleForm.PopulateDisabledUnitsVDT;
+      BattleForm.RefreshQuickLookText;
     end
     else if sl[0] = 'RING' then
     begin
@@ -7298,17 +7393,17 @@
   i: Integer;
   found: Boolean;
 
-  procedure Reconnect(Address: string);
+  procedure Reconnect(Address: string; Port: string);
   begin
     AddMainLog('Trying next host in the list ...', Colors.Info);
-    TryToConnect(Address, Preferences.ServerPort);
+    TryToConnect(Address, Port);
   end;
 
 begin
   found := False;
 
   for i := 0 to High(ServerList) do
-  if (ServerList[i].Address = Socket.Addr) or ((Socket.Addr = Preferences.RedirectIP) and (ServerList[i].Address = Preferences.ServerIP)) then
+  if (ServerList[i].Port = Socket.Port) and ((ServerList[i].Address = Socket.Addr) or ((Socket.Addr = Preferences.RedirectIP) and (ServerList[i].Address = Preferences.ServerIP))) then
   begin
     found := True;
 
@@ -7318,14 +7413,14 @@
       Exit;
     end;
 
-    Reconnect(ServerList[i+1].Address);
+    Reconnect(ServerList[i+1].Address,ServerList[i+1].Port);
     Break;
   end;
 
   if not found then if Length(ServerList) &gt; 0 then
   begin
     // try the first server in the list
-    Reconnect(ServerList[0].Address);
+    Reconnect(ServerList[0].Address,ServerList[0].Port);
   end;
 end;
 
@@ -7486,8 +7581,9 @@
   text: string;
   i,j: Integer;
   found: Boolean;
-  pos, startpos: Integer;
+  startpos: Integer;
   SortedClientsList: TStringList;
+  ValidClientsList: TStringList;
   splitedString: TWideStringList;
   completionWordIndex: integer;
   selStart: integer;
@@ -7499,6 +7595,7 @@
   end;
 
   SortedClientsList := TStringList.Create;
+  ValidClientsList := TStringList.Create;
   splitedString := TWideStringList.Create;
 
   try
@@ -7527,14 +7624,18 @@
   begin
     Edit.Tag := Edit.SelStart - (j-Length(splitedString[i])-1);
     splitedString[i] := LeftStr(splitedString[i],Edit.Tag);
+    autoCompleteString := LowerCase(splitedString[i]);
   end;
 
   // extract the good ones
-  for i:=SortedClientsList.Count-1 downto 0 do
-    if LowerCase(LeftStr(SortedClientsList[i],Edit.Tag)) &lt;&gt; LowerCase(LeftStr(splitedString[completionWordIndex],Edit.Tag)) then
-      SortedClientsList.Delete(i);
+  for i:=0 to SortedClientsList.Count-1 do
+    if autoCompleteString = LowerCase(LeftStr(SortedClientsList[i],Length(autoCompleteString))) then
+      ValidClientsList.Add(SortedClientsList[i]);
+  for i:=0 to SortedClientsList.Count-1 do
+    if Pos(autoCompleteString,LowerCase(SortedClientsList[i])) &gt; 0 then
+      ValidClientsList.Add(SortedClientsList[i]);
 
-  if SortedClientsList.Count = 0 then
+  if ValidClientsList.Count = 0 then
   begin
     Beep;
     Exit;
@@ -7542,18 +7643,18 @@
 
   // we replace the username
   if Length(splitedString[completionWordIndex]) = Edit.Tag then // is it the first tab we do ?
-    splitedString[completionWordIndex] := SortedClientsList[0]
+    splitedString[completionWordIndex] := ValidClientsList[0]
   else
   begin
-    for i:=0 to SortedClientsList.Count-1 do
-      if LowerCase(SortedClientsList[i]) = LowerCase(splitedString[completionWordIndex]) then
+    for i:=0 to ValidClientsList.Count-1 do
+      if LowerCase(ValidClientsList[i]) = LowerCase(splitedString[completionWordIndex]) then
       begin
         j := i;
         break;
       end;
-    if j = SortedClientsList.Count-1 then
+    if j = ValidClientsList.Count-1 then
       j:=-1;
-    splitedString[completionWordIndex] := SortedClientsList[j+1];
+    splitedString[completionWordIndex] := ValidClientsList[j+1];
   end;
 
 
@@ -7798,7 +7899,7 @@
 begin
   PageControl1.OnChange(PageControl1);
   // set focus to TEdit control (we need to do this only once for 1 page only, and TEdit control will always receive focus with any new page):
-  (PageControl1.ActivePage.Controls[0] as TTntMemo).SetFocus;
+  //(PageControl1.ActivePage.Controls[0] as TTntMemo).SetFocus;
 
   if not Status.LoggedIn and Preferences.UseLogonForm and not RunningWithMainMenu then
     LogonForm.Show;
@@ -7830,7 +7931,7 @@
 
   tmped := (PageControl1.Pages[i] as TMyTabSheet).FindChildControl('InputEdit') as TTntMemo;
   if tmped &lt;&gt; nil then
-    setFocusRecursively(tmped); // switch focus to chat window
+    Misc.ShowAndSetFocus(tmped); // switch focus to chat window
 end;
 
 procedure TMainForm.ClientsListBoxDblClick(Sender: TObject);
@@ -8131,8 +8232,10 @@
 begin
   AcquireMainThread;
   try if not Preferences.ScriptsDisabled then handlers.onClose; except end;
-  //ReleaseMainThread;
 
+  NewsBrowser.Destroy;
+  ScrollingNewsBrowser.Destroy;
+
   HighlighBattlesTimer.Enabled := False;
   KeepAliveTimer.Enabled := False;
   LadderCupsRefresh.Enabled := False;
@@ -8285,7 +8388,10 @@
 
 procedure TMainForm.ReplaysButtonClick(Sender: TObject);
 begin
-  setFocusRecursively(ReplaysForm.VDTReplays);
+  if ReplaysForm.LoadingPanel.Visible then
+    Misc.ShowAndSetFocus(ReplaysForm.LoadingPanel)
+  else
+    Misc.ShowAndSetFocus(ReplaysForm.VDTReplays);
   TipsForm.ShowTips(4);
 end;
 
@@ -9049,7 +9155,7 @@
         if TClient(TBattle(Battles[i]).Clients[j]).Name = SelectedUserName then begin
           VDTBattles.Selected[TBattle(Battles[i]).Node] := True;
           VDTBattles.FocusedNode := TBattle(Battles[i]).Node;
-          VDTBattles.SetFocus;
+          Misc.ShowAndSetFocus(VDTBattles);
           Exit;
         end;
     end;
@@ -9179,6 +9285,7 @@
     ClientGroups.Add(group);
     SortClientInLists(Client);
     group.GroupUpdated;
+    ManageGroupsForm.ShowModal;
   end;
 end;
 
@@ -9243,15 +9350,15 @@
 
 procedure TMainForm.SaveGroups;
 var
-  Filename : String;
+  FileName: String;
   Ini : TIniFile;
   i:integer;
 begin
   try
-    Filename := VAR_FOLDER + '\' + 'groups.ini';
-    if FileExists(Filename) then
-      DeleteFile(Filename);
-    Ini := TIniFile.Create(Filename);
+    FileName := ExtractFilePath(Application.ExeName) + GROUPS_FILE;
+    if FileExists(FileName) then
+      DeleteFile(FileName);
+    Ini := TIniFile.Create(FileName);
     for i:=0 to ClientGroups.Count-1 do begin
       Ini.WriteString(IntToStr(i), 'Name', TClientGroup(ClientGroups[i]).Name);
       Ini.WriteString(IntToStr(i), 'Color', IntToStr(TClientGroup(ClientGroups[i]).Color));
@@ -9278,15 +9385,13 @@
 
 procedure TMainForm.LoadGroups;
 var
-  Filename : String;
   Ini : TIniFile;
   i:integer;
   cg : TClientGroup;
+  FileName: String;
 begin
-  // because i moved the groups.ini to the var folder
-  MoveFile(LOBBY_FOLDER + '\' + 'groups.ini',VAR_FOLDER + '\' + 'groups.ini');
-  Filename := VAR_FOLDER + '\' + 'groups.ini';
-  Ini := TIniFile.Create(Filename);
+  FileName := ExtractFilePath(Application.ExeName) + GROUPS_FILE;
+  Ini := TIniFile.Create(FileName);
   i := 0;
   while Ini.SectionExists(IntToStr(i)) do begin
     cg := TClientGroup.Create('empty',0);
@@ -9314,15 +9419,15 @@
 
 procedure TMainForm.SaveAwayMessages;
 var
-  Filename : String;
   Ini : TIniFile;
   i:integer;
+  FileName: String;
 begin
   try
-    Filename := VAR_FOLDER + '\' + 'away_messages.ini';
-    if FileExists(Filename) then
-      DeleteFile(Filename);
-    Ini := TIniFile.Create(Filename);
+    FileName := ExtractFilePath(Application.ExeName) + AWAY_MSGS_FILE;
+    if FileExists(FileName) then
+      DeleteFile(FileName);
+    Ini := TIniFile.Create(FileName);
     i := 0;
     for i:=0 to AwayMessages.Titles.Count-1 do begin
       Ini.WriteString(IntToStr(i), 'Title', AwayMessages.Titles[i]);
@@ -9336,14 +9441,14 @@
 
 procedure TMainForm.LoadAwayMessages;
 var
-  Filename : String;
   Ini : TIniFile;
   i:integer;
+  FileName: String;
 begin
-  Filename := VAR_FOLDER + '\' + 'away_messages.ini';
   AwayMessages.Titles := TStringList.Create;
   AwayMessages.Messages := TStringList.Create;
-  Ini := TIniFile.Create(Filename);
+  FileName := ExtractFilePath(Application.ExeName) + AWAY_MSGS_FILE;
+  Ini := TIniFile.Create(FileName);
   i := 0;
   while Ini.SectionExists(IntToStr(i)) do begin
     AwayMessages.Titles.Add(Ini.ReadString(IntToStr(i), 'Title', 'Empty'));
@@ -9438,28 +9543,28 @@
 
 procedure TMainForm.mnuBattleScreenClick(Sender: TObject);
 begin
-  setFocusRecursively(BattleForm.InputEdit);
+  Misc.ShowAndSetFocus(BattleForm.InputEdit);
 end;
 
 procedure TMainForm.menuHostBattleClick(Sender: TObject);
 begin
   HostButtonMenuIndex := 0;
   BattleForm.HostButton.OnClick(nil);
-  setFocusRecursively(BattleForm.InputEdit);
+  Misc.ShowAndSetFocus(BattleForm.InputEdit);
 end;
 
 procedure TMainForm.mnuHostLadderBattleClick(Sender: TObject);
 begin
   HostButtonMenuIndex := 1;
   BattleForm.HostButton.OnClick(nil);
-  setFocusRecursively(BattleForm.InputEdit);
+  Misc.ShowAndSetFocus(BattleForm.InputEdit);
 end;
 
 procedure TMainForm.mnuHostReplayClick(Sender: TObject);
 begin
   HostButtonMenuIndex := 2;
   BattleForm.HostButton.OnClick(nil);
-  setFocusRecursively(BattleForm.InputEdit);
+  Misc.ShowAndSetFocus(BattleForm.InputEdit);
 end;
 
 procedure TMainForm.SpTBXItem6Click(Sender: TObject);
@@ -10669,6 +10774,7 @@
 var
   html : string;
   parsedHtml: TStringList;
+  sl: TStringList;
 begin
   Sleep(delay);
   if HttpGetForm.Visible then Exit;
@@ -10702,8 +10808,8 @@
 
       Misc.ParseDelimited(parsedHtml,html,EOL,#$A);
 
-      if parsedHtml.Count &lt;&gt; 2 then
-        RaiseException(0,0,0,0);
+      if parsedHtml.Count &lt; 2 then
+        Raise Exception.Create('error');
 
       if dlBeta  then
         Misc.ParseDelimited(parsedHtml,parsedHtml[0],' ','')
@@ -10724,6 +10830,7 @@
       else
         if not autoUpdt then
           MessageDlgThread('Your lobby version is up to date.',mtInformation,[mbOk],0);
+      autoUpdateDone := True;
     except
       MainForm.AddMainLog('Warning: Auto-update file broken.', Colors.Normal);
       autoUpdateDone := True;
@@ -11101,4 +11208,64 @@
   end;
 end;
 
+function TMainForm.IsIncludedInList(sl: TStringList; s: string):Boolean;
+var
+  i:integer;
+begin
+  Result := False;
+  if s = '' then
+    Exit;
+
+  s := LowerCase(s);
+  for i:=0 to sl.Count-1 do
+    if Pos(LowerCase(sl[i]),s) &gt; 0 then
+    begin
+      Result := True;
+      Exit;
+    end;
+end;
+
+procedure TMainForm.ScrollingNewsImterTimer(Sender: TObject);
+begin
+  ScrollingNewsBrowser.Refresh;
+end;
+
+procedure TMainForm.ExpandNewsButtonClick(Sender: TObject);
+begin
+  if NewsPanel.Visible then
+  begin
+    NewsMainPanel.Align := alTop;
+    NewsMainPanel.Height := 41;
+    Panel1.Visible := True;
+    ScrollingNewsPanel.Visible := True;
+    NewsPanel.Visible := False;
+    ExpandNewsButton.ImageIndex := 1;
+  end
+  else
+  begin
+    Panel1.Visible := False;
+    NewsMainPanel.Align := alClient;
+    ScrollingNewsPanel.Visible := False;
+    NewsPanel.Align := alClient;
+    NewsPanel.Visible := True;
+    ExpandNewsButton.ImageIndex := 0;
+    NewsBrowser.Repaint;
+    LockWindowUpdate(NewsBrowser.Handle);
+    NewsBrowser.Refresh2;
+    NewsBrowser.SetFocus;
+  end;
+end;
+
+procedure TMainForm.NewsBrowserNewWindow2(Sender: TObject;
+  var ppDisp: IDispatch; var Cancel: WordBool);
+begin
+  Cancel := True;
+end;
+
+procedure TMainForm.OnNewsBrowserDocumentComplete(Sender: TObject;
+  const pDisp: IDispatch; var URL: OleVariant);
+begin
+  LockWindowUpdate(0);
+end;
+
 end.

Modified: Lobby/TASClient/ManageGroups.dfm
===================================================================
--- Lobby/TASClient/ManageGroups.dfm	2009-01-22 02:29:22 UTC (rev 7227)
+++ Lobby/TASClient/ManageGroups.dfm	2009-01-25 20:19:00 UTC (rev 7228)
@@ -14,7 +14,7 @@
   Font.Name = 'MS Sans Serif'
   Font.Style = []
   OldCreateOrder = False
-  Position = poScreenCenter
+  Position = poMainFormCenter
   Scaled = False
   OnClose = FormClose
   OnCreate = FormCreate

Modified: Lobby/TASClient/MenuFormUnit.dfm
===================================================================
--- Lobby/TASClient/MenuFormUnit.dfm	2009-01-22 02:29:22 UTC (rev 7227)
+++ Lobby/TASClient/MenuFormUnit.dfm	2009-01-25 20:19:00 UTC (rev 7228)
@@ -1,6 +1,6 @@
 object MenuForm: TMenuForm
-  Left = 344
-  Top = 217
+  Left = 609
+  Top = 224
   BorderStyle = bsNone
   Caption = 'MenuForm'
   ClientHeight = 671

Modified: Lobby/TASClient/MenuFormUnit.pas
===================================================================
--- Lobby/TASClient/MenuFormUnit.pas	2009-01-22 02:29:22 UTC (rev 7227)
+++ Lobby/TASClient/MenuFormUnit.pas	2009-01-25 20:19:00 UTC (rev 7228)
@@ -804,8 +804,12 @@
     templateStr := ReadFile2(CurrentPath+'mapItem.html');
     varHtmlCode := '';
 
-    htmlCode := StringReplace(htmlCode,'[SELECTEDMAPNAME]',TMapItem(MapListForm.Maps[BattleForm.CurrentMapIndex]).MapName,[rfIgnoreCase,rfReplaceAll]);
-    if (TMapItem(MapListForm.Maps[BattleForm.CurrentMapIndex]).MapInfo.Width = 0) or (TMapItem(MapListForm.Maps[BattleForm.CurrentMapIndex]).MapInfo.Height = 0) then
+    if BattleForm.CurrentMapIndex &gt;= 0 then
+      htmlCode := StringReplace(htmlCode,'[SELECTEDMAPNAME]',TMapItem(MapListForm.Maps[BattleForm.CurrentMapIndex]).MapName,[rfIgnoreCase,rfReplaceAll])
+    else
+      htmlCode := StringReplace(htmlCode,'[SELECTEDMAPNAME]','No map',[rfIgnoreCase,rfReplaceAll]);
+
+    if (BattleForm.CurrentMapIndex &lt; 0) or (TMapItem(MapListForm.Maps[BattleForm.CurrentMapIndex]).MapInfo.Width = 0) or (TMapItem(MapListForm.Maps[BattleForm.CurrentMapIndex]).MapInfo.Height = 0) then
     begin
       htmlCode := StringReplace(htmlCode,'[MAP%WIDTH]','100',[rfIgnoreCase,rfReplaceAll]);
       htmlCode := StringReplace(htmlCode,'[MAP%HEIGHT]','100',[rfIgnoreCase,rfReplaceAll]);
@@ -1097,6 +1101,15 @@
 var
   newWidth,newHeight: integer;
 begin
+  if BattleForm.CurrentMapIndex &lt; 0 then
+  begin
+    Minimap.Picture.Bitmap.Width := BattleForm.NoMapImage.Picture.Width;
+    Minimap.Picture.Bitmap.Height := BattleForm.NoMapImage.Picture.Height;
+    Minimap.Canvas.StretchDraw(Rect(0,0,BattleForm.NoMapImage.Picture.Width,BattleForm.NoMapImage.Picture.Height),BattleForm.NoMapImage.Picture.Bitmap);
+    Minimap.Picture.SaveToFile(MenuCurrentPath+'minimap.bmp');
+    Exit;
+  end;
+
   with TMapItem(MapListForm.Maps[BattleForm.CurrentMapIndex]) do
   begin
     try
@@ -1168,6 +1181,12 @@
 
 procedure TMenuForm.StartSkirmish;
 begin
+  if BattleForm.CurrentMapIndex &lt; 0 then
+  begin
+    MessageDlg('You need to select a map first.',mtInformation,[mbOk],0);
+    Exit;
+  end;
+
   if not GenerateScript(ExtractFilePath(Application.ExeName)+'script.txt') then
     Exit;
 
@@ -1233,6 +1252,8 @@
   script.AddOrChangeKeyValue('GAME/HostIP','localhost');
   script.AddOrChangeKeyValue('GAME/HostPort','8452');
   script.AddOrChangeKeyValue('GAME/MyPlayerNum','0');
+  script.AddOrChangeKeyValue('GAME/MyPlayerName','Me');
+  script.AddOrChangeKeyValue('GAME/IsHost','1');
   script.AddOrChangeKeyValue('GAME/NumPlayers','1');
 
   il.Clear;
@@ -2028,8 +2049,10 @@
   res := FindFilesVFS(res, PChar(s), 255);
   while res &lt;&gt; 0 do
   begin
-    c := TCampaign.Create(Trim(s)+modShortName+'.lua');
+    Delete(s,Pos(#0,s),255);
+    c := TCampaign.Create(s+modShortName+'.lua');
     CampaignList.Add(c);
+    SetLength(s, 255);
     res := FindFilesVFS(res, PChar(s), 255);
   end;
 end;
@@ -2119,14 +2142,14 @@
 
 procedure TMenuForm.SaveSettings;
 var
-  Filename : String;
   Ini : TIniFile;
   i: integer;
+  FileName: String;
 begin
-  Filename := VAR_FOLDER + '\' + 'menuSettings.ini';
-  if FileExists(Filename) then
-    DeleteFile(Filename);
-  Ini := TIniFile.Create(Filename);
+  FileName := ExtractFilePath(Application.ExeName) + MENU_SETTINGS_FILE;
+  if FileExists(FileName) then
+    DeleteFile(MENU_SETTINGS_FILE);
+  Ini := TIniFile.Create(FileName);
   for i:=0 to settingsNames.Count-1 do
     Ini.WriteString('MenuSettings', settingsNames[i], settingsValues[i]);
   Ini.Free;
@@ -2134,13 +2157,13 @@
 
 procedure TMenuForm.LoadSettings;
 var
-  Filename : String;
   Ini : TIniFile;
   i: integer;
   pos: integer;
+  FileName: String;
 begin
-  Filename := VAR_FOLDER + '\' + 'menuSettings.ini';
-  Ini := TIniFile.Create(Filename);
+  FileName := ExtractFilePath(Application.ExeName) + MENU_SETTINGS_FILE;
+  Ini := TIniFile.Create(FileName);
 
   settingsNames.Clear;
   ini.ReadSection('MenuSettings',settingsNames);

Modified: Lobby/TASClient/Misc.pas
===================================================================
--- Lobby/TASClient/Misc.pas	2009-01-22 02:29:22 UTC (rev 7227)
+++ Lobby/TASClient/Misc.pas	2009-01-25 20:19:00 UTC (rev 7228)
@@ -162,10 +162,12 @@
 procedure GetProperties(Obj:TObject; nameList : TStrings; valueList : TList; typeList: TStringList);
 procedure GetEnumPropertyList(Obj:TObject; name : string; enumList : TStringList);
 function StringNChar(c: char; n: integer): string;
-procedure setFocusRecursively(c: TWinControl);
+procedure ShowAndSetFocus(c: TWinControl);
 function PackedShortString(Value: PShortstring;var NextField{: Pointer}): PShortString; overload;
 function PackedShortString(var NextField{: Pointer}): PShortString; overload;
 function GetMethodSignature(Event: PPropInfo): TMethodSignature;
+function crypt_xor(chaine:string;key:string):string;
+function decrypt_xor(chaine:string;key:string):string;
 
 
 implementation
@@ -2496,7 +2498,7 @@
   end;
 end;
 
-procedure setFocusRecursively(c: TWinControl);
+procedure ShowAndSetFocus(c: TWinControl);  // ShowAndSetFocus
 var
   p: TWinControl;
   controlList: TList;
@@ -2536,7 +2538,7 @@
   Inc(PChar(NextField), SizeOf(Result^[0]) + Length(Result^));
 end;  
 
-function GetMethodSignature(Event: PPropInfo): TMethodSignature;        
+function GetMethodSignature(Event: PPropInfo): TMethodSignature;
 type
   PParamListRecord = ^TParamListRecord;
   TParamListRecord = packed record 
@@ -2568,4 +2570,40 @@
   Result.ResultType := PackedShortString(ParamListRecord);
 end;
 
+function decrypt_xor(chaine:string;key:string):string;
+var
+  i,j:integer;
+  s:string;
+begin
+  s := '';
+  for i:=0 to (length(chaine) div 2)-1 do
+    s := s + char(StrToInt('$'+MidStr(chaine,1+i*2,2)));
+  chaine := s;
+  s:='';
+  j:=1;
+  for i:=1 to length(chaine) do
+  begin
+    if j&gt;length(key) then j:=1;
+    s:=s+char(integer(ord(chaine[i])) xor integer(ord(key[j])));
+    j:=j+1;
+  end;
+  Result:=s;
+end;
+
+function crypt_xor(chaine:string;key:string):string;
+var
+  i,j:integer;
+  s:string;
+begin
+  s:='';
+  j:=1;
+  for i:=1 to length(chaine) do
+  begin
+    if j&gt;length(key) then j:=1;
+    s:=s+IntToHex(integer(ord(chaine[i])) xor integer(ord(key[j])),2);
+    j:=j+1;
+  end;
+  Result:=s;
+end;
+
 end.

Modified: Lobby/TASClient/PreferencesFormUnit.dfm
===================================================================
--- Lobby/TASClient/PreferencesFormUnit.dfm	2009-01-22 02:29:22 UTC (rev 7227)
+++ Lobby/TASClient/PreferencesFormUnit.dfm	2009-01-25 20:19:00 UTC (rev 7228)
@@ -1,13 +1,13 @@
 object PreferencesForm: TPreferencesForm
-  Left = 861
-  Top = 106
+  Left = 1073
+  Top = 229
   BorderStyle = bsDialog
   Caption = 'Preferences'
-  ClientHeight = 413
+  ClientHeight = 434
   ClientWidth = 415
   Color = clBtnFace
-  Constraints.MaxHeight = 750
-  Constraints.MaxWidth = 1280
+  Constraints.MaxHeight = 1000
+  Constraints.MaxWidth = 1680
   Font.Charset = DEFAULT_CHARSET
   Font.Color = clWindowText
   Font.Height = -11
@@ -25,7 +25,7 @@
     Left = 0
     Top = 0
     Width = 415
-    Height = 413
+    Height = 434
     Caption = 'Preferences'
     FixedSize = True
     Options.Minimize = False
@@ -35,18 +35,18 @@
       Left = 8
       Top = 32
       Width = 401
-      Height = 329
+      Height = 353
       Color = clBtnFace
-      ActiveTabIndex = 1
+      ActiveTabIndex = 0
       TabAutofit = True
       HiddenItems = &lt;&gt;
       object SpTBXTabItem6: TSpTBXTabItem
         Caption = 'Server'
+        Checked = True
         CustomWidth = 56
       end
       object SpTBXTabItem5: TSpTBXTabItem
         Caption = 'Account'
-        Checked = True
         CustomWidth = 56
       end
       object SpTBXTabItem4: TSpTBXTabItem
@@ -69,324 +69,303 @@
         Caption = 'Scripts'
         CustomWidth = 56
       end
-      object SpTBXTabSheet2: TSpTBXTabSheet
+      object SpTBXTabSheet5: TSpTBXTabSheet
         Left = 0
         Top = 23
         Width = 401
-        Height = 306
-        Caption = 'HTTP'
+        Height = 330
+        Caption = 'Account'
         ImageIndex = -1
-        TabItem = 'SpTBXTabItem2'
-        object GroupBox6: TSpTBXGroupBox
+        TabItem = 'SpTBXTabItem5'
+        object GroupBox2: TSpTBXGroupBox
           Left = 16
           Top = 8
           Width = 369
-          Height = 281
-          Caption = 'Proxy settings'
+          Height = 305
+          Caption = 'Account details'
           Color = clNone
           ParentColor = False
           TabOrder = 0
-          object UseProxyCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 32
-            Width = 65
-            Height = 15
-            Caption = 'Use proxy'
-            TabOrder = 0
-            OnClick = UseProxyCheckBoxClick
-            Checked = True
-            State = cbChecked
+          object RegisterAccountButton: TSpTBXSpeedButton
+            Left = 56
+            Top = 160
+            Width = 185
+            Height = 25
+            Caption = 'Create new account'
+            OnClick = RegisterAccountButtonClick
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
           end
-          object ProxyPanel: TSpTBXPanel
+          object Label4: TSpTBXLabel
             Left = 24
-            Top = 56
-            Width = 321
-            Height = 113
-            Caption = 'ProxyPanel'
-            Color = clNone
-            ParentColor = False
-            TabOrder = 1
-            object ProxyEdit: TSpTBXEdit
-              Left = 64
-              Top = 8
-              Width = 241
-              Height = 21
-              TabOrder = 0
-            end
-            object Label7: TSpTBXLabel
-              Left = 8
-              Top = 8
-              Width = 41
-              Height = 13
-              Caption = 'Address:'
-              LinkFont.Charset = DEFAULT_CHARSET
-              LinkFont.Color = clBlue
-              LinkFont.Height = -11
-              LinkFont.Name = 'MS Sans Serif'
-              LinkFont.Style = [fsUnderline]
-            end
-            object Label8: TSpTBXLabel
-              Left = 8
-              Top = 32
-              Width = 22
-              Height = 13
-              Caption = 'Port:'
-              LinkFont.Charset = DEFAULT_CHARSET
-              LinkFont.Color = clBlue
-              LinkFont.Height = -11
-              LinkFont.Name = 'MS Sans Serif'
-              LinkFont.Style = [fsUnderline]
-            end
-            object JvProxyPortEdit: TJvValidateEdit
-              Left = 64
-              Top = 32
-              Width = 49
-              Height = 21
-              Alignment = taLeftJustify
-              CriticalPoints.MaxValueIncluded = False
-              CriticalPoints.MinValueIncluded = False
-              EditText = '0'
-              TabOrder = 3
-            end
-            object ProxyUserEdit: TSpTBXEdit
-              Left = 64
-              Top = 56
-              Width = 121
-              Height = 21
-              TabOrder = 4
-            end
-            object Label9: TSpTBXLabel
-              Left = 8
-              Top = 56
-              Width = 51
-              Height = 13
-              Caption = 'Username:'
-              LinkFont.Charset = DEFAULT_CHARSET
-              LinkFont.Color = clBlue
-              LinkFont.Height = -11
-              LinkFont.Name = 'MS Sans Serif'
-              LinkFont.Style = [fsUnderline]
-            end
-            object Label10: TSpTBXLabel
-              Left = 8
-              Top = 80
-              Width = 49
-              Height = 13
-              Caption = 'Password:'
-              LinkFont.Charset = DEFAULT_CHARSET
-              LinkFont.Color = clBlue
-              LinkFont.Height = -11
-              LinkFont.Name = 'MS Sans Serif'
-              LinkFont.Style = [fsUnderline]
-            end
-            object ProxyPassEdit: TSpTBXEdit
-              Left = 64
-              Top = 80
-              Width = 121
-              Height = 21
-              TabOrder = 7
-            end
-          end
-        end
-      end
-      object SpTBXTabSheet6: TSpTBXTabSheet
-        Left = 0
-        Top = 23
-        Width = 401
-        Height = 306
-        Caption = 'Server'
-        ImageIndex = -1
-        TabItem = 'SpTBXTabItem6'
-        object GroupBox1: TSpTBXGroupBox
-          Left = 16
-          Top = 8
-          Width = 369
-          Height = 281
-          Caption = 'Server settings'
-          Color = clNone
-          ParentColor = False
-          TabOrder = 0
-          object Label1: TSpTBXLabel
-            Left = 16
-            Top = 32
-            Width = 74
+            Top = 40
+            Width = 51
             Height = 13
-            Caption = 'Server address:'
+            Caption = 'Username:'
             LinkFont.Charset = DEFAULT_CHARSET
             LinkFont.Color = clBlue
             LinkFont.Height = -11
             LinkFont.Name = 'MS Sans Serif'
             LinkFont.Style = [fsUnderline]
           end
-          object Label2: TSpTBXLabel
-            Left = 16
-            Top = 56
-            Width = 55
+          object Label5: TSpTBXLabel
+            Left = 24
+            Top = 72
+            Width = 49
             Height = 13
-            Caption = 'Server port:'
+            Caption = 'Password:'
             LinkFont.Charset = DEFAULT_CHARSET
             LinkFont.Color = clBlue
             LinkFont.Height = -11
             LinkFont.Name = 'MS Sans Serif'
             LinkFont.Style = [fsUnderline]
           end
-          object ServerPortEdit: TSpTBXEdit
-            Left = 96
-            Top = 56
-            Width = 41
+          object UsernameEdit: TSpTBXEdit
+            Left = 120
+            Top = 40
+            Width = 121
             Height = 21
+            TabOrder = 0
+            OnChange = UsernameEditChange
+          end
+          object PasswordEdit: TSpTBXEdit
+            Left = 120
+            Top = 72
+            Width = 121
+            Height = 21
             TabOrder = 1
-            Text = '8200'
+            OnChange = PasswordEditChange
+            PasswordCharW = '*'
           end
-          object CheckBox10: TSpTBXCheckBox
-            Left = 16
-            Top = 128
-            Width = 197
-            Height = 15
-            Caption = 'Connect to backup host if primary fails'
-            TabOrder = 2
-            Checked = True
-            State = cbChecked
+          object LadderPasswordEdit: TSpTBXEdit
+            Left = 120
+            Top = 104
+            Width = 121
+            Height = 21
+            Enabled = False
+            TabOrder = 5
+            PasswordCharW = '*'
           end
-          object CheckBox2: TSpTBXCheckBox
-            Left = 16
-            Top = 144
-            Width = 108
-            Height = 15
-            Caption = 'Connect on startup'
-            TabOrder = 3
+          object SpTBXLabel1: TSpTBXLabel
+            Left = 24
+            Top = 104
+            Width = 87
+            Height = 13
+            Caption = 'Ladder password :'
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
           end
-          object CheckBox7: TSpTBXCheckBox
-            Left = 16
-            Top = 160
-            Width = 226
-            Height = 15
-            Caption = 'Join #main once connected (recommended)'
-            TabOrder = 4
-          end
-          object ServerAddressEdit: TSpTBXButtonEdit
-            Left = 96
-            Top = 32
-            Width = 249
+          object ChangeLadderPasswordButton: TSpTBXButton
+            Left = 248
+            Top = 104
+            Width = 41
             Height = 21
-            TabOrder = 0
-            EditButton.Left = 225
-            EditButton.Top = 0
-            EditButton.Width = 20
-            EditButton.Height = 17
-            EditButton.Caption = '...'
-            EditButton.Align = alRight
-            EditButton.DropDownArrow = False
-            EditButton.DropDownMenu = AddressPopupMenu
-            EditButton.LinkFont.Charset = DEFAULT_CHARSET
-            EditButton.LinkFont.Color = clBlue
-            EditButton.LinkFont.Height = -11
-            EditButton.LinkFont.Name = 'MS Sans Serif'
-            EditButton.LinkFont.Style = [fsUnderline]
-          end
-          object JvXPButton1: TSpTBXButton
-            Left = 272
-            Top = 56
-            Width = 73
-            Height = 21
-            Caption = 'Perform ...'
+            Caption = 'Edit'
             TabOrder = 7
-            OnClick = JvXPButton1Click
+            OnClick = ChangeLadderPasswordButtonClick
             LinkFont.Charset = DEFAULT_CHARSET
             LinkFont.Color = clBlue
             LinkFont.Height = -11
             LinkFont.Name = 'MS Sans Serif'
             LinkFont.Style = [fsUnderline]
           end
+          object RegisterLadderAccountButton: TSpTBXButton
+            Left = 56
+            Top = 192
+            Width = 185
+            Height = 25
+            Caption = 'Create new ladder account'
+            TabOrder = 8
+            OnClick = RegisterLadderAccountButtonClick
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
+          end
+          object RememberPasswordsCheckBox: TSpTBXCheckBox
+            Left = 120
+            Top = 128
+            Width = 117
+            Height = 15
+            Caption = 'remember passwords'
+            TabOrder = 9
+          end
         end
       end
-      object SpTBXTabSheet1: TSpTBXTabSheet
+      object SpTBXTabSheet3: TSpTBXTabSheet
         Left = 0
         Top = 23
         Width = 401
-        Height = 306
-        Caption = 'Skins'
+        Height = 330
+        Caption = 'Interface'
         ImageIndex = -1
-        TabItem = 'SpTBXTabItem1'
-        object GroupBox5: TSpTBXGroupBox
+        TabItem = 'SpTBXTabItem3'
+        object GroupBox4: TSpTBXGroupBox
           Left = 16
           Top = 8
-          Width = 361
-          Height = 281
-          Caption = 'Skin manager'
+          Width = 369
+          Height = 305
+          Caption = 'Interface preferences'
           Color = clNone
           ParentColor = False
           TabOrder = 0
-          object ThemesComboBox: TSpTBXComboBox
-            Left = 48
-            Top = 144
-            Width = 177
-            Height = 21
-            Style = csDropDownList
-            ItemHeight = 13
+          object CheckBox1: TSpTBXCheckBox
+            Left = 24
+            Top = 24
+            Width = 104
+            Height = 15
+            Caption = 'Timestamp events'
             TabOrder = 0
-            OnChange = ThemesComboBoxChange
+            Checked = True
+            State = cbChecked
           end
-          object SpTBXRadioButton1: TSpTBXRadioButton
-            Left = 48
-            Top = 56
-            Width = 44
+          object CheckBox3: TSpTBXCheckBox
+            Left = 24
+            Top = 40
+            Width = 128
             Height = 15
-            Caption = 'None'
+            Caption = 'Filter join/left messages'
             TabOrder = 1
-            TabStop = True
-            OnClick = SpTBXRadioButton1Click
-            Checked = True
           end
-          object SpTBXRadioButton2: TSpTBXRadioButton
-            Left = 48
+          object CheckBox4: TSpTBXCheckBox
+            Left = 24
             Top = 72
-            Width = 62
+            Width = 108
             Height = 15
-            Caption = 'Windows'
+            Caption = 'Show country flags'
             TabOrder = 2
-            OnClick = SpTBXRadioButton2Click
+            Checked = True
+            State = cbChecked
           end
-          object Label3: TSpTBXLabel
-            Left = 32
-            Top = 120
-            Width = 85
-            Height = 13
-            Caption = 'Choose TBX skin:'
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
-          object SpTBXRadioButton3: TSpTBXRadioButton
-            Left = 48
+          object CheckBox5: TSpTBXCheckBox
+            Left = 24
             Top = 88
-            Width = 76
+            Width = 147
             Height = 15
-            Caption = 'TBX themes'
+            Caption = 'Mark unknown maps/mods'
+            TabOrder = 3
+            Checked = True
+            State = cbChecked
+          end
+          object CheckBox6: TSpTBXCheckBox
+            Left = 24
+            Top = 104
+            Width = 251
+            Height = 15
+            Caption = 'Use taskbar button for each form (requires restart)'
             TabOrder = 4
-            OnClick = SpTBXRadioButton3Click
           end
-          object Label11: TSpTBXLabel
-            Left = 32
-            Top = 32
-            Width = 60
-            Height = 13
-            Caption = 'Theme style:'
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
+          object WarnNATCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 120
+            Width = 271
+            Height = 15
+            Caption = 'Display warning icons on battles using NAT traversing'
+            TabOrder = 5
+            Checked = True
+            State = cbChecked
           end
+          object AutoFocusOnPMCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 136
+            Width = 262
+            Height = 15
+            Caption = 'Automatically switch focus to new private messages'
+            TabOrder = 6
+            Checked = True
+            State = cbChecked
+          end
+          object DisableAllSoundsCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 152
+            Width = 103
+            Height = 15
+            Caption = 'Disable all sounds'
+            TabOrder = 7
+          end
+          object UploadReplayCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 248
+            Width = 227
+            Height = 15
+            Caption = 'Ask what to do with replays after each battle'
+            TabOrder = 8
+          end
+          object SortLocalCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 168
+            Width = 132
+            Height = 15
+            Caption = 'Sort the $local player list'
+            TabOrder = 9
+          end
+          object DisplayQuickJoinPanelCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 184
+            Width = 131
+            Height = 15
+            Caption = 'Display Quick join panel'
+            TabOrder = 10
+          end
+          object FilterBattleJoinLeftCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 56
+            Width = 157
+            Height = 15
+            Caption = 'Filter battle join/left messages'
+            TabOrder = 11
+          end
+          object AutoCompletionCurrentChannelCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 200
+            Width = 252
+            Height = 15
+            Caption = 'Auto-completion from current channel'#39's players list'
+            TabOrder = 12
+          end
+          object ChatLogsLimitCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 216
+            Width = 145
+            Height = 15
+            Caption = 'Limit chat logs to 800 lines '
+            TabOrder = 13
+          end
+          object ChatLogsLimitTracker: TSpTBXTrackBar
+            Left = 184
+            Top = 216
+            Width = 121
+            Height = 17
+            Max = 3000
+            Min = 50
+            Frequency = 100
+            Position = 800
+            TabOrder = 14
+            ThumbLength = 10
+            OnChange = ChatLogsLimitTrackerChange
+          end
+          object DisplayUnitsIconsAndNamesCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 232
+            Width = 251
+            Height = 15
+            Caption = 'Load units icons and names when joining (slower)'
+            TabOrder = 15
+          end
         end
       end
       object SpTBXTabSheet7: TSpTBXTabSheet
         Left = 0
         Top = 23
         Width = 401
-        Height = 306
+        Height = 330
         Caption = 'Scripts'
         ImageIndex = -1
         TabItem = 'SpTBXTabItem7'
@@ -456,11 +435,213 @@
           TabOrder = 4
         end
       end
+      object SpTBXTabSheet1: TSpTBXTabSheet
+        Left = 0
+        Top = 23
+        Width = 401
+        Height = 330
+        Caption = 'Skins'
+        ImageIndex = -1
+        TabItem = 'SpTBXTabItem1'
+        object GroupBox5: TSpTBXGroupBox
+          Left = 16
+          Top = 8
+          Width = 361
+          Height = 305
+          Caption = 'Skin manager'
+          Color = clNone
+          ParentColor = False
+          TabOrder = 0
+          object ThemesComboBox: TSpTBXComboBox
+            Left = 48
+            Top = 144
+            Width = 177
+            Height = 21
+            Style = csDropDownList
+            ItemHeight = 13
+            TabOrder = 0
+            OnChange = ThemesComboBoxChange
+          end
+          object SpTBXRadioButton1: TSpTBXRadioButton
+            Left = 48
+            Top = 56
+            Width = 44
+            Height = 15
+            Caption = 'None'
+            TabOrder = 1
+            TabStop = True
+            OnClick = SpTBXRadioButton1Click
+            Checked = True
+          end
+          object SpTBXRadioButton2: TSpTBXRadioButton
+            Left = 48
+            Top = 72
+            Width = 62
+            Height = 15
+            Caption = 'Windows'
+            TabOrder = 2
+            OnClick = SpTBXRadioButton2Click
+          end
+          object Label3: TSpTBXLabel
+            Left = 32
+            Top = 120
+            Width = 85
+            Height = 13
+            Caption = 'Choose TBX skin:'
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
+          end
+          object SpTBXRadioButton3: TSpTBXRadioButton
+            Left = 48
+            Top = 88
+            Width = 76
+            Height = 15
+            Caption = 'TBX themes'
+            TabOrder = 4
+            OnClick = SpTBXRadioButton3Click
+          end
+          object Label11: TSpTBXLabel
+            Left = 32
+            Top = 32
+            Width = 60
+            Height = 13
+            Caption = 'Theme style:'
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
+          end
+        end
+      end
+      object SpTBXTabSheet2: TSpTBXTabSheet
+        Left = 0
+        Top = 23
+        Width = 401
+        Height = 330
+        Caption = 'HTTP'
+        ImageIndex = -1
+        TabItem = 'SpTBXTabItem2'
+        object GroupBox6: TSpTBXGroupBox
+          Left = 16
+          Top = 8
+          Width = 369
+          Height = 305
+          Caption = 'Proxy settings'
+          Color = clNone
+          ParentColor = False
+          TabOrder = 0
+          object UseProxyCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 32
+            Width = 65
+            Height = 15
+            Caption = 'Use proxy'
+            TabOrder = 0
+            OnClick = UseProxyCheckBoxClick
+            Checked = True
+            State = cbChecked
+          end
+          object ProxyPanel: TSpTBXPanel
+            Left = 24
+            Top = 56
+            Width = 321
+            Height = 113
+            Caption = 'ProxyPanel'
+            Color = clNone
+            ParentColor = False
+            TabOrder = 1
+            object ProxyEdit: TSpTBXEdit
+              Left = 64
+              Top = 8
+              Width = 241
+              Height = 21
+              TabOrder = 0
+            end
+            object Label7: TSpTBXLabel
+              Left = 8
+              Top = 8
+              Width = 41
+              Height = 13
+              Caption = 'Address:'
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object Label8: TSpTBXLabel
+              Left = 8
+              Top = 32
+              Width = 22
+              Height = 13
+              Caption = 'Port:'
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object JvProxyPortEdit: TJvValidateEdit
+              Left = 64
+              Top = 32
+              Width = 49
+              Height = 21
+              Alignment = taLeftJustify
+              CriticalPoints.MaxValueIncluded = False
+              CriticalPoints.MinValueIncluded = False
+              EditText = '0'
+              TabOrder = 3
+            end
+            object ProxyUserEdit: TSpTBXEdit
+              Left = 64
+              Top = 56
+              Width = 121
+              Height = 21
+              TabOrder = 4
+            end
+            object Label9: TSpTBXLabel
+              Left = 8
+              Top = 56
+              Width = 51
+              Height = 13
+              Caption = 'Username:'
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object Label10: TSpTBXLabel
+              Left = 8
+              Top = 80
+              Width = 49
+              Height = 13
+              Caption = 'Password:'
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object ProxyPassEdit: TSpTBXEdit
+              Left = 64
+              Top = 80
+              Width = 121
+              Height = 21
+              TabOrder = 7
+            end
+          end
+        end
+      end
       object SpTBXTabSheet4: TSpTBXTabSheet
         Left = 0
         Top = 23
         Width = 401
-        Height = 306
+        Height = 330
         Caption = 'Program'
         ImageIndex = -1
         TabItem = 'SpTBXTabItem4'
@@ -468,14 +649,14 @@
           Left = 16
           Top = 8
           Width = 369
-          Height = 281
+          Height = 305
           Caption = 'Program settings'
           Color = clNone
           ParentColor = False
           TabOrder = 0
           object ResetRegistryButton: TSpTBXSpeedButton
             Left = 240
-            Top = 248
+            Top = 264
             Width = 113
             Height = 22
             Caption = 'Reset registry data'
@@ -578,7 +759,7 @@
           end
           object CheckBox8: TSpTBXCheckBox
             Left = 16
-            Top = 256
+            Top = 280
             Width = 88
             Height = 15
             Caption = 'Enable logging'
@@ -588,7 +769,7 @@
           end
           object CheckBox9: TSpTBXCheckBox
             Left = 16
-            Top = 240
+            Top = 264
             Width = 128
             Height = 15
             Caption = 'Use sound notifications'
@@ -611,7 +792,7 @@
           end
           object CheckForNewVersionCheckBox: TSpTBXCheckBox
             Left = 16
-            Top = 224
+            Top = 248
             Width = 168
             Height = 15
             Caption = 'Auto update lobby to latest beta'
@@ -647,7 +828,7 @@
           end
           object EnableSpringDownloaderCheckBox: TSpTBXCheckBox
             Left = 16
-            Top = 208
+            Top = 232
             Width = 144
             Height = 15
             Caption = 'Enable Spring Downloader'
@@ -657,7 +838,7 @@
           end
           object UseLogonFormCheckBox: TSpTBXCheckBox
             Left = 16
-            Top = 192
+            Top = 216
             Width = 89
             Height = 15
             Caption = 'Use logon form'
@@ -679,304 +860,137 @@
             LinkFont.Name = 'MS Sans Serif'
             LinkFont.Style = [fsUnderline]
           end
-        end
-      end
-      object SpTBXTabSheet3: TSpTBXTabSheet
-        Left = 0
-        Top = 23
-        Width = 401
-        Height = 306
-        Caption = 'Interface'
-        ImageIndex = -1
-        TabItem = 'SpTBXTabItem3'
-        object GroupBox4: TSpTBXGroupBox
-          Left = 16
-          Top = 8
-          Width = 369
-          Height = 281
-          Caption = 'Interface preferences'
-          Color = clNone
-          ParentColor = False
-          TabOrder = 0
-          object CheckBox1: TSpTBXCheckBox
-            Left = 24
-            Top = 24
-            Width = 104
-            Height = 15
-            Caption = 'Timestamp events'
-            TabOrder = 0
-            Checked = True
-            State = cbChecked
-          end
-          object CheckBox3: TSpTBXCheckBox
-            Left = 24
-            Top = 40
-            Width = 128
-            Height = 15
-            Caption = 'Filter join/left messages'
-            TabOrder = 1
-          end
-          object CheckBox4: TSpTBXCheckBox
-            Left = 24
-            Top = 72
-            Width = 108
-            Height = 15
-            Caption = 'Show country flags'
-            TabOrder = 2
-            Checked = True
-            State = cbChecked
-          end
-          object CheckBox5: TSpTBXCheckBox
-            Left = 24
-            Top = 88
-            Width = 147
-            Height = 15
-            Caption = 'Mark unknown maps/mods'
-            TabOrder = 3
-            Checked = True
-            State = cbChecked
-          end
-          object CheckBox6: TSpTBXCheckBox
-            Left = 24
-            Top = 104
-            Width = 251
-            Height = 15
-            Caption = 'Use taskbar button for each form (requires restart)'
-            TabOrder = 4
-          end
-          object WarnNATCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 120
-            Width = 271
-            Height = 15
-            Caption = 'Display warning icons on battles using NAT traversing'
-            TabOrder = 5
-            Checked = True
-            State = cbChecked
-          end
-          object AutoFocusOnPMCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 136
-            Width = 262
-            Height = 15
-            Caption = 'Automatically switch focus to new private messages'
-            TabOrder = 6
-            Checked = True
-            State = cbChecked
-          end
-          object DisableAllSoundsCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 152
-            Width = 103
-            Height = 15
-            Caption = 'Disable all sounds'
-            TabOrder = 7
-          end
-          object UploadReplayCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 248
-            Width = 227
-            Height = 15
-            Caption = 'Ask what to do with replays after each battle'
-            TabOrder = 8
-          end
-          object SortLocalCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 168
-            Width = 132
-            Height = 15
-            Caption = 'Sort the $local player list'
-            TabOrder = 9
-          end
-          object DisplayQuickJoinPanelCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 184
-            Width = 131
-            Height = 15
-            Caption = 'Display Quick join panel'
-            TabOrder = 10
-          end
-          object FilterBattleJoinLeftCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 56
-            Width = 157
-            Height = 15
-            Caption = 'Filter battle join/left messages'
-            TabOrder = 11
-          end
-          object AutoCompletionCurrentChannelCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 200
-            Width = 252
-            Height = 15
-            Caption = 'Auto-completion from current channel'#39's players list'
-            TabOrder = 12
-          end
-          object ChatLogsLimitCheckBox: TSpTBXCheckBox
-            Left = 24
+          object SpringSettingsProfilesButton: TSpTBXButton
+            Left = 240
             Top = 216
-            Width = 145
-            Height = 15
-            Caption = 'Limit chat logs to 800 lines '
-            TabOrder = 13
+            Width = 113
+            Height = 22
+            Caption = 'Spring Settings profiles'
+            TabOrder = 18
+            OnClick = SpringSettingsProfilesButtonClick
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
           end
-          object ChatLogsLimitTracker: TSpTBXTrackBar
-            Left = 184
-            Top = 216
-            Width = 121
-            Height = 17
-            Max = 3000
-            Min = 50
-            Frequency = 100
-            Position = 800
-            TabOrder = 14
-            ThumbLength = 10
-            OnChange = ChatLogsLimitTrackerChange
-          end
-          object DisplayUnitsIconsAndNamesCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 232
-            Width = 251
-            Height = 15
-            Caption = 'Load units icons and names when joining (slower)'
-            TabOrder = 15
-          end
         end
       end
-      object SpTBXTabSheet5: TSpTBXTabSheet
+      object SpTBXTabSheet6: TSpTBXTabSheet
         Left = 0
         Top = 23
         Width = 401
-        Height = 306
-        Caption = 'Account'
+        Height = 330
+        Caption = 'Server'
         ImageIndex = -1
-        TabItem = 'SpTBXTabItem5'
-        object GroupBox2: TSpTBXGroupBox
+        TabItem = 'SpTBXTabItem6'
+        object GroupBox1: TSpTBXGroupBox
           Left = 16
           Top = 8
           Width = 369
-          Height = 281
-          Caption = 'Account details'
+          Height = 305
+          Caption = 'Server settings'
           Color = clNone
           ParentColor = False
           TabOrder = 0
-          object RegisterAccountButton: TSpTBXSpeedButton
-            Left = 56
-            Top = 160
-            Width = 185
-            Height = 25
-            Caption = 'Create new account'
-            OnClick = RegisterAccountButtonClick
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
-          object Label4: TSpTBXLabel
-            Left = 24
-            Top = 40
-            Width = 51
+          object Label1: TSpTBXLabel
+            Left = 16
+            Top = 32
+            Width = 74
             Height = 13
-            Caption = 'Username:'
+            Caption = 'Server address:'
             LinkFont.Charset = DEFAULT_CHARSET
             LinkFont.Color = clBlue
             LinkFont.Height = -11
             LinkFont.Name = 'MS Sans Serif'
             LinkFont.Style = [fsUnderline]
           end
-          object Label5: TSpTBXLabel
-            Left = 24
-            Top = 72
-            Width = 49
+          object Label2: TSpTBXLabel
+            Left = 16
+            Top = 56
+            Width = 55
             Height = 13
-            Caption = 'Password:'
+            Caption = 'Server port:'
             LinkFont.Charset = DEFAULT_CHARSET
             LinkFont.Color = clBlue
             LinkFont.Height = -11
             LinkFont.Name = 'MS Sans Serif'
             LinkFont.Style = [fsUnderline]
           end
-          object UsernameEdit: TSpTBXEdit
-            Left = 120
-            Top = 40
-            Width = 121
+          object ServerPortEdit: TSpTBXEdit
+            Left = 96
+            Top = 56
+            Width = 41
             Height = 21
-            TabOrder = 0
-            OnChange = UsernameEditChange
-          end
-          object PasswordEdit: TSpTBXEdit
-            Left = 120
-            Top = 72
-            Width = 121
-            Height = 21
             TabOrder = 1
-            OnChange = PasswordEditChange
-            PasswordCharW = '*'
+            Text = '8200'
           end
-          object LadderPasswordEdit: TSpTBXEdit
-            Left = 120
-            Top = 104
-            Width = 121
-            Height = 21
-            Enabled = False
-            TabOrder = 5
-            PasswordCharW = '*'
+          object CheckBox10: TSpTBXCheckBox
+            Left = 16
+            Top = 128
+            Width = 197
+            Height = 15
+            Caption = 'Connect to backup host if primary fails'
+            TabOrder = 2
+            Checked = True
+            State = cbChecked
           end
-          object SpTBXLabel1: TSpTBXLabel
-            Left = 24
-            Top = 104
-            Width = 87
-            Height = 13
-            Caption = 'Ladder password :'
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
+          object CheckBox2: TSpTBXCheckBox
+            Left = 16
+            Top = 144
+            Width = 108
+            Height = 15
+            Caption = 'Connect on startup'
+            TabOrder = 3
           end
-          object ChangeLadderPasswordButton: TSpTBXButton
-            Left = 248
-            Top = 104
-            Width = 41
+          object CheckBox7: TSpTBXCheckBox
+            Left = 16
+            Top = 160
+            Width = 226
+            Height = 15
+            Caption = 'Join #main once connected (recommended)'
+            TabOrder = 4
+          end
+          object ServerAddressEdit: TSpTBXButtonEdit
+            Left = 96
+            Top = 32
+            Width = 249
             Height = 21
-            Caption = 'Edit'
+            TabOrder = 0
+            EditButton.Left = 225
+            EditButton.Top = 0
+            EditButton.Width = 20
+            EditButton.Height = 17
+            EditButton.Caption = '...'
+            EditButton.Align = alRight
+            EditButton.DropDownArrow = False
+            EditButton.DropDownMenu = AddressPopupMenu
+            EditButton.LinkFont.Charset = DEFAULT_CHARSET
+            EditButton.LinkFont.Color = clBlue
+            EditButton.LinkFont.Height = -11
+            EditButton.LinkFont.Name = 'MS Sans Serif'
+            EditButton.LinkFont.Style = [fsUnderline]
+          end
+          object JvXPButton1: TSpTBXButton
+            Left = 272
+            Top = 56
+            Width = 73
+            Height = 21
+            Caption = 'Perform ...'
             TabOrder = 7
-            OnClick = ChangeLadderPasswordButtonClick
+            OnClick = JvXPButton1Click
             LinkFont.Charset = DEFAULT_CHARSET
             LinkFont.Color = clBlue
             LinkFont.Height = -11
             LinkFont.Name = 'MS Sans Serif'
             LinkFont.Style = [fsUnderline]
           end
-          object RegisterLadderAccountButton: TSpTBXButton
-            Left = 56
-            Top = 192
-            Width = 185
-            Height = 25
-            Caption = 'Create new ladder account'
-            TabOrder = 8
-            OnClick = RegisterLadderAccountButtonClick
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
-          object RememberPasswordsCheckBox: TSpTBXCheckBox
-            Left = 120
-            Top = 128
-            Width = 117
-            Height = 15
-            Caption = 'remember passwords'
-            TabOrder = 9
-          end
         end
       end
     end
     object ApplyAndCloseButton: TSpTBXButton
       Left = 43
-      Top = 376
+      Top = 392
       Width = 145
       Height = 25
       Caption = 'Apply and close'
@@ -990,7 +1004,7 @@
     end
     object CancelAndCloseButton: TSpTBXButton
       Left = 227
-      Top = 376
+      Top = 392
       Width = 145
       Height = 25
       Caption = 'Cancel and close'

Modified: Lobby/TASClient/PreferencesFormUnit.pas
===================================================================
--- Lobby/TASClient/PreferencesFormUnit.pas	2009-01-22 02:29:22 UTC (rev 7227)
+++ Lobby/TASClient/PreferencesFormUnit.pas	2009-01-25 20:19:00 UTC (rev 7228)
@@ -189,6 +189,7 @@
     RememberPasswordsCheckBox: TSpTBXCheckBox;
     UseLogonFormCheckBox: TSpTBXCheckBox;
     TipsButton: TSpTBXButton;
+    SpringSettingsProfilesButton: TSpTBXButton;
 
     function BattleSortStyleToColumn(SortStyle: Integer): Integer;
     function ColumnToBattleSortStyle(Column: Integer): Integer;
@@ -238,6 +239,7 @@
     procedure ScriptsDebugWindowBtClick(Sender: TObject);
     procedure ScriptsAdvancedOptionsBtClick(Sender: TObject);
     procedure TipsButtonClick(Sender: TObject);
+    procedure SpringSettingsProfilesButtonClick(Sender: TObject);
   private
     { Private declarations }
   public
@@ -248,6 +250,7 @@
   record
     Name: string;
     Address: string;
+    Port: string;
   end;
 
   TLadderCheckAccountThread = class(TTASClientThread)
@@ -324,7 +327,7 @@
   NewAccountUnit, IgnoreListUnit, MapListFormUnit, ColorsPreferenceUnit,
   ManageGroups, ReplaysUnit, PythonScriptDebugFormUnit, LobbyScriptUnit,
   SpringDownloaderFormUnit, LogonFormUnit, TipsFormUnit,
-  TemplateEditorFormUnit;
+  TemplateEditorFormUnit, SpringSettingsProfileFormUnit;
 
 {$R *.dfm}
 
@@ -345,6 +348,7 @@
     except
       Preferences.RememberPasswords := Preferences.Password &lt;&gt; '';
     end;
+
     try Preferences.LadderPassword := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'LadderPassword'); except end;
     try Preferences.ConnectOnStartup := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'ConnectOnStartup'); except end;
     try Preferences.SortStyle := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'SortStyle'); except end;
@@ -454,6 +458,7 @@
     try BattleForm.Panel4.Height := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'Splitter2'); except end;
     //try BattleForm.Panel6.Width := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'Splitter3'); except end;
     try BattleForm.KeepRatioItem.Checked := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'KeepMinimapRatio'); except end;
+    try BattleForm.SpringSettingsProfile := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'SpringSettingsProfile'); except end;
 
     {--&gt;} AllowBattleDetailsUpdate := False;
     //try BattleForm.StartPosRadioGroup.ItemIndex := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'StartPos'); except end;
@@ -567,6 +572,8 @@
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'Splitter2', rdInteger, BattleForm.Panel4.Height);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'Splitter3', rdInteger, BattleForm.Panel6.Width);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'KeepMinimapRatio', rdInteger, Misc.BoolToInt(BattleForm.KeepRatioItem.Checked));
+    Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'SpringSettingsProfile', rdString, BattleForm.SpringSettingsProfile);
+
     //Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'StartPos', rdInteger, BattleForm.StartPosRadioGroup.ItemIndex);
     //Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'GameEnd', rdInteger, BattleForm.GameEndRadioGroup.ItemIndex);
     //Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'LimitDGun', rdInteger, Misc.BoolToInt(BattleForm.LimitDGunCheckBox.Checked));
@@ -1008,15 +1015,19 @@
 
   ServerList[0].Name := 'Official host (taspringmaster.clan-sy.com)';
   ServerList[0].Address := 'taspringmaster.clan-sy.com';
+  ServerList[0].Port := '8200';
 
   ServerList[1].Name := 'Test/Backup server (buildbot.no-ip.org)';
   ServerList[1].Address := 'buildbot.no-ip.org';
+  ServerList[1].Port := '8200';
 
   ServerList[2].Name := 'Test/backup server #2 (taspringmaster.servegame.com)';
   ServerList[2].Address := 'taspringmaster.servegame.com';
+  ServerList[2].Port := '8200';
 
   ServerList[3].Name := 'Local server (localhost)';
   ServerList[3].Address := 'localhost';
+  ServerList[3].Port := '8200';
 
 
   PopulateServerListMenu;
@@ -1111,6 +1122,9 @@
 begin
   ServerAddressEdit.Text := ServerList[(Sender as TSpTBXItem).Tag].Address;
   LogonForm.beServer.Text := ServerList[(Sender as TSpTBXItem).Tag].Address;
+
+  ServerPortEdit.Text := ServerList[(Sender as TSpTBXItem).Tag].Port;
+  LogonForm.txtPort.Text := ServerList[(Sender as TSpTBXItem).Tag].Port;
 end;
 
 procedure TPreferencesForm.GameSettingsButtonClick(Sender: TObject);
@@ -1595,4 +1609,10 @@
   TipsForm.ShowTips(0,True);
 end;
 
+procedure TPreferencesForm.SpringSettingsProfilesButtonClick(
+  Sender: TObject);
+begin
+  SpringSettingsProfileForm.ShowModal;
+end;
+
 end.

Modified: Lobby/TASClient/ProgressBarWindow.dfm
===================================================================
--- Lobby/TASClient/ProgressBarWindow.dfm	2009-01-22 02:29:22 UTC (rev 7227)
+++ Lobby/TASClient/ProgressBarWindow.dfm	2009-01-25 20:19:00 UTC (rev 7228)
@@ -15,7 +15,7 @@
   Font.Name = 'MS Sans Serif'
   Font.Style = []
   OldCreateOrder = False
-  Position = poScreenCenter
+  Position = poMainFormCenter
   Scaled = False
   OnActivate = FormActivate
   OnCreate = FormCreate

Modified: Lobby/TASClient/Python/api.txt
===================================================================
--- Lobby/TASClient/Python/api.txt	2009-01-22 02:29:22 UTC (rev 7227)
+++ Lobby/TASClient/Python/api.txt	2009-01-25 20:19:00 UTC (rev 7228)
@@ -1,8 +1,14 @@
 Callins
 -------
 
-- handleCommand(s)
-- handleIn(s) return dontLetLobbyHandleIt : boolean
+- cmd_ANYTHING(args) return dontLetLobbyHandleIt : boolean
+	ANYTHING can be anything you want, then when typing &quot;/ANYTHING args&quot; in the lobby the function will be trigerred
+- in_PROTOCOLCMD(args) return newArgs
+	PROTOCOLCMD can be any of the incoming protocol command : SAID, SAIDEX ...
+	see the protocol documentation for more information
+- out_PROTOCOLCMD(args) return newArgs
+	PROTOCOLCMD can be any of the outgoing protocol command : SAY, SAYEX ...
+	see the protocol documentation for more information
 - onLoggedIn
 - onDisconnect
 - HandleOut(s) return dontLetLobbyHandleIt : boolean
@@ -115,8 +121,6 @@
 - SetSkin
 - GetSkinList
 
-
-
 callin :
 
 - onMenuPopup(menuName)
\ No newline at end of file

Added: Lobby/TASClient/Python/scripts/layoutProfiles/BattleForm WideScreen.py
===================================================================
--- Lobby/TASClient/Python/scripts/layoutProfiles/BattleForm WideScreen.py	                        (rev 0)
+++ Lobby/TASClient/Python/scripts/layoutProfiles/BattleForm WideScreen.py	2009-01-25 20:19:00 UTC (rev 7228)
@@ -0,0 +1,160 @@
+import lobbyscript
+import sys, os
+
+api = lobbyscript.Callback()
+gui = lobbyscript.GUI()
+
+opList = []
+newControlList = []
+
+PlayerListWidth = &quot;361&quot;
+settingsFile = 'BattleForm_WideScreen_Settings.txt'
+
+def saveSettings():
+	file = open(os.path.join(sys.path[0],'..','scripts','layoutProfiles',settingsFile), 'w')
+	file.write(PlayerListWidth) 
+	file.close()
+	
+def readSettings():
+	global PlayerListWidth
+	if os.path.isfile(os.path.join(sys.path[0],'..','scripts','layoutProfiles',settingsFile)):
+		file = open(os.path.join(sys.path[0],'..','scripts','layoutProfiles',settingsFile), 'r')
+		PlayerListWidth = file.readline()
+		file.close()
+		
+def saveLayoutSettings():
+	global PlayerListWidth
+	print gui.GetControlProperties(&quot;BattleForm.VDTBattleClients&quot;,&quot;&quot;)
+	PlayerListWidth = str(gui.GetControlProperties(&quot;BattleForm.VDTBattleClients&quot;,&quot;&quot;)['Width'])
+	saveSettings()
+
+def addOperationToList(control,property,subprop,oldValue):
+	op = dict()
+	op['Control'] = control
+	op['Property'] = property
+	op['SubProperty'] = subprop
+	op['OldValue'] = oldValue
+	opList.append(op)
+
+def changeControlProp(control,prop,subProp,value, undo = True):
+	p = gui.GetControlProperties(control,prop)
+	
+	if p == None:
+		print &quot;error : changeControlProp(&quot;+control+&quot;,&quot;+prop+&quot;,&quot;+subProp+&quot;,&quot;+str(value)+&quot;,&quot;+str(undo)+&quot;) failed.&quot;
+		
+	if undo:
+		if subProp == 'Align':
+			#  if the align changes we must save the previous pos and size
+			addOperationToList(control,prop,'Top',p['Top'])
+			addOperationToList(control,prop,'Left',p['Left'])
+			addOperationToList(control,prop,'Width',p['Width'])
+			addOperationToList(control,prop,'Height',p['Height'])
+		
+		addOperationToList(control,prop,subProp,p[subProp])
+
+	p[subProp] = value
+	return gui.SetControlProperties(control,prop,p)
+
+def loadLayout():
+	readSettings()
+	
+	gui.StackLayoutChanges(False)
+	changeControlProp(&quot;BattleForm&quot;,&quot;&quot;,&quot;Visible&quot;,&quot;True&quot;)
+	
+	gui.StackLayoutChanges(True)
+	changeControlProp(&quot;BattleForm.VDTBattleClients&quot;,&quot;&quot;,&quot;Height&quot;,&quot;129&quot;);
+	changeControlProp(&quot;BattleForm.VDTBattleClients&quot;,&quot;&quot;,&quot;Top&quot;,&quot;124&quot;);
+	changeControlProp(&quot;BattleForm.MyOptionsGroupBox&quot;,&quot;&quot;,&quot;Height&quot;,&quot;92&quot;);
+	changeControlProp(&quot;BattleForm.MyOptionsGroupBox&quot;,&quot;&quot;,&quot;Left&quot;,&quot;617&quot;);
+	changeControlProp(&quot;BattleForm.MyOptionsGroupBox&quot;,&quot;&quot;,&quot;Top&quot;,&quot;5&quot;);
+	changeControlProp(&quot;BattleForm.MyOptionsGroupBox&quot;,&quot;&quot;,&quot;Width&quot;,&quot;242&quot;);
+	changeControlProp(&quot;BattleForm.MyOptionsGroupBox&quot;,&quot;&quot;,&quot;Align&quot;,&quot;alTop&quot;);
+	changeControlProp(&quot;BattleForm.Label12&quot;,&quot;&quot;,&quot;Top&quot;,&quot;20&quot;);
+	changeControlProp(&quot;BattleForm.MyTeamNoButton&quot;,&quot;&quot;,&quot;Height&quot;,&quot;21&quot;);
+	changeControlProp(&quot;BattleForm.MyTeamNoButton&quot;,&quot;&quot;,&quot;Left&quot;,&quot;60&quot;);
+	changeControlProp(&quot;BattleForm.MyTeamNoButton&quot;,&quot;&quot;,&quot;Top&quot;,&quot;16&quot;);
+	changeControlProp(&quot;BattleForm.MyAllyNoButton&quot;,&quot;&quot;,&quot;Height&quot;,&quot;21&quot;);
+	changeControlProp(&quot;BattleForm.MyAllyNoButton&quot;,&quot;&quot;,&quot;Top&quot;,&quot;16&quot;);
+	changeControlProp(&quot;BattleForm.TeamColorSpeedButton&quot;,&quot;&quot;,&quot;Top&quot;,&quot;16&quot;);
+	changeControlProp(&quot;BattleForm.MySideButton&quot;,&quot;&quot;,&quot;Top&quot;,&quot;16&quot;);
+	changeControlProp(&quot;BattleForm.SpectateCheckBox&quot;,&quot;&quot;,&quot;Top&quot;,&quot;20&quot;);
+	changeControlProp(&quot;BattleForm.Label12&quot;,&quot;&quot;,&quot;Left&quot;,&quot;112&quot;);
+	changeControlProp(&quot;BattleForm.MyAllyNoButton&quot;,&quot;&quot;,&quot;Left&quot;,&quot;168&quot;);
+	changeControlProp(&quot;BattleForm.TeamColorSpeedButton&quot;,&quot;&quot;,&quot;Left&quot;,&quot;216&quot;);
+	changeControlProp(&quot;BattleForm.MySideButton&quot;,&quot;&quot;,&quot;Left&quot;,&quot;336&quot;);
+	changeControlProp(&quot;BattleForm.SpectateCheckBox&quot;,&quot;&quot;,&quot;Left&quot;,&quot;460&quot;);
+	changeControlProp(&quot;BattleForm.TeamColorSpeedButton&quot;,&quot;&quot;,&quot;Height&quot;,&quot;21&quot;);
+	changeControlProp(&quot;BattleForm.MySideButton&quot;,&quot;&quot;,&quot;Height&quot;,&quot;21&quot;);
+	changeControlProp(&quot;BattleForm.MyOptionsGroupBox&quot;,&quot;&quot;,&quot;Height&quot;,&quot;48&quot;);
+	changeControlProp(&quot;BattleForm.VDTBattleClients&quot;,&quot;&quot;,&quot;Width&quot;,&quot;361&quot;);
+	changeControlProp(&quot;BattleForm.VDTBattleClients&quot;,&quot;&quot;,&quot;Align&quot;,&quot;alLeft&quot;);
+	changeControlProp(&quot;BattleForm.lblTeamNbr&quot;,&quot;&quot;,&quot;Height&quot;,&quot;39&quot;);
+	changeControlProp(&quot;BattleForm.lblTeamNbr&quot;,&quot;&quot;,&quot;Left&quot;,&quot;570&quot;);
+	changeControlProp(&quot;BattleForm.lblTeamNbr&quot;,&quot;&quot;,&quot;Top&quot;,&quot;8&quot;);
+	changeControlProp(&quot;BattleForm.lblTeamNbr&quot;,&quot;&quot;,&quot;Width&quot;,&quot;44&quot;);
+	changeControlProp(&quot;BattleForm.lblTeamNbr&quot;,&quot;&quot;,&quot;Align&quot;,&quot;alRight&quot;);
+	changeControlProp(&quot;BattleForm.VDTBattleClients&quot;,&quot;&quot;,&quot;Height&quot;,&quot;129&quot;);
+	changeControlProp(&quot;BattleForm.VDTBattleClients&quot;,&quot;&quot;,&quot;Left&quot;,&quot;8&quot;);
+	changeControlProp(&quot;BattleForm.VDTBattleClients&quot;,&quot;&quot;,&quot;Top&quot;,&quot;124&quot;);
+	changeControlProp(&quot;BattleForm.VDTBattleClients&quot;,&quot;&quot;,&quot;Width&quot;,PlayerListWidth);
+	changeControlProp(&quot;BattleForm.VDTBattleClients&quot;,&quot;&quot;,&quot;Align&quot;,&quot;alRight&quot;);
+	changeControlProp(&quot;BattleForm.SpTBXSplitter2&quot;,&quot;&quot;,&quot;Parent&quot;,&quot;BattleForm.Panel4&quot;);
+	changeControlProp(&quot;BattleForm.SpTBXSplitter2&quot;,&quot;&quot;,&quot;Height&quot;,&quot;6&quot;);
+	changeControlProp(&quot;BattleForm.SpTBXSplitter2&quot;,&quot;&quot;,&quot;Left&quot;,&quot;2&quot;);
+	changeControlProp(&quot;BattleForm.SpTBXSplitter2&quot;,&quot;&quot;,&quot;Top&quot;,&quot;50&quot;);
+	changeControlProp(&quot;BattleForm.SpTBXSplitter2&quot;,&quot;&quot;,&quot;Width&quot;,&quot;863&quot;);
+	changeControlProp(&quot;BattleForm.SpTBXSplitter2&quot;,&quot;&quot;,&quot;Align&quot;,&quot;alRight&quot;);
+	changeControlProp(&quot;BattleForm.ChatRichEdit&quot;,&quot;&quot;,&quot;Parent&quot;,&quot;BattleForm.Panel4&quot;);
+	changeControlProp(&quot;BattleForm.Panel4&quot;,&quot;&quot;,&quot;Height&quot;,&quot;261&quot;);
+	changeControlProp(&quot;BattleForm.Panel4&quot;,&quot;&quot;,&quot;Left&quot;,&quot;4&quot;);
+	changeControlProp(&quot;BattleForm.Panel4&quot;,&quot;&quot;,&quot;Top&quot;,&quot;396&quot;);
+	changeControlProp(&quot;BattleForm.Panel4&quot;,&quot;&quot;,&quot;Width&quot;,&quot;867&quot;);
+	changeControlProp(&quot;BattleForm.Panel4&quot;,&quot;&quot;,&quot;Align&quot;,&quot;alClient&quot;);	
+	gui.AddControl(&quot;ChatPanel&quot;,&quot;BattleForm.Panel4&quot;,&quot;TSpTBXPanel&quot;)
+	newControlList.append(&quot;BattleForm.Panel4.ChatPanel&quot;)
+	changeControlProp(&quot;BattleForm.Panel4.ChatPanel&quot;,&quot;&quot;,&quot;Height&quot;,&quot;0&quot;);
+	changeControlProp(&quot;BattleForm.Panel4.ChatPanel&quot;,&quot;&quot;,&quot;Left&quot;,&quot;0&quot;);
+	changeControlProp(&quot;BattleForm.Panel4.ChatPanel&quot;,&quot;&quot;,&quot;Top&quot;,&quot;0&quot;);
+	changeControlProp(&quot;BattleForm.Panel4.ChatPanel&quot;,&quot;&quot;,&quot;Width&quot;,&quot;0&quot;);
+	changeControlProp(&quot;BattleForm.Panel4.ChatPanel&quot;,&quot;&quot;,&quot;Align&quot;,&quot;alClient&quot;);
+	changeControlProp(&quot;BattleForm.ChatRichEdit&quot;,&quot;&quot;,&quot;Parent&quot;,&quot;BattleForm.Panel4.ChatPanel&quot;);
+	changeControlProp(&quot;BattleForm.InputEdit&quot;,&quot;&quot;,&quot;Parent&quot;,&quot;BattleForm.Panel4.ChatPanel&quot;);
+	changeControlProp(&quot;BattleForm.ChatRichEdit&quot;,&quot;&quot;,&quot;Height&quot;,&quot;193&quot;);
+	changeControlProp(&quot;BattleForm.ChatRichEdit&quot;,&quot;&quot;,&quot;Left&quot;,&quot;0&quot;);
+	changeControlProp(&quot;BattleForm.ChatRichEdit&quot;,&quot;&quot;,&quot;Top&quot;,&quot;48&quot;);
+	changeControlProp(&quot;BattleForm.ChatRichEdit&quot;,&quot;&quot;,&quot;Width&quot;,&quot;321&quot;);
+	changeControlProp(&quot;BattleForm.ChatRichEdit&quot;,&quot;&quot;,&quot;Align&quot;,&quot;alClient&quot;);
+	changeControlProp(&quot;BattleForm.Panel2&quot;,&quot;&quot;,&quot;Visible&quot;,&quot;False&quot;);
+
+	gui.StackLayoutChanges(False)
+	changeControlProp(&quot;BattleForm&quot;,&quot;&quot;,&quot;Visible&quot;,&quot;False&quot;)
+	
+def unloadLayout():
+	global opList
+	global newControlList
+	
+	for i in range(len(opList)):
+		op = opList.pop()
+		changeControlProp(op['Control'],op['Property'],op['SubProperty'],op['OldValue'],False)
+	
+	for controlName in newControlList:
+		gui.DeleteControl(controlName)
+
+	changeControlProp(&quot;BattleForm.Splitter2&quot;,&quot;&quot;,&quot;Height&quot;,&quot;6&quot;);
+	changeControlProp(&quot;BattleForm.Splitter2&quot;,&quot;&quot;,&quot;Left&quot;,&quot;4&quot;);
+	changeControlProp(&quot;BattleForm.Splitter2&quot;,&quot;&quot;,&quot;Top&quot;,&quot;396&quot;);
+	changeControlProp(&quot;BattleForm.Splitter2&quot;,&quot;&quot;,&quot;Width&quot;,&quot;869&quot;);
+	changeControlProp(&quot;BattleForm.Splitter2&quot;,&quot;&quot;,&quot;Align&quot;,&quot;alBottom&quot;);
+	changeControlProp(&quot;BattleForm.Splitter2&quot;,&quot;&quot;,&quot;Height&quot;,&quot;6&quot;);
+	changeControlProp(&quot;BattleForm.Splitter2&quot;,&quot;&quot;,&quot;Left&quot;,&quot;4&quot;);
+	changeControlProp(&quot;BattleForm.Splitter2&quot;,&quot;&quot;,&quot;Top&quot;,&quot;396&quot;);
+	changeControlProp(&quot;BattleForm.Splitter2&quot;,&quot;&quot;,&quot;Width&quot;,&quot;869&quot;);
+	changeControlProp(&quot;BattleForm.Splitter2&quot;,&quot;&quot;,&quot;Align&quot;,&quot;alTop&quot;);
+	changeControlProp(&quot;BattleForm.MyOptionsGroupBox&quot;,&quot;&quot;,&quot;Anchors&quot;,&quot;akTop,akRight&quot;);
+	changeControlProp(&quot;BattleForm.lblTeamNbr&quot;,&quot;&quot;,&quot;Anchors&quot;,&quot;akTop,akRight&quot;);
+	changeControlProp(&quot;BattleForm.VDTBattleClients&quot;,&quot;&quot;,&quot;Align&quot;,&quot;alLeft&quot;);
+	changeControlProp(&quot;BattleForm.VDTBattleClients&quot;,&quot;&quot;,&quot;Anchors&quot;,&quot;akLeft,akTop,akRight,akBottom&quot;);
+
+	
+	opList = []
+	newControlList = []

Modified: Lobby/TASClient/Python/scripts/layoutProfiles/Chat And Battles.py
===================================================================
--- Lobby/TASClient/Python/scripts/layoutProfiles/Chat And Battles.py	2009-01-22 02:29:22 UTC (rev 7227)
+++ Lobby/TASClient/Python/scripts/layoutProfiles/Chat And Battles.py	2009-01-25 20:19:00 UTC (rev 7228)
@@ -16,7 +16,10 @@
 
 def changeControlProp(control,prop,subProp,value, undo = True):
 	p = gui.GetControlProperties(control,prop)
-
+	
+	if p == None:
+		print &quot;error : changeControlProp(&quot;+control+&quot;,&quot;+prop+&quot;,&quot;+subProp+&quot;,&quot;+str(value)+&quot;,&quot;+str(undo)+&quot;) failed.&quot;
+		
 	if undo:
 		if subProp == 'Align':
 			#  if the align changes we must save the previous pos and size

Deleted: Lobby/TASClient/Python/scripts/layoutProfiles/Full Width Battle list.py
===================================================================
--- Lobby/TASClient/Python/scripts/layoutProfiles/Full Width Battle list.py	2009-01-22 02:29:22 UTC (rev 7227)
+++ Lobby/TASClient/Python/scripts/layoutProfiles/Full Width Battle list.py	2009-01-25 20:19:00 UTC (rev 7228)
@@ -1,59 +0,0 @@
-import lobbyscript
-
-api = lobbyscript.Callback()
-gui = lobbyscript.GUI()
-
-opList = []
-newControlList = []
-
-def changeControlProp(control,prop,subProp,value, undo = True):
-	p = gui.GetControlProperties(control,prop)
-
-	if undo:
-		op = dict()
-		op['Control'] = control
-		op['Property'] = prop
-		op['SubProperty'] = subProp
-		op['OldValue'] = p[subProp]
-		opList.append(op)
-
-	p[subProp] = value
-	return gui.SetControlProperties(control,prop,p)
-
-def loadLayout():
-	gui.StackLayoutChanges(True)
-	# move the player list to the right of the chat with battle list under
-	gui.AddControl('testPanel','MainForm.Panel1','TSpTBXPanel')
-	newControlList.append('MainForm.Panel1.testPanel')
-	
-	changeControlProp('MainForm.Panel1.testPanel','','Borders','False')
-
-	changeControlProp('MainForm.Splitter1','','Parent','MainForm.Panel1.testPanel')
-
-	changeControlProp('MainForm.Panel2','','Align','alRight')
-	changeControlProp('MainForm.Panel2','','Parent','MainForm.Panel1.testPanel')
-
-
-
-	changeControlProp('MainForm.PageControl1','','Align','alClient')
-	changeControlProp('MainForm.PageControl1','','Parent','MainForm.Panel1.testPanel')
-
-	changeControlProp('MainForm.Panel4','','Align','alTop') 
-
-	changeControlProp('MainForm.Panel1.testPanel','','Align','alClient')
-	
-	gui.StackLayoutChanges(False)
-	
-def unloadLayout():
-	global opList
-	global newControlList
-	
-	for i in range(1,len(opList)):
-		op = opList.pop()
-		changeControlProp(op['Control'],op['Property'],op['SubProperty'],op['OldValue'],False)
-	
-	for controlName in newControlList:
-		gui.DeleteControl(controlName)
-	
-	opList = []
-	newControlList = []
\ No newline at end of file

Modified: Lobby/TASClient/Python/scripts/layoutProfiles/Small Screen Full.py
===================================================================
--- Lobby/TASClient/Python/scripts/layoutProfiles/Small Screen Full.py	2009-01-22 02:29:22 UTC (rev 7227)
+++ Lobby/TASClient/Python/scripts/layoutProfiles/Small Screen Full.py	2009-01-25 20:19:00 UTC (rev 7228)
@@ -16,7 +16,10 @@
 
 def changeControlProp(control,prop,subProp,value, undo = True):
 	p = gui.GetControlProperties(control,prop)
-
+	
+	if p == None:
+		print &quot;error : changeControlProp(&quot;+control+&quot;,&quot;+prop+&quot;,&quot;+subProp+&quot;,&quot;+str(value)+&quot;,&quot;+str(undo)+&quot;) failed.&quot;
+		
 	if undo:
 		if subProp == 'Align':
 			#  if the align changes we must save the previous pos and size
@@ -46,6 +49,11 @@
 	changeControlProp(&quot;MainForm.Panel1.MainPanel.ChatTab&quot;,&quot;&quot;,&quot;Caption&quot;,&quot;Chat&quot;)
 	gui.AddTab(&quot;New tab&quot;,&quot;BattlesTab&quot;,&quot;MainForm.Panel1.MainPanel.MainTabs&quot;)
 	newControlList.append(&quot;MainForm.Panel1.MainPanel.BattlesTab&quot;)
+	changeControlProp(&quot;MainForm.Panel1.MainPanel.BattlesTab&quot;,&quot;Item&quot;,&quot;CustomHeight&quot;,&quot;30&quot;);
+	changeControlProp(&quot;MainForm.Panel1.MainPanel.BattlesTab&quot;,&quot;Item.FontSettings&quot;,&quot;Bold&quot;,&quot;tsTrue&quot;);
+	changeControlProp(&quot;MainForm.Panel1.MainPanel.BattlesTab&quot;,&quot;Item.FontSettings&quot;,&quot;Size&quot;,&quot;120&quot;);
+	changeControlProp(&quot;MainForm.Panel1.MainPanel.ChatTab&quot;,&quot;Item.FontSettings&quot;,&quot;Size&quot;,&quot;120&quot;);
+	changeControlProp(&quot;MainForm.Panel1.MainPanel.ChatTab&quot;,&quot;Item.FontSettings&quot;,&quot;Bold&quot;,&quot;tsTrue&quot;);
 	changeControlProp(&quot;MainForm.Panel1.MainPanel.BattlesTab&quot;,&quot;&quot;,&quot;Caption&quot;,&quot;Battle list&quot;)
 	changeControlProp(&quot;MainForm.PageControl1&quot;,&quot;&quot;,&quot;Parent&quot;,&quot;MainForm.Panel1.MainPanel.ChatTab&quot;)
 	changeControlProp(&quot;MainForm.Panel3&quot;,&quot;&quot;,&quot;Parent&quot;,&quot;MainForm.Panel1.MainPanel.BattlesTab&quot;)

Modified: Lobby/TASClient/Python/scripts/layoutProfiles/Small Screen.py
===================================================================
--- Lobby/TASClient/Python/scripts/layoutProfiles/Small Screen.py	2009-01-22 02:29:22 UTC (rev 7227)
+++ Lobby/TASClient/Python/scripts/layoutProfiles/Small Screen.py	2009-01-25 20:19:00 UTC (rev 7228)
@@ -16,7 +16,10 @@
 
 def changeControlProp(control,prop,subProp,value, undo = True):
 	p = gui.GetControlProperties(control,prop)
-
+	
+	if p == None:
+		print &quot;error : changeControlProp(&quot;+control+&quot;,&quot;+prop+&quot;,&quot;+subProp+&quot;,&quot;+str(value)+&quot;,&quot;+str(undo)+&quot;) failed.&quot;
+		
 	if undo:
 		if subProp == 'Align':
 			#  if the align changes we must save the previous pos and size
@@ -43,6 +46,11 @@
 	changeControlProp(&quot;MainForm.Panel1.MainPanel.ChatTab&quot;,&quot;&quot;,&quot;Caption&quot;,&quot;Chat&quot;)
 	gui.AddTab(&quot;New tab&quot;,&quot;BattlesTab&quot;,&quot;MainForm.Panel1.MainPanel.MainTabs&quot;)
 	newControlList.append(&quot;MainForm.Panel1.MainPanel.BattlesTab&quot;)
+	changeControlProp(&quot;MainForm.Panel1.MainPanel.BattlesTab&quot;,&quot;Item&quot;,&quot;CustomHeight&quot;,&quot;30&quot;);
+	changeControlProp(&quot;MainForm.Panel1.MainPanel.BattlesTab&quot;,&quot;Item.FontSettings&quot;,&quot;Bold&quot;,&quot;tsTrue&quot;);
+	changeControlProp(&quot;MainForm.Panel1.MainPanel.BattlesTab&quot;,&quot;Item.FontSettings&quot;,&quot;Size&quot;,&quot;120&quot;);
+	changeControlProp(&quot;MainForm.Panel1.MainPanel.ChatTab&quot;,&quot;Item.FontSettings&quot;,&quot;Size&quot;,&quot;120&quot;);
+	changeControlProp(&quot;MainForm.Panel1.MainPanel.ChatTab&quot;,&quot;Item.FontSettings&quot;,&quot;Bold&quot;,&quot;tsTrue&quot;);
 	changeControlProp(&quot;MainForm.Panel1.MainPanel.BattlesTab&quot;,&quot;&quot;,&quot;Caption&quot;,&quot;Battle list&quot;)
 	changeControlProp(&quot;MainForm.PageControl1&quot;,&quot;&quot;,&quot;Parent&quot;,&quot;MainForm.Panel1.MainPanel.ChatTab&quot;)
 	changeControlProp(&quot;MainForm.Panel3&quot;,&quot;&quot;,&quot;Parent&quot;,&quot;MainForm.Panel1.MainPanel.BattlesTab&quot;)

Added: Lobby/TASClient/Python/scripts/layoutProfiles/SpringLobby Layout.py
===================================================================
--- Lobby/TASClient/Python/scripts/layoutProfiles/SpringLobby Layout.py	                        (rev 0)
+++ Lobby/TASClient/Python/scripts/layoutProfiles/SpringLobby Layout.py	2009-01-25 20:19:00 UTC (rev 7228)
@@ -0,0 +1,164 @@
+import lobbyscript
+
+api = lobbyscript.Callback()
+gui = lobbyscript.GUI()
+
+opList = []
+newControlList = []
+
+def addOperationToList(control,property,subprop,oldValue):
+	op = dict()
+	op['Control'] = control
+	op['Property'] = property
+	op['SubProperty'] = subprop
+	op['OldValue'] = oldValue
+	opList.append(op)
+
+def changeControlProp(control,prop,subProp,value, undo = True):
+	p = gui.GetControlProperties(control,prop)
+	
+	if p == None:
+		print &quot;error : changeControlProp(&quot;+control+&quot;,&quot;+prop+&quot;,&quot;+subProp+&quot;,&quot;+str(value)+&quot;,&quot;+str(undo)+&quot;) failed.&quot;
+
+	if undo:
+		if subProp == 'Align':
+			#  if the align changes we must save the previous pos and size
+			addOperationToList(control,prop,'Top',p['Top'])
+			addOperationToList(control,prop,'Left',p['Left'])
+			addOperationToList(control,prop,'Width',p['Width'])
+			addOperationToList(control,prop,'Height',p['Height'])
+		
+		addOperationToList(control,prop,subProp,p[subProp])
+
+	p[subProp] = value
+	return gui.SetControlProperties(control,prop,p)
+
+def loadLayout():
+	gui.StackLayoutChanges(False)
+	changeControlProp(&quot;BattleForm&quot;,&quot;&quot;,&quot;Visible&quot;,&quot;True&quot;)
+	changeControlProp(&quot;MainForm&quot;,&quot;&quot;,&quot;Visible&quot;,&quot;True&quot;)
+	
+	
+	gui.StackLayoutChanges(True)
+	gui.AddControl(&quot;MainPanel&quot;,&quot;MainForm.Panel1&quot;,&quot;TSpTBXPanel&quot;)
+	newControlList.append(&quot;MainForm.Panel1.MainPanel&quot;)
+	gui.AddControl(&quot;MainTabs&quot;,&quot;MainForm.Panel1.MainPanel&quot;,&quot;TSpTBXTabControl&quot;)
+	newControlList.append(&quot;MainForm.Panel1.MainPanel.MainTabs&quot;)
+	gui.AddTab(&quot;New tab&quot;,&quot;ChatTab&quot;,&quot;MainForm.Panel1.MainPanel.MainTabs&quot;)
+	newControlList.append(&quot;MainForm.Panel1.MainPanel.ChatTab&quot;)
+	changeControlProp(&quot;MainForm.Panel1.MainPanel.ChatTab&quot;,&quot;&quot;,&quot;Caption&quot;,&quot;Chat&quot;);
+	gui.AddTab(&quot;New tab&quot;,&quot;BattlesTab&quot;,&quot;MainForm.Panel1.MainPanel.MainTabs&quot;)
+	newControlList.append(&quot;MainForm.Panel1.MainPanel.BattlesTab&quot;)
+	changeControlProp(&quot;MainForm.Panel1.MainPanel.BattlesTab&quot;,&quot;&quot;,&quot;Caption&quot;,&quot;Battle list&quot;);
+	changeControlProp(&quot;MainForm.PageControl1&quot;,&quot;&quot;,&quot;Parent&quot;,&quot;MainForm.Panel1.MainPanel.ChatTab&quot;);
+	changeControlProp(&quot;MainForm.Panel3&quot;,&quot;&quot;,&quot;Parent&quot;,&quot;MainForm.Panel1.MainPanel.BattlesTab&quot;);
+	changeControlProp(&quot;MainForm.Panel2&quot;,&quot;&quot;,&quot;Parent&quot;,&quot;MainForm.Panel1.MainPanel.ChatTab&quot;);
+	changeControlProp(&quot;MainForm.Panel1.MainPanel&quot;,&quot;&quot;,&quot;Align&quot;,&quot;alClient&quot;);
+	changeControlProp(&quot;MainForm.Panel1.MainPanel.MainTabs&quot;,&quot;&quot;,&quot;Align&quot;,&quot;alClient&quot;);
+	changeControlProp(&quot;MainForm.Splitter1&quot;,&quot;&quot;,&quot;Parent&quot;,&quot;MainForm.Panel1.MainPanel.ChatTab&quot;);
+	changeControlProp(&quot;MainForm.Splitter1&quot;,&quot;&quot;,&quot;Align&quot;,&quot;alLeft&quot;);
+	changeControlProp(&quot;MainForm.Splitter1&quot;,&quot;&quot;,&quot;Height&quot;,&quot;636&quot;);
+	changeControlProp(&quot;MainForm.Splitter1&quot;,&quot;&quot;,&quot;Left&quot;,&quot;1147&quot;);
+	changeControlProp(&quot;MainForm.Splitter1&quot;,&quot;&quot;,&quot;Align&quot;,&quot;alRight&quot;);
+	changeControlProp(&quot;MainForm.Splitter2&quot;,&quot;&quot;,&quot;Visible&quot;,&quot;False&quot;);
+	changeControlProp(&quot;MainForm.Panel1.MainPanel.MainTabs&quot;,&quot;Margins&quot;,&quot;Bottom&quot;,&quot;5&quot;);
+	changeControlProp(&quot;MainForm.Panel1.MainPanel.MainTabs&quot;,&quot;Margins&quot;,&quot;Left&quot;,&quot;5&quot;);
+	changeControlProp(&quot;MainForm.Panel1.MainPanel.MainTabs&quot;,&quot;Margins&quot;,&quot;Right&quot;,&quot;5&quot;);
+	changeControlProp(&quot;MainForm.Panel1.MainPanel.MainTabs&quot;,&quot;Margins&quot;,&quot;Top&quot;,&quot;5&quot;);
+	changeControlProp(&quot;MainForm.Panel3&quot;,&quot;&quot;,&quot;Left&quot;,&quot;7&quot;);
+	changeControlProp(&quot;MainForm.Panel3&quot;,&quot;&quot;,&quot;Top&quot;,&quot;283&quot;);
+	changeControlProp(&quot;MainForm.Panel3&quot;,&quot;&quot;,&quot;Width&quot;,&quot;1135&quot;);
+	changeControlProp(&quot;MainForm.Panel3&quot;,&quot;&quot;,&quot;Align&quot;,&quot;alClient&quot;);
+	changeControlProp(&quot;MainForm.FiltersButton&quot;,&quot;&quot;,&quot;Visible&quot;,&quot;False&quot;);
+	changeControlProp(&quot;MainForm.FilterGroup&quot;,&quot;&quot;,&quot;Height&quot;,&quot;173&quot;);
+	changeControlProp(&quot;MainForm.Panel1.MainPanel&quot;,&quot;&quot;,&quot;Borders&quot;,&quot;False&quot;);
+	gui.AddTab(&quot;New tab&quot;,&quot;MapOptionsTab&quot;,&quot;BattleForm.SpTBXTabControl1&quot;)
+	newControlList.append(&quot;BattleForm.MapOptionsTab&quot;)
+	changeControlProp(&quot;BattleForm.MapOptionsTab&quot;,&quot;&quot;,&quot;Caption&quot;,&quot;Map&quot;);
+	changeControlProp(&quot;BattleForm.Panel6&quot;,&quot;&quot;,&quot;Parent&quot;,&quot;BattleForm.MapOptionsTab&quot;);
+	changeControlProp(&quot;BattleForm.Panel1&quot;,&quot;&quot;,&quot;BevelOuter&quot;,&quot;bvNone&quot;);
+	changeControlProp(&quot;BattleForm.Panel5&quot;,&quot;&quot;,&quot;Height&quot;,&quot;355&quot;);
+	changeControlProp(&quot;BattleForm.Panel5&quot;,&quot;&quot;,&quot;Left&quot;,&quot;329&quot;);
+	changeControlProp(&quot;BattleForm.Panel5&quot;,&quot;&quot;,&quot;Align&quot;,&quot;alClient&quot;);
+	gui.AddTab(&quot;New tab&quot;,&quot;BattleTab&quot;,&quot;BattleForm.SpTBXTabControl1&quot;)
+	newControlList.append(&quot;BattleForm.BattleTab&quot;)
+	changeControlProp(&quot;BattleForm.Panel2&quot;,&quot;&quot;,&quot;Parent&quot;,&quot;BattleForm.BattleTab&quot;);
+	changeControlProp(&quot;BattleForm.SpTBXSplitter2&quot;,&quot;&quot;,&quot;Parent&quot;,&quot;BattleForm.BattleTab&quot;);
+	changeControlProp(&quot;BattleForm.Panel4&quot;,&quot;&quot;,&quot;Parent&quot;,&quot;BattleForm.BattleTab&quot;);
+	changeControlProp(&quot;BattleForm.Panel1&quot;,&quot;&quot;,&quot;Height&quot;,&quot;355&quot;);
+	changeControlProp(&quot;BattleForm.Panel1&quot;,&quot;&quot;,&quot;Left&quot;,&quot;0&quot;);
+	changeControlProp(&quot;BattleForm.Panel1&quot;,&quot;&quot;,&quot;Top&quot;,&quot;0&quot;);
+	changeControlProp(&quot;BattleForm.Panel1&quot;,&quot;&quot;,&quot;Width&quot;,&quot;748&quot;);
+	changeControlProp(&quot;BattleForm.Panel1&quot;,&quot;&quot;,&quot;Align&quot;,&quot;alClient&quot;);
+	changeControlProp(&quot;BattleForm.Panel3&quot;,&quot;&quot;,&quot;Borders&quot;,&quot;False&quot;);
+	changeControlProp(&quot;BattleForm.BattleTab&quot;,&quot;&quot;,&quot;Caption&quot;,&quot;Battle&quot;);
+	changeControlProp(&quot;BattleForm.SpTBXTabControl1&quot;,&quot;&quot;,&quot;ActiveTabIndex&quot;,&quot;5&quot;);
+	changeControlProp(&quot;BattleForm.MyOptionsGroupBox&quot;,&quot;&quot;,&quot;Left&quot;,&quot;486&quot;);
+	changeControlProp(&quot;BattleForm.MyOptionsGroupBox&quot;,&quot;&quot;,&quot;Align&quot;,&quot;alTop&quot;);
+	changeControlProp(&quot;BattleForm.lblTeamNbr&quot;,&quot;&quot;,&quot;Left&quot;,&quot;439&quot;);
+	changeControlProp(&quot;BattleForm.lblTeamNbr&quot;,&quot;&quot;,&quot;Align&quot;,&quot;alRight&quot;);
+	changeControlProp(&quot;BattleForm.VDTBattleClients&quot;,&quot;&quot;,&quot;Height&quot;,&quot;197&quot;);
+	changeControlProp(&quot;BattleForm.VDTBattleClients&quot;,&quot;&quot;,&quot;Width&quot;,&quot;426&quot;);
+	changeControlProp(&quot;BattleForm.VDTBattleClients&quot;,&quot;&quot;,&quot;Align&quot;,&quot;alClient&quot;);
+	changeControlProp(&quot;BattleForm.Splitter2&quot;,&quot;&quot;,&quot;Visible&quot;,&quot;False&quot;);
+	changeControlProp(&quot;BattleForm.Label12&quot;,&quot;&quot;,&quot;Left&quot;,&quot;115&quot;);
+	changeControlProp(&quot;BattleForm.Label12&quot;,&quot;&quot;,&quot;Top&quot;,&quot;20&quot;);
+	changeControlProp(&quot;BattleForm.MyAllyNoButton&quot;,&quot;&quot;,&quot;Left&quot;,&quot;175&quot;);
+	changeControlProp(&quot;BattleForm.MyAllyNoButton&quot;,&quot;&quot;,&quot;Top&quot;,&quot;18&quot;);
+	changeControlProp(&quot;BattleForm.MySideButton&quot;,&quot;&quot;,&quot;Left&quot;,&quot;225&quot;);
+	changeControlProp(&quot;BattleForm.MySideButton&quot;,&quot;&quot;,&quot;Top&quot;,&quot;18&quot;);
+	changeControlProp(&quot;BattleForm.MySideButton&quot;,&quot;&quot;,&quot;Height&quot;,&quot;20&quot;);
+	changeControlProp(&quot;BattleForm.TeamColorSpeedButton&quot;,&quot;&quot;,&quot;Height&quot;,&quot;20&quot;);
+	changeControlProp(&quot;BattleForm.TeamColorSpeedButton&quot;,&quot;&quot;,&quot;Top&quot;,&quot;18&quot;);
+	changeControlProp(&quot;BattleForm.TeamColorSpeedButton&quot;,&quot;&quot;,&quot;Left&quot;,&quot;345&quot;);
+	changeControlProp(&quot;BattleForm.SpectateCheckBox&quot;,&quot;&quot;,&quot;Left&quot;,&quot;465&quot;);
+	changeControlProp(&quot;BattleForm.SpectateCheckBox&quot;,&quot;&quot;,&quot;Top&quot;,&quot;21&quot;);
+	changeControlProp(&quot;BattleForm.MyOptionsGroupBox&quot;,&quot;&quot;,&quot;Height&quot;,&quot;50&quot;);
+	changeControlProp(&quot;BattleForm.Panel4&quot;,&quot;&quot;,&quot;Borders&quot;,&quot;False&quot;);
+	changeControlProp(&quot;BattleForm.Panel2&quot;,&quot;&quot;,&quot;BevelOuter&quot;,&quot;bvNone&quot;);
+	gui.AddTab(&quot;New tab&quot;,&quot;BattleTab&quot;,&quot;MainForm.Panel1.MainPanel.MainTabs&quot;)
+	newControlList.append(&quot;MainForm.Panel1.MainPanel.BattleTab&quot;)
+	changeControlProp(&quot;MainForm.Panel1.MainPanel.BattleTab&quot;,&quot;Item&quot;,&quot;CustomHeight&quot;,&quot;30&quot;);
+	changeControlProp(&quot;MainForm.Panel1.MainPanel.BattleTab&quot;,&quot;Item.FontSettings&quot;,&quot;Bold&quot;,&quot;tsTrue&quot;);
+	changeControlProp(&quot;MainForm.Panel1.MainPanel.BattlesTab&quot;,&quot;Item.FontSettings&quot;,&quot;Bold&quot;,&quot;tsTrue&quot;);
+	changeControlProp(&quot;MainForm.Panel1.MainPanel.BattlesTab&quot;,&quot;Item.FontSettings&quot;,&quot;Size&quot;,&quot;120&quot;);
+	changeControlProp(&quot;MainForm.Panel1.MainPanel.BattleTab&quot;,&quot;Item.FontSettings&quot;,&quot;Size&quot;,&quot;120&quot;);
+	changeControlProp(&quot;MainForm.Panel1.MainPanel.ChatTab&quot;,&quot;Item.FontSettings&quot;,&quot;Size&quot;,&quot;120&quot;);
+	changeControlProp(&quot;MainForm.Panel1.MainPanel.ChatTab&quot;,&quot;Item.FontSettings&quot;,&quot;Bold&quot;,&quot;tsTrue&quot;);
+	changeControlProp(&quot;MainForm.Panel1.MainPanel.BattleTab&quot;,&quot;&quot;,&quot;Caption&quot;,&quot;Battle&quot;);
+	changeControlProp(&quot;BattleForm.Panel3&quot;,&quot;&quot;,&quot;Parent&quot;,&quot;MainForm.Panel1.MainPanel.BattleTab&quot;);
+	changeControlProp(&quot;BattleForm.Panel1&quot;,&quot;&quot;,&quot;Parent&quot;,&quot;MainForm.Panel1.MainPanel.BattleTab&quot;);
+
+	gui.StackLayoutChanges(False)
+	changeControlProp(&quot;BattleForm&quot;,&quot;&quot;,&quot;Visible&quot;,&quot;False&quot;)
+	
+def unloadLayout():
+	global opList
+	global newControlList
+	
+	for i in range(len(opList)):
+		op = opList.pop()
+		changeControlProp(op['Control'],op['Property'],op['SubProperty'],op['OldValue'],False)
+	
+	for controlName in newControlList:
+		gui.DeleteControl(controlName)
+
+	changeControlProp(&quot;BattleForm.Panel1&quot;,&quot;&quot;,&quot;Align&quot;,&quot;alBottom&quot;)
+	changeControlProp(&quot;BattleForm.Splitter2&quot;,&quot;&quot;,&quot;Align&quot;,&quot;alBottom&quot;)
+	changeControlProp(&quot;BattleForm.Panel4&quot;,&quot;&quot;,&quot;Align&quot;,&quot;alBottom&quot;)
+	changeControlProp(&quot;BattleForm.SpTBXSplitter2&quot;,&quot;&quot;,&quot;Align&quot;,&quot;alBottom&quot;)
+	changeControlProp(&quot;BattleForm.Panel1&quot;,&quot;&quot;,&quot;Align&quot;,&quot;alTop&quot;)
+	changeControlProp(&quot;BattleForm.SpTBXSplitter2&quot;,&quot;&quot;,&quot;Align&quot;,&quot;alTop&quot;)
+	changeControlProp(&quot;BattleForm.Panel4&quot;,&quot;&quot;,&quot;Align&quot;,&quot;alTop&quot;)
+	changeControlProp(&quot;BattleForm.Splitter2&quot;,&quot;&quot;,&quot;Align&quot;,&quot;alTop&quot;)
+	changeControlProp(&quot;BattleForm.MyOptionsGroupBox&quot;,&quot;&quot;,&quot;Anchors&quot;,&quot;akTop,akRight&quot;)
+	changeControlProp(&quot;BattleForm.Panel4&quot;,&quot;&quot;,&quot;Anchors&quot;,&quot;akLeft,akTop,akRight,akBottom&quot;)
+	changeControlProp(&quot;BattleForm.lblTeamNbr&quot;,&quot;&quot;,&quot;Anchors&quot;,&quot;akTop,akRight&quot;)
+	changeControlProp(&quot;BattleForm.VDTBattleClients&quot;,&quot;&quot;,&quot;Anchors&quot;,&quot;akLeft,akTop,akRight,akBottom&quot;)
+	changeControlProp(&quot;MainForm.Splitter1&quot;,&quot;&quot;,&quot;Align&quot;,&quot;alLeft&quot;)
+	changeControlProp(&quot;MainForm.Splitter1&quot;,&quot;&quot;,&quot;Align&quot;,&quot;alRight&quot;)
+	changeControlProp(&quot;MainForm.Splitter2&quot;,&quot;&quot;,&quot;Align&quot;,&quot;alTop&quot;)
+	changeControlProp(&quot;MainForm.Splitter2&quot;,&quot;&quot;,&quot;Align&quot;,&quot;alBottom&quot;)
+	
+	opList = []
+	newControlList = []

Modified: Lobby/TASClient/PythonScriptDebugFormUnit.dfm
===================================================================
--- Lobby/TASClient/PythonScriptDebugFormUnit.dfm	2009-01-22 02:29:22 UTC (rev 7227)
+++ Lobby/TASClient/PythonScriptDebugFormUnit.dfm	2009-01-25 20:19:00 UTC (rev 7228)
@@ -11,6 +11,7 @@
   Font.Name = 'MS Sans Serif'
   Font.Style = []
   OldCreateOrder = False
+  Position = poMainFormCenter
   OnCreate = FormCreate
   PixelsPerInch = 96
   TextHeight = 13

Modified: Lobby/TASClient/ReplaysUnit.dfm
===================================================================
--- Lobby/TASClient/ReplaysUnit.dfm	2009-01-22 02:29:22 UTC (rev 7227)
+++ Lobby/TASClient/ReplaysUnit.dfm	2009-01-25 20:19:00 UTC (rev 7228)
@@ -1,6 +1,6 @@
 object ReplaysForm: TReplaysForm
-  Left = 952
-  Top = 181
+  Left = 749
+  Top = 249
   Width = 809
   Height = 640
   Caption = 'Replays'

Modified: Lobby/TASClient/ReplaysUnit.pas
===================================================================
--- Lobby/TASClient/ReplaysUnit.pas	2009-01-22 02:29:22 UTC (rev 7227)
+++ Lobby/TASClient/ReplaysUnit.pas	2009-01-25 20:19:00 UTC (rev 7228)
@@ -417,6 +417,9 @@
         end
         else
           rep.Free;
+
+        //if s.isCorrupted then
+        //  MainForm.AddMainLog('Replay corrupted : '+sr.Name,Colors.Error);
       end
     until FindNext(sr) &lt;&gt; 0;
     FindClose(sr);
@@ -1033,10 +1036,15 @@
   springDir: string;
   Replay: TReplay;
   springExeVersion: String;
+  version1: TStringList;
+  version2: TStringList;
 begin
   if VDTReplays.FocusedNode = nil then // just in case
     Exit;
 
+  version1 := TStringList.Create;
+  version2 := TStringList.Create;
+
   Replay := GetReplayFromNode(VDTReplays.FocusedNode);
 
   if RunningUnderWine then
@@ -1055,7 +1063,11 @@
     if not FileExists(springDir+'spring.exe') then
     begin
       springExeVersion := GetSpringVersionFromEXE;
-      if springExeVersion &lt;&gt; Replay.SpringVersion then
+
+      ParseDelimited(version1,springExeVersion,'.','');
+      ParseDelimited(version2,Replay.SpringVersion,'.','');
+
+      if (springExeVersion &lt;&gt; Replay.SpringVersion) and (((version1.Count &lt; 3) and (version2.Count &lt; 3)) or not((version1[0] = version2[0]) and (version1[1] = version2[1]) and (version1[2] = version2[2]))) then
         if MessageDlg(springDir + 'spring.exe not found.'+EOL+EOL+'Watching a replay with the wrong spring version may not work.'+EOL+EOL+'Watch with the default spring.exe ('+springExeVersion+') ?',mtWarning,[mbYes,mbNo],0) = mrNo then
           Exit;
       springDir := ExtractFilePath(Application.ExeName);
@@ -1071,7 +1083,7 @@
       end;
     end;
   end;
-  ShellExecute(MainForm.Handle, 'open', PChar(springDir+'spring.exe'), PChar(AnsiString(Replay.FileName)), PChar(springDir), SW_SHOWMAXIMIZED);
+  ShellExecute(MainForm.Handle, 'open', PChar(springDir+'spring.exe'), PChar(AnsiString(Replay.FileName)), PChar(springDir), SW_MAX);
 end;
 
 procedure TReplaysForm.DeleteButtonClick(Sender: TObject);
@@ -1417,6 +1429,7 @@
 
 procedure TReplaysForm.VDTReplaysClick;
 begin
+  if VDTReplays.FocusedNode = nil then Exit;
   if not LoadReplay(GetReplayFromNode(VDTReplays.FocusedNode)) then
   begin
     WasLastLoadSuccessful := False;

Modified: Lobby/TASClient/SplashScreenUnit.pas
===================================================================
--- Lobby/TASClient/SplashScreenUnit.pas	2009-01-22 02:29:22 UTC (rev 7227)
+++ Lobby/TASClient/SplashScreenUnit.pas	2009-01-25 20:19:00 UTC (rev 7228)
@@ -14,6 +14,7 @@
 
     procedure CreateParams(var Params: TCreateParams); override;
     procedure UpdateText(Text: string);
+    function MsgBox(const Msg: string; DlgType: TMsgDlgType; Buttons: TMsgDlgButtons; HelpCtx: Longint): Word;
   private
     { Private declarations }
   public
@@ -53,4 +54,9 @@
   Update;
 end;
 
+function TSplashScreenForm.MsgBox(const Msg: string; DlgType: TMsgDlgType; Buttons: TMsgDlgButtons; HelpCtx: Longint): Word;
+begin
+  Result := MessageDlg(Msg,DlgType,Buttons,HelpCtx);
+end;
+
 end.

Modified: Lobby/TASClient/SpringDownloaderFormUnit.dfm
===================================================================
--- Lobby/TASClient/SpringDownloaderFormUnit.dfm	2009-01-22 02:29:22 UTC (rev 7227)
+++ Lobby/TASClient/SpringDownloaderFormUnit.dfm	2009-01-25 20:19:00 UTC (rev 7228)
@@ -14,7 +14,7 @@
   Font.Name = 'MS Sans Serif'
   Font.Style = []
   OldCreateOrder = False
-  Position = poScreenCenter
+  Position = poMainFormCenter
   OnClose = FormClose
   OnCreate = FormCreate
   PixelsPerInch = 96

Added: Lobby/TASClient/SpringSettingsProfileFormUnit.ddp
===================================================================
(Binary files differ)


Property changes on: Lobby/TASClient/SpringSettingsProfileFormUnit.ddp
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: Lobby/TASClient/SpringSettingsProfileFormUnit.dfm
===================================================================
--- Lobby/TASClient/SpringSettingsProfileFormUnit.dfm	                        (rev 0)
+++ Lobby/TASClient/SpringSettingsProfileFormUnit.dfm	2009-01-25 20:19:00 UTC (rev 7228)
@@ -0,0 +1,242 @@
+object SpringSettingsProfileForm: TSpringSettingsProfileForm
+  Left = 668
+  Top = 394
+  BorderStyle = bsSingle
+  Caption = 'Spring settings profiles'
+  ClientHeight = 385
+  ClientWidth = 398
+  Color = clBtnFace
+  Constraints.MaxHeight = 1000
+  Constraints.MaxWidth = 1680
+  Font.Charset = DEFAULT_CHARSET
+  Font.Color = clWindowText
+  Font.Height = -11
+  Font.Name = 'MS Sans Serif'
+  Font.Style = []
+  OldCreateOrder = False
+  Position = poScreenCenter
+  OnClose = FormClose
+  OnCreate = FormCreate
+  PixelsPerInch = 96
+  TextHeight = 13
+  object SpTBXTitleBar1: TSpTBXTitleBar
+    Left = 0
+    Top = 0
+    Width = 398
+    Height = 385
+    Caption = 'Spring settings profiles'
+    object gbPlaying: TSpTBXGroupBox
+      Left = 16
+      Top = 64
+      Width = 369
+      Height = 41
+      Caption = 'Playing profile '
+      Font.Charset = DEFAULT_CHARSET
+      Font.Color = clWindowText
+      Font.Height = -11
+      Font.Name = 'MS Sans Serif'
+      Font.Style = [fsBold]
+      ParentFont = False
+      TabOrder = 1
+      object bePlaying: TSpTBXButtonEdit
+        Left = 8
+        Top = 16
+        Width = 353
+        Height = 21
+        Font.Charset = DEFAULT_CHARSET
+        Font.Color = clWindowText
+        Font.Height = -11
+        Font.Name = 'MS Sans Serif'
+        Font.Style = []
+        ParentFont = False
+        TabOrder = 0
+        EditButton.Left = 329
+        EditButton.Top = 0
+        EditButton.Width = 20
+        EditButton.Height = 17
+        EditButton.Caption = '...'
+        EditButton.Align = alRight
+        EditButton.OnClick = bePlayingSubEditButton0Click
+        EditButton.LinkFont.Charset = DEFAULT_CHARSET
+        EditButton.LinkFont.Color = clBlue
+        EditButton.LinkFont.Height = -11
+        EditButton.LinkFont.Name = 'MS Sans Serif'
+        EditButton.LinkFont.Style = [fsUnderline]
+      end
+    end
+    object SpTBXLabel1: TSpTBXLabel
+      Left = 16
+      Top = 40
+      Width = 369
+      Height = 17
+      Caption = 'Pick a Spring Settings file to use according to the situation :'
+      AutoSize = False
+      Wrapping = twWrap
+      LinkFont.Charset = DEFAULT_CHARSET
+      LinkFont.Color = clBlue
+      LinkFont.Height = -11
+      LinkFont.Name = 'MS Sans Serif'
+      LinkFont.Style = [fsUnderline]
+    end
+    object gbSpectator: TSpTBXGroupBox
+      Left = 16
+      Top = 112
+      Width = 369
+      Height = 41
+      Caption = 'Spectator profile'
+      Font.Charset = DEFAULT_CHARSET
+      Font.Color = clWindowText
+      Font.Height = -11
+      Font.Name = 'MS Sans Serif'
+      Font.Style = [fsBold]
+      ParentFont = False
+      TabOrder = 3
+      object beSpectator: TSpTBXButtonEdit
+        Left = 8
+        Top = 16
+        Width = 353
+        Height = 21
+        Font.Charset = DEFAULT_CHARSET
+        Font.Color = clWindowText
+        Font.Height = -11
+        Font.Name = 'MS Sans Serif'
+        Font.Style = []
+        ParentFont = False
+        TabOrder = 0
+        EditButton.Left = 329
+        EditButton.Top = 0
+        EditButton.Width = 20
+        EditButton.Height = 17
+        EditButton.Caption = '...'
+        EditButton.Align = alRight
+        EditButton.OnClick = beSpectatorSubEditButton0Click
+        EditButton.LinkFont.Charset = DEFAULT_CHARSET
+        EditButton.LinkFont.Color = clBlue
+        EditButton.LinkFont.Height = -11
+        EditButton.LinkFont.Name = 'MS Sans Serif'
+        EditButton.LinkFont.Style = [fsUnderline]
+      end
+    end
+    object SpTBXLabel2: TSpTBXLabel
+      Left = 16
+      Top = 160
+      Width = 172
+      Height = 13
+      Caption = '(leave empty to use the default one )'
+      LinkFont.Charset = DEFAULT_CHARSET
+      LinkFont.Color = clBlue
+      LinkFont.Height = -11
+      LinkFont.Name = 'MS Sans Serif'
+      LinkFont.Style = [fsUnderline]
+    end
+    object CustomGroupBox: TSpTBXGroupBox
+      Left = 16
+      Top = 184
+      Width = 369
+      Height = 161
+      Caption = 'Custom profiles'
+      Font.Charset = DEFAULT_CHARSET
+      Font.Color = clWindowText
+      Font.Height = -11
+      Font.Name = 'MS Sans Serif'
+      Font.Style = [fsBold]
+      ParentFont = False
+      TabOrder = 5
+      object lstCustom: TSpTBXListBox
+        Left = 8
+        Top = 32
+        Width = 353
+        Height = 121
+        Font.Charset = DEFAULT_CHARSET
+        Font.Color = clWindowText
+        Font.Height = -11
+        Font.Name = 'MS Sans Serif'
+        Font.Style = []
+        ItemHeight = 16
+        ParentFont = False
+        TabOrder = 0
+      end
+      object btAdd: TSpTBXButton
+        Left = 192
+        Top = 16
+        Width = 57
+        Height = 17
+        Caption = 'Add'
+        Font.Charset = DEFAULT_CHARSET
+        Font.Color = clWindowText
+        Font.Height = -11
+        Font.Name = 'MS Sans Serif'
+        Font.Style = []
+        ParentFont = False
+        TabOrder = 1
+        OnClick = btAddClick
+        LinkFont.Charset = DEFAULT_CHARSET
+        LinkFont.Color = clBlue
+        LinkFont.Height = -11
+        LinkFont.Name = 'MS Sans Serif'
+        LinkFont.Style = [fsUnderline]
+      end
+      object btEdit: TSpTBXButton
+        Left = 248
+        Top = 16
+        Width = 57
+        Height = 17
+        Caption = 'Edit'
+        Font.Charset = DEFAULT_CHARSET
+        Font.Color = clWindowText
+        Font.Height = -11
+        Font.Name = 'MS Sans Serif'
+        Font.Style = []
+        ParentFont = False
+        TabOrder = 2
+        OnClick = btEditClick
+        LinkFont.Charset = DEFAULT_CHARSET
+        LinkFont.Color = clBlue
+        LinkFont.Height = -11
+        LinkFont.Name = 'MS Sans Serif'
+        LinkFont.Style = [fsUnderline]
+      end
+      object btDelete: TSpTBXButton
+        Left = 304
+        Top = 16
+        Width = 57
+        Height = 17
+        Caption = 'Delete'
+        Font.Charset = DEFAULT_CHARSET
+        Font.Color = clWindowText
+        Font.Height = -11
+        Font.Name = 'MS Sans Serif'
+        Font.Style = []
+        ParentFont = False
+        TabOrder = 3
+        OnClick = btDeleteClick
+        LinkFont.Charset = DEFAULT_CHARSET
+        LinkFont.Color = clBlue
+        LinkFont.Height = -11
+        LinkFont.Name = 'MS Sans Serif'
+        LinkFont.Style = [fsUnderline]
+      end
+    end
+    object btClose: TSpTBXButton
+      Left = 160
+      Top = 352
+      Width = 89
+      Height = 25
+      Caption = 'Close'
+      TabOrder = 6
+      OnClick = btCloseClick
+      LinkFont.Charset = DEFAULT_CHARSET
+      LinkFont.Color = clBlue
+      LinkFont.Height = -11
+      LinkFont.Name = 'MS Sans Serif'
+      LinkFont.Style = [fsUnderline]
+    end
+  end
+  object OpenDialog1: TOpenDialog
+    DefaultExt = 'cfg'
+    Filter = 'Spring settings file|*.cfg'
+    Options = [ofHideReadOnly, ofFileMustExist, ofEnableSizing]
+    Left = 240
+    Top = 160
+  end
+end

Added: Lobby/TASClient/SpringSettingsProfileFormUnit.pas
===================================================================
--- Lobby/TASClient/SpringSettingsProfileFormUnit.pas	                        (rev 0)
+++ Lobby/TASClient/SpringSettingsProfileFormUnit.pas	2009-01-25 20:19:00 UTC (rev 7228)
@@ -0,0 +1,200 @@
+unit SpringSettingsProfileFormUnit;
+
+interface
+
+uses
+  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
+  Dialogs, SpTBXItem, StdCtrls, SpTBXEditors, TBXDkPanels, SpTBXControls,
+  TntStdCtrls, IniFiles,MainUnit;
+
+type
+  TSpringSettingsProfileForm = class(TForm)
+    SpTBXTitleBar1: TSpTBXTitleBar;
+    gbPlaying: TSpTBXGroupBox;
+    SpTBXLabel1: TSpTBXLabel;
+    bePlaying: TSpTBXButtonEdit;
+    gbSpectator: TSpTBXGroupBox;
+    beSpectator: TSpTBXButtonEdit;
+    SpTBXLabel2: TSpTBXLabel;
+    CustomGroupBox: TSpTBXGroupBox;
+    lstCustom: TSpTBXListBox;
+    btClose: TSpTBXButton;
+    btAdd: TSpTBXButton;
+    btEdit: TSpTBXButton;
+    btDelete: TSpTBXButton;
+    OpenDialog1: TOpenDialog;
+    procedure FormCreate(Sender: TObject);
+    procedure bePlayingSubEditButton0Click(Sender: TObject);
+    procedure beSpectatorSubEditButton0Click(Sender: TObject);
+    procedure btAddClick(Sender: TObject);
+    procedure btDeleteClick(Sender: TObject);
+    procedure btEditClick(Sender: TObject);
+    procedure FormClose(Sender: TObject; var Action: TCloseAction);
+    procedure btCloseClick(Sender: TObject);
+  private
+    { Private declarations }
+  public
+    cpNames: TStringList;
+    cpFiles: TStringList;
+    function getSettingsFile(spectator: boolean;custom: boolean; customProfileName: string):string;
+    procedure SaveProfiles;
+    procedure LoadProfiles;
+  end;
+
+var
+  SpringSettingsProfileForm: TSpringSettingsProfileForm;
+
+implementation
+
+uses Misc, BattleFormUnit;
+
+{$R *.dfm}
+
+procedure TSpringSettingsProfileForm.FormCreate(Sender: TObject);
+begin
+  if not SpTBXTitleBar1.Active then
+    RemoveSpTBXTitleBarMarges(self);
+
+  cpNames := TStringList.Create;
+  cpFiles := TStringList.Create;
+end;
+
+procedure TSpringSettingsProfileForm.bePlayingSubEditButton0Click(
+  Sender: TObject);
+begin
+  if OpenDialog1.Execute then
+    bePlaying.Text := OpenDialog1.FileName;
+end;
+
+procedure TSpringSettingsProfileForm.beSpectatorSubEditButton0Click(
+  Sender: TObject);
+begin
+  if OpenDialog1.Execute then
+    beSpectator.Text := OpenDialog1.FileName;
+end;
+
+procedure TSpringSettingsProfileForm.btAddClick(Sender: TObject);
+var
+  profileName: string;
+begin
+  profileName := InputBox('Adding profile','Profile name :','');
+  if LowerCase(profileName) = 'default' then
+  begin
+    MessageDlg('Reserved profile name.',mtInformation,[mbOk],0);
+    Exit;
+  end;
+  if (profileName &lt;&gt; '') and OpenDialog1.Execute then
+  begin
+    cpNames.Add(profileName);
+    cpFiles.Add(OpenDialog1.FileName);
+    lstCustom.Items.Add(profileName + ' =&gt; ' + OpenDialog1.FileName);
+  end;
+end;
+
+procedure TSpringSettingsProfileForm.btDeleteClick(Sender: TObject);
+begin
+  if lstCustom.ItemIndex &gt; -1 then
+  begin
+    if BattleForm.SpringSettingsProfile = cpNames[lstCustom.ItemIndex] then
+      BattleForm.SpringSettingsProfile := '';
+    cpNames.Delete(lstCustom.ItemIndex);
+    cpFiles.Delete(lstCustom.ItemIndex);
+    lstCustom.DeleteSelected;
+  end;
+end;
+
+procedure TSpringSettingsProfileForm.btEditClick(Sender: TObject);
+var
+  profileName: string;
+begin
+  if lstCustom.ItemIndex = -1 then Exit;
+  profileName := InputBox('Editing profile','Profile name :',cpNames[lstCustom.ItemIndex]);
+  OpenDialog1.FileName := cpFiles[lstCustom.ItemIndex];
+  if (profileName &lt;&gt; '') and OpenDialog1.Execute then
+  begin
+    if BattleForm.SpringSettingsProfile = cpNames[lstCustom.ItemIndex] then
+      BattleForm.SpringSettingsProfile := profileName;
+    cpNames[lstCustom.ItemIndex] := profileName;
+    cpFiles[lstCustom.ItemIndex] := OpenDialog1.FileName;
+    lstCustom.Items[lstCustom.ItemIndex] := profileName + ' =&gt; ' + OpenDialog1.FileName;
+  end;
+end;
+
+function TSpringSettingsProfileForm.getSettingsFile(spectator: boolean;custom: boolean; customProfileName: string):string;
+begin
+  if not custom then
+    if spectator then
+      Result := beSpectator.Text
+    else
+      Result := bePlaying.Text
+  else
+    if cpNames.IndexOf(customProfileName) = -1 then
+      raise Exception.Create('Unknown spring settings profile name.')
+    else
+      Result := cpFiles[cpNames.IndexOf(customProfileName)];
+end;
+
+procedure TSpringSettingsProfileForm.SaveProfiles;
+var
+  Ini : TIniFile;
+  i:integer;
+  FileName:String;
+begin
+  try
+    FileName := ExtractFilePath(Application.ExeName) + SPRING_SETTINGS_PROFILE_FILE;
+    if FileExists(FileName) then
+      DeleteFile(FileName);
+    Ini := TIniFile.Create(FileName);
+    Ini.WriteString('Default','Playing',bePlaying.Text);
+    Ini.WriteString('Default','Spectator',beSpectator.Text);
+
+    for i:=0 to cpNames.Count-1 do
+      Ini.WriteString(cpNames[i],'File',cpFiles[i]);
+
+    Ini.Free;
+  except
+    Exit;
+  end;
+end;
+procedure TSpringSettingsProfileForm.LoadProfiles;
+var
+  Ini : TIniFile;
+  i:integer;
+  FileName: String;
+begin
+  FileName := ExtractFilePath(Application.ExeName) + SPRING_SETTINGS_PROFILE_FILE;
+  if not FileExists(FileName) then Exit;
+  Ini := TIniFile.Create(FileName);
+  bePlaying.Text := Ini.ReadString('Default','Playing','');
+  beSpectator.Text := Ini.ReadString('Default','Spectator','');
+
+  cpNames.Clear;
+  cpFiles.Clear;
+  lstCustom.Clear;
+  
+  Ini.ReadSections(cpNames);
+  cpNames.Delete(cpNames.IndexOf('Default'));
+  for i:=0 to cpNames.Count-1 do
+  begin
+    cpFiles.Add(Ini.ReadString(cpNames[i],'File',''));
+    lstCustom.Items.Add(cpNames[i] + ' =&gt; ' + cpFiles[i]);
+  end;
+
+  if cpNames.IndexOf(BattleForm.SpringSettingsProfile) = -1 then
+    BattleForm.SpringSettingsProfile := '';
+end;
+
+
+
+procedure TSpringSettingsProfileForm.FormClose(Sender: TObject;
+  var Action: TCloseAction);
+begin
+  SaveProfiles;
+end;
+
+procedure TSpringSettingsProfileForm.btCloseClick(Sender: TObject);
+begin
+  Close;
+end;
+
+end.

Modified: Lobby/TASClient/TASClient.dof
===================================================================
--- Lobby/TASClient/TASClient.dof	2009-01-22 02:29:22 UTC (rev 7227)
+++ Lobby/TASClient/TASClient.dof	2009-01-25 20:19:00 UTC (rev 7228)
@@ -115,7 +115,7 @@
 MajorVer=0
 MinorVer=3
 Release=0
-Build=542
+Build=562
 Debug=0
 PreRelease=0
 Special=0
@@ -126,7 +126,7 @@
 [Version Info Keys]
 CompanyName=
 FileDescription=TA Spring lobby client
-FileVersion=0.3.0.542
+FileVersion=0.3.0.562
 InternalName=
 LegalCopyright=
 LegalTrademarks=

Modified: Lobby/TASClient/TASClient.dpr
===================================================================
--- Lobby/TASClient/TASClient.dpr	2009-01-22 02:29:22 UTC (rev 7227)
+++ Lobby/TASClient/TASClient.dpr	2009-01-25 20:19:00 UTC (rev 7228)
@@ -117,7 +117,8 @@
   TipsFormUnit in 'TipsFormUnit.pas' {TipsForm},
   CustomizeGUIFormUnit in 'CustomizeGUIFormUnit.pas' {CustomizeGUIForm},
   SetValuesFormUnit in 'SetValuesFormUnit.pas' {SetValuesForm},
-  TemplateEditorFormUnit in 'TemplateEditorFormUnit.pas' {TemplateEditorForm};
+  TemplateEditorFormUnit in 'TemplateEditorFormUnit.pas' {TemplateEditorForm},
+  SpringSettingsProfileFormUnit in 'SpringSettingsProfileFormUnit.pas' {SpringSettingsProfileForm};
 
 var
   i: Integer;
@@ -233,6 +234,7 @@
   Application.CreateForm(TCustomizeGUIForm, CustomizeGUIForm);
   Application.CreateForm(TSetValuesForm, SetValuesForm);
   Application.CreateForm(TTemplateEditorForm, TemplateEditorForm);
+  Application.CreateForm(TSpringSettingsProfileForm, SpringSettingsProfileForm);
   //Application.CreateForm(TSpringDownloaderForm, SpringDownloaderForm);
   if not MainUnit.RunningUnderWine then
     Application.CreateForm(TMenuForm, MenuForm);

Modified: Lobby/TASClient/TASClient.res
===================================================================
(Binary files differ)

Modified: Lobby/TASClient/TemplateEditorFormUnit.dfm
===================================================================
--- Lobby/TASClient/TemplateEditorFormUnit.dfm	2009-01-22 02:29:22 UTC (rev 7227)
+++ Lobby/TASClient/TemplateEditorFormUnit.dfm	2009-01-25 20:19:00 UTC (rev 7228)
@@ -11,6 +11,7 @@
   Font.Name = 'MS Sans Serif'
   Font.Style = []
   OldCreateOrder = False
+  Position = poMainFormCenter
   PixelsPerInch = 96
   TextHeight = 13
   object GroupBox1: TGroupBox

Modified: Lobby/TASClient/TipsFormUnit.dfm
===================================================================
--- Lobby/TASClient/TipsFormUnit.dfm	2009-01-22 02:29:22 UTC (rev 7227)
+++ Lobby/TASClient/TipsFormUnit.dfm	2009-01-25 20:19:00 UTC (rev 7228)
@@ -15,7 +15,7 @@
   Font.Style = []
   FormStyle = fsStayOnTop
   OldCreateOrder = False
-  Position = poScreenCenter
+  Position = poMainFormCenter
   Scaled = False
   OnCreate = FormCreate
   PixelsPerInch = 96

Modified: Lobby/TASClient/TipsFormUnit.pas
===================================================================
--- Lobby/TASClient/TipsFormUnit.pas	2009-01-22 02:29:22 UTC (rev 7227)
+++ Lobby/TASClient/TipsFormUnit.pas	2009-01-25 20:19:00 UTC (rev 7228)
@@ -57,7 +57,7 @@
   tipAdded: boolean;
 begin
   try
-    rawTips := ReadFile2(VAR_FOLDER+'\tips.txt');
+    rawTips := ReadFile2(TIPS_FILE);
   except
     MessageDlg(VAR_FOLDER+'\tips.txt not found.',mtError,[mbOK],0);
     Exit;

Modified: Lobby/TASClient/Utility.pas
===================================================================
--- Lobby/TASClient/Utility.pas	2009-01-22 02:29:22 UTC (rev 7227)
+++ Lobby/TASClient/Utility.pas	2009-01-25 20:19:00 UTC (rev 7228)
@@ -338,15 +338,17 @@
   time := GetTickCount;
   MapCount := GetMapCount;
 
-  if MapCount = 0 then
+  {*if MapCount = 0 then
   begin
     MessageDlg('No maps found!', mtError, [mbOK], 0);
-    //Application.Terminate;
+    Application.Terminate;
     Exit;
-  end;
+  end;*}
 
   for i := 0 to MapCount-1 do
   begin
+     Forms.Application.ProcessMessages;
+     
      MapName := GetMapName(i);
 
      // filter out maps with duplicate names:
@@ -531,15 +533,27 @@
   res := FindFilesVFS(res, PChar(s), 255);
   if res &lt;&gt; 0 then
   begin
-    if RightStr(LowerCase(Trim(s)),4) = '.pcx' then
-      res := FindFilesVFS(res, PChar(s), 255);
+    Delete(s,Pos(#0,s),5000);
+    while res &lt;&gt; 0 do
+    begin
+      if RightStr(LowerCase(Trim(s)),4) = '.pcx' then // pcx are only used in the old otacontent so if a more recent file is available it will be png or something else
+      begin
+        res := FindFilesVFS(res, PChar(s), 255);
+        Delete(s,Pos(#0,s),5000);
+      end
+      else
+        break;
+    end;
 
+
     res := OpenFileVFS(PChar(s));
     size := FileSizeVFS(res);
     SetLength(picture, size);
     ReadFileVFS(res, PChar(picture), size);
     CloseFileVFS(res);
 
+    Delete(s,Pos(#0,s),5000);
+
     if RightStr(LowerCase(Trim(s)),4) = '.dds' then
       imgType := IL_DDS
     else if RightStr(LowerCase(Trim(s)),4) = '.png' then
@@ -743,6 +757,24 @@
     end;
   end;
 
+  // default section
+  New(o);
+  o^ := TLuaOptionSection.Create;
+  o^.Key := '__defaultSection__';
+  o^.Name := 'Main Options';
+  o^.Description := '';
+  o^.Section := '';
+  o^.hasChanged := False;
+  if modOptions then
+  begin
+    BattleForm.ModOptionsList.Add(o^);
+  end
+  else
+  begin
+    BattleForm.MapOptionsList.Add(o^);
+  end;
+
+
   for i:=0 to nb-1 do
   begin
     if modOptions then
@@ -886,6 +918,7 @@
     o^.Name := StrNew(GetOptionName(i));
     o^.Description := StrNew(GetOptionDesc(i));
     o^.Section := StrNew(GetOptionSection(i));
+    o^.hasChanged := False;
     if modOptions then
     begin
       o^.KeyPrefix := 'GAME/MODOPTIONS/';
@@ -984,6 +1017,7 @@
   i: integer;
   fs: TFileStream;
   outputFileName : string;
+  vfsFileName: string;
 begin
   // make the subdirs list
   subDirs := TStringList.Create;
@@ -992,7 +1026,9 @@
   res := FindFilesVFS(res, PChar(s), 255);
   while res &lt;&gt; 0 do
   begin
-    subDirs.Add(Trim(s));
+    Delete(s,Pos(#0,s),255);
+    subDirs.Add(s);
+    SetLength(s, 255);
     res := FindFilesVFS(res, PChar(s), 255);
   end;
 
@@ -1020,15 +1056,23 @@
         size := FileSizeVFS(fileHwd);
         SetLength(fileContent,size);
         ReadFileVFS(fileHwd,PChar(fileContent),size);
-        outputFileName := ExtractTo+'\'+ExtractFileName(StringReplace(Trim(s),'/','\',[rfReplaceAll]));
-        if FileExists(outputFileName) then
-          DeleteFile(outputFileName);
-        fs := TFileStream.Create(outputFileName,fmOpenWrite or fmCreate );
-        fs.WriteBuffer(fileContent[1],size);
-        fs.Free;
-        CloseFileVFS(fileHwd);
+        Delete(s,Pos(#0,s),255);
+        vfsFileName := ExtractFileName(StringReplace(s,'/','\',[rfReplaceAll]));
+        if vfsFileName &lt;&gt; '' then
+        begin
+          outputFileName := ExtractTo+'\'+vfsFileName;
+          if FileExists(outputFileName) then
+            DeleteFile(outputFileName);
+          fs := TFileStream.Create(outputFileName,fmOpenWrite or fmCreate );
+          fs.WriteBuffer(fileContent[1],size);
+          fs.Free;
+          CloseFileVFS(fileHwd);
+        end
+        else
+          MainForm.AddMainLog('Error: Empty VFS file name : '+s,Colors.Error);
       end;
       // get next filename
+      SetLength(s, 255);
       res := FindFilesVFS(res, PChar(s), 255);
     end;
 
@@ -1038,15 +1082,23 @@
 end;
 function getMetalMap(mapName: string; var width: integer; var height: integer): TMapData;
 begin
-  GetInfoMapSize(PChar(mapName),'metal',width,height);
-  SetLength(Result,width*height);
-  GetInfoMap(PChar(mapName),'metal'<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">, at Result</A>[1],1);
+  width := 0;
+  height := 0;
+  if GetInfoMapSize(PChar(mapName),'metal',width,height) = 1 then
+  begin
+    SetLength(Result,width*height);
+    GetInfoMap(PChar(mapName),'metal'<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">, at Result</A>[1],1);
+  end;
 end;
 function getHeightMap(mapName: string; var width: integer; var height: integer): TMapData;
 begin
-  GetInfoMapSize(PChar(mapName),'height',width,height);
-  SetLength(Result,width*height);
-  GetInfoMap(PChar(mapName),'height'<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">, at Result</A>[1],1);
+  width := 0;
+  height := 0;
+  if GetInfoMapSize(PChar(mapName),'height',width,height) = 1 then
+  begin
+    SetLength(Result,width*height);
+    GetInfoMap(PChar(mapName),'height'<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">, at Result</A>[1],1);
+  end;
 end;
 
 

Modified: Lobby/TASClient/administrator.RES
===================================================================
--- Lobby/TASClient/administrator.RES	2009-01-22 02:29:22 UTC (rev 7227)
+++ Lobby/TASClient/administrator.RES	2009-01-25 20:19:00 UTC (rev 7228)
@@ -1,17 +1,5 @@
-        &#255;&#255;  &#255;&#255;                  O      &#255;&#255; &#255;&#255;     0         &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;?&gt;
+        &#255;&#255;  &#255;&#255;                  7      &#255;&#255; &#255;&#255;     0         &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;?&gt;
 &lt;assembly xmlns=&quot;urn:schemas-microsoft-com:asm.v1&quot; manifestVersion=&quot;1.0&quot;&gt;
-        &lt;dependency&gt;
-                &lt;dependentAssembly&gt;
-                        &lt;assemblyIdentity
-                                type=&quot;win32&quot;
-                                name=&quot;Microsoft.Windows.Common-Controls&quot;
-                                version=&quot;6.0.0.0&quot;
-                                processorArchitecture=&quot;X86&quot;
-                                publicKeyToken=&quot;6595b64144ccf1df&quot;
-                                language=&quot;*&quot;
-                        /&gt;
-                &lt;/dependentAssembly&gt;
-        &lt;/dependency&gt;
         &lt;trustInfo xmlns=&quot;urn:schemas-microsoft-com:asm.v2&quot;&gt;
                 &lt;security&gt;
                         &lt;requestedPrivileges&gt;

Added: Lobby/TASClient/administrator.manifest
===================================================================
--- Lobby/TASClient/administrator.manifest	                        (rev 0)
+++ Lobby/TASClient/administrator.manifest	2009-01-25 20:19:00 UTC (rev 7228)
@@ -0,0 +1,12 @@
+&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;?&gt;
+&lt;assembly xmlns=&quot;urn:schemas-microsoft-com:asm.v1&quot; manifestVersion=&quot;1.0&quot;&gt;
+        &lt;trustInfo xmlns=&quot;urn:schemas-microsoft-com:asm.v2&quot;&gt;
+                &lt;security&gt;
+                        &lt;requestedPrivileges&gt;
+                                &lt;requestedExecutionLevel
+                                       level=&quot;requireAdministrator&quot;
+                                       uiAccess=&quot;false&quot;/&gt;
+                        &lt;/requestedPrivileges&gt;
+                &lt;/security&gt;
+        &lt;/trustInfo&gt;
+&lt;/assembly&gt;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001996.html">[Taspring-linux-commit] r7227 - Lobby/springie/Springie/spring
</A></li>
	<LI>Next message: <A HREF="001998.html">[Taspring-linux-commit] r7229 - Lobby/TASClient
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1997">[ date ]</a>
              <a href="thread.html#1997">[ thread ]</a>
              <a href="subject.html#1997">[ subject ]</a>
              <a href="author.html#1997">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
