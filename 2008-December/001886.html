<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r7117 - in Lobby/springie: ModInfoBuilder	Springie Springie/PlanetWars Springie/autohost	Springie/client Springie/spring Springie/utils libs
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-December/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r7117%20-%20in%20Lobby/springie%3A%20ModInfoBuilder%0A%09Springie%20Springie/PlanetWars%20Springie/autohost%0A%09Springie/client%20Springie/spring%20Springie/utils%20libs&In-Reply-To=%3C20081204163126.91F32477A%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001885.html">
   <LINK REL="Next"  HREF="001887.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r7117 - in Lobby/springie: ModInfoBuilder	Springie Springie/PlanetWars Springie/autohost	Springie/client Springie/spring Springie/utils libs</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r7117%20-%20in%20Lobby/springie%3A%20ModInfoBuilder%0A%09Springie%20Springie/PlanetWars%20Springie/autohost%0A%09Springie/client%20Springie/spring%20Springie/utils%20libs&In-Reply-To=%3C20081204163126.91F32477A%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r7117 - in Lobby/springie: ModInfoBuilder	Springie Springie/PlanetWars Springie/autohost	Springie/client Springie/spring Springie/utils libs">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Thu Dec  4 17:31:26 CET 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001885.html">[Taspring-linux-commit] r7116 - in Lobby/TASClient: . Interface
</A></li>
        <LI>Next message: <A HREF="001887.html">[Taspring-linux-commit] r7118 - Lobby/TASClient
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1886">[ date ]</a>
              <a href="thread.html#1886">[ thread ]</a>
              <a href="subject.html#1886">[ subject ]</a>
              <a href="author.html#1886">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: Licho
Date: 2008-12-04 17:31:25 +0100 (Thu, 04 Dec 2008)
New Revision: 7117

Added:
   Lobby/springie/Springie/PlanetWars/
   Lobby/springie/Springie/PlanetWars/PlanetWarsHandler.cs
Removed:
   Lobby/springie/Springie/utils/FileDownloader.cs
Modified:
   Lobby/springie/ModInfoBuilder/ModInfoBuilder.csproj
   Lobby/springie/Springie/Main.cs
   Lobby/springie/Springie/MainConfig.cs
   Lobby/springie/Springie/Springie.csproj
   Lobby/springie/Springie/autohost/AutoHost.cs
   Lobby/springie/Springie/autohost/AutoHost_commands.cs
   Lobby/springie/Springie/autohost/Polls.cs
   Lobby/springie/Springie/client/TasClient.cs
   Lobby/springie/Springie/spring/Spring.cs
   Lobby/springie/Springie/utils/Stats.cs
   Lobby/springie/libs/PlanetWarsShared.dll
Log:
isolated and refactored planetwars stuff to single class

Modified: Lobby/springie/ModInfoBuilder/ModInfoBuilder.csproj
===================================================================
--- Lobby/springie/ModInfoBuilder/ModInfoBuilder.csproj	2008-12-04 13:11:49 UTC (rev 7116)
+++ Lobby/springie/ModInfoBuilder/ModInfoBuilder.csproj	2008-12-04 16:31:25 UTC (rev 7117)
@@ -35,9 +35,6 @@
   &lt;/PropertyGroup&gt;
   &lt;ItemGroup&gt;
     &lt;Reference Include=&quot;System&quot; /&gt;
-    &lt;Reference Include=&quot;System.Xml.Linq&quot;&gt;
-      &lt;RequiredTargetFramework&gt;3.5&lt;/RequiredTargetFramework&gt;
-    &lt;/Reference&gt;
     &lt;Reference Include=&quot;System.Data.DataSetExtensions&quot;&gt;
       &lt;RequiredTargetFramework&gt;3.5&lt;/RequiredTargetFramework&gt;
     &lt;/Reference&gt;

Modified: Lobby/springie/Springie/Main.cs
===================================================================
--- Lobby/springie/Springie/Main.cs	2008-12-04 13:11:49 UTC (rev 7116)
+++ Lobby/springie/Springie/Main.cs	2008-12-04 16:31:25 UTC (rev 7117)
@@ -12,6 +12,7 @@
 using PlanetWarsShared.Springie;
 using Springie.autohost;
 using Springie.Client;
+using Springie.PlanetWars;
 using Springie.SpringNamespace;
 
     #endregion
@@ -32,8 +33,6 @@
 
         private AutoHost autoHost;
         private AutoUpdater autoUpdater;
-        private List&lt;string&gt; planetWarsChannels = new List&lt;string&gt;();
-        private Dictionary&lt;string, string&gt; planetWarsPlayerSide = new Dictionary&lt;string, string&gt;();
         private Timer recon;
         private Spring spring;
 
@@ -51,12 +50,8 @@
         }
 
         public MainConfig config;
-        public ISpringieServer PlanetWars;
 
-        public AuthInfo PlanetwarsAccount
-        {
-            get { return new AuthInfo(config.AccountName, config.PlanetWarsServerPassword); }
-        }
+        public PlanetWarsHandler PlanetWars;
 
         public Spring Spring
         {
@@ -89,23 +84,8 @@
 
         public void InitializePlanetWarsServer()
         {
-            PlanetWars = (ISpringieServer) Activator.GetObject(typeof (ISpringieServer), String.Format(&quot;<A HREF="tcp://{0">tcp://{0</A>}:1666/IServer&quot;, config.PlanetWarsServer));
-
-            planetWarsPlayerSide = new Dictionary&lt;string, string&gt;();
-
-            // fill factions for channel monitoring and join channels
-            planetWarsChannels = new List&lt;string&gt;();
-            var factions = PlanetWars.GetFactions();
-            foreach (var fact in factions) {
-                string name = fact.Name.ToLower();
-                planetWarsChannels.Add(name);
-                if (!Program.main.config.JoinChannels.Contains(name)) {
-                    var list = new List&lt;string&gt;(Program.main.config.JoinChannels);
-                    list.Add(name);
-                    Program.main.config.JoinChannels = list.ToArray();
-                    if (tas != null &amp;&amp; tas.IsConnected &amp;&amp; tas.IsLoggedIn) tas.JoinChannel(name);
-                }
-            }
+            if (config.PlanetWarsEnabled) PlanetWars = new PlanetWarsHandler(config.PlanetWarsServer, 1666, autoHost, tas, config);
+            else PlanetWars = null;
         }
 
         public void LoadConfig()
@@ -209,36 +189,7 @@
 
         private void tas_ChannelUserAdded(object sender, TasEventArgs e)
         {
-            if (config.PlanetWarsEnabled &amp;&amp; PlanetWars != null) {
-                string channel = e.ServerParams[0];
-                string name = e.ServerParams[1];
-
-                if (planetWarsChannels.Contains(channel) &amp;&amp; name != &quot;ChanServ&quot; &amp;&amp; name != tas.UserName) {
-                    bool? isOk = null;
-                    string side;
-                    if (planetWarsPlayerSide.TryGetValue(name, out side)) {
-                        // first check cached value
-                        isOk = side == channel;
-                    }
-                    if (!isOk.HasValue) {
-                        IPlayer usinfo = null;
-                        try {
-                            usinfo = PlanetWars.GetPlayerInfo(name);
-                        } catch (Exception ex) {
-                            autoHost.SayBattle(&quot;Error fetching user info:&quot; + ex);
-                        }
-                        if (usinfo == null) isOk = false;
-                        else {
-                            string realFact = usinfo.FactionName.ToLower();
-                            planetWarsPlayerSide[name] = realFact;
-                            isOk = realFact == channel;
-                        }
-                    }
-
-                    // he is not from this faction, mute him
-                    if (!isOk.Value) tas.Say(TasClient.SayPlace.User, &quot;ChanServ&quot;, string.Format(&quot;!kick #{0} {1} This is PlanetWars faction channel (<A HREF="http://planet-wars.eu">http://planet-wars.eu</A>) Register using !register command.&quot;, channel, name), false);
-                }
-            }
+            if (PlanetWars != null) PlanetWars.UserJoinedChannel(e.ServerParams[0], e.ServerParams[1]);
         }
 
 
@@ -276,20 +227,11 @@
 
         private void tas_Said(object sender, TasSayEventArgs e)
         {
-            if (config.PlanetWarsEnabled &amp;&amp; PlanetWars != null) {
-                if (e.Origin == TasSayEventArgs.Origins.Player &amp;&amp; e.Place == TasSayEventArgs.Places.Channel &amp;&amp; planetWarsChannels.Contains(e.Channel)) {
-                    //  lets log this
-                    try {
-                        PlanetWars.SendChatLine(PlanetwarsAccount, e.Channel, e.UserName, e.Text);
-                    } catch (Exception ex) {
-                        autoHost.SayBattle(&quot;Error sending chat:&quot; + ex);
-                    }
-                }
-            }
+            if (PlanetWars != null) PlanetWars.UserSaid(e);
 
             if (config.RedirectGameChat &amp;&amp; e.Place == TasSayEventArgs.Places.Battle &amp;&amp; e.Origin == TasSayEventArgs.Origins.Player &amp;&amp; e.UserName != tas.UserName &amp;&amp; e.IsEmote == false) spring.SayGame(&quot;[&quot; + e.UserName + &quot;]&quot; + e.Text);
         }
 
         #endregion
     }
-}
\ No newline at end of file
+}

Modified: Lobby/springie/Springie/MainConfig.cs
===================================================================
--- Lobby/springie/Springie/MainConfig.cs	2008-12-04 13:11:49 UTC (rev 7116)
+++ Lobby/springie/Springie/MainConfig.cs	2008-12-04 16:31:25 UTC (rev 7117)
@@ -152,6 +152,7 @@
 		[Category(&quot;PlanetWars&quot;)]
 		public string PlanetWarsServerPassword { get; set; }
 
+
 		[Category(&quot;Spring&quot;)]
 		[Description(&quot;Should springie redirect global game chat to lobby?&quot;)]
 		public bool RedirectGameChat

Added: Lobby/springie/Springie/PlanetWars/PlanetWarsHandler.cs
===================================================================
--- Lobby/springie/Springie/PlanetWars/PlanetWarsHandler.cs	                        (rev 0)
+++ Lobby/springie/Springie/PlanetWars/PlanetWarsHandler.cs	2008-12-04 16:31:25 UTC (rev 7117)
@@ -0,0 +1,392 @@
+&#65279;#region using
+
+using System;
+using System.Collections.Generic;
+using System.Linq;
+using PlanetWarsShared;
+using PlanetWarsShared.Springie;
+using Springie.autohost;
+using Springie.Client;
+
+#endregion
+
+namespace Springie.PlanetWars
+{
+    public class PlanetWarsHandler
+    {
+        #region Fields
+
+        private AutoHost autoHost;
+        private List&lt;string&gt; planetWarsAutohosts = new List&lt;string&gt;();
+        private List&lt;string&gt; planetWarsChannels = new List&lt;string&gt;();
+        private Dictionary&lt;string, string&gt; planetWarsPlayerSide = new Dictionary&lt;string, string&gt;();
+
+
+        private TasClient tas;
+
+        #endregion
+
+        #region Properties
+
+        public AuthInfo account;
+        public ISpringieServer server;
+
+        #endregion
+
+        #region Constructors
+
+        public PlanetWarsHandler(string host, int port, AutoHost autoHost, TasClient tas, MainConfig config)
+        {
+            this.autoHost = autoHost;
+            this.tas = tas;
+            account = new AuthInfo(config.AccountName, config.PlanetWarsServerPassword);
+
+            server = (ISpringieServer) Activator.GetObject(typeof (ISpringieServer), String.Format(&quot;<A HREF="tcp://{0">tcp://{0</A>}:{1}/IServer&quot;, host, port));
+            // fill factions for channel monitoring and join channels
+            planetWarsChannels = new List&lt;string&gt;();
+            var factions = server.GetFactions(account);
+            foreach (var fact in factions) {
+                string name = fact.Name.ToLower();
+                planetWarsChannels.Add(name);
+                if (!config.JoinChannels.Contains(name)) {
+                    var list = new List&lt;string&gt;(config.JoinChannels);
+                    list.Add(name);
+                    config.JoinChannels = list.ToArray();
+                    if (tas != null &amp;&amp; tas.IsConnected &amp;&amp; tas.IsLoggedIn) tas.JoinChannel(name);
+                }
+            }
+        }
+
+        #endregion
+
+        #region Public methods
+
+        public void ComListPlanets(TasSayEventArgs e, string[] words)
+        {
+            string[] vals;
+            int[] indexes;
+            if (!Program.main.config.PlanetWarsEnabled) {
+                autoHost.Respond(e, &quot;This is not PlanetWars host&quot;);
+                return;
+            }
+            try {
+                if (Program.main.PlanetWars.FilterPlanets(words, out vals, out indexes) &gt; 0) {
+                    autoHost.Respond(e, &quot;Planets available for attack are:&quot;);
+                    for (int i = 0; i &lt; vals.Length; ++i) autoHost.Respond(e, string.Format(&quot;{0}: {1}&quot;, indexes[i], vals[i]));
+                } else autoHost.Respond(e, &quot;no such planet found&quot;);
+            } catch (Exception ex) {
+                autoHost.Respond(e, string.Format(&quot;Error getting planets: {0}&quot;, ex));
+            }
+        }
+
+        public void ComPlanet(TasSayEventArgs e, string[] words)
+        {
+            if (!Program.main.config.PlanetWarsEnabled) {
+                autoHost.Respond(e, &quot;This is not a PlanetWars host&quot;);
+                return;
+            }
+
+            if (words.Length == 0) {
+                autoHost.Respond(e, &quot;You must specify planet name&quot;);
+                return;
+            }
+            string[] vals;
+            int[] indexes;
+            if (FilterPlanets(words, out vals, out indexes) &gt; 0) {
+                var info = server.GetPlayerInfo(account, e.UserName);
+                var fact = server.GetOffensiveFaction(account);
+                bool canset = false;
+                string bestPlayer = &quot;&quot;;
+                if (info != null) {
+                    if (info.IsCommanderInChief) canset = true;
+                    else {
+                        canset = true;
+                        int bestRank = info.RankOrder;
+                        foreach (var u in tas.GetBattle().Users) {
+                            if (!u.IsSpectator &amp;&amp; u.name != e.UserName &amp;&amp; tas.GetBattle().Mod.Sides[u.Side].ToLower() == info.FactionName.ToLower()) {
+                                var pi = server.GetPlayerInfo(account, u.name);
+                                if (pi != null &amp;&amp; pi.RankOrder &lt; bestRank) {
+                                    // someone sle with better rank exists
+                                    bestPlayer = pi.Name;
+                                    bestRank = pi.RankOrder;
+                                    canset = false;
+                                }
+                            }
+                        }
+                    }
+                }
+
+                if (canset) {
+                    if (info.FactionName == fact.Name) {
+                        autoHost.SayBattle(string.Format(&quot;changing planet to {0} by {1}&quot;, vals[0], e.UserName));
+                        var planet = server.GetAttackOptions(account).Where(m =&gt; m.Name == vals[0]).Single();
+                        tas.ChangeMap(Program.main.Spring.UnitSyncWrapper.MapList[planet.MapName]);
+                    } else autoHost.Respond(e, string.Format(&quot;It's currently {0} turn&quot;, fact.Name));
+                } else autoHost.Respond(e, string.Format(&quot;You are not first in command here, {0} must do it!&quot;, bestPlayer));
+            } else autoHost.Respond(e, &quot;Cannot find such planet.&quot;);
+        }
+
+        public void ComRegister(TasSayEventArgs e, string[] words)
+        {
+            if (!Program.main.config.PlanetWarsEnabled) {
+                autoHost.Respond(e, &quot;This is not PlanetWars host&quot;);
+                return;
+            }
+            if (words.Length &lt; 2) {
+                autoHost.Respond(e, &quot;This command needs 2-3 parameters - side and password and optional planet name (you can PM it to me). Eg. !register core secretpw&quot;);
+                return;
+            }
+
+            try {
+                string response = server.Register(account, new AuthInfo {Login = e.UserName, Password = words[1]}, words[0], words.Length &gt; 2 ? Utils.Glue(words, 2) : null);
+                autoHost.Respond(e, string.Format(response));
+            } catch (Exception ex) {
+                autoHost.Respond(e, string.Format(&quot;Error when registering: {0}&quot;, ex));
+            }
+        }
+
+        public void ComResetPassword(TasSayEventArgs e)
+        {
+            try {
+                autoHost.Respond(e, server.ResetPassword(account, e.UserName));
+            } catch (Exception ex) {
+                autoHost.SayBattle(&quot;Error reseting password: &quot; + ex);
+            }
+        }
+
+        public int FilterPlanets(string[] words, out string[] vals, out int[] indexes)
+        {
+            var options = server.GetAttackOptions(Program.main.PlanetWars.account);
+
+            if (options != null) {
+                var temp = new string[options.Count];
+                int cnt = 0;
+
+                foreach (var planet in options) temp[cnt++] = planet.Name;
+                return AutoHost.Filter(temp, words, out vals, out indexes);
+            } else {
+                vals = null;
+                indexes = null;
+                return 0;
+            }
+        }
+
+        public void MapChanged()
+        {
+            try {
+                string name = tas.GetBattle().Map.Name;
+                var mapInfo = server.GetAttackOptions(account).Where(m =&gt; m.MapName == name).Single();
+                if (mapInfo.StartBoxes != null &amp;&amp; mapInfo.StartBoxes.Count &gt; 0) {
+                    int rectangles = tas.GetBattle().Rectangles.Count;
+                    for (int i = 0; i &lt; rectangles; ++i) tas.RemoveBattleRectangle(i);
+                    for (int i = 0; i &lt; mapInfo.StartBoxes.Count; ++i) {
+                        var mi = mapInfo.StartBoxes[i];
+                        tas.AddBattleRectangle(i, new BattleRect(mi.Left, mi.Top, mi.Right, mi.Bottom));
+                    }
+                }
+
+                foreach (var command in mapInfo.AutohostCommands) tas.Say(TasClient.SayPlace.Channel, tas.UserName, command, false);
+
+                autoHost.SayBattle(String.Format(&quot;Welcome to {0}!  (<A HREF="http://planet-wars.eu/planet.aspx?name={1">http://planet-wars.eu/planet.aspx?name={1</A>})&quot;, mapInfo.Name, Uri.EscapeUriString(mapInfo.Name)));
+
+                var notifyList = server.GetPlayersToNotify(account, name, ReminderEvent.OnBattlePreparing);
+                foreach (var userName in notifyList) tas.Say(TasClient.SayPlace.User, userName, string.Format(&quot;Planet {0} is under attack! Join the fight!&quot;, mapInfo.Name), false);
+            } catch (Exception ex) {
+                autoHost.SayBattle(string.Format(&quot;Error setting planet starting boxes: {0}&quot;, ex));
+            }
+        }
+
+        public void SendBattleResult(Battle battle, Dictionary&lt;string, EndGamePlayerInfo&gt; players)
+        {
+            try {
+                var response = server.SendBattleResult(account, battle.Map.Name, players.Values);
+
+
+                autoHost.SayBattle(response.MessageToDisplay);
+                var users = tas.GetBattle().Users;
+                foreach (var p in players.Values) if (p.Name != tas.UserName &amp;&amp; users.Find(x =&gt; x.name == p.Name) == null) tas.Say(TasClient.SayPlace.User, p.Name, response.MessageToDisplay, false);
+
+                foreach (var kvp in response.RankNotifications) tas.Say(TasClient.SayPlace.User, kvp.Name, kvp.Text, false);
+
+                var toNotify = server.GetPlayersToNotify(account, battle.Map.Name, ReminderEvent.OnBattleEnded);
+                foreach (var s in toNotify) tas.Say(TasClient.SayPlace.User, s, &quot;PlanetWars battle has just ended.&quot;, false);
+                ComListPlanets(TasSayEventArgs.Default, new string[] {});
+            } catch (Exception ex) {
+                autoHost.SayBattle(string.Format(&quot;Error sending planet battle result :(( {0}&quot;, ex), true);
+            }
+        }
+
+        public void SpringMessage(string text)
+        {
+            // awards
+            const string awardPrefix = &quot;pwaward:&quot;;
+            if (text.StartsWith(awardPrefix)) {
+                string substr = text.Substring(awardPrefix.Length);
+                if (!string.IsNullOrEmpty(substr)) {
+                    try {
+                        var parts = substr.Split(new[] {' '}, 3);
+                        string name = parts[0];
+                        string awardType = parts[1];
+                        string awardText = parts[2];
+                        autoHost.SayBattle(string.Format(&quot;Award for {0} - {1}&quot;, name, awardText));
+                        server.AddAward(account, name, awardType, awardText, Program.main.Tas.GetBattle().Map.Name);
+                        return;
+                    } catch (Exception ex) {
+                        Program.main.AutoHost.SayBattle(&quot;Error sending data:&quot; + ex);
+                    }
+                }
+            }
+
+
+            // deployment
+            const string pwPrefix = &quot;pwdeploy:&quot;;
+            if (text.StartsWith(pwPrefix)) {
+                string substr = text.Substring(pwPrefix.Length);
+                var parts = substr.Split(new[] {','});
+                if (!string.IsNullOrEmpty(substr)) {
+                    try {
+                        server.UnitDeployed(account, tas.GetBattle().Map.Name, parts[0], parts[1], (int) double.Parse(parts[2]), (int) double.Parse(parts[3]), parts[4]);
+                        return;
+                    } catch (Exception ex) {
+                        Program.main.AutoHost.SayBattle(&quot;Error sending data:&quot; + ex);
+                    }
+                }
+            }
+        }
+
+        public bool StartGame(TasSayEventArgs e)
+        {
+            try {
+                string currentMapName = tas.GetBattle().Map.Name;
+                var planet = server.GetAttackOptions(account).Where(p =&gt; p.MapName == currentMapName).SingleOrDefault();
+
+                if (planet == null) {
+                    autoHost.SayBattle(&quot;This planet is not currently allowed, select another one&quot;);
+                    return false;
+                }
+
+                var factions = server.GetFactions(account);
+
+                var actual = new List&lt;IPlayer&gt;();
+                foreach (var user in tas.GetBattle().Users) {
+                    if (!user.IsSpectator) {
+                        var info = server.GetPlayerInfo(account, user.name);
+                        actual.Add(info);
+                        string side = tas.GetBattle().Mod.Sides[user.Side];
+                        string hisSide = factions.Where(f =&gt; f.Name == info.FactionName).Single().SpringSide;
+
+                        if (!string.Equals(side, hisSide, StringComparison.InvariantCultureIgnoreCase)) {
+                            autoHost.SayBattle(string.Format(&quot;{0} must switch to {1}&quot;, user.name, hisSide), false);
+                            return false;
+                        }
+                    }
+                }
+
+
+                string options = server.GetStartupModOptions(account, tas.GetBattle().Map.Name, actual);
+                //SayBattle(Encoding.ASCII.GetString(Convert.FromBase64String(options.Replace(&quot;+&quot;, &quot;=&quot;))));
+                var b = tas.GetBattle();
+                foreach (var o in b.Mod.Options) {
+                    if (o.Key == &quot;planetwars&quot;) {
+                        string res;
+                        if (o.GetPair(options, out res)) {
+                            tas.SetScriptTag(res);
+
+                            var startEvent = server.GetPlayersToNotify(account, currentMapName, ReminderEvent.OnBattleStarted);
+                            foreach (var s in startEvent) tas.Say(TasClient.SayPlace.User, s, string.Format(&quot;PlanetWars battle for planet {0} owned by {1} is starting.&quot;, planet.Name, planet.OwnerName), false);
+
+                            return true;
+                        } else {
+                            autoHost.Respond(e, &quot;Eror setting script tag&quot;);
+                            return false;
+                        }
+                    }
+                }
+                autoHost.Respond(e, &quot;This mod does not support PlanetWars&quot;);
+                return false;
+            } catch (Exception ex) {
+                autoHost.SayBattle(string.Format(&quot;Error when checking PlanetWars teams: {0}&quot;, ex), false);
+                return false;
+            }
+        }
+
+        public void UserJoined(string name)
+        {
+            try {
+                var current = server.GetOffensiveFaction(account);
+
+                var info = server.GetPlayerInfo(account, name);
+                if (info != null) autoHost.SayBattle(string.Format(&quot;{0} {1} {2}. Attacking faction is {3}&quot;, info.IsCommanderInChief ? &quot;All hail to&quot; : &quot;Greetings, &quot;, info.RankText, name, current.Name), false);
+            } catch (Exception ex) {
+                autoHost.SayBattle(&quot;PlanetWars error: &quot; + ex);
+            }
+        }
+
+        public void UserJoinedChannel(string channel, string name)
+        {
+            if (planetWarsChannels.Contains(channel) &amp;&amp; name != &quot;ChanServ&quot; &amp;&amp; name != tas.UserName) {
+                bool? isOk = null;
+                string side;
+                if (planetWarsPlayerSide.TryGetValue(name, out side)) {
+                    // first check cached value
+                    isOk = side == channel;
+                }
+                if (!isOk.HasValue) {
+                    IPlayer usinfo = null;
+                    try {
+                        usinfo = server.GetPlayerInfo(account, name);
+                    } catch (Exception ex) {
+                        autoHost.SayBattle(&quot;Error fetching user info:&quot; + ex);
+                    }
+                    if (usinfo == null) isOk = false;
+                    else {
+                        string realFact = usinfo.FactionName.ToLower();
+                        planetWarsPlayerSide[name] = realFact;
+                        isOk = realFact == channel;
+                    }
+                }
+
+                // he is not from this faction, mute him
+                if (!isOk.Value) tas.Say(TasClient.SayPlace.User, &quot;ChanServ&quot;, string.Format(&quot;!kick #{0} {1} This is PlanetWars faction channel (<A HREF="http://planet-wars.eu">http://planet-wars.eu</A>) Register using !register command.&quot;, channel, name), false);
+            }
+        }
+
+        public void UserSaid(TasSayEventArgs e)
+        {
+            if (e.Origin == TasSayEventArgs.Origins.Player &amp;&amp; e.Place == TasSayEventArgs.Places.Channel &amp;&amp; planetWarsChannels.Contains(e.Channel)) {
+                //  lets log this
+                try {
+                    server.SendChatLine(account, e.Channel, e.UserName, e.Text);
+                } catch (Exception ex) {
+                    autoHost.SayBattle(&quot;Error sending chat:&quot; + ex);
+                }
+            }
+        }
+
+        public void UserStatusChanged(UserBattleStatus user)
+        {
+            try {
+                var info = server.GetPlayerInfo(account, user.name);
+                var factions = new List&lt;IFaction&gt;(server.GetFactions(account));
+                if (info == null) {
+                    if (!user.IsSpectator) {
+                        tas.ForceSpectator(user.name);
+                        autoHost.SayBattle(string.Format(&quot;{0} is not registered.Say !register faction newpassword (optional planet) eg. !register core secretpw&quot;, user.name), false);
+                        return;
+                    }
+                } else {
+                    int hisFaction = factions.IndexOf(factions.Find((f) =&gt; f.Name == info.FactionName));
+                    if (user.AllyNumber != hisFaction) {
+                        tas.ForceAlly(user.name, hisFaction);
+                        autoHost.SayBattle(string.Format(&quot;{0} must play in team {1}&quot;, user.name, hisFaction + 1), false);
+                        return;
+                    }
+                }
+            } catch (Exception ex) {
+                autoHost.SayBattle(string.Format(&quot;Warning, PlanetWars problem: {0} &quot;, ex), false);
+            }
+        }
+
+        #endregion
+    }
+}
\ No newline at end of file

Modified: Lobby/springie/Springie/Springie.csproj
===================================================================
--- Lobby/springie/Springie/Springie.csproj	2008-12-04 13:11:49 UTC (rev 7116)
+++ Lobby/springie/Springie/Springie.csproj	2008-12-04 16:31:25 UTC (rev 7117)
@@ -140,6 +140,7 @@
       &lt;DependentUpon&gt;FormCurrentBattle.cs&lt;/DependentUpon&gt;
     &lt;/Compile&gt;
     &lt;Compile Include=&quot;MainConfig.cs&quot; /&gt;
+    &lt;Compile Include=&quot;PlanetWars\PlanetWarsHandler.cs&quot; /&gt;
     &lt;Compile Include=&quot;UnitSync\ListOption.cs&quot; /&gt;
     &lt;Compile Include=&quot;UnitSync\MapInfo.cs&quot; /&gt;
     &lt;Compile Include=&quot;UnitSync\ModInfo.cs&quot; /&gt;
@@ -147,7 +148,6 @@
     &lt;Compile Include=&quot;UnitSync\UnitConverter.cs&quot; /&gt;
     &lt;Compile Include=&quot;UnitSync\UnitInfo.cs&quot; /&gt;
     &lt;Compile Include=&quot;utils\AutoUpdater.cs&quot; /&gt;
-    &lt;Compile Include=&quot;utils\FileDownloader.cs&quot; /&gt;
     &lt;Compile Include=&quot;utils\ResourceLinkProvider.cs&quot; /&gt;
     &lt;Compile Include=&quot;autohost\Polls.cs&quot; /&gt;
     &lt;Compile Include=&quot;ErrorHandling.cs&quot; /&gt;
@@ -234,6 +234,7 @@
   &lt;/ItemGroup&gt;
   &lt;Import Project=&quot;$(MSBuildBinPath)\Microsoft.CSharp.Targets&quot; /&gt;
   &lt;PropertyGroup&gt;
-    &lt;PostBuildEvent&gt;copy $(ProjectDir)doc\readme.txt $(TargetDir)&lt;/PostBuildEvent&gt;
+    &lt;PostBuildEvent&gt;
+    &lt;/PostBuildEvent&gt;
   &lt;/PropertyGroup&gt;
 &lt;/Project&gt;
\ No newline at end of file

Modified: Lobby/springie/Springie/autohost/AutoHost.cs
===================================================================
--- Lobby/springie/Springie/autohost/AutoHost.cs	2008-12-04 13:11:49 UTC (rev 7116)
+++ Lobby/springie/Springie/autohost/AutoHost.cs	2008-12-04 16:31:25 UTC (rev 7117)
@@ -7,1029 +7,939 @@
 using System.Runtime.Serialization.Formatters.Binary;
 using System.Threading;
 using System.Timers;
-using System.Windows.Forms;
 using System.Xml.Serialization;
-using PlanetWarsShared;
-using PlanetWarsShared.Springie;
 using Springie.AutoHostNamespace;
 using Springie.Client;
 using Springie.SpringNamespace;
 using Timer=System.Timers.Timer;
-using System.Linq;
 
 #endregion
 
 namespace Springie.autohost
 {
-	public partial class AutoHost
-	{
-		#region Constants
+    public partial class AutoHost
+    {
+        #region Constants
 
-		public const string BoxesName = &quot;boxes.bin&quot;;
-		public const string ConfigName = &quot;autohost.xml&quot;;
+        public const string BoxesName = &quot;boxes.bin&quot;;
+        public const string ConfigName = &quot;autohost.xml&quot;;
 
-		public const int PollTimeout = 60;
-		public const string PresetsName = &quot;presets.xml&quot;;
+        public const int PollTimeout = 60;
+        public const string PresetsName = &quot;presets.xml&quot;;
 
-		#endregion
+        #endregion
 
-		#region Fields
+        #region Fields
 
-		private IVotable activePoll;
-		private int autoLock;
-		private BanList banList;
-		private string bossName = &quot;&quot;;
-		private string delayedModChange;
+        private IVotable activePoll;
+        private int autoLock;
+        private BanList banList;
+        private string bossName = &quot;&quot;;
+        private string delayedModChange;
 
 
-		private FileDownloader fileDownloader;
+        private bool kickMinRank;
+        private bool kickSpectators;
+        private ResourceLinkProvider linkProvider;
+        private bool lockedByKickSpec;
 
-		private bool kickMinRank;
-		private bool kickSpectators;
-		private ResourceLinkProvider linkProvider;
-		private bool lockedByKickSpec;
+        private AutoManager manager;
+        private int mapCycleIndex;
 
-		private AutoManager manager;
-		private int mapCycleIndex;
 
+        private double minCpuSpeed;
+        private Timer pollTimer;
+        private object savLock = new object();
+        private Spring spring;
+        private TasClient tas;
 
-		private double minCpuSpeed;
-		private Timer pollTimer;
-		private object savLock = new object();
-		private Spring spring;
-		private TasClient tas;
+        #endregion
 
-		#endregion
+        #region Properties
 
-		#region Properties
+        public string BossName
+        {
+            get { return bossName; }
+            set { bossName = value; }
+        }
 
-		public string BossName
-		{
-			get { return bossName; }
-			set { bossName = value; }
-		}
+        public AutoHostConfig config = new AutoHostConfig();
 
-		public AutoHostConfig config = new AutoHostConfig();
+        public bool KickSpectators
+        {
+            get { return kickSpectators; }
+        }
 
-		public bool KickSpectators
-		{
-			get { return kickSpectators; }
-		}
+        public Ladder ladder;
+        public Dictionary&lt;string, Dictionary&lt;int, BattleRect&gt;&gt; MapBoxes = new Dictionary&lt;string, Dictionary&lt;int, BattleRect&gt;&gt;();
 
-		public Ladder ladder;
-		public Dictionary&lt;string, Dictionary&lt;int, BattleRect&gt;&gt; MapBoxes = new Dictionary&lt;string, Dictionary&lt;int, BattleRect&gt;&gt;();
+        public double MinCpuSpeed
+        {
+            get { return minCpuSpeed; }
+        }
 
-		public double MinCpuSpeed
-		{
-			get { return minCpuSpeed; }
-		}
+        public List&lt;Preset&gt; presets = new List&lt;Preset&gt;();
 
-		public List&lt;Preset&gt; presets = new List&lt;Preset&gt;();
+        #endregion
 
-		#endregion
+        #region Constructors
 
-		#region Constructors
+        public AutoHost(TasClient tas, Spring spring, AutoHostConfig conf)
+        {
+            banList = new BanList(this, tas);
 
-		public AutoHost(TasClient tas, Spring spring, AutoHostConfig conf)
-		{
-			banList = new BanList(this, tas);
+            if (conf == null) LoadConfig();
+            else config = conf;
+            SaveConfig();
 
-			if (conf == null) LoadConfig();
-			else config = conf;
-			SaveConfig();
+            this.tas = tas;
+            this.spring = spring;
 
-			this.tas = tas;
-			this.spring = spring;
+            tas.Said += tas_Said;
 
-			tas.Said += tas_Said;
+            pollTimer = new Timer(PollTimeout*1000);
+            pollTimer.Enabled = false;
+            pollTimer.AutoReset = false;
+            pollTimer.Elapsed += pollTimer_Elapsed;
 
-			pollTimer = new Timer(PollTimeout*1000);
-			pollTimer.Enabled = false;
-			pollTimer.AutoReset = false;
-			pollTimer.Elapsed += pollTimer_Elapsed;
+            spring.SpringExited += spring_SpringExited;
+            spring.GameOver += spring_GameOver;
+            spring.NotifyModsChanged += spring_NotifyModsChanged;
 
-			spring.SpringExited += spring_SpringExited;
-			spring.GameOver += spring_GameOver;
-			spring.NotifyModsChanged += spring_NotifyModsChanged;
+            tas.BattleUserLeft += tas_BattleUserLeft;
+            tas.UserStatusChanged += tas_UserStatusChanged;
+            tas.BattleUserJoined += tas_BattleUserJoined;
+            tas.BattleMapChanged += tas_BattleMapChanged;
+            tas.BattleUserStatusChanged += tas_BattleUserStatusChanged;
+            tas.BattleLockChanged += tas_BattleLockChanged;
+            tas.BattleOpened += tas_BattleOpened;
 
-			tas.BattleUserLeft += tas_BattleUserLeft;
-			tas.UserStatusChanged += tas_UserStatusChanged;
-			tas.BattleUserJoined += tas_BattleUserJoined;
-			tas.BattleMapChanged += tas_BattleMapChanged;
-			tas.BattleUserStatusChanged += tas_BattleUserStatusChanged;
-			tas.BattleLockChanged += tas_BattleLockChanged;
-			tas.BattleOpened += tas_BattleOpened;
+            linkProvider = new ResourceLinkProvider();
+            spring.UnitSyncWrapper.Downloader.LinksRecieved += linkProvider.Downloader_LinksRecieved;
+        }
 
-			linkProvider = new ResourceLinkProvider();
-			spring.UnitSyncWrapper.Downloader.LinksRecieved += linkProvider.Downloader_LinksRecieved;
-			fileDownloader = new FileDownloader(spring);
-			fileDownloader.DownloadCompleted += fileDownloader_DownloadCompleted;
-			//fileDownloader.DownloadProgressChanged += new EventHandler&lt;TasEventArgs&gt;(fileDownloader_DownloadProgressChanged);
-		}
+        #endregion
 
-		#endregion
-
-		/*void fileDownloader_DownloadProgressChanged(object sender, TasEventArgs e)
+        /*void fileDownloader_DownloadProgressChanged(object sender, TasEventArgs e)
     {
       if (tas.IsConnected) {
         SayBattle(e.ServerParams[0] + &quot; &quot; + e.ServerParams[1] + &quot;% done&quot;);
       }
     }*/
 
-		#region Public methods
+        #region Public methods
 
-		public int GetUserLevel(TasSayEventArgs e)
-		{
-			return GetUserLevel(e.UserName);
-		}
+        public int GetUserLevel(TasSayEventArgs e)
+        {
+            return GetUserLevel(e.UserName);
+        }
 
-		public int GetUserLevel(string name)
-		{
-			foreach (var pu in config.PrivilegedUsers) if (pu.Name == name) return pu.Level;
-			User u;
-			if (tas.GetExistingUser(name, out u)) if (u.isAdmin) return config.DefaulRightsLevelForLobbyAdmins;
-			return config.DefaulRightsLevel;
-		}
+        public int GetUserLevel(string name)
+        {
+            foreach (var pu in config.PrivilegedUsers) if (pu.Name == name) return pu.Level;
+            User u;
+            if (tas.GetExistingUser(name, out u)) if (u.isAdmin) return config.DefaulRightsLevelForLobbyAdmins;
+            return config.DefaulRightsLevel;
+        }
 
 
-		public bool HasRights(string command, TasSayEventArgs e)
-		{
-			if (banList.IsBanned(e.UserName)) {
-				Respond(e, &quot;tough luck, you are banned&quot;);
-				return false;
-			}
-			foreach (var c in config.Commands) {
-				if (c.Name == command) {
-					if (c.Throttling &gt; 0) {
-						int diff = (int) DateTime.Now.Subtract(c.lastCall).TotalSeconds;
-						if (diff &lt; c.Throttling) {
-							Respond(e, &quot;AntiSpam - please wait &quot; + (c.Throttling - diff) + &quot; more seconds&quot;);
-							return false;
-						}
-					}
+        public bool HasRights(string command, TasSayEventArgs e)
+        {
+            if (banList.IsBanned(e.UserName)) {
+                Respond(e, &quot;tough luck, you are banned&quot;);
+                return false;
+            }
+            foreach (var c in config.Commands) {
+                if (c.Name == command) {
+                    if (c.Throttling &gt; 0) {
+                        int diff = (int) DateTime.Now.Subtract(c.lastCall).TotalSeconds;
+                        if (diff &lt; c.Throttling) {
+                            Respond(e, &quot;AntiSpam - please wait &quot; + (c.Throttling - diff) + &quot; more seconds&quot;);
+                            return false;
+                        }
+                    }
 
-					for (int i = 0; i &lt; c.ListenTo.Length; i++) {
-						if (c.ListenTo[i] == e.Place) {
-							int reqLevel = c.Level;
-							int ulevel = GetUserLevel(e);
+                    for (int i = 0; i &lt; c.ListenTo.Length; i++) {
+                        if (c.ListenTo[i] == e.Place) {
+                            int reqLevel = c.Level;
+                            int ulevel = GetUserLevel(e);
 
-							if (ulevel &gt;= reqLevel) {
-								// boss stuff
-								if (bossName != &quot;&quot; &amp;&amp; ulevel &lt;= config.DefaulRightsLevel &amp;&amp; e.UserName != bossName &amp;&amp; config.DefaultRightsLevelWithBoss &lt; reqLevel) {
-									Respond(e, &quot;Sorry, you cannot do this right now, ask boss admin &quot; + bossName);
-									return false;
-								} else {
-									c.lastCall = DateTime.Now;
-									return true; // ALL OK
-								}
-							} else {
-								Respond(e, &quot;Sorry, you do not have rights to execute &quot; + command);
-								return false;
-							}
-						}
-					}
-					return false; // place not allowed for this command = ignore command
-				}
-			}
-			if (e.Place != TasSayEventArgs.Places.Channel) Respond(e, &quot;Sorry, I don't know command '&quot; + command + &quot;'&quot;);
-			return false;
-		}
+                            if (ulevel &gt;= reqLevel) {
+                                // boss stuff
+                                if (bossName != &quot;&quot; &amp;&amp; ulevel &lt;= config.DefaulRightsLevel &amp;&amp; e.UserName != bossName &amp;&amp; config.DefaultRightsLevelWithBoss &lt; reqLevel) {
+                                    Respond(e, &quot;Sorry, you cannot do this right now, ask boss admin &quot; + bossName);
+                                    return false;
+                                } else {
+                                    c.lastCall = DateTime.Now;
+                                    return true; // ALL OK
+                                }
+                            } else {
+                                Respond(e, &quot;Sorry, you do not have rights to execute &quot; + command);
+                                return false;
+                            }
+                        }
+                    }
+                    return false; // place not allowed for this command = ignore command
+                }
+            }
+            if (e.Place != TasSayEventArgs.Places.Channel) Respond(e, &quot;Sorry, I don't know command '&quot; + command + &quot;'&quot;);
+            return false;
+        }
 
-		public void LoadConfig()
-		{
-			if (File.Exists(Program.WorkPath + '/' + ConfigName)) {
-				var s = new XmlSerializer(config.GetType());
-				var r = File.OpenText(Program.WorkPath + '/' + ConfigName);
-				config = (AutoHostConfig) s.Deserialize(r);
-				r.Close();
-				config.AddMissingCommands();
-			} else config.Defaults();
+        public void LoadConfig()
+        {
+            if (File.Exists(Program.WorkPath + '/' + ConfigName)) {
+                var s = new XmlSerializer(config.GetType());
+                var r = File.OpenText(Program.WorkPath + '/' + ConfigName);
+                config = (AutoHostConfig) s.Deserialize(r);
+                r.Close();
+                config.AddMissingCommands();
+            } else config.Defaults();
 
-			if (File.Exists(Program.WorkPath + '/' + PresetsName))
-			{
-				var s = new XmlSerializer(presets.GetType());
-				using (var r = File.OpenText(Program.WorkPath + '/' + PresetsName))
-				{
-					presets = (List&lt;Preset&gt;) s.Deserialize(r);
-					r.Close();
-				}
-			}
+            if (File.Exists(Program.WorkPath + '/' + PresetsName)) {
+                var s = new XmlSerializer(presets.GetType());
+                using (var r = File.OpenText(Program.WorkPath + '/' + PresetsName)) {
+                    presets = (List&lt;Preset&gt;) s.Deserialize(r);
+                    r.Close();
+                }
+            }
 
-			if (File.Exists(Program.WorkPath +'/' + BoxesName))
-			{
-				var frm = new BinaryFormatter();
-				using (var r = new FileStream(Program.WorkPath + '/' + BoxesName, FileMode.Open))
-				{
-					MapBoxes = (Dictionary&lt;string, Dictionary&lt;int, BattleRect&gt;&gt;) frm.Deserialize(r);
-					r.Close();
-				}
-			}
+            if (File.Exists(Program.WorkPath + '/' + BoxesName)) {
+                var frm = new BinaryFormatter();
+                using (var r = new FileStream(Program.WorkPath + '/' + BoxesName, FileMode.Open)) {
+                    MapBoxes = (Dictionary&lt;string, Dictionary&lt;int, BattleRect&gt;&gt;) frm.Deserialize(r);
+                    r.Close();
+                }
+            }
 
-			banList.Load();
-		}
+            banList.Load();
+        }
 
-		public void RegisterVote(TasSayEventArgs e, string[] words)
-		{
-			if (activePoll != null) {
-				if (activePoll.Vote(e, words)) StopVote();
-			} else Respond(e, &quot;There is no poll going on, start some first&quot;);
-		}
+        public void RegisterVote(TasSayEventArgs e, string[] words)
+        {
+            if (activePoll != null) {
+                if (activePoll.Vote(e, words)) StopVote();
+            } else Respond(e, &quot;There is no poll going on, start some first&quot;);
+        }
 
-		public void Respond(TasSayEventArgs e, string text)
-		{
-			Respond(tas, spring, e, text);
-		}
+        public void Respond(TasSayEventArgs e, string text)
+        {
+            Respond(tas, spring, e, text);
+        }
 
-		public static void Respond(TasClient tas, Spring spring, TasSayEventArgs e, string text)
-		{
-			var p = TasClient.SayPlace.User;
-			bool emote = false;
-			if (e.Place == TasSayEventArgs.Places.Battle) {
-				p = TasClient.SayPlace.Battle;
-				emote = true;
-			}
-			if (e.Place == TasSayEventArgs.Places.Game &amp;&amp; spring.IsRunning) spring.SayGame(text);
-			else tas.Say(p, e.UserName, text, emote);
-		}
+        public static void Respond(TasClient tas, Spring spring, TasSayEventArgs e, string text)
+        {
+            var p = TasClient.SayPlace.User;
+            bool emote = false;
+            if (e.Place == TasSayEventArgs.Places.Battle) {
+                p = TasClient.SayPlace.Battle;
+                emote = true;
+            }
+            if (e.Place == TasSayEventArgs.Places.Game &amp;&amp; spring.IsRunning) spring.SayGame(text);
+            else tas.Say(p, e.UserName, text, emote);
+        }
 
-		public void SaveConfig()
-		{
-			lock (savLock) {
-				config.Commands.Sort(AutoHostConfig.CommandComparer);
+        public void SaveConfig()
+        {
+            lock (savLock) {
+                config.Commands.Sort(AutoHostConfig.CommandComparer);
 
-				// remove duplicated admins
-				var l = new List&lt;PrivilegedUser&gt;();
-				foreach (var p in config.PrivilegedUsers) if (l.Find(delegate(PrivilegedUser u) { return u.Name == p.Name; }) == null) l.Add(p);
-				;
-				config.PrivilegedUsers = l;
-				config.PrivilegedUsers.Sort(AutoHostConfig.UserComparer);
+                // remove duplicated admins
+                var l = new List&lt;PrivilegedUser&gt;();
+                foreach (var p in config.PrivilegedUsers) if (l.Find(delegate(PrivilegedUser u) { return u.Name == p.Name; }) == null) l.Add(p);
+                ;
+                config.PrivilegedUsers = l;
+                config.PrivilegedUsers.Sort(AutoHostConfig.UserComparer);
 
-				presets.Sort(delegate(Preset a, Preset b) { return a.Name.CompareTo(b.Name); });
+                presets.Sort(delegate(Preset a, Preset b) { return a.Name.CompareTo(b.Name); });
 
-				var s = new XmlSerializer(config.GetType());
-				var f = File.OpenWrite(Program.WorkPath + '/' + ConfigName);
-				f.SetLength(0);
-				s.Serialize(f, config);
-				f.Close();
+                var s = new XmlSerializer(config.GetType());
+                var f = File.OpenWrite(Program.WorkPath + '/' + ConfigName);
+                f.SetLength(0);
+                s.Serialize(f, config);
+                f.Close();
 
-				s = new XmlSerializer(presets.GetType());
-				f = File.OpenWrite(Program.WorkPath + '/' + PresetsName);
-				f.SetLength(0);
-				s.Serialize(f, presets);
-				f.Close();
+                s = new XmlSerializer(presets.GetType());
+                f = File.OpenWrite(Program.WorkPath + '/' + PresetsName);
+                f.SetLength(0);
+                s.Serialize(f, presets);
+                f.Close();
 
-				banList.Save();
+                banList.Save();
 
-				var fm = new BinaryFormatter();
-				using (var fs = new FileStream(Program.WorkPath + '/' + BoxesName, FileMode.Create))
-				{
-					fm.Serialize(fs, MapBoxes);
-					fs.Close();
-				}
-			}
-		}
+                var fm = new BinaryFormatter();
+                using (var fs = new FileStream(Program.WorkPath + '/' + BoxesName, FileMode.Create)) {
+                    fm.Serialize(fs, MapBoxes);
+                    fs.Close();
+                }
+            }
+        }
 
 
-		public void SayBattle(string text)
-		{
-			SayBattle(text, true);
-		}
+        public void SayBattle(string text)
+        {
+            SayBattle(text, true);
+        }
 
-		public void SayBattle(string text, bool ingame)
-		{
-			SayBattle(tas, spring, text, ingame);
-		}
+        public void SayBattle(string text, bool ingame)
+        {
+            SayBattle(tas, spring, text, ingame);
+        }
 
 
-		public static void SayBattle(TasClient tas, Spring spring, string text, bool ingame)
-		{
+        public static void SayBattle(TasClient tas, Spring spring, string text, bool ingame)
+        {
+            tas.Say(TasClient.SayPlace.Battle, &quot;&quot;, text, true);
+            if (spring.IsRunning &amp;&amp; ingame) spring.SayGame(text);
+        }
 
-			tas.Say(TasClient.SayPlace.Battle, &quot;&quot;, text, true);
-			if (spring.IsRunning &amp;&amp; ingame) spring.SayGame(text);
-		}
+        public void Start(string modname, string mapname)
+        {
+            Stop();
 
-		public void Start(string modname, string mapname)
-		{
-			Stop();
-	
-			manager = new AutoManager(this, tas, spring);
-			lockedByKickSpec = false;
-			autoLock = 0;
-			kickSpectators = config.KickSpectators;
-			minCpuSpeed = config.MinCpuSpeed;
-			kickMinRank = config.KickMinRank;
+            manager = new AutoManager(this, tas, spring);
+            lockedByKickSpec = false;
+            autoLock = 0;
+            kickSpectators = config.KickSpectators;
+            minCpuSpeed = config.MinCpuSpeed;
+            kickMinRank = config.KickMinRank;
 
-			if (config.LadderId &gt; 0) ladder = new Ladder(config.LadderId);
-			else ladder = null;
+            if (config.LadderId &gt; 0) ladder = new Ladder(config.LadderId);
+            else ladder = null;
 
-			if (String.IsNullOrEmpty(modname)) modname = config.DefaultMod;
-			if (String.IsNullOrEmpty(mapname)) mapname = config.DefaultMap;
+            if (String.IsNullOrEmpty(modname)) modname = config.DefaultMod;
+            if (String.IsNullOrEmpty(mapname)) mapname = config.DefaultMap;
 
-			if (!spring.UnitSyncWrapper.HasMap(mapname)) {
-				IEnumerator&lt;MapInfo&gt; enu = spring.UnitSyncWrapper.MapList.Values.GetEnumerator();
-				enu.MoveNext();
-				mapname = enu.Current.Name;
-			}
-			if (!string.IsNullOrEmpty(config.AutoUpdateMod)) {
-				var latest = spring.UnitSyncWrapper.GetNewestModVersion(config.AutoUpdateMod);
-				if (latest != null) modname = latest;
-			}
+            if (!spring.UnitSyncWrapper.HasMap(mapname)) {
+                IEnumerator&lt;MapInfo&gt; enu = spring.UnitSyncWrapper.MapList.Values.GetEnumerator();
+                enu.MoveNext();
+                mapname = enu.Current.Name;
+            }
+            if (!string.IsNullOrEmpty(config.AutoUpdateMod)) {
+                string latest = spring.UnitSyncWrapper.GetNewestModVersion(config.AutoUpdateMod);
+                if (latest != null) modname = latest;
+            }
 
-			if (!spring.UnitSyncWrapper.HasMod(modname)) {
-				IEnumerator&lt;ModInfo&gt; enu = spring.UnitSyncWrapper.ModList.Values.GetEnumerator();
-				enu.MoveNext();
-				modname = enu.Current.Name;
-			}
+            if (!spring.UnitSyncWrapper.HasMod(modname)) {
+                IEnumerator&lt;ModInfo&gt; enu = spring.UnitSyncWrapper.ModList.Values.GetEnumerator();
+                enu.MoveNext();
+                modname = enu.Current.Name;
+            }
 
-			int mint, maxt;
-			var b = new Battle((ladder == null ? config.Password : &quot;ladderlock2&quot;), config.HostingPort, config.MaxPlayers, config.MinRank, spring.UnitSyncWrapper.GetMapInfo(mapname), (ladder != null ? &quot;(ladder &quot; + ladder.Id + &quot;) &quot; : &quot;&quot;) + config.GameTitle.Replace(&quot;%1&quot;, MainConfig.SpringieVersion), spring.UnitSyncWrapper.GetModInfo(modname), (ladder != null ? ladder.CheckBattleDetails(config.BattleDetails, out mint, out maxt) : config.BattleDetails));
-			// if hole punching enabled then we use it
-			if (config.UseHolePunching) b.Nat = Battle.NatMode.HolePunching;
-			else if (Program.main.config.GargamelMode &amp;&amp; Program.main.Stats != null) b.Nat = Battle.NatMode.FixedPorts;
-			else b.Nat = Battle.NatMode.None; // else either no nat or fixed ports (for gargamel fake - to get client IPs)
+            int mint, maxt;
+            var b = new Battle((ladder == null ? config.Password : &quot;ladderlock2&quot;), config.HostingPort, config.MaxPlayers, config.MinRank, spring.UnitSyncWrapper.GetMapInfo(mapname), (ladder != null ? &quot;(ladder &quot; + ladder.Id + &quot;) &quot; : &quot;&quot;) + config.GameTitle.Replace(&quot;%1&quot;, MainConfig.SpringieVersion), spring.UnitSyncWrapper.GetModInfo(modname), (ladder != null ? ladder.CheckBattleDetails(config.BattleDetails, out mint, out maxt) : config.BattleDetails));
+            // if hole punching enabled then we use it
+            if (config.UseHolePunching) b.Nat = Battle.NatMode.HolePunching;
+            else if (Program.main.config.GargamelMode &amp;&amp; Program.main.Stats != null) b.Nat = Battle.NatMode.FixedPorts;
+            else b.Nat = Battle.NatMode.None; // else either no nat or fixed ports (for gargamel fake - to get client IPs)
 
-			for (int i = 0; i &lt; config.DefaultRectangles.Count; ++i) b.Rectangles.Add(i, config.DefaultRectangles[i]);
-			tas.OpenBattle(b);
-		}
+            for (int i = 0; i &lt; config.DefaultRectangles.Count; ++i) b.Rectangles.Add(i, config.DefaultRectangles[i]);
+            tas.OpenBattle(b);
+        }
 
 
-		public void StartVote(IVotable vote, TasSayEventArgs e, string[] words)
-		{
-			if (vote != null) {
-				if (activePoll != null) {
-					Respond(e, &quot;Another poll already in progress, please wait&quot;);
-					return;
-				}
-				if (vote.Init(e, words)) {
-					activePoll = vote;
-					pollTimer.Interval = PollTimeout*1000;
-					pollTimer.Enabled = true;
-				}
-			}
-		}
+        public void StartVote(IVotable vote, TasSayEventArgs e, string[] words)
+        {
+            if (vote != null) {
+                if (activePoll != null) {
+                    Respond(e, &quot;Another poll already in progress, please wait&quot;);
+                    return;
+                }
+                if (vote.Init(e, words)) {
+                    activePoll = vote;
+                    pollTimer.Interval = PollTimeout*1000;
+                    pollTimer.Enabled = true;
+                }
+            }
+        }
 
 
-		public void Stop()
-		{
-			if (manager != null) manager.Stop();
-			StopVote();
-			spring.ExitGame();
-			tas.ChangeMyStatus(false, false);
-			tas.LeaveBattle();
-		}
+        public void Stop()
+        {
+            if (manager != null) manager.Stop();
+            StopVote();
+            spring.ExitGame();
+            tas.ChangeMyStatus(false, false);
+            tas.LeaveBattle();
+        }
 
-		public void StopVote()
-		{
-			pollTimer.Enabled = false;
-			activePoll = null;
-		}
+        public void StopVote()
+        {
+            pollTimer.Enabled = false;
+            activePoll = null;
+        }
 
-		#endregion
+        #endregion
 
-		#region Other methods
+        #region Other methods
 
-		private void CheckForBattleExit()
-		{
-			if ((DateTime.Now - spring.GameStarted) &gt; TimeSpan.FromSeconds(20)) {
-				if (spring.IsRunning) {
-					var b = tas.GetBattle();
-					int count = 0;
-					foreach (var p in b.Users) {
-						if (p.IsSpectator) continue;
+        private void CheckForBattleExit()
+        {
+            if ((DateTime.Now - spring.GameStarted) &gt; TimeSpan.FromSeconds(20)) {
+                if (spring.IsRunning) {
+                    var b = tas.GetBattle();
+                    int count = 0;
+                    foreach (var p in b.Users) {
+                        if (p.IsSpectator) continue;
 
-						User u;
-						if (!tas.GetExistingUser(p.name, out u)) continue;
-						if (u.isInGame) count++;
-					}
-					if (count &lt; 1) {
-						SayBattle(&quot;closing game, &quot; + count + &quot; active player left in game&quot;);
-						spring.ExitGame();
-					}
-				}
-				// kontrola pro pripad ze by se nevypl spring
-				User us;
-				if (!spring.IsRunning &amp;&amp; tas.GetExistingUser(tas.UserName, out us) &amp;&amp; us.isInGame) tas.ChangeMyStatus(false, false);
-			}
-		}
+                        User u;
+                        if (!tas.GetExistingUser(p.name, out u)) continue;
+                        if (u.isInGame) count++;
+                    }
+                    if (count &lt; 1) {
+                        SayBattle(&quot;closing game, &quot; + count + &quot; active player left in game&quot;);
+                        spring.ExitGame();
+                    }
+                }
+                // kontrola pro pripad ze by se nevypl spring
+                User us;
+                if (!spring.IsRunning &amp;&amp; tas.GetExistingUser(tas.UserName, out us) &amp;&amp; us.isInGame) tas.ChangeMyStatus(false, false);
+            }
+        }
 
-		private void HandleAutoLocking()
-		{
-			if (autoLock &gt; 0 &amp;&amp; (!spring.IsRunning)) {
-				var b = tas.GetBattle();
-				int cnt = b.CountPlayers();
-				if (cnt &gt;= autoLock) tas.ChangeLock(true);
+        private void HandleAutoLocking()
+        {
+            if (autoLock &gt; 0 &amp;&amp; (!spring.IsRunning)) {
+                var b = tas.GetBattle();
+                int cnt = b.CountPlayers();
+                if (cnt &gt;= autoLock) tas.ChangeLock(true);
 
-				if (cnt &lt; autoLock) tas.ChangeLock(false);
-			}
-		}
+                if (cnt &lt; autoLock) tas.ChangeLock(false);
+            }
+        }
 
-		private void HandleKickSpecServerLocking()
-		{
-			if (!spring.IsRunning &amp;&amp; (KickSpectators || lockedByKickSpec)) {
-				var b = tas.GetBattle();
-				int cnt = b.CountPlayers();
-				if (KickSpectators &amp;&amp; cnt &gt;= b.MaxPlayers) {
-					lockedByKickSpec = true;
-					tas.ChangeLock(true);
-				}
+        private void HandleKickSpecServerLocking()
+        {
+            if (!spring.IsRunning &amp;&amp; (KickSpectators || lockedByKickSpec)) {
+                var b = tas.GetBattle();
+                int cnt = b.CountPlayers();
+                if (KickSpectators &amp;&amp; cnt &gt;= b.MaxPlayers) {
+                    lockedByKickSpec = true;
+                    tas.ChangeLock(true);
+                }
 
-				if (lockedByKickSpec &amp;&amp; cnt &lt; b.MaxPlayers) {
-					lockedByKickSpec = false;
-					tas.ChangeLock(false);
-				}
-			}
-		}
+                if (lockedByKickSpec &amp;&amp; cnt &lt; b.MaxPlayers) {
+                    lockedByKickSpec = false;
+                    tas.ChangeLock(false);
+                }
+            }
+        }
 
-		private void HandleMinRankKicking()
-		{
-			if (kickMinRank &amp;&amp; config.MinRank &gt; 0) {
-				var b = tas.GetBattle();
-				if (b != null) {
-					foreach (var u in b.Users) {
-						User x;
-						tas.GetExistingUser(u.name, out x);
-						if (u.name != tas.UserName &amp;&amp; x.rank &lt; config.MinRank) {
-							SayBattle(x.name + &quot;, your rank is too low, rank kicking is enabled here&quot;);
-							ComKick(TasSayEventArgs.Default, new[] {u.name});
-						}
-					}
-				}
-			}
-		}
+        private void HandleMinRankKicking()
+        {
+            if (kickMinRank &amp;&amp; config.MinRank &gt; 0) {
+                var b = tas.GetBattle();
+                if (b != null) {
+                    foreach (var u in b.Users) {
+                        User x;
+                        tas.GetExistingUser(u.name, out x);
+                        if (u.name != tas.UserName &amp;&amp; x.rank &lt; config.MinRank) {
+                            SayBattle(x.name + &quot;, your rank is too low, rank kicking is enabled here&quot;);
+                            ComKick(TasSayEventArgs.Default, new[] {u.name});
+                        }
+                    }
+                }
+            }
+        }
 
-		#endregion
+        #endregion
 
-		#region Event Handlers
+        #region Event Handlers
 
-		private void fileDownloader_DownloadCompleted(object sender, FileDownloader.DownloadEventArgs e)
-		{
-			string mes;
-			if (e.Status == FileDownloader.Status.Failed) mes = e.DownloadItem.fileName + &quot; download failed: &quot; + e.Message;
-			else mes = e.DownloadItem.fileName + &quot; download finished!&quot;;
-			if (tas.IsConnected) SayBattle(mes);
-			if (e.DownloadItem.fileType == FileDownloader.FileType.Mod &amp;&amp; !spring.IsRunning) Start(e.DownloadItem.fileName, null);
-		}
 
-		private void pollTimer_Elapsed(object sender, ElapsedEventArgs e)
-		{
-			if (activePoll != null) activePoll.TimeEnd();
-			StopVote();
-		}
+        private void pollTimer_Elapsed(object sender, ElapsedEventArgs e)
+        {
+            if (activePoll != null) activePoll.TimeEnd();
+            StopVote();
+        }
 
-		private void spring_GameOver(object sender, SpringLogEventArgs e)
-		{
-			SayBattle(&quot;Game over, exiting&quot;);
-		    new Thread(x =&gt;
-		                   {
-		                       Thread.Sleep(3000); // wait for stats
-		                       spring.ExitGame();
-		                   }).Start();
+        private void spring_GameOver(object sender, SpringLogEventArgs e)
+        {
+            SayBattle(&quot;Game over, exiting&quot;);
+            new Thread(x =&gt;
+                           {
+                               Thread.Sleep(3000); // wait for stats
+                               spring.ExitGame();
+                           }).Start();
 
-			if (config.MapCycle.Length &gt; 0) {
-				mapCycleIndex = mapCycleIndex%config.MapCycle.Length;
-				SayBattle(&quot;changing to another map in mapcycle&quot;);
-				ComMap(TasSayEventArgs.Default, config.MapCycle[mapCycleIndex].Split(new[] {' '}, StringSplitOptions.RemoveEmptyEntries));
-				mapCycleIndex++;
-			}
-		}
+            if (config.MapCycle.Length &gt; 0) {
+                mapCycleIndex = mapCycleIndex%config.MapCycle.Length;
+                SayBattle(&quot;changing to another map in mapcycle&quot;);
+                ComMap(TasSayEventArgs.Default, config.MapCycle[mapCycleIndex].Split(new[] {' '}, StringSplitOptions.RemoveEmptyEntries));
+                mapCycleIndex++;
+            }
+        }
 
-		private void spring_NotifyModsChanged(object sender, EventArgs e)
-		{
-			if (!string.IsNullOrEmpty(config.AutoUpdateMod)) {
-				string latest = spring.UnitSyncWrapper.GetNewestModVersion(config.AutoUpdateMod);
-				Battle b = tas.GetBattle();
-				if (!string.IsNullOrEmpty(latest) &amp;&amp; b != null &amp;&amp; b.Mod != null &amp; b.Mod.Name != latest)
-				{
-					config.DefaultMod = latest;
-					if (!spring.IsRunning) {
-						SayBattle(&quot;Updating to latest mod version: &quot; + latest);
-						ComRehost(TasSayEventArgs.Default, new[] {latest});
-					} else delayedModChange = latest;
-				}
-			}
-		}
+        private void spring_NotifyModsChanged(object sender, EventArgs e)
+        {
+            if (!string.IsNullOrEmpty(config.AutoUpdateMod)) {
+                string latest = spring.UnitSyncWrapper.GetNewestModVersion(config.AutoUpdateMod);
+                var b = tas.GetBattle();
+                if (!string.IsNullOrEmpty(latest) &amp;&amp; b != null &amp;&amp; b.Mod != null &amp; b.Mod.Name != latest) {
+                    config.DefaultMod = latest;
+                    if (!spring.IsRunning) {
+                        SayBattle(&quot;Updating to latest mod version: &quot; + latest);
+                        ComRehost(TasSayEventArgs.Default, new[] {latest});
+                    } else delayedModChange = latest;
+                }
+            }
+        }
 
-		private void spring_SpringExited(object sender, EventArgs e)
-		{
-			tas.ChangeLock(false);
-			var b = tas.GetBattle();
-			foreach (var s in toNotify) {
-				if (b != null &amp;&amp; b.ContainsUser(s)) tas.Ring(s);
-				tas.Say(TasClient.SayPlace.User, s, &quot;** Game just ended, join me! **&quot;, false);
-			}
-			toNotify.Clear();
-			if (!string.IsNullOrEmpty(delayedModChange)) {
-				string mod = delayedModChange;
-				delayedModChange = null;
-				SayBattle(&quot;Updating to latest mod version: &quot; + mod);
-				ComRehost(TasSayEventArgs.Default, new[] {mod});
-			}
-		}
+        private void spring_SpringExited(object sender, EventArgs e)
+        {
+            tas.ChangeLock(false);
+            var b = tas.GetBattle();
+            foreach (var s in toNotify) {
+                if (b != null &amp;&amp; b.ContainsUser(s)) tas.Ring(s);
+                tas.Say(TasClient.SayPlace.User, s, &quot;** Game just ended, join me! **&quot;, false);
+            }
+            toNotify.Clear();
+            if (!string.IsNullOrEmpty(delayedModChange)) {
+                string mod = delayedModChange;
+                delayedModChange = null;
+                SayBattle(&quot;Updating to latest mod version: &quot; + mod);
+                ComRehost(TasSayEventArgs.Default, new[] {mod});
+            }
+        }
 
 
-		private void tas_BattleLockChanged(object sender, TasEventArgs e)
-		{
-			SayBattle(&quot;game &quot; + (tas.GetBattle().IsLocked ? &quot;locked&quot; : &quot;unlocked&quot;), false);
-		}
+        private void tas_BattleLockChanged(object sender, TasEventArgs e)
+        {
+            SayBattle(&quot;game &quot; + (tas.GetBattle().IsLocked ? &quot;locked&quot; : &quot;unlocked&quot;), false);
+        }
 
-		private void tas_BattleMapChanged(object sender, TasEventArgs e)
-		{
-			var b = tas.GetBattle();
-			string mapName = b.Map.Name.ToLower();
-			if (MapBoxes.ContainsKey(mapName)) {
-				for (int i = 0; i &lt; b.Rectangles.Count; ++i) tas.RemoveBattleRectangle(i);
-				var dict = MapBoxes[mapName];
-				foreach (var v in dict) tas.AddBattleRectangle(v.Key, v.Value);
-			}
+        private void tas_BattleMapChanged(object sender, TasEventArgs e)
+        {
+            var b = tas.GetBattle();
+            string mapName = b.Map.Name.ToLower();
+            if (MapBoxes.ContainsKey(mapName)) {
+                for (int i = 0; i &lt; b.Rectangles.Count; ++i) tas.RemoveBattleRectangle(i);
+                var dict = MapBoxes[mapName];
+                foreach (var v in dict) tas.AddBattleRectangle(v.Key, v.Value);
+            }
 
+            if (Program.main.PlanetWars != null) Program.main.PlanetWars.MapChanged();
+        }
 
-			if (Program.main.config.PlanetWarsEnabled) {
-				try {
-					var pw = Program.main.PlanetWars;
+        private void tas_BattleOpened(object sender, TasEventArgs e)
+        {
+            tas.DisableUnits(UnitInfo.ToStringList(config.DisabledUnits));
+        }
 
-					string name = tas.GetBattle().Map.Name;
-					var mapInfo = pw.GetAttackOptions().Where(m =&gt; m.MapName == name).Single();
-					if (mapInfo.StartBoxes != null &amp;&amp; mapInfo.StartBoxes.Count &gt; 0) {
-						int rectangles = tas.GetBattle().Rectangles.Count;
-						for (int i = 0; i &lt; rectangles; ++i) tas.RemoveBattleRectangle(i);
-						for (int i = 0; i &lt; mapInfo.StartBoxes.Count; ++i) {
-							var mi = mapInfo.StartBoxes[i];
-							tas.AddBattleRectangle(i, new BattleRect(mi.Left, mi.Top, mi.Right, mi.Bottom));
-						}
-					}
+        private void tas_BattleUserJoined(object sender, TasEventArgs e)
+        {
+            string name = e.ServerParams[0];
+            string welc = config.Welcome;
+            if (welc != &quot;&quot;) {
+                welc = welc.Replace(&quot;%1&quot;, name);
+                welc = welc.Replace(&quot;%2&quot;, GetUserLevel(name).ToString());
+                welc = welc.Replace(&quot;%3&quot;, MainConfig.SpringieVersion);
+                SayBattle(welc, false);
+            }
+            if (spring.IsRunning) {
+                var started = DateTime.Now.Subtract(spring.GameStarted);
+                started = new TimeSpan((int) started.TotalHours, started.Minutes, started.Seconds);
+                SayBattle(string.Format(&quot;GAME IS CURRENTLY IN PROGRESS, PLEASE WAIT TILL IT ENDS! Running for {0}&quot;, started), false);
+                SayBattle(&quot;If you say !notify, I will PM you when game ends.&quot;, false);
+            }
 
-					foreach (var command in mapInfo.AutohostCommands) tas.Say(TasClient.SayPlace.Channel, tas.UserName, command, false);
+            HandleKickSpecServerLocking();
+            HandleAutoLocking();
+            HandleMinRankKicking();
 
-                    SayBattle(String.Format(&quot;Welcome to {0}!  (<A HREF="http://planet-wars.eu/planet.aspx?name={1">http://planet-wars.eu/planet.aspx?name={1</A>})&quot;, mapInfo.Name, Uri.EscapeUriString(mapInfo.Name)));
+            if (minCpuSpeed &gt; 0) {
+                User u;
+                if (tas.GetExistingUser(name, out u)) {
+                    if (u.cpu != 0 &amp;&amp; u.cpu &lt; minCpuSpeed*1000) {
+                        Thread.CurrentThread.CurrentCulture = CultureInfo.InvariantCulture;
+                        SayBattle(name + &quot;, your CPU speed is below minimum set for this server:&quot; + minCpuSpeed + &quot;GHz - sorry&quot;);
+                        ComKick(TasSayEventArgs.Default, new[] {u.name});
+                    }
+                }
+            }
+            if (Program.main.PlanetWars != null) Program.main.PlanetWars.UserJoined(name);
+        }
 
-					var notifyList = pw.GetPlayersToNotify(Program.main.PlanetwarsAccount, name, ReminderEvent.OnBattlePreparing);
-                    foreach (string userName in notifyList) tas.Say(TasClient.SayPlace.User, userName, string.Format(&quot;Planet {0} is under attack! Join the fight!&quot;, mapInfo.Name), false);
-				} catch (Exception ex) {
-					SayBattle(string.Format(&quot;Error setting planet starting boxes: {0}&quot;, ex));
-				}
-			}
-		}
+        private void tas_BattleUserLeft(object sender, TasEventArgs e)
+        {
+            CheckForBattleExit();
+            HandleKickSpecServerLocking();
+            HandleAutoLocking();
 
-		private void tas_BattleOpened(object sender, TasEventArgs e)
-		{
-			tas.DisableUnits(UnitInfo.ToStringList(config.DisabledUnits));
-		}
+            if (spring.IsRunning) spring.SayGame(e.ServerParams[0] + &quot; has left lobby&quot;);
 
-		private void tas_BattleUserJoined(object sender, TasEventArgs e)
-		{
-			string name = e.ServerParams[0];
-			string welc = config.Welcome;
-			if (welc != &quot;&quot;) {
-				welc = welc.Replace(&quot;%1&quot;, name);
-				welc = welc.Replace(&quot;%2&quot;, GetUserLevel(name).ToString());
-				welc = welc.Replace(&quot;%3&quot;, MainConfig.SpringieVersion);
-				SayBattle(welc, false);
-			}
-			if (spring.IsRunning) {
-				var started = DateTime.Now.Subtract(spring.GameStarted);
-				started = new TimeSpan((int) started.TotalHours, started.Minutes, started.Seconds);
-				SayBattle(string.Format(&quot;GAME IS CURRENTLY IN PROGRESS, PLEASE WAIT TILL IT ENDS! Running for {0}&quot;, started), false);
-				SayBattle(&quot;If you say !notify, I will PM you when game ends.&quot;, false);
-			}
+            if (e.ServerParams[0] == bossName) {
+                SayBattle(&quot;boss has left the battle&quot;);
+                bossName = &quot;&quot;;
+            }
 
-			HandleKickSpecServerLocking();
-			HandleAutoLocking();
-			HandleMinRankKicking();
+            if (tas.GetBattle().IsLocked &amp;&amp; tas.GetBattle().Users.Count &lt; 2) {
+                // player left and only 2 remaining (springie itself + some noob) -&gt; unlock
+                tas.ChangeLock(false);
+            }
+        }
 
-			if (minCpuSpeed &gt; 0) {
-				User u;
-				if (tas.GetExistingUser(name, out u)) {
-					if (u.cpu != 0 &amp;&amp; u.cpu &lt; minCpuSpeed*1000) {
-						Thread.CurrentThread.CurrentCulture = CultureInfo.InvariantCulture;
-						SayBattle(name + &quot;, your CPU speed is below minimum set for this server:&quot; + minCpuSpeed + &quot;GHz - sorry&quot;);
-						ComKick(TasSayEventArgs.Default, new[] {u.name});
-					}
-				}
-			}
+        private void tas_BattleUserStatusChanged(object sender, TasEventArgs e)
+        {
+            UserBattleStatus u;
+            var b = tas.GetBattle();
 
-			if (Program.main.config.PlanetWarsEnabled) {
-                try {
-                    var current = Program.main.PlanetWars.GetOffensiveFaction();
+            if (b != null &amp;&amp; b.ContainsUser(e.ServerParams[0], out u)) {
+                if (Program.main.PlanetWars != null) Program.main.PlanetWars.UserStatusChanged(u);
+                if (KickSpectators &amp;&amp; u.IsSpectator &amp;&amp; u.name != tas.UserName) {
+                    SayBattle(config.KickSpectatorText);
+                    ComKick(TasSayEventArgs.Default, new[] {u.name});
+                }
+                HandleAutoLocking();
 
-                    var info = Program.main.PlanetWars.GetPlayerInfo(name);
-                    if (info != null)
-                    {
-                        SayBattle(string.Format(&quot;{0} {1} {2}. Attacking faction is {3}&quot;, info.IsCommanderInChief ? &quot;All hail to&quot; : &quot;Greetings, &quot;, info.RankText, name, current.Name), false);
+                int cnt = 0;
+                foreach (var ubs in b.Users) if (!ubs.IsSpectator &amp;&amp; ubs.IsReady) cnt++;
+                List&lt;string&gt; usname;
+                int allyno;
+                if (!manager.Enabled) {
+                    if ((cnt == config.MaxPlayers || (autoLock &gt; 0 &amp;&amp; autoLock == cnt)) &amp;&amp; !Program.main.config.PlanetWarsEnabled &amp;&amp; AllReadyAndSynced(out usname) &amp;&amp; AllUniqueTeams(out usname) &amp;&amp; BalancedTeams(out allyno)) {
+                        SayBattle(&quot;server is full, starting&quot;);
+                        Thread.Sleep(1000); // just to make sure that other clients update their game info and balance ends
+                        ComStart(TasSayEventArgs.Default, new string[] {});
                     }
-                } catch (Exception ex) {
-                    SayBattle(&quot;PlanetWars error: &quot; + ex);
                 }
-			}
-		}
+            }
+        }
 
-		private void tas_BattleUserLeft(object sender, TasEventArgs e)
-		{
-			CheckForBattleExit();
-			HandleKickSpecServerLocking();
-			HandleAutoLocking();
+        private void tas_Said(object sender, TasSayEventArgs e)
+        {
+            // check if it's command
+            if (e.Origin == TasSayEventArgs.Origins.Player &amp;&amp; !e.IsEmote &amp;&amp; e.Text.StartsWith(&quot;!&quot;)) {
+                if (e.Text.Length &lt; 2) return;
+                var allwords = e.Text.Substring(1).Split(new[] {' '}, StringSplitOptions.RemoveEmptyEntries);
+                if (allwords.Length &lt; 1) return;
+                string com = allwords[0];
 
-			if (spring.IsRunning) spring.SayGame(e.ServerParams[0] + &quot; has left lobby&quot;);
+                // remove first word (command)
+                var words = Utils.ShiftArray(allwords, -1);
 
-			if (e.ServerParams[0] == bossName) {
-				SayBattle(&quot;boss has left the battle&quot;);
-				bossName = &quot;&quot;;
-			}
+                if (!HasRights(com, e)) return;
+                switch (com) {
+                    case &quot;listmaps&quot;:
+                        ComListMaps(e, words);
+                        break;
 
-			if (tas.GetBattle().IsLocked &amp;&amp; tas.GetBattle().Users.Count &lt; 2) {
-				// player left and only 2 remaining (springie itself + some noob) -&gt; unlock
-				tas.ChangeLock(false);
-			}
-		}
+                    case &quot;listmods&quot;:
+                        ComListMods(e, words);
+                        break;
 
-		private void tas_BattleUserStatusChanged(object sender, TasEventArgs e)
-		{
-			UserBattleStatus u;
-			var b = tas.GetBattle();
+                    case &quot;help&quot;:
+                        ComHelp(e, words);
+                        break;
 
-			if (b != null &amp;&amp; b.ContainsUser(e.ServerParams[0], out u)) {
-				/*if (u.SyncStatus == SyncStatuses.Unsynced) {
-          SayBattle(&quot;kicking &quot; + u.name + &quot; - has incorrect spring or mod version&quot;);
-          tas.Kick(u.name);
-        }*/
+                    case &quot;map&quot;:
+                        ComMap(e, words);
+                        break;
 
+                    case &quot;admins&quot;:
+                        ComAdmins(e, words);
+                        break;
 
-				if (Program.main.config.PlanetWarsEnabled &amp;&amp; u.name != tas.UserName &amp;&amp; !u.IsSpectator) {
-					try {
-						var pw = Program.main.PlanetWars;
-						var info = pw.GetPlayerInfo(u.name);
-						var factions = new List&lt;IFaction&gt;(pw.GetFactions());
-						if (info == null) {
-							if (!u.IsSpectator) {
-								tas.ForceSpectator(u.name);
-								SayBattle(string.Format(&quot;{0} is not registered.Say !register faction newpassword (optional planet) eg. !register core secretpw&quot;, u.name), false);
-								return;
-							}
-						} else {
-							int hisFaction = factions.IndexOf(factions.Find((f) =&gt; f.Name == info.FactionName));
-							if (u.AllyNumber != hisFaction) {
-								tas.ForceAlly(u.name, hisFaction);
-								SayBattle(string.Format(&quot;{0} must play in team {1}&quot;, u.name, hisFaction + 1), false);
-								return;
-							}
-						}
-					} catch (Exception ex) {
-						SayBattle(string.Format(&quot;Warning, PlanetWars problem: {0} &quot;, ex), false);
-					}
-				}
+                    case &quot;start&quot;:
+                        ComStart(e, words);
+                        break;
 
+                    case &quot;forcestart&quot;:
+                        ComForceStart(e, words);
+                        break;
 
-				if (KickSpectators &amp;&amp; u.IsSpectator &amp;&amp; u.name != tas.UserName) {
-					SayBattle(config.KickSpectatorText);
-					ComKick(TasSayEventArgs.Default, new[] {u.name});
-				}
-				HandleAutoLocking();
+                    case &quot;force&quot;:
+                        ComForce(e, words);
+                        break;
 
-				int cnt = 0;
-				foreach (var ubs in b.Users) if (!ubs.IsSpectator &amp;&amp; ubs.IsReady) cnt++;
-				List&lt;string&gt; usname;
-				int allyno;
-				if (!manager.Enabled) {
-					if ((cnt == config.MaxPlayers || (autoLock &gt; 0 &amp;&amp; autoLock == cnt)) &amp;&amp; !Program.main.config.PlanetWarsEnabled &amp;&amp; AllReadyAndSynced(out usname) &amp;&amp; AllUniqueTeams(out usname) &amp;&amp; BalancedTeams(out allyno)) {
-						SayBattle(&quot;server is full, starting&quot;);
-						Thread.Sleep(1000); // just to make sure that other clients update their game info and balance ends
-						ComStart(TasSayEventArgs.Default, new string[] {});
-					}
-				}
-			}
-		}
+                    case &quot;split&quot;:
+                        ComSplit(e, words);
+                        break;
 
-		private void tas_Said(object sender, TasSayEventArgs e)
-		{
-			// check if it's command
-			if (e.Origin == TasSayEventArgs.Origins.Player &amp;&amp; !e.IsEmote &amp;&amp; e.Text.StartsWith(&quot;!&quot;)) {
-				if (e.Text.Length &lt; 2) return;
-				var allwords = e.Text.Substring(1).Split(new[] {' '}, StringSplitOptions.RemoveEmptyEntries);
-				if (allwords.Length &lt; 1) return;
-				string com = allwords[0];
+                    case &quot;corners&quot;:
+                        ComCorners(e, words);
+                        break;
 
-				// remove first word (command)
-				var words = Utils.ShiftArray(allwords, -1);
+                    case &quot;maplink&quot;:
+                        linkProvider.FindLinks(words, ResourceLinkProvider.FileType.Map, tas, e);
+                        break;
 
-				if (!HasRights(com, e)) return;
-				switch (com) {
-					case &quot;listmaps&quot;:
-						ComListMaps(e, words);
-						break;
+                    case &quot;modlink&quot;:
+                        linkProvider.FindLinks(words, ResourceLinkProvider.FileType.Mod, tas, e);
+                        break;
 
-					case &quot;listmods&quot;:
-						ComListMods(e, words);
-						break;
+                    case &quot;ring&quot;:
+                        ComRing(e, words);
+                        break;
 
-					case &quot;help&quot;:
-						ComHelp(e, words);
-						break;
+                    case &quot;kick&quot;:
+                        ComKick(e, words);
+                        break;
 
-					case &quot;map&quot;:
-						ComMap(e, words);
-						break;
+                    case &quot;exit&quot;:
+                        ComExit(e, words);
+                        break;
 
-					case &quot;admins&quot;:
-						ComAdmins(e, words);
-						break;
+                    case &quot;lock&quot;:
+                        tas.ChangeLock(true);
+                        break;
 
-					case &quot;start&quot;:
-						ComStart(e, words);
-						break;
+                    case &quot;unlock&quot;:
+                        tas.ChangeLock(false);
+                        break;
 
-					case &quot;forcestart&quot;:
-						ComForceStart(e, words);
-						break;
+                    case &quot;vote&quot;:
+                        RegisterVote(e, words);
+                        break;
 
-					case &quot;force&quot;:
-						ComForce(e, words);
-						break;
+                    case &quot;votemap&quot;:
+                        StartVote(new VoteMap(tas, spring, this), e, words);
+                        break;
 
-					case &quot;split&quot;:
-						ComSplit(e, words);
-						break;
+                    case &quot;votekick&quot;:
+                        StartVote(new VoteKick(tas, spring, this), e, words);
+                        break;
 
-					case &quot;corners&quot;:
-						ComCorners(e, words);
-						break;
+                    case &quot;voteforcestart&quot;:
+                        StartVote(new VoteForceStart(tas, spring, this), e, words);
+                        break;
 
-					case &quot;maplink&quot;:
-						linkProvider.FindLinks(words, ResourceLinkProvider.FileType.Map, tas, e);
-						break;
+                    case &quot;voteforce&quot;:
+                        StartVote(new VoteForce(tas, spring, this), e, words);
+                        break;
 
-					case &quot;modlink&quot;:
-						linkProvider.FindLinks(words, ResourceLinkProvider.FileType.Mod, tas, e);
-						break;
+                    case &quot;voteexit&quot;:
+                        StartVote(new VoteExit(tas, spring, this), e, words);
+                        break;
 
-					case &quot;ring&quot;:
-						ComRing(e, words);
-						break;
+                    case &quot;votepreset&quot;:
+                        StartVote(new VotePreset(tas, spring, this), e, words);
+                        break;
 
-					case &quot;kick&quot;:
-						ComKick(e, words);
-						break;
+                    case &quot;fix&quot;:
+                        ComFix(e, words);
+                        break;
 
-					case &quot;exit&quot;:
-						ComExit(e, words);
-						break;
+                    case &quot;rehost&quot;:
+                        ComRehost(e, words);
+                        break;
 
-					case &quot;lock&quot;:
-						tas.ChangeLock(true);
-						break;
+                    case &quot;voterehost&quot;:
+                        StartVote(new VoteRehost(tas, spring, this), e, words);
+                        break;
 
-					case &quot;unlock&quot;:
-						tas.ChangeLock(false);
-						break;
+                    case &quot;random&quot;:
+                        ComRandom(e, words);
+                        break;
 
-					case &quot;vote&quot;:
-						RegisterVote(e, words);
-						break;
+                    case &quot;balance&quot;:
+                        ComBalance(e, words);
+                        break;
 
-					case &quot;votemap&quot;:
-						StartVote(new VoteMap(tas, spring, this), e, words);
-						break;
+                    case &quot;setlevel&quot;:
+                        ComSetLevel(e, words);
+                        break;
 
-					case &quot;votekick&quot;:
-						StartVote(new VoteKick(tas, spring, this), e, words);
-						break;
+                    case &quot;say&quot;:
+                        ComSay(e, words);
+                        break;
 
-					case &quot;voteforcestart&quot;:
-						StartVote(new VoteForceStart(tas, spring, this), e, words);
-						break;
 
-					case &quot;voteforce&quot;:
-						StartVote(new VoteForce(tas, spring, this), e, words);
-						break;
+                    case &quot;id&quot;:
+                        ComTeam(e, words);
+                        break;
 
-					case &quot;voteexit&quot;:
-						StartVote(new VoteExit(tas, spring, this), e, words);
-						break;
+                    case &quot;team&quot;:
+                        ComAlly(e, words);
+                        break;
 
-					case &quot;votepreset&quot;:
-						StartVote(new VotePreset(tas, spring, this), e, words);
-						break;
+                    case &quot;helpall&quot;:
+                        ComHelpAll(e, words);
+                        break;
 
-					case &quot;fix&quot;:
-						ComFix(e, words);
-						break;
+                    case &quot;fixcolors&quot;:
+                        ComFixColors(e, words);
+                        break;
 
-					case &quot;rehost&quot;:
-						ComRehost(e, words);
-						break;
+                    case &quot;springie&quot;:
+                        ComSpringie(e, words);
+                        break;
 
-					case &quot;voterehost&quot;:
-						StartVote(new VoteRehost(tas, spring, this), e, words);
-						break;
+                    case &quot;endvote&quot;:
+                        StopVote();
+                        SayBattle(&quot;poll cancelled&quot;);
+                        break;
 
-					case &quot;random&quot;:
-						ComRandom(e, words);
-						break;
+                    case &quot;addbox&quot;:
+                        ComAddBox(e, words);
+                        break;
 
-					case &quot;balance&quot;:
-						ComBalance(e, words);
-						break;
+                    case &quot;clearbox&quot;:
+                        ComClearBox(e, words);
+                        break;
 
-					case &quot;setlevel&quot;:
-						ComSetLevel(e, words);
-						break;
+                    case &quot;listpresets&quot;:
+                        ComListPresets(e, words);
+                        break;
 
-					case &quot;say&quot;:
-						ComSay(e, words);
-						break;
+                    case &quot;presetdetails&quot;:
+                        ComPresetDetails(e, words);
+                        break;
 
+                    case &quot;preset&quot;:
+                        ComPreset(e, words);
+                        break;
 
-					case &quot;id&quot;:
-						ComTeam(e, words);
-						break;
+                    case &quot;cbalance&quot;:
+                        ComCBalance(e, words);
+                        break;
 
-					case &quot;team&quot;:
-						ComAlly(e, words);
-						break;
+                    case &quot;listbans&quot;:
+                        banList.ComListBans(e, words);
+                        break;
 
-					case &quot;helpall&quot;:
-						ComHelpAll(e, words);
-						break;
+                    case &quot;ban&quot;:
+                        banList.ComBan(e, words);
+                        break;
 
-					case &quot;fixcolors&quot;:
-						ComFixColors(e, words);
-						break;
+                    case &quot;unban&quot;:
+                        banList.ComUnban(e, words);
+                        break;
 
-					case &quot;springie&quot;:
-						ComSpringie(e, words);
-						break;
+                    case &quot;smurfs&quot;:
+                        RemoteCommand(Stats.smurfScript, e, words);
+                        break;
 
-					case &quot;endvote&quot;:
-						StopVote();
-						SayBattle(&quot;poll cancelled&quot;);
-						break;
+                    case &quot;stats&quot;:
+                        RemoteCommand(Stats.statsScript, e, words);
+                        break;
 
-					case &quot;addbox&quot;:
-						ComAddBox(e, words);
-						break;
+                    case &quot;kickspec&quot;:
+                        ComKickSpec(e, words);
+                        break;
 
-					case &quot;clearbox&quot;:
-						ComClearBox(e, words);
-						break;
+                    case &quot;manage&quot;:
+                        ComManage(e, words);
+                        break;
 
-					case &quot;listpresets&quot;:
-						ComListPresets(e, words);
-						break;
+                    case &quot;notify&quot;:
+                        ComNotify(e, words);
+                        break;
 
-					case &quot;presetdetails&quot;:
-						ComPresetDetails(e, words);
-						break;
+                    case &quot;votekickspec&quot;:
+                        StartVote(new VoteKickSpec(tas, spring, this), e, words);
+                        break;
 
-					case &quot;preset&quot;:
-						ComPreset(e, words);
-						break;
+                    case &quot;boss&quot;:
+                        ComBoss(e, words);
+                        break;
 
-					case &quot;cbalance&quot;:
-						ComCBalance(e, words);
-						break;
+                    case &quot;voteboss&quot;:
+                        StartVote(new VoteBoss(tas, spring, this), e, words);
+                        break;
 
-					case &quot;listbans&quot;:
-						banList.ComListBans(e, words);
-						break;
+                    case &quot;setpassword&quot;:
+                        ComSetPassword(e, words);
+                        break;
 
-					case &quot;ban&quot;:
-						banList.ComBan(e, words);
-						break;
+                    case &quot;setgametitle&quot;:
+                        ComSetGameTitle(e, words);
+                        break;
 
-					case &quot;unban&quot;:
-						banList.ComUnban(e, words);
-						break;
+                    case &quot;setminrank&quot;:
+                        ComSetMinRank(e, words);
+                        break;
 
-					case &quot;smurfs&quot;:
-						RemoteCommand(Stats.smurfScript, e, words);
-						break;
+                    case &quot;setmaxplayers&quot;:
+                        ComSetMaxPlayers(e, words);
+                        break;
 
-					case &quot;stats&quot;:
-						RemoteCommand(Stats.statsScript, e, words);
-						break;
+                    case &quot;mincpuspeed&quot;:
+                        ComSetMinCpuSpeed(e, words);
+                        break;
 
-					case &quot;kickspec&quot;:
-						ComKickSpec(e, words);
-						break;
+                    case &quot;autolock&quot;:
+                        ComAutoLock(e, words);
+                        break;
 
-					case &quot;manage&quot;:
-						ComManage(e, words);
-						break;
+                    case &quot;spec&quot;:
+                        ComForceSpectator(e, words);
+                        break;
 
-					case &quot;notify&quot;:
-						ComNotify(e, words);
-						break;
+                    case &quot;specafk&quot;:
+                        ComForceSpectatorAfk(e, words);
+                        break;
 
-					case &quot;votekickspec&quot;:
-						StartVote(new VoteKickSpec(tas, spring, this), e, words);
-						break;
+                    case &quot;kickminrank&quot;:
+                        ComKickMinRank(e, words);
+                        break;
 
-					case &quot;boss&quot;:
-						ComBoss(e, words);
-						break;
+                    case &quot;cheats&quot;:
+                        if (spring.IsRunning) {
+                            spring.SayGame(&quot;/cheat&quot;);
+                            SayBattle(&quot;Cheats!&quot;);
+                        } else Respond(e, &quot;Cannot set cheats, game not running&quot;);
+                        break;
 
-					case &quot;voteboss&quot;:
-						StartVote(new VoteBoss(tas, spring, this), e, words);
-						break;
+                    case &quot;listoptions&quot;:
+                        ComListOptions(e, words);
+                        break;
 
-					case &quot;setpassword&quot;:
-						ComSetPassword(e, words);
-						break;
+                    case &quot;setoptions&quot;:
+                        ComSetOption(e, words);
+                        break;
 
-					case &quot;setgametitle&quot;:
-						ComSetGameTitle(e, words);
-						break;
+                    case &quot;votesetoptions&quot;:
+                        StartVote(new VoteSetOptions(tas, spring, this), e, words);
+                        break;
 
-					case &quot;setminrank&quot;:
-						ComSetMinRank(e, words);
-						break;
+                    case &quot;listplanets&quot;:
+                        if (Program.main.PlanetWars != null) Program.main.PlanetWars.ComListPlanets(e, words);
+                        else Respond(e, &quot;Not a PlanetWars server&quot;);
+                        break;
 
-					case &quot;setmaxplayers&quot;:
-						ComSetMaxPlayers(e, words);
-						break;
+                    case &quot;register&quot;:
+                        if (Program.main.PlanetWars != null) Program.main.PlanetWars.ComRegister(e, words);
+                        else Respond(e, &quot;Not a PlanetWars autohost&quot;);
+                        break;
 
-					case &quot;mincpuspeed&quot;:
-						ComSetMinCpuSpeed(e, words);
-						break;
 
-					case &quot;autolock&quot;:
-						ComAutoLock(e, words);
-						break;
+                    case &quot;planet&quot;:
+                        if (Program.main.PlanetWars != null) Program.main.PlanetWars.ComPlanet(e, words);
+                        else Respond(e, &quot;Not a PlanetWars server&quot;);
+                        break;
 
-					case &quot;spec&quot;:
-						ComForceSpectator(e, words);
-						break;
+                    case &quot;setpwserver&quot;:
+                        if (words.Length &lt; 1) Respond(e, &quot;Specify address&quot;);
+                        else {
+                            // hack this is just debug, remove this later
+                            Program.main.config.PlanetWarsServer = words[0];
+                            Program.main.InitializePlanetWarsServer();
+                            Respond(e, &quot;Planetwars server changed to &quot; + words[0]);
+                        }
+                        break;
 
-					case &quot;specafk&quot;:
-						ComForceSpectatorAfk(e, words);
-						break;
-
-					case &quot;kickminrank&quot;:
-						ComKickMinRank(e, words);
-						break;
-
-					case &quot;cheats&quot;:
-						if (spring.IsRunning) {
-							spring.SayGame(&quot;/cheat&quot;);
-							SayBattle( &quot;Cheats!&quot;);
-						} else {
-							Respond(e, &quot;Cannot set cheats, game not running&quot;);
-						}
-						break;
-
-					case &quot;listoptions&quot;:
-						ComListOptions(e, words);
-						break;
-
-					case &quot;setoptions&quot;:
-						ComSetOption(e, words);
-						break;
-
-					case &quot;votesetoptions&quot;:
-						StartVote(new VoteSetOptions(tas, spring, this), e, words);
-						break;
-
-					case &quot;listplanets&quot;:
-						ComListPlanets(e, words);
-						break;
-
-					case &quot;register&quot;:
-						ComRegister(e, words);
-						break;
-
-
-					case &quot;planet&quot;:
-						ComPlanet(e, words);
-						break;
-
-					case &quot;setpwserver&quot;:
-						if (words.Length &lt; 1) Respond(e, &quot;Specify address&quot;);
-						else {
-							// hack this is just debug, remove this later
-							Program.main.config.PlanetWarsServer = words[0];
-							Program.main.InitializePlanetWarsServer();
-							Respond(e, &quot;Planetwars server changed to &quot; + words[0]);
-						}
-						break;
-
-					case &quot;voteplanet&quot;:
-						if (Program.main.config.PlanetWarsEnabled) StartVote(new VotePlanet(tas, spring, this), e, words);
-						else Respond(e, &quot;PlanetWars not enabled on this host&quot;);
-						break;
+                    case &quot;voteplanet&quot;:
+                        if (Program.main.config.PlanetWarsEnabled) StartVote(new VotePlanet(tas, spring, this), e, words);
+                        else Respond(e, &quot;PlanetWars not enabled on this host&quot;);
+                        break;
                     case &quot;resetpassword&quot;:
-                        if (Program.main.config.PlanetWarsEnabled) Respond(e, Program.main.PlanetWars.ResetPassword(Program.main.PlanetwarsAccount, e.UserName)); else Respond(e, &quot;This is not a PlanetWars autohost&quot;);
+                        if (Program.main.PlanetWars != null) Program.main.PlanetWars.ComResetPassword(e);
+                        else Respond(e, &quot;This is not PlanetWars autohost&quot;);
 
                         break;
-				}
-			}
-		}
+                }
+            }
+        }
 
-		private void tas_UserStatusChanged(object sender, TasEventArgs e)
-		{
-			if (spring.IsRunning) {
-				var b = tas.GetBattle();
-				if (e.ServerParams[0] != tas.UserName &amp;&amp; b.ContainsUser(e.ServerParams[0])) CheckForBattleExit();
-			}
-		}
+        private void tas_UserStatusChanged(object sender, TasEventArgs e)
+        {
+            if (spring.IsRunning) {
+                var b = tas.GetBattle();
+                if (e.ServerParams[0] != tas.UserName &amp;&amp; b.ContainsUser(e.ServerParams[0])) CheckForBattleExit();
+            }
+        }
 
-		#endregion
-	}
+        #endregion
+    }
 }
\ No newline at end of file

Modified: Lobby/springie/Springie/autohost/AutoHost_commands.cs
===================================================================
--- Lobby/springie/Springie/autohost/AutoHost_commands.cs	2008-12-04 13:11:49 UTC (rev 7116)
+++ Lobby/springie/Springie/autohost/AutoHost_commands.cs	2008-12-04 16:31:25 UTC (rev 7117)
@@ -481,7 +481,7 @@
         SayBattle(&quot;cannot start, &quot; + usname + &quot; not ready and synced&quot;);
         return;
       }*/
-            if (CheckAndSendPlanetWarsStart(e)) {
+            if (Program.main.PlanetWars == null || Program.main.PlanetWars.StartGame(e)) {
                 SayBattle(&quot;please wait, game is about to start&quot;);
 
                 StopVote();
@@ -730,7 +730,7 @@
                 return;
             }
 
-            if (CheckAndSendPlanetWarsStart(e)) {
+            if (Program.main.PlanetWars == null || Program.main.PlanetWars.StartGame(e)) {
                 SayBattle(&quot;please wait, game is about to start&quot;);
 
                 StopVote();
@@ -848,26 +848,7 @@
             return Filter(temp, words, out vals, out indexes);
         }
 
-        public int FilterPlanets(string[] words, out string[] vals, out int[] indexes)
-        {
-            var pw = Program.main.PlanetWars;
-            var options = pw.GetAttackOptions();
 
-            if (options != null) {
-                var temp = new string[options.Count];
-                int cnt = 0;
-
-                foreach (var planet in options) temp[cnt++] = planet.Name;
-                return Filter(temp, words, out vals, out indexes);
-            } else {
-                vals = null;
-                indexes = null;
-                return 0;
-            }
-            
-        }
-
-
         internal static int FilterPresets(string[] words, AutoHost autohost, out string[] vals, out int[] indexes)
         {
             var temp = new string[autohost.presets.Count];
@@ -930,65 +911,8 @@
 
         #region Other methods
 
-        private bool CheckAndSendPlanetWarsStart(TasSayEventArgs e)
-        {
-            if (Program.main.config.PlanetWarsEnabled) {
-                try {
-                    var pw = Program.main.PlanetWars;
-                    string currentMapName = tas.GetBattle().Map.Name;
-                    var planet = pw.GetAttackOptions().Where(p =&gt; p.MapName == currentMapName).SingleOrDefault();
 
-                    if (planet == null) {
-                        SayBattle(&quot;This planet is not currently allowed, select another one&quot;);
-                        return false;
-                    }
 
-                    var factions = pw.GetFactions();
-
-                    var actual = new List&lt;IPlayer&gt;();
-                    foreach (var user in tas.GetBattle().Users) {
-                        if (!user.IsSpectator) {
-                            var info = pw.GetPlayerInfo(user.name);
-                            actual.Add(info);
-                            string side = tas.GetBattle().Mod.Sides[user.Side];
-                            string hisSide = factions.Where(f =&gt; f.Name == info.FactionName).Single().SpringSide;
-
-                            if (!string.Equals(side, hisSide, StringComparison.InvariantCultureIgnoreCase)) {
-                                SayBattle(string.Format(&quot;{0} must switch to {1}&quot;, user.name, hisSide), false);
-                                return false;
-                            }
-                        }
-                    }
-
-
-                    string options = pw.GetStartupModOptions(Program.main.PlanetwarsAccount, tas.GetBattle().Map.Name, actual);
-                    //SayBattle(Encoding.ASCII.GetString(Convert.FromBase64String(options.Replace(&quot;+&quot;, &quot;=&quot;))));
-                    var b = tas.GetBattle();
-                    foreach (var o in b.Mod.Options) {
-                        if (o.Key == &quot;planetwars&quot;) {
-                            string res;
-                            if (o.GetPair(options, out res)) {
-                                tas.SetScriptTag(res);
-
-                                var startEvent = pw.GetPlayersToNotify(Program.main.PlanetwarsAccount, currentMapName, ReminderEvent.OnBattleStarted);
-                                foreach (string s in startEvent) tas.Say(TasClient.SayPlace.User, s, string.Format(&quot;PlanetWars battle for planet {0} owned by {1} is starting.&quot;, planet.Name, planet.OwnerName), false);
-
-                                return true;
-                            } else {
-                                Respond(e, &quot;Eror setting script tag&quot;);
-                                return false;
-                            }
-                        }
-                    }
-                    Respond(e, &quot;This mod does not support PlanetWars&quot;);
-                    return false;
-                } catch (Exception ex) {
-                    SayBattle(string.Format(&quot;Error when checking PlanetWars teams: {0}&quot;, ex), false);
-                    return false;
-                }
-            } else return true;
-        }
-
         private void ComAdmins(TasSayEventArgs e, string[] words)
         {
             tas.Say(TasClient.SayPlace.User, e.UserName, &quot;---&quot;, false);
@@ -1058,23 +982,6 @@
             else foreach (var opt in b.Mod.Options) Respond(e, opt.ToString());
         }
 
-        public void ComListPlanets(TasSayEventArgs e, string[] words)
-        {
-            string[] vals;
-            int[] indexes;
-            if (!Program.main.config.PlanetWarsEnabled) {
-                Respond(e, &quot;This is not PlanetWars host&quot;);
-                return;
-            }
-            try {
-                if (FilterPlanets(words, out vals, out indexes) &gt; 0) {
-                    Respond(e, &quot;Planets available for attack are:&quot;);
-                    for (int i = 0; i &lt; vals.Length; ++i) Respond(e, string.Format(&quot;{0}: {1}&quot;, indexes[i], vals[i]));
-                } else Respond(e, &quot;no such planet found&quot;);
-            } catch (Exception ex) {
-                Respond(e, string.Format(&quot;Error getting planets: {0}&quot;, ex));
-            }
-        }
 
         private void ComListPresets(TasSayEventArgs e, string[] words)
         {
@@ -1109,74 +1016,8 @@
             Respond(e, &quot;I will notify you when game ends&quot;);
         }
 
-        private void ComPlanet(TasSayEventArgs e, string[] words)
-        {
-            if (!Program.main.config.PlanetWarsEnabled) {
-                Respond(e, &quot;This is not a PlanetWars host&quot;);
-                return;
-            }
 
-            if (words.Length == 0) {
-                Respond(e, &quot;You must specify planet name&quot;);
-                return;
-            }
-            string[] vals;
-            int[] indexes;
-            if (FilterPlanets(words, out vals, out indexes) &gt; 0) {
-                var pw = Program.main.PlanetWars;
-                var info = pw.GetPlayerInfo(e.UserName);
-                var fact = pw.GetOffensiveFaction();
-                var canset = false;
-                string bestPlayer = &quot;&quot;;
-                if (info != null) {
-                    if (info.IsCommanderInChief) canset = true;
-                    else {
-                        canset = true;
-                        int bestRank = info.RankOrder;
-                        foreach (var u in tas.GetBattle().Users) {
-                            if (!u.IsSpectator &amp;&amp; u.name != e.UserName &amp;&amp; tas.GetBattle().Mod.Sides[u.Side].ToLower() == info.FactionName.ToLower()) {
-                                var pi = pw.GetPlayerInfo(u.name);
-                                if (pi != null &amp;&amp; pi.RankOrder &lt; bestRank) { // someone sle with better rank exists
-                                    bestPlayer = pi.Name;
-                                    bestRank = pi.RankOrder;
-                                    canset = false;
-                               }
-                            }
-                        }
 
-                    }
-                }
-                
-                if (canset) {
-                    if (info.FactionName == fact.Name) {
-                        SayBattle(string.Format(&quot;changing planet to {0} by {1}&quot;, vals[0], e.UserName));
-                        var planet = pw.GetAttackOptions().Where(m =&gt; m.Name == vals[0]).Single();
-                        tas.ChangeMap(spring.UnitSyncWrapper.MapList[planet.MapName]);
-                    } else Respond(e, string.Format(&quot;It's currently {0} turn&quot;, fact.Name));
-                } else Respond(e, string.Format(&quot;You are not first in command here, {0} must do it!&quot;, bestPlayer));
-            } else Respond(e, &quot;Cannot find such planet.&quot;);
-        }
-
-        private void ComRegister(TasSayEventArgs e, string[] words)
-        {
-            if (!Program.main.config.PlanetWarsEnabled) {
-                Respond(e, &quot;This is not PlanetWars host&quot;);
-                return;
-            }
-            if (words.Length &lt; 2) {
-                Respond(e, &quot;This command needs 2-3 parameters - side and password and optional planet name (you can PM it to me). Eg. !register core secretpw&quot;);
-                return;
-            }
-
-            try {
-                var pw = Program.main.PlanetWars;
-                string response = pw.Register(Program.main.PlanetwarsAccount, new AuthInfo { Login = e.UserName, Password = words[1] }, words[0], words.Length &gt; 2 ? Utils.Glue(words, 2) : null); 
-                Respond(e, string.Format(response));
-            } catch (Exception ex) {
-                Respond(e, string.Format(&quot;Error when registering: {0}&quot;, ex));
-            }
-        }
-
         private void ComSetGameTitle(TasSayEventArgs e, string[] words)
         {
             if (words.Length == 0) Respond(e, &quot;this command needs one parameter - new game title&quot;);
@@ -1359,4 +1200,4 @@
 
         #endregion
     }
-}
\ No newline at end of file
+}

Modified: Lobby/springie/Springie/autohost/Polls.cs
===================================================================
--- Lobby/springie/Springie/autohost/Polls.cs	2008-12-04 13:11:49 UTC (rev 7116)
+++ Lobby/springie/Springie/autohost/Polls.cs	2008-12-04 16:31:25 UTC (rev 7117)
@@ -709,8 +709,8 @@
 			this.spring = spring;
 			this.ah = ah;
 
-			var pw = Program.main.PlanetWars;
-			var fact = pw.GetOffensiveFaction();
+		    var pw = Program.main.PlanetWars.server;
+            var fact = pw.GetOffensiveFaction(Program.main.PlanetWars.account);
 			faction = fact.Name;
 
 			users.Clear();
@@ -720,7 +720,7 @@
 			var b = tas.GetBattle();
 			if (b != null) {
 				foreach (var us in b.Users) {
-					if (us.name != tas.UserName &amp;&amp; !us.IsSpectator &amp;&amp; pw.GetPlayerInfo(us.name).FactionName == faction) {
+                    if (us.name != tas.UserName &amp;&amp; !us.IsSpectator &amp;&amp; pw.GetPlayerInfo(Program.main.PlanetWars.account, us.name).FactionName == faction) {
 						users.Add(us.name);
 						votes.Add(0);
 						initialUserCount++;
@@ -741,7 +741,7 @@
 			}
 			string[] vals;
 			int[] indexes;
-			if (ah.FilterPlanets(words, out vals, out indexes) &gt; 0) {
+			if (Program.main.PlanetWars.FilterPlanets(words, out vals, out indexes) &gt; 0) {
 				planet = vals[0];
 				ah.SayBattle(string.Format(&quot;Do you want to change planet to {0}? !vote 1 = yes, !vote 2 = no&quot;, planet));
 				return true;
@@ -754,12 +754,12 @@
 		public bool Vote(TasSayEventArgs e, string[] words)
 		{
 			int vote;
-			var pw = Program.main.PlanetWars;
+		    var pw = Program.main.PlanetWars.server;
 
 
 			if (e.UserName != &quot;&quot;) {
 				// this is needed due to &quot;timeout&quot; hackthing with vote
-				var info = pw.GetPlayerInfo(e.UserName);
+                var info = pw.GetPlayerInfo(Program.main.PlanetWars.account, e.UserName);
 
 				if (info == null || info.FactionName != faction) {
 					AutoHost.Respond(tas, spring, e, string.Format(&quot;{0}, it's not your faction's turn&quot;, e.UserName));
@@ -776,7 +776,7 @@
 			if (CheckEnd(out winVote)) {
 				if (winVote == 1) {
 					ah.SayBattle(&quot;vote successful - changing planet to &quot; + planet);
-					var sel = pw.GetAttackOptions().Where(p =&gt; p.Name == planet).Single();
+                    var sel = pw.GetAttackOptions(Program.main.PlanetWars.account).Where(p =&gt; p.Name == planet).Single();
 					tas.ChangeMap(spring.UnitSyncWrapper.MapList[sel.MapName]);
 				} else ah.SayBattle(&quot;not enough votes, planet stays&quot;);
 				return true;
@@ -785,4 +785,4 @@
 
 		#endregion
 	}
-}
\ No newline at end of file
+}

Modified: Lobby/springie/Springie/client/TasClient.cs
===================================================================
--- Lobby/springie/Springie/client/TasClient.cs	2008-12-04 13:11:49 UTC (rev 7116)
+++ Lobby/springie/Springie/client/TasClient.cs	2008-12-04 16:31:25 UTC (rev 7117)
@@ -887,6 +887,7 @@
 		private void RaiseFailure(object sender, TasEventArgs args)
 		{
 			if (Failure != null) Failure(this, args);
+            Console.Out.Flush();
 		}
 
 		private void udpPunchingTimer_Elapsed(object sender, ElapsedEventArgs e)
@@ -896,4 +897,4 @@
 
 		#endregion
 	}
-}
\ No newline at end of file
+}

Modified: Lobby/springie/Springie/spring/Spring.cs
===================================================================
--- Lobby/springie/Springie/spring/Spring.cs	2008-12-04 13:11:49 UTC (rev 7116)
+++ Lobby/springie/Springie/spring/Spring.cs	2008-12-04 16:31:25 UTC (rev 7117)
@@ -236,48 +236,7 @@
             PlanetWarsMessages[e.Text] = count;
             if (count != 2) return; // only send if count matches 2 exactly
 
-            //Program.main.AutoHost.SayBattle(&quot;dbg mes:&quot; + e.Text);
-
-            // awards
-            const string awardPrefix = &quot;pwaward:&quot;;
-            if (e.Text.StartsWith(awardPrefix))
-            {
-                string substr = e.Text.Substring(awardPrefix.Length);
-                if (!string.IsNullOrEmpty(substr))
-                {
-                    try
-                    {
-                        var parts = substr.Split(new[] { ' ' }, 3);
-                        string name = parts[0];
-                        string awardType = parts[1];
-                        string awardText = parts[2];
-                        Program.main.AutoHost.SayBattle(string.Format(&quot;Award for {0} - {1}&quot;, name, awardText));
-                        Program.main.PlanetWars.AddAward(Program.main.PlanetwarsAccount, name, awardType, awardText, Program.main.Tas.GetBattle().Map.Name);
-                        return;
-                    }
-                    catch (Exception ex)
-                    {
-                        Program.main.AutoHost.SayBattle(&quot;Error sending data:&quot; + ex);
-                    }
-                }
-            }
-
-
-            // deployment
-            const string pwPrefix = &quot;pwdeploy:&quot;;
-            if (e.Text.StartsWith(pwPrefix)) {
-                string substr = e.Text.Substring(pwPrefix.Length);
-                var parts = substr.Split(new char[] {','});
-                if (!string.IsNullOrEmpty(substr)) {
-                    try {
-                        Program.main.PlanetWars.UnitDeployed(Program.main.PlanetwarsAccount, Program.main.Tas.GetBattle().Map.Name, parts[0], parts[1], (int)double.Parse(parts[2]), (int)double.Parse(parts[3]), parts[4]);
-                        return;
-                    } catch (Exception ex) {
-                        Program.main.AutoHost.SayBattle(&quot;Error sending data:&quot; + ex);
-                    }
-                }
-            }
-
+            if (Program.main.PlanetWars != null) Program.main.PlanetWars.SpringMessage(e.Text);
         }
 
         #endregion

Deleted: Lobby/springie/Springie/utils/FileDownloader.cs
===================================================================
--- Lobby/springie/Springie/utils/FileDownloader.cs	2008-12-04 13:11:49 UTC (rev 7116)
+++ Lobby/springie/Springie/utils/FileDownloader.cs	2008-12-04 16:31:25 UTC (rev 7117)
@@ -1,200 +0,0 @@
-#region using
-
-using System;
-using System.Collections.Generic;
-using System.Net;
-using System.Text.RegularExpressions;
-using System.Threading;
-using Springie.SpringNamespace;
-
-#endregion
-
-namespace Springie
-{
-	/// &lt;summary&gt;
-	/// Class responsible for downloading new Mods to spring
-	/// &lt;/summary&gt;
-	internal class FileDownloader
-	{
-		#region FileType enum
-
-		/// &lt;summary&gt;
-		/// Download progress has changed
-		/// &lt;/summary&gt;
-		//public event EventHandler&lt;TasEventArgs&gt; DownloadProgressChanged;
-		/// &lt;summary&gt;
-		/// How often to report progresschanged (in percents)
-		/// &lt;/summary&gt;
-		//public const int ReportPercentStep = 20;
-		public enum FileType
-		{
-			Map,
-			Mod
-		}
-
-		#endregion
-
-		#region Status enum
-
-		public enum Status
-		{
-			Done,
-			Failed
-		} ;
-
-		#endregion
-
-		#region Fields
-
-		private DownloadItem currentDownload;
-		private Queue&lt;DownloadItem&gt; downloadQueue = new Queue&lt;DownloadItem&gt;();
-		private Thread downloadThread;
-
-		/************************************************************************/
-		/*    PRIVATE ATTRIBS                                                   */
-		/************************************************************************/
-
-		private Spring spring;
-		private WebClient wc;
-
-		#endregion
-
-		/************************************************************************/
-		/*    PUBLIC METHODS                                                    */
-		/************************************************************************/
-
-		#region Events
-
-		/// &lt;summary&gt;
-		/// Download completed (either successfully or unsuccessfully)
-		/// &lt;/summary&gt;
-		public event EventHandler&lt;DownloadEventArgs&gt; DownloadCompleted;
-
-		#endregion
-
-		#region Constructors
-
-		/// &lt;summary&gt;
-		/// Initializes Mod downloader
-		/// &lt;/summary&gt;
-		public FileDownloader(Spring spring)
-		{
-			this.spring = spring;
-		}
-
-		#endregion
-
-		#region Public methods
-
-		#endregion
-
-		/************************************************************************/
-		/*     EVENT HANDLERS                                                   */
-		/************************************************************************/
-		/*void wc_DownloadProgressChanged(object sender, DownloadProgressChangedEventArgs e)
-    {
-      if (e.ProgressPercentage &gt;= lastPercent + ReportPercentStep) {
-        lastPercent = (e.ProgressPercentage / ReportPercentStep) * ReportPercentStep;
-        if (DownloadProgressChanged != null) DownloadProgressChanged(this, new TasEventArgs(currentDownload.fileName, e.ProgressPercentage.ToString()));
-      }
-    }
-
-
-    void wc_DownloadFileCompleted(object sender, System.ComponentModel.AsyncCompletedEventArgs e)
-    {
-      if (e.Error != null || e.Cancelled) {
-        string ername = e.Error != null ? e.Error.Message : &quot;cancelled&quot;;
-        if (DownloadCompleted != null) DownloadCompleted(this, new TasEventArgs(currentDownload.fileName, ername));
-      } else if (DownloadCompleted != null) DownloadCompleted(this, new TasEventArgs(currentDownload.fileName));
-      GetNext();
-    }*/
-
-		/************************************************************************/
-		/*     STATIC METHODS                                                   */
-		/************************************************************************/
-
-
-		/************************************************************6************/
-		/*    PRIVATE METHODS                                                   */
-		/************************************************************************/
-
-		#region Other methods
-
-		/// &lt;summary&gt;
-		/// Tries to handle next request from queue
-		/// &lt;/summary&gt;
-		private void GetNext()
-		{
-			if (downloadQueue.Count == 0 || wc.IsBusy) return;
-
-			currentDownload = downloadQueue.Dequeue();
-			// lastPercent = 0;
-			try {
-				wc.DownloadFile(currentDownload.url, currentDownload.targetPath + &quot;/&quot; + currentDownload.fileName);
-
-				if (DownloadCompleted != null) DownloadCompleted(this, new DownloadEventArgs(currentDownload, Status.Done, &quot;&quot;));
-			} catch (Exception e) {
-				if (DownloadCompleted != null) DownloadCompleted(this, new DownloadEventArgs(currentDownload, Status.Failed, e.Message));
-			}
-			GetNext();
-
-			//wc.DownloadFileAsync(currentDownload.url, currentDownload.targetPath + &quot;/&quot; + currentDownload.fileName);
-		}
-
-		#endregion
-
-		#region Nested type: DownloadEventArgs
-
-		public class DownloadEventArgs : EventArgs
-		{
-			#region Properties
-
-			public DownloadItem DownloadItem;
-			public string Message;
-			public Status Status;
-
-			#endregion
-
-			#region Constructors
-
-			public DownloadEventArgs(DownloadItem item, Status status, string message)
-			{
-				DownloadItem = item;
-				Status = status;
-				Message = message;
-			}
-
-			#endregion
-		}
-
-		#endregion
-
-		#region Nested type: DownloadItem
-
-		public class DownloadItem
-		{
-			#region Properties
-
-			public string fileName;
-			public FileType fileType;
-			public string targetPath;
-			public Uri url;
-
-			#endregion
-
-			#region Constructors
-
-			public DownloadItem() {}
-
-			public DownloadItem(FileType fileType, string fileName)
-			{
-				this.fileType = fileType;
-				this.fileName = fileName;
-			}
-
-			#endregion
-		} ;
-
-		#endregion
-	}
-}
\ No newline at end of file

Modified: Lobby/springie/Springie/utils/Stats.cs
===================================================================
--- Lobby/springie/Springie/utils/Stats.cs	2008-12-04 13:11:49 UTC (rev 7116)
+++ Lobby/springie/Springie/utils/Stats.cs	2008-12-04 16:31:25 UTC (rev 7117)
@@ -181,33 +181,8 @@
 
 			foreach (var p in players.Values) query += &quot;&amp;player[]=&quot; + p;
 
-			if (Program.main.config.PlanetWarsEnabled) {
-                try {
-                    var pw = Program.main.PlanetWars;
+            if (Program.main.PlanetWars != null) Program.main.PlanetWars.SendBattleResult(battle, players);
 
-                    foreach (var p in players.Values) {
-                        //Program.main.AutoHost.SayBattle(string.Format(&quot;Player: {0}, victory:{1}, alive till end: {2}, side:{3}, spec:{4}&quot;, p.Name, p.OnVictoryTeam, p.AliveTillEnd, p.Side, p.Spectator));
-                    }
-
-                    ICollection&lt;RankNotification&gt; notifications;
-                    var response = pw.SendBattleResult(Program.main.PlanetwarsAccount, battle.Map.Name, players.Values);
-
-
-                    Program.main.AutoHost.SayBattle(response.MessageToDisplay);
-                    var users = tas.GetBattle().Users;
-                    foreach (var p in players.Values) if (p.Name != tas.UserName &amp;&amp; users.Find(x =&gt; x.name == p.Name) == null) tas.Say(TasClient.SayPlace.User, p.Name, response.MessageToDisplay, false);
-
-                    foreach (var kvp in response.RankNotifications) tas.Say(TasClient.SayPlace.User, kvp.Name, kvp.Text, false);
-
-                    var toNotify = pw.GetPlayersToNotify(Program.main.PlanetwarsAccount, battle.Map.Name, ReminderEvent.OnBattleEnded);
-                    foreach (string s in toNotify) tas.Say(TasClient.SayPlace.User, s, &quot;PlanetWars battle has just ended.&quot;, false);
-                    Program.main.AutoHost.ComListPlanets(TasSayEventArgs.Default, new string[] {});
-                }  catch (Exception ex)
-                {
-                    Program.main.AutoHost.SayBattle(string.Format(&quot;Error sending planet battle result :(( {0}&quot;, ex), true);
-                }
-			}
-
 			// send only if there were at least 2 players in game
 			if (players.Count &gt; 1) SendCommand(gatherScript, query, true, true);
 		}

Modified: Lobby/springie/libs/PlanetWarsShared.dll
===================================================================
(Binary files differ)


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001885.html">[Taspring-linux-commit] r7116 - in Lobby/TASClient: . Interface
</A></li>
	<LI>Next message: <A HREF="001887.html">[Taspring-linux-commit] r7118 - Lobby/TASClient
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1886">[ date ]</a>
              <a href="thread.html#1886">[ thread ]</a>
              <a href="subject.html#1886">[ subject ]</a>
              <a href="author.html#1886">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
