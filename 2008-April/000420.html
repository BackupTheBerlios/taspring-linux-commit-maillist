<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r5639 - trunk/Lobby/TASClient
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-April/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5639%20-%20trunk/Lobby/TASClient&In-Reply-To=%3C20080401134708.2C29046AE%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000419.html">
   <LINK REL="Next"  HREF="000421.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r5639 - trunk/Lobby/TASClient</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5639%20-%20trunk/Lobby/TASClient&In-Reply-To=%3C20080401134708.2C29046AE%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r5639 - trunk/Lobby/TASClient">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Tue Apr  1 15:47:08 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000419.html">[Taspring-linux-commit] r5638 - in trunk/rts: Lua Sim/MoveTypes	Sim/Units
</A></li>
        <LI>Next message: <A HREF="000421.html">[Taspring-linux-commit] r5640 - in trunk/rts: Game Game/UI Lua	Rendering Rendering/GL Rendering/UnitModels Sim/Units System
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#420">[ date ]</a>
              <a href="thread.html#420">[ thread ]</a>
              <a href="subject.html#420">[ subject ]</a>
              <a href="author.html#420">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: satirik
Date: 2008-04-01 15:47:07 +0200 (Tue, 01 Apr 2008)
New Revision: 5639

Modified:
   trunk/Lobby/TASClient/BattleFormUnit.pas
   trunk/Lobby/TASClient/HostBattleFormUnit.pas
   trunk/Lobby/TASClient/MainUnit.dfm
   trunk/Lobby/TASClient/MainUnit.pas
   trunk/Lobby/TASClient/Misc.pas
   trunk/Lobby/TASClient/StringParser.pas
   trunk/Lobby/TASClient/TASClient.dof
   trunk/Lobby/TASClient/TASClient.res
Log:
- limited utf8 support, every output commands are sent in utf8 format, every input commands are utf8decoded, the interface only supports utf8 in chat, few commands (like /msg etc) and battle description ... more to come
- /hook optionalparam and /quit msg added for aegis lobby server

Modified: trunk/Lobby/TASClient/BattleFormUnit.pas
===================================================================
--- trunk/Lobby/TASClient/BattleFormUnit.pas	2008-04-01 08:25:01 UTC (rev 5638)
+++ trunk/Lobby/TASClient/BattleFormUnit.pas	2008-04-01 13:47:07 UTC (rev 5639)
@@ -24,7 +24,7 @@
   ImageEx, JvSticker, JvExExtCtrls, JvImage, JvShape, JvLabel, TBXLists,
   SpTBXLists, ImgList, SpTBXjanTracker, SpTBXFormPopupMenu,IniFiles,
   HttpProt,MsMultiPartFormData, JvComponentBase, JvDSADialogs, Spin, Mask,
-  JvExMask, JvSpin, TntStdCtrls, TntForms, TntComCtrls,RichEdit;
+  JvExMask, JvSpin, TntStdCtrls, TntForms, TntComCtrls,RichEdit,JclUnicode;
 
 type
 
@@ -284,7 +284,7 @@
     procedure CreateParams(var Params: TCreateParams); override;
 
     function IsBattleActive: Boolean;
-    procedure AddTextToChat(Text: string; Color: TColor; ChatTextPos: Integer);
+    procedure AddTextToChat(Text: WideString; Color: TColor; ChatTextPos: Integer);
     procedure UpdateClientsListBox;
     function GetMyBattleStatus: Integer;
     procedure SetMyBattleStatus(Side: Integer; Ready: Boolean; TeamNo: Integer; AllyNo: Integer; Mode: Integer);
@@ -479,7 +479,7 @@
     procedure btLoadDefaultMDOClick(Sender: TObject);
     procedure btLoadDefaultMPOClick(Sender: TObject);
   private
-    History: TStringList;
+    History: TWideStringList;
     HistoryIndex: Integer;
 
     SortedClientList : TList;
@@ -721,9 +721,9 @@
 end;
 
 { for ChatTextPos argument, see MainForm's AddTextToChatWindow method's comments }
-procedure TBattleForm.AddTextToChat(Text: string; Color: TColor; ChatTextPos: Integer);
+procedure TBattleForm.AddTextToChat(Text: WideString; Color: TColor; ChatTextPos: Integer);
 var
-  s: string;
+  s: WideString;
 begin
   if Preferences.TimeStamps then
   begin
@@ -2318,7 +2318,7 @@
     Panel1.Height := Panel1.Height + 20;
   end;
 
-  History := TStringList.Create;
+  History := TWideStringList.Create;
   HistoryIndex := -1;
 
   BattleReplayInfo.Script := TStringList.Create;
@@ -3158,12 +3158,12 @@
 procedure TBattleForm.InputEditKeyDown(Sender: TObject; var Key: Word;
   Shift: TShiftState);
 var
-  s: string;
+  s: WideString;
 begin
   if Key = 13 then
   begin
-    s := (Sender as TEdit).Text;
-    (Sender as TEdit).Text := '';
+    s := (Sender as TSpTBXEdit).Text;
+    (Sender as TSpTBXEdit).Text := '';
     if s = '' then Exit;
 
     History.Add(s);
@@ -3182,21 +3182,21 @@
   begin
     if History.Count = 0 then Exit;
     HistoryIndex := Max(0, HistoryIndex - 1);
-    (Sender as TEdit).Text := History[HistoryIndex];
-    (Sender as TEdit).SelStart := Length((Sender as TEdit).Text);
+    (Sender as TSpTBXEdit).Text := History[HistoryIndex];
+    (Sender as TSpTBXEdit).SelStart := Length((Sender as TSpTBXEdit).Text);
     Key := 0;
   end
   else if Key = VK_DOWN then
   begin
     if History.Count = 0 then Exit;
     HistoryIndex := Min(History.Count-1, HistoryIndex + 1);
-    (Sender as TEdit).Text := History[HistoryIndex];
-    (Sender as TEdit).SelStart := Length((Sender as TEdit).Text);
+    (Sender as TSpTBXEdit).Text := History[HistoryIndex];
+    (Sender as TSpTBXEdit).SelStart := Length((Sender as TSpTBXEdit).Text);
     Key := 0;
   end
   else if Key = VK_ESCAPE then
   begin
-    (Sender as TEdit).Text := '';
+    (Sender as TSpTBXEdit).Text := '';
     Key := 0;
   end;
 

Modified: trunk/Lobby/TASClient/HostBattleFormUnit.pas
===================================================================
--- trunk/Lobby/TASClient/HostBattleFormUnit.pas	2008-04-01 08:25:01 UTC (rev 5638)
+++ trunk/Lobby/TASClient/HostBattleFormUnit.pas	2008-04-01 13:47:07 UTC (rev 5639)
@@ -7,7 +7,7 @@
   Dialogs, StdCtrls, Mask, ComCtrls, janTracker, Buttons, Menus,
   JvExControls, JvComponent, JvArrowButton, ExtCtrls, JvXPCore, JvXPButtons,
   TBXDkPanels, SpTBXControls, TntStdCtrls, SpTBXEditors, SpTBXItem, TBX,
-  TB2Item, TB2ExtItems, TB2Dock, TB2Toolbar, SpTBXjanTracker, HttpProt,MainUnit,StrUtils;
+  TB2Item, TB2ExtItems, TB2Dock, TB2Toolbar, SpTBXjanTracker, HttpProt,MainUnit,StrUtils,JclUnicode;
 
 type
   THostBattleForm = class(TForm)
@@ -125,7 +125,7 @@
 procedure THostBattleForm.TryToHostBattle(ladderIndex: integer);
 var
   i,j: Integer;
-  s: string;
+  s: WideString;
   validMaps: TStringList;
 begin
   try
@@ -310,7 +310,7 @@
 procedure THostBattleForm.TryToHostReplay;
 var
   i: Integer;
-  s: string;
+  s: WideString;
   replay: TReplay;
 begin
   try

Modified: trunk/Lobby/TASClient/MainUnit.dfm
===================================================================
--- trunk/Lobby/TASClient/MainUnit.dfm	2008-04-01 08:25:01 UTC (rev 5638)
+++ trunk/Lobby/TASClient/MainUnit.dfm	2008-04-01 13:47:07 UTC (rev 5639)
@@ -1,6 +1,6 @@
 object MainForm: TMainForm
-  Left = 413
-  Top = 133
+  Left = 326
+  Top = 135
   Width = 789
   Height = 548
   Caption = 'TASClient'

Modified: trunk/Lobby/TASClient/MainUnit.pas
===================================================================
--- trunk/Lobby/TASClient/MainUnit.pas	2008-04-01 08:25:01 UTC (rev 5638)
+++ trunk/Lobby/TASClient/MainUnit.pas	2008-04-01 13:47:07 UTC (rev 5639)
@@ -204,7 +204,7 @@
   HttpProt, GraphicEx, Registry, JvComponent, JvBaseDlg, JvDesktopAlert,
   JvDesktopAlertForm, DateUtils, Winsock, TBXToolPals, SpTBXItem, TB2Item,
   TBX, SpTBXControls, TBXDkPanels, SpTBXFormPopupMenu,IniFiles,StrUtils,
-  TntStdCtrls, SpTBXEditors, Mask, JvExMask, JvSpin,TntComCtrls;
+  TntStdCtrls, SpTBXEditors, Mask, JvExMask, JvSpin,TntComCtrls,JclUnicode;
 
 const
   CountryNames: array[0..240] of string = (
@@ -508,7 +508,7 @@
 
 const
   VERSION_NUMBER = '0.37'; // Must be float value! (with a period as a decimal seperator)
-  BETA_NUMBER = 263;
+  BETA_NUMBER = 265;
   CHECK_BETA_LOBBY_URL = '<A HREF="http://tasclient.no-ip.org/TASClient.txt">http://tasclient.no-ip.org/TASClient.txt</A>';
   PROGRAM_VERSION = 'TASClient ' + VERSION_NUMBER + ' beta';
   KEEP_ALIVE_INTERVAL = 10000; // in milliseconds. Tells us what should be the maximum &quot;silence&quot; time before we send a ping to the server.
@@ -613,7 +613,7 @@
   TMyTabSheet = class(TTabSheet)
   public
     Clients: TList; // do not free any of the clients in this list! See AllClients list's comments
-    History: TStringList; // here we store everything user has typed in. User can access it by pressing UP/DOWN keys
+    History: TWideStringList; // here we store everything user has typed in. User can access it by pressing UP/DOWN keys
     HistoryIndex: Integer;
     AutoScroll: Boolean; // if true, we will scroll rich edit to the new line added
     LogFile: TFileStream;
@@ -788,7 +788,7 @@
     RankLimit: Shortint; // if 0, no rank limit is set. If 1 or higher, only players with this rank (or higher) can join the battle (Note: rank index 1 means seconds rank, not the first one, since you can't limit game to players of the first rank because that means game is open to all players and you don't have to limit it in that case)
     Visible : boolean;
 
-    Description: string;
+    Description: WideString;
     Map: String; // .smf file name, not archive file name!
     MapHash: Integer; // checksum of the map (acquired using unitsync.dll, for example)
     SpectatorCount: Integer; // how many spectators are there in this battle
@@ -1211,8 +1211,8 @@
     procedure InputEditClick(Sender: TObject);
     procedure InputEditKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
     function CheckServerVersion(ServerVersion: string): Boolean;
-    procedure ProcessCommand(s: string; CameFromBattleScreen: Boolean);
-    procedure ProcessRemoteCommand(s: string); // processes command received from server
+    procedure ProcessCommand(s: WideString; CameFromBattleScreen: Boolean);
+    procedure ProcessRemoteCommand(s: WideString); // processes command received from server
     procedure TryToCloseTab(TabSheet: TMyTabSheet);
     procedure OpenPrivateChat(ClientName: string);
 
@@ -1221,7 +1221,7 @@
     procedure RemoveAllClientsFromTab(Tab: TMyTabSheet);
     procedure UpdateClientsListBox;
 
-    function AddBattle(ID: Integer; BattleType: Integer; NATType: Integer; Founder: TClient; IP: string; Port: Integer; MaxPlayers: Integer; Password: Boolean; Rank: Byte; MapHash: Integer; MapName: string; Title: string; ModName: string): Boolean;
+    function AddBattle(ID: Integer; BattleType: Integer; NATType: Integer; Founder: TClient; IP: string; Port: Integer; MaxPlayers: Integer; Password: Boolean; Rank: Byte; MapHash: Integer; MapName: string; Title: WideString; ModName: string): Boolean;
     function RemoveBattle(ID: Integer): Boolean;
     function RemoveBattleByIndex(Index: Integer): Boolean;
     function GetBattle(ID: Integer): TBattle;
@@ -1241,10 +1241,10 @@
 
     procedure TryToDisconnect;
     // note that the generic TryToSendCommand is located under a private block
-    function TryToSendCommand(Command: string; Params: string; AssignID: Boolean): Integer; overload;
-    function TryToSendCommand(Command: string; AssignID: Boolean): Integer; overload;
-    procedure TryToSendCommand(Command: string; Params: string); overload;
-    procedure TryToSendCommand(Command: string); overload;
+    function TryToSendCommand(Command: WideString; Params: WideString; AssignID: Boolean): Integer; overload;
+    function TryToSendCommand(Command: WideString; AssignID: Boolean): Integer; overload;
+    procedure TryToSendCommand(Command: WideString; Params: WideString); overload;
+    procedure TryToSendCommand(Command: WideString); overload;
 
     procedure TryToSendDataDirectly(s: string); // deprecated - use TryToSendCommand method instead!
     procedure TryToLogin(Username, Password: string);
@@ -1335,7 +1335,7 @@
     procedure SortLabelClick(Sender: TObject);
 
   private
-    function TryToSendCommand(Command: string; SendParams: Boolean; Params: string; AssignID: Boolean): Integer; overload;
+    function TryToSendCommand(Command: WideString; SendParams: Boolean; Params: WideString; AssignID: Boolean): Integer; overload;
 
   public
     procedure TryToConnect; overload;
@@ -1464,7 +1464,7 @@
   ProcessingRemoteCommand: Boolean = False; // tells us if we are processing remote command currently. This is important because sometimes Application.ProcessMessages can get called from within ProcessRemoteCommand method, which could led to next command being processed before current one is finished.
 
   // used with Socket:
-  ReceiveBuffer: string; // this is temp buffer of what we receive from socket
+  ReceiveBuffer: WideString; // this is temp buffer of what we receive from socket
 
   LadderList: TList;
 
@@ -1472,7 +1472,7 @@
 
   { we have to use messaging queue, since TWSocket doesn't seem to work correctly if certain methods are called
     from within its events (and especially if new messages arrive in meantime) }
-  CommandQueue: array[0..QUEUE_LENGTH-1] of string;
+  CommandQueue: array[0..QUEUE_LENGTH-1] of WideString;
   CommandQueueHead: Integer = 0;
   CommandQueueTail: Integer = 0;
 
@@ -1491,8 +1491,8 @@
   MyInternetIp: String;
   
 
-  function Dequeue: string; forward;
-  function Enqueue(s: string): Integer; forward;
+  function Dequeue: WideString; forward;
+  function Enqueue(s: WideString): Integer; forward;
 
 
 implementation
@@ -1545,13 +1545,13 @@
            or (Align = alNone) or (WindowState = wsMinimized) then inherited;
 end;
 
-function Dequeue: string;
+function Dequeue: WideString;
 begin
   Result := CommandQueue[CommandQueueHead];
   CommandQueueHead := (CommandQueueHead + 1) mod QUEUE_LENGTH;
 end;
 
-function Enqueue(s: string): Integer;
+function Enqueue(s: WideString): Integer;
 begin
   Result := CommandQueueTail;
   CommandQueue[CommandQueueTail] := s;
@@ -1579,7 +1579,7 @@
 
 procedure TMainForm.OnDataHasArrivedMessage(var Msg: TMessage); // responds to WM_DATAHASARRIVED message
 var
-  s: string;
+  s: WideString;
 begin
 {
   if ProcessingRemoteCommand then // should probably not happen at all
@@ -1930,7 +1930,7 @@
 end;
 
 // returns False if battle with this ID already exists or some other error occured
-function TMainForm.AddBattle(ID: Integer; BattleType: Integer; NATType: Integer; Founder: TClient; IP: string; Port: Integer; MaxPlayers: Integer; Password: Boolean; Rank: Byte; MapHash: Integer; MapName: string; Title: string; ModName: string): Boolean;
+function TMainForm.AddBattle(ID: Integer; BattleType: Integer; NATType: Integer; Founder: TClient; IP: string; Port: Integer; MaxPlayers: Integer; Password: Boolean; Rank: Byte; MapHash: Integer; MapName: string; Title: WideString; ModName: string): Boolean;
 var
   Battle: TBattle;
   i:integer;
@@ -2995,7 +2995,7 @@
 begin
   inherited Create(AOwner);
   Clients := TList.Create;
-  History := TStringList.Create;
+  History := TWideStringList.Create;
   HistoryIndex := -1;
   AutoScroll := True;
   LogFile := nil;
@@ -3596,15 +3596,15 @@
 end;
 
 { CameFromBattleScreen must be True if user typed the message in battle screen }
-procedure TMainForm.ProcessCommand(s: string; CameFromBattleScreen: Boolean);
+procedure TMainForm.ProcessCommand(s: WideString; CameFromBattleScreen: Boolean);
 var
-  sl: TStringList;
+  sl: TWideStringList;
   p: Pointer;
   i: Integer;
-  tmp: string;
+  tmp: WideString;
   duration: Integer; // temp var
   res: Integer;
-  str: string;
+  str: WideString;
   pinginfo: PPingInfo;
 begin
 
@@ -3614,7 +3614,13 @@
 
   try
     if sl[0] = 'CONNECT' then TryToConnect
-    else if sl[0] = 'QUIT' then MainForm.Close
+    else if (sl[0] = 'QUIT') and (sl.Count=1) then MainForm.Close
+    else if (sl[0] = 'QUIT') and (sl.Count&gt;1) then
+    begin
+      TryToSendCommand('EXIT', MakeSentenceWS(sl,1));
+      Sleep(1000);
+      MainForm.Close;
+    end
     else if sl[0] = 'EXIT' then MainForm.Close
     else if (sl[0] = 'JOIN') or (sl[0] = 'J') then
     begin
@@ -3630,7 +3636,7 @@
         Exit;
       end;
 
-      if sl.Count = 2 then tmp := '' else tmp := ' ' + MakeSentence(sl, 2);
+      if sl.Count = 2 then tmp := '' else tmp := ' ' + MakeSentenceWS(sl, 2);
       TryToSendCommand('JOIN', LowerCase(Copy(sl[1], 2, Length(sl[1])-1)) + tmp);
     end
     else if (sl[0] = 'PART') or (sl[0] = 'P') then
@@ -3656,9 +3662,9 @@
     end
     else if (sl[0] = 'ME') then
     begin
-      if CameFromBattleScreen then TryToSendCommand('SAYBATTLEEX', MakeSentence(sl, 1))
+      if CameFromBattleScreen then TryToSendCommand('SAYBATTLEEX', MakeSentenceWS(sl, 1))
       else if PageControl1.ActivePage.Caption[1] = '#' then // a channel tab
-        TryToSendCommand('SAYEX', Copy(PageControl1.ActivePage.Caption, 2, Length(PageControl1.ActivePage.Caption)-1) + ' ' + MakeSentence(sl, 1));
+        TryToSendCommand('SAYEX', Copy(PageControl1.ActivePage.Caption, 2, Length(PageControl1.ActivePage.Caption)-1) + ' ' + MakeSentenceWS(sl, 1));
     end
     else if (sl[0] = 'RING') then
     begin
@@ -3728,7 +3734,7 @@
         Exit;
       end;
 
-      if sl.Count &gt; 2 then tmp := ' ' + MakeSentence(sl, 2)
+      if sl.Count &gt; 2 then tmp := ' ' + MakeSentenceWS(sl, 2)
       else tmp := '';
 
       if MainForm.GetClient(sl[1]) = nil then
@@ -3781,7 +3787,7 @@
         Exit;
       end;
 
-      TryToSendCommand('CHANNELTOPIC', Copy(sl[1], 2, Length(sl[1])-1) + ' ' + MakeSentence(sl, 2));
+      TryToSendCommand('CHANNELTOPIC', Copy(sl[1], 2, Length(sl[1])-1) + ' ' + MakeSentenceWS(sl, 2));
     end
     else if (sl[0] = 'CHANMSG') then
     begin
@@ -3797,11 +3803,11 @@
         Exit;
       end;
 
-      TryToSendCommand('CHANNELMESSAGE', Copy(sl[1], 2, Length(sl[1])-1) + ' ' + MakeSentence(sl, 2));
+      TryToSendCommand('CHANNELMESSAGE', Copy(sl[1], 2, Length(sl[1])-1) + ' ' + MakeSentenceWS(sl, 2));
     end
     else if (sl[0] = 'INGAME') then
     begin
-      str := MakeSentence(sl, 1);
+      str := MakeSentenceWS(sl, 1);
       if str = '' then MainForm.TryToSendCommand('GETINGAMETIME')
       else MainForm.TryToSendCommand('GETINGAMETIME', str);
     end
@@ -3928,7 +3934,7 @@
         Exit;
       end;
 
-      MainForm.AddMainLog(GetMD5Hash(MakeSentence(sl, 1)), Colors.Info);
+      MainForm.AddMainLog(GetMD5Hash(MakeSentenceWS(sl, 1)), Colors.Info);
     end
     else if (sl[0] = 'TESTCRASH') then
     begin
@@ -3976,8 +3982,20 @@
         Exit;
       end;
 
-      TryToSendCommand('SAYPRIVATE', sl[1] + ' ' + MakeSentence(sl, 2));
+      TryToSendCommand('SAYPRIVATE', sl[1] + ' ' + MakeSentenceWS(sl, 2));
     end
+    else if (sl[0] = 'HOOK') then
+    begin
+      if sl.Count &gt; 2 then
+      begin
+        AddMainLog('Error: Too many arguments!', Colors.Error);
+        Exit;
+      end;
+      if(sl.Count = 2) then
+        TryToSendCommand('HOOK', sl[1])
+      else
+        TryToSendCommand('HOOK')
+    end
     else if (sl[0] = 'IGNORE') then
     begin
       if sl.Count = 1 then
@@ -3986,7 +4004,7 @@
       end
       else
       begin
-        tmp := MakeSentence(sl, 1);
+        tmp := MakeSentenceWS(sl, 1);
 
         if MainForm.GetClient(tmp) = nil then
         begin
@@ -4012,10 +4030,10 @@
 end;
 
 
-procedure TMainForm.ProcessRemoteCommand(s: string); // processes command received from server
+procedure TMainForm.ProcessRemoteCommand(s: WideString); // processes command received from server
 var
-  sl: TStringList;
-  sl2: TStringList; // temp.
+  sl: TWideStringList;
+  sl2: TWideStringList; // temp.
   sl3: TStringList; // temp.
   MsgID: Integer;
   i, j, k, l, m, n, o, p, r, t: Integer;
@@ -4023,7 +4041,7 @@
   Battle: TBattle;
   Client: TClient;
   Bot: TBot;
-  tmp, tmp2, hash, url: string;
+  tmp, tmp2, hash, url: WideString;
   tmpInt, tmpInt2, tmpInt3,tmpInt4: Integer;
   tmpBool: Boolean;
   changed: Boolean;
@@ -4115,7 +4133,7 @@
         ReceivedAgreement.Add('');
       end
       else
-        ReceivedAgreement.Add(MakeSentence(sl, 1));
+        ReceivedAgreement.Add(MakeSentenceWS(sl, 1));
     end
     else if sl[0] = 'AGREEMENTEND' then
     begin
@@ -4129,7 +4147,7 @@
     end
     else if sl[0] = 'DENIED' then
     begin
-      if sl.Count = 1 then tmp := 'Unknown reason' else tmp := MakeSentence(sl, 1);
+      if sl.Count = 1 then tmp := 'Unknown reason' else tmp := MakeSentenceWS(sl, 1);
       MessageDlg('Error logging to server: ' + tmp, mtWarning, [mbOK], 0);
       AddMainLog('Login failed: ' + tmp, Colors.Error);
       TryToDisconnect;
@@ -4174,8 +4192,8 @@
     begin
       if sl.Count &gt; 1 then
       begin
-        AddMainLog('Registration failed: ' + MakeSentence(sl, 1), Colors.Error);
-        MessageDlg('Registration failed: ' + MakeSentence(sl, 1), mtWarning, [mbOK], 0);
+        AddMainLog('Registration failed: ' + MakeSentenceWS(sl, 1), Colors.Error);
+        MessageDlg('Registration failed: ' + MakeSentenceWS(sl, 1), mtWarning, [mbOK], 0);
       end
       else
       begin
@@ -4191,7 +4209,7 @@
       if sl.Count &lt; 2 then
       AddMainLog('-', Colors.MOTD)
       else
-      AddMainLog('- ' + MakeSentence(sl, 1), Colors.MOTD);
+      AddMainLog('- ' + MakeSentenceWS(sl, 1), Colors.MOTD);
 
       if (Status.ReceivingLoginInfo) and (Status.LastCommandReceived = 'ACCEPTED') then LoginProgressForm.UpdateCaption('Receiving MOTD ...');
     end
@@ -4203,7 +4221,7 @@
       end
       else
       begin
-        AddMainLog('Unable to join channel #' + sl[1] + ' (' + MakeSentence(sl, 2) + ')', Colors.Info);
+        AddMainLog('Unable to join channel #' + sl[1] + ' (' + MakeSentenceWS(sl, 2) + ')', Colors.Info);
       end;
     end
     else if sl[0] = 'OFFERFILE' then
@@ -4214,7 +4232,7 @@
         Exit;
       end;
 
-      sl2 := ParseString(MakeSentence(sl, 2), #9);
+      sl2 := ParseString(MakeSentenceWS(sl, 2), #9);
       if sl2.Count &lt;&gt; 3 then
       begin
         AddMainLog('Error: Server sent ambiguous command!', Colors.Error, 2);
@@ -4401,7 +4419,7 @@
         Exit;
       end;
 
-      Bot := TBot.Create(sl[2], sl[3], MakeSentence(sl, 6));
+      Bot := TBot.Create(sl[2], sl[3], MakeSentenceWS(sl, 6));
       Bot.BattleStatus := tmpInt2;
       Bot.TeamColor := teamcolor;
 
@@ -4660,7 +4678,7 @@
       end;
 
       tmp2 := sl[2]; // number of users in the channel
-      if sl.Count &gt; 4 then tmp := '  (' + MakeSentence(sl, 3) + ')'
+      if sl.Count &gt; 4 then tmp := '  (' + MakeSentenceWS(sl, 3) + ')'
       else tmp := '';
       AddMainLog('+ ' + '#' + sl[1] + EnumerateSpaces(Max(0, 20-Length(sl[1])-Length(tmp2))) + tmp2 + tmp, Colors.Normal);
     end
@@ -4720,7 +4738,7 @@
       if not Preferences.FilterJoinLeftMessages then
       begin
         tmp := '';
-        if sl.Count &gt; 3 then tmp := ' (' + MakeSentence(sl, 3) + ')';
+        if sl.Count &gt; 3 then tmp := ' (' + MakeSentenceWS(sl, 3) + ')';
         AddTextToChatWindow(PageControl1.Pages[i] as TMyTabSheet, '* ' + sl[2] + ' has left ' + PageControl1.Pages[i].Caption + tmp, Colors.ChanLeft);
       end;
 
@@ -4741,7 +4759,7 @@
         Exit;
       end;
 
-      if sl.Count = 3 then tmp := '' else tmp := ' (' + MakeSentence(sl, 3) + ')';
+      if sl.Count = 3 then tmp := '' else tmp := ' (' + MakeSentenceWS(sl, 3) + ')';
       AddTextToChatWindow(PageControl1.Pages[i] as TMyTabSheet, '* You have been kicked from #' + sl[1] + ' by &lt;' + sl[2] + '&gt;' + tmp, Colors.Info);
       (PageControl1.Pages[i] as TMyTabSheet).Clients.Clear;
 
@@ -4769,9 +4787,9 @@
         AddMainLog('Error: Server sent ambiguous command!', Colors.Error);
         Exit;
       end;
-      tmp2 := MakeSentence(sl, 4);
+      tmp2 := MakeSentenceWS(sl, 4);
 
-      sl2 := TStringList.Create;
+      sl2 := TWideStringList.Create;
       Misc.ParseDelimited(sl2,tmp2,'\n','');
 
       if sl2.Count = 1 then
@@ -4811,7 +4829,7 @@
       else
         cTmp := Colors.Normal;
 
-      AddTextToChatWindow(PageControl1.Pages[i] as TMyTabSheet, '&lt;' + sl[2] + '&gt; ' + MakeSentence(sl, 3), cTmp, Length(sl[2])+2);
+      AddTextToChatWindow(PageControl1.Pages[i] as TMyTabSheet, '&lt;' + sl[2] + '&gt; ' + MakeSentenceWS(sl, 3), cTmp, Length(sl[2])+2);
     end
     else if sl[0] = 'CHANNELMESSAGE' then
     begin
@@ -4828,7 +4846,7 @@
         Exit;
       end;
 
-      AddTextToChatWindow(PageControl1.Pages[i] as TMyTabSheet, '* Channel message: ' + MakeSentence(sl, 2), Colors.Info);
+      AddTextToChatWindow(PageControl1.Pages[i] as TMyTabSheet, '* Channel message: ' + MakeSentenceWS(sl, 2), Colors.Info);
     end
     else if sl[0] = 'SAIDEX' then
     begin
@@ -4849,7 +4867,7 @@
         Exit;
       end;
 
-      AddTextToChatWindow(PageControl1.Pages[i] as TMyTabSheet, '* ' + sl[2] + ' ' + MakeSentence(sl, 3), Colors.SayEx);
+      AddTextToChatWindow(PageControl1.Pages[i] as TMyTabSheet, '* ' + sl[2] + ' ' + MakeSentenceWS(sl, 3), Colors.SayEx);
     end
     else if sl[0] = 'SAIDPRIVATE' then
     begin
@@ -4875,7 +4893,7 @@
         UpdateClientsListBox;
       end;
 
-      AddTextToChatWindow(PageControl1.Pages[i] as TMyTabSheet, '&lt;' + sl[1] + '&gt; ' + MakeSentence(sl, 2), Colors.Normal, Length(sl[1])+2);
+      AddTextToChatWindow(PageControl1.Pages[i] as TMyTabSheet, '&lt;' + sl[1] + '&gt; ' + MakeSentenceWS(sl, 2), Colors.Normal, Length(sl[1])+2);
 
       // auto replay away message
       Client := GetClient(sl[1]);
@@ -4887,7 +4905,7 @@
       if not Application.Active then FlashWindow(MainForm.Handle, true);
 
       // add notification if private message and if application isn't focused:
-      if (not Application.Active) and (NotificationsForm.CheckBox1.Checked) then AddNotification('Private message', '&lt;' + sl[1] + '&gt; ' + MakeSentence(sl, 2), 2500);
+      if (not Application.Active) and (NotificationsForm.CheckBox1.Checked) then AddNotification('Private message', '&lt;' + sl[1] + '&gt; ' + MakeSentenceWS(sl, 2), 2500);
     end
     else if sl[0] = 'SAYPRIVATE' then
     begin
@@ -4909,7 +4927,7 @@
         UpdateClientsListBox;
       end;
 
-      AddTextToChatWindow(PageControl1.Pages[i] as TMyTabSheet, '&lt;' + Status.Username + '&gt; ' + MakeSentence(sl, 2), Colors.MyText, Length(Status.Username)+2);
+      AddTextToChatWindow(PageControl1.Pages[i] as TMyTabSheet, '&lt;' + Status.Username + '&gt; ' + MakeSentenceWS(sl, 2), Colors.MyText, Length(Status.Username)+2);
     end
     else if sl[0] = 'PONG' then
     begin
@@ -4934,7 +4952,7 @@
       else
         cTmp := Colors.Normal;
 
-      BattleForm.AddTextToChat('&lt;' + sl[1] + '&gt; ' + MakeSentence(sl, 2), cTmp, Length(sl[1])+2);
+      BattleForm.AddTextToChat('&lt;' + sl[1] + '&gt; ' + MakeSentenceWS(sl, 2), cTmp, Length(sl[1])+2);
     end
     else if sl[0] = 'SAIDBATTLEEX' then
     begin
@@ -4944,7 +4962,7 @@
         Exit;
       end;
 
-      BattleForm.AddTextToChat('* ' + sl[1] + ' ' + MakeSentence(sl, 2), Colors.SayEx, 1);
+      BattleForm.AddTextToChat('* ' + sl[1] + ' ' + MakeSentenceWS(sl, 2), Colors.SayEx, 1);
     end
     else if sl[0] = 'REQUESTBATTLESTATUS' then
     begin
@@ -5073,12 +5091,12 @@
         Exit;
       end;
 
-      AddMainLog('Failed to join the battle (Reason: ' + MakeSentence(sl, 1) + ')', Colors.Error);
+      AddMainLog('Failed to join the battle (Reason: ' + MakeSentenceWS(sl, 1) + ')', Colors.Error);
     end
     else if sl[0] = 'OPENBATTLEFAILED' then
     begin
       tmp := 'Unknown error';
-      if sl.Count &gt; 1 then tmp := MakeSentence(sl, 1);
+      if sl.Count &gt; 1 then tmp := MakeSentenceWS(sl, 1);
       WaitForAckForm.OnCancelHosting(tmp);
     end
     else if sl[0] = 'BATTLEOPENED' then
@@ -5089,7 +5107,7 @@
         Exit;
       end;
 
-      sl2 := ParseString(MakeSentence(sl, 11), #9);
+      sl2 := ParseString(MakeSentenceWS(sl, 11), #9);
 
       if sl2.Count &lt;&gt; 3 then
       begin
@@ -5138,7 +5156,6 @@
         AddMainLog('Error: Server sent ambiguous command!', Colors.Error);
         Exit;
       end;
-
       AddBattle(i, battletype, nattype, Client, tmp, j, k, tmpBool, l, maphash, sl2[0], sl2[1], sl2[2]);
       Battle := GetBattle(i);
       if Battle.visible then
@@ -5515,7 +5532,7 @@
       if (BattleForm.IsBattleActive) and (Battle.ID = BattleState.Battle.ID) then
         oldMapHash := BattleState.Battle.MapHash;
 
-      Battle.Map := MakeSentence(sl, 5);
+      Battle.Map := MakeSentenceWS(sl, 5);
       Battle.MapHash := maphash;
       Battle.SpectatorCount := tmpInt2;
       Battle.Locked := tmpBool;
@@ -5643,7 +5660,7 @@
     end
     else if sl[0] = 'SETSCRIPTTAGS' then
     begin
-      sl2 := ParseString(MakeSentence(sl,1),#9);
+      sl2 := ParseString(MakeSentenceWS(sl,1),#9);
 
       if sl2.Count = 0 then
       begin
@@ -5904,20 +5921,20 @@
         Exit;
       end;
 
-      AddMainLog('* Broadcast from server: ' + MakeSentence(sl, 1), Colors.Info);
+      AddMainLog('* Broadcast from server: ' + MakeSentenceWS(sl, 1), Colors.Info);
 
       For i:=1 to PageControl1.PageCount -1 do
-        AddTextToChatWindow(PageControl1.Pages[i] as TMyTabSheet, '* Broadcast from server: ' + MakeSentence(sl, 1), Colors.Info);
+        AddTextToChatWindow(PageControl1.Pages[i] as TMyTabSheet, '* Broadcast from server: ' + MakeSentenceWS(sl, 1), Colors.Info);
     end
     else if sl[0] = 'SERVERMSG' then
     begin
-      sl2 := TStringList.Create;
+      sl2 := TWideStringList.Create;
       if sl.Count &lt; 2 then
       begin
         AddMainLog('Error: Server sent ambiguous command!', Colors.Error);
         Exit;
       end;
-      tmp := MakeSentence(sl, 1);
+      tmp := MakeSentenceWS(sl, 1);
       AddMainLog('* Message from server: ' + tmp, Colors.Info);
       if (Pos('Your account has been renamed',tmp) &gt; 0) and (Preferences.LadderPassword &lt;&gt; '') then // handleRename
       begin
@@ -5946,7 +5963,7 @@
         Exit;
       end;
 
-      sl2 := ParseString(MakeSentence(sl, 1), #9);
+      sl2 := ParseString(MakeSentenceWS(sl, 1), #9);
 
       if sl2.Count &gt; 1 then url := sl2[1]
       else url := '';
@@ -5998,7 +6015,7 @@
       end;
 
       if sl.Count &lt; 2 then BattleReplayInfo.TempScript.Add('')
-      else BattleReplayInfo.TempScript.Add(MakeSentence(sl, 1));
+      else BattleReplayInfo.TempScript.Add(MakeSentenceWS(sl, 1));
     end
     else if sl[0] = 'SCRIPTEND' then
     begin
@@ -6064,7 +6081,7 @@
       for i := 0 to MuteListForms.Count - 1 do
         if TMuteListForm(MuteListForms[i]).ChanName = ReceivingMuteListForChannel then
         begin
-          TMuteListForm(MuteListForms[i]).MuteListBox.Items.Add(MakeSentence(sl, 1));
+          TMuteListForm(MuteListForms[i]).MuteListBox.Items.Add(MakeSentenceWS(sl, 1));
           Break;
         end;
     end
@@ -6107,7 +6124,7 @@
     else if sl[0] = 'MAPGRADESFAILED' then
     begin
       tmp := 'Unspecified error';
-      if sl.Count &gt; 1 then tmp := MakeSentence(sl, 1);
+      if sl.Count &gt; 1 then tmp := MakeSentenceWS(sl, 1);
       MessageDlg('Unable to synchronize map grades (reason: ' + tmp + ')', mtWarning, [mbOK], 0);
       MapListForm.StatusLabel.Caption := 'synchronization failed.';
       SyncSentAt := 0;
@@ -6211,7 +6228,7 @@
   Shift: TShiftState);
 var
   s: WideString;
-  sl: TStringList;
+  sl: TWideStringList;
   tmp: string;
 begin
   if (Key = Ord('W')) and (ssCtrl in Shift) then
@@ -6242,7 +6259,7 @@
     begin
       sl := StringParser.ParseString(s, ' ');
       if sl.Count &gt; 1 then
-        TryToSendCommand(sl[0], MakeSentence(sl, 1))
+        TryToSendCommand(sl[0], MakeSentenceWS(sl, 1))
       else
         TryToSendCommand(sl[0]);
     end
@@ -6252,34 +6269,34 @@
   end
   else if Key = VK_UP then
   begin
-    with (Sender as TEdit).Parent as TMyTabSheet do
+    with (Sender as TSpTBXEdit).Parent as TMyTabSheet do
     begin
       if History.Count = 0 then Exit;
       HistoryIndex := Max(0, HistoryIndex-1);
-      (Sender as TEdit).Text := History[HistoryIndex];
-      (Sender as TEdit).SelStart := Length((Sender as TEdit).Text);
+      (Sender as TSpTBXEdit).Text := History[HistoryIndex];
+      (Sender as TSpTBXEdit).SelStart := Length((Sender as TSpTBXEdit).Text);
       Key := 0;
     end;
   end
   else if Key = VK_DOWN then
   begin
-    with (Sender as TEdit).Parent as TMyTabSheet do
+    with (Sender as TSpTBXEdit).Parent as TMyTabSheet do
     begin
       if History.Count = 0 then Exit;
       HistoryIndex := Min(History.Count-1, HistoryIndex + 1);
-      (Sender as TEdit).Text := History[HistoryIndex];
-      (Sender as TEdit).SelStart := Length((Sender as TEdit).Text);
+      (Sender as TSpTBXEdit).Text := History[HistoryIndex];
+      (Sender as TSpTBXEdit).SelStart := Length((Sender as TSpTBXEdit).Text);
       Key := 0;
     end;
   end
   else if Key = VK_ESCAPE then
   begin
-    (Sender as TEdit).Text := '';
+    (Sender as TSpTBXEdit).Text := '';
     Key := 0;
   end;
 
   if Key &lt;&gt; VK_TAB then
-    (Sender as TEdit).Tag := 0;
+    (Sender as TSpTBXEdit).Tag := 0;
 end;
 
 procedure TMainForm.PageControl1MouseDown(Sender: TObject;
@@ -6494,9 +6511,10 @@
   Params will not be sent along the command if SendParams is set to 'False'.
   Returns immediately.
   Note that this is a generic (and private) method, use other overloaded methods instead for general use. }
-function TMainForm.TryToSendCommand(Command: string; SendParams: Boolean; Params: string; AssignID: Boolean): Integer;
+function TMainForm.TryToSendCommand(Command: WideString; SendParams: Boolean; Params: WideString; AssignID: Boolean): Integer;
 var
-  s: string;
+  s: WideString;
+  sUTF8: UTF8String;
 begin;
   // assign unique message(command) ID:
   if AssignID then
@@ -6515,7 +6533,8 @@
   end;
 
   try
-    Socket.SendLine(s);
+    sUTF8 := UTF8Encode(s+EOL);
+    Socket.Send(PChar(sUTF8),length(sUTF8));
     Inc(Status.CumulativeDataSent, Length(s));
     if Debug.Enabled and ((not Debug.FilterPingPong) or (Command &lt;&gt; 'PING')) then AddMainLog('Client: &quot;' + s + '&quot;', Colors.Data);
     Status.TimeOfLastDataSent := GetTickCount;
@@ -6526,23 +6545,23 @@
 
 { will try to send command to the server returning the message ID chosen for this message if 'AssignID' is true, or else returning -1.
   Returns immediately. }
-function TMainForm.TryToSendCommand(Command: string; Params: string; AssignID: Boolean): Integer;
+function TMainForm.TryToSendCommand(Command: WideString; Params: WideString; AssignID: Boolean): Integer;
 begin;
   Result := TryToSendCommand(Command, True, Params, AssignID);
 end;
 
 { 'AssignID' - if true, ID is assigned and returned, or else -1 is returned }
-function TMainForm.TryToSendCommand(Command: string; AssignID: Boolean): Integer;
+function TMainForm.TryToSendCommand(Command: WideString; AssignID: Boolean): Integer;
 begin;
   Result := TryToSendCommand(Command, False, '', AssignID);
 end;
 
-procedure TMainForm.TryToSendCommand(Command: string; Params: string);
+procedure TMainForm.TryToSendCommand(Command: WideString; Params: WideString);
 begin
   TryToSendCommand(Command, True, Params, False);
 end;
 
-procedure TMainForm.TryToSendCommand(Command: string);
+procedure TMainForm.TryToSendCommand(Command: WideString);
 begin
   TryToSendCommand(Command, False, '', False);
 end;
@@ -6576,7 +6595,7 @@
   found: Boolean;
   pos, startpos: Integer;
   SortedClientsList: TStringList;
-  splitedString: TStringList;
+  splitedString: TWideStringList;
   completionWordIndex: integer;
   selStart: integer;
 begin
@@ -6587,7 +6606,7 @@
   end;
 
   SortedClientsList := TStringList.Create;
-  splitedString := TStringList.Create;
+  splitedString := TWideStringList.Create;
 
   try
   for i:=0 to Clients.Count-1 do
@@ -6834,19 +6853,22 @@
 
 procedure TMainForm.SocketDataAvailable(Sender: TObject; ErrCode: Word);
 var
-  s: string;
+  sBuffer: UTF8String;
+  s: WideString;
   i: Integer;
   len: Integer;
 begin
   Status.TimeOfLastDataReceived := GetTickCount;
-  SetLength(s, 256);
+  SetLength(sBuffer, 256);
 
   while True do
   begin
-    len := (Sender as TWSocket).Receive(@s[1], 256);
+    len := (Sender as TWSocket).Receive(@sBuffer[1], 256);
     if len &lt;= 0 then Exit;
 
-    for i := 1 to len do
+    s := UTF8Decode(LeftStr(sBuffer,len));
+
+    for i := 1 to length(s) do
     begin
       if (s[i] = #13) or (s[i] = #10) then
       begin
@@ -7011,7 +7033,7 @@
         for i:=0 to Battle.Clients.Count-1 do
           avgRank := avgRank + TClient(Battle.Clients[i]).GetRank;
         avgRank := avgRank / Battle.Clients.Count;
-        RanksImageList.Draw(Canvas, R.Left, R.Top, Floor(avgRank));
+        RanksImageList.Draw(Canvas, R.Left, R.Top, Round(avgRank));
         Inc(R.Left, RanksImageList.Width);
         s := FloatToStr(RoundTo(avgRank+1,-2));
       end;
@@ -7394,11 +7416,11 @@
     begin
       avgRank1 := 0;
       for i:=0 to Battle1.Clients.Count-1 do
-        avgRank1 := avgRank1 + TClient(Battle1.Clients[i]).GetRank;
+          avgRank1 := avgRank1 + TClient(Battle1.Clients[i]).GetRank;
       avgRank1 := avgRank1 / Battle1.Clients.Count;
       avgRank2 := 0;
       for i:=0 to Battle2.Clients.Count-1 do
-        avgRank2 := avgRank2 + TClient(Battle2.Clients[i]).GetRank;
+          avgRank2 := avgRank2 + TClient(Battle2.Clients[i]).GetRank;
       avgRank2 := avgRank2 / Battle2.Clients.Count;
       Result := CompareValue(avgRank1,avgRank2);
     end;

Modified: trunk/Lobby/TASClient/Misc.pas
===================================================================
--- trunk/Lobby/TASClient/Misc.pas	2008-04-01 08:25:01 UTC (rev 5638)
+++ trunk/Lobby/TASClient/Misc.pas	2008-04-01 13:47:07 UTC (rev 5639)
@@ -11,7 +11,7 @@
 
 uses
   SpTBXItem,JvSpin,Dialogs, Classes, ComCtrls, Windows, Graphics, MMSystem, Controls, Registry, SysUtils,
-  WSocket, Winsock, ESBDates, GpTimeZone, JvColorCombo, Forms,StdCtrls,HttpProt,TntComCtrls;
+  WSocket, Winsock, ESBDates, GpTimeZone, JvColorCombo, Forms,StdCtrls,HttpProt,TntComCtrls,JclUnicode;
 
 type
   TVerticalAlign=(alVTop,alVCenter,alVBottom);
@@ -30,10 +30,12 @@
     constructor Create(Suspended : Boolean);
   end;
 
-procedure ParseDelimited(const sl : TStrings; const value : string; const delimiter : string;const delimiter2: string) ;
+procedure ParseDelimited(const sl : TStrings; const value : string; const delimiter : string;const delimiter2: string) ;overload;
+procedure ParseDelimited(const sl : TWideStrings; const value : string; const delimiter : WideString;const delimiter2: WideString) ;overload;
 function JoinStringList(sl : TStrings;delimiter: String):String;
 function ShellExecuteAndWait(FileName: string; Params: string): Boolean;
 function MakeSentence(sl: TStringList; StartIndex: Integer): string;
+function MakeSentenceWS(sl: TWideStringList; StartIndex: Integer): WideString;
 function CreateStrings(Length: Integer): string; // a helper function used to create a string filled with #13's
 function StringToHex(s: string): string;
 function HexToString(s: string): string;
@@ -128,6 +130,36 @@
   BUFFER_LENGTH = 1024;
 
 { --------------------------------------------------------------------------- }
+procedure ParseDelimited(const sl : TWideStrings; const value : string; const delimiter : WideString;const delimiter2: WideString) ;
+  var
+   dx : integer;
+   ns : WideString;
+   txt : WideString;
+   delta,delta1,delta2 : integer;
+  begin
+   delta1 := Length(delimiter) ;
+   delta2 := Length(delimiter2) ;
+   txt := value + delimiter;
+   sl.BeginUpdate;
+   sl.Clear;
+   try
+     while Length(txt) &gt; 0 do
+     begin
+       dx := Pos(delimiter, txt) ;
+       delta := delta1;
+       if (delta2 &gt; 0) and (Pos(delimiter2,txt) &lt; dx) and (Pos(delimiter2,txt) &gt; 0) then
+       begin
+        dx := Pos(delimiter2,txt);
+        delta := delta2;
+       end;
+       ns := Copy(txt,0,dx-1) ;
+       sl.Add(ns) ;
+       txt := Copy(txt,dx+delta,MaxInt) ;
+     end;
+   finally
+     sl.EndUpdate;
+   end;
+  end;
 procedure ParseDelimited(const sl : TStrings; const value : string; const delimiter : string;const delimiter2: string) ;
   var
    dx : integer;
@@ -216,6 +248,20 @@
   end;
 end;
 
+function MakeSentenceWS(sl: TWideStringList; StartIndex: Integer): WideString;
+begin
+  Result := '';
+  if StartIndex &gt; sl.Count-1 then Exit;
+
+  Result := sl[StartIndex];
+  Inc(StartIndex);
+  while StartIndex &lt;= sl.Count-1 do
+  begin
+    Result := Result + ' ' + sl[StartIndex];
+    Inc(StartIndex);
+  end;
+end;
+
 { --------------------------------------------------------------------------- }
 
 function CreateStrings(Length: Integer): string;

Modified: trunk/Lobby/TASClient/StringParser.pas
===================================================================
--- trunk/Lobby/TASClient/StringParser.pas	2008-04-01 08:25:01 UTC (rev 5638)
+++ trunk/Lobby/TASClient/StringParser.pas	2008-04-01 13:47:07 UTC (rev 5639)
@@ -10,9 +10,10 @@
 
 interface
 
-uses Classes;
+uses Classes,JclUnicode;
 
-function ParseString(s: string; Delimiter: Char): TStringList;
+function ParseString(s: string; Delimiter: Char): TStringList;overload;
+function ParseString(s: WideString; Delimiter: Char): TWideStringList; overload;
 function ParseStringEx(s: string; Delimiter: string): TStringList;
 
 implementation
@@ -100,7 +101,36 @@
 end;   // ParseString_mc
 }
 
+function ParseString(s: WideString; Delimiter: Char): TWideStringList;
+var
+  str, wrd: WideString;
+  list: TWideStringList;
 
+begin
+
+  list:= TWideStringList.Create;
+
+  Result := list;
+  str := s;
+  wrd := '';
+
+  {Check to see if the string passed is blank}
+  if (Length(s) = 0) then Exit;
+
+  while (Pos(Delimiter, str) &gt; 0) do                  {Do this while you find}
+  begin                                         {spaces in the sentence}
+    wrd := Copy(str, 1, Pos(Delimiter, str) - 1);     {Get the word from the string}
+    list.Add(wrd);                              {Add the word to the TStringList}
+    str := Copy(str, Pos(Delimiter, str) + 1,         {Redefine the sentence by cutting}
+                Length(str) - Length(wrd) + 1); {off the first word}
+  end;
+
+  if (Length(str) &gt; 0) then                     {This is important, because you never}
+    list.Add(str);                              {know if there's anything left in the
+                                                 sentence.}
+end;
+
+
 function ParseString(s: string; Delimiter: Char): TStringList;
 var
   str, wrd: string;

Modified: trunk/Lobby/TASClient/TASClient.dof
===================================================================
--- trunk/Lobby/TASClient/TASClient.dof	2008-04-01 08:25:01 UTC (rev 5638)
+++ trunk/Lobby/TASClient/TASClient.dof	2008-04-01 13:47:07 UTC (rev 5639)
@@ -115,7 +115,7 @@
 MajorVer=0
 MinorVer=3
 Release=0
-Build=263
+Build=265
 Debug=0
 PreRelease=0
 Special=0
@@ -126,7 +126,7 @@
 [Version Info Keys]
 CompanyName=
 FileDescription=TA Spring lobby client
-FileVersion=0.3.0.263
+FileVersion=0.3.0.265
 InternalName=
 LegalCopyright=
 LegalTrademarks=

Modified: trunk/Lobby/TASClient/TASClient.res
===================================================================
(Binary files differ)


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000419.html">[Taspring-linux-commit] r5638 - in trunk/rts: Lua Sim/MoveTypes	Sim/Units
</A></li>
	<LI>Next message: <A HREF="000421.html">[Taspring-linux-commit] r5640 - in trunk/rts: Game Game/UI Lua	Rendering Rendering/GL Rendering/UnitModels Sim/Units System
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#420">[ date ]</a>
              <a href="thread.html#420">[ thread ]</a>
              <a href="subject.html#420">[ subject ]</a>
              <a href="author.html#420">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
