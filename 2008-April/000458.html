<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r5677 - in trunk/tools/springie: . Springie	Springie/Properties Springie/autohost Springie/client	Springie/doc Springie/spring Springie/utils
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-April/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5677%20-%20in%20trunk/tools/springie%3A%20.%20Springie%0A%09Springie/Properties%20Springie/autohost%20Springie/client%0A%09Springie/doc%20Springie/spring%20Springie/utils&In-Reply-To=%3C20080407185710.CA6D646BB%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000457.html">
   <LINK REL="Next"  HREF="000459.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r5677 - in trunk/tools/springie: . Springie	Springie/Properties Springie/autohost Springie/client	Springie/doc Springie/spring Springie/utils</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5677%20-%20in%20trunk/tools/springie%3A%20.%20Springie%0A%09Springie/Properties%20Springie/autohost%20Springie/client%0A%09Springie/doc%20Springie/spring%20Springie/utils&In-Reply-To=%3C20080407185710.CA6D646BB%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r5677 - in trunk/tools/springie: . Springie	Springie/Properties Springie/autohost Springie/client	Springie/doc Springie/spring Springie/utils">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Mon Apr  7 20:57:10 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000457.html">[Taspring-linux-commit] r5676 - trunk/rts/Sim/Path
</A></li>
        <LI>Next message: <A HREF="000459.html">[Taspring-linux-commit] r5678 - trunk/rts/Sim/Path
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#458">[ date ]</a>
              <a href="thread.html#458">[ thread ]</a>
              <a href="subject.html#458">[ subject ]</a>
              <a href="author.html#458">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: Licho
Date: 2008-04-07 20:57:09 +0200 (Mon, 07 Apr 2008)
New Revision: 5677

Modified:
   trunk/tools/springie/
   trunk/tools/springie/Springie/ErrorHandling.cs
   trunk/tools/springie/Springie/FormAccount.cs
   trunk/tools/springie/Springie/FormCurrentBattle.cs
   trunk/tools/springie/Springie/FormMain.cs
   trunk/tools/springie/Springie/FormSettings.cs
   trunk/tools/springie/Springie/Main.cs
   trunk/tools/springie/Springie/MainConfig.cs
   trunk/tools/springie/Springie/Program.cs
   trunk/tools/springie/Springie/Properties/AssemblyInfo.cs
   trunk/tools/springie/Springie/Properties/Resources.Designer.cs
   trunk/tools/springie/Springie/Properties/Settings.Designer.cs
   trunk/tools/springie/Springie/autohost/AutoHost.cs
   trunk/tools/springie/Springie/autohost/AutoHostConfig.cs
   trunk/tools/springie/Springie/autohost/AutoHost_commands.cs
   trunk/tools/springie/Springie/autohost/AutoManager.cs
   trunk/tools/springie/Springie/autohost/BanList.cs
   trunk/tools/springie/Springie/autohost/BannedUser.cs
   trunk/tools/springie/Springie/autohost/CommandConfig.cs
   trunk/tools/springie/Springie/autohost/Ladder.cs
   trunk/tools/springie/Springie/autohost/Polls.cs
   trunk/tools/springie/Springie/autohost/Preset.cs
   trunk/tools/springie/Springie/autohost/PrivilegedUser.cs
   trunk/tools/springie/Springie/client/Battle.cs
   trunk/tools/springie/Springie/client/BattleDetails.cs
   trunk/tools/springie/Springie/client/BattleRect.cs
   trunk/tools/springie/Springie/client/ServerConnection.cs
   trunk/tools/springie/Springie/client/TasClient.cs
   trunk/tools/springie/Springie/client/TasClient_structures.cs
   trunk/tools/springie/Springie/client/UserBattleStatus.cs
   trunk/tools/springie/Springie/doc/devlog.txt
   trunk/tools/springie/Springie/spring/ConfigMaker.cs
   trunk/tools/springie/Springie/spring/Spring.cs
   trunk/tools/springie/Springie/spring/Talker.cs
   trunk/tools/springie/Springie/spring/UnitSync.cs
   trunk/tools/springie/Springie/utils/AutoUpdater.cs
   trunk/tools/springie/Springie/utils/FileDownloader.cs
   trunk/tools/springie/Springie/utils/MyCol.cs
   trunk/tools/springie/Springie/utils/Stats.cs
   trunk/tools/springie/Springie/utils/UnknownFilesLinker.cs
   trunk/tools/springie/Springie/utils/Utils.cs
Log:
code cleanup


Property changes on: trunk/tools/springie
___________________________________________________________________
Name: svn:ignore
   - *.suo
Ankh.Load
!zaloha
!runs
!resources

   + *.suo
Ankh.Load
!zaloha
!runs
!resources
_ReSharper.Springie
Springie.resharper


Modified: trunk/tools/springie/Springie/ErrorHandling.cs
===================================================================
--- trunk/tools/springie/Springie/ErrorHandling.cs	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/ErrorHandling.cs	2008-04-07 18:57:09 UTC (rev 5677)
@@ -1,16 +1,14 @@
 using System;
-using System.Collections.Generic;
-using System.Text;
-using System.Windows.Forms;
 using System.IO;
 using System.Net;
+using System.Windows.Forms;
 
 namespace Springie
 {
   public class ErrorHandling
   {
-    const string LogFile = &quot;springie_errors.txt&quot;;
-    const string ReportUrl = &quot;<A HREF="http://springie.licho.eu/error.php">http://springie.licho.eu/error.php</A>&quot;;
+    private const string LogFile = &quot;springie_errors.txt&quot;;
+    private const string ReportUrl = &quot;<A HREF="http://springie.licho.eu/error.php">http://springie.licho.eu/error.php</A>&quot;;
 
     /// &lt;summary&gt;
     /// Handles one exception (saves to log file and sends to website)
@@ -18,7 +16,8 @@
     /// &lt;param name=&quot;e&quot;&gt;exception to be handled&lt;/param&gt;
     /// &lt;param name=&quot;moreInfo&quot;&gt;additional information&lt;/param&gt;
     /// &lt;returns&gt;returns true if exception was handled, false if called should rethrow&lt;/returns&gt;
-    public static bool HandleException(Exception e, string moreInfo) {
+    public static bool HandleException(Exception e, string moreInfo)
+    {
       try {
         // write to error log
         StreamWriter s = File.AppendText(Application.StartupPath + '/' + LogFile);
@@ -27,17 +26,17 @@
 
         // send to error gathering site
         WebClient wc = new WebClient();
-        string urtext = string.Format(&quot;{0}?username={1}&amp;springie={2}&amp;moreinfo={3}&amp;exception={4}&quot;, ReportUrl, Program.main.config.AccountName, MainConfig.SpringieVersion, moreInfo+&quot;&quot;, e);
+        string urtext = string.Format(&quot;{0}?username={1}&amp;springie={2}&amp;moreinfo={3}&amp;exception={4}&quot;, ReportUrl, Program.main.config.AccountName, MainConfig.SpringieVersion, moreInfo + &quot;&quot;, e);
         wc.DownloadString(new Uri(urtext));
-       
       } catch {}
-      
+
       try {
         // optionally display messagebox
         if (Program.main.config.ErrorHandlingMode == MainConfig.ErrorHandlingModes.MessageBox) MessageBox.Show(e.ToString(), moreInfo);
       } catch {}
-      
-      if (Program.main.config.ErrorHandlingMode == MainConfig.ErrorHandlingModes.Debug) return false; else return true;
+
+      if (Program.main.config.ErrorHandlingMode == MainConfig.ErrorHandlingModes.Debug) return false;
+      else return true;
     }
   }
-}
+}
\ No newline at end of file

Modified: trunk/tools/springie/Springie/FormAccount.cs
===================================================================
--- trunk/tools/springie/Springie/FormAccount.cs	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/FormAccount.cs	2008-04-07 18:57:09 UTC (rev 5677)
@@ -1,39 +1,28 @@
 using System;
-using System.Collections.Generic;
-using System.ComponentModel;
-using System.Data;
-using System.Drawing;
-using System.Text;
 using System.Windows.Forms;
 
 namespace Springie
 {
   public partial class FormAccount : Form
   {
-    public string Login {
-      get {
-        return textBox1.Text;
-      }
-      set {
-        textBox1.Text = value;
-      }
+    private const int CountDown = 60;
+    private int countValue = CountDown;
+
+    public FormAccount()
+    {
+      InitializeComponent();
     }
 
-    public string Password {
-      get {
-        return textBox2.Text;
-      }
-      set {
-        textBox2.Text = value;
-      }
+    public string Login
+    {
+      get { return textBox1.Text; }
+      set { textBox1.Text = value; }
     }
 
-    const int CountDown = 60;
-    int countValue = CountDown;
-
-    public FormAccount()
+    public string Password
     {
-      InitializeComponent();
+      get { return textBox2.Text; }
+      set { textBox2.Text = value; }
     }
 
     private void button1_Click(object sender, EventArgs e)
@@ -54,9 +43,7 @@
     {
       countValue--;
       button1.Text = &quot;Apply (&quot; + countValue + &quot;)&quot;;
-      if (countValue == 0) {
-        button1.PerformClick();
-      }
+      if (countValue == 0) button1.PerformClick();
     }
 
     private void FormAccount_FormClosing(object sender, FormClosingEventArgs e)

Modified: trunk/tools/springie/Springie/FormCurrentBattle.cs
===================================================================
--- trunk/tools/springie/Springie/FormCurrentBattle.cs	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/FormCurrentBattle.cs	2008-04-07 18:57:09 UTC (rev 5677)
@@ -1,10 +1,7 @@
 using System;
-using System.Collections.Generic;
 using System.ComponentModel;
-using System.Data;
-using System.Drawing;
-using System.Text;
 using System.Windows.Forms;
+using Springie.autohost;
 using Springie.Client;
 using Springie.SpringNamespace;
 
@@ -12,53 +9,17 @@
 {
   public partial class FormCurrentBattle : Form
   {
-    protected class CurrentBattle {
+    private CurrentBattle bat = new CurrentBattle();
 
-      private string map;
-      [Category(&quot;Basic&quot;), Description(&quot;Current map&quot;), TypeConverter(typeof(Springie.AutoHostNamespace.AutoHostConfig.MapConverter))]
-      public string Map
-      {
-        get { return map; }
-        set { map = value; }
-      }
-
-      private bool locked;
-      [Category(&quot;Basic&quot;), Description(&quot;Is game locked?&quot;)]
-      public bool Locked
-      {
-        get { return locked; }
-        set { locked = value; }
-      }
-
-      
-      private BattleDetails battleDetails;
-      [Category(&quot;Details&quot;), Description(&quot;Battle details&quot;)]
-      public BattleDetails BattleDetails
-      {
-        get { return battleDetails; }
-        set { battleDetails = value; }
-      }
-      
-      private UnitInfo[] disabledUnits;
-      [Category(&quot;Disabled units&quot;), Description(&quot;List of currently disabled units&quot;)]
-      public UnitInfo[] DisabledUnits
-      {
-        get { return disabledUnits; }
-        set { disabledUnits = value; }
-      }
-
-    };
-
-    CurrentBattle bat = new CurrentBattle();
-
     public FormCurrentBattle()
     {
       InitializeComponent();
     }
 
-    private void LoadCurrentData() {
-      Battle b = Program.main.Tas.GetBattle();     
-      if (b!=null) {
+    private void LoadCurrentData()
+    {
+      Battle b = Program.main.Tas.GetBattle();
+      if (b != null) {
         bat.BattleDetails = b.Details;
         bat.Map = b.Map.Name;
         bat.Locked = b.IsLocked;
@@ -67,7 +28,8 @@
       }
     }
 
-    private void SaveCurrentData() {
+    private void SaveCurrentData()
+    {
       Battle b = Program.main.Tas.GetBattle();
       if (b != null) {
         Program.main.Tas.UpdateBattleDetails(bat.BattleDetails);
@@ -85,7 +47,7 @@
       propertyGrid1.SelectedObject = bat;
     }
 
-    void Tas_Changed(object sender, TasEventArgs e)
+    private void Tas_Changed(object sender, TasEventArgs e)
     {
       LoadCurrentData();
     }
@@ -95,5 +57,48 @@
       SaveCurrentData();
     }
 
+    #region Nested type: CurrentBattle
+    protected class CurrentBattle
+    {
+      private BattleDetails battleDetails;
+      private UnitInfo[] disabledUnits;
+      private bool locked;
+      private string map;
+
+      [Category(&quot;Basic&quot;)]
+      [Description(&quot;Current map&quot;)]
+      [TypeConverter(typeof(AutoHostConfig.MapConverter))]
+      public string Map
+      {
+        get { return map; }
+        set { map = value; }
+      }
+
+      [Category(&quot;Basic&quot;)]
+      [Description(&quot;Is game locked?&quot;)]
+      public bool Locked
+      {
+        get { return locked; }
+        set { locked = value; }
+      }
+
+
+      [Category(&quot;Details&quot;)]
+      [Description(&quot;Battle details&quot;)]
+      public BattleDetails BattleDetails
+      {
+        get { return battleDetails; }
+        set { battleDetails = value; }
+      }
+
+      [Category(&quot;Disabled units&quot;)]
+      [Description(&quot;List of currently disabled units&quot;)]
+      public UnitInfo[] DisabledUnits
+      {
+        get { return disabledUnits; }
+        set { disabledUnits = value; }
+      }
+    } ;
+    #endregion
   }
 }
\ No newline at end of file

Modified: trunk/tools/springie/Springie/FormMain.cs
===================================================================
--- trunk/tools/springie/Springie/FormMain.cs	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/FormMain.cs	2008-04-07 18:57:09 UTC (rev 5677)
@@ -1,27 +1,20 @@
 using System;
-using System.Collections.Generic;
-using System.ComponentModel;
-using System.Data;
+using System.Diagnostics;
 using System.Drawing;
-using System.Text;
 using System.Windows.Forms;
-using Springie;
-using System.Threading;
-using System.Globalization;
-using Springie.Properties;
+using Springie.autohost;
 using Springie.Client;
-using Springie.AutoHostNamespace;
-using System.Diagnostics;
+using Springie.Properties;
 
 namespace Springie
 {
   public partial class FormMain : Form
   {
-    bool exitOnSpringExit = false;
-    RichTextBox tServer;
-    RichTextBox tBattle;
-    Main main = Program.main;
-    ToolStripMenuItem hostingPriorityMenu;
+    private bool exitOnSpringExit = false;
+    private ToolStripMenuItem hostingPriorityMenu;
+    private Main main = Program.main;
+    private RichTextBox tBattle;
+    private RichTextBox tServer;
 
     public FormMain()
     {
@@ -29,10 +22,6 @@
       InitializeComponent();
     }
 
-    private delegate void Event(object sender, EventArgs args);
-
-    private delegate void TasEvent(object sender, TasEventArgs args);
-
     public void OnFailure(object sender, TasEventArgs args)
     {
       if (InvokeRequired) Invoke(new TasEvent(OnFailure), sender, args);
@@ -43,8 +32,6 @@
     }
 
 
-
-    private delegate void SayEvent(object sender, TasSayEventArgs args);
     public void OnSaid(object sender, TasSayEventArgs args)
     {
       if (InvokeRequired) Invoke(new SayEvent(OnSaid), sender, args);
@@ -88,7 +75,7 @@
       return rt;
     }
 
-    void rt_TextChanged(object sender, EventArgs e)
+    private void rt_TextChanged(object sender, EventArgs e)
     {
       RichTextBox rt = (RichTextBox)sender;
       rt.ScrollToCaret();
@@ -118,7 +105,6 @@
       main.Spring.SpringStarted += new EventHandler(Spring_SpringStarted);
       main.Spring.SpringExited += new EventHandler(Spring_SpringExited);
 
-
       // hosting priority submenu
       hostingPriorityMenu = new ToolStripMenuItem(&quot;Hosting priority&quot;);
       springToolStripMenuItem.DropDownItems.Add(hostingPriorityMenu);
@@ -134,28 +120,25 @@
       tabControl.TabPages.Clear();
       tServer = GetTab(&quot;$server&quot;);
       tBattle = GetTab(&quot;@battle&quot;);
-
-
     }
 
-    void Tas_BattleUserStatusChanged(object sender, TasEventArgs e)
+    private void Tas_BattleUserStatusChanged(object sender, TasEventArgs e)
     {
       UpdateStatusInfo();
     }
 
-    void Tas_BattleMapChanged(object sender, TasEventArgs e)
+    private void Tas_BattleMapChanged(object sender, TasEventArgs e)
     {
       UpdateStatusInfo();
     }
 
-    void Tas_BattleOpened(object sender, TasEventArgs e)
+    private void Tas_BattleOpened(object sender, TasEventArgs e)
     {
       UpdateStatusInfo();
     }
 
 
-    
-    void ts_PriorityChangeClick(object sender, EventArgs e)
+    private void ts_PriorityChangeClick(object sender, EventArgs e)
     {
       ToolStripMenuItem i = sender as ToolStripMenuItem;
       if (i != null) {
@@ -168,52 +151,44 @@
       }
     }
 
-    void Tas_BattleClosed(object sender, TasEventArgs e)
+    private void Tas_BattleClosed(object sender, TasEventArgs e)
     {
       if (InvokeRequired) Invoke(new TasEvent(Tas_BattleClosed), sender, e);
-      else {
-        listBoxBattle.Items.Clear();
-      }
+      else listBoxBattle.Items.Clear();
     }
 
-    void Tas_UserStatusChanged(object sender, TasEventArgs e)
+    private void Tas_UserStatusChanged(object sender, TasEventArgs e)
     {
       if (InvokeRequired) Invoke(new TasEvent(Tas_UserStatusChanged), sender, e);
       else {
         string nam = e.ServerParams[0];
         int i = GetUserIndex(listBoxChannel, nam);
-        if (i != -1) {
-          listBoxChannel.Items[i] = UpdateNameWithCountryAfkAndGame(nam);
-        }
+        if (i != -1) listBoxChannel.Items[i] = UpdateNameWithCountryAfkAndGame(nam);
 
         i = GetUserIndex(listBoxBattle, nam);
-        if (i != -1) {
-          listBoxBattle.Items[i] = UpdateNameWithCountryAfkAndGame(nam);
-        }
+        if (i != -1) listBoxBattle.Items[i] = UpdateNameWithCountryAfkAndGame(nam);
       }
     }
 
-    private int GetUserIndex(System.Windows.Forms.ListBox lb, string name)
+    private int GetUserIndex(ListBox lb, string name)
     {
-      for (int i = 0; i &lt; lb.Items.Count; ++i) {
-        if (lb.Items[i].ToString().StartsWith(name + &quot; &quot;)) return i;
-      }
+      for (int i = 0; i &lt; lb.Items.Count; ++i) if (lb.Items[i].ToString().StartsWith(name + &quot; &quot;)) return i;
       return -1;
     }
 
-    void Tas_ChannelLeft(object sender, TasEventArgs e)
+    private void Tas_ChannelLeft(object sender, TasEventArgs e)
     {
       if (InvokeRequired) Invoke(new TasEvent(Tas_ChannelLeft), sender, e);
       else tabControl.TabPages.RemoveByKey(&quot;#&quot; + e.ServerParams[0]);
     }
 
-    void Tas_ChannelJoined(object sender, TasEventArgs e)
+    private void Tas_ChannelJoined(object sender, TasEventArgs e)
     {
       if (InvokeRequired) Invoke(new TasEvent(Tas_ChannelJoined), sender, e);
       else GetTab(&quot;#&quot; + e.ServerParams[0]);
     }
 
-    void Tas_ConnectionLost(object sender, TasEventArgs e)
+    private void Tas_ConnectionLost(object sender, TasEventArgs e)
     {
       if (InvokeRequired) Invoke(new TasEvent(Tas_ConnectionLost), sender, e);
       else {
@@ -224,48 +199,45 @@
       }
     }
 
-    void Spring_SpringExited(object sender, EventArgs e)
+    private void Spring_SpringExited(object sender, EventArgs e)
     {
       if (InvokeRequired) Invoke(new Event(Spring_SpringExited), sender, e);
       else {
         notifyIcon1.Icon = Resources.ok;
-        foreach (ToolStripMenuItem t in springToolStripMenuItem.DropDownItems) {
-          t.Enabled = false;
-        }
-         if (exitOnSpringExit) {
-          Close();
-        }
-        
+        foreach (ToolStripMenuItem t in springToolStripMenuItem.DropDownItems) t.Enabled = false;
+        if (exitOnSpringExit) Close();
+
         UpdateStatusInfo();
       }
     }
 
-    void Spring_SpringStarted(object sender, EventArgs e)
+    private void Spring_SpringStarted(object sender, EventArgs e)
     {
       if (InvokeRequired) Invoke(new Event(Spring_SpringStarted), sender, e);
       else {
         notifyIcon1.Icon = Resources.run;
-        
-        foreach (ToolStripMenuItem t in springToolStripMenuItem.DropDownItems) {
-          t.Enabled = true;
-        }
+
+        foreach (ToolStripMenuItem t in springToolStripMenuItem.DropDownItems) t.Enabled = true;
         UpdateSpringPriorityMenu(hostingPriorityMenu, main.config.HostingProcessPriority);
         showhideHostingWindowToolStripMenuItem.Checked = main.Spring.SpringWindowHidden;
-        
+
         UpdateStatusInfo();
       }
     }
 
 
-    private void UpdateSpringPriorityMenu(ToolStripMenuItem menu, ProcessPriorityClass priority) {
-      foreach (ToolStripMenuItem c in menu.DropDownItems) { // list through priorities
-        if (c.Text == priority.ToString()) {  // we found priority, set it up
+    private void UpdateSpringPriorityMenu(ToolStripMenuItem menu, ProcessPriorityClass priority)
+    {
+      foreach (ToolStripMenuItem c in menu.DropDownItems) {
+        // list through priorities
+        if (c.Text == priority.ToString()) {
+          // we found priority, set it up
           c.Checked = true;
         } else c.Checked = false;
       }
     }
 
-    void Tas_BattleUserLeft(object sender, TasEventArgs e)
+    private void Tas_BattleUserLeft(object sender, TasEventArgs e)
     {
       if (InvokeRequired) Invoke(new TasEvent(Tas_BattleUserLeft), sender, e);
       else {
@@ -275,7 +247,7 @@
       }
     }
 
-    void Tas_BattleUserJoined(object sender, TasEventArgs e)
+    private void Tas_BattleUserJoined(object sender, TasEventArgs e)
     {
       if (InvokeRequired) Invoke(new TasEvent(Tas_BattleUserJoined), sender, e);
       else {
@@ -291,7 +263,7 @@
       }
     }
 
-    void Tas_UserRemoved(object sender, TasEventArgs e)
+    private void Tas_UserRemoved(object sender, TasEventArgs e)
     {
       if (InvokeRequired) Invoke(new TasEvent(Tas_UserRemoved), sender, e);
       else {
@@ -309,7 +281,7 @@
     }
 
 
-    void Tas_UserAdded(object sender, TasEventArgs e)
+    private void Tas_UserAdded(object sender, TasEventArgs e)
     {
       if (InvokeRequired) Invoke(new TasEvent(Tas_UserAdded), sender, e);
       else {
@@ -325,8 +297,7 @@
     }
 
 
-
-    void Tas_Connected(object sender, TasEventArgs e)
+    private void Tas_Connected(object sender, TasEventArgs e)
     {
       if (InvokeRequired) Invoke(new TasEvent(Tas_Connected), sender, e);
       else {
@@ -354,9 +325,8 @@
             return;
           default:
             User u;
-            if (!main.Tas.GetExistingUser(tab, out u)) {
-              GetTab(tab).AppendText(&quot;ERROR: user left\r\n&quot;);
-            } else main.Tas.Say(TasClient.SayPlace.User, tab, textBox.Text, false);
+            if (!main.Tas.GetExistingUser(tab, out u)) GetTab(tab).AppendText(&quot;ERROR: user left\r\n&quot;);
+            else main.Tas.Say(TasClient.SayPlace.User, tab, textBox.Text, false);
             break;
         }
         textBox.Text = &quot;&quot;;
@@ -384,9 +354,7 @@
             break;
           }
         }
-        if (ind &gt; 1 &amp;&amp; ind &lt; tabControl.TabCount) {
-          if (tabControl.TabPages[ind].Name[0] != '#') tabControl.TabPages.RemoveAt(ind);
-        }
+        if (ind &gt; 1 &amp;&amp; ind &lt; tabControl.TabCount) if (tabControl.TabPages[ind].Name[0] != '#') tabControl.TabPages.RemoveAt(ind);
       }
     }
 
@@ -404,13 +372,10 @@
 
     private void Form1_SizeChanged(object sender, EventArgs e)
     {
-      if (this.WindowState == FormWindowState.Minimized) {
-        Visible = false;
-      }
+      if (WindowState == FormWindowState.Minimized) Visible = false;
     }
 
 
-    private delegate void DelegEmpty();
     public void GetNewLogPass()
     {
       if (InvokeRequired) Invoke(new DelegEmpty(GetNewLogPass));
@@ -459,8 +424,8 @@
 
     private void rehostToolStripMenuItem_Click(object sender, EventArgs e)
     {
-      if (!main.Tas.IsConnected || !main.Tas.IsLoggedIn) main.ReLogin(); else 
-      main.AutoHost.ComRehost(TasSayEventArgs.Default, new string[] { });
+      if (!main.Tas.IsConnected || !main.Tas.IsLoggedIn) main.ReLogin();
+      else main.AutoHost.ComRehost(TasSayEventArgs.Default, new string[] {});
     }
 
     private void reloadModsMapsToolStripMenuItem_Click(object sender, EventArgs e)
@@ -476,31 +441,32 @@
     }
 
 
-    private void UpdateStatusInfo() {
-      if (InvokeRequired) Invoke(new DelegEmpty(UpdateStatusInfo)); else 
-      try {
-        if (!main.Tas.IsLoggedIn) return;
-        Client.Battle b = main.Tas.GetBattle();
-        if (b == null) return;
+    private void UpdateStatusInfo()
+    {
+      if (InvokeRequired) Invoke(new DelegEmpty(UpdateStatusInfo));
+      else {
+        try {
+          if (!main.Tas.IsLoggedIn) return;
+          Battle b = main.Tas.GetBattle();
+          if (b == null) return;
 
-        int players = b.Users.Count - b.CountSpectators();
+          int players = b.Users.Count - b.CountSpectators();
 
-        toolStripStatusLabel1.Text = &quot;on since: &quot; + Program.startupTime.ToString(&quot;g&quot;);
-        toolStripStatusLabel2.Text = &quot;players: &quot; + players + &quot;/&quot; + b.MaxPlayers;
-        toolStripStatusLabel3.Text = &quot;mod: &quot; + b.Mod.Name;
-        toolStripStatusLabel4.Text = &quot;map: &quot; + b.Map.Name;
-        toolStripStatusLabel5.Text = &quot;last game: &quot; + (main.Spring.GameStarted != DateTime.MinValue ? main.Spring.GameStarted.ToString(&quot;g&quot;) : &quot;never&quot;);
+          toolStripStatusLabel1.Text = &quot;on since: &quot; + Program.startupTime.ToString(&quot;g&quot;);
+          toolStripStatusLabel2.Text = &quot;players: &quot; + players + &quot;/&quot; + b.MaxPlayers;
+          toolStripStatusLabel3.Text = &quot;mod: &quot; + b.Mod.Name;
+          toolStripStatusLabel4.Text = &quot;map: &quot; + b.Map.Name;
+          toolStripStatusLabel5.Text = &quot;last game: &quot; + (main.Spring.GameStarted != DateTime.MinValue ? main.Spring.GameStarted.ToString(&quot;g&quot;) : &quot;never&quot;);
 
-        
+          if (!main.Spring.IsRunning) {
+            if (players &gt; 0) {
+              if (notifyIcon1.Icon != Resources.joined) notifyIcon1.Icon = Resources.joined;
+            } else if (notifyIcon1.Icon != Resources.ok) notifyIcon1.Icon = Resources.ok;
+          }
 
-        if (!main.Spring.IsRunning) {
-          if (players &gt; 0) {
-            if (notifyIcon1.Icon != Resources.joined) notifyIcon1.Icon = Resources.joined;
-          } else if (notifyIcon1.Icon != Resources.ok) notifyIcon1.Icon = Resources.ok;
-        }
-
-        notifyIcon1.Text = players + &quot;/&quot; + b.MaxPlayers + &quot;\r\n&quot; + b.Map.Name + &quot;\r\n&quot; + (main.Spring.GameStarted != DateTime.MinValue ? main.Spring.GameStarted.ToString(&quot;g&quot;) : &quot;never&quot;);
-      } catch {}
+          notifyIcon1.Text = players + &quot;/&quot; + b.MaxPlayers + &quot;\r\n&quot; + b.Map.Name + &quot;\r\n&quot; + (main.Spring.GameStarted != DateTime.MinValue ? main.Spring.GameStarted.ToString(&quot;g&quot;) : &quot;never&quot;);
+        } catch {}
+      }
     }
 
     private void currentBattleToolStripMenuItem_Click(object sender, EventArgs e)
@@ -508,5 +474,21 @@
       FormCurrentBattle s = new FormCurrentBattle();
       s.ShowDialog();
     }
+
+    #region Nested type: DelegEmpty
+    private delegate void DelegEmpty();
+    #endregion
+
+    #region Nested type: Event
+    private delegate void Event(object sender, EventArgs args);
+    #endregion
+
+    #region Nested type: SayEvent
+    private delegate void SayEvent(object sender, TasSayEventArgs args);
+    #endregion
+
+    #region Nested type: TasEvent
+    private delegate void TasEvent(object sender, TasEventArgs args);
+    #endregion
   }
-}
+}
\ No newline at end of file

Modified: trunk/tools/springie/Springie/FormSettings.cs
===================================================================
--- trunk/tools/springie/Springie/FormSettings.cs	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/FormSettings.cs	2008-04-07 18:57:09 UTC (rev 5677)
@@ -1,15 +1,9 @@
 using System;
-using System.Collections.Generic;
-using System.ComponentModel;
-using System.Data;
-using System.Drawing;
-using System.Text;
 using System.Windows.Forms;
-using Springie.AutoHostNamespace;
+using Springie.autohost;
 
 namespace Springie
 {
-
   public partial class FormSettings : Form
   {
     public FormSettings()
@@ -21,17 +15,15 @@
     {
       propertyGrid1.SelectedObject = Program.main.config;
       propertyGrid2.SelectedObject = Program.main.AutoHost.config;
-      
-      foreach (CommandConfig c in Program.main.AutoHost.config.Commands) {
-        listBox1.Items.Add(c.Name);
-      }
 
+      foreach (CommandConfig c in Program.main.AutoHost.config.Commands) listBox1.Items.Add(c.Name);
+
       propertyGrid5.TextChanged += new EventHandler(propertyGrid5_TextChanged);
       LoadAdmins();
       LoadPresets();
     }
 
-    void propertyGrid5_TextChanged(object sender, EventArgs e)
+    private void propertyGrid5_TextChanged(object sender, EventArgs e)
     {
       LoadAdmins();
     }
@@ -46,20 +38,19 @@
     /************************************************************************/
     /*      ADMINS                                                          */
     /************************************************************************/
+
     private void LoadAdmins()
     {
       listBoxAdmins.Items.Clear();
       listBoxAdmins.Items.Add(&quot;[ Add new admin... ]&quot;);
-      foreach (PrivilegedUser p in Program.main.AutoHost.config.PrivilegedUsers) {
-        listBoxAdmins.Items.Add(p.Name);
-      }
+      foreach (PrivilegedUser p in Program.main.AutoHost.config.PrivilegedUsers) listBoxAdmins.Items.Add(p.Name);
     }
 
 
     private void listBoxAdmins_SelectedIndexChanged(object sender, EventArgs e)
     {
       if (listBoxAdmins.SelectedIndex == -1) return;
-      if (listBoxAdmins.SelectedIndex==0) {
+      if (listBoxAdmins.SelectedIndex == 0) {
         propertyGrid5.SelectedObject = new PrivilegedUser();
         buttonDelete.Visible = false;
         buttonAdd.Visible = true;
@@ -94,13 +85,12 @@
     /************************************************************************/
     /*    PRESETS                                                           */
     /************************************************************************/
+
     private void LoadPresets()
     {
       listBoxPresets.Items.Clear();
       listBoxPresets.Items.Add(&quot;[ Add new preset... ]&quot;);
-      foreach (Preset p in Program.main.AutoHost.presets) {
-        listBoxPresets.Items.Add(p.Name);
-      }
+      foreach (Preset p in Program.main.AutoHost.presets) listBoxPresets.Items.Add(p.Name);
     }
 
 

Modified: trunk/tools/springie/Springie/Main.cs
===================================================================
--- trunk/tools/springie/Springie/Main.cs	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/Main.cs	2008-04-07 18:57:09 UTC (rev 5677)
@@ -1,56 +1,54 @@
 using System;
-using System.Collections.Generic;
-using System.Text;
-using System.Xml.Serialization;
 using System.IO;
 using System.Timers;
 using System.Windows.Forms;
-using System.ComponentModel;
+using System.Xml.Serialization;
+using Springie.autohost;
 using Springie.Client;
 using Springie.SpringNamespace;
-using Springie.AutoHostNamespace;
-using System.Diagnostics;
+using Timer=System.Timers.Timer;
 
 namespace Springie
 {
   public class Main
   {
-    public MainConfig config;
     public const string ConfigMain = &quot;main.xml&quot;;
-    System.Timers.Timer recon;
+    private AutoHost autoHost;
+    private AutoUpdater autoUpdater;
+    public MainConfig config;
+    private Timer recon;
+    private Spring spring;
 
-    Stats stats;
-    public Stats Stats {
+    private Stats stats;
+
+    private TasClient tas;
+
+    public Main()
+    {
+      LoadConfig();
+      SaveConfig();
+    }
+
+    public Stats Stats
+    {
       get { return stats; }
     }
 
-    TasClient tas;
     public TasClient Tas
     {
-      get
-      {
-        return tas;
-      }
+      get { return tas; }
     }
-    Spring spring;
+
     public Spring Spring
     {
-      get
-      {
-        return spring;
-      }
+      get { return spring; }
     }
-    AutoHost autoHost;
+
     public AutoHost AutoHost
     {
-      get
-      {
-        return autoHost;
-      }
+      get { return autoHost; }
     }
 
-    private AutoUpdater autoUpdater;
-
     public void LoadConfig()
     {
       config = new MainConfig();
@@ -64,25 +62,17 @@
 
     public void SaveConfig()
     {
-
       XmlSerializer s = new XmlSerializer(config.GetType());
       FileStream f = File.OpenWrite(Application.StartupPath + '/' + ConfigMain);
       f.SetLength(0);
       s.Serialize(f, config);
       f.Close();
-
     }
 
-    public Main()
-    {
-      LoadConfig();
-      SaveConfig();
-    }
-
     public bool Start()
     {
       if (config.AttemptToRecconnect) {
-        recon = new System.Timers.Timer(config.AttemptReconnectInterval * 1000);
+        recon = new Timer(config.AttemptReconnectInterval*1000);
         recon.Elapsed += new ElapsedEventHandler(recon_Elapsed);
       }
 
@@ -120,7 +110,6 @@
         }
       }
 
-
       tas = new TasClient();
       tas.ConnectionLost += new EventHandler&lt;TasEventArgs&gt;(tas_ConnectionLost);
       tas.Connected += new EventHandler&lt;TasEventArgs&gt;(tas_Connected);
@@ -143,7 +132,7 @@
       return true;
     }
 
-    void spring_SpringStarted(object sender, EventArgs e)
+    private void spring_SpringStarted(object sender, EventArgs e)
     {
       if (Program.main.config.AllowInGameJoin) {
         tas.ChangeMyStatus(false, false);
@@ -152,29 +141,29 @@
     }
 
 
-    public void Stop() {
+    public void Stop()
+    {
       tas.ConnectionLost -= tas_ConnectionLost;
       tas.Disconnect();
     }
 
-    void tas_MyStatusChangedToInGame(object sender, TasEventArgs e)
+    private void tas_MyStatusChangedToInGame(object sender, TasEventArgs e)
     {
       spring.StartGame(tas.GetBattle());
     }
 
-    void tas_Said(object sender, TasSayEventArgs e)
+    private void tas_Said(object sender, TasSayEventArgs e)
     {
-      if (config.RedirectGameChat &amp;&amp; e.Place == TasSayEventArgs.Places.Battle &amp;&amp; e.Origin == TasSayEventArgs.Origins.Player &amp;&amp; e.UserName != tas.UserName &amp;&amp; e.IsEmote == false &amp;&amp; !Program.main.config.AllowInGameJoin) { // TODO disable disabled redirect for allow ingame joins
+      if (config.RedirectGameChat &amp;&amp; e.Place == TasSayEventArgs.Places.Battle &amp;&amp; e.Origin == TasSayEventArgs.Origins.Player &amp;&amp; e.UserName != tas.UserName &amp;&amp; e.IsEmote == false &amp;&amp; !Program.main.config.AllowInGameJoin) {
+        // TODO disable disabled redirect for allow ingame joins
         spring.SayGame(&quot;[&quot; + e.UserName + &quot;]&quot; + e.Text);
       }
     }
 
-    void spring_PlayerSaid(object sender, SpringLogEventArgs e)
+    private void spring_PlayerSaid(object sender, SpringLogEventArgs e)
     {
       tas.GameSaid(e.Username, e.Line);
-      if (config.RedirectGameChat &amp;&amp; e.Username != tas.UserName &amp;&amp; !e.Line.StartsWith(&quot;Allies:&quot;) &amp;&amp; !e.Line.StartsWith(&quot;Spectators:&quot;)) {
-        tas.Say(TasClient.SayPlace.Battle, &quot;&quot;, &quot;[&quot; + e.Username + &quot;]&quot; + e.Line, false);
-      }
+      if (config.RedirectGameChat &amp;&amp; e.Username != tas.UserName &amp;&amp; !e.Line.StartsWith(&quot;Allies:&quot;) &amp;&amp; !e.Line.StartsWith(&quot;Spectators:&quot;)) tas.Say(TasClient.SayPlace.Battle, &quot;&quot;, &quot;[&quot; + e.Username + &quot;]&quot; + e.Line, false);
     }
 
     public void ReLogin()
@@ -182,35 +171,33 @@
       tas_Connected(this, new TasEventArgs());
     }
 
-    void tas_LoginDenied(object sender, TasEventArgs e)
+    private void tas_LoginDenied(object sender, TasEventArgs e)
     {
       //MessageBox.Show(e.ServerParams[0], &quot;Login failed&quot;, MessageBoxButtons.OK, MessageBoxIcon.Warning);
       Program.formMain.GetNewLogPass();
     }
 
-    void spring_SpringExited(object sender, EventArgs e)
+    private void spring_SpringExited(object sender, EventArgs e)
     {
       if (tas != null) tas.ChangeMyStatus(false, false);
     }
 
 
     // login accepted - join channels
-    void tas_LoginAccepted(object sender, TasEventArgs e)
+    private void tas_LoginAccepted(object sender, TasEventArgs e)
     {
-      for (int i = 0; i &lt; config.JoinChannels.Length; ++i) {
-        tas.JoinChannel(config.JoinChannels[i]);
-      }
+      for (int i = 0; i &lt; config.JoinChannels.Length; ++i) tas.JoinChannel(config.JoinChannels[i]);
       autoHost.Start(null, null);
     }
 
     // im connected, let's login
-    void tas_Connected(object sender, TasEventArgs e)
+    private void tas_Connected(object sender, TasEventArgs e)
     {
       tas.Login(config.AccountName, config.AccountPassword, MainConfig.SpringieVersion);
     }
 
 
-    void recon_Elapsed(object sender, ElapsedEventArgs e)
+    private void recon_Elapsed(object sender, ElapsedEventArgs e)
     {
       recon.Stop();
       try {
@@ -220,10 +207,10 @@
       }
     }
 
-    void tas_ConnectionLost(object sender, TasEventArgs e)
+    private void tas_ConnectionLost(object sender, TasEventArgs e)
     {
       autoHost.Stop();
-      recon.Start(); 
+      recon.Start();
     }
   }
-}
+}
\ No newline at end of file

Modified: trunk/tools/springie/Springie/MainConfig.cs
===================================================================
--- trunk/tools/springie/Springie/MainConfig.cs	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/MainConfig.cs	2008-04-07 18:57:09 UTC (rev 5677)
@@ -1,16 +1,53 @@
-using System;
-using System.Collections.Generic;
-using System.Text;
+using System.ComponentModel;
 using System.Diagnostics;
-using System.ComponentModel;
 
 namespace Springie
 {
   public class MainConfig
   {
-    public const string SpringieVersion = &quot;Springie 1.16&quot;;
+    #region CaUpdateMode enum
+    public enum CaUpdateMode
+    {
+      None,
+      Stable,
+      Latest
+    } ;
+    #endregion
 
-    bool autoUpdate = true;
+    #region ErrorHandlingModes enum
+    public enum ErrorHandlingModes : int
+    {
+      Debug,
+      Suppress,
+      MessageBox
+    }
+    #endregion
+
+    public const string SpringieVersion = &quot;Springie 1.16b2&quot;;
+    private string accountName = &quot;login&quot;;
+    private string accountPassword = &quot;pass&quot;;
+    private bool allowInGameJoin = false;
+    private int attemptReconnectInterval = 60;
+    private bool attemptToRecconnect = true;
+
+    private bool autoUpdate = true;
+    private CaUpdateMode caUpdating;
+    private ErrorHandlingModes errorHandlingMode = ErrorHandlingModes.Suppress;
+    private bool gargamelMode = true;
+    private ProcessPriorityClass hostingProcessPriority = ProcessPriorityClass.AboveNormal;
+    private string[] joinChannels = new string[] {&quot;main&quot;};
+    private bool redirectGameChat = true;
+    private string serverHost = &quot;taspringmaster.clan-sy.com&quot;;
+    private int serverPort = 8200;
+    private bool springFullscreen = false;
+    private string springPath = &quot;./&quot;;
+    private int springResolutionX = 40;
+    private int springResolutionY = 40;
+    private bool springStartsHidden = true;
+    private bool springStartsMinimized = true;
+    private bool statsEnabled = true;
+    private string statsUrlAddress = &quot;<A HREF="http://licho.iamacup.com/">http://licho.iamacup.com/</A>&quot;;
+
     [Description(&quot;Should Springie automatically update itself to latest version?&quot;)]
     [Category(&quot;Springie&quot;)]
     public bool AutoUpdate
@@ -19,11 +56,6 @@
       set { autoUpdate = value; }
     }
 
-
-
-
-    public enum CaUpdateMode {None, Stable, Latest};
-    CaUpdateMode caUpdating;
     [Description(&quot;If you run CA updater on the server Springie can autorehost for stable or latest version of it&quot;)]
     [Category(&quot;Springie&quot;)]
     public CaUpdateMode CaUpdating
@@ -32,9 +64,7 @@
       set { caUpdating = value; }
     }
 
-   
-    
-    bool attemptToRecconnect = true;
+
     [Description(&quot;Should attempt to reconnect to server in case of failure?&quot;)]
     [Category(&quot;Server connection&quot;)]
     public bool AttemptToRecconnect
@@ -42,7 +72,6 @@
       get { return attemptToRecconnect; }
       set { attemptToRecconnect = value; }
     }
-    int attemptReconnectInterval = 60;
 
 
     [Description(&quot;Time interval before reconnection attempt in seconds&quot;)]
@@ -53,7 +82,6 @@
       set { attemptReconnectInterval = value; }
     }
 
-    string serverHost = &quot;taspringmaster.clan-sy.com&quot;;
     [Description(&quot;Lobby server hostname&quot;)]
     [Category(&quot;Server connection&quot;)]
     public string ServerHost
@@ -62,7 +90,6 @@
       set { serverHost = value; }
     }
 
-    int serverPort = 8200;
     [Description(&quot;Lobby server port&quot;)]
     [Category(&quot;Server connection&quot;)]
     public int ServerPort
@@ -72,17 +99,19 @@
     }
 
 
-    string statsUrlAddress = &quot;<A HREF="http://licho.iamacup.com/">http://licho.iamacup.com/</A>&quot;;
     [Description(&quot;Url of stats data gathering service&quot;)]
     [Category(&quot;Server connection&quot;)]
     public string StatsUrlAddress
     {
       get { return statsUrlAddress; }
-      set { if (!value.EndsWith(&quot;/&quot;)) value += &quot;/&quot;; statsUrlAddress = value; }
+      set
+      {
+        if (!value.EndsWith(&quot;/&quot;)) value += &quot;/&quot;;
+        statsUrlAddress = value;
+      }
     }
 
 
-    bool gargamelMode = true;
     [Description(&quot;Should this autohost work in gargamel mode (catch smurfs)&quot;)]
     [Category(&quot;Server connection&quot;)]
     public bool GargamelMode
@@ -92,7 +121,6 @@
     }
 
 
-    bool statsEnabled = true;
     [Description(&quot;Should this server report data to stats server?&quot;)]
     [Category(&quot;Server connection&quot;)]
     public bool StatsEnabled
@@ -101,7 +129,6 @@
       set { statsEnabled = value; }
     }
 
-    string accountName = &quot;login&quot;;
     [Description(&quot;Login name&quot;)]
     [Category(&quot;Account&quot;)]
     public string AccountName
@@ -109,7 +136,6 @@
       get { return accountName; }
       set { accountName = value; }
     }
-    string accountPassword = &quot;pass&quot;;
 
     [Description(&quot;Your login password&quot;)]
     [Category(&quot;Account&quot;)]
@@ -119,7 +145,6 @@
       set { accountPassword = value; }
     }
 
-    string springPath = &quot;./&quot;;
     [Description(&quot;Path to your spring directory folder&quot;)]
     [Category(&quot;Spring&quot;)]
     public string SpringPath
@@ -128,7 +153,6 @@
       set { springPath = value; }
     }
 
-    string[] joinChannels = new string[] { &quot;main&quot; };
     [Description(&quot;Which channels to join on startup&quot;)]
     [Category(&quot;Spring&quot;)]
     public string[] JoinChannels
@@ -138,24 +162,24 @@
     }
 
 
-    int springResolutionX = 40;
-    [Category(&quot;Spring&quot;), Description(&quot;Default hosting spring window width&quot;)]
+    [Category(&quot;Spring&quot;)]
+    [Description(&quot;Default hosting spring window width&quot;)]
     public int SpringResolutionX
     {
       get { return springResolutionX; }
       set { springResolutionX = value; }
     }
 
-    int springResolutionY = 40;
-    [Category(&quot;Spring&quot;), Description(&quot;Default hosting spring window height&quot;)]
+    [Category(&quot;Spring&quot;)]
+    [Description(&quot;Default hosting spring window height&quot;)]
     public int SpringResolutionY
     {
       get { return springResolutionY; }
       set { springResolutionY = value; }
     }
 
-    bool springFullscreen = false;
-    [Category(&quot;Spring&quot;), Description(&quot;Should hosting spring start as fullscreen&quot;)]
+    [Category(&quot;Spring&quot;)]
+    [Description(&quot;Should hosting spring start as fullscreen&quot;)]
     public bool SpringFullscreen
     {
       get { return springFullscreen; }
@@ -163,24 +187,24 @@
     }
 
 
-    bool springStartsHidden = true;
-    [Category(&quot;Spring&quot;), Description(&quot;Should hosting spring start hidden by default&quot;)]
+    [Category(&quot;Spring&quot;)]
+    [Description(&quot;Should hosting spring start hidden by default&quot;)]
     public bool SpringStartsHidden
     {
       get { return springStartsHidden; }
       set { springStartsHidden = value; }
     }
 
-    bool springStartsMinimized = true;
-    [Category(&quot;Spring&quot;), Description(&quot;Should hosting spring start minimized by default&quot;)]
+    [Category(&quot;Spring&quot;)]
+    [Description(&quot;Should hosting spring start minimized by default&quot;)]
     public bool SpringStartsMinimized
     {
       get { return springStartsMinimized; }
       set { springStartsMinimized = value; }
     }
 
-    bool redirectGameChat = true;
-    [Category(&quot;Spring&quot;), Description(&quot;Should springie redirect global game chat to lobby?&quot;)]
+    [Category(&quot;Spring&quot;)]
+    [Description(&quot;Should springie redirect global game chat to lobby?&quot;)]
     public bool RedirectGameChat
     {
       get { return redirectGameChat; }
@@ -188,15 +212,14 @@
     }
 
 
-    ProcessPriorityClass hostingProcessPriority = ProcessPriorityClass.AboveNormal;
-    [Category(&quot;Spring&quot;), Description(&quot;Sets the priority of spring hosting process&quot;)]
+    [Category(&quot;Spring&quot;)]
+    [Description(&quot;Sets the priority of spring hosting process&quot;)]
     public ProcessPriorityClass HostingProcessPriority
     {
       get { return hostingProcessPriority; }
       set { hostingProcessPriority = value; }
     }
 
-    bool allowInGameJoin = false;
     [Description(&quot;Should Springie allow people to join it while game is in progress?&quot;)]
     [Category(&quot;Spring&quot;)]
     public bool AllowInGameJoin
@@ -206,13 +229,12 @@
     }
 
 
-    public enum ErrorHandlingModes : int { Debug, Suppress, MessageBox }
-    ErrorHandlingModes errorHandlingMode = ErrorHandlingModes.Suppress;
-    [Category(&quot;Springie&quot;), Description(&quot;Determines the way in which Springie handles unexpected errors. For general purpose use Suppress, for instant notification and stop on error use MessageBox mode and for debugging use Debug&quot;)]
+    [Category(&quot;Springie&quot;)]
+    [Description(&quot;Determines the way in which Springie handles unexpected errors. For general purpose use Suppress, for instant notification and stop on error use MessageBox mode and for debugging use Debug&quot;)]
     public ErrorHandlingModes ErrorHandlingMode
     {
       get { return errorHandlingMode; }
       set { errorHandlingMode = value; }
     }
-  };
+  } ;
 }
\ No newline at end of file

Modified: trunk/tools/springie/Springie/Program.cs
===================================================================
--- trunk/tools/springie/Springie/Program.cs	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/Program.cs	2008-04-07 18:57:09 UTC (rev 5677)
@@ -1,29 +1,32 @@
 using System;
-using System.Collections.Generic;
+using System.Globalization;
+using System.Threading;
 using System.Windows.Forms;
 
 namespace Springie
 {
-  static class Program
+  internal static class Program
   {
+    public static FormMain formMain = null;
+
     /// &lt;summary&gt;
     /// The main entry point for the application.
     /// &lt;/summary&gt;
     public static Main main = new Main();
-    public static FormMain formMain = null;
+
     public static DateTime startupTime = DateTime.Now;
 
     [STAThread]
-    static void Main()
+    private static void Main()
     {
       // setup unhandled exception handlers
-      Application.ThreadException += new System.Threading.ThreadExceptionEventHandler(Application_ThreadException);
+      Application.ThreadException += new ThreadExceptionEventHandler(Application_ThreadException);
       AppDomain.CurrentDomain.UnhandledException += new UnhandledExceptionEventHandler(CurrentDomain_UnhandledException);
       Application.SetUnhandledExceptionMode(UnhandledExceptionMode.CatchException);
 
-      Application.CurrentCulture = System.Globalization.CultureInfo.InvariantCulture;
-      System.Threading.Thread.CurrentThread.CurrentCulture = System.Globalization.CultureInfo.InvariantCulture;
-     
+      Application.CurrentCulture = CultureInfo.InvariantCulture;
+      Thread.CurrentThread.CurrentCulture = CultureInfo.InvariantCulture;
+
       try {
         Application.EnableVisualStyles();
         Application.SetCompatibleTextRenderingDefault(false);
@@ -33,16 +36,16 @@
       }
     }
 
-    
+
     // unhandled exception in non-ui thread
-    static void CurrentDomain_UnhandledException(object sender, UnhandledExceptionEventArgs e)
+    private static void CurrentDomain_UnhandledException(object sender, UnhandledExceptionEventArgs e)
     {
       Exception ex = (Exception)e.ExceptionObject;
       if (!ErrorHandling.HandleException(ex, &quot;Secondary thread unhandled exception&quot;)) throw ex;
     }
 
     // unhandled exception in gui thread
-    static void Application_ThreadException(object sender, System.Threading.ThreadExceptionEventArgs e)
+    private static void Application_ThreadException(object sender, ThreadExceptionEventArgs e)
     {
       if (!ErrorHandling.HandleException(e.Exception, &quot;Main thread unhandled exception&quot;)) throw e.Exception;
     }

Modified: trunk/tools/springie/Springie/Properties/AssemblyInfo.cs
===================================================================
--- trunk/tools/springie/Springie/Properties/AssemblyInfo.cs	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/Properties/AssemblyInfo.cs	2008-04-07 18:57:09 UTC (rev 5677)
@@ -1,28 +1,30 @@
 &#65279;using System.Reflection;
-using System.Runtime.CompilerServices;
+using System.Resources;
 using System.Runtime.InteropServices;
-using System.Resources;
 
 // General Information about an assembly is controlled through the following 
 // set of attributes. Change these attribute values to modify the information
 // associated with an assembly.
-[assembly: AssemblyTitle(&quot;Springie&quot;)]
-[assembly: AssemblyDescription(&quot;Springie AutoHost&quot;)]
-[assembly: AssemblyConfiguration(&quot;&quot;)]
-[assembly: AssemblyCompany(&quot;Licho&quot;)]
-[assembly: AssemblyProduct(&quot;Springie&quot;)]
-[assembly: AssemblyCopyright(&quot;Copyright &#169; Licho&quot;)]
-[assembly: AssemblyTrademark(&quot;&quot;)]
-[assembly: AssemblyCulture(&quot;&quot;)]
 
+[assembly : AssemblyTitle(&quot;Springie&quot;)]
+[assembly : AssemblyDescription(&quot;Springie AutoHost&quot;)]
+[assembly : AssemblyConfiguration(&quot;&quot;)]
+[assembly : AssemblyCompany(&quot;Licho&quot;)]
+[assembly : AssemblyProduct(&quot;Springie&quot;)]
+[assembly : AssemblyCopyright(&quot;Copyright &#169; Licho&quot;)]
+[assembly : AssemblyTrademark(&quot;&quot;)]
+[assembly : AssemblyCulture(&quot;&quot;)]
+
 // Setting ComVisible to false makes the types in this assembly not visible 
 // to COM components.  If you need to access a type in this assembly from 
 // COM, set the ComVisible attribute to true on that type.
-[assembly: ComVisible(false)]
 
+[assembly : ComVisible(false)]
+
 // The following GUID is for the ID of the typelib if this project is exposed to COM
-[assembly: Guid(&quot;42c2f4e5-69ea-4dfe-9bda-5a97c8ba3b23&quot;)]
 
+[assembly : Guid(&quot;42c2f4e5-69ea-4dfe-9bda-5a97c8ba3b23&quot;)]
+
 // Version information for an assembly consists of the following four values:
 //
 //      Major Version
@@ -30,6 +32,8 @@
 //      Build Number
 //      Revision
 //
-[assembly: AssemblyVersion(&quot;0.99.*&quot;)]
+
+[assembly : AssemblyVersion(&quot;0.99.*&quot;)]
 //[assembly: AssemblyFileVersion(&quot;0.97.0.0&quot;)]
-[assembly: NeutralResourcesLanguageAttribute(&quot;en&quot;)]
+
+[assembly : NeutralResourcesLanguage(&quot;en&quot;)]
\ No newline at end of file

Modified: trunk/tools/springie/Springie/Properties/Resources.Designer.cs
===================================================================
--- trunk/tools/springie/Springie/Properties/Resources.Designer.cs	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/Properties/Resources.Designer.cs	2008-04-07 18:57:09 UTC (rev 5677)
@@ -8,91 +8,105 @@
 // &lt;/auto-generated&gt;
 //------------------------------------------------------------------------------
 
-namespace Springie.Properties {
-    using System;
-    
-    
+using System.CodeDom.Compiler;
+using System.ComponentModel;
+using System.Diagnostics;
+using System.Diagnostics.CodeAnalysis;
+using System.Drawing;
+using System.Globalization;
+using System.Resources;
+using System.Runtime.CompilerServices;
+
+namespace Springie.Properties
+{
+  /// &lt;summary&gt;
+  ///   A strongly-typed resource class, for looking up localized strings, etc.
+  /// &lt;/summary&gt;
+  // This class was auto-generated by the StronglyTypedResourceBuilder
+  // class via a tool like ResGen or Visual Studio.
+  // To add or remove a member, edit your .ResX file then rerun ResGen
+  // with the /str option, or rebuild your VS project.
+  [GeneratedCode(&quot;System.Resources.Tools.StronglyTypedResourceBuilder&quot;, &quot;2.0.0.0&quot;)]
+  [DebuggerNonUserCode()]
+  [CompilerGenerated()]
+  internal class Resources
+  {
+    private static CultureInfo resourceCulture;
+    private static ResourceManager resourceMan;
+
+    [SuppressMessage(&quot;Microsoft.Performance&quot;, &quot;CA1811:AvoidUncalledPrivateCode&quot;)]
+    internal Resources() {}
+
     /// &lt;summary&gt;
-    ///   A strongly-typed resource class, for looking up localized strings, etc.
+    ///   Returns the cached ResourceManager instance used by this class.
     /// &lt;/summary&gt;
-    // This class was auto-generated by the StronglyTypedResourceBuilder
-    // class via a tool like ResGen or Visual Studio.
-    // To add or remove a member, edit your .ResX file then rerun ResGen
-    // with the /str option, or rebuild your VS project.
-    [global::System.CodeDom.Compiler.GeneratedCodeAttribute(&quot;System.Resources.Tools.StronglyTypedResourceBuilder&quot;, &quot;2.0.0.0&quot;)]
-    [global::System.Diagnostics.DebuggerNonUserCodeAttribute()]
-    [global::System.Runtime.CompilerServices.CompilerGeneratedAttribute()]
-    internal class Resources {
-        
-        private static global::System.Resources.ResourceManager resourceMan;
-        
-        private static global::System.Globalization.CultureInfo resourceCulture;
-        
-        [global::System.Diagnostics.CodeAnalysis.SuppressMessageAttribute(&quot;Microsoft.Performance&quot;, &quot;CA1811:AvoidUncalledPrivateCode&quot;)]
-        internal Resources() {
+    [EditorBrowsable(EditorBrowsableState.Advanced)]
+    internal static ResourceManager ResourceManager
+    {
+      get
+      {
+        if (ReferenceEquals(resourceMan, null)) {
+          ResourceManager temp = new ResourceManager(&quot;Springie.Properties.Resources&quot;, typeof(Resources).Assembly);
+          resourceMan = temp;
         }
-        
-        /// &lt;summary&gt;
-        ///   Returns the cached ResourceManager instance used by this class.
-        /// &lt;/summary&gt;
-        [global::System.ComponentModel.EditorBrowsableAttribute(global::System.ComponentModel.EditorBrowsableState.Advanced)]
-        internal static global::System.Resources.ResourceManager ResourceManager {
-            get {
-                if (object.ReferenceEquals(resourceMan, null)) {
-                    global::System.Resources.ResourceManager temp = new global::System.Resources.ResourceManager(&quot;Springie.Properties.Resources&quot;, typeof(Resources).Assembly);
-                    resourceMan = temp;
-                }
-                return resourceMan;
-            }
-        }
-        
-        /// &lt;summary&gt;
-        ///   Overrides the current thread's CurrentUICulture property for all
-        ///   resource lookups using this strongly typed resource class.
-        /// &lt;/summary&gt;
-        [global::System.ComponentModel.EditorBrowsableAttribute(global::System.ComponentModel.EditorBrowsableState.Advanced)]
-        internal static global::System.Globalization.CultureInfo Culture {
-            get {
-                return resourceCulture;
-            }
-            set {
-                resourceCulture = value;
-            }
-        }
-        
-        internal static System.Drawing.Icon err {
-            get {
-                object obj = ResourceManager.GetObject(&quot;err&quot;, resourceCulture);
-                return ((System.Drawing.Icon)(obj));
-            }
-        }
-        
-        internal static System.Drawing.Icon joined {
-            get {
-                object obj = ResourceManager.GetObject(&quot;joined&quot;, resourceCulture);
-                return ((System.Drawing.Icon)(obj));
-            }
-        }
-        
-        internal static System.Drawing.Icon ok {
-            get {
-                object obj = ResourceManager.GetObject(&quot;ok&quot;, resourceCulture);
-                return ((System.Drawing.Icon)(obj));
-            }
-        }
-        
-        internal static System.Drawing.Icon run {
-            get {
-                object obj = ResourceManager.GetObject(&quot;run&quot;, resourceCulture);
-                return ((System.Drawing.Icon)(obj));
-            }
-        }
-        
-        internal static System.Drawing.Icon springie {
-            get {
-                object obj = ResourceManager.GetObject(&quot;springie&quot;, resourceCulture);
-                return ((System.Drawing.Icon)(obj));
-            }
-        }
+        return resourceMan;
+      }
     }
-}
+
+    /// &lt;summary&gt;
+    ///   Overrides the current thread's CurrentUICulture property for all
+    ///   resource lookups using this strongly typed resource class.
+    /// &lt;/summary&gt;
+    [EditorBrowsable(EditorBrowsableState.Advanced)]
+    internal static CultureInfo Culture
+    {
+      get { return resourceCulture; }
+      set { resourceCulture = value; }
+    }
+
+    internal static Icon err
+    {
+      get
+      {
+        object obj = ResourceManager.GetObject(&quot;err&quot;, resourceCulture);
+        return ((Icon)(obj));
+      }
+    }
+
+    internal static Icon joined
+    {
+      get
+      {
+        object obj = ResourceManager.GetObject(&quot;joined&quot;, resourceCulture);
+        return ((Icon)(obj));
+      }
+    }
+
+    internal static Icon ok
+    {
+      get
+      {
+        object obj = ResourceManager.GetObject(&quot;ok&quot;, resourceCulture);
+        return ((Icon)(obj));
+      }
+    }
+
+    internal static Icon run
+    {
+      get
+      {
+        object obj = ResourceManager.GetObject(&quot;run&quot;, resourceCulture);
+        return ((Icon)(obj));
+      }
+    }
+
+    internal static Icon springie
+    {
+      get
+      {
+        object obj = ResourceManager.GetObject(&quot;springie&quot;, resourceCulture);
+        return ((Icon)(obj));
+      }
+    }
+  }
+}
\ No newline at end of file

Modified: trunk/tools/springie/Springie/Properties/Settings.Designer.cs
===================================================================
--- trunk/tools/springie/Springie/Properties/Settings.Designer.cs	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/Properties/Settings.Designer.cs	2008-04-07 18:57:09 UTC (rev 5677)
@@ -8,19 +8,21 @@
 // &lt;/auto-generated&gt;
 //------------------------------------------------------------------------------
 
-namespace Springie.Properties {
-    
-    
-    [global::System.Runtime.CompilerServices.CompilerGeneratedAttribute()]
-    [global::System.CodeDom.Compiler.GeneratedCodeAttribute(&quot;Microsoft.VisualStudio.Editors.SettingsDesigner.SettingsSingleFileGenerator&quot;, &quot;9.0.0.0&quot;)]
-    internal sealed partial class Settings : global::System.Configuration.ApplicationSettingsBase {
-        
-        private static Settings defaultInstance = ((Settings)(global::System.Configuration.ApplicationSettingsBase.Synchronized(new Settings())));
-        
-        public static Settings Default {
-            get {
-                return defaultInstance;
-            }
-        }
+using System.CodeDom.Compiler;
+using System.Configuration;
+using System.Runtime.CompilerServices;
+
+namespace Springie.Properties
+{
+  [CompilerGenerated()]
+  [GeneratedCode(&quot;Microsoft.VisualStudio.Editors.SettingsDesigner.SettingsSingleFileGenerator&quot;, &quot;9.0.0.0&quot;)]
+  internal sealed partial class Settings : ApplicationSettingsBase
+  {
+    private static Settings defaultInstance = ((Settings)(Synchronized(new Settings())));
+
+    public static Settings Default
+    {
+      get { return defaultInstance; }
     }
-}
+  }
+}
\ No newline at end of file

Modified: trunk/tools/springie/Springie/autohost/AutoHost.cs
===================================================================
--- trunk/tools/springie/Springie/autohost/AutoHost.cs	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/autohost/AutoHost.cs	2008-04-07 18:57:09 UTC (rev 5677)
@@ -1,79 +1,68 @@
 using System;
 using System.Collections.Generic;
-using System.Text;
-using System.Xml.Serialization;
+using System.Globalization;
 using System.IO;
+using System.Runtime.Serialization.Formatters.Binary;
+using System.Threading;
 using System.Timers;
+using System.Windows.Forms;
+using System.Xml.Serialization;
+using Springie.AutoHostNamespace;
 using Springie.Client;
 using Springie.SpringNamespace;
-using System.Windows.Forms;
-using System.Runtime.Serialization.Formatters;
-using System.Runtime.Serialization.Formatters.Binary;
+using Timer=System.Timers.Timer;
 
-namespace Springie.AutoHostNamespace
+namespace Springie.autohost
 {
-
   public partial class AutoHost
   {
-    public const string ConfigName = &quot;autohost.xml&quot;;
-    public const string PresetsName = &quot;presets.xml&quot;;
     public const string BoxesName = &quot;boxes.bin&quot;;
+    public const string ConfigName = &quot;autohost.xml&quot;;
 
     public const int PollTimeout = 60;
+    public const string PresetsName = &quot;presets.xml&quot;;
 
+    private IVotable activePoll = null;
+    private int autoLock = 0;
+    private BanList banList;
+    private string bossName = &quot;&quot;;
     public AutoHostConfig config = new AutoHostConfig();
 
-    public List&lt;Preset&gt; presets = new List&lt;Preset&gt;();
 
+    private FileDownloader fileDownloader;
+
+    private bool kickMinRank = false;
+    private bool kickSpectators = false;
     public Ladder ladder;
+    private UnknownFilesLinker linker;
+    private bool lockedByKickSpec = false;
 
+    private AutoManager manager;
     public Dictionary&lt;string, Dictionary&lt;int, BattleRect&gt;&gt; MapBoxes = new Dictionary&lt;string, Dictionary&lt;int, BattleRect&gt;&gt;();
+    private int mapCycleIndex = 0;
 
 
-    TasClient tas;
-    Spring spring;
-    UnknownFilesLinker linker;
-    IVotable activePoll = null;
-    System.Timers.Timer pollTimer = null;
-    string bossName = &quot;&quot;;
-    public string BossName
-    {
-      get { return bossName; }
-      set { bossName = value; }
-    }
+    private double minCpuSpeed = 0;
+    private Timer pollTimer = null;
+    public List&lt;Preset&gt; presets = new List&lt;Preset&gt;();
+    private object savLock = new object();
+    private Spring spring;
+    private TasClient tas;
 
-
-    FileDownloader fileDownloader;
-    BanList banList;
-
-    int mapCycleIndex = 0;
-
-    bool kickMinRank = false;
-    bool kickSpectators = false;
-    bool lockedByKickSpec = false;
-    int autoLock = 0;
-
-    private AutoManager manager;
-
-
-    public bool KickSpectators { get { return kickSpectators; } }
-    double minCpuSpeed = 0;
-    public double MinCpuSpeed { get { return minCpuSpeed; } }
-
     public AutoHost(TasClient tas, Spring spring, AutoHostConfig conf)
     {
       banList = new BanList(this, tas);
 
-      if (conf == null) LoadConfig(); else config = conf;
+      if (conf == null) LoadConfig();
+      else config = conf;
       SaveConfig();
 
-
       this.tas = tas;
       this.spring = spring;
 
       tas.Said += new EventHandler&lt;TasSayEventArgs&gt;(tas_Said);
 
-      pollTimer = new System.Timers.Timer(PollTimeout * 1000);
+      pollTimer = new Timer(PollTimeout*1000);
       pollTimer.Enabled = false;
       pollTimer.AutoReset = false;
       pollTimer.Elapsed += new ElapsedEventHandler(pollTimer_Elapsed);
@@ -95,9 +84,24 @@
       //fileDownloader.DownloadProgressChanged += new EventHandler&lt;TasEventArgs&gt;(fileDownloader_DownloadProgressChanged);
 
       tas.BattleFound += new EventHandler&lt;TasEventArgs&gt;(tas_BattleFound);
+    }
 
+    public string BossName
+    {
+      get { return bossName; }
+      set { bossName = value; }
     }
 
+    public bool KickSpectators
+    {
+      get { return kickSpectators; }
+    }
+
+    public double MinCpuSpeed
+    {
+      get { return minCpuSpeed; }
+    }
+
     /*void fileDownloader_DownloadProgressChanged(object sender, TasEventArgs e)
     {
       if (tas.IsConnected) {
@@ -105,47 +109,41 @@
       }
     }*/
 
-    void fileDownloader_DownloadCompleted(object sender, FileDownloader.DownloadEventArgs e)
+    private void fileDownloader_DownloadCompleted(object sender, FileDownloader.DownloadEventArgs e)
     {
       string mes;
-      if (e.Status == FileDownloader.Status.Failed) {
-        mes = e.DownloadItem.fileName + &quot; download failed: &quot; + e.Message;
-      } else {
+      if (e.Status == FileDownloader.Status.Failed) mes = e.DownloadItem.fileName + &quot; download failed: &quot; + e.Message;
+      else {
         mes = e.DownloadItem.fileName + &quot; download finished!&quot;;
         spring.Reload(true, true);
       }
       if (tas.IsConnected) SayBattle(mes);
-      if (e.DownloadItem.fileType == FileDownloader.FileType.Mod &amp;&amp; !spring.IsRunning) {
-        Start(e.DownloadItem.fileName, null);
-      }
-
+      if (e.DownloadItem.fileType == FileDownloader.FileType.Mod &amp;&amp; !spring.IsRunning) Start(e.DownloadItem.fileName, null);
     }
 
 
-    void tas_BattleOpened(object sender, TasEventArgs e)
+    private void tas_BattleOpened(object sender, TasEventArgs e)
     {
       tas.DisableUnits(UnitInfo.ToStringList(config.DisabledUnits));
     }
 
-    void tas_BattleFound(object sender, TasEventArgs e)
+    private void tas_BattleFound(object sender, TasEventArgs e)
     {
       string map = Utils.Glue(e.ServerParams.ToArray(), 10).Split('\t')[0];
-      if (config.AutoDownloadNewMaps &amp;&amp; !spring.IsRunning &amp;&amp; !spring.UnitSync.MapList.ContainsKey(map)) {
-        fileDownloader.DownloadMap(map);
-      }
+      if (config.AutoDownloadNewMaps &amp;&amp; !spring.IsRunning &amp;&amp; !spring.UnitSync.MapList.ContainsKey(map)) fileDownloader.DownloadMap(map);
     }
 
 
-    void spring_GameOver(object sender, SpringLogEventArgs e)
+    private void spring_GameOver(object sender, SpringLogEventArgs e)
     {
-      System.Threading.Thread.Sleep(3000); // wait for stats
+      Thread.Sleep(3000); // wait for stats
       SayBattle(&quot;Game over, exiting&quot;);
       spring.ExitGame();
 
       if (config.MapCycle.Length &gt; 0) {
-        mapCycleIndex = mapCycleIndex % config.MapCycle.Length;
+        mapCycleIndex = mapCycleIndex%config.MapCycle.Length;
         SayBattle(&quot;changing to another map in mapcycle&quot;);
-        ComMap(TasSayEventArgs.Default, config.MapCycle[mapCycleIndex].Split(new char[] { ' ' }, StringSplitOptions.RemoveEmptyEntries));
+        ComMap(TasSayEventArgs.Default, config.MapCycle[mapCycleIndex].Split(new char[] {' '}, StringSplitOptions.RemoveEmptyEntries));
         mapCycleIndex++;
       }
     }
@@ -180,7 +178,6 @@
     }
 
 
-    private object savLock = new object();
     public void SaveConfig()
     {
       lock (savLock) {
@@ -188,11 +185,8 @@
 
         // remove duplicated admins
         List&lt;PrivilegedUser&gt; l = new List&lt;PrivilegedUser&gt;();
-        foreach (PrivilegedUser p in config.PrivilegedUsers) {
-          if (l.Find(delegate(PrivilegedUser u) { return u.Name == p.Name; }) == null) {
-            l.Add(p);
-          }
-        };
+        foreach (PrivilegedUser p in config.PrivilegedUsers) if (l.Find(delegate(PrivilegedUser u) { return u.Name == p.Name; }) == null) l.Add(p);
+        ;
         config.PrivilegedUsers = l;
         config.PrivilegedUsers.Sort(AutoHostConfig.UserComparer);
 
@@ -212,7 +206,6 @@
 
         banList.Save();
 
-
         BinaryFormatter fm = new BinaryFormatter();
         using (FileStream fs = new FileStream(Application.StartupPath + '/' + BoxesName, FileMode.Create)) {
           fm.Serialize(fs, MapBoxes);
@@ -222,7 +215,6 @@
     }
 
 
-
     public void Start(string modname, string mapname)
     {
       Stop();
@@ -234,13 +226,9 @@
       minCpuSpeed = config.MinCpuSpeed;
       kickMinRank = config.KickMinRank;
 
+      if (config.LadderId &gt; 0) ladder = new Ladder(config.LadderId);
+      else ladder = null;
 
-
-      if (config.LadderId &gt; 0) {
-        ladder = new Ladder(config.LadderId);
-      } else ladder = null;
-
-
       config.BattleDetails.Validate();
       if (String.IsNullOrEmpty(modname)) modname = config.DefaultMod;
       if (String.IsNullOrEmpty(mapname)) mapname = config.DefaultMap;
@@ -256,29 +244,24 @@
         modname = enu.Current.Name;
       }
 
-
       int mint, maxt;
-      Battle b = new Battle((ladder == null ? config.Password : &quot;ladderlock&quot;), config.HostingPort, config.MaxPlayers, config.MinRank,
-spring.UnitSync.GetMapInfo(mapname), (ladder != null ? &quot;(ladder &quot; + ladder.Id + &quot;) &quot; : &quot;&quot;) + config.GameTitle.Replace(&quot;%1&quot;, MainConfig.SpringieVersion), spring.UnitSync.GetModInfo(modname), (ladder != null ? ladder.CheckBattleDetails(config.BattleDetails, out mint, out maxt) : config.BattleDetails));
+      Battle b = new Battle((ladder == null ? config.Password : &quot;ladderlock2&quot;), config.HostingPort, config.MaxPlayers, config.MinRank, spring.UnitSync.GetMapInfo(mapname), (ladder != null ? &quot;(ladder &quot; + ladder.Id + &quot;) &quot; : &quot;&quot;) + config.GameTitle.Replace(&quot;%1&quot;, MainConfig.SpringieVersion), spring.UnitSync.GetModInfo(modname), (ladder != null ? ladder.CheckBattleDetails(config.BattleDetails, out mint, out maxt) : config.BattleDetails));
       // if hole punching enabled then we use it
       if (config.UseHolePunching) b.Nat = Battle.NatMode.HolePunching;
-      else if (Program.main.config.GargamelMode &amp;&amp; Program.main.Stats != null) b.Nat = Battle.NatMode.FixedPorts; else b.Nat = Battle.NatMode.None;  // else either no nat or fixed ports (for gargamel fake - to get client IPs)
+      else if (Program.main.config.GargamelMode &amp;&amp; Program.main.Stats != null) b.Nat = Battle.NatMode.FixedPorts;
+      else b.Nat = Battle.NatMode.None; // else either no nat or fixed ports (for gargamel fake - to get client IPs)
 
-
-      for (int i = 0; i &lt; config.DefaultRectangles.Count; ++i) {
-        b.Rectangles.Add(i, config.DefaultRectangles[i]);
-      }
+      for (int i = 0; i &lt; config.DefaultRectangles.Count; ++i) b.Rectangles.Add(i, config.DefaultRectangles[i]);
       tas.OpenBattle(b);
     }
 
 
-
-    void tas_BattleLockChanged(object sender, TasEventArgs e)
+    private void tas_BattleLockChanged(object sender, TasEventArgs e)
     {
       SayBattle(&quot;game &quot; + (tas.GetBattle().IsLocked ? &quot;locked&quot; : &quot;unlocked&quot;), false);
     }
 
-    void tas_BattleUserStatusChanged(object sender, TasEventArgs e)
+    private void tas_BattleUserStatusChanged(object sender, TasEventArgs e)
     {
       UserBattleStatus u;
       Battle b = tas.GetBattle();
@@ -291,47 +274,41 @@
 
         if (KickSpectators &amp;&amp; u.IsSpectator == true &amp;&amp; u.name != tas.UserName) {
           SayBattle(config.KickSpectatorText);
-          ComKick(TasSayEventArgs.Default, new string[] { u.name });
+          ComKick(TasSayEventArgs.Default, new string[] {u.name});
         }
         HandleAutoLocking();
 
-
         int cnt = 0;
-        foreach (UserBattleStatus ubs in b.Users) {
-          if (!ubs.IsSpectator &amp;&amp; ubs.IsReady) cnt++;
-        }
-        string usname; int allyno;
+        foreach (UserBattleStatus ubs in b.Users) if (!ubs.IsSpectator &amp;&amp; ubs.IsReady) cnt++;
+        string usname;
+        int allyno;
         if (!manager.Enabled) {
           if ((cnt == config.MaxPlayers || (autoLock &gt; 0 &amp;&amp; autoLock == cnt)) &amp;&amp; AllReadyAndSynced(out usname) &amp;&amp; AllUniqueTeams(out usname) &amp;&amp; BalancedTeams(out allyno)) {
             SayBattle(&quot;server is full, starting&quot;);
-            System.Threading.Thread.Sleep(1000); // just to make sure that other clients update their game info and balance ends
-            ComStart(TasSayEventArgs.Default, new string[] { });
+            Thread.Sleep(1000); // just to make sure that other clients update their game info and balance ends
+            ComStart(TasSayEventArgs.Default, new string[] {});
           }
         }
       }
     }
 
-    void tas_BattleMapChanged(object sender, TasEventArgs e)
+    private void tas_BattleMapChanged(object sender, TasEventArgs e)
     {
       if (config.DisplayMapLink) SayBattle(&quot;maplink: &quot; + linker.GetMapBounceLink(tas.GetBattle().Map.Name));
-      foreach (UserBattleStatus p in tas.GetBattle().Users) { //ring all people that host changed the map
+      foreach (UserBattleStatus p in tas.GetBattle().Users) {
+        //ring all people that host changed the map
         tas.Ring(p.name);
       }
       Battle b = tas.GetBattle();
       string mapName = b.Map.ArchiveName.ToLower();
       if (MapBoxes.ContainsKey(mapName)) {
-        for (int i = 0; i &lt; b.Rectangles.Count; ++i) {
-          tas.RemoveBattleRectangle(i);
-        }
+        for (int i = 0; i &lt; b.Rectangles.Count; ++i) tas.RemoveBattleRectangle(i);
         Dictionary&lt;int, BattleRect&gt; dict = MapBoxes[mapName];
-        foreach (KeyValuePair&lt;int, BattleRect&gt; v in dict) {
-          tas.AddBattleRectangle(v.Key, v.Value);
-        }
+        foreach (KeyValuePair&lt;int, BattleRect&gt; v in dict) tas.AddBattleRectangle(v.Key, v.Value);
       }
     }
 
 
-
     private void HandleKickSpecServerLocking()
     {
       if (!spring.IsRunning &amp;&amp; (KickSpectators || lockedByKickSpec)) {
@@ -352,16 +329,11 @@
     private void HandleAutoLocking()
     {
       if (autoLock &gt; 0 &amp;&amp; (!spring.IsRunning || !Program.main.config.AllowInGameJoin)) {
-
         Battle b = tas.GetBattle();
         int cnt = b.CountPlayers();
-        if (cnt &gt;= autoLock) {
-          tas.ChangeLock(true);
-        }
+        if (cnt &gt;= autoLock) tas.ChangeLock(true);
 
-        if (cnt &lt; autoLock) {
-          tas.ChangeLock(false);
-        }
+        if (cnt &lt; autoLock) tas.ChangeLock(false);
       }
     }
 
@@ -375,7 +347,7 @@
             tas.GetExistingUser(u.name, out x);
             if (u.name != tas.UserName &amp;&amp; x.rank &lt; config.MinRank) {
               SayBattle(x.name + &quot;, your rank is too low, rank kicking is enabled here&quot;);
-              ComKick(TasSayEventArgs.Default, new string[] { u.name });
+              ComKick(TasSayEventArgs.Default, new string[] {u.name});
             }
           }
         }
@@ -383,7 +355,7 @@
     }
 
 
-    void tas_BattleUserJoined(object sender, TasEventArgs e)
+    private void tas_BattleUserJoined(object sender, TasEventArgs e)
     {
       string name = e.ServerParams[0];
       string welc = config.Welcome;
@@ -403,21 +375,20 @@
       HandleAutoLocking();
       HandleMinRankKicking();
 
-
       if (minCpuSpeed &gt; 0) {
         User u;
         if (tas.GetExistingUser(name, out u)) {
-          if (u.cpu != 0 &amp;&amp; u.cpu &lt; minCpuSpeed * 1000) {
-            System.Threading.Thread.CurrentThread.CurrentCulture = System.Globalization.CultureInfo.InvariantCulture;
+          if (u.cpu != 0 &amp;&amp; u.cpu &lt; minCpuSpeed*1000) {
+            Thread.CurrentThread.CurrentCulture = CultureInfo.InvariantCulture;
             SayBattle(name + &quot;, your CPU speed is below minimum set for this server:&quot; + minCpuSpeed + &quot;GHz - sorry&quot;);
-            ComKick(TasSayEventArgs.Default, new string[] { u.name });
+            ComKick(TasSayEventArgs.Default, new string[] {u.name});
           }
         }
       }
     }
 
 
-    void CheckForBattleExit()
+    private void CheckForBattleExit()
     {
       if ((DateTime.Now - spring.GameStarted) &gt; TimeSpan.FromSeconds(20)) {
         if (spring.IsRunning) {
@@ -437,52 +408,44 @@
         }
         // kontrola pro pripad ze by se nevypl spring
         User us;
-        if (!spring.IsRunning &amp;&amp; tas.GetExistingUser(tas.UserName, out us) &amp;&amp; us.isInGame) {
-          tas.ChangeMyStatus(false, false);
-        }
+        if (!spring.IsRunning &amp;&amp; tas.GetExistingUser(tas.UserName, out us) &amp;&amp; us.isInGame) tas.ChangeMyStatus(false, false);
       }
-
     }
 
 
-    void tas_UserStatusChanged(object sender, TasEventArgs e)
+    private void tas_UserStatusChanged(object sender, TasEventArgs e)
     {
       if (spring.IsRunning) {
         Battle b = tas.GetBattle();
-        if (e.ServerParams[0] != tas.UserName &amp;&amp; b.ContainsUser(e.ServerParams[0])) {
-          CheckForBattleExit();
-        }
+        if (e.ServerParams[0] != tas.UserName &amp;&amp; b.ContainsUser(e.ServerParams[0])) CheckForBattleExit();
       }
     }
 
-    void tas_BattleUserLeft(object sender, TasEventArgs e)
+    private void tas_BattleUserLeft(object sender, TasEventArgs e)
     {
       CheckForBattleExit();
       HandleKickSpecServerLocking();
       HandleAutoLocking();
 
-      if (spring.IsRunning) {
-        spring.SayGame(e.ServerParams[0] + &quot; has left lobby&quot;);
-      }
+      if (spring.IsRunning) spring.SayGame(e.ServerParams[0] + &quot; has left lobby&quot;);
 
       if (e.ServerParams[0] == bossName) {
         SayBattle(&quot;boss has left the battle&quot;);
         bossName = &quot;&quot;;
       }
 
-      if (tas.GetBattle().IsLocked &amp;&amp; tas.GetBattle().Users.Count &lt; 2) { // player left and only 2 remaining (springie itself + some noob) -&gt; unlock
+      if (tas.GetBattle().IsLocked &amp;&amp; tas.GetBattle().Users.Count &lt; 2) {
+        // player left and only 2 remaining (springie itself + some noob) -&gt; unlock
         tas.ChangeLock(false);
       }
     }
 
-    void spring_SpringExited(object sender, EventArgs e)
+    private void spring_SpringExited(object sender, EventArgs e)
     {
       tas.ChangeLock(false);
       Battle b = tas.GetBattle();
       foreach (string s in toNotify) {
-        if (b != null &amp;&amp; b.ContainsUser(s)) {
-          tas.Ring(s);
-        }
+        if (b != null &amp;&amp; b.ContainsUser(s)) tas.Ring(s);
         tas.Say(TasClient.SayPlace.User, s, &quot;** Game just ended, join me! **&quot;, false);
       }
       toNotify.Clear();
@@ -496,15 +459,9 @@
 
     public int GetUserLevel(string name)
     {
-      foreach (PrivilegedUser pu in config.PrivilegedUsers) {
-        if (pu.Name == name) {
-          return pu.Level;
-        }
-      }
+      foreach (PrivilegedUser pu in config.PrivilegedUsers) if (pu.Name == name) return pu.Level;
       User u;
-      if (tas.GetExistingUser(name, out u)) {
-        if (u.isAdmin) return config.DefaulRightsLevelForLobbyAdmins;
-      }
+      if (tas.GetExistingUser(name, out u)) if (u.isAdmin) return config.DefaulRightsLevelForLobbyAdmins;
       return config.DefaulRightsLevel;
     }
 
@@ -565,9 +522,8 @@
         p = TasClient.SayPlace.Battle;
         emote = true;
       }
-      if (e.Place == TasSayEventArgs.Places.Game &amp;&amp; spring.IsRunning) {
-        spring.SayGame(text);
-      } else tas.Say(p, e.UserName, text, emote);
+      if (e.Place == TasSayEventArgs.Places.Game &amp;&amp; spring.IsRunning) spring.SayGame(text);
+      else tas.Say(p, e.UserName, text, emote);
     }
 
 
@@ -589,12 +545,12 @@
     }
 
 
-    void tas_Said(object sender, TasSayEventArgs e)
+    private void tas_Said(object sender, TasSayEventArgs e)
     {
       // check if it's command
       if (e.Origin == TasSayEventArgs.Origins.Player &amp;&amp; !e.IsEmote &amp;&amp; e.Text.StartsWith(&quot;!&quot;)) {
         if (e.Text.Length &lt; 2) return;
-        string[] allwords = e.Text.Substring(1).Split(new char[] { ' ' }, StringSplitOptions.RemoveEmptyEntries);
+        string[] allwords = e.Text.Substring(1).Split(new char[] {' '}, StringSplitOptions.RemoveEmptyEntries);
         if (allwords.Length &lt; 1) return;
         string com = allwords[0];
 
@@ -623,7 +579,6 @@
             ComAdmins(e, words);
             break;
 
-
           case &quot;start&quot;:
             ComStart(e, words);
             break;
@@ -652,7 +607,6 @@
             linker.SayResults(Utils.Glue(words), UnknownFilesLinker.FileType.Mod, tas, e);
             break;
 
-
           case &quot;ring&quot;:
             ComRing(e, words);
             break;
@@ -737,7 +691,6 @@
             ComDlMod(e, words);
             break;
 
-
           case &quot;reload&quot;:
             Respond(e, &quot;reloading mod and map list&quot;);
             spring.Reload(true, true);
@@ -833,7 +786,6 @@
             ComBoss(e, words);
             break;
 
-
           case &quot;voteboss&quot;:
             StartVote(new VoteBoss(tas, spring, this), e, words);
             break;
@@ -842,12 +794,10 @@
             ComSetPassword(e, words);
             break;
 
-
           case &quot;setgametitle&quot;:
             ComSetGameTitle(e, words);
             break;
 
-
           case &quot;setminrank&quot;:
             ComSetMinRank(e, words);
             break;
@@ -891,7 +841,6 @@
           case &quot;votesetoptions&quot;:
             StartVote(new VoteSetOptions(tas, spring, this), e, words);
             break;
-
         }
       }
     }
@@ -912,7 +861,7 @@
         }
         if (vote.Init(e, words)) {
           activePoll = vote;
-          pollTimer.Interval = PollTimeout * 1000;
+          pollTimer.Interval = PollTimeout*1000;
           pollTimer.Enabled = true;
         }
       }
@@ -921,18 +870,14 @@
     public void RegisterVote(TasSayEventArgs e, string[] words)
     {
       if (activePoll != null) {
-        if (activePoll.Vote(e, words)) {
-          StopVote();
-        }
+        if (activePoll.Vote(e, words)) StopVote();
       } else Respond(e, &quot;There is no poll going on, start some first&quot;);
     }
 
 
-    void pollTimer_Elapsed(object sender, ElapsedEventArgs e)
+    private void pollTimer_Elapsed(object sender, ElapsedEventArgs e)
     {
-      if (activePoll != null) {
-        activePoll.TimeEnd();
-      }
+      if (activePoll != null) activePoll.TimeEnd();
       StopVote();
     }
 
@@ -945,6 +890,5 @@
       tas.ChangeMyStatus(false, false);
       tas.LeaveBattle();
     }
-
   }
-}
+}
\ No newline at end of file

Modified: trunk/tools/springie/Springie/autohost/AutoHostConfig.cs
===================================================================
--- trunk/tools/springie/Springie/autohost/AutoHostConfig.cs	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/autohost/AutoHostConfig.cs	2008-04-07 18:57:09 UTC (rev 5677)
@@ -1,54 +1,43 @@
-using System;
 using System.Collections.Generic;
-using System.Text;
-using System.Xml.Serialization;
 using System.ComponentModel;
 using Springie.Client;
 using Springie.SpringNamespace;
 
-namespace Springie.AutoHostNamespace
+namespace Springie.autohost
 {
   public class AutoHostConfig
   {
-    public class ModConverter : StringConverter
-    {
-      public override bool GetStandardValuesSupported(ITypeDescriptorContext context)
-      {
-        return true;
-      }
+    private bool autoDownloadNewMaps = false;
+    private int autoLockMinPlayers = 2;
+    private BattleDetails battleDetails = new BattleDetails();
+    public List&lt;CommandConfig&gt; Commands = new List&lt;CommandConfig&gt;();
+    private int defaulRightsLevel = 1;
+    private int defaulRightsLevelForLobbyAdmins = 4;
+    private string defaultMap = &quot;SmallDivide.smf&quot;;
+    private string defaultMod = &quot;XTA v8&quot;;
+    public List&lt;BattleRect&gt; DefaultRectangles = new List&lt;BattleRect&gt;();
+    private int defaultRightsLevelWithBoss = 0;
+    private UnitInfo[] disabledUnits = new UnitInfo[] {};
+    private bool displayMapLink = true;
+    private string gameTitle = &quot;AutoHost (%1)&quot;;
+    private int hostingPort = 8452;
+    private bool kickMinRank = false;
+    private bool kickSpectators = false;
+    private string kickSpectatorText = &quot;spectators not allowed here at this time, sorry&quot;;
+    private int ladderId = 0;
+    private string[] limitMaps;
+    private string[] limitMods;
+    private string[] mapCycle = new string[] {};
+    private int maxPlayers = 10;
+    private double minCpuSpeed = 0;
+    private int minRank = 0;
+    private string password = &quot;*&quot;;
+    public List&lt;PrivilegedUser&gt; PrivilegedUsers = new List&lt;PrivilegedUser&gt;();
+    private bool useHolePunching = false;
+    private string welcome = &quot;Hi %1 (rights:%2), welcome to %3, automated host. For help say !help&quot;;
 
-      public override StandardValuesCollection GetStandardValues(ITypeDescriptorContext context)
-      {
-        List&lt;string&gt; mods = new List&lt;string&gt;();
-        foreach (KeyValuePair&lt;string, ModInfo&gt; p in Program.main.Spring.UnitSync.ModList) {
-          mods.Add(p.Value.Name);
-        }
-        return new StandardValuesCollection(mods);
-      }
-    };
+    public AutoHostConfig() {}
 
-    public class MapConverter : StringConverter
-    {
-      public override bool GetStandardValuesSupported(ITypeDescriptorContext context)
-      {
-        return true;
-      }
-
-      public override StandardValuesCollection GetStandardValues(ITypeDescriptorContext context)
-      {
-        List&lt;string&gt; maps = new List&lt;string&gt;();
-        foreach (KeyValuePair&lt;string, MapInfo&gt; p in Program.main.Spring.UnitSync.MapList) {
-          maps.Add(p.Value.Name);
-        }
-        return new StandardValuesCollection(maps);
-      }
-
-
-    };
-
-
-    string password = &quot;*&quot;;
-
     [Category(&quot;Basic options&quot;)]
     [Description(&quot;Game password&quot;)]
     public string Password
@@ -57,7 +46,6 @@
       set { password = value; }
     }
 
-    int hostingPort = 8452;
     [Category(&quot;Basic options&quot;)]
     [Description(&quot;Hosting port number&quot;)]
     public int HostingPort
@@ -67,7 +55,6 @@
     }
 
 
-    bool useHolePunching = false;
     [Category(&quot;Basic options&quot;)]
     [Description(&quot;Should Springie use hole punching NAT traversal method? - Incompatible with gargamel mode&quot;)]
     public bool UseHolePunching
@@ -76,7 +63,6 @@
       set { useHolePunching = value; }
     }
 
-    int maxPlayers = 10;
     [Category(&quot;Basic options&quot;)]
     [Description(&quot;Maximum number of players&quot;)]
     public int MaxPlayers
@@ -84,7 +70,6 @@
       get { return maxPlayers; }
       set { maxPlayers = value; }
     }
-    int minRank = 0;
 
     [Category(&quot;Basic options&quot;)]
     [Description(&quot;Minimum rank to be allowed to join&quot;)]
@@ -94,7 +79,6 @@
       set { minRank = value; }
     }
 
-    bool kickMinRank = false;
     [Category(&quot;Basic options&quot;)]
     [Description(&quot;Should autohost kick people below min rank?&quot;)]
     public bool KickMinRank
@@ -104,8 +88,9 @@
     }
 
 
-    string defaultMod = &quot;XTA v8&quot;;
-    [Category(&quot;Mod and map&quot;), Description(&quot;Default game mod&quot;), TypeConverter(typeof(ModConverter))]
+    [Category(&quot;Mod and map&quot;)]
+    [Description(&quot;Default game mod&quot;)]
+    [TypeConverter(typeof(ModConverter))]
     public string DefaultMod
     {
       get { return defaultMod; }
@@ -113,32 +98,33 @@
     }
 
 
-    string[] limitMaps;
-    [Category(&quot;Mod and map&quot;), Description(&quot;Limit map selection to this list&quot;)]
+    [Category(&quot;Mod and map&quot;)]
+    [Description(&quot;Limit map selection to this list&quot;)]
     public string[] LimitMaps
     {
       get { return limitMaps; }
       set { limitMaps = value; }
     }
 
-    string[] limitMods;
-    [Category(&quot;Mod and map&quot;), Description(&quot;Limit mod selection to this list&quot;)]
+    [Category(&quot;Mod and map&quot;)]
+    [Description(&quot;Limit mod selection to this list&quot;)]
     public string[] LimitMods
     {
       get { return limitMods; }
       set { limitMods = value; }
     }
 
-    string defaultMap = &quot;SmallDivide.smf&quot;;
-    [Category(&quot;Mod and map&quot;), Description(&quot;Default game map&quot;), TypeConverter(typeof(MapConverter))]
+    [Category(&quot;Mod and map&quot;)]
+    [Description(&quot;Default game map&quot;)]
+    [TypeConverter(typeof(MapConverter))]
     public string DefaultMap
     {
       get { return defaultMap; }
       set { defaultMap = value; }
     }
 
-    bool autoDownloadNewMaps = false;
-    [Category(&quot;Mod and map&quot;), Description(&quot;Should springie redirect global game chat to lobby?&quot;)]
+    [Category(&quot;Mod and map&quot;)]
+    [Description(&quot;Should springie redirect global game chat to lobby?&quot;)]
     public bool AutoDownloadNewMaps
     {
       get { return autoDownloadNewMaps; }
@@ -146,8 +132,8 @@
     }
 
 
-    string[] mapCycle = new string[] { };
-    [Category(&quot;Mod and map&quot;), Description(&quot;Optional mapcycle - when game ends, another map is from this list is picked. You don't have to specify exact names here, springie is using filtering capabilities to find entered maps.&quot;)]
+    [Category(&quot;Mod and map&quot;)]
+    [Description(&quot;Optional mapcycle - when game ends, another map is from this list is picked. You don't have to specify exact names here, springie is using filtering capabilities to find entered maps.&quot;)]
     public string[] MapCycle
     {
       get { return mapCycle; }
@@ -155,9 +141,6 @@
     }
 
 
-    public List&lt;BattleRect&gt; DefaultRectangles = new List&lt;BattleRect&gt;();
-
-    string gameTitle = &quot;AutoHost (%1)&quot;;
     [Category(&quot;Texts&quot;)]
     [Description(&quot;Game title - appears in open game list, %1 = springie version&quot;)]
     public string GameTitle
@@ -167,16 +150,16 @@
     }
 
 
-    private bool kickSpectators = false;
-    [Category(&quot;Default battle settings&quot;), Description(&quot;Do you want to automatically kick spectators&quot;)]
+    [Category(&quot;Default battle settings&quot;)]
+    [Description(&quot;Do you want to automatically kick spectators&quot;)]
     public bool KickSpectators
     {
       get { return kickSpectators; }
       set { kickSpectators = value; }
     }
 
-    private double minCpuSpeed = 0;
-    [Category(&quot;Default battle settings&quot;), Description(&quot;Players with CPU speed (in GHz) below this value will be autokicked - 0 no kicking&quot;)]
+    [Category(&quot;Default battle settings&quot;)]
+    [Description(&quot;Players with CPU speed (in GHz) below this value will be autokicked - 0 no kicking&quot;)]
     public double MinCpuSpeed
     {
       get { return minCpuSpeed; }
@@ -184,23 +167,22 @@
     }
 
 
-    private BattleDetails battleDetails = new BattleDetails();
-    [Category(&quot;Default battle settings&quot;), Description(&quot;Defines battle details to use by default&quot;)]
+    [Category(&quot;Default battle settings&quot;)]
+    [Description(&quot;Defines battle details to use by default&quot;)]
     public BattleDetails BattleDetails
     {
       get { return battleDetails; }
       set { battleDetails = value; }
     }
 
-    private UnitInfo[] disabledUnits = new UnitInfo[] { };
-    [Category(&quot;Default battle settings&quot;), Description(&quot;List of units disabled by default&quot;)]
+    [Category(&quot;Default battle settings&quot;)]
+    [Description(&quot;List of units disabled by default&quot;)]
     public UnitInfo[] DisabledUnits
     {
       get { return disabledUnits; }
       set { disabledUnits = value; }
     }
 
-    int defaulRightsLevelForLobbyAdmins = 4;
     [Category(&quot;Rights&quot;)]
     [Description(&quot;Default rights level for lobby admins (mod admins)&quot;)]
     public int DefaulRightsLevelForLobbyAdmins
@@ -208,9 +190,8 @@
       get { return defaulRightsLevelForLobbyAdmins; }
       set { defaulRightsLevelForLobbyAdmins = value; }
     }
-    
 
-    int defaulRightsLevel = 1;
+
     [Category(&quot;Rights&quot;)]
     [Description(&quot;Default rights level for non-privileged users&quot;)]
     public int DefaulRightsLevel
@@ -219,7 +200,6 @@
       set { defaulRightsLevel = value; }
     }
 
-    int defaultRightsLevelWithBoss = 0;
     [Category(&quot;Rights&quot;)]
     [Description(&quot;Default rights level for non-privileged users when there is a boss in game&quot;)]
     public int DefaultRightsLevelWithBoss
@@ -228,8 +208,7 @@
       set { defaultRightsLevelWithBoss = value; }
     }
 
-    
-    int autoLockMinPlayers = 2;
+
     [Category(&quot;Basic options&quot;)]
     [Description(&quot;Minimum number of players for autolocking&quot;)]
     public int AutoLockMinPlayers
@@ -238,10 +217,6 @@
       set { autoLockMinPlayers = value; }
     }
 
-    public List&lt;CommandConfig&gt; Commands = new List&lt;CommandConfig&gt;();
-    public List&lt;PrivilegedUser&gt; PrivilegedUsers = new List&lt;PrivilegedUser&gt;();
-
-    string welcome = &quot;Hi %1 (rights:%2), welcome to %3, automated host. For help say !help&quot;;
     [Category(&quot;Texts&quot;)]
     [Description(&quot;Welcome message - server says this when users joins. %1 = user name, %2 = user rights level, %3 = springie version&quot;)]
     public string Welcome
@@ -251,7 +226,6 @@
     }
 
 
-    string kickSpectatorText = &quot;spectators not allowed here at this time, sorry&quot;;
     [Category(&quot;Texts&quot;)]
     [Description(&quot;Message used when kicking spectator&quot;)]
     public string KickSpectatorText
@@ -261,8 +235,6 @@
     }
 
 
-
-    bool displayMapLink = true;
     [Category(&quot;Texts&quot;)]
     [Description(&quot;Should Springie advertise a maplink to new joiners and after map change?&quot;)]
     public bool DisplayMapLink
@@ -271,7 +243,6 @@
       set { displayMapLink = value; }
     }
 
-    int ladderId = 0;
     [Category(&quot;Basic options&quot;)]
     [Description(&quot;Should Springie host ladder map? Pick ladder id&quot;)]
     public int LadderId
@@ -281,12 +252,10 @@
     }
 
 
-
     public void SetPrivilegedUser(string name, int level)
     {
       for (int i = 0; i &lt; PrivilegedUsers.Count; ++i) {
         if (PrivilegedUsers[i].Name == name) {
-
           if (level == 0) {
             PrivilegedUsers.RemoveAt(i);
             return;
@@ -323,9 +292,8 @@
 
       AddMissing(new CommandConfig(&quot;start&quot;, 1, &quot; - starts game&quot;, 5), addedCommands);
 
-      AddMissing(new CommandConfig(&quot;ring&quot;, 0, &quot;[&lt;filters&gt;..] - rings all unready or specific player(s), e.g. !ring - rings unready, !ring icho - rings Licho&quot;, 5, new TasSayEventArgs.Places[] { TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game }), addedCommands);
+      AddMissing(new CommandConfig(&quot;ring&quot;, 0, &quot;[&lt;filters&gt;..] - rings all unready or specific player(s), e.g. !ring - rings unready, !ring icho - rings Licho&quot;, 5, new TasSayEventArgs.Places[] {TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game}), addedCommands);
 
-
       AddMissing(new CommandConfig(&quot;listmaps&quot;, 0, &quot;[&lt;filters&gt;..] - lists maps on server, e.g. !listmaps altor div&quot;, 10), addedCommands);
       AddMissing(new CommandConfig(&quot;listmods&quot;, 0, &quot;[&lt;filters&gt;..] - lists mods on server, e.g. !listmods absolute 2.23&quot;, 5), addedCommands);
       AddMissing(new CommandConfig(&quot;map&quot;, 2, &quot;[&lt;filters&gt;..] - changes server map, eg. !map altor div&quot;), addedCommands);
@@ -334,18 +302,17 @@
 
       AddMissing(new CommandConfig(&quot;forcestart&quot;, 2, &quot; - starts game forcibly (ignoring warnings)&quot;, 5), addedCommands);
 
-      AddMissing(new CommandConfig(&quot;say&quot;, 0, &quot;&lt;text&gt; - says something in game&quot;, 0, new TasSayEventArgs.Places[] { TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game }), addedCommands);
+      AddMissing(new CommandConfig(&quot;say&quot;, 0, &quot;&lt;text&gt; - says something in game&quot;, 0, new TasSayEventArgs.Places[] {TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game}), addedCommands);
 
-      AddMissing(new CommandConfig(&quot;force&quot;, 2, &quot; - forces game start inside game&quot;, 8, new TasSayEventArgs.Places[] { TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game }), addedCommands);
-      AddMissing(new CommandConfig(&quot;kick&quot;, 3, &quot;[&lt;filters&gt;..] - kicks a player&quot;, 0, new TasSayEventArgs.Places[] { TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game }), addedCommands);
+      AddMissing(new CommandConfig(&quot;force&quot;, 2, &quot; - forces game start inside game&quot;, 8, new TasSayEventArgs.Places[] {TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game}), addedCommands);
+      AddMissing(new CommandConfig(&quot;kick&quot;, 3, &quot;[&lt;filters&gt;..] - kicks a player&quot;, 0, new TasSayEventArgs.Places[] {TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game}), addedCommands);
 
       AddMissing(new CommandConfig(&quot;split&quot;, 1, &quot;&lt;\&quot;h\&quot;/\&quot;v\&quot;&gt; &lt;percent&gt; - draws with given direction and percentual size, e.g. !split h 15&quot;), addedCommands);
 
       AddMissing(new CommandConfig(&quot;corners&quot;, 1, &quot;&lt;\&quot;a\&quot;/\&quot;b\&quot;&gt; &lt;percent&gt; - draws corners (a or b mode differ in ordering), e.g. !corners a 15&quot;), addedCommands);
 
+      AddMissing(new CommandConfig(&quot;exit&quot;, 3, &quot; - exits the game&quot;, 0, new TasSayEventArgs.Places[] {TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game}), addedCommands);
 
-      AddMissing(new CommandConfig(&quot;exit&quot;, 3, &quot; - exits the game&quot;, 0, new TasSayEventArgs.Places[] { TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game }), addedCommands);
-
       AddMissing(new CommandConfig(&quot;lock&quot;, 1, &quot; - locks the game&quot;), addedCommands);
 
       AddMissing(new CommandConfig(&quot;unlock&quot;, 1, &quot; - unlocks the game&quot;), addedCommands);
@@ -354,33 +321,31 @@
 
       AddMissing(new CommandConfig(&quot;votemap&quot;, 0, &quot;[&lt;mapname&gt;..] - starts vote for new map, e.g. !votemap altored div&quot;), addedCommands);
 
-      AddMissing(new CommandConfig(&quot;votekick&quot;, 0, &quot;[&lt;mapname&gt;..] - starts vote to kick a player, e.g. !votekick Licho&quot;, 0, new TasSayEventArgs.Places[] { TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game }), addedCommands);
+      AddMissing(new CommandConfig(&quot;votekick&quot;, 0, &quot;[&lt;mapname&gt;..] - starts vote to kick a player, e.g. !votekick Licho&quot;, 0, new TasSayEventArgs.Places[] {TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game}), addedCommands);
 
       AddMissing(new CommandConfig(&quot;voteforcestart&quot;, 0, &quot; - starts vote to force game to start in lobby&quot;), addedCommands);
 
-      AddMissing(new CommandConfig(&quot;voteforce&quot;, 0, &quot; - starts vote to force game to start from game&quot;, 0, new TasSayEventArgs.Places[] { TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game }), addedCommands);
+      AddMissing(new CommandConfig(&quot;voteforce&quot;, 0, &quot; - starts vote to force game to start from game&quot;, 0, new TasSayEventArgs.Places[] {TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game}), addedCommands);
 
-      AddMissing(new CommandConfig(&quot;voteexit&quot;, 0, &quot; - starts vote to exit game&quot;, 0, new TasSayEventArgs.Places[] { TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game }), addedCommands);
+      AddMissing(new CommandConfig(&quot;voteexit&quot;, 0, &quot; - starts vote to exit game&quot;, 0, new TasSayEventArgs.Places[] {TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game}), addedCommands);
 
-      AddMissing(new CommandConfig(&quot;vote&quot;, 0, &quot;&lt;number&gt; - votes for given option (works from battle only), e.g. !vote 1&quot;, 0, new TasSayEventArgs.Places[] { TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game }), addedCommands);
+      AddMissing(new CommandConfig(&quot;vote&quot;, 0, &quot;&lt;number&gt; - votes for given option (works from battle only), e.g. !vote 1&quot;, 0, new TasSayEventArgs.Places[] {TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game}), addedCommands);
 
       AddMissing(new CommandConfig(&quot;rehost&quot;, 3, &quot;[&lt;modname&gt;..] - rehosts game, e.g. !rehost abosol 2.23 - rehosts AA2.23&quot;), addedCommands);
-      AddMissing(new CommandConfig(&quot;voterehost&quot;, 0, &quot;[&lt;modname&gt;..] - votes to rehost game, e.g. !rehost abosol 2.23 - rehosts AA2.23&quot;, 0, new TasSayEventArgs.Places[] { TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game }), addedCommands);
+      AddMissing(new CommandConfig(&quot;voterehost&quot;, 0, &quot;[&lt;modname&gt;..] - votes to rehost game, e.g. !rehost abosol 2.23 - rehosts AA2.23&quot;, 0, new TasSayEventArgs.Places[] {TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game}), addedCommands);
 
       AddMissing(new CommandConfig(&quot;admins&quot;, 0, &quot; - lists admins&quot;, 5), addedCommands);
 
       AddMissing(new CommandConfig(&quot;setlevel&quot;, 4, &quot;&lt;level&gt; &lt;playername&gt; - set's rights level for player.Setting to 0 deletes players.&quot;), addedCommands);
 
-      AddMissing(new CommandConfig(&quot;maplink&quot;, 0, &quot;[&lt;mapname&gt;..] - looks for maplinks at unknown-files&quot;, 5, new TasSayEventArgs.Places[] { TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Normal }), addedCommands);
+      AddMissing(new CommandConfig(&quot;maplink&quot;, 0, &quot;[&lt;mapname&gt;..] - looks for maplinks at unknown-files&quot;, 5, new TasSayEventArgs.Places[] {TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Normal}), addedCommands);
 
-      AddMissing(new CommandConfig(&quot;modlink&quot;, 0, &quot;[&lt;modname&gt;..] - looks for modlinks at unknown-files&quot;, 5, new TasSayEventArgs.Places[] { TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Normal }), addedCommands);
+      AddMissing(new CommandConfig(&quot;modlink&quot;, 0, &quot;[&lt;modname&gt;..] - looks for modlinks at unknown-files&quot;, 5, new TasSayEventArgs.Places[] {TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Normal}), addedCommands);
 
-
       AddMissing(new CommandConfig(&quot;dlmap&quot;, 1, &quot;[&lt;mapname/dllid/url&gt;..] - downloads map to server. You can either specify map name or map id (from unknown files) or map URL&quot;, 10), addedCommands);
 
       AddMissing(new CommandConfig(&quot;dlmod&quot;, 1, &quot;[&lt;modname/dllid/url&gt;..] - downloads mod to server. You must specify mod file id (from unknown files) or mod URL&quot;, 10), addedCommands);
 
-
       AddMissing(new CommandConfig(&quot;reload&quot;, 2, &quot; - reloads mod and map list (can take long time)&quot;, 30), addedCommands);
 
       AddMissing(new CommandConfig(&quot;team&quot;, 2, &quot;&lt;teamnumber&gt; [&lt;playername&gt;..] - forces given player to a team&quot;), addedCommands);
@@ -391,7 +356,7 @@
 
       AddMissing(new CommandConfig(&quot;fixcolors&quot;, 1, &quot;- changes too similar colors to more different (note that color difference is highly subjective and impossible to model mathematically, so it won't always produce results satisfying for all)&quot;, 10), addedCommands);
 
-      AddMissing(new CommandConfig(&quot;springie&quot;, 0, &quot;- responds with basic springie information&quot;, 5, new TasSayEventArgs.Places[] { TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Channel }), addedCommands);
+      AddMissing(new CommandConfig(&quot;springie&quot;, 0, &quot;- responds with basic springie information&quot;, 5, new TasSayEventArgs.Places[] {TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Channel}), addedCommands);
 
       AddMissing(new CommandConfig(&quot;endvote&quot;, 2, &quot;- ends current poll&quot;), addedCommands);
 
@@ -404,10 +369,9 @@
       AddMissing(new CommandConfig(&quot;listoptions&quot;, 1, &quot; - lists all mod/map options&quot;, 5), addedCommands);
 
       AddMissing(new CommandConfig(&quot;setoptions&quot;, 1, &quot;&lt;name&gt;=&lt;value&gt;[,&lt;name&gt;=&lt;value&gt;] - applies mod/map options&quot;, 0), addedCommands);
-      
+
       AddMissing(new CommandConfig(&quot;votesetoptions&quot;, 1, &quot;&lt;name&gt;=&lt;value&gt;[,&lt;name&gt;=&lt;value&gt;] - starts a vote to apply mod/map options&quot;, 0), addedCommands);
 
-
       AddMissing(new CommandConfig(&quot;preset&quot;, 2, &quot;[&lt;presetname&gt;..] - applies given preset to current battle&quot;), addedCommands);
 
       AddMissing(new CommandConfig(&quot;votepreset&quot;, 0, &quot;[&lt;presetname&gt;..] - starts a vote to apply given preset&quot;), addedCommands);
@@ -422,13 +386,13 @@
 
       AddMissing(new CommandConfig(&quot;listbans&quot;, 0, &quot;- lists currently banned users&quot;, 0), addedCommands);
 
-      AddMissing(new CommandConfig(&quot;smurfs&quot;, 0, &quot;- finds smurfs, use this command to get more help&quot;, 5, new TasSayEventArgs.Places[] { TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Channel }), addedCommands);
+      AddMissing(new CommandConfig(&quot;smurfs&quot;, 0, &quot;- finds smurfs, use this command to get more help&quot;, 5, new TasSayEventArgs.Places[] {TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Channel}), addedCommands);
 
-      AddMissing(new CommandConfig(&quot;stats&quot;, 0, &quot;- displays statistics, use this command to get more help&quot;, 5, new TasSayEventArgs.Places[] { TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Channel }), addedCommands);
+      AddMissing(new CommandConfig(&quot;stats&quot;, 0, &quot;- displays statistics, use this command to get more help&quot;, 5, new TasSayEventArgs.Places[] {TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Channel}), addedCommands);
 
-      AddMissing(new CommandConfig(&quot;kickspec&quot;, 2, &quot;[0|1] - enables or disables automatic spectator kicking&quot;, 0, new TasSayEventArgs.Places[] { TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game, TasSayEventArgs.Places.Normal }), addedCommands);
+      AddMissing(new CommandConfig(&quot;kickspec&quot;, 2, &quot;[0|1] - enables or disables automatic spectator kicking&quot;, 0, new TasSayEventArgs.Places[] {TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game, TasSayEventArgs.Places.Normal}), addedCommands);
 
-      AddMissing(new CommandConfig(&quot;votekickspec&quot;, 0, &quot;- starts a vote to enables or disable automatic spectator kicking&quot;, 0, new TasSayEventArgs.Places[] { TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game }), addedCommands);
+      AddMissing(new CommandConfig(&quot;votekickspec&quot;, 0, &quot;- starts a vote to enables or disable automatic spectator kicking&quot;, 0, new TasSayEventArgs.Places[] {TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game}), addedCommands);
 
       AddMissing(new CommandConfig(&quot;setpassword&quot;, 4, &quot;&lt;newpassword&gt; - sets server password (needs !rehost to apply)&quot;), addedCommands);
 
@@ -438,15 +402,12 @@
 
       AddMissing(new CommandConfig(&quot;setgametitle&quot;, 4, &quot;&lt;new title&gt; - sets server game title (needs !rehost to apply)&quot;), addedCommands);
 
-
       AddMissing(new CommandConfig(&quot;mincpuspeed&quot;, 4, &quot;&lt;GHz&gt; - sets minimum CPU for this host - players with CPU speed below this value are auto-kicked, 0 = no limit&quot;), addedCommands);
 
-
       AddMissing(new CommandConfig(&quot;boss&quot;, 2, &quot;&lt;name&gt; - sets &lt;name&gt; as a new boss, use without parameter to remove any current boss. If there is a boss on server, other non-admin people have their rights reduced&quot;), addedCommands);
 
+      AddMissing(new CommandConfig(&quot;voteboss&quot;, 0, &quot;&lt;name&gt; - sets &lt;name&gt; as a new boss, use without parameter to remove any current boss. If there is a boss on server, other non-admin people have their rights reduced&quot;, 0, new TasSayEventArgs.Places[] {TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game}), addedCommands);
 
-      AddMissing(new CommandConfig(&quot;voteboss&quot;, 0, &quot;&lt;name&gt; - sets &lt;name&gt; as a new boss, use without parameter to remove any current boss. If there is a boss on server, other non-admin people have their rights reduced&quot;, 0, new TasSayEventArgs.Places[] { TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game }), addedCommands);
-
       AddMissing(new CommandConfig(&quot;autolock&quot;, 1, &quot;&lt;players&gt; - sets desired number of players in game. If this number is reached, server will autolock itself, if someone leaves, it will autounlock again. !autolock without parameter disables auto locking&quot;), addedCommands);
 
       AddMissing(new CommandConfig(&quot;spec&quot;, 2, &quot;&lt;username&gt; - forces player to become spectator&quot;, 0), addedCommands);
@@ -455,12 +416,11 @@
 
       AddMissing(new CommandConfig(&quot;kickminrank&quot;, 4, &quot;[0/1] enables or disables automatic kicking of people based upon their rank&quot;, 0), addedCommands);
 
-      AddMissing(new CommandConfig(&quot;cheats&quot;, 3, &quot;enables/disables .cheats in game&quot;, 0, new TasSayEventArgs.Places[] { TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game }), addedCommands);
+      AddMissing(new CommandConfig(&quot;cheats&quot;, 3, &quot;enables/disables .cheats in game&quot;, 0, new TasSayEventArgs.Places[] {TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game}), addedCommands);
 
-      AddMissing(new CommandConfig(&quot;notify&quot;, 0, &quot;springie notifies you when game ends&quot;, 0, new TasSayEventArgs.Places[] { TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game, TasSayEventArgs.Places.Channel }), addedCommands);
+      AddMissing(new CommandConfig(&quot;notify&quot;, 0, &quot;springie notifies you when game ends&quot;, 0, new TasSayEventArgs.Places[] {TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game, TasSayEventArgs.Places.Channel}), addedCommands);
 
-
-      Commands.RemoveAll(delegate(CommandConfig c) { return !addedCommands.Contains(c);});
+      Commands.RemoveAll(delegate(CommandConfig c) { return !addedCommands.Contains(c); });
     }
 
 
@@ -481,9 +441,38 @@
       AddMissingCommands();
     }
 
-    public AutoHostConfig()
+    #region Nested type: MapConverter
+    public class MapConverter : StringConverter
     {
-    }
-  }
+      public override bool GetStandardValuesSupported(ITypeDescriptorContext context)
+      {
+        return true;
+      }
 
-}
+      public override StandardValuesCollection GetStandardValues(ITypeDescriptorContext context)
+      {
+        List&lt;string&gt; maps = new List&lt;string&gt;();
+        foreach (KeyValuePair&lt;string, MapInfo&gt; p in Program.main.Spring.UnitSync.MapList) maps.Add(p.Value.Name);
+        return new StandardValuesCollection(maps);
+      }
+    } ;
+    #endregion
+
+    #region Nested type: ModConverter
+    public class ModConverter : StringConverter
+    {
+      public override bool GetStandardValuesSupported(ITypeDescriptorContext context)
+      {
+        return true;
+      }
+
+      public override StandardValuesCollection GetStandardValues(ITypeDescriptorContext context)
+      {
+        List&lt;string&gt; mods = new List&lt;string&gt;();
+        foreach (KeyValuePair&lt;string, ModInfo&gt; p in Program.main.Spring.UnitSync.ModList) mods.Add(p.Value.Name);
+        return new StandardValuesCollection(mods);
+      }
+    } ;
+    #endregion
+  }
+}
\ No newline at end of file

Modified: trunk/tools/springie/Springie/autohost/AutoHost_commands.cs
===================================================================
--- trunk/tools/springie/Springie/autohost/AutoHost_commands.cs	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/autohost/AutoHost_commands.cs	2008-04-07 18:57:09 UTC (rev 5677)
@@ -1,26 +1,27 @@
 using System;
 using System.Collections.Generic;
-using System.Text;
+using System.Globalization;
 using System.Text.RegularExpressions;
+using System.Threading;
 using Springie.Client;
 using Springie.SpringNamespace;
-using System.Net;
 
-namespace Springie.AutoHostNamespace
+namespace Springie.autohost
 {
   public partial class AutoHost
   {
+    private List&lt;string&gt; toNotify = new List&lt;string&gt;();
+
     internal static int Filter(string[] source, string[] words, out string[] resultVals, out int[] resultIndexes)
     {
-
       int i;
 
       // search by direct index
       if (words.Length == 1) {
         if (int.TryParse(words[0], out i)) {
           if (i &gt;= 0 &amp;&amp; i &lt; source.Length) {
-            resultVals = new string[] { source[i] };
-            resultIndexes = new int[] { i };
+            resultVals = new string[] {source[i]};
+            resultIndexes = new int[] {i};
             return 1;
           }
         }
@@ -29,8 +30,8 @@
         string glued = Utils.Glue(words);
         for (i = 0; i &lt; source.Length; ++i) {
           if (source[i] == glued) {
-            resultVals = new string[] { source[i] };
-            resultIndexes = new int[] { i };
+            resultVals = new string[] {source[i]};
+            resultIndexes = new int[] {i};
             return 1;
           }
         }
@@ -63,16 +64,13 @@
     }
 
 
-
-    static int FilterMaps(string[] words, TasClient tas, Spring spring, Ladder ladder, out string[] vals, out int[] indexes)
+    private static int FilterMaps(string[] words, TasClient tas, Spring spring, Ladder ladder, out string[] vals, out int[] indexes)
     {
       string[] temp = new string[spring.UnitSync.MapList.Keys.Count];
       int cnt = 0;
       foreach (string s in spring.UnitSync.MapList.Keys) {
         if (ladder != null) {
-          if (ladder.Maps.Contains(s.ToLower())) {
-            temp[cnt++] = s;
-          }
+          if (ladder.Maps.Contains(s.ToLower())) temp[cnt++] = s;
         } else {
           string[] limit = Program.main.AutoHost.config.LimitMaps;
           if (limit != null &amp;&amp; limit.Length &gt; 0) {
@@ -85,12 +83,9 @@
             }
             if (allowed) temp[cnt++] = s;
           } else temp[cnt++] = s;
-
-        } 
-        
+        }
       }
       return Filter(temp, words, out vals, out indexes);
-
     }
 
     public int FilterMaps(string[] words, out string[] vals, out int[] indexes)
@@ -103,7 +98,7 @@
     {
       string[] temp = new string[autohost.presets.Count];
       int cnt = 0;
-      foreach (Preset p in autohost.presets) { temp[cnt++] = p.Name + &quot; --&gt; &quot; + p.Description; }
+      foreach (Preset p in autohost.presets) temp[cnt++] = p.Name + &quot; --&gt; &quot; + p.Description;
       return Filter(temp, words, out vals, out indexes);
     }
 
@@ -117,9 +112,7 @@
       Battle b = tas.GetBattle();
       string[] temp = new string[b.Users.Count];
       int i = 0;
-      foreach (UserBattleStatus u in b.Users) {
-        temp[i++] = u.name;
-      }
+      foreach (UserBattleStatus u in b.Users) temp[i++] = u.name;
       return Filter(temp, words, out vals, out indexes);
     }
 
@@ -161,9 +154,7 @@
       int[] indexes;
       if (FilterMaps(words, out vals, out indexes) &gt; 0) {
         tas.Say(TasClient.SayPlace.User, e.UserName, &quot;---&quot;, false);
-        for (int i = 0; i &lt; vals.Length; ++i) {
-          tas.Say(TasClient.SayPlace.User, e.UserName, indexes[i] + &quot;: &quot; + vals[i], false);
-        }
+        for (int i = 0; i &lt; vals.Length; ++i) tas.Say(TasClient.SayPlace.User, e.UserName, indexes[i] + &quot;: &quot; + vals[i], false);
         tas.Say(TasClient.SayPlace.User, e.UserName, &quot;---&quot;, false);
       } else Respond(e, &quot;no such map found&quot;);
     }
@@ -175,9 +166,7 @@
       int[] indexes;
       if (FilterMods(words, out vals, out indexes) &gt; 0) {
         tas.Say(TasClient.SayPlace.User, e.UserName, &quot;---&quot;, false);
-        for (int i = 0; i &lt; vals.Length; ++i) {
-          tas.Say(TasClient.SayPlace.User, e.UserName, indexes[i] + &quot;: &quot; + vals[i], false);
-        }
+        for (int i = 0; i &lt; vals.Length; ++i) tas.Say(TasClient.SayPlace.User, e.UserName, indexes[i] + &quot;: &quot; + vals[i], false);
         tas.Say(TasClient.SayPlace.User, e.UserName, &quot;---&quot;, false);
       } else Respond(e, &quot;no such mod found&quot;);
     }
@@ -189,24 +178,17 @@
 
       if (FilterPresets(words, out vals, out indexes) &gt; 0) {
         tas.Say(TasClient.SayPlace.User, e.UserName, &quot;---&quot;, false);
-        for (int i = 0; i &lt; vals.Length; ++i) {
-          tas.Say(TasClient.SayPlace.User, e.UserName, indexes[i] + &quot;: &quot; + vals[i], false);
-        }
+        for (int i = 0; i &lt; vals.Length; ++i) tas.Say(TasClient.SayPlace.User, e.UserName, indexes[i] + &quot;: &quot; + vals[i], false);
         tas.Say(TasClient.SayPlace.User, e.UserName, &quot;---&quot;, false);
       } else Respond(e, &quot;no such preset found&quot;);
     }
 
 
-
     private void ComHelp(TasSayEventArgs e, string[] words)
     {
       int ulevel = GetUserLevel(e);
       tas.Say(TasClient.SayPlace.User, e.UserName, &quot;---&quot;, false);
-      foreach (CommandConfig c in config.Commands) {
-        if (c.Level &lt;= ulevel) {
-          tas.Say(TasClient.SayPlace.User, e.UserName, &quot; !&quot; + c.Name + &quot; &quot; + c.HelpText, false);
-        }
-      }
+      foreach (CommandConfig c in config.Commands) if (c.Level &lt;= ulevel) tas.Say(TasClient.SayPlace.User, e.UserName, &quot; !&quot; + c.Name + &quot; &quot; + c.HelpText, false);
       tas.Say(TasClient.SayPlace.User, e.UserName, &quot;---&quot;, false);
     }
 
@@ -214,12 +196,14 @@
     private void ComHelpAll(TasSayEventArgs e, string[] words)
     {
       List&lt;CommandConfig&gt; copy = new List&lt;CommandConfig&gt;(config.Commands);
-      copy.Sort(delegate(CommandConfig a, CommandConfig b) { if (a.Level != b.Level) return a.Level.CompareTo(b.Level); else return a.Name.CompareTo(b.Name); });
+      copy.Sort(delegate(CommandConfig a, CommandConfig b)
+                  {
+                    if (a.Level != b.Level) return a.Level.CompareTo(b.Level);
+                    else return a.Name.CompareTo(b.Name);
+                  });
 
       tas.Say(TasClient.SayPlace.User, e.UserName, &quot;---&quot;, false);
-      foreach (CommandConfig c in copy) {
-        tas.Say(TasClient.SayPlace.User, e.UserName, &quot;Level &quot; + c.Level + &quot; --&gt; !&quot; + c.Name + &quot; &quot; + c.HelpText, false);
-      }
+      foreach (CommandConfig c in copy) tas.Say(TasClient.SayPlace.User, e.UserName, &quot;Level &quot; + c.Level + &quot; --&gt; !&quot; + c.Name + &quot; &quot; + c.HelpText, false);
       tas.Say(TasClient.SayPlace.User, e.UserName, &quot;---&quot;, false);
     }
 
@@ -227,9 +211,7 @@
     private void ComAdmins(TasSayEventArgs e, string[] words)
     {
       tas.Say(TasClient.SayPlace.User, e.UserName, &quot;---&quot;, false);
-      foreach (PrivilegedUser u in config.PrivilegedUsers) {
-        tas.Say(TasClient.SayPlace.User, e.UserName, &quot; &quot; + u.Name + &quot; (level &quot; + u.Level.ToString() + &quot;)&quot;, false);
-      }
+      foreach (PrivilegedUser u in config.PrivilegedUsers) tas.Say(TasClient.SayPlace.User, e.UserName, &quot; &quot; + u.Name + &quot; (level &quot; + u.Level.ToString() + &quot;)&quot;, false);
       tas.Say(TasClient.SayPlace.User, e.UserName, &quot;---&quot;, false);
     }
 
@@ -245,9 +227,7 @@
       if (FilterMaps(words, out vals, out indexes) &gt; 0) {
         SayBattle(&quot;changing map to &quot; + vals[0]);
         tas.ChangeMap(spring.UnitSync.MapList[vals[0]]);
-
       } else Respond(e, &quot;Cannot find such map.&quot;);
-
     }
 
 
@@ -256,13 +236,15 @@
       usname = &quot;&quot;;
       int cnt = 0;
       foreach (UserBattleStatus p in tas.GetBattle().Users) {
-        if (p.IsSpectator) continue; else cnt++;
+        if (p.IsSpectator) continue;
+        else cnt++;
         if (p.SyncStatus != SyncStatuses.Synced || !p.IsReady) {
           usname = p.name;
           return false;
         }
       }
-      if (cnt == 0) return false; else return true;
+      if (cnt == 0) return false;
+      else return true;
     }
 
     public bool AllUniqueTeams(out string username)
@@ -308,7 +290,6 @@
         }
       }
       return true;
-
     }
 
     public void ComStart(TasSayEventArgs e, string[] words)
@@ -334,17 +315,14 @@
       StopVote();
 
       Battle b = tas.GetBattle();
-      if (b!= null) {
+      if (b != null) {
         string curMap = b.Map.ArchiveName.ToLower();
-        
+
         Dictionary&lt;int, BattleRect&gt; nd = new Dictionary&lt;int, BattleRect&gt;();
-        foreach (KeyValuePair&lt;int, BattleRect&gt; v in b.Rectangles) {
-          nd.Add(v.Key, v.Value);
-        }
+        foreach (KeyValuePair&lt;int, BattleRect&gt; v in b.Rectangles) nd.Add(v.Key, v.Value);
 
-        if (MapBoxes.ContainsKey(curMap)) {
-          MapBoxes[curMap] = nd;
-        } else MapBoxes.Add(curMap, nd);
+        if (MapBoxes.ContainsKey(curMap)) MapBoxes[curMap] = nd;
+        else MapBoxes.Add(curMap, nd);
         SaveConfig();
       }
       tas.ChangeLock(true);
@@ -370,9 +348,7 @@
       if (spring.IsRunning) {
         SayBattle(&quot;forcing game start by &quot; + e.UserName);
         spring.ForceStart();
-      } else {
-        Respond(e, &quot;cannot force, game not started&quot;);
-      }
+      } else Respond(e, &quot;cannot force, game not started&quot;);
     }
 
     public void ComSplit(TasSayEventArgs e, string[] words)
@@ -381,19 +357,18 @@
         Respond(e, &quot;This command needs 2 parameters&quot;);
         return;
       }
-      if (words[0] != &quot;h&quot; &amp;&amp; words[0] != &quot;v&quot;) {
-        Respond(e, &quot;first parameter must be 'h' or 'v'&quot;);
-      } else {
+      if (words[0] != &quot;h&quot; &amp;&amp; words[0] != &quot;v&quot;) Respond(e, &quot;first parameter must be 'h' or 'v'&quot;);
+      else {
         int perc;
         int.TryParse(words[1], out perc);
         if (perc &lt; 0 || perc &gt; 50) Respond(e, &quot;second parameter must be between 0 and 50&quot;);
         else {
           if (words[0] == &quot;h&quot;) {
-            tas.AddBattleRectangle(0, new BattleRect(0, 0, 1.0, perc / 100.0));
-            tas.AddBattleRectangle(1, new BattleRect(0, 1.0 - perc / 100.0, 1.0, 1.0));
+            tas.AddBattleRectangle(0, new BattleRect(0, 0, 1.0, perc/100.0));
+            tas.AddBattleRectangle(1, new BattleRect(0, 1.0 - perc/100.0, 1.0, 1.0));
           } else {
-            tas.AddBattleRectangle(0, new BattleRect(0, 0, perc / 100.0, 1.0));
-            tas.AddBattleRectangle(1, new BattleRect(1.0 - perc / 100.0, 0, 1.0, 1.0));
+            tas.AddBattleRectangle(0, new BattleRect(0, 0, perc/100.0, 1.0));
+            tas.AddBattleRectangle(1, new BattleRect(1.0 - perc/100.0, 0, 1.0, 1.0));
           }
           tas.RemoveBattleRectangle(2);
           tas.RemoveBattleRectangle(3);
@@ -408,14 +383,13 @@
         Respond(e, &quot;This command needs 2 parameters&quot;);
         return;
       }
-      if (words[0] != &quot;a&quot; &amp;&amp; words[0] != &quot;b&quot;) {
-        Respond(e, &quot;first parameter must be 'a' or 'b'&quot;);
-      } else {
+      if (words[0] != &quot;a&quot; &amp;&amp; words[0] != &quot;b&quot;) Respond(e, &quot;first parameter must be 'a' or 'b'&quot;);
+      else {
         int perc;
         int.TryParse(words[1], out perc);
         if (perc &lt; 0 || perc &gt; 50) Respond(e, &quot;second parameter must be between 0 and 50&quot;);
         else {
-          double p = perc / 100.0;
+          double p = perc/100.0;
           if (words[0] == &quot;a&quot;) {
             tas.AddBattleRectangle(0, new BattleRect(0, 0, p, p));
             tas.AddBattleRectangle(1, new BattleRect(1 - p, 1 - p, 1, 1));
@@ -432,7 +406,6 @@
     }
 
 
-
     public void ComAddBox(TasSayEventArgs e, string[] words)
     {
       if (words.Length &lt; 4) {
@@ -455,20 +428,15 @@
         }
         numrect++;
       }
-      tas.AddBattleRectangle(numrect - 1, new BattleRect(x * 2, y * 2, (x + w) * 2, (y + h) * 2));
+      tas.AddBattleRectangle(numrect - 1, new BattleRect(x*2, y*2, (x + w)*2, (y + h)*2));
     }
 
     public void ComClearBox(TasSayEventArgs e, string[] words)
     {
-      if (words.Length == 0) {
-        foreach (int i in tas.GetBattle().Rectangles.Keys) {
-          tas.RemoveBattleRectangle(i);
-        }
-      } else {
+      if (words.Length == 0) foreach (int i in tas.GetBattle().Rectangles.Keys) tas.RemoveBattleRectangle(i);
+      else {
         int numrect = 0;
-        if (!int.TryParse(words[0], out numrect)) {
-          Respond(e, &quot;paramater must by a number of rectangle&quot;);
-        }
+        if (!int.TryParse(words[0], out numrect)) Respond(e, &quot;paramater must by a number of rectangle&quot;);
         tas.RemoveBattleRectangle(numrect - 1);
       }
     }
@@ -477,7 +445,8 @@
     {
       List&lt;string&gt; usrlist = new List&lt;string&gt;();
 
-      if (words.Length == 0) { // ringing idle
+      if (words.Length == 0) {
+        // ringing idle
         foreach (UserBattleStatus p in tas.GetBattle().Users) {
           if (p.IsSpectator) continue;
           if (!p.IsReady) usrlist.Add(p.name);
@@ -495,7 +464,8 @@
         rang += s + &quot;, &quot;;
       }
 
-      if (words.Length == 0 &amp;&amp; usrlist.Count &gt; 7) SayBattle(&quot;ringing all unready&quot;); else SayBattle(&quot;ringing &quot; + rang);
+      if (words.Length == 0 &amp;&amp; usrlist.Count &gt; 7) SayBattle(&quot;ringing all unready&quot;);
+      else SayBattle(&quot;ringing &quot; + rang);
     }
 
 
@@ -544,11 +514,8 @@
 
     public void ComExit(TasSayEventArgs e, string[] words)
     {
-      if (spring.IsRunning) {
-        SayBattle(&quot;exiting game&quot;);
-      } else {
-        Respond(e, &quot;cannot exit, not in game&quot;);
-      }
+      if (spring.IsRunning) SayBattle(&quot;exiting game&quot;);
+      else Respond(e, &quot;cannot exit, not in game&quot;);
       spring.ExitGame();
     }
 
@@ -572,9 +539,7 @@
       List&lt;MyCol&gt; cols = new List&lt;MyCol&gt;();
       Battle b = tas.GetBattle();
 
-      foreach (UserBattleStatus u in b.Users) {
-        if (!u.IsSpectator) cols.Add((MyCol)u.TeamColor);
-      }
+      foreach (UserBattleStatus u in b.Users) if (!u.IsSpectator) cols.Add((MyCol)u.TeamColor);
       MyCol[] arcols = cols.ToArray();
 
       MyCol.FixColors(arcols, 30000);
@@ -596,16 +561,12 @@
 
     public void ComRehost(TasSayEventArgs e, string[] words)
     {
-      if (words.Length == 0) {
-        Start(null, null);
-      } else {
+      if (words.Length == 0) Start(null, null);
+      else {
         string[] mods;
         int[] indexes;
-        if (FilterMods(words, out mods, out indexes) == 0) {
-          Respond(e, &quot;cannot find such mod&quot;);
-        } else {
-          Start(mods[0], null);
-        }
+        if (FilterMods(words, out mods, out indexes) == 0) Respond(e, &quot;cannot find such mod&quot;);
+        else Start(mods[0], null);
       }
     }
 
@@ -615,12 +576,11 @@
       Battle b = tas.GetBattle();
 
       List&lt;UserBattleStatus&gt; actUsers = new List&lt;UserBattleStatus&gt;();
-      foreach (UserBattleStatus u in b.Users) {
-        if (!u.IsSpectator) actUsers.Add(u);
-      }
+      foreach (UserBattleStatus u in b.Users) if (!u.IsSpectator) actUsers.Add(u);
 
       int teamCount = 0;
-      if (words.Length &gt; 0) int.TryParse(words[0], out teamCount); else teamCount = 2;
+      if (words.Length &gt; 0) int.TryParse(words[0], out teamCount);
+      else teamCount = 2;
       if (teamCount &lt; 2) teamCount = 2;
       if (teamCount &gt; actUsers.Count) teamCount = 2;
       Random r = new Random();
@@ -631,34 +591,18 @@
         tas.ForceAlly(actUsers[index].name, al);
         actUsers.RemoveAt(index);
         al++;
-        al = al % teamCount;
+        al = al%teamCount;
       }
       SayBattle(&quot;players assigned to &quot; + teamCount + &quot; random teams&quot;);
     }
 
 
-
     // user and rank info
-    private class UsRank
-    {
-      public int id;
-      public int rank;
-      public string clan;
-      public UsRank(int id, int rank, string clan)
-      {
-        this.id = id;
-        this.rank = rank;
-        this.clan = clan;
-      }
-    }
 
 
-
     private static string GetClan(string name)
     {
-      foreach (Match m in Regex.Matches(name, &quot;\\[([^\\]]+)\\]&quot;)) {
-        return m.Groups[1].Value;
-      }
+      foreach (Match m in Regex.Matches(name, &quot;\\[([^\\]]+)\\]&quot;)) return m.Groups[1].Value;
       return &quot;&quot;;
     }
 
@@ -672,7 +616,8 @@
         if (!u.IsSpectator) {
           actUsers.Add(u);
           User p;
-          if (tas.GetExistingUser(u.name, out p)) ranker.Add(new UsRank(ranker.Count, p.rank, GetClan(u.name))); else ranker.Add(new UsRank(ranker.Count, 0, GetClan(u.name))); // cannot find user, assume rank 0
+          if (tas.GetExistingUser(u.name, out p)) ranker.Add(new UsRank(ranker.Count, p.rank, GetClan(u.name)));
+          else ranker.Add(new UsRank(ranker.Count, 0, GetClan(u.name))); // cannot find user, assume rank 0
         }
       }
 
@@ -683,11 +628,7 @@
       while (tempList.Count &gt; 0) {
         // find max rank value
         int maxval = int.MinValue;
-        foreach (UsRank u in tempList) {
-          if (u.rank &gt; maxval) {
-            maxval = u.rank;
-          }
-        }
+        foreach (UsRank u in tempList) if (u.rank &gt; maxval) maxval = u.rank;
 
         List&lt;UsRank&gt; l2 = new List&lt;UsRank&gt;(); // pick pieces with max rank to l2
         int j = 0;
@@ -700,12 +641,12 @@
           j++;
         }
 
-        while (l2.Count &gt; 0) { // randomly add pieces from l2 to ranker
+        while (l2.Count &gt; 0) {
+          // randomly add pieces from l2 to ranker
           int ind = rand.Next(l2.Count);
           ranker.Add(l2[ind]);
           l2.RemoveAt(ind);
         }
-
       }
 
       if (teamCount &lt; 2 || teamCount &gt; ranker.Count) teamCount = 2;
@@ -722,27 +663,22 @@
         // remove clans that have less than 2 members - those are irelevant
         foreach (UsRank u in ranker) {
           if (u.clan != &quot;&quot;) {
-            if (ranker.FindAll(delegate(UsRank x) { return x.clan == u.clan; }).Count &lt; 2) {
-              u.clan = &quot;&quot;;
-            } else {
-              clans += u.clan + &quot;, &quot;;
-            }
+            if (ranker.FindAll(delegate(UsRank x) { return x.clan == u.clan; }).Count &lt; 2) u.clan = &quot;&quot;;
+            else clans += u.clan + &quot;, &quot;;
           }
         }
         if (clans != &quot;&quot;) SayBattle(&quot;those clan are being balanced: &quot; + clans);
       }
 
-
       // this cycle performs actual user adding to teams
       int cnt = 0;
       while (ranker.Count &gt; 0) {
-
         int minsum = int.MaxValue;
         int minid = 0;
         for (int i = 0; i &lt; teamCount; ++i) {
           List&lt;UsRank&gt; l = teamUsers[i];
           // pick only current &quot;row&quot; and find the one with least sum
-          if (l.Count == cnt / teamCount) {
+          if (l.Count == cnt/teamCount) {
             if (teamSums[i] &lt; minsum) {
               minid = i;
               minsum = teamSums[i];
@@ -751,23 +687,16 @@
         }
 
         int picked_user = 0;
-        if (clanwise) { // clanwise balancing - attempt to pick someone with same clan
+        if (clanwise) {
+          // clanwise balancing - attempt to pick someone with same clan
           // selected team already has some clan
           int rank = ranker[0].rank;
           List&lt;int&gt; temp = new List&lt;int&gt;();
 
-
           // get list of clans assigned to other teams
           List&lt;string&gt; assignedClans = new List&lt;string&gt;();
-          for (int i = 0; i &lt; teamClans.Length; ++i) {
-            if (i != minid) {
-              foreach (string clanName in teamClans[i]) {
-                assignedClans.Add(clanName);
-              }
-            }
-          }
+          for (int i = 0; i &lt; teamClans.Length; ++i) if (i != minid) foreach (string clanName in teamClans[i]) assignedClans.Add(clanName);
 
-
           // first try to get some with same clan
           if (teamClans[minid].Count &gt; 0) {
             for (int i = 0; i &lt; ranker.Count; ++i) {
@@ -793,14 +722,16 @@
           }
 
           // if we have some candidates pick one randomly
-          if (temp.Count &gt; 0) picked_user = temp[rand.Next(temp.Count)]; ;
+          if (temp.Count &gt; 0) picked_user = temp[rand.Next(temp.Count)];
+          ;
         }
 
         UsRank usr = ranker[picked_user];
         teamUsers[minid].Add(usr);
         teamSums[minid] += usr.rank;
 
-        if (clanwise &amp;&amp; usr.clan != &quot;&quot;) { // if we work with clans add user's clan to clan list for his team
+        if (clanwise &amp;&amp; usr.clan != &quot;&quot;) {
+          // if we work with clans add user's clan to clan list for his team
           if (!teamClans[minid].Contains(usr.clan)) teamClans[minid].Add(usr.clan);
         }
 
@@ -809,7 +740,6 @@
         cnt++;
       }
 
-
       // alliances for allinace permutations
       List&lt;int&gt; allys = new List&lt;int&gt;();
       for (int i = 0; i &lt; teamCount; ++i) allys.Add(i);
@@ -820,9 +750,7 @@
         int allynum = allys[rdindex];
         allys.RemoveAt(rdindex);
 
-        foreach (UsRank u in teamUsers[i]) {
-          tas.ForceAlly(actUsers[u.id].name, allynum);
-        }
+        foreach (UsRank u in teamUsers[i]) tas.ForceAlly(actUsers[u.id].name, allynum);
       }
 
       string t = string.Format(&quot;{0} players balanced to {1} teams (ranks &quot;, actUsers.Count, teamCount);
@@ -836,12 +764,11 @@
     }
 
 
-
-
     public void ComBalance(TasSayEventArgs e, string[] words)
     {
       int teamCount = 2;
-      if (words.Length &gt; 0) int.TryParse(words[0], out teamCount); else teamCount = 2;
+      if (words.Length &gt; 0) int.TryParse(words[0], out teamCount);
+      else teamCount = 2;
       ComFix(e, words);
       BalanceTeams(teamCount, false);
     }
@@ -849,7 +776,8 @@
     public void ComCBalance(TasSayEventArgs e, string[] words)
     {
       int teamCount = 2;
-      if (words.Length &gt; 0) int.TryParse(words[0], out teamCount); else teamCount = 2;
+      if (words.Length &gt; 0) int.TryParse(words[0], out teamCount);
+      else teamCount = 2;
       ComFix(e, words);
       BalanceTeams(teamCount, true);
     }
@@ -894,15 +822,13 @@
         try {
           dump = linker.GetResults(str, UnknownFilesLinker.FileType.Map);
           res = Regex.Match(dump, &quot;file/([0-9]*)&quot;).Groups[1].Value;
-        } catch { }
+        } catch {}
       }
 
       if (res != &quot;&quot;) {
         Respond(e, &quot;Starting map download&quot;);
         fileDownloader.DownloadMap(res);
-      } else {
-        Respond(e, &quot;I cannot find such map&quot;);
-      }
+      } else Respond(e, &quot;I cannot find such map&quot;);
     }
 
 
@@ -922,19 +848,16 @@
         try {
           dump = linker.GetResults(str, UnknownFilesLinker.FileType.Mod);
           res = Regex.Match(dump, &quot;file/([0-9]*)&quot;).Groups[1].Value;
-        } catch { }
+        } catch {}
       }
 
       if (res != &quot;&quot;) {
         Respond(e, &quot;Starting mod download&quot;);
         fileDownloader.DownloadMod(res);
-      } else {
-        Respond(e, &quot;I cannot find such mod&quot;);
-      }
+      } else Respond(e, &quot;I cannot find such mod&quot;);
     }
 
 
-
     public void ComTeam(TasSayEventArgs e, string[] words)
     {
       if (words.Length &lt; 2) {
@@ -948,9 +871,8 @@
       }
       string[] usrs;
       int[] idx;
-      if (FilterUsers(Utils.ShiftArray(words, -1), out usrs, out idx) == 0) {
-        Respond(e, &quot;no such player found&quot;);
-      } else {
+      if (FilterUsers(Utils.ShiftArray(words, -1), out usrs, out idx) == 0) Respond(e, &quot;no such player found&quot;);
+      else {
         SayBattle(&quot;Forcing &quot; + usrs[0] + &quot; to team &quot; + (teamno + 1));
         tas.ForceTeam(usrs[0], teamno);
       }
@@ -966,11 +888,8 @@
       int.TryParse(words[0], out min);
       int max = min;
       if (words.Length &gt; 1) int.TryParse(words[1], out max);
-      if (min == 0) {
-        Respond(e, &quot;managing disabled&quot;);
-      } else {
-        Respond(e, &quot;auto managing for &quot; + min + &quot; to &quot; + max + &quot; players&quot;);
-      }
+      if (min == 0) Respond(e, &quot;managing disabled&quot;);
+      else Respond(e, &quot;auto managing for &quot; + min + &quot; to &quot; + max + &quot; players&quot;);
       manager.Manage(min, max);
     }
 
@@ -987,9 +906,8 @@
       }
       string[] usrs;
       int[] idx;
-      if (FilterUsers(Utils.ShiftArray(words, -1), out usrs, out idx) == 0) {
-        Respond(e, &quot;no such player found&quot;);
-      } else {
+      if (FilterUsers(Utils.ShiftArray(words, -1), out usrs, out idx) == 0) Respond(e, &quot;no such player found&quot;);
+      else {
         SayBattle(&quot;Forcing &quot; + usrs[0] + &quot; to alliance &quot; + (allyno + 1));
         tas.ForceAlly(usrs[0], allyno);
       }
@@ -998,7 +916,7 @@
 
     public void ComSpringie(TasSayEventArgs e, string[] words)
     {
-      Client.Battle b = tas.GetBattle();
+      Battle b = tas.GetBattle();
 
       TimeSpan running = DateTime.Now.Subtract(Program.startupTime);
       running = new TimeSpan((int)running.TotalHours, running.Minutes, running.Seconds);
@@ -1019,9 +937,7 @@
       int[] indexes;
       if (FilterPresets(words, out vals, out indexes) &gt; 0) {
         tas.Say(TasClient.SayPlace.User, e.UserName, &quot;---&quot;, false);
-        foreach (string line in presets[indexes[0]].ToString().Split(new char[] { '\n' }, StringSplitOptions.RemoveEmptyEntries)) {
-          tas.Say(TasClient.SayPlace.User, e.UserName, line, false);
-        }
+        foreach (string line in presets[indexes[0]].ToString().Split(new char[] {'\n'}, StringSplitOptions.RemoveEmptyEntries)) tas.Say(TasClient.SayPlace.User, e.UserName, line, false);
         tas.Say(TasClient.SayPlace.User, e.UserName, &quot;---&quot;, false);
       } else Respond(e, &quot;no such preset found&quot;);
     }
@@ -1041,9 +957,7 @@
 
     private void SayLines(TasSayEventArgs e, string what)
     {
-      foreach (string line in what.Split(new char[] { '\n', '\r' }, StringSplitOptions.RemoveEmptyEntries)) {
-        tas.Say(TasClient.SayPlace.User, e.UserName, line, false);
-      }
+      foreach (string line in what.Split(new char[] {'\n', '\r'}, StringSplitOptions.RemoveEmptyEntries)) tas.Say(TasClient.SayPlace.User, e.UserName, line, false);
     }
 
 
@@ -1056,25 +970,16 @@
       Battle b = tas.GetBattle();
       if (b != null) {
         string query = string.Format(&quot;user={0}&amp;map={1}&amp;mod={2}&amp;p={3}&quot;, e.UserName, b.Map.Name, b.Mod.Name, Utils.Glue(words));
-        foreach (UserBattleStatus u in b.Users) {
-          if (u.name != tas.UserName) {
-            query += string.Format(&quot;&amp;users[]={0}|{1}|{2}&quot;, u.name, (u.IsSpectator ? &quot;1&quot; : &quot;0&quot;), u.AllyNumber);
-          }
-        }
-        string[] response = Program.main.Stats.SendCommand(scriptName, query, false, true).Split(new char[] { '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries);
+        foreach (UserBattleStatus u in b.Users) if (u.name != tas.UserName) query += string.Format(&quot;&amp;users[]={0}|{1}|{2}&quot;, u.name, (u.IsSpectator ? &quot;1&quot; : &quot;0&quot;), u.AllyNumber);
+        string[] response = Program.main.Stats.SendCommand(scriptName, query, false, true).Split(new char[] {'\r', '\n'}, StringSplitOptions.RemoveEmptyEntries);
 
         if (response.Length == 0) {
           Respond(e, &quot;error accessing stats server&quot;);
           return;
         }
 
-        if (response[0].StartsWith(&quot;RESPOND&quot;)) {
-          for (int i = 1; i &lt; response.Length; ++i) {
-            Respond(e, response[i]);
-          }
-        } else {
-          foreach (string line in response) tas.Say(TasClient.SayPlace.User, e.UserName, line, false);
-        }
+        if (response[0].StartsWith(&quot;RESPOND&quot;)) for (int i = 1; i &lt; response.Length; ++i) Respond(e, response[i]);
+        else foreach (string line in response) tas.Say(TasClient.SayPlace.User, e.UserName, line, false);
       }
     }
 
@@ -1085,9 +990,7 @@
       if (b != null) {
         foreach (UserBattleStatus u in b.Users) {
           User u2;
-          if (u.name != tas.UserName &amp;&amp; !u.IsSpectator &amp;&amp; !u.IsReady &amp;&amp; tas.GetExistingUser(u.name, out u2)) {
-            if (u2.isAway) ComForceSpectator(e, new string[] { u.name });
-          }
+          if (u.name != tas.UserName &amp;&amp; !u.IsSpectator &amp;&amp; !u.IsReady &amp;&amp; tas.GetExistingUser(u.name, out u2)) if (u2.isAway) ComForceSpectator(e, new string[] {u.name});
         }
       }
     }
@@ -1095,40 +998,26 @@
 
     public void ComKickSpec(TasSayEventArgs e, string[] words)
     {
-      if (words.Length &gt; 0 &amp;&amp; (words[0] == &quot;1&quot; || words[0] == &quot;0&quot;)) {
-        kickSpectators = (words[0] == &quot;1&quot;);
-      } else kickSpectators = !kickSpectators;
+      if (words.Length &gt; 0 &amp;&amp; (words[0] == &quot;1&quot; || words[0] == &quot;0&quot;)) kickSpectators = (words[0] == &quot;1&quot;);
+      else kickSpectators = !kickSpectators;
 
-      if (kickSpectators) {
-        SayBattle(&quot;automatic spectator kicking is now ENABLED&quot;);
-      } else {
-        SayBattle(&quot;automatic spectator kicking is now DISABLED&quot;);
-      }
+      if (kickSpectators) SayBattle(&quot;automatic spectator kicking is now ENABLED&quot;);
+      else SayBattle(&quot;automatic spectator kicking is now DISABLED&quot;);
 
       if (kickSpectators) {
         SayBattle(config.KickSpectatorText);
         Battle b = tas.GetBattle();
-        if (b != null) {
-          foreach (UserBattleStatus u in b.Users) {
-            if (u.name != tas.UserName &amp;&amp; u.IsSpectator) {
-              ComKick(e, new string[] { u.name });
-            }
-          }
-        }
+        if (b != null) foreach (UserBattleStatus u in b.Users) if (u.name != tas.UserName &amp;&amp; u.IsSpectator) ComKick(e, new string[] {u.name});
       }
     }
 
     public void ComKickMinRank(TasSayEventArgs e, string[] words)
     {
-      if (words.Length &gt; 0 &amp;&amp; (words[0] == &quot;1&quot; || words[0] == &quot;0&quot;)) {
-        kickMinRank = (words[0] == &quot;1&quot;);
-      } else kickMinRank = !kickMinRank;
+      if (words.Length &gt; 0 &amp;&amp; (words[0] == &quot;1&quot; || words[0] == &quot;0&quot;)) kickMinRank = (words[0] == &quot;1&quot;);
+      else kickMinRank = !kickMinRank;
 
-      if (kickMinRank) {
-        SayBattle(&quot;automatic minrank kicking is now ENABLED&quot;);
-      } else {
-        SayBattle(&quot;automatic minrank kicking is now DISABLED&quot;);
-      }
+      if (kickMinRank) SayBattle(&quot;automatic minrank kicking is now ENABLED&quot;);
+      else SayBattle(&quot;automatic minrank kicking is now DISABLED&quot;);
 
       HandleMinRankKicking();
     }
@@ -1147,9 +1036,8 @@
       } else {
         string[] usrs;
         int[] idx;
-        if (FilterUsers(words, out usrs, out idx) == 0) {
-          Respond(e, &quot;no such player found&quot;);
-        } else {
+        if (FilterUsers(words, out usrs, out idx) == 0) Respond(e, &quot;no such player found&quot;);
+        else {
           SayBattle(&quot;New boss is &quot; + usrs[0]);
           bossName = usrs[0];
         }
@@ -1159,9 +1047,8 @@
 
     private void ComSetMinRank(TasSayEventArgs e, string[] words)
     {
-      if (words.Length == 0) {
-        Respond(e, &quot;this command needs one parameter - rank number&quot;);
-      } else {
+      if (words.Length == 0) Respond(e, &quot;this command needs one parameter - rank number&quot;);
+      else {
         int rank;
         int.TryParse(words[0], out rank);
         if (rank &lt; TasClient.MinRank) rank = TasClient.MinRank;
@@ -1175,10 +1062,9 @@
 
     private void ComSetMinCpuSpeed(TasSayEventArgs e, string[] words)
     {
-      if (words.Length == 0) {
-        Respond(e, &quot;this command needs one parameter - minimal CPU speed&quot;);
-      } else {
-        System.Threading.Thread.CurrentThread.CurrentCulture = System.Globalization.CultureInfo.InvariantCulture;
+      if (words.Length == 0) Respond(e, &quot;this command needs one parameter - minimal CPU speed&quot;);
+      else {
+        Thread.CurrentThread.CurrentCulture = CultureInfo.InvariantCulture;
         double minCpu;
         double.TryParse(words[0], out minCpu);
         minCpuSpeed = minCpu;
@@ -1188,11 +1074,7 @@
           if (b != null) {
             foreach (UserBattleStatus ubs in b.Users) {
               User u;
-              if (ubs.name != tas.UserName &amp;&amp; tas.GetExistingUser(ubs.name, out u)) {
-                if (u.cpu &gt; 0 &amp;&amp; u.cpu &lt; minCpuSpeed * 1000) {
-                  ComKick(e, new string[] { u.name });
-                }
-              }
+              if (ubs.name != tas.UserName &amp;&amp; tas.GetExistingUser(ubs.name, out u)) if (u.cpu &gt; 0 &amp;&amp; u.cpu &lt; minCpuSpeed*1000) ComKick(e, new string[] {u.name});
             }
           }
         }
@@ -1201,9 +1083,8 @@
 
     private void ComSetMaxPlayers(TasSayEventArgs e, string[] words)
     {
-      if (words.Length == 0) {
-        Respond(e, &quot;this command needs one parameter - number of players&quot;);
-      } else {
+      if (words.Length == 0) Respond(e, &quot;this command needs one parameter - number of players&quot;);
+      else {
         int plr;
         int.TryParse(words[0], out plr);
         if (plr &lt; 1) plr = 1;
@@ -1216,9 +1097,8 @@
 
     private void ComSetGameTitle(TasSayEventArgs e, string[] words)
     {
-      if (words.Length == 0) {
-        Respond(e, &quot;this command needs one parameter - new game title&quot;);
-      } else {
+      if (words.Length == 0) Respond(e, &quot;this command needs one parameter - new game title&quot;);
+      else {
         Program.main.AutoHost.config.GameTitle = Utils.Glue(words);
         SaveConfig();
         Respond(e, &quot;game title changed&quot;);
@@ -1262,13 +1142,8 @@
     private void ComListOptions(TasSayEventArgs e, string[] words)
     {
       Battle b = tas.GetBattle();
-      if (b.Mod.Options.Count == 0) {
-        Respond(e, &quot;this mod has no options&quot;);
-      } else {
-        foreach (UnitSync.Option opt in b.Mod.Options) {
-          Respond(e, opt.ToString());
-        }
-      }
+      if (b.Mod.Options.Count == 0) Respond(e, &quot;this mod has no options&quot;);
+      else foreach (UnitSync.Option opt in b.Mod.Options) Respond(e, opt.ToString());
     }
 
 
@@ -1276,13 +1151,13 @@
     {
       string s = Utils.Glue(words);
       string result = &quot;&quot;;
-      string[] pairs = s.Split(new char[] { ',' });
+      string[] pairs = s.Split(new char[] {','});
       if (pairs.Length == 0 || pairs[0].Length == 0) {
         Respond(e, &quot;requires key=value format&quot;);
         return &quot;&quot;;
       }
       foreach (string pair in pairs) {
-        string[] parts = pair.Split(new char[] { '=' }, 2);
+        string[] parts = pair.Split(new char[] {'='}, 2);
         if (parts.Length != 2) {
           Respond(e, &quot;requires key=value format&quot;);
           return &quot;&quot;;
@@ -1293,16 +1168,13 @@
 
         bool found = false;
         foreach (UnitSync.Option o in b.Mod.Options) {
-
           if (o.Key == key) {
             found = true;
             string res;
             if (o.GetPair(val, out res)) {
               if (result != &quot;&quot;) result += &quot;\t&quot;;
               result += res;
-            } else {
-              Respond(e, &quot;Value &quot; + val + &quot; is not valid for this option&quot;);
-            }
+            } else Respond(e, &quot;Value &quot; + val + &quot; is not valid for this option&quot;);
 
             break;
           }
@@ -1316,13 +1188,11 @@
     }
 
 
-
-    List&lt;string&gt; toNotify = new List&lt;string&gt;();
-    private void ComNotify(TasSayEventArgs e, string[] words) {
+    private void ComNotify(TasSayEventArgs e, string[] words)
+    {
       if (!toNotify.Contains(e.UserName)) toNotify.Add(e.UserName);
       Respond(e, &quot;I will notify you when game ends&quot;);
     }
-    
 
 
     private void ComSetOption(TasSayEventArgs e, string[] words)
@@ -1333,5 +1203,21 @@
         Respond(e, &quot;Options set&quot;);
       }
     }
+
+    #region Nested type: UsRank
+    private class UsRank
+    {
+      public string clan;
+      public int id;
+      public int rank;
+
+      public UsRank(int id, int rank, string clan)
+      {
+        this.id = id;
+        this.rank = rank;
+        this.clan = clan;
+      }
+    }
+    #endregion
   }
-}
+}
\ No newline at end of file

Modified: trunk/tools/springie/Springie/autohost/AutoManager.cs
===================================================================
--- trunk/tools/springie/Springie/autohost/AutoManager.cs	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/autohost/AutoManager.cs	2008-04-07 18:57:09 UTC (rev 5677)
@@ -1,38 +1,32 @@
 &#65279;using System;
-using System.Collections.Generic;
-using System.Text;
-using Springie.AutoHostNamespace;
-using Springie.Client;
+using System.Threading;
 using System.Timers;
+using Springie.autohost;
+using Springie.Client;
 using Springie.SpringNamespace;
+using Timer=System.Timers.Timer;
 
 namespace Springie.AutoHostNamespace
 {
   public class AutoManager
   {
-    const int RingEvery = 60;
-    const int SpecAfkAfter = 60;
-    const int SpecForceAfter = 120;
-    const int KickAfter = 300;
+    private const int KickAfter = 300;
+    private const int RingEvery = 60;
+    private const int SpecAfkAfter = 60;
+    private const int SpecForceAfter = 120;
 
-    AutoHost ah;
-    TasClient tas;
-    Spring spring;
-    Timer timer = new Timer(5000);
+    private AutoHost ah;
+    private int from;
+    private DateTime lastRing = DateTime.Now;
+    private Spring spring;
+    private TasClient tas;
+    private Timer timer = new Timer(5000);
 
-    int from;
-    int to;
+    private int to;
 
-    DateTime waitForReadySince = DateTime.Now;
-    DateTime lastRing = DateTime.Now;
-    bool waitReady = false;
+    private DateTime waitForReadySince = DateTime.Now;
+    private bool waitReady = false;
 
-    public bool Enabled {
-      get {
-        return from &gt; 0;
-      }
-    }
-
     public AutoManager(AutoHost ah, TasClient tas, Spring spring)
     {
       this.ah = ah;
@@ -40,12 +34,15 @@
       this.spring = spring;
       timer.Elapsed += new ElapsedEventHandler(timer_Elapsed);
       timer.Start();
+    }
 
+    public bool Enabled
+    {
+      get { return from &gt; 0; }
     }
 
 
-
-    void timer_Elapsed(object sender, ElapsedEventArgs e)
+    private void timer_Elapsed(object sender, ElapsedEventArgs e)
     {
       lock (timer) {
         timer.Stop();
@@ -57,50 +54,40 @@
               if (plrCnt &gt;= from &amp;&amp; plrCnt &lt;= to) {
                 string notReady;
                 bool isReady = ah.AllReadyAndSynced(out notReady);
-                if (plrCnt % 2 == 0) {
+                if (plrCnt%2 == 0) {
                   int allyno;
                   if (!ah.BalancedTeams(out allyno)) {
-                    ah.ComFix(TasSayEventArgs.Default, new string[] { });
-                    ah.ComFixColors(TasSayEventArgs.Default, new string[] { });
+                    ah.ComFix(TasSayEventArgs.Default, new string[] {});
+                    ah.ComFixColors(TasSayEventArgs.Default, new string[] {});
                     ah.BalanceTeams(2, false);
                   }
                 }
                 if (isReady) {
-                  System.Threading.Thread.Sleep(1000);
-                  if (!spring.IsRunning) ah.ComStart(TasSayEventArgs.Default, new string[] { });
+                  Thread.Sleep(1000);
+                  if (!spring.IsRunning) ah.ComStart(TasSayEventArgs.Default, new string[] {});
                 } else {
                   DateTime now = DateTime.Now;
                   if (!waitReady) {
                     waitReady = true;
                     waitForReadySince = now;
                   }
-                  if (plrCnt &gt; from &amp;&amp; plrCnt % 2 == 1 &amp;&amp; b.IsLocked) {
-                    ah.ComAutoLock(TasSayEventArgs.Default, new string[] { (plrCnt + 1).ToString() });
-                  }
+                  if (plrCnt &gt; from &amp;&amp; plrCnt%2 == 1 &amp;&amp; b.IsLocked) ah.ComAutoLock(TasSayEventArgs.Default, new string[] {(plrCnt + 1).ToString()});
 
                   if (now.Subtract(lastRing).TotalSeconds &gt; RingEvery) {
                     lastRing = now;
-                    ah.ComRing(TasSayEventArgs.Default, new string[] { });
+                    ah.ComRing(TasSayEventArgs.Default, new string[] {});
                   }
 
-                  if (plrCnt &gt; from &amp;&amp; now.Subtract(waitForReadySince).TotalSeconds &gt; SpecForceAfter) {
-                    ah.ComForceSpectator(TasSayEventArgs.Default, new string[] { notReady });
-                  }
+                  if (plrCnt &gt; from &amp;&amp; now.Subtract(waitForReadySince).TotalSeconds &gt; SpecForceAfter) ah.ComForceSpectator(TasSayEventArgs.Default, new string[] {notReady});
 
-                  if (now.Subtract(waitForReadySince).TotalSeconds &gt; SpecAfkAfter) {
-                    ah.ComForceSpectatorAfk(TasSayEventArgs.Default, new string[] { });
-                  }
-                  if (now.Subtract(waitForReadySince).TotalSeconds &gt; KickAfter) {
-                    ah.ComKick(TasSayEventArgs.Default, new string[] { notReady });
-                  }
+                  if (now.Subtract(waitForReadySince).TotalSeconds &gt; SpecAfkAfter) ah.ComForceSpectatorAfk(TasSayEventArgs.Default, new string[] {});
+                  if (now.Subtract(waitForReadySince).TotalSeconds &gt; KickAfter) ah.ComKick(TasSayEventArgs.Default, new string[] {notReady});
                 }
               } else {
-                if (b.IsLocked &amp;&amp; plrCnt &lt; from) {
-                  ah.ComAutoLock(TasSayEventArgs.Default, new string[] { to.ToString() });
-                } else if (plrCnt &gt; to) {
+                if (b.IsLocked &amp;&amp; plrCnt &lt; from) ah.ComAutoLock(TasSayEventArgs.Default, new string[] {to.ToString()});
+                else if (plrCnt &gt; to) {
                   string notready;
-                  if (!ah.AllReadyAndSynced(out notready)) ah.ComForceSpectator(TasSayEventArgs.Default, new string[] { notready });
-
+                  if (!ah.AllReadyAndSynced(out notready)) ah.ComForceSpectator(TasSayEventArgs.Default, new string[] {notready});
                 }
                 waitReady = false;
               }
@@ -113,7 +100,6 @@
           timer.Start();
         }
       }
-
     }
 
     public void Manage(int from, int to)
@@ -132,6 +118,5 @@
         timer.Stop();
       }
     }
-
   }
-}
+}
\ No newline at end of file

Modified: trunk/tools/springie/Springie/autohost/BanList.cs
===================================================================
--- trunk/tools/springie/Springie/autohost/BanList.cs	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/autohost/BanList.cs	2008-04-07 18:57:09 UTC (rev 5677)
@@ -1,22 +1,20 @@
 using System;
 using System.Collections.Generic;
-using System.Text;
-using Springie.Client;
-using System.Net;
-using System.Xml.Serialization;
 using System.IO;
+using System.Net;
 using System.Windows.Forms;
+using System.Xml.Serialization;
+using Springie.Client;
 
-namespace Springie.AutoHostNamespace
+namespace Springie.autohost
 {
-  class BanList
+  internal class BanList
   {
-    public List&lt;BannedUser&gt; Items = new List&lt;BannedUser&gt;();
-
     public const string BanlistFilename = &quot;banlist.xml&quot;;
 
-    private TasClient tas;
     private AutoHost ah;
+    public List&lt;BannedUser&gt; Items = new List&lt;BannedUser&gt;();
+    private TasClient tas;
 
     public BanList(AutoHost ah, TasClient tas)
     {
@@ -27,7 +25,7 @@
       tas.BattleUserJoined += new EventHandler&lt;TasEventArgs&gt;(tas_BattleUserJoined);
     }
 
-    void tas_BattleUserIpRecieved(object sender, TasEventArgs e)
+    private void tas_BattleUserIpRecieved(object sender, TasEventArgs e)
     {
       UpdateWithUserIp(e.ServerParams[0], IPAddress.Parse(e.ServerParams[1]));
       BannedUser b;
@@ -38,7 +36,6 @@
     }
 
 
-
     public bool GetByIp(string ip, out BannedUser b)
     {
       b = Items.Find(delegate(BannedUser u) { return u.ipAddresses.Contains(ip); });
@@ -55,7 +52,7 @@
     {
       b = Items.Find(delegate(BannedUser u) { return u.nickNames.Contains(name); });
       if (b != null) {
-        if (b.Expired) { 
+        if (b.Expired) {
           Items.Remove(b);
           b = null;
           return false;
@@ -90,7 +87,7 @@
     {
       Battle bat = tas.GetBattle();
       if (GetByName(name, out b)) return true;
-      if (bat!=null) {
+      if (bat != null) {
         UserBattleStatus ubs;
         if (bat.ContainsUser(name, out ubs)) {
           string ip = ubs.ip.ToString();
@@ -107,7 +104,7 @@
     }
 
 
-    void tas_BattleUserJoined(object sender, TasEventArgs e)
+    private void tas_BattleUserJoined(object sender, TasEventArgs e)
     {
       BannedUser b;
       string usname = e.ServerParams[0];
@@ -119,14 +116,13 @@
     }
 
 
-
     public void ComBan(TasSayEventArgs e, string[] words)
     {
       if (words.Length == 0) {
         ah.Respond(e, &quot;this command needs at least 1 argument - exact user name&quot;);
         return;
       }
-      
+
       int duration = 0;
       if (words.Length &gt; 1) {
         if (!int.TryParse(words[1], out duration)) {
@@ -142,7 +138,8 @@
 
       if (duration &lt; 0) duration = 0;
       TimeSpan dur;
-      if (duration == 0) dur = TimeSpan.FromDays(365 * 1000); else dur = TimeSpan.FromMinutes(duration);
+      if (duration == 0) dur = TimeSpan.FromDays(365*1000);
+      else dur = TimeSpan.FromMinutes(duration);
 
       BannedUser b = new BannedUser(words[0]);
       b.Duration = dur;
@@ -150,9 +147,7 @@
 
       Battle battle = tas.GetBattle();
       UserBattleStatus ubs;
-      if (battle.ContainsUser(b.Name, out ubs)) {
-        if (ubs.ip != IPAddress.None) b.ipAddresses.Add(ubs.ip.ToString());
-      }
+      if (battle.ContainsUser(b.Name, out ubs)) if (ubs.ip != IPAddress.None) b.ipAddresses.Add(ubs.ip.ToString());
       Items.Add(b);
       tas.Say(TasClient.SayPlace.Battle, &quot;&quot;, b.Name + &quot; banned - &quot; + b.Reason, true);
       tas.Kick(b.Name);
@@ -160,8 +155,9 @@
     }
 
 
-    public void ComUnban(TasSayEventArgs e, string[] words) {
-      if (words.Length ==0) {
+    public void ComUnban(TasSayEventArgs e, string[] words)
+    {
+      if (words.Length == 0) {
         ah.Respond(e, &quot;this command needs 1 argument - user name&quot;);
         return;
       }
@@ -170,25 +166,24 @@
         Items.Remove(b);
         ah.Respond(e, b.Name + &quot; removed from banlist&quot;);
         Save();
-      } else {
-        ah.Respond(e, &quot;no such user in banlist&quot;);
-      }
+      } else ah.Respond(e, &quot;no such user in banlist&quot;);
     }
 
 
-    public void ComListBans(TasSayEventArgs e, string[] words) 
+    public void ComListBans(TasSayEventArgs e, string[] words)
     {
       Items.RemoveAll(delegate(BannedUser b) { return b.Expired; });
       tas.Say(TasClient.SayPlace.User, e.UserName, &quot;---&quot;, false);
       foreach (BannedUser b in Items) {
-        string text=  String.Format(&quot;{0} --&gt; {1} (banned from:{2} to:{3} (GMT))&quot;,b.Name, b.Reason, b.Started.ToUniversalTime(), b.Started.Add(b.Duration).ToUniversalTime() );
+        string text = String.Format(&quot;{0} --&gt; {1} (banned from:{2} to:{3} (GMT))&quot;, b.Name, b.Reason, b.Started.ToUniversalTime(), b.Started.Add(b.Duration).ToUniversalTime());
         tas.Say(TasClient.SayPlace.User, e.UserName, text, false);
       }
       tas.Say(TasClient.SayPlace.User, e.UserName, &quot;---&quot;, false);
     }
 
 
-    public void Save() {
+    public void Save()
+    {
       Items.RemoveAll(delegate(BannedUser b) { return b.Expired; });
       Items.Sort(delegate(BannedUser a, BannedUser b) { return a.Name.CompareTo(b.Name); });
       XmlSerializer s = new XmlSerializer(Items.GetType());
@@ -198,17 +193,17 @@
       f.Close();
     }
 
-    public void Load() {
+    public void Load()
+    {
       if (File.Exists(Application.StartupPath + '/' + BanlistFilename)) {
         XmlSerializer s = new XmlSerializer(Items.GetType());
         StreamReader r = File.OpenText(Application.StartupPath + '/' + BanlistFilename);
-        Items= (List&lt;BannedUser&gt;)s.Deserialize(r);
+        Items = (List&lt;BannedUser&gt;)s.Deserialize(r);
         r.Close();
       }
     }
 
 
-
     /// &lt;summary&gt;
     /// Disconnects event handlers
     /// &lt;/summary&gt;
@@ -218,4 +213,4 @@
       tas.BattleUserIpRecieved -= tas_BattleUserIpRecieved;
     }
   }
-}
+}
\ No newline at end of file

Modified: trunk/tools/springie/Springie/autohost/BannedUser.cs
===================================================================
--- trunk/tools/springie/Springie/autohost/BannedUser.cs	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/autohost/BannedUser.cs	2008-04-07 18:57:09 UTC (rev 5677)
@@ -1,23 +1,35 @@
 using System;
 using System.Collections.Generic;
-using System.Text;
-using System.Net;
 using System.ComponentModel;
 using System.Xml.Serialization;
 
-namespace Springie.AutoHostNamespace
+namespace Springie.autohost
 {
   public class BannedUser
   {
-    string name;
+    private TimeSpan duration;
+    public List&lt;string&gt; ipAddresses = new List&lt;string&gt;();
+    private string name;
+    public List&lt;string&gt; nickNames = new List&lt;string&gt;();
+
+    private string reason;
+    private DateTime started;
+    public BannedUser() {}
+
+    public BannedUser(string name)
+    {
+      this.name = name;
+      started = DateTime.Now;
+      nickNames.Add(name);
+    }
+
     [Description(&quot;Original name&quot;)]
     public string Name
     {
       get { return name; }
-      set { name = value;}
+      set { name = value; }
     }
 
-    string reason;
     [Description(&quot;Reason of the ban&quot;)]
     public string Reason
     {
@@ -26,7 +38,6 @@
     }
 
 
-    TimeSpan duration;
     [Description(&quot;Ban duration&quot;)]
     [XmlIgnore]
     public TimeSpan Duration
@@ -43,7 +54,6 @@
     }
 
 
-    DateTime started;
     [Description(&quot;Ban start time&quot;)]
     public DateTime Started
     {
@@ -51,22 +61,10 @@
       set { started = value; }
     }
 
-    public BannedUser() { }
-
-    public BannedUser(string name)
-    {
-      this.name = name;
-      this.started = DateTime.Now;
-      this.nickNames.Add(name);
-    }
-
     [XmlIgnore]
     public bool Expired
     {
       get { return (Started + Duration &lt; DateTime.Now); }
     }
-
-    public List&lt;string&gt; ipAddresses = new List&lt;string&gt;();
-    public List&lt;string&gt; nickNames = new List&lt;string&gt;();
   }
-}
+}
\ No newline at end of file

Modified: trunk/tools/springie/Springie/autohost/CommandConfig.cs
===================================================================
--- trunk/tools/springie/Springie/autohost/CommandConfig.cs	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/autohost/CommandConfig.cs	2008-04-07 18:57:09 UTC (rev 5677)
@@ -1,84 +1,83 @@
 using System;
-using System.Collections.Generic;
-using System.Text;
 using System.ComponentModel;
-using Springie.Client;
 using System.Xml.Serialization;
+using Springie.Client;
 
-namespace Springie.AutoHostNamespace
+namespace Springie.autohost
 {
   public class CommandConfig
   {
+    private string helpText;
 
-    string name;
+    [XmlIgnore]
+    public DateTime lastCall = DateTime.Now;
 
-    [ReadOnly(true), Category(&quot;Command&quot;)]
+    private int level;
+
+
+    private TasSayEventArgs.Places[] listenTo = new TasSayEventArgs.Places[] {TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Normal};
+    private string name;
+    private int throttling = 0;
+
+
+    public CommandConfig() {}
+
+
+    public CommandConfig(string name, int level, string helpText, int throttling, TasSayEventArgs.Places[] listenTo) : this(name, level, helpText, throttling)
+    {
+      this.listenTo = listenTo;
+    }
+
+    public CommandConfig(string name, int level, string helpText, int throttling) : this(name, level, helpText)
+    {
+      this.throttling = throttling;
+    }
+
+    public CommandConfig(string name, int level, string helpText)
+    {
+      this.name = name;
+      this.level = level;
+      this.helpText = helpText;
+    }
+
+    [ReadOnly(true)]
+    [Category(&quot;Command&quot;)]
     public string Name
     {
       get { return name; }
       set { name = value; }
     }
 
-    int level;
-
-    [Category(&quot;Command&quot;), Description(&quot;Rights level. If user's rights level is higher or equal to rights level of command - user has rights to use this command.&quot;)]
+    [Category(&quot;Command&quot;)]
+    [Description(&quot;Rights level. If user's rights level is higher or equal to rights level of command - user has rights to use this command.&quot;)]
     public int Level
     {
       get { return level; }
       set { level = value; }
     }
-    string helpText;
 
-    [Category(&quot;Texts&quot;), Description(&quot;Help text to be displayed in !help listings.&quot;)]
+    [Category(&quot;Texts&quot;)]
+    [Description(&quot;Help text to be displayed in !help listings.&quot;)]
     public string HelpText
     {
       get { return helpText; }
       set { helpText = value; }
     }
 
-    int throttling = 0;
-
-    [Category(&quot;Command&quot;), Description(&quot;How often can this command be executed (in seconds). 0 = no throttling, can execute at any time.&quot;)]
+    [Category(&quot;Command&quot;)]
+    [Description(&quot;How often can this command be executed (in seconds). 0 = no throttling, can execute at any time.&quot;)]
     public int Throttling
     {
       get { return throttling; }
       set { throttling = value; }
     }
 
-    [XmlIgnore]
-    public DateTime lastCall = DateTime.Now;
-
-
-
-    TasSayEventArgs.Places[] listenTo = new TasSayEventArgs.Places[] { TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Normal };
-
-
-    [Category(&quot;Command&quot;), Description(&quot;From which places can you use this command. Normal = PM to server, Battle = battle lobby, Game = from running game.&quot;)]
+    [Category(&quot;Command&quot;)]
+    [Description(&quot;From which places can you use this command. Normal = PM to server, Battle = battle lobby, Game = from running game.&quot;)]
     public TasSayEventArgs.Places[] ListenTo
     {
       get { return listenTo; }
       set { listenTo = value; }
     }
-    public CommandConfig() { }
-
-
-    public CommandConfig(string name, int level, string helpText, int throttling, TasSayEventArgs.Places[] listenTo)
-      : this(name, level, helpText, throttling)
-    {
-      this.listenTo = listenTo;
-    }
-
-    public CommandConfig(string name, int level, string helpText, int throttling)
-      : this(name, level, helpText)
-    {
-      this.throttling = throttling;
-    }
-
-    public CommandConfig(string name, int level, string helpText)
-    {
-      this.name = name;
-      this.level = level;
-      this.helpText = helpText;
-    }
-  };
-}
+  } ;
+}
\ No newline at end of file

Modified: trunk/tools/springie/Springie/autohost/Ladder.cs
===================================================================
--- trunk/tools/springie/Springie/autohost/Ladder.cs	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/autohost/Ladder.cs	2008-04-07 18:57:09 UTC (rev 5677)
@@ -1,34 +1,19 @@
-&#65279;using System;
-using System.Collections.Generic;
-using System.Text;
+&#65279;using System.Collections.Generic;
 using System.Net;
 using Springie.Client;
 
-namespace Springie.AutoHostNamespace
+namespace Springie.autohost
 {
   public class Ladder
   {
-    const string ladderUrl = &quot;<A HREF="http://spring-league.com/ladder/lobby/">http://spring-league.com/ladder/lobby/</A>&quot;;
+    private const string ladderUrl = &quot;<A HREF="http://blendax.informatik.uni-bremen.de/jan/spring/ladder/lobby/">http://blendax.informatik.uni-bremen.de/jan/spring/ladder/lobby/</A>&quot;;
+    private int ladderId;
 
-    List&lt;string&gt; maps = new List&lt;string&gt;();
-    public List&lt;string&gt; Maps
-    {
-      get { return maps; }
-    }
+    private List&lt;string&gt; maps = new List&lt;string&gt;();
 
-    string[] rules;
+    private string[] rules;
 
-    int ladderId;
 
-    public int Id
-    {
-      get
-      {
-        return ladderId;
-      }
-    }
-
-
     public Ladder(int id)
     {
       ladderId = id;
@@ -36,16 +21,25 @@
       LoadRules();
     }
 
+    public List&lt;string&gt; Maps
+    {
+      get { return maps; }
+    }
+
+    public int Id
+    {
+      get { return ladderId; }
+    }
+
     private void LoadMapList()
     {
       WebClient wc = new WebClient();
       try {
         string lines = wc.DownloadString(ladderUrl + &quot;maplist.php?ladder=&quot; + ladderId);
         maps.Clear();
-        foreach (string line in lines.Split('\n')) {
-          maps.Add(line.ToLower());
-        }
-      } catch { };
+        foreach (string line in lines.Split('\n')) maps.Add(line.ToLower());
+      } catch {}
+      ;
     }
 
 
@@ -53,9 +47,11 @@
     {
       try {
         WebClient wc = new WebClient();
+        wc.UseDefaultCredentials = true;
         string lines = wc.DownloadString(ladderUrl + &quot;rules.php?ladder=&quot; + ladderId);
         rules = lines.Split('\n');
-      } catch { };
+      } catch {}
+      ;
     }
 
 
@@ -71,24 +67,14 @@
         string[] args = line.Split(' ');
         string key = args[0];
         string val = Utils.Glue(args, 1);
-        
+
         if (key == &quot;min_players_per_allyteam&quot;) minTeamPlayers = int.Parse(val);
         if (key == &quot;max_players_per_allyteam&quot;) maxTeamPlayers = int.Parse(val);
-        if (key == &quot;startpos&quot;) {
-          if (val != &quot;any&quot;) battleDetails.StartPos = (BattleStartPos)int.Parse(val);
-        }
-        if (key == &quot;gamemode&quot;) {
-          if (val != &quot;any&quot;) battleDetails.EndCondition = (BattleEndCondition)int.Parse(val);
-        }
-        if (key == &quot;dgun&quot;) {
-          if (val != &quot;any&quot;) battleDetails.LimitDgun = int.Parse(val);
-        }
-        if (key == &quot;ghost&quot;) {
-          if (val != &quot;any&quot;) battleDetails.GhostedBuildings = int.Parse(val);
-        }
-        if (key == &quot;diminish&quot;) {
-          if (val != &quot;any&quot;) battleDetails.DiminishingMM = int.Parse(val);
-        }
+        if (key == &quot;startpos&quot;) if (val != &quot;any&quot;) battleDetails.StartPos = (BattleStartPos)int.Parse(val);
+        if (key == &quot;gamemode&quot;) if (val != &quot;any&quot;) battleDetails.EndCondition = (BattleEndCondition)int.Parse(val);
+        if (key == &quot;dgun&quot;) if (val != &quot;any&quot;) battleDetails.LimitDgun = int.Parse(val);
+        if (key == &quot;ghost&quot;) if (val != &quot;any&quot;) battleDetails.GhostedBuildings = int.Parse(val);
+        if (key == &quot;diminish&quot;) if (val != &quot;any&quot;) battleDetails.DiminishingMM = int.Parse(val);
         if (key == &quot;metal&quot;) {
           if (val != &quot;any&quot;) {
             int min = int.Parse(args[1]);
@@ -133,7 +119,5 @@
         }
       } catch { };
     }*/
-
-
   }
-}
+}
\ No newline at end of file

Modified: trunk/tools/springie/Springie/autohost/Polls.cs
===================================================================
--- trunk/tools/springie/Springie/autohost/Polls.cs	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/autohost/Polls.cs	2008-04-07 18:57:09 UTC (rev 5677)
@@ -1,10 +1,8 @@
-using System;
 using System.Collections.Generic;
-using System.Text;
 using Springie.Client;
 using Springie.SpringNamespace;
 
-namespace Springie.AutoHostNamespace
+namespace Springie.autohost
 {
   public interface IVotable
   {
@@ -13,23 +11,21 @@
     bool Vote(TasSayEventArgs e, string[] words);
   }
 
-
-  abstract public class AbstractPoll
+  public abstract class AbstractPoll
   {
-    protected TasClient tas;
-    protected Spring spring;
+    protected const double ratio = 0.5;
     protected AutoHost ah;
     protected int initialUserCount = 0;
     protected int lastVote = -1; // last registered vote value
+    protected int options = 2;
+    protected Spring spring;
+    protected TasClient tas;
 
     protected List&lt;string&gt; users = new List&lt;string&gt;();
     protected List&lt;int&gt; votes = new List&lt;int&gt;();
 
-    protected int options = 2;
-    protected const double ratio = 0.5;
+    public AbstractPoll() {}
 
-    public AbstractPoll() { }
-
     public AbstractPoll(TasClient tas, Spring spring, AutoHost ah)
     {
       this.tas = tas;
@@ -57,13 +53,11 @@
     protected bool CheckEnd(out int winVote)
     {
       int[] sums = new int[options];
-      foreach (int val in votes) {
-        if (val &gt; 0 &amp;&amp; val &lt;= options) sums[val - 1]++;
-      }
+      foreach (int val in votes) if (val &gt; 0 &amp;&amp; val &lt;= options) sums[val - 1]++;
 
       int votesLeft = votes.FindAll(delegate(int t) { return (t == 0); }).Count;
       bool canDecide = false;
-      int winLimit = (int)(initialUserCount * ratio);
+      int winLimit = (int)(initialUserCount*ratio);
 
       for (int i = 0; i &lt; sums.Length; ++i) {
         string text = string.Format(&quot;option {0} has {1} of {2} votes&quot;, i + 1, sums[i], winLimit + 1);
@@ -77,7 +71,8 @@
         if (sums[i] + votesLeft &gt; winLimit) canDecide = true;
       }
       winVote = 0;
-      if (!canDecide) return true; else return false;
+      if (!canDecide) return true;
+      else return false;
     }
 
     protected bool RegisterVote(TasSayEventArgs e, string[] words, out int vote)
@@ -85,7 +80,8 @@
       vote = 0;
       if (words.Length != 1) return false;
       int.TryParse(words[0], out vote);
-      if (vote &gt; 0 &amp;&amp; vote &lt;= options) { // vote within parameters, lets register it
+      if (vote &gt; 0 &amp;&amp; vote &lt;= options) {
+        // vote within parameters, lets register it
         lastVote = vote;
 
         int ind = users.IndexOf(e.UserName);
@@ -96,26 +92,21 @@
           if (ind == -1) {
             votes.Add(vote);
             users.Add(e.UserName);
-          } else {
-            votes[ind] = vote;
-          }
+          } else votes[ind] = vote;
           return true;
         }
       }
       return false;
     }
-  };
+  } ;
 
-
-  /************************************************************************/
-  /*      VOTE MAP                                                        */
-  /************************************************************************/
   public class VoteMap : AbstractPoll, IVotable
   {
-    string map;
+    private string map;
 
-    public VoteMap(TasClient tas, Spring spring, AutoHost ah) : base(tas, spring, ah) { }
+    public VoteMap(TasClient tas, Spring spring, AutoHost ah) : base(tas, spring, ah) {}
 
+    #region IVotable Members
     bool IVotable.Init(TasSayEventArgs e, string[] words)
     {
       if (words.Length == 0) {
@@ -148,25 +139,21 @@
         if (winVote == 1) {
           ah.SayBattle(&quot;vote successful - changing map to &quot; + map);
           tas.ChangeMap(spring.UnitSync.MapList[map]);
-        } else {
-          ah.SayBattle(&quot;not enough votes, map stays&quot;);
-        }
+        } else ah.SayBattle(&quot;not enough votes, map stays&quot;);
         return true;
       } else return false;
     }
+    #endregion
   }
 
-  /************************************************************************/
-  /*    VOTE KICK                                                         */
-  /************************************************************************/
   public class VoteKick : AbstractPoll, IVotable
   {
-    string player;
+    private new const double ratio = 0.66;
+    private string player;
 
-    new const double ratio = 0.66;
+    public VoteKick(TasClient tas, Spring spring, AutoHost ah) : base(tas, spring, ah) {}
 
-    public VoteKick(TasClient tas, Spring spring, AutoHost ah) : base(tas, spring, ah) { }
-
+    #region IVotable Members
     public bool Init(TasSayEventArgs e, string[] words)
     {
       if (words.Length == 0) {
@@ -198,24 +185,21 @@
       if (CheckEnd(out winVote)) {
         if (winVote == 1) {
           ah.SayBattle(&quot;vote successful - kicking &quot; + player);
-          ah.ComKick(TasSayEventArgs.Default, new string[] { player });
-        } else {
-          ah.SayBattle(&quot;not enough votes, player stays&quot;);
-        }
+          ah.ComKick(TasSayEventArgs.Default, new string[] {player});
+        } else ah.SayBattle(&quot;not enough votes, player stays&quot;);
         return true;
       } else return false;
     }
+    #endregion
   }
 
-  /************************************************************************/
-  /*      VOTE FORCE                                                      */
-  /************************************************************************/
   public class VoteForce : AbstractPoll, IVotable
   {
-    new const double ratio = 0.50;
+    private new const double ratio = 0.50;
 
-    public VoteForce(TasClient tas, Spring spring, AutoHost ah) : base(tas, spring, ah) { }
+    public VoteForce(TasClient tas, Spring spring, AutoHost ah) : base(tas, spring, ah) {}
 
+    #region IVotable Members
     public bool Init(TasSayEventArgs e, string[] words)
     {
       if (spring.IsRunning) {
@@ -241,24 +225,20 @@
         if (winVote == 1) {
           ah.ComForce(e, words);
           ah.SayBattle(&quot;vote successful - forcing&quot;);
-        } else {
-          ah.SayBattle(&quot;not enough votes&quot;);
-        }
+        } else ah.SayBattle(&quot;not enough votes&quot;);
         return true;
       } else return false;
     }
+    #endregion
   }
 
-
-  /************************************************************************/
-  /*    VOTE FORCE START                                                  */
-  /************************************************************************/
   public class VoteForceStart : AbstractPoll, IVotable
   {
-    new const double ratio = 0.50;
+    private new const double ratio = 0.50;
 
-    public VoteForceStart(TasClient tas, Spring spring, AutoHost ah) : base(tas, spring, ah) { }
+    public VoteForceStart(TasClient tas, Spring spring, AutoHost ah) : base(tas, spring, ah) {}
 
+    #region IVotable Members
     public bool Init(TasSayEventArgs e, string[] words)
     {
       if (!spring.IsRunning) {
@@ -284,24 +264,20 @@
         if (winVote == 1) {
           ah.SayBattle(&quot;vote successful - force starting&quot;);
           ah.ComForceStart(e, words);
-        } else {
-          ah.SayBattle(&quot;not enough votes&quot;);
-        }
+        } else ah.SayBattle(&quot;not enough votes&quot;);
         return true;
       } else return false;
     }
+    #endregion
   }
 
-
-  /************************************************************************/
-  /*     VOTE EXIT                                                        */
-  /************************************************************************/
   public class VoteExit : AbstractPoll, IVotable
   {
-    new const double ratio = 0.66;
+    private new const double ratio = 0.66;
 
-    public VoteExit(TasClient tas, Spring spring, AutoHost ah) : base(tas, spring, ah) { }
+    public VoteExit(TasClient tas, Spring spring, AutoHost ah) : base(tas, spring, ah) {}
 
+    #region IVotable Members
     public bool Init(TasSayEventArgs e, string[] words)
     {
       if (spring.IsRunning) {
@@ -326,26 +302,21 @@
         if (winVote == 1) {
           ah.SayBattle(&quot;vote successful - force exiting&quot;);
           ah.ComExit(e, words);
-        } else {
-          ah.SayBattle(&quot;not enough votes&quot;);
-        }
+        } else ah.SayBattle(&quot;not enough votes&quot;);
         return true;
       } else return false;
     }
+    #endregion
   }
 
-
-
-  /************************************************************************/
-  /*    VOTE REHOST                                                       */
-  /************************************************************************/
   public class VoteRehost : AbstractPoll, IVotable
   {
-    new const double ratio = 0.66;
-    string modname = &quot;&quot;;
+    private new const double ratio = 0.66;
+    private string modname = &quot;&quot;;
 
-    public VoteRehost(TasClient tas, Spring spring, AutoHost ah) : base(tas, spring, ah) { }
+    public VoteRehost(TasClient tas, Spring spring, AutoHost ah) : base(tas, spring, ah) {}
 
+    #region IVotable Members
     public bool Init(TasSayEventArgs e, string[] words)
     {
       if (words.Length == 0) {
@@ -378,26 +349,22 @@
         if (winVote == 1) {
           ah.SayBattle(&quot;vote successful - rehosting&quot;);
 
-          ah.ComRehost(e, new string[] { modname });
-        } else {
-          ah.SayBattle(&quot;not enough votes&quot;);
-        }
+          ah.ComRehost(e, new string[] {modname});
+        } else ah.SayBattle(&quot;not enough votes&quot;);
         return true;
       } else return false;
     }
+    #endregion
   }
 
-
-  /************************************************************************/
-  /*     VOTE PRESET                                                      */
-  /************************************************************************/
   public class VotePreset : AbstractPoll, IVotable
   {
-    int presetId;
-    string presetName;
+    private int presetId;
+    private string presetName;
 
-    public VotePreset(TasClient tas, Spring spring, AutoHost ah) : base(tas, spring, ah) { }
+    public VotePreset(TasClient tas, Spring spring, AutoHost ah) : base(tas, spring, ah) {}
 
+    #region IVotable Members
     public bool Init(TasSayEventArgs e, string[] words)
     {
       if (words.Length == 0) {
@@ -432,24 +399,19 @@
         if (winVote == 1) {
           ah.SayBattle(&quot;vote successful - appling preset &quot; + presetName);
           ah.presets[presetId].Apply(tas, ah.ladder);
-        } else {
-          ah.SayBattle(&quot;not enough votes for preset&quot;);
-        }
+        } else ah.SayBattle(&quot;not enough votes for preset&quot;);
         return true;
       } else return false;
     }
+    #endregion
   }
 
-
-  /************************************************************************/
-  /*     VOTE KICKSPEC                                                    */
-  /************************************************************************/
   public class VoteKickSpec : AbstractPoll, IVotable
   {
-    public VoteKickSpec(TasClient tas, Spring spring, AutoHost ah) : base(tas, spring, ah) { }
+    private bool stateAfter = false;
+    public VoteKickSpec(TasClient tas, Spring spring, AutoHost ah) : base(tas, spring, ah) {}
 
-    bool stateAfter = false;
-
+    #region IVotable Members
     public bool Init(TasSayEventArgs e, string[] words)
     {
       stateAfter = !ah.KickSpectators;
@@ -469,27 +431,23 @@
       if (CheckEnd(out winVote)) {
         if (winVote == 1) {
           ah.SayBattle(&quot;vote successful&quot;);
-          ah.ComKickSpec(e, new string[] { stateAfter ? &quot;1&quot; : &quot;0&quot; });
-        } else {
-          ah.SayBattle(&quot;not enough votes to &quot; + (stateAfter ? &quot;ENABLE&quot; : &quot;DISABLE&quot;) + &quot; kickspec&quot;);
-        }
+          ah.ComKickSpec(e, new string[] {stateAfter ? &quot;1&quot; : &quot;0&quot;});
+        } else ah.SayBattle(&quot;not enough votes to &quot; + (stateAfter ? &quot;ENABLE&quot; : &quot;DISABLE&quot;) + &quot; kickspec&quot;);
         return true;
       } else return false;
     }
+    #endregion
   }
 
-
-  /************************************************************************/
-  /*    VOTE BOSS                                                    */
-  /************************************************************************/
   public class VoteBoss : AbstractPoll, IVotable
   {
-    string player;
+    private string player;
 
     //new const double ratio = 0.50;
 
-    public VoteBoss(TasClient tas, Spring spring, AutoHost ah) : base(tas, spring, ah) { }
+    public VoteBoss(TasClient tas, Spring spring, AutoHost ah) : base(tas, spring, ah) {}
 
+    #region IVotable Members
     public bool Init(TasSayEventArgs e, string[] words)
     {
       if (words.Length == 0) {
@@ -526,35 +484,31 @@
       int winVote;
       if (CheckEnd(out winVote)) {
         if (winVote == 1) {
-          if (player == &quot;&quot;) ah.SayBattle(&quot;vote successful - boss removed&quot;); else
-            ah.SayBattle(&quot;vote successful - new boss is &quot; + player);
+          if (player == &quot;&quot;) ah.SayBattle(&quot;vote successful - boss removed&quot;);
+          else ah.SayBattle(&quot;vote successful - new boss is &quot; + player);
           ah.BossName = player;
-        } else {
-          ah.SayBattle(&quot;not enough votes&quot;);
-        }
+        } else ah.SayBattle(&quot;not enough votes&quot;);
         return true;
       } else return false;
     }
+    #endregion
   }
 
-
-  /************************************************************************/
-  /*     VOTE SETOPTIONS                                                  */
-  /************************************************************************/
   public class VoteSetOptions : AbstractPoll, IVotable
   {
-    string scriptTagsFormat;
-    string wordFormat;
+    private string scriptTagsFormat;
+    private string wordFormat;
 
-    public VoteSetOptions(TasClient tas, Spring spring, AutoHost ah) : base(tas, spring, ah) { }
+    public VoteSetOptions(TasClient tas, Spring spring, AutoHost ah) : base(tas, spring, ah) {}
 
+    #region IVotable Members
     public bool Init(TasSayEventArgs e, string[] words)
     {
       wordFormat = Utils.Glue(words);
       scriptTagsFormat = ah.GetOptionsString(e, words);
       if (scriptTagsFormat == &quot;&quot;) return false;
       else {
-        ah.SayBattle(&quot;Do you want to apply options &quot; +wordFormat+ &quot;? !vote 1 = yes, !vote 2 = no&quot;);
+        ah.SayBattle(&quot;Do you want to apply options &quot; + wordFormat + &quot;? !vote 1 = yes, !vote 2 = no&quot;);
         return true;
       }
     }
@@ -573,13 +527,10 @@
         if (winVote == 1) {
           ah.SayBattle(&quot;vote successful - appling options &quot; + wordFormat);
           tas.SetScriptTag(scriptTagsFormat);
-        } else {
-          ah.SayBattle(&quot;not enough votes for setoptions&quot;);
-        }
+        } else ah.SayBattle(&quot;not enough votes for setoptions&quot;);
         return true;
       } else return false;
     }
+    #endregion
   }
-
-}
-
+}
\ No newline at end of file

Modified: trunk/tools/springie/Springie/autohost/Preset.cs
===================================================================
--- trunk/tools/springie/Springie/autohost/Preset.cs	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/autohost/Preset.cs	2008-04-07 18:57:09 UTC (rev 5677)
@@ -1,16 +1,27 @@
-using System;
-using System.Collections.Generic;
-using System.Text;
 using System.ComponentModel;
 using Springie.Client;
 using Springie.SpringNamespace;
 
-namespace Springie.AutoHostNamespace
+namespace Springie.autohost
 {
   public class Preset
   {
-    string name = &quot;&lt;enter name here&gt;&quot;;
-    [Category(&quot;Basic&quot;), Description(&quot;Name of this preset&quot;)]
+    private string description;
+    private int? diminishingMM;
+    private UnitInfo[] disabledUnits = new UnitInfo[0];
+    private bool enableAllUnits = false;
+    private BattleEndCondition? endCondition;
+    private int? ghostedBuildings;
+    private int? limitDgun;
+    private int? maxUnits;
+    private string name = &quot;&lt;enter name here&gt;&quot;;
+    private string[] perform = new string[0];
+    private int? startingEnergy;
+    private int? startingMetal;
+    private BattleStartPos? startPos;
+
+    [Category(&quot;Basic&quot;)]
+    [Description(&quot;Name of this preset&quot;)]
     public string Name
     {
       set { name = value; }
@@ -18,40 +29,40 @@
     }
 
 
-    string description;
-    [Category(&quot;Basic&quot;), Description(&quot;Brief description of this preset&quot;)]
+    [Category(&quot;Basic&quot;)]
+    [Description(&quot;Brief description of this preset&quot;)]
     public string Description
     {
       get { return description; }
       set { description = value; }
     }
 
-    string[] perform = new string[0];
-    [Category(&quot;Basic&quot;), Description(&quot;List of additional commands to be performed&quot;)]
+    [Category(&quot;Basic&quot;)]
+    [Description(&quot;List of additional commands to be performed&quot;)]
     public string[] Perform
     {
       set { perform = value; }
       get { return perform; }
     }
 
-    int? startingMetal;
-    [Category(&quot;Resources&quot;), Description(&quot;Starting metal&quot;)]
+    [Category(&quot;Resources&quot;)]
+    [Description(&quot;Starting metal&quot;)]
     public int? StartingMetal
     {
       get { return startingMetal; }
       set { startingMetal = value; }
     }
 
-    int? startingEnergy;
-    [Category(&quot;Resources&quot;), Description(&quot;Starting energy&quot;)]
+    [Category(&quot;Resources&quot;)]
+    [Description(&quot;Starting energy&quot;)]
     public int? StartingEnergy
     {
       get { return startingEnergy; }
       set { startingEnergy = value; }
     }
 
-    int? maxUnits;
-    [Category(&quot;Resources&quot;), Description(&quot;Maximum units&quot;)]
+    [Category(&quot;Resources&quot;)]
+    [Description(&quot;Maximum units&quot;)]
     public int? MaxUnits
     {
       get { return maxUnits; }
@@ -59,16 +70,16 @@
     }
 
 
-    BattleStartPos? startPos;
-    [Category(&quot;Game rules&quot;), Description(&quot;Starting position&quot;)]
+    [Category(&quot;Game rules&quot;)]
+    [Description(&quot;Starting position&quot;)]
     public BattleStartPos? StartPos
     {
       get { return startPos; }
       set { startPos = value; }
     }
 
-    BattleEndCondition? endCondition;
-    [Category(&quot;Game rules&quot;), Description(&quot;End condition - should continue when comm dies&quot;)]
+    [Category(&quot;Game rules&quot;)]
+    [Description(&quot;End condition - should continue when comm dies&quot;)]
     public BattleEndCondition? EndCondition
     {
       get { return endCondition; }
@@ -76,24 +87,24 @@
     }
 
 
-    int? limitDgun;
-    [Category(&quot;Game rules&quot;), Description(&quot;Limit dgun to start position, 0 = no limit, 1 = limited&quot;)]
+    [Category(&quot;Game rules&quot;)]
+    [Description(&quot;Limit dgun to start position, 0 = no limit, 1 = limited&quot;)]
     public int? LimitDgun
     {
       get { return limitDgun; }
       set { limitDgun = value; }
     }
 
-    int? diminishingMM;
-    [Category(&quot;Game rules&quot;), Description(&quot;Diminishing metal maker outputs, 0 = normal mm, 1 = diminishing mm&quot;)]
+    [Category(&quot;Game rules&quot;)]
+    [Description(&quot;Diminishing metal maker outputs, 0 = normal mm, 1 = diminishing mm&quot;)]
     public int? DiminishingMM
     {
       get { return diminishingMM; }
       set { diminishingMM = value; }
     }
 
-    int? ghostedBuildings;
-    [Category(&quot;Game rules&quot;), Description(&quot;Ghosted buildings, 0 = no ghosted buildings, 1 = ghosted buildings&quot;)]
+    [Category(&quot;Game rules&quot;)]
+    [Description(&quot;Ghosted buildings, 0 = no ghosted buildings, 1 = ghosted buildings&quot;)]
     public int? GhostedBuildings
     {
       get { return ghostedBuildings; }
@@ -101,16 +112,16 @@
     }
 
 
-    bool enableAllUnits = false;
-    [Category(&quot;Units&quot;), Description(&quot;Should this preset enable all units before disabling&quot;)]
+    [Category(&quot;Units&quot;)]
+    [Description(&quot;Should this preset enable all units before disabling&quot;)]
     public bool EnableAllUnits
     {
       get { return enableAllUnits; }
       set { enableAllUnits = value; }
     }
 
-    private UnitInfo[] disabledUnits = new UnitInfo[0];
-    [Category(&quot;Units&quot;), Description(&quot;Units to disable&quot;)]
+    [Category(&quot;Units&quot;)]
+    [Description(&quot;Units to disable&quot;)]
     public UnitInfo[] DisabledUnits
     {
       get { return disabledUnits; }
@@ -138,13 +149,9 @@
       tas.UpdateBattleDetails(d);
 
       if (enableAllUnits) tas.EnableAllUnits();
-      if (disabledUnits.Length &gt; 0) {
-        tas.DisableUnits(UnitInfo.ToStringList(disabledUnits));
-      }
+      if (disabledUnits.Length &gt; 0) tas.DisableUnits(UnitInfo.ToStringList(disabledUnits));
 
-      foreach (string s in perform) {
-        tas.Say(TasClient.SayPlace.Battle, &quot;&quot;, s, false);
-      }
+      foreach (string s in perform) tas.Say(TasClient.SayPlace.Battle, &quot;&quot;, s, false);
     }
 
     public override string ToString()
@@ -165,6 +172,5 @@
       if (ret == &quot;&quot;) ret = &quot;no changes&quot;;
       return ret;
     }
-
   }
-}
+}
\ No newline at end of file

Modified: trunk/tools/springie/Springie/autohost/PrivilegedUser.cs
===================================================================
--- trunk/tools/springie/Springie/autohost/PrivilegedUser.cs	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/autohost/PrivilegedUser.cs	2008-04-07 18:57:09 UTC (rev 5677)
@@ -1,34 +1,34 @@
-using System;
-using System.Collections.Generic;
-using System.Text;
 using System.ComponentModel;
 
-namespace Springie.AutoHostNamespace
+namespace Springie.autohost
 {
   public class PrivilegedUser
   {
-    string name;
-    [Category(&quot;User&quot;), Description(&quot;Nickname used in spring lobby&quot;)]
+    private int level;
+    private string name;
+
+    public PrivilegedUser() {}
+
+    public PrivilegedUser(string name, int level)
+    {
+      this.name = name;
+      this.level = level;
+    }
+
+    [Category(&quot;User&quot;)]
+    [Description(&quot;Nickname used in spring lobby&quot;)]
     public string Name
     {
       get { return name; }
       set { name = value; }
     }
-    int level;
 
-    [Category(&quot;User&quot;), Description(&quot;Rights level. If rights level is higher or equal to rights level of command - user has rights to use that command.&quot;)]
+    [Category(&quot;User&quot;)]
+    [Description(&quot;Rights level. If rights level is higher or equal to rights level of command - user has rights to use that command.&quot;)]
     public int Level
     {
       get { return level; }
       set { level = value; }
     }
-    public PrivilegedUser()
-    {
-    }
-    public PrivilegedUser(string name, int level)
-    {
-      this.name = name;
-      this.level = level;
-    }
-  };
-}
+  } ;
+}
\ No newline at end of file

Modified: trunk/tools/springie/Springie/client/Battle.cs
===================================================================
--- trunk/tools/springie/Springie/client/Battle.cs	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/client/Battle.cs	2008-04-07 18:57:09 UTC (rev 5677)
@@ -1,48 +1,74 @@
 using System;
 using System.Collections.Generic;
-using System.Text;
 using Springie.SpringNamespace;
 
 namespace Springie.Client
 {
   public class Battle : ICloneable
   {
-    public enum NatMode : int { None = 0, HolePunching = 1, FixedPorts = 2 };
+    #region NatMode enum
+    public enum NatMode : int
+    {
+      None = 0,
+      HolePunching = 1,
+      FixedPorts = 2
+    } ;
+    #endregion
 
     public BattleDetails Details = new BattleDetails();
+    public List&lt;string&gt; DisabledUnits = new List&lt;string&gt;();
+    public int HostPort;
+    public bool IsLocked = false;
+    public MapInfo Map;
+    public int MaxPlayers;
     public ModInfo Mod;
+    public Dictionary&lt;string, string&gt; ModOptions = new Dictionary&lt;string, string&gt;();
+    public NatMode Nat = NatMode.None;
     public string Password = &quot;*&quot;;
-    public int MaxPlayers;
     public int Rank;
-    public MapInfo Map;
+    public Dictionary&lt;int, BattleRect&gt; Rectangles = new Dictionary&lt;int, BattleRect&gt;();
     public string Title;
-    public int HostPort;
-    public NatMode Nat = NatMode.None;
-    public bool IsLocked = false;
 
     public List&lt;UserBattleStatus&gt; Users = new List&lt;UserBattleStatus&gt;();
-    public Dictionary&lt;string, string&gt; ModOptions = new Dictionary&lt;string, string&gt;();
 
+    public Battle(string password, int port, int maxplayers, int rank, MapInfo map, string title, ModInfo mod, BattleDetails details)
+    {
+      if (!String.IsNullOrEmpty(password)) Password = password;
+      else Password = &quot;*&quot;;
+      if (port == 0) HostPort = 8452;
+      else HostPort = port;
+      MaxPlayers = maxplayers;
+      Rank = rank;
+      Map = map;
+      Title = title;
+      Mod = mod;
+      if (details != null) Details = details;
+      else details = new BattleDetails();
+      details.Validate();
+    }
 
+    #region ICloneable Members
+    public object Clone()
+    {
+      Battle b = (Battle)MemberwiseClone();
+      if (Details != null) b.Details = (BattleDetails)Details.Clone();
+      if (Users != null) b.Users = new List&lt;UserBattleStatus&gt;(Users);
+      if (Rectangles != null) b.Rectangles = new Dictionary&lt;int, BattleRect&gt;(Rectangles);
 
-    public Dictionary&lt;int, BattleRect&gt; Rectangles = new Dictionary&lt;int, BattleRect&gt;();
+      if (DisabledUnits != null) b.DisabledUnits = new List&lt;string&gt;(DisabledUnits);
+      return b;
+    }
+    #endregion
 
-    public List&lt;string&gt; DisabledUnits = new List&lt;string&gt;();
-
-
     public int GetFirstEmptyRectangle()
     {
-      for (int i = 0; i &lt; Spring.MaxAllies; ++i) {
-        if (!Rectangles.ContainsKey(i)) return i;
-      }
+      for (int i = 0; i &lt; Spring.MaxAllies; ++i) if (!Rectangles.ContainsKey(i)) return i;
       return -1;
     }
 
     public bool ContainsUser(string name)
     {
-      foreach (UserBattleStatus u in Users) {
-        if (u.name == name) return true;
-      }
+      foreach (UserBattleStatus u in Users) if (u.name == name) return true;
       return false;
     }
 
@@ -65,23 +91,16 @@
     }
 
 
-
     public int GetUserIndex(string name)
     {
-      for (int i = 0; i &lt; Users.Count; ++i) {
-        if (Users[i].name == name) {
-          return i;
-        }
-      }
+      for (int i = 0; i &lt; Users.Count; ++i) if (Users[i].name == name) return i;
       return -1;
     }
 
     public int CountSpectators()
     {
       int speccount = 0;
-      foreach (UserBattleStatus u in Users) {
-        if (u.IsSpectator) speccount++;
-      }
+      foreach (UserBattleStatus u in Users) if (u.IsSpectator) speccount++;
       return speccount;
     }
 
@@ -89,49 +108,13 @@
     /// count players - non spectators
     /// &lt;/summary&gt;
     /// &lt;returns&gt;returns number of players that will play the game&lt;/returns&gt;
-    public int CountPlayers() 
+    public int CountPlayers()
     {
       int speccount = 0;
-      foreach (UserBattleStatus u in Users) {
-        if (!u.IsSpectator) speccount++;
-      }
+      foreach (UserBattleStatus u in Users) if (!u.IsSpectator) speccount++;
       return speccount;
     }
 
-
-    public Battle(string password, int port, int maxplayers, int rank, MapInfo map, string title, ModInfo mod, BattleDetails details)
-    {
-      if (!String.IsNullOrEmpty(password)) this.Password = password; else this.Password = &quot;*&quot;;
-      if (port == 0) this.HostPort = 8452; else this.HostPort = port;
-      this.MaxPlayers = maxplayers;
-      this.Rank = rank;
-      this.Map = map;
-      this.Title = title;
-      this.Mod = mod;
-      if (details != null) this.Details = details; else details = new BattleDetails();
-      details.Validate();
-    }
-
-
-
-    public struct GrPlayer
-    {
-      public UserBattleStatus user;
-      public GrPlayer(UserBattleStatus ubs) { user = ubs; }
-    };
-
-    public struct GrTeam
-    {
-      public int leader;
-      public GrTeam(int leader) { this.leader = leader; }
-    };
-
-    public struct GrAlly
-    {
-      public BattleRect rect;
-      public GrAlly(BattleRect r) { rect = r; }
-    };
-
     /// &lt;summary&gt;
     /// Groups tam and ally numbers, so that they both start from 0
     /// &lt;/summary&gt;
@@ -154,7 +137,6 @@
           }
           u.TeamNumber = teamNums[u.TeamNumber];
 
-
           if (!allyNums.ContainsKey(u.AllyNumber)) {
             allyNums.Add(u.AllyNumber, alliances.Count); // add transformation of ally
             alliances.Add(new GrAlly());
@@ -165,24 +147,43 @@
       }
 
       // now assign rectangles and skip unused
-      foreach (KeyValuePair&lt;int, BattleRect&gt; r in Rectangles) {
-        if (allyNums.ContainsKey(r.Key)) {
-          alliances[allyNums[r.Key]] = new GrAlly(r.Value);
-        }
-      }
+      foreach (KeyValuePair&lt;int, BattleRect&gt; r in Rectangles) if (allyNums.ContainsKey(r.Key)) alliances[allyNums[r.Key]] = new GrAlly(r.Value);
     }
 
-    #region ICloneable Members
-    public object Clone()
+    #region Nested type: GrAlly
+    public struct GrAlly
     {
-      Battle b = (Battle)this.MemberwiseClone();
-      if (this.Details != null) b.Details = (BattleDetails)this.Details.Clone();
-      if (this.Users != null) b.Users = new List&lt;UserBattleStatus&gt;(Users);
-      if (this.Rectangles != null) b.Rectangles = new Dictionary&lt;int, BattleRect&gt;(Rectangles);
+      public BattleRect rect;
 
-      if (this.DisabledUnits != null) b.DisabledUnits = new List&lt;string&gt;(DisabledUnits);
-      return b;
-    }
+      public GrAlly(BattleRect r)
+      {
+        rect = r;
+      }
+    } ;
     #endregion
-  };
-}
+
+    #region Nested type: GrPlayer
+    public struct GrPlayer
+    {
+      public UserBattleStatus user;
+
+      public GrPlayer(UserBattleStatus ubs)
+      {
+        user = ubs;
+      }
+    } ;
+    #endregion
+
+    #region Nested type: GrTeam
+    public struct GrTeam
+    {
+      public int leader;
+
+      public GrTeam(int leader)
+      {
+        this.leader = leader;
+      }
+    } ;
+    #endregion
+  } ;
+}
\ No newline at end of file

Modified: trunk/tools/springie/Springie/client/BattleDetails.cs
===================================================================
--- trunk/tools/springie/Springie/client/BattleDetails.cs	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/client/BattleDetails.cs	2008-04-07 18:57:09 UTC (rev 5677)
@@ -1,7 +1,7 @@
 using System;
 using System.Collections.Generic;
-using System.Text;
 using System.ComponentModel;
+using System.Globalization;
 
 namespace Springie.Client
 {
@@ -19,41 +19,38 @@
     Lineage = 2
   }
 
-  [TypeConverter(typeof(BattleDetails.BattleDetailsConverter))]
+  [TypeConverter(typeof(BattleDetailsConverter))]
   public class BattleDetails : ICloneable
   {
-    protected class BattleDetailsConverter : ExpandableObjectConverter
-    {
-      public override object ConvertTo(ITypeDescriptorContext context, System.Globalization.CultureInfo culture, object value, Type destinationType)
-      {
-        if (destinationType == typeof(string)) {
-          BattleDetails b = (BattleDetails)value;
-          return &quot;Position:&quot; + b.StartPos + &quot;; Comm:&quot; + b.EndCondition + &quot;; Dgun:&quot; + b.LimitDgun;
-        } else return base.ConvertTo(context, culture, value, destinationType);
-      }
-    }
+    public static BattleDetails Default = new BattleDetails();
+    private int diminishingMM = 0;
+    private BattleEndCondition endCondition = BattleEndCondition.Continues;
+    private int ghostedBuildings = 1;
+    private int limitDgun = 0;
+    private int maxUnits = 1000;
+    private int startingEnergy = 1000;
 
+    private int startingMetal = 1000;
+    private BattleStartPos startPos = BattleStartPos.Choose;
 
-    public static BattleDetails Default = new BattleDetails();
-
-    int startingMetal = 1000;
-    [Category(&quot;Resources&quot;), Description(&quot;Starting metal&quot;)]
+    [Category(&quot;Resources&quot;)]
+    [Description(&quot;Starting metal&quot;)]
     public int StartingMetal
     {
       get { return startingMetal; }
       set { startingMetal = value; }
     }
 
-    int startingEnergy = 1000;
-    [Category(&quot;Resources&quot;), Description(&quot;Starting energy&quot;)]
+    [Category(&quot;Resources&quot;)]
+    [Description(&quot;Starting energy&quot;)]
     public int StartingEnergy
     {
       get { return startingEnergy; }
       set { startingEnergy = value; }
     }
-    int maxUnits = 1000;
 
-    [Category(&quot;Resources&quot;), Description(&quot;Maximum units&quot;)]
+    [Category(&quot;Resources&quot;)]
+    [Description(&quot;Maximum units&quot;)]
     public int MaxUnits
     {
       get { return maxUnits; }
@@ -61,18 +58,16 @@
     }
 
 
-    BattleStartPos startPos = BattleStartPos.Choose;
-
-    [Category(&quot;Game rules&quot;), Description(&quot;Starting position&quot;)]
+    [Category(&quot;Game rules&quot;)]
+    [Description(&quot;Starting position&quot;)]
     public BattleStartPos StartPos
     {
       get { return startPos; }
       set { startPos = value; }
     }
 
-    BattleEndCondition endCondition = BattleEndCondition.Continues;
-
-    [Category(&quot;Game rules&quot;), Description(&quot;End condition - should continue when comm dies&quot;)]
+    [Category(&quot;Game rules&quot;)]
+    [Description(&quot;End condition - should continue when comm dies&quot;)]
     public BattleEndCondition EndCondition
     {
       get { return endCondition; }
@@ -80,32 +75,37 @@
     }
 
 
-    int limitDgun = 0;
-
-    [Category(&quot;Game rules&quot;), Description(&quot;Limit dgun to start position&quot;)]
+    [Category(&quot;Game rules&quot;)]
+    [Description(&quot;Limit dgun to start position&quot;)]
     public int LimitDgun
     {
       get { return limitDgun; }
       set { limitDgun = value; }
     }
-    int diminishingMM = 0;
 
-    [Category(&quot;Game rules&quot;), Description(&quot;Diminishing metal maker outputs&quot;)]
+    [Category(&quot;Game rules&quot;)]
+    [Description(&quot;Diminishing metal maker outputs&quot;)]
     public int DiminishingMM
     {
       get { return diminishingMM; }
       set { diminishingMM = value; }
     }
 
-    int ghostedBuildings = 1;
-
-    [Category(&quot;Game rules&quot;), Description(&quot;Ghosted buildings&quot;)]
+    [Category(&quot;Game rules&quot;)]
+    [Description(&quot;Ghosted buildings&quot;)]
     public int GhostedBuildings
     {
       get { return ghostedBuildings; }
       set { ghostedBuildings = value; }
     }
 
+    #region ICloneable Members
+    public object Clone()
+    {
+      return MemberwiseClone();
+    }
+    #endregion
+
     public void Validate()
     {
       if (startingMetal &lt; 0) startingMetal = Default.startingMetal;
@@ -123,7 +123,7 @@
     public void Parse(string source, Dictionary&lt;string, string&gt; modOptions)
     {
       foreach (string pair in source.Split('\t')) {
-        string[] arg = pair.Split(new char[]{'='}, 2);
+        string[] arg = pair.Split(new char[] {'='}, 2);
         if (arg.Length == 2) {
           switch (arg[0]) {
             case &quot;game/startmetal&quot;:
@@ -163,21 +163,23 @@
     }
 
 
-
     public string GetParamList()
     {
       Validate();
       return string.Format(&quot;GAME/StartMetal={0}\tGAME/StartEnergy={1}\tGAME/MaxUnits={2}\tGAME/StartPosType={3}\tGAME/GameMode={4}\tGAME/LimitDGun={5}\tGAME/DiminishingMMs={6}\tGAME/GhostedBuildings={7}&quot;, startingMetal, startingEnergy, maxUnits, (int)startPos, (int)endCondition, limitDgun, diminishingMM, ghostedBuildings);
     }
 
-    #region ICloneable Members
-
-    public object Clone()
+    #region Nested type: BattleDetailsConverter
+    protected class BattleDetailsConverter : ExpandableObjectConverter
     {
-      return this.MemberwiseClone();
+      public override object ConvertTo(ITypeDescriptorContext context, CultureInfo culture, object value, Type destinationType)
+      {
+        if (destinationType == typeof(string)) {
+          BattleDetails b = (BattleDetails)value;
+          return &quot;Position:&quot; + b.StartPos + &quot;; Comm:&quot; + b.EndCondition + &quot;; Dgun:&quot; + b.LimitDgun;
+        } else return base.ConvertTo(context, culture, value, destinationType);
+      }
     }
-
     #endregion
-  };
-
-}
+  } ;
+}
\ No newline at end of file

Modified: trunk/tools/springie/Springie/client/BattleRect.cs
===================================================================
--- trunk/tools/springie/Springie/client/BattleRect.cs	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/client/BattleRect.cs	2008-04-07 18:57:09 UTC (rev 5677)
@@ -1,22 +1,33 @@
 using System;
-using System.Collections.Generic;
-using System.Text;
 
 namespace Springie.Client
 {
   [Serializable]
   public struct BattleRect
   {
-    private int left, top, right, bottom; // values 0-200 (native tasclient format)
     public const double Max = 200;
+    private int bottom; // values 0-200 (native tasclient format)
+    private int left; // values 0-200 (native tasclient format)
+    private int right; // values 0-200 (native tasclient format)
+    private int top; // values 0-200 (native tasclient format)
 
-    private static int LimitByMax(int input)
+    public BattleRect(double left, double top, double right, double bottom)
     {
-      if (input &lt; 0) return 0;
-      if (input &gt; Max) return (int)Max;
-      return input;
+      // convert from percentages
+      this.left = LimitByMax((int)(Max*left));
+      this.top = LimitByMax((int)(Max*top));
+      this.right = LimitByMax((int)(Max*right));
+      this.bottom = LimitByMax((int)(Max*bottom));
     }
 
+    public BattleRect(int left, int top, int right, int bottom)
+    {
+      this.left = LimitByMax(left);
+      this.top = LimitByMax(top);
+      this.right = LimitByMax(right);
+      this.bottom = LimitByMax(bottom);
+    }
+
     public int Left
     {
       get { return left; }
@@ -41,29 +52,20 @@
       set { bottom = LimitByMax(value); }
     }
 
-
-    public BattleRect(double left, double top, double right, double bottom)
-    { // convert from percentages
-      this.left = LimitByMax((int)(Max * left));
-      this.top = LimitByMax((int)(Max * top));
-      this.right = LimitByMax((int)(Max * right));
-      this.bottom = LimitByMax((int)(Max * bottom));
-    }
-
-    public BattleRect(int left, int top, int right, int bottom)
+    private static int LimitByMax(int input)
     {
-      this.left = LimitByMax(left);
-      this.top = LimitByMax(top);
-      this.right = LimitByMax(right);
-      this.bottom = LimitByMax(bottom);
+      if (input &lt; 0) return 0;
+      if (input &gt; Max) return (int)Max;
+      return input;
     }
 
+
     public void ToFractions(out double left, out double top, out double right, out double bottom)
     {
-      left = Left / Max;
-      top = Top / Max;
-      right = Right / Max;
-      bottom = Bottom / Max;
+      left = Left/Max;
+      top = Top/Max;
+      right = Right/Max;
+      bottom = Bottom/Max;
     }
-  };
-}
+  } ;
+}
\ No newline at end of file

Modified: trunk/tools/springie/Springie/client/ServerConnection.cs
===================================================================
--- trunk/tools/springie/Springie/client/ServerConnection.cs	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/client/ServerConnection.cs	2008-04-07 18:57:09 UTC (rev 5677)
@@ -1,7 +1,6 @@
 using System;
-using System.Collections.Generic;
-using System.Text;
 using System.Net.Sockets;
+using System.Text;
 
 namespace Springie.Client
 {
@@ -10,21 +9,46 @@
   /// &lt;/summary&gt;
   public class ServerConnectionEventArgs : EventArgs
   {
+    #region ResultTypes enum
+    public enum ResultTypes
+    {
+      Success,
+      NetworkError,
+      NotSet
+    } ;
+    #endregion
+
+    private string command = &quot;&quot;;
+
+    private object[] parameters;
     private int requestId = 0;
 
+    private ResultTypes result = ResultTypes.NotSet;
+
+    private ServerConnection serverConnection = null;
+
+
+    public ServerConnectionEventArgs() {}
+
+    public ServerConnectionEventArgs(ServerConnection serverConnection, int requestId, string command, object[] parameters)
+    {
+      this.serverConnection = serverConnection;
+      this.requestId = requestId;
+      this.command = command;
+      this.parameters = parameters;
+    }
+
     public int RequestId
     {
       get { return requestId; }
       set { requestId = value; }
     }
-    private string command = &quot;&quot;;
 
     public string Command
     {
       get { return command; }
       set { command = value; }
     }
-    private object[] parameters;
 
     public object[] Parameters
     {
@@ -32,35 +56,17 @@
       set { parameters = value; }
     }
 
-    public enum ResultTypes { Success, NetworkError, NotSet };
-
-    private ResultTypes result = ResultTypes.NotSet;
-
     public ResultTypes Result
     {
       get { return result; }
       set { result = value; }
     }
 
-    private ServerConnection serverConnection = null;
     public ServerConnection ServerConnection
     {
       get { return serverConnection; }
       set { serverConnection = value; }
     }
-
-
-    public ServerConnectionEventArgs()
-    {
-    }
-
-    public ServerConnectionEventArgs(ServerConnection serverConnection, int requestId, string command, object[] parameters)
-    {
-      this.serverConnection = serverConnection;
-      this.requestId = requestId;
-      this.command = command;
-      this.parameters = parameters;
-    }
   }
 
 
@@ -69,42 +75,49 @@
   /// &lt;/summary&gt;
   public class ServerConnection : IDisposable
   {
-    TcpClient tcp;
-    NetworkStream stream;
-    Byte[] readBuffer;
-    int readPosition = 0;
-    int commandNumber = 0;
-    object myLock = new object();
+    private int commandNumber = 0;
+    private object myLock = new object();
+    private Byte[] readBuffer;
+    private int readPosition = 0;
+    private NetworkStream stream;
+    private TcpClient tcp;
 
+    public ServerConnection() {}
+
     /// &lt;summary&gt;
+    /// Creates object and connects to TA server
+    /// &lt;/summary&gt;
+    /// &lt;param name=&quot;host&quot;&gt;server host&lt;/param&gt;
+    /// &lt;param name=&quot;port&quot;&gt;server port&lt;/param&gt;
+    public ServerConnection(string host, int port)
+    {
+      Connect(host, port);
+    }
+
+    #region IDisposable Members
+    public void Dispose()
+    {
+      Close();
+    }
+    #endregion
+
+    /// &lt;summary&gt;
     /// Raised when command has finished sending
     /// &lt;/summary&gt;
     public event EventHandler&lt;ServerConnectionEventArgs&gt; CommandSent;
+
     /// &lt;summary&gt;
     /// raised when connection is closed 
     /// &lt;/summary&gt;
     public event EventHandler ConnectionClosed;
+
     /// &lt;summary&gt;
     /// Raised when command is recieved from the server
     /// &lt;/summary&gt;
     public event EventHandler&lt;ServerConnectionEventArgs&gt; CommandRecieved;
 
 
-    public ServerConnection()
-    {
-    }
-
     /// &lt;summary&gt;
-    /// Creates object and connects to TA server
-    /// &lt;/summary&gt;
-    /// &lt;param name=&quot;host&quot;&gt;server host&lt;/param&gt;
-    /// &lt;param name=&quot;port&quot;&gt;server port&lt;/param&gt;
-    public ServerConnection(string host, int port)
-    {
-      Connect(host, port);
-    }
-
-    /// &lt;summary&gt;
     /// Connects to TA server and resets internal data
     /// &lt;/summary&gt;
     /// &lt;param name=&quot;host&quot;&gt;server host&lt;/param&gt;
@@ -182,19 +195,22 @@
       ServerConnection server = (ServerConnection)res.AsyncState;
       try {
         server.readPosition += server.stream.EndRead(res); // actual data read - this blocks
-      } catch { // there was error while reading - stream is broken
+      } catch {
+        // there was error while reading - stream is broken
         server.Close();
         return;
       }
 
       // check data for new line - isolating commands from it
       for (int i = server.readPosition - 1; i &gt;= 0; --i) {
-        if (server.readBuffer[i] == '\n') { // new line found - convert to string and parse commands
+        if (server.readBuffer[i] == '\n') {
+          // new line found - convert to string and parse commands
 
           String recData = Encoding.ASCII.GetString(server.readBuffer, 0, i + 1); // convert recieved bytes to string
 
           // cycle through lines of data
-          foreach (string line in recData.Split(new char[] { '\n' }, StringSplitOptions.RemoveEmptyEntries)) { // for each line = command do
+          foreach (string line in recData.Split(new char[] {'\n'}, StringSplitOptions.RemoveEmptyEntries)) {
+            // for each line = command do
             string[] args = line.Split(' '); // split arguments
             /*for (int j = 0; j &lt; args.Length; ++j) { // replace \t with ' ' in every argument
               args[j] = args[j].Replace('\t', ' ');
@@ -207,26 +223,22 @@
             command.Command = args[0];
             command.Result = ServerConnectionEventArgs.ResultTypes.Success;
             command.Parameters = new string[args.Length - 1];
-            for (int j = 1; j &lt; args.Length; ++j) {
-              command.Parameters[j - 1] = args[j];
-            }
+            for (int j = 1; j &lt; args.Length; ++j) command.Parameters[j - 1] = args[j];
             if (server.CommandRecieved != null) server.CommandRecieved(server, command);
           }
 
           // copy remaining data (not ended by \n yet) to the beginning of buffer
-          for (int x = 0; x &lt; server.readPosition - i - 1; ++x) {
-            server.readBuffer[x] = server.readBuffer[x + i + 1];
-          }
+          for (int x = 0; x &lt; server.readPosition - i - 1; ++x) server.readBuffer[x] = server.readBuffer[x + i + 1];
           server.readPosition = server.readPosition - i - 1;
           break;
         }
       }
 
-
       // prepare to read more data
       int rembuf = server.readBuffer.Length - server.readPosition;
-      if (rembuf &lt;= 0) { // read buffer too small, increase it
-        byte[] n = new byte[server.readBuffer.Length * 2];
+      if (rembuf &lt;= 0) {
+        // read buffer too small, increase it
+        byte[] n = new byte[server.readBuffer.Length*2];
         server.readBuffer.CopyTo(n, 0);
         server.readBuffer = n;
         rembuf = server.readBuffer.Length - server.readPosition;
@@ -234,43 +246,28 @@
 
       try {
         server.stream.BeginRead(server.readBuffer, server.readPosition, rembuf, new AsyncCallback(DataRecieveCallback), server);
-      } catch { // there was error while reading - stream is broken
+      } catch {
+        // there was error while reading - stream is broken
         server.Close();
         return;
       }
     }
 
 
-
     /// &lt;summary&gt;
     /// Closes connection to remote server
     /// &lt;/summary&gt;
     public void Close()
     {
       lock (myLock) {
-        this.CommandRecieved = null;
-        this.CommandSent = null;
-        if (tcp != null &amp;&amp; tcp.Connected) {
-          tcp.Close();
-        }
+        CommandRecieved = null;
+        CommandSent = null;
+        if (tcp != null &amp;&amp; tcp.Connected) tcp.Close();
         stream = null;
         tcp = null;
         if (ConnectionClosed != null) ConnectionClosed(this, EventArgs.Empty);
-        this.ConnectionClosed = null;
+        ConnectionClosed = null;
       }
     }
-
-
-
-    #region IDisposable Members
-
-    public void Dispose()
-    {
-      Close();
-    }
-
-    #endregion
   }
-}
-
-
+}
\ No newline at end of file

Modified: trunk/tools/springie/Springie/client/TasClient.cs
===================================================================
--- trunk/tools/springie/Springie/client/TasClient.cs	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/client/TasClient.cs	2008-04-07 18:57:09 UTC (rev 5677)
@@ -1,61 +1,103 @@
 using System;
 using System.Collections.Generic;
+using System.Globalization;
+using System.Net;
+using System.Net.Sockets;
+using System.Security.Cryptography;
 using System.Text;
+using System.Text.RegularExpressions;
+using System.Threading;
 using System.Timers;
-using System.Net;
 using Microsoft.Win32;
-using System.Security.Cryptography;
 using Springie.SpringNamespace;
-using System.Text.RegularExpressions;
-using System.Net.Sockets;
+using Timer=System.Timers.Timer;
 
-
 namespace Springie.Client
 {
   public partial class TasClient
   {
     // server info
-    ServerConnection con = null;
-    bool isConnected = false;
-    bool isLoggedIn = false;
 
-    bool startingAfterUdpPunch = false;
+    #region SayPlace enum
+    public enum SayPlace
+    {
+      Channel,
+      Battle,
+      User
+    } ;
+    #endregion
 
-    string serverVersion = &quot;&quot;;
-    int serverUdpHolePunchingPort = 0;
-    string serverHost = &quot;&quot;;
-    IPAddress serverIp;
-    int serverPort = 0;
-    int pingInterval = 10; // how often to ping server (in seconds)
-    int lastUdpSourcePort = 0;
-    Timer pingTimer;
-    Timer udpPunchingTimer = new Timer(400);
-    MapInfo mapToChangeTo;
-    bool lockToChangeTo;
+    public const int MaxRank = 4;
+    public const int MinRank = 0;
+    private Battle battle = null;
+    private int battleID = 0;
 
-    // working variables
-    bool isChanScanning = false;
+    private ServerConnection con = null;
+    private Dictionary&lt;string, ExistingChannel&gt; existingChannels = new Dictionary&lt;string, ExistingChannel&gt;();
+    private Dictionary&lt;string, User&gt; existingUsers = new Dictionary&lt;string, User&gt;();
+    private bool isChanScanning = false;
+    private bool isConnected = false;
+    private bool isLoggedIn = false;
+    private Dictionary&lt;string, Channel&gt; joinedChannels = new Dictionary&lt;string, Channel&gt;();
+    private int lastSpectatorCount;
+    private int lastUdpSourcePort = 0;
+    private bool lockToChangeTo;
+    private MapInfo mapToChangeTo;
+    private int pingInterval = 10; // how often to ping server (in seconds)
+    private Timer pingTimer;
 
+    private string serverHost = &quot;&quot;;
+    private IPAddress serverIp;
+    private int serverPort = 0;
+    private int serverUdpHolePunchingPort = 0;
+    private string serverVersion = &quot;&quot;;
+    private bool startingAfterUdpPunch = false;
+    private Timer udpPunchingTimer = new Timer(400);
+
     // user info 
-    string username = &quot;&quot;;
+    private string username = &quot;&quot;;
+
+    public TasClient()
+    {
+      pingTimer = new Timer(pingInterval*1000);
+      pingTimer.AutoReset = true;
+      pingTimer.Elapsed += OnPingTimer;
+      pingTimer.Start();
+
+      udpPunchingTimer.Elapsed += new ElapsedEventHandler(udpPunchingTimer_Elapsed);
+      udpPunchingTimer.AutoReset = true;
+
+      ConnectionLost += RaiseFailure;
+      LoginDenied += RaiseFailure;
+      ChannelJoinFailed += RaiseFailure;
+      BattleOpenFailed += RaiseFailure;
+    }
+
     public string UserName
     {
-      get
+      get { return username; }
+    }
+
+    public bool IsLoggedIn
+    {
+      get { return isLoggedIn; }
+    }
+
+    public int PingInterval
+    {
+      get { return pingInterval; }
+      set
       {
-        return username;
+        pingInterval = value;
+        pingTimer.Interval = pingInterval*1000;
       }
     }
-    Dictionary&lt;string, ExistingChannel&gt; existingChannels = new Dictionary&lt;string, ExistingChannel&gt;();
-    Dictionary&lt;string, User&gt; existingUsers = new Dictionary&lt;string, User&gt;();
-    Dictionary&lt;string, Channel&gt; joinedChannels = new Dictionary&lt;string, Channel&gt;();
 
-    // battle info
-    Battle battle = null;
-    int battleID = 0;
+    public bool IsConnected
+    {
+      get { return isConnected; }
+    }
 
-    public const int MinRank = 0;
-    public const int MaxRank = 4;
-
     // group events
     public event EventHandler&lt;TasEventArgs&gt; Failure; //this event is fired whenever any failure events fire
     public event EventHandler&lt;TasSayEventArgs&gt; Said; // this is fired when any kind of say message is recieved
@@ -100,46 +142,13 @@
 
     public event EventHandler&lt;TasEventArgs&gt; MyStatusChangedToInGame;
 
-    public bool IsLoggedIn
-    {
-      get { return isLoggedIn; }
-    }
 
-    public int PingInterval
-    {
-      get { return pingInterval; }
-      set { pingInterval = value; pingTimer.Interval = pingInterval * 1000; }
-    }
-
-    public bool IsConnected
-    {
-      get { return isConnected; }
-    }
-
-
     public Dictionary&lt;string, Channel&gt; GetJoinedChannels()
     {
       return new Dictionary&lt;string, Channel&gt;(joinedChannels);
     }
 
 
-    public TasClient()
-    {
-      pingTimer = new Timer(pingInterval * 1000);
-      pingTimer.AutoReset = true;
-      pingTimer.Elapsed += OnPingTimer;
-      pingTimer.Start();
-
-
-      udpPunchingTimer.Elapsed += new ElapsedEventHandler(udpPunchingTimer_Elapsed);
-      udpPunchingTimer.AutoReset = true;
-
-      ConnectionLost += RaiseFailure;
-      LoginDenied += RaiseFailure;
-      ChannelJoinFailed += RaiseFailure;
-      BattleOpenFailed += RaiseFailure;
-    }
-
     public bool GetExistingUser(string name, out User u)
     {
       return existingUsers.TryGetValue(name, out u);
@@ -172,9 +181,7 @@
 
     public void Disconnect()
     {
-      if (con != null &amp;&amp; isConnected) {
-        con.Close();
-      }
+      if (con != null &amp;&amp; isConnected) con.Close();
       //con.CommandRecieved 
       existingUsers = new Dictionary&lt;string, User&gt;();
       existingChannels = new Dictionary&lt;string, ExistingChannel&gt;();
@@ -189,9 +196,7 @@
 
     private void OnPingTimer(object sender, EventArgs args)
     {
-      if (isConnected &amp;&amp; con != null) {
-        con.SendCommand(0, &quot;PING&quot;);
-      }
+      if (isConnected &amp;&amp; con != null) con.SendCommand(0, &quot;PING&quot;);
     }
 
 
@@ -228,7 +233,8 @@
 
     public Battle GetBattle()
     {
-      if (battle != null) return (Battle)battle.Clone(); else return null;
+      if (battle != null) return (Battle)battle.Clone();
+      else return null;
     }
 
     public Dictionary&lt;string, ExistingChannel&gt; GetExistingChannels()
@@ -248,9 +254,8 @@
     {
       if (con == null) throw new TasClientException(&quot;Not connected&quot;);
 
-      if (!String.IsNullOrEmpty(key)) {
-        con.SendCommand(0, &quot;JOIN&quot;, channelName, HashPassword(key));
-      } else con.SendCommand(0, &quot;JOIN&quot;, channelName);
+      if (!String.IsNullOrEmpty(key)) con.SendCommand(0, &quot;JOIN&quot;, channelName, HashPassword(key));
+      else con.SendCommand(0, &quot;JOIN&quot;, channelName);
     }
 
 
@@ -281,13 +286,11 @@
           startingAfterUdpPunch = true;
           SendUdpPacket(0, serverIp, serverUdpHolePunchingPort);
           udpPunchingTimer.Start();
-        } else {
-          ChangeMyStatus(false, true);
-        }
+        } else ChangeMyStatus(false, true);
       }
     }
 
-    void udpPunchingTimer_Elapsed(object sender, ElapsedEventArgs e)
+    private void udpPunchingTimer_Elapsed(object sender, ElapsedEventArgs e)
     {
       SendUdpPacket(lastUdpSourcePort, serverIp, serverUdpHolePunchingPort);
     }
@@ -309,7 +312,6 @@
     }
 
 
-    public enum SayPlace { Channel, Battle, User };
     /// &lt;summary&gt;
     /// Say something through chat system
     /// &lt;/summary&gt;
@@ -341,7 +343,6 @@
     public void GameSaid(string username, string text)
     {
       if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Player, TasSayEventArgs.Places.Game, &quot;&quot;, username, text, false));
-
     }
 
 
@@ -349,14 +350,15 @@
     {
       LeaveBattle(); // leave current battle
       battleID = -1;
-      this.battle = (Battle)nbattle.Clone();
+      battle = (Battle)nbattle.Clone();
 
       List&lt;Object&gt; objList = new List&lt;object&gt;();
       objList.Add(0); // type = normal
       objList.Add((int)battle.Nat);
       objList.Add(battle.Password);
       objList.Add(battle.HostPort);
-      objList.Add(battle.MaxPlayers); ;
+      objList.Add(battle.MaxPlayers);
+      ;
       //battle.Details.AddToParamList(objList);
       objList.Add(battle.Mod.Checksum);
       objList.Add(battle.Rank);
@@ -373,15 +375,12 @@
       lastSpectatorCount = -1;
 
       // send predefined starting rectangles
-      foreach (KeyValuePair&lt;int, BattleRect&gt; v in battle.Rectangles) {
-        con.SendCommand(0, &quot;ADDSTARTRECT&quot;, v.Key, v.Value.Left, v.Value.Top, v.Value.Right, v.Value.Bottom);
-      }
-
+      foreach (KeyValuePair&lt;int, BattleRect&gt; v in battle.Rectangles) con.SendCommand(0, &quot;ADDSTARTRECT&quot;, v.Key, v.Value.Left, v.Value.Top, v.Value.Right, v.Value.Bottom);
     }
 
     public void LeaveBattle()
     {
-      if (this.battle != null) {
+      if (battle != null) {
         con.SendCommand(0, &quot;LEAVEBATTLE&quot;);
         battle = null;
         battleID = 0;
@@ -419,9 +418,7 @@
         foreach (string s in tmp) {
           if (!battle.DisabledUnits.Contains(s)) {
             UnitInfo u;
-            if (battle.Mod.GetUnitInfo(s, out u)) {
-              battle.DisabledUnits.Add(s);
-            }
+            if (battle.Mod.GetUnitInfo(s, out u)) battle.DisabledUnits.Add(s);
           }
         }
         if (battle.DisabledUnits.Count &gt; 0) {
@@ -441,7 +438,6 @@
     }
 
 
-
     private void UpdateBattleInfo(bool lck, MapInfo mapname)
     {
       if (battle != null) {
@@ -453,12 +449,9 @@
 
     public void ChangeLock(bool lck)
     {
-      if (battle != null &amp;&amp; lck != lockToChangeTo) {
-        UpdateBattleInfo(lck, mapToChangeTo);
-      }
+      if (battle != null &amp;&amp; lck != lockToChangeTo) UpdateBattleInfo(lck, mapToChangeTo);
     }
 
-    private int lastSpectatorCount;
     private void UpdateSpectators()
     {
       if (battle != null) {
@@ -503,9 +496,7 @@
 
     private void OnCommandRecieved(object sender, ServerConnectionEventArgs args)
     {
-      if (sender == con) {
-        DispatchServerCommand(args.Command, (string[])args.Parameters);
-      }
+      if (sender == con) DispatchServerCommand(args.Command, (string[])args.Parameters);
     }
 
     /// &lt;summary&gt;
@@ -572,10 +563,9 @@
     /// &lt;param name=&quot;args&quot;&gt;command arguments&lt;/param&gt;
     private void DispatchServerCommand(string command, string[] args)
     {
-      System.Threading.Thread.CurrentThread.CurrentCulture = System.Globalization.CultureInfo.InvariantCulture;
+      Thread.CurrentThread.CurrentCulture = CultureInfo.InvariantCulture;
       try {
         switch (command) {
-
           case &quot;TASServer&quot;: // happens after connecting to server
             serverVersion = args[0];
             int.TryParse(args[2], out serverUdpHolePunchingPort);
@@ -604,142 +594,140 @@
             break;
 
           case &quot;CHANNEL&quot;: // iterating channels
-          {
+            {
               ExistingChannel c = new ExistingChannel();
               c.name = args[0];
               int.TryParse(args[1], out c.userCount);
               if (args.Length &gt;= 3) c.topic = Utils.Glue(args, 2);
               existingChannels.Add(c.name, c);
             }
-          break;
+            break;
 
           case &quot;ENDOFCHANNELS&quot;: // end of channel list iteration
-          isChanScanning = false;
-          if (ChannelListDone != null) ChannelListDone(this, new TasEventArgs());
-          break;
+            isChanScanning = false;
+            if (ChannelListDone != null) ChannelListDone(this, new TasEventArgs());
+            break;
 
           case &quot;ADDUSER&quot;: // new user joined ta server
-          {
-            User u = User.Create(args[0]);
-            u.country = args[1];
-            int.TryParse(args[2], out u.cpu);
-            //IPAddress.TryParse(args[3], out u.ip);
-            existingUsers.Add(u.name, u);
-            if (UserAdded != null) UserAdded(this, new TasEventArgs(args));
-          }
-          break;
+            {
+              User u = User.Create(args[0]);
+              u.country = args[1];
+              int.TryParse(args[2], out u.cpu);
+              //IPAddress.TryParse(args[3], out u.ip);
+              existingUsers.Add(u.name, u);
+              if (UserAdded != null) UserAdded(this, new TasEventArgs(args));
+            }
+            break;
 
-          case &quot;REMOVEUSER&quot;:  // user left ta server
-          existingUsers.Remove(args[0]);
-          if (UserRemoved != null) UserRemoved(this, new TasEventArgs(args));
-          break;
+          case &quot;REMOVEUSER&quot;: // user left ta server
+            existingUsers.Remove(args[0]);
+            if (UserRemoved != null) UserRemoved(this, new TasEventArgs(args));
+            break;
 
           case &quot;MOTD&quot;: // server motd
-          if (Said != null &amp;&amp; args.Length &gt; 0) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Server, TasSayEventArgs.Places.Motd, &quot;&quot;, &quot;&quot;, Utils.Glue(args, 0), false));
-          break;
+            if (Said != null &amp;&amp; args.Length &gt; 0) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Server, TasSayEventArgs.Places.Motd, &quot;&quot;, &quot;&quot;, Utils.Glue(args, 0), false));
+            break;
 
           case &quot;SERVERMSG&quot;: // server message
-          if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Server, TasSayEventArgs.Places.Normal, &quot;&quot;, &quot;&quot;, Utils.Glue(args, 0), false));
-          break;
+            if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Server, TasSayEventArgs.Places.Normal, &quot;&quot;, &quot;&quot;, Utils.Glue(args, 0), false));
+            break;
 
           case &quot;SERVERMSGBOX&quot;: // server messagebox
-          if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Server, TasSayEventArgs.Places.MessageBox, &quot;&quot;, &quot;&quot;, Utils.Glue(args, 0), false));
-          break;
+            if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Server, TasSayEventArgs.Places.MessageBox, &quot;&quot;, &quot;&quot;, Utils.Glue(args, 0), false));
+            break;
 
           case &quot;CHANNELMESSAGE&quot;: // server broadcast to channel
-          if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Server, TasSayEventArgs.Places.Channel, args[0], &quot;&quot;, Utils.Glue(args, 1), false));
-          break;
+            if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Server, TasSayEventArgs.Places.Channel, args[0], &quot;&quot;, Utils.Glue(args, 1), false));
+            break;
 
           case &quot;SAID&quot;: // someone said something in channel
-          if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Player, TasSayEventArgs.Places.Channel, args[0], args[1], Utils.Glue(args, 2), false));
-          break;
+            if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Player, TasSayEventArgs.Places.Channel, args[0], args[1], Utils.Glue(args, 2), false));
+            break;
 
           case &quot;SAIDEX&quot;: // someone said something with emote in channel
-          if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Player, TasSayEventArgs.Places.Channel, args[0], args[1], Utils.Glue(args, 2), true));
-          break;
+            if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Player, TasSayEventArgs.Places.Channel, args[0], args[1], Utils.Glue(args, 2), true));
+            break;
 
           case &quot;SAYPRIVATE&quot;: // sent back from sever when user sends private message
-          if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Player, TasSayEventArgs.Places.Normal, args[0], username, Utils.Glue(args, 1), false)); // channel = char partner name
-          break;
+            if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Player, TasSayEventArgs.Places.Normal, args[0], username, Utils.Glue(args, 1), false)); // channel = char partner name
+            break;
 
           case &quot;SAIDPRIVATE&quot;: // someone said something to me
-          if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Player, TasSayEventArgs.Places.Normal, args[0], args[0], Utils.Glue(args, 1), false));
-          break;
+            if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Player, TasSayEventArgs.Places.Normal, args[0], args[0], Utils.Glue(args, 1), false));
+            break;
 
           case &quot;SAIDBATTLE&quot;: // someone said something in battle
-          if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Player, TasSayEventArgs.Places.Battle, &quot;&quot;, args[0], Utils.Glue(args, 1), false));
-          break;
+            if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Player, TasSayEventArgs.Places.Battle, &quot;&quot;, args[0], Utils.Glue(args, 1), false));
+            break;
 
           case &quot;SAIDBATTLEEX&quot;: // someone said in battle with emote
-          if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Player, TasSayEventArgs.Places.Battle, &quot;&quot;, args[0], Utils.Glue(args, 1), true));
-          break;
+            if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Player, TasSayEventArgs.Places.Battle, &quot;&quot;, args[0], Utils.Glue(args, 1), true));
+            break;
 
           case &quot;BROADCAST&quot;: // server sends urgent broadcast
-          if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Server, TasSayEventArgs.Places.Broadcast, &quot;&quot;, &quot;&quot;, Utils.Glue(args, 0), false));
-          break;
+            if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Server, TasSayEventArgs.Places.Broadcast, &quot;&quot;, &quot;&quot;, Utils.Glue(args, 0), false));
+            break;
 
           case &quot;REDIRECT&quot;: // server sends backup IP
-          // removed due to bugs         
-          break;
+            // removed due to bugs         
+            break;
 
           case &quot;CLIENTSTATUS&quot;: // client's status changed
-          {
-            int status = 0;
-            int.TryParse(args[1], out status);
-            User u = existingUsers[args[0]];
-            u.FromInt(status);
+            {
+              int status = 0;
+              int.TryParse(args[1], out status);
+              User u = existingUsers[args[0]];
+              u.FromInt(status);
 
-            if (u.name == UserName &amp;&amp; (u.isInGame == true &amp;&amp; existingUsers[args[0]].isInGame == false)) {
+              if (u.name == UserName &amp;&amp; (u.isInGame == true &amp;&amp; existingUsers[args[0]].isInGame == false)) {
+                existingUsers[args[0]] = u;
+                if (MyStatusChangedToInGame != null) MyStatusChangedToInGame(this, new TasEventArgs());
+              }
+
               existingUsers[args[0]] = u;
-              if (MyStatusChangedToInGame != null) MyStatusChangedToInGame(this, new TasEventArgs());
+              if (UserStatusChanged != null) UserStatusChanged(this, new TasEventArgs(args));
             }
+            break;
 
-            existingUsers[args[0]] = u;
-            if (UserStatusChanged != null) UserStatusChanged(this, new TasEventArgs(args));
-          }
-          break;
-
           case &quot;CLIENTS&quot;: // client list sent after channel join
-          string[] usrs = Utils.Glue(args, 1).Split(' ');
-          foreach (string s in usrs) {
-            joinedChannels[args[0]].channelUsers.Add(s);
-          }
-          if (ChannelUserAdded != null) ChannelUserAdded(this, new TasEventArgs(args[0]));
-          break;
+            string[] usrs = Utils.Glue(args, 1).Split(' ');
+            foreach (string s in usrs) joinedChannels[args[0]].channelUsers.Add(s);
+            if (ChannelUserAdded != null) ChannelUserAdded(this, new TasEventArgs(args[0]));
+            break;
 
           case &quot;JOINED&quot;: // user joined one of my channels
-          joinedChannels[args[0]].channelUsers.Add(args[1]);
-          if (ChannelUserAdded != null) ChannelUserAdded(this, new TasEventArgs(args[0]));
-          break;
+            joinedChannels[args[0]].channelUsers.Add(args[1]);
+            if (ChannelUserAdded != null) ChannelUserAdded(this, new TasEventArgs(args[0]));
+            break;
 
-          case &quot;LEFT&quot;:  // user left one of my channels
-          joinedChannels[args[0]].channelUsers.Remove(args[1]);
-          if (ChannelUserRemoved != null) ChannelUserRemoved(this, new TasEventArgs(args[0], args[1], Utils.Glue(args, 2)));
-          break;
+          case &quot;LEFT&quot;: // user left one of my channels
+            joinedChannels[args[0]].channelUsers.Remove(args[1]);
+            if (ChannelUserRemoved != null) ChannelUserRemoved(this, new TasEventArgs(args[0], args[1], Utils.Glue(args, 2)));
+            break;
 
           case &quot;CHANNELTOPIC&quot;: // channel topic update (after joining a channel)
-          {
-            Channel c = joinedChannels[args[0]];
-            c.topicSetBy = args[1];
-            c.topicSetDate = ConvertMilisecondTime(args[2]);
-            c.topic = Utils.Glue(args, 3);
-            if (ChannelTopicChanged != null) ChannelTopicChanged(this, new TasEventArgs(args[0]));
-          }
-          break;
+            {
+              Channel c = joinedChannels[args[0]];
+              c.topicSetBy = args[1];
+              c.topicSetDate = ConvertMilisecondTime(args[2]);
+              c.topic = Utils.Glue(args, 3);
+              if (ChannelTopicChanged != null) ChannelTopicChanged(this, new TasEventArgs(args[0]));
+            }
+            break;
 
           case &quot;OPENBATTLEFAILED&quot;: // opening new battle has failed
-          if (BattleOpenFailed != null) BattleOpenFailed(this, new TasEventArgs(Utils.Glue(args)));
-          break;
+            if (BattleOpenFailed != null) BattleOpenFailed(this, new TasEventArgs(Utils.Glue(args)));
+            break;
 
           case &quot;OPENBATTLE&quot;: // openbattle ok
             {
-            battleID = int.Parse(args[0]);
-            UserBattleStatus self = new UserBattleStatus(username);
-            self.IsSpectator = true;
-            battle.Users.Add(self); // add self
-            UpdateBattleDetails(battle.Details);
-            if (BattleOpened != null) BattleOpened(this, new TasEventArgs(args[0]));
-          }
+              battleID = int.Parse(args[0]);
+              UserBattleStatus self = new UserBattleStatus(username);
+              self.IsSpectator = true;
+              battle.Users.Add(self); // add self
+              UpdateBattleDetails(battle.Details);
+              if (BattleOpened != null) BattleOpened(this, new TasEventArgs(args[0]));
+            }
             break;
 
           case &quot;REQUESTBATTLESTATUS&quot;: // server asks us to update our status
@@ -783,7 +771,8 @@
             if (battle != null &amp;&amp; int.Parse(args[0]) == battleID) {
               string mapname = Utils.Glue(args, 4);
               if (battle.Map.Name != mapname) {
-                if (mapToChangeTo != null &amp;&amp; mapToChangeTo.Name == mapname) { // if we changed to known requested map, use it
+                if (mapToChangeTo != null &amp;&amp; mapToChangeTo.Name == mapname) {
+                  // if we changed to known requested map, use it
                   battle.Map = mapToChangeTo;
                 } else battle.Map = Program.main.Spring.UnitSync.MapList[mapname]; //otherwise find this map using unitsync
                 if (BattleMapChanged != null) BattleMapChanged(this, new TasEventArgs(mapname));
@@ -796,8 +785,8 @@
             }
             break;
 
-
-          case &quot;BATTLEOPENED&quot;: {
+          case &quot;BATTLEOPENED&quot;:
+            {
               if (BattleFound != null) BattleFound(this, new TasEventArgs(args));
               break;
             }
@@ -815,7 +804,6 @@
             }
             break;
 
-
           case &quot;SETSCRIPTTAGS&quot;: // updates internal battle details
             if (battle != null) {
               BattleDetails bd = new BattleDetails();
@@ -825,24 +813,14 @@
             }
             break;
 
-
           case &quot;UDPSOURCEPORT&quot;:
             udpPunchingTimer.Stop();
             if (startingAfterUdpPunch) {
               startingAfterUdpPunch = false;
               if (battle != null) {
-
                 // send UDP packets to client (2x to be sure)
-                foreach (UserBattleStatus ubs in battle.Users) {
-                  if (ubs.ip != IPAddress.None &amp;&amp; ubs.port != 0) {
-                    SendUdpPacket(lastUdpSourcePort, ubs.ip, ubs.port);
-                  }
-                }
-                foreach (UserBattleStatus ubs in battle.Users) {
-                  if (ubs.ip != IPAddress.None &amp;&amp; ubs.port != 0) {
-                    SendUdpPacket(lastUdpSourcePort, ubs.ip, ubs.port);
-                  }
-                }
+                foreach (UserBattleStatus ubs in battle.Users) if (ubs.ip != IPAddress.None &amp;&amp; ubs.port != 0) SendUdpPacket(lastUdpSourcePort, ubs.ip, ubs.port);
+                foreach (UserBattleStatus ubs in battle.Users) if (ubs.ip != IPAddress.None &amp;&amp; ubs.port != 0) SendUdpPacket(lastUdpSourcePort, ubs.ip, ubs.port);
 
                 battle.HostPort = lastUdpSourcePort; // update source port for hosting and start it
                 ChangeMyStatus(false, true);
@@ -852,15 +830,14 @@
         }
       } catch (Exception e) {
         if (!ErrorHandling.HandleException(e, &quot;Exception while dispatching &quot; + command + &quot; &quot; + Utils.Glue(args))) throw e;
-      };
+      }
+      ;
     }
 
 
-
     public static DateTime ConvertMilisecondTime(string arg)
     {
       return (new DateTime(1970, 1, 1, 0, 0, 0)).AddMilliseconds(long.Parse(arg));
     }
-
   }
-}
+}
\ No newline at end of file

Modified: trunk/tools/springie/Springie/client/TasClient_structures.cs
===================================================================
--- trunk/tools/springie/Springie/client/TasClient_structures.cs	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/client/TasClient_structures.cs	2008-04-07 18:57:09 UTC (rev 5677)
@@ -1,7 +1,5 @@
 using System;
 using System.Collections.Generic;
-using System.Text;
-using System.Net;
 
 namespace Springie.Client
 {
@@ -11,11 +9,11 @@
   /// &lt;/summary&gt;
   public struct Channel
   {
+    public List&lt;string&gt; channelUsers;
     public string name;
     public string topic;
     public string topicSetBy;
     public DateTime topicSetDate;
-    public List&lt;string&gt; channelUsers;
 
     public static Channel Create(string name)
     {
@@ -24,7 +22,7 @@
       c.channelUsers = new List&lt;string&gt;();
       return c;
     }
-  };
+  } ;
 
   /// &lt;summary&gt;
   /// Basic channel information - for channel enumeration
@@ -32,9 +30,9 @@
   public struct ExistingChannel
   {
     public string name;
+    public string topic;
     public int userCount;
-    public string topic;
-  };
+  } ;
 
 
   /// &lt;summary&gt;
@@ -42,19 +40,21 @@
   /// &lt;/summary&gt;
   public struct User
   {
-    public string name;
+    public string country;
     public int cpu;
-    public string country;
+    public bool isAdmin;
+    public bool isAway;
     public bool isInGame;
-    public bool isAway;
+    public string name;
     public int rank;
-    public bool isAdmin;
+
     public static User Create(string name)
     {
       User u = new User();
       u.name = name;
       return u;
     }
+
     public void FromInt(int status)
     {
       isInGame = (status &amp; 1) &gt; 0;
@@ -70,42 +70,70 @@
       res |= isAway ? 2 : 0;
       return res;
     }
-  };
+  } ;
 
 
+  public class TasEventArgs : EventArgs
+  {
+    private List&lt;string&gt; serverParams = new List&lt;string&gt;();
 
+    public TasEventArgs() {}
 
-  public class TasEventArgs : EventArgs
-  {
-    List&lt;string&gt; serverParams = new List&lt;string&gt;();
+    public TasEventArgs(params string[] serverParams)
+    {
+      this.serverParams = new List&lt;string&gt;(serverParams);
+    }
+
     public List&lt;string&gt; ServerParams
     {
       get { return serverParams; }
       set { serverParams = value; }
     }
+  } ;
 
-    public TasEventArgs() { }
-    public TasEventArgs(params string[] serverParams)
+
+  public class TasSayEventArgs : EventArgs
+  {
+    #region Origins enum
+    public enum Origins
     {
-      this.serverParams = new List&lt;string&gt;(serverParams);
+      Server,
+      Player
     }
-  };
+    #endregion
 
+    #region Places enum
+    public enum Places
+    {
+      Normal,
+      Motd,
+      Channel,
+      Battle,
+      MessageBox,
+      Broadcast,
+      Game
+    }
+    #endregion
 
-  public class TasSayEventArgs : EventArgs
-  {
-    public enum Origins { Server, Player }
-    public enum Places { Normal, Motd, Channel, Battle, MessageBox, Broadcast, Game }
-
     public static TasSayEventArgs Default = new TasSayEventArgs(Origins.Player, Places.Battle, &quot;&quot;, &quot;&quot;, &quot;&quot;, false);
+    private string channel;
+    private bool isEmote;
 
-    Origins origin;
-    Places place;
-    string text;
-    bool isEmote;
-    string userName;
-    string channel;
+    private Origins origin;
+    private Places place;
+    private string text;
+    private string userName;
 
+    public TasSayEventArgs(Origins origin, Places place, string channel, string username, string text, bool isEmote)
+    {
+      this.origin = origin;
+      this.place = place;
+      userName = username;
+      this.text = text;
+      this.isEmote = isEmote;
+      this.channel = channel;
+    }
+
     public string Channel
     {
       get { return channel; }
@@ -117,6 +145,7 @@
       get { return isEmote; }
       set { isEmote = value; }
     }
+
     public Origins Origin
     {
       get { return origin; }
@@ -140,30 +169,11 @@
       get { return userName; }
       set { userName = value; }
     }
+  } ;
 
-
-    public TasSayEventArgs(Origins origin, Places place, string channel, string username, string text, bool isEmote)
-    {
-      this.origin = origin;
-      this.place = place;
-      this.userName = username;
-      this.text = text;
-      this.isEmote = isEmote;
-      this.channel = channel;
-    }
-
-  };
-
   public class TasClientException : Exception
   {
-    public TasClientException() { }
-    public TasClientException(string message)
-      : base(message)
-    {
-    }
-  };
-
-
-
-
-}
+    public TasClientException() {}
+    public TasClientException(string message) : base(message) {}
+  } ;
+}
\ No newline at end of file

Modified: trunk/tools/springie/Springie/client/UserBattleStatus.cs
===================================================================
--- trunk/tools/springie/Springie/client/UserBattleStatus.cs	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/client/UserBattleStatus.cs	2008-04-07 18:57:09 UTC (rev 5677)
@@ -1,6 +1,3 @@
-using System;
-using System.Collections.Generic;
-using System.Text;
 using System.Net;
 
 namespace Springie.Client
@@ -14,29 +11,29 @@
 
   public struct UserBattleStatus
   {
-    public string name;
-    public bool IsReady;
-    public int TeamNumber;
     public int AllyNumber;
+    public IPAddress ip;
+    public bool IsReady;
     public bool IsSpectator;
-    public SyncStatuses SyncStatus;
+    public string name;
+    public int port;
     public int Side;
+    public SyncStatuses SyncStatus;
     public int TeamColor;
-    public IPAddress ip;
-    public int port;
+    public int TeamNumber;
 
     public UserBattleStatus(string name)
     {
       this.name = name;
-      this.IsReady = false;
-      this.TeamNumber = 0;
-      this.AllyNumber = 0;
-      this.IsSpectator = false;
-      this.SyncStatus = SyncStatuses.Unknown;
-      this.Side = 0;
-      this.TeamColor = 0;
-      this.port = 0;
-      this.ip = IPAddress.None;
+      IsReady = false;
+      TeamNumber = 0;
+      AllyNumber = 0;
+      IsSpectator = false;
+      SyncStatus = SyncStatuses.Unknown;
+      Side = 0;
+      TeamColor = 0;
+      port = 0;
+      ip = IPAddress.None;
     }
 
     public void SetFrom(int status, int color, string name)
@@ -55,5 +52,5 @@
       Side = (status &gt;&gt; 24) &amp; 15;
       TeamColor = color;
     }
-  };
-}
+  } ;
+}
\ No newline at end of file

Modified: trunk/tools/springie/Springie/doc/devlog.txt
===================================================================
--- trunk/tools/springie/Springie/doc/devlog.txt	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/doc/devlog.txt	2008-04-07 18:57:09 UTC (rev 5677)
@@ -4,7 +4,8 @@
 * added !notify command - notified user when game ends
 * added perform list (can be part of preset), enables you to set mod options or boxes in easy way
 * added option to allow people join while in game
-
+* uf linked changed to jobjol site
+* ladder updated to new site
  
 
 ===============

Modified: trunk/tools/springie/Springie/spring/ConfigMaker.cs
===================================================================
--- trunk/tools/springie/Springie/spring/ConfigMaker.cs	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/spring/ConfigMaker.cs	2008-04-07 18:57:09 UTC (rev 5677)
@@ -1,7 +1,7 @@
-using System;
 using System.Collections.Generic;
-using System.Text;
+using System.Globalization;
 using System.IO;
+using System.Text;
 using System.Threading;
 using Springie.Client;
 
@@ -9,9 +9,10 @@
 {
   public class ConfigMaker
   {
-    public static void Generate(string filename, Battle b, out List&lt;Battle.GrPlayer&gt; players) {
-      Thread.CurrentThread.CurrentCulture = System.Globalization.CultureInfo.InvariantCulture; 
-      
+    public static void Generate(string filename, Battle b, out List&lt;Battle.GrPlayer&gt; players)
+    {
+      Thread.CurrentThread.CurrentCulture = CultureInfo.InvariantCulture;
+
       StringBuilder s = new StringBuilder();
 
       s.AppendLine(&quot;[GAME]&quot;);
@@ -45,42 +46,39 @@
       s.AppendFormat(&quot;  NumTeams={0};\n&quot;, teams.Count);
       s.AppendFormat(&quot;  NumAllyTeams={0};\n&quot;, alliances.Count);
       s.AppendLine();
-      
+
       // PLAYERS
-      for (int i = 0; i &lt; players.Count ; ++i) {
+      for (int i = 0; i &lt; players.Count; ++i) {
         UserBattleStatus u = players[i].user;
         s.AppendFormat(&quot;  [PLAYER{0}]\n&quot;, i);
         s.AppendLine(&quot;  {&quot;);
         s.AppendFormat(&quot;     name={0};\n&quot;, u.name);
         s.AppendFormat(&quot;     Spectator={0};\n&quot;, u.IsSpectator ? 1 : 0);
-        if (!u.IsSpectator) {
-          s.AppendFormat(&quot;     team={0};\n&quot;, u.TeamNumber);
-        }
+        if (!u.IsSpectator) s.AppendFormat(&quot;     team={0};\n&quot;, u.TeamNumber);
         s.AppendLine(&quot;  }&quot;);
       }
 
       // TEAMS
       s.AppendLine();
-      for (int i = 0 ; i &lt; teams.Count; ++i) {
+      for (int i = 0; i &lt; teams.Count; ++i) {
         s.AppendFormat(&quot;  [TEAM{0}]\n&quot;, i);
         s.AppendLine(&quot;  {&quot;);
         s.AppendFormat(&quot;     TeamLeader={0};\n&quot;, teams[i].leader);
         UserBattleStatus u = players[teams[i].leader].user;
         s.AppendFormat(&quot;     AllyTeam={0};\n&quot;, u.AllyNumber);
-        s.AppendFormat(&quot;     RGBColor={0:F5} {1:F5} {2:F5};\n&quot;, (u.TeamColor &amp; 255) / 255.0, ((u.TeamColor &gt;&gt; 8) &amp; 255) / 255.0, ((u.TeamColor &gt;&gt; 16) &amp; 255) / 255.0);
+        s.AppendFormat(&quot;     RGBColor={0:F5} {1:F5} {2:F5};\n&quot;, (u.TeamColor &amp; 255)/255.0, ((u.TeamColor &gt;&gt; 8) &amp; 255)/255.0, ((u.TeamColor &gt;&gt; 16) &amp; 255)/255.0);
         s.AppendFormat(&quot;     Side={0};\n&quot;, b.Mod.Sides[u.Side]);
         s.AppendFormat(&quot;     Handicap={0};\n&quot;, 0);
         s.AppendLine(&quot;  }&quot;);
       }
 
-
       // ALLYS
       s.AppendLine();
       for (int i = 0; i &lt; alliances.Count; ++i) {
         s.AppendFormat(&quot;[ALLYTEAM{0}]\n&quot;, i);
         s.AppendLine(&quot;{&quot;);
         s.AppendFormat(&quot;     NumAllies={0};\n&quot;, 0);
-        double left,top,right,bottom;
+        double left, top, right, bottom;
         alliances[i].rect.ToFractions(out left, out top, out right, out bottom);
         s.AppendFormat(&quot;     StartRectLeft={0};\n&quot;, left);
         s.AppendFormat(&quot;     StartRectTop={0};\n&quot;, top);
@@ -93,7 +91,7 @@
       s.AppendFormat(&quot;  NumRestrictions={0};\n&quot;, b.DisabledUnits.Count);
       s.AppendLine(&quot;  [RESTRICT]&quot;);
       s.AppendLine(&quot;  {&quot;);
-      for (int i = 0; i &lt; b.DisabledUnits.Count ; ++i) {
+      for (int i = 0; i &lt; b.DisabledUnits.Count; ++i) {
         s.AppendFormat(&quot;    Unit{0}={1};\n&quot;, i, b.DisabledUnits[i]);
         s.AppendFormat(&quot;    Limit{0}=0;\n&quot;, i);
       }
@@ -101,23 +99,19 @@
 
       s.AppendLine(&quot;  [modoptions]&quot;);
       s.AppendLine(&quot;  {&quot;);
-      foreach(UnitSync.Option o in b.Mod.Options) {
+      foreach (UnitSync.Option o in b.Mod.Options) {
         string v = o.Default;
         if (b.ModOptions.ContainsKey(o.Key)) v = b.ModOptions[o.Key];
-        s.AppendFormat(&quot;    {0}={1};\n&quot;,  o.Key, v);
+        s.AppendFormat(&quot;    {0}={1};\n&quot;, o.Key, v);
       }
       s.AppendLine(&quot;  }&quot;);
 
-
-
       s.AppendLine(&quot;}&quot;);
 
       StreamWriter f = File.CreateText(filename);
       f.Write(s.ToString());
       f.Flush();
       f.Close();
-      
-
     }
   }
-}
+}
\ No newline at end of file

Modified: trunk/tools/springie/Springie/spring/Spring.cs
===================================================================
--- trunk/tools/springie/Springie/spring/Spring.cs	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/spring/Spring.cs	2008-04-07 18:57:09 UTC (rev 5677)
@@ -1,69 +1,94 @@
 using System;
 using System.Collections.Generic;
-using System.Text;
-using System.IO;
 using System.Diagnostics;
+using System.IO;
 using System.Threading;
 using Microsoft.Win32;
-using System.Timers;
 using Springie.Client;
 
 namespace Springie.SpringNamespace
 {
   public class SpringLogEventArgs : EventArgs
   {
-    string username;
-    public string Username { get { return username; } }
+    private List&lt;string&gt; args = new List&lt;string&gt;();
+    private string line;
+    private string username;
 
-    string line;
-    public string Line { get { return line; } }
+    public SpringLogEventArgs(string username, string line)
+    {
+      this.line = line;
+      this.username = username;
+    }
 
-    List&lt;string&gt; args = new List&lt;string&gt;();
-    public List&lt;string&gt; Args
+    public string Username
     {
-      get { return args; }
+      get { return username; }
     }
 
-    public SpringLogEventArgs(string username, string line)
+    public string Line
     {
-      this.line = line;
-      this.username = username;
+      get { return line; }
     }
-  };
 
+    public List&lt;string&gt; Args
+    {
+      get { return args; }
+    }
+  } ;
+
   /// &lt;summary&gt;
   /// represents one install location of spring game
   /// &lt;/summary&gt;
   public class Spring : IDisposable
   {
-    public event EventHandler&lt;SpringLogEventArgs&gt; PlayerSaid;
-    public event EventHandler&lt;SpringLogEventArgs&gt; PlayerJoined;
-    public event EventHandler&lt;SpringLogEventArgs&gt; PlayerLeft;
-    public event EventHandler&lt;SpringLogEventArgs&gt; PlayerDisconnected;
-    public event EventHandler&lt;SpringLogEventArgs&gt; PlayerLost; // player lost the game
-    public event EventHandler&lt;SpringLogEventArgs&gt; GameOver; // game has ended
-
-    public event EventHandler SpringExited;
-    public event EventHandler SpringStarted;
-
     public const string ExecutableName = &quot;spring.exe&quot;;
     public const string InfoLogName = &quot;infolog.txt&quot;;
-    public const int MaxTeams = 32;
     public const int MaxAllies = 10;
-    const string PathDivider = &quot;/&quot;;
+    public const int MaxTeams = 32;
+    private const string PathDivider = &quot;/&quot;;
+    private const string springRegistryKey = &quot;HKEY_CURRENT_USER\\Software\\SJ\\spring&quot;;
+    private int fullScreen;
+    private DateTime gameStarted;
+    private int luaUi;
+    private Thread outputReader;
 
-    Talker talker;
-    string path;
-    public string Path { get { return path; } }
-    Process process;
+    private string path;
 
-    List&lt;Battle.GrPlayer&gt; players;
+    private List&lt;Battle.GrPlayer&gt; players;
+    private Process process;
 
-    bool springWindowHidden = true;
+    private bool springWindowHidden = true;
+    private Talker talker;
+    private UnitSync unitSync;
+    private int xResolution;
+    private int yResolution;
+
+    public Spring(string path)
+    {
+      if (string.IsNullOrEmpty(path)) path = Directory.GetCurrentDirectory();
+
+      if (!path.EndsWith(PathDivider)) path += PathDivider; // ensure that path ends with \\
+      this.path = path;
+
+      if (!File.Exists(path + ExecutableName)) throw new Exception(ExecutableName + &quot; not found in &quot; + path);
+
+      // init unitsync and load basic info
+      unitSync = new UnitSync(path);
+    }
+
+    public string Path
+    {
+      get { return path; }
+    }
+
     public bool SpringWindowHidden
     {
       get { return springWindowHidden; }
-      set { springWindowHidden = value; UpdateSpringVisibility(); }
+      set
+      {
+        springWindowHidden = value;
+        UpdateSpringVisibility();
+      }
     }
 
     public ProcessPriorityClass ProcessPriority
@@ -73,51 +98,40 @@
         if (IsRunning) return process.PriorityClass;
         else return Program.main.config.HostingProcessPriority;
       }
-      set
-      {
-        if (IsRunning) {
-          process.PriorityClass = value;
-        }
-      }
-
+      set { if (IsRunning) process.PriorityClass = value; }
     }
 
 
-
     public bool IsRunning
     {
-      get
-      {
-        return (process != null &amp;&amp; process.MainWindowHandle != IntPtr.Zero &amp;&amp; !process.HasExited);
-      }
+      get { return (process != null &amp;&amp; process.MainWindowHandle != IntPtr.Zero &amp;&amp; !process.HasExited); }
     }
-    DateTime gameStarted;
+
     public DateTime GameStarted
     {
       get { return gameStarted; }
     }
 
-    UnitSync unitSync;
     public UnitSync UnitSync
     {
       get { return unitSync; }
     }
-    Thread outputReader;
 
-    public Spring(string path)
-    {
-      if (string.IsNullOrEmpty(path)) path = Directory.GetCurrentDirectory();
+    #region IDisposable Members
+    public void Dispose() {}
+    #endregion
 
-      if (!path.EndsWith(PathDivider)) path += PathDivider; // ensure that path ends with \\
-      this.path = path;
+    public event EventHandler&lt;SpringLogEventArgs&gt; PlayerSaid;
+    public event EventHandler&lt;SpringLogEventArgs&gt; PlayerJoined;
+    public event EventHandler&lt;SpringLogEventArgs&gt; PlayerLeft;
+    public event EventHandler&lt;SpringLogEventArgs&gt; PlayerDisconnected;
+    public event EventHandler&lt;SpringLogEventArgs&gt; PlayerLost; // player lost the game
+    public event EventHandler&lt;SpringLogEventArgs&gt; GameOver; // game has ended
 
-      if (!File.Exists(path + ExecutableName)) throw new Exception(ExecutableName + &quot; not found in &quot; + path);
+    public event EventHandler SpringExited;
+    public event EventHandler SpringStarted;
 
-      // init unitsync and load basic info
-      unitSync = new UnitSync(path);
-    }
 
-
     /// &lt;summary&gt;
     /// Reloads map and or mod list
     /// &lt;/summary&gt;
@@ -132,15 +146,13 @@
     public void StartGame(Battle battle)
     {
       if (!IsRunning) {
-
         ConfigMaker.Generate(path + &quot;springie.txt&quot;, battle, out players);
 
         process = new Process();
         process.StartInfo.CreateNoWindow = true;
 
-        if (Program.main.config.SpringStartsMinimized) {
-          process.StartInfo.Arguments = &quot;/minimise &quot;;
-        } else process.StartInfo.Arguments = &quot;&quot;;
+        if (Program.main.config.SpringStartsMinimized) process.StartInfo.Arguments = &quot;/minimise &quot;;
+        else process.StartInfo.Arguments = &quot;&quot;;
         process.StartInfo.Arguments += &quot;springie.txt&quot;;
 
         process.StartInfo.RedirectStandardOutput = true;
@@ -148,7 +160,7 @@
         process.StartInfo.FileName = path + ExecutableName;
         process.StartInfo.UseShellExecute = false;
         process.Exited += new EventHandler(springProcess_Exited);
-        
+
         Thread.Sleep(2000); // give time to user's spring to start and ignore upcoming registry hax
         PrepareRegistry();
         process.Start();
@@ -163,9 +175,9 @@
 
         RestoreRegistry();
         if (IsRunning &amp;&amp; SpringStarted != null) SpringStarted(this, EventArgs.Empty);
-        
+
         SpringWindowHidden = Program.main.config.SpringStartsHidden;
-        System.Threading.Thread.Sleep(1000);
+        Thread.Sleep(1000);
         ProcessPriority = Program.main.config.HostingProcessPriority;
       }
     }
@@ -193,26 +205,25 @@
       if (l.StartsWith(&quot;Player&quot;)) {
         words = l.Split(' ');
         if (l.Length &gt; 2) {
-          if (words[2] == &quot;joined&quot;) { // player joined
+          if (words[2] == &quot;joined&quot;) {
+            // player joined
             if (PlayerJoined != null) PlayerJoined(this, new SpringLogEventArgs(words[1], l));
-          } else if (words[2] == &quot;left&quot;) { // player left
+          } else if (words[2] == &quot;left&quot;) {
+            // player left
             if (PlayerLeft != null) PlayerLeft(this, new SpringLogEventArgs(words[1], l));
           }
         }
-      } else if (l[0] == '&lt;') { // player said something
-        words = l.Split(new char[] { '&lt;', '&gt;', ' ' }, 2, StringSplitOptions.RemoveEmptyEntries);
+      } else if (l[0] == '&lt;') {
+        // player said something
+        words = l.Split(new char[] {'&lt;', '&gt;', ' '}, 2, StringSplitOptions.RemoveEmptyEntries);
         if (PlayerSaid != null &amp;&amp; words.Length &gt; 1) PlayerSaid(this, new SpringLogEventArgs(words[0], words[1]));
-
-      } else if (l.StartsWith(&quot;Lost connection to&quot;)) { // lost connection to player
+      } else if (l.StartsWith(&quot;Lost connection to&quot;)) {
+        // lost connection to player
         words = l.Split(' ');
-        if (words.Length &gt; 3) {
-          if (PlayerDisconnected != null) PlayerDisconnected(this, new SpringLogEventArgs(words[3], l));
-        }
+        if (words.Length &gt; 3) if (PlayerDisconnected != null) PlayerDisconnected(this, new SpringLogEventArgs(words[3], l));
       } else if (l.StartsWith(&quot;Team&quot;)) {
-        words = l.Split(new char[] { '(', ')' });
-        if (words.Length &gt; 1) {
-          if (PlayerLost != null) PlayerLost(this, new SpringLogEventArgs(words[1], l));
-        }
+        words = l.Split(new char[] {'(', ')'});
+        if (words.Length &gt; 1) if (PlayerLost != null) PlayerLost(this, new SpringLogEventArgs(words[1], l));
       } else if (l == &quot;Game over&quot;) {
         string luser = &quot;&quot;;
         SpringLogEventArgs e = new SpringLogEventArgs(luser, l);
@@ -271,7 +282,7 @@
       SayGame(&quot;.kick &quot; + name);
     }
 
-    void springProcess_Exited(object sender, EventArgs e)
+    private void springProcess_Exited(object sender, EventArgs e)
     {
       process = null;
       talker.Close();
@@ -280,11 +291,6 @@
     }
 
     //int soundVolume;
-    int xResolution;
-    int yResolution;
-    int fullScreen;
-    int luaUi;
-    const string springRegistryKey = &quot;HKEY_CURRENT_USER\\Software\\SJ\\spring&quot;;
     private void PrepareRegistry()
     {
       //soundVolume = (int)Registry.GetValue(springRegistryKey, &quot;SoundVolume&quot;, 0);
@@ -320,16 +326,9 @@
     private void UpdateSpringVisibility()
     {
       if (IsRunning) {
-        if (springWindowHidden) Talker.ShowWindow(process.MainWindowHandle, Talker.SW_HIDE); else Talker.ShowWindow(process.MainWindowHandle, Talker.SW_NORMAL);
+        if (springWindowHidden) Talker.ShowWindow(process.MainWindowHandle, Talker.SW_HIDE);
+        else Talker.ShowWindow(process.MainWindowHandle, Talker.SW_NORMAL);
       }
     }
-
-    #region IDisposable Members
-
-    public void Dispose()
-    {
-    }
-
-    #endregion
   }
-}
+}
\ No newline at end of file

Modified: trunk/tools/springie/Springie/spring/Talker.cs
===================================================================
--- trunk/tools/springie/Springie/spring/Talker.cs	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/spring/Talker.cs	2008-04-07 18:57:09 UTC (rev 5677)
@@ -1,98 +1,97 @@
 using System;
-using System.Runtime.InteropServices;
 using System.Collections.Generic;
-using System.Threading;
 using System.Diagnostics;
+using System.Runtime.InteropServices;
+using System.Threading;
 
 namespace Springie.SpringNamespace
 {
   /// &lt;summary&gt;
   /// Class for sending keyboard related windows commands
   /// &lt;/summary&gt;
-  class Talker : IDisposable
+  internal class Talker : IDisposable
   {
-    [DllImport(&quot;User32.Dll&quot;)]
-    public static extern IntPtr FindWindow(String className, String windowName);
+    public const int FL_CTRL = 1 &lt;&lt; 9;
 
-    [DllImport(&quot;User32.Dll&quot;)]
-    public static extern IntPtr FindWindowEx(IntPtr hwndParent, IntPtr hwndChildAfter, string lpszClass, string lpszWindow);
+    /// &lt;summary&gt;
+    /// flag to be added to scan code to simulate shift+key
+    /// &lt;/summary&gt;
+    public const int FL_SHIFT = 1 &lt;&lt; 8;
 
+    public const int SW_FORCEMINIMIZE = 11;
 
-    [DllImport(&quot;User32.Dll&quot;)]
-    public static extern bool PostMessage(IntPtr hWnd, int msg, int wParam, int lParam);
-
-    [DllImport(&quot;User32.Dll&quot;)]
-    public static extern bool ShowWindow(IntPtr hWnd, int nCmdShow);
     public const int SW_HIDE = 0;
-    public const int SW_SHOWNORMAL = 1;
-    public const int SW_NORMAL = 1;
-    public const int SW_SHOWMINIMIZED = 2;
-    public const int SW_SHOWMAXIMIZED = 3;
+    public const int SW_MAX = 11;
     public const int SW_MAXIMIZE = 3;
-    public const int SW_SHOWNOACTIVATE = 4;
-    public const int SW_SHOW = 5;
     public const int SW_MINIMIZE = 6;
-    public const int SW_SHOWMINNOACTIVE = 7;
-    public const int SW_SHOWNA = 8;
+    public const int SW_NORMAL = 1;
     public const int SW_RESTORE = 9;
+    public const int SW_SHOW = 5;
     public const int SW_SHOWDEFAULT = 10;
-    public const int SW_FORCEMINIMIZE = 11;
-    public const int SW_MAX = 11;
-
-
-
-
-    /// &lt;summary&gt;
-    /// transforms char to scan code
-    /// &lt;/summary&gt;
-    /// &lt;param name=&quot;ch&quot;&gt;char&lt;/param&gt;
-    /// &lt;returns&gt;scan code (one byte actually)&lt;/returns&gt;
-    [DllImport(&quot;User32.Dll&quot;)]
-    public static extern int VkKeyScan(char ch);
-
-
-    public const int VK_ESC = 0x1B;
+    public const int SW_SHOWMAXIMIZED = 3;
+    public const int SW_SHOWMINIMIZED = 2;
+    public const int SW_SHOWMINNOACTIVE = 7;
+    public const int SW_SHOWNA = 8;
+    public const int SW_SHOWNOACTIVATE = 4;
+    public const int SW_SHOWNORMAL = 1;
+    public const int VK_CONTROL = 17;
     public const int VK_ENTER = 0x0D;
+    public const int VK_ESC = 0x1B;
     public const int VK_LSHIFT = 0xA0;
     public const int VK_RCONTROL = 0xA3;
-    public const int VK_CONTROL = 17;
+    private const int WM_CHAR = 0x0102;
+    private const int WM_KEYDOWN = 0x0100;
+    private const int WM_KEYUP = 0x0101;
+    private bool exitThread = false;
 
+    private Queue&lt;Message&gt; messageQueue = new Queue&lt;Message&gt;();
+    private object myLock = new object();
+    private Process process;
+    private Semaphore semaphore = new Semaphore(0, int.MaxValue);
+    private Thread senderThread;
+    private IntPtr target = new IntPtr();
+
     /// &lt;summary&gt;
-    /// flag to be added to scan code to simulate shift+key
+    /// Constructs Talker class
     /// &lt;/summary&gt;
-    public const int FL_SHIFT = 1 &lt;&lt; 8;
-    public const int FL_CTRL = 1 &lt;&lt; 9;
+    /// &lt;param name=&quot;targetHandle&quot;&gt;Handle to target window&lt;/param&gt;
+    public Talker(Process process)
+    {
+      this.process = process;
+      target = process.MainWindowHandle;
+      senderThread = new Thread(new ParameterizedThreadStart(ExecuteMessages));
+      senderThread.Name = &quot;Talker&quot;;
+      senderThread.Start(this);
+    }
 
+    #region IDisposable Members
+    public void Dispose()
+    {
+      Close();
+    }
+    #endregion
 
+    [DllImport(&quot;User32.Dll&quot;)]
+    public static extern IntPtr FindWindow(String className, String windowName);
 
-    private IntPtr target = new IntPtr();
-    const int WM_KEYDOWN = 0x0100;
-    const int WM_KEYUP = 0x0101;
-    const int WM_CHAR = 0x0102;
+    [DllImport(&quot;User32.Dll&quot;)]
+    public static extern IntPtr FindWindowEx(IntPtr hwndParent, IntPtr hwndChildAfter, string lpszClass, string lpszWindow);
 
 
-    class Message
-    {
-      public int message;
-      public int lparam;
-      public int wparam;
-      public IntPtr target;
-      public Message(IntPtr target, int message, int lparam, int wparam)
-      {
-        this.target = target;
-        this.message = message;
-        this.lparam = lparam;
-        this.wparam = wparam;
-      }
-    };
+    [DllImport(&quot;User32.Dll&quot;)]
+    public static extern bool PostMessage(IntPtr hWnd, int msg, int wParam, int lParam);
 
-    Queue&lt;Message&gt; messageQueue = new Queue&lt;Message&gt;();
-    Semaphore semaphore = new Semaphore(0, int.MaxValue);
-    bool exitThread = false;
-    Thread senderThread;
-    Process process;
-    object myLock = new object();
+    [DllImport(&quot;User32.Dll&quot;)]
+    public static extern bool ShowWindow(IntPtr hWnd, int nCmdShow);
 
+    /// &lt;summary&gt;
+    /// transforms char to scan code
+    /// &lt;/summary&gt;
+    /// &lt;param name=&quot;ch&quot;&gt;char&lt;/param&gt;
+    /// &lt;returns&gt;scan code (one byte actually)&lt;/returns&gt;
+    [DllImport(&quot;User32.Dll&quot;)]
+    public static extern int VkKeyScan(char ch);
+
     private void AddMessage(IntPtr target, int mess, int lparam, int wparam)
     {
       lock (myLock) {
@@ -155,19 +154,6 @@
       }
     }
 
-    /// &lt;summary&gt;
-    /// Constructs Talker class
-    /// &lt;/summary&gt;
-    /// &lt;param name=&quot;targetHandle&quot;&gt;Handle to target window&lt;/param&gt;
-    public Talker(Process process)
-    {
-      this.process = process;
-      target = process.MainWindowHandle;
-      senderThread = new Thread(new ParameterizedThreadStart(ExecuteMessages));
-      senderThread.Name = &quot;Talker&quot;;
-      senderThread.Start(this);
-    }
-
     public void Close()
     {
       exitThread = true;
@@ -175,14 +161,22 @@
       senderThread.Join();
     }
 
-
-    #region IDisposable Members
-
-    public void Dispose()
+    #region Nested type: Message
+    private class Message
     {
-      Close();
-    }
+      public int lparam;
+      public int message;
+      public IntPtr target;
+      public int wparam;
 
+      public Message(IntPtr target, int message, int lparam, int wparam)
+      {
+        this.target = target;
+        this.message = message;
+        this.lparam = lparam;
+        this.wparam = wparam;
+      }
+    } ;
     #endregion
   }
-}
+}
\ No newline at end of file

Modified: trunk/tools/springie/Springie/spring/UnitSync.cs
===================================================================
--- trunk/tools/springie/Springie/spring/UnitSync.cs	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/spring/UnitSync.cs	2008-04-07 18:57:09 UTC (rev 5677)
@@ -1,31 +1,29 @@
 using System;
 using System.Collections.Generic;
-using System.Text;
+using System.ComponentModel;
+using System.Globalization;
+using System.IO;
 using System.Runtime.InteropServices;
-using System.IO;
-using System.ComponentModel;
+using System.Threading;
+using Springie.Client;
 
 namespace Springie.SpringNamespace
 {
-  class UnitConverter : StringConverter
+  internal class UnitConverter : StringConverter
   {
     public override bool GetStandardValuesSupported(ITypeDescriptorContext context)
     {
       return true;
     }
 
-    public override object ConvertFrom(ITypeDescriptorContext context, System.Globalization.CultureInfo culture, object value)
+    public override object ConvertFrom(ITypeDescriptorContext context, CultureInfo culture, object value)
     {
       string tofind = value.ToString().Split(' ')[0];
-      foreach (UnitInfo u in GetMod().Units) {
-        if (u.Name == tofind) {
-          return u;
-        }
-      }
+      foreach (UnitInfo u in GetMod().Units) if (u.Name == tofind) return u;
       return null;
     }
 
-    public override object ConvertTo(ITypeDescriptorContext context, System.Globalization.CultureInfo culture, object value, Type destinationType)
+    public override object ConvertTo(ITypeDescriptorContext context, CultureInfo culture, object value, Type destinationType)
     {
       if (destinationType == typeof(String)) {
         if (value == null) return null;
@@ -44,35 +42,31 @@
     private ModInfo GetMod()
     {
       if (Program.main.Tas != null) {
-        Client.Battle b = Program.main.Tas.GetBattle();
+        Battle b = Program.main.Tas.GetBattle();
         if (b != null) return b.Mod;
       }
       return Program.main.Spring.UnitSync.GetModInfo(Program.main.AutoHost.config.DefaultMod);
     }
-
-
   }
 
 
   [TypeConverter(typeof(UnitConverter))]
   public struct UnitInfo
   {
+    public string FullName;
     public string Name;
-    public string FullName;
 
 
     public UnitInfo(string name, string fullName)
     {
-      this.Name = name;
-      this.FullName = fullName;
+      Name = name;
+      FullName = fullName;
     }
 
     public static string[] ToStringList(UnitInfo[] src)
     {
       string[] result = new string[src.Length];
-      for (int i = 0; i &lt; src.Length; ++i) {
-        result[i] = src[i].Name;
-      }
+      for (int i = 0; i &lt; src.Length; ++i) result[i] = src[i].Name;
       return result;
     }
 
@@ -81,32 +75,41 @@
       List&lt;UnitInfo&gt; result = new List&lt;UnitInfo&gt;();
       for (int i = 0; i &lt; src.Length; ++i) {
         UnitInfo u;
-        if (mod.GetUnitInfo(src[i], out u)) {
-          result.Add(u);
-        }
+        if (mod.GetUnitInfo(src[i], out u)) result.Add(u);
       }
       return result.ToArray();
     }
   }
 
 
-
-
-
   /// &lt;summary&gt;
   /// Represents one mod. Detailed information are loaded on demand for given mod.
   /// &lt;/summary&gt;
   public class ModInfo
   {
+    protected string archiveName;
+    private int checksum;
+    private bool loaded = false;
+    private int modId = -1;
+    private object myLock = new object();
+    private string name;
     public List&lt;UnitSync.Option&gt; Options = new List&lt;UnitSync.Option&gt;();
+    private string[] sides;
+    private UnitInfo[] units;
+    private UnitSync unitSync = null;
 
-    string name;
+    public ModInfo(UnitSync owner, string name, int modId)
+    {
+      unitSync = owner;
+      this.name = name;
+      this.modId = modId;
+    }
+
     public string Name
     {
       get { return name; }
     }
 
-    protected string archiveName;
     public string ArchiveName
     {
       get
@@ -117,39 +120,39 @@
       set { archiveName = value; }
     }
 
-    private int checksum;
     public int Checksum
     {
-      get { CheckLoaded(); return checksum; }
+      get
+      {
+        CheckLoaded();
+        return checksum;
+      }
       set { checksum = value; }
     }
 
-    private string[] sides;
     public string[] Sides
     {
-      get { CheckLoaded(); return sides; }
+      get
+      {
+        CheckLoaded();
+        return sides;
+      }
       set { sides = value; }
     }
 
-    private UnitInfo[] units;
     public UnitInfo[] Units
     {
-      get { CheckLoaded(); return units; }
+      get
+      {
+        CheckLoaded();
+        return units;
+      }
       set { units = value; }
     }
 
-    UnitSync unitSync = null;
-    bool loaded = false;
-    int modId = -1;
-    public int ModId { get { return modId; } }
-    private object myLock = new object();
-
-
-    public ModInfo(UnitSync owner, string name, int modId)
+    public int ModId
     {
-      unitSync = owner;
-      this.name = name;
-      this.modId = modId;
+      get { return modId; }
     }
 
 
@@ -167,7 +170,6 @@
 
     private void CheckLoaded()
     {
-
       if (!loaded &amp;&amp; unitSync != null) {
         lock (myLock) {
           loaded = true;
@@ -180,46 +182,56 @@
     {
       return name;
     }
-  };
+  } ;
 
 
+  public class MapInfo
+  {
+    protected string archiveName;
 
+    private int checksum;
+    private bool loaded = false;
+    private int mapId = -1;
+    private object myLock = new object();
+    private string name;
+    private UnitSync unitSync = null;
 
-  public class MapInfo
-  {
-    string name;
+
+    public MapInfo(UnitSync owner, string name, int mapId)
+    {
+      unitSync = owner;
+      this.name = name;
+      this.mapId = mapId;
+    }
+
     public string Name
     {
       get { return name; }
     }
 
-    protected string archiveName;
     public string ArchiveName
     {
-      get { CheckLoaded(); return archiveName; }
+      get
+      {
+        CheckLoaded();
+        return archiveName;
+      }
       set { archiveName = value; }
     }
 
-    private int checksum;
     public int Checksum
     {
-      get { CheckLoaded(); return checksum; }
+      get
+      {
+        CheckLoaded();
+        return checksum;
+      }
       set { checksum = value; }
     }
 
-
-    UnitSync unitSync = null;
-    bool loaded = false;
-    int mapId = -1;
-    public int MapId { get { return mapId; } }
-    private object myLock = new object();
-
-
-    public MapInfo(UnitSync owner, string name, int mapId)
+    public int MapId
     {
-      unitSync = owner;
-      this.name = name;
-      this.mapId = mapId;
+      get { return mapId; }
     }
 
     private void CheckLoaded()
@@ -236,177 +248,55 @@
     {
       return name;
     }
-  };
+  } ;
 
 
   public class UnitSync : IDisposable
   {
-    public struct ListOption
-    {
-      public string Name;
-      public string Description;
-      public string Key;
-      public ListOption(int optionIndex, int itemIndex)
-      {
-        Name = GetOptionListItemName(optionIndex, itemIndex);
-        Description = GetOptionListItemDesc(optionIndex, itemIndex);
-        Key = GetOptionListItemKey(optionIndex, itemIndex);
-      }
-    }
+    private Dictionary&lt;string, MapInfo&gt; mapList = new Dictionary&lt;string, MapInfo&gt;();
+    private Dictionary&lt;string, ModInfo&gt; modList = new Dictionary&lt;string, ModInfo&gt;();
+    private string path;
+    public UnitSync() : this(Directory.GetCurrentDirectory()) {}
 
-    public class Option
+    public UnitSync(string path)
     {
-      public enum Type : int { Error = 0, Bool = 1, List = 2, Number = 3, String = 4 };
-      string Table = &quot;GAME\\MODOPTIONS\\&quot;;
-      public Type OptionType;
-      float min = float.MinValue, max = float.MinValue, step = 0, strMaxLen = 65535;
-      public List&lt;ListOption&gt; ListOptions = new List&lt;ListOption&gt;();
-
-      public string Name;
-      public string Key;
-      public string Description;
-      public string Default;
-
-      public Option(int idx) {
-        Name = GetOptionName(idx);
-        Key = GetOptionKey(idx);
-        Description = GetOptionDesc(idx);
-        OptionType = (Type)GetOptionType(idx);
-        strMaxLen = GetOptionStringMaxLen(idx);
-        min = GetOptionNumberMin(idx);
-        max = GetOptionNumberMax(idx);
-        step = GetOptionNumberStep(idx);
-        int listCount = GetOptionListCount(idx);
-        for (int i = 0; i &lt; listCount; i++) {
-          ListOption optl = new ListOption(idx, i);
-          ListOptions.Add(optl);
-        }
-        switch (OptionType) {
-          case Type.Bool: Default = GetOptionBoolDef(idx).ToString();
-            break;
-          case Type.Number: Default = GetOptionNumberDef(idx).ToString();
-            break;
-          case Type.String: Default = GetOptionStringDef(idx);
-            break;
-          case Type.List: Default = GetOptionListDef(idx);
-            break;
-        }
-      }
-
-      private string ConstructLine(string val)
-      {
-        return Table + Key + &quot;=&quot; + val;
-      }
-
-      public bool GetPair(string Value, out string result)
-      {
-        result = &quot;&quot;;
-        switch (OptionType) {
-          case Type.Bool:
-            if (Value != &quot;0&quot; &amp;&amp; Value != &quot;1&quot;) return false;
-            result = ConstructLine(Value);
-            return true;
-
-          case Type.Number:
-            double d;
-            if (!double.TryParse(Value, out d)) return false;
-            if (d &lt; min || d &gt; max) return false;
-            result = ConstructLine(Value);
-            return true;
-
-
-          case Type.String:
-            if (Value.Length &gt; strMaxLen) return false;
-            result = ConstructLine(Value);
-            return true;
-
-
-          case Type.List:
-            foreach (ListOption lop in ListOptions) {
-              if (lop.Key == Value) {
-                result = ConstructLine(lop.Key);
-                return true;
-              }
-            }
-            return false;
-
-        }
-
-        return false;
-      }
-
-      public override string ToString()
-      {
-        string pom = &quot;&quot;;
-        string typs = &quot;&quot;;
-        if (OptionType == Type.Number) {
-          typs = &quot;x&quot;;
-          pom += &quot; = &quot;;
-          if (min != float.MinValue) pom += &quot; &gt;=&quot; + min;
-          if (max != float.MaxValue) pom += &quot; &lt;=&quot; + max;
-        }
-        if (OptionType == Type.List) {
-          pom += &quot; = &quot;;
-          foreach (ListOption lop in ListOptions) {
-            pom += lop.Key + &quot;-&quot; + lop.Description + &quot; | &quot;;
-            typs += lop.Key + &quot;|&quot;;
-          }
-        }
-        if (OptionType == Type.Bool) {
-          typs += &quot;0|1&quot;;
-        }
-        if (OptionType == Type.String) {
-          typs += &quot;s&quot;;
-        }
-
-
-        return string.Format(&quot;{0}={1}  ({2}{3})&quot;, Key, typs, Description, pom);
-
-      }
+      this.path = path;
+      string opath = Directory.GetCurrentDirectory();
+      Directory.SetCurrentDirectory(path);
+      if (Init(false, 0) != 1) throw new Exception(&quot;unitsync.dll init failed&quot;);
+      //if (InitArchiveScanner() != 1) throw new Exception(&quot;unitsync.dll:InitArchiveScanner() failed&quot;);
+      LoadModList();
+      LoadMapList();
+      Directory.SetCurrentDirectory(opath);
     }
 
-    public UnitSync() : this(Directory.GetCurrentDirectory()) { }
-
-    string path;
-
-    Dictionary&lt;string, ModInfo&gt; modList = new Dictionary&lt;string, ModInfo&gt;();
     public Dictionary&lt;string, ModInfo&gt; ModList
     {
       get { return modList; }
     }
 
 
-    Dictionary&lt;string, MapInfo&gt; mapList = new Dictionary&lt;string, MapInfo&gt;();
     public Dictionary&lt;string, MapInfo&gt; MapList
     {
       get { return mapList; }
     }
 
-
-    public UnitSync(string path)
+    #region IDisposable Members
+    public void Dispose()
     {
-      this.path = path;
-      string opath = Directory.GetCurrentDirectory();
-      Directory.SetCurrentDirectory(path);
-      if (Init(false, 0) != 1) throw new Exception(&quot;unitsync.dll init failed&quot;);
-      //if (InitArchiveScanner() != 1) throw new Exception(&quot;unitsync.dll:InitArchiveScanner() failed&quot;);
-      LoadModList();
-      LoadMapList();
-      Directory.SetCurrentDirectory(opath);
+      UnInit();
     }
+    #endregion
 
-
     /// &lt;summary&gt;
     /// Gets map list from unit sync, does not make full reinit by default
     /// &lt;/summary&gt;
     /// &lt;returns&gt;&lt;/returns&gt;
-    void LoadMapList()
+    private void LoadMapList()
     {
       string opath = Directory.GetCurrentDirectory();
       Directory.SetCurrentDirectory(path);
 
-
-
       int mapCount = GetMapCount();
       mapList.Clear();
       for (int i = 0; i &lt; mapCount; ++i) {
@@ -422,7 +312,7 @@
     /// Gets mod list - does not make full reinit by default
     /// &lt;/summary&gt;
     /// &lt;returns&gt;&lt;/returns&gt;
-    void LoadModList()
+    private void LoadModList()
     {
       string opath = Directory.GetCurrentDirectory();
       Directory.SetCurrentDirectory(path);
@@ -434,13 +324,12 @@
         ModInfo mi = new ModInfo(this, GetPrimaryModName(i), i);
         modList[mi.Name] = mi;
       }
-
     }
 
 
     internal void LoadModInfo(ModInfo mi)
     {
-      System.Threading.Thread.CurrentThread.CurrentCulture = System.Globalization.CultureInfo.InvariantCulture;
+      Thread.CurrentThread.CurrentCulture = CultureInfo.InvariantCulture;
       string opath = Directory.GetCurrentDirectory();
       Directory.SetCurrentDirectory(path);
       int i = mi.ModId;
@@ -462,16 +351,13 @@
 
       AddAllArchives(mi.ArchiveName);
       mi.Sides = new String[GetSideCount()];
-      for (int x = 0; x &lt; mi.Sides.Length; ++x) {
-        mi.Sides[x] = GetSideName(x);
-      }
+      for (int x = 0; x &lt; mi.Sides.Length; ++x) mi.Sides[x] = GetSideName(x);
 
       // weirdest stuff of all...
-      while (ProcessUnitsNoChecksum() != 0) { };
+      while (ProcessUnitsNoChecksum() != 0) {}
+      ;
       mi.Units = new UnitInfo[GetUnitCount()];
-      for (int x = 0; x &lt; mi.Units.Length; ++x) {
-        mi.Units[x] = new UnitInfo(GetUnitName(x), GetFullUnitName(x));
-      }
+      for (int x = 0; x &lt; mi.Units.Length; ++x) mi.Units[x] = new UnitInfo(GetUnitName(x), GetFullUnitName(x));
 
       int opts = GetModOptionCount();
       for (int x = 0; x &lt; opts; x++) {
@@ -500,9 +386,7 @@
 
       uint result = 0;
       int acount = GetMapArchiveCount(mi.Name);
-      for (int x = 0; x &lt; acount; ++x) {
-        result += GetArchiveChecksum(GetMapArchiveName(x));
-      }
+      for (int x = 0; x &lt; acount; ++x) result += GetArchiveChecksum(GetMapArchiveName(x));
       mi.Checksum = (int)result;
 
       Directory.SetCurrentDirectory(opath);
@@ -513,7 +397,7 @@
     /// ReInits unitsync
     /// &lt;/summary&gt;
     /// &lt;param name=&quot;full&quot;&gt;if true does complete reinit (neccesary to find new map or mod), if false does just archivescannerinit&lt;/param&gt;
-    void ReInit(bool full)
+    private void ReInit(bool full)
     {
       string opath = Directory.GetCurrentDirectory();
       Directory.SetCurrentDirectory(path);
@@ -530,7 +414,8 @@
 
     public string GetMapArchiveName(string mapname)
     {
-      if (mapList.ContainsKey(mapname)) return mapList[mapname].ArchiveName; else return &quot;&quot;;
+      if (mapList.ContainsKey(mapname)) return mapList[mapname].ArchiveName;
+      else return &quot;&quot;;
     }
 
     public bool HasMap(string name)
@@ -542,9 +427,7 @@
     {
       if (modList.ContainsKey(name)) return modList[name];
       else {
-        foreach (KeyValuePair&lt;string, ModInfo&gt; p in modList) {
-          if (p.Value.ArchiveName == name) return p.Value;
-        }
+        foreach (KeyValuePair&lt;string, ModInfo&gt; p in modList) if (p.Value.ArchiveName == name) return p.Value;
         return null;
       }
     }
@@ -558,20 +441,18 @@
     public bool HasMod(string modName)
     {
       if (!modList.ContainsKey(modName)) {
-        foreach (KeyValuePair&lt;string, ModInfo&gt; p in modList) {
-          if (p.Value.ArchiveName == modName) return true;
-        }
+        foreach (KeyValuePair&lt;string, ModInfo&gt; p in modList) if (p.Value.ArchiveName == modName) return true;
         return false;
       } else return true;
     }
 
 
-    string RequestMapArchive(string mapname)
+    private string RequestMapArchive(string mapname)
     {
       int i = GetMapArchiveCount(mapname);
       if (i &gt; 0) {
         string arch = GetMapArchiveName(0);
-        int lastslash = arch.LastIndexOfAny(new char[] { '/', '\\' });
+        int lastslash = arch.LastIndexOfAny(new char[] {'/', '\\'});
         return arch.Substring(lastslash + 1);
       } else return &quot;&quot;;
     }
@@ -579,154 +460,287 @@
     /*
     //     MAPS
     */
+
     [DllImport(&quot;unitsync.dll&quot;)]
-    static extern int GetMapCount();
+    private static extern int GetMapCount();
 
     [DllImport(&quot;unitsync.dll&quot;)]
-    static extern string GetMapName(int index);
+    private static extern string GetMapName(int index);
 
     [DllImport(&quot;unitsync.dll&quot;)]
-    static extern int GetMapArchiveCount(string mapName);
+    private static extern int GetMapArchiveCount(string mapName);
 
     [DllImport(&quot;unitsync.dll&quot;)]
-    static extern string GetMapArchiveName(int index);
+    private static extern string GetMapArchiveName(int index);
 
     /*
     //     MODS
     */
+
     [DllImport(&quot;unitsync.dll&quot;)]
-    static extern int GetPrimaryModCount();
+    private static extern int GetPrimaryModCount();
 
     [DllImport(&quot;unitsync.dll&quot;)]
-    static extern string GetPrimaryModName(int index);
+    private static extern string GetPrimaryModName(int index);
 
     [DllImport(&quot;unitsync.dll&quot;)]
-    static extern string GetPrimaryModArchive(int index);
+    private static extern string GetPrimaryModArchive(int index);
 
     [DllImport(&quot;unitsync.dll&quot;)]
-    static extern string GetPrimaryModArchiveList(int index);
+    private static extern string GetPrimaryModArchiveList(int index);
 
     [DllImport(&quot;unitsync.dll&quot;)]
-    static extern uint GetArchiveChecksum(string archive);
+    private static extern uint GetArchiveChecksum(string archive);
 
     [DllImport(&quot;unitsync.dll&quot;)]
-    static extern int GetPrimaryModArchiveCount(int index);
+    private static extern int GetPrimaryModArchiveCount(int index);
 
     [DllImport(&quot;unitsync.dll&quot;)]
-    static extern void AddAllArchives(string root);
+    private static extern void AddAllArchives(string root);
 
     [DllImport(&quot;unitsync.dll&quot;)]
-    static extern int GetPrimaryModChecksum(int index);
+    private static extern int GetPrimaryModChecksum(int index);
 
 
     /*
     //     SIDES
     */
+
     [DllImport(&quot;unitsync.dll&quot;)]
-    static extern int GetSideCount();
+    private static extern int GetSideCount();
 
     [DllImport(&quot;unitsync.dll&quot;)]
-    static extern string GetSideName(int index);
+    private static extern string GetSideName(int index);
 
 
     /*
     //     UNITS
     */
+
     [DllImport(&quot;unitsync.dll&quot;)]
-    static extern int ProcessUnitsNoChecksum();
+    private static extern int ProcessUnitsNoChecksum();
 
     [DllImport(&quot;unitsync.dll&quot;)]
-    static extern int GetUnitCount();
+    private static extern int GetUnitCount();
 
     [DllImport(&quot;unitsync.dll&quot;)]
-    static extern string GetUnitName(int index);
+    private static extern string GetUnitName(int index);
 
     [DllImport(&quot;unitsync.dll&quot;)]
-    static extern string GetFullUnitName(int index);
+    private static extern string GetFullUnitName(int index);
 
     /************************************************************************/
     /*     OPTIONS                                                          */
     /************************************************************************/
+
     [DllImport(&quot;unitsync.dll&quot;)]
-    static extern int GetMapOptionCount(string mapName);
+    private static extern int GetMapOptionCount(string mapName);
 
     [DllImport(&quot;unitsync.dll&quot;)]
-    static extern int GetModOptionCount();
+    private static extern int GetModOptionCount();
 
     [DllImport(&quot;unitsync.dll&quot;)]
-    static extern string GetOptionKey(int index);
+    private static extern string GetOptionKey(int index);
 
     [DllImport(&quot;unitsync.dll&quot;)]
-    static extern string GetOptionName(int index);
+    private static extern string GetOptionName(int index);
 
     [DllImport(&quot;unitsync.dll&quot;)]
-    static extern string GetOptionDesc(int index);
+    private static extern string GetOptionDesc(int index);
 
     [DllImport(&quot;unitsync.dll&quot;)]
-    static extern int GetOptionType(int index);
+    private static extern int GetOptionType(int index);
 
     [DllImport(&quot;unitsync.dll&quot;)]
-    static extern float GetOptionNumberMin(int index);
+    private static extern float GetOptionNumberMin(int index);
 
     [DllImport(&quot;unitsync.dll&quot;)]
-    static extern float GetOptionNumberMax(int index);
+    private static extern float GetOptionNumberMax(int index);
 
     [DllImport(&quot;unitsync.dll&quot;)]
-    static extern float GetOptionNumberStep(int index);
+    private static extern float GetOptionNumberStep(int index);
 
     [DllImport(&quot;unitsync.dll&quot;)]
-    static extern int GetOptionStringMaxLen(int index);
+    private static extern int GetOptionStringMaxLen(int index);
 
     [DllImport(&quot;unitsync.dll&quot;)]
-    static extern int GetOptionListCount(int index);
+    private static extern int GetOptionListCount(int index);
 
     [DllImport(&quot;unitsync.dll&quot;)]
-    static extern string GetOptionListItemKey(int index, int itemIndex);
+    private static extern string GetOptionListItemKey(int index, int itemIndex);
 
     [DllImport(&quot;unitsync.dll&quot;)]
-    static extern string GetOptionListItemName(int index, int itemIndex);
+    private static extern string GetOptionListItemName(int index, int itemIndex);
 
     [DllImport(&quot;unitsync.dll&quot;)]
-    static extern string GetOptionListItemDesc(int index, int itemIndex);
+    private static extern string GetOptionListItemDesc(int index, int itemIndex);
 
     [DllImport(&quot;unitsync.dll&quot;)]
-    static extern int GetOptionBoolDef(int index);
+    private static extern int GetOptionBoolDef(int index);
 
     [DllImport(&quot;unitsync.dll&quot;)]
-    static extern float GetOptionNumberDef(int index);
+    private static extern float GetOptionNumberDef(int index);
 
     [DllImport(&quot;unitsync.dll&quot;)]
-    static extern string GetOptionStringDef(int index);
+    private static extern string GetOptionStringDef(int index);
 
     [DllImport(&quot;unitsync.dll&quot;)]
-    static extern string GetOptionListDef(int index);
+    private static extern string GetOptionListDef(int index);
 
     /*
     //     INIT
     */
+
     [DllImport(&quot;unitsync.dll&quot;)]
-    static extern int Init(bool isServer, int id);
+    private static extern int Init(bool isServer, int id);
 
 
     [DllImport(&quot;unitsync.dll&quot;)]
-    static extern void UnInit();
+    private static extern void UnInit();
 
 
-    #region IDisposable Members
-    public void Dispose()
+    internal void Reload(bool reloadMods, bool reloadMaps)
     {
-      UnInit();
+      if (reloadMods || reloadMaps) ReInit(true);
+      if (reloadMaps) LoadMapList();
+      if (reloadMods) LoadModList();
     }
+
+    #region Nested type: ListOption
+    public struct ListOption
+    {
+      public string Description;
+      public string Key;
+      public string Name;
+
+      public ListOption(int optionIndex, int itemIndex)
+      {
+        Name = GetOptionListItemName(optionIndex, itemIndex);
+        Description = GetOptionListItemDesc(optionIndex, itemIndex);
+        Key = GetOptionListItemKey(optionIndex, itemIndex);
+      }
+    }
     #endregion
 
-    internal void Reload(bool reloadMods, bool reloadMaps)
+    #region Nested type: Option
+    public class Option
     {
-      if (reloadMods || reloadMaps) {
-        ReInit(true);
+      #region Type enum
+      public enum Type : int
+      {
+        Error = 0,
+        Bool = 1,
+        List = 2,
+        Number = 3,
+        String = 4
+      } ;
+      #endregion
+
+      public string Default;
+      public string Description;
+      public string Key;
+      public List&lt;ListOption&gt; ListOptions = new List&lt;ListOption&gt;();
+
+      private float max = float.MinValue;
+      private float min = float.MinValue;
+      public string Name;
+      public Type OptionType;
+      private float step = 0, strMaxLen = 65535;
+      private string Table = &quot;GAME\\MODOPTIONS\\&quot;;
+
+      public Option(int idx)
+      {
+        Name = GetOptionName(idx);
+        Key = GetOptionKey(idx);
+        Description = GetOptionDesc(idx);
+        OptionType = (Type)GetOptionType(idx);
+        strMaxLen = GetOptionStringMaxLen(idx);
+        min = GetOptionNumberMin(idx);
+        max = GetOptionNumberMax(idx);
+        step = GetOptionNumberStep(idx);
+        int listCount = GetOptionListCount(idx);
+        for (int i = 0; i &lt; listCount; i++) {
+          ListOption optl = new ListOption(idx, i);
+          ListOptions.Add(optl);
+        }
+        switch (OptionType) {
+          case Type.Bool:
+            Default = GetOptionBoolDef(idx).ToString();
+            break;
+          case Type.Number:
+            Default = GetOptionNumberDef(idx).ToString();
+            break;
+          case Type.String:
+            Default = GetOptionStringDef(idx);
+            break;
+          case Type.List:
+            Default = GetOptionListDef(idx);
+            break;
+        }
       }
-      if (reloadMaps) LoadMapList();
-      if (reloadMods) LoadModList();
+
+      private string ConstructLine(string val)
+      {
+        return Table + Key + &quot;=&quot; + val;
+      }
+
+      public bool GetPair(string Value, out string result)
+      {
+        result = &quot;&quot;;
+        switch (OptionType) {
+          case Type.Bool:
+            if (Value != &quot;0&quot; &amp;&amp; Value != &quot;1&quot;) return false;
+            result = ConstructLine(Value);
+            return true;
+
+          case Type.Number:
+            double d;
+            if (!double.TryParse(Value, out d)) return false;
+            if (d &lt; min || d &gt; max) return false;
+            result = ConstructLine(Value);
+            return true;
+
+          case Type.String:
+            if (Value.Length &gt; strMaxLen) return false;
+            result = ConstructLine(Value);
+            return true;
+
+          case Type.List:
+            foreach (ListOption lop in ListOptions) {
+              if (lop.Key == Value) {
+                result = ConstructLine(lop.Key);
+                return true;
+              }
+            }
+            return false;
+        }
+
+        return false;
+      }
+
+      public override string ToString()
+      {
+        string pom = &quot;&quot;;
+        string typs = &quot;&quot;;
+        if (OptionType == Type.Number) {
+          typs = &quot;x&quot;;
+          pom += &quot; = &quot;;
+          if (min != float.MinValue) pom += &quot; &gt;=&quot; + min;
+          if (max != float.MaxValue) pom += &quot; &lt;=&quot; + max;
+        }
+        if (OptionType == Type.List) {
+          pom += &quot; = &quot;;
+          foreach (ListOption lop in ListOptions) {
+            pom += lop.Key + &quot;-&quot; + lop.Description + &quot; | &quot;;
+            typs += lop.Key + &quot;|&quot;;
+          }
+        }
+        if (OptionType == Type.Bool) typs += &quot;0|1&quot;;
+        if (OptionType == Type.String) typs += &quot;s&quot;;
+
+        return string.Format(&quot;{0}={1}  ({2}{3})&quot;, Key, typs, Description, pom);
+      }
     }
-
+    #endregion
   }
-}
+}
\ No newline at end of file

Modified: trunk/tools/springie/Springie/utils/AutoUpdater.cs
===================================================================
--- trunk/tools/springie/Springie/utils/AutoUpdater.cs	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/utils/AutoUpdater.cs	2008-04-07 18:57:09 UTC (rev 5677)
@@ -1,39 +1,32 @@
 using System;
-using System.Collections.Generic;
-using System.Text;
-using System.Net;
+using System.Diagnostics;
 using System.IO;
-using System.Net.Sockets;
+using System.Net;
 using System.Text.RegularExpressions;
-using System.Collections;
-using Springie.Client;
-using Springie.SpringNamespace;
 using System.Timers;
 using System.Windows.Forms;
+using Springie.Client;
+using Springie.SpringNamespace;
+using Timer=System.Timers.Timer;
 
 namespace Springie
 {
-  class AutoUpdater
+  internal class AutoUpdater
   {
-
     /************************************************************************/
     /*    PRIVATE ATTRIBS                                                   */
     /************************************************************************/
-    bool enabled
-    {
-      get { return Program.main.config.AutoUpdate; }
-    }
 
-    System.Timers.Timer timer;
-    Spring spring;
-    TasClient tas;
+    private const int updateCheckInterval = 1; //in minutes
+    private const string updateSite = &quot;<A HREF="http://springie.licho.eu/">http://springie.licho.eu/</A>&quot;;
+    private Spring spring;
+    private TasClient tas;
+    private Timer timer;
 
-    const int updateCheckInterval = 1; //in minutes
-    const string updateSite = &quot;<A HREF="http://springie.licho.eu/">http://springie.licho.eu/</A>&quot;;
-
     /************************************************************************/
     /*    PUBLIC METHODS                                                    */
     /************************************************************************/
+
     /// &lt;summary&gt;
     /// Initializes auto downloader
     /// &lt;/summary&gt;
@@ -42,28 +35,25 @@
       this.spring = spring;
       this.tas = tas;
 
-      timer = new System.Timers.Timer();
-      timer.Interval = updateCheckInterval * 1000 * 60;
+      timer = new Timer();
+      timer.Interval = updateCheckInterval*1000*60;
       timer.AutoReset = true;
-      timer.Elapsed += new ElapsedEventHandler(timer_Elapsed);
+      timer.Elapsed += timer_Elapsed;
       timer.Start();
-
-      spring.SpringExited += new EventHandler(spring_SpringExited);
+      spring.SpringExited += spring_SpringExited;
     }
 
-    void timer_Elapsed(object sender, ElapsedEventArgs e)
+    private bool enabled
     {
-      updateSpringie();
+      get { return Program.main.config.AutoUpdate; }
     }
 
-    void spring_SpringExited(object sender, EventArgs e)
+    private void timer_Elapsed(object sender, ElapsedEventArgs e)
     {
       updateSpringie();
     }
 
-
-
-    void timer_Tick(object sender, EventArgs e)
+    private void spring_SpringExited(object sender, EventArgs e)
     {
       updateSpringie();
     }
@@ -72,6 +62,7 @@
     /************************************************************************/
     /*    PRIVATE METHODS                                                   */
     /************************************************************************/
+
     private void updateSpringie()
     {
       if (enabled &amp;&amp; !spring.IsRunning) {
@@ -79,7 +70,6 @@
 
         UpdateCa();
 
-
         using (WebClient wc = new WebClient()) {
           try {
             string remoteVersion = wc.DownloadString(updateSite + &quot;version.txt&quot;).Trim();
@@ -96,23 +86,20 @@
               File.Move(target, Application.ExecutablePath);
               tas.Say(TasClient.SayPlace.Battle, &quot;&quot;, &quot;Springie is auto-upgrading to newer version, rejoin please&quot;, true);
 
-              System.Diagnostics.Process.Start(Application.ExecutablePath);
+              Process.Start(Application.ExecutablePath);
               Application.Exit();
             }
-          } catch (WebException) {
-          }
+          } catch (WebException) {}
         }
         timer.Enabled = true;
       }
     }
 
-    private int ExtractVersionNumber(string modname)
+    private static int ExtractVersionNumber(string modname)
     {
       int ver = 0;
       Match m = Regex.Match(modname, &quot;\\-([0-9]+)&quot;);
-      if (m.Success) {
-        int.TryParse(m.Groups[1].Value, out ver);
-      }
+      if (m.Success) int.TryParse(m.Groups[1].Value, out ver);
       return ver;
     }
 
@@ -140,9 +127,9 @@
 
         if (b.Mod.Name != selMod) {
           tas.Say(TasClient.SayPlace.Battle, &quot;&quot;, &quot;Springie is now rehosting to new version of CA - &quot; + selMod, true);
-          Program.main.AutoHost.ComRehost(TasSayEventArgs.Default, new string[] { selMod });
+          Program.main.AutoHost.ComRehost(TasSayEventArgs.Default, new string[] {selMod});
         }
       }
     }
   }
-}
+}
\ No newline at end of file

Modified: trunk/tools/springie/Springie/utils/FileDownloader.cs
===================================================================
--- trunk/tools/springie/Springie/utils/FileDownloader.cs	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/utils/FileDownloader.cs	2008-04-07 18:57:09 UTC (rev 5677)
@@ -1,83 +1,57 @@
 using System;
 using System.Collections.Generic;
-using System.Text;
 using System.Net;
-using System.IO;
-using System.Net.Sockets;
 using System.Text.RegularExpressions;
-using System.Collections;
-using Springie.Client;
+using System.Threading;
 using Springie.SpringNamespace;
-using System.Security.Policy;
-using System.Threading;
 
 namespace Springie
 {
   /// &lt;summary&gt;
   /// Class responsible for downloading new Mods to spring
   /// &lt;/summary&gt;
-  class FileDownloader
+  internal class FileDownloader
   {
-    public enum Status { Done, Failed };
-    public class DownloadEventArgs:EventArgs {
-      public DownloadItem DownloadItem;
-      public Status Status;
-      public string Message;
-      public DownloadEventArgs(DownloadItem item, Status status, string message) {
-        this.DownloadItem = item;
-        this.Status = status;
-        this.Message = message;
-      }
-    }
-
-    /************************************************************************/
-    /*    PUBLIC ATTRIBS                                                    */
-    /************************************************************************/
+    #region FileType enum
     /// &lt;summary&gt;
-    /// Download completed (either successfully or unsuccessfully)
-    /// &lt;/summary&gt;
-    public event EventHandler&lt;DownloadEventArgs&gt; DownloadCompleted;
-
-    /// &lt;summary&gt;
     /// Download progress has changed
     /// &lt;/summary&gt;
     //public event EventHandler&lt;TasEventArgs&gt; DownloadProgressChanged;
-
     /// &lt;summary&gt;
     /// How often to report progresschanged (in percents)
     /// &lt;/summary&gt;
     //public const int ReportPercentStep = 20;
+    public enum FileType
+    {
+      Map,
+      Mod
+    }
+    #endregion
 
-    public enum FileType { Map, Mod }
+    #region Status enum
+    public enum Status
+    {
+      Done,
+      Failed
+    } ;
+    #endregion
 
+    private DownloadItem currentDownload = null;
+    private Queue&lt;DownloadItem&gt; downloadQueue = new Queue&lt;DownloadItem&gt;();
+    private Thread downloadThread = null;
+
     /************************************************************************/
     /*    PRIVATE ATTRIBS                                                   */
     /************************************************************************/
-    public class DownloadItem
-    {
-      public Uri url;
-      public string fileName;
-      public string targetPath;
-      public FileType fileType;
-      public DownloadItem(){}
-      public DownloadItem(FileType fileType, string fileName) {
-        this.fileType = fileType;
-        this.fileName = fileName;
-      }
-    };
 
-    Spring spring;
-    WebClient wc = null;
-    Thread downloadThread = null;
+    private Spring spring;
+    private WebClient wc = null;
 
-    //int lastPercent = 0;
-    Queue&lt;DownloadItem&gt; downloadQueue = new Queue&lt;DownloadItem&gt;();
-    DownloadItem currentDownload = null;
 
-
     /************************************************************************/
     /*    PUBLIC METHODS                                                    */
     /************************************************************************/
+
     /// &lt;summary&gt;
     /// Initializes Mod downloader
     /// &lt;/summary&gt;
@@ -86,7 +60,12 @@
       this.spring = spring;
     }
 
+    /// &lt;summary&gt;
+    /// Download completed (either successfully or unsuccessfully)
+    /// &lt;/summary&gt;
+    public event EventHandler&lt;DownloadEventArgs&gt; DownloadCompleted;
 
+
     /// &lt;summary&gt;
     /// Queues file for download
     /// &lt;/summary&gt;
@@ -101,18 +80,21 @@
       downloadQueue.Enqueue(d);
 
       if (downloadQueue.Count == 1 &amp;&amp; (downloadThread == null || downloadThread.IsAlive == false)) {
-        downloadThread = new Thread(delegate() {
-          wc = new WebClient();
-          GetNext(); });
+        downloadThread = new Thread(delegate()
+                                      {
+                                        wc = new WebClient();
+                                        GetNext();
+                                      });
         downloadThread.Start();
       }
     }
 
 
-    public static bool IsFileUrl(string what, out string fileName) {
+    public static bool IsFileUrl(string what, out string fileName)
+    {
       fileName = &quot;&quot;;
       if (what.StartsWith(&quot;<A HREF="http://">http://</A>&quot;) || what.StartsWith(&quot;<A HREF="ftp://">ftp://</A>&quot;)) {
-        string[] fs = what.Split(new char[] { '/', '\\', '?' }, StringSplitOptions.RemoveEmptyEntries);
+        string[] fs = what.Split(new char[] {'/', '\\', '?'}, StringSplitOptions.RemoveEmptyEntries);
         if (fs.Length &gt; 0) {
           fileName = fs[fs.Length - 1];
           return true;
@@ -129,49 +111,42 @@
     public void DownloadMap(string mapNameUrlOrId)
     {
       string realFileName = &quot;&quot;;
-      
-      if (FileDownloader.IsFileUrl(mapNameUrlOrId, out realFileName)) {
+
+      if (IsFileUrl(mapNameUrlOrId, out realFileName)) {
         DownloadFile(mapNameUrlOrId, realFileName, FileType.Map);
         return;
       }
-      
+
       try {
         WebClient wc2 = new WebClient();
         string result = &quot;&quot;;
         if (mapNameUrlOrId.Contains(&quot;.&quot;)) {
           result = wc2.DownloadString(&quot;<A HREF="http://www.unknown-files.net/licho.php?filename=">http://www.unknown-files.net/licho.php?filename=</A>&quot; + mapNameUrlOrId.Replace(&quot;.smf&quot;, &quot;.sd7&quot;)); // try sd7 first
 
-          if (result == &quot;error&quot; || result == &quot;&quot;) {
-            result = wc2.DownloadString(&quot;<A HREF="http://www.unknown-files.net/licho.php?filename=">http://www.unknown-files.net/licho.php?filename=</A>&quot; + mapNameUrlOrId.Replace(&quot;.smf&quot;, &quot;.sdz&quot;)); //then sdz
-          }
-
+          if (result == &quot;error&quot; || result == &quot;&quot;) result = wc2.DownloadString(&quot;<A HREF="http://www.unknown-files.net/licho.php?filename=">http://www.unknown-files.net/licho.php?filename=</A>&quot; + mapNameUrlOrId.Replace(&quot;.smf&quot;, &quot;.sdz&quot;)); //then sdz
         } else result = wc2.DownloadString(&quot;<A HREF="http://www.unknown-files.net/licho.php?id=">http://www.unknown-files.net/licho.php?id=</A>&quot; + mapNameUrlOrId);
 
-
         string realUrl = &quot;&quot;;
         try {
-          
           realUrl = Regex.Match(result, &quot;file=(.*)&quot;).Groups[1].Value;
           realFileName = Regex.Match(result, &quot;filename=([^\\&amp;]+)&quot;).Groups[1].Value;
-
         } catch {
-          if (DownloadCompleted != null) DownloadCompleted(this, new DownloadEventArgs(new DownloadItem(FileType.Map,mapNameUrlOrId), Status.Failed, &quot;File not found&quot;));
+          if (DownloadCompleted != null) DownloadCompleted(this, new DownloadEventArgs(new DownloadItem(FileType.Map, mapNameUrlOrId), Status.Failed, &quot;File not found&quot;));
           return;
         }
         if (realFileName == &quot;&quot;) {
-          if (DownloadCompleted != null) DownloadCompleted(this, new DownloadEventArgs(new DownloadItem(FileType.Map,mapNameUrlOrId), Status.Failed, &quot;File not found&quot;));
+          if (DownloadCompleted != null) DownloadCompleted(this, new DownloadEventArgs(new DownloadItem(FileType.Map, mapNameUrlOrId), Status.Failed, &quot;File not found&quot;));
           return;
         }
 
         string mapSmf = realFileName.Substring(0, realFileName.LastIndexOf('.')) + &quot;.smf&quot;;
-        if (spring.UnitSync.HasMap(mapSmf)) { // we have this map already let's fuck this
+        if (spring.UnitSync.HasMap(mapSmf)) {
+          // we have this map already let's fuck this
           if (DownloadCompleted != null) DownloadCompleted(this, new DownloadEventArgs(new DownloadItem(FileType.Map, mapNameUrlOrId), Status.Failed, &quot;We already have this map&quot;));
           return;
         }
 
-
         DownloadFile(realUrl, realFileName, FileType.Map);
-
       } catch {
         if (DownloadCompleted != null) DownloadCompleted(this, new DownloadEventArgs(new DownloadItem(FileType.Map, mapNameUrlOrId), Status.Failed, &quot;Error while determining map URL&quot;));
         return;
@@ -187,7 +162,7 @@
     {
       string realFileName = &quot;&quot;;
 
-      if (FileDownloader.IsFileUrl(modUrlOrId, out realFileName)) {
+      if (IsFileUrl(modUrlOrId, out realFileName)) {
         DownloadFile(modUrlOrId, realFileName, FileType.Mod);
         return;
       }
@@ -211,14 +186,11 @@
           return;
         }
 
-
         DownloadFile(result, realFileName, FileType.Mod);
-
       } catch {
         if (DownloadCompleted != null) DownloadCompleted(this, new DownloadEventArgs(new DownloadItem(FileType.Map, modUrlOrId), Status.Failed, &quot;Error while determining mod URL&quot;));
         return;
       }
-
     }
 
 
@@ -251,6 +223,7 @@
     /************************************************************6************/
     /*    PRIVATE METHODS                                                   */
     /************************************************************************/
+
     /// &lt;summary&gt;
     /// Tries to handle next request from queue
     /// &lt;/summary&gt;
@@ -271,5 +244,38 @@
 
       //wc.DownloadFileAsync(currentDownload.url, currentDownload.targetPath + &quot;/&quot; + currentDownload.fileName);
     }
+
+    #region Nested type: DownloadEventArgs
+    public class DownloadEventArgs : EventArgs
+    {
+      public DownloadItem DownloadItem;
+      public string Message;
+      public Status Status;
+
+      public DownloadEventArgs(DownloadItem item, Status status, string message)
+      {
+        DownloadItem = item;
+        Status = status;
+        Message = message;
+      }
+    }
+    #endregion
+
+    #region Nested type: DownloadItem
+    public class DownloadItem
+    {
+      public string fileName;
+      public FileType fileType;
+      public string targetPath;
+      public Uri url;
+      public DownloadItem() {}
+
+      public DownloadItem(FileType fileType, string fileName)
+      {
+        this.fileType = fileType;
+        this.fileName = fileName;
+      }
+    } ;
+    #endregion
   }
-}
+}
\ No newline at end of file

Modified: trunk/tools/springie/Springie/utils/MyCol.cs
===================================================================
--- trunk/tools/springie/Springie/utils/MyCol.cs	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/utils/MyCol.cs	2008-04-07 18:57:09 UTC (rev 5677)
@@ -1,6 +1,3 @@
-using System;
-using System.Collections.Generic;
-using System.Text;
 using System.Drawing;
 
 namespace Springie
@@ -13,16 +10,19 @@
     /************************************************************************/
     /*   PUBLIC ATTRIBS                                                     */
     /************************************************************************/
-    public byte R;
-    public byte G;
     public byte B;
+    public byte G;
+    public byte R;
 
     /************************************************************************/
     /*   PUBLIC METHODS                                                     */
     /************************************************************************/
+
     public MyCol(byte r, byte g, byte b)
     {
-      R = r; G = g; B = b;
+      R = r;
+      G = g;
+      B = b;
     }
 
     /// &lt;summary&gt;
@@ -77,11 +77,11 @@
     {
       int r, g, b;
       int rmean;
-      rmean = ((int)e1.R + (int)e2.R) / 2;
+      rmean = ((int)e1.R + (int)e2.R)/2;
       r = (int)e1.R - (int)e2.R;
       g = (int)e1.G - (int)e2.G;
       b = (int)e1.B - (int)e2.B;
-      return (((512 + rmean) * r * r) &gt;&gt; 8) + 4 * g * g + (((767 - rmean) * b * b) &gt;&gt; 8);
+      return (((512 + rmean)*r*r) &gt;&gt; 8) + 4*g*g + (((767 - rmean)*b*b) &gt;&gt; 8);
     }
 
     public int Distance(MyCol e2)
@@ -108,7 +108,9 @@
       bestVal = int.MinValue;
 
       MyCol temp = new MyCol();
-      for (short r = 0; r &lt;= 255; r += 3) for (short g = 0; g &lt;= 255; g += 3) for (short b = 0; b &lt;= 255; b += 3) {
+      for (short r = 20; r &lt;= 255; r += 3) {
+        for (short g = 20; g &lt;= 255; g += 3) {
+          for (short b = 50; b &lt;= 255; b += 3) {
             temp.R = (byte)r;
             temp.G = (byte)g;
             temp.B = (byte)b;
@@ -116,7 +118,7 @@
             int minDist = int.MaxValue;
             for (int i = 0; i &lt; input.Length; ++i) {
               if (i == index) continue;
-              int cDistance = temp % input[i];
+              int cDistance = temp%input[i];
               if (cDistance &lt;= bestVal) {
                 minDist = int.MinValue;
                 break;
@@ -129,6 +131,8 @@
               bestCol = temp;
             }
           }
+        }
+      }
       return bestVal;
     }
 
@@ -139,13 +143,7 @@
     /// &lt;param name=&quot;balanceDistance&quot;&gt;Treshold distance, if two colors are more similar than this, it changes one of them&lt;/param&gt;
     public static void FixColors(MyCol[] input, int balanceDistance)
     {
-      for (int i = 0; i &lt; input.Length - 1; ++i) {
-        for (int j = i + 1; j &lt; input.Length; ++j) {
-          if (input[i] % input[j] &lt; balanceDistance) {
-            GetBestRelocation(input, i, out input[i]);
-          }
-        }
-      }
+      for (int i = 0; i &lt; input.Length - 1; ++i) for (int j = i + 1; j &lt; input.Length; ++j) if (input[i]%input[j] &lt; balanceDistance) GetBestRelocation(input, i, out input[i]);
     }
-  };
-}
+  } ;
+}
\ No newline at end of file

Modified: trunk/tools/springie/Springie/utils/Stats.cs
===================================================================
--- trunk/tools/springie/Springie/utils/Stats.cs	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/utils/Stats.cs	2008-04-07 18:57:09 UTC (rev 5677)
@@ -1,44 +1,57 @@
 using System;
 using System.Collections.Generic;
-using System.Text;
-using Springie.Client;
-using Springie.SpringNamespace;
-using System.Xml.Serialization;
 using System.IO;
 using System.Net;
 using System.Security.Cryptography;
-using System.Windows.Forms;
+using System.Text;
 using System.Threading;
+using System.Windows.Forms;
+using System.Xml.Serialization;
+using Springie.Client;
+using Springie.SpringNamespace;
 
 namespace Springie
 {
   public class Stats
   {
-    TasClient tas;
-    Spring spring;
-
-    string password = &quot;&quot;;
-    List&lt;Account&gt; accounts = new List&lt;Account&gt;();
-
-    Dictionary&lt;string, Player&gt; players = new Dictionary&lt;string, Player&gt;();
-
-    // original battle settings
-    Battle battle;
-    DateTime startTime;
-
     public const string accountsFileName = &quot;do_not_delete_me.xml&quot;;
     public const string gatherScript = &quot;statsGather.php&quot;;
     public const string smurfScript = &quot;smurfs.php&quot;;
     public const string statsScript = &quot;stats.php&quot;;
+    private List&lt;Account&gt; accounts = new List&lt;Account&gt;();
+    private Battle battle;
+    private string password = &quot;&quot;;
+    private Dictionary&lt;string, Player&gt; players = new Dictionary&lt;string, Player&gt;();
+    private Spring spring;
+    private DateTime startTime;
+    private TasClient tas;
 
-    protected string StatsUrl
+    public Stats(TasClient tas, Spring spring)
     {
-      get
-      {
-        return Program.main.config.StatsUrlAddress;
+      this.tas = tas;
+      this.spring = spring;
+
+      LoadAccounts();
+
+      tas.LoginAccepted += new EventHandler&lt;TasEventArgs&gt;(tas_LoginAccepted);
+      if (Program.main.config.GargamelMode) {
+        tas.UserRemoved += new EventHandler&lt;TasEventArgs&gt;(tas_UserRemoved);
+        tas.BattleUserIpRecieved += new EventHandler&lt;TasEventArgs&gt;(tas_BattleUserIpRecieved);
+        tas.UserStatusChanged += new EventHandler&lt;TasEventArgs&gt;(tas_UserStatusChanged);
       }
+      spring.SpringStarted += new EventHandler(spring_SpringStarted);
+      spring.PlayerJoined += new EventHandler&lt;SpringLogEventArgs&gt;(spring_PlayerJoined);
+      spring.PlayerLeft += new EventHandler&lt;SpringLogEventArgs&gt;(spring_PlayerLeft);
+      spring.PlayerLost += new EventHandler&lt;SpringLogEventArgs&gt;(spring_PlayerLost);
+      spring.PlayerDisconnected += new EventHandler&lt;SpringLogEventArgs&gt;(spring_PlayerDisconnected);
+      spring.GameOver += new EventHandler&lt;SpringLogEventArgs&gt;(spring_GameOver);
     }
 
+    protected string StatsUrl
+    {
+      get { return Program.main.config.StatsUrlAddress; }
+    }
+
     protected string UserName
     {
       get
@@ -54,20 +67,20 @@
       try {
         if (hash) {
           query += &quot;&amp;login=&quot; + UserName;
-          uri = new Uri(StatsUrl + script + &quot;?&quot; + query.Replace(&quot;#&quot;,&quot;%23&quot;) + &quot;&amp;hash=&quot; + CalculateHexMD5Hash(query + password));
+          uri = new Uri(StatsUrl + script + &quot;?&quot; + query.Replace(&quot;#&quot;, &quot;%23&quot;) + &quot;&amp;hash=&quot; + CalculateHexMD5Hash(query + password));
 
-
           Console.WriteLine(query);
           Console.WriteLine(CalculateHexMD5Hash(query + password));
         } else uri = new Uri(StatsUrl + script + &quot;?&quot; + query);
 
         if (async) {
-          Thread t1 = new Thread(delegate(object s) {
-            try {
-              WebClient wc = new WebClient();
-              wc.DownloadString((Uri)s);
-            } catch { }
-          });
+          Thread t1 = new Thread(delegate(object s)
+                                   {
+                                     try {
+                                       WebClient wc = new WebClient();
+                                       wc.DownloadString((Uri)s);
+                                     } catch {}
+                                   });
           t1.Start(uri);
           return &quot;&quot;;
         } else {
@@ -80,75 +93,37 @@
     }
 
 
-
-    public Stats(TasClient tas, Spring spring)
+    private void tas_UserStatusChanged(object sender, TasEventArgs e)
     {
-      this.tas = tas;
-      this.spring = spring;
-
-      LoadAccounts();
-
-      tas.LoginAccepted += new EventHandler&lt;TasEventArgs&gt;(tas_LoginAccepted);
-      if (Program.main.config.GargamelMode) {
-        tas.UserRemoved += new EventHandler&lt;TasEventArgs&gt;(tas_UserRemoved);
-        tas.BattleUserIpRecieved += new EventHandler&lt;TasEventArgs&gt;(tas_BattleUserIpRecieved);
-        tas.UserStatusChanged += new EventHandler&lt;TasEventArgs&gt;(tas_UserStatusChanged);
-      }
-      spring.SpringStarted += new EventHandler(spring_SpringStarted);
-      spring.PlayerJoined += new EventHandler&lt;SpringLogEventArgs&gt;(spring_PlayerJoined);
-      spring.PlayerLeft += new EventHandler&lt;SpringLogEventArgs&gt;(spring_PlayerLeft);
-      spring.PlayerLost += new EventHandler&lt;SpringLogEventArgs&gt;(spring_PlayerLost);
-      spring.PlayerDisconnected += new EventHandler&lt;SpringLogEventArgs&gt;(spring_PlayerDisconnected);
-      spring.GameOver += new EventHandler&lt;SpringLogEventArgs&gt;(spring_GameOver);
-    }
-
-    void tas_UserStatusChanged(object sender, TasEventArgs e)
-    {
       User u;
-      if (tas.GetExistingUser(e.ServerParams[0], out u)) {
-        SendCommand(gatherScript, &quot;a=addplayer&amp;name=&quot; + u.name + &quot;&amp;rank=&quot; + (u.rank + 1), true, true);
-      }
+      if (tas.GetExistingUser(e.ServerParams[0], out u)) SendCommand(gatherScript, &quot;a=addplayer&amp;name=&quot; + u.name + &quot;&amp;rank=&quot; + (u.rank + 1), true, true);
     }
 
-    void tas_BattleUserIpRecieved(object sender, TasEventArgs e)
+    private void tas_BattleUserIpRecieved(object sender, TasEventArgs e)
     {
       User u;
-      if (tas.GetExistingUser(e.ServerParams[0], out u)) {
-        SendCommand(gatherScript, &quot;a=joinplayer&amp;name=&quot; + u.name + &quot;&amp;rank=&quot; + u.rank + &quot;&amp;ip=&quot; + e.ServerParams[1], true, true);
-      }
-
+      if (tas.GetExistingUser(e.ServerParams[0], out u)) SendCommand(gatherScript, &quot;a=joinplayer&amp;name=&quot; + u.name + &quot;&amp;rank=&quot; + u.rank + &quot;&amp;ip=&quot; + e.ServerParams[1], true, true);
     }
 
 
-    void spring_GameOver(object sender, SpringLogEventArgs e)
+    private void spring_GameOver(object sender, SpringLogEventArgs e)
     {
       string query = String.Format(&quot;a=battle&amp;map={0}&amp;mod={1}&amp;title={2}&amp;start={3}&amp;duration={4}&quot;, battle.Map.Name, battle.Mod.Name, battle.Title, Utils.ToUnix(startTime), Utils.ToUnix(DateTime.Now.Subtract(startTime)));
 
+      foreach (Player p in players.Values) if (!p.Spectator &amp;&amp; p.AliveTillEnd) foreach (Player pset in players.Values) if (pset.AllyNumber == p.AllyNumber &amp;&amp; !pset.Spectator) pset.OnVictoryTeam = true;
 
-      foreach (Player p in players.Values) {
-        if (!p.Spectator &amp;&amp; p.AliveTillEnd) {
-          foreach (Player pset in players.Values) {
-            if (pset.AllyNumber == p.AllyNumber &amp;&amp; !pset.Spectator) pset.OnVictoryTeam = true;
-          }
-        }
-      }
+      foreach (Player p in players.Values) query += &quot;&amp;player[]=&quot; + p;
 
-      foreach (Player p in players.Values) {
-        query += &quot;&amp;player[]=&quot; + p;
-      }
-
       // send only if there were at least 2 players in game
       if (players.Count &gt; 1) SendCommand(gatherScript, query, true, true);
     }
 
-    void spring_PlayerDisconnected(object sender, SpringLogEventArgs e)
+    private void spring_PlayerDisconnected(object sender, SpringLogEventArgs e)
     {
-      if (RegisterPlayerInCombat(e.Username)) {
-        players[e.Username].DisconnectTime = DateTime.Now.Subtract(startTime);
-      }
+      if (RegisterPlayerInCombat(e.Username)) players[e.Username].DisconnectTime = DateTime.Now.Subtract(startTime);
     }
 
-    void spring_PlayerLost(object sender, SpringLogEventArgs e)
+    private void spring_PlayerLost(object sender, SpringLogEventArgs e)
     {
       if (RegisterPlayerInCombat(e.Username)) {
         players[e.Username].LoseTime = DateTime.Now.Subtract(startTime);
@@ -156,11 +131,9 @@
       }
     }
 
-    void spring_PlayerLeft(object sender, SpringLogEventArgs e)
+    private void spring_PlayerLeft(object sender, SpringLogEventArgs e)
     {
-      if (RegisterPlayerInCombat(e.Username)) {
-        players[e.Username].LeaveTime = DateTime.Now.Subtract(startTime);
-      }
+      if (RegisterPlayerInCombat(e.Username)) players[e.Username].LeaveTime = DateTime.Now.Subtract(startTime);
     }
 
     private bool RegisterPlayerInCombat(string name)
@@ -176,46 +149,41 @@
         p.Ip = battle.Users[idx].ip.ToString();
 
         User u;
-        if (tas.GetExistingUser(name, out u)) {
-          p.Rank = u.rank + 1;
-        }
+        if (tas.GetExistingUser(name, out u)) p.Rank = u.rank + 1;
       } else return false;
       players.Add(name, p);
       return true;
     }
 
-    void spring_PlayerJoined(object sender, SpringLogEventArgs e)
+    private void spring_PlayerJoined(object sender, SpringLogEventArgs e)
     {
       if (e.Username == UserName) return; // do not add autohost itself
       RegisterPlayerInCombat(e.Username);
     }
 
-    void spring_SpringStarted(object sender, EventArgs e)
+    private void spring_SpringStarted(object sender, EventArgs e)
     {
       battle = tas.GetBattle();
       players = new Dictionary&lt;string, Player&gt;();
       startTime = DateTime.Now;
     }
 
-    void tas_UserRemoved(object sender, TasEventArgs e)
+    private void tas_UserRemoved(object sender, TasEventArgs e)
     {
       SendCommand(gatherScript, &quot;a=removeplayer&amp;name=&quot; + e.ServerParams[0], true, true);
     }
 
 
-    void tas_LoginAccepted(object sender, TasEventArgs e)
+    private void tas_LoginAccepted(object sender, TasEventArgs e)
     {
       Account a = accounts.Find(delegate(Account acc) { return acc.UserName == UserName; });
-      if (a != null) {
-        password = a.Password;
-      }
+      if (a != null) password = a.Password;
 
       if (password == &quot;&quot;) {
         password = SendCommand(gatherScript, &quot;a=register&amp;name=&quot; + UserName, false, false);
         if (password != &quot;&quot;) {
-          if (password.StartsWith(&quot;FAILED&quot;)) {
-            MessageBox.Show(&quot;You need correct password to submit stats with account &quot; + UserName + &quot;, stats won't work - &quot; + password, &quot;Stats registration failed&quot;, MessageBoxButtons.OK, MessageBoxIcon.Warning);
-          } else {
+          if (password.StartsWith(&quot;FAILED&quot;)) MessageBox.Show(&quot;You need correct password to submit stats with account &quot; + UserName + &quot;, stats won't work - &quot; + password, &quot;Stats registration failed&quot;, MessageBoxButtons.OK, MessageBoxIcon.Warning);
+          else {
             accounts.Add(new Account(UserName, password));
             SaveAccounts();
           }
@@ -249,39 +217,39 @@
       byte[] hash = md5.ComputeHash(inputBytes);
 
       StringBuilder sb = new StringBuilder();
-      for (int i = 0; i &lt; hash.Length; i++) {
-        sb.Append(hash[i].ToString(&quot;x2&quot;));
-      }
+      for (int i = 0; i &lt; hash.Length; i++) sb.Append(hash[i].ToString(&quot;x2&quot;));
       return sb.ToString();
     }
 
-
+    #region Nested type: Account
     public class Account
     {
-      public string UserName;
       public string Password;
-      public Account() { }
+      public string UserName;
+      public Account() {}
+
       public Account(string userName, string password)
       {
-        this.UserName = userName;
-        this.Password = password;
+        UserName = userName;
+        Password = password;
       }
-    };
+    } ;
+    #endregion
 
-
-    class Player
+    #region Nested type: Player
+    private class Player
     {
-      public string Name = &quot;&quot;;
       public bool AliveTillEnd = true;
-      public bool OnVictoryTeam = false;
-      public bool Spectator = false;
-      public TimeSpan LoseTime;
-      public TimeSpan LeaveTime;
+      public int AllyNumber = 0;
       public TimeSpan DisconnectTime;
-      public string Side = &quot;&quot;; // mod side
       public string Ip = &quot;&quot;;
-      public int AllyNumber = 0;
+      public TimeSpan LeaveTime;
+      public TimeSpan LoseTime;
+      public string Name = &quot;&quot;;
+      public bool OnVictoryTeam = false;
       public int Rank = 0; // - actually rank + 1 .. starts at 1 and not 0
+      public string Side = &quot;&quot;; // mod side
+      public bool Spectator = false;
 
       public override string ToString()
       {
@@ -292,6 +260,7 @@
         ret += Side + &quot;|&quot; + Utils.ToUnix(LoseTime) + &quot;|&quot; + AllyNumber + &quot;|&quot; + Rank;
         return ret;
       }
-    };
+    } ;
+    #endregion
   }
-}
+}
\ No newline at end of file

Modified: trunk/tools/springie/Springie/utils/UnknownFilesLinker.cs
===================================================================
--- trunk/tools/springie/Springie/utils/UnknownFilesLinker.cs	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/utils/UnknownFilesLinker.cs	2008-04-07 18:57:09 UTC (rev 5677)
@@ -1,6 +1,5 @@
 using System;
 using System.Collections.Generic;
-using System.Text;
 using System.Net;
 using System.Text.RegularExpressions;
 using System.Timers;
@@ -17,20 +16,26 @@
     /************************************************************************/
     /*   PRIVATE ATTRIBS                                                    */
     /************************************************************************/
-    const int DeleteCacheInterval = 3600; // inerval in seconds
-    Dictionary&lt;string, string&gt; cachedResults = new Dictionary&lt;string, string&gt;();
-    Timer timerDelResults = new Timer(DeleteCacheInterval * 1000);
-    Spring spring;
 
-    public enum FileType {
+    #region FileType enum
+    public enum FileType
+    {
       Map = 13,
       Mod = 14
     }
+    #endregion
 
+    private const int DeleteCacheInterval = 3600; // inerval in seconds
+    private Dictionary&lt;string, string&gt; cachedResults = new Dictionary&lt;string, string&gt;();
+    private Spring spring;
+    private Timer timerDelResults = new Timer(DeleteCacheInterval*1000);
+
     /************************************************************************/
     /*   PUBLIC METHODS                                                     */
     /************************************************************************/
-    public UnknownFilesLinker(Spring spring) {
+
+    public UnknownFilesLinker(Spring spring)
+    {
       this.spring = spring;
       timerDelResults.Elapsed += new ElapsedEventHandler(timerDelResults_Elapsed);
       timerDelResults.Enabled = true;
@@ -44,7 +49,7 @@
     public string GetMapBounceLink(string name)
     {
       name = spring.GetMapArchiveName(name);
-      return &quot;<A HREF="http://www.unknown-files.net/bounce.php?filename=">http://www.unknown-files.net/bounce.php?filename=</A>&quot; + Uri.EscapeDataString(name);
+      return &quot;<A HREF="http://spring.jobjol.nl/search_result.php?select_select=select_file_name&amp;search=">http://spring.jobjol.nl/search_result.php?select_select=select_file_name&amp;search=</A>&quot; + Uri.EscapeDataString(name);
     }
 
     /// &lt;summary&gt;
@@ -54,38 +59,28 @@
     /// &lt;returns&gt;Search results&lt;/returns&gt;
     public string GetResults(string name, FileType type)
     {
-      if (cachedResults.ContainsKey(name)) {
-        return cachedResults[name];
-      }
+      if (cachedResults.ContainsKey(name)) return cachedResults[name];
 
       WebClient wc = new WebClient();
       string result = &quot;&quot;;
 
-      if (String.IsNullOrEmpty(name)) {
-        return &quot;you must type name of map, e.g. !maplink altored&quot;;
-      }
+      if (String.IsNullOrEmpty(name)) return &quot;you must type name of map, e.g. !maplink altored&quot;;
 
       try {
         result = wc.DownloadString(&quot;<A HREF="http://spring.unknown-files.net/page/search/1/">http://spring.unknown-files.net/page/search/1/</A>&quot; + (int)type + &quot;/&quot; + name);
       } catch {
         return &quot;link search failed, unknown files down :(&quot;;
       }
-      if (result == &quot;&quot; || !result.Contains(&quot;<A HREF="http://spring.unknown-files.net/file/">http://spring.unknown-files.net/file/</A>&quot;)) {
-        return &quot;link search failed, contact Licho&quot;;
-      }
+      if (result == &quot;&quot; || !result.Contains(&quot;<A HREF="http://spring.unknown-files.net/file/">http://spring.unknown-files.net/file/</A>&quot;)) return &quot;link search failed, contact Licho&quot;;
 
       int start = result.IndexOf(&quot;&lt;b&gt;Search Results&lt;/b&gt;&quot;);
       int end = result.IndexOf(&quot;&lt;b&gt;Quick Search&lt;/b&gt;&quot;);
-      if (start == -1 || end == -1) {
-        return &quot;no link found&quot;;
-      }
+      if (start == -1 || end == -1) return &quot;no link found&quot;;
       result = result.Substring(start, end - start); // pickup just result lines + something
 
       MatchCollection c = Regex.Matches(result, &quot;&lt;a href='(<A HREF="http://spring.unknown-files.net/file/[0-9">http://spring.unknown-files.net/file/[0-9</A>]*)[^&gt;]*&gt;([^&lt;]+)&quot;);
       string response = &quot;&quot;;
-      foreach (Match m in c) {
-        response += m.Groups[2].Value + &quot; ---&gt; &quot; + m.Groups[1].Value + &quot;\n&quot;;
-      }
+      foreach (Match m in c) response += m.Groups[2].Value + &quot; ---&gt; &quot; + m.Groups[1].Value + &quot;\n&quot;;
       if (response == &quot;&quot;) response = &quot;no such map found&quot;;
       cachedResults[name] = response;
       return response;
@@ -107,7 +102,8 @@
     /************************************************************************/
     /*   EVENT HANDLERS                                                     */
     /************************************************************************/
-    void timerDelResults_Elapsed(object sender, ElapsedEventArgs e)
+
+    private void timerDelResults_Elapsed(object sender, ElapsedEventArgs e)
     {
       cachedResults = new Dictionary&lt;string, string&gt;();
     }
@@ -116,12 +112,11 @@
     /************************************************************************/
     /*   PRIVATE METHODS                                                    */
     /************************************************************************/
+
     private void SayLines(string text, TasClient tas, TasSayEventArgs e)
     {
       string[] lines = text.Split(new char[] {'\n'}, StringSplitOptions.RemoveEmptyEntries);
-      foreach (string l in lines) {
-        tas.Say(TasClient.SayPlace.User, e.UserName, l, false);
-      }
+      foreach (string l in lines) tas.Say(TasClient.SayPlace.User, e.UserName, l, false);
     }
   }
-}
+}
\ No newline at end of file

Modified: trunk/tools/springie/Springie/utils/Utils.cs
===================================================================
--- trunk/tools/springie/Springie/utils/Utils.cs	2008-04-07 18:43:12 UTC (rev 5676)
+++ trunk/tools/springie/Springie/utils/Utils.cs	2008-04-07 18:57:09 UTC (rev 5677)
@@ -1,13 +1,11 @@
 using System;
-using System.Collections.Generic;
-using System.Text;
 
 namespace Springie
 {
   /// &lt;summary&gt;
   /// General purpose static functions here
   /// &lt;/summary&gt;
-  class Utils
+  internal class Utils
   {
     /// &lt;summary&gt;
     /// Glues remaining arguments together
@@ -37,21 +35,14 @@
     public static T[] ShiftArray&lt;T&gt;(T[] input, int bynum)
     {
       T[] ret = new T[input.Length + bynum];
-      if (bynum == 0) {
-        input.CopyTo(ret, 0);
-      } else if (bynum &lt; 0) {
-        for (int i = 0; i &lt; ret.Length; ++i) {
-          ret[i] = input[i - bynum];
-        }
-      } else if (bynum &gt; 0) {
-        for (int i = 0; i &lt; input.Length; ++i) {
-          ret[i + bynum] = input[i];
-        }
-      }
+      if (bynum == 0) input.CopyTo(ret, 0);
+      else if (bynum &lt; 0) for (int i = 0; i &lt; ret.Length; ++i) ret[i] = input[i - bynum];
+      else if (bynum &gt; 0) for (int i = 0; i &lt; input.Length; ++i) ret[i + bynum] = input[i];
       return ret;
     }
 
-    public static long ToUnix(DateTime t) {
+    public static long ToUnix(DateTime t)
+    {
       if (t == DateTime.MinValue) return 0;
       return (long)(t.ToUniversalTime() - new DateTime(1970, 1, 1, 0, 0, 0)).TotalSeconds;
     }
@@ -61,6 +52,5 @@
       if (t == TimeSpan.MinValue) return 0;
       return (long)t.TotalSeconds;
     }
-
   }
-}
+}
\ No newline at end of file


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000457.html">[Taspring-linux-commit] r5676 - trunk/rts/Sim/Path
</A></li>
	<LI>Next message: <A HREF="000459.html">[Taspring-linux-commit] r5678 - trunk/rts/Sim/Path
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#458">[ date ]</a>
              <a href="thread.html#458">[ thread ]</a>
              <a href="subject.html#458">[ subject ]</a>
              <a href="author.html#458">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
