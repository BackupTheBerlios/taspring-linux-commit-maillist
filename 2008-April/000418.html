<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r5637 - trunk/rts/Sim/MoveTypes
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-April/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5637%20-%20trunk/rts/Sim/MoveTypes&In-Reply-To=%3C20080401075814.E278446AE%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="000419.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r5637 - trunk/rts/Sim/MoveTypes</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5637%20-%20trunk/rts/Sim/MoveTypes&In-Reply-To=%3C20080401075814.E278446AE%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r5637 - trunk/rts/Sim/MoveTypes">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Tue Apr  1 09:58:14 CEST 2008</I>
    <P><UL>
        
        <LI>Next message: <A HREF="000419.html">[Taspring-linux-commit] r5638 - in trunk/rts: Lua Sim/MoveTypes	Sim/Units
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#418">[ date ]</a>
              <a href="thread.html#418">[ thread ]</a>
              <a href="subject.html#418">[ subject ]</a>
              <a href="author.html#418">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: tvo
Date: 2008-04-01 09:58:14 +0200 (Tue, 01 Apr 2008)
New Revision: 5637

Modified:
   trunk/rts/Sim/MoveTypes/AirMoveType.cpp
Log:
* Formatting changes only.

Modified: trunk/rts/Sim/MoveTypes/AirMoveType.cpp
===================================================================
--- trunk/rts/Sim/MoveTypes/AirMoveType.cpp	2008-03-31 18:29:50 UTC (rev 5636)
+++ trunk/rts/Sim/MoveTypes/AirMoveType.cpp	2008-04-01 07:58:14 UTC (rev 5637)
@@ -84,6 +84,7 @@
 CR_REG_METADATA_SUB(CAirMoveType, RudderInfo, (CR_MEMBER(rotation)));
 
 
+
 CAirMoveType::CAirMoveType(CUnit* owner):
 	AAirMoveType(owner),
 	wingDrag(0.07f),
@@ -105,43 +106,46 @@
 	maneuver(0),
 	maneuverSubState(0),
 	inefficientAttackTime(0),
-	oldSlowUpdatePos(-1,-1,-1),
+	oldSlowUpdatePos(-1, -1, -1),
 	loopbackAttack(false)
 {
-	turnRadius=150;
-	if (owner)owner-&gt;mapSquare+=1;						//to force los recalculation
+	turnRadius = 150;
+	if (owner) owner-&gt;mapSquare += 1;						//to force los recalculation
 
 	//From Aircraft::Init
-	maxRudder*=0.99f+gs-&gt;randFloat()*0.02f;
-	maxElevator*=0.99f+gs-&gt;randFloat()*0.02f;
-	maxAileron*=0.99f+gs-&gt;randFloat()*0.02f;
-	maxAcc*=0.99f+gs-&gt;randFloat()*0.02f;
+	maxRudder *= 0.99f + gs-&gt;randFloat() * 0.02f;
+	maxElevator *= 0.99f + gs-&gt;randFloat() * 0.02f;
+	maxAileron *= 0.99f + gs-&gt;randFloat() * 0.02f;
+	maxAcc *= 0.99f + gs-&gt;randFloat() * 0.02f;
 
-	crashAileron=1-gs-&gt;randFloat()*gs-&gt;randFloat();
-	if(gs-&gt;randInt()&amp;1)
-		crashAileron=-crashAileron;
-	crashElevator=gs-&gt;randFloat();
-	crashRudder=gs-&gt;randFloat()-0.5f;
+	crashAileron = 1 - gs-&gt;randFloat() * gs-&gt;randFloat();
+	if (gs-&gt;randInt() &amp; 1)
+		crashAileron = -crashAileron;
+	crashElevator = gs-&gt;randFloat();
+	crashRudder = gs-&gt;randFloat() - 0.5f;
 
-	lastRudderUpdate=gs-&gt;frameNum;
-	lastElevatorPos=0;
-	lastRudderPos=0;
-	lastAileronPos=0;
+	lastRudderUpdate = gs-&gt;frameNum;
+	lastElevatorPos = 0;
+	lastRudderPos = 0;
+	lastAileronPos = 0;
 
-	exitVector=gs-&gt;randVector();
-	if(exitVector.y&lt;0)
-		exitVector.y=-exitVector.y;
-	exitVector.y+=1;
+	exitVector = gs-&gt;randVector();
+	if (exitVector.y &lt; 0)
+		exitVector.y = -exitVector.y;
+	exitVector.y += 1;
 }
 
+
+
 CAirMoveType::~CAirMoveType(void)
-{}
+{
+}
 
 
 
 void CAirMoveType::Update(void)
 {
-	float3 &amp;pos=owner-&gt;pos;
+	float3 &amp;pos = owner-&gt;pos;
 
 	//This is only set to false after the plane has finished constructing
 	if (useHeading) {
@@ -215,7 +219,7 @@
 			owner-&gt;AddBuildPower(unit-&gt;unitDef-&gt;buildSpeed/30,unit);
 			owner-&gt;currentFuel = min (owner-&gt;unitDef-&gt;maxFuel, owner-&gt;currentFuel + (owner-&gt;unitDef-&gt;maxFuel / (GAME_SPEED * owner-&gt;unitDef-&gt;refuelTime)));
 
-			if(owner-&gt;health&gt;=owner-&gt;maxHealth-1 &amp;&amp; owner-&gt;currentFuel &gt;= owner-&gt;unitDef-&gt;maxFuel){
+			if (owner-&gt;health &gt;= owner-&gt;maxHealth - 1 &amp;&amp; owner-&gt;currentFuel &gt;= owner-&gt;unitDef-&gt;maxFuel) {
 				airBaseHandler-&gt;LeaveLandingPad(reservedPad);
 				reservedPad=0;
 				padStatus=0;
@@ -229,47 +233,47 @@
 	switch (aircraftState) {
 	case AIRCRAFT_FLYING:
 #ifdef DEBUG_AIRCRAFT
-	if (selectedUnits.selectedUnits.find(this) != selectedUnits.selectedUnits.end()) {
-		logOutput.Print(&quot;Flying %i %i %.1f %i&quot;, moveState, fireState, inefficientAttackTime, (int) isFighter);
-	}
+		if (selectedUnits.selectedUnits.find(this) != selectedUnits.selectedUnits.end()) {
+			logOutput.Print(&quot;Flying %i %i %.1f %i&quot;, moveState, fireState, inefficientAttackTime, (int) isFighter);
+		}
 #endif
-		owner-&gt;restTime=0;
-		if(owner-&gt;userTarget || owner-&gt;userAttackGround){
-			inefficientAttackTime=min(inefficientAttackTime,(float)gs-&gt;frameNum-owner-&gt;lastFireWeapon);
-			if(owner-&gt;userTarget){
-				goalPos=owner-&gt;userTarget-&gt;pos;
+		owner-&gt;restTime = 0;
+		if (owner-&gt;userTarget || owner-&gt;userAttackGround) {
+			inefficientAttackTime = min(inefficientAttackTime, (float)gs-&gt;frameNum - owner-&gt;lastFireWeapon);
+			if (owner-&gt;userTarget) {
+				goalPos = owner-&gt;userTarget-&gt;pos;
 			} else {
-				goalPos=owner-&gt;userAttackPos;
+				goalPos = owner-&gt;userAttackPos;
 			}
-			if(maneuver){
+			if(maneuver) {
 				UpdateManeuver();
-				inefficientAttackTime=0;
-			} else if(isFighter &amp;&amp; goalPos.distance(pos)&lt;owner-&gt;maxRange*4){
+				inefficientAttackTime = 0;
+			} else if(isFighter &amp;&amp; goalPos.distance(pos) &lt; owner-&gt;maxRange * 4) {
 				inefficientAttackTime++;
 				UpdateFighterAttack();
-			}else{
-				inefficientAttackTime=0;
+			} else {
+				inefficientAttackTime = 0;
 				UpdateAttack();
 			}
-		}else{
-			inefficientAttackTime=0;
-			UpdateFlying(wantedHeight,1);
+		} else {
+			inefficientAttackTime = 0;
+			UpdateFlying(wantedHeight, 1);
 		}
 		break;
 	case AIRCRAFT_LANDED:
-		inefficientAttackTime=0;
+		inefficientAttackTime = 0;
 		UpdateLanded();
 		break;
 	case AIRCRAFT_LANDING:
-		inefficientAttackTime=0;
+		inefficientAttackTime = 0;
 		UpdateLanding();
 		break;
 	case AIRCRAFT_CRASHING:
-		owner-&gt;crashing=true;
-		UpdateAirPhysics(crashRudder,crashAileron,crashElevator,0,owner-&gt;frontdir);
-		SAFE_NEW CSmokeProjectile(owner-&gt;midPos,gs-&gt;randVector()*0.08f,100+gs-&gt;randFloat()*50,5,0.2f,owner,0.4f);
-		if(!(gs-&gt;frameNum&amp;3) &amp;&amp; max(0.f,ground-&gt;GetApproximateHeight(pos.x,pos.z))+5+owner-&gt;radius&gt;pos.y)
-			owner-&gt;KillUnit(true,false,0);
+		owner-&gt;crashing = true;
+		UpdateAirPhysics(crashRudder, crashAileron, crashElevator, 0, owner-&gt;frontdir);
+		SAFE_NEW CSmokeProjectile(owner-&gt;midPos, gs-&gt;randVector() * 0.08f, 100 + gs-&gt;randFloat() * 50, 5, 0.2f, owner, 0.4f);
+		if (!(gs-&gt;frameNum &amp; 3) &amp;&amp; max(0.f, ground-&gt;GetApproximateHeight(pos.x, pos.z)) + 5 + owner-&gt;radius &gt; pos.y)
+			owner-&gt;KillUnit(true, false, 0);
 		break;
 	case AIRCRAFT_TAKEOFF:
 		UpdateTakeOff(wantedHeight);
@@ -349,99 +353,106 @@
 	}
 
 #ifdef DEBUG_AIRCRAFT
-	if(lastColWarningType==1){
-		int g=geometricObjects-&gt;AddLine(owner-&gt;pos,lastColWarning-&gt;pos,10,1,1);
-		geometricObjects-&gt;SetColor(g,0.2f,1,0.2f,0.6f);
-	} else if(lastColWarningType==2){
-		int g=geometricObjects-&gt;AddLine(owner-&gt;pos,lastColWarning-&gt;pos,10,1,1);
-		if(owner-&gt;frontdir.dot(lastColWarning-&gt;midPos+lastColWarning-&gt;speed*20 - owner-&gt;midPos - owner-&gt;speed*20)&lt;0)
-			geometricObjects-&gt;SetColor(g,1,0.2f,0.2f,0.6f);
+	if (lastColWarningType==1) {
+		int g = geometricObjects-&gt;AddLine(owner-&gt;pos, lastColWarning-&gt;pos, 10, 1, 1);
+		geometricObjects-&gt;SetColor(g, 0.2f, 1, 0.2f, 0.6f);
+	} else if(lastColWarningType == 2) {
+		int g=geometricObjects-&gt;AddLine(owner-&gt;pos, lastColWarning-&gt;pos, 10, 1, 1);
+		if (owner-&gt;frontdir.dot(lastColWarning-&gt;midPos + lastColWarning-&gt;speed * 20 - owner-&gt;midPos - owner-&gt;speed * 20) &lt; 0)
+			geometricObjects-&gt;SetColor(g, 1, 0.2f, 0.2f, 0.6f);
 		else
-			geometricObjects-&gt;SetColor(g,1,1,0.2f,0.6f);
+			geometricObjects-&gt;SetColor(g, 1, 1, 0.2f, 0.6f);
 	}
 #endif
 }
 
 
+
 void CAirMoveType::SlowUpdate(void)
 {
-	if(aircraftState!=AIRCRAFT_LANDED &amp;&amp; owner-&gt;unitDef-&gt;maxFuel&gt;0)
-		owner-&gt;currentFuel = max (0.f, owner-&gt;currentFuel - (16.f/GAME_SPEED));
+	if (aircraftState != AIRCRAFT_LANDED &amp;&amp; owner-&gt;unitDef-&gt;maxFuel &gt; 0)
+		owner-&gt;currentFuel = max (0.f, owner-&gt;currentFuel - (16.f / GAME_SPEED));
 
-	if(owner-&gt;pos!=oldSlowUpdatePos) {
-		oldSlowUpdatePos=owner-&gt;pos;
-		if(owner-&gt;pos.y - ground-&gt;GetApproximateHeight(owner-&gt;pos.x, owner-&gt;pos.z) &gt; wantedHeight * 5 + 100)	//try to handle aircraft getting unlimited height
+	if (owner-&gt;pos != oldSlowUpdatePos) {
+		oldSlowUpdatePos = owner-&gt;pos;
+
+		//try to handle aircraft getting unlimited height
+		if (owner-&gt;pos.y - ground-&gt;GetApproximateHeight(owner-&gt;pos.x, owner-&gt;pos.z) &gt; wantedHeight * 5 + 100)
 			owner-&gt;pos.y = ground-&gt;GetApproximateHeight(owner-&gt;pos.x, owner-&gt;pos.z) + wantedHeight * 5  + 100;
 
-		int newmapSquare=ground-&gt;GetSquare(owner-&gt;pos);
-		if(newmapSquare!=owner-&gt;mapSquare){
-			owner-&gt;mapSquare=newmapSquare;
-			float oldlh=owner-&gt;losHeight;
-			float h=owner-&gt;pos.y-ground-&gt;GetApproximateHeight(owner-&gt;pos.x,owner-&gt;pos.z);
-			owner-&gt;losHeight=h+5;
-			loshandler-&gt;MoveUnit(owner,false);
-			if(owner-&gt;hasRadarCapacity)
+		int newmapSquare = ground-&gt;GetSquare(owner-&gt;pos);
+		if(newmapSquare != owner-&gt;mapSquare){
+			owner-&gt;mapSquare = newmapSquare;
+			float oldlh = owner-&gt;losHeight;
+			float h = owner-&gt;pos.y - ground-&gt;GetApproximateHeight(owner-&gt;pos.x, owner-&gt;pos.z);
+			owner-&gt;losHeight = h + 5;
+			loshandler-&gt;MoveUnit(owner, false);
+			if (owner-&gt;hasRadarCapacity)
 				radarhandler-&gt;MoveUnit(owner);
 
-			owner-&gt;losHeight=oldlh;
+			owner-&gt;losHeight = oldlh;
 		}
 		qf-&gt;MovedUnit(owner);
-		owner-&gt;isUnderWater=owner-&gt;pos.y+owner-&gt;model-&gt;height&lt;0;
+		owner-&gt;isUnderWater = owner-&gt;pos.y + owner-&gt;model-&gt;height &lt; 0;
 	}
 }
 
+
+
 void CAirMoveType::UpdateManeuver(void)
 {
 #ifdef DEBUG_AIRCRAFT
-	if(selectedUnits.selectedUnits.find(this)!=selectedUnits.selectedUnits.end()){
-		logOutput.Print(&quot;UpdataMan %i %i&quot;,maneuver,maneuverSubState);
+	if (selectedUnits.selectedUnits.find(this) != selectedUnits.selectedUnits.end()) {
+		logOutput.Print(&quot;UpdataMan %i %i&quot;, maneuver, maneuverSubState);
 	}
 #endif
-	float speedf=owner-&gt;speed.Length();
-	switch(maneuver){
-	case 1:{	//immelman
-		int aileron=0,elevator=0;
-		if(owner-&gt;updir.y&gt;0){
-			if(owner-&gt;rightdir.y&gt;maxAileron*speedf){
-				aileron=1;
-			}else if(owner-&gt;rightdir.y&lt;-maxAileron*speedf){
-				aileron=-1;
+	float speedf = owner-&gt;speed.Length();
+	switch(maneuver) {
+	case 1: {	//immelman
+		int aileron = 0, elevator = 0;
+		if (owner-&gt;updir.y &gt; 0) {
+			if (owner-&gt;rightdir.y &gt; maxAileron * speedf) {
+				aileron = 1;
+			} else if (owner-&gt;rightdir.y &lt; -maxAileron * speedf) {
+				aileron = -1;
 			}
 		}
-		if(fabs(owner-&gt;rightdir.y)&lt;maxAileron*3*speedf || owner-&gt;updir.y&lt;0)
-			elevator=1;
-		UpdateAirPhysics(0,aileron,elevator,1,owner-&gt;frontdir);
-		if((owner-&gt;updir.y&lt;0 &amp;&amp; owner-&gt;frontdir.y&lt;0) || speedf&lt;0.8f)
-			maneuver=0;
-		if(owner-&gt;pos.y - ground-&gt;GetApproximateHeight(owner-&gt;pos.x, owner-&gt;pos.z) &gt; wantedHeight * 4)	//some seem to report that the &quot;unlimited altitude&quot; thing is because of these maneuvers
+		if (fabs(owner-&gt;rightdir.y) &lt; maxAileron * 3 * speedf || owner-&gt;updir.y &lt; 0)
+			elevator = 1;
+		UpdateAirPhysics(0, aileron, elevator, 1, owner-&gt;frontdir);
+		if ((owner-&gt;updir.y &lt; 0 &amp;&amp; owner-&gt;frontdir.y &lt; 0) || speedf &lt; 0.8f)
 			maneuver = 0;
+		//some seem to report that the &quot;unlimited altitude&quot; thing is because of these maneuvers
+		if(owner-&gt;pos.y - ground-&gt;GetApproximateHeight(owner-&gt;pos.x, owner-&gt;pos.z) &gt; wantedHeight * 4)
+			maneuver = 0;
 		break;}
-	case 2:{	//inverted immelman
-		int aileron=0,elevator=0;
-		if(maneuverSubState==0){
-			if(owner-&gt;rightdir.y&gt;=0){
-				aileron=-1;
-			}else{
-				aileron=1;
+	case 2: {	//inverted immelman
+		int aileron = 0, elevator = 0;
+		if (maneuverSubState == 0) {
+			if (owner-&gt;rightdir.y &gt;= 0) {
+				aileron = -1;
+			} else {
+				aileron = 1;
 			}
 		}
-		if(owner-&gt;frontdir.y&lt;-0.7f)
-			maneuverSubState=1;
-		if(maneuverSubState==1 || owner-&gt;updir.y&lt;0)
-			elevator=1;
-		UpdateAirPhysics(0,aileron,elevator,1,owner-&gt;frontdir);
+		if (owner-&gt;frontdir.y &lt; -0.7f)
+			maneuverSubState = 1;
+		if (maneuverSubState == 1 || owner-&gt;updir.y &lt; 0)
+			elevator = 1;
+		UpdateAirPhysics(0, aileron, elevator, 1, owner-&gt;frontdir);
 
-		if((owner-&gt;updir.y&gt;0 &amp;&amp; owner-&gt;frontdir.y&gt;0 &amp;&amp; maneuverSubState==1) || speedf&lt;0.2f)
-			maneuver=0;
+		if ((owner-&gt;updir.y &gt; 0 &amp;&amp; owner-&gt;frontdir.y &gt; 0 &amp;&amp; maneuverSubState == 1) || speedf &lt; 0.2f)
+			maneuver = 0;
 		break;}
 	default:
-		UpdateAirPhysics(0,0,0,1,owner-&gt;frontdir);
-		maneuver=0;
+		UpdateAirPhysics(0, 0, 0, 1, owner-&gt;frontdir);
+		maneuver = 0;
 		break;
 	}
 }
 
 
+
 void CAirMoveType::UpdateFighterAttack(void)
 {
 	float3 &amp;pos = owner-&gt;pos;
@@ -450,116 +461,115 @@
 	SyncedFloat3 &amp;updir = owner-&gt;updir;
 	float3 &amp;speed = owner-&gt;speed;
 
-	float speedf=owner-&gt;speed.Length();
-	if(speedf&lt;0.01f){
-		UpdateAirPhysics(0,0,0,1,owner-&gt;frontdir);
+	float speedf = owner-&gt;speed.Length();
+	if (speedf &lt; 0.01f){
+		UpdateAirPhysics(0, 0, 0, 1, owner-&gt;frontdir);
 		return;
 	}
 
-	if(!((gs-&gt;frameNum+owner-&gt;id)&amp;3))
+	if (!((gs-&gt;frameNum + owner-&gt;id) &amp; 3))
 		CheckForCollision();
 
-	bool groundTarget=!owner-&gt;userTarget || !owner-&gt;userTarget-&gt;unitDef-&gt;canfly || owner-&gt;userTarget-&gt;unitDef-&gt;hoverAttack;
-	bool airTarget=owner-&gt;userTarget &amp;&amp; owner-&gt;userTarget-&gt;unitDef-&gt;canfly &amp;&amp; !owner-&gt;userTarget-&gt;unitDef-&gt;hoverAttack;	//only &quot;real&quot; aircrafts (non gunship)
-	if(groundTarget){
-		if(frontdir.dot(goalPos-pos)&lt;0 &amp;&amp; (pos-goalPos).SqLength()&lt;turnRadius*turnRadius*(loopbackAttack?4:1)){
-			float3 dif=pos-goalPos;
-			dif.y=0;
+	bool groundTarget = !owner-&gt;userTarget || !owner-&gt;userTarget-&gt;unitDef-&gt;canfly || owner-&gt;userTarget-&gt;unitDef-&gt;hoverAttack;
+	bool airTarget = owner-&gt;userTarget &amp;&amp; owner-&gt;userTarget-&gt;unitDef-&gt;canfly &amp;&amp; !owner-&gt;userTarget-&gt;unitDef-&gt;hoverAttack;	//only &quot;real&quot; aircrafts (non gunship)
+	if (groundTarget) {
+		if (frontdir.dot(goalPos - pos) &lt; 0 &amp;&amp; (pos - goalPos).SqLength() &lt; turnRadius * turnRadius * (loopbackAttack ? 4 : 1)) {
+			float3 dif = pos - goalPos;
+			dif.y = 0;
 			dif.Normalize();
-			goalPos=goalPos+dif*turnRadius*4;
-		} else if (loopbackAttack &amp;&amp; !airTarget){
-			bool hasFired=false;
-			if(!owner-&gt;weapons.empty() &amp;&amp; owner-&gt;weapons[0]-&gt;reloadStatus &gt; gs-&gt;frameNum &amp;&amp; owner-&gt;weapons[0]-&gt;salvoLeft==0)
-				hasFired=true;
-			if( frontdir.dot(goalPos-pos)&lt;owner-&gt;maxRange*(hasFired?1.0f:0.7f)){
-				maneuver=1;
-			}
-		} else if(frontdir.dot(goalPos-pos)&lt;owner-&gt;maxRange*0.7f){
-			goalPos+=exitVector*(owner-&gt;userTarget?owner-&gt;userTarget-&gt;radius+owner-&gt;radius+10:owner-&gt;radius+40);
+			goalPos = goalPos + dif * turnRadius * 4;
+		} else if (loopbackAttack &amp;&amp; !airTarget) {
+			bool hasFired = false;
+			if (!owner-&gt;weapons.empty() &amp;&amp; owner-&gt;weapons[0]-&gt;reloadStatus &gt; gs-&gt;frameNum &amp;&amp; owner-&gt;weapons[0]-&gt;salvoLeft == 0)
+				hasFired = true;
+			if (frontdir.dot(goalPos - pos) &lt; owner-&gt;maxRange * (hasFired ? 1.0f : 0.7f))
+				maneuver = 1;
+		} else if (frontdir.dot(goalPos - pos) &lt; owner-&gt;maxRange * 0.7f) {
+			goalPos += exitVector * (owner-&gt;userTarget ? owner-&gt;userTarget-&gt;radius + owner-&gt;radius + 10 : owner-&gt;radius + 40);
 		}
 	}
-	float3 tgp=goalPos+(goalPos-oldGoalPos)*8;
-	oldGoalPos=goalPos;
-	goalPos=tgp;
+	float3 tgp = goalPos + (goalPos - oldGoalPos) * 8;
+	oldGoalPos = goalPos;
+	goalPos = tgp;
 
-	float goalLength=(goalPos-pos).Length();
-	float3 goalDir=(goalPos-pos)/goalLength;
+	float goalLength = (goalPos - pos).Length();
+	float3 goalDir = (goalPos - pos) / goalLength;
 
-	float aileron=0;
-	float rudder=0;
-	float elevator=0;
-	float engine=0;
+	float aileron = 0;
+	float rudder = 0;
+	float elevator = 0;
+	float engine = 0;
 
-	float gHeight=ground-&gt;GetHeight(pos.x,pos.z);
+	float gHeight = ground-&gt;GetHeight(pos.x, pos.z);
 
-	float goalDot=rightdir.dot(goalDir);
-	goalDot/=goalDir.dot(frontdir)*0.5f+0.501f;
+	float goalDot = rightdir.dot(goalDir);
+	goalDot /= goalDir.dot(frontdir) * 0.5f + 0.501f;
 
-	if(goalDir.dot(frontdir)&lt;-0.2f+inefficientAttackTime*0.002f &amp;&amp; frontdir.y&gt;-0.2f &amp;&amp; speedf&gt;2.0f &amp;&amp; gs-&gt;randFloat()&gt;0.996f)
-		maneuver=1;
+	if (goalDir.dot(frontdir) &lt; -0.2f + inefficientAttackTime * 0.002f &amp;&amp; frontdir.y &gt; -0.2f &amp;&amp; speedf &gt; 2.0f &amp;&amp; gs-&gt;randFloat() &gt; 0.996f)
+		maneuver = 1;
 
-	if(goalDir.dot(frontdir)&lt;-0.2f+inefficientAttackTime*0.002f &amp;&amp; fabs(frontdir.y)&lt;0.2f &amp;&amp; gs-&gt;randFloat()&gt;0.996f &amp;&amp; gHeight+400&lt;pos.y){
-		maneuver=2;
-		maneuverSubState=0;
+	if (goalDir.dot(frontdir) &lt; -0.2f + inefficientAttackTime * 0.002f &amp;&amp; fabs(frontdir.y) &lt; 0.2f &amp;&amp; gs-&gt;randFloat() &gt; 0.996f &amp;&amp; gHeight + 400 &lt; pos.y) {
+		maneuver = 2;
+		maneuverSubState = 0;
 	}
 
 	//roll
-	if(speedf&gt;0.45f &amp;&amp; pos.y+owner-&gt;speed.y*60*fabs(frontdir.y)+min(0.f,updir.y)*150&gt;gHeight+60+fabs(rightdir.y)*150){
-		float goalBankDif=goalDot+rightdir.y*0.2f;
-		if(goalBankDif&gt;maxAileron*speedf*4){
-			aileron=1;
-		} else if(goalBankDif&lt;-maxAileron*speedf*4){
-			aileron=-1;
+	if (speedf &gt; 0.45f &amp;&amp; pos.y + owner-&gt;speed.y * 60 * fabs(frontdir.y) + min(0.f, updir.y) * 150 &gt; gHeight + 60 + fabs(rightdir.y) * 150) {
+		float goalBankDif = goalDot + rightdir.y * 0.2f;
+		if (goalBankDif &gt; maxAileron * speedf * 4) {
+			aileron = 1;
+		} else if(goalBankDif &lt; -maxAileron * speedf * 4) {
+			aileron = -1;
 		} else {
-			aileron=goalBankDif/(maxAileron*speedf*4);
+			aileron = goalBankDif / (maxAileron * speedf * 4);
 		}
 	} else {
-		if(rightdir.y&gt;0){
-			if(rightdir.y&gt;maxAileron*speedf || frontdir.y&lt;-0.7f)
-				aileron=1;
+		if (rightdir.y &gt; 0) {
+			if (rightdir.y &gt; maxAileron * speedf || frontdir.y &lt; -0.7f)
+				aileron = 1;
 			else
-				aileron=rightdir.y/(maxAileron*speedf);
+				aileron = rightdir.y / (maxAileron * speedf);
 		} else {
-			if(rightdir.y&lt;-maxAileron*speedf || frontdir.y&lt;-0.7f)
-				aileron=-1;
+			if (rightdir.y &lt; -maxAileron * speedf || frontdir.y &lt; -0.7f)
+				aileron = -1;
 			else
-				aileron=rightdir.y/(maxAileron*speedf);
+				aileron = rightdir.y / (maxAileron * speedf);
 		}
 	}
 
 	//yaw
-	if(pos.y&gt;gHeight+30){
-		if(goalDot&lt;-maxRudder*speedf){
-			rudder=-1;
-		} else if(goalDot&gt;maxRudder*speedf){
-			rudder=1;
+	if (pos.y &gt; gHeight + 30) {
+		if (goalDot &lt; -maxRudder * speedf) {
+			rudder = -1;
+		} else if (goalDot &gt; maxRudder * speedf) {
+			rudder = 1;
 		} else {
-			rudder=goalDot/(maxRudder*speedf);
+			rudder = goalDot / (maxRudder * speedf);
 		}
 	}
 
-	float upside=1;
-	if(updir.y&lt;-0.3f)
-		upside=-1;
+	float upside = 1;
+	if (updir.y &lt; -0.3f)
+		upside = -1;
 
 	//pitch
-	if(speedf&lt;1.5f){
-		if(frontdir.y&lt;0.0f){
+	if (speedf &lt; 1.5f) {
+		if (frontdir.y &lt; 0.0f) {
 			elevator=upside;
-		} else if(frontdir.y&gt;0.0f){
+		} else if(frontdir.y &gt; 0.0f) {
 			elevator=-upside;
 		}
 	} else {
-		float gHeight2=ground-&gt;GetHeight(pos.x+speed.x*40,pos.z+speed.z*40);
-		float hdif=max(gHeight,gHeight2)+60-pos.y-frontdir.y*speedf*20;
+		float gHeight2 = ground-&gt;GetHeight(pos.x + speed.x * 40, pos.z + speed.z * 40);
+		float hdif = max(gHeight, gHeight2) + 60 - pos.y - frontdir.y * speedf * 20;
 		float minPitch;//=min(1.0f,hdif/(maxElevator*speedf*speedf*20));
 
-		if(hdif&lt;-(maxElevator*speedf*speedf*20)){
-			minPitch=-1;
-		} else if(hdif&gt;(maxElevator*speedf*speedf*20)){
-			minPitch=1;
+		if (hdif &lt; -(maxElevator * speedf * speedf * 20)) {
+			minPitch = -1;
+		} else if (hdif &gt; (maxElevator * speedf * speedf * 20)) {
+			minPitch = 1;
 		} else {
-			minPitch=hdif/(maxElevator*speedf*speedf*20);
+			minPitch = hdif / (maxElevator * speedf * speedf * 20);
 		}
 
 /*		if(pos.y+min(0,owner-&gt;speed.y)*70*fabs(frontdir.y)+min(0,updir.y)*50&lt;gHeight+50){
@@ -569,38 +579,38 @@
 			elevator=-upside;
 		}*/
 //	} else {
-		if(lastColWarning &amp;&amp; lastColWarningType==2 &amp;&amp; frontdir.dot(lastColWarning-&gt;pos+lastColWarning-&gt;speed*20-pos-owner-&gt;speed*20)&lt;0){
+		if(lastColWarning &amp;&amp; lastColWarningType == 2 &amp;&amp; frontdir.dot(lastColWarning-&gt;pos + lastColWarning-&gt;speed * 20 - pos-owner-&gt;speed * 20) &lt; 0) {
 /*			float pitchMod=updir.y&gt;0?1:-1;
 			if(lastColWarning-&gt;pos.y&gt;pos.y)
 				elevator=-pitchMod;
 			else
 				elevator=pitchMod;
-/*/			elevator=updir.dot(lastColWarning-&gt;midPos-owner-&gt;midPos)&gt;0?-1:1;/**/
+/*/			elevator = updir.dot(lastColWarning-&gt;midPos - owner-&gt;midPos) &gt; 0 ? -1 : 1;/**/
 		} else {
-			float hdif=goalDir.dot(updir);
-			if(hdif&lt;-maxElevator*speedf){
-				elevator=-1;
-			} else if(hdif&gt;maxElevator*speedf){
-				elevator=1;
+			float hdif = goalDir.dot(updir);
+			if (hdif &lt; -maxElevator * speedf) {
+				elevator = -1;
+			} else if (hdif &gt; maxElevator * speedf) {
+				elevator = 1;
 			} else {
-				elevator=hdif/(maxElevator*speedf);
+				elevator = hdif / (maxElevator * speedf);
 			}
 		}
-		if(elevator*upside&lt;minPitch)
-			elevator=minPitch*upside;
+		if (elevator * upside &lt; minPitch)
+			elevator = minPitch * upside;
 	}
 #ifdef DEBUG_AIRCRAFT
-	if(selectedUnits.selectedUnits.find(this)!=selectedUnits.selectedUnits.end()){
-		logOutput.Print(&quot;FAttack %.1f %.1f %.2f&quot;,pos.y-gHeight,goalLength,goalDir.dot(frontdir));
+	if (selectedUnits.selectedUnits.find(this) != selectedUnits.selectedUnits.end()){
+		logOutput.Print(&quot;FAttack %.1f %.1f %.2f&quot;, pos.y - gHeight, goalLength, goalDir.dot(frontdir));
 	}
 #endif
 
 	if(groundTarget)
-		engine=1;
+		engine = 1;
 	else
-		engine=min(1.f,(float)(goalLength/owner-&gt;maxRange+1-goalDir.dot(frontdir)*0.7f));
+		engine = min(1.f, (float)(goalLength / owner-&gt;maxRange + 1 - goalDir.dot(frontdir) * 0.7f));
 
-	UpdateAirPhysics(rudder,aileron,elevator,engine,owner-&gt;frontdir);
+	UpdateAirPhysics(rudder, aileron, elevator, engine, owner-&gt;frontdir);
 /*
 	std::vector&lt;CWeapon*&gt;::iterator wi;
 	for(wi=owner-&gt;weapons.begin();wi!=owner-&gt;weapons.end();++wi){
@@ -621,6 +631,7 @@
 }
 
 
+
 void CAirMoveType::UpdateAttack(void)
 {
 	/*
@@ -636,6 +647,7 @@
 }
 
 
+
 void CAirMoveType::UpdateFlying(float wantedHeight, float engine)
 {
 	float3 &amp;pos = owner-&gt;pos;
@@ -727,15 +739,15 @@
 			}
 		}
 		if (notColliding) {
-			float gHeight2=ground-&gt;GetHeight(pos.x+speed.x*40,pos.z+speed.z*40);
-			float hdif=max(gHeight,gHeight2)+wantedHeight-pos.y-frontdir.y*speedf*20;
-			if(hdif&lt;-(maxElevator*speedf*speedf*20) &amp;&amp; frontdir.y&gt;-maxPitch){
-				elevator=-1;
-			} else if(hdif&gt;(maxElevator*speedf*speedf*20) &amp;&amp; frontdir.y&lt;maxPitch){
-				elevator=1;
+			float gHeight2 = ground-&gt;GetHeight(pos.x + speed.x * 40, pos.z + speed.z * 40);
+			float hdif = max(gHeight, gHeight2) + wantedHeight - pos.y - frontdir.y * speedf * 20;
+			if (hdif &lt; -(maxElevator * speedf * speedf * 20) &amp;&amp; frontdir.y &gt; -maxPitch) {
+				elevator = -1;
+			} else if (hdif &gt; (maxElevator * speedf * speedf * 20) &amp;&amp; frontdir.y &lt; maxPitch) {
+				elevator = 1;
 			} else {
-				if(fabs(frontdir.y)&lt;maxPitch)
-					elevator=hdif/(maxElevator*speedf*speedf*20);
+				if (fabs(frontdir.y) &lt; maxPitch)
+					elevator = hdif / (maxElevator * speedf * speedf * 20);
 			}
 		}
 	}
@@ -769,6 +781,8 @@
 	updir = rightdir.cross(frontdir);
 }
 
+
+
 void CAirMoveType::UpdateTakeOff(float wantedHeight)
 {
 	float3&amp; pos=owner-&gt;pos;
@@ -802,6 +816,8 @@
 	owner-&gt;midPos = pos + (owner-&gt;frontdir * owner-&gt;relMidPos.z) + (owner-&gt;updir * owner-&gt;relMidPos.y) + (owner-&gt;rightdir * owner-&gt;relMidPos.x);
 }
 
+
+
 void CAirMoveType::UpdateLanding(void)
 {
 	float3 &amp;pos = owner-&gt;pos;
@@ -1002,10 +1018,12 @@
 #endif
 }
 
+
+
 void CAirMoveType::SetState(AAirMoveType::AircraftState state)
 {
 	assert(state != AIRCRAFT_HOVERING);
-	if(aircraftState==AIRCRAFT_CRASHING || state==aircraftState)
+	if (aircraftState == AIRCRAFT_CRASHING || state == aircraftState)
 		return;
 
 /*	if (state == AIRCRAFT_LANDING)
@@ -1018,34 +1036,38 @@
 		owner-&gt;cob-&gt;Call(COBFN_StartMoving);
 	}
 
-	if(state==AIRCRAFT_LANDED){
-		owner-&gt;heading=GetHeadingFromVector(owner-&gt;frontdir.x, owner-&gt;frontdir.z);
+	if (state == AIRCRAFT_LANDED) {
+		owner-&gt;heading = GetHeadingFromVector(owner-&gt;frontdir.x, owner-&gt;frontdir.z);
 		owner-&gt;physicalState = CSolidObject::OnGround;
-		owner-&gt;useAirLos=false;
-	}else{
+		owner-&gt;useAirLos = false;
+	} else {
 		owner-&gt;physicalState = CSolidObject::Flying;
-		owner-&gt;useAirLos=true;
-		if(state!=AIRCRAFT_LANDING){
-			reservedLandingPos.x=-1;
+		owner-&gt;useAirLos = true;
+		if(state != AIRCRAFT_LANDING) {
+			reservedLandingPos.x = -1;
 			owner-&gt;UnBlock();
 		}
 	}
 
-	if(aircraftState==AIRCRAFT_LANDED &amp;&amp; reservedLandingPos.x&gt;0){
-		reservedLandingPos.x=-1;
+	if (aircraftState == AIRCRAFT_LANDED &amp;&amp; reservedLandingPos.x &gt; 0) {
+		reservedLandingPos.x = -1;
 	}
-	subState=0;
-	if(state!=AIRCRAFT_TAKEOFF || aircraftState==AIRCRAFT_LANDED)		//make sure we only go into takeoff if actually landed
-		aircraftState=state;
+	subState = 0;
+
+	//make sure we only go into takeoff if actually landed
+	if (state != AIRCRAFT_TAKEOFF || aircraftState == AIRCRAFT_LANDED)
+		aircraftState = state;
 	else
-		aircraftState=AIRCRAFT_TAKEOFF;
+		aircraftState = AIRCRAFT_TAKEOFF;
 }
 
+
+
 void CAirMoveType::ImpulseAdded(void)
 {
-	if(aircraftState==AIRCRAFT_FLYING){
-		owner-&gt;speed+=owner-&gt;residualImpulse;
-		owner-&gt;residualImpulse=ZeroVector;
+	if (aircraftState == AIRCRAFT_FLYING) {
+		owner-&gt;speed += owner-&gt;residualImpulse;
+		owner-&gt;residualImpulse = ZeroVector;
 	}
 }
 
@@ -1088,93 +1110,116 @@
 {
 	if (!collide) return;
 
-	SyncedFloat3&amp; pos=owner-&gt;midPos;
-	SyncedFloat3&amp; forward=owner-&gt;frontdir;
-	float3 midTestPos=pos+forward*121;
+	SyncedFloat3&amp; pos = owner-&gt;midPos;
+	SyncedFloat3&amp; forward = owner-&gt;frontdir;
+	float3 midTestPos = pos + forward * 121;
 
-	std::vector&lt;CUnit*&gt; others=qf-&gt;GetUnitsExact(midTestPos,115);
+	std::vector&lt;CUnit*&gt; others = qf-&gt;GetUnitsExact(midTestPos, 115);
 
-	float dist=200;
-	if(lastColWarning){
+	float dist = 200;
+	if (lastColWarning) {
 		DeleteDeathDependence(lastColWarning);
-		lastColWarning=0;
-		lastColWarningType=0;
+		lastColWarning = 0;
+		lastColWarningType = 0;
 	}
 
-	for(std::vector&lt;CUnit*&gt;::iterator ui=others.begin();ui!=others.end();++ui){
-		if(*ui==owner || !(*ui)-&gt;unitDef-&gt;canfly)
+	for (std::vector&lt;CUnit*&gt;::iterator ui = others.begin(); ui != others.end(); ++ui) {
+		if (*ui == owner || !(*ui)-&gt;unitDef-&gt;canfly)
 			continue;
-		SyncedFloat3&amp; op=(*ui)-&gt;midPos;
-		float3 dif=op-pos;
-		float3 forwardDif=forward*(forward.dot(dif));
-		if(forwardDif.SqLength()&lt;dist*dist){
-			float frontLength=forwardDif.Length();
-			float3 ortoDif=dif-forwardDif;
-			float minOrtoDif=((*ui)-&gt;radius+owner-&gt;radius)*2+frontLength*0.1f+10;		//note that the radiuses is multiplied by two since we rely on the aircrafts having to small radiuses (see unitloader)
-			if(ortoDif.SqLength()&lt;minOrtoDif*minOrtoDif){
-				dist=frontLength;
-				lastColWarning=(*ui);
+		SyncedFloat3&amp; op = (*ui)-&gt;midPos;
+		float3 dif = op - pos;
+		float3 forwardDif = forward * (forward.dot(dif));
+		if (forwardDif.SqLength() &lt; dist * dist) {
+			float frontLength = forwardDif.Length();
+			float3 ortoDif = dif - forwardDif;
+			//note that the radiuses is multiplied by two since we rely on
+			//the aircrafts having to small radiuses (see unitloader)
+			float minOrtoDif = ((*ui)-&gt;radius + owner-&gt;radius) * 2 + frontLength * 0.1f + 10;
+			if (ortoDif.SqLength() &lt; minOrtoDif * minOrtoDif) {
+				dist = frontLength;
+				lastColWarning = (*ui);
 			}
 		}
 	}
-	if(lastColWarning){
-		lastColWarningType=2;
+	if (lastColWarning) {
+		lastColWarningType = 2;
 		AddDeathDependence(lastColWarning);
 		return;
 	}
-	for(std::vector&lt;CUnit*&gt;::iterator ui=others.begin();ui!=others.end();++ui){
-		if(*ui==owner)
+	for (std::vector&lt;CUnit*&gt;::iterator ui = others.begin(); ui != others.end(); ++ui) {
+		if (*ui == owner)
 			continue;
-		if(((*ui)-&gt;midPos-pos).SqLength()&lt;dist*dist){
-			lastColWarning=*ui;
+		if (((*ui)-&gt;midPos - pos).SqLength() &lt; dist * dist) {
+			lastColWarning = *ui;
 		}
 	}
-	if(lastColWarning){
-		lastColWarningType=1;
+	if (lastColWarning) {
+		lastColWarningType = 1;
 		AddDeathDependence(lastColWarning);
 	}
 	return;
 }
 
+
+
 void CAirMoveType::DependentDied(CObject* o)
 {
-	if(o==lastColWarning){
-		lastColWarning=0;
-		lastColWarningType=0;
+	if(o == lastColWarning){
+		lastColWarning = 0;
+		lastColWarningType = 0;
 	}
 	AMoveType::DependentDied(o);
 }
 
+
+
 void CAirMoveType::SetMaxSpeed(float speed)
 {
-	maxSpeed=speed;
-	if(owner-&gt;unitDef-&gt;maxAcc!=0 &amp;&amp; owner-&gt;maxSpeed!=0){
-		float drag=1.0f/(maxSpeed/GAME_SPEED*1.1f/maxAcc) - wingAngle*wingAngle*wingDrag;		//meant to set the drag such that the maxspeed becomes what it should be
-		invDrag = 1-drag;
+	maxSpeed = speed;
+	if (owner-&gt;unitDef-&gt;maxAcc != 0 &amp;&amp; owner-&gt;maxSpeed != 0) {
+		//meant to set the drag such that the maxspeed becomes what it should be
+		float drag = 1.0f / (maxSpeed / GAME_SPEED * 1.1f / maxAcc) - wingAngle * wingAngle * wingDrag;
+		invDrag = 1 - drag;
 	}
 }
 
 
-void CAirMoveType::KeepPointingTo(float3 pos, float distance, bool aggressive) {
-	
+
+void CAirMoveType::KeepPointingTo(float3 pos, float distance, bool aggressive)
+{
 }
-void CAirMoveType::StartMoving(float3 pos, float goalRadius) {
+
+
+
+void CAirMoveType::StartMoving(float3 pos, float goalRadius)
+{
 	SetGoal(pos);
 }
-void CAirMoveType::StartMoving(float3 pos, float goalRadius, float speed) {
+
+
+
+void CAirMoveType::StartMoving(float3 pos, float goalRadius, float speed)
+{
 	SetWantedMaxSpeed(speed);
 	SetGoal(pos);
 }
-void CAirMoveType::StopMoving() {
+
+
+
+void CAirMoveType::StopMoving()
+{
 	SetGoal(owner-&gt;pos);
-	if((aircraftState == AAirMoveType::AIRCRAFT_FLYING)
+	if ((aircraftState == AAirMoveType::AIRCRAFT_FLYING)
 	   &amp;&amp; !owner-&gt;unitDef-&gt;DontLand() &amp;&amp; autoLand) {
 		SetState(AAirMoveType::AIRCRAFT_LANDING);
 	}
 }
 
-void CAirMoveType::Takeoff() {
-	if(aircraftState==AAirMoveType::AIRCRAFT_LANDED) {
+
+
+void CAirMoveType::Takeoff()
+{
+	if (aircraftState == AAirMoveType::AIRCRAFT_LANDED) {
 		SetState(AAirMoveType::AIRCRAFT_TAKEOFF);
 	}
 	if (aircraftState == AAirMoveType::AIRCRAFT_LANDING) {
@@ -1182,7 +1227,9 @@
 	}
 }
 
-bool CAirMoveType::IsFighter() {
+
+
+bool CAirMoveType::IsFighter()
+{
 	return isFighter;
 }
-


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message: <A HREF="000419.html">[Taspring-linux-commit] r5638 - in trunk/rts: Lua Sim/MoveTypes	Sim/Units
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#418">[ date ]</a>
              <a href="thread.html#418">[ thread ]</a>
              <a href="subject.html#418">[ subject ]</a>
              <a href="author.html#418">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
