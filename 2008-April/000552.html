<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r5772 - in trunk/rts: ExternalAI Game	Game/StartScripts Game/UI Lua Map Map/SM3 Map/SM3/terrain	Map/SMF Rendering Rendering/Env Rendering/UnitModels	Sim/Features Sim/Misc Sim/MoveTypes Sim/MoveTypes/MoveMath	Sim/Path Sim/Projectiles Sim/Projectiles/Unsynced	Sim/Projectiles/WeaponProjectiles Sim/Units	Sim/Units/UnitTypes Sim/Weapons System System/Script build/vstudio8
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-April/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5772%20-%20in%20trunk/rts%3A%20ExternalAI%20Game%0A%09Game/StartScripts%20Game/UI%20Lua%20Map%20Map/SM3%20Map/SM3/terrain%0A%09Map/SMF%20Rendering%20Rendering/Env%20Rendering/UnitModels%0A%09Sim/Features%20Sim/Misc%20Sim/MoveTypes%20Sim/MoveTypes/MoveMath%0A%09Sim/Path%20Sim/Projectiles%20Sim/Projectiles/Unsynced%0A%09Sim/Projectiles/WeaponProjectiles%20Sim/Units%0A%09Sim/Units/UnitTypes%20Sim/Weapons%20System%20System/Script%20build/vstudio8&In-Reply-To=%3C20080424121358.63262469F%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000551.html">
   <LINK REL="Next"  HREF="000553.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r5772 - in trunk/rts: ExternalAI Game	Game/StartScripts Game/UI Lua Map Map/SM3 Map/SM3/terrain	Map/SMF Rendering Rendering/Env Rendering/UnitModels	Sim/Features Sim/Misc Sim/MoveTypes Sim/MoveTypes/MoveMath	Sim/Path Sim/Projectiles Sim/Projectiles/Unsynced	Sim/Projectiles/WeaponProjectiles Sim/Units	Sim/Units/UnitTypes Sim/Weapons System System/Script build/vstudio8</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5772%20-%20in%20trunk/rts%3A%20ExternalAI%20Game%0A%09Game/StartScripts%20Game/UI%20Lua%20Map%20Map/SM3%20Map/SM3/terrain%0A%09Map/SMF%20Rendering%20Rendering/Env%20Rendering/UnitModels%0A%09Sim/Features%20Sim/Misc%20Sim/MoveTypes%20Sim/MoveTypes/MoveMath%0A%09Sim/Path%20Sim/Projectiles%20Sim/Projectiles/Unsynced%0A%09Sim/Projectiles/WeaponProjectiles%20Sim/Units%0A%09Sim/Units/UnitTypes%20Sim/Weapons%20System%20System/Script%20build/vstudio8&In-Reply-To=%3C20080424121358.63262469F%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r5772 - in trunk/rts: ExternalAI Game	Game/StartScripts Game/UI Lua Map Map/SM3 Map/SM3/terrain	Map/SMF Rendering Rendering/Env Rendering/UnitModels	Sim/Features Sim/Misc Sim/MoveTypes Sim/MoveTypes/MoveMath	Sim/Path Sim/Projectiles Sim/Projectiles/Unsynced	Sim/Projectiles/WeaponProjectiles Sim/Units	Sim/Units/UnitTypes Sim/Weapons System System/Script build/vstudio8">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Thu Apr 24 14:13:57 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000551.html">[Taspring-linux-commit] r5771 - in trunk/rts: ExternalAI System
</A></li>
        <LI>Next message: <A HREF="000553.html">[Taspring-linux-commit] r5773 - trunk/rts/Map/SM3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#552">[ date ]</a>
              <a href="thread.html#552">[ thread ]</a>
              <a href="subject.html#552">[ subject ]</a>
              <a href="author.html#552">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: tvo
Date: 2008-04-24 14:13:55 +0200 (Thu, 24 Apr 2008)
New Revision: 5772

Added:
   trunk/rts/Map/HeightLinePalette.cpp
   trunk/rts/Map/HeightLinePalette.h
   trunk/rts/Map/MapInfo.cpp
   trunk/rts/Map/MapInfo.h
Modified:
   trunk/rts/ExternalAI/AICallback.cpp
   trunk/rts/ExternalAI/aibase.h
   trunk/rts/Game/Camera.cpp
   trunk/rts/Game/Game.cpp
   trunk/rts/Game/GameSetup.cpp
   trunk/rts/Game/StartScripts/CommanderScript.cpp
   trunk/rts/Game/StartScripts/CommanderScript2.cpp
   trunk/rts/Game/StartScripts/GlobalAITestScript.cpp
   trunk/rts/Game/StartScripts/SpawnScript.cpp
   trunk/rts/Game/UI/GameInfo.cpp
   trunk/rts/Game/UI/GuiHandler.cpp
   trunk/rts/Game/UI/TooltipConsole.cpp
   trunk/rts/Lua/LuaConstGame.cpp
   trunk/rts/Lua/LuaOpenGL.cpp
   trunk/rts/Lua/LuaSyncedCtrl.cpp
   trunk/rts/Lua/LuaSyncedRead.cpp
   trunk/rts/Lua/LuaUnitDefs.cpp
   trunk/rts/Map/BaseGroundDrawer.cpp
   trunk/rts/Map/BaseGroundDrawer.h
   trunk/rts/Map/BasicMapDamage.cpp
   trunk/rts/Map/Ground.h
   trunk/rts/Map/MapDamage.cpp
   trunk/rts/Map/ReadMap.cpp
   trunk/rts/Map/ReadMap.h
   trunk/rts/Map/SM3/Sm3GroundDrawer.cpp
   trunk/rts/Map/SM3/Sm3Map.cpp
   trunk/rts/Map/SM3/terrain/Terrain.cpp
   trunk/rts/Map/SM3/terrain/Terrain.h
   trunk/rts/Map/SM3/terrain/TerrainTexture.cpp
   trunk/rts/Map/SM3/terrain/TerrainTexture.h
   trunk/rts/Map/SM3/terrain/Textures.cpp
   trunk/rts/Map/SM3/terrain/Textures.h
   trunk/rts/Map/SMF/BFGroundDrawer.cpp
   trunk/rts/Map/SMF/SmfReadMap.cpp
   trunk/rts/Rendering/Env/AdvSky.cpp
   trunk/rts/Rendering/Env/AdvTreeDrawer.cpp
   trunk/rts/Rendering/Env/AdvTreeGenerator.cpp
   trunk/rts/Rendering/Env/AdvWater.cpp
   trunk/rts/Rendering/Env/BaseSky.cpp
   trunk/rts/Rendering/Env/BasicSky.cpp
   trunk/rts/Rendering/Env/BasicTreeDrawer.cpp
   trunk/rts/Rendering/Env/BasicWater.cpp
   trunk/rts/Rendering/Env/DynWater.cpp
   trunk/rts/Rendering/Env/GrassDrawer.cpp
   trunk/rts/Rendering/Env/SkyBox.cpp
   trunk/rts/Rendering/FartextureHandler.cpp
   trunk/rts/Rendering/GroundDecalHandler.cpp
   trunk/rts/Rendering/InMapDraw.cpp
   trunk/rts/Rendering/ShadowHandler.cpp
   trunk/rts/Rendering/UnitModels/UnitDrawer.cpp
   trunk/rts/Sim/Features/FeatureHandler.cpp
   trunk/rts/Sim/Misc/RadarHandler.cpp
   trunk/rts/Sim/Misc/Wind.cpp
   trunk/rts/Sim/MoveTypes/AirMoveType.cpp
   trunk/rts/Sim/MoveTypes/GroundMoveType.cpp
   trunk/rts/Sim/MoveTypes/MoveInfo.cpp
   trunk/rts/Sim/MoveTypes/MoveMath/HoverMoveMath.cpp
   trunk/rts/Sim/MoveTypes/ScriptMoveType.cpp
   trunk/rts/Sim/Path/PathManager.cpp
   trunk/rts/Sim/Projectiles/FlareProjectile.cpp
   trunk/rts/Sim/Projectiles/PieceProjectile.cpp
   trunk/rts/Sim/Projectiles/Projectile.cpp
   trunk/rts/Sim/Projectiles/ProjectileHandler.cpp
   trunk/rts/Sim/Projectiles/Unsynced/DirtProjectile.cpp
   trunk/rts/Sim/Projectiles/Unsynced/SmokeProjectile2.cpp
   trunk/rts/Sim/Projectiles/Unsynced/SmokeTrailProjectile.cpp
   trunk/rts/Sim/Projectiles/Unsynced/WreckProjectile.cpp
   trunk/rts/Sim/Projectiles/WeaponProjectiles/ExplosiveProjectile.cpp
   trunk/rts/Sim/Projectiles/WeaponProjectiles/FireBallProjectile.cpp
   trunk/rts/Sim/Projectiles/WeaponProjectiles/MissileProjectile.cpp
   trunk/rts/Sim/Projectiles/WeaponProjectiles/StarburstProjectile.cpp
   trunk/rts/Sim/Projectiles/WeaponProjectiles/TorpedoProjectile.cpp
   trunk/rts/Sim/Projectiles/WeaponProjectiles/WeaponProjectile.cpp
   trunk/rts/Sim/Units/Unit.cpp
   trunk/rts/Sim/Units/UnitDefHandler.cpp
   trunk/rts/Sim/Units/UnitHandler.cpp
   trunk/rts/Sim/Units/UnitLoader.cpp
   trunk/rts/Sim/Units/UnitTypes/Builder.cpp
   trunk/rts/Sim/Weapons/Cannon.cpp
   trunk/rts/Sim/Weapons/bombdropper.cpp
   trunk/rts/System/GlobalStuff.cpp
   trunk/rts/System/GlobalStuff.h
   trunk/rts/System/Script/LuaFunctions.cpp
   trunk/rts/System/TdfParser.cpp
   trunk/rts/System/TdfParser.h
   trunk/rts/build/vstudio8/rts.vcproj
Log:
* Removed unnecessary #include &lt;windows.h&gt; from aibase.h
* Removed using namespace std from Ground.h
* Added missing std:: to min &amp; max, probably because of the above.
* Factored map settings (.smd file) out of CReadMap into CMapInfo.
  All the (non-SM3) settings are together now in MapInfo.h!
* Moved CGlobalSyncedStuff::sunVector and sunVector4 into CMapInfo,
  as light.sunDir and light.sunDir4.
* Moved CGlobalSyncedStuff::gravity into CMapInfo as map.gravity.
* Factored heightLinePal out of CReadMap into CHeightLinePalette.
* Cleaned up #include dependencies a bit, by not having ReadMap include
  MetalMap.h, MapInfo.h, TdfParser.h, etc. in the header.
* Moved global CGroundBlockingObjectMap creation to CGame::CGame.
* Fixed memory leak, groundBlockingObjectMap wasn't deleted.
* Removed a useless win-only #include &lt;process.h&gt; from ReadMap.cpp
* Removed TdfParser::GetMSG and TdfParser::SGetValueMSG, it's stilly
  to have a low level function be documented as to pop up a messagebox
  if it fails to find a setting, in particular if it doesn't actually pop
  up a messagebox but throws an exception.  Also it wasn't used :-)

Modified: trunk/rts/ExternalAI/AICallback.cpp
===================================================================
--- trunk/rts/ExternalAI/AICallback.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/ExternalAI/AICallback.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -12,6 +12,8 @@
 #include &quot;Game/UI/MiniMap.h&quot;
 #include &quot;Game/UI/MouseHandler.h&quot;
 #include &quot;Lua/LuaRules.h&quot;
+#include &quot;Map/MapInfo.h&quot;
+#include &quot;Map/MetalMap.h&quot;
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;NetProtocol.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
@@ -27,7 +29,6 @@
 #include &quot;Sim/Misc/GeometricObjects.h&quot;
 #include &quot;Sim/Misc/LosHandler.h&quot;
 #include &quot;Sim/Misc/QuadField.h&quot;
-#include &quot;Sim/Misc/Wind.h&quot;
 #include &quot;Sim/ModInfo.h&quot;
 #include &quot;Sim/Path/PathManager.h&quot;
 #include &quot;Sim/Units/CommandAI/CommandAI.h&quot;
@@ -829,32 +830,32 @@
 
 float CAICallback::GetMaxMetal()
 {
-	return readmap-&gt;maxMetal;
+	return mapInfo-&gt;map.maxMetal;
 }
 
 float CAICallback::GetExtractorRadius()
 {
-	return readmap-&gt;extractorRadius;
+	return mapInfo-&gt;map.extractorRadius;
 }
 
 float CAICallback::GetMinWind()
 {
-	return wind.GetMinWind();
+	return mapInfo-&gt;atmosphere.minWind;
 }
 
 float CAICallback::GetMaxWind()
 {
-	return wind.GetMaxWind();
+	return mapInfo-&gt;atmosphere.maxWind;
 }
 
 float CAICallback::GetTidalStrength()
 {
-	return readmap-&gt;tidalStrength;
+	return mapInfo-&gt;map.tidalStrength;
 }
 
 float CAICallback::GetGravity()
 {
-	return gs-&gt;gravity;
+	return mapInfo-&gt;map.gravity;
 }
 
 /*const unsigned char* CAICallback::GetSupplyMap()

Modified: trunk/rts/ExternalAI/aibase.h
===================================================================
--- trunk/rts/ExternalAI/aibase.h	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/ExternalAI/aibase.h	2008-04-24 12:13:55 UTC (rev 5772)
@@ -6,16 +6,6 @@
 #ifndef AIBASE_H
 #define AIBASE_H
 
-#ifdef _WIN32
-
-#include &lt;windows.h&gt;
-
-#else
-
-#define WINAPI
-
-#endif
-
 // Shared library support
 #ifdef _WIN32
 	#define DLL_EXPORT extern &quot;C&quot; __declspec(dllexport)

Modified: trunk/rts/Game/Camera.cpp
===================================================================
--- trunk/rts/Game/Camera.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Game/Camera.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -169,7 +169,7 @@
 	}
 
 	const float gndHeight = ground-&gt;GetHeight(pos.x, pos.z);
-	const float rangemod = 1.0f + max(0.0f, pos.y - gndHeight - 500.0f) * 0.0003f;
+	const float rangemod = 1.0f + std::max(0.0f, pos.y - gndHeight - 500.0f) * 0.0003f;
 	const float zNear = (NEAR_PLANE * rangemod);
 	gu-&gt;viewRange = MAX_VIEW_RANGE * rangemod;
 

Modified: trunk/rts/Game/Game.cpp
===================================================================
--- trunk/rts/Game/Game.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Game/Game.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -55,6 +55,7 @@
 #include &quot;Map/Ground.h&quot;
 #include &quot;Map/HeightMapTexture.h&quot;
 #include &quot;Map/MapDamage.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;Map/MetalMap.h&quot;
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;NetProtocol.h&quot;
@@ -86,6 +87,7 @@
 #include &quot;Sim/Misc/DamageArrayHandler.h&quot;
 #include &quot;Sim/Features/FeatureHandler.h&quot;
 #include &quot;Sim/Misc/GeometricObjects.h&quot;
+#include &quot;Sim/Misc/GroundBlockingObjectMap.h&quot;
 #include &quot;Sim/Misc/LosHandler.h&quot;
 #include &quot;Sim/Misc/QuadField.h&quot;
 #include &quot;Sim/Misc/RadarHandler.h&quot;
@@ -339,7 +341,15 @@
 
 	ENTER_SYNCED;
 	ground = SAFE_NEW CGround();
+	mapInfo = SAFE_NEW CMapInfo(mapname); // must go before readmap
+
+	// FIXME: remove these silly global variables ...
+	FogLand[0] = mapInfo-&gt;atmosphere.fogColor.x;
+	FogLand[1] = mapInfo-&gt;atmosphere.fogColor.y;
+	FogLand[2] = mapInfo-&gt;atmosphere.fogColor.z;
+
 	readmap = CReadMap::LoadMap (mapname);
+	groundBlockingObjectMap = SAFE_NEW CGroundBlockingObjectMap(gs-&gt;mapSquares);
 	wind.LoadWind();
 	moveinfo = SAFE_NEW CMoveInfo();
 	groundDecals = SAFE_NEW CGroundDecalHandler();
@@ -521,9 +531,10 @@
 
 	globalAI-&gt;PreDestroy ();
 	delete globalAI;           globalAI           = NULL;
-//	delete grouphandler;       grouphandler       = NULL;
+
 	for(int a=0;a&lt;MAX_TEAMS;a++) {
-		delete grouphandlers[a];grouphandlers[a]   = NULL;}
+		delete grouphandlers[a]; grouphandlers[a] = NULL;
+	}
 
 	delete water;              water              = NULL;
 	delete sky;                sky                = NULL;
@@ -566,6 +577,12 @@
 	delete consoleHistory;     consoleHistory     = NULL;
 	delete wordCompletion;     wordCompletion     = NULL;
 	delete explGenHandler;     explGenHandler     = NULL;
+
+	delete const_cast&lt;CMapInfo*&gt;(mapInfo);
+	mapInfo = NULL;
+	delete groundBlockingObjectMap;
+	groundBlockingObjectMap = NULL;
+
 	CCategoryHandler::RemoveInstance();
 	CColorMap::DeleteColormaps();
 }
@@ -2382,7 +2399,7 @@
 		gd-&gt;Draw();
 	}
 	if (drawWater) {
-		if (!readmap-&gt;voidWater &amp;&amp; water-&gt;drawSolid) {
+		if (!mapInfo-&gt;map.voidWater &amp;&amp; water-&gt;drawSolid) {
 			water-&gt;Draw();
 		}
 	}
@@ -2405,7 +2422,7 @@
 		}
 	}
 	if (drawWater) {
-		if (!readmap-&gt;voidWater &amp;&amp; !water-&gt;drawSolid) {
+		if (!mapInfo-&gt;map.voidWater &amp;&amp; !water-&gt;drawSolid) {
 			water-&gt;Draw();
 		}
 	}
@@ -4497,8 +4514,8 @@
 	luaParser.AddParam(&quot;modShortName&quot;, modInfo.shortName);
 	luaParser.AddParam(&quot;modVersion&quot;,   modInfo.version);
 
-	luaParser.AddParam(&quot;mapName&quot;,      readmap-&gt;mapName);
-	luaParser.AddParam(&quot;mapHumanName&quot;, readmap-&gt;mapHumanName);
+	luaParser.AddParam(&quot;mapName&quot;,      mapInfo-&gt;map.name);
+	luaParser.AddParam(&quot;mapHumanName&quot;, mapInfo-&gt;map.humanName);
 
 	luaParser.AddParam(&quot;gameMode&quot;,     gs-&gt;gameMode);
 

Modified: trunk/rts/Game/GameSetup.cpp
===================================================================
--- trunk/rts/Game/GameSetup.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Game/GameSetup.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -13,6 +13,7 @@
 #include &quot;Lua/LuaGaia.h&quot;
 #include &quot;Lua/LuaRules.h&quot;
 #include &quot;Lua/LuaParser.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;Rendering/Textures/TAPalette.h&quot;
 #include &quot;System/UnsyncedRNG.h&quot;
@@ -78,7 +79,7 @@
 void CGameSetup::LoadStartPositionsFromMap()
 {
 	TdfParser p2;
-	CReadMap::OpenTDF (mapName, p2);
+	CMapInfo::OpenTDF (mapName, p2);
 
 	for(int a=0;a&lt;numTeams;++a){
 		float x,z;

Modified: trunk/rts/Game/StartScripts/CommanderScript.cpp
===================================================================
--- trunk/rts/Game/StartScripts/CommanderScript.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Game/StartScripts/CommanderScript.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -8,6 +8,7 @@
 #include &quot;Game/Team.h&quot;
 #include &quot;Game/GameSetup.h&quot;
 #include &quot;Game/Game.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitDefHandler.h&quot;
 #include &quot;ExternalAI/GlobalAIHandler.h&quot;
@@ -97,7 +98,7 @@
 			StringToLower(p.SGetValueDef(&quot;corcom&quot;, &quot;side1\\commander&quot;));
 
 		TdfParser p2;
-		CReadMap::OpenTDF(stupidGlobalMapname, p2);
+		CMapInfo::OpenTDF(stupidGlobalMapname, p2);
 
 		float x0, x1, z0, z1;
 		p2.GetDef(x0, &quot;1000&quot;, &quot;MAP\\TEAM0\\StartPosX&quot;);

Modified: trunk/rts/Game/StartScripts/CommanderScript2.cpp
===================================================================
--- trunk/rts/Game/StartScripts/CommanderScript2.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Game/StartScripts/CommanderScript2.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -3,8 +3,8 @@
 #include &quot;Sim/Units/UnitLoader.h&quot;
 #include &quot;TdfParser.h&quot;
 #include &quot;Game/Team.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;Map/ReadMap.h&quot;
-
 #include &quot;mmgr.h&quot;
 
 extern std::string stupidGlobalMapname;
@@ -41,7 +41,7 @@
 		string s1 = StringToLower(p.SGetValueDef(&quot;corcom&quot;, &quot;side1\\commander&quot;));
 
 		TdfParser p2;
-		CReadMap::OpenTDF (stupidGlobalMapname, p2);
+		CMapInfo::OpenTDF (stupidGlobalMapname, p2);
 
 		float x0,x1,z0,z1;
 		p2.GetDef(x0,&quot;1000&quot;,&quot;MAP\\TEAM0\\StartPosX&quot;);

Modified: trunk/rts/Game/StartScripts/GlobalAITestScript.cpp
===================================================================
--- trunk/rts/Game/StartScripts/GlobalAITestScript.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Game/StartScripts/GlobalAITestScript.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -9,6 +9,7 @@
 #include &quot;ExternalAI/GlobalAIHandler.h&quot;
 #include &quot;FileSystem/FileHandler.h&quot;
 #include &quot;Platform/FileSystem.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;mmgr.h&quot;
 
@@ -45,7 +46,7 @@
 			string s1 = p.SGetValueDef(&quot;corcom&quot;, &quot;side1\\commander&quot;);
 
 			TdfParser p2;
-			CReadMap::OpenTDF(stupidGlobalMapname, p2);
+			CMapInfo::OpenTDF(stupidGlobalMapname, p2);
 
 			float x0, x1, z0, z1;
 			p2.GetDef(x0, &quot;1000&quot;, &quot;MAP\\TEAM0\\StartPosX&quot;);

Modified: trunk/rts/Game/StartScripts/SpawnScript.cpp
===================================================================
--- trunk/rts/Game/StartScripts/SpawnScript.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Game/StartScripts/SpawnScript.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -9,6 +9,7 @@
 #include &lt;set&gt;
 #include &quot;Sim/Units/CommandAI/Command.h&quot;
 #include &quot;Sim/Units/CommandAI/CommandAI.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;mmgr.h&quot;
 
@@ -36,7 +37,7 @@
 		string s1=p.SGetValueDef(&quot;corcom&quot;,&quot;side1\\commander&quot;);
 
 		TdfParser p2;
-		CReadMap::OpenTDF (stupidGlobalMapname, p2);
+		CMapInfo::OpenTDF (stupidGlobalMapname, p2);
 
 		float x0,z0;
 		p2.GetDef(x0,&quot;1000&quot;,&quot;MAP\\TEAM0\\StartPosX&quot;);

Modified: trunk/rts/Game/UI/GameInfo.cpp
===================================================================
--- trunk/rts/Game/UI/GameInfo.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Game/UI/GameInfo.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -9,6 +9,7 @@
 #include &quot;Game/GameSetup.h&quot;
 #include &quot;Game/GameVersion.h&quot;
 #include &quot;Game/Team.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;Sim/Misc/Wind.h&quot;
 #include &quot;Sim/ModInfo.h&quot;
@@ -170,10 +171,10 @@
 	values.push_back(gs-&gt;gameMode &gt; 0 ? true : false);
 
 	labels.push_back(&quot;Gravity:&quot;);
-	values.push_back(-(gs-&gt;gravity * GAME_SPEED * GAME_SPEED));
+	values.push_back(-(mapInfo-&gt;map.gravity * GAME_SPEED * GAME_SPEED));
 
 	labels.push_back(&quot;Tidal:&quot;);
-	values.push_back(readmap-&gt;tidalStrength);
+	values.push_back(mapInfo-&gt;map.tidalStrength);
 
 	labels.push_back(&quot;Min Wind:&quot;);
 	values.push_back(wind.GetMinWind());
@@ -194,7 +195,7 @@
 	values.push_back(buf);
 	
 	labels.push_back(&quot;Map Name:&quot;);
-	values.push_back(readmap-&gt;mapName.c_str());
+	values.push_back(mapInfo-&gt;map.name.c_str());
 
 	labels.push_back(&quot;Mod Name:&quot;);
 	values.push_back(modInfo.filename.c_str());

Modified: trunk/rts/Game/UI/GuiHandler.cpp
===================================================================
--- trunk/rts/Game/UI/GuiHandler.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Game/UI/GuiHandler.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -22,6 +22,9 @@
 #include &quot;Game/SelectedUnits.h&quot;
 #include &quot;Map/BaseGroundDrawer.h&quot;
 #include &quot;Map/Ground.h&quot;
+#include &quot;Map/MapInfo.h&quot;
+#include &quot;Map/MetalMap.h&quot;
+#include &quot;Map/ReadMap.h&quot;
 #include &quot;Rendering/glFont.h&quot;
 #include &quot;Rendering/GL/glExtra.h&quot;
 #include &quot;Rendering/GL/glList.h&quot;
@@ -82,12 +85,11 @@
 
 	LoadConfig(&quot;ctrlpanel.txt&quot;);
 
-  miniMapMarker = !!configHandler.GetInt(&quot;MiniMapMarker&quot;, 1);
+	miniMapMarker = !!configHandler.GetInt(&quot;MiniMapMarker&quot;, 1);
+	invertQueueKey = !!configHandler.GetInt(&quot;InvertQueueKey&quot;, 0);
 
-  invertQueueKey = !!configHandler.GetInt(&quot;InvertQueueKey&quot;, 0);
+	autoShowMetal = mapInfo-&gt;gui.autoShowMetal;
 
-	readmap-&gt;mapDefParser.GetDef(autoShowMetal, &quot;1&quot;, &quot;MAP\\autoShowMetal&quot;);
-
 	useStencil = false;
 	if (GLEW_NV_depth_clamp &amp;&amp; !!configHandler.GetInt(&quot;StencilBufferBits&quot;, 1)) {
 		GLint stencilBits;

Modified: trunk/rts/Game/UI/TooltipConsole.cpp
===================================================================
--- trunk/rts/Game/UI/TooltipConsole.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Game/UI/TooltipConsole.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -9,6 +9,9 @@
 #include &quot;Game/Team.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Map/MapDamage.h&quot;
+#include &quot;Map/MapInfo.h&quot;
+#include &quot;Map/MetalMap.h&quot;
+#include &quot;Map/ReadMap.h&quot;
 #include &quot;Sim/Features/Feature.h&quot;
 #include &quot;Sim/Features/FeatureDef.h&quot;
 #include &quot;Sim/Misc/LosHandler.h&quot;
@@ -141,7 +144,7 @@
 	mMake += ud-&gt;metalMake;
 	eMake += ud-&gt;energyMake;
 	if (ud-&gt;tidalGenerator &gt; 0.0f) {
-		eMake += (ud-&gt;tidalGenerator * readmap-&gt;tidalStrength);
+		eMake += (ud-&gt;tidalGenerator * mapInfo-&gt;map.tidalStrength);
 	}
 
 	bool active;
@@ -333,7 +336,7 @@
 	}
 
 	char tmp[512];
-	CReadMap::TerrainType* tt = &amp;readmap-&gt;terrainTypes[readmap-&gt;typemap[min(gs-&gt;hmapx*gs-&gt;hmapy-1,max(0,((int)pos.z/16)*gs-&gt;hmapx+((int)pos.x/16)))]];
+	const CMapInfo::TerrainType* tt = &amp;mapInfo-&gt;terrainTypes[readmap-&gt;typemap[min(gs-&gt;hmapx*gs-&gt;hmapy-1,max(0,((int)pos.z/16)*gs-&gt;hmapx+((int)pos.x/16)))]];
 	string ttype = tt-&gt;name;
 	sprintf(tmp, &quot;Pos %.0f %.0f Elevation %.0f\nTerrain type: %s\n&quot;
 	             &quot;Speeds T/K/H/S %.2f %.2f %.2f %.2f\nHardness %.0f Metal %.1f&quot;,

Modified: trunk/rts/Lua/LuaConstGame.cpp
===================================================================
--- trunk/rts/Lua/LuaConstGame.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Lua/LuaConstGame.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -12,6 +12,7 @@
 #include &quot;Game/GameSetup.h&quot;
 #include &quot;Game/GameVersion.h&quot;
 #include &quot;Map/MapDamage.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Sim/ModInfo.h&quot;
@@ -42,7 +43,7 @@
 
 bool LuaConstGame::PushEntries(lua_State* L)
 {
-	const float gravity = -(gs-&gt;gravity * GAME_SPEED * GAME_SPEED);
+	const float gravity = -(mapInfo-&gt;map.gravity * GAME_SPEED * GAME_SPEED);
 	const bool limitDGun        = gameSetup ? gameSetup-&gt;limitDgun        : false;
 	const bool diminishingMMs   = gameSetup ? gameSetup-&gt;diminishingMMs   : false;
 	const bool ghostedBuildings = gameSetup ? gameSetup-&gt;ghostedBuildings : false;
@@ -69,22 +70,22 @@
 	LuaPushNamedNumber(L, &quot;gravity&quot;,           gravity);
 	LuaPushNamedNumber(L, &quot;windMin&quot;,           wind.GetMinWind());
 	LuaPushNamedNumber(L, &quot;windMax&quot;,           wind.GetMaxWind());
-	LuaPushNamedString(L, &quot;mapName&quot;,           readmap-&gt;mapName);
-	LuaPushNamedString(L, &quot;mapHumanName&quot;,      readmap-&gt;mapHumanName);
+	LuaPushNamedString(L, &quot;mapName&quot;,           mapInfo-&gt;map.name);
+	LuaPushNamedString(L, &quot;mapHumanName&quot;,      mapInfo-&gt;map.humanName);
 	LuaPushNamedNumber(L, &quot;mapX&quot;,              readmap-&gt;width  / 64);
 	LuaPushNamedNumber(L, &quot;mapY&quot;,              readmap-&gt;height / 64);
 	LuaPushNamedNumber(L, &quot;mapSizeX&quot;,          readmap-&gt;width  * SQUARE_SIZE);
 	LuaPushNamedNumber(L, &quot;mapSizeZ&quot;,          readmap-&gt;height * SQUARE_SIZE);
-	LuaPushNamedNumber(L, &quot;extractorRadius&quot;,   readmap-&gt;extractorRadius);
-	LuaPushNamedNumber(L, &quot;tidal&quot;,             readmap-&gt;tidalStrength);
-	LuaPushNamedString(L, &quot;waterTexture&quot;,      readmap-&gt;waterTexture);
-	LuaPushNamedBool(L,   &quot;waterVoid&quot;,         readmap-&gt;voidWater);
-	LuaPushNamedBool(L,   &quot;waterPlane&quot;,        readmap-&gt;hasWaterPlane);
-	LuaPushNamedColor(L,  &quot;waterAbsorb&quot;,       readmap-&gt;waterAbsorb);
-	LuaPushNamedColor(L,  &quot;waterBaseColor&quot;,    readmap-&gt;waterBaseColor);
-	LuaPushNamedColor(L,  &quot;waterMinColor&quot;,     readmap-&gt;waterMinColor);
-	LuaPushNamedColor(L,  &quot;waterSurfaceColor&quot;, readmap-&gt;waterSurfaceColor);
-	LuaPushNamedColor(L,  &quot;waterPlaneColor&quot;,   readmap-&gt;waterPlaneColor);
+	LuaPushNamedNumber(L, &quot;extractorRadius&quot;,   mapInfo-&gt;map.extractorRadius);
+	LuaPushNamedNumber(L, &quot;tidal&quot;,             mapInfo-&gt;map.tidalStrength);
+	LuaPushNamedString(L, &quot;waterTexture&quot;,      mapInfo-&gt;water.texture);
+	LuaPushNamedBool(L,   &quot;waterVoid&quot;,         mapInfo-&gt;map.voidWater);
+	LuaPushNamedBool(L,   &quot;waterPlane&quot;,        mapInfo-&gt;hasWaterPlane);
+	LuaPushNamedColor(L,  &quot;waterAbsorb&quot;,       mapInfo-&gt;water.absorb);
+	LuaPushNamedColor(L,  &quot;waterBaseColor&quot;,    mapInfo-&gt;water.baseColor);
+	LuaPushNamedColor(L,  &quot;waterMinColor&quot;,     mapInfo-&gt;water.minColor);
+	LuaPushNamedColor(L,  &quot;waterSurfaceColor&quot;, mapInfo-&gt;water.surfaceColor);
+	LuaPushNamedColor(L,  &quot;waterPlaneColor&quot;,   mapInfo-&gt;water.planeColor);
 	LuaPushNamedColor(L,  &quot;fogColor&quot;,          fogColor);
 
 	LuaPushNamedString(L, &quot;modName&quot;,         modInfo.humanName);
@@ -105,7 +106,7 @@
 
 	char buf[64];
 	SNPRINTF(buf, sizeof(buf), &quot;0x%08X&quot;,
-	         archiveScanner-&gt;GetMapChecksum(readmap-&gt;mapName));
+	         archiveScanner-&gt;GetMapChecksum(mapInfo-&gt;map.name));
 	LuaPushNamedString(L, &quot;mapChecksum&quot;, buf);
 	SNPRINTF(buf, sizeof(buf), &quot;0x%08X&quot;,
 	         archiveScanner-&gt;GetModChecksum(modInfo.filename));

Modified: trunk/rts/Lua/LuaOpenGL.cpp
===================================================================
--- trunk/rts/Lua/LuaOpenGL.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Lua/LuaOpenGL.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -32,6 +32,7 @@
 #include &quot;Game/Camera.h&quot;
 #include &quot;Game/UI/CommandColors.h&quot;
 #include &quot;Game/UI/MiniMap.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;Map/HeightMapTexture.h&quot;
 #include &quot;Rendering/glFont.h&quot;
@@ -796,7 +797,7 @@
 void LuaOpenGL::SetupWorldLighting()
 {
 	glLightModeli(GL_LIGHT_MODEL_LOCAL_VIEWER, GL_TRUE);
-	glLightfv(GL_LIGHT1, GL_POSITION, gs-&gt;sunVector4);
+	glLightfv(GL_LIGHT1, GL_POSITION, mapInfo-&gt;light.sunDir4);
 	glEnable(GL_LIGHT1);
 }
 
@@ -876,7 +877,7 @@
 	// sun light -- needs the camera transformation
 	glPushMatrix();
 	glLoadMatrixd(camera-&gt;GetModelview());
-	glLightfv(GL_LIGHT1, GL_POSITION, gs-&gt;sunVector4);
+	glLightfv(GL_LIGHT1, GL_POSITION, mapInfo-&gt;light.sunDir4);
 
 	const float sunFactor = 1.0f;
 	const float sf = sunFactor;
@@ -4807,17 +4808,17 @@
 {
 	const int args = lua_gettop(L); // number of arguments
 	if (args == 0) {
-		lua_pushnumber(L, gs-&gt;sunVector4[0]);
-		lua_pushnumber(L, gs-&gt;sunVector4[1]);
-		lua_pushnumber(L, gs-&gt;sunVector4[2]);
+		lua_pushnumber(L, mapInfo-&gt;light.sunDir4[0]);
+		lua_pushnumber(L, mapInfo-&gt;light.sunDir4[1]);
+		lua_pushnumber(L, mapInfo-&gt;light.sunDir4[2]);
 		return 3;
 	}
 
 	const string param = luaL_checkstring(L, 1);
 	if (param == &quot;pos&quot;) {
-		lua_pushnumber(L, gs-&gt;sunVector4[0]);
-		lua_pushnumber(L, gs-&gt;sunVector4[1]);
-		lua_pushnumber(L, gs-&gt;sunVector4[2]);
+		lua_pushnumber(L, mapInfo-&gt;light.sunDir4[0]);
+		lua_pushnumber(L, mapInfo-&gt;light.sunDir4[1]);
+		lua_pushnumber(L, mapInfo-&gt;light.sunDir4[2]);
 		return 3;
 	}
 
@@ -4828,7 +4829,7 @@
 
 	if (param == &quot;shadowDensity&quot;) {
 		if (!unitMode) {
-			lua_pushnumber(L, readmap-&gt;shadowDensity);
+			lua_pushnumber(L, mapInfo-&gt;light.groundShadowDensity);
 		} else {
 			lua_pushnumber(L, unitDrawer-&gt;unitShadowDensity);
 		}
@@ -4836,21 +4837,21 @@
 	}
 	else if (param == &quot;diffuse&quot;) {
 		if (!unitMode) {
-			data = &amp;readmap-&gt;sunColor;
+			data = &amp;mapInfo-&gt;light.groundSunColor;
 		} else {
 			data = &amp;unitDrawer-&gt;unitSunColor;
 		}
 	}
 	else if (param == &quot;ambient&quot;) {
 		if (!unitMode) {
-			data = &amp;readmap-&gt;sunColor;
+			data = &amp;mapInfo-&gt;light.groundSunColor;
 		} else {
 			data = &amp;unitDrawer-&gt;unitAmbientColor;
 		}
 	}
 	else if (param == &quot;specular&quot;) {
 		if (!unitMode) {
-			data = &amp;readmap-&gt;specularColor;
+			data = &amp;mapInfo-&gt;light.groundSpecularColor;
 		}
 	}
 

Modified: trunk/rts/Lua/LuaSyncedCtrl.cpp
===================================================================
--- trunk/rts/Lua/LuaSyncedCtrl.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Lua/LuaSyncedCtrl.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -25,6 +25,7 @@
 #include &quot;Game/Team.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Map/MapDamage.h&quot;
+#include &quot;Map/ReadMap.h&quot;
 #include &quot;Rendering/GroundDecalHandler.h&quot;
 #include &quot;Rendering/Env/BaseTreeDrawer.h&quot;
 #include &quot;Rendering/UnitModels/3DModelParser.h&quot;

Modified: trunk/rts/Lua/LuaSyncedRead.cpp
===================================================================
--- trunk/rts/Lua/LuaSyncedRead.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Lua/LuaSyncedRead.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -26,6 +26,9 @@
 #include &quot;Game/Player.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Map/MapDamage.h&quot;
+#include &quot;Map/MapInfo.h&quot;
+#include &quot;Map/MetalMap.h&quot;
+#include &quot;Map/ReadMap.h&quot;
 #include &quot;Rendering/UnitModels/3DModelParser.h&quot;
 #include &quot;Rendering/UnitModels/3DOParser.h&quot;
 #include &quot;Rendering/UnitModels/s3oParser.h&quot;
@@ -3634,7 +3637,7 @@
 	const int maxIndex = (gs-&gt;hmapx * gs-&gt;hmapy) - 1;
 	const int index = min(maxIndex, (gs-&gt;hmapx * iz) + ix);
 	const int typeIndex = readmap-&gt;typemap[index];
-	const CReadMap::TerrainType&amp; tt = readmap-&gt;terrainTypes[typeIndex];
+	const CMapInfo::TerrainType&amp; tt = mapInfo-&gt;terrainTypes[typeIndex];
 
 	lua_pushstring(L, tt.name.c_str());
 	lua_pushnumber(L, metal);
@@ -3643,7 +3646,7 @@
 	lua_pushnumber(L, tt.kbotSpeed);
 	lua_pushnumber(L, tt.hoverSpeed);
 	lua_pushnumber(L, tt.shipSpeed);
-	lua_pushboolean(L, !!tt.receiveTracks);
+	lua_pushboolean(L, tt.receiveTracks);
 	return 8;
 }
 

Modified: trunk/rts/Lua/LuaUnitDefs.cpp
===================================================================
--- trunk/rts/Lua/LuaUnitDefs.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Lua/LuaUnitDefs.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -22,6 +22,7 @@
 #include &quot;Game/Team.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Map/MapDamage.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;Rendering/UnitModels/3DModelParser.h&quot;
 #include &quot;Sim/Features/Feature.h&quot;
 #include &quot;Sim/Features/FeatureHandler.h&quot;
@@ -537,7 +538,7 @@
 {
 	const UnitDef&amp; ud = *((const UnitDef*)data);
 	const float basicEnergy = (ud.energyMake - ud.energyUpkeep);
-	const float tidalEnergy = (ud.tidalGenerator * readmap-&gt;tidalStrength);
+	const float tidalEnergy = (ud.tidalGenerator * mapInfo-&gt;map.tidalStrength);
 	float windEnergy = 0.0f;
 	if (ud.windGenerator &gt; 0.0f) {
 		windEnergy = (0.25f * (wind.GetMinWind() + wind.GetMaxWind()));

Modified: trunk/rts/Map/BaseGroundDrawer.cpp
===================================================================
--- trunk/rts/Map/BaseGroundDrawer.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Map/BaseGroundDrawer.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -4,6 +4,7 @@
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Game/Camera.h&quot;
 #include &quot;Map/ReadMap.h&quot;
+#include &quot;Map/HeightLinePalette.h&quot;
 #include &quot;Sim/Misc/LosHandler.h&quot;
 #include &quot;Sim/Misc/RadarHandler.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
@@ -43,21 +44,23 @@
 	highResLosTex = !!configHandler.GetInt(&quot;HighResLos&quot;, 0);
 // 	smoothLosTex = !!configHandler.GetInt(&quot;SmoothLos&quot;, 1);
 
-  jamColor[0] = (int)(losColorScale * 0.25f);
-  jamColor[1] = (int)(losColorScale * 0.0f);
-  jamColor[2] = (int)(losColorScale * 0.0f);
+	jamColor[0] = (int)(losColorScale * 0.25f);
+	jamColor[1] = (int)(losColorScale * 0.0f);
+	jamColor[2] = (int)(losColorScale * 0.0f);
 
-  losColor[0] = (int)(losColorScale * 0.15f);
-  losColor[1] = (int)(losColorScale * 0.05f);
-  losColor[2] = (int)(losColorScale * 0.40f);
+	losColor[0] = (int)(losColorScale * 0.15f);
+	losColor[1] = (int)(losColorScale * 0.05f);
+	losColor[2] = (int)(losColorScale * 0.40f);
 
-  radarColor[0] = (int)(losColorScale *  0.05f);
-  radarColor[1] = (int)(losColorScale *  0.15f);
-  radarColor[2] = (int)(losColorScale * -0.20f);
+	radarColor[0] = (int)(losColorScale *  0.05f);
+	radarColor[1] = (int)(losColorScale *  0.15f);
+	radarColor[2] = (int)(losColorScale * -0.20f);
 
-  alwaysColor[0] = (int)(losColorScale * 0.25f);
-  alwaysColor[1] = (int)(losColorScale * 0.25f);
-  alwaysColor[2] = (int)(losColorScale * 0.25f);
+	alwaysColor[0] = (int)(losColorScale * 0.25f);
+	alwaysColor[1] = (int)(losColorScale * 0.25f);
+	alwaysColor[2] = (int)(losColorScale * 0.25f);
+
+	heightLinePal = SAFE_NEW CHeightLinePalette();
 }
 
 CBaseGroundDrawer::~CBaseGroundDrawer(void)
@@ -66,6 +69,8 @@
 	if (infoTex!=0) {
 		glDeleteTextures(1, &amp;infoTex);
 	}
+
+	delete heightLinePal;
 }
 
 void CBaseGroundDrawer::DrawShadowPass(void)
@@ -278,7 +283,7 @@
 				break;
 			}
 			case drawHeight: {
-				extraTexPal = readmap-&gt;heightLinePal;
+				extraTexPal = heightLinePal-&gt;GetData();
 				for (int y = starty; y &lt; endy; ++y) {
 					for (int x = 0; x  &lt; gs-&gt;mapx; ++x){
 						const float height = readmap-&gt;centerheightmap[(y * gs-&gt;mapx) + x];

Modified: trunk/rts/Map/BaseGroundDrawer.h
===================================================================
--- trunk/rts/Map/BaseGroundDrawer.h	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Map/BaseGroundDrawer.h	2008-04-24 12:13:55 UTC (rev 5772)
@@ -9,6 +9,8 @@
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;float3.h&quot;
 
+class CHeightLinePalette;
+
 class CBaseGroundDrawer
 {
 public:
@@ -58,8 +60,8 @@
 	bool highResInfoTex;
 	bool highResInfoTexWanted;
 
-	unsigned char* extraTex;
-	unsigned char* extraTexPal;
+	const unsigned char* extraTex;
+	const unsigned char* extraTexPal;
 	float* extractDepthMap;
 
 	int updateTextureState;
@@ -76,6 +78,8 @@
 	
 	bool highResLosTex;
 // 	bool smoothLosTex;
+
+	CHeightLinePalette* heightLinePal;
 };
 
 #endif // __BASE_GROUND_DRAWER__

Modified: trunk/rts/Map/BasicMapDamage.cpp
===================================================================
--- trunk/rts/Map/BasicMapDamage.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Map/BasicMapDamage.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -1,6 +1,7 @@
 #include &quot;StdAfx.h&quot;
 #include &quot;BasicMapDamage.h&quot;
 #include &quot;ReadMap.h&quot;
+#include &quot;MapInfo.h&quot;
 #include &quot;BaseGroundDrawer.h&quot;
 #include &quot;HeightMapTexture.h&quot;
 #include &quot;Rendering/Env/BaseTreeDrawer.h&quot;
@@ -36,9 +37,9 @@
 		craterTable[a]=0;
 	}
 	for(int a=0;a&lt;256;++a)
-		invHardness[a]=1.0f/readmap-&gt;terrainTypes[a].hardness;
+		invHardness[a]=1.0f/mapInfo-&gt;terrainTypes[a].hardness;
 
-	mapHardness=atof(readmap-&gt;mapDefParser.SGetValueDef(&quot;100&quot;,&quot;MAP\\MapHardness&quot;).c_str());
+	mapHardness = mapInfo-&gt;map.hardness;
 
 	disabled = false;
 }

Modified: trunk/rts/Map/Ground.h
===================================================================
--- trunk/rts/Map/Ground.h	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Map/Ground.h	2008-04-24 12:13:55 UTC (rev 5772)
@@ -4,16 +4,12 @@
 //
 //////////////////////////////////////////////////////////////////////
 
-class CGround;
+#include &quot;GlobalStuff.h&quot;
 
-
-#include &lt;vector&gt;
-	// Added by ClassView
-#include &quot;ReadMap.h&quot;
 class CProjectileHandler;
 class CProjectile;
 
-using namespace std;
+
 class CGround
 {
 public:
@@ -31,13 +27,17 @@
 	void CheckCol(CProjectileHandler* ph);
 	float TrajectoryGroundCol(float3 from, float3 flatdir, float length, float linear, float quadratic);
 
-	inline int GetSquare(const float3&amp; pos){return max(0,min(gs-&gt;mapx-1,(int(pos.x)/SQUARE_SIZE)))+max(0,min(gs-&gt;mapy-1,(int(pos.z)/SQUARE_SIZE)))*gs-&gt;mapx;};
+	inline int GetSquare(const float3&amp; pos) {
+		return std::max(0, std::min(gs-&gt;mapx - 1, (int(pos.x) / SQUARE_SIZE))) +
+			std::max(0, std::min(gs-&gt;mapy - 1, (int(pos.z) / SQUARE_SIZE))) * gs-&gt;mapx;
+	};
 private:
 
 	void CheckColSquare(CProjectile* p,int x,int y);
 
 	float LineGroundSquareCol(const float3 &amp;from,const float3 &amp;to,int xs,int ys);
 };
+
 extern CGround* ground;
 
 #endif /* GROUND_H */

Added: trunk/rts/Map/HeightLinePalette.cpp
===================================================================
--- trunk/rts/Map/HeightLinePalette.cpp	                        (rev 0)
+++ trunk/rts/Map/HeightLinePalette.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -0,0 +1,40 @@
+#include &quot;HeightLinePalette.h&quot;
+
+#include &quot;Platform/ConfigHandler.h&quot;
+
+
+/** @brief Generates the height line palette.
+Based on the configuration variable &quot;ColorElev&quot; (default: 1), it either
+generates a colored palette or a grayscale palette. */
+
+CHeightLinePalette::CHeightLinePalette()
+{
+	if(configHandler.GetInt(&quot;ColorElev&quot;,1)){
+		for(int a=0;a&lt;86;++a){
+			heightLinePal[a*3+0]=255-a*3;
+			heightLinePal[a*3+1]=a*3;
+			heightLinePal[a*3+2]=0;
+		}
+		for(int a=86;a&lt;172;++a){
+			heightLinePal[a*3+0]=0;
+			heightLinePal[a*3+1]=255-(a-86)*3;
+			heightLinePal[a*3+2]=(a-86)*3;
+		}
+		for(int a=172;a&lt;256;++a){
+			heightLinePal[a*3+0]=(a-172)*3;
+			heightLinePal[a*3+1]=0;
+			heightLinePal[a*3+2]=255-(a-172)*3;
+		}
+	} else {
+		for(int a=0;a&lt;29;++a){
+			heightLinePal[a*3+0]=255-a*8;
+			heightLinePal[a*3+1]=255-a*8;
+			heightLinePal[a*3+2]=255-a*8;
+		}
+		for(int a=29;a&lt;256;++a){
+			heightLinePal[a*3+0]=a;
+			heightLinePal[a*3+1]=a;
+			heightLinePal[a*3+2]=a;
+		}
+	}
+}

Added: trunk/rts/Map/HeightLinePalette.h
===================================================================
--- trunk/rts/Map/HeightLinePalette.h	                        (rev 0)
+++ trunk/rts/Map/HeightLinePalette.h	2008-04-24 12:13:55 UTC (rev 5772)
@@ -0,0 +1,18 @@
+#ifndef HEIGHTLINEPALETTE_H
+#define HEIGHTLINEPALETTE_H
+
+/** @brief The palette used in heightmap rendering mode (F1). */
+class CHeightLinePalette
+{
+public:
+	CHeightLinePalette();
+
+	/** @brief Gets the palette.
+	The palette data consists of 256 RGB triplets with range 0-255. */
+	const unsigned char* GetData() const { return heightLinePal; }
+
+private:
+	unsigned char heightLinePal[3*256];
+};
+
+#endif

Modified: trunk/rts/Map/MapDamage.cpp
===================================================================
--- trunk/rts/Map/MapDamage.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Map/MapDamage.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -3,6 +3,7 @@
 #include &quot;BasicMapDamage.h&quot;
 #include &quot;NoMapDamage.h&quot;
 #include &quot;ReadMap.h&quot;
+#include &quot;MapInfo.h&quot;
 #include &quot;Game/GameSetup.h&quot;
 
 IMapDamage* mapDamage;
@@ -20,7 +21,7 @@
 {
 	bool disable = false;
 	
-	if (readmap-&gt;mapDefParser.SGetValueDef(&quot;0&quot;, &quot;MAP\\NotDeformable&quot;) != &quot;0&quot;)
+	if (mapInfo-&gt;map.notDeformable)
 		disable = true;
 	else if (gameSetup &amp;&amp; gameSetup-&gt;disableMapDamage)
 		disable = true;

Added: trunk/rts/Map/MapInfo.cpp
===================================================================
--- trunk/rts/Map/MapInfo.cpp	                        (rev 0)
+++ trunk/rts/Map/MapInfo.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -0,0 +1,187 @@
+#include &quot;MapInfo.h&quot;
+
+#include &quot;TdfParser.h&quot;
+
+
+// before delete, the const is const_cast'ed away.
+// there are no (other) situations where mapInfo may be modified
+const CMapInfo* mapInfo;
+
+
+CMapInfo::CMapInfo(const std::string&amp; mapname)
+{
+	map.name = mapname;
+	mapDefParser = new TdfParser(GetTDFName(mapname));
+	resources = new TdfParser(&quot;gamedata/resources.tdf&quot;);
+
+	ReadGlobal();
+	ReadAtmosphere();
+	ReadGui();
+	ReadLight();
+	ReadWater();
+	ReadSmf();
+	ReadSm3();
+	ReadTerrainTypes();
+
+	delete resources;
+	resources = NULL;
+}
+
+
+CMapInfo::~CMapInfo()
+{
+	delete mapDefParser;
+	mapDefParser = NULL;
+}
+
+
+/** @brief Opens the TDF file from the given map in parser.
+	FIXME: This is mostly a hack to supply CGameSetup with start positions,
+	when no CMapInfo object has yet been created.
+ */
+void CMapInfo::OpenTDF(const std::string&amp; mapname, TdfParser&amp; parser)
+{
+	parser.LoadFile(GetTDFName(mapname));
+}
+
+
+/** @brief Get the name of the TDF file with map settings.
+	@return &quot;maps/%.smd&quot; for &quot;%.smf&quot; and &quot;maps/%.sm3&quot; for &quot;%.sm3&quot;
+ */
+std::string CMapInfo::GetTDFName(const std::string&amp; mapname)
+{
+	if (mapname.length() &lt; 3)
+		throw std::runtime_error(&quot;CMapInfo::GetTDFName(): mapname '&quot; + mapname + &quot;' too short&quot;);
+
+	std::string extension = mapname.substr(mapname.length() - 3);
+	if (extension == &quot;smf&quot;)
+		return std::string(&quot;maps/&quot;) + mapname.substr(0, mapname.find_last_of('.')) + &quot;.smd&quot;;
+	else if(extension == &quot;sm3&quot;)
+		return std::string(&quot;maps/&quot;) + mapname;
+	else
+		throw std::runtime_error(&quot;CMapInfo::GetTDFName(): Unknown extension: &quot; + extension);
+}
+
+
+void CMapInfo::ReadGlobal()
+{
+	map.humanName = mapDefParser-&gt;SGetValueDef(map.name, &quot;MAP\\Description&quot;);
+
+	mapDefParser-&gt;GetTDef(map.hardness, 100.0f, &quot;MAP\\MapHardness&quot;);
+	map.notDeformable = mapDefParser-&gt;SGetValueDef(&quot;0&quot;, &quot;MAP\\NotDeformable&quot;) != &quot;0&quot;;
+
+	mapDefParser-&gt;GetTDef(map.gravity, 130.0f, &quot;MAP\\Gravity&quot;);
+	map.gravity = -map.gravity / (GAME_SPEED * GAME_SPEED);
+
+	mapDefParser-&gt;GetTDef(map.tidalStrength, 0.0f, &quot;MAP\\TidalStrength&quot;);
+	mapDefParser-&gt;GetTDef(map.maxMetal, 0.02f, &quot;MAP\\MaxMetal&quot;);
+	mapDefParser-&gt;GetTDef(map.extractorRadius, 500.0f, &quot;MAP\\ExtractorRadius&quot;);
+
+	mapDefParser-&gt;GetDef(map.voidWater, &quot;0&quot;, &quot;MAP\\voidWater&quot;);
+}
+
+
+void CMapInfo::ReadGui()
+{
+	// GUI
+	mapDefParser-&gt;GetTDef(gui.autoShowMetal, true, &quot;MAP\\autoShowMetal&quot;);
+}
+
+
+void CMapInfo::ReadAtmosphere()
+{
+	// MAP\ATMOSPHERE
+	mapDefParser-&gt;GetTDef(atmosphere.cloudDensity, 0.5f, &quot;MAP\\ATMOSPHERE\\CloudDensity&quot;);
+	mapDefParser-&gt;GetTDef(atmosphere.fogStart, 0.1f, &quot;MAP\\ATMOSPHERE\\FogStart&quot;);
+	atmosphere.fogColor = mapDefParser-&gt;GetFloat3(float3(0.7f, 0.7f, 0.8f), &quot;MAP\\ATMOSPHERE\\FogColor&quot;);
+	atmosphere.skyColor = mapDefParser-&gt;GetFloat3(float3(0.1f, 0.15f, 0.7f), &quot;MAP\\ATMOSPHERE\\SkyColor&quot;);
+	atmosphere.sunColor = mapDefParser-&gt;GetFloat3(float3(1.0f, 1.0f, 1.0f), &quot;MAP\\ATMOSPHERE\\SunColor&quot;);
+	atmosphere.cloudColor = mapDefParser-&gt;GetFloat3(float3(1.0f, 1.0f, 1.0f), &quot;MAP\\ATMOSPHERE\\CloudColor&quot;);
+	mapDefParser-&gt;GetTDef(atmosphere.minWind, 5.0f, &quot;MAP\\ATMOSPHERE\\MinWind&quot;);
+	mapDefParser-&gt;GetTDef(atmosphere.maxWind, 25.0f, &quot;MAP\\ATMOSPHERE\\MaxWind&quot;);
+	mapDefParser-&gt;GetDef(atmosphere.skyBox, &quot;&quot;, &quot;MAP\\ATMOSPHERE\\SkyBox&quot;);
+}
+
+
+void CMapInfo::ReadLight()
+{
+	// MAP\LIGHT
+	light.sunDir = mapDefParser-&gt;GetFloat3(float3(0.0f, 1.0f, 2.0f), &quot;MAP\\LIGHT\\SunDir&quot;);
+	light.sunDir.Normalize();
+	light.sunDir4[0] = light.sunDir[0];
+	light.sunDir4[1] = light.sunDir[1];
+	light.sunDir4[2] = light.sunDir[2];
+	light.sunDir4[3] = 0.0f;
+
+	light.groundAmbientColor = mapDefParser-&gt;GetFloat3(float3(0.5f, 0.5f, 0.5f), &quot;MAP\\LIGHT\\GroundAmbientColor&quot;);
+	light.groundSunColor = mapDefParser-&gt;GetFloat3(float3(0.5f, 0.5f, 0.5f), &quot;MAP\\LIGHT\\GroundSunColor&quot;);
+	light.groundSpecularColor = mapDefParser-&gt;GetFloat3(float3(0.1f, 0.1f, 0.1f), &quot;MAP\\LIGHT\\GroundSpecularColor&quot;);
+	mapDefParser-&gt;GetTDef(light.groundShadowDensity, 0.8f, &quot;MAP\\LIGHT\\GroundShadowDensity&quot;);
+
+	light.unitAmbientColor = mapDefParser-&gt;GetFloat3(float3(0.4f, 0.4f, 0.4f), &quot;MAP\\LIGHT\\UnitAmbientColor&quot;);
+	light.unitSunColor = mapDefParser-&gt;GetFloat3(float3(0.7f, 0.7f, 0.7f), &quot;MAP\\LIGHT\\UnitSunColor&quot;);
+	light.specularSunColor = mapDefParser-&gt;GetFloat3(light.unitSunColor, &quot;MAP\\LIGHT\\SpecularSunColor&quot;);
+	mapDefParser-&gt;GetTDef(light.unitShadowDensity, 0.8f, &quot;MAP\\LIGHT\\UnitShadowDensity&quot;);
+}
+
+
+void CMapInfo::ReadWater()
+{
+	// MAP\WATER
+	mapDefParser-&gt;GetTDef(water.repeatX, 0.0f, &quot;MAP\\WATER\\WaterRepeatX&quot;);
+	mapDefParser-&gt;GetTDef(water.repeatY, 0.0f, &quot;MAP\\WATER\\WaterRepeatY&quot;);
+	mapDefParser-&gt;GetTDef(water.damage, 0.0f, &quot;MAP\\WATER\\WaterDamage&quot;);
+	water.damage *= 16.0f / 30.0f;
+	
+	std::string tmp;
+	mapDefParser-&gt;GetDef(tmp, &quot;&quot;, &quot;MAP\\WATER\\WaterPlaneColor&quot;);
+	hasWaterPlane = !tmp.empty();
+	water.planeColor = mapDefParser-&gt;GetFloat3(float3(0.0f, 0.4f, 0.0f), &quot;MAP\\WATER\\WaterPlaneColor&quot;);
+
+	water.surfaceColor = mapDefParser-&gt;GetFloat3(float3(0.75f, 0.8f, 0.85f), &quot;MAP\\WATER\\WaterSurfaceColor&quot;);
+	water.absorb = mapDefParser-&gt;GetFloat3(float3(0, 0, 0), &quot;MAP\\WATER\\WaterAbsorb&quot;);
+	water.baseColor = mapDefParser-&gt;GetFloat3(float3(0, 0, 0), &quot;MAP\\WATER\\WaterBaseColor&quot;);
+	water.minColor = mapDefParser-&gt;GetFloat3(float3(0, 0, 0), &quot;MAP\\WATER\\WaterMinColor&quot;);
+	mapDefParser-&gt;GetDef(water.texture, &quot;&quot;, &quot;MAP\\WATER\\WaterTexture&quot;);
+
+	//default water is ocean.jpg in bitmaps, map specific water textures is saved in the map dir
+	if(water.texture.empty())
+		water.texture = &quot;bitmaps/&quot; + resources-&gt;SGetValueDef(&quot;ocean.jpg&quot;, &quot;resources\\graphics\\maps\\watertex&quot;);
+	else
+		water.texture = &quot;maps/&quot; + water.texture;
+}
+
+
+void CMapInfo::ReadSmf()
+{
+	// SMF specific settings
+	mapDefParser-&gt;GetDef(smf.detailTexName, &quot;&quot;, &quot;MAP\\DetailTex&quot;);
+	if (smf.detailTexName.empty())
+		smf.detailTexName = &quot;bitmaps/&quot; + resources-&gt;SGetValueDef(&quot;detailtex2.bmp&quot;, &quot;resources\\graphics\\maps\\detailtex&quot;);
+	else
+		smf.detailTexName = &quot;maps/&quot; + smf.detailTexName;
+}
+
+
+void CMapInfo::ReadSm3()
+{
+	// SM3 specific settings
+	sm3.minimap = mapDefParser-&gt;SGetValueDef(&quot;&quot;, &quot;MAP\\minimap&quot;);
+}
+
+
+void CMapInfo::ReadTerrainTypes()
+{
+	for (int a = 0; a &lt; 256; ++a) {
+		char tname[200];
+		sprintf(tname, &quot;MAP\\TerrainType%i\\&quot;, a);
+		std::string section = tname;
+		mapDefParser-&gt;GetDef (terrainTypes[a].name,  &quot;Default&quot;, section + &quot;name&quot;);
+		mapDefParser-&gt;GetTDef(terrainTypes[a].hardness,   1.0f, section + &quot;hardness&quot;);
+		mapDefParser-&gt;GetTDef(terrainTypes[a].tankSpeed,  1.0f, section + &quot;tankmovespeed&quot;);
+		mapDefParser-&gt;GetTDef(terrainTypes[a].kbotSpeed,  1.0f, section + &quot;kbotmovespeed&quot;);
+		mapDefParser-&gt;GetTDef(terrainTypes[a].hoverSpeed, 1.0f, section + &quot;hovermovespeed&quot;);
+		mapDefParser-&gt;GetTDef(terrainTypes[a].shipSpeed,  1.0f, section + &quot;shipmovespeed&quot;);
+		mapDefParser-&gt;GetDef(terrainTypes[a].receiveTracks, &quot;1&quot;, section + &quot;receivetracks&quot;);
+	}
+}

Added: trunk/rts/Map/MapInfo.h
===================================================================
--- trunk/rts/Map/MapInfo.h	                        (rev 0)
+++ trunk/rts/Map/MapInfo.h	2008-04-24 12:13:55 UTC (rev 5772)
@@ -0,0 +1,155 @@
+#ifndef MAPINFO_H
+#define MAPINFO_H
+
+#include &lt;string&gt;
+#include &quot;float3.h&quot;
+
+class TdfParser;
+
+
+class CMapInfo
+{
+public:
+
+	static void OpenTDF(const std::string&amp; mapname, TdfParser&amp; parser);
+	static std::string GetTDFName(const std::string&amp; mapname);
+
+	CMapInfo(const std::string&amp; mapname);
+	~CMapInfo();
+
+	/** @brief Get a readonly reference to the TDF parser.
+	    This is needed by SM3 code to load feature and layer data. */
+	const TdfParser&amp; GetMapDefParser() const { return *mapDefParser; }
+
+	/* The settings are just public members because:
+
+	   1) it's quite some work to encapsulate all of them, and
+	   2) nothing too bad happens if you modify them, there are no complex
+	      pointer members that really beg for encapsulation.
+
+	   Instead of encapsulation it is as effective and much easier make the
+	   global mapInfo const, ie. const CMapInfo* mapInfo;
+	 */
+
+	/* Note: this could (should) have been anonymous structures if only MSVC 8
+	   didn't crap out on it.  Specifically, it craps out on any class with at
+	   least 1 user defined non-inline constructor and at least 2 anonymous
+	   structures, each with at least 1 object with a constructor in it.
+	   In other words, it probably assigns the same name to each anonymous
+	   structure, and later gets confused by that.
+
+	   This sample code triggers the problem in MSVC:
+
+		class A {
+			A::A();
+			struct { std::string s1; } a1;
+			struct { std::string s2; } a2;
+		};
+		A::A() {}
+	 */
+
+	/** Global settings, ie. from &quot;MAP&quot; section. */
+	struct map_t {
+		std::string name;      ///&lt; The filename as passed to the constructor.
+		std::string humanName; ///&lt; &quot;MAP\\Description&quot;
+		float hardness;        ///&lt; &quot;MAP\\MapHardness&quot;
+		bool  notDeformable;
+		/** Stores the gravity as a negative number in units/frame^2
+		    (NOT positive units/second^2 as in the mapfile) */
+		float gravity;
+		float tidalStrength;
+		float maxMetal;
+		float extractorRadius; ///&lt; extraction radius for mines
+		bool  voidWater;
+	} map;
+
+	/** GUI settings (used by CGuiHandler) */
+	struct gui_t {
+		bool autoShowMetal;
+	} gui;
+
+	/** settings read from &quot;MAP\ATMOSPHERE&quot; section */
+	struct atmosphere_t {
+		float  cloudDensity;
+		float  fogStart;
+		float3 fogColor;
+		float3 skyColor;
+		float3 sunColor;
+		float3 cloudColor;
+		float  minWind;
+		float  maxWind;
+		std::string skyBox;
+	} atmosphere;
+
+	/** settings read from &quot;MAP\LIGHT&quot; section */
+	struct light_t {
+		float3 sunDir;     ///&lt; Holds vector for the direction of the sun
+		float  sunDir4[4]; ///&lt; sunDir as 4 component vector
+		float3 groundAmbientColor;
+		float3 groundSunColor;
+		float3 groundSpecularColor;
+		float  groundShadowDensity;
+		float3 unitAmbientColor;
+		float3 unitSunColor;
+		float3 specularSunColor;
+		float  unitShadowDensity;
+	} light;
+
+	/** settings read from &quot;MAP\WATER&quot; section
+	    prefix their name with &quot;Water&quot; to get the TDF variable */
+	struct water_t {
+		float  repeatX; ///&lt; (calculated default is in CBaseWater)
+		float  repeatY; ///&lt; (calculated default is in CBaseWater)
+		float  damage;
+		float3 absorb;
+		float3 baseColor;
+		float3 minColor;
+		float3 surfaceColor;
+		float3 planeColor;
+		std::string texture;
+	} water;
+	bool hasWaterPlane; ///&lt; true if &quot;MAP\WATER\WaterPlaneColor&quot; is set
+
+	/** SMF specific settings */
+	struct smf_t {
+		std::string detailTexName; ///&lt; &quot;MAP\DetailTex&quot;
+	} smf;
+
+	/** SM3 specific settings
+	    This is NOT complete, SM3 stores so much in the map settings
+	    that it really isn't a good idea to put them here. */
+	struct sm3_t {
+		std::string minimap; ///&lt; &quot;MAP\minimap&quot;
+	} sm3;
+
+	/** Terrain type, there can be 256 of these:
+	    &quot;MAP\TerrainType0&quot; up to &quot;MAP\TerrainType255&quot; */
+	struct TerrainType {
+		std::string name;
+		float hardness;
+		float tankSpeed;   ///&lt; &quot;TankMoveSpeed&quot;
+		float kbotSpeed;   ///&lt; &quot;KbotMoveSpeed&quot;
+		float hoverSpeed;  ///&lt; &quot;HoverMoveSpeed&quot;
+		float shipSpeed;   ///&lt; &quot;ShipMoveSpeed&quot;
+		bool receiveTracks;
+	};
+	TerrainType terrainTypes[256];
+
+private:
+
+	void ReadGlobal();
+	void ReadGui();
+	void ReadAtmosphere();
+	void ReadLight();
+	void ReadWater();
+	void ReadSmf();
+	void ReadSm3();
+	void ReadTerrainTypes();
+
+	TdfParser* resources;
+	TdfParser* mapDefParser;
+};
+
+extern const CMapInfo* mapInfo;
+
+#endif // MAPINFO_H

Modified: trunk/rts/Map/ReadMap.cpp
===================================================================
--- trunk/rts/Map/ReadMap.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Map/ReadMap.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -7,16 +7,12 @@
 #include &quot;ReadMap.h&quot;
 #include &lt;stdlib.h&gt;
 #include &lt;string&gt;
-//#include &lt;ostream&gt;
 #include &quot;Rendering/Textures/Bitmap.h&quot;
 #include &quot;Ground.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
-#ifdef _WIN32
-#include &lt;process.h&gt;
-#endif
 #include &quot;MapDamage.h&quot;
+#include &quot;MapInfo.h&quot;
 #include &quot;MetalMap.h&quot;
-#include &quot;Sim/Misc/GroundBlockingObjectMap.h&quot;
 #include &quot;Sim/Path/PathManager.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
@@ -42,25 +38,7 @@
 				CR_SERIALIZER(Serialize)
 				));
 
-void CReadMap::OpenTDF (const std::string&amp; mapname, TdfParser&amp; parser)
-{
-	parser.LoadFile(GetTDFName(mapname));
-}
 
-std::string CReadMap::GetTDFName(const std::string&amp; mapname)
-{
-	if (mapname.length() &lt; 3)
-		throw std::runtime_error(&quot;CReadMap::GetTDFName(): mapname '&quot; + mapname + &quot;' too short&quot;);
-
-	string extension = mapname.substr(mapname.length()-3);
-	if (extension == &quot;smf&quot;)
-		return string(&quot;maps/&quot;)+mapname.substr(0,mapname.find_last_of('.'))+&quot;.smd&quot;;
-	else if(extension == &quot;sm3&quot;)
-		return string(&quot;maps/&quot;)+mapname;
-	else
-		throw std::runtime_error(&quot;CReadMap::GetTDFName(): Unknown extension: &quot; + extension);
-}
-
 CReadMap* CReadMap::LoadMap (const std::string&amp; mapname)
 {
 	if (mapname.length() &lt; 3)
@@ -78,8 +56,6 @@
 	if (!rm)
 		return 0;
 
-	rm-&gt;mapName = mapname;
-
 	/* Read metal map */
 	MapBitmapInfo mbi;
 	unsigned char  *metalmap = rm-&gt;GetInfoMap (&quot;metal&quot;, &amp;mbi);
@@ -88,7 +64,7 @@
 		int size = mbi.width*mbi.height;
 		unsigned char *map = SAFE_NEW unsigned char[size];
 		memcpy(map, metalmap, size);
-		rm-&gt;metalMap = SAFE_NEW CMetalMap(map, mbi.width, mbi.height, rm-&gt;maxMetal);
+		rm-&gt;metalMap = SAFE_NEW CMetalMap(map, mbi.width, mbi.height, mapInfo-&gt;map.maxMetal);
 	}
 	if (metalmap) rm-&gt;FreeInfoMap (&quot;metal&quot;, metalmap);
 
@@ -106,28 +82,10 @@
 		assert (gs-&gt;hmapx == tbi.width &amp;&amp; gs-&gt;hmapy == tbi.height);
 		rm-&gt;typemap = SAFE_NEW unsigned char[tbi.width*tbi.height];
 		memcpy(rm-&gt;typemap, typemap, tbi.width*tbi.height);
-
-		rm-&gt;terrainTypes.resize(256);
-		for(int a=0;a&lt;256;++a){
-			char tname[200];
-			sprintf(tname,&quot;TerrainType%i\\&quot;,a);
-			string section=&quot;map\\&quot;;
-			section+=tname;
-			rm-&gt;mapDefParser.GetDef(rm-&gt;terrainTypes[a].name,&quot;Default&quot;,section+&quot;name&quot;);
-			rm-&gt;mapDefParser.GetDef(rm-&gt;terrainTypes[a].hardness,&quot;1&quot;,section+&quot;hardness&quot;);
-			rm-&gt;mapDefParser.GetDef(rm-&gt;terrainTypes[a].tankSpeed,&quot;1&quot;,section+&quot;tankmovespeed&quot;);
-			rm-&gt;mapDefParser.GetDef(rm-&gt;terrainTypes[a].kbotSpeed,&quot;1&quot;,section+&quot;kbotmovespeed&quot;);
-			rm-&gt;mapDefParser.GetDef(rm-&gt;terrainTypes[a].hoverSpeed,&quot;1&quot;,section+&quot;hovermovespeed&quot;);
-			rm-&gt;mapDefParser.GetDef(rm-&gt;terrainTypes[a].shipSpeed,&quot;1&quot;,section+&quot;shipmovespeed&quot;);
-			rm-&gt;mapDefParser.GetDef(rm-&gt;terrainTypes[a].receiveTracks,&quot;1&quot;,section+&quot;receivetracks&quot;);
-		}
 	} else
 		throw content_error(&quot;Bad/no terrain type map.&quot;);
 	if (typemap) rm-&gt;FreeInfoMap (&quot;type&quot;, typemap);
 
-	// FIXME: this isn't really the right place for this -&gt; refactor sometime
-	groundBlockingObjectMap = new CGroundBlockingObjectMap(gs-&gt;mapSquares);
-
 	return rm;
 }
 
@@ -137,8 +95,6 @@
 		slopemap(NULL),
 		facenormals(NULL),
 		typemap(NULL),
-		heightLinePal(NULL),
-//		groundBlockingObjectMap(NULL),
 		metalMap(NULL)
 {
 	memset(mipHeightmap, 0, sizeof(mipHeightmap));
@@ -156,8 +112,6 @@
 		delete[] mipHeightmap[i];
 
 	delete[] orgheightmap;
-//	delete[] groundBlockingObjectMap;
-	delete[] heightLinePal;
 }
 
 void CReadMap::Serialize(creg::ISerializer&amp; s)
@@ -172,11 +126,8 @@
 void CReadMap::Initialize()
 {
 	PrintLoadMsg(&quot;Loading Map&quot;);
-	float* heightmap = GetHeightmap();
 
 	orgheightmap=SAFE_NEW float[(gs-&gt;mapx+1)*(gs-&gt;mapy+1)];
-	for(int y=0;y&lt;(gs-&gt;mapy+1)*(gs-&gt;mapx+1);++y)
-		orgheightmap[y]=heightmap[y];
 
 	//	normals=SAFE_NEW float3[(gs-&gt;mapx+1)*(gs-&gt;mapy+1)];
 	facenormals=SAFE_NEW float3[gs-&gt;mapx*gs-&gt;mapy*2];
@@ -188,36 +139,6 @@
 
 	slopemap=SAFE_NEW float[gs-&gt;hmapx*gs-&gt;hmapy];
 
-	heightLinePal=SAFE_NEW unsigned char[3*256];
-	if(configHandler.GetInt(&quot;ColorElev&quot;,1)){
-		for(int a=0;a&lt;86;++a){
-			heightLinePal[a*3+0]=255-a*3;
-			heightLinePal[a*3+1]=a*3;
-			heightLinePal[a*3+2]=0;
-		}
-		for(int a=86;a&lt;172;++a){
-			heightLinePal[a*3+0]=0;
-			heightLinePal[a*3+1]=255-(a-86)*3;
-			heightLinePal[a*3+2]=(a-86)*3;
-		}
-		for(int a=172;a&lt;256;++a){
-			heightLinePal[a*3+0]=(a-172)*3;
-			heightLinePal[a*3+1]=0;
-			heightLinePal[a*3+2]=255-(a-172)*3;
-		}
-	} else {
-		for(int a=0;a&lt;29;++a){
-			heightLinePal[a*3+0]=255-a*8;
-			heightLinePal[a*3+1]=255-a*8;
-			heightLinePal[a*3+2]=255-a*8;
-		}
-		for(int a=29;a&lt;256;++a){
-			heightLinePal[a*3+0]=a;
-			heightLinePal[a*3+1]=a;
-			heightLinePal[a*3+2]=a;
-		}
-	}
-
 	CalcHeightfieldData();
 }
 
@@ -311,74 +232,5 @@
 }
 
 
-extern GLfloat FogLand[];
-
-void CReadMap::ParseSettings(TdfParser&amp; resources)
-{
-	mapHumanName = mapDefParser.SGetValueDef(mapName, &quot;MAP\\Description&quot;);
-
-	gs-&gt;sunVector=mapDefParser.GetFloat3(float3(0,1,2),&quot;MAP\\LIGHT\\SunDir&quot;);
-	gs-&gt;sunVector.Normalize();
-	gs-&gt;sunVector4[0]=gs-&gt;sunVector[0];
-	gs-&gt;sunVector4[1]=gs-&gt;sunVector[1];
-	gs-&gt;sunVector4[2]=gs-&gt;sunVector[2];
-	gs-&gt;sunVector4[3]=0;
-
-	gs-&gt;gravity=-atof(mapDefParser.SGetValueDef(&quot;130&quot;,&quot;MAP\\Gravity&quot;).c_str())/(GAME_SPEED*GAME_SPEED);
-
-	float3 fogColor=mapDefParser.GetFloat3(float3(0.7f,0.7f,0.8f),&quot;MAP\\ATMOSPHERE\\FogColor&quot;);
-	FogLand[0]=fogColor[0];
-	FogLand[1]=fogColor[1];
-	FogLand[2]=fogColor[2];
-
-	mapDefParser.GetDef(skyBox, &quot;&quot;, &quot;MAP\\ATMOSPHERE\\SkyBox&quot;);
-	std::string tmp;
-	mapDefParser.GetDef(tmp, &quot;&quot;, &quot;MAP\\WATER\\WaterPlaneColor&quot;);
-	if(tmp.empty())
-		hasWaterPlane=0;
-	else
-	{
-		hasWaterPlane = 1;
-		waterPlaneColor = mapDefParser.GetFloat3(float3(0.0f,0.4f,0.0f),&quot;MAP\\WATER\\WaterPlaneColor&quot;);
-	}
-	mapDefParser.GetDef(tidalStrength, &quot;0&quot;, &quot;MAP\\TidalStrength&quot;);
-
-	waterSurfaceColor=mapDefParser.GetFloat3(float3(0.75f,0.8f,0.85f),&quot;MAP\\WATER\\WaterSurfaceColor&quot;);
-	waterAbsorb=mapDefParser.GetFloat3(float3(0,0,0),&quot;MAP\\WATER\\WaterAbsorb&quot;);
-	waterBaseColor=mapDefParser.GetFloat3(float3(0,0,0),&quot;MAP\\WATER\\WaterBaseColor&quot;);
-	waterMinColor=mapDefParser.GetFloat3(float3(0,0,0),&quot;MAP\\WATER\\WaterMinColor&quot;);
-	mapDefParser.GetDef(waterTexture, &quot;&quot;, &quot;MAP\\WATER\\WaterTexture&quot;);
-	if(waterTexture.empty())	//default water is ocean.jpg in bitmaps, map specific water textures is saved in the map dir
-		waterTexture = &quot;bitmaps/&quot;+resources.SGetValueDef(&quot;ocean.jpg&quot;,&quot;resources\\graphics\\maps\\watertex&quot;);
-	else
-		waterTexture = &quot;maps/&quot; + waterTexture;
-
-	ambientColor=mapDefParser.GetFloat3(float3(0.5f,0.5f,0.5f),&quot;MAP\\LIGHT\\GroundAmbientColor&quot;);
-	sunColor=mapDefParser.GetFloat3(float3(0.5f,0.5f,0.5f),&quot;MAP\\LIGHT\\GroundSunColor&quot;);
-	specularColor=mapDefParser.GetFloat3(float3(0.1f,0.1f,0.1f),&quot;MAP\\LIGHT\\GroundSpecularColor&quot;);
-	mapDefParser.GetDef(shadowDensity, &quot;0.8&quot;, &quot;MAP\\LIGHT\\GroundShadowDensity&quot;);
-
-	mapDefParser.GetDef(maxMetal,&quot;0.02&quot;,&quot;MAP\\MaxMetal&quot;);
-	mapDefParser.GetDef(extractorRadius,&quot;500&quot;,&quot;MAP\\ExtractorRadius&quot;);
-
-	mapDefParser.GetDef(voidWater, &quot;0&quot;, &quot;MAP\\voidWater&quot;);
-}
-
-//this function assumes that the correct map has been loaded and only load/saves new height values
-void CReadMap::LoadSaveMap(CLoadSaveInterface* file,bool loading)
-{
-	float* heightmap=readmap-&gt;GetHeightmap();
-	//load/save heightmap
-	for(int y=0;y&lt;gs-&gt;mapy+1;++y){
-		for(int x=0;x&lt;gs-&gt;mapx+1;++x){
-			file-&gt;lsFloat(heightmap[y*(gs-&gt;mapx+1)+x]);
-		}
-	}
-	//recalculate dependent values if loading
-	if(loading){
-		mapDamage-&gt;RecalcArea(0,gs-&gt;mapx,0,gs-&gt;mapy);
-	}
-}
-
 CReadMap::IQuadDrawer::~IQuadDrawer() {
 }

Modified: trunk/rts/Map/ReadMap.h
===================================================================
--- trunk/rts/Map/ReadMap.h	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Map/ReadMap.h	2008-04-24 12:13:55 UTC (rev 5772)
@@ -4,14 +4,12 @@
 //
 //////////////////////////////////////////////////////////////////////
 
-#include &lt;string&gt;
-#include &lt;vector&gt;
 #define GLEW_STATIC
 #include &lt;GL/glew.h&gt;
+#include &quot;creg/creg.h&quot;
 #include &quot;float3.h&quot;
-#include &quot;MetalMap.h&quot;
-#include &quot;TdfParser.h&quot;
 
+class CMetalMap;
 class CCamera;
 class CFileHandler;
 class CUnit;
@@ -42,19 +40,13 @@
 
 	void Serialize(creg::ISerializer&amp; s); // creg serialize callback
 
-	static std::string GetTDFName (const std::string&amp; mapname);
-	static void OpenTDF (const std::string&amp; mapname, TdfParser&amp; parser);
 	static CReadMap* LoadMap (const std::string&amp; mapname);
 
 protected:
 	void Initialize(); // called by implementations of CReadMap
 public:
 	void CalcHeightfieldData(); /// Calculates derived heightmap information such as normals, centerheightmap and slopemap
-	void ParseSettings(TdfParser&amp; resources);
 
-	std::string mapName;
-	std::string mapHumanName;
-
 	virtual float* GetHeightmap() = 0; // if you modify the heightmap, call HeightmapUpdated
 	float* orgheightmap;
 	float* centerheightmap;
@@ -64,35 +56,10 @@
 	float3* facenormals;
 	unsigned char* typemap;
 
-	unsigned char* heightLinePal;
-
-	struct TerrainType{
-		std::string name;
-		float hardness;
-		float tankSpeed;
-		float kbotSpeed;
-		float hoverSpeed;
-		float shipSpeed;
-		int receiveTracks;
-	};
-
-	std::vector&lt;TerrainType&gt; terrainTypes;
-
 	CMetalMap *metalMap;					//Metal-density/height-map
 
-	float tidalStrength;
-	float3 waterAbsorb;
-	float3 waterBaseColor;
-	float3 waterMinColor;
-	float3 waterSurfaceColor;
-	float maxMetal;
-
 	int width, height;
 
-	float3 waterPlaneColor;
-	bool hasWaterPlane;
-	std::string waterTexture;
-
 	unsigned int mapChecksum;
 protected:
 	CReadMap(); // use LoadMap
@@ -130,19 +97,7 @@
 	};
 	virtual void GridVisibility(CCamera *cam, int quadSize, float maxdist, IQuadDrawer *cb, int extraSize=0) = 0;
 
-	TdfParser mapDefParser;
-
-	float3 ambientColor;
-	float3 sunColor;
-	float3 specularColor; // ground specular color
-	float shadowDensity;
-	float extractorRadius;			//extraction radius for mines
-	bool voidWater;
-
 	float minheight,maxheight;
-	void LoadSaveMap(CLoadSaveInterface* file,bool loading);
-
-	std::string skyBox;
 };
 
 extern CReadMap* readmap;

Modified: trunk/rts/Map/SM3/Sm3GroundDrawer.cpp
===================================================================
--- trunk/rts/Map/SM3/Sm3GroundDrawer.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Map/SM3/Sm3GroundDrawer.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -8,6 +8,7 @@
 #include &quot;Rendering/ShadowHandler.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;Rendering/GroundDecalHandler.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #define GLEW_STATIC
 #include &lt;GL/glew.h&gt;
 #include &quot;Platform/ConfigHandler.h&quot;
@@ -74,7 +75,7 @@
 
 	terrain::RenderContext *currc = rc;
 
-	tr-&gt;SetShaderParams(gs-&gt;sunVector, currc-&gt;cam-&gt;pos);
+	tr-&gt;SetShaderParams(mapInfo-&gt;light.sunDir, currc-&gt;cam-&gt;pos);
 
 	if (shadowHandler-&gt;drawShadows)
 	{
@@ -97,16 +98,16 @@
 
 	glColor4f(1.0f,1.0f,1.0f,1.0f);
 	glEnable(GL_LIGHTING);
-	glLightfv(GL_LIGHT0, GL_POSITION,gs-&gt;sunVector4);
+	glLightfv(GL_LIGHT0, GL_POSITION,mapInfo-&gt;light.sunDir4);
 	float d[4]={0.0f,0.0f,0.0f,1.0f};
 	for (int a=0;a&lt;3;a++)
-		d[a]=map-&gt;sunColor[a];
+		d[a]=mapInfo-&gt;light.groundSunColor[a];
 	glLightfv(GL_LIGHT0, GL_DIFFUSE, d);
 	for (int a=0;a&lt;3;a++)
-		d[a]=map-&gt;ambientColor[a];
+		d[a]=mapInfo-&gt;light.groundAmbientColor[a];
 	glLightfv(GL_LIGHT0, GL_AMBIENT, d);
 	for (int a=0;a&lt;3;a++)
-		d[a]=map-&gt;specularColor[a];
+		d[a]=mapInfo-&gt;light.groundSpecularColor[a];
 	glLightfv (GL_LIGHT0, GL_SPECULAR, d);
 	for (int a=0;a&lt;4;a++)
 		d[a]=0.0f;

Modified: trunk/rts/Map/SM3/Sm3Map.cpp
===================================================================
--- trunk/rts/Map/SM3/Sm3Map.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Map/SM3/Sm3Map.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -8,11 +8,13 @@
 #include &lt;GL/glew.h&gt;
 #include &lt;IL/il.h&gt;
 #include &lt;SDL_types.h&gt;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;Rendering/ShadowHandler.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;Platform/errorhandler.h&quot;
 #include &quot;Platform/byteorder.h&quot;
 #include &quot;FileSystem/FileHandler.h&quot;
+#include &quot;TdfParser.h&quot;
 
 #include &quot;terrain/TerrainNode.h&quot;
 #include &quot;Game/Camera.h&quot;
@@ -77,16 +79,9 @@
 		if (shadowHandler-&gt;drawShadows)
 			renderer-&gt;config.useShadowMaps = true;
 
-		// Load map info from TDF
-		std::string fn = std::string(&quot;maps/&quot;) + mapname;
-		mapDefParser.LoadFile (fn);
-		TdfParser resources(&quot;gamedata/resources.tdf&quot;);
-		ParseSettings(resources);
-
-		string minimap = mapDefParser.SGetValueDef(string(),&quot;map\\minimap&quot;);
-		if (!minimap.empty()) {
+		if (!mapInfo-&gt;sm3.minimap.empty()) {
 			CBitmap bmp;
-			if(bmp.Load(minimap))
+			if(bmp.Load(mapInfo-&gt;sm3.minimap))
 				minimapTexture=bmp.CreateTexture(true);
 		}
 
@@ -100,13 +95,13 @@
 */
 		Sm3LoadCB loadcb;
 		terrain::LightingInfo lightInfo;
-		lightInfo.ambient = ambientColor;
+		lightInfo.ambient = mapInfo-&gt;light.groundAmbientColor;
 		terrain::StaticLight light;
-		light.color = sunColor;
+		light.color = mapInfo-&gt;light.groundSunColor;
 		light.directional = false;
-		light.position = gs-&gt;sunVector *1000000;
+		light.position = mapInfo-&gt;light.sunDir *1000000;
 		lightInfo.staticLights.push_back (light);
-		renderer-&gt;Load (mapDefParser, &amp;lightInfo, &amp;loadcb);
+		renderer-&gt;Load (mapInfo-&gt;GetMapDefParser(), &amp;lightInfo, &amp;loadcb);
 
 		height = width = renderer-&gt;GetHeightmapWidth ()-1;
 
@@ -124,6 +119,7 @@
 
 		CReadMap::Initialize();
 
+		const TdfParser&amp; mapDefParser = mapInfo-&gt;GetMapDefParser();
 		if (mapDefParser.SectionExist(&quot;map\\featuretypes&quot;)) {
 			int numTypes = atoi(mapDefParser.SGetValueDef(&quot;0&quot;, &quot;map\\featuretypes\\numtypes&quot;).c_str());
 			for (int a=0;a&lt;numTypes;a++) {
@@ -255,7 +251,7 @@
 void CSm3ReadMap::LoadFeatureData()
 {
 		// returns MapFeatureInfo[GetNumFeatures()]
-	std::string fd = mapDefParser.SGetValueDef(std::string(),&quot;map\\featuredata&quot;);
+	std::string fd = mapInfo-&gt;GetMapDefParser().SGetValueDef(std::string(),&quot;map\\featuredata&quot;);
 	if (!fd.empty()) {
 		CFileHandler fh(fd);
 		if (!fh.FileExists())
@@ -316,7 +312,7 @@
 unsigned char *CSm3ReadMap::GetInfoMap (const std::string&amp; name, MapBitmapInfo* bm)
 {
 	std::string map;
-	if (!mapDefParser.SGetValue(map, &quot;MAP\\INFOMAPS\\&quot; + name))
+	if (!mapInfo-&gt;GetMapDefParser().SGetValue(map, &quot;MAP\\INFOMAPS\\&quot; + name))
 		return 0;
 
 	CBitmap img;

Modified: trunk/rts/Map/SM3/terrain/Terrain.cpp
===================================================================
--- trunk/rts/Map/SM3/terrain/Terrain.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Map/SM3/terrain/Terrain.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -861,7 +861,7 @@
 		texturing-&gt;DebugEvent (event);
 	}
 
-	void Terrain::Load(TdfParser&amp; tdf, LightingInfo *li, ILoadCallback *cb)
+	void Terrain::Load(const TdfParser&amp; tdf, LightingInfo *li, ILoadCallback *cb)
 	{
 		string basepath = &quot;MAP\\TERRAIN\\&quot;;
 

Modified: trunk/rts/Map/SM3/terrain/Terrain.h
===================================================================
--- trunk/rts/Map/SM3/terrain/Terrain.h	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Map/SM3/terrain/Terrain.h	2008-04-24 12:13:55 UTC (rev 5772)
@@ -132,7 +132,7 @@
 		void RemoveRenderContext (RenderContext *ctx);
 		void SetActiveContext (RenderContext *ctx);   // set active rendering context / camera viewpoint
 
-		void Load (TdfParser&amp; tdf, LightingInfo* li, ILoadCallback *cb);
+		void Load (const TdfParser&amp; tdf, LightingInfo* li, ILoadCallback *cb);
 		void Draw ();
 		void DrawAll (); // draw all terrain nodes, regardless of visibility or lod
 		void Update (); // update lod+visibility, should be called when camera position has changed

Modified: trunk/rts/Map/SM3/terrain/TerrainTexture.cpp
===================================================================
--- trunk/rts/Map/SM3/terrain/TerrainTexture.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Map/SM3/terrain/TerrainTexture.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -176,7 +176,7 @@
 		return btex;
 	}
 
-	void TerrainTexture::Load (TdfParser *tdf, Heightmap *heightmap, TQuad *quadtree, const vector&lt;QuadMap*&gt;&amp; qmaps, Config *cfg, ILoadCallback *cb, LightingInfo *li)
+	void TerrainTexture::Load (const TdfParser *tdf, Heightmap *heightmap, TQuad *quadtree, const vector&lt;QuadMap*&gt;&amp; qmaps, Config *cfg, ILoadCallback *cb, LightingInfo *li)
 	{
 		string basepath=&quot;MAP\\TERRAIN\\&quot;;
 
@@ -594,7 +594,7 @@
 	}
 #endif
 
-	void ShaderDef::LoadStages(int numStages,const char *stagename, TdfParser&amp; tdf, std::vector&lt;ShaderDef::Stage&gt;&amp; stages)
+	void ShaderDef::LoadStages(int numStages,const char *stagename, const TdfParser&amp; tdf, std::vector&lt;ShaderDef::Stage&gt;&amp; stages)
 	{
 		for (int a=0;a&lt;numStages;a++)
 		{
@@ -639,7 +639,7 @@
 		}
 	}
 
-	void ShaderDef::Parse(TdfParser&amp; tdf, bool needNormalMap)
+	void ShaderDef::Parse(const TdfParser&amp; tdf, bool needNormalMap)
 	{
 		string path = &quot;map\\terrain\\&quot;;
 

Modified: trunk/rts/Map/SM3/terrain/TerrainTexture.h
===================================================================
--- trunk/rts/Map/SM3/terrain/TerrainTexture.h	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Map/SM3/terrain/TerrainTexture.h	2008-04-24 12:13:55 UTC (rev 5772)
@@ -76,7 +76,7 @@
 	{
 	public:
 		ShaderDef() { hasLighting=useShadowMapping=false; specularExponent = 16.0f; }
-		void Parse(TdfParser&amp; tdf, bool needNormalMap);
+		void Parse(const TdfParser&amp; tdf, bool needNormalMap);
 		void Optimize(ShaderDef* dst);
 		void Output();
 		void GetTextureUsage(TextureUsage* tu);
@@ -103,7 +103,7 @@
 		float specularExponent;
 
 		static void OptimizeStages(std::vector&lt;Stage&gt;&amp; src, std::vector&lt;Stage&gt;&amp; dst);
-		static void LoadStages(int numStages, const char *stagename, TdfParser&amp; tdf, std::vector&lt;Stage&gt;&amp; stages);
+		static void LoadStages(int numStages, const char *stagename, const TdfParser&amp; tdf, std::vector&lt;Stage&gt;&amp; stages);
 	};
 
 	struct NodeSetupParams
@@ -192,7 +192,7 @@
 		TerrainTexture();
 		~TerrainTexture();
 
-		void Load (TdfParser *parser, Heightmap *heightmap, TQuad *quadTree, const std::vector&lt;QuadMap*&gt;&amp; qmaps, Config *cfg, ILoadCallback *cb, LightingInfo* li);
+		void Load (const TdfParser *parser, Heightmap *heightmap, TQuad *quadTree, const std::vector&lt;QuadMap*&gt;&amp; qmaps, Config *cfg, ILoadCallback *cb, LightingInfo* li);
 
 		int NumPasses ();
 
@@ -258,7 +258,7 @@
 		int maxPasses; // the highest number of passes a RenderSetupCollection requires (some nodes might need less passes than this)
 
 		//only valid during loading
-		TdfParser *tdfParser;
+		const TdfParser *tdfParser;
 
 		Lightmap *lightmap;
 		ShaderDef shaderDef;

Modified: trunk/rts/Map/SM3/terrain/Textures.cpp
===================================================================
--- trunk/rts/Map/SM3/terrain/Textures.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Map/SM3/terrain/Textures.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -100,7 +100,7 @@
 	TiledTexture::~TiledTexture()
 	{}
 
-	void TiledTexture::Load(const std::string&amp; name, const std::string&amp; section, ILoadCallback *cb, TdfParser *tdf, bool isBumpmap)
+	void TiledTexture::Load(const std::string&amp; name, const std::string&amp; section, ILoadCallback *cb, const TdfParser *tdf, bool isBumpmap)
 	{
 		this-&gt;name = name;
 
@@ -146,7 +146,7 @@
 			delete generatorInfo;
 	}
 
-	void Blendmap::Load(const std::string&amp; name, const std::string&amp; section, Heightmap *heightmap, ILoadCallback *cb, TdfParser *tdf)
+	void Blendmap::Load(const std::string&amp; name, const std::string&amp; section, Heightmap *heightmap, ILoadCallback *cb, const TdfParser *tdf)
 	{
 		// Create blendmap
 		this-&gt;name = name;

Modified: trunk/rts/Map/SM3/terrain/Textures.h
===================================================================
--- trunk/rts/Map/SM3/terrain/Textures.h	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Map/SM3/terrain/Textures.h	2008-04-24 12:13:55 UTC (rev 5772)
@@ -103,7 +103,7 @@
 		TiledTexture ();
 		~TiledTexture ();
 
-		void Load(const std::string&amp; name, const std::string&amp; section, ILoadCallback *cb, TdfParser *tdf, bool isBumpmap);
+		void Load(const std::string&amp; name, const std::string&amp; section, ILoadCallback *cb, const TdfParser *tdf, bool isBumpmap);
 		static TiledTexture* CreateFlatBumpmap();
 	};
 
@@ -113,7 +113,7 @@
 		~Blendmap ();
 
 		void Generate (Heightmap *rootHm, int lodLevel, float hmscale, float hmoffset);
-		void Load(const std::string&amp; name, const std::string&amp; section, Heightmap *heightmap, ILoadCallback *cb, TdfParser *tdf);
+		void Load(const std::string&amp; name, const std::string&amp; section, Heightmap *heightmap, ILoadCallback *cb, const TdfParser *tdf);
 
 		struct GeneratorInfo {
 			float coverage, noise;

Modified: trunk/rts/Map/SMF/BFGroundDrawer.cpp
===================================================================
--- trunk/rts/Map/SMF/BFGroundDrawer.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Map/SMF/BFGroundDrawer.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -4,6 +4,7 @@
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Game/Camera.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;LogOutput.h&quot;
@@ -109,7 +110,7 @@
 inline void CBFGroundDrawer::DrawWaterPlane(bool drawWaterReflection) {
 	if (!drawWaterReflection) {
 		glDisable(GL_TEXTURE_2D);
-		glColor3f(map-&gt;waterPlaneColor.x, map-&gt;waterPlaneColor.y, map-&gt;waterPlaneColor.z);
+		glColor3f(mapInfo-&gt;water.planeColor.x, mapInfo-&gt;water.planeColor.y, mapInfo-&gt;water.planeColor.z);
 		glBegin(GL_QUADS);
 
 		static const float xsize = (gs-&gt;mapx * SQUARE_SIZE) &gt;&gt; 2;
@@ -178,7 +179,7 @@
 	SetupTextureUnits(drawWaterReflection, overrideVP);
 	bool inStrip = false;
 
-	if (map-&gt;voidWater &amp;&amp; !waterDrawn) {
+	if (mapInfo-&gt;map.voidWater &amp;&amp; !waterDrawn) {
 		glEnable(GL_ALPHA_TEST);
 		glAlphaFunc(GL_GREATER, 0.9f);
 	}
@@ -633,11 +634,11 @@
 		glPolygonMode(GL_FRONT_AND_BACK, GL_FILL);
 	}
 
-	if (map-&gt;voidWater &amp;&amp; !waterDrawn) {
+	if (mapInfo-&gt;map.voidWater &amp;&amp; !waterDrawn) {
 		glDisable(GL_ALPHA_TEST);
 	}
 
-	if (map-&gt;hasWaterPlane) {
+	if (mapInfo-&gt;hasWaterPlane) {
 		DrawWaterPlane(drawWaterReflection);
 	}
 
@@ -1018,9 +1019,9 @@
 	else if (shadowHandler-&gt;drawShadows) {
 		glBindProgramARB(GL_FRAGMENT_PROGRAM_ARB, groundFPShadow);
 		glEnable(GL_FRAGMENT_PROGRAM_ARB);
-		float3 ac = map-&gt;ambientColor * (210.0f / 255.0f);
+		float3 ac = mapInfo-&gt;light.groundAmbientColor * (210.0f / 255.0f);
 		glProgramEnvParameter4fARB(GL_FRAGMENT_PROGRAM_ARB, 10, ac.x, ac.y, ac.z, 1);
-		glProgramEnvParameter4fARB(GL_FRAGMENT_PROGRAM_ARB, 11, 0, 0, 0, map-&gt;shadowDensity);
+		glProgramEnvParameter4fARB(GL_FRAGMENT_PROGRAM_ARB, 11, 0, 0, 0, mapInfo-&gt;light.groundShadowDensity);
 
 		glActiveTextureARB(GL_TEXTURE0_ARB);
 		glActiveTextureARB(GL_TEXTURE1_ARB);

Modified: trunk/rts/Map/SMF/SmfReadMap.cpp
===================================================================
--- trunk/rts/Map/SMF/SmfReadMap.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Map/SMF/SmfReadMap.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -1,6 +1,7 @@
 #include &quot;StdAfx.h&quot;
 #include &quot;SmfReadMap.h&quot;
 #include &quot;mapfile.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;FileSystem/FileHandler.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
@@ -34,20 +35,9 @@
 
 	ConfigureAnisotropy();
 
-	string smdfile = string(&quot;maps/&quot;)+mapname.substr(0,mapname.find_last_of('.'))+&quot;.smd&quot;;
-	mapDefParser.LoadFile(smdfile);
-	TdfParser resources(&quot;gamedata/resources.tdf&quot;);
-	ParseSettings(resources);
-
-	mapDefParser.GetDef(detailTexName, &quot;&quot;, &quot;MAP\\DetailTex&quot;);
-	if(detailTexName.empty())
-		detailTexName = &quot;bitmaps/&quot;+resources.SGetValueDef(&quot;detailtex2.bmp&quot;,&quot;resources\\graphics\\maps\\detailtex&quot;);
-	else
-		detailTexName = &quot;maps/&quot; + detailTexName;
-
 	for(int a=0;a&lt;1024;++a){
 		for(int b=0;b&lt;3;++b){
-			float c=max(waterMinColor[b],waterBaseColor[b]-waterAbsorb[b]*a);
+			float c=max(mapInfo-&gt;water.minColor[b],mapInfo-&gt;water.baseColor[b]-mapInfo-&gt;water.absorb[b]*a);
 			waterHeightColors[a*4+b]=(unsigned char)(c*210);
 		}
 		waterHeightColors[a*4+3]=1;
@@ -105,6 +95,8 @@
 
 	PrintLoadMsg(&quot;Loading detail textures&quot;);
 
+	detailTexName = mapInfo-&gt;smf.detailTexName;
+
 	CBitmap bm;
 	if (!bm.Load(detailTexName))
 		throw content_error(&quot;Could not load detail texture from file &quot; + detailTexName);
@@ -231,12 +223,12 @@
 	float3 n1=facenormals[(y*gs-&gt;mapx+x)*2]+facenormals[(y*gs-&gt;mapx+x)*2+1];
 	n1.Normalize();
 
-	float3 light=sunColor*gs-&gt;sunVector.dot(n1);
+	float3 light=mapInfo-&gt;light.groundSunColor*mapInfo-&gt;light.sunDir.dot(n1);
 	for(int a=0;a&lt;3;++a)
 		if(light[a]&lt;0)
 			light[a]=0;
 
-	light+=ambientColor;
+	light+=mapInfo-&gt;light.groundAmbientColor;
 	for(int a=0;a&lt;3;++a)
 		if(light[a]&gt;1)
 			light[a]=1;

Modified: trunk/rts/Rendering/Env/AdvSky.cpp
===================================================================
--- trunk/rts/Rendering/Env/AdvSky.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Rendering/Env/AdvSky.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -7,6 +7,7 @@
 
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Game/Camera.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;Rendering/Textures/Bitmap.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
@@ -35,16 +36,16 @@
 	domeheight=cos(PI/16)*1.01f;
 	domeWidth=sin(2*PI/32)*400*1.7f;
 
-	sundir2=gs-&gt;sunVector;
+	sundir2=mapInfo-&gt;light.sunDir;
 	sundir2.y=0;
 	if(sundir2.Length()==0)
 		sundir2.x=1;
 	sundir2.Normalize();
 	sundir1=sundir2.cross(UpVector);
 
-	modSunDir.y=gs-&gt;sunVector.y;
+	modSunDir.y=mapInfo-&gt;light.sunDir.y;
 	modSunDir.x=0;
-	modSunDir.z=sqrt(gs-&gt;sunVector.x*gs-&gt;sunVector.x+gs-&gt;sunVector.z*gs-&gt;sunVector.z);
+	modSunDir.z=sqrt(mapInfo-&gt;light.sunDir.x*mapInfo-&gt;light.sunDir.x+mapInfo-&gt;light.sunDir.z*mapInfo-&gt;light.sunDir.z);
 
 	sunTexCoordX=0.5f;
 	sunTexCoordY=GetTexCoordFromDir(modSunDir);
@@ -57,12 +58,13 @@
 //	dynamicSky=!!regHandler.GetInt(&quot;DynamicSky&quot;,0);
 	dynamicSky=false;
 	lastCloudUpdate=-30;
-	readmap-&gt;mapDefParser.GetDef(cloudDensity,&quot;0.5&quot;,&quot;MAP\\ATMOSPHERE\\CloudDensity&quot;);
-	readmap-&gt;mapDefParser.GetDef(fogStart,&quot;0.1&quot;,&quot;MAP\\ATMOSPHERE\\FogStart&quot;);
+
+	cloudDensity = mapInfo-&gt;atmosphere.cloudDensity;
+	cloudColor = mapInfo-&gt;atmosphere.cloudColor;
+	skyColor = mapInfo-&gt;atmosphere.skyColor;
+	sunColor = mapInfo-&gt;atmosphere.sunColor;
+	fogStart = mapInfo-&gt;atmosphere.fogStart;
 	if (fogStart&gt;0.99f) gu-&gt;drawFog = false;
-	skyColor=readmap-&gt;mapDefParser.GetFloat3(float3(0.1f,0.15f,0.7f),&quot;MAP\\ATMOSPHERE\\SkyColor&quot;);
-	sunColor=readmap-&gt;mapDefParser.GetFloat3(float3(1,1,1),&quot;MAP\\ATMOSPHERE\\SunColor&quot;);
-	cloudColor=readmap-&gt;mapDefParser.GetFloat3(float3(1,1,1),&quot;MAP\\ATMOSPHERE\\CloudColor&quot;);
 
 	CreateClouds();
 	InitSun();

Modified: trunk/rts/Rendering/Env/AdvTreeDrawer.cpp
===================================================================
--- trunk/rts/Rendering/Env/AdvTreeDrawer.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Rendering/Env/AdvTreeDrawer.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -6,6 +6,7 @@
 #include &quot;AdvTreeDrawer.h&quot;
 #include &quot;Map/BaseGroundDrawer.h&quot;
 #include &quot;Map/Ground.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;Game/Camera.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Map/ReadMap.h&quot;
@@ -250,16 +251,16 @@
 		if(shadowHandler-&gt;useFPShadows){
 			glBindProgramARB( GL_FRAGMENT_PROGRAM_ARB, treeGen-&gt;treeFPShadow );
 			glEnable( GL_FRAGMENT_PROGRAM_ARB );
-			glProgramEnvParameter4fARB(GL_FRAGMENT_PROGRAM_ARB,10, readmap-&gt;ambientColor.x,readmap-&gt;ambientColor.y,readmap-&gt;ambientColor.z,1);
-			glProgramEnvParameter4fARB(GL_FRAGMENT_PROGRAM_ARB,11, 0,0,0,1-readmap-&gt;shadowDensity*0.5f);
+			glProgramEnvParameter4fARB(GL_FRAGMENT_PROGRAM_ARB,10, mapInfo-&gt;light.groundAmbientColor.x,mapInfo-&gt;light.groundAmbientColor.y,mapInfo-&gt;light.groundAmbientColor.z,1);
+			glProgramEnvParameter4fARB(GL_FRAGMENT_PROGRAM_ARB,11, 0,0,0,1-mapInfo-&gt;light.groundShadowDensity*0.5f);
 
 			glActiveTextureARB(GL_TEXTURE1_ARB);
 			glBindTexture(GL_TEXTURE_2D, activeFarTex);
 		} else {
 			glEnable(GL_TEXTURE_2D);
-			glTexParameterf(GL_TEXTURE_2D, GL_TEXTURE_COMPARE_FAIL_VALUE_ARB, 1-readmap-&gt;shadowDensity*0.5f);
+			glTexParameterf(GL_TEXTURE_2D, GL_TEXTURE_COMPARE_FAIL_VALUE_ARB, 1-mapInfo-&gt;light.groundShadowDensity*0.5f);
 
-			float texConstant[]={readmap-&gt;ambientColor.x,readmap-&gt;ambientColor.y,readmap-&gt;ambientColor.z,0.0f};
+			float texConstant[]={mapInfo-&gt;light.groundAmbientColor.x,mapInfo-&gt;light.groundAmbientColor.y,mapInfo-&gt;light.groundAmbientColor.z,0.0f};
 			glTexEnvfv(GL_TEXTURE_ENV,GL_TEXTURE_ENV_COLOR,texConstant);
 			glTexEnvi(GL_TEXTURE_ENV,GL_SOURCE0_RGB_ARB,GL_PREVIOUS_ARB);
 			glTexEnvi(GL_TEXTURE_ENV,GL_SOURCE1_RGB_ARB,GL_CONSTANT);
@@ -318,8 +319,8 @@
 		glEnable( GL_VERTEX_PROGRAM_ARB );
 		glProgramEnvParameter4fARB(GL_VERTEX_PROGRAM_ARB,13,  camera-&gt;right.x,camera-&gt;right.y,camera-&gt;right.z,0);
 		glProgramEnvParameter4fARB(GL_VERTEX_PROGRAM_ARB,9,  camera-&gt;up.x,camera-&gt;up.y,camera-&gt;up.z,0);
-		glProgramEnvParameter4fARB(GL_VERTEX_PROGRAM_ARB,11, readmap-&gt;sunColor.x,readmap-&gt;sunColor.y,readmap-&gt;sunColor.z,0.85f);
-		glProgramEnvParameter4fARB(GL_VERTEX_PROGRAM_ARB,14, readmap-&gt;ambientColor.x,readmap-&gt;ambientColor.y,readmap-&gt;ambientColor.z,0.85f);
+		glProgramEnvParameter4fARB(GL_VERTEX_PROGRAM_ARB,11, mapInfo-&gt;light.groundSunColor.x,mapInfo-&gt;light.groundSunColor.y,mapInfo-&gt;light.groundSunColor.z,0.85f);
+		glProgramEnvParameter4fARB(GL_VERTEX_PROGRAM_ARB,14, mapInfo-&gt;light.groundAmbientColor.x,mapInfo-&gt;light.groundAmbientColor.y,mapInfo-&gt;light.groundAmbientColor.z,0.85f);
 		glProgramEnvParameter4fARB(GL_VERTEX_PROGRAM_ARB,12, 0,0,0,0.20f*(1.0f/MAX_TREE_HEIGHT));	//w=alpha/height modifier
 		glAlphaFunc(GL_GREATER,0.5f);
 		glDisable(GL_BLEND);
@@ -336,8 +337,8 @@
 		static FadeTree fadeTrees[3000];
 		int curFade=0;
 
-		for(int y=max(0,cy-2);y&lt;=min(gs-&gt;mapy/TREE_SQUARE_SIZE-1,cy+2);++y){	//close trees
-			for(int x=max(0,cx-2);x&lt;=min(gs-&gt;mapx/TREE_SQUARE_SIZE-1,cx+2);++x){
+		for(int y=std::max(0,cy-2);y&lt;=std::min(gs-&gt;mapy/TREE_SQUARE_SIZE-1,cy+2);++y){	//close trees
+			for(int x=std::max(0,cx-2);x&lt;=std::min(gs-&gt;mapx/TREE_SQUARE_SIZE-1,cx+2);++x){
 				TreeSquareStruct* tss=&amp;trees[y*treesX+x];
 				tss-&gt;lastSeen=gs-&gt;frameNum;
 				for(std::map&lt;int,TreeStruct&gt;::iterator ti=tss-&gt;trees.begin();ti!=tss-&gt;trees.end();++ti){
@@ -873,7 +874,7 @@
 	if(s&gt;500)
 		return 0;
 	ft.dir=dir/s;
-	ft.speed=max(0.01f,s*0.0004f);
+	ft.speed=std::max(0.01f,s*0.0004f);
 	ft.type=type;
 	ft.fallPos=0;
 

Modified: trunk/rts/Rendering/Env/AdvTreeGenerator.cpp
===================================================================
--- trunk/rts/Rendering/Env/AdvTreeGenerator.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Rendering/Env/AdvTreeGenerator.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -8,8 +8,10 @@
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Game/Camera.h&quot;
 #include &quot;Rendering/Textures/Bitmap.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;Rendering/ShadowHandler.h&quot;
+#include &quot;TdfParser.h&quot;
 #include &quot;mmgr.h&quot;
 
 using namespace std;
@@ -160,7 +162,7 @@
 
 void CAdvTreeGenerator::DrawTrunk(const float3 &amp;start, const float3 &amp;end,const float3&amp; orto1,const float3&amp; orto2, float size)
 {
-	float3 flatSun=gs-&gt;sunVector;
+	float3 flatSun=mapInfo-&gt;light.sunDir;
 	flatSun.y=0;
 
 	int numIter=(int)max(3.0f,size*10);
@@ -237,7 +239,7 @@
 	float baseRot=fRand(2*PI);
 	int numLeaves=(int)length*10/MAX_TREE_HEIGHT;
 
-	float3 flatSun=gs-&gt;sunVector;
+	float3 flatSun=mapInfo-&gt;light.sunDir;
 	flatSun.y=0;
 
 	for(int a=0;a&lt;numLeaves+1;a++){
@@ -299,8 +301,8 @@
 	glProgramEnvParameter4fARB(GL_VERTEX_PROGRAM_ARB,13, 1,0,0,0);	//camera side
 	glProgramEnvParameter4fARB(GL_VERTEX_PROGRAM_ARB,9, 0,1,0,0);	//camera up
 	glProgramEnvParameter4fARB(GL_VERTEX_PROGRAM_ARB,10,0,0,0,0);	//position delta
-	glProgramEnvParameter4fARB(GL_VERTEX_PROGRAM_ARB,11, readmap-&gt;sunColor.x,readmap-&gt;sunColor.y,readmap-&gt;sunColor.z,0.85f);
-	glProgramEnvParameter4fARB(GL_VERTEX_PROGRAM_ARB,14, readmap-&gt;ambientColor.x,readmap-&gt;ambientColor.y,readmap-&gt;ambientColor.z,0.85f);
+	glProgramEnvParameter4fARB(GL_VERTEX_PROGRAM_ARB,11, mapInfo-&gt;light.groundSunColor.x,mapInfo-&gt;light.groundSunColor.y,mapInfo-&gt;light.groundSunColor.z,0.85f);
+	glProgramEnvParameter4fARB(GL_VERTEX_PROGRAM_ARB,14, mapInfo-&gt;light.groundAmbientColor.x,mapInfo-&gt;light.groundAmbientColor.y,mapInfo-&gt;light.groundAmbientColor.z,0.85f);
 	glProgramEnvParameter4fARB(GL_VERTEX_PROGRAM_ARB,12,0,0,0,0.02f);	//w=alpha/height modifier
 	glAlphaFunc(GL_GREATER,0.5f);
 	glDisable(GL_FOG);
@@ -681,7 +683,7 @@
 {
 	float3 orto1(1,0,0);
 	float3 orto2(0,0,1);
-	float3 flatSun=gs-&gt;sunVector;
+	float3 flatSun=mapInfo-&gt;light.sunDir;
 	flatSun.y=0;
 
 	int numIter=8;
@@ -703,7 +705,7 @@
 
 void CAdvTreeGenerator::DrawPineBranch(const float3 &amp;start, const float3 &amp;dir, float size)
 {
-	float3 flatSun=gs-&gt;sunVector;
+	float3 flatSun=mapInfo-&gt;light.sunDir;
 	flatSun.y=0;
 
 	float3 orto1=dir.cross(UpVector);

Modified: trunk/rts/Rendering/Env/AdvWater.cpp
===================================================================
--- trunk/rts/Rendering/Env/AdvWater.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Rendering/Env/AdvWater.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -16,7 +16,7 @@
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;Sim/Features/FeatureHandler.h&quot;
 #include &quot;Lua/LuaCallInHandler.h&quot;
-
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;mmgr.h&quot;
 
 //////////////////////////////////////////////////////////////////////
@@ -103,7 +103,7 @@
 	if (loadShader)
 		waterFP=LoadFragmentProgram(&quot;water.fp&quot;);
 
-	waterSurfaceColor = readmap-&gt;waterSurfaceColor;
+	waterSurfaceColor = mapInfo-&gt;water.surfaceColor;
 }
 
 CAdvWater::~CAdvWater()
@@ -228,7 +228,7 @@
 
 void CAdvWater::UpdateWater(CGame* game)
 {
-	if (readmap-&gt;minheight &gt; 10 || readmap-&gt;voidWater)
+	if (readmap-&gt;minheight &gt; 10 || mapInfo-&gt;map.voidWater)
 		return;
 
 	glViewport(0,0,128,128);

Modified: trunk/rts/Rendering/Env/BaseSky.cpp
===================================================================
--- trunk/rts/Rendering/Env/BaseSky.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Rendering/Env/BaseSky.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -5,6 +5,7 @@
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;SkyBox.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;mmgr.h&quot;
 
@@ -20,9 +21,8 @@
 
 CBaseSky* CBaseSky::GetSky()
 {
-
-	if(!readmap-&gt;skyBox.empty())
-		return SAFE_NEW CSkyBox(&quot;maps/&quot; + readmap-&gt;skyBox);
+	if(!mapInfo-&gt;atmosphere.skyBox.empty())
+		return SAFE_NEW CSkyBox(&quot;maps/&quot; + mapInfo-&gt;atmosphere.skyBox);
 	else if(GLEW_ARB_fragment_program &amp;&amp; configHandler.GetInt(&quot;AdvSky&quot;,1) &amp;&amp; ProgramStringIsNative(GL_FRAGMENT_PROGRAM_ARB,&quot;clouds.fp&quot;))
 		return SAFE_NEW CAdvSky();
 	else

Modified: trunk/rts/Rendering/Env/BasicSky.cpp
===================================================================
--- trunk/rts/Rendering/Env/BasicSky.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Rendering/Env/BasicSky.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -10,6 +10,7 @@
 
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Game/Camera.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;Rendering/Textures/Bitmap.h&quot;
 #include &quot;TimeProfiler.h&quot;
@@ -40,27 +41,26 @@
 	domeheight=cos(PI/16)*1.01f;
 	domeWidth=sin(2*PI/32)*400*1.7f;
 
-	sundir2=gs-&gt;sunVector;
+	sundir2=mapInfo-&gt;light.sunDir;
 	sundir2.y=0;
 	if(sundir2.Length()==0)
 		sundir2.x=1;
 	sundir2.Normalize();
 	sundir1=sundir2.cross(UpVector);
 
-	modSunDir.y=gs-&gt;sunVector.y;
+	modSunDir.y=mapInfo-&gt;light.sunDir.y;
 	modSunDir.x=0;
-	modSunDir.z=sqrt(gs-&gt;sunVector.x*gs-&gt;sunVector.x+gs-&gt;sunVector.z*gs-&gt;sunVector.z);
+	modSunDir.z=sqrt(mapInfo-&gt;light.sunDir.x*mapInfo-&gt;light.sunDir.x+mapInfo-&gt;light.sunDir.z*mapInfo-&gt;light.sunDir.z);
 
 	sunTexCoordX=0.5f;
 	sunTexCoordY=GetTexCoordFromDir(modSunDir);
 
-	readmap-&gt;mapDefParser.GetDef(cloudDensity,&quot;0.5&quot;,&quot;MAP\\ATMOSPHERE\\CloudDensity&quot;);
-	cloudDensity=0.25f+cloudDensity*0.5f;
-	readmap-&gt;mapDefParser.GetDef(fogStart,&quot;0.1&quot;,&quot;MAP\\ATMOSPHERE\\FogStart&quot;);
+	cloudDensity = 0.25f + mapInfo-&gt;atmosphere.cloudDensity * 0.5f;
+	cloudColor = mapInfo-&gt;atmosphere.cloudColor;
+	skyColor = mapInfo-&gt;atmosphere.skyColor;
+	sunColor = mapInfo-&gt;atmosphere.sunColor;
+	fogStart = mapInfo-&gt;atmosphere.fogStart;
 	if (fogStart&gt;0.99f) gu-&gt;drawFog = false;
-	skyColor=readmap-&gt;mapDefParser.GetFloat3(float3(0.1f,0.15f,0.7f),&quot;MAP\\ATMOSPHERE\\SkyColor&quot;);
-	sunColor=readmap-&gt;mapDefParser.GetFloat3(float3(1,1,1),&quot;MAP\\ATMOSPHERE\\SunColor&quot;);
-	cloudColor=readmap-&gt;mapDefParser.GetFloat3(float3(1,1,1),&quot;MAP\\ATMOSPHERE\\CloudColor&quot;);
 
 	for(int a=0;a&lt;CLOUD_DETAIL;a++)
 		cloudDown[a]=false;

Modified: trunk/rts/Rendering/Env/BasicTreeDrawer.cpp
===================================================================
--- trunk/rts/Rendering/Env/BasicTreeDrawer.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Rendering/Env/BasicTreeDrawer.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -10,6 +10,7 @@
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Rendering/Textures/Bitmap.h&quot;
+#include &quot;TdfParser.h&quot;
 #include &quot;mmgr.h&quot;
 
 //////////////////////////////////////////////////////////////////////

Modified: trunk/rts/Rendering/Env/BasicWater.cpp
===================================================================
--- trunk/rts/Rendering/Env/BasicWater.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Rendering/Env/BasicWater.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -7,6 +7,7 @@
 #include &quot;Rendering/GL/myGL.h&quot;
 
 #include &quot;Rendering/Textures/Bitmap.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;mmgr.h&quot;
 
@@ -18,8 +19,8 @@
 {
 	glGenTextures(1, &amp;texture);
 	CBitmap pic;
-	if (!pic.Load(readmap-&gt;waterTexture))
-		throw content_error(&quot;Could not read water texture from file &quot; + readmap-&gt;waterTexture);
+	if (!pic.Load(mapInfo-&gt;water.texture))
+		throw content_error(&quot;Could not read water texture from file &quot; + mapInfo-&gt;water.texture);
 
 	// create mipmapped texture
 	glBindTexture(GL_TEXTURE_2D, texture);
@@ -64,15 +65,13 @@
 		// Use better repeat setting of 1 repeat per 4096 mapx/mapy for the new
 		// ocean.jpg while retaining backward compatibility with old maps relying
 		// on 1 repeat per 1024 mapx/mapy. (changed 16/05/2007)
-		if (readmap-&gt;waterTexture == &quot;bitmaps/ocean.jpg&quot;) {
+		if (mapInfo-&gt;water.texture == &quot;bitmaps/ocean.jpg&quot;) {
 			repeatX /= 4;
 			repeatY /= 4;
 		}
 
-		readmap-&gt;mapDefParser.GetTDef(repeatX, repeatX, &quot;MAP\\WATER\\WaterRepeatX&quot;);
-		readmap-&gt;mapDefParser.GetTDef(repeatY, repeatY, &quot;MAP\\WATER\\WaterRepeatY&quot;);
-		repeatX /= 16;
-		repeatY /= 16;
+		repeatX = (mapInfo-&gt;water.repeatX != 0 ? mapInfo-&gt;water.repeatX : repeatX) / 16;
+		repeatY = (mapInfo-&gt;water.repeatY != 0 ? mapInfo-&gt;water.repeatY : repeatY) / 16;
 
 		for(int y=0;y&lt;16;y++){
 			for(int x=0;x&lt;16;x++){

Modified: trunk/rts/Rendering/Env/DynWater.cpp
===================================================================
--- trunk/rts/Rendering/Env/DynWater.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Rendering/Env/DynWater.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -5,6 +5,7 @@
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Game/Camera.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Map/BaseGroundDrawer.h&quot;
@@ -115,7 +116,7 @@
 	dwAddSplashFP=LoadFragmentProgram(&quot;dwAddSplash.fp&quot;);
 	dwAddSplashVP=LoadVertexProgram(&quot;dwAddSplash.vp&quot;);
 
-	waterSurfaceColor = readmap-&gt;waterSurfaceColor;
+	waterSurfaceColor = mapInfo-&gt;water.surfaceColor;
 
 	for(int y=0;y&lt;1024;++y){
 		for(int x=0;x&lt;1024;++x){
@@ -314,9 +315,9 @@
 	glProgramEnvParameter4fARB(GL_FRAGMENT_PROGRAM_ARB,6, 0.05f, 1-0.05f, 0, 0);
 	glProgramEnvParameter4fARB(GL_FRAGMENT_PROGRAM_ARB,7, 0.2f, 0, 0, 0);
 	glProgramEnvParameter4fARB(GL_FRAGMENT_PROGRAM_ARB,8, 0.5f, 0.6f, 0.8f, 0);
-	glProgramEnvParameter4fARB(GL_FRAGMENT_PROGRAM_ARB,9, gs-&gt;sunVector.x, gs-&gt;sunVector.y, gs-&gt;sunVector.z, 0);
-	glProgramEnvParameter4fARB(GL_FRAGMENT_PROGRAM_ARB,10, readmap-&gt;sunColor.x, readmap-&gt;sunColor.y, readmap-&gt;sunColor.z, 0);
-	glProgramEnvParameter4fARB(GL_FRAGMENT_PROGRAM_ARB,11, readmap-&gt;ambientColor.x, readmap-&gt;ambientColor.y, readmap-&gt;ambientColor.z, 0);
+	glProgramEnvParameter4fARB(GL_FRAGMENT_PROGRAM_ARB,9, mapInfo-&gt;light.sunDir.x, mapInfo-&gt;light.sunDir.y, mapInfo-&gt;light.sunDir.z, 0);
+	glProgramEnvParameter4fARB(GL_FRAGMENT_PROGRAM_ARB,10, mapInfo-&gt;light.groundSunColor.x, mapInfo-&gt;light.groundSunColor.y, mapInfo-&gt;light.groundSunColor.z, 0);
+	glProgramEnvParameter4fARB(GL_FRAGMENT_PROGRAM_ARB,11, mapInfo-&gt;light.groundAmbientColor.x, mapInfo-&gt;light.groundAmbientColor.y, mapInfo-&gt;light.groundAmbientColor.z, 0);
 	glProgramEnvParameter4fARB(GL_FRAGMENT_PROGRAM_ARB,12, refractRight.x,refractRight.y,refractRight.z,0);
 	glProgramEnvParameter4fARB(GL_FRAGMENT_PROGRAM_ARB,13, refractUp.x,refractUp.y,refractUp.z,0);
 	glProgramEnvParameter4fARB(GL_FRAGMENT_PROGRAM_ARB,14, 0.5f/dx,0.5f/dy,1,1);
@@ -351,7 +352,7 @@
 
 void CDynWater::UpdateWater(CGame* game)
 {
-	if (readmap-&gt;minheight &gt; 10 || readmap-&gt;voidWater)
+	if (readmap-&gt;minheight &gt; 10 || mapInfo-&gt;map.voidWater)
 		return;
 
 	glDisable(GL_DEPTH_TEST);

Modified: trunk/rts/Rendering/Env/GrassDrawer.cpp
===================================================================
--- trunk/rts/Rendering/Env/GrassDrawer.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Rendering/Env/GrassDrawer.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -14,6 +14,7 @@
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &lt;algorithm&gt;
 #include &quot;FileSystem/FileHandler.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;Rendering/ShadowHandler.h&quot;
 //#include &quot;TimeProfiler.h&quot;
@@ -313,9 +314,9 @@
 		glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_COMPARE_MODE_ARB, GL_COMPARE_R_TO_TEXTURE);
 		glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_COMPARE_FUNC_ARB, GL_LEQUAL);
 		glTexParameteri(GL_TEXTURE_2D, GL_DEPTH_TEXTURE_MODE_ARB, GL_ALPHA);
-		glTexParameterf(GL_TEXTURE_2D, GL_TEXTURE_COMPARE_FAIL_VALUE_ARB, 1-readmap-&gt;shadowDensity);
+		glTexParameterf(GL_TEXTURE_2D, GL_TEXTURE_COMPARE_FAIL_VALUE_ARB, 1-mapInfo-&gt;light.groundShadowDensity);
 		
-		float texConstant[]={readmap-&gt;ambientColor.x*1.24f,readmap-&gt;ambientColor.y*1.24f,readmap-&gt;ambientColor.z*1.24f,1};
+		float texConstant[]={mapInfo-&gt;light.groundAmbientColor.x*1.24f,mapInfo-&gt;light.groundAmbientColor.y*1.24f,mapInfo-&gt;light.groundAmbientColor.z*1.24f,1};
 		glTexEnvfv(GL_TEXTURE_ENV,GL_TEXTURE_ENV_COLOR,texConstant); 
 		glTexEnvi(GL_TEXTURE_ENV,GL_SOURCE0_RGB_ARB,GL_PREVIOUS_ARB);
 		glTexEnvi(GL_TEXTURE_ENV,GL_SOURCE1_RGB_ARB,GL_CONSTANT);
@@ -465,7 +466,7 @@
 		float3 up(side.cross(v));
 		glProgramEnvParameter4fARB(GL_VERTEX_PROGRAM_ARB,9,  up.x,up.y,up.z,0);
 		float ang=acos(v.y);
-		int texPart=min(15,(int)max(0,(int)((ang+PI/16-PI/2)/PI*30)));
+		int texPart=std::min(15,(int)std::max(0,(int)((ang+PI/16-PI/2)/PI*30)));
 		glProgramEnvParameter4fARB(GL_VERTEX_PROGRAM_ARB,10, texPart/16.0f,0,0,0.0f);
 		glProgramEnvParameter4fARB(GL_VERTEX_PROGRAM_ARB,11,  -v.x,-v.y,-v.z,0);
 		grass[(*gi).num].va-&gt;DrawArrayTN(GL_QUADS);
@@ -486,7 +487,7 @@
 			float3 up(side.cross(v));
 			glProgramEnvParameter4fARB(GL_VERTEX_PROGRAM_ARB,9,  up.x,up.y,up.z,0);
 			float ang=acos(v.y);
-			int texPart=min(15,int(max(0,int((ang+PI/16-PI/2)/PI*30))));
+			int texPart=std::min(15,int(std::max(0,int((ang+PI/16-PI/2)/PI*30))));
 			glProgramEnvParameter4fARB(GL_VERTEX_PROGRAM_ARB,10, texPart/16.0f,0,0,0.0f);
 			glProgramEnvParameter4fARB(GL_VERTEX_PROGRAM_ARB,11,  -v.x,-v.y,-v.z,0);
 
@@ -738,7 +739,7 @@
 					buf[((y)*1024*sizeMod+x+dx)*4+0]=(unsigned char) (r/a);
 					buf[((y)*1024*sizeMod+x+dx)*4+1]=(unsigned char) (g/a);
 					buf[((y)*1024*sizeMod+x+dx)*4+2]=(unsigned char) (b/a);
-					buf[((y)*1024*sizeMod+x+dx)*4+3]=(unsigned char) (min((float)255,a*16));
+					buf[((y)*1024*sizeMod+x+dx)*4+3]=(unsigned char) (std::min((float)255,a*16));
 				}
 			}
 		}

Modified: trunk/rts/Rendering/Env/SkyBox.cpp
===================================================================
--- trunk/rts/Rendering/Env/SkyBox.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Rendering/Env/SkyBox.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -5,6 +5,7 @@
 #include &quot;Rendering/Textures/Bitmap.h&quot;
 #include &quot;Game/Camera.h&quot;
 #include &quot;GlobalStuff.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;Rendering/UnitModels/UnitDrawer.h&quot;
 #include &quot;mmgr.h&quot;
@@ -19,11 +20,12 @@
 		throw content_error(&quot;Could not load skybox texture from file &quot; + texture);
 	tex = btex.CreateTexture(0);
 
-	readmap-&gt;mapDefParser.GetDef(fogStart,&quot;0.1&quot;,&quot;MAP\\ATMOSPHERE\\FogStart&quot;);
+	cloudDensity = mapInfo-&gt;atmosphere.cloudDensity;
+	cloudColor = mapInfo-&gt;atmosphere.cloudColor;
+	skyColor = mapInfo-&gt;atmosphere.skyColor;
+	sunColor = mapInfo-&gt;atmosphere.sunColor;
+	fogStart = mapInfo-&gt;atmosphere.fogStart;
 	if (fogStart&gt;0.99f) gu-&gt;drawFog = false;
-	skyColor=readmap-&gt;mapDefParser.GetFloat3(float3(0.1f,0.15f,0.7f),&quot;MAP\\ATMOSPHERE\\SkyColor&quot;);
-	sunColor=readmap-&gt;mapDefParser.GetFloat3(float3(1,1,1),&quot;MAP\\ATMOSPHERE\\SunColor&quot;);
-	cloudColor=readmap-&gt;mapDefParser.GetFloat3(float3(1,1,1),&quot;MAP\\ATMOSPHERE\\CloudColor&quot;);
 }
 
 CSkyBox::~CSkyBox(void)

Modified: trunk/rts/Rendering/FartextureHandler.cpp
===================================================================
--- trunk/rts/Rendering/FartextureHandler.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Rendering/FartextureHandler.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -5,6 +5,7 @@
 #include &quot;GlobalStuff.h&quot;
 #include &quot;UnitModels/UnitDrawer.h&quot;
 #include &quot;Rendering/Textures/Bitmap.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;mmgr.h&quot;
 
 CFartextureHandler* fartextureHandler = NULL;
@@ -102,7 +103,7 @@
 	glMaterialfv(GL_FRONT_AND_BACK,GL_DIFFUSE,cols2);
 	glColor3f(1,1,1);
 	glRotatef(10,1,0,0);
-	glLightfv(GL_LIGHT1, GL_POSITION,gs-&gt;sunVector4);
+	glLightfv(GL_LIGHT1, GL_POSITION,mapInfo-&gt;light.sunDir4);
 	glEnable(GL_LIGHT1);
 
 	int baseX=0;
@@ -127,7 +128,7 @@
 			}
 		baseX+=16;
 		glRotatef(45,0,1,0);
-		glLightfv(GL_LIGHT1, GL_POSITION,gs-&gt;sunVector4);
+		glLightfv(GL_LIGHT1, GL_POSITION,mapInfo-&gt;light.sunDir4);
 	}
 
 	glCullFace(GL_BACK);

Modified: trunk/rts/Rendering/GroundDecalHandler.cpp
===================================================================
--- trunk/rts/Rendering/GroundDecalHandler.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Rendering/GroundDecalHandler.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -6,6 +6,7 @@
 #include &quot;GL/VertexArray.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Map/Ground.h&quot;
+#include &quot;Map/ReadMap.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
@@ -13,7 +14,9 @@
 #include &quot;Game/Camera.h&quot;
 #include &quot;Sim/Units/UnitTypes/Building.h&quot;
 #include &quot;Map/BaseGroundDrawer.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;ShadowHandler.h&quot;
+#include &quot;TdfParser.h&quot;
 #include &quot;mmgr.h&quot;
 
 CGroundDecalHandler* groundDecals = 0;
@@ -143,9 +146,9 @@
 		glBindProgramARB(GL_VERTEX_PROGRAM_ARB, decalVP);
 		glEnable(GL_VERTEX_PROGRAM_ARB );
 		glProgramEnvParameter4fARB(GL_VERTEX_PROGRAM_ARB, 10, 1.0f / (gs-&gt;pwr2mapx * SQUARE_SIZE), 1.0f / (gs-&gt;pwr2mapy * SQUARE_SIZE), 0, 1);
-		float3 ac = readmap-&gt;ambientColor * (210.0f / 255.0f);
+		float3 ac = mapInfo-&gt;light.groundAmbientColor * (210.0f / 255.0f);
 		glProgramEnvParameter4fARB(GL_FRAGMENT_PROGRAM_ARB, 10, ac.x, ac.y, ac.z, 1);
-		glProgramEnvParameter4fARB(GL_FRAGMENT_PROGRAM_ARB, 11, 0, 0, 0, readmap-&gt;shadowDensity);
+		glProgramEnvParameter4fARB(GL_FRAGMENT_PROGRAM_ARB, 11, 0, 0, 0, mapInfo-&gt;light.groundShadowDensity);
 		glMatrixMode(GL_MATRIX0_ARB);
 		glLoadMatrixf(shadowHandler-&gt;shadowMatrix.m);
 		glMatrixMode(GL_MODELVIEW);
@@ -463,7 +466,7 @@
 		mp=0;
 	if(mp&gt;=gs-&gt;mapSquares/4)
 		mp=gs-&gt;mapSquares/4-1;
-	if(!readmap-&gt;terrainTypes[readmap-&gt;typemap[mp]].receiveTracks)
+	if(!mapInfo-&gt;terrainTypes[readmap-&gt;typemap[mp]].receiveTracks)
 		return;
 
 	TrackType* type=trackTypes[unit-&gt;unitDef-&gt;trackType];

Modified: trunk/rts/Rendering/InMapDraw.cpp
===================================================================
--- trunk/rts/Rendering/InMapDraw.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Rendering/InMapDraw.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -12,6 +12,7 @@
 #include &quot;Game/UI/MouseHandler.h&quot;
 #include &quot;Map/BaseGroundDrawer.h&quot;
 #include &quot;Map/Ground.h&quot;
+#include &quot;Map/ReadMap.h&quot;
 #include &quot;NetProtocol.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Sound.h&quot;

Modified: trunk/rts/Rendering/ShadowHandler.cpp
===================================================================
--- trunk/rts/Rendering/ShadowHandler.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Rendering/ShadowHandler.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -5,6 +5,8 @@
 #include &quot;Game/Camera.h&quot;
 #include &quot;UnitModels/UnitDrawer.h&quot;
 #include &quot;Map/BaseGroundDrawer.h&quot;
+#include &quot;Map/MapInfo.h&quot;
+#include &quot;Map/ReadMap.h&quot;
 #include &quot;Matrix44f.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
@@ -199,7 +201,7 @@
 	glMatrixMode(GL_MODELVIEW);
 	glLoadIdentity();
 
-	float3 sundir=gs-&gt;sunVector;
+	float3 sundir=mapInfo-&gt;light.sunDir;
 	cross1=(sundir.cross(UpVector)).Normalize();
 	cross2=cross1.cross(sundir);
 	centerPos=camera-&gt;pos;

Modified: trunk/rts/Rendering/UnitModels/UnitDrawer.cpp
===================================================================
--- trunk/rts/Rendering/UnitModels/UnitDrawer.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Rendering/UnitModels/UnitDrawer.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -13,6 +13,7 @@
 #include &quot;Lua/LuaRules.h&quot;
 #include &quot;Map/BaseGroundDrawer.h&quot;
 #include &quot;Map/Ground.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;Rendering/Env/BaseSky.h&quot;
@@ -88,11 +89,11 @@
 
 	whiteTex=white.CreateTexture(false);
 
-	unitAmbientColor=readmap-&gt;mapDefParser.GetFloat3(float3(0.4f,0.4f,0.4f),&quot;MAP\\LIGHT\\UnitAmbientColor&quot;);
-	unitSunColor=readmap-&gt;mapDefParser.GetFloat3(float3(0.7f,0.7f,0.7f),&quot;MAP\\LIGHT\\UnitSunColor&quot;);
+	unitAmbientColor = mapInfo-&gt;light.unitAmbientColor;
+	unitSunColor = mapInfo-&gt;light.unitAmbientColor;
+	unitShadowDensity = mapInfo-&gt;light.unitShadowDensity;
 
-	float3 specularSunColor=readmap-&gt;mapDefParser.GetFloat3(unitSunColor,&quot;MAP\\LIGHT\\SpecularSunColor&quot;);
-	readmap-&gt;mapDefParser.GetDef(unitShadowDensity,&quot;0.8&quot;,&quot;MAP\\LIGHT\\UnitShadowDensity&quot;);
+	float3 specularSunColor = mapInfo-&gt;light.specularSunColor;
 
 	advShading=!!configHandler.GetInt(&quot;AdvUnitShading&quot;, GLEW_ARB_fragment_program ? 1 : 0);
 	if (advShading &amp;&amp; !GLEW_ARB_fragment_program) {
@@ -137,12 +138,12 @@
 		glTexParameteri(GL_TEXTURE_CUBE_MAP_ARB, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE);
 		glTexParameteri(GL_TEXTURE_CUBE_MAP_ARB, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE);
 
-		CreateSpecularFace(GL_TEXTURE_CUBE_MAP_POSITIVE_X_ARB,specTexSize,float3( 1, 1, 1),float3( 0, 0,-2),float3(0,-2, 0),gs-&gt;sunVector,100,specularSunColor);
-		CreateSpecularFace(GL_TEXTURE_CUBE_MAP_NEGATIVE_X_ARB,specTexSize,float3(-1, 1,-1),float3( 0, 0, 2),float3(0,-2, 0),gs-&gt;sunVector,100,specularSunColor);
-		CreateSpecularFace(GL_TEXTURE_CUBE_MAP_POSITIVE_Y_ARB,specTexSize,float3(-1 ,1,-1),float3( 2, 0, 0),float3(0, 0, 2),gs-&gt;sunVector,100,specularSunColor);
-		CreateSpecularFace(GL_TEXTURE_CUBE_MAP_NEGATIVE_Y_ARB,specTexSize,float3(-1,-1, 1),float3( 2, 0, 0),float3(0, 0,-2),gs-&gt;sunVector,100,specularSunColor);
-		CreateSpecularFace(GL_TEXTURE_CUBE_MAP_POSITIVE_Z_ARB,specTexSize,float3(-1, 1, 1),float3( 2, 0, 0),float3(0,-2, 0),gs-&gt;sunVector,100,specularSunColor);
-		CreateSpecularFace(GL_TEXTURE_CUBE_MAP_NEGATIVE_Z_ARB,specTexSize,float3( 1, 1,-1),float3(-2, 0, 0),float3(0,-2, 0),gs-&gt;sunVector,100,specularSunColor);
+		CreateSpecularFace(GL_TEXTURE_CUBE_MAP_POSITIVE_X_ARB,specTexSize,float3( 1, 1, 1),float3( 0, 0,-2),float3(0,-2, 0),mapInfo-&gt;light.sunDir,100,specularSunColor);
+		CreateSpecularFace(GL_TEXTURE_CUBE_MAP_NEGATIVE_X_ARB,specTexSize,float3(-1, 1,-1),float3( 0, 0, 2),float3(0,-2, 0),mapInfo-&gt;light.sunDir,100,specularSunColor);
+		CreateSpecularFace(GL_TEXTURE_CUBE_MAP_POSITIVE_Y_ARB,specTexSize,float3(-1 ,1,-1),float3( 2, 0, 0),float3(0, 0, 2),mapInfo-&gt;light.sunDir,100,specularSunColor);
+		CreateSpecularFace(GL_TEXTURE_CUBE_MAP_NEGATIVE_Y_ARB,specTexSize,float3(-1,-1, 1),float3( 2, 0, 0),float3(0, 0,-2),mapInfo-&gt;light.sunDir,100,specularSunColor);
+		CreateSpecularFace(GL_TEXTURE_CUBE_MAP_POSITIVE_Z_ARB,specTexSize,float3(-1, 1, 1),float3( 2, 0, 0),float3(0,-2, 0),mapInfo-&gt;light.sunDir,100,specularSunColor);
+		CreateSpecularFace(GL_TEXTURE_CUBE_MAP_NEGATIVE_Z_ARB,specTexSize,float3( 1, 1,-1),float3(-2, 0, 0),float3(0,-2, 0),mapInfo-&gt;light.sunDir,100,specularSunColor);
 	}
 }
 
@@ -923,7 +924,7 @@
 		}
 		glEnable(GL_FRAGMENT_PROGRAM_ARB);
 
-		glProgramEnvParameter4fARB(GL_VERTEX_PROGRAM_ARB, 10, gs-&gt;sunVector.x, gs-&gt;sunVector.y, gs-&gt;sunVector.z, 0);
+		glProgramEnvParameter4fARB(GL_VERTEX_PROGRAM_ARB, 10, mapInfo-&gt;light.sunDir.x, mapInfo-&gt;light.sunDir.y, mapInfo-&gt;light.sunDir.z, 0);
 		glProgramEnvParameter4fARB(GL_VERTEX_PROGRAM_ARB, 12, unitAmbientColor.x, unitAmbientColor.y, unitAmbientColor.z, 1);
 		glProgramEnvParameter4fARB(GL_VERTEX_PROGRAM_ARB, 11, unitSunColor.x, unitSunColor.y, unitSunColor.z, 0);
 		glProgramEnvParameter4fARB(GL_VERTEX_PROGRAM_ARB, 13, camera-&gt;pos.x, camera-&gt;pos.y, camera-&gt;pos.z, 0);
@@ -967,7 +968,7 @@
 		glLoadIdentity();
 	} else {
 		glEnable(GL_LIGHTING);
-		glLightfv(GL_LIGHT1, GL_POSITION,gs-&gt;sunVector4);	// Position The Light
+		glLightfv(GL_LIGHT1, GL_POSITION,mapInfo-&gt;light.sunDir4);	// Position The Light
 		glEnable(GL_LIGHT1);								// Enable Light One
 	//	glDisable(GL_CULL_FACE);
 	//	glCullFace(GL_BACK);
@@ -1115,7 +1116,7 @@
 		}
 		glEnable( GL_FRAGMENT_PROGRAM_ARB );
 
-		glProgramEnvParameter4fARB(GL_VERTEX_PROGRAM_ARB,10, gs-&gt;sunVector.x,gs-&gt;sunVector.y,gs-&gt;sunVector.z,0);
+		glProgramEnvParameter4fARB(GL_VERTEX_PROGRAM_ARB,10, mapInfo-&gt;light.sunDir.x,mapInfo-&gt;light.sunDir.y,mapInfo-&gt;light.sunDir.z,0);
 		glProgramEnvParameter4fARB(GL_VERTEX_PROGRAM_ARB,12, unitAmbientColor.x,unitAmbientColor.y,unitAmbientColor.z,1);
 		glProgramEnvParameter4fARB(GL_VERTEX_PROGRAM_ARB,11, unitSunColor.x,unitSunColor.y,unitSunColor.z,0);
 		glProgramEnvParameter4fARB(GL_VERTEX_PROGRAM_ARB,13, camera-&gt;pos.x, camera-&gt;pos.y, camera-&gt;pos.z, 0);
@@ -1166,7 +1167,7 @@
 		glLoadIdentity();
 	} else {
 		glEnable(GL_LIGHTING);
-		glLightfv(GL_LIGHT1, GL_POSITION,gs-&gt;sunVector4);	// Position The Light
+		glLightfv(GL_LIGHT1, GL_POSITION,mapInfo-&gt;light.sunDir4);	// Position The Light
 		glEnable(GL_LIGHT1);								// Enable Light One
 
 		SetupBasicS3OTexture0();

Modified: trunk/rts/Sim/Features/FeatureHandler.cpp
===================================================================
--- trunk/rts/Sim/Features/FeatureHandler.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Sim/Features/FeatureHandler.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -12,6 +12,7 @@
 #include &quot;Lua/LuaParser.h&quot;
 #include &quot;Lua/LuaRules.h&quot;
 #include &quot;Map/Ground.h&quot;
+#include &quot;Map/ReadMap.h&quot;
 #include &quot;myMath.h&quot;
 #include &quot;Rendering/Env/BaseTreeDrawer.h&quot;
 #include &quot;Rendering/Env/BaseWater.h&quot;

Modified: trunk/rts/Sim/Misc/RadarHandler.cpp
===================================================================
--- trunk/rts/Sim/Misc/RadarHandler.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Sim/Misc/RadarHandler.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -3,6 +3,7 @@
 #include &quot;TimeProfiler.h&quot;
 #include &quot;LosHandler.h&quot;
 #include &quot;Rendering/UnitModels/3DOParser.h&quot;
+#include &quot;Map/ReadMap.h&quot;
 #include &quot;mmgr.h&quot;
 
 CR_BIND(CRadarHandler, (false));

Modified: trunk/rts/Sim/Misc/Wind.cpp
===================================================================
--- trunk/rts/Sim/Misc/Wind.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Sim/Misc/Wind.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -1,7 +1,7 @@
 #include &quot;StdAfx.h&quot;
 #include &quot;Wind.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
-#include &quot;Map/ReadMap.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;mmgr.h&quot;
 
 CR_BIND(CWind, );
@@ -46,8 +46,8 @@
 void CWind::LoadWind()
 {
 	// TODO: decouple
-	readmap-&gt;mapDefParser.GetDef(minWind,&quot;5&quot;,&quot;MAP\\ATMOSPHERE\\MinWind&quot;);
-	readmap-&gt;mapDefParser.GetDef(maxWind,&quot;25&quot;,&quot;MAP\\ATMOSPHERE\\MaxWind&quot;);
+	minWind = mapInfo-&gt;atmosphere.minWind;
+	maxWind = mapInfo-&gt;atmosphere.maxWind;
 }
 
 

Modified: trunk/rts/Sim/MoveTypes/AirMoveType.cpp
===================================================================
--- trunk/rts/Sim/MoveTypes/AirMoveType.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Sim/MoveTypes/AirMoveType.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -4,6 +4,7 @@
 #include &quot;Game/Player.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Map/Ground.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;Mobility.h&quot;
 #include &quot;myMath.h&quot;
 #include &quot;Rendering/UnitModels/3DOParser.h&quot;
@@ -966,7 +967,7 @@
 
 
 	speed += engineVector * maxAcc * engine;
-	speed.y += gs-&gt;gravity * myGravity;
+	speed.y += mapInfo-&gt;map.gravity * myGravity;
 	speed *= invDrag;
 
 	float3 wingDir = updir * (1 - wingAngle) - frontdir * wingAngle;

Modified: trunk/rts/Sim/MoveTypes/GroundMoveType.cpp
===================================================================
--- trunk/rts/Sim/MoveTypes/GroundMoveType.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Sim/MoveTypes/GroundMoveType.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -3,6 +3,7 @@
 #include &quot;Map/Ground.h&quot;
 #include &quot;Sim/Misc/QuadField.h&quot;
 #include &quot;Map/ReadMap.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;Sim/Misc/LosHandler.h&quot;
 #include &quot;Game/GameHelper.h&quot;
 #include &quot;myMath.h&quot;
@@ -648,7 +649,7 @@
 	SyncedFloat3&amp; midPos=owner-&gt;midPos;
 
 	if(flying){
-		speed.y+=gs-&gt;gravity;
+		speed.y+=mapInfo-&gt;map.gravity;
 		if(midPos.y &lt; 0)
 			speed*=0.95f;
 
@@ -694,8 +695,8 @@
 		} else {
 			if (onSlope) {
 				float3 dir = ground-&gt;GetNormal(midPos.x, midPos.z);
-				float3 normalForce = dir*dir.dot(UpVector*gs-&gt;gravity);
-				float3 newForce = UpVector*gs-&gt;gravity - normalForce;
+				float3 normalForce = dir*dir.dot(UpVector*mapInfo-&gt;map.gravity);
+				float3 newForce = UpVector*mapInfo-&gt;map.gravity - normalForce;
 				speed+=newForce;
 				speedf = speed.Length();
 				speed *= 1 - (.1*dir.y);
@@ -719,8 +720,8 @@
 		else
 			wh = ground-&gt;GetHeight2(pos.x, pos.z);
 
-		if(wh-pos.y &lt; speed.y + gs-&gt;gravity){
-			speed.y += gs-&gt;gravity;
+		if(wh-pos.y &lt; speed.y + mapInfo-&gt;map.gravity){
+			speed.y += mapInfo-&gt;map.gravity;
 			skidding = true; // flying requires skidding
 			flying = true;
 		} else if(wh-pos.y &gt; speed.y){
@@ -754,7 +755,7 @@
 		//set us upright
 		owner-&gt;cob-&gt;Call(&quot;Falling&quot;); //start/continue parachute animation
 
-		speed.y += gs-&gt;gravity*owner-&gt;fallSpeed;
+		speed.y += mapInfo-&gt;map.gravity*owner-&gt;fallSpeed;
 
 		if(owner-&gt;speed.y &gt; 0) //sometimes the dropped unit gets an upward force, still unsure where its coming from
 			owner-&gt;speed.y = 0;

Modified: trunk/rts/Sim/MoveTypes/MoveInfo.cpp
===================================================================
--- trunk/rts/Sim/MoveTypes/MoveInfo.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Sim/MoveTypes/MoveInfo.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -5,6 +5,7 @@
 #include &quot;Lua/LuaParser.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Map/ReadMap.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;MoveMath/MoveMath.h&quot;
 #include &lt;boost/lexical_cast.hpp&gt;
 #include &quot;creg/STL_Deque.h&quot;
@@ -113,10 +114,10 @@
 	}
 
 	for (int a = 0; a &lt; 256; ++a) {
-		terrainType2MoveFamilySpeed[a][0] = readmap-&gt;terrainTypes[a].tankSpeed;
-		terrainType2MoveFamilySpeed[a][1] = readmap-&gt;terrainTypes[a].kbotSpeed;
-		terrainType2MoveFamilySpeed[a][2] = readmap-&gt;terrainTypes[a].hoverSpeed;
-		terrainType2MoveFamilySpeed[a][3] = readmap-&gt;terrainTypes[a].shipSpeed;
+		terrainType2MoveFamilySpeed[a][0] = mapInfo-&gt;terrainTypes[a].tankSpeed;
+		terrainType2MoveFamilySpeed[a][1] = mapInfo-&gt;terrainTypes[a].kbotSpeed;
+		terrainType2MoveFamilySpeed[a][2] = mapInfo-&gt;terrainTypes[a].hoverSpeed;
+		terrainType2MoveFamilySpeed[a][3] = mapInfo-&gt;terrainTypes[a].shipSpeed;
 	}
 }
 

Modified: trunk/rts/Sim/MoveTypes/MoveMath/HoverMoveMath.cpp
===================================================================
--- trunk/rts/Sim/MoveTypes/MoveMath/HoverMoveMath.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Sim/MoveTypes/MoveMath/HoverMoveMath.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -35,7 +35,7 @@
 	if(slope*moveSlope &gt; moveData.maxSlope)
 		return 0.0f;
 	//Slope-mod
-	return 1 / (1 + max(0.0f,slope*moveSlope) * moveData.slopeMod);
+	return 1 / (1 + std::max(0.0f,slope*moveSlope) * moveData.slopeMod);
 }
 
 /*

Modified: trunk/rts/Sim/MoveTypes/ScriptMoveType.cpp
===================================================================
--- trunk/rts/Sim/MoveTypes/ScriptMoveType.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Sim/MoveTypes/ScriptMoveType.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -3,6 +3,7 @@
 #include &quot;ScriptMoveType.h&quot;
 #include &quot;Lua/LuaRules.h&quot;
 #include &quot;Map/Ground.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;Rendering/GroundDecalHandler.h&quot;
 #include &quot;Sim/Misc/Wind.h&quot;
 #include &quot;Sim/Misc/AirBaseHandler.h&quot;
@@ -195,7 +196,7 @@
 			                    (owner-&gt;rightdir * -relVel.x); // x is left
 			owner-&gt;speed += rVel;
 		}
-		vel.y        += gs-&gt;gravity * gravityFactor;
+		vel.y        += mapInfo-&gt;map.gravity * gravityFactor;
 		owner-&gt;speed += (wind.GetCurrentWind() * windFactor);
 		owner-&gt;pos   += owner-&gt;speed;
 	}

Modified: trunk/rts/Sim/Path/PathManager.cpp
===================================================================
--- trunk/rts/Sim/Path/PathManager.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Sim/Path/PathManager.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -11,6 +11,7 @@
 #include &quot;PathFinder.h&quot;
 #include &quot;PathEstimator.h&quot;
 #include &quot;SDL_timer.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;mmgr.h&quot;
 
 const float ESTIMATE_DISTANCE = 55;
@@ -34,7 +35,7 @@
 	hover = SAFE_NEW CHoverMoveMath();
 	sea = SAFE_NEW CShipMoveMath();
 
-	float waterDamage=atof(readmap-&gt;mapDefParser.SGetValueDef(&quot;0&quot;,&quot;MAP\\WATER\\WaterDamage&quot;).c_str());
+	float waterDamage = mapInfo-&gt;water.damage;
 	if(waterDamage&gt;=1000)
 		CGroundMoveMath::waterCost=0;
 	else

Modified: trunk/rts/Sim/Projectiles/FlareProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/FlareProjectile.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Sim/Projectiles/FlareProjectile.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -2,6 +2,7 @@
 #include &quot;FlareProjectile.h&quot;
 #include &quot;Game/Camera.h&quot;
 #include &quot;LogOutput.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;ProjectileHandler.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
@@ -57,7 +58,7 @@
 	if(gs-&gt;frameNum&gt;=activateFrame){
 		pos+=speed;
 		speed*=0.95f;
-		speed.y+=gs-&gt;gravity*0.3f;
+		speed.y+=mapInfo-&gt;map.gravity*0.3f;
 
 		if(owner &amp;&amp; lastSub&lt;gs-&gt;frameNum-owner-&gt;unitDef-&gt;flareSalvoDelay &amp;&amp; numSub&lt;owner-&gt;unitDef-&gt;flareSalvoSize){
 			subPos.push_back(owner-&gt;pos);
@@ -80,7 +81,7 @@
 		for(int a=0;a&lt;numSub;++a){
 			subPos[a]+=subSpeed[a];
 			subSpeed[a]*=0.95f;
-			subSpeed[a].y+=gs-&gt;gravity*0.3f;
+			subSpeed[a].y+=mapInfo-&gt;map.gravity*0.3f;
 		}
 	}
 

Modified: trunk/rts/Sim/Projectiles/PieceProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/PieceProjectile.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Sim/Projectiles/PieceProjectile.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -4,6 +4,7 @@
 #include &quot;GlobalStuff.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Map/Ground.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;Matrix44f.h&quot;
 #include &quot;myMath.h&quot;
 #include &quot;PieceProjectile.h&quot;
@@ -263,7 +264,7 @@
 void CPieceProjectile::Update()
 {
 	if (flags &amp; PP_Fall) {
-		speed.y += gs-&gt;gravity;
+		speed.y += mapInfo-&gt;map.gravity;
 	}
 
 	speed *= 0.997f;

Modified: trunk/rts/Sim/Projectiles/Projectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/Projectile.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Sim/Projectiles/Projectile.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -11,6 +11,7 @@
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Rendering/UnitModels/3DModelParser.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;mmgr.h&quot;
 
 CR_BIND_DERIVED(CProjectile, CExpGenSpawnable, );
@@ -77,7 +78,7 @@
 
 void CProjectile::Update()
 {
-	speed.y+=gs-&gt;gravity;
+	speed.y+=mapInfo-&gt;map.gravity;
 
 	pos+=speed;
 }

Modified: trunk/rts/Sim/Projectiles/ProjectileHandler.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/ProjectileHandler.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Sim/Projectiles/ProjectileHandler.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -16,6 +16,7 @@
 #include &quot;Rendering/GroundFlash.h&quot;
 #include &quot;Sim/Misc/LosHandler.h&quot;
 #include &quot;Map/Ground.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;Rendering/Textures/TextureHandler.h&quot;
 #include &quot;Sim/Features/Feature.h&quot;
 #include &quot;Sim/Features/FeatureDef.h&quot;
@@ -30,6 +31,7 @@
 #include &lt;algorithm&gt;
 #include &quot;Rendering/GL/IFramebuffer.h&quot;
 #include &quot;System/FileSystem/FileHandler.h&quot;
+#include &quot;TdfParser.h&quot;
 #include &quot;mmgr.h&quot;
 #include &quot;creg/STL_List.h&quot;
 
@@ -356,7 +358,7 @@
 		for(std::list&lt;FlyingPiece*&gt;::iterator pi=fpl-&gt;begin();pi!=fpl-&gt;end();){
 			(*pi)-&gt;pos+=(*pi)-&gt;speed;
 			(*pi)-&gt;speed*=0.996f;
-			(*pi)-&gt;speed.y+=gs-&gt;gravity;
+			(*pi)-&gt;speed.y+=mapInfo-&gt;map.gravity;
 			(*pi)-&gt;rot+=(*pi)-&gt;rotSpeed;
 			if((*pi)-&gt;pos.y&lt;ground-&gt;GetApproximateHeight((*pi)-&gt;pos.x,(*pi)-&gt;pos.z)-10){
 				delete *pi;

Modified: trunk/rts/Sim/Projectiles/Unsynced/DirtProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/Unsynced/DirtProjectile.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Sim/Projectiles/Unsynced/DirtProjectile.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -6,6 +6,7 @@
 #include &quot;DirtProjectile.h&quot;
 #include &quot;Game/Camera.h&quot;
 #include &quot;Map/Ground.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;mmgr.h&quot;
@@ -61,7 +62,7 @@
 void CDirtProjectile::Update()
 {
 	speed*=slowdown;
-	speed.y+=gs-&gt;gravity;
+	speed.y+=mapInfo-&gt;map.gravity;
 	pos+=speed;
 	alpha-=alphaFalloff;
 	size+=sizeExpansion;

Modified: trunk/rts/Sim/Projectiles/Unsynced/SmokeProjectile2.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/Unsynced/SmokeProjectile2.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Sim/Projectiles/Unsynced/SmokeProjectile2.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -104,18 +104,18 @@
 void CSmokeProjectile2::Draw()
 {
 	inArray=true;
-	float interAge=min(1.0f,age+ageSpeed*gu-&gt;timeOffset);
+	float interAge=std::min(1.0f,age+ageSpeed*gu-&gt;timeOffset);
 	unsigned char col[4];
 	unsigned char alpha;
 	if(interAge&lt;0.05f)
 		alpha=(unsigned char)(interAge*19*127);
 	else
 		alpha=(unsigned char)((1-interAge)*127);
-	float rglow=max(0.f,(1-interAge*glowFalloff)*127);
-	float gglow=max(0.f,(1-interAge*glowFalloff*2.5f)*127);
+	float rglow=std::max(0.f,(1-interAge*glowFalloff)*127);
+	float gglow=std::max(0.f,(1-interAge*glowFalloff*2.5f)*127);
 	col[0]=(unsigned char)(color*alpha+rglow);
 	col[1]=(unsigned char)(color*alpha+gglow);
-	col[2]=(unsigned char)max(0.f,color*alpha-gglow*0.5f);
+	col[2]=(unsigned char)std::max(0.f,color*alpha-gglow*0.5f);
 	col[3]=alpha/*-alphaFalloff*gu-&gt;timeOffset*/;
 	//int frame=textureNum;
 	//float xmod=0.125f+(float(int(frame%6)))/16.0f;

Modified: trunk/rts/Sim/Projectiles/Unsynced/SmokeTrailProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/Unsynced/SmokeTrailProjectile.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Sim/Projectiles/Unsynced/SmokeTrailProjectile.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -111,7 +111,7 @@
 		if(lastSegment)
 			a1=0;
 		a1*=0.7f+fabs(dif.dot(dir1));
-		float alpha=min(255.f,max(0.f,a1));
+		float alpha=std::min(255.f,std::max(0.f,a1));
 		col[0]=(unsigned char) (color*alpha);
 		col[1]=(unsigned char) (color*alpha);
 		col[2]=(unsigned char) (color*alpha);
@@ -122,7 +122,7 @@
 		if(firstSegment)
 			a2=0;
 		a2*=0.7f+fabs(dif2.dot(dir2));
-		alpha=min(255.f,max(0.f,a2));
+		alpha=std::min(255.f,std::max(0.f,a2));
 		col2[0]=(unsigned char) (color*alpha);
 		col2[1]=(unsigned char) (color*alpha);
 		col2[2]=(unsigned char) (color*alpha);
@@ -141,7 +141,7 @@
 			unsigned char col3[4];
 			float a2=(1-float(age+4)/(lifeTime))*255;
 			a2*=0.7f+fabs(dif3.dot(middir));
-			alpha=min(255.f,max(0.f,a2));
+			alpha=std::min(255.f,std::max(0.f,a2));
 			col3[0]=(unsigned char) (color*alpha);
 			col3[1]=(unsigned char) (color*alpha);
 			col3[2]=(unsigned char) (color*alpha);
@@ -168,7 +168,7 @@
 		unsigned char col[4];
 		for(int a=0;a&lt;8;++a){
 			float a1=1-float(age+a)/lifeTime;
-			float alpha=min(255.f,max(0.f,a1*255));
+			float alpha=std::min(255.f,std::max(0.f,a1*255));
 			col[0]=(unsigned char) (color*alpha);
 			col[1]=(unsigned char) (color*alpha);
 			col[2]=(unsigned char) (color*alpha);

Modified: trunk/rts/Sim/Projectiles/Unsynced/WreckProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/Unsynced/WreckProjectile.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Sim/Projectiles/Unsynced/WreckProjectile.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -5,6 +5,7 @@
 #include &quot;StdAfx.h&quot;
 #include &quot;Game/Camera.h&quot;
 #include &quot;Map/Ground.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
@@ -36,7 +37,7 @@
 
 void CWreckProjectile::Update()
 {
-	speed.y+=gs-&gt;gravity;
+	speed.y+=mapInfo-&gt;map.gravity;
 	speed.x*=0.994f;
 	speed.z*=0.994f;
 	if(speed.y&gt;0)

Modified: trunk/rts/Sim/Projectiles/WeaponProjectiles/ExplosiveProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/WeaponProjectiles/ExplosiveProjectile.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Sim/Projectiles/WeaponProjectiles/ExplosiveProjectile.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -93,7 +93,7 @@
 		float h=ground-&gt;GetHeight2(pos.x,pos.z);
 		if(h&gt;pos.y){
 			float3 n=ground-&gt;GetNormal(pos.x,pos.z);
-			pos-=speed*max(0.0f,min(1.0f,float((h-pos.y)*n.y/n.dot(speed)+0.1f)));
+			pos-=speed*std::max(0.0f,std::min(1.0f,float((h-pos.y)*n.y/n.dot(speed)+0.1f)));
 		}
 		else if (weaponDef-&gt;waterweapon) {
 			return; //let waterweapons go underwater

Modified: trunk/rts/Sim/Projectiles/WeaponProjectiles/FireBallProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/WeaponProjectiles/FireBallProjectile.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Sim/Projectiles/WeaponProjectiles/FireBallProjectile.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -3,6 +3,7 @@
 #include &quot;FireBallProjectile.h&quot;
 #include &quot;Game/Camera.h&quot;
 #include &quot;Map/Ground.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
@@ -87,7 +88,7 @@
 		pos += speed;
 
 		if (weaponDef-&gt;gravityAffected)
-			speed.y += gs-&gt;gravity;
+			speed.y += mapInfo-&gt;map.gravity;
 
 		// g&#65533;ra om till ttl sedan kanske
 		if (weaponDef-&gt;noExplode) {

Modified: trunk/rts/Sim/Projectiles/WeaponProjectiles/MissileProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/WeaponProjectiles/MissileProjectile.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Sim/Projectiles/WeaponProjectiles/MissileProjectile.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -3,6 +3,7 @@
 #include &quot;Game/GameHelper.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Map/Ground.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;Matrix44f.h&quot;
 #include &quot;MissileProjectile.h&quot;
 #include &quot;myMath.h&quot;
@@ -277,7 +278,7 @@
 		// only when TTL &lt;= 0 do projectiles
 		// get influenced by gravity and drag
 		speed *= 0.995f;
-		speed.y += gs-&gt;gravity;
+		speed.y += mapInfo-&gt;map.gravity;
 		dir = speed;
 		dir.Normalize();
 	}

Modified: trunk/rts/Sim/Projectiles/WeaponProjectiles/StarburstProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/WeaponProjectiles/StarburstProjectile.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Sim/Projectiles/WeaponProjectiles/StarburstProjectile.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -3,6 +3,7 @@
 #include &quot;Game/GameHelper.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Map/Ground.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;Matrix44f.h&quot;
 #include &quot;myMath.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
@@ -206,9 +207,9 @@
 		if (distanceToTravel != MAX_WORLD_SIZE)
 			distanceToTravel -= speed.Length2D();
 	} else {
-		dir.y += gs-&gt;gravity;
+		dir.y += mapInfo-&gt;map.gravity;
 		dir.Normalize();
-		curSpeed += -gs-&gt;gravity;
+		curSpeed += -mapInfo-&gt;map.gravity;
 		speed = dir * curSpeed;
 	}
 

Modified: trunk/rts/Sim/Projectiles/WeaponProjectiles/TorpedoProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/WeaponProjectiles/TorpedoProjectile.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Sim/Projectiles/WeaponProjectiles/TorpedoProjectile.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -2,6 +2,7 @@
 #include &quot;Game/Camera.h&quot;
 #include &quot;Game/GameHelper.h&quot;
 #include &quot;Map/Ground.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;myMath.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
@@ -89,7 +90,7 @@
 {
 	if (!(weaponDef-&gt;submissile) &amp;&amp; pos.y &gt; -3) {
 		// tracking etc only works when we are underwater
-		speed.y += gs-&gt;gravity;
+		speed.y += mapInfo-&gt;map.gravity;
 		if (dir.y &gt; 0)
 			dir.y = 0;
 		dir = speed;
@@ -137,7 +138,7 @@
 			}
 		} else {
 			speed *= 0.98f;
-			speed.y += gs-&gt;gravity;
+			speed.y += mapInfo-&gt;map.gravity;
 			dir = speed;
 			dir.Normalize();
 		}

Modified: trunk/rts/Sim/Projectiles/WeaponProjectiles/WeaponProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/WeaponProjectiles/WeaponProjectile.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Sim/Projectiles/WeaponProjectiles/WeaponProjectile.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -231,7 +231,7 @@
 	//pos+=speed;
 
 	//if(weaponDef-&gt;gravityAffected)
-	//	speed.y+=gs-&gt;gravity;
+	//	speed.y+=mapInfo-&gt;map.gravity;
 
 
 	//if(weaponDef-&gt;noExplode)

Modified: trunk/rts/Sim/Units/Unit.cpp
===================================================================
--- trunk/rts/Sim/Units/Unit.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Sim/Units/Unit.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -21,6 +21,7 @@
 #include &quot;Lua/LuaRules.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Map/MetalMap.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;Map/ReadMap.h&quot;
 
 #include &quot;Rendering/GroundDecalHandler.h&quot;
@@ -1905,7 +1906,7 @@
 	if (lastLOD == 0) { return 0; }
 
 	// FIXME: fix it, cap it for shallow shadows?
-	const float3&amp; sun = gs-&gt;sunVector;
+	const float3&amp; sun = mapInfo-&gt;light.sunDir;
 	const float3 diff = (camera-&gt;pos - pos);
 	const float  dot  = diff.dot(sun);
 	const float3 gap  = diff - (sun * dot);

Modified: trunk/rts/Sim/Units/UnitDefHandler.cpp
===================================================================
--- trunk/rts/Sim/Units/UnitDefHandler.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Sim/Units/UnitDefHandler.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -14,6 +14,7 @@
 #include &quot;Game/GameSetup.h&quot;
 #include &quot;Game/Team.h&quot;
 #include &quot;Lua/LuaParser.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;Rendering/GroundDecalHandler.h&quot;
@@ -575,7 +576,7 @@
 	ud.extractRange = 0;
 
 	if (ud.extractsMetal) {
-		ud.extractRange = readmap-&gt;extractorRadius;
+		ud.extractRange = mapInfo-&gt;map.extractorRadius;
 		ud.type = &quot;MetalExtractor&quot;;
 	}
 	else if (ud.transportCapacity) {

Modified: trunk/rts/Sim/Units/UnitHandler.cpp
===================================================================
--- trunk/rts/Sim/Units/UnitHandler.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Sim/Units/UnitHandler.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -10,6 +10,7 @@
 #include &quot;TimeProfiler.h&quot;
 #include &quot;myMath.h&quot;
 #include &quot;Map/Ground.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;Rendering/FartextureHandler.h&quot;
@@ -133,7 +134,7 @@
 
 	slowUpdateIterator = activeUnits.end();
 
-	waterDamage=atof(readmap-&gt;mapDefParser.SGetValueDef(&quot;0&quot;,&quot;MAP\\WATER\\WaterDamage&quot;).c_str())*(16.0f/30.0f);
+	waterDamage = mapInfo-&gt;water.damage;
 
 	if (gameSetup) {
 		maxUnits = gameSetup-&gt;maxUnits;

Modified: trunk/rts/Sim/Units/UnitLoader.cpp
===================================================================
--- trunk/rts/Sim/Units/UnitLoader.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Sim/Units/UnitLoader.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -22,6 +22,8 @@
 #include &quot;Game/GameHelper.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Map/MapDamage.h&quot;
+#include &quot;Map/MapInfo.h&quot;
+#include &quot;Map/ReadMap.h&quot;
 #include &quot;Platform/errorhandler.h&quot;
 #include &quot;Rendering/UnitModels/3DModelParser.h&quot;
 #include &quot;Sim/Misc/CollisionVolume.h&quot;
@@ -298,7 +300,7 @@
 	unit-&gt;energyTickMake = ud-&gt;energyMake;
 
 	if (ud-&gt;tidalGenerator &gt; 0)
-		unit-&gt;energyTickMake += ud-&gt;tidalGenerator * readmap-&gt;tidalStrength;
+		unit-&gt;energyTickMake += ud-&gt;tidalGenerator * mapInfo-&gt;map.tidalStrength;
 
 
 	unit-&gt;model = ud-&gt;LoadModel(team);

Modified: trunk/rts/Sim/Units/UnitTypes/Builder.cpp
===================================================================
--- trunk/rts/Sim/Units/UnitTypes/Builder.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Sim/Units/UnitTypes/Builder.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -14,6 +14,7 @@
 #include &quot;Lua/LuaRules.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Map/MapDamage.h&quot;
+#include &quot;Map/ReadMap.h&quot;
 #include &quot;myMath.h&quot;
 #include &quot;Rendering/UnitModels/3DOParser.h&quot;
 #include &quot;Sim/Features/Feature.h&quot;

Modified: trunk/rts/Sim/Weapons/Cannon.cpp
===================================================================
--- trunk/rts/Sim/Weapons/Cannon.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Sim/Weapons/Cannon.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -7,6 +7,7 @@
 #include &quot;Game/GameHelper.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Map/Ground.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;myMath.h&quot;
 #include &quot;Rendering/Env/BaseWater.h&quot;
 #include &quot;Sim/Projectiles/Unsynced/HeatCloudProjectile.h&quot;
@@ -47,7 +48,7 @@
 
 void CCannon::Init(void)
 {
-	gravity = weaponDef-&gt;myGravity==0 ? gs-&gt;gravity : -(weaponDef-&gt;myGravity);
+	gravity = weaponDef-&gt;myGravity==0 ? mapInfo-&gt;map.gravity : -(weaponDef-&gt;myGravity);
 	highTrajectory = weaponDef-&gt;highTrajectory == 1;
 	if(highTrajectory){
 		maxPredict=projectileSpeed*2/-gravity;

Modified: trunk/rts/Sim/Weapons/bombdropper.cpp
===================================================================
--- trunk/rts/Sim/Weapons/bombdropper.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/Sim/Weapons/bombdropper.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -7,6 +7,7 @@
 #include &quot;Game/GameHelper.h&quot;
 #include &quot;Game/Team.h&quot;
 #include &quot;LogOutput.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;Sim/MoveTypes/TAAirMoveType.h&quot;
 #include &quot;Sim/Projectiles/WeaponProjectiles/ExplosiveProjectile.h&quot;
 #include &quot;Sim/Projectiles/WeaponProjectiles/TorpedoProjectile.h&quot;
@@ -56,9 +57,9 @@
 		if(weaponPos.y&gt;targetPos.y){
 			float d=targetPos.y-weaponPos.y;
 			float s=-owner-&gt;speed.y;
-			float sq=(s-2*d)/-(weaponDef-&gt;myGravity==0 ? gs-&gt;gravity : -(weaponDef-&gt;myGravity));
+			float sq=(s-2*d)/-(weaponDef-&gt;myGravity==0 ? mapInfo-&gt;map.gravity : -(weaponDef-&gt;myGravity));
 			if(sq&gt;0)
-				predict=s/(weaponDef-&gt;myGravity==0 ? gs-&gt;gravity : -(weaponDef-&gt;myGravity))+sqrt(sq);
+				predict=s/(weaponDef-&gt;myGravity==0 ? mapInfo-&gt;map.gravity : -(weaponDef-&gt;myGravity))+sqrt(sq);
 			else
 				predict=0;
 			float3 hitpos=owner-&gt;pos+owner-&gt;speed*predict;
@@ -125,7 +126,7 @@
 		}
 		SAFE_NEW CExplosiveProjectile(weaponPos, owner-&gt;speed + dif, owner,
 				weaponDef, 1000, areaOfEffect,
-				weaponDef-&gt;myGravity==0 ? gs-&gt;gravity : -(weaponDef-&gt;myGravity));
+				weaponDef-&gt;myGravity==0 ? mapInfo-&gt;map.gravity : -(weaponDef-&gt;myGravity));
 	}
 	//CWeaponProjectile::CreateWeaponProjectile(owner-&gt;pos,owner-&gt;speed,owner, NULL, float3(0,0,0), damages, weaponDef);
 	if(fireSoundId &amp;&amp; (!weaponDef-&gt;soundTrigger || salvoLeft==salvoSize-1))

Modified: trunk/rts/System/GlobalStuff.cpp
===================================================================
--- trunk/rts/System/GlobalStuff.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/System/GlobalStuff.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -109,12 +109,6 @@
 	gaiaAllyTeamID=-1;
 	useLuaRules=true;
 	
-	sunVector=float3(0,0,1);
-	sunVector4[0]=0;
-	sunVector4[1]=0;
-	sunVector4[2]=1;
-	sunVector4[3]=0;
-
 	for(int a=0; a &lt; MAX_TEAMS; ++a){
 		teams[a]=SAFE_NEW CTeam();
 		teams[a]-&gt;teamNum=a;
@@ -135,10 +129,6 @@
 	activeTeams=2;
 	activeAllyTeams=2;
 	activePlayers=MAX_PLAYERS;
-
-	sunVector=float3(0,1,2).Normalize();
-
-	gravity = -0.1f;
 }
 
 /**

Modified: trunk/rts/System/GlobalStuff.h
===================================================================
--- trunk/rts/System/GlobalStuff.h	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/System/GlobalStuff.h	2008-04-24 12:13:55 UTC (rev 5772)
@@ -303,15 +303,6 @@
 	int gameMode;
 
 	/**
-	 * @brief gravity
-	 *
-	 * Stores the gravity as a negative number
-	 * and in units/frame^2
-	 * (NOT positive units/second^2 as in the mapfile)
-	 */
-	float gravity;
-
-	/**
 	 * @brief players
 	 *
 	 * Array of CPlayer pointers, for all the
@@ -343,20 +334,6 @@
 	int activePlayers;
 
 	/**
-	 * @brief sun vector
-	 *
-	 * Holds vector for the direction of the sun
-	 */
-	float3 sunVector;
-
-	/**
-	 * @brief sun vector4
-	 *
-	 * Holds vector for the sun as 4 components
-	 */
-	float sunVector4[4];
-
-	/**
 	 * @brief Player
 	 * @param name name of the player
 	 * @return his playernumber of -1 if not found

Modified: trunk/rts/System/Script/LuaFunctions.cpp
===================================================================
--- trunk/rts/System/Script/LuaFunctions.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/System/Script/LuaFunctions.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -15,7 +15,7 @@
 #include &quot;Game/StartScripts/Script.h&quot;
 #include &quot;Game/UI/EndGameBox.h&quot;
 #include &quot;Lua/LuaCallInHandler.h&quot;
-#include &quot;Map/ReadMap.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;Sim/Features/FeatureDef.h&quot;
 #include &quot;Sim/Features/Feature.h&quot;
 #include &quot;Sim/Features/FeatureHandler.h&quot;
@@ -179,6 +179,6 @@
 
 	string MapGetTDFName()
 	{
-		return CReadMap::GetTDFName(stupidGlobalMapname);
+		return CMapInfo::GetTDFName(stupidGlobalMapname);
 	}
 }

Modified: trunk/rts/System/TdfParser.cpp
===================================================================
--- trunk/rts/System/TdfParser.cpp	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/System/TdfParser.cpp	2008-04-24 12:13:55 UTC (rev 5772)
@@ -191,20 +191,6 @@
   LoadFile(filename);
 }
 
-//find value, display messagebox if no such value found
-std::string TdfParser::SGetValueMSG(std::string const&amp; location) const
-{
-	std::string lowerd = StringToLower(location);
-	std::string value;
-	bool found = SGetValue(value, lowerd);
-	if(!found)
-	{
-		std::string error = &quot;TDF parsing error: &quot;;
-		error += value;
-		throw content_error(error);
-	}
-	return value;
-}
 
 //find value, return default value if no such value found
 std::string TdfParser::SGetValueDef(std::string const&amp; defaultvalue, std::string const&amp; location) const

Modified: trunk/rts/System/TdfParser.h
===================================================================
--- trunk/rts/System/TdfParser.h	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/System/TdfParser.h	2008-04-24 12:13:55 UTC (rev 5772)
@@ -51,20 +51,6 @@
 
 
 	/**
-		*  @param value pointer to string to store the value in.
-		*  @param ... location of value, terminate with NULL.
-		*  @return true on success.
-
-	bool GetValue(std::string &amp;value, ...);*/
-
-	/**
-		*  Retreive a specific value from the file and returns it, gives an error messagebox if value not found.
-		*  @param location location of value in the form &quot;section\\section\\ ... \\name&quot;.
-		*  @return returns the value on success, undefined on failure.
-		*/
-	std::string SGetValueMSG(std::string const&amp; location) const;
-
-	/**
 		*  Retreive a specific value from the file and returns it, returns the specified default value if not found.
 		*  @param defaultvalue
 		*  @param location location of value.
@@ -126,18 +112,6 @@
 		}
 	}
 
-	//template funktion f&#246;r att h&#228;ta ett v&#228;rde, ger errormessagebox om v&#228;rdet inte fins
-	template&lt;typename T&gt;
-	void GetMsg(T&amp; value, const std::string&amp; key) const
-	{
-		std::string str;
-		str = SGetValueMSG(key);
-
-		std::stringstream stream;
-		stream &lt;&lt; str;
-		stream &gt;&gt; value;
-	}
-
 	//template funktion f&#246;r att h&#228;ta ett v&#228;rde, tar defaultv&#228;rde om v&#228;rdet inte fins
 	template&lt;typename T&gt;
 	void GetDef(T&amp; value, const std::string&amp; defvalue, const std::string&amp; key) const

Modified: trunk/rts/build/vstudio8/rts.vcproj
===================================================================
--- trunk/rts/build/vstudio8/rts.vcproj	2008-04-24 10:40:30 UTC (rev 5771)
+++ trunk/rts/build/vstudio8/rts.vcproj	2008-04-24 12:13:55 UTC (rev 5772)
@@ -5672,6 +5672,46 @@
 				&gt;
 			&lt;/File&gt;
 			&lt;File
+				RelativePath=&quot;..\..\Map\HeightLinePalette.cpp&quot;
+				&gt;
+				&lt;FileConfiguration
+					Name=&quot;Debug|Win32&quot;
+					&gt;
+					&lt;Tool
+						Name=&quot;VCCLCompilerTool&quot;
+						UsePrecompiledHeader=&quot;0&quot;
+					/&gt;
+				&lt;/FileConfiguration&gt;
+				&lt;FileConfiguration
+					Name=&quot;No debug|Win32&quot;
+					&gt;
+					&lt;Tool
+						Name=&quot;VCCLCompilerTool&quot;
+						UsePrecompiledHeader=&quot;0&quot;
+					/&gt;
+				&lt;/FileConfiguration&gt;
+				&lt;FileConfiguration
+					Name=&quot;Release with error catching|Win32&quot;
+					&gt;
+					&lt;Tool
+						Name=&quot;VCCLCompilerTool&quot;
+						UsePrecompiledHeader=&quot;0&quot;
+					/&gt;
+				&lt;/FileConfiguration&gt;
+				&lt;FileConfiguration
+					Name=&quot;Syncdebug|Win32&quot;
+					&gt;
+					&lt;Tool
+						Name=&quot;VCCLCompilerTool&quot;
+						UsePrecompiledHeader=&quot;0&quot;
+					/&gt;
+				&lt;/FileConfiguration&gt;
+			&lt;/File&gt;
+			&lt;File
+				RelativePath=&quot;..\..\Map\HeightLinePalette.h&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
 				RelativePath=&quot;..\..\Map\HeightMapTexture.cpp&quot;
 				&gt;
 			&lt;/File&gt;
@@ -5688,6 +5728,46 @@
 				&gt;
 			&lt;/File&gt;
 			&lt;File
+				RelativePath=&quot;..\..\Map\MapInfo.cpp&quot;
+				&gt;
+				&lt;FileConfiguration
+					Name=&quot;Debug|Win32&quot;
+					&gt;
+					&lt;Tool
+						Name=&quot;VCCLCompilerTool&quot;
+						UsePrecompiledHeader=&quot;0&quot;
+					/&gt;
+				&lt;/FileConfiguration&gt;
+				&lt;FileConfiguration
+					Name=&quot;No debug|Win32&quot;
+					&gt;
+					&lt;Tool
+						Name=&quot;VCCLCompilerTool&quot;
+						UsePrecompiledHeader=&quot;0&quot;
+					/&gt;
+				&lt;/FileConfiguration&gt;
+				&lt;FileConfiguration
+					Name=&quot;Release with error catching|Win32&quot;
+					&gt;
+					&lt;Tool
+						Name=&quot;VCCLCompilerTool&quot;
+						UsePrecompiledHeader=&quot;0&quot;
+					/&gt;
+				&lt;/FileConfiguration&gt;
+				&lt;FileConfiguration
+					Name=&quot;Syncdebug|Win32&quot;
+					&gt;
+					&lt;Tool
+						Name=&quot;VCCLCompilerTool&quot;
+						UsePrecompiledHeader=&quot;0&quot;
+					/&gt;
+				&lt;/FileConfiguration&gt;
+			&lt;/File&gt;
+			&lt;File
+				RelativePath=&quot;..\..\Map\MapInfo.h&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
 				RelativePath=&quot;..\..\Map\MetalMap.cpp&quot;
 				&gt;
 			&lt;/File&gt;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000551.html">[Taspring-linux-commit] r5771 - in trunk/rts: ExternalAI System
</A></li>
	<LI>Next message: <A HREF="000553.html">[Taspring-linux-commit] r5773 - trunk/rts/Map/SM3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#552">[ date ]</a>
              <a href="thread.html#552">[ thread ]</a>
              <a href="subject.html#552">[ subject ]</a>
              <a href="author.html#552">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
