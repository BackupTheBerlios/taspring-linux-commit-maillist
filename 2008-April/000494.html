<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r5706 - in branches/springie/refactoring: .	Springie Springie/autohost Springie/autohost/commands
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-April/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5706%20-%20in%20branches/springie/refactoring%3A%20.%0A%09Springie%20Springie/autohost%20Springie/autohost/commands&In-Reply-To=%3C20080412160641.B7DCF46C0%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000490.html">
   <LINK REL="Next"  HREF="000491.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r5706 - in branches/springie/refactoring: .	Springie Springie/autohost Springie/autohost/commands</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5706%20-%20in%20branches/springie/refactoring%3A%20.%0A%09Springie%20Springie/autohost%20Springie/autohost/commands&In-Reply-To=%3C20080412160641.B7DCF46C0%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r5706 - in branches/springie/refactoring: .	Springie Springie/autohost Springie/autohost/commands">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Sat Apr 12 18:06:41 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000490.html">[Taspring-linux-commit] r5705 - branches/springie
</A></li>
        <LI>Next message: <A HREF="000491.html">[Taspring-linux-commit] r5707 - in trunk/tools/springie: . Springie	Springie/client Springie/spring
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#494">[ date ]</a>
              <a href="thread.html#494">[ thread ]</a>
              <a href="subject.html#494">[ subject ]</a>
              <a href="author.html#494">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: Licho
Date: 2008-04-12 18:06:40 +0200 (Sat, 12 Apr 2008)
New Revision: 5706

Added:
   branches/springie/refactoring/Springie/autohost/commands/
   branches/springie/refactoring/Springie/autohost/commands/ComAbstractTargetsPlayer.cs
   branches/springie/refactoring/Springie/autohost/commands/ComBalance.cs
   branches/springie/refactoring/Springie/autohost/commands/ComFix.cs
   branches/springie/refactoring/Springie/autohost/commands/ComHelp.cs
   branches/springie/refactoring/Springie/autohost/commands/ComId.cs
   branches/springie/refactoring/Springie/autohost/commands/ComKick.cs
   branches/springie/refactoring/Springie/autohost/commands/ComRandom.cs
   branches/springie/refactoring/Springie/autohost/commands/ComRing.cs
   branches/springie/refactoring/Springie/autohost/commands/ComSpec.cs
   branches/springie/refactoring/Springie/autohost/commands/ComStart.cs
   branches/springie/refactoring/Springie/autohost/commands/ComTeam.cs
   branches/springie/refactoring/Springie/autohost/commands/Command.cs
   branches/springie/refactoring/Springie/autohost/commands/CommandConfig.cs
   branches/springie/refactoring/Springie/autohost/commands/CommandHandler.cs
Modified:
   branches/springie/refactoring/
   branches/springie/refactoring/Springie/FormSettings.cs
   branches/springie/refactoring/Springie/Main.cs
   branches/springie/refactoring/Springie/Springie.csproj
   branches/springie/refactoring/Springie/autohost/AutoHost.cs
   branches/springie/refactoring/Springie/autohost/AutoHostConfig.cs
   branches/springie/refactoring/Springie/autohost/AutoHost_commands.cs
   branches/springie/refactoring/Springie/autohost/BanList.cs
   branches/springie/refactoring/Springie/autohost/Ladder.cs
Log:



Property changes on: branches/springie/refactoring
___________________________________________________________________
Name: svn:ignore
   - *.suo
Ankh.Load
!zaloha
!runs
!resources
_ReSharper.Springie
Springie.resharper

   + *.suo
Ankh.Load
!zaloha
!runs
!resources
_ReSharper.Springie
Springie.resharper
Springie.4.0.resharper


Modified: branches/springie/refactoring/Springie/FormSettings.cs
===================================================================
--- branches/springie/refactoring/Springie/FormSettings.cs	2008-04-12 16:05:55 UTC (rev 5705)
+++ branches/springie/refactoring/Springie/FormSettings.cs	2008-04-12 16:06:40 UTC (rev 5706)
@@ -1,6 +1,7 @@
 using System;
 using System.Windows.Forms;
 using Springie.autohost;
+using Springie.autohost.commands;
 
 namespace Springie
 {

Modified: branches/springie/refactoring/Springie/Main.cs
===================================================================
--- branches/springie/refactoring/Springie/Main.cs	2008-04-12 16:05:55 UTC (rev 5705)
+++ branches/springie/refactoring/Springie/Main.cs	2008-04-12 16:06:40 UTC (rev 5706)
@@ -155,7 +155,6 @@
     private void tas_Said(object sender, TasSayEventArgs e)
     {
       if (config.RedirectGameChat &amp;&amp; e.Place == TasSayEventArgs.Places.Battle &amp;&amp; e.Origin == TasSayEventArgs.Origins.Player &amp;&amp; e.UserName != tas.UserName &amp;&amp; e.IsEmote == false &amp;&amp; !Program.main.config.AllowInGameJoin) {
-        // TODO disable disabled redirect for allow ingame joins
         spring.SayGame(&quot;[&quot; + e.UserName + &quot;]&quot; + e.Text);
       }
     }

Modified: branches/springie/refactoring/Springie/Springie.csproj
===================================================================
--- branches/springie/refactoring/Springie/Springie.csproj	2008-04-12 16:05:55 UTC (rev 5705)
+++ branches/springie/refactoring/Springie/Springie.csproj	2008-04-12 16:06:40 UTC (rev 5706)
@@ -111,7 +111,20 @@
     &lt;Compile Include=&quot;autohost\AutoManager.cs&quot; /&gt;
     &lt;Compile Include=&quot;autohost\BanList.cs&quot; /&gt;
     &lt;Compile Include=&quot;autohost\BannedUser.cs&quot; /&gt;
-    &lt;Compile Include=&quot;autohost\CommandConfig.cs&quot; /&gt;
+    &lt;Compile Include=&quot;autohost\commands\ComAbstractTargetsPlayer.cs&quot; /&gt;
+    &lt;Compile Include=&quot;autohost\commands\ComBalance.cs&quot; /&gt;
+    &lt;Compile Include=&quot;autohost\commands\ComFix.cs&quot; /&gt;
+    &lt;Compile Include=&quot;autohost\commands\ComHelp.cs&quot; /&gt;
+    &lt;Compile Include=&quot;autohost\commands\ComId.cs&quot; /&gt;
+    &lt;Compile Include=&quot;autohost\commands\ComKick.cs&quot; /&gt;
+    &lt;Compile Include=&quot;autohost\commands\CommandConfig.cs&quot; /&gt;
+    &lt;Compile Include=&quot;autohost\commands\Command.cs&quot; /&gt;
+    &lt;Compile Include=&quot;autohost\commands\CommandHandler.cs&quot; /&gt;
+    &lt;Compile Include=&quot;autohost\commands\ComRandom.cs&quot; /&gt;
+    &lt;Compile Include=&quot;autohost\commands\ComRing.cs&quot; /&gt;
+    &lt;Compile Include=&quot;autohost\commands\ComSpec.cs&quot; /&gt;
+    &lt;Compile Include=&quot;autohost\commands\ComStart.cs&quot; /&gt;
+    &lt;Compile Include=&quot;autohost\commands\ComTeam.cs&quot; /&gt;
     &lt;Compile Include=&quot;autohost\Ladder.cs&quot; /&gt;
     &lt;Compile Include=&quot;autohost\Preset.cs&quot; /&gt;
     &lt;Compile Include=&quot;autohost\PrivilegedUser.cs&quot; /&gt;

Modified: branches/springie/refactoring/Springie/autohost/AutoHost.cs
===================================================================
--- branches/springie/refactoring/Springie/autohost/AutoHost.cs	2008-04-12 16:05:55 UTC (rev 5705)
+++ branches/springie/refactoring/Springie/autohost/AutoHost.cs	2008-04-12 16:06:40 UTC (rev 5706)
@@ -7,6 +7,7 @@
 using System.Timers;
 using System.Windows.Forms;
 using System.Xml.Serialization;
+using Springie.autohost.commands;
 using Springie.AutoHostNamespace;
 using Springie.Client;
 using Springie.SpringNamespace;
@@ -492,14 +493,12 @@
                 if (bossName != &quot;&quot; &amp;&amp; ulevel &lt;= config.DefaulRightsLevel &amp;&amp; e.UserName != bossName &amp;&amp; config.DefaultRightsLevelWithBoss &lt; reqLevel) {
                   Respond(e, &quot;Sorry, you cannot do this right now, ask boss admin &quot; + bossName);
                   return false;
-                } else {
-                  c.lastCall = DateTime.Now;
-                  return true; // ALL OK
                 }
-              } else {
-                Respond(e, &quot;Sorry, you do not have rights to execute &quot; + command);
-                return false;
+                c.lastCall = DateTime.Now;
+                return true; // ALL OK
               }
+              Respond(e, &quot;Sorry, you do not have rights to execute &quot; + command);
+              return false;
             }
           }
           return false; // place not allowed for this command = ignore command

Modified: branches/springie/refactoring/Springie/autohost/AutoHostConfig.cs
===================================================================
--- branches/springie/refactoring/Springie/autohost/AutoHostConfig.cs	2008-04-12 16:05:55 UTC (rev 5705)
+++ branches/springie/refactoring/Springie/autohost/AutoHostConfig.cs	2008-04-12 16:06:40 UTC (rev 5706)
@@ -1,5 +1,6 @@
 using System.Collections.Generic;
 using System.ComponentModel;
+using Springie.autohost.commands;
 using Springie.Client;
 using Springie.SpringNamespace;
 
@@ -268,32 +269,10 @@
       if (level &gt; 0) PrivilegedUsers.Add(new PrivilegedUser(name, level));
     }
 
-    private void AddMissing(CommandConfig command, List&lt;CommandConfig&gt; addedCommands)
-    {
-      foreach (CommandConfig c in Commands) {
-        if (c.Name == command.Name) {
-          addedCommands.Add(c);
-          return;
-        }
-      }
-      Commands.Add(command);
-      addedCommands.Add(command);
-    }
-
     public void AddMissingCommands()
     {
       List&lt;CommandConfig&gt; addedCommands = new List&lt;CommandConfig&gt;();
 
-      AddMissing(new CommandConfig(&quot;help&quot;, 0, &quot; - lists all commands available specifically to you&quot;, 5), addedCommands);
-
-      AddMissing(new CommandConfig(&quot;random&quot;, 1, &quot;&lt;allycount&gt; - assigns people to &lt;allycount&gt; random alliances, e.g. !random - makes 2 random alliances&quot;, 10), addedCommands);
-
-      AddMissing(new CommandConfig(&quot;balance&quot;, 1, &quot;&lt;allycount&gt; - assigns people to &lt;allycount&gt; rank balanced alliances, e.g. !balance - makes 2 random but balanced alliances&quot;, 10), addedCommands);
-
-      AddMissing(new CommandConfig(&quot;start&quot;, 1, &quot; - starts game&quot;, 5), addedCommands);
-
-      AddMissing(new CommandConfig(&quot;ring&quot;, 0, &quot;[&lt;filters&gt;..] - rings all unready or specific player(s), e.g. !ring - rings unready, !ring icho - rings Licho&quot;, 5, new TasSayEventArgs.Places[] {TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game}), addedCommands);
-
       AddMissing(new CommandConfig(&quot;listmaps&quot;, 0, &quot;[&lt;filters&gt;..] - lists maps on server, e.g. !listmaps altor div&quot;, 10), addedCommands);
       AddMissing(new CommandConfig(&quot;listmods&quot;, 0, &quot;[&lt;filters&gt;..] - lists mods on server, e.g. !listmods absolute 2.23&quot;, 5), addedCommands);
       AddMissing(new CommandConfig(&quot;map&quot;, 2, &quot;[&lt;filters&gt;..] - changes server map, eg. !map altor div&quot;), addedCommands);
@@ -305,7 +284,6 @@
       AddMissing(new CommandConfig(&quot;say&quot;, 0, &quot;&lt;text&gt; - says something in game&quot;, 0, new TasSayEventArgs.Places[] {TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game}), addedCommands);
 
       AddMissing(new CommandConfig(&quot;force&quot;, 2, &quot; - forces game start inside game&quot;, 8, new TasSayEventArgs.Places[] {TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game}), addedCommands);
-      AddMissing(new CommandConfig(&quot;kick&quot;, 3, &quot;[&lt;filters&gt;..] - kicks a player&quot;, 0, new TasSayEventArgs.Places[] {TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game}), addedCommands);
 
       AddMissing(new CommandConfig(&quot;split&quot;, 1, &quot;&lt;\&quot;h\&quot;/\&quot;v\&quot;&gt; &lt;percent&gt; - draws with given direction and percentual size, e.g. !split h 15&quot;), addedCommands);
 
@@ -317,22 +295,8 @@
 
       AddMissing(new CommandConfig(&quot;unlock&quot;, 1, &quot; - unlocks the game&quot;), addedCommands);
 
-      AddMissing(new CommandConfig(&quot;fix&quot;, 1, &quot; - fixes teamnumbers&quot;, 5), addedCommands);
 
-      AddMissing(new CommandConfig(&quot;votemap&quot;, 0, &quot;[&lt;mapname&gt;..] - starts vote for new map, e.g. !votemap altored div&quot;), addedCommands);
-
-      AddMissing(new CommandConfig(&quot;votekick&quot;, 0, &quot;[&lt;mapname&gt;..] - starts vote to kick a player, e.g. !votekick Licho&quot;, 0, new TasSayEventArgs.Places[] {TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game}), addedCommands);
-
-      AddMissing(new CommandConfig(&quot;voteforcestart&quot;, 0, &quot; - starts vote to force game to start in lobby&quot;), addedCommands);
-
-      AddMissing(new CommandConfig(&quot;voteforce&quot;, 0, &quot; - starts vote to force game to start from game&quot;, 0, new TasSayEventArgs.Places[] {TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game}), addedCommands);
-
-      AddMissing(new CommandConfig(&quot;voteexit&quot;, 0, &quot; - starts vote to exit game&quot;, 0, new TasSayEventArgs.Places[] {TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game}), addedCommands);
-
-      AddMissing(new CommandConfig(&quot;vote&quot;, 0, &quot;&lt;number&gt; - votes for given option (works from battle only), e.g. !vote 1&quot;, 0, new TasSayEventArgs.Places[] {TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game}), addedCommands);
-
       AddMissing(new CommandConfig(&quot;rehost&quot;, 3, &quot;[&lt;modname&gt;..] - rehosts game, e.g. !rehost abosol 2.23 - rehosts AA2.23&quot;), addedCommands);
-      AddMissing(new CommandConfig(&quot;voterehost&quot;, 0, &quot;[&lt;modname&gt;..] - votes to rehost game, e.g. !rehost abosol 2.23 - rehosts AA2.23&quot;, 0, new TasSayEventArgs.Places[] {TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game}), addedCommands);
 
       AddMissing(new CommandConfig(&quot;admins&quot;, 0, &quot; - lists admins&quot;, 5), addedCommands);
 
@@ -348,18 +312,12 @@
 
       AddMissing(new CommandConfig(&quot;reload&quot;, 2, &quot; - reloads mod and map list (can take long time)&quot;, 30), addedCommands);
 
-      AddMissing(new CommandConfig(&quot;team&quot;, 2, &quot;&lt;teamnumber&gt; [&lt;playername&gt;..] - forces given player to a team&quot;), addedCommands);
-
-      AddMissing(new CommandConfig(&quot;ally&quot;, 2, &quot;&lt;allynumber&gt; [&lt;playername&gt;..] - forces given player to an alliance&quot;), addedCommands);
-
       AddMissing(new CommandConfig(&quot;helpall&quot;, 0, &quot;- lists all commands known to Springie (sorted by command level)&quot;, 5), addedCommands);
 
       AddMissing(new CommandConfig(&quot;fixcolors&quot;, 1, &quot;- changes too similar colors to more different (note that color difference is highly subjective and impossible to model mathematically, so it won't always produce results satisfying for all)&quot;, 10), addedCommands);
 
       AddMissing(new CommandConfig(&quot;springie&quot;, 0, &quot;- responds with basic springie information&quot;, 5, new TasSayEventArgs.Places[] {TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Channel}), addedCommands);
 
-      AddMissing(new CommandConfig(&quot;endvote&quot;, 2, &quot;- ends current poll&quot;), addedCommands);
-
       AddMissing(new CommandConfig(&quot;addbox&quot;, 1, &quot;&lt;left&gt; &lt;top&gt; &lt;width&gt; &lt;height&gt; [&lt;number&gt;] - adds a new box rectangle&quot;), addedCommands);
 
       AddMissing(new CommandConfig(&quot;clearbox&quot;, 1, &quot;[&lt;number&gt;] - removes a box (or removes all boxes if number not specified)&quot;), addedCommands);
@@ -392,8 +350,6 @@
 
       AddMissing(new CommandConfig(&quot;kickspec&quot;, 2, &quot;[0|1] - enables or disables automatic spectator kicking&quot;, 0, new TasSayEventArgs.Places[] {TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game, TasSayEventArgs.Places.Normal}), addedCommands);
 
-      AddMissing(new CommandConfig(&quot;votekickspec&quot;, 0, &quot;- starts a vote to enables or disable automatic spectator kicking&quot;, 0, new TasSayEventArgs.Places[] {TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game}), addedCommands);
-
       AddMissing(new CommandConfig(&quot;setpassword&quot;, 4, &quot;&lt;newpassword&gt; - sets server password (needs !rehost to apply)&quot;), addedCommands);
 
       AddMissing(new CommandConfig(&quot;setminrank&quot;, 4, &quot;&lt;minrank&gt; - sets server minimum rank (needs !rehost to apply)&quot;), addedCommands);
@@ -406,11 +362,9 @@
 
       AddMissing(new CommandConfig(&quot;boss&quot;, 2, &quot;&lt;name&gt; - sets &lt;name&gt; as a new boss, use without parameter to remove any current boss. If there is a boss on server, other non-admin people have their rights reduced&quot;), addedCommands);
 
-      AddMissing(new CommandConfig(&quot;voteboss&quot;, 0, &quot;&lt;name&gt; - sets &lt;name&gt; as a new boss, use without parameter to remove any current boss. If there is a boss on server, other non-admin people have their rights reduced&quot;, 0, new TasSayEventArgs.Places[] {TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game}), addedCommands);
 
       AddMissing(new CommandConfig(&quot;autolock&quot;, 1, &quot;&lt;players&gt; - sets desired number of players in game. If this number is reached, server will autolock itself, if someone leaves, it will autounlock again. !autolock without parameter disables auto locking&quot;), addedCommands);
 
-      AddMissing(new CommandConfig(&quot;spec&quot;, 2, &quot;&lt;username&gt; - forces player to become spectator&quot;, 0), addedCommands);
 
       AddMissing(new CommandConfig(&quot;specafk&quot;, 1, &quot;forces all AFK player to become spectators&quot;, 0), addedCommands);
 

Modified: branches/springie/refactoring/Springie/autohost/AutoHost_commands.cs
===================================================================
--- branches/springie/refactoring/Springie/autohost/AutoHost_commands.cs	2008-04-12 16:05:55 UTC (rev 5705)
+++ branches/springie/refactoring/Springie/autohost/AutoHost_commands.cs	2008-04-12 16:06:40 UTC (rev 5706)
@@ -3,6 +3,7 @@
 using System.Globalization;
 using System.Text.RegularExpressions;
 using System.Threading;
+using Springie.autohost.commands;
 using Springie.Client;
 using Springie.SpringNamespace;
 
@@ -116,7 +117,7 @@
       return Filter(temp, words, out vals, out indexes);
     }
 
-    private int FilterUsers(string[] words, out string[] vals, out int[] indexes)
+    public int FilterUsers(string[] words, out string[] vals, out int[] indexes)
     {
       return FilterUsers(words, tas, spring, out vals, out indexes);
     }
@@ -184,13 +185,6 @@
     }
 
 
-    private void ComHelp(TasSayEventArgs e, string[] words)
-    {
-      int ulevel = GetUserLevel(e);
-      tas.Say(TasClient.SayPlace.User, e.UserName, &quot;---&quot;, false);
-      foreach (CommandConfig c in config.Commands) if (c.Level &lt;= ulevel) tas.Say(TasClient.SayPlace.User, e.UserName, &quot; !&quot; + c.Name + &quot; &quot; + c.HelpText, false);
-      tas.Say(TasClient.SayPlace.User, e.UserName, &quot;---&quot;, false);
-    }
 
 
     private void ComHelpAll(TasSayEventArgs e, string[] words)
@@ -292,43 +286,6 @@
       return true;
     }
 
-    public void ComStart(TasSayEventArgs e, string[] words)
-    {
-      string usname;
-      if (!AllReadyAndSynced(out usname)) {
-        SayBattle(&quot;cannot start, &quot; + usname + &quot; not ready and synced&quot;);
-        return;
-      }
-
-      if (!AllUniqueTeams(out usname)) {
-        SayBattle(&quot;cannot start, &quot; + usname + &quot; is sharing teams. Use !forcestart to override&quot;);
-        return;
-      }
-
-      int allyno;
-      if (!BalancedTeams(out allyno)) {
-        SayBattle(&quot;cannot start, alliance &quot; + (allyno + 1).ToString() + &quot; not fair. Use !forcestart to override&quot;);
-        return;
-      }
-      SayBattle(&quot;please wait, game is about to start&quot;);
-
-      StopVote();
-
-      Battle b = tas.GetBattle();
-      if (b != null) {
-        string curMap = b.Map.ArchiveName.ToLower();
-
-        Dictionary&lt;int, BattleRect&gt; nd = new Dictionary&lt;int, BattleRect&gt;();
-        foreach (KeyValuePair&lt;int, BattleRect&gt; v in b.Rectangles) nd.Add(v.Key, v.Value);
-
-        if (MapBoxes.ContainsKey(curMap)) MapBoxes[curMap] = nd;
-        else MapBoxes.Add(curMap, nd);
-        SaveConfig();
-      }
-      tas.ChangeLock(true);
-      tas.StartGame();
-    }
-
     public void ComForceStart(TasSayEventArgs e, string[] words)
     {
       /*string usname;
@@ -441,77 +398,7 @@
       }
     }
 
-    public void ComRing(TasSayEventArgs e, string[] words)
-    {
-      List&lt;string&gt; usrlist = new List&lt;string&gt;();
 
-      if (words.Length == 0) {
-        // ringing idle
-        foreach (UserBattleStatus p in tas.GetBattle().Users) {
-          if (p.IsSpectator) continue;
-          if (!p.IsReady) usrlist.Add(p.name);
-        }
-      } else {
-        string[] vals;
-        int[] indexes;
-        FilterUsers(words, out vals, out indexes);
-        usrlist = new List&lt;string&gt;(vals);
-      }
-
-      string rang = &quot;&quot;;
-      foreach (string s in usrlist) {
-        tas.Ring(s);
-        rang += s + &quot;, &quot;;
-      }
-
-      if (words.Length == 0 &amp;&amp; usrlist.Count &gt; 7) SayBattle(&quot;ringing all unready&quot;);
-      else SayBattle(&quot;ringing &quot; + rang);
-    }
-
-
-    public void ComKick(TasSayEventArgs e, string[] words)
-    {
-      if (words.Length == 0) {
-        Respond(e, &quot;You must specify player name&quot;);
-        return;
-      }
-
-      int[] indexes;
-      string[] usrlist;
-      if (FilterUsers(words, out usrlist, out indexes) == 0) {
-        Respond(e, &quot;Cannot find such player&quot;);
-        return;
-      }
-
-      if (usrlist[0] == tas.UserName) {
-        Respond(e, &quot;won't kick myself, not in suicidal mood today&quot;);
-        return;
-      }
-
-      if (spring.IsRunning) spring.Kick(usrlist[0]);
-      tas.Kick(usrlist[0]);
-    }
-
-
-    public void ComForceSpectator(TasSayEventArgs e, string[] words)
-    {
-      if (words.Length == 0) {
-        Respond(e, &quot;You must specify player name&quot;);
-        return;
-      }
-
-      int[] indexes;
-      string[] usrlist;
-      if (FilterUsers(words, out usrlist, out indexes) == 0) {
-        Respond(e, &quot;Cannot find such player&quot;);
-        return;
-      }
-
-      tas.ForceSpectator(usrlist[0]);
-      Respond(e, &quot;Forcing &quot; + usrlist[0] + &quot; to spectator&quot;);
-    }
-
-
     public void ComExit(TasSayEventArgs e, string[] words)
     {
       if (spring.IsRunning) SayBattle(&quot;exiting game&quot;);
@@ -520,18 +407,6 @@
     }
 
 
-    public void ComFix(TasSayEventArgs e, string[] words)
-    {
-      Battle b = tas.GetBattle();
-      int cnt = 0;
-      foreach (UserBattleStatus u in b.Users) {
-        if (!u.IsSpectator) {
-          tas.ForceTeam(u.name, cnt);
-          cnt++;
-        }
-      }
-      SayBattle(&quot;team numbers fixed&quot;);
-    }
 
 
     public void ComFixColors(TasSayEventArgs e, string[] words)
@@ -570,33 +445,8 @@
       }
     }
 
-    public void ComRandom(TasSayEventArgs e, string[] words)
-    {
-      ComFix(e, words);
-      Battle b = tas.GetBattle();
 
-      List&lt;UserBattleStatus&gt; actUsers = new List&lt;UserBattleStatus&gt;();
-      foreach (UserBattleStatus u in b.Users) if (!u.IsSpectator) actUsers.Add(u);
 
-      int teamCount = 0;
-      if (words.Length &gt; 0) int.TryParse(words[0], out teamCount);
-      else teamCount = 2;
-      if (teamCount &lt; 2) teamCount = 2;
-      if (teamCount &gt; actUsers.Count) teamCount = 2;
-      Random r = new Random();
-
-      int al = 0;
-      while (actUsers.Count &gt; 0) {
-        int index = r.Next(actUsers.Count);
-        tas.ForceAlly(actUsers[index].name, al);
-        actUsers.RemoveAt(index);
-        al++;
-        al = al%teamCount;
-      }
-      SayBattle(&quot;players assigned to &quot; + teamCount + &quot; random teams&quot;);
-    }
-
-
     // user and rank info
 
 
@@ -858,25 +708,6 @@
     }
 
 
-    public void ComTeam(TasSayEventArgs e, string[] words)
-    {
-      if (words.Length &lt; 2) {
-        Respond(e, &quot;this command needs 2 parameters (team number and player name)&quot;);
-        return;
-      }
-      int teamno = 0;
-      if (!int.TryParse(words[0], out teamno) || --teamno &lt; 0 || teamno &gt;= Spring.MaxTeams) {
-        Respond(e, &quot;invalid team number&quot;);
-        return;
-      }
-      string[] usrs;
-      int[] idx;
-      if (FilterUsers(Utils.ShiftArray(words, -1), out usrs, out idx) == 0) Respond(e, &quot;no such player found&quot;);
-      else {
-        SayBattle(&quot;Forcing &quot; + usrs[0] + &quot; to team &quot; + (teamno + 1));
-        tas.ForceTeam(usrs[0], teamno);
-      }
-    }
 
     public void ComManage(TasSayEventArgs e, string[] words)
     {
@@ -893,25 +724,7 @@
       manager.Manage(min, max);
     }
 
-    public void ComAlly(TasSayEventArgs e, string[] words)
-    {
-      if (words.Length &lt; 2) {
-        Respond(e, &quot;this command needs 2 parameters (ally number and player name)&quot;);
-        return;
-      }
-      int allyno = 0;
-      if (!int.TryParse(words[0], out allyno) || --allyno &lt; 0 || allyno &gt;= Spring.MaxAllies) {
-        Respond(e, &quot;invalid ally number&quot;);
-        return;
-      }
-      string[] usrs;
-      int[] idx;
-      if (FilterUsers(Utils.ShiftArray(words, -1), out usrs, out idx) == 0) Respond(e, &quot;no such player found&quot;);
-      else {
-        SayBattle(&quot;Forcing &quot; + usrs[0] + &quot; to alliance &quot; + (allyno + 1));
-        tas.ForceAlly(usrs[0], allyno);
-      }
-    }
+  
 
 
     public void ComSpringie(TasSayEventArgs e, string[] words)

Modified: branches/springie/refactoring/Springie/autohost/BanList.cs
===================================================================
--- branches/springie/refactoring/Springie/autohost/BanList.cs	2008-04-12 16:05:55 UTC (rev 5705)
+++ branches/springie/refactoring/Springie/autohost/BanList.cs	2008-04-12 16:06:40 UTC (rev 5706)
@@ -21,8 +21,8 @@
       this.tas = tas;
       this.ah = ah;
 
-      tas.BattleUserIpRecieved += new EventHandler&lt;TasEventArgs&gt;(tas_BattleUserIpRecieved);
-      tas.BattleUserJoined += new EventHandler&lt;TasEventArgs&gt;(tas_BattleUserJoined);
+      tas.BattleUserIpRecieved += tas_BattleUserIpRecieved;
+      tas.BattleUserJoined += tas_BattleUserJoined;
     }
 
     private void tas_BattleUserIpRecieved(object sender, TasEventArgs e)

Modified: branches/springie/refactoring/Springie/autohost/Ladder.cs
===================================================================
--- branches/springie/refactoring/Springie/autohost/Ladder.cs	2008-04-12 16:05:55 UTC (rev 5705)
+++ branches/springie/refactoring/Springie/autohost/Ladder.cs	2008-04-12 16:06:40 UTC (rev 5706)
@@ -7,9 +7,9 @@
   public class Ladder
   {
     private const string ladderUrl = &quot;<A HREF="http://blendax.informatik.uni-bremen.de/jan/spring/ladder/lobby/">http://blendax.informatik.uni-bremen.de/jan/spring/ladder/lobby/</A>&quot;;
-    private int ladderId;
+    private readonly int ladderId;
 
-    private List&lt;string&gt; maps = new List&lt;string&gt;();
+    private readonly List&lt;string&gt; maps = new List&lt;string&gt;();
 
     private string[] rules;
 
@@ -39,19 +39,16 @@
         maps.Clear();
         foreach (string line in lines.Split('\n')) maps.Add(line.ToLower());
       } catch {}
-      ;
     }
 
 
     private void LoadRules()
     {
       try {
-        WebClient wc = new WebClient();
-        wc.UseDefaultCredentials = true;
+        WebClient wc = new WebClient {UseDefaultCredentials = true};
         string lines = wc.DownloadString(ladderUrl + &quot;rules.php?ladder=&quot; + ladderId);
         rules = lines.Split('\n');
       } catch {}
-      ;
     }
 
 

Added: branches/springie/refactoring/Springie/autohost/commands/ComAbstractTargetsPlayer.cs
===================================================================
--- branches/springie/refactoring/Springie/autohost/commands/ComAbstractTargetsPlayer.cs	                        (rev 0)
+++ branches/springie/refactoring/Springie/autohost/commands/ComAbstractTargetsPlayer.cs	2008-04-12 16:06:40 UTC (rev 5706)
@@ -0,0 +1,54 @@
+using Springie.Client;
+
+namespace Springie.autohost.commands
+{
+  public abstract class ComAbstractTargetsPlayer : Command
+  {
+    protected string[] playerNames;
+    protected bool allowEmptyArgs;
+    protected bool canTargetMultiple;
+    protected int playernameStartIndex;
+
+    protected ComAbstractTargetsPlayer(CommandHandler handler) : base(handler)
+    {
+      paramDescription = allowEmptyArgs ? &quot;[&lt;playername..&gt;]&quot; : &quot;&lt;playername..&gt;&quot;;
+    }
+
+    public override bool Parse(TasSayEventArgs eventArgs, object[] parameters)
+    {
+      if (parameters.Length &lt;= playernameStartIndex) {
+        if (allowEmptyArgs) {
+          playerNames = new string[0];
+          return true;
+        }
+        Respond(eventArgs, &quot;You must specify player name&quot;);
+        return false;
+      }
+
+      string[] filterWords = new string[parameters.Length - playernameStartIndex];
+      for (int i = 0; i &lt; parameters.Length; i++) filterWords[i] = parameters[i + playernameStartIndex].ToString();
+      int[] indexes;
+      handler.AutoHost.FilterUsers(filterWords, out playerNames, out indexes);
+
+      if (playerNames.Length == 0) {
+        Respond(eventArgs, &quot;Cannot find such player&quot;);
+        return false;
+      }
+
+      foreach (string s in playerNames) {
+        if (s == handler.TasClient.UserName) {
+          Respond(eventArgs, &quot;Cannot target myself&quot;);
+          return false;
+        }
+      }
+
+
+      if (playerNames.Length &gt; 1 &amp;&amp; !canTargetMultiple) {
+        Respond(eventArgs, &quot;This matches more than one player&quot;);
+        return false;
+      }
+      
+      return true;
+    }
+  }
+}
\ No newline at end of file

Added: branches/springie/refactoring/Springie/autohost/commands/ComBalance.cs
===================================================================
--- branches/springie/refactoring/Springie/autohost/commands/ComBalance.cs	                        (rev 0)
+++ branches/springie/refactoring/Springie/autohost/commands/ComBalance.cs	2008-04-12 16:06:40 UTC (rev 5706)
@@ -0,0 +1,32 @@
+using Springie.Client;
+
+namespace Springie.autohost.commands
+{
+  public class ComBalance : Command
+  {
+    private int allyCount;
+
+    public ComBalance(CommandHandler handler) : base(handler)
+    {
+      id = &quot;balance&quot;;
+      description = &quot;assigns people to &lt;allycount&gt; rank balanced alliances, e.g. !balance - makes 2 random but balanced alliances&quot;;
+      paramDescription = &quot;&lt;allycount&gt;&quot;;
+      config.Throttling = 5;
+    }
+
+    public override bool Parse(TasSayEventArgs eventArgs, object[] parameters)
+    {
+      if (parameters.Length &gt; 0) {
+        if (!int.TryParse(parameters[0].ToString(), out allyCount)) allyCount = 2;
+      } else allyCount = 2;
+      if (allyCount &lt; 2) allyCount = 2;
+      return true;
+    }
+
+    protected override void DoCommand()
+    {
+      handler.Execute&lt;ComFix&gt;();
+      handler.AutoHost.BalanceTeams(allyCount, false);
+    }
+  }
+}
\ No newline at end of file

Added: branches/springie/refactoring/Springie/autohost/commands/ComFix.cs
===================================================================
--- branches/springie/refactoring/Springie/autohost/commands/ComFix.cs	                        (rev 0)
+++ branches/springie/refactoring/Springie/autohost/commands/ComFix.cs	2008-04-12 16:06:40 UTC (rev 5706)
@@ -0,0 +1,32 @@
+using Springie.Client;
+
+namespace Springie.autohost.commands
+{
+  public class ComFix : Command
+  {
+    public ComFix(CommandHandler handler) : base(handler)
+    {
+      id = &quot;fix&quot;;
+      description = &quot;fixes team numbers&quot;;
+      config.Throttling = 2;
+    }
+
+    public override bool Parse(TasSayEventArgs eventArgs, object[] parameters)
+    {
+      return true;
+    }
+
+    protected override void DoCommand()
+    {
+      Battle b = handler.TasClient.GetBattle();
+      int cnt = 0;
+      foreach (UserBattleStatus u in b.Users) {
+        if (!u.IsSpectator) {
+          handler.TasClient.ForceTeam(u.name, cnt);
+          cnt++;
+        }
+      }
+      SayBattle(&quot;team numbers fixed&quot;);
+    }
+  }
+}
\ No newline at end of file

Added: branches/springie/refactoring/Springie/autohost/commands/ComHelp.cs
===================================================================
--- branches/springie/refactoring/Springie/autohost/commands/ComHelp.cs	                        (rev 0)
+++ branches/springie/refactoring/Springie/autohost/commands/ComHelp.cs	2008-04-12 16:06:40 UTC (rev 5706)
@@ -0,0 +1,29 @@
+&#65279;using Springie.Client;
+
+namespace Springie.autohost.commands
+{
+  public class ComHelp : Command
+  {
+    public ComHelp(CommandHandler handler) : base(handler)
+    {
+      id = &quot;help&quot;;
+      config.Level = 0;
+      config.ListenTo = CommandConfig.ListenChannelPmBattle;
+      description = &quot;lists all commands available specifically to you&quot;;
+    }
+
+    public override bool Parse(TasSayEventArgs eventArgs, object[] parameters)
+    {
+      return true;
+    }
+
+    protected override void DoCommand()
+    {
+      // TODO: dodelat
+      //int ulevel = GetUserLevel(e);
+      //tas.Say(TasClient.SayPlace.User, e.UserName, &quot;---&quot;, false);
+      //foreach (CommandConfig c in config.Commands) if (c.Level &lt;= ulevel) tas.Say(TasClient.SayPlace.User, e.UserName, &quot; !&quot; + c.Name + &quot; &quot; + c.HelpText, false);
+      //tas.Say(TasClient.SayPlace.User, e.UserName, &quot;---&quot;, false);
+    }
+  }
+}
\ No newline at end of file

Added: branches/springie/refactoring/Springie/autohost/commands/ComId.cs
===================================================================
--- branches/springie/refactoring/Springie/autohost/commands/ComId.cs	                        (rev 0)
+++ branches/springie/refactoring/Springie/autohost/commands/ComId.cs	2008-04-12 16:06:40 UTC (rev 5706)
@@ -0,0 +1,41 @@
+using Springie.SpringNamespace;
+
+namespace Springie.autohost.commands
+{
+  public class ComId : ComAbstractTargetsPlayer
+  {
+    protected int targetNumber;
+
+    public ComId(CommandHandler handler) : base(handler)
+    {
+      id = &quot;id&quot;;
+      description = &quot;changes player id&quot;;
+      config.Level = 2;
+      playernameStartIndex = 1;
+      allowEmptyArgs = false;
+      canTargetMultiple = false;
+    }
+
+    public override bool Parse(Client.TasSayEventArgs eventArgs, object[] parameters)
+    {
+      if (base.Parse(eventArgs, parameters)) {
+        if (!int.TryParse(parameters[0].ToString(), out targetNumber)) {
+          Respond(eventArgs, &quot;first parameter must be a number&quot;);
+          return false;
+        }
+        if (targetNumber &lt; 0 || targetNumber&gt;= Spring.MaxTeams) {
+          Respond(eventArgs, &quot;id number must be between 0 and {1}&quot;, Spring.MaxTeams);
+          return false;
+        }
+        return true;
+      } else return false;
+    }
+
+
+    protected override void DoCommand()
+    {
+      handler.TasClient.ForceTeam(playerNames[0], targetNumber);
+      SayBattle(&quot;Setting {0} id to {1}&quot;, playerNames[0], targetNumber);
+    }
+  }
+}
\ No newline at end of file

Added: branches/springie/refactoring/Springie/autohost/commands/ComKick.cs
===================================================================
--- branches/springie/refactoring/Springie/autohost/commands/ComKick.cs	                        (rev 0)
+++ branches/springie/refactoring/Springie/autohost/commands/ComKick.cs	2008-04-12 16:06:40 UTC (rev 5706)
@@ -0,0 +1,23 @@
+namespace Springie.autohost.commands
+{
+  public class ComKick : ComAbstractTargetsPlayer
+  {
+    public ComKick(CommandHandler handler) : base(handler)
+    {
+      id = &quot;kick&quot;;
+      description = &quot;kicks a player from game/battle room&quot;;
+      config.ListenTo = CommandConfig.ListenPmGameBattle;
+      config.Level = 3;
+      allowEmptyArgs = false;
+      canTargetMultiple = false;
+    }
+
+
+    protected override void DoCommand()
+    {
+      if (handler.Spring.IsRunning) handler.Spring.Kick(playerNames[0]);
+      handler.TasClient.Kick(playerNames[0]);
+      SayBattle(&quot;Kicking {0}&quot;, playerNames[0]);
+   }
+  }
+}
\ No newline at end of file

Added: branches/springie/refactoring/Springie/autohost/commands/ComRandom.cs
===================================================================
--- branches/springie/refactoring/Springie/autohost/commands/ComRandom.cs	                        (rev 0)
+++ branches/springie/refactoring/Springie/autohost/commands/ComRandom.cs	2008-04-12 16:06:40 UTC (rev 5706)
@@ -0,0 +1,49 @@
+using System;
+using System.Collections.Generic;
+using Springie.Client;
+
+namespace Springie.autohost.commands
+{
+  public class ComRandom : Command
+  {
+    private int allyCount;
+
+    public ComRandom(CommandHandler handler) : base(handler)
+    {
+      id = &quot;random&quot;;
+      description = &quot;assigns people to &lt;allycount&gt; random alliances, e.g. !random - makes 2 random alliances&quot;;
+      paramDescription = &quot;&lt;allycount&gt;&quot;;
+      config.Throttling = 5;
+    }
+
+    public override bool Parse(TasSayEventArgs eventArgs, params object[] parameters)
+    {
+      if (parameters.Length &gt; 0) {
+        if (!int.TryParse(parameters[0].ToString(), out allyCount)) allyCount = 2;
+      } else allyCount = 2;
+      if (allyCount &lt; 2) allyCount = 2;
+      return true;
+    }
+
+    protected override void DoCommand()
+    {
+      handler.Execute&lt;ComFix&gt;();
+      Battle b = handler.TasClient.GetBattle();
+
+      List&lt;UserBattleStatus&gt; actUsers = new List&lt;UserBattleStatus&gt;();
+      foreach (UserBattleStatus u in b.Users) if (!u.IsSpectator) actUsers.Add(u);
+
+      Random r = new Random();
+
+      int al = 0;
+      while (actUsers.Count &gt; 0) {
+        int index = r.Next(actUsers.Count);
+        handler.TasClient.ForceAlly(actUsers[index].name, al);
+        actUsers.RemoveAt(index);
+        al++;
+        al = al % allyCount;
+      }
+      SayBattle(&quot;players assigned to {0} random teams&quot;, allyCount);
+    }
+  }
+}
\ No newline at end of file

Added: branches/springie/refactoring/Springie/autohost/commands/ComRing.cs
===================================================================
--- branches/springie/refactoring/Springie/autohost/commands/ComRing.cs	                        (rev 0)
+++ branches/springie/refactoring/Springie/autohost/commands/ComRing.cs	2008-04-12 16:06:40 UTC (rev 5706)
@@ -0,0 +1,40 @@
+using System.Collections.Generic;
+using Springie.Client;
+
+namespace Springie.autohost.commands
+{
+  public class ComRing : ComAbstractTargetsPlayer
+  {
+    public ComRing(CommandHandler handler) : base(handler)
+    {
+      id = &quot;ring&quot;;
+      description = &quot;rings all unready or specific player(s)&quot;;
+      config.ListenTo = CommandConfig.ListenGameBattle;
+
+      allowEmptyArgs = true;
+      canTargetMultiple = true;
+    }
+
+
+    protected override void DoCommand()
+    {
+      List&lt;string&gt; toRing = new List&lt;string&gt;();
+      bool allUnready = (playerNames == null || playerNames.Length == 0); // ringing unready if empty args
+
+      if (allUnready) {
+        foreach (UserBattleStatus p in handler.TasClient.GetBattle().Users) {
+          if (p.IsSpectator) continue;
+          if (!p.IsReady) toRing.Add(p.name);
+        }
+      } else toRing = new List&lt;string&gt;(playerNames);
+
+      string rang = &quot;&quot;;
+      foreach (string s in toRing) {
+        handler.TasClient.Ring(s);
+        rang += s + &quot;, &quot;;
+      }
+      if (allUnready) SayBattle(&quot;ringing all unready&quot;);
+      else SayBattle(&quot;ringing &quot; + rang);
+    }
+  }
+}
\ No newline at end of file

Added: branches/springie/refactoring/Springie/autohost/commands/ComSpec.cs
===================================================================
--- branches/springie/refactoring/Springie/autohost/commands/ComSpec.cs	                        (rev 0)
+++ branches/springie/refactoring/Springie/autohost/commands/ComSpec.cs	2008-04-12 16:06:40 UTC (rev 5706)
@@ -0,0 +1,22 @@
+namespace Springie.autohost.commands
+{
+  public class ComSpec : ComAbstractTargetsPlayer
+  {
+    public ComSpec(CommandHandler handler) : base(handler)
+    {
+      id = &quot;spec&quot;;
+      description = &quot;forces player to spectator&quot;;
+      config.ListenTo = CommandConfig.ListenPmGameBattle;
+      config.Level = 2;
+      allowEmptyArgs = false;
+      canTargetMultiple = false;
+    }
+
+
+    protected override void DoCommand()
+    {
+      handler.TasClient.ForceSpectator(playerNames[0]);
+      SayBattle(&quot;Speccing {0}&quot;, playerNames[0]);
+    }
+  }
+}
\ No newline at end of file

Added: branches/springie/refactoring/Springie/autohost/commands/ComStart.cs
===================================================================
--- branches/springie/refactoring/Springie/autohost/commands/ComStart.cs	                        (rev 0)
+++ branches/springie/refactoring/Springie/autohost/commands/ComStart.cs	2008-04-12 16:06:40 UTC (rev 5706)
@@ -0,0 +1,57 @@
+using System.Collections.Generic;
+using Springie.Client;
+
+namespace Springie.autohost.commands
+{
+  public class ComStart : Command
+  {
+    public ComStart(CommandHandler handler) : base(handler)
+    {
+      id = &quot;start&quot;;
+      description = &quot;starts game&quot;;
+    }
+
+    public override bool Parse(TasSayEventArgs eventArgs, object[] parameters)
+    {
+      return true;
+    }
+
+    protected override void DoCommand()
+    {
+      string usname;
+      if (!handler.AutoHost.AllReadyAndSynced(out usname)) {
+        SayBattle(&quot;cannot start, &quot; + usname + &quot; not ready and synced&quot;);
+        return;
+      }
+
+      if (!handler.AutoHost.AllUniqueTeams(out usname)) {
+        SayBattle(&quot;cannot start, &quot; + usname + &quot; is sharing teams. Use !forcestart to override&quot;);
+        return;
+      }
+
+      int allyno;
+      if (!handler.AutoHost.BalancedTeams(out allyno)) {
+        SayBattle(&quot;cannot start, alliance &quot; + (allyno + 1) + &quot; not fair. Use !forcestart to override&quot;);
+        return;
+      }
+      SayBattle(&quot;please wait, game is about to start&quot;);
+
+      //StopVote(); // TODO stop vote replacement
+
+      Battle b = handler.TasClient.GetBattle();
+      if (b != null) {
+        string curMap = b.Map.ArchiveName.ToLower();
+
+        Dictionary&lt;int, BattleRect&gt; nd = new Dictionary&lt;int, BattleRect&gt;();
+        foreach (KeyValuePair&lt;int, BattleRect&gt; v in b.Rectangles) nd.Add(v.Key, v.Value);
+        
+        // TODO map boxes in independt class tracking changes 
+        //if (MapBoxes.ContainsKey(curMap)) MapBoxes[curMap] = nd;
+        //else MapBoxes.Add(curMap, nd);
+        //SaveConfig();
+      }
+      handler.TasClient.ChangeLock(true);
+      handler.TasClient.StartGame();
+    }
+  }
+}
\ No newline at end of file

Added: branches/springie/refactoring/Springie/autohost/commands/ComTeam.cs
===================================================================
--- branches/springie/refactoring/Springie/autohost/commands/ComTeam.cs	                        (rev 0)
+++ branches/springie/refactoring/Springie/autohost/commands/ComTeam.cs	2008-04-12 16:06:40 UTC (rev 5706)
@@ -0,0 +1,41 @@
+using Springie.SpringNamespace;
+
+namespace Springie.autohost.commands
+{
+  public class ComTeam : ComAbstractTargetsPlayer
+  {
+    protected int targetNumber;
+
+    public ComTeam(CommandHandler handler) : base(handler)
+    {
+      id = &quot;team&quot;;
+      description = &quot;changes player team&quot;;
+      config.Level = 2;
+      playernameStartIndex = 1;
+      allowEmptyArgs = false;
+      canTargetMultiple = false;
+    }
+
+    public override bool Parse(Client.TasSayEventArgs eventArgs, object[] parameters)
+    {
+      if (base.Parse(eventArgs, parameters)) {
+        if (!int.TryParse(parameters[0].ToString(), out targetNumber)) {
+          Respond(eventArgs, &quot;first parameter must be a number&quot;);
+          return false;
+        }
+        if (targetNumber &lt; 0 || targetNumber&gt;= Spring.MaxAllies) {
+          Respond(eventArgs, &quot;id number must be between 0 and {1}&quot;, Spring.MaxAllies);
+          return false;
+        }
+        return true;
+      } else return false;
+    }
+
+
+    protected override void DoCommand()
+    {
+      handler.TasClient.ForceAlly(playerNames[0], targetNumber);
+      SayBattle(&quot;Setting {0} team to {1}&quot;, playerNames[0], targetNumber);
+    }
+  }
+}
\ No newline at end of file

Added: branches/springie/refactoring/Springie/autohost/commands/Command.cs
===================================================================
--- branches/springie/refactoring/Springie/autohost/commands/Command.cs	                        (rev 0)
+++ branches/springie/refactoring/Springie/autohost/commands/Command.cs	2008-04-12 16:06:40 UTC (rev 5706)
@@ -0,0 +1,107 @@
+&#65279;using System;
+using Springie.Client;
+
+namespace Springie.autohost.commands
+{
+  public abstract class Command
+  {
+    protected readonly CommandHandler handler;
+
+    protected CommandConfig config = new CommandConfig();
+
+    protected string description = &quot;&quot;;
+    protected bool enabled;
+    protected string id = &quot;abstract&quot;;
+    protected DateTime lastExecution = DateTime.Now;
+    protected string paramDescription = &quot;&quot;;
+
+    internal Command(CommandHandler handler)
+    {
+      this.handler = handler;
+    }
+
+    public bool Enabled
+    {
+      get { return enabled; }
+      set { enabled = value; }
+    }
+
+    public CommandConfig Config
+    {
+      get { return config; }
+      set { config = value; }
+    }
+
+    public string Description
+    {
+      get { return description; }
+    }
+
+    public string Id
+    {
+      get { return id; }
+    }
+
+    public string ParamDescription
+    {
+      get { return paramDescription; }
+    }
+
+
+    public bool Parse(params object[] parameters)
+    {
+      return Parse(TasSayEventArgs.Default, parameters);
+    }
+
+    public abstract bool Parse(TasSayEventArgs eventArgs, params object[] parameters);
+
+    public bool Execute(params object[] parameters)
+    {
+      return Execute(TasSayEventArgs.Default, parameters);
+    }
+
+    public virtual bool Execute(TasSayEventArgs eventArgs, params object[] parameters)
+    {
+      if (Enabled) {
+        if (Parse(eventArgs, parameters)) {
+          int diff = (int)(DateTime.Now.Subtract(lastExecution).TotalSeconds - Config.Throttling);
+          if (diff &gt;= 0) {
+            lastExecution = DateTime.Now;
+            DoCommand();
+            return true;
+          } else {
+            Respond(eventArgs, &quot;wait {0} seconds&quot;, -diff);
+            return false;
+          }
+        } else {
+          Respond(eventArgs, &quot;usage: !{0} {1}&quot;, id, paramDescription);
+          return false;
+        }
+      } else return false;
+    }
+
+    protected void Respond(TasSayEventArgs eventArgs, string text, params object[] args)
+    {
+      AutoHost.Respond(handler.TasClient, handler.Spring, eventArgs, string.Format(text, args));
+    }
+
+
+    /// &lt;summary&gt;
+    /// Says text both in battle room and in spring
+    /// &lt;/summary&gt;
+    /// &lt;param name=&quot;text&quot;&gt;&lt;/param&gt;
+    /// &lt;param name=&quot;args&quot;&gt;&lt;/param&gt;
+    protected void SayBattle(string text, params object[] args)
+    {
+      SayBattle(true, text, args);
+    }
+
+    protected void SayBattle(bool inGame, string text, params object[] args)
+    {
+      AutoHost.SayBattle(handler.TasClient, handler.Spring, string.Format(text, args), inGame);
+    }
+
+
+    protected abstract void DoCommand();
+  }
+}
\ No newline at end of file

Added: branches/springie/refactoring/Springie/autohost/commands/CommandConfig.cs
===================================================================
--- branches/springie/refactoring/Springie/autohost/commands/CommandConfig.cs	                        (rev 0)
+++ branches/springie/refactoring/Springie/autohost/commands/CommandConfig.cs	2008-04-12 16:06:40 UTC (rev 5706)
@@ -0,0 +1,50 @@
+using System.ComponentModel;
+using Springie.Client;
+
+namespace Springie.autohost.commands
+{
+  public class CommandConfig
+  {
+    public static readonly TasSayEventArgs.Places[] ListenChannelPmBattle = new[] { TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Channel };
+    public static readonly TasSayEventArgs.Places[] ListenPmGameBattle = new[] { TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Normal, TasSayEventArgs.Places.Game };
+    public static readonly TasSayEventArgs.Places[] ListenGameBattle = new[] { TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Game };
+    public static readonly TasSayEventArgs.Places[] ListenPmBattle = new[] { TasSayEventArgs.Places.Battle, TasSayEventArgs.Places.Normal };
+
+    private int level = 1;
+    private int voteLevel = 1;
+    private TasSayEventArgs.Places[] listenTo = new[] {TasSayEventArgs.Places.Battle};
+    private int throttling = 1;
+
+    [Category(&quot;Command&quot;)]
+    [Description(&quot;Rights level. If user's rights level is higher or equal to rights level of command - user has rights to use this command.&quot;)]
+    public int Level
+    {
+      get { return level; }
+      set { level = value; }
+    }
+    [Category(&quot;Command&quot;)]
+    [Description(&quot;Rights level for voting this command.&quot;)]
+    public int VoteLevel
+    {
+      get { return voteLevel; }
+      set { voteLevel = value; }
+    }
+
+
+    [Category(&quot;Command&quot;)]
+    [Description(&quot;How often can this command be executed (in seconds). 0 = no throttling, can execute at any time.&quot;)]
+    public int Throttling
+    {
+      get { return throttling; }
+      set { throttling = value; }
+    }
+
+    [Category(&quot;Command&quot;)]
+    [Description(&quot;From which places can you use this command. Normal = PM to server, Battle = battle lobby, Game = from running game.&quot;)]
+    public TasSayEventArgs.Places[] ListenTo
+    {
+      get { return listenTo; }
+      set { listenTo = value; }
+    }
+  } ;
+}
\ No newline at end of file

Added: branches/springie/refactoring/Springie/autohost/commands/CommandHandler.cs
===================================================================
--- branches/springie/refactoring/Springie/autohost/commands/CommandHandler.cs	                        (rev 0)
+++ branches/springie/refactoring/Springie/autohost/commands/CommandHandler.cs	2008-04-12 16:06:40 UTC (rev 5706)
@@ -0,0 +1,98 @@
+&#65279;using System;
+using System.Collections.Generic;
+using System.Reflection;
+using Springie.Client;
+using Springie.SpringNamespace;
+
+namespace Springie.autohost.commands
+{
+  public class CommandHandler
+  {
+    private readonly Dictionary&lt;string, Command&gt; commandsByName = new Dictionary&lt;string, Command&gt;();
+    private readonly Dictionary&lt;Type, Command&gt; commandsByType = new Dictionary&lt;Type, Command&gt;();
+    private Dictionary&lt;string, CommandConfig&gt; configs = new Dictionary&lt;string, CommandConfig&gt;();
+    private AutoHost autoHost;
+    private Spring spring;
+    private TasClient tasClient;
+
+    private const string ConfigFile = &quot;commands.xml&quot;;
+
+
+    /// &lt;summary&gt;
+    /// Loads all existing commands in assembly into commandlist
+    /// &lt;/summary&gt;
+    public CommandHandler()
+    {
+      foreach (Type type in Assembly.GetExecutingAssembly().GetTypes()) {
+        if (type.IsClass &amp;&amp; type.IsSubclassOf(typeof(Command))) {
+          Command command = (Command)type.GetConstructor(new Type[] {typeof(CommandHandler)}).Invoke(new object[] {this});
+          commandsByName.Add(command.Id, command);
+          commandsByType.Add(type, command);
+        }
+      }
+    }
+
+
+    void LoadConfigs()
+    {
+     //TODO dodelat loading a saving 
+    }
+
+
+
+    public TasClient TasClient
+    {
+      get { return tasClient; }
+      set { tasClient = value; }
+    }
+
+    public AutoHost AutoHost
+    {
+      get { return autoHost; }
+      set { autoHost = value; }
+    }
+
+    public Spring Spring
+    {
+      get { return spring; }
+      set { spring = value; }
+    }
+
+    /// &lt;summary&gt;
+    /// Gets command
+    /// &lt;/summary&gt;
+    /// &lt;typeparam name=&quot;T&quot;&gt;type of command to get&lt;/typeparam&gt;
+    /// &lt;returns&gt;&lt;/returns&gt;
+    public T Get&lt;T&gt;() where T : Command
+    {
+      Command command;
+      if (commandsByType.TryGetValue(typeof(T), out command)) return (T)command;
+      return null;
+    }
+
+
+    public bool Execute&lt;T&gt;(params object[] arguments) where T : Command
+    {
+      return Execute&lt;T&gt;(null, arguments);
+    }
+
+    public bool Execute&lt;T&gt;(TasSayEventArgs eventArgs, params object[] arguments) where T : Command
+    {
+      return Get&lt;T&gt;().Execute(eventArgs, arguments);
+    }
+
+
+    
+    /// &lt;summary&gt;
+    /// Gets command
+    /// &lt;/summary&gt;
+    /// &lt;param name=&quot;id&quot;&gt;text id of command&lt;/param&gt;
+    /// &lt;returns&gt;&lt;/returns&gt;
+    public Command Get(string id)
+    {
+      Command command;
+      if (commandsByName.TryGetValue(id, out command)) return command;
+      else return null;
+    }
+  }
+}
\ No newline at end of file


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000490.html">[Taspring-linux-commit] r5705 - branches/springie
</A></li>
	<LI>Next message: <A HREF="000491.html">[Taspring-linux-commit] r5707 - in trunk/tools/springie: . Springie	Springie/client Springie/spring
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#494">[ date ]</a>
              <a href="thread.html#494">[ thread ]</a>
              <a href="subject.html#494">[ subject ]</a>
              <a href="author.html#494">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
