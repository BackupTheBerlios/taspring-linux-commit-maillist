<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r5693 - trunk/Lobby/TASClient
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-April/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5693%20-%20trunk/Lobby/TASClient&In-Reply-To=%3C20080410183631.5B7A346BF%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000473.html">
   <LINK REL="Next"  HREF="000475.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r5693 - trunk/Lobby/TASClient</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5693%20-%20trunk/Lobby/TASClient&In-Reply-To=%3C20080410183631.5B7A346BF%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r5693 - trunk/Lobby/TASClient">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Thu Apr 10 20:36:31 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000473.html">[Taspring-linux-commit] r5692 - trunk/rts/Sim/Path
</A></li>
        <LI>Next message: <A HREF="000475.html">[Taspring-linux-commit] r5694 - trunk/Lobby/TASClient
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#474">[ date ]</a>
              <a href="thread.html#474">[ thread ]</a>
              <a href="subject.html#474">[ subject ]</a>
              <a href="author.html#474">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: satirik
Date: 2008-04-10 20:36:29 +0200 (Thu, 10 Apr 2008)
New Revision: 5693

Removed:
   trunk/Lobby/TASClient/SevenZip.pas
Modified:
   trunk/Lobby/TASClient/! readme !.txt
   trunk/Lobby/TASClient/BattleFormUnit.dfm
   trunk/Lobby/TASClient/BattleFormUnit.pas
   trunk/Lobby/TASClient/HttpGetUnit.dfm
   trunk/Lobby/TASClient/HttpGetUnit.pas
   trunk/Lobby/TASClient/MainUnit.dfm
   trunk/Lobby/TASClient/MainUnit.pas
   trunk/Lobby/TASClient/PreferencesFormUnit.pas
   trunk/Lobby/TASClient/ReplaysUnit.dfm
   trunk/Lobby/TASClient/ReplaysUnit.pas
   trunk/Lobby/TASClient/TASClient.dof
   trunk/Lobby/TASClient/TASClient.dpr
   trunk/Lobby/TASClient/TASClient.res
Log:
- 7zip extractor changed to 7zipVCL (it may fix the autoupdate problem on some comp)
- save replays (to edit grade and comments) bug fixed
- 2splitters added to the left and the bottom of the minimap panel
- &quot;keep ratio&quot; option to the minimap context menu

Modified: trunk/Lobby/TASClient/! readme !.txt
===================================================================
--- trunk/Lobby/TASClient/! readme !.txt	2008-04-10 14:10:37 UTC (rev 5692)
+++ trunk/Lobby/TASClient/! readme !.txt	2008-04-10 18:36:29 UTC (rev 5693)
@@ -1,7 +1,9 @@
-UPDATED: 7 Sep 2007
+UPDATED: 10 Apr 2008
 
 *** In order to compile the sources, you'll have to install some free 3rd-party components: ***
 
+*** BETA : This archive should contains everything you need to compile the lobby : <A HREF="http://tasclient.it-l.eu/TASClient_SDK.7z">http://tasclient.it-l.eu/TASClient_SDK.7z</A>
+
 - TjanTracker (Included with these sources - just install janTracker.pas)
 - Virtual TreeView component: <A HREF="http://www.lischke-online.de/VirtualTreeview/">http://www.lischke-online.de/VirtualTreeview/</A>
 - TWSocket (ICS): <A HREF="http://www.overbyte.be/frame_index.html?redirTo=/ssl.html">http://www.overbyte.be/frame_index.html?redirTo=/ssl.html</A>
@@ -44,6 +46,7 @@
 - SpTBXLib 1.8.1 (<A HREF="http://club.telepolis.com/silverpointdev/sptbxlib/index.htm">http://club.telepolis.com/silverpointdev/sptbxlib/index.htm</A>)
 - Additional TBX themes (<A HREF="http://www.rmklever.com/zipfiles/TBXThemes21.zip">http://www.rmklever.com/zipfiles/TBXThemes21.zip</A>)
 - PngImage (for the macosx theme only)
+- 7zipJCL (autoupdate feature) <A HREF="http://www.rg-software.de/rg/index.php?option=com_content&amp;task=view&amp;id=29&amp;Itemid=51">http://www.rg-software.de/rg/index.php?option=com_content&amp;task=view&amp;id=29&amp;Itemid=51</A>
 
 To install these components, you should use Silverpoint MultiInstaller
 (<A HREF="http://club.telepolis.com/silverpointdev/multiinstaller/index.htm">http://club.telepolis.com/silverpointdev/multiinstaller/index.htm</A>),

Modified: trunk/Lobby/TASClient/BattleFormUnit.dfm
===================================================================
--- trunk/Lobby/TASClient/BattleFormUnit.dfm	2008-04-10 14:10:37 UTC (rev 5692)
+++ trunk/Lobby/TASClient/BattleFormUnit.dfm	2008-04-10 18:36:29 UTC (rev 5693)
@@ -1,8 +1,8 @@
 object BattleForm: TBattleForm
-  Left = 1180
-  Top = 182
-  Width = 758
-  Height = 548
+  Left = 820
+  Top = 287
+  Width = 767
+  Height = 601
   Caption = 'Battle window'
   Color = clBtnFace
   Constraints.MaxHeight = 1000
@@ -24,23 +24,33 @@
   object SpTBXTitleBar1: TSpTBXTitleBar
     Left = 0
     Top = 0
-    Width = 750
-    Height = 521
+    Width = 759
+    Height = 574
     Caption = 'Battle window'
     object Splitter1: TSplitter
       Left = 4
-      Top = 401
-      Width = 742
+      Top = 413
+      Width = 751
       Height = 3
       Cursor = crVSplit
       Align = alTop
       AutoSnap = False
       ResizeStyle = rsUpdate
     end
+    object Splitter2: TSplitter
+      Left = 4
+      Top = 305
+      Width = 751
+      Height = 3
+      Cursor = crVSplit
+      Align = alTop
+      AutoSnap = False
+      ResizeStyle = rsUpdate
+    end
     object Panel3: TSpTBXPanel
       Left = 4
-      Top = 476
-      Width = 742
+      Top = 529
+      Width = 751
       Height = 41
       Align = alBottom
       Color = clNone
@@ -49,7 +59,7 @@
       BorderType = pbrRaised
       TBXStyleBackground = True
       DesignSize = (
-        742
+        751
         41)
       object StartButton: TSpTBXButton
         Left = 104
@@ -143,7 +153,7 @@
         LinkFont.Style = [fsUnderline]
       end
       object LadderRulesButton: TSpTBXButton
-        Left = 656
+        Left = 665
         Top = 8
         Width = 75
         Height = 25
@@ -177,9 +187,9 @@
     end
     object Panel2: TPanel
       Left = 4
-      Top = 404
-      Width = 742
-      Height = 72
+      Top = 416
+      Width = 751
+      Height = 113
       Align = alClient
       TabOrder = 2
       object NoMapImage: TImage
@@ -3970,311 +3980,756 @@
     object Panel1: TPanel
       Left = 4
       Top = 30
-      Width = 742
-      Height = 371
+      Width = 751
+      Height = 275
       Align = alTop
       TabOrder = 3
-      DesignSize = (
-        742
-        371)
-      object MyOptionsGroupBox: TSpTBXGroupBox
-        Left = 498
-        Top = 269
-        Width = 242
-        Height = 92
-        Caption = 'My options'
-        Anchors = [akTop, akRight]
-        Color = clNone
-        ParentColor = False
+      object Splitter3: TSplitter
+        Left = 337
+        Top = 1
+        Width = 4
+        Height = 273
+        AutoSnap = False
+        ResizeStyle = rsUpdate
+      end
+      object Panel5: TPanel
+        Left = 341
+        Top = 1
+        Width = 409
+        Height = 273
+        Align = alClient
+        BevelOuter = bvNone
         TabOrder = 0
-        TBXStyleBackground = True
-        object Label11: TSpTBXLabel
-          Left = 16
-          Top = 20
-          Width = 32
-          Height = 13
-          Caption = 'My Id :'
-          LinkFont.Charset = DEFAULT_CHARSET
-          LinkFont.Color = clBlue
-          LinkFont.Height = -11
-          LinkFont.Name = 'MS Sans Serif'
-          LinkFont.Style = [fsUnderline]
+        object SpTBXTabControl1: TSpTBXTabControl
+          Left = 0
+          Top = 0
+          Width = 409
+          Height = 273
+          Align = alClient
+          Color = clBtnFace
+          ActiveTabIndex = 0
+          OnActiveTabChange = SpTBXTabControl1ActiveTabChange
+          HiddenItems = &lt;&gt;
+          object GameOptionsTab: TSpTBXTabItem
+            Caption = 'Game options'
+            Checked = True
+          end
+          object DisabledUnitsTab: TSpTBXTabItem
+            Caption = 'Disabled Units (0)'
+          end
+          object MapTab: TSpTBXTabItem
+            Caption = 'Map options'
+          end
+          object ModTab: TSpTBXTabItem
+            Caption = 'Mod options'
+          end
+          object ModTabSheet: TSpTBXTabSheet
+            Left = 0
+            Top = 23
+            Width = 409
+            Height = 250
+            Caption = 'Mod options'
+            ImageIndex = -1
+            DesignSize = (
+              409
+              250)
+            TabItem = 'ModTab'
+            object ModOptionsScrollBox: TTntScrollBox
+              Left = 2
+              Top = 48
+              Width = 401
+              Height = 200
+              VertScrollBar.Smooth = True
+              VertScrollBar.Tracking = True
+              Anchors = [akLeft, akTop, akRight, akBottom]
+              BiDiMode = bdLeftToRight
+              BorderStyle = bsNone
+              Color = clBtnFace
+              Ctl3D = False
+              ParentBiDiMode = False
+              ParentBackground = True
+              ParentColor = False
+              ParentCtl3D = False
+              TabOrder = 0
+            end
+            object panelModOptionsDefault: TSpTBXPanel
+              Left = 5
+              Top = 4
+              Width = 381
+              Height = 41
+              Align = alCustom
+              TabOrder = 1
+              object btLoadDefaultMDO: TSpTBXButton
+                Left = 136
+                Top = 8
+                Width = 113
+                Height = 25
+                Caption = 'Load default'
+                TabOrder = 0
+                OnClick = btLoadDefaultMDOClick
+                LinkFont.Charset = DEFAULT_CHARSET
+                LinkFont.Color = clBlue
+                LinkFont.Height = -11
+                LinkFont.Name = 'MS Sans Serif'
+                LinkFont.Style = [fsUnderline]
+              end
+              object btSetAsDefaultMDO: TSpTBXButton
+                Left = 256
+                Top = 8
+                Width = 113
+                Height = 25
+                Caption = 'Set as default'
+                TabOrder = 1
+                OnClick = btSetAsDefaultMDOClick
+                LinkFont.Charset = DEFAULT_CHARSET
+                LinkFont.Color = clBlue
+                LinkFont.Height = -11
+                LinkFont.Name = 'MS Sans Serif'
+                LinkFont.Style = [fsUnderline]
+              end
+              object btLoadModsDefaultMDO: TSpTBXButton
+                Left = 16
+                Top = 8
+                Width = 113
+                Height = 25
+                Caption = 'Load mod'#39's default'
+                TabOrder = 2
+                OnClick = btLoadModsDefaultMDOClick
+                LinkFont.Charset = DEFAULT_CHARSET
+                LinkFont.Color = clBlue
+                LinkFont.Height = -11
+                LinkFont.Name = 'MS Sans Serif'
+                LinkFont.Style = [fsUnderline]
+              end
+            end
+          end
+          object MapTabSheet: TSpTBXTabSheet
+            Left = 0
+            Top = 23
+            Width = 409
+            Height = 250
+            Caption = 'Map options'
+            ImageIndex = -1
+            DesignSize = (
+              409
+              250)
+            TabItem = 'MapTab'
+            object MapOptionsScrollBox: TTntScrollBox
+              Left = 2
+              Top = 48
+              Width = 404
+              Height = 200
+              VertScrollBar.Smooth = True
+              VertScrollBar.Tracking = True
+              Anchors = [akLeft, akTop, akRight, akBottom]
+              BiDiMode = bdLeftToRight
+              BorderStyle = bsNone
+              Color = clBtnFace
+              Ctl3D = False
+              ParentBiDiMode = False
+              ParentBackground = True
+              ParentColor = False
+              ParentCtl3D = False
+              TabOrder = 0
+            end
+            object panelMapOptionsDefault: TSpTBXPanel
+              Left = 5
+              Top = 4
+              Width = 382
+              Height = 41
+              Align = alCustom
+              TabOrder = 1
+              object btLoadDefaultMPO: TSpTBXButton
+                Left = 136
+                Top = 8
+                Width = 113
+                Height = 25
+                Caption = 'Load default'
+                TabOrder = 0
+                OnClick = btLoadDefaultMPOClick
+                LinkFont.Charset = DEFAULT_CHARSET
+                LinkFont.Color = clBlue
+                LinkFont.Height = -11
+                LinkFont.Name = 'MS Sans Serif'
+                LinkFont.Style = [fsUnderline]
+              end
+              object btSetAsDefaultMPO: TSpTBXButton
+                Left = 256
+                Top = 8
+                Width = 113
+                Height = 25
+                Caption = 'Set as default'
+                TabOrder = 1
+                OnClick = btSetAsDefaultMPOClick
+                LinkFont.Charset = DEFAULT_CHARSET
+                LinkFont.Color = clBlue
+                LinkFont.Height = -11
+                LinkFont.Name = 'MS Sans Serif'
+                LinkFont.Style = [fsUnderline]
+              end
+              object btLoadMapsDefaultMPO: TSpTBXButton
+                Left = 16
+                Top = 8
+                Width = 113
+                Height = 25
+                Caption = 'Load map'#39's default'
+                TabOrder = 2
+                OnClick = btLoadMapsDefaultMPOClick
+                LinkFont.Charset = DEFAULT_CHARSET
+                LinkFont.Color = clBlue
+                LinkFont.Height = -11
+                LinkFont.Name = 'MS Sans Serif'
+                LinkFont.Style = [fsUnderline]
+              end
+            end
+          end
+          object SpTBXTabSheet1: TSpTBXTabSheet
+            Left = 0
+            Top = 23
+            Width = 409
+            Height = 250
+            Caption = 'Disabled Units (0)'
+            ImageIndex = -1
+            DesignSize = (
+              409
+              250)
+            TabItem = 'DisabledUnitsTab'
+            object UnitsGroupBox: TSpTBXGroupBox
+              Left = 8
+              Top = 4
+              Width = 249
+              Height = 237
+              Caption = 'Disabled units'
+              Anchors = [akLeft, akTop, akBottom]
+              Color = clNone
+              ParentColor = False
+              TabOrder = 0
+              DesignSize = (
+                249
+                237)
+              object AddUnitsSpeedButton: TSpeedButton
+                Left = 120
+                Top = 10
+                Width = 121
+                Height = 22
+                Caption = 'Add more units'
+                OnClick = AddUnitsSpeedButtonClick
+              end
+              object DisabledUnitsListBox: TListBox
+                Left = 8
+                Top = 32
+                Width = 233
+                Height = 193
+                Anchors = [akLeft, akTop, akBottom]
+                Font.Charset = DEFAULT_CHARSET
+                Font.Color = clWindowText
+                Font.Height = -11
+                Font.Name = 'Fixedsys'
+                Font.Style = []
+                ItemHeight = 15
+                MultiSelect = True
+                ParentFont = False
+                TabOrder = 0
+              end
+            end
+          end
+          object SpTBXTabSheet2: TSpTBXTabSheet
+            Left = 0
+            Top = 23
+            Width = 409
+            Height = 250
+            Caption = 'Game options'
+            ImageIndex = -1
+            TabItem = 'GameOptionsTab'
+            object LimitDGunCheckBox: TSpTBXCheckBox
+              Left = 16
+              Top = 152
+              Width = 128
+              Height = 15
+              Hint = 
+                'If checked, commanders will be able to use D-gun only within a c' +
+                'ertain radius from their start position'
+              Caption = 'Limit D-Gun to start pos'
+              ParentShowHint = False
+              ShowHint = True
+              TabOrder = 0
+              OnClick = LimitDGunCheckBoxClick
+            end
+            object GhostedBuildingsCheckBox: TSpTBXCheckBox
+              Left = 16
+              Top = 168
+              Width = 102
+              Height = 15
+              Hint = 
+                'If checked, players will be able to see &quot;ghosted&quot; buildings once' +
+                ' they get out of LOS'
+              Caption = 'Ghosted buildings'
+              ParentShowHint = False
+              ShowHint = True
+              TabOrder = 1
+              OnClick = GhostedBuildingsCheckBoxClick
+              Checked = True
+              State = cbChecked
+            end
+            object DiminishingMMsCheckBox: TSpTBXCheckBox
+              Left = 16
+              Top = 184
+              Width = 166
+              Height = 15
+              Hint = 
+                'If checked, efficiency of metal makers will decrease when the nu' +
+                'mber of them increases'
+              Caption = 'Diminishing metal maker returns'
+              ParentShowHint = False
+              ShowHint = True
+              TabOrder = 2
+              OnClick = DiminishingMMsCheckBoxClick
+            end
+            object LockGameSpeedCheckBox: TSpTBXCheckBox
+              Left = 16
+              Top = 200
+              Width = 103
+              Height = 15
+              Caption = 'Lock game speed'
+              TabOrder = 3
+              OnClick = LockGameSpeedCheckBoxClick
+            end
+            object ResourcesGroupBox: TSpTBXGroupBox
+              Left = 248
+              Top = 8
+              Width = 137
+              Height = 209
+              Caption = 'Resources'
+              Color = clNone
+              ParentColor = False
+              TabOrder = 5
+              object Label8: TSpTBXLabel
+                Left = 52
+                Top = 189
+                Width = 33
+                Height = 13
+                Cursor = crHandPoint
+                Caption = 'Energy'
+                Font.Charset = DEFAULT_CHARSET
+                Font.Color = clHotLight
+                Font.Height = -11
+                Font.Name = 'MS Sans Serif'
+                Font.Style = [fsUnderline]
+                ParentFont = False
+                OnClick = Label8Click
+                LinkFont.Charset = DEFAULT_CHARSET
+                LinkFont.Color = clBlue
+                LinkFont.Height = -11
+                LinkFont.Name = 'MS Sans Serif'
+                LinkFont.Style = [fsUnderline]
+              end
+              object Label9: TSpTBXLabel
+                Left = 15
+                Top = 189
+                Width = 26
+                Height = 13
+                Cursor = crHandPoint
+                Caption = 'Metal'
+                Font.Charset = DEFAULT_CHARSET
+                Font.Color = clHotLight
+                Font.Height = -11
+                Font.Name = 'MS Sans Serif'
+                Font.Style = [fsUnderline]
+                ParentFont = False
+                OnClick = Label9Click
+                LinkFont.Charset = DEFAULT_CHARSET
+                LinkFont.Color = clBlue
+                LinkFont.Height = -11
+                LinkFont.Name = 'MS Sans Serif'
+                LinkFont.Style = [fsUnderline]
+              end
+              object Label10: TSpTBXLabel
+                Left = 96
+                Top = 189
+                Width = 24
+                Height = 13
+                Cursor = crHandPoint
+                Caption = 'Units'
+                Font.Charset = DEFAULT_CHARSET
+                Font.Color = clHotLight
+                Font.Height = -11
+                Font.Name = 'MS Sans Serif'
+                Font.Style = [fsUnderline]
+                ParentFont = False
+                OnClick = Label10Click
+                LinkFont.Charset = DEFAULT_CHARSET
+                LinkFont.Color = clBlue
+                LinkFont.Height = -11
+                LinkFont.Name = 'MS Sans Serif'
+                LinkFont.Style = [fsUnderline]
+              end
+              object MetalTracker: TSpTBXjanTracker
+                Left = 10
+                Top = 16
+                Width = 39
+                Height = 171
+                ThemeType = thtWindows
+                Minimum = 0
+                Maximum = 10000
+                Value = 1000
+                Orientation = jtbVertical
+                BackColor = clBtnFace
+                BackBorder = False
+                TrackColor = clGray
+                TrackPositionColor = False
+                TrackBorder = True
+                BorderColor = clBlack
+                ThumbColor = clSilver
+                ThumbBorder = False
+                ThumbWidth = 40
+                ThumbHeight = 16
+                TrackHeight = 6
+                ShowCaption = True
+                CaptionColor = clBlack
+                CaptionBold = False
+                OnMouseUpAfterChange = MetalTrackerMouseUpAfterChange
+              end
+              object EnergyTracker: TSpTBXjanTracker
+                Left = 50
+                Top = 16
+                Width = 39
+                Height = 171
+                ThemeType = thtWindows
+                Minimum = 0
+                Maximum = 10000
+                Value = 1000
+                Orientation = jtbVertical
+                BackColor = clBtnFace
+                BackBorder = False
+                TrackColor = clGray
+                TrackPositionColor = False
+                TrackBorder = True
+                BorderColor = clBlack
+                ThumbColor = clSilver
+                ThumbBorder = False
+                ThumbWidth = 40
+                ThumbHeight = 16
+                TrackHeight = 6
+                ShowCaption = True
+                CaptionColor = clBlack
+                CaptionBold = False
+                OnMouseUpAfterChange = EnergyTrackerMouseUpAfterChange
+              end
+              object UnitsTracker: TSpTBXjanTracker
+                Left = 90
+                Top = 16
+                Width = 39
+                Height = 171
+                ThemeType = thtWindows
+                Minimum = 10
+                Maximum = 5000
+                Value = 1000
+                Orientation = jtbVertical
+                BackColor = clBtnFace
+                BackBorder = False
+                TrackColor = clGray
+                TrackPositionColor = False
+                TrackBorder = True
+                BorderColor = clBlack
+                ThumbColor = clSilver
+                ThumbBorder = False
+                ThumbWidth = 40
+                ThumbHeight = 16
+                TrackHeight = 6
+                ShowCaption = True
+                CaptionColor = clBlack
+                CaptionBold = False
+                OnMouseUpAfterChange = UnitsTrackerMouseUpAfterChange
+              end
+            end
+            object GameEndRadioGroup: TSpTBXRadioGroup
+              Left = 16
+              Top = 80
+              Width = 225
+              Height = 65
+              Caption = 'Game end condition'
+              Color = clNone
+              ParentColor = False
+              TabOrder = 6
+              OnClick = GameEndRadioGroupClick
+              ItemIndex = 0
+              Items.Strings = (
+                'Game continues if commander dies'
+                'Game ends if commander dies'
+                'Lineage mode')
+            end
+            object StartPosRadioGroup: TSpTBXRadioGroup
+              Left = 16
+              Top = 8
+              Width = 129
+              Height = 69
+              Caption = 'Start position'
+              Color = clNone
+              ParentColor = False
+              TabOrder = 7
+              OnClick = StartPosRadioGroupClick
+              ItemIndex = 2
+              Items.Strings = (
+                'Fixed'
+                'Random'
+                'Choose in game')
+            end
+            object LoadDefaultButton: TSpTBXButton
+              Left = 160
+              Top = 16
+              Width = 81
+              Height = 25
+              Caption = 'Load default'
+              TabOrder = 4
+              OnClick = LoadDefaultButtonClick
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object SetDefaultButton: TSpTBXButton
+              Left = 160
+              Top = 48
+              Width = 81
+              Height = 25
+              Caption = 'Set as default'
+              TabOrder = 8
+              OnClick = SetDefaultButtonClick
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+          end
         end
-        object Label12: TSpTBXLabel
-          Left = 16
-          Top = 44
-          Width = 43
-          Height = 13
-          Caption = 'My team:'
-          LinkFont.Charset = DEFAULT_CHARSET
-          LinkFont.Color = clBlue
-          LinkFont.Height = -11
-          LinkFont.Name = 'MS Sans Serif'
-          LinkFont.Style = [fsUnderline]
-        end
-        object TeamColorSpeedButton: TSpTBXSpeedButton
-          Left = 120
-          Top = 41
-          Width = 113
-          Height = 22
-          Caption = 'Team color'
-          OnClick = TeamColorSpeedButtonClick
-          Images = MainForm.ColorImageList
-          LinkFont.Charset = DEFAULT_CHARSET
-          LinkFont.Color = clBlue
-          LinkFont.Height = -11
-          LinkFont.Name = 'MS Sans Serif'
-          LinkFont.Style = [fsUnderline]
-        end
-        object SpectateCheckBox: TSpTBXCheckBox
-          Left = 16
-          Top = 70
-          Width = 70
-          Height = 15
-          Caption = 'Spectate'
-          Font.Charset = DEFAULT_CHARSET
-          Font.Color = clWindowText
-          Font.Height = -11
-          Font.Name = 'MS Sans Serif'
-          Font.Style = [fsBold]
-          ParentFont = False
-          TabOrder = 0
-          OnClick = SpectateCheckBoxClick
-        end
-        object MyTeamNoButton: TTBXButton
-          Left = 64
-          Top = 18
-          Width = 41
-          Height = 20
-          Hint = 
-            'Your team number. Players with the same team number will share s' +
-            'ame commander.'
-          AutoSize = False
-          Caption = '1'
-          Images = MainForm.MiscImageList
-          Layout = blGlyphRight
-          ParentShowHint = False
-          ShowHint = True
-          TabOrder = 1
-          OnClick = MyTeamNoButtonClick
-        end
-        object MyAllyNoButton: TTBXButton
-          Left = 64
-          Top = 42
-          Width = 41
-          Height = 20
-          Hint = 
-            'Your ally number. Players with same ally number will share map v' +
-            'isibility and resources (if they choose to)'
-          AutoSize = False
-          Caption = '1'
-          Images = MainForm.MiscImageList
-          Layout = blGlyphRight
-          ParentShowHint = False
-          ShowHint = True
-          TabOrder = 2
-          OnClick = MyAllyNoButtonClick
-        end
-        object MySideButton: TSpTBXSpeedButton
-          Left = 120
-          Top = 17
-          Width = 113
-          Height = 22
-          Caption = 'Side'
-          OnClick = MySideButtonClick
-          LinkFont.Charset = DEFAULT_CHARSET
-          LinkFont.Color = clBlue
-          LinkFont.Height = -11
-          LinkFont.Name = 'MS Sans Serif'
-          LinkFont.Style = [fsUnderline]
-        end
       end
-      object MapPanel: TSpTBXPanel
-        Left = 8
-        Top = 8
-        Width = 329
-        Height = 257
-        Color = clNone
-        ParentColor = False
+      object Panel6: TPanel
+        Left = 1
+        Top = 1
+        Width = 336
+        Height = 273
+        Align = alLeft
+        BevelOuter = bvNone
+        Constraints.MinWidth = 200
         TabOrder = 1
-        OnMouseMove = MapPanelMouseMove
-        TBXStyleBackground = True
-        object Bevel2: TBevel
-          Left = 0
-          Top = 203
+        DesignSize = (
+          336
+          273)
+        object MapPanel: TSpTBXPanel
+          Left = 7
+          Top = 8
           Width = 329
-          Height = 46
-          Shape = bsTopLine
-        end
-        object MapImage: TImageEx
-          Left = 1
-          Top = 1
-          Width = 200
-          Height = 200
-          Cursor = crHandPoint
-          Hint = 'No map'
-          ParentShowHint = False
-          PopupMenu = AutoStartRectsPopupMenu
-          ShowHint = True
-          Stretch = True
-          OnMouseDown = MapImageMouseDown
-          OnMouseMove = MapImageMouseMove
-          OnMouseUp = MapImageMouseUp
-        end
-        object MapDescLabel: TSpTBXLabel
-          Left = 8
-          Top = 208
-          Width = 313
-          Height = 41
-          Caption = 'MapDescLabel'
-          AutoSize = False
-          ParentShowHint = False
-          ShowHint = True
-          Wrapping = twWrap
-          OnMouseMove = MapDescLabelMouseMove
-          LinkFont.Charset = DEFAULT_CHARSET
-          LinkFont.Color = clBlue
-          LinkFont.Height = -11
-          LinkFont.Name = 'MS Sans Serif'
-          LinkFont.Style = [fsUnderline]
-        end
-        object TidalStrengthLabel: TSpTBXLabel
-          Left = 216
-          Top = 123
-          Width = 76
-          Height = 13
-          Caption = 'Tidal strength: ?'
-          LinkFont.Charset = DEFAULT_CHARSET
-          LinkFont.Color = clBlue
-          LinkFont.Height = -11
-          LinkFont.Name = 'MS Sans Serif'
-          LinkFont.Style = [fsUnderline]
-        end
-        object GravityLabel: TSpTBXLabel
-          Left = 216
-          Top = 138
-          Width = 45
-          Height = 13
-          Caption = 'Gravity: ?'
-          LinkFont.Charset = DEFAULT_CHARSET
-          LinkFont.Color = clBlue
-          LinkFont.Height = -11
-          LinkFont.Name = 'MS Sans Serif'
-          LinkFont.Style = [fsUnderline]
-        end
-        object MaxMetalLabel: TSpTBXLabel
-          Left = 216
-          Top = 153
-          Width = 63
-          Height = 13
-          Caption = 'Max. metal: ?'
-          LinkFont.Charset = DEFAULT_CHARSET
-          LinkFont.Color = clBlue
-          LinkFont.Height = -11
-          LinkFont.Name = 'MS Sans Serif'
-          LinkFont.Style = [fsUnderline]
-        end
-        object ExtRadiusLabel: TSpTBXLabel
-          Left = 216
-          Top = 168
-          Width = 85
-          Height = 13
-          Caption = 'Extractor radius: ?'
-          LinkFont.Charset = DEFAULT_CHARSET
-          LinkFont.Color = clBlue
-          LinkFont.Height = -11
-          LinkFont.Name = 'MS Sans Serif'
-          LinkFont.Style = [fsUnderline]
-        end
-        object WindLabel: TSpTBXLabel
-          Left = 216
-          Top = 183
-          Width = 86
-          Height = 13
-          Caption = 'Wind (min/max): ?'
-          LinkFont.Charset = DEFAULT_CHARSET
-          LinkFont.Color = clBlue
-          LinkFont.Height = -11
-          LinkFont.Name = 'MS Sans Serif'
-          LinkFont.Style = [fsUnderline]
-        end
-        object SpTBXPanel1: TSpTBXPanel
-          Left = 208
-          Top = 4
-          Width = 113
-          Height = 97
-          Caption = 'SpTBXPanel1'
+          Height = 257
+          Anchors = [akLeft, akTop, akRight, akBottom]
           Color = clNone
           ParentColor = False
-          TabOrder = 5
+          TabOrder = 0
+          OnMouseMove = MapPanelMouseMove
+          OnResize = MapPanelResize
           TBXStyleBackground = True
-          object Bevel1: TBevel
-            Left = 8
-            Top = 48
-            Width = 97
-            Height = 33
+          DesignSize = (
+            329
+            257)
+          object Bevel2: TBevel
+            Left = 0
+            Top = 203
+            Width = 329
+            Height = 46
+            Anchors = [akLeft, akRight, akBottom]
             Shape = bsTopLine
           end
-          object MapsButton: TTBXButton
-            Left = 8
-            Top = 7
-            Width = 97
-            Height = 17
-            BorderSize = 2
-            Caption = 'More maps ...'
-            DropDownCombo = True
-            DropDownMenu = MapsPopupMenu
-            TabOrder = 0
-            OnClick = MapsButtonClick
+          object MapImage: TImageEx
+            Left = 5
+            Top = 5
+            Width = 200
+            Height = 200
+            Cursor = crHandPoint
+            Hint = 'No map'
+            Anchors = [akLeft, akTop, akRight, akBottom]
+            ParentShowHint = False
+            PopupMenu = AutoStartRectsPopupMenu
+            ShowHint = True
+            Stretch = True
+            OnMouseDown = MapImageMouseDown
+            OnMouseMove = MapImageMouseMove
+            OnMouseUp = MapImageMouseUp
           end
-          object ReloadMapListButton: TTBXButton
+          object MapDescLabel: TSpTBXLabel
             Left = 8
-            Top = 27
-            Width = 97
-            Height = 17
-            BorderSize = 2
-            Caption = 'Reload map list'
-            TabOrder = 1
-            OnClick = ReloadMapListButtonClick
+            Top = 208
+            Width = 313
+            Height = 41
+            Caption = 'MapDescLabel'
+            Anchors = [akLeft, akRight, akBottom]
+            AutoSize = False
+            ParentShowHint = False
+            ShowHint = True
+            Wrapping = twWrap
+            OnMouseMove = MapDescLabelMouseMove
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
           end
-          object TBXButton1: TTBXButton
-            Left = 8
-            Top = 54
-            Width = 97
-            Height = 17
-            BorderSize = 2
-            Caption = 'Online maps ...'
-            TabOrder = 2
-            OnClick = TBXButton1Click
+          object TidalStrengthLabel: TSpTBXLabel
+            Left = 216
+            Top = 123
+            Width = 76
+            Height = 13
+            Caption = 'Tidal strength: ?'
+            Anchors = [akTop, akRight]
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
           end
-          object TBXButton2: TTBXButton
-            Left = 8
-            Top = 74
-            Width = 97
-            Height = 17
-            BorderSize = 2
-            Caption = 'Online mods ...'
-            TabOrder = 3
-            OnClick = TBXButton2Click
+          object GravityLabel: TSpTBXLabel
+            Left = 216
+            Top = 138
+            Width = 45
+            Height = 13
+            Caption = 'Gravity: ?'
+            Anchors = [akTop, akRight]
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
           end
+          object MaxMetalLabel: TSpTBXLabel
+            Left = 216
+            Top = 153
+            Width = 63
+            Height = 13
+            Caption = 'Max. metal: ?'
+            Anchors = [akTop, akRight]
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
+          end
+          object ExtRadiusLabel: TSpTBXLabel
+            Left = 216
+            Top = 168
+            Width = 85
+            Height = 13
+            Caption = 'Extractor radius: ?'
+            Anchors = [akTop, akRight]
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
+          end
+          object WindLabel: TSpTBXLabel
+            Left = 216
+            Top = 183
+            Width = 86
+            Height = 13
+            Caption = 'Wind (min/max): ?'
+            Anchors = [akTop, akRight]
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
+          end
+          object SpTBXPanel1: TSpTBXPanel
+            Left = 208
+            Top = 4
+            Width = 113
+            Height = 97
+            Caption = 'SpTBXPanel1'
+            Anchors = [akTop, akRight]
+            Color = clNone
+            ParentColor = False
+            TabOrder = 5
+            TBXStyleBackground = True
+            object Bevel1: TBevel
+              Left = 8
+              Top = 48
+              Width = 97
+              Height = 33
+              Shape = bsTopLine
+            end
+            object MapsButton: TTBXButton
+              Left = 8
+              Top = 7
+              Width = 97
+              Height = 17
+              BorderSize = 2
+              Caption = 'More maps ...'
+              DropDownCombo = True
+              DropDownMenu = MapsPopupMenu
+              TabOrder = 0
+              OnClick = MapsButtonClick
+            end
+            object ReloadMapListButton: TTBXButton
+              Left = 8
+              Top = 27
+              Width = 97
+              Height = 17
+              BorderSize = 2
+              Caption = 'Reload map list'
+              TabOrder = 1
+              OnClick = ReloadMapListButtonClick
+            end
+            object TBXButton1: TTBXButton
+              Left = 8
+              Top = 54
+              Width = 97
+              Height = 17
+              BorderSize = 2
+              Caption = 'Online maps ...'
+              TabOrder = 2
+              OnClick = TBXButton1Click
+            end
+            object TBXButton2: TTBXButton
+              Left = 8
+              Top = 74
+              Width = 97
+              Height = 17
+              BorderSize = 2
+              Caption = 'Online mods ...'
+              TabOrder = 3
+              OnClick = TBXButton2Click
+            end
+          end
+          object MapSizeLabel: TSpTBXLabel
+            Left = 216
+            Top = 108
+            Width = 54
+            Height = 13
+            Caption = 'Map size: ?'
+            Anchors = [akTop, akRight]
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
+          end
         end
-        object MapSizeLabel: TSpTBXLabel
-          Left = 216
-          Top = 108
-          Width = 54
-          Height = 13
-          Caption = 'Map size: ?'
-          LinkFont.Charset = DEFAULT_CHARSET
-          LinkFont.Color = clBlue
-          LinkFont.Height = -11
-          LinkFont.Name = 'MS Sans Serif'
-          LinkFont.Style = [fsUnderline]
-        end
       end
+    end
+    object Panel4: TPanel
+      Left = 4
+      Top = 308
+      Width = 751
+      Height = 105
+      Align = alTop
+      TabOrder = 4
+      DesignSize = (
+        751
+        105)
       object VDTBattleClients: TVirtualDrawTree
         Left = 8
-        Top = 272
-        Width = 433
+        Top = 6
+        Width = 448
         Height = 91
         Anchors = [akLeft, akTop, akRight, akBottom]
         Font.Charset = DEFAULT_CHARSET
@@ -4294,7 +4749,7 @@
         ParentFont = False
         ParentShowHint = False
         ShowHint = True
-        TabOrder = 2
+        TabOrder = 0
         TreeOptions.PaintOptions = [toHideFocusRect, toShowButtons, toShowDropmark, toThemeAware, toUseBlendedImages]
         TreeOptions.SelectionOptions = [toFullRowSelect, toRightClickSelect]
         OnDblClick = VDTBattleClientsDblClick
@@ -4360,506 +4815,122 @@
             WideText = 'Order'
           end&gt;
       end
-      object SpTBXTabControl1: TSpTBXTabControl
-        Left = 344
-        Top = 8
-        Width = 393
-        Height = 257
-        Anchors = [akLeft, akTop, akRight]
-        Color = clBtnFace
-        ActiveTabIndex = 2
-        OnActiveTabChange = SpTBXTabControl1ActiveTabChange
-        HiddenItems = &lt;&gt;
-        object GameOptionsTab: TSpTBXTabItem
-          Caption = 'Game options'
+      object MyOptionsGroupBox: TSpTBXGroupBox
+        Left = 501
+        Top = 5
+        Width = 242
+        Height = 92
+        Caption = 'My options'
+        Anchors = [akTop, akRight]
+        Color = clNone
+        ParentColor = False
+        TabOrder = 1
+        TBXStyleBackground = True
+        object Label11: TSpTBXLabel
+          Left = 16
+          Top = 20
+          Width = 32
+          Height = 13
+          Caption = 'My Id :'
+          LinkFont.Charset = DEFAULT_CHARSET
+          LinkFont.Color = clBlue
+          LinkFont.Height = -11
+          LinkFont.Name = 'MS Sans Serif'
+          LinkFont.Style = [fsUnderline]
         end
-        object DisabledUnitsTab: TSpTBXTabItem
-          Caption = 'Disabled Units (0)'
+        object Label12: TSpTBXLabel
+          Left = 16
+          Top = 44
+          Width = 43
+          Height = 13
+          Caption = 'My team:'
+          LinkFont.Charset = DEFAULT_CHARSET
+          LinkFont.Color = clBlue
+          LinkFont.Height = -11
+          LinkFont.Name = 'MS Sans Serif'
+          LinkFont.Style = [fsUnderline]
         end
-        object MapTab: TSpTBXTabItem
-          Caption = 'Map options'
-          Checked = True
+        object TeamColorSpeedButton: TSpTBXSpeedButton
+          Left = 120
+          Top = 41
+          Width = 113
+          Height = 22
+          Caption = 'Team color'
+          OnClick = TeamColorSpeedButtonClick
+          Images = MainForm.ColorImageList
+          LinkFont.Charset = DEFAULT_CHARSET
+          LinkFont.Color = clBlue
+          LinkFont.Height = -11
+          LinkFont.Name = 'MS Sans Serif'
+          LinkFont.Style = [fsUnderline]
         end
-        object ModTab: TSpTBXTabItem
-          Caption = 'Mod options'
+        object SpectateCheckBox: TSpTBXCheckBox
+          Left = 16
+          Top = 70
+          Width = 70
+          Height = 15
+          Caption = 'Spectate'
+          Font.Charset = DEFAULT_CHARSET
+          Font.Color = clWindowText
+          Font.Height = -11
+          Font.Name = 'MS Sans Serif'
+          Font.Style = [fsBold]
+          ParentFont = False
+          TabOrder = 0
+          OnClick = SpectateCheckBoxClick
         end
-        object SpTBXTabSheet1: TSpTBXTabSheet
-          Left = 0
-          Top = 23
-          Width = 393
-          Height = 234
-          Caption = 'Disabled Units (0)'
-          ImageIndex = -1
-          TabItem = 'DisabledUnitsTab'
-          object UnitsGroupBox: TSpTBXGroupBox
-            Left = 8
-            Top = 4
-            Width = 249
-            Height = 217
-            Caption = 'Disabled units'
-            Color = clNone
-            ParentColor = False
-            TabOrder = 0
-            object AddUnitsSpeedButton: TSpeedButton
-              Left = 120
-              Top = 10
-              Width = 121
-              Height = 22
-              Caption = 'Add more units'
-              OnClick = AddUnitsSpeedButtonClick
-            end
-            object DisabledUnitsListBox: TListBox
-              Left = 8
-              Top = 32
-              Width = 233
-              Height = 177
-              Font.Charset = DEFAULT_CHARSET
-              Font.Color = clWindowText
-              Font.Height = -11
-              Font.Name = 'Fixedsys'
-              Font.Style = []
-              ItemHeight = 15
-              MultiSelect = True
-              ParentFont = False
-              TabOrder = 0
-            end
-          end
+        object MyTeamNoButton: TTBXButton
+          Left = 64
+          Top = 18
+          Width = 41
+          Height = 20
+          Hint = 
+            'Your team number. Players with the same team number will share s' +
+            'ame commander.'
+          AutoSize = False
+          Caption = '1'
+          Images = MainForm.MiscImageList
+          Layout = blGlyphRight
+          ParentShowHint = False
+          ShowHint = True
+          TabOrder = 1
+          OnClick = MyTeamNoButtonClick
         end
-        object ModTabSheet: TSpTBXTabSheet
-          Left = 0
-          Top = 23
-          Width = 393
-          Height = 234
-          Caption = 'Mod options'
-          ImageIndex = -1
-          DesignSize = (
-            393
-            234)
-          TabItem = 'ModTab'
-          object ModOptionsScrollBox: TTntScrollBox
-            Left = 2
-            Top = 48
-            Width = 385
-            Height = 184
-            VertScrollBar.Smooth = True
-            VertScrollBar.Tracking = True
-            Anchors = [akLeft, akTop, akRight, akBottom]
-            BiDiMode = bdLeftToRight
-            BorderStyle = bsNone
-            Color = clBtnFace
-            Ctl3D = False
-            ParentBiDiMode = False
-            ParentBackground = True
-            ParentColor = False
-            ParentCtl3D = False
-            TabOrder = 0
-          end
-          object panelModOptionsDefault: TSpTBXPanel
-            Left = 5
-            Top = 4
-            Width = 381
-            Height = 41
-            Align = alCustom
-            TabOrder = 1
-            object btLoadDefaultMDO: TSpTBXButton
-              Left = 136
-              Top = 8
-              Width = 113
-              Height = 25
-              Caption = 'Load default'
-              TabOrder = 0
-              OnClick = btLoadDefaultMDOClick
-              LinkFont.Charset = DEFAULT_CHARSET
-              LinkFont.Color = clBlue
-              LinkFont.Height = -11
-              LinkFont.Name = 'MS Sans Serif'
-              LinkFont.Style = [fsUnderline]
-            end
-            object btSetAsDefaultMDO: TSpTBXButton
-              Left = 256
-              Top = 8
-              Width = 113
-              Height = 25
-              Caption = 'Set as default'
-              TabOrder = 1
-              OnClick = btSetAsDefaultMDOClick
-              LinkFont.Charset = DEFAULT_CHARSET
-              LinkFont.Color = clBlue
-              LinkFont.Height = -11
-              LinkFont.Name = 'MS Sans Serif'
-              LinkFont.Style = [fsUnderline]
-            end
-            object btLoadModsDefaultMDO: TSpTBXButton
-              Left = 16
-              Top = 8
-              Width = 113
-              Height = 25
-              Caption = 'Load mod'#39's default'
-              TabOrder = 2
-              OnClick = btLoadModsDefaultMDOClick
-              LinkFont.Charset = DEFAULT_CHARSET
-              LinkFont.Color = clBlue
-              LinkFont.Height = -11
-              LinkFont.Name = 'MS Sans Serif'
-              LinkFont.Style = [fsUnderline]
-            end
-          end
+        object MyAllyNoButton: TTBXButton
+          Left = 64
+          Top = 42
+          Width = 41
+          Height = 20
+          Hint = 
+            'Your ally number. Players with same ally number will share map v' +
+            'isibility and resources (if they choose to)'
+          AutoSize = False
+          Caption = '1'
+          Images = MainForm.MiscImageList
+          Layout = blGlyphRight
+          ParentShowHint = False
+          ShowHint = True
+          TabOrder = 2
+          OnClick = MyAllyNoButtonClick
         end
-        object SpTBXTabSheet2: TSpTBXTabSheet
-          Left = 0
-          Top = 23
-          Width = 393
-          Height = 234
-          Caption = 'Game options'
-          ImageIndex = -1
-          TabItem = 'GameOptionsTab'
-          object LimitDGunCheckBox: TSpTBXCheckBox
-            Left = 16
-            Top = 152
-            Width = 128
-            Height = 15
-            Hint = 
-              'If checked, commanders will be able to use D-gun only within a c' +
-              'ertain radius from their start position'
-            Caption = 'Limit D-Gun to start pos'
-            ParentShowHint = False
-            ShowHint = True
-            TabOrder = 0
-            OnClick = LimitDGunCheckBoxClick
-          end
-          object GhostedBuildingsCheckBox: TSpTBXCheckBox
-            Left = 16
-            Top = 168
-            Width = 102
-            Height = 15
-            Hint = 
-              'If checked, players will be able to see &quot;ghosted&quot; buildings once' +
-              ' they get out of LOS'
-            Caption = 'Ghosted buildings'
-            ParentShowHint = False
-            ShowHint = True
-            TabOrder = 1
-            OnClick = GhostedBuildingsCheckBoxClick
-            Checked = True
-            State = cbChecked
-          end
-          object DiminishingMMsCheckBox: TSpTBXCheckBox
-            Left = 16
-            Top = 184
-            Width = 166
-            Height = 15
-            Hint = 
-              'If checked, efficiency of metal makers will decrease when the nu' +
-              'mber of them increases'
-            Caption = 'Diminishing metal maker returns'
-            ParentShowHint = False
-            ShowHint = True
-            TabOrder = 2
-            OnClick = DiminishingMMsCheckBoxClick
-          end
-          object LockGameSpeedCheckBox: TSpTBXCheckBox
-            Left = 16
-            Top = 200
-            Width = 103
-            Height = 15
-            Caption = 'Lock game speed'
-            TabOrder = 3
-            OnClick = LockGameSpeedCheckBoxClick
-          end
-          object ResourcesGroupBox: TSpTBXGroupBox
-            Left = 248
-            Top = 8
-            Width = 137
-            Height = 209
-            Caption = 'Resources'
-            Color = clNone
-            ParentColor = False
-            TabOrder = 5
-            object Label8: TSpTBXLabel
-              Left = 52
-              Top = 189
-              Width = 33
-              Height = 13
-              Cursor = crHandPoint
-              Caption = 'Energy'
-              Font.Charset = DEFAULT_CHARSET
-              Font.Color = clHotLight
-              Font.Height = -11
-              Font.Name = 'MS Sans Serif'
-              Font.Style = [fsUnderline]
-              ParentFont = False
-              OnClick = Label8Click
-              LinkFont.Charset = DEFAULT_CHARSET
-              LinkFont.Color = clBlue
-              LinkFont.Height = -11
-              LinkFont.Name = 'MS Sans Serif'
-              LinkFont.Style = [fsUnderline]
-            end
-            object Label9: TSpTBXLabel
-              Left = 15
-              Top = 189
-              Width = 26
-              Height = 13
-              Cursor = crHandPoint
-              Caption = 'Metal'
-              Font.Charset = DEFAULT_CHARSET
-              Font.Color = clHotLight
-              Font.Height = -11
-              Font.Name = 'MS Sans Serif'
-              Font.Style = [fsUnderline]
-              ParentFont = False
-              OnClick = Label9Click
-              LinkFont.Charset = DEFAULT_CHARSET
-              LinkFont.Color = clBlue
-              LinkFont.Height = -11
-              LinkFont.Name = 'MS Sans Serif'
-              LinkFont.Style = [fsUnderline]
-            end
-            object Label10: TSpTBXLabel
-              Left = 96
-              Top = 189
-              Width = 24
-              Height = 13
-              Cursor = crHandPoint
-              Caption = 'Units'
-              Font.Charset = DEFAULT_CHARSET
-              Font.Color = clHotLight
-              Font.Height = -11
-              Font.Name = 'MS Sans Serif'
-              Font.Style = [fsUnderline]
-              ParentFont = False
-              OnClick = Label10Click
-              LinkFont.Charset = DEFAULT_CHARSET
-              LinkFont.Color = clBlue
-              LinkFont.Height = -11
-              LinkFont.Name = 'MS Sans Serif'
-              LinkFont.Style = [fsUnderline]
-            end
-            object MetalTracker: TSpTBXjanTracker
-              Left = 10
-              Top = 16
-              Width = 39
-              Height = 171
-              ThemeType = thtWindows
-              Minimum = 0
-              Maximum = 10000
-              Value = 1000
-              Orientation = jtbVertical
-              BackColor = clBtnFace
-              BackBorder = False
-              TrackColor = clGray
-              TrackPositionColor = False
-              TrackBorder = True
-              BorderColor = clBlack
-              ThumbColor = clSilver
-              ThumbBorder = False
-              ThumbWidth = 40
-              ThumbHeight = 16
-              TrackHeight = 6
-              ShowCaption = True
-              CaptionColor = clBlack
-              CaptionBold = False
-              OnMouseUpAfterChange = MetalTrackerMouseUpAfterChange
-            end
-            object EnergyTracker: TSpTBXjanTracker
-              Left = 50
-              Top = 16
-              Width = 39
-              Height = 171
-              ThemeType = thtWindows
-              Minimum = 0
-              Maximum = 10000
-              Value = 1000
-              Orientation = jtbVertical
-              BackColor = clBtnFace
-              BackBorder = False
-              TrackColor = clGray
-              TrackPositionColor = False
-              TrackBorder = True
-              BorderColor = clBlack
-              ThumbColor = clSilver
-              ThumbBorder = False
-              ThumbWidth = 40
-              ThumbHeight = 16
-              TrackHeight = 6
-              ShowCaption = True
-              CaptionColor = clBlack
-              CaptionBold = False
-              OnMouseUpAfterChange = EnergyTrackerMouseUpAfterChange
-            end
-            object UnitsTracker: TSpTBXjanTracker
-              Left = 90
-              Top = 16
-              Width = 39
-              Height = 171
-              ThemeType = thtWindows
-              Minimum = 10
-              Maximum = 5000
-              Value = 1000
-              Orientation = jtbVertical
-              BackColor = clBtnFace
-              BackBorder = False
-              TrackColor = clGray
-              TrackPositionColor = False
-              TrackBorder = True
-              BorderColor = clBlack
-              ThumbColor = clSilver
-              ThumbBorder = False
-              ThumbWidth = 40
-              ThumbHeight = 16
-              TrackHeight = 6
-              ShowCaption = True
-              CaptionColor = clBlack
-              CaptionBold = False
-              OnMouseUpAfterChange = UnitsTrackerMouseUpAfterChange
-            end
-          end
-          object GameEndRadioGroup: TSpTBXRadioGroup
-            Left = 16
-            Top = 80
-            Width = 225
-            Height = 65
-            Caption = 'Game end condition'
-            Color = clNone
-            ParentColor = False
-            TabOrder = 6
-            OnClick = GameEndRadioGroupClick
-            ItemIndex = 0
-            Items.Strings = (
-              'Game continues if commander dies'
-              'Game ends if commander dies'
-              'Lineage mode')
-          end
-          object StartPosRadioGroup: TSpTBXRadioGroup
-            Left = 16
-            Top = 8
-            Width = 129
-            Height = 69
-            Caption = 'Start position'
-            Color = clNone
-            ParentColor = False
-            TabOrder = 7
-            OnClick = StartPosRadioGroupClick
-            ItemIndex = 2
-            Items.Strings = (
-              'Fixed'
-              'Random'
-              'Choose in game')
-          end
-          object LoadDefaultButton: TSpTBXButton
-            Left = 160
-            Top = 16
-            Width = 81
-            Height = 25
-            Caption = 'Load default'
-            TabOrder = 4
-            OnClick = LoadDefaultButtonClick
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
-          object SetDefaultButton: TSpTBXButton
-            Left = 160
-            Top = 48
-            Width = 81
-            Height = 25
-            Caption = 'Set as default'
-            TabOrder = 8
-            OnClick = SetDefaultButtonClick
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
+        object MySideButton: TSpTBXSpeedButton
+          Left = 120
+          Top = 17
+          Width = 113
+          Height = 22
+          Caption = 'Side'
+          OnClick = MySideButtonClick
+          LinkFont.Charset = DEFAULT_CHARSET
+          LinkFont.Color = clBlue
+          LinkFont.Height = -11
+          LinkFont.Name = 'MS Sans Serif'
+          LinkFont.Style = [fsUnderline]
         end
-        object MapTabSheet: TSpTBXTabSheet
-          Left = 0
-          Top = 23
-          Width = 393
-          Height = 234
-          Caption = 'Map options'
-          ImageIndex = -1
-          DesignSize = (
-            393
-            234)
-          TabItem = 'MapTab'
-          object MapOptionsScrollBox: TTntScrollBox
-            Left = 2
-            Top = 48
-            Width = 388
-            Height = 184
-            VertScrollBar.Smooth = True
-            VertScrollBar.Tracking = True
-            Anchors = [akLeft, akTop, akRight, akBottom]
-            BiDiMode = bdLeftToRight
-            BorderStyle = bsNone
-            Color = clBtnFace
-            Ctl3D = False
-            ParentBiDiMode = False
-            ParentBackground = True
-            ParentColor = False
-            ParentCtl3D = False
-            TabOrder = 0
-          end
-          object panelMapOptionsDefault: TSpTBXPanel
-            Left = 5
-            Top = 4
-            Width = 382
-            Height = 41
-            Align = alCustom
-            TabOrder = 1
-            object btLoadDefaultMPO: TSpTBXButton
-              Left = 136
-              Top = 8
-              Width = 113
-              Height = 25
-              Caption = 'Load default'
-              TabOrder = 0
-              OnClick = btLoadDefaultMPOClick
-              LinkFont.Charset = DEFAULT_CHARSET
-              LinkFont.Color = clBlue
-              LinkFont.Height = -11
-              LinkFont.Name = 'MS Sans Serif'
-              LinkFont.Style = [fsUnderline]
-            end
-            object btSetAsDefaultMPO: TSpTBXButton
-              Left = 256
-              Top = 8
-              Width = 113
-              Height = 25
-              Caption = 'Set as default'
-              TabOrder = 1
-              OnClick = btSetAsDefaultMPOClick
-              LinkFont.Charset = DEFAULT_CHARSET
-              LinkFont.Color = clBlue
-              LinkFont.Height = -11
-              LinkFont.Name = 'MS Sans Serif'
-              LinkFont.Style = [fsUnderline]
-            end
-            object btLoadMapsDefaultMPO: TSpTBXButton
-              Left = 16
-              Top = 8
-              Width = 113
-              Height = 25
-              Caption = 'Load map'#39's default'
-              TabOrder = 2
-              OnClick = btLoadMapsDefaultMPOClick
-              LinkFont.Charset = DEFAULT_CHARSET
-              LinkFont.Color = clBlue
-              LinkFont.Height = -11
-              LinkFont.Name = 'MS Sans Serif'
-              LinkFont.Style = [fsUnderline]
-            end
-          end
-        end
       end
       object lblTeamNbr: TSpTBXLabel
-        Left = 445
-        Top = 273
-        Width = 48
+        Left = 458
+        Top = 8
+        Width = 39
         Height = 0
         Hint = 'Team counters'
         Anchors = [akTop, akRight]
@@ -4882,8 +4953,8 @@
     Top = 428
   end
   object ColorPopupMenu: TSpTBXPopupMenu
-    Left = 664
-    Top = 368
+    Left = 688
+    Top = 376
     object TBXColorPalette1: TTBXColorPalette
       ColorSet = TBXTeamColorSet
       PaletteOptions = [tpoCustomImages]
@@ -4903,12 +4974,12 @@
     ColCount = 5
     RowCount = 2
     OnGetColorInfo = TBXTeamColorSetGetColorInfo
-    Left = 664
-    Top = 400
+    Left = 656
+    Top = 376
   end
   object ChooseNumberPopupMenu: TSpTBXPopupMenu
     Left = 480
-    Top = 312
+    Top = 328
     object TBXToolPalette1: TTBXToolPalette
       ColCount = 4
       Images = MainForm.NumbersImageList
@@ -4921,8 +4992,8 @@
     end
   end
   object ChooseSidePopupMenu: TSpTBXPopupMenu
-    Left = 664
-    Top = 284
+    Left = 672
+    Top = 292
   end
   object PlayerControlPopupMenu: TSpTBXPopupMenu
     OnInitPopup = PlayerControlPopupMenuInitPopup
@@ -5047,10 +5118,17 @@
       Caption = 'Options ...'
       OnClick = AutoStartRectsOptionsItemClick
     end
+    object SpTBXSeparatorItem7: TSpTBXSeparatorItem
+    end
+    object KeepRatioItem: TSpTBXItem
+      Caption = 'Keep ratio'
+      AutoCheck = True
+      OnClick = KeepRatioItemClick
+    end
   end
   object AdminPopupMenu: TSpTBXPopupMenu
     Left = 316
-    Top = 449
+    Top = 497
     object mnuRingAllNotRdy: TSpTBXItem
       Caption = 'Ring all not ready'
       OnClick = mnuRingAllNotRdyClick
@@ -5167,7 +5245,7 @@
   end
   object LadderPopupMenu: TSpTBXPopupMenu
     Left = 692
-    Top = 451
+    Top = 459
     object SpTBXItem9: TSpTBXItem
       Caption = 'Rules'
       OnClick = SpTBXItem9Click

Modified: trunk/Lobby/TASClient/BattleFormUnit.pas
===================================================================
--- trunk/Lobby/TASClient/BattleFormUnit.pas	2008-04-10 14:10:37 UTC (rev 5692)
+++ trunk/Lobby/TASClient/BattleFormUnit.pas	2008-04-10 18:36:29 UTC (rev 5693)
@@ -175,56 +175,12 @@
     NoMapImage: TImage;
     Splitter1: TSplitter;
     Panel1: TPanel;
-    MyOptionsGroupBox: TSpTBXGroupBox;
-    Label11: TSpTBXLabel;
-    Label12: TSpTBXLabel;
-    TeamColorSpeedButton: TSpTBXSpeedButton;
-    SpectateCheckBox: TSpTBXCheckBox;
-    MyTeamNoButton: TTBXButton;
-    MyAllyNoButton: TTBXButton;
-    MySideButton: TSpTBXSpeedButton;
-    MapPanel: TSpTBXPanel;
-    Bevel2: TBevel;
-    MapDescLabel: TSpTBXLabel;
-    TidalStrengthLabel: TSpTBXLabel;
-    GravityLabel: TSpTBXLabel;
-    MaxMetalLabel: TSpTBXLabel;
-    ExtRadiusLabel: TSpTBXLabel;
-    WindLabel: TSpTBXLabel;
-    SpTBXPanel1: TSpTBXPanel;
-    Bevel1: TBevel;
-    MapsButton: TTBXButton;
-    ReloadMapListButton: TTBXButton;
-    TBXButton1: TTBXButton;
-    TBXButton2: TTBXButton;
-    VDTBattleClients: TVirtualDrawTree;
-    SpTBXTabControl1: TSpTBXTabControl;
-    GameOptionsTab: TSpTBXTabItem;
-    DisabledUnitsTab: TSpTBXTabItem;
-    SpTBXTabSheet2: TSpTBXTabSheet;
-    LimitDGunCheckBox: TSpTBXCheckBox;
-    GhostedBuildingsCheckBox: TSpTBXCheckBox;
-    DiminishingMMsCheckBox: TSpTBXCheckBox;
-    LockGameSpeedCheckBox: TSpTBXCheckBox;
-    ResourcesGroupBox: TSpTBXGroupBox;
-    Label8: TSpTBXLabel;
-    Label9: TSpTBXLabel;
-    Label10: TSpTBXLabel;
-    MetalTracker: TSpTBXjanTracker;
-    EnergyTracker: TSpTBXjanTracker;
-    UnitsTracker: TSpTBXjanTracker;
-    SpTBXTabSheet1: TSpTBXTabSheet;
-    UnitsGroupBox: TSpTBXGroupBox;
-    AddUnitsSpeedButton: TSpeedButton;
-    DisabledUnitsListBox: TListBox;
-    MapImage: TImageEx;
     BalanceTeamsPopupMenu: TSpTBXPopupMenu;
     SpTBXItem8: TSpTBXItem;
     AutoStartRectsPopupMenu: TSpTBXPopupMenu;
     AutoStartRectsOptionsItem: TSpTBXItem;
     AutoStartRectsApplyItem: TSpTBXItem;
     AdminButton: TSpTBXButton;
-    lblTeamNbr: TSpTBXLabel;
     AdminPopupMenu: TSpTBXPopupMenu;
     mnuCBalanceTeams: TTBItem;
     mnuBalanceTeamOptions: TTBItem;
@@ -243,7 +199,6 @@
     mnuLimitRankAutoSpec: TSpTBXItem;
     mnuRankLimit: TSpTBXSubmenuItem;
     mnuRankLimitDisabled: TSpTBXItem;
-    GameEndRadioGroup: TSpTBXRadioGroup;
     mnuFixTeams: TSpTBXItem;
     mnuBlockTeams: TSpTBXItem;
     HttpCli2: THttpCli;
@@ -254,32 +209,84 @@
     SpTBXItem10: TSpTBXItem;
     SpTBXItem11: TSpTBXItem;
     RingItem: TSpTBXItem;
-    ModTab: TSpTBXTabItem;
-    ModTabSheet: TSpTBXTabSheet;
-    MapTab: TSpTBXTabItem;
-    MapTabSheet: TSpTBXTabSheet;
-    MapSizeLabel: TSpTBXLabel;
-    StartPosRadioGroup: TSpTBXRadioGroup;
-    LoadDefaultButton: TSpTBXButton;
-    SetDefaultButton: TSpTBXButton;
     ReadyButton: TSpTBXButton;
     SpTBXSeparatorItem5: TSpTBXSeparatorItem;
     mnuRemoveFromGroup: TSpTBXItem;
     mnuAddToGroup: TSpTBXSubmenuItem;
     mnuNewGroup: TSpTBXItem;
     SpTBXSeparatorItem6: TSpTBXSeparatorItem;
+    InputEdit: TSpTBXEdit;
+    ChatRichEdit: TTntRichEditURL;
+    Panel4: TPanel;
+    Splitter2: TSplitter;
+    VDTBattleClients: TVirtualDrawTree;
+    MyOptionsGroupBox: TSpTBXGroupBox;
+    Label11: TSpTBXLabel;
+    Label12: TSpTBXLabel;
+    TeamColorSpeedButton: TSpTBXSpeedButton;
+    SpectateCheckBox: TSpTBXCheckBox;
+    MyTeamNoButton: TTBXButton;
+    MyAllyNoButton: TTBXButton;
+    MySideButton: TSpTBXSpeedButton;
+    lblTeamNbr: TSpTBXLabel;
+    Panel5: TPanel;
+    SpTBXTabControl1: TSpTBXTabControl;
+    GameOptionsTab: TSpTBXTabItem;
+    DisabledUnitsTab: TSpTBXTabItem;
+    MapTab: TSpTBXTabItem;
+    ModTab: TSpTBXTabItem;
+    ModTabSheet: TSpTBXTabSheet;
     ModOptionsScrollBox: TTntScrollBox;
-    MapOptionsScrollBox: TTntScrollBox;
     panelModOptionsDefault: TSpTBXPanel;
     btLoadDefaultMDO: TSpTBXButton;
     btSetAsDefaultMDO: TSpTBXButton;
     btLoadModsDefaultMDO: TSpTBXButton;
+    MapTabSheet: TSpTBXTabSheet;
+    MapOptionsScrollBox: TTntScrollBox;
     panelMapOptionsDefault: TSpTBXPanel;
     btLoadDefaultMPO: TSpTBXButton;
     btSetAsDefaultMPO: TSpTBXButton;
     btLoadMapsDefaultMPO: TSpTBXButton;
-    InputEdit: TSpTBXEdit;
-    ChatRichEdit: TTntRichEditURL;
+    SpTBXTabSheet1: TSpTBXTabSheet;
+    UnitsGroupBox: TSpTBXGroupBox;
+    AddUnitsSpeedButton: TSpeedButton;
+    DisabledUnitsListBox: TListBox;
+    SpTBXTabSheet2: TSpTBXTabSheet;
+    LimitDGunCheckBox: TSpTBXCheckBox;
+    GhostedBuildingsCheckBox: TSpTBXCheckBox;
+    DiminishingMMsCheckBox: TSpTBXCheckBox;
+    LockGameSpeedCheckBox: TSpTBXCheckBox;
+    ResourcesGroupBox: TSpTBXGroupBox;
+    Label8: TSpTBXLabel;
+    Label9: TSpTBXLabel;
+    Label10: TSpTBXLabel;
+    MetalTracker: TSpTBXjanTracker;
+    EnergyTracker: TSpTBXjanTracker;
+    UnitsTracker: TSpTBXjanTracker;
+    GameEndRadioGroup: TSpTBXRadioGroup;
+    StartPosRadioGroup: TSpTBXRadioGroup;
+    LoadDefaultButton: TSpTBXButton;
+    SetDefaultButton: TSpTBXButton;
+    Panel6: TPanel;
+    MapPanel: TSpTBXPanel;
+    Bevel2: TBevel;
+    MapImage: TImageEx;
+    MapDescLabel: TSpTBXLabel;
+    TidalStrengthLabel: TSpTBXLabel;
+    GravityLabel: TSpTBXLabel;
+    MaxMetalLabel: TSpTBXLabel;
+    ExtRadiusLabel: TSpTBXLabel;
+    WindLabel: TSpTBXLabel;
+    SpTBXPanel1: TSpTBXPanel;
+    Bevel1: TBevel;
+    MapsButton: TTBXButton;
+    ReloadMapListButton: TTBXButton;
+    TBXButton1: TTBXButton;
+    TBXButton2: TTBXButton;
+    MapSizeLabel: TSpTBXLabel;
+    Splitter3: TSplitter;
+    KeepRatioItem: TSpTBXItem;
+    SpTBXSeparatorItem7: TSpTBXSeparatorItem;
 
     procedure CreateParams(var Params: TCreateParams); override;
 
@@ -323,6 +330,7 @@
     function GetFirstMissingStartRect: Integer;
     procedure StartRectPaintBoxPaint(Sender: TObject);
     procedure AddStartRect(Index: Integer; Rect: TRect);
+    procedure RefreshStartRectsPosAndSize;
     procedure RemoveStartRect(Index: Integer);
     procedure ChangeStartRect(Index: Integer; Rect: TRect);
     procedure SetSelectedStartRect(Index: Integer);
@@ -478,6 +486,8 @@
     procedure btSetAsDefaultMPOClick(Sender: TObject);
     procedure btLoadDefaultMDOClick(Sender: TObject);
     procedure btLoadDefaultMPOClick(Sender: TObject);
+    procedure KeepRatioItemClick(Sender: TObject);
+    procedure MapPanelResize(Sender: TObject);
   private
     History: TWideStringList;
     HistoryIndex: Integer;
@@ -1051,6 +1061,7 @@
   MapsPopupStringList.ItemIndex := -1;
 
   MapImage.Hint := 'No map';
+  MapPanelResize(nil);
 end;
 
 procedure TBattleForm.ChangeMap(MapIndex: Integer);
@@ -1097,6 +1108,8 @@
   panelMapOptionsDefault.Visible := MapOptionsList.Count &gt; 0;
   MapTab.Caption := 'Map options ('+IntToStr(BattleForm.MapOptionsList.Count)+')';
 
+  MapPanelResize(nil);
+
   SendLuaOptionsDetailsToServer;
 end;
 
@@ -2420,6 +2433,8 @@
   tmp: Integer;
   url: string;
 begin
+  X := Round(100*X/MapImage.Width);
+  Y := Round(100*Y/MapImage.Height);
   if Button &lt;&gt; mbLeft then Exit;
   if CurrentMapIndex = -1 then // user does not have this map
   begin
@@ -2447,7 +2462,7 @@
     if tmp &gt; High(BattleState.StartRects) then Exit;
     BattleState.DrawingStartRect := tmp;
 
-    AddStartRect(tmp, Rect(X, Y, X, Y));
+    AddStartRect(tmp, Rect(X,Y ,X, Y));
 
     Exit;
   end;
@@ -2506,6 +2521,8 @@
 procedure TBattleForm.MapImageMouseMove(Sender: TObject;
   Shift: TShiftState; X, Y: Integer);
 begin
+  X := Round(100*X/MapImage.Width);
+  Y := Round(100*Y/MapImage.Height);
   if ssShift in Shift then
   begin
     if (BattleState.Status = Hosting) and (BattleState.Battle.BattleType =0) then
@@ -2592,7 +2609,7 @@
       end;
 
     end;
-
+    RefreshStartRectsPosAndSize;
     NormalizeRect(BattleState.StartRects[BattleState.DrawingStartRect].Rect);
 
     // notify everyone about new startrect:
@@ -2601,7 +2618,7 @@
       StartPosRadioGroup.ItemIndex := 2; // automatically switch to &quot;Choose in game&quot; startpos
       
       with BattleState.StartRects[BattleState.DrawingStartRect] do
-        MainForm.TryToSendCommand('ADDSTARTRECT', IntToStr(BattleState.DrawingStartRect) + ' ' + IntToStr(Rect.Left) + ' ' + IntToStr(Rect.Top) + ' ' + IntToStr(Rect.Right) + ' ' + IntToStr(Rect.Bottom) + ' ');
+        MainForm.TryToSendCommand('ADDSTARTRECT', IntToStr(BattleState.DrawingStartRect) + ' ' + IntToStr(Rect.Left*2) + ' ' + IntToStr(Rect.Top*2) + ' ' + IntToStr(Rect.Right*2) + ' ' + IntToStr(Rect.Bottom*2) + ' ');    // *2 because the start rect is in % (0-&gt;100) and the old system was in pixel with a 200x200 minimap
     end;
 
 
@@ -2623,7 +2640,7 @@
     NormalizeRect(BattleState.StartRects[BattleState.MovingStartRect].Rect);
     MainForm.TryToSendCommand('REMOVESTARTRECT', IntToStr(BattleState.MovingStartRect));
     with BattleState.StartRects[BattleState.MovingStartRect] do
-      MainForm.TryToSendCommand('ADDSTARTRECT', IntToStr(BattleState.MovingStartRect) + ' ' + IntToStr(Rect.Left) + ' ' + IntToStr(Rect.Top) + ' ' + IntToStr(Rect.Right) + ' ' + IntToStr(Rect.Bottom) + ' ');
+      MainForm.TryToSendCommand('ADDSTARTRECT', IntToStr(BattleState.MovingStartRect) + ' ' + IntToStr(Rect.Left*2) + ' ' + IntToStr(Rect.Top*2) + ' ' + IntToStr(Rect.Right*2) + ' ' + IntToStr(Rect.Bottom*2) + ' ');    // *2 because the start rect is in % (0-&gt;100) and the old system was in pixel with a 200x200 minimap
     BattleState.MovingStartRect := -1;
   end;
   if BattleState.ResizingStartRect &lt;&gt; -1 then
@@ -2642,7 +2659,7 @@
     NormalizeRect(BattleState.StartRects[BattleState.ResizingStartRect].Rect);
     MainForm.TryToSendCommand('REMOVESTARTRECT', IntToStr(BattleState.ResizingStartRect));
     with BattleState.StartRects[BattleState.ResizingStartRect] do
-      MainForm.TryToSendCommand('ADDSTARTRECT', IntToStr(BattleState.ResizingStartRect) + ' ' + IntToStr(Rect.Left) + ' ' + IntToStr(Rect.Top) + ' ' + IntToStr(Rect.Right) + ' ' + IntToStr(Rect.Bottom) + ' ');
+      MainForm.TryToSendCommand('ADDSTARTRECT', IntToStr(BattleState.ResizingStartRect) + ' ' + IntToStr(Rect.Left*2) + ' ' + IntToStr(Rect.Top*2) + ' ' + IntToStr(Rect.Right*2) + ' ' + IntToStr(Rect.Bottom*2) + ' ');    // *2 because the start rect is in % (0-&gt;100) and the old system was in pixel with a 200x200 minimap
     BattleState.ResizingStartRect := -1;
   end;
 end;
@@ -2739,15 +2756,29 @@
   BattleState.StartRects[Index].PaintBox.Enabled := False;
   BattleState.StartRects[Index].PaintBox.Tag := Index;
   BattleState.StartRects[Index].PaintBox.OnPaint := StartRectPaintBoxPaint;
-  BattleState.StartRects[Index].PaintBox.Left := Rect.Left;
-  BattleState.StartRects[Index].PaintBox.Top := Rect.Top;
-  BattleState.StartRects[Index].PaintBox.Width := Rect.Right - Rect.Left;
-  BattleState.StartRects[Index].PaintBox.Height := Rect.Bottom - Rect.Top;
+  BattleState.StartRects[Index].PaintBox.Left := MapImage.Left+Round(MapImage.Width*(Rect.Left/100));
+  BattleState.StartRects[Index].PaintBox.Top := MapImage.Top+Round(MapImage.Height*(Rect.Top/100));
+  BattleState.StartRects[Index].PaintBox.Width := Round(MapImage.Width*(Rect.Right - Rect.Left)/100);
+  BattleState.StartRects[Index].PaintBox.Height := Round(MapImage.Height*(Rect.Bottom - Rect.Top)/100);
   BattleState.StartRects[Index].PaintBox.Parent := MapPanel;
 
   RearrangeStartRects;
 end;
 
+procedure TBattleForm.RefreshStartRectsPosAndSize;
+var
+  i: integer;
+begin
+  for i:=0 to High(BattleState.StartRects) do
+  if BattleState.StartRects[i].Enabled then
+  begin
+    BattleState.StartRects[i].PaintBox.Left := MapImage.Left+Round(MapImage.Width*(BattleState.StartRects[i].Rect.Left/100));
+    BattleState.StartRects[i].PaintBox.Top := MapImage.Top+Round(MapImage.Height*(BattleState.StartRects[i].Rect.Top/100));
+    BattleState.StartRects[i].PaintBox.Width := Round(MapImage.Width*(BattleState.StartRects[i].Rect.Right - BattleState.StartRects[i].Rect.Left)/100);
+    BattleState.StartRects[i].PaintBox.Height := Round(MapImage.Height*(BattleState.StartRects[i].Rect.Bottom - BattleState.StartRects[i].Rect.Top)/100);
+  end;
+end;
+
 // rearranges start rects paintboxes in a way that first box is drawn first, then seconds one, etc.
 procedure TBattleForm.RearrangeStartRects;
 var
@@ -2778,10 +2809,10 @@
   NormalizeRect(Rect);
 
   try
-    BattleState.StartRects[Index].PaintBox.Left := Rect.Left;
-    BattleState.StartRects[Index].PaintBox.Top := Rect.Top;
-    BattleState.StartRects[Index].PaintBox.Width := Rect.Right - Rect.Left;
-    BattleState.StartRects[Index].PaintBox.Height := Rect.Bottom - Rect.Top;
+    BattleState.StartRects[Index].PaintBox.Left := MapImage.Left+Round(MapImage.Width*(Rect.Left/100));
+    BattleState.StartRects[Index].PaintBox.Top := MapImage.Top+Round(MapImage.Height*(Rect.Top/100));
+    BattleState.StartRects[Index].PaintBox.Width := Round(MapImage.Width*(Rect.Right - Rect.Left)/100);
+    BattleState.StartRects[Index].PaintBox.Height := Round(MapImage.Height*(Rect.Bottom - Rect.Top)/100);
   except
     MainForm.AddMainLog('Error: ChangeStartRect method raised an exception. Please report this error!', Colors.Error);
   end;
@@ -4952,10 +4983,10 @@
   if Ini.SectionExists('Box0') then begin
     mnuClearBoxesClick(Sender);
     for i:=0 to High(BattleState.StartRects) do begin
-      left := StrToInt(Ini.ReadString('Box'+IntToStr(i), 'Left', '0'));
-      top := StrToInt(Ini.ReadString('Box'+IntToStr(i), 'Top', '0'));
-      right := StrToInt(Ini.ReadString('Box'+IntToStr(i), 'Right', '0'));
-      bottom := StrToInt(Ini.ReadString('Box'+IntToStr(i), 'Bottom', '0'));
+      left := Min(100,StrToInt(Ini.ReadString('Box'+IntToStr(i), 'Left', '0')));
+      top := Min(100,StrToInt(Ini.ReadString('Box'+IntToStr(i), 'Top', '0')));
+      right := Min(100,StrToInt(Ini.ReadString('Box'+IntToStr(i), 'Right', '0')));
+      bottom := Min(100,StrToInt(Ini.ReadString('Box'+IntToStr(i), 'Bottom', '0')));
       if right &gt; 0 then begin
         AddStartRect(i,Rect(left,top,right,bottom));
         MainForm.TryToSendCommand('ADDSTARTRECT', IntToStr(i) + ' ' + IntToStr(left) + ' ' + IntToStr(top) + ' ' + IntToStr(right) + ' ' + IntToStr(bottom) + ' ');
@@ -6219,4 +6250,53 @@
   LoadMapOptionsDefault;
 end;
 
+procedure TBattleForm.KeepRatioItemClick(Sender: TObject);
+begin
+  MapPanelResize(nil);
+end;
+
+procedure TBattleForm.MapPanelResize(Sender: TObject);
+var
+  index: integer;
+  map : TMapItem;
+  mapImgSpaceWidth,mapImgSpaceHeight : integer;
+  forceWidth,forceHeight : integer;
+begin
+  if MapsPopupStringList.ItemIndex = -1 then
+    Exit;
+  index :=  Utility.MapList.IndexOf(MapsPopupStringList.Strings[MapsPopupStringList.ItemIndex]);
+  if index = -1 then
+  begin
+    MapImage.Anchors := [akLeft,akTop,akBottom,akRight];
+    MapImage.Height := mapImgSpaceHeight;
+    MapImage.Width := mapImgSpaceWidth;
+    Exit;
+  end;
+  map := GetMapItem(index);
+  mapImgSpaceWidth := MapPanel.Width-134;
+  mapImgSpaceHeight := MapPanel.Height-62;
+  forceHeight := Round(mapImgSpaceWidth*map.MapInfo.Height/map.MapInfo.Width);
+  forceWidth := Round(mapImgSpaceHeight*map.MapInfo.Width/map.MapInfo.Height);
+  if KeepRatioItem.Checked then
+    if ((map.MapInfo.Width &gt; map.MapInfo.Height) and (forceHeight &lt; mapImgSpaceHeight)) or (forceWidth &gt; mapImgSpaceWidth) then
+    begin
+      MapImage.Anchors := [akLeft,akTop,akRight];
+      MapImage.Height := forceHeight;
+      MapImage.Width := mapImgSpaceWidth;
+    end
+    else
+    begin
+      MapImage.Anchors := [akLeft,akTop,akBottom];
+      MapImage.Width := forceWidth;
+      MapImage.Height :=  mapImgSpaceHeight;
+    end
+  else
+  begin
+    MapImage.Anchors := [akLeft,akTop,akBottom,akRight];
+    MapImage.Height := mapImgSpaceHeight;
+    MapImage.Width := mapImgSpaceWidth;
+  end;
+  RefreshStartRectsPosAndSize;
+end;
+
 end.

Modified: trunk/Lobby/TASClient/HttpGetUnit.dfm
===================================================================
--- trunk/Lobby/TASClient/HttpGetUnit.dfm	2008-04-10 14:10:37 UTC (rev 5692)
+++ trunk/Lobby/TASClient/HttpGetUnit.dfm	2008-04-10 18:36:29 UTC (rev 5693)
@@ -159,4 +159,19 @@
     Left = 208
     Top = 136
   end
+  object SevenZip1: TSevenZip
+    SFXCreate = False
+    SFXModule = '7z.sfx'
+    AddOptions = []
+    ExtractOptions = [ExtractOverwrite]
+    LZMACompressType = LZMA
+    LZMACompressStrength = SAVE
+    LZMAStrength = 0
+    LPPMDmem = 0
+    LPPMDsize = 0
+    NumberOfFiles = -1
+    VolumeSize = 0
+    Left = 112
+    Top = 40
+  end
 end

Modified: trunk/Lobby/TASClient/HttpGetUnit.pas
===================================================================
--- trunk/Lobby/TASClient/HttpGetUnit.pas	2008-04-10 14:10:37 UTC (rev 5692)
+++ trunk/Lobby/TASClient/HttpGetUnit.pas	2008-04-10 18:36:29 UTC (rev 5693)
@@ -5,7 +5,7 @@
 uses
   Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
   Dialogs, HttpProt, StdCtrls, Buttons, ComCtrls, MainUnit, Misc, ShellAPI,
-  SpTBXControls, TBXDkPanels, SpTBXItem,SevenZip,StrUtils;
+  SpTBXControls, TBXDkPanels, SpTBXItem,SevenZip,StrUtils, SevenZipVCL;
 
 type
   THttpGetForm = class(TForm)
@@ -19,6 +19,7 @@
     CloseButton: TSpTBXButton;
     HttpCli1: THttpCli;
     ProgressBar: TSpTBXProgressBar;
+    SevenZip1: TSevenZip;
 
     procedure CreateParams(var Params: TCreateParams); override;
 
@@ -168,34 +169,20 @@
         ReceivedLabel.Visible := False;
         appExePath := Application.ExeName;
         RenameFile(Application.ExeName,Application.ExeName+'.old');
-        LoadSevenZipDLL;
-        e := SevenZipExtractArchive(Application.Handle,DownloadFile.FileName,'',false,'',true,'.',false);
-        UnloadSevenZipDLL;
-        DeleteFile(DownloadFile.FileName);
-
-        paramList := TStringList.Create;
-        for i:=1 to ParamCount do
-          paramList.Add(ParamStr(i));
-
-        if e=SZ_OK then
+        SevenZip1.SZFileName := DownloadFile.FileName;
+        SevenZip1.ExtrBaseDir := ExtractFilePath(appExePath);
+        e := SevenZip1.Extract(false);
+        if e=0 then
         begin
+          paramList := TStringList.Create;
+          for i:=1 to ParamCount do
+            paramList.Add(ParamStr(i));
           ShellExecute(0,'open',PChar(appExePath),PChar(JoinStringList(paramList,' ')),PChar(ExtractFilePath(appExePath)), SW_SHOWNORMAL);
           MainForm.Close;
         end
         else
         begin
-          if e=SZ_ERROR then
-          begin
-            if Debug.Enabled then
-              MessageDlg(SevenZip.LastError, mtError, [mbOK], 0)
-            else
-            begin
-              ShellExecute(0,'open',PChar(appExePath),PChar(JoinStringList(paramList,' ')),PChar(ExtractFilePath(appExePath)), SW_SHOWNORMAL);
-              MainForm.Close;
-            end;
-          end
-          else
-            MessageDlg('Error '+IntToStr(e)+': '+SevenZipErrNbToMsg(e), mtError, [mbOK], 0)
+          MessageDlg('Error '+IntToStr(e), mtError, [mbOK], 0)
         end;
       end
       else

Modified: trunk/Lobby/TASClient/MainUnit.dfm
===================================================================
--- trunk/Lobby/TASClient/MainUnit.dfm	2008-04-10 14:10:37 UTC (rev 5692)
+++ trunk/Lobby/TASClient/MainUnit.dfm	2008-04-10 18:36:29 UTC (rev 5693)
@@ -843,10 +843,13 @@
           Top = 8
           Width = 41
           Height = 26
+          Hint = 'Connection/Disconnection and Away message control'
           BorderSize = 3
           DropDownCombo = True
           DropDownMenu = ConnectionPopupMenu
           Images = ConnectionStateImageList
+          ParentShowHint = False
+          ShowHint = True
           TabOrder = 5
           OnClick = ConnectButtonClick
         end

Modified: trunk/Lobby/TASClient/MainUnit.pas
===================================================================
--- trunk/Lobby/TASClient/MainUnit.pas	2008-04-10 14:10:37 UTC (rev 5692)
+++ trunk/Lobby/TASClient/MainUnit.pas	2008-04-10 18:36:29 UTC (rev 5693)
@@ -204,7 +204,8 @@
   HttpProt, GraphicEx, Registry, JvComponent, JvBaseDlg, JvDesktopAlert,
   JvDesktopAlertForm, DateUtils, Winsock, TBXToolPals, SpTBXItem, TB2Item,
   TBX, SpTBXControls, TBXDkPanels, SpTBXFormPopupMenu,IniFiles,StrUtils,
-  TntStdCtrls, SpTBXEditors, Mask, JvExMask, JvSpin,TntComCtrls,JclUnicode;
+  TntStdCtrls, SpTBXEditors, Mask, JvExMask, JvSpin,TntComCtrls,JclUnicode,
+  GR32_Image;
 
 const
   CountryNames: array[0..240] of string = (
@@ -509,7 +510,7 @@
 
 const
   VERSION_NUMBER = '0.37'; // Must be float value! (with a period as a decimal seperator)
-  BETA_NUMBER = 273;
+  BETA_NUMBER = 275;
   CHECK_BETA_LOBBY_URL = '<A HREF="http://tasclient.no-ip.org/TASClient.txt">http://tasclient.no-ip.org/TASClient.txt</A>';
   PROGRAM_VERSION = 'TASClient ' + VERSION_NUMBER + ' beta';
   KEEP_ALIVE_INTERVAL = 10000; // in milliseconds. Tells us what should be the maximum &quot;silence&quot; time before we send a ping to the server.
@@ -1227,7 +1228,7 @@
     procedure TryToCloseTab(TabSheet: TMyTabSheet);
     procedure OpenPrivateChat(ClientName: string);
 
-    function AddClientToTab(Tab: TMyTabSheet; ClientName: string): Boolean;
+    function AddClientToTab(ClientList: TList; ClientName: string): Boolean;
     function RemoveClientFromTab(Tab: TMyTabSheet; ClientName: string): Boolean;
     procedure RemoveAllClientsFromTab(Tab: TMyTabSheet);
     procedure UpdateClientsListBox;
@@ -1514,7 +1515,7 @@
   HostBattleFormUnit, AgreementUnit, PerformFormUnit, HighlightingUnit,
   IgnoreListUnit, MuteListFormUnit, MapListFormUnit, SplashScreenUnit,
   LoginProgressFormUnit, GpIFF, SearchFormUnit, ManageGroups, ColorPicker,
-  AwayMessageFormUnit,JclStrings;
+  AwayMessageFormUnit,JclStrings, MaskFormUnit;
 
 {$R *.dfm}
 
@@ -2058,6 +2059,7 @@
   Client.CurrentLadderRank := -1;
   Client.CurrentLadderRating := -1;
   AllClients.Add(Client);
+
   if not Status.ReceivingLoginInfo then SortClientsList(AllClients,Preferences.SortStyle);
 end;
 
@@ -2969,8 +2971,8 @@
     subKeys := GetSubKeys(completeKey);
     for i:=0 to subKeys.Count-1 do
       RemoveKey(completeKey + '/' + subKeys[i]);
+    subKeys.Free;
   end;
-  subKeys.Free;
 end;
 
 procedure TScript.TryToRemoveUDPSourcePort;
@@ -3620,7 +3622,7 @@
     end;
 end;
 
-function TMainForm.AddClientToTab(Tab: TMyTabSheet; ClientName: string): Boolean; // does not update ClientsListBox!
+function TMainForm.AddClientToTab(ClientList: TList; ClientName: string): Boolean; // does not update ClientsListBox!
 var
   c: TClient;
   i: Integer;
@@ -3632,18 +3634,18 @@
   if c = nil then Exit;
 
   // make sure client is not already in the list:
-  for i := 0 to Tab.Clients.Count-1 do if TClient(Tab.Clients[i]).Name = ClientName then Exit;
+  for i := 0 to ClientList.Count-1 do if TClient(ClientList[i]).Name = ClientName then Exit;
 
-  Tab.Clients.Add(c);
-  i := Tab.Clients.Count-1;
+  ClientList.Add(c);
+  i := ClientList.Count-1;
   // sort:
   while i &gt; 0 do
-    if CompareClients(Tab.Clients[i], Tab.Clients[i-1], Preferences.SortStyle) &lt; 0 then
+    if CompareClients(ClientList[i], ClientList[i-1], Preferences.SortStyle) &lt; 0 then
     begin
       // swap:
-      tmp := Tab.Clients[i];
-      Tab.Clients[i] := Tab.Clients[i-1];
-      Tab.Clients[i-1] := tmp;
+      tmp := ClientList[i];
+      ClientList[i] := ClientList[i-1];
+      ClientList[i-1] := tmp;
       Dec(i);
     end
     else Break;
@@ -3713,7 +3715,7 @@
   // will get updated more often and sometimes you won't be able to double click
   // on a player since clients list will get updated so fast it will reset your
   // selection from the first click. This fixes it:
-  if TempCount = ClientsListBox.Items.Count then
+  //if TempCount = ClientsListBox.Items.Count then
     ClientsListBox.ItemIndex := TempItemIndex;
 
   ClientsListBox.Items.EndUpdate;
@@ -4482,7 +4484,7 @@
       i := GetTabWindowPageIndex(sl[1]);
       if i &lt;&gt; -1 then
       begin
-        if not AddClientToTab(PageControl1.Pages[i] as TMyTabSheet, sl[1]) then ; // nevermind, just ignore it
+        if not AddClientToTab((PageControl1.Pages[i] as TMyTabSheet).Clients, sl[1]) then ; // nevermind, just ignore it
         if (PageControl1.ActivePage.Caption = sl[1]) and (not Status.ReceivingLoginInfo) then UpdateClientsListBox;
       end;
 
@@ -4679,10 +4681,10 @@
 
       try
         index := StrToInt(sl[1]);
-        Rect.Left := StrToInt(sl[2]);
-        Rect.Top := StrToInt(sl[3]);
-        Rect.Right := StrToInt(sl[4]);
-        Rect.Bottom := StrToInt(sl[5]);
+        Rect.Left := Round(StrToInt(sl[2])/2);
+        Rect.Top := Round(StrToInt(sl[3])/2);
+        Rect.Right := Round(StrToInt(sl[4])/2);
+        Rect.Bottom := Round(StrToInt(sl[5])/2);
       except
         AddMainLog('Error: Server sent ambiguous command!', Colors.Error);
         Exit;
@@ -4796,7 +4798,7 @@
       end;
 
       for j := 2 to sl.Count-1 do
-        if not AddClientToTab(PageControl1.Pages[i] as TMyTabSheet, sl[j]) then
+        if not AddClientToTab((PageControl1.Pages[i] as TMyTabSheet).Clients, sl[j]) then
         begin
           AddMainLog('Error: Server sent ambiguous command!', Colors.Error);
           Exit;
@@ -4836,7 +4838,7 @@
         Exit;
       end;
 
-      if not AddClientToTab(PageControl1.Pages[i] as TMyTabSheet, sl[2]) then
+      if not AddClientToTab((PageControl1.Pages[i] as TMyTabSheet).Clients, sl[2]) then
       begin
         AddMainLog('Error: Server sent ambiguous command!', Colors.Error);
         Exit;
@@ -5017,7 +5019,7 @@
       if i = -1 then
       begin
         i := AddTabWindow(sl[1], Preferences.AutoFocusOnPM);
-        if not AddClientToTab(PageControl1.Pages[i] as TMyTabSheet, sl[1]) then
+        if not AddClientToTab((PageControl1.Pages[i] as TMyTabSheet).Clients, sl[1]) then
         begin
           AddMainLog('Error: Server sent ambiguous command!', Colors.Error);
           Exit;
@@ -5051,7 +5053,7 @@
       if i = -1 then
       begin
         i := AddTabWindow(sl[1], Preferences.AutoFocusOnPM);
-        if not AddClientToTab(PageControl1.Pages[i] as TMyTabSheet, sl[1]) then
+        if not AddClientToTab((PageControl1.Pages[i] as TMyTabSheet).Clients, sl[1]) then
         begin
           AddMainLog('Error: Server sent ambiguous command!', Colors.Error);
           Exit;
@@ -5632,10 +5634,11 @@
       if changed and not Client.GetInGameStatus and (Client.GetBattleId &lt;&gt; Status.Me.GetBattleId) and (Client.GetGroup &gt; -1) and TClientGroup(ClientGroups[Client.GetGroup]).NotifyOnBattleEnd then
         AddNotification('Player battle end', '&lt;' + Client.Name + '&gt; has end his battle.', 2000);
 
+     UpdateClientsListBox;
 
       if Client.Name = Status.Username then Status.MyRank := Client.GetRank;
 
-      if not Status.ReceivingLoginInfo then UpdateClientsListBox;
+      //if not Status.ReceivingLoginInfo then UpdateClientsListBox;
 
       if (Status.ReceivingLoginInfo) and ((Status.LastCommandReceived = 'UPDATEBATTLEINFO') or (Status.LastCommandReceived = 'JOINEDBATTLE')) then LoginProgressForm.UpdateCaption('Updating clients status list ...');
     end
@@ -7007,13 +7010,7 @@
   begin
     len := (Sender as TWSocket).Receive(@sBuffer[1], 256);
     if len &lt;= 0 then Exit;
-
     s := UTF8Decode(LeftBStr(sBuffer,len));
-    s2 := s;
-    if Pos('29093',s2)&gt;0 then
-    begin
-      ReceiveBuffer := ReceiveBuffer;
-    end;
 
     for i := 1 to length(s) do
     begin
@@ -7060,7 +7057,7 @@
   else ChangeActivePageAndUpdate(PageControl1, i);
 
 //  RemoveAllClientsFromTab(PageControl1.Pages[i] as TMyTabSheet);
-  if not AddClientToTab(PageControl1.Pages[i] as TMyTabSheet, ClientName) then ; // nevermind, just ignore it
+  if not AddClientToTab((PageControl1.Pages[i] as TMyTabSheet).Clients, ClientName) then ; // nevermind, just ignore it
 
   UpdateClientsListBox;
 
@@ -9134,6 +9131,8 @@
     re.SelStart := 0;
     re.SelStart := Length(re.text);
   end;
+ // if MaskForm.Visible then
+   // MaskForm.RefreshPostAndSize;
 end;
 
 procedure TMainForm.PlayersFilterClick(Sender: TObject);
@@ -9385,7 +9384,7 @@
   s: string;
   s2 : WideString;
 begin
-  AddMainLog('  ' + BattleForm.InputEdit.Text+'d',Colors.Normal);
+
 end;
 
 procedure TMainForm.BattleListPopupMenuInitPopup(Sender: TObject;

Modified: trunk/Lobby/TASClient/PreferencesFormUnit.pas
===================================================================
--- trunk/Lobby/TASClient/PreferencesFormUnit.pas	2008-04-10 14:10:37 UTC (rev 5692)
+++ trunk/Lobby/TASClient/PreferencesFormUnit.pas	2008-04-10 18:36:29 UTC (rev 5693)
@@ -357,7 +357,7 @@
         Items[i].Position := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\MainForm', 'ColumnPosition' + IntToStr(i));
       except
       end;
-    FixFormBounds(MainForm);  
+    FixFormBounds(MainForm);
 
     try BattleForm.Left := GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'Left'); except end;
     try BattleForm.Top := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'Top'); except end;
@@ -365,6 +365,9 @@
     try BattleForm.Height := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'Height'); except end;
     try BattleForm.WindowState := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'WindowState'); except end;
     try BattleForm.Panel1.Height := Min(BattleForm.ClientHeight-90,Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'Splitter1')); except end;
+    try BattleForm.Panel4.Height := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'Splitter2'); except end;
+    try BattleForm.Panel6.Width := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'Splitter3'); except end;
+    try BattleForm.KeepRatioItem.Checked := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'KeepMinimapRatio'); except end;
 
     {--&gt;} AllowBattleDetailsUpdate := False;
     //try BattleForm.StartPosRadioGroup.ItemIndex := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'StartPos'); except end;
@@ -466,6 +469,9 @@
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'Height', rdInteger, R.Bottom-R.Top);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'WindowState', rdInteger, BattleForm.WindowState);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'Splitter1', rdInteger, BattleForm.Panel1.Height);
+    Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'Splitter2', rdInteger, BattleForm.Panel4.Height);
+    Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'Splitter3', rdInteger, BattleForm.Panel6.Width);
+    Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'KeepMinimapRatio', rdInteger, Misc.BoolToInt(BattleForm.KeepRatioItem.Checked));
     //Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'StartPos', rdInteger, BattleForm.StartPosRadioGroup.ItemIndex);
     //Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'GameEnd', rdInteger, BattleForm.GameEndRadioGroup.ItemIndex);
     //Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'LimitDGun', rdInteger, Misc.BoolToInt(BattleForm.LimitDGunCheckBox.Checked));

Modified: trunk/Lobby/TASClient/ReplaysUnit.dfm
===================================================================
--- trunk/Lobby/TASClient/ReplaysUnit.dfm	2008-04-10 14:10:37 UTC (rev 5692)
+++ trunk/Lobby/TASClient/ReplaysUnit.dfm	2008-04-10 18:36:29 UTC (rev 5693)
@@ -1,6 +1,6 @@
 object ReplaysForm: TReplaysForm
-  Left = 889
-  Top = 190
+  Left = 623
+  Top = 197
   Width = 809
   Height = 640
   Caption = 'Replays'

Modified: trunk/Lobby/TASClient/ReplaysUnit.pas
===================================================================
--- trunk/Lobby/TASClient/ReplaysUnit.pas	2008-04-10 14:10:37 UTC (rev 5692)
+++ trunk/Lobby/TASClient/ReplaysUnit.pas	2008-04-10 18:36:29 UTC (rev 5693)
@@ -774,7 +774,7 @@
       sl.Free;
       if doReadPlayerStats then
         CloseFile(f);
-      Player^.Free;
+      player^.Free;
       FreeMem(player);
       Exit;
     end;
@@ -789,7 +789,7 @@
         sl.Free;
         if doReadPlayerStats then
           CloseFile(f);
-        Player^.Free;
+        player^.Free;
         FreeMem(player);
         Exit;
       end;
@@ -802,7 +802,7 @@
         sl.Free;
         if doReadPlayerStats then
           CloseFile(f);
-        Player^.Free;
+        player^.Free;
         FreeMem(player);
         Exit;
       end;
@@ -815,7 +815,7 @@
         sl.Free;
         if doReadPlayerStats then
           CloseFile(f);
-        Player^.Free;
+        player^.Free;
         FreeMem(player);
         Exit;
       end;
@@ -827,23 +827,24 @@
         sl.Free;
         if doReadPlayerStats then
           CloseFile(f);
-        Player^.Free;
+        player^.Free;
         FreeMem(player);
         Exit;
       end;
     end;
-    replay.PlayerList.Add(Player);
+    replay.PlayerList.Add(player);
 
     if doReadPlayerStats then
     begin
       try
-        BlockRead(f, Player^.Stats, sizeof(Player^.Stats));
+        BlockRead(f, player^.Stats, sizeof(player^.Stats));
       except
         //MainForm.AddMainLog('Error : couldn''t read the players stats in the replay file '+replay.FileName,Colors.Error);
         CloseFile(f);
         doReadPlayerStats := false;
       end;
     end;
+    
     Inc(count);
   end;
   sl.Free;

Deleted: trunk/Lobby/TASClient/SevenZip.pas
===================================================================
--- trunk/Lobby/TASClient/SevenZip.pas	2008-04-10 14:10:37 UTC (rev 5692)
+++ trunk/Lobby/TASClient/SevenZip.pas	2008-04-10 18:36:29 UTC (rev 5693)
@@ -1,800 +0,0 @@
-// Delphi interface to 7-zip32.dll
-// Written by Dominic Dum&#233;e (<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">dominic at psas.co.za</A>)
-// Purpose: to create and extract files in the 7-zip format (www.7-zip.org)
-
-// 7-zip32.dll written by Akky. Download it here:
-// <A HREF="http://akky.cjb.net/download/7-zip32.html">http://akky.cjb.net/download/7-zip32.html</A>
-
-// NB: I don't understand Japanese (no english docs are available for the dll)
-// so I don't understand the purpose of all of the functions available,
-// such as Set/GetCursorInterval, Cursormode etc...
-
-// If anyone out there can provide more info on all the functions in the dll
-// please let me know... :)
-
-//-----------------------------------------------------------------------------
-// HOW TO USE IT:
-// Your program first needs to call LoadSevenZipDLL before any of the functions
-// will work. Call UnloadSevenZipDLL when your program terminates...
-// Obviously 7-zip32.dll file must be available to program (such as in the
-// app's exe folder).
-
-// Use SevenZipCreateArchive, SevenZipExtractArchive function to easily create
-// and extract 7z files (with optional callback function)
-
-// If you know what you're doing use SevenZipCommand function (works just like
-// command line version of 7-zip). See 7-zip docs for command syntax.
-
-// To get contents of archive file use SevenZipOpenArchive, SevenZipFindFirst,
-// SevenZipFindNext and SevenZipCloseArchive (works like FindFirst, FindNext) 
-
-//-----------------------------------------------------------------------------
-// Revision history:
-// v1.00 17 June 2005 - First release
-// If you find any bugs or add any features please let me know
-
-// v1.01 1 September 2005
-// new feature:
-//  --&gt; Add parameter Password in SevenZipCreateArchive and SevenZipExtractArchive function
-//      by J&#233;ter Rabelo Ferreira (<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">jeter.rabelo at jerasoft.com.br</A>)
-
-// --&gt; Added BaseDirectory parameter to SevenZipCreateArchive for easier handling of
-//     relative paths (note that absolute paths ARE NOT supported by the DLL) [Dominic Dum&#233;e]
-
-unit SevenZip;
-
-interface
-uses windows;
-
-const
-  // codes returned by SevenZipCreateArchive and SevenZipExtractArchive
-  SZ_OK = 0;
-  SZ_ERROR = 1;
-  SZ_CANCELLED = 2;
-  SZ_DLLERROR = 3;
-
-  FNAME_MAX32	= 512;
-  // these get returned as nState in the Callback function
-  ARCEXTRACT_BEGIN = 0;
-  ARCEXTRACT_INPROCESS = 1;
-  ARCEXTRACT_END = 2;
-  ARCEXTRACT_OPEN	= 3;
-  ARCEXTRACT_COPY	= 4;
-
-  // functions (QueryFunctionList)
-  ISARC								            = 0	; (* SevenZip *)
-  ISARC_GET_VERSION					      = 1	; (* SevenZipGetVersion *)
-  ISARC_GET_CURSOR_INTERVAL			  = 2	; (* SevenZipGetCursorInterval *)
-  ISARC_SET_CURSOR_INTERVAL			  = 3	; (* SevenZipSetCursorInterval *)
-  ISARC_GET_BACK_GROUND_MODE			= 4	; (* SevenZipGetBackGroundMode *)
-  ISARC_SET_BACK_GROUND_MODE			= 5	; (* SevenZipSetBackGroundMode *)
-  ISARC_GET_CURSOR_MODE				    = 6	; (* SevenZipGetCursorMode *)
-  ISARC_SET_CURSOR_MODE				    = 7	; (* SevenZipSetCursorMode *)
-  ISARC_GET_RUNNING					      = 8	; (* SevenZipGetRunning *)
-
-  ISARC_CHECK_ARCHIVE					    = 16	; (* SevenZipCheckArchive *)
-  ISARC_CONFIG_DIALOG					    = 17	; (* SevenZipConfigDialog *)
-  ISARC_GET_FILE_COUNT				    = 18	; (* SevenZipGetFileCount *)
-  ISARC_QUERY_FUNCTION_LIST			  = 19	; (* SevenZipQueryFunctionList *)
-  ISARC_HOUT							        = 20	; (* SevenZipHOut *)
-  ISARC_STRUCTOUT						      = 21	; (* SevenZipStructOut *)
-  ISARC_GET_ARC_FILE_INFO				  = 22	; (* SevenZipGetArcFileInfo *)
-
-  ISARC_OPEN_ARCHIVE					    = 23	; (* SevenZipOpenArchive *)
-  ISARC_CLOSE_ARCHIVE					    = 24	; (* SevenZipCloseArchive *)
-  ISARC_FIND_FIRST					      = 25	; (* SevenZipFindFirst *)
-  ISARC_FIND_NEXT						      = 26	; (* SevenZipFindNext *)
-  ISARC_EXTRACT						        = 27	; (* SevenZipExtract *)
-  ISARC_ADD							          = 28	; (* SevenZipAdd *)
-  ISARC_MOVE							        = 29	; (* SevenZipMove *)
-  ISARC_DELETE						        = 30	; (* SevenZipDelete *)
-  ISARC_SETOWNERWINDOW				    = 31	; (* SevenZipSetOwnerWindow *)
-  ISARC_CLEAROWNERWINDOW				  = 32	; (* SevenZipClearOwnerWindow *)
-  ISARC_SETOWNERWINDOWEX				  = 33	; (* SevenZipSetOwnerWindowEx *)
-  ISARC_KILLOWNERWINDOWEX				  = 34	; (* SevenZipKillOwnerWindowEx *)
-
-  ISARC_GET_ARC_FILE_NAME				  = 40	; (* SevenZipGetArcFileName *)
-  ISARC_GET_ARC_FILE_SIZE				  = 41	; (* SevenZipGetArcFileSize *)
-  ISARC_GET_ARC_ORIGINAL_SIZE			= 42	; (* SevenZipArcOriginalSize *)
-  ISARC_GET_ARC_COMPRESSED_SIZE		= 43	; (* SevenZipGetArcCompressedSize *)
-  ISARC_GET_ARC_RATIO					    = 44	; (* SevenZipGetArcRatio *)
-  ISARC_GET_ARC_DATE					    = 45	; (* SevenZipGetArcDate *)
-  ISARC_GET_ARC_TIME					    = 46	; (* SevenZipGetArcTime *)
-  ISARC_GET_ARC_OS_TYPE				    = 47	; (* SevenZipGetArcOSType *)
-  ISARC_GET_ARC_IS_SFX_FILE			  = 48	; (* SevenZipGetArcIsSFXFile *)
-  ISARC_GET_ARC_WRITE_TIME_EX			= 49	; (* SevenZipGetArcWriteTimeEx *)
-  ISARC_GET_ARC_CREATE_TIME_EX		= 50	; (* SevenZipGetArcCreateTimeEx *)
- 	ISARC_GET_ARC_ACCESS_TIME_EX		= 51	; (* SevenZipGetArcAccessTimeEx *)
- 	ISARC_GET_ARC_CREATE_TIME_EX2		= 52	; (* SevenZipGetArcCreateTimeEx2 *)
-  ISARC_GET_ARC_WRITE_TIME_EX2		= 53	; (* SevenZipGetArcWriteTimeEx2 *)
-  ISARC_GET_FILE_NAME					    = 57	; (* SevenZipGetFileName *)
-  ISARC_GET_ORIGINAL_SIZE				  = 58	; (* SevenZipGetOriginalSize *)
-  ISARC_GET_COMPRESSED_SIZE			  = 59	; (* SevenZipGetCompressedSize *)
-  ISARC_GET_RATIO						      = 60	; (* SevenZipGetRatio *)
-  ISARC_GET_DATE						      = 61	; (* SevenZipGetDate *)
-  ISARC_GET_TIME						      = 62	; (* SevenZipGetTime *)
-  ISARC_GET_CRC						        = 63	; (* SevenZipGetCRC *)
-  ISARC_GET_ATTRIBUTE					    = 64	; (* SevenZipGetAttribute *)
-  ISARC_GET_OS_TYPE					      = 65	; (* SevenZipGetOSType *)
-  ISARC_GET_METHOD					      = 66	; (* SevenZipGetMethod *)
-  ISARC_GET_WRITE_TIME				    = 67	; (* SevenZipGetWriteTime *)
-  ISARC_GET_CREATE_TIME				    = 68	; (* SevenZipGetCreateTime *)
-  ISARC_GET_ACCESS_TIME				    = 69	; (* SevenZipGetAccessTime *)
-  ISARC_GET_WRITE_TIME_EX				  = 70	; (* SevenZipGetWriteTimeEx *)
-  ISARC_GET_CREATE_TIME_EX			  = 71	; (* SevenZipGetCreateTimeEx *)
-  ISARC_GET_ACCESS_TIME_EX			  = 72	; (* SevenZipGetAccessTimeEx *)
-  ISARC_SET_ENUM_MEMBERS_PROC			= 80 ; (* SevenZipSetEnumMembersProc *)
-  ISARC_CLEAR_ENUM_MEMBERS_PROC		= 81	; (* SevenZipClearEnumMembersProc *)
-  ISARC_GET_ARC_FILE_SIZE_EX			= 82	; (* SevenZipGetArcFileSizeEx *)
-  ISARC_GET_ARC_ORIGINAL_SIZE_EX	=	83	; (* SevenZipArcOriginalSizeEx *)
-  ISARC_GET_ARC_COMPRESSED_SIZE_EX = 84	; (* SevenZipGetArcCompressedSizeEx *)
-  ISARC_GET_ORIGINAL_SIZE_EX			= 85	; (* SevenZipGetOriginalSizeEx *)
-  ISARC_GET_COMPRESSED_SIZE_EX		= 86	; (* SevenZipGetCompressedSizeEx *)
-  ISARC_SETOWNERWINDOWEX64			  = 87	; (* SevenZipSetOwnerWindowEx64 *)
-  ISARC_KILLOWNERWINDOWEX64			  = 88	; (* SevenZipKillOwnerWindowEx64 *)
-  ISARC_SET_ENUM_MEMBERS_PROC64		= 89  ; (* SevenZipSetEnumMembersProc64 *)
-  ISARC_CLEAR_ENUM_MEMBERS_PROC64	= 90	; (* SevenZipClearEnumMembersProc64 *)
-  ISARC_OPEN_ARCHIVE2					    = 91	; (* SevenZipOpenArchive2 *)
-  ISARC_GET_ARC_READ_SIZE				  = 92	; (* SevenZipGetArcReadSize *)
-  ISARC_GET_ARC_READ_SIZE_EX			= 93	; (* SevenZipGetArcReadSizeEx*)
-
-
-// Errors
-  ERROR_START				              = $8000;
-
-// (* WARNING *)
-  ERROR_DISK_SPACE		            = $8005;
-  ERROR_READ_ONLY			            = $8006;
-  ERROR_USER_SKIP			            = $8007;
-  ERROR_UNKNOWN_TYPE		          = $8008;
-  ERROR_METHOD			              = $8009;
-  ERROR_PASSWORD_FILE		          = $800A;
-  ERROR_VERSION			              = $800B;
-  ERROR_FILE_CRC			            = $800C;
-  ERROR_FILE_OPEN			            = $800D;
-  ERROR_MORE_FRESH		            = $800E;
-  ERROR_NOT_EXIST			            = $800F;
-  ERROR_ALREADY_EXIST		          = $8010;
-
-  ERROR_TOO_MANY_FILES	          = $8011;
-
-// (* ERROR *)
-  ERROR_MAKEDIRECTORY		          = $8012;
-  ERROR_CANNOT_WRITE		          = $8013;
-  ERROR_HUFFMAN_CODE		          = $8014;
-  ERROR_COMMENT_HEADER	          = $8015;
-  ERROR_HEADER_CRC		            = $8016;
-  ERROR_HEADER_BROKEN		          = $8017;
-  ERROR_ARC_FILE_OPEN		          = $8018;
-  ERROR_NOT_ARC_FILE		          = $8019;
-  ERROR_CANNOT_READ		            = $801A;
-  ERROR_FILE_STYLE		            = $801B;
-  ERROR_COMMAND_NAME		          = $801C;
-  ERROR_MORE_HEAP_MEMORY	        = $801D;
-  ERROR_ENOUGH_MEMORY		          = $801E;
-  ERROR_ALREADY_RUNNING	          = $801F;
-  ERROR_USER_CANCEL		            = $8020;
-  ERROR_HARC_ISNOT_OPENED	        = $8021;
-  ERROR_NOT_SEARCH_MODE	          = $8022;
-  ERROR_NOT_SUPPORT		            = $8023;
-  ERROR_TIME_STAMP		            = $8024;
-  ERROR_TMP_OPEN			            = $8025;
-  ERROR_LONG_FILE_NAME	          = $8026;
-  ERROR_ARC_READ_ONLY		          = $8027;
-  ERROR_SAME_NAME_FILE	          = $8028;
-  ERROR_NOT_FIND_ARC_FILE         = $8029;
-  ERROR_RESPONSE_READ		          = $802A;
-  ERROR_NOT_FILENAME		          = $802B;
-  ERROR_TMP_COPY			            = $802C;
-  ERROR_EOF				                = $802D;
-  ERROR_ADD_TO_LARC		            = $802E;
-  ERROR_TMP_BACK_SPACE	          = $802F;
-  ERROR_SHARING			              = $8030;
-  ERROR_NOT_FIND_FILE		          = $8031;
-  ERROR_LOG_FILE			            = $8032;
- 	ERROR_NO_DEVICE			            = $8033;
-  ERROR_GET_ATTRIBUTES	          = $8034;
-  ERROR_SET_ATTRIBUTES	          = $8035;
-  ERROR_GET_INFORMATION	          = $8036;
-  ERROR_GET_POINT			            = $8037;
-  ERROR_SET_POINT			            = $8038;
-  ERROR_CONVERT_TIME		          = $8039;
-  ERROR_GET_TIME			            = $803a;
-  ERROR_SET_TIME			            = $803b;
-  ERROR_CLOSE_FILE		            = $803c;
-  ERROR_HEAP_MEMORY		            = $803d;
-  ERROR_HANDLE			              = $803e;
-  ERROR_TIME_STAMP_RANGE	        = $803f;
-  ERROR_MAKE_ARCHIVE		          = $8040;
-  ERROR_NOT_CONFIRM_NAME	        = $8041;
-  ERROR_UNEXPECTED_EOF	          = $8042;
-  ERROR_INVALID_END_MARK	        = $8043;
-  ERROR_INVOLVED_LZH		          = $8044;
-  ERROR_NO_END_MARK		            = $8045;
-  ERROR_HDR_INVALID_SIZE	        = $8046;
-  ERROR_UNKNOWN_LEVEL		          = $8047;
-  ERROR_BROKEN_DATA		            = $8048;
-
-  FA_RDONLY		 = $01;
-  FA_HIDDEN		 = $02;
-  FA_SYSTEM		 = $04;
-  FA_LABEL		 = $08;
-  FA_DIREC		 = $10;
-  FA_ARCH 		 = $20;
-  FA_ENCRYPTED = $40;
-
-  ERROR_7ZIP_START                    = $8100;
-
-  ERROR_WARNING		                    = $8101;
-  ERROR_FATAL			                    = $8102;
-  ERROR_DURING_DECOMPRESSION          = $8103;
-  ERROR_DIR_FILE_WITH_64BIT_SIZE      = $8104;
-  ERROR_FILE_CHANGED_DURING_OPERATION	= $8105;
-
-  ARCHIVETYPE_ZIP	= 1;
-  ARCHIVETYPE_7Z	=	2;
-
-
-type
-
-  HARC = integer;
-
-  TSevenZipEXTRACTINGINFO = record
-    dwFileSize          : DWORD;
-    dwWriteSize         : DWORD;
-    szSourceFileName    : array[ 0..FNAME_MAX32 ] of char;
-    dummy1              : array[ 0..2 ] of char;
-    szDestFileName      : array[ 0..FNAME_MAX32 ] of char;
-    dummy               : array[ 0..2 ] of char;
-  end;
-
-  TSevenZipEXTRACTINGINFOEX = record
-    exinfo           : TSevenZipEXTRACTINGINFO;
-    dwCompressedSize : DWORD;
-    dwCRC            : DWORD;
-    uOSType          : UINT;
-    wRatio           : WORD;
-    wDate            : WORD;
-    wTime            : WORD;
-    szAttribute      : array[ 0..7 ] of char;
-    szMode           : array[ 0..7 ] of char;
-  end;
-
-  TSevenZipINDIVIDUALINFO = record
-    dwOriginalSize   : DWORD;
-	  dwCompressedSize : DWORD;
-	  dwCRC            : DWORD;
-    uFlag            : UINT;
-		uOSType          : UINT;
-    wRatio           : WORD;
-    wDate            : WORD;
-    wTime            : WORD;
-    szFilename       : array[ 0..FNAME_MAX32 ] of char;
-    dummy1           : array[ 0..2 ] of char;
-    szAttribute      : array[ 0..7 ] of char;
-    szMode           : array[ 0..7 ] of char;
-  end;
-
-  TSevenZipCommand                = function (const hWnd: HWND; szCmdLine: PChar; szOutput: PChar; dwSize: DWORD): Integer; stdcall;
-	TSevenZipGetVersion             = function : WORD; stdcall;
-  TSevenZipGetCursorMode          = function : BOOL; stdcall;
-  TSevenZipSetCursorMode          = function( CursorMode : BOOL ) : BOOL; stdcall;
-  TSevenZipGetCursorInterval      = function : WORD; stdcall;
-  TSevenZipSetCursorInterval      = function( CursorInterval : WORD ) : WORD; stdcall; // millisecs
-  TSevenZipGetBackgroundMode      = function : BOOL; stdcall;
-  TSevenZipSetBackgroundMode      = function( BackgroundMode : BOOL ) : BOOL; stdcall;
-	TSevenZipGetRunning             = function : BOOL; stdcall;
-
-  TSevenZipConfigDialog           = function( hwnd : HWND; szOptionBuffer : PChar; iMode : integer ) : BOOL; stdcall;
-  TSevenZipCheckArchive           = function( szFilename : PChar; iMode : integer ) : BOOL; stdcall;
-  TSevenZipGetFileCount           = function( szArcFile : PChar ) : integer; stdcall;
-  TSevenZipQueryFunctionList      = function( iFunction : integer ) : BOOL; stdcall;
-
-	TSevenZipOpenArchive            = function( hwnd : HWND; szFileName : PChar; dwMode : DWORD ) : HARC; stdcall;
-	TSevenZipCloseArchive           = function( harc : HARC ) : integer; stdcall;
-	TSevenZipFindFirst              = function( harc : HARC; szFilename : PChar; var lpSubInfo : TSevenZipINDIVIDUALINFO ) : integer; stdcall;
-	TSevenZipFindNext               = function( harc : HARC; var lpSubInfo : TSevenZipINDIVIDUALINFO ) : integer; stdcall;
-	TSevenZipGetArcFileName         = function( harc : HARC; lpBuffer : pchar; nSize : integer ) : integer; stdcall;
-	TSevenZipGetArcFileSize         = function( harc : HARC ) : DWORD; stdcall;
-	TSevenZipGetArcOriginalSize     = function( harc : HARC ) : DWORD; stdcall;
-	TSevenZipGetArcCompressedSize   = function( harc : HARC ) : DWORD; stdcall;
-	TSevenZipGetArcRatio            = function( harc : HARC ) : WORD; stdcall;
-	TSevenZipGetArcDate             = function( harc : HARC ) : WORD; stdcall;
-	TSevenZipGetArcTime             = function( harc : HARC ) : WORD; stdcall;
-	TSevenZipGetArcOSType           = function( harc : HARC ) : UINT; stdcall;
-	TSevenZipIsSFXFile              = function( harc : HARC ) : integer; stdcall;
-	TSevenZipGetFileName            = function( harc : HARC ; lpBuffer : PChar; nsize : integer) : integer; stdcall;
-	TSevenZipGetOriginalSize        = function( harc : HARC ) : DWORD; stdcall;
-	TSevenZipGetCompressedSize      = function( harc : HARC ) : DWORD; stdcall;
-	TSevenZipGetRatio               = function( harc : HARC ) : WORD; stdcall;
-	TSevenZipGetDate                = function( harc : HARC ) : WORD; stdcall;
-	TSevenZipGetTime                = function( harc : HARC ) : WORD; stdcall;
-	TSevenZipGetCRC                 = function( harc : HARC ) : DWORD; stdcall;
-	TSevenZipGetAttribute           = function( harc : HARC ) : integer; stdcall;
-	TSevenZipGetOSType              = function( harc : HARC ) : UINT; stdcall;
-	TSevenZipGetMethod              = function( harc : HARC ; lpBuffer : PChar; nsize : integer) : integer; stdcall;
-	TSevenZipGetWriteTime           = function( harc : HARC ) : DWORD; stdcall;
-	TSevenZipGetWriteTimeEx         = function( harc : HARC; var lpftLastWriteTime : FILETIME ) : BOOL; stdcall;
-	TSevenZipGetArcCreateTimeEx     = function( harc : HARC; var lpftCreationTime : FILETIME ) : BOOL; stdcall;
-	TSevenZipGetArcAccessTimeEx     = function( harc : HARC; var lpftLastAccessTime : FILETIME ) : BOOL; stdcall;
-	TSevenZipGetArcWriteTimeEx      = function( harc : HARC; var lpftLastWriteTime : FILETIME ) : BOOL; stdcall;
-	TSevenZipGetArcFileSizeEx       = function( harc : HARC; var lpllSize : TLargeInteger ) : BOOL; stdcall;
-	TSevenZipGetArcOriginalSizeEx   = function( harc : HARC; var lpllSize : TLargeInteger ) : BOOL; stdcall;
-	TSevenZipGetArcCompressedSizeEx = function( harc : HARC; var lpllSize : TLargeInteger ) : BOOL; stdcall;
-	TSevenZipGetOriginalSizeEx      = function( harc : HARC; var lpllSize : TLargeInteger  ) : BOOL; stdcall;
-	TSevenZipGetCompressedSizeEx    = function( harc : HARC; var lpllSize : TLargeInteger ) : BOOL; stdcall;
-
-  // Callback func should return FALSE to cancel the archiving process, else TRUE
-  TSevenZipCallbackProc           = function( hWnd : HWND; uMsg, nState : UINT; var ExInfo : TSevenZipEXTRACTINGINFOEX ) : BOOL of object;stdcall;
-
-  TSevenZipSetOwnerWindow         = function( hwnd : HWND ) : BOOL; stdcall;
-	TSevenZipClearOwnerWindow       = function : BOOL; stdcall;
-  TSevenZipSetOwnerWindowEx       = function( hwnd : HWND; CallbackProc : TSevenZipCallbackProc ) : BOOL; stdcall;
-	TSevenZipKillOwnerWindowEx      = function( hwnd : HWND ) : BOOL; stdcall;
-
-	TSevenZipGetSubVersion          = function : WORD; stdcall;
-	TSevenZipGetArchiveType         = function( szFileName : pchar ) : integer; stdcall;
-	TSevenZipSetUnicodeMode         = function( bUnicode : BOOL ) : BOOL; stdcall;
-
-function LoadSevenZipDLL : Boolean;
-function UnloadSevenZipDLL : Boolean;
-
-// NB: add '-hide' to command line switches if you want the CallBack function to be called
-// (set up via SevenZipSetOwnerWindowEx).
-// otherwise the DLL uses it's own internal progress dialog
-function SevenZipCommand( hWnd : HWND;                     // parent window
-                          CommandLine : string;            // 7zip command line (see 7zip docs)
-                          var CommandOutput : string;      // returns 7zip output
-                          MaxCommandOutputLen : integer = 32768 ) : integer;
-
-// simplified func to create archive
-function SevenZipCreateArchive( hWnd : HWND; // parent window handle
-                                ArchiveFilename : string;
-                                BaseDirectory : string; // all filenames in FileList must be relative to this directory (absolute paths e.g. &quot;c:\temp\test.txt&quot; not allowed, but &quot;temp\test.txt&quot; allowed)
-                                FileList : string; // comma separated files to be added to archive (wildcards ok)
-                                CompressionLevel : integer;   // 0 = none, 9=max
-                                CreateSolidArchive : Boolean; // solid = better compression for multiple files
-                                RecurseFolders : Boolean;     // recurse folders?
-                                Password: String; // '' Nothing happens
-                                ShowProgress   : Boolean;     // if true uses dll's internal progress indicator (callback func ignored)
-                                Callback       : TSevenZipCallbackProc = nil ) // optional callback (ShowProgress must be false)
-                                : integer;
-
-// simplified func to extract archive
-function SevenZipExtractArchive( hWnd : HWND; // parent window handle
-                                 ArchiveFilename : string;
-                                 FileList : string; // comma separated files to be extracted (wildcards ok)
-                                 RecurseFolders : Boolean;
-                                 Password: String; // '' Nothing happens
-                                 ExtractFullPaths : Boolean;
-                                 ExtractBaseDir : string;
-                                 ShowProgress   : Boolean;     // if true uses dll's internal progress indicator (callback func ignored)
-                                 Callback       : TSevenZipCallbackProc = nil ) // optional callback (ShowProgress must be false)
-                                 : integer; // 0 = success
-function SevenZipErrNbToMsg(errNb: integer):string;
-
-
-var
-  _SevenZipCommand              : TSevenZipCommand              = nil;
-  SevenZipGetVersion            : TSevenZipGetVersion           = nil;
-  SevenZipGetCursorMode         : TSevenZipGetCursorMode        = nil;
-  SevenZipSetCursorMode         : TSevenZipSetCursorMode        = nil;
-  SevenZipGetCursorInterval     : TSevenZipGetCursorInterval    = nil;
-  SevenZipSetCursorInterval     : TSevenZipSetCursorInterval    = nil;
-  SevenZipGetBackgroundMode     : TSevenZipGetBackgroundMode    = nil;
-  SevenZipSetBackgroundMode     : TSevenZipSetBackgroundMode    = nil;
-  SevenZipGetRunning            : TSevenZipGetRunning           = nil;
-
-  SevenZipConfigDialog          : TSevenZipConfigDialog         = nil;
-  SevenZipCheckArchive          : TSevenZipCheckArchive         = nil;
-  SevenZipGetFileCount          : TSevenZipGetFileCount         = nil;
-  SevenZipQueryFunctionList     : TSevenZipQueryFunctionList    = nil;
-
-  SevenZipOpenArchive           : TSevenZipOpenArchive          = nil;
-  SevenZipCloseArchive          : TSevenZipCloseArchive         = nil;
-  SevenZipFindFirst             : TSevenZipFindFirst            = nil;
-  SevenZipFindNext              : TSevenZipFindNext             = nil;
-  SevenZipGetArcFileName        : TSevenZipGetArcFileName       = nil;
-  SevenZipGetArcFileSize        : TSevenZipGetArcFileSize       = nil;
-  SevenZipGetArcOriginalSize    : TSevenZipGetArcOriginalSize   = nil;
-  SevenZipGetArcCompressedSize  : TSevenZipGetArcCompressedSize = nil;
-  SevenZipGetArcRatio           : TSevenZipGetArcRatio          = nil;
-  SevenZipGetArcDate            : TSevenZipGetArcDate           = nil;
-  SevenZipGetArcTime            : TSevenZipGetArcTime           = nil;
-  SevenZipGetArcOSType          : TSevenZipGetArcOSType         = nil;
-  SevenZipIsSFXFile             : TSevenZipIsSFXFile            = nil;
-  SevenZipGetFileName           : TSevenZipGetFileName          = nil;
-  SevenZipGetOriginalSize       : TSevenZipGetOriginalSize      = nil;
-  SevenZipGetCompressedSize     : TSevenZipGetCompressedSize    = nil;
-  SevenZipGetRatio              : TSevenZipGetRatio             = nil;
-  SevenZipGetDate               : TSevenZipGetDate              = nil;   
-  SevenZipGetTime               : TSevenZipGetTime              = nil;   
-  SevenZipGetCRC                : TSevenZipGetCRC               = nil;
-  SevenZipGetAttribute          : TSevenZipGetAttribute         = nil;   
-  SevenZipGetOSType             : TSevenZipGetOSType            = nil;   
-  SevenZipGetMethod             : TSevenZipGetMethod            = nil;   
-  SevenZipGetWriteTime          : TSevenZipGetWriteTime         = nil;
-  SevenZipGetWriteTimeEx        : TSevenZipGetWriteTimeEx       = nil;
-  SevenZipGetArcCreateTimeEx    : TSevenZipGetArcCreateTimeEx   = nil;   
-  SevenZipGetArcAccessTimeEx    : TSevenZipGetArcAccessTimeEx   = nil;   
-  SevenZipGetArcWriteTimeEx     : TSevenZipGetArcWriteTimeEx    = nil;   
-  SevenZipGetArcFileSizeEx      : TSevenZipGetArcFileSizeEx     = nil;   
-  SevenZipGetArcOriginalSizeEx  : TSevenZipGetArcOriginalSizeEx = nil;   
-  SevenZipGetArcCompressedSizeEx: TSevenZipGetArcCompressedSizeEx= nil;
-  SevenZipGetOriginalSizeEx     : TSevenZipGetOriginalSizeEx    = nil; 
-  SevenZipGetCompressedSizeEx   : TSevenZipGetCompressedSizeEx  = nil;
-
-  SevenZipSetOwnerWindow        : TSevenZipSetOwnerWindow       = nil; 
-  SevenZipClearOwnerWindow      : TSevenZipClearOwnerWindow     = nil; 
-  SevenZipSetOwnerWindowEx      : TSevenZipSetOwnerWindowEx     = nil; 
-  SevenZipKillOwnerWindowEx     : TSevenZipKillOwnerWindowEx    = nil; 
-
-  SevenZipGetSubVersion         : TSevenZipGetSubVersion        = nil; 
-  SevenZipGetArchiveType        : TSevenZipGetArchiveType       = nil;
-  SevenZipSetUnicodeMode        : TSevenZipSetUnicodeMode       = nil;
-  LastError : String;
-implementation
-uses classes, sysutils, dialogs;
-
-var
-  _SevenZipDLLHandle : THandle = 0;
-
-function LoadSevenZipDLL : Boolean;
-
-begin
-  Result := FALSE;
-
-  if _SevenZipDLLHandle &lt;&gt; 0 then
-    exit;
-
-  _SevenZipDLLHandle := LoadLibrary( '7-zip32.dll' );
-  if _SevenZipDLLHandle &gt; 0 then
-  begin
-    _SevenZipCommand             := GetProcAddress( _SevenZipDLLHandle, 'SevenZip' );
-
-    SevenZipGetVersion           := GetProcAddress( _SevenZipDLLHandle, 'SevenZipGetVersion' );
-    SevenZipGetCursorMode        := GetProcAddress( _SevenZipDLLHandle, 'SevenZipGetCursorMode' );
-    SevenZipSetCursorMode        := GetProcAddress( _SevenZipDLLHandle, 'SevenZipSetCursorMode' );
-    SevenZipGetCursorInterval    := GetProcAddress( _SevenZipDLLHandle, 'SevenZipGetCursorInterval' );
-    SevenZipSetCursorInterval    := GetProcAddress( _SevenZipDLLHandle, 'SevenZipSetCursorInterval' );
-    SevenZipGetBackgroundMode    := GetProcAddress( _SevenZipDLLHandle, 'SevenZipGetBackgroundMode' );
-    SevenZipSetBackgroundMode    := GetProcAddress( _SevenZipDLLHandle, 'SevenZipSetBackgroundMode' );
-    SevenZipGetRunning           := GetProcAddress( _SevenZipDLLHandle, 'SevenZipGetRunning' );
-
-    SevenZipConfigDialog         := GetProcAddress( _SevenZipDLLHandle, 'SevenZipConfigDialog' );
-    SevenZipCheckArchive         := GetProcAddress( _SevenZipDLLHandle, 'SevenZipCheckArchive' );
-    SevenZipGetFileCount         := GetProcAddress( _SevenZipDLLHandle, 'SevenZipGetFileCount' );
-    SevenZipQueryFunctionList    := GetProcAddress( _SevenZipDLLHandle, 'SevenZipQueryFunctionList' );
-
-    SevenZipOpenArchive          := GetProcAddress( _SevenZipDLLHandle, 'SevenZipOpenArchive' );
-    SevenZipCloseArchive         := GetProcAddress( _SevenZipDLLHandle, 'SevenZipCloseArchive' );
-    SevenZipFindFirst            := GetProcAddress( _SevenZipDLLHandle, 'SevenZipFindFirst' );
-    SevenZipFindNext             := GetProcAddress( _SevenZipDLLHandle, 'SevenZipFindNext' );
-    SevenZipGetArcFileName       := GetProcAddress( _SevenZipDLLHandle, 'SevenZipGetArcFileName' );      
-    SevenZipGetArcFileSize       := GetProcAddress( _SevenZipDLLHandle, 'SevenZipGetArcFileSize' );      
-    SevenZipGetArcOriginalSize   := GetProcAddress( _SevenZipDLLHandle, 'SevenZipGetArcOriginalSize' );  
-    SevenZipGetArcCompressedSize := GetProcAddress( _SevenZipDLLHandle, 'SevenZipGetArcCompressedSize' );
-    SevenZipGetArcRatio          := GetProcAddress( _SevenZipDLLHandle, 'SevenZipGetArcRatio' );         
-    SevenZipGetArcDate           := GetProcAddress( _SevenZipDLLHandle, 'SevenZipGetArcDate' );          
-    SevenZipGetArcTime           := GetProcAddress( _SevenZipDLLHandle, 'SevenZipGetArcTime' );          
-    SevenZipGetArcOSType         := GetProcAddress( _SevenZipDLLHandle, 'SevenZipGetArcOSType' );        
-    SevenZipIsSFXFile            := GetProcAddress( _SevenZipDLLHandle, 'SevenZipIsSFXFile' );           
-    SevenZipGetFileName          := GetProcAddress( _SevenZipDLLHandle, 'SevenZipGetFileName' );         
-    SevenZipGetOriginalSize      := GetProcAddress( _SevenZipDLLHandle, 'SevenZipGetOriginalSize' );     
-    SevenZipGetCompressedSize    := GetProcAddress( _SevenZipDLLHandle, 'SevenZipGetCompressedSize' );
-    SevenZipGetRatio             := GetProcAddress( _SevenZipDLLHandle, 'SevenZipGetRatio' );            
-    SevenZipGetDate              := GetProcAddress( _SevenZipDLLHandle, 'SevenZipGetDate' );             
-    SevenZipGetTime              := GetProcAddress( _SevenZipDLLHandle, 'SevenZipGetTime' );             
-    SevenZipGetCRC               := GetProcAddress( _SevenZipDLLHandle, 'SevenZipGetCRC' );              
-    SevenZipGetAttribute         := GetProcAddress( _SevenZipDLLHandle, 'SevenZipGetAttribute' );         
-    SevenZipGetOSType            := GetProcAddress( _SevenZipDLLHandle, 'SevenZipGetOSType' );            
-    SevenZipGetMethod            := GetProcAddress( _SevenZipDLLHandle, 'SevenZipGetMethod' );            
-    SevenZipGetWriteTime         := GetProcAddress( _SevenZipDLLHandle, 'SevenZipGetWriteTime' );         
-    SevenZipGetWriteTimeEx       := GetProcAddress( _SevenZipDLLHandle, 'SevenZipGetWriteTimeEx' );       
-    SevenZipGetArcCreateTimeEx   := GetProcAddress( _SevenZipDLLHandle, 'SevenZipGetArcCreateTimeEx' );   
-    SevenZipGetArcAccessTimeEx   := GetProcAddress( _SevenZipDLLHandle, 'SevenZipGetArcAccessTimeEx' );   
-    SevenZipGetArcWriteTimeEx    := GetProcAddress( _SevenZipDLLHandle, 'SevenZipGetArcWriteTimeEx' );
-    SevenZipGetArcFileSizeEx     := GetProcAddress( _SevenZipDLLHandle, 'SevenZipGetArcFileSizeEx' );
-    SevenZipGetArcOriginalSizeEx := GetProcAddress( _SevenZipDLLHandle, 'SevenZipGetArcOriginalSizeEx' ); 
-    SevenZipGetArcCompressedSizeEx := GetProcAddress( _SevenZipDLLHandle, 'SevenZipGetArcCompressedSizeEx' );
-    SevenZipGetOriginalSizeEx    := GetProcAddress( _SevenZipDLLHandle, 'SevenZipGetOriginalSizeEx' );
-    SevenZipGetCompressedSizeEx  := GetProcAddress( _SevenZipDLLHandle, 'SevenZipGetCompressedSizeEx' );
-
-    SevenZipSetOwnerWindow       := GetProcAddress( _SevenZipDLLHandle, 'SevenZipSetOwnerWindow' );
-    SevenZipClearOwnerWindow     := GetProcAddress( _SevenZipDLLHandle, 'SevenZipClearOwnerWindow' );
-    SevenZipSetOwnerWindowEx     := GetProcAddress( _SevenZipDLLHandle, 'SevenZipSetOwnerWindowEx' );
-    SevenZipKillOwnerWindowEx    := GetProcAddress( _SevenZipDLLHandle, 'SevenZipKillOwnerWindowEx' );
-
-    SevenZipGetSubVersion        := GetProcAddress( _SevenZipDLLHandle, 'SevenZipGetSubVersion' );
-    SevenZipGetArchiveType       := GetProcAddress( _SevenZipDLLHandle, 'SevenZipGetArchiveType' );
-    SevenZipSetUnicodeMode       := GetProcAddress( _SevenZipDLLHandle, 'SevenZipSetUnicodeMode' );
-
-    Result := TRUE;
-  end;
-
-end;
-
-function UnloadSevenZipDLL : Boolean;
-
-begin
-  Result := FALSE;
-
-  if _SevenZipDLLHandle &lt;&gt; 0 then
-  begin
-    FreeLibrary( _SevenZipDLLHandle );
-    _SevenZipDLLHandle := 0;
-    Result := TRUE;
-  end;
-end;
-
-function SevenZipCommand( hWnd : HWND;
-                          CommandLine : string;
-                          var CommandOutput : string;
-                          MaxCommandOutputLen : integer = 32768 ) : integer;
-
-begin
-  SetLength( CommandOutput, MaxCommandOutputLen );
-  Result := _SevenZipCommand( hWnd, PChar( CommandLine), PChar( CommandOutput ), MaxCommandOutputLen - 1 );
-  CommandOutput := string( PChar( CommandOutput ) );
-end;
-
-function RemoveQuotes( s : string ) : string;
-
-begin
-  if ( Copy( s, 1, 1 ) = '&quot;' ) and ( Copy( s, Length( s ), 1 ) = '&quot;' ) then
-    Result := Copy( s, 2, Length( s ) - 2 )
-  else
-    Result := s;
-end;
-
-function SevenZipCreateArchive( hWnd : HWND; // parent window handle
-                                ArchiveFilename : string;
-                                BaseDirectory : string; // all filenames in FileList must be relative to this directory (absolute paths e.g. &quot;c:\temp\test.txt&quot; not allowed, but &quot;temp\test.txt&quot; allowed)
-                                FileList : string; // comma separated files to be added to archive (wildcards ok) - all relative to BaseDirectory
-                                CompressionLevel : integer;   // 0 = none, 9=max
-                                CreateSolidArchive : Boolean; // solid = better compression for multiple files
-                                RecurseFolders : Boolean;     // recurse folders?
-                                Password: String; // '' Nothing happens
-                                ShowProgress   : Boolean;     // if true uses dll's internal progress indicator (callback func ignored)
-                                Callback       : TSevenZipCallbackProc = nil ) // optional callback (ShowProgress must be false)
-                                : integer; // 0 = success
-
-var
-  flist : TStringList;
-  S7ResultOutput : string;
-  s7cmd : string;
-  i : integer;
-  cwd : string;
-
-begin
-  //
-  cwd := GetCurrentDir;
-
-  // change to base dir so relative paths work correctly
-  if not SetCurrentDir( BaseDirectory ) then
-  begin
-    Result := SZ_ERROR;
-    exit;
-  end;
-
-  flist := TStringList.Create;
-  flist.CommaText := FileList;
-
-  if @Callback &lt;&gt; nil then
-    ShowProgress := FALSE;
-
-  try
-    s7cmd := 'a &quot;' + ArchiveFilename + '&quot; &quot;' + RemoveQuotes( flist[ 0 ] ) + '&quot;';
-
-    for i := 1 to flist.count - 1 do
-    begin
-      s7cmd := s7cmd + ' -i';
-      if RecurseFolders then
-        s7cmd := s7cmd + 'r';
-
-      s7cmd := s7cmd + '!&quot;' + RemoveQuotes( flist[ i ] ) + '&quot;';
-    end;
-
-    s7cmd := s7cmd + ' -mx' + IntToStr( CompressionLevel );
-    if RecurseFolders then
-      s7Cmd := s7cmd + ' -r';
-
-    if Password &lt;&gt; '' then
-      s7Cmd := s7Cmd + ' -p' + Password;
-
-    if CreateSolidArchive then
-      s7cmd := s7cmd + ' -ms=on'
-    else
-      s7cmd := s7cmd + ' -ms=off';
-
-    if not ShowProgress then
-      s7cmd := s7cmd + ' -hide';
-
-    try
-      SevenZipSetOwnerWindowEx( hwnd, Callback );
-
-      SevenZipCommand( hWnd, s7cmd, s7ResultOutput );
-
-      SevenZipSetOwnerWindowEx( hwnd, nil );
-
-      S7ResultOutput := string(PChar(S7ResultOutput));
-
-      if Pos( 'operation aborted', Lowercase( S7ResultOutput ) ) &gt; 0 then
-        Result := SZ_CANCELLED
-      else
-      if Pos('error:', LowerCase(S7ResultOutput)) &gt; 0 then
-      begin
-        LastError := S7ResultOutput;
-        Result := SZ_ERROR
-      end
-      else
-        Result := SZ_OK;
-    except
-      on e : exception do
-      begin
-        Result := SZ_DLLERROR;
-      end;
-    end;
-
-  finally
-    flist.Free;
-    SetCurrentDir( cwd ); // back to where we were
-  end;
-end;
-
-function SevenZipExtractArchive( hWnd : HWND; // parent window handle
-                                ArchiveFilename : string;
-                                FileList : string; // comma separated files to be extracted (wildcards ok)
-                                RecurseFolders : Boolean;
-                                Password: String; // '' Nothing happens
-                                ExtractFullPaths : Boolean;
-                                ExtractBaseDir : string;
-                                ShowProgress   : Boolean;     // if true uses dll's internal progress indicator (callback func ignored)
-                                Callback       : TSevenZipCallbackProc = nil ) // optional callback (ShowProgress must be false)
-                                : integer; // 0 = success
-
-var
-  flist : TStringList;
-  S7ResultOutput : string;
-  s7cmd : string;
-  i : integer;
-
-begin
-  //
-  flist := TStringList.Create;
-
-  if @Callback &lt;&gt; nil then
-    ShowProgress := FALSE;
-
-  if FileList = '' then
-    FileList := '*.*';
-
-  flist.CommaText := FileList;
-
-  try
-    if ExtractFullPaths then
-      s7cmd := 'x'
-    else
-      s7cmd := 'e';
-
-    s7cmd := s7cmd + ' &quot;' + ArchiveFilename + '&quot; -o&quot;' + ExtractBaseDir + '&quot;';
-
-    s7cmd := s7cmd + ' &quot;' + flist[ 0 ] + '&quot;';
-
-
-    for i := 1 to flist.count - 1 do
-    begin
-      s7cmd := s7cmd + ' -i';
-      if RecurseFolders then
-        s7cmd := s7cmd + 'r';
-
-      s7cmd := s7cmd + '!&quot;' + RemoveQuotes( flist[ i ] ) + '&quot;';
-    end;
-
-    if RecurseFolders then
-      s7cmd := s7cmd + ' -r';
-
-    if Password &lt;&gt; '' then
-      s7Cmd := s7Cmd + ' -p' + Password;  
-
-    if not ShowProgress then
-      s7cmd := s7cmd + ' -hide';
-
-    s7cmd := s7cmd + ' -y'; // yes on all queries (will overwrite)
-
-    try
-      SevenZipSetOwnerWindowEx( hwnd, Callback );
-
-      SevenZipCommand( hWnd, s7cmd, s7ResultOutput );
-
-      SevenZipSetOwnerWindowEx( hwnd, nil );
-
-      S7ResultOutput := string(PChar(S7ResultOutput));
-
-      if Pos( 'operation aborted', Lowercase( S7ResultOutput ) ) &gt; 0 then
-        Result := SZ_CANCELLED
-      else
-      if Pos('error:', LowerCase(S7ResultOutput)) &gt; 0 then
-      begin
-        LastError := S7ResultOutput;
-        Result := SZ_ERROR;
-      end
-      else
-        Result := SZ_OK;
-    except
-      on e : exception do
-      begin
-        Result := SZ_DLLERROR;
-      end;
-    end;
-
-  finally
-    flist.Free;
-  end;
-end;
-
-function SevenZipErrNbToMsg(errNb: integer):string;
-begin
-  case errNb of
-    $8012:Result := 'MAKEDIRECTORY';
-		$8013:Result := 'CANNOT_WRITE';
-		$8014:Result := 'HUFFMAN_CODE';
-		$8015:Result := 'COMMENT_HEADER';
-		$8016:Result := 'HEADER_CRC';
-		$8017:Result := 'HEADER_BROKEN';
-		$8018:Result := 'ARC_FILE_OPEN';
-		$8019:Result := 'NOT_ARC_FILE';
-		$801A:Result := 'CANNOT_READ';
-		$801B:Result := 'FILE_STYLE';
-		$801C:Result := 'COMMAND_NAME';
-		$801D:Result := 'MORE_HEAP_MEMORY';
-		$801E:Result := 'ENOUGH_MEMORY';
-		$801F:Result := 'ALREADY_RUNNING';
-		$8020:Result := 'USER_CANCEL';
-		$8021:Result := 'HARC_ISNOT_OPENED';
-		$8022:Result := 'NOT_SEARCH_MODE';
-		$8023:Result := 'NOT_SUPPORT';
-		$8024:Result := 'TIME_STAMP';
-		$8025:Result := 'TMP_OPEN';
-		$8026:Result := 'LONG_FILE_NAME';
-		$8027:Result := 'ARC_READ_ONLY';
-		$8028:Result := 'SAME_NAME_FILE';
-		$8029:Result := 'NOT_FIND_ARC_FILE';
-		$802A:Result := 'RESPONSE_READ';
-		$802B:Result := 'NOT_FILENAME';
-		$802C:Result := 'TMP_COPY';
-		$802D:Result := 'EOF';
-		$802E:Result := 'ADD_TO_LARC';
-		$802F:Result := 'TMP_BACK_SPACE';
-		$8030:Result := 'SHARING';
-		$8031:Result := 'NOT_FIND_FILE';
-		$8032:Result := 'LOG_FILE';
-		$8033:Result := 'NO_DEVICE';
-		$8034:Result := 'GET_ATTRIBUTES';
-		$8035:Result := 'SET_ATTRIBUTES';
-		$8036:Result := 'GET_INFORMATION';
-		$8037:Result := 'GET_POINT';
-		$8038:Result := 'SET_POINT';
-		$8039:Result := 'CONVERT_TIME';
-		$803a:Result := 'GET_TIME';
-		$803b:Result := 'SET_TIME';
-		$803c:Result := 'CLOSE_FILE';
-		$803d:Result := 'HEAP_MEMORY';
-		$803e:Result := 'HANDLE';
-		$803f:Result := 'TIME_STAMP_RANGE';
-		$8040:Result := 'MAKE_ARCHIVE';
-		$8041:Result := 'NOT_CONFIRM_NAME';
-		$8042:Result := 'UNEXPECTED_EOF';
-		$8043:Result := 'INVALID_END_MARK';
-		$8044:Result := 'INVOLVED_LZH';
-		$8045:Result := 'NO_END_MARK';
-		$8046:Result := 'HDR_INVALID_SIZE';
-		$8047:Result := 'UNKNOWN_LEVEL';
-		$8048:Result := 'BROKEN_DATA';
-  else
-    Result := 'UNKNOWN';
-  end;
-end;
-
-
-end.

Modified: trunk/Lobby/TASClient/TASClient.dof
===================================================================
--- trunk/Lobby/TASClient/TASClient.dof	2008-04-10 14:10:37 UTC (rev 5692)
+++ trunk/Lobby/TASClient/TASClient.dof	2008-04-10 18:36:29 UTC (rev 5693)
@@ -115,7 +115,7 @@
 MajorVer=0
 MinorVer=3
 Release=0
-Build=273
+Build=275
 Debug=0
 PreRelease=0
 Special=0
@@ -126,7 +126,7 @@
 [Version Info Keys]
 CompanyName=
 FileDescription=TA Spring lobby client
-FileVersion=0.3.0.273
+FileVersion=0.3.0.275
 InternalName=
 LegalCopyright=
 LegalTrademarks=

Modified: trunk/Lobby/TASClient/TASClient.dpr
===================================================================
--- trunk/Lobby/TASClient/TASClient.dpr	2008-04-10 14:10:37 UTC (rev 5692)
+++ trunk/Lobby/TASClient/TASClient.dpr	2008-04-10 18:36:29 UTC (rev 5693)
@@ -97,8 +97,7 @@
   AwayMessageFormUnit in 'AwayMessageFormUnit.pas' {AwayMessageForm},
   ColorsPreferenceUnit in 'ColorsPreferenceUnit.pas' {ColorsPreference},
   Math,
-  Classes,
-  SevenZip in 'SevenZip.pas';
+  Classes;
 
 var
   i: Integer;

Modified: trunk/Lobby/TASClient/TASClient.res
===================================================================
(Binary files differ)


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000473.html">[Taspring-linux-commit] r5692 - trunk/rts/Sim/Path
</A></li>
	<LI>Next message: <A HREF="000475.html">[Taspring-linux-commit] r5694 - trunk/Lobby/TASClient
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#474">[ date ]</a>
              <a href="thread.html#474">[ thread ]</a>
              <a href="subject.html#474">[ subject ]</a>
              <a href="author.html#474">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
