<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r5971 - in trunk: . AI/Global/AAI installer	installer/builddata installer/builddata/maphelper	installer/builddata/maphelper/maphelper	installer/builddata/springcontent/gamedata rts/Game	rts/Game/StartScripts rts/Game/UI rts/Lua rts/Map rts/Map/SM3	rts/Map/SMF rts/Rendering rts/Rendering/Env rts/Sim/Features	rts/Sim/Misc rts/Sim/Projectiles rts/Sim/Units	rts/Sim/Units/CommandAI rts/System rts/System/FileSystem	rts/System/Script tools/unitsync tools/unitsync/test
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-June/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5971%20-%20in%20trunk%3A%20.%20AI/Global/AAI%20installer%0A%09installer/builddata%20installer/builddata/maphelper%0A%09installer/builddata/maphelper/maphelper%0A%09installer/builddata/springcontent/gamedata%20rts/Game%0A%09rts/Game/StartScripts%20rts/Game/UI%20rts/Lua%20rts/Map%20rts/Map/SM3%0A%09rts/Map/SMF%20rts/Rendering%20rts/Rendering/Env%20rts/Sim/Features%0A%09rts/Sim/Misc%20rts/Sim/Projectiles%20rts/Sim/Units%0A%09rts/Sim/Units/CommandAI%20rts/System%20rts/System/FileSystem%0A%09rts/System/Script%20tools/unitsync%20tools/unitsync/test&In-Reply-To=%3C20080602024200.B5E8F46DD%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000750.html">
   <LINK REL="Next"  HREF="000752.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r5971 - in trunk: . AI/Global/AAI installer	installer/builddata installer/builddata/maphelper	installer/builddata/maphelper/maphelper	installer/builddata/springcontent/gamedata rts/Game	rts/Game/StartScripts rts/Game/UI rts/Lua rts/Map rts/Map/SM3	rts/Map/SMF rts/Rendering rts/Rendering/Env rts/Sim/Features	rts/Sim/Misc rts/Sim/Projectiles rts/Sim/Units	rts/Sim/Units/CommandAI rts/System rts/System/FileSystem	rts/System/Script tools/unitsync tools/unitsync/test</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5971%20-%20in%20trunk%3A%20.%20AI/Global/AAI%20installer%0A%09installer/builddata%20installer/builddata/maphelper%0A%09installer/builddata/maphelper/maphelper%0A%09installer/builddata/springcontent/gamedata%20rts/Game%0A%09rts/Game/StartScripts%20rts/Game/UI%20rts/Lua%20rts/Map%20rts/Map/SM3%0A%09rts/Map/SMF%20rts/Rendering%20rts/Rendering/Env%20rts/Sim/Features%0A%09rts/Sim/Misc%20rts/Sim/Projectiles%20rts/Sim/Units%0A%09rts/Sim/Units/CommandAI%20rts/System%20rts/System/FileSystem%0A%09rts/System/Script%20tools/unitsync%20tools/unitsync/test&In-Reply-To=%3C20080602024200.B5E8F46DD%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r5971 - in trunk: . AI/Global/AAI installer	installer/builddata installer/builddata/maphelper	installer/builddata/maphelper/maphelper	installer/builddata/springcontent/gamedata rts/Game	rts/Game/StartScripts rts/Game/UI rts/Lua rts/Map rts/Map/SM3	rts/Map/SMF rts/Rendering rts/Rendering/Env rts/Sim/Features	rts/Sim/Misc rts/Sim/Projectiles rts/Sim/Units	rts/Sim/Units/CommandAI rts/System rts/System/FileSystem	rts/System/Script tools/unitsync tools/unitsync/test">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Mon Jun  2 04:41:59 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000750.html">[Taspring-linux-commit] r5970 - in trunk: AI/Global/AAI game/AI/AAI
</A></li>
        <LI>Next message: <A HREF="000752.html">[Taspring-linux-commit] r5972 - trunk/installer/sections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#751">[ date ]</a>
              <a href="thread.html#751">[ thread ]</a>
              <a href="subject.html#751">[ subject ]</a>
              <a href="author.html#751">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: trepan
Date: 2008-06-02 04:41:57 +0200 (Mon, 02 Jun 2008)
New Revision: 5971

Added:
   trunk/installer/builddata/maphelper/
   trunk/installer/builddata/maphelper/maphelper/
   trunk/installer/builddata/maphelper/maphelper/load_tdf_map.lua
   trunk/installer/builddata/maphelper/maphelper/parse_tdf.lua
   trunk/installer/builddata/maphelper/modinfo.tdf
   trunk/rts/Map/MapParser.cpp
   trunk/rts/Map/MapParser.h
Modified:
   trunk/AI/Global/AAI/AAIExecute.cpp
   trunk/AI/Global/AAI/AAIMap.cpp
   trunk/AI/Global/AAI/AAISector.cpp
   trunk/SConstruct
   trunk/installer/builddata/build.bat
   trunk/installer/builddata/springcontent/gamedata/parse_tdf.lua
   trunk/installer/builddata/springcontent/gamedata/sidedata.lua
   trunk/installer/make_gamedata_arch.sh
   trunk/rts/Game/Game.cpp
   trunk/rts/Game/GameSetup.cpp
   trunk/rts/Game/GameSetupData.h
   trunk/rts/Game/PreGame.cpp
   trunk/rts/Game/StartScripts/CommanderScript.cpp
   trunk/rts/Game/StartScripts/CommanderScript2.cpp
   trunk/rts/Game/StartScripts/GlobalAITestScript.cpp
   trunk/rts/Game/StartScripts/LoadScript.cpp
   trunk/rts/Game/StartScripts/SpawnScript.cpp
   trunk/rts/Game/StartScripts/TestScript.cpp
   trunk/rts/Game/UI/LuaUI.cpp
   trunk/rts/Game/UI/StartPosSelecter.cpp
   trunk/rts/Lua/LuaConstGame.cpp
   trunk/rts/Lua/LuaFeatureDefs.cpp
   trunk/rts/Lua/LuaOpenGL.cpp
   trunk/rts/Lua/LuaParser.cpp
   trunk/rts/Lua/LuaParser.h
   trunk/rts/Lua/LuaRules.cpp
   trunk/rts/Lua/LuaRules.h
   trunk/rts/Lua/LuaUnitDefs.cpp
   trunk/rts/Lua/LuaWeaponDefs.cpp
   trunk/rts/Map/BasicMapDamage.cpp
   trunk/rts/Map/MapInfo.cpp
   trunk/rts/Map/MapInfo.h
   trunk/rts/Map/SM3/Sm3Map.cpp
   trunk/rts/Map/SMF/BFGroundTextures.cpp
   trunk/rts/Map/SMF/SmfReadMap.cpp
   trunk/rts/Map/SMF/SmfReadMap.h
   trunk/rts/Map/SMF/mapfile.h
   trunk/rts/Rendering/Env/BumpWater.cpp
   trunk/rts/Rendering/Env/BumpWater.h
   trunk/rts/Rendering/InMapDraw.cpp
   trunk/rts/Rendering/InMapDraw.h
   trunk/rts/Sim/Features/FeatureHandler.cpp
   trunk/rts/Sim/Misc/DamageArrayHandler.cpp
   trunk/rts/Sim/Projectiles/ProjectileHandler.cpp
   trunk/rts/Sim/Projectiles/ProjectileHandler.h
   trunk/rts/Sim/Units/CommandAI/TransportCAI.cpp
   trunk/rts/Sim/Units/Unit.cpp
   trunk/rts/Sim/Units/UnitDefHandler.h
   trunk/rts/System/FileSystem/ArchiveScanner.cpp
   trunk/rts/System/GlobalStuff.cpp
   trunk/rts/System/GlobalStuff.h
   trunk/rts/System/Script/LuaFunctions.cpp
   trunk/rts/System/StdAfx.h
   trunk/tools/unitsync/javabind.cpp
   trunk/tools/unitsync/setup.py
   trunk/tools/unitsync/test/test.cpp
   trunk/tools/unitsync/unitsync.cpp
Log:

- converted map config scripts to lua format (LuaParser / MapParser)
  - if a script file is a TDF, then the load_tdf_map.lua script from
    maphelper.sdz is used to parse it.
  - map scripts also receive the name of the map, and its script name
    (in the 'Map' table)
  - MapOptions.lua is now handed the 'Map' table information as well
    (allows one to write a generic MapOptions.lua file that accesses
     the SMD/SM3 files to retrieve the defaults)
  - the SM3 format is yet to be converted to the lua format
    (but its MapInfo information is)
  - all maps now depend on the maphelper.sdz archive
    (see ArchiveScanner.cpp)

- added more testing functionality to unitsync/test/test.cpp
  - map archives
  - map info
  - mod sides

- added the '-DUNITSYNC' compilation flag for the unitsync build
  (specifically, for the MapParser.cpp file)

- added the AllowStartPosition(x, y, z, playerID) LuaRules/synced call-in
  - NETMSG_STARTPOS now generates InMapDrawer points locally
    (no need for the extra message)

- changed all of the LuaParser AddParam() calls to type-specific names

- added the LuaParser DotTable() routine  (mostly untested)

- converted the BumpMap water caustics textures to a vector
  (unlimited count). the 'smoketex' projectile texture set should
  probably be changed as well (and any others that could benefit)

- added IntToString() to StdAfx.h  ;-)

- allowed access to gs's randSeed (and the initial randSeed)
  if random() is added to definitions scripts, then you'll want to
  make sure that the same script always starts with the same randSeed

- globally renamed the 'MapHeader' struct to 'SMFHeader'



Modified: trunk/AI/Global/AAI/AAIExecute.cpp
===================================================================
--- trunk/AI/Global/AAI/AAIExecute.cpp	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/AI/Global/AAI/AAIExecute.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -3780,4 +3780,4 @@
 		fprintf(ai-&gt;file, &quot;%i th order has been given by %s in frame %i\n&quot;, issued_orders, owner,  cb-&gt;GetCurrentFrame());
 
 	cb-&gt;GiveOrder(unit, c);
-}
\ No newline at end of file
+}

Modified: trunk/AI/Global/AAI/AAIMap.cpp
===================================================================
--- trunk/AI/Global/AAI/AAIMap.cpp	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/AI/Global/AAI/AAIMap.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -2665,4 +2665,4 @@
 		y = yContMapSize - 1;
 
 	return continent_map[y * xContMapSize + x];
-}
\ No newline at end of file
+}

Modified: trunk/AI/Global/AAI/AAISector.cpp
===================================================================
--- trunk/AI/Global/AAI/AAISector.cpp	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/AI/Global/AAI/AAISector.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -789,4 +789,4 @@
 			pos-&gt;x = left + map-&gt;xSectorSize * (0.2f + 0.06f * (float)(rand()%11) );
 			pos-&gt;z = top + map-&gt;ySectorSize * (0.2f + 0.06f * (float)(rand()%11) );
 	}
-}
\ No newline at end of file
+}

Modified: trunk/SConstruct
===================================================================
--- trunk/SConstruct	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/SConstruct	2008-06-02 02:41:57 UTC (rev 5971)
@@ -74,7 +74,7 @@
 # so we don't need so much bloat here.
 # Need a new env otherwise scons chokes on equal targets built with different flags.
 uenv = env.Copy(builddir=os.path.join(env['builddir'], 'unitsync'))
-uenv.AppendUnique(CPPDEFINES=['BITMAP_NO_OPENGL'])
+uenv.AppendUnique(CPPDEFINES=['UNITSYNC', 'BITMAP_NO_OPENGL'])
 for d in filelist.list_directories(uenv, 'rts'):
 	uenv.BuildDir(os.path.join(uenv['builddir'], d), d, duplicate = False)
 uenv.BuildDir(os.path.join(uenv['builddir'], 'tools/unitsync'), 'tools/unitsync', duplicate = False)
@@ -88,6 +88,7 @@
 	'rts/Game/GameVersion.cpp',
 	'rts/Lua/LuaUtils.cpp',
 	'rts/Lua/LuaParser.cpp',
+	'rts/Map/MapParser.cpp',
 	'rts/Rendering/Textures/Bitmap.cpp',
 	'rts/Rendering/Textures/nv_dds.cpp',
 	'rts/System/TdfParser.cpp',
@@ -241,12 +242,16 @@
 				env.Exit(1)
 			if os.system(&quot;rm -f game/base/spring/bitmaps.sdz&quot;):
 				env.Exit(1)
+			if os.system(&quot;rm -f game/base/maphelper.sdz&quot;):
+				env.Exit(1)
 		else:
 			if os.system(&quot;installer/make_gamedata_arch.sh&quot;):
 				env.Exit(1)
 
 inst = env.Install(os.path.join(env['installprefix'], env['datadir'], 'base'), 'game/base/springcontent.sdz')
 Alias('install', inst)
+inst = env.Install(os.path.join(env['installprefix'], env['datadir'], 'base'), 'game/base/maphelper.sdz')
+Alias('install', inst)
 inst = env.Install(os.path.join(env['installprefix'], env['datadir'], 'base/spring'), 'game/base/spring/bitmaps.sdz')
 Alias('install', inst)
 

Modified: trunk/installer/builddata/build.bat
===================================================================
--- trunk/installer/builddata/build.bat	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/installer/builddata/build.bat	2008-06-02 02:41:57 UTC (rev 5971)
@@ -24,4 +24,14 @@
 pkzip -add _temp.zip builddata\springcontent\modinfo.tdf
 rename _temp.zip springcontent.sdz
 move /Y springcontent.sdz ..\game\base
-cd builddata
\ No newline at end of file
+cd builddata
+
+echo Creating maphelper.sdz
+del /Q ..\..\base\maphelper.sdz
+cd maphelper
+..\..\pkzip -add -dir=current ..\..\_temp.zip maphelper\*
+cd ..\..
+pkzip -add _temp.zip builddata\maphelper\modinfo.tdf
+rename _temp.zip maphelper.sdz
+move /Y maphelper.sdz ..\game\base
+cd builddata

Added: trunk/installer/builddata/maphelper/maphelper/load_tdf_map.lua
===================================================================
--- trunk/installer/builddata/maphelper/maphelper/load_tdf_map.lua	                        (rev 0)
+++ trunk/installer/builddata/maphelper/maphelper/load_tdf_map.lua	2008-06-02 02:41:57 UTC (rev 5971)
@@ -0,0 +1,171 @@
+--------------------------------------------------------------------------------
+--------------------------------------------------------------------------------
+--
+--  file:     load_tdf_map.lua
+--  brief:    tdf map lua parser (original SMD and SM3 formats)
+--  authors:  Dave Rodgers
+--
+--  Copyright (C) 2008.
+--  Licensed under the terms of the GNU GPL, v2 or later.
+--
+--------------------------------------------------------------------------------
+--------------------------------------------------------------------------------
+
+-- Special table for map config files
+--
+--   Map.name
+--   Map.fullName
+--   Map.configFile
+
+local mapConfig = Map.configFile
+
+local TDF = VFS.Include('maphelper/parse_tdf.lua')
+
+
+--------------------------------------------------------------------------------
+--------------------------------------------------------------------------------
+--
+--  Conversion Helpers
+--
+
+local function ConvertMoveSpeeds(terrain)
+  local moveSpeeds = {}
+  for k, v in pairs(terrain) do
+    local s, e, type = k:find('^(.*)movespeed$')
+    if (type) then
+      moveSpeeds[type] = v
+      terrain[k] = nil
+    end
+  end
+  terrain.movespeeds = moveSpeeds
+end
+
+
+local function ConvertTerrainTypes(map)
+  local typeArray = {}
+  for k, v in pairs(map) do
+    if (type(v) == 'table') then
+      local s, e, num = k:find('^terraintype(.*)$')
+      local num = tonumber(num)
+      if (num) then
+        ConvertMoveSpeeds(v)
+        typeArray[num] = v
+        map[k] = nil
+      end
+    end
+  end
+  map.terraintypes = typeArray
+end
+
+
+local function ConvertTeams(map)
+  local teamArray = {}
+  for k, v in pairs(map) do
+    local s, e, num = k:find('^team(.*)$')
+    local num = tonumber(num)
+    if (num) then
+      teamArray[num] = {
+        startpos = {
+          x = v.startposx,
+          z = v.startposz,
+        },
+      }
+      map[k] = nil
+    end
+  end
+  map.teams = teamArray
+end
+
+
+local function ConvertLighting(map)
+  local light = map.light
+  if (type(light) ~= 'table') then
+    return
+  end
+  local lighting = {}
+  for k, v in pairs(light) do
+    local s, e, prefix = k:find('^(.*)suncolor$')
+    if (prefix) then
+      k = prefix .. 'diffusecolor'
+    end
+    lighting[k] = v
+  end
+  map.light = nil
+  map.lighting = lighting
+end
+
+
+local function ConvertWater(map)
+  -- remove the 'water' prefix
+  local water = map.water
+  if (type(water) ~= 'table') then
+    return
+  end
+  for k, v in pairs(water) do
+    local s, e, suffix = k:find('^water(.*)$')
+    if (suffix) then
+      water[suffix] = v
+      water[k] = nil
+    end
+  end
+  -- FIXME -- handle caustics?
+end
+
+
+--------------------------------------------------------------------------------
+--------------------------------------------------------------------------------
+--
+--  Main Routine
+--
+
+local mapData, err = TDF.Parse(mapConfig)
+if (mapData == nil) then
+  error('Error parsing ' .. mapConfig .. ': ' .. err)
+end
+
+local map = mapData.map
+if (map == nil) then
+  error('Error parsing ' .. mapConfig .. ': missing MAP section')
+end
+
+
+ConvertTerrainTypes(map)
+
+ConvertLighting(map)
+
+ConvertWater(map)
+
+ConvertTeams(map)
+
+
+--------------------------------------------------------------------------------
+--------------------------------------------------------------------------------
+--
+--  Debugging
+--
+
+-- FIXME -- debugging
+local function PrintTable(t, indent)
+  indent = indent or ''
+  for k,v in pairs(t) do
+    k = tonumber(k) and '['..k..']' or k
+    if (type(v) == 'table') then
+      print(indent .. k .. ' = {')
+      PrintTable(v, indent .. '  ')
+      print(indent .. '},')
+    else
+      print(indent .. k .. ' = &quot;' .. v .. '&quot;,')
+    end
+  end
+end
+
+--PrintTable(map)
+
+
+--------------------------------------------------------------------------------
+--------------------------------------------------------------------------------
+
+return map
+
+--------------------------------------------------------------------------------
+--------------------------------------------------------------------------------

Added: trunk/installer/builddata/maphelper/maphelper/parse_tdf.lua
===================================================================
--- trunk/installer/builddata/maphelper/maphelper/parse_tdf.lua	                        (rev 0)
+++ trunk/installer/builddata/maphelper/maphelper/parse_tdf.lua	2008-06-02 02:41:57 UTC (rev 5971)
@@ -0,0 +1,240 @@
+--------------------------------------------------------------------------------
+--------------------------------------------------------------------------------
+--
+--  file:    parsetdf.lua
+--  brief:   lua tdf parser
+--  author:  Dave Rodgers
+--
+--  Copyright (C) 2007.
+--  Licensed under the terms of the GNU GPL, v2 or later.
+--
+--------------------------------------------------------------------------------
+--------------------------------------------------------------------------------
+--
+--  NOTES:
+--
+--    - Although this parser is faster then the C++ TDFParser, it still suffers
+--      from a few serious slowdowns. Running global substitutions for dos2unix,
+--      line comments, and block comments is probably not the best way to go.
+--
+--    - Add more complete error checking / handling
+--
+--------------------------------------------------------------------------------
+--------------------------------------------------------------------------------
+
+if (TDFparser) then
+  return TDFparser
+end
+
+--------------------------------------------------------------------------------
+--------------------------------------------------------------------------------
+
+local keyFilter = string.lower
+
+local noDuplicates = false
+
+local debug = false
+
+
+--------------------------------------------------------------------------------
+--------------------------------------------------------------------------------
+
+local function FindLineNum(pos, text)
+  local lineNum = 1
+  local p = 1
+  while (p ~= nil) do
+    local s, e = string.find(text, '^[^\n]*\n', p) 
+    if (s == nil) then
+      return lineNum
+    end
+    p = e + 1
+    if (p &gt; pos) then
+      return lineNum
+    end
+    lineNum = lineNum + 1
+  end
+  return lineNum
+end
+
+
+--------------------------------------------------------------------------------
+
+local function DosToUnix(text)
+  return string.gsub(text, '\r', '')
+end
+
+
+local function ReplaceWithSpaces(text)
+  return string.gsub(text, '[^\n]', ' ')
+end
+
+
+local function StripLineComments(text)
+  return string.gsub(text, '//[^\n]*[\n]?', ReplaceWithSpaces)
+end
+
+
+local function StripBlockComments(text)
+  return string.gsub(text, '/%*.-%*/', ReplaceWithSpaces)
+end
+
+
+--------------------------------------------------------------------------------
+--------------------------------------------------------------------------------
+
+local cleanText
+
+local stack = { {} }
+local current = stack[1]
+
+
+--------------------------------------------------------------------------------
+
+local function ParseElement(text, pos)
+  if (debug) then
+    print('pos = ' .. tostring(pos))
+  end
+
+  local sectionPattern = '^%s*%[([^%]]+)%]%s*{'
+  local s, e, sec = string.find(text, sectionPattern, pos)
+  if (sec) then
+    sec = keyFilter(sec)
+    if (noDuplicates and current[sec]) then
+      return nil, 'duplicate entry: ' .. sec
+    end
+    local newSection = {}
+    table.insert(stack, newSection)
+    current[sec] = newSection
+    current = newSection
+    if (debug) then
+      print('  SECTION', sec, e + 1)
+      print(type(e))
+    end
+    return e + 1
+  end
+
+  local endSecPattern = '^(%s*})'
+  local s, e, endText = string.find(text, endSecPattern, pos)
+  if (s) then
+    local stackSize = #stack
+    if (stackSize &lt;= 1) then
+      return nil, 'table underrun'
+    else
+      table.remove(stack)
+      current = stack[stackSize - 1]
+    end
+    if (debug) then
+      print('  ENDSECTION', endText, e + 1)
+    end
+    return e + 1
+  end
+
+  local entryPattern = '^%s*([^%s=]*)%s*=%s*([^;\n]*);'
+  local s, e, k, v = string.find(text, entryPattern, pos)
+  if (k and v) then
+    k = keyFilter(k)
+    if (noDuplicates and current[k]) then
+      return nil, 'duplicate entry: ' .. k
+    end
+
+    local _, _, v = string.find(v, '(.-)%s*$') -- remove trailing space
+    current[k] = v
+    if (debug) then
+      print('  PAIR:  ' .. k .. ' = ' .. v,
+            (e + 1) .. '/' .. FindLineNum(pos, cleanText))
+    end
+    return e + 1
+  end
+
+  if (string.find(text, '^%s*$', pos)) then
+    return nil
+  end
+
+  return nil, 'Bad TDF text at line ' .. FindLineNum(pos, cleanText)
+end
+
+
+--------------------------------------------------------------------------------
+
+local function Parse(text)
+
+  text = DosToUnix(text)
+  text = StripLineComments(text)
+  text = StripBlockComments(text)
+
+  cleanText = text
+
+  stack = { {} }
+  current = stack[1]
+
+  local pos = 1
+
+  while (pos) do
+    pos, err = ParseElement(text, pos)
+    if (err) then
+      return nil, err
+    end
+    if ((pos == nil) or (pos &gt; #text)) then
+      if (#stack == 1) then
+        break;
+      else
+        return nil, 'missing } table terminations'
+      end
+    end
+  end
+
+  return stack[1]
+end
+
+
+local function ParseFile(filename)
+  if (debug) then
+    print('TDF.Parse: ' .. tostring(filename))
+  end
+  local text, err = VFS.LoadFile(filename)
+  if (text == nil) then
+    return nil, err
+  end
+  return Parse(text)
+end
+
+
+--------------------------------------------------------------------------------
+--------------------------------------------------------------------------------
+
+local function GetKeyFilter()
+  return keyFilter
+end
+
+
+local function SetKeyFilter(filter)
+  if (type(filter) == 'function') then
+    keyFilter = filter
+  else
+    error('TDF.SetKeyFilter(): filter must be a function')
+  end
+end
+
+
+local function AllowDuplicates(state)
+  if (type(state) == 'boolean') then
+    noDuplicates = not state
+  end
+end
+
+
+--------------------------------------------------------------------------------
+--------------------------------------------------------------------------------
+
+TDFparser = {
+  Parse           = ParseFile,
+  ParseText       = Parse,
+  GetKeyFilter    = GetKeyFilter,
+  SetKeyFilter    = SetKeyFilter,
+  AllowDuplicates = AllowDuplicates,
+}
+
+return TDFparser
+
+--------------------------------------------------------------------------------
+--------------------------------------------------------------------------------

Added: trunk/installer/builddata/maphelper/modinfo.tdf
===================================================================
--- trunk/installer/builddata/maphelper/modinfo.tdf	                        (rev 0)
+++ trunk/installer/builddata/maphelper/modinfo.tdf	2008-06-02 02:41:57 UTC (rev 5971)
@@ -0,0 +1,8 @@
+[MOD]
+{
+	Name=Map Helper v1;
+	Description=Maps can use this archive for its lua tdf parser
+	ModType=0;
+
+	NumDependencies=0;
+}

Modified: trunk/installer/builddata/springcontent/gamedata/parse_tdf.lua
===================================================================
--- trunk/installer/builddata/springcontent/gamedata/parse_tdf.lua	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/installer/builddata/springcontent/gamedata/parse_tdf.lua	2008-06-02 02:41:57 UTC (rev 5971)
@@ -140,7 +140,7 @@
     local _, _, v = string.find(v, '(.-)%s*$') -- remove trailing space
     current[k] = v
     if (debug) then
-      pritn('  PAIR:  ' .. k .. ' = ' .. v,
+      print('  PAIR:  ' .. k .. ' = ' .. v,
             (e + 1) .. '/' .. FindLineNum(pos, cleanText))
     end
     return e + 1

Modified: trunk/installer/builddata/springcontent/gamedata/sidedata.lua
===================================================================
--- trunk/installer/builddata/springcontent/gamedata/sidedata.lua	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/installer/builddata/springcontent/gamedata/sidedata.lua	2008-06-02 02:41:57 UTC (rev 5971)
@@ -33,8 +33,6 @@
   if (type(data) ~= 'table') then
     break
   else
-    print(string.format('%s &quot;%s&quot; &quot;%s&quot;',
-                        label, tostring(data.name), tostring(data.commander)))
     -- rename 'commander' to 'startunit'
     data['startunit'] = data['commander']
     data['commander'] = nil

Modified: trunk/installer/make_gamedata_arch.sh
===================================================================
--- trunk/installer/make_gamedata_arch.sh	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/installer/make_gamedata_arch.sh	2008-06-02 02:41:57 UTC (rev 5971)
@@ -21,14 +21,17 @@
 
 # Zip up the stuff.
 
+cd installer/builddata/
+
 echo Updating bitmaps.sdz
-cd installer/builddata/bitmaps
+cd bitmaps/
 zip -qu ../../../game/base/spring/bitmaps.sdz modinfo.tdf
 zip -qu ../../../game/base/spring/bitmaps.sdz bitmaps/*
 zip -qu ../../../game/base/spring/bitmaps.sdz bitmaps/*/*
+cd ..
 
 echo Updating springcontent.sdz
-cd ../springcontent
+cd springcontent/
 zip -qu ../../../game/base/springcontent.sdz modinfo.tdf
 zip -qu ../../../game/base/springcontent.sdz gamedata/*
 zip -qu ../../../game/base/springcontent.sdz gamedata/*/*
@@ -37,4 +40,12 @@
 zip -qu ../../../game/base/springcontent.sdz anims/*
 zip -qu ../../../game/base/springcontent.sdz shaders/*
 zip -qu ../../../game/base/springcontent.sdz LuaGadgets/*
-cd ../../..
+cd ..
+
+echo Updating maphelper.sdz
+cd maphelper/
+zip -qu ../../../game/base/maphelper.sdz modinfo.tdf
+zip -qu ../../../game/base/maphelper.sdz maphelper/*
+cd ..
+
+cd ../..

Modified: trunk/rts/Game/Game.cpp
===================================================================
--- trunk/rts/Game/Game.cpp	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Game/Game.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -8,6 +8,7 @@
 #include &lt;time.h&gt;
 #include &lt;cctype&gt;
 #include &lt;locale&gt;
+#include &lt;sstream&gt;
 
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &lt;GL/glu.h&gt;
@@ -303,7 +304,7 @@
 	modInfo.Init(modName.c_str());
 
 	defsParser = SAFE_NEW LuaParser(&quot;gamedata/defs.lua&quot;,
-	                                 SPRING_VFS_MOD_BASE, SPRING_VFS_ZIP);
+	                                SPRING_VFS_MOD_BASE, SPRING_VFS_ZIP);
 	// customize the defs environment
 	defsParser-&gt;GetTable(&quot;Spring&quot;);
 	defsParser-&gt;AddFunc(&quot;GetModOptions&quot;, LuaSyncedRead::GetModOptions);
@@ -2083,12 +2084,13 @@
 				float posx = pos.x + (a % sqSize - sqSize / 2) * 10 * SQUARE_SIZE;
 				float posz = pos.z + (a / sqSize - sqSize / 2) * 10 * SQUARE_SIZE;
 				float3 pos2 = float3(posx, pos.y, posz);
-				const string&amp; defName = unitDefHandler-&gt;unitDefs[a].name;
-				const CUnit* unit =
-						unitLoader.LoadUnit(defName, pos2, team, false, 0, NULL);
-
-				if (unit) {
-					unitLoader.FlattenGround(unit);
+				const UnitDef* ud = &amp;unitDefHandler-&gt;unitDefs[a];
+				if (ud-&gt;valid) {
+					const CUnit* unit =
+						unitLoader.LoadUnit(ud-&gt;name, pos2, team, false, 0, NULL);
+					if (unit) {
+						unitLoader.FlattenGround(unit);
+					}
 				}
 			}
 		}
@@ -3349,19 +3351,26 @@
 				if ((team &gt;= gs-&gt;activeTeams) || (team &lt; 0) || !gameSetup) {
 					logOutput.Print(&quot;Got invalid team num %i in startpos msg&quot;,team);
 				} else {
-					if (inbuf[3] != 2) {
-						gameSetup-&gt;readyTeams[team] = !!inbuf[3];
+					float3 pos(*(float*)&amp;inbuf[4],
+					           *(float*)&amp;inbuf[8],
+					           *(float*)&amp;inbuf[12]);
+					if (!luaRules || luaRules-&gt;AllowStartPosition(player, pos)) {
+						if (inbuf[3] != 2) {
+							gameSetup-&gt;readyTeams[team] = !!inbuf[3];
+						}
+						gs-&gt;Team(team)-&gt;startPos = pos;
+						char label[128];
+						snprintf(label, sizeof(label), &quot;Start %i&quot;, team);
+						inMapDrawer-&gt;LocalPoint(pos, label, player);
+						// FIXME - erase old pos ?
 					}
-					gs-&gt;Team(team)-&gt;startPos.x = *(float*)&amp;inbuf[4];
-					gs-&gt;Team(team)-&gt;startPos.y = *(float*)&amp;inbuf[8];
-					gs-&gt;Team(team)-&gt;startPos.z = *(float*)&amp;inbuf[12];
 				}
 				AddTraffic(player, packetCode, dataLength);
 				break;
 			}
 
 			case NETMSG_RANDSEED: {
-				gs-&gt;SetRandSeed(*((unsigned int*)&amp;inbuf[1]));
+				gs-&gt;SetRandSeed(*((unsigned int*)&amp;inbuf[1]), true);
 				AddTraffic(-1, packetCode, dataLength);
 				break;
 			}
@@ -3963,7 +3972,7 @@
 			userInput = userInput.substr(0, 200);
 			writingPos = (int)userInput.length();
 		}
-		inMapDrawer-&gt;CreatePoint(inMapDrawer-&gt;waitingPoint,userInput);
+		inMapDrawer-&gt;SendPoint(inMapDrawer-&gt;waitingPoint, userInput);
 		inMapDrawer-&gt;wantLabel = false;
 		userInput = &quot;&quot;;
 		writingPos = 0;
@@ -4597,31 +4606,31 @@
 
 	LuaParser luaParser(&quot;teamcolors.lua&quot;, SPRING_VFS_RAW, SPRING_VFS_RAW_FIRST);
 
-	luaParser.AddParam(&quot;myPlayer&quot;, gu-&gt;myPlayerNum);
+	luaParser.AddInt(&quot;myPlayer&quot;, gu-&gt;myPlayerNum);
 
-	luaParser.AddParam(&quot;modName&quot;,      modInfo.humanName);
-	luaParser.AddParam(&quot;modShortName&quot;, modInfo.shortName);
-	luaParser.AddParam(&quot;modVersion&quot;,   modInfo.version);
+	luaParser.AddString(&quot;modName&quot;,      modInfo.humanName);
+	luaParser.AddString(&quot;modShortName&quot;, modInfo.shortName);
+	luaParser.AddString(&quot;modVersion&quot;,   modInfo.version);
 
-	luaParser.AddParam(&quot;mapName&quot;,      mapInfo-&gt;map.name);
-	luaParser.AddParam(&quot;mapHumanName&quot;, mapInfo-&gt;map.humanName);
+	luaParser.AddString(&quot;mapName&quot;,      mapInfo-&gt;map.name);
+	luaParser.AddString(&quot;mapHumanName&quot;, mapInfo-&gt;map.humanName);
 
-	luaParser.AddParam(&quot;gameMode&quot;,     gs-&gt;gameMode);
+	luaParser.AddInt(&quot;gameMode&quot;, gs-&gt;gameMode);
 
 	luaParser.GetTable(&quot;teams&quot;);
 	for(int t = 0; t &lt; gs-&gt;activeTeams; ++t) {
 		luaParser.GetTable(t); {
 			const CTeam* team = gs-&gt;Team(t);
 			const unsigned char* color = gs-&gt;Team(t)-&gt;color;
-			luaParser.AddParam(&quot;allyTeam&quot;, gs-&gt;AllyTeam(t));
-			luaParser.AddParam(&quot;gaia&quot;,     team-&gt;gaia);
-			luaParser.AddParam(&quot;leader&quot;,   team-&gt;leader);
-			luaParser.AddParam(&quot;side&quot;,     team-&gt;side);
+			luaParser.AddInt(&quot;allyTeam&quot;, gs-&gt;AllyTeam(t));
+			luaParser.AddBool(&quot;gaia&quot;,    team-&gt;gaia);
+			luaParser.AddInt(&quot;leader&quot;,   team-&gt;leader);
+			luaParser.AddString(&quot;side&quot;,  team-&gt;side);
 			luaParser.GetTable(&quot;color&quot;); {
-				luaParser.AddParam(1, float(color[0]) / 255.0f);
-				luaParser.AddParam(2, float(color[1]) / 255.0f);
-				luaParser.AddParam(3, float(color[2]) / 255.0f);
-				luaParser.AddParam(4, float(color[3]) / 255.0f);
+				luaParser.AddFloat(1, float(color[0]) / 255.0f);
+				luaParser.AddFloat(2, float(color[1]) / 255.0f);
+				luaParser.AddFloat(3, float(color[2]) / 255.0f);
+				luaParser.AddFloat(4, float(color[3]) / 255.0f);
 			}
 			luaParser.EndTable(); // color
 		}
@@ -4633,10 +4642,10 @@
 	for(int p = 0; p &lt; gs-&gt;activePlayers; ++p) {
 		luaParser.GetTable(p); {
 			const CPlayer* player = gs-&gt;players[p];
-			luaParser.AddParam(&quot;name&quot;,       player-&gt;playerName);
-			luaParser.AddParam(&quot;team&quot;,       player-&gt;team);
-			luaParser.AddParam(&quot;active&quot;,     player-&gt;active);
-			luaParser.AddParam(&quot;spectating&quot;, player-&gt;spectator);
+			luaParser.AddString(&quot;name&quot;,     player-&gt;playerName);
+			luaParser.AddInt(&quot;team&quot;,        player-&gt;team);
+			luaParser.AddBool(&quot;active&quot;,     player-&gt;active);
+			luaParser.AddBool(&quot;spectating&quot;, player-&gt;spectator);
 		}
 		luaParser.EndTable(); // player#
 	}

Modified: trunk/rts/Game/GameSetup.cpp
===================================================================
--- trunk/rts/Game/GameSetup.cpp	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Game/GameSetup.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -13,7 +13,7 @@
 #include &quot;Lua/LuaGaia.h&quot;
 #include &quot;Lua/LuaRules.h&quot;
 #include &quot;Lua/LuaParser.h&quot;
-#include &quot;Map/MapInfo.h&quot;
+#include &quot;Map/MapParser.h&quot;
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;Rendering/Textures/TAPalette.h&quot;
 #include &quot;System/UnsyncedRNG.h&quot;
@@ -78,17 +78,13 @@
  */
 void CGameSetup::LoadStartPositionsFromMap()
 {
-	TdfParser p2;
-	CMapInfo::OpenTDF (mapName, p2);
+	MapParser mapParser(mapName);
 
-	for(int a=0;a&lt;numTeams;++a){
-		float x,z;
-		char teamName[20];
-		sprintf(teamName, &quot;TEAM%i&quot;, teamStartNum[a]);
-		p2.GetDef(x, &quot;1000&quot;, string(&quot;MAP\\&quot;) + teamName + &quot;\\StartPosX&quot;);
-		p2.GetDef(z, &quot;1000&quot;, string(&quot;MAP\\&quot;) + teamName + &quot;\\StartPosZ&quot;);
-		gs-&gt;Team(a)-&gt;startPos = float3(x, 100, z);
-		startPos[a] = SFloat3(x, 100, z);
+	for(int a = 0; a &lt; numTeams; ++a) {
+		float3 pos(1000.0f, 100.0f, 1000.0f);
+		mapParser.GetStartPos(a, pos);
+		gs-&gt;Team(a)-&gt;startPos = pos;
+		startPos[a] = SFloat3(pos.x, pos.y, pos.z);
 	}
 }
 
@@ -121,8 +117,7 @@
 
 	// Show that we havent selected start pos yet
 	if (startPosType == StartPos_ChooseInGame) {
-		for (int a = 0; a &lt; numTeams; ++a)
-		{
+		for (int a = 0; a &lt; numTeams; ++a) {
 			gs-&gt;Team(a)-&gt;startPos.y = -500;
 			startPos[a].y = -500;
 		}
@@ -289,8 +284,9 @@
 		++i;
 	}
 
-	if (allyteamRemap.size() != numAllyTeams)
+	if (allyteamRemap.size() != numAllyTeams) {
 		throw content_error(&quot;incorrect number of allyteams in GameSetup script&quot;);
+	}
 }
 
 /** @brief Update all player indices to refer to the right player. */
@@ -298,14 +294,16 @@
 {
 	// relocate Team.TeamLeader field
 	for (int a = 0; a &lt; numTeams; ++a) {
-		if (playerRemap.find(gs-&gt;Team(a)-&gt;leader) == playerRemap.end())
+		if (playerRemap.find(gs-&gt;Team(a)-&gt;leader) == playerRemap.end()) {
 			throw content_error(&quot;invalid Team.TeamLeader in GameSetup script&quot;);
+		};
 		gs-&gt;Team(a)-&gt;leader = playerRemap[gs-&gt;Team(a)-&gt;leader];
 	}
 
 	// relocate myPlayerNum
-	if (playerRemap.find(myPlayerNum) == playerRemap.end())
+	if (playerRemap.find(myPlayerNum) == playerRemap.end()) {
 		throw content_error(&quot;invalid MyPlayerNum in GameSetup script&quot;);
+	}
 	myPlayerNum = playerRemap[myPlayerNum];
 }
 
@@ -326,8 +324,9 @@
 {
 	// relocate Team.Allyteam field
 	for (int a = 0; a &lt; numTeams; ++a) {
-		if (allyteamRemap.find(gs-&gt;AllyTeam(a)) == allyteamRemap.end())
+		if (allyteamRemap.find(gs-&gt;AllyTeam(a)) == allyteamRemap.end()) {
 			throw content_error(&quot;invalid Team.Allyteam in GameSetup script&quot;);
+		}
 		gs-&gt;SetAllyTeam(a, allyteamRemap[gs-&gt;AllyTeam(a)]);
 		teamAllyteam[a] = allyteamRemap[teamAllyteam[a]];
 	}

Modified: trunk/rts/Game/GameSetupData.h
===================================================================
--- trunk/rts/Game/GameSetupData.h	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Game/GameSetupData.h	2008-06-02 02:41:57 UTC (rev 5971)
@@ -7,7 +7,6 @@
 #include &quot;SFloat3.h&quot;
 #include &quot;GlobalStuff.h&quot;
 
-class TdfParser;
 
 class CGameSetupData
 {

Modified: trunk/rts/Game/PreGame.cpp
===================================================================
--- trunk/rts/Game/PreGame.cpp	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Game/PreGame.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -21,6 +21,8 @@
 #include &quot;FileSystem/VFSHandler.h&quot;
 #include &quot;Lua/LuaGaia.h&quot;
 #include &quot;Lua/LuaRules.h&quot;
+#include &quot;Lua/LuaParser.h&quot;
+#include &quot;Map/MapParser.h&quot;
 #include &quot;Platform/Clipboard.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;Platform/FileSystem.h&quot;
@@ -31,7 +33,6 @@
 #include &quot;StartScripts/ScriptHandler.h&quot;
 #include &quot;UI/InfoConsole.h&quot;
 #include &quot;UI/MouseHandler.h&quot;
-#include &quot;TdfParser.h&quot;
 #include &quot;mmgr.h&quot;
 
 // msvc behaves really strange
@@ -366,14 +367,14 @@
 		else
 			throw std::runtime_error(&quot;CPreGame::StartServer(): Unknown extension: &quot; + extension);
 
-		TdfParser mapDefParser(mapDefFile);
-		std::string mapWantedScript, scriptFile;
-		mapDefParser.GetDef(mapWantedScript, &quot;&quot;, &quot;MAP\\Script&quot;);
-		mapDefParser.GetDef(scriptFile, &quot;&quot;, &quot;MAP\\Scriptfile&quot;);
-		if (!scriptFile.empty())
+		MapParser mp(map);
+		LuaTable mapRoot = mp.GetRoot();
+		const std::string mapWantedScript = mapRoot.GetString(&quot;script&quot;,     &quot;&quot;);
+		const std::string scriptFile      = mapRoot.GetString(&quot;scriptFile&quot;, &quot;&quot;);
+		if (!scriptFile.empty()) {
 			CScriptHandler::Instance().LoadScriptFile(scriptFile);
-		if (!mapWantedScript.empty())
-		{
+		}
+		if (!mapWantedScript.empty()) {
 			script = mapWantedScript;
 			mapHasStartscript = true;
 		}
@@ -381,18 +382,16 @@
 	startupData-&gt;SetScript(script);
 	// here we now the name of the script to use
 
-	try // to load the script 
-	{
+	try { // to load the script 
 		CScriptHandler::SelectScript(script);
 		std::string scriptWantedMod;
 		scriptWantedMod = CScriptHandler::Instance().chosenScript-&gt;GetModName();
-		if (!scriptWantedMod.empty())
+		if (!scriptWantedMod.empty()) {
 			mod = scriptWantedMod;
-
+		}
 		LoadMod(mod);
 	}
-	catch (const std::runtime_error&amp; err) // script not found, so it may be in the modarchive?
-	{
+	catch (const std::runtime_error&amp; err) { // script not found, so it may be in the modarchive?
 		LoadMod(mod); // new map into VFS
 		CScriptHandler::SelectScript(script);
 	}
@@ -401,25 +400,26 @@
 	std::string modArchive = archiveScanner-&gt;ModNameToModArchive(mod);
 	startupData-&gt;SetMod(mod, archiveScanner-&gt;GetModChecksum(modArchive));
 	
-	if (!mapHasStartscript)
-	{
+	if (!mapHasStartscript) {
 		std::string mapFromScript = CScriptHandler::Instance().chosenScript-&gt;GetMapName();
-		if (!mapFromScript.empty() &amp;&amp; map != mapFromScript)
-		{
+		if (!mapFromScript.empty() &amp;&amp; map != mapFromScript) {
 			//TODO unload old map
 			LoadMap(mapFromScript, true);
 		}
 	}
 	startupData-&gt;SetMap(map, archiveScanner-&gt;GetMapChecksum(map));
 
-	if (gameSetup)
-		gameSetup-&gt;LoadStartPositions(); // only host needs to do this, because client will recieve startpos msg from server
+	if (gameSetup) {
+		gameSetup-&gt;LoadStartPositions(); // only host needs to do this, because
+		                                 // client will receive startpos msg from server
+	}
 	
 	good_fpu_control_registers(&quot;before CGameServer creation&quot;);
 	int myPort = gameSetup? gameSetup-&gt;hostport : springDefaultPort;
 	gameServer = new CGameServer(myPort, startupData, gameSetup, demoFile);
-	if (gameSetup &amp;&amp; gameSetup-&gt;autohostport &gt; 0)
+	if (gameSetup &amp;&amp; gameSetup-&gt;autohostport &gt; 0) {
 		gameServer-&gt;AddAutohostInterface(gameSetup-&gt;autohostport);
+	}
 	gameServer-&gt;AddLocalClient();
 	good_fpu_control_registers(&quot;after CGameServer creation&quot;);
 }
@@ -584,11 +584,13 @@
 		CFileHandler* f = SAFE_NEW CFileHandler(&quot;maps/&quot; + mapName);
 		if (!f-&gt;FileExists()) {
 			vector&lt;string&gt; ars = archiveScanner-&gt;GetArchivesForMap(mapName);
-			if (ars.empty())
+			if (ars.empty()) {
 				throw content_error(&quot;Couldn't find any archives for map '&quot; + mapName + &quot;'.&quot;);
+			}
 			for (vector&lt;string&gt;::iterator i = ars.begin(); i != ars.end(); ++i) {
-				if (!hpiHandler-&gt;AddArchive(*i, false))
+				if (!hpiHandler-&gt;AddArchive(*i, false)) {
 					throw content_error(&quot;Couldn't load archive '&quot; + *i + &quot;' for map '&quot; + mapName + &quot;'.&quot;);
+				}
 			}
 		}
 		delete f;
@@ -600,21 +602,23 @@
 {
 	static bool alreadyLoaded = false;
 	
-	if (!alreadyLoaded)
-	{
+	if (!alreadyLoaded) {
+		// Map all required archives depending on selected mod(s)
 		std::string modArchive = archiveScanner-&gt;ModNameToModArchive(modName);
-		// Map all required archives depending on selected mod(s)
 		vector&lt;string&gt; ars = archiveScanner-&gt;GetArchives(modArchive);
-		if (ars.empty())
+		if (ars.empty()) {
 			throw content_error(&quot;Couldn't find any archives for mod '&quot; + modName + &quot;'&quot;);
-		for (vector&lt;string&gt;::iterator i = ars.begin(); i != ars.end(); ++i)
-		{
-			if (!hpiHandler-&gt;AddArchive(*i, false))
+		}
+		for (vector&lt;string&gt;::iterator i = ars.begin(); i != ars.end(); ++i) {
+
+			if (!hpiHandler-&gt;AddArchive(*i, false)) {
 				throw content_error(&quot;Couldn't load archive '&quot; + *i + &quot;' for mod '&quot; + modName + &quot;'.&quot;);
+			}
 		}
 	
 		// always load springcontent.sdz
 		hpiHandler-&gt;AddArchive(&quot;base/springcontent.sdz&quot;, false);
+
 		alreadyLoaded = true;
 	}
 }
@@ -623,7 +627,7 @@
 {
 	gameData = new GameData(packet);
 	
-	gs-&gt;SetRandSeed(gameData-&gt;GetRandomSeed());
+	gs-&gt;SetRandSeed(gameData-&gt;GetRandomSeed(), true);
 	logOutput &lt;&lt; &quot;Using map &quot; &lt;&lt; gameData-&gt;GetMap() &lt;&lt; &quot;\n&quot;;
 	stupidGlobalMapname = gameData-&gt;GetMap();
 	

Modified: trunk/rts/Game/StartScripts/CommanderScript.cpp
===================================================================
--- trunk/rts/Game/StartScripts/CommanderScript.cpp	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Game/StartScripts/CommanderScript.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -10,13 +10,12 @@
 #include &quot;Game/UI/MiniMap.h&quot;
 #include &quot;Game/UI/InfoConsole.h&quot;
 #include &quot;Lua/LuaParser.h&quot;
-#include &quot;Map/MapInfo.h&quot;
+#include &quot;Map/MapParser.h&quot;
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitDefHandler.h&quot;
 #include &quot;Sim/Units/UnitLoader.h&quot;
 #include &quot;System/LogOutput.h&quot;
-#include &quot;System/TdfParser.h&quot; // still required for parsing map SMD for start positions
 #include &quot;System/FileSystem/FileHandler.h&quot;
 #include &quot;mmgr.h&quot;
 
@@ -121,22 +120,18 @@
 			throw content_error (&quot;Unable to load a startUnit for the first side&quot;);
 		}
 		
-		TdfParser p2;
-		CMapInfo::OpenTDF(stupidGlobalMapname, p2);
+		MapParser mapParser(stupidGlobalMapname);
+		float3 startPos0(1000.0f, 80.0f, 1000.0f);
+		float3 startPos1(1200.0f, 80.0f, 1200.0f);
+		mapParser.GetStartPos(0, startPos0);
+		mapParser.GetStartPos(1, startPos1);
 
-		float x0, x1, z0, z1;
-		p2.GetDef(x0, &quot;1000&quot;, &quot;MAP\\TEAM0\\StartPosX&quot;);
-		p2.GetDef(z0, &quot;1000&quot;, &quot;MAP\\TEAM0\\StartPosZ&quot;);
-		p2.GetDef(x1, &quot;1200&quot;, &quot;MAP\\TEAM1\\StartPosX&quot;);
-		p2.GetDef(z1, &quot;1200&quot;, &quot;MAP\\TEAM1\\StartPosZ&quot;);
+		unitLoader.LoadUnit(su1, startPos0, 0, false, 0, NULL);
+		unitLoader.LoadUnit(su2, startPos1, 1, false, 0, NULL);
 
-		unitLoader.LoadUnit(su1, float3(x0, 80.0f, z0), 0, false, 0, NULL);
-		unitLoader.LoadUnit(su2, float3(x1, 80.0f, z1), 1, false, 0, NULL);
-
 		// FIXME this shouldn't be here, but no better place exists currently
-		minimap-&gt;AddNotification(float3(x0, 80.0f, z0),
-				float3(1.0f, 1.0f, 1.0f), 1.0f);
-		game-&gt;infoConsole-&gt;SetLastMsgPos(float3(x0, 80.0f, z0));
+		minimap-&gt;AddNotification(startPos0, float3(1.0f, 1.0f, 1.0f), 1.0f);
+		game-&gt;infoConsole-&gt;SetLastMsgPos(startPos0);
 	}
 }
 

Modified: trunk/rts/Game/StartScripts/CommanderScript2.cpp
===================================================================
--- trunk/rts/Game/StartScripts/CommanderScript2.cpp	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Game/StartScripts/CommanderScript2.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -2,11 +2,10 @@
 #include &quot;CommanderScript2.h&quot;
 #include &quot;Game/Team.h&quot;
 #include &quot;Lua/LuaParser.h&quot;
-#include &quot;Map/MapInfo.h&quot;
+#include &quot;Map/MapParser.h&quot;
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;Sim/Units/UnitLoader.h&quot;
 #include &quot;System/LogOutput.h&quot;
-#include &quot;System/TdfParser.h&quot;
 #include &quot;System/FileSystem/FileHandler.h&quot;
 #include &quot;mmgr.h&quot;
 
@@ -57,18 +56,15 @@
 			throw content_error (&quot;Unable to load a startUnit for the first side&quot;);
 		}
 
-		TdfParser p2;
-		CMapInfo::OpenTDF (stupidGlobalMapname, p2);
+		MapParser mapParser(stupidGlobalMapname);
+		float3 startPos0(1000.0f, 80.0f, 1000.0f);
+		float3 startPos1(1200.0f, 80.0f, 1200.0f);
+		mapParser.GetStartPos(0, startPos0);
+		mapParser.GetStartPos(1, startPos1);
 
-		float x0,x1,z0,z1;
-		p2.GetDef(x0,&quot;1000&quot;,&quot;MAP\\TEAM0\\StartPosX&quot;);
-		p2.GetDef(z0,&quot;1000&quot;,&quot;MAP\\TEAM0\\StartPosZ&quot;);
-		p2.GetDef(x1,&quot;1200&quot;,&quot;MAP\\TEAM1\\StartPosX&quot;);
-		p2.GetDef(z1,&quot;1200&quot;,&quot;MAP\\TEAM1\\StartPosZ&quot;);
+		unitLoader.LoadUnit(su1, startPos0, 0, false, 0, NULL);
+		unitLoader.LoadUnit(su2, startPos1, 1, false, 0, NULL);
 
-		unitLoader.LoadUnit(su1, float3(x0, 80, z0), 0, false, 0, NULL);
-		unitLoader.LoadUnit(su2, float3(x1, 80, z1), 1, false, 0, NULL);
-
 //		unitLoader.LoadUnit(&quot;armsam&quot;,float3(2650,10,2600),0,false);
 //		unitLoader.LoadUnit(&quot;armflash&quot;,float3(2450,10,2600),1,false);
 

Modified: trunk/rts/Game/StartScripts/GlobalAITestScript.cpp
===================================================================
--- trunk/rts/Game/StartScripts/GlobalAITestScript.cpp	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Game/StartScripts/GlobalAITestScript.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -5,12 +5,11 @@
 #include &quot;ExternalAI/GlobalAIHandler.h&quot;
 #include &quot;Game/Team.h&quot;
 #include &quot;Lua/LuaParser.h&quot;
-#include &quot;Map/MapInfo.h&quot;
+#include &quot;Map/MapParser.h&quot;
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;Sim/Units/UnitDefHandler.h&quot;
 #include &quot;Sim/Units/UnitLoader.h&quot;
 #include &quot;System/LogOutput.h&quot;
-#include &quot;System/TdfParser.h&quot;
 #include &quot;System/FileSystem/FileHandler.h&quot;
 #include &quot;System/Platform/FileSystem.h&quot;
 #include &quot;mmgr.h&quot;
@@ -63,17 +62,14 @@
 				throw content_error (&quot;Unable to load a commander for the first side&quot;);
 			}
 
-			TdfParser p2;
-			CMapInfo::OpenTDF(stupidGlobalMapname, p2);
+			MapParser mapParser(stupidGlobalMapname);
+			float3 startPos0(1000.0f, 80.0f, 1000.0f);
+			float3 startPos1(1200.0f, 80.0f, 1200.0f);
+			mapParser.GetStartPos(0, startPos0);
+			mapParser.GetStartPos(1, startPos1);
 
-			float x0, x1, z0, z1;
-			p2.GetDef(x0, &quot;1000&quot;, &quot;MAP\\TEAM0\\StartPosX&quot;);
-			p2.GetDef(z0, &quot;1000&quot;, &quot;MAP\\TEAM0\\StartPosZ&quot;);
-			p2.GetDef(x1, &quot;1200&quot;, &quot;MAP\\TEAM1\\StartPosX&quot;);
-			p2.GetDef(z1, &quot;1200&quot;, &quot;MAP\\TEAM1\\StartPosZ&quot;);
-
-			unitLoader.LoadUnit(su1, float3(x0, 80, z0), 0, false, 0, NULL);
-			unitLoader.LoadUnit(su2, float3(x1, 80, z1), 1, false, 0, NULL);
+			unitLoader.LoadUnit(su1, startPos0, 0, false, 0, NULL);
+			unitLoader.LoadUnit(su2, startPos1, 1, false, 0, NULL);
 			break;
 		}
 		default: {

Modified: trunk/rts/Game/StartScripts/LoadScript.cpp
===================================================================
--- trunk/rts/Game/StartScripts/LoadScript.cpp	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Game/StartScripts/LoadScript.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -13,8 +13,8 @@
 extern std::string stupidGlobalMapname;
 
 CLoadScript::CLoadScript(std::string file)
-	: CScript(std::string(&quot;Load &quot;) + filesystem.GetFilename(file)),
-	file(file)
+: CScript(std::string(&quot;Load &quot;) + filesystem.GetFilename(file)),
+  file(file)
 {
 }
 
@@ -25,39 +25,8 @@
 void CLoadScript::Update(void)
 {
 	if(!started) {
-/*
-		if(gameSetup){
-			TdfParser p(&quot;gamedata/SIDEDATA.TDF&quot;);
-			for(int a=0;a&lt;gs-&gt;activeTeams;++a){		
-				CTeam* team = gs-&gt;Team(a);
-				if (team-&gt;gaia) continue;
-//				if(!gameSetup-&gt;aiDlls[a].empty()){
-//					if (gu-&gt;myPlayerNum == gs-&gt;Team (a)-&gt;leader)
-//						globalAI-&gt;CreateGlobalAI(a,gameSetup-&gt;aiDlls[a].c_str());
-//				}
-
-				for(int b=0;b&lt;8;++b){					//loop over all sides
-					char sideText[50];
-					sprintf(sideText,&quot;side%i&quot;,b);
-					if(p.SectionExist(sideText)){
-						string sideName = StringToLower(p.SGetValueDef(&quot;arm&quot;,string(sideText)+&quot;\\name&quot;));
-						if(sideName==gs-&gt;Team(a)-&gt;side){		//ok found the right side
-							string cmdType=p.SGetValueDef(&quot;armcom&quot;,string(sideText)+&quot;\\commander&quot;);
-							
-							UnitDef* ud= unitDefHandler-&gt;GetUnitByName(cmdType);
-							ud-&gt;metalStorage=gs-&gt;Team(a)-&gt;metalStorage;			//make sure the cmd has the right amount of storage
-							ud-&gt;energyStorage=gs-&gt;Team(a)-&gt;energyStorage;
-							break;
-						}
-					}
-				}
-//				gs-&gt;Team(a)-&gt;metalStorage=/ *gs-&gt;Team(a)-&gt;metalStorage/2+* /20;		//now remove the preexisting storage except for a small amount
-//				gs-&gt;Team(a)-&gt;energyStorage=/ *gs-&gt;Team(a)-&gt;energyStorage/2+* /20;
-			}
-		}
-*/
 		loader.LoadGame();
-		started=true;
+		started = true;
 	}
 }
 
@@ -65,7 +34,7 @@
 {
 	loader.LoadGameStartInfo(file);		//this is the first time we get called after getting choosen
 	started = false;
-	loadGame=true;
+	loadGame = true;
 }
 
 std::string CLoadScript::GetMapName(void)

Modified: trunk/rts/Game/StartScripts/SpawnScript.cpp
===================================================================
--- trunk/rts/Game/StartScripts/SpawnScript.cpp	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Game/StartScripts/SpawnScript.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -4,7 +4,7 @@
 #include &quot;SpawnScript.h&quot;
 #include &quot;Game/Team.h&quot;
 #include &quot;Lua/LuaParser.h&quot;
-#include &quot;Map/MapInfo.h&quot;
+#include &quot;Map/MapParser.h&quot;
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;Sim/Units/UnitLoader.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
@@ -12,7 +12,6 @@
 #include &quot;Sim/Units/CommandAI/Command.h&quot;
 #include &quot;Sim/Units/CommandAI/CommandAI.h&quot;
 #include &quot;System/LogOutput.h&quot;
-#include &quot;System/TdfParser.h&quot;
 #include &quot;System/FileSystem/FileHandler.h&quot;
 #include &quot;mmgr.h&quot;
 
@@ -50,29 +49,25 @@
 			throw content_error (&quot;Unable to load a startUnit for the first side&quot;);
 		}
 
-		TdfParser p2;
-		CMapInfo::OpenTDF (stupidGlobalMapname, p2);
+		MapParser mapParser(stupidGlobalMapname);
 
-		float x0,z0;
-		p2.GetDef(x0,&quot;1000&quot;,&quot;MAP\\TEAM0\\StartPosX&quot;);
-		p2.GetDef(z0,&quot;1000&quot;,&quot;MAP\\TEAM0\\StartPosZ&quot;);
+		float3 startPos0(1000.0f, 80.0f, 1000.0f);
+		mapParser.GetStartPos(0, startPos0);
 
 		// Set the TEAM0 startpos as spawnpos if we're supposed to be
 		// autonomous, load the commander for the player if not.
-		if (autonomous) spawnPos.push_back(float3(x0,80,z0));
-		else unitLoader.LoadUnit(su1, float3(x0,80,z0),0,false,0,NULL);
+		if (autonomous) {
+			spawnPos.push_back(startPos0);
+		} else {
+			unitLoader.LoadUnit(su1, startPos0, 0, false, 0, NULL);
+		}
 
-		p2.GetDef(x0,&quot;1000&quot;,&quot;MAP\\TEAM1\\StartPosX&quot;);
-		p2.GetDef(z0,&quot;1000&quot;,&quot;MAP\\TEAM1\\StartPosZ&quot;);
-		spawnPos.push_back(float3(x0,80,z0));
-
-		p2.GetDef(x0,&quot;1000&quot;,&quot;MAP\\TEAM2\\StartPosX&quot;);
-		p2.GetDef(z0,&quot;1000&quot;,&quot;MAP\\TEAM2\\StartPosZ&quot;);
-		spawnPos.push_back(float3(x0,80,z0));
-
-		p2.GetDef(x0,&quot;1000&quot;,&quot;MAP\\TEAM3\\StartPosX&quot;);
-		p2.GetDef(z0,&quot;1000&quot;,&quot;MAP\\TEAM3\\StartPosZ&quot;);
-		spawnPos.push_back(float3(x0,80,z0));
+		// load the start positions for teams 1 - 3
+		for (int teamID = 1; teamID &lt;= 3; teamID++) {
+			float3 sp(1000.0f, 80.0f, 1000.0f);
+			mapParser.GetStartPos(teamID, sp);
+			spawnPos.push_back(sp);
+		}
 	}
 
 	if(!spawns.empty()){

Modified: trunk/rts/Game/StartScripts/TestScript.cpp
===================================================================
--- trunk/rts/Game/StartScripts/TestScript.cpp	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Game/StartScripts/TestScript.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -10,7 +10,6 @@
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Sim/Features/FeatureHandler.h&quot;
-#include &quot;TdfParser.h&quot;
 #include &quot;Game/Team.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;

Modified: trunk/rts/Game/UI/LuaUI.cpp
===================================================================
--- trunk/rts/Game/UI/LuaUI.cpp	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Game/UI/LuaUI.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -3003,7 +3003,7 @@
 	  text = lua_tostring(L, 4);
 	}
 
-	inMapDrawer-&gt;CreatePoint(pos, text);
+	inMapDrawer-&gt;SendPoint(pos, text);
 
 	return 0;
 }
@@ -3029,7 +3029,7 @@
 	                  (float)lua_tonumber(L, 5),
 	                  (float)lua_tonumber(L, 6));
 
-	inMapDrawer-&gt;AddLine(pos1, pos2);
+	inMapDrawer-&gt;SendLine(pos1, pos2);
 
 	return 0;
 }
@@ -3049,7 +3049,7 @@
 	                 (float)lua_tonumber(L, 2),
 	                 (float)lua_tonumber(L, 3));
 
-	inMapDrawer-&gt;ErasePos(pos);
+	inMapDrawer-&gt;SendErase(pos);
 
 	return 0;
 }

Modified: trunk/rts/Game/UI/StartPosSelecter.cpp
===================================================================
--- trunk/rts/Game/UI/StartPosSelecter.cpp	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Game/UI/StartPosSelecter.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -57,7 +57,7 @@
 		return true;
 
 	startPosSet = true;
-	inMapDrawer-&gt;ErasePos(startPos);
+	inMapDrawer-&gt;SendErase(startPos);
 	startPos = camera-&gt;pos + mouse-&gt;dir * dist;
 
 	if(startPos.z&lt;gameSetup-&gt;startRectTop[gu-&gt;myAllyTeam]*gs-&gt;mapy*8)
@@ -72,12 +72,9 @@
 	if(startPos.x&gt;gameSetup-&gt;startRectRight[gu-&gt;myAllyTeam]*gs-&gt;mapx*8)
 		startPos.x=gameSetup-&gt;startRectRight[gu-&gt;myAllyTeam]*gs-&gt;mapx*8;
 
-	net-&gt;SendStartPos(gu-&gt;myPlayerNum, gu-&gt;myTeam, 0, startPos.x, startPos.y, startPos.z);
+	net-&gt;SendStartPos(gu-&gt;myPlayerNum, gu-&gt;myTeam, 0,
+	                  startPos.x, startPos.y, startPos.z);
 
-	char t[128];
-	sprintf(t,&quot;Start %i&quot;,gu-&gt;myTeam);
-	inMapDrawer-&gt;CreatePoint(startPos,t);
-
 	return true;
 }
 

Modified: trunk/rts/Lua/LuaConstGame.cpp
===================================================================
--- trunk/rts/Lua/LuaConstGame.cpp	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Lua/LuaConstGame.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -109,10 +109,10 @@
 	LuaPushNamedColor(L,  &quot;groundSpecularColor&quot;, mi-&gt;light.groundSpecularColor);
 	LuaPushNamedColor(L,  &quot;groundSunColor&quot;,      mi-&gt;light.groundSunColor);
 
-	const string* causticTexs = mi-&gt;water.causticTextures;
+	const vector&lt;string&gt;&amp; causticTexs = mi-&gt;water.causticTextures;
 	lua_pushstring(L, &quot;waterCausticTextures&quot;);
 	lua_newtable(L);
-	for (int i = 0; i &lt; CMapInfo::causticTextureCount; i++) {
+	for (int i = 0; i &lt; (int)causticTexs.size(); i++) {
 		lua_pushnumber(L, i + 1);
 		lua_pushstring(L, causticTexs[i].c_str());
 		lua_rawset(L, -3);

Modified: trunk/rts/Lua/LuaFeatureDefs.cpp
===================================================================
--- trunk/rts/Lua/LuaFeatureDefs.cpp	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Lua/LuaFeatureDefs.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -169,7 +169,7 @@
 	ParamMap::const_iterator it = paramMap.find(name);
 
 	// not a default value
-	if (paramMap.find(name) == paramMap.end()) {
+	if (it == paramMap.end()) {
 	  lua_rawget(L, 1);
 	  return 1;
 	}
@@ -222,7 +222,7 @@
 	ParamMap::const_iterator it = paramMap.find(name);
 
 	// not a default value, set it
-	if (paramMap.find(name) == paramMap.end()) {
+	if (it == paramMap.end()) {
 		lua_rawset(L, 1);
 		return 0;
 	}

Modified: trunk/rts/Lua/LuaOpenGL.cpp
===================================================================
--- trunk/rts/Lua/LuaOpenGL.cpp	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Lua/LuaOpenGL.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -4816,7 +4816,7 @@
 		return 3;
 	}
 
-	const bool unitMode = lua_isstring(L, 2) &amp;&amp;
+	const bool unitMode = lua_israwstring(L, 2) &amp;&amp;
 	                      (strcmp(lua_tostring(L, 2), &quot;unit&quot;) == 0);
 
 	const float3* data = NULL;
@@ -4833,14 +4833,14 @@
 		if (!unitMode) {
 			data = &amp;mapInfo-&gt;light.groundSunColor;
 		} else {
-			data = &amp;unitDrawer-&gt;unitSunColor;
+			data = &amp;mapInfo-&gt;light.unitSunColor;
 		}
 	}
 	else if (param == &quot;ambient&quot;) {
 		if (!unitMode) {
-			data = &amp;mapInfo-&gt;light.groundSunColor;
+			data = &amp;mapInfo-&gt;light.groundAmbientColor;
 		} else {
-			data = &amp;unitDrawer-&gt;unitAmbientColor;
+			data = &amp;mapInfo-&gt;light.unitAmbientColor;
 		}
 	}
 	else if (param == &quot;specular&quot;) {

Modified: trunk/rts/Lua/LuaParser.cpp
===================================================================
--- trunk/rts/Lua/LuaParser.cpp	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Lua/LuaParser.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -33,45 +33,11 @@
 
 static const bool lowerKeys = true;
 
-
-/******************************************************************************/
-/******************************************************************************/
-
 LuaParser* LuaParser::currentParser = NULL;
 
 
 /******************************************************************************/
 /******************************************************************************/
-
-static void SetupStdLibs(lua_State* L)
-{
-	LUA_OPEN_LIB(L, luaopen_base);
-	LUA_OPEN_LIB(L, luaopen_math);
-	LUA_OPEN_LIB(L, luaopen_table);
-	LUA_OPEN_LIB(L, luaopen_string);
-	//LUA_OPEN_LIB(L, luaopen_io);
-	//LUA_OPEN_LIB(L, luaopen_os);
-	//LUA_OPEN_LIB(L, luaopen_package);
-	//LUA_OPEN_LIB(L, luaopen_debug);
-
-	// delete some dangerous/unsynced functions
-	lua_pushnil(L); lua_setglobal(L, &quot;dofile&quot;);
-	lua_pushnil(L); lua_setglobal(L, &quot;loadfile&quot;);
-	lua_pushnil(L); lua_setglobal(L, &quot;loadlib&quot;);
-	lua_pushnil(L); lua_setglobal(L, &quot;require&quot;);
-	lua_pushnil(L); lua_setglobal(L, &quot;gcinfo&quot;);
-	lua_pushnil(L); lua_setglobal(L, &quot;collectgarbage&quot;);
-
-	// FIXME: replace &quot;random&quot; as in LuaHandleSynced (can write your own for now)
-	lua_getglobal(L, &quot;math&quot;);
-	lua_pushstring(L, &quot;random&quot;);     lua_pushnil(L); lua_rawset(L, -3);
-	lua_pushstring(L, &quot;randomseed&quot;); lua_pushnil(L); lua_rawset(L, -3);
-	lua_pop(L, 1); // pop &quot;math&quot;
-}
-
-
-/******************************************************************************/
-/******************************************************************************/
 //
 //  LuaParser
 //
@@ -91,19 +57,7 @@
 	L = lua_open();
 
 	if (L != NULL) {
-		SetupStdLibs(L);
-
-		GetTable(&quot;Spring&quot;);
-		AddFunc(&quot;Echo&quot;, Echo);
-		AddFunc(&quot;TimeCheck&quot;, TimeCheck);
-		EndTable();
-
-		GetTable(&quot;VFS&quot;);
-		AddFunc(&quot;DirList&quot;,    DirList);
-		AddFunc(&quot;Include&quot;,    Include);
-		AddFunc(&quot;LoadFile&quot;,   LoadFile);
-		AddFunc(&quot;FileExists&quot;, FileExists);
-		EndTable();
+		SetupEnv();
 	}
 }
 
@@ -122,19 +76,7 @@
 	L = lua_open();
 
 	if (L != NULL) {
-		SetupStdLibs(L);
-
-		GetTable(&quot;Spring&quot;);
-		AddFunc(&quot;Echo&quot;, Echo);
-		AddFunc(&quot;TimeCheck&quot;, TimeCheck);
-		EndTable();
-
-		GetTable(&quot;VFS&quot;);
-		AddFunc(&quot;DirList&quot;,    DirList);
-		AddFunc(&quot;Include&quot;,    Include);
-		AddFunc(&quot;LoadFile&quot;,   LoadFile);
-		AddFunc(&quot;FileExists&quot;, FileExists);
-		EndTable();
+		SetupEnv();
 	}
 }
 
@@ -155,8 +97,146 @@
 }
 
 
+void LuaParser::SetupEnv()
+{
+	LUA_OPEN_LIB(L, luaopen_base);
+	LUA_OPEN_LIB(L, luaopen_math);
+	LUA_OPEN_LIB(L, luaopen_table);
+	LUA_OPEN_LIB(L, luaopen_string);
+	//LUA_OPEN_LIB(L, luaopen_io);
+	//LUA_OPEN_LIB(L, luaopen_os);
+	//LUA_OPEN_LIB(L, luaopen_package);
+	//LUA_OPEN_LIB(L, luaopen_debug);
+
+	// delete some dangerous/unsynced functions
+	lua_pushnil(L); lua_setglobal(L, &quot;dofile&quot;);
+	lua_pushnil(L); lua_setglobal(L, &quot;loadfile&quot;);
+	lua_pushnil(L); lua_setglobal(L, &quot;loadlib&quot;);
+	lua_pushnil(L); lua_setglobal(L, &quot;require&quot;);
+	lua_pushnil(L); lua_setglobal(L, &quot;gcinfo&quot;);
+	lua_pushnil(L); lua_setglobal(L, &quot;collectgarbage&quot;);
+
+	// FIXME: replace &quot;random&quot; as in LuaHandleSynced (can write your own for now)
+	lua_getglobal(L, &quot;math&quot;);
+	lua_pushstring(L, &quot;random&quot;);     lua_pushnil(L); lua_rawset(L, -3);
+	lua_pushstring(L, &quot;randomseed&quot;); lua_pushnil(L); lua_rawset(L, -3);
+	lua_pop(L, 1); // pop &quot;math&quot;
+
+	GetTable(&quot;Spring&quot;);
+	AddFunc(&quot;Echo&quot;, Echo);
+	AddFunc(&quot;TimeCheck&quot;, TimeCheck);
+	EndTable();
+
+	GetTable(&quot;VFS&quot;);
+	AddFunc(&quot;DirList&quot;,    DirList);
+	AddFunc(&quot;Include&quot;,    Include);
+	AddFunc(&quot;LoadFile&quot;,   LoadFile);
+	AddFunc(&quot;FileExists&quot;, FileExists);
+	EndTable();
+}
+
+
 /******************************************************************************/
 
+bool LuaParser::Execute()
+{
+	if (L == NULL) {
+		errorLog = &quot;could not initialize LUA library&quot;;
+		return false;
+	}
+
+	rootRef = LUA_NOREF;
+
+	assert(initDepth == 0);
+	initDepth = -1;
+
+	string code;
+	string codeLabel;
+	if (!textChunk.empty()) {
+		code = textChunk;
+		codeLabel = &quot;text chunk&quot;;
+	}
+	else if (!fileName.empty()) {
+		codeLabel = fileName;
+		CFileHandler fh(fileName, fileModes);
+		if (!fh.LoadStringData(code)) {
+			errorLog = &quot;could not open file: &quot; + fileName;
+			lua_close(L);
+			L = NULL;
+			return false;
+		}
+	}
+	else {
+		errorLog = &quot;no source file or text&quot;;
+		lua_close(L);
+		L = NULL;
+		return false;
+	}
+
+	int error;
+	error = luaL_loadbuffer(L, code.c_str(), code.size(), codeLabel.c_str());
+	if (error != 0) {
+		errorLog = lua_tostring(L, -1);
+		logOutput.Print(&quot;error = %i, %s, %s\n&quot;,
+		                error, codeLabel.c_str(), errorLog.c_str());
+		lua_close(L);
+		L = NULL;
+		return false;
+	}
+
+	currentParser = this;
+
+	error = lua_pcall(L, 0, 1, 0);
+
+	currentParser = NULL;
+
+	if (error != 0) {
+		errorLog = lua_tostring(L, -1);
+		logOutput.Print(&quot;error = %i, %s, %s\n&quot;,
+		                error, fileName.c_str(), errorLog.c_str());
+		lua_close(L);
+		L = NULL;
+		return false;
+	}
+
+	if (!lua_istable(L, 1)) {
+		errorLog = &quot;missing return table from &quot; + fileName + &quot;\n&quot;;
+		logOutput.Print(&quot;missing return table from %s\n&quot;, fileName.c_str());
+		lua_close(L);
+		L = NULL;
+		return false;
+	}
+
+	rootRef = luaL_ref(L, LUA_REGISTRYINDEX);
+
+	lua_settop(L, 0);
+
+	valid = true;
+
+	return true;
+}
+
+
+void LuaParser::AddTable(LuaTable* tbl)
+{
+	tables.insert(tbl);
+}
+
+
+void LuaParser::RemoveTable(LuaTable* tbl)
+{
+	tables.erase(tbl);
+}
+
+
+LuaTable LuaParser::GetRoot()
+{
+	return LuaTable(this);
+}
+
+
+/******************************************************************************/
+
 void LuaParser::PushParam()
 {
 	if ((L == NULL) || (initDepth &lt; 0)) { return; }
@@ -233,25 +313,25 @@
 }
 
 
-void LuaParser::AddParam(const string&amp; key, const string&amp; value)
+void LuaParser::AddInt(const string&amp; key, int value)
 {
 	if ((L == NULL) || (initDepth &lt; 0)) { return; }
 	lua_pushstring(L, key.c_str());
-	lua_pushstring(L, value.c_str());
+	lua_pushnumber(L, value);
 	PushParam();
 }
 
 
-void LuaParser::AddParam(const string&amp; key, float value)
+void LuaParser::AddBool(const string&amp; key, bool value)
 {
 	if ((L == NULL) || (initDepth &lt; 0)) { return; }
 	lua_pushstring(L, key.c_str());
-	lua_pushnumber(L, value);
+	lua_pushboolean(L, value);
 	PushParam();
 }
 
 
-void LuaParser::AddParam(const string&amp; key, int value)
+void LuaParser::AddFloat(const string&amp; key, float value)
 {
 	if ((L == NULL) || (initDepth &lt; 0)) { return; }
 	lua_pushstring(L, key.c_str());
@@ -260,11 +340,11 @@
 }
 
 
-void LuaParser::AddParam(const string&amp; key, bool value)
+void LuaParser::AddString(const string&amp; key, const string&amp; value)
 {
 	if ((L == NULL) || (initDepth &lt; 0)) { return; }
 	lua_pushstring(L, key.c_str());
-	lua_pushboolean(L, value);
+	lua_pushstring(L, value.c_str());
 	PushParam();
 }
 
@@ -281,25 +361,25 @@
 }
 
 
-void LuaParser::AddParam(int key, const string&amp; value)
+void LuaParser::AddInt(int key, int value)
 {
 	if ((L == NULL) || (initDepth &lt; 0)) { return; }
 	lua_pushnumber(L, key);
-	lua_pushstring(L, value.c_str());
+	lua_pushnumber(L, value);
 	PushParam();
 }
 
 
-void LuaParser::AddParam(int key, float value)
+void LuaParser::AddBool(int key, bool value)
 {
 	if ((L == NULL) || (initDepth &lt; 0)) { return; }
 	lua_pushnumber(L, key);
-	lua_pushnumber(L, value);
+	lua_pushboolean(L, value);
 	PushParam();
 }
 
 
-void LuaParser::AddParam(int key, int value)
+void LuaParser::AddFloat(int key, float value)
 {
 	if ((L == NULL) || (initDepth &lt; 0)) { return; }
 	lua_pushnumber(L, key);
@@ -308,110 +388,17 @@
 }
 
 
-void LuaParser::AddParam(int key, bool value)
+void LuaParser::AddString(int key, const string&amp; value)
 {
 	if ((L == NULL) || (initDepth &lt; 0)) { return; }
 	lua_pushnumber(L, key);
-	lua_pushboolean(L, value);
+	lua_pushstring(L, value.c_str());
 	PushParam();
 }
 
 
 /******************************************************************************/
-
-bool LuaParser::Execute()
-{
-	if (L == NULL) {
-		errorLog = &quot;could not initialize LUA library&quot;;
-		return false;
-	}
-
-	rootRef = LUA_NOREF;
-
-	assert(initDepth == 0);
-	initDepth = -1;
-
-	string code;
-	string codeLabel;
-	if (textChunk.size() &gt; 0) {
-		code = textChunk;
-		codeLabel = &quot;text chunk&quot;;
-	}
-	else {
-		codeLabel = fileName;
-		CFileHandler fh(fileName, fileModes);
-		if (!fh.LoadStringData(code)) {
-			errorLog = &quot;could not open file: &quot; + fileName;
-			lua_close(L);
-			L = NULL;
-			return false;
-		}
-	}
-
-	int error;
-	error = luaL_loadbuffer(L, code.c_str(), code.size(), codeLabel.c_str());
-	if (error != 0) {
-		errorLog = lua_tostring(L, -1);
-		logOutput.Print(&quot;error = %i, %s, %s\n&quot;,
-		                error, codeLabel.c_str(), errorLog.c_str());
-		lua_close(L);
-		L = NULL;
-		return false;
-	}
-
-	currentParser = this;
-
-	error = lua_pcall(L, 0, 1, 0);
-
-	currentParser = NULL;
-
-	if (error != 0) {
-		errorLog = lua_tostring(L, -1);
-		logOutput.Print(&quot;error = %i, %s, %s\n&quot;,
-		                error, fileName.c_str(), errorLog.c_str());
-		lua_close(L);
-		L = NULL;
-		return false;
-	}
-
-	if (!lua_istable(L, 1)) {
-		errorLog = &quot;missing return table from &quot; + fileName + &quot;\n&quot;;
-		logOutput.Print(&quot;missing return table from %s\n&quot;, fileName.c_str());
-		lua_close(L);
-		L = NULL;
-		return false;
-	}
-
-	rootRef = luaL_ref(L, LUA_REGISTRYINDEX);
-
-	lua_settop(L, 0);
-
-	valid = true;
-
-	return true;
-}
-
-
-void LuaParser::AddTable(LuaTable* tbl)
-{
-	tables.insert(tbl);
-}
-
-
-void LuaParser::RemoveTable(LuaTable* tbl)
-{
-	tables.erase(tbl);
-}
-
-
-LuaTable LuaParser::GetRoot()
-{
-	return LuaTable(this);
-}
-
-
 /******************************************************************************/
-/******************************************************************************/
 //
 //  call-outs
 //
@@ -747,6 +734,47 @@
 }
 
 
+LuaTable LuaTable::DotTable(const string&amp; expr) const
+{
+	if (expr.empty()) {
+		return LuaTable(*this);
+	}
+	if (!isValid) {
+		return LuaTable();
+	}
+
+	string::size_type endPos;
+	LuaTable nextTable;
+
+	if (expr[0] == '[') { // numeric key
+    endPos = expr.find(']');
+    if (endPos == string::npos) {
+      return LuaTable(); // missing brace
+    }
+    const char* startPtr = expr.c_str() + 1; // skip the '['
+    char* endPtr;
+    const int index = strtol(startPtr, &amp;endPtr, 10);
+    if (endPtr == startPtr) {
+      return LuaTable(); // invalid index
+    }
+    endPos++; // eat the ']'
+    nextTable = SubTable(index);
+	}
+	else { // string key
+		endPos = expr.find_first_of(&quot;.[&quot;);
+		if (endPos == string::npos) {
+			return SubTable(expr);
+		}
+		nextTable = SubTable(expr.substr(0, endPos));
+	}
+
+	if (expr[endPos] == '.') {
+		endPos++; // eat the dot
+	}
+	return nextTable.DotTable(expr.substr(endPos));
+}
+
+
 LuaTable::~LuaTable()
 {
 	if (L &amp;&amp; (refnum != LUA_NOREF)) {

Modified: trunk/rts/Lua/LuaParser.h
===================================================================
--- trunk/rts/Lua/LuaParser.h	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Lua/LuaParser.h	2008-06-02 02:41:57 UTC (rev 5971)
@@ -36,6 +36,8 @@
 		LuaTable SubTable(int key) const;
 		LuaTable SubTable(const string&amp; key) const;
 
+		LuaTable DotTable(const string&amp; dot) const;
+
 		bool IsValid() const { return (parser != NULL); }
 
 		const string&amp; GetPath() const { return path; }
@@ -118,6 +120,8 @@
 
 		LuaTable GetRoot();
 
+		LuaTable DotTable(const string&amp; dot) { return GetRoot().DotTable(dot); }
+
 		const string&amp; GetErrorLog() const { return errorLog; }
 	
 		const set&lt;string&gt;&amp; GetAccessedFiles() const { return accessedFiles; }
@@ -127,15 +131,15 @@
 		void GetTable(const string&amp; name, bool overwrite = false);
 		void EndTable();
 		void AddFunc(int key, int (*func)(lua_State*));
-		void AddParam(int key, const string&amp; value);
-		void AddParam(int key, float value);
-		void AddParam(int key, int value);
-		void AddParam(int key, bool value);
+		void AddInt(int key, int value);
+		void AddBool(int key, bool value);
+		void AddFloat(int key, float value);
+		void AddString(int key, const string&amp; value);
 		void AddFunc(const string&amp; key, int (*func)(lua_State*));
-		void AddParam(const string&amp; key, const string&amp; value);
-		void AddParam(const string&amp; key, float value);
-		void AddParam(const string&amp; key, int value);
-		void AddParam(const string&amp; key, bool value);
+		void AddInt(const string&amp; key, int value);
+		void AddBool(const string&amp; key, bool value);
+		void AddFloat(const string&amp; key, float value);
+		void AddString(const string&amp; key, const string&amp; value);
 
 	public:
 		const string fileName;
@@ -144,6 +148,8 @@
 		const string accessModes;
 
 	private:
+		void SetupEnv();
+
 		void PushParam();
 
 		void AddTable(LuaTable* tbl);

Modified: trunk/rts/Lua/LuaRules.cpp
===================================================================
--- trunk/rts/Lua/LuaRules.cpp	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Lua/LuaRules.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -119,6 +119,7 @@
 	haveAllowResourceLevel       = HasCallIn(&quot;AllowResourceLevel&quot;);
 	haveAllowResourceTransfer    = HasCallIn(&quot;AllowResourceTransfer&quot;);
 	haveAllowDirectUnitControl   = HasCallIn(&quot;AllowDirectUnitControl&quot;);
+	haveAllowStartPosition       = HasCallIn(&quot;AllowStartPosition&quot;);
 	haveMoveCtrlNotify           = HasCallIn(&quot;MoveCtrlNotify&quot;);
 	haveBuilderTerraformComplete = HasCallIn(&quot;BuilderTerraformComplete&quot;);
 	haveDrawUnit                 = HasCallIn(&quot;DrawUnit&quot;);
@@ -242,6 +243,8 @@
 		haveAllowResourceTransfer    = HasCallIn(&quot;AllowResourceTransfer&quot;);
 	} else if (name == &quot;AllowDirectUnitControl&quot;) {
 		haveAllowDirectUnitControl   = HasCallIn(&quot;AllowDirectUnitControl&quot;);
+	} else if (name == &quot;AllowStartPosition&quot;) {
+		haveAllowStartPosition       = HasCallIn(&quot;AllowStartPosition&quot;);
 	} else if (name == &quot;MoveCtrlNotify&quot;) {
 		haveMoveCtrlNotify           = HasCallIn(&quot;MoveCtrlNotify&quot;);
 	} else if (name == &quot;BuilderTerraformComplete&quot;) {
@@ -700,6 +703,44 @@
 }
 
 
+bool CLuaRules::AllowStartPosition(int playerID, const float3&amp; pos)
+{
+	if (!haveAllowStartPosition) {
+		return true; // the call is not defined
+	}
+
+	LUA_CALL_IN_CHECK(L);
+	lua_checkstack(L, 9);
+	static const LuaHashString cmdStr(&quot;AllowStartPosition&quot;);
+	if (!cmdStr.GetGlobalFunc(L)) {
+		return true; // the call is not defined
+	}
+
+	// push the start position and playerID
+	lua_pushnumber(L, pos.x);
+	lua_pushnumber(L, pos.y);
+	lua_pushnumber(L, pos.z);
+	lua_pushnumber(L, playerID);
+
+	// call the function
+	if (!RunCallIn(cmdStr, 4, 1)) {
+		return true;
+	}
+
+	// get the results
+	const int args = lua_gettop(L);
+	if (!lua_isboolean(L, -1)) {
+		logOutput.Print(&quot;%s() bad return value (%i)\n&quot;,
+		                cmdStr.GetString().c_str(), args);
+		lua_pop(L, 1);
+		return true;
+	}
+	const bool retval = !!lua_toboolean(L, -1);
+	lua_pop(L, 1);
+	return retval;
+}
+
+
 bool CLuaRules::MoveCtrlNotify(const CUnit* unit, int data)
 {
 	if (!haveMoveCtrlNotify) {
@@ -815,7 +856,7 @@
 	}
 
 	const int args = lua_gettop(L);
-	if ((args != 1) || !lua_isboolean(L, -1)) {
+	if (!lua_isboolean(L, -1)) {
 		logOutput.Print(&quot;%s() bad return value (%i)\n&quot;,
 		                cmdStr.GetString().c_str(), args);
 		lua_pop(L, 1);

Modified: trunk/rts/Lua/LuaRules.h
===================================================================
--- trunk/rts/Lua/LuaRules.h	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Lua/LuaRules.h	2008-06-02 02:41:57 UTC (rev 5971)
@@ -58,6 +58,7 @@
 		bool AllowResourceTransfer(int oldTeam, int newTeam,
 		                           const string&amp; type, float amount);
 		bool AllowDirectUnitControl(int playerID, const CUnit* unit);
+		bool AllowStartPosition(int playerID, const float3&amp; pos);
 
 		bool MoveCtrlNotify(const CUnit* unit, int data);
 
@@ -115,6 +116,7 @@
 		bool haveAllowResourceLevel;
 		bool haveAllowResourceTransfer;
 		bool haveAllowDirectUnitControl;
+		bool haveAllowStartPosition;
 		bool haveMoveCtrlNotify;
 		bool haveBuilderTerraformComplete;
 		bool haveDrawUnit;

Modified: trunk/rts/Lua/LuaUnitDefs.cpp
===================================================================
--- trunk/rts/Lua/LuaUnitDefs.cpp	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Lua/LuaUnitDefs.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -157,7 +157,7 @@
 	ParamMap::const_iterator it = paramMap.find(name);
 
 	// not a default value
-	if (paramMap.find(name) == paramMap.end()) {
+	if (it == paramMap.end()) {
 	  lua_rawget(L, 1);
 	  return 1;
 	}
@@ -210,7 +210,7 @@
 	ParamMap::const_iterator it = paramMap.find(name);
 
 	// not a default value, set it
-	if (paramMap.find(name) == paramMap.end()) {
+	if (it == paramMap.end()) {
 		lua_rawset(L, 1);
 		return 0;
 	}

Modified: trunk/rts/Lua/LuaWeaponDefs.cpp
===================================================================
--- trunk/rts/Lua/LuaWeaponDefs.cpp	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Lua/LuaWeaponDefs.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -123,7 +123,7 @@
 	ParamMap::const_iterator it = paramMap.find(name);
 
 	// not a default value
-	if (paramMap.find(name) == paramMap.end()) {
+	if (it == paramMap.end()) {
 		lua_rawget(L, 1);
 		return 1;
 	}
@@ -176,7 +176,7 @@
 	ParamMap::const_iterator it = paramMap.find(name);
 
 	// not a default value, set it
-	if (paramMap.find(name) == paramMap.end()) {
+	if (it == paramMap.end()) {
 		lua_rawset(L, 1);
 		return 0;
 	}

Modified: trunk/rts/Map/BasicMapDamage.cpp
===================================================================
--- trunk/rts/Map/BasicMapDamage.cpp	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Map/BasicMapDamage.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -155,15 +155,15 @@
 	for(int y=y1/2;y&lt;=hy2;y++)
 		for(int x=x1/2;x&lt;=hx2;x++)
 			readmap-&gt;mipHeightmap[1][y*gs-&gt;hmapx+x]=heightmap[(y*2+1)*(gs-&gt;mapx+1)+(x*2+1)];*/
-	for(int i=0; i&lt;readmap-&gt;numHeightMipMaps-1; i++){
-		int hmapx = gs-&gt;mapx&gt;&gt;i;
-		for(int y=(y1&gt;&gt;i)&amp;(~1);y&lt;y2&gt;&gt;i;y+=2){
-			for(int x=(x1&gt;&gt;i)&amp;(~1);x&lt;x2&gt;&gt;i;x+=2){
+	for (int i = 0; i &lt; readmap-&gt;numHeightMipMaps - 1; i++) {
+		int hmapx = gs-&gt;mapx &gt;&gt; i;
+		for (int y = ((y1 &gt;&gt; i) &amp; (~1)); y &lt; (y2 &gt;&gt; i); y += 2) {
+			for (int x = ((x1 &gt;&gt; i) &amp; (~1)); x &lt; (x2 &gt;&gt; i); x += 2) {
 				float height = readmap-&gt;mipHeightmap[i][(x)+(y)*hmapx];
-				height += readmap-&gt;mipHeightmap[i][(x)+(y+1)*hmapx];
-				height += readmap-&gt;mipHeightmap[i][(x+1)+(y)*hmapx];
+				height += readmap-&gt;mipHeightmap[i][(x)  +(y+1)*hmapx];
+				height += readmap-&gt;mipHeightmap[i][(x+1)+(y)  *hmapx];
 				height += readmap-&gt;mipHeightmap[i][(x+1)+(y+1)*hmapx];
-				readmap-&gt;mipHeightmap[i+1][(x/2)+(y/2)*hmapx/2] = height/4.0f;
+				readmap-&gt;mipHeightmap[i+1][(x/2)+(y/2)*hmapx/2] = height * 0.25f;
 			}
 		}
 	}
@@ -174,66 +174,65 @@
 	int decx=std::max(0,x1-1);
 	int incx=std::min(gs-&gt;mapx-1,x2+1);
 
-	for(int y=decy;y&lt;=incy;y++) {
-		for(int x=decx;x&lt;=incx;x++)
-		{
+	for (int y = decy; y &lt;= incy; y++) {
+		for (int x = decx; x &lt;= incx; x++) {
 			float3 e1(-SQUARE_SIZE,heightmap[y*(gs-&gt;mapx+1)+x]-heightmap[y*(gs-&gt;mapx+1)+x+1],0);
 			float3 e2( 0,heightmap[y*(gs-&gt;mapx+1)+x]-heightmap[(y+1)*(gs-&gt;mapx+1)+x],-SQUARE_SIZE);
 
 			float3 n=e2.cross(e1);
 			n.Normalize();
 
-			readmap-&gt;facenormals[(y*gs-&gt;mapx+x)*2]=n;
+			readmap-&gt;facenormals[(y*gs-&gt;mapx+x)*2] = n;
 
-			e1=float3( SQUARE_SIZE,heightmap[(y+1)*(gs-&gt;mapx+1)+x+1]-heightmap[(y+1)*(gs-&gt;mapx+1)+x],0);
-			e2=float3( 0,heightmap[(y+1)*(gs-&gt;mapx+1)+x+1]-heightmap[(y)*(gs-&gt;mapx+1)+x+1],SQUARE_SIZE);
+			e1 = float3( SQUARE_SIZE,heightmap[(y+1)*(gs-&gt;mapx+1)+x+1]-heightmap[(y+1)*(gs-&gt;mapx+1)+x],0);
+			e2 = float3( 0,heightmap[(y+1)*(gs-&gt;mapx+1)+x+1]-heightmap[(y)*(gs-&gt;mapx+1)+x+1],SQUARE_SIZE);
 
-			n=e2.cross(e1);
+			n = e2.cross(e1);
 			n.Normalize();
 
-			readmap-&gt;facenormals[(y*gs-&gt;mapx+x)*2+1]=n;
+			readmap-&gt;facenormals[(y*gs-&gt;mapx+x)*2+1] = n;
 		}
 	}
 
-	for(int y=std::max(2,(y1&amp;0xfffffe));y&lt;=std::min(gs-&gt;mapy-3,y2);y+=2)
-	{
-		for(int x=std::max(2,(x1&amp;0xfffffe));x&lt;=std::min(gs-&gt;mapx-3,x2);x+=2)
-		{
+	for(int y = std::max(2,(y1&amp;0xfffffe)); y &lt;= std::min(gs-&gt;mapy-3,y2); y += 2) {
+		for(int x = std::max(2,(x1&amp;0xfffffe)); x &lt;= std::min(gs-&gt;mapx-3,x2); x += 2) {
 			float3 e1(-SQUARE_SIZE*4,heightmap[(y-1)*(gs-&gt;mapx+1)+x-1]-heightmap[(y-1)*(gs-&gt;mapx+1)+x+3],0);
 			float3 e2( 0,heightmap[(y-1)*(gs-&gt;mapx+1)+x-1]-heightmap[(y+3)*(gs-&gt;mapx+1)+x-1],-SQUARE_SIZE*4);
 
-			float3 n=e2.cross(e1);
+			float3 n = e2.cross(e1);
 			n.Normalize();
 
-			e1=float3( SQUARE_SIZE*4,heightmap[(y+3)*(gs-&gt;mapx+1)+x+3]-heightmap[(y+3)*(gs-&gt;mapx+1)+x-1],0);
-			e2=float3( 0,heightmap[(y+3)*(gs-&gt;mapx+1)+x+3]-heightmap[(y-1)*(gs-&gt;mapx+1)+x+3],SQUARE_SIZE*4);
+			e1 = float3( SQUARE_SIZE*4,heightmap[(y+3)*(gs-&gt;mapx+1)+x+3]-heightmap[(y+3)*(gs-&gt;mapx+1)+x-1],0);
+			e2 = float3( 0,heightmap[(y+3)*(gs-&gt;mapx+1)+x+3]-heightmap[(y-1)*(gs-&gt;mapx+1)+x+3],SQUARE_SIZE*4);
 
-			float3 n2=e2.cross(e1);
+			float3 n2 = e2.cross(e1);
 			n2.Normalize();
 
-			readmap-&gt;slopemap[(y/2)*gs-&gt;hmapx+(x/2)]=1-(n.y+n2.y)*0.5f;
+			readmap-&gt;slopemap[(y/2)*gs-&gt;hmapx+(x/2)] = 1-(n.y+n2.y)*0.5f;
 		}
 	}
-	pathManager-&gt;TerrainChange(x1,y1,x2,y2);
-	featureHandler-&gt;TerrainChanged(x1,y1,x2,y2);
-	readmap-&gt;HeightmapUpdated(x1,x2,y1,y2);
 
-	decy=std::max(0,(y1*SQUARE_SIZE-QUAD_SIZE/2)/QUAD_SIZE);
-	incy=std::min(qf-&gt;GetNumQuadsZ()-1,(y2*SQUARE_SIZE+QUAD_SIZE/2)/QUAD_SIZE);
-	decx=std::max(0,(x1*SQUARE_SIZE-QUAD_SIZE/2)/QUAD_SIZE);
-	incx=std::min(qf-&gt;GetNumQuadsX()-1,(x2*SQUARE_SIZE+QUAD_SIZE/2)/QUAD_SIZE);
+	pathManager-&gt;TerrainChange(x1, y1, x2, y2);
+	featureHandler-&gt;TerrainChanged(x1, y1, x2, y2);
+	readmap-&gt;HeightmapUpdated(x1, x2, y1, y2);
 
-	for(int y=decy;y&lt;=incy;y++){
-		for(int x=decx;x&lt;=incx;x++){
-			if(inRelosQue[y*qf-&gt;GetNumQuadsX()+x])
+	decy = std::max(0,(y1*SQUARE_SIZE-QUAD_SIZE/2)/QUAD_SIZE);
+	incy = std::min(qf-&gt;GetNumQuadsZ()-1,(y2*SQUARE_SIZE+QUAD_SIZE/2)/QUAD_SIZE);
+	decx = std::max(0,(x1*SQUARE_SIZE-QUAD_SIZE/2)/QUAD_SIZE);
+	incx = std::min(qf-&gt;GetNumQuadsX()-1,(x2*SQUARE_SIZE+QUAD_SIZE/2)/QUAD_SIZE);
+
+	for (int y = decy; y &lt;= incy; y++) {
+		for (int x = decx; x &lt;= incx; x++) {
+			if (inRelosQue[y*qf-&gt;GetNumQuadsX()+x]) {
 				continue;
+			}
 			RelosSquare rs;
-			rs.x=x;
-			rs.y=y;
-			rs.neededUpdate=gs-&gt;frameNum;
+			rs.x = x;
+			rs.y = y;
+			rs.neededUpdate = gs-&gt;frameNum;
 			rs.numUnits = qf-&gt;GetQuadAt(x, y).units.size();
-			relosSize+=rs.numUnits;
-			inRelosQue[y*qf-&gt;GetNumQuadsX()+x]=true;
+			relosSize += rs.numUnits;
+			inRelosQue[y*qf-&gt;GetNumQuadsX()+x] = true;
 			relosQue.push_back(rs);
 		}
 	}

Modified: trunk/rts/Map/MapInfo.cpp
===================================================================
--- trunk/rts/Map/MapInfo.cpp	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Map/MapInfo.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -1,10 +1,14 @@
+#include &quot;StdAfx.h&quot;
+
 #include &quot;MapInfo.h&quot;
 
+#include &quot;MapParser.h&quot;
 #include &quot;Lua/LuaParser.h&quot;
 #include &quot;System/LogOutput.h&quot;
-#include &quot;System/TdfParser.h&quot;
 #include &quot;System/FileSystem/FileHandler.h&quot;
 
+using namespace std;
+
 float4::float4()
 {
 	float tmp[4];
@@ -27,16 +31,25 @@
 const CMapInfo* mapInfo;
 
 
-CMapInfo::CMapInfo(const std::string&amp; mapname)
+CMapInfo::CMapInfo(const string&amp; mapname)
 {
 	map.name = mapname;
-	mapDefParser = new TdfParser(GetTDFName(mapname));
-	resourcesParser = new LuaParser (&quot;gamedata/resources.lua&quot;,
-	                                 SPRING_VFS_MOD_BASE, SPRING_VFS_ZIP);
-	if (!resourcesParser-&gt;Execute()) {
-		logOutput.Print(resourcesParser-&gt;GetErrorLog());
+
+	MapParser mapParser(mapname);
+	if (!mapParser.IsValid()) {
+		logOutput.Print(mapParser.GetErrorLog());
 	}
-	
+	LuaTable mapTbl = mapParser.GetRoot();
+	mapRoot = &mapTbl;
+
+	LuaParser resParser(&quot;gamedata/resources.lua&quot;,
+	                    SPRING_VFS_MOD_BASE, SPRING_VFS_ZIP);
+	if (!resParser.Execute()) {
+		logOutput.Print(resParser.GetErrorLog());
+	}
+	LuaTable resTbl = resParser.GetRoot();
+	resRoot = &resTbl;
+
 	ReadGlobal();
 	ReadAtmosphere();
 	ReadGui();
@@ -45,197 +58,223 @@
 	ReadSmf();
 	ReadSm3();
 	ReadTerrainTypes();
-
-	delete resourcesParser;
-	resourcesParser = NULL;
 }
 
 
 CMapInfo::~CMapInfo()
 {
-	delete mapDefParser;
-	mapDefParser = NULL;
 }
 
 
-/** @brief Opens the TDF file from the given map in parser.
-	FIXME: This is mostly a hack to supply CGameSetup with start positions,
-	when no CMapInfo object has yet been created.
- */
-void CMapInfo::OpenTDF(const std::string&amp; mapname, TdfParser&amp; parser)
-{
-	parser.LoadFile(GetTDFName(mapname));
-}
-
-
-/** @brief Get the name of the TDF file with map settings.
-	@return &quot;maps/%.smd&quot; for &quot;%.smf&quot; and &quot;maps/%.sm3&quot; for &quot;%.sm3&quot;
- */
-std::string CMapInfo::GetTDFName(const std::string&amp; mapname)
-{
-	if (mapname.length() &lt; 3)
-		throw std::runtime_error(&quot;CMapInfo::GetTDFName(): mapname '&quot; + mapname + &quot;' too short&quot;);
-
-	std::string extension = mapname.substr(mapname.length() - 3);
-	if (extension == &quot;smf&quot;)
-		return std::string(&quot;maps/&quot;) + mapname.substr(0, mapname.find_last_of('.')) + &quot;.smd&quot;;
-	else if(extension == &quot;sm3&quot;)
-		return std::string(&quot;maps/&quot;) + mapname;
-	else
-		throw std::runtime_error(&quot;CMapInfo::GetTDFName(): Unknown extension: &quot; + extension);
-}
-
-
 void CMapInfo::ReadGlobal()
 {
-	map.humanName = mapDefParser-&gt;SGetValueDef(map.name, &quot;MAP\\Description&quot;);
-	map.wantedScript = mapDefParser-&gt;SGetValueDef(map.wantedScript, &quot;MAP\\Script&quot;);
+	const LuaTable topTable = *mapRoot;
+	
+	map.humanName    = topTable.GetString(&quot;description&quot;, map.name);
+	map.wantedScript = topTable.GetString(&quot;script&quot;, map.wantedScript);
 
-	mapDefParser-&gt;GetTDef(map.hardness, 100.0f, &quot;MAP\\MapHardness&quot;);
-	map.notDeformable = mapDefParser-&gt;SGetValueDef(&quot;0&quot;, &quot;MAP\\NotDeformable&quot;) != &quot;0&quot;;
+	map.hardness      = topTable.GetFloat(&quot;maphardness&quot;, 100.0f);
+	map.notDeformable = topTable.GetBool(&quot;notDeformable&quot;, false);
 
-	mapDefParser-&gt;GetTDef(map.gravity, 130.0f, &quot;MAP\\Gravity&quot;);
+	map.gravity = topTable.GetFloat(&quot;gravity&quot;, 130.0f);
 	map.gravity = -map.gravity / (GAME_SPEED * GAME_SPEED);
 
-	mapDefParser-&gt;GetTDef(map.tidalStrength, 0.0f, &quot;MAP\\TidalStrength&quot;);
-	mapDefParser-&gt;GetTDef(map.maxMetal, 0.02f, &quot;MAP\\MaxMetal&quot;);
-	mapDefParser-&gt;GetTDef(map.extractorRadius, 500.0f, &quot;MAP\\ExtractorRadius&quot;);
+	map.tidalStrength   = topTable.GetFloat(&quot;tidalStrength&quot;, 0.0f);
+	map.maxMetal        = topTable.GetFloat(&quot;maxMetal&quot;, 0.02f);
+	map.extractorRadius = topTable.GetFloat(&quot;extractorRadius&quot;, 500.0f);
 
-	mapDefParser-&gt;GetDef(map.voidWater, &quot;0&quot;, &quot;MAP\\voidWater&quot;);
+	map.voidWater = topTable.GetBool(&quot;voidWater&quot;, false);
 }
 
 
 void CMapInfo::ReadGui()
 {
 	// GUI
-	mapDefParser-&gt;GetTDef(gui.autoShowMetal, true, &quot;MAP\\autoShowMetal&quot;);
+	gui.autoShowMetal = mapRoot-&gt;GetBool(&quot;autoShowMetal&quot;, true);
 }
 
 
 void CMapInfo::ReadAtmosphere()
 {
 	// MAP\ATMOSPHERE
-	mapDefParser-&gt;GetTDef(atmosphere.cloudDensity, 0.5f, &quot;MAP\\ATMOSPHERE\\CloudDensity&quot;);
-	mapDefParser-&gt;GetTDef(atmosphere.fogStart, 0.1f, &quot;MAP\\ATMOSPHERE\\FogStart&quot;);
-	atmosphere.fogColor = mapDefParser-&gt;GetFloat3(float3(0.7f, 0.7f, 0.8f), &quot;MAP\\ATMOSPHERE\\FogColor&quot;);
-	atmosphere.skyColor = mapDefParser-&gt;GetFloat3(float3(0.1f, 0.15f, 0.7f), &quot;MAP\\ATMOSPHERE\\SkyColor&quot;);
-	atmosphere.sunColor = mapDefParser-&gt;GetFloat3(float3(1.0f, 1.0f, 1.0f), &quot;MAP\\ATMOSPHERE\\SunColor&quot;);
-	atmosphere.cloudColor = mapDefParser-&gt;GetFloat3(float3(1.0f, 1.0f, 1.0f), &quot;MAP\\ATMOSPHERE\\CloudColor&quot;);
-	mapDefParser-&gt;GetTDef(atmosphere.minWind, 5.0f, &quot;MAP\\ATMOSPHERE\\MinWind&quot;);
-	mapDefParser-&gt;GetTDef(atmosphere.maxWind, 25.0f, &quot;MAP\\ATMOSPHERE\\MaxWind&quot;);
-	mapDefParser-&gt;GetDef(atmosphere.skyBox, &quot;&quot;, &quot;MAP\\ATMOSPHERE\\SkyBox&quot;);
+	const LuaTable atmoTable = mapRoot-&gt;SubTable(&quot;atmosphere&quot;);
+	atmosphere_t&amp; atmo = atmosphere;
+	atmo.cloudDensity = atmoTable.GetFloat(&quot;cloudDensity&quot;, 0.5f);
+	atmo.minWind      = atmoTable.GetFloat(&quot;minWind&quot;, 5.0f);
+	atmo.maxWind      = atmoTable.GetFloat(&quot;maxWind&quot;, 25.0f);
+	atmo.fogStart     = atmoTable.GetFloat(&quot;fogStart&quot;, 0.1f);
+	atmo.fogColor   = atmoTable.GetFloat3(&quot;fogColor&quot;, float3(0.7f, 0.7f, 0.8f));
+	atmo.skyColor   = atmoTable.GetFloat3(&quot;skyColor&quot;, float3(0.1f, 0.15f, 0.7f));
+	atmo.sunColor   = atmoTable.GetFloat3(&quot;sunColor&quot;, float3(1.0f, 1.0f, 1.0f));
+	atmo.cloudColor = atmoTable.GetFloat3(&quot;cloudColor&quot;, float3(1.0f, 1.0f, 1.0f));
+	atmo.skyBox = atmoTable.GetString(&quot;skyBox&quot;, &quot;&quot;);
 }
 
 
 void CMapInfo::ReadLight()
 {
-	// MAP\LIGHT
-	light.sunDir = mapDefParser-&gt;GetFloat3(float3(0.0f, 1.0f, 2.0f), &quot;MAP\\LIGHT\\SunDir&quot;);
+	const LuaTable lightTable = mapRoot-&gt;SubTable(&quot;lighting&quot;);
+
+	light.sunDir = lightTable.GetFloat3(&quot;sunDir&quot;, float3(0.0f, 1.0f, 2.0f));
 	light.sunDir.Normalize();
 
-	light.groundAmbientColor = mapDefParser-&gt;GetFloat3(float3(0.5f, 0.5f, 0.5f), &quot;MAP\\LIGHT\\GroundAmbientColor&quot;);
-	light.groundSunColor = mapDefParser-&gt;GetFloat3(float3(0.5f, 0.5f, 0.5f), &quot;MAP\\LIGHT\\GroundSunColor&quot;);
-	light.groundSpecularColor = mapDefParser-&gt;GetFloat3(float3(0.1f, 0.1f, 0.1f), &quot;MAP\\LIGHT\\GroundSpecularColor&quot;);
-	mapDefParser-&gt;GetTDef(light.groundShadowDensity, 0.8f, &quot;MAP\\LIGHT\\GroundShadowDensity&quot;);
+	light.groundAmbientColor  = lightTable.GetFloat3(&quot;groundAmbientColor&quot;,
+	                                                float3(0.5f, 0.5f, 0.5f));
+	light.groundSunColor      = lightTable.GetFloat3(&quot;groundDiffuseColor&quot;,
+	                                                float3(0.5f, 0.5f, 0.5f));
+	light.groundSpecularColor = lightTable.GetFloat3(&quot;groundSpecularColor&quot;,
+	                                                float3(0.1f, 0.1f, 0.1f));
+	light.groundShadowDensity = lightTable.GetFloat(&quot;groundShadowDensity&quot;, 0.8f);
 
-	light.unitAmbientColor = float4(mapDefParser-&gt;GetFloat3(float3(0.4f, 0.4f, 0.4f), &quot;MAP\\LIGHT\\UnitAmbientColor&quot;), 1.0f);
-	light.unitSunColor = float4(mapDefParser-&gt;GetFloat3(float3(0.7f, 0.7f, 0.7f), &quot;MAP\\LIGHT\\UnitSunColor&quot;), 1.0f);
-	light.specularSunColor = mapDefParser-&gt;GetFloat3(light.unitSunColor, &quot;MAP\\LIGHT\\SpecularSunColor&quot;);
-	mapDefParser-&gt;GetTDef(light.unitShadowDensity, 0.8f, &quot;MAP\\LIGHT\\UnitShadowDensity&quot;);
+	light.unitAmbientColor  = lightTable.GetFloat3(&quot;unitAmbientColor&quot;,
+	                                                float3(0.4f, 0.4f, 0.4f));
+	light.unitSunColor      = lightTable.GetFloat3(&quot;unitDiffuseColor&quot;,
+	                                                float3(0.7f, 0.7f, 0.7f));
+	light.specularSunColor = lightTable.GetFloat3(&quot;unitSpecularColor&quot;,
+	                                               light.unitSunColor);
+	light.unitShadowDensity = lightTable.GetFloat(&quot;unitShadowDensity&quot;, 0.8f);
 }
 
 
 void CMapInfo::ReadWater()
 {
-	// MAP\WATER
-	mapDefParser-&gt;GetTDef(water.repeatX, 0.0f, &quot;MAP\\WATER\\WaterRepeatX&quot;);
-	mapDefParser-&gt;GetTDef(water.repeatY, 0.0f, &quot;MAP\\WATER\\WaterRepeatY&quot;);
-	mapDefParser-&gt;GetTDef(water.damage, 0.0f, &quot;MAP\\WATER\\WaterDamage&quot;);
-	water.damage *= 16.0f / 30.0f;
-	
-	std::string tmp;
-	mapDefParser-&gt;GetDef(tmp, &quot;&quot;, &quot;MAP\\WATER\\WaterPlaneColor&quot;);
-	hasWaterPlane = !tmp.empty();
-	water.planeColor = mapDefParser-&gt;GetFloat3(float3(0.0f, 0.4f, 0.0f), &quot;MAP\\WATER\\WaterPlaneColor&quot;);
+	const LuaTable wt = mapRoot-&gt;SubTable(&quot;water&quot;);
 
-	mapDefParser-&gt;GetDef(water.fresnelMin,&quot;0.2&quot;,&quot;MAP\\WATER\\FresnelMin&quot;);
-	mapDefParser-&gt;GetDef(water.fresnelMax,&quot;0.3&quot;,&quot;MAP\\WATER\\FresnelMax&quot;);
-	mapDefParser-&gt;GetDef(water.fresnelPower,&quot;4.0&quot;,&quot;MAP\\WATER\\FresnelPower&quot;);
+	water.repeatX = wt.GetFloat(&quot;repeatX&quot;, 0.0f);
+	water.repeatY = wt.GetFloat(&quot;repeatY&quot;, 0.0f);
+	water.damage  = wt.GetFloat(&quot;damage&quot;, 0.0f) * (16.0f / 30.0f);
 
-	mapDefParser-&gt;GetDef(water.specularFactor,&quot;20.0&quot;,&quot;MAP\\WATER\\WaterSpecularFactor&quot;);
+	water.absorb       = wt.GetFloat3(&quot;absorb&quot;,       float3(0.0f, 0.0f, 0.0f));
+	water.baseColor    = wt.GetFloat3(&quot;baseColor&quot;,    float3(0.0f, 0.0f, 0.0f));
+	water.minColor     = wt.GetFloat3(&quot;minColor&quot;,     float3(0.0f, 0.0f, 0.0f));
 
-	water.specularColor = mapDefParser-&gt;GetFloat3(light.groundSunColor,&quot;MAP\\WATER\\WaterSpecularColor&quot;);
-	water.surfaceColor = mapDefParser-&gt;GetFloat3(float3(0.75f, 0.8f, 0.85f), &quot;MAP\\WATER\\WaterSurfaceColor&quot;);
-	mapDefParser-&gt;GetDef(water.surfaceAlpha,&quot;0.55&quot;,&quot;MAP\\WATER\\WaterSurfaceAlpha&quot;);
-	water.absorb = mapDefParser-&gt;GetFloat3(float3(0, 0, 0), &quot;MAP\\WATER\\WaterAbsorb&quot;);
-	water.baseColor = mapDefParser-&gt;GetFloat3(float3(0, 0, 0), &quot;MAP\\WATER\\WaterBaseColor&quot;);
-	water.minColor = mapDefParser-&gt;GetFloat3(float3(0, 0, 0), &quot;MAP\\WATER\\WaterMinColor&quot;);
+	water.surfaceColor = wt.GetFloat3(&quot;surfaceColor&quot;, float3(0.75f, 0.8f, 0.85f));
+	water.surfaceAlpha = wt.GetFloat(&quot;surfaceAlpha&quot;,  0.55f);
 
-	mapDefParser-&gt;GetDef(water.texture, &quot;&quot;, &quot;MAP\\WATER\\WaterTexture&quot;);
-	mapDefParser-&gt;GetDef(water.foamTexture, &quot;&quot;, &quot;MAP\\WATER\\WaterFoamTexture&quot;);
-	mapDefParser-&gt;GetDef(water.normalTexture, &quot;&quot;, &quot;MAP\\WATER\\WaterNormalTexture&quot;);
+	water.planeColor   = wt.GetFloat3(&quot;planeColor&quot;,   float3(0.0f, 0.4f, 0.0f));
+	hasWaterPlane = wt.KeyExists(&quot;planeColor&quot;);
 
-	//default water is ocean.jpg in bitmaps, map specific water textures is saved in the map dir
-	const LuaTable mapsTable = resourcesParser-&gt;GetRoot().SubTable(&quot;graphics&quot;).SubTable(&quot;maps&quot;);
-	const LuaTable causticsTable = resourcesParser-&gt;GetRoot().SubTable(&quot;graphics&quot;).SubTable(&quot;caustics&quot;);
-	
-	if(water.texture.empty())
-		water.texture = &quot;bitmaps/&quot; + mapsTable.GetString(&quot;watertex&quot;, &quot;ocean.jpg&quot;);
-	else
+	water.specularColor  = wt.GetFloat3(&quot;specularColor&quot;, light.groundSunColor);
+	water.specularFactor = wt.GetFloat(&quot;specularFactor&quot;, 20.0f);
+
+	water.fresnelMin   = wt.GetFloat(&quot;fresnelMin&quot;,   0.2f);
+	water.fresnelMax   = wt.GetFloat(&quot;fresnelMax&quot;,   0.3f);
+	water.fresnelPower = wt.GetFloat(&quot;fresnelPower&quot;, 4.0f);
+
+	water.texture       = wt.GetString(&quot;texture&quot;, &quot;&quot;);
+	water.foamTexture   = wt.GetString(&quot;foamTexture&quot;, &quot;&quot;);
+	water.normalTexture = wt.GetString(&quot;normalTexture&quot;, &quot;&quot;);
+
+	// use 'resources.lua' for missing fields  (our the engine defaults)
+	const LuaTable resGfxMaps = resRoot-&gt;SubTable(&quot;graphics&quot;).SubTable(&quot;maps&quot;);
+
+	if (!water.texture.empty()) {
 		water.texture = &quot;maps/&quot; + water.texture;
+	} else {
+		water.texture = &quot;bitmaps/&quot; + resGfxMaps.GetString(&quot;watertex&quot;, &quot;ocean.jpg&quot;);
+	}
 
-	if(water.foamTexture.empty())
-		water.foamTexture = &quot;bitmaps/&quot; + mapsTable.GetString(&quot;waterfoamtex&quot;, &quot;foam.jpg&quot;);
-	else
+	if (!water.foamTexture.empty()) {
 		water.foamTexture = &quot;maps/&quot; + water.foamTexture;
+	} else {
+		water.foamTexture = &quot;bitmaps/&quot; + resGfxMaps.GetString(&quot;waterfoamtex&quot;, &quot;foam.jpg&quot;);
+	}
 
-	if(water.normalTexture.empty())
-		water.normalTexture = &quot;bitmaps/&quot; + mapsTable.GetString(&quot;waternormaltex&quot;, &quot;waterbump.png&quot;);
-	else
+	if (!water.normalTexture.empty()) {
 		water.normalTexture = &quot;maps/&quot; + water.normalTexture;
+	} else {
+		water.normalTexture = &quot;bitmaps/&quot; + resGfxMaps.GetString(&quot;waternormaltex&quot;, &quot;waterbump.png&quot;);
+	}
 
-	char num[10];
-	for (int i = 0; i &lt; causticTextureCount; i++) {
-		sprintf(num, &quot;%02i&quot;, i);
-		water.causticTextures[i] = std::string(&quot;bitmaps/&quot;) + causticsTable.GetString(i+1, 
-															 std::string(&quot;caustics/caustic&quot;)+num+&quot;.jpg&quot;);
+	// water caustic textures
+	LuaTable caustics = wt.SubTable(&quot;causticTextures&quot;);
+	string causticPrefix = &quot;maps/&quot;;
+	if (!caustics.IsValid()) {
+		caustics = resGfxMaps.SubTable(&quot;causticTextures&quot;);
+		causticPrefix = &quot;bitmaps/&quot;;
 	}
+	if (caustics.IsValid()) {
+		for (int i = 1; true; i++) {
+			const string texName = causticPrefix + caustics.GetString(i, &quot;&quot;);
+			if (texName.empty()) {
+				break;
+			}
+			water.causticTextures.push_back(texName);
+		}
+	} else {
+		// load the default 32 textures
+		for (int i = 0; i &lt; 32; i++) {
+			char defTex[256];
+			sprintf(defTex, &quot;bitmaps/caustics/caustic%02i.jpg&quot;, i);
+			water.causticTextures.push_back(defTex);
+		}
+	}
 }
 
 
 void CMapInfo::ReadSmf()
 {
 	// SMF specific settings
-	mapDefParser-&gt;GetDef(smf.detailTexName, &quot;&quot;, &quot;MAP\\DetailTex&quot;);
 
-	const LuaTable mapsTable = resourcesParser-&gt;GetRoot().SubTable(&quot;graphics&quot;).SubTable(&quot;maps&quot;);
-	
-	if (smf.detailTexName.empty())
-		smf.detailTexName = &quot;bitmaps/&quot; + mapsTable.GetString(&quot;detailtex&quot;,&quot;detailtex2.bmp&quot;);
-	else
+	const LuaTable mapResTable = mapRoot-&gt;SubTable(&quot;resources&quot;);
+	smf.detailTexName = mapResTable.GetString(&quot;detailTex&quot;, &quot;&quot;);
+	if (!smf.detailTexName.empty()) {
 		smf.detailTexName = &quot;maps/&quot; + smf.detailTexName;
+	}
+	else {
+		const LuaTable resGfxMaps = resRoot-&gt;SubTable(&quot;graphics&quot;).SubTable(&quot;maps&quot;);
+		smf.detailTexName = resGfxMaps.GetString(&quot;detailtex&quot;, &quot;detailtex2.bmp&quot;);
+		smf.detailTexName = &quot;bitmaps/&quot; + smf.detailTexName;
+	}
 }
 
 
 void CMapInfo::ReadSm3()
 {
 	// SM3 specific settings
-	sm3.minimap = mapDefParser-&gt;SGetValueDef(&quot;&quot;, &quot;MAP\\minimap&quot;);
+	sm3.minimap = mapRoot-&gt;GetString(&quot;minimap&quot;, &quot;&quot;);
 }
 
 
 void CMapInfo::ReadTerrainTypes()
 {
-	for (int a = 0; a &lt; 256; ++a) {
+	const LuaTable terrTypeTable =
+		mapRoot-&gt;SubTable(&quot;terrainTypes&quot;);
+
+	for (int tt = 0; tt &lt; 256; tt++) {
+		TerrainType&amp; terrType = terrainTypes[tt];
+		const LuaTable terrain = terrTypeTable.SubTable(tt);
+		terrType.name          = terrain.GetString(&quot;name&quot;, &quot;Default&quot;);
+		terrType.hardness      = terrain.GetFloat(&quot;hardness&quot;,   1.0f);
+		terrType.receiveTracks = terrain.GetFloat(&quot;receiveTracks&quot;, true);
+		const LuaTable moveTable = terrain.SubTable(&quot;moveSpeeds&quot;);
+		terrType.tankSpeed  = moveTable.GetFloat(&quot;tank&quot;,  1.0f);
+		terrType.kbotSpeed  = moveTable.GetFloat(&quot;kbot&quot;,  1.0f);
+		terrType.hoverSpeed = moveTable.GetFloat(&quot;hover&quot;, 1.0f);
+		terrType.shipSpeed  = moveTable.GetFloat(&quot;ship&quot;,  1.0f);
+	}
+}
+
+
+void CMapInfo::ReadStartPos()
+{
+	const float defX = 1000.0f;
+	const float defZ = 1000.0f;
+	const float defStep = 100.0f;
+	for (int t = 0; t &lt; MAX_TEAMS; ++t) {
+		float x, z;
 		char tname[200];
-		sprintf(tname, &quot;MAP\\TerrainType%i\\&quot;, a);
-		std::string section = tname;
-		mapDefParser-&gt;GetDef (terrainTypes[a].name,  &quot;Default&quot;, section + &quot;name&quot;);
-		mapDefParser-&gt;GetTDef(terrainTypes[a].hardness,   1.0f, section + &quot;hardness&quot;);
-		mapDefParser-&gt;GetTDef(terrainTypes[a].tankSpeed,  1.0f, section + &quot;tankmovespeed&quot;);
-		mapDefParser-&gt;GetTDef(terrainTypes[a].kbotSpeed,  1.0f, section + &quot;kbotmovespeed&quot;);
-		mapDefParser-&gt;GetTDef(terrainTypes[a].hoverSpeed, 1.0f, section + &quot;hovermovespeed&quot;);
-		mapDefParser-&gt;GetTDef(terrainTypes[a].shipSpeed,  1.0f, section + &quot;shipmovespeed&quot;);
-		mapDefParser-&gt;GetDef(terrainTypes[a].receiveTracks, &quot;1&quot;, section + &quot;receivetracks&quot;);
+		sprintf(tname, &quot;MAP\\Team%i\\&quot;, t);
+		const string section = tname;
 	}
 }
+
+
+bool CMapInfo::GetStartPos(int team, float3&amp; pos) const
+{
+	if ((team &lt; 0) || (team &gt;= startPos.size()) || !havePos[team]) {
+		return false;
+	}
+	pos = startPos[team];
+	return true;
+}

Modified: trunk/rts/Map/MapInfo.h
===================================================================
--- trunk/rts/Map/MapInfo.h	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Map/MapInfo.h	2008-06-02 02:41:57 UTC (rev 5971)
@@ -2,10 +2,10 @@
 #define MAPINFO_H
 
 #include &lt;string&gt;
+#include &lt;vector&gt;
 #include &quot;float3.h&quot;
 
-class TdfParser;
-class LuaParser;
+class LuaTable;
 
 
 /** Float3 with a fourth data member, which is basically unused but required
@@ -27,16 +27,9 @@
 {
 public:
 
-	static void OpenTDF(const std::string&amp; mapname, TdfParser&amp; parser);
-	static std::string GetTDFName(const std::string&amp; mapname);
-
 	CMapInfo(const std::string&amp; mapname);
 	~CMapInfo();
 
-	/** @brief Get a readonly reference to the TDF parser.
-	    This is needed by SM3 code to load feature and layer data. */
-	const TdfParser&amp; GetMapDefParser() const { return *mapDefParser; }
-
 	/* The settings are just public members because:
 
 	   1) it's quite some work to encapsulate all of them, and
@@ -107,13 +100,12 @@
 		float  groundShadowDensity;
 		float4 unitAmbientColor;
 		float4 unitSunColor;
-		float3 specularSunColor;
 		float  unitShadowDensity;
+		float3 specularSunColor;
 	} light;
 
 	/** settings read from &quot;MAP\WATER&quot; section
 	    prefix their name with &quot;Water&quot; to get the TDF variable */
-	static const int causticTextureCount = 32;
 	struct water_t {
 		float  repeatX; ///&lt; (calculated default is in CBaseWater)
 		float  repeatY; ///&lt; (calculated default is in CBaseWater)
@@ -132,7 +124,7 @@
 		std::string texture;
 		std::string foamTexture;
 		std::string normalTexture;
-		std::string causticTextures[causticTextureCount];
+		std::vector&lt;std::string&gt; causticTextures;
 	} water;
 	bool hasWaterPlane; ///&lt; true if &quot;MAP\WATER\WaterPlaneColor&quot; is set
 
@@ -161,8 +153,13 @@
 	};
 	TerrainType terrainTypes[256];
 
+	bool GetStartPos(int team, float3&amp; pos) const; // FIXME: MapParser duplicate?
+	
 private:
+	std::vector&lt;bool&gt;   havePos;
+	std::vector&lt;float3&gt; startPos;
 
+private:
 	void ReadGlobal();
 	void ReadGui();
 	void ReadAtmosphere();
@@ -171,9 +168,10 @@
 	void ReadSmf();
 	void ReadSm3();
 	void ReadTerrainTypes();
+	void ReadStartPos();
 
-	LuaParser* resourcesParser;
-	TdfParser* mapDefParser;
+	LuaTable* mapRoot; // map       parser root table
+	LuaTable* resRoot; // resources parser root table
 };
 
 extern const CMapInfo* mapInfo;

Added: trunk/rts/Map/MapParser.cpp
===================================================================
--- trunk/rts/Map/MapParser.cpp	                        (rev 0)
+++ trunk/rts/Map/MapParser.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -0,0 +1,134 @@
+#include &quot;StdAfx.h&quot;
+
+#include &lt;string&gt;
+#include &lt;ctype.h&gt;
+using namespace std;
+
+#include &quot;MapParser.h&quot;
+#include &quot;Lua/LuaSyncedRead.h&quot;
+#include &quot;System/FileSystem/FileHandler.h&quot;
+
+
+static bool IsTdfFormat(CFileHandler&amp; fh)
+{
+
+	while (!fh.Eof()) {
+		char c = ' ';
+		fh.Read(&amp;c, 1);
+		if (!isspace(c)) {
+			// TDF files should start with:
+			//   [name] - section header
+			//   /*     - comment
+			//   //     - comment
+			return ((c == '[') || (c == '/'));
+		}
+	}
+	return false;		
+}
+
+
+string MapParser::GetMapConfigName(const string&amp; mapName)
+{
+	if (mapName.length() &lt; 3) {
+		throw runtime_error(&quot;CMapInfo::GetMapConfigName(): mapName '&quot;
+		                         + mapName + &quot;' too short&quot;);
+	}
+
+	const string extension = mapName.substr(mapName.length() - 3);
+
+	if (extension == &quot;sm3&quot;) {
+		return string(&quot;maps/&quot;) + mapName;
+	}
+	else if (extension == &quot;smf&quot;) {
+		return string(&quot;maps/&quot;) +
+		       mapName.substr(0, mapName.find_last_of('.')) + &quot;.smd&quot;;
+	}
+	else {
+		throw runtime_error(&quot;MapParser::GetMapConfigName(): Unknown extension: &quot;
+		                    + extension);
+	}
+}
+
+
+MapParser::MapParser(const string&amp; mapName) : parser(NULL)
+{
+	const string mapConfig = GetMapConfigName(mapName);
+
+	CFileHandler fh(mapConfig, SPRING_VFS_MAP);
+	if (!fh.FileExists()) {
+		throw runtime_error(&quot;MapParser() missing file: &quot; + mapConfig);
+	}
+
+	const bool isTDF =  IsTdfFormat(fh);
+
+	const string configScript = isTDF ? &quot;maphelper/load_tdf_map.lua&quot; : mapConfig;
+	
+	parser = SAFE_NEW LuaParser(configScript,
+															SPRING_VFS_MAP_BASE, SPRING_VFS_MAP_BASE);
+	parser-&gt;GetTable(&quot;Map&quot;);
+	parser-&gt;AddString(&quot;fileName&quot;, mapName);
+	parser-&gt;AddString(&quot;fullName&quot;, &quot;maps/&quot; + mapName);
+	parser-&gt;AddString(&quot;configFile&quot;, mapConfig);
+#ifndef UNITSYNC
+	// this should not be included with unitsync:
+	// 1. avoids linkage with LuaSyncedRead
+	// 2. MapOptions are not valid during unitsync map parsing
+	parser-&gt;AddFunc(&quot;GetMapOptions&quot;, LuaSyncedRead::GetMapOptions);
+#endif
+	parser-&gt;EndTable();
+	parser-&gt;Execute();
+}
+
+
+MapParser::~MapParser()
+{
+	delete parser;
+}
+
+
+bool MapParser::GetStartPos(int team, float3&amp; pos) const
+{
+	if (!parser-&gt;IsValid()) {
+		return false;
+	}
+	const LuaTable teamsTable = parser-&gt;GetRoot().SubTable(&quot;teams&quot;);
+	const LuaTable posTable = teamsTable.SubTable(team).SubTable(&quot;startPos&quot;);
+	if (!posTable.IsValid()) {
+		return false;
+	}
+
+	pos.x = posTable.GetFloat(&quot;x&quot;, pos.x);
+	pos.z = posTable.GetFloat(&quot;z&quot;, pos.z);
+	
+	return true;
+}
+
+
+LuaTable MapParser::GetRoot()
+{
+	if (parser) {
+		return parser-&gt;GetRoot();
+	} else {
+		return LuaTable();
+	}
+}
+
+
+bool MapParser::IsValid() const
+{
+	if (parser) {
+		return parser-&gt;IsValid();
+	} else {
+		return false;
+	}
+}
+
+
+std::string MapParser::GetErrorLog() const
+{
+	if (parser) {
+		return parser-&gt;GetErrorLog();
+	} else {
+		return &quot;could not find file&quot;;
+	}
+}

Added: trunk/rts/Map/MapParser.h
===================================================================
--- trunk/rts/Map/MapParser.h	                        (rev 0)
+++ trunk/rts/Map/MapParser.h	2008-06-02 02:41:57 UTC (rev 5971)
@@ -0,0 +1,31 @@
+#ifndef MAP_PARSER_H
+#define MAP_PARSER_H
+
+#include &lt;string&gt;
+#include &quot;float3.h&quot;
+#include &quot;Lua/LuaParser.h&quot;
+
+
+class MapParser
+{
+	public:
+		static std::string GetMapConfigName(const std::string&amp; mapName);
+
+	public:
+		MapParser(const std::string&amp; mapName);
+		~MapParser();
+
+		LuaParser* GetParser() { return parser; }
+
+		LuaTable GetRoot();
+		bool IsValid() const;
+		std::string GetErrorLog() const;
+
+		bool GetStartPos(int team, float3&amp; pos) const;
+
+	private:
+		LuaParser* parser;
+};
+
+
+#endif // MAP_PARSER_H

Modified: trunk/rts/Map/SM3/Sm3Map.cpp
===================================================================
--- trunk/rts/Map/SM3/Sm3Map.cpp	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Map/SM3/Sm3Map.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -9,6 +9,7 @@
 #include &lt;IL/il.h&gt;
 #include &lt;SDL_types.h&gt;
 #include &quot;Map/MapInfo.h&quot;
+#include &quot;Map/MapParser.h&quot;
 #include &quot;Rendering/ShadowHandler.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;Platform/errorhandler.h&quot;
@@ -23,6 +24,16 @@
 #include &lt;fstream&gt;
 #include &quot;bitops.h&quot;
 
+
+// FIXME - temporary, until the LuaParser change is done
+static const TdfParser&amp; GetMapDefParser()
+{
+	extern std::string stupidGlobalMapname;
+	static TdfParser tdf(MapParser::GetMapConfigName(stupidGlobalMapname));
+	return tdf;
+}
+
+
 CR_BIND_DERIVED(CSm3ReadMap, CReadMap, ())
 
 //CR_REG_METADATA(CSmfReadMap, (
@@ -101,7 +112,7 @@
 		light.directional = false;
 		light.position = mapInfo-&gt;light.sunDir *1000000;
 		lightInfo.staticLights.push_back (light);
-		renderer-&gt;Load (mapInfo-&gt;GetMapDefParser(), &amp;lightInfo, &amp;loadcb);
+		renderer-&gt;Load (GetMapDefParser(), &amp;lightInfo, &amp;loadcb);
 
 		height = width = renderer-&gt;GetHeightmapWidth ()-1;
 
@@ -119,7 +130,7 @@
 
 		CReadMap::Initialize();
 
-		const TdfParser&amp; mapDefParser = mapInfo-&gt;GetMapDefParser();
+		const TdfParser&amp; mapDefParser = GetMapDefParser();
 		if (mapDefParser.SectionExist(&quot;map\\featuretypes&quot;)) {
 			int numTypes = atoi(mapDefParser.SGetValueDef(&quot;0&quot;, &quot;map\\featuretypes\\numtypes&quot;).c_str());
 			for (int a=0;a&lt;numTypes;a++) {
@@ -251,7 +262,7 @@
 void CSm3ReadMap::LoadFeatureData()
 {
 		// returns MapFeatureInfo[GetNumFeatures()]
-	std::string fd = mapInfo-&gt;GetMapDefParser().SGetValueDef(std::string(),&quot;map\\featuredata&quot;);
+	std::string fd = GetMapDefParser().SGetValueDef(std::string(),&quot;map\\featuredata&quot;);
 	if (!fd.empty()) {
 		CFileHandler fh(fd);
 		if (!fh.FileExists())
@@ -312,7 +323,7 @@
 unsigned char *CSm3ReadMap::GetInfoMap (const std::string&amp; name, MapBitmapInfo* bm)
 {
 	std::string map;
-	if (!mapInfo-&gt;GetMapDefParser().SGetValue(map, &quot;MAP\\INFOMAPS\\&quot; + name))
+	if (!GetMapDefParser().SGetValue(map, &quot;MAP\\INFOMAPS\\&quot; + name))
 		return 0;
 
 	CBitmap img;

Modified: trunk/rts/Map/SMF/BFGroundTextures.cpp
===================================================================
--- trunk/rts/Map/SMF/BFGroundTextures.cpp	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Map/SMF/BFGroundTextures.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -29,7 +29,7 @@
 	numBigTexX = gs-&gt;mapx / bigSquareSize;
 	numBigTexY = gs-&gt;mapy / bigSquareSize;
 
-	MapHeader* header = &amp;map-&gt;header;
+	SMFHeader* header = &amp;map-&gt;header;
 	ifs-&gt;Seek(header-&gt;tilesPtr);
 
 	tileSize = header-&gt;tilesize;

Modified: trunk/rts/Map/SMF/SmfReadMap.cpp
===================================================================
--- trunk/rts/Map/SMF/SmfReadMap.cpp	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Map/SMF/SmfReadMap.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -422,7 +422,7 @@
 void CSmfReadMap::ReadGrassMap(void *data)
 {
 	CFileHandler* fh=ifs;
-	fh-&gt;Seek(sizeof(MapHeader));
+	fh-&gt;Seek(sizeof(SMFHeader));
 
 	for(int a=0;a&lt;header.numExtraHeaders;++a){
 		int size;

Modified: trunk/rts/Map/SMF/SmfReadMap.h
===================================================================
--- trunk/rts/Map/SMF/SmfReadMap.h	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Map/SMF/SmfReadMap.h	2008-06-02 02:41:57 UTC (rev 5971)
@@ -33,7 +33,7 @@
 
 	std::string detailTexName;
 	GLuint detailTex;
-	MapHeader header;
+	SMFHeader header;
 	CFileHandler *ifs;
 
 	bool usePBO;

Modified: trunk/rts/Map/SMF/mapfile.h
===================================================================
--- trunk/rts/Map/SMF/mapfile.h	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Map/SMF/mapfile.h	2008-06-02 02:41:57 UTC (rev 5971)
@@ -13,7 +13,7 @@
 properties for the map.
 
 The SMF file is the main file for the map, containing the tilemap and a lot of
-additional data. See MapHeader for details.
+additional data. See SMFHeader for details.
 
 The SMT file, for which the filename is stored in the SMF file, contains the
 tiles used by the map. This file can be shared between different maps. See
@@ -37,7 +37,7 @@
 
 Map file (.smf) layout is like this:
 
-	- MapHeader
+	- SMFHeader
 	- ExtraHeader
 	- ExtraHeader
 	- ...
@@ -45,7 +45,7 @@
 	- Chunk of data pointed to by header or extra headers
 	- ...
 */
-struct MapHeader {
+struct SMFHeader {
 	char magic[16];      ///&lt; &quot;spring map file\0&quot;
 	int version;         ///&lt; Must be 1 for now
 	int mapid;           ///&lt; Sort of a GUID of the file, just set to a random value when writing a map
@@ -68,7 +68,7 @@
 	int numExtraHeaders; ///&lt; Numbers of extra headers following main header
 };
 
-/// Read MapHeader mh from CFileHandler srcptr (endian aware)
+/// Read SMFHeader mh from CFileHandler srcptr (endian aware)
 #define READPTR_MAPHEADER(mh,srcptr)			\
 do {							\
 	unsigned int __tmpdw;				\
@@ -145,7 +145,7 @@
 // Some structures used in the chunks of data later in the file
 
 /**
<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">- at brief</A> The header at offset MapHeader.tilesPtr in the .smf
<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">+ at brief</A> The header at offset SMFHeader.tilesPtr in the .smf
 
 MapTileHeader is followed by numTileFiles file definition where each file
 definition is an int followed by a zero terminated file name. On loading,
@@ -177,7 +177,7 @@
 } while (0)
 
 /**
<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">- at brief</A> The header at offset MapHeader.featurePtr in the .smf
<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">+ at brief</A> The header at offset SMFHeader.featurePtr in the .smf
 
 MapFeatureHeader is followed by numFeatureType zero terminated strings indicating the names
 of the features in the map. Then follow numFeatures MapFeatureStructs.

Modified: trunk/rts/Rendering/Env/BumpWater.cpp
===================================================================
--- trunk/rts/Rendering/Env/BumpWater.cpp	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Rendering/Env/BumpWater.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -28,6 +28,7 @@
 #include &lt;boost/format.hpp&gt;
 
 using std::string;
+using std::vector;
 
 //////////////////////////////////////////////////////////////////////
 // Construction/Destruction
@@ -217,16 +218,18 @@
 	}
 
 
-	foamTexture = LoadTexture( mapInfo-&gt;water.foamTexture );
-	normalTexture = LoadTexture( mapInfo-&gt;water.normalTexture );
-	for (int i = 0; i &lt; CMapInfo::causticTextureCount; i++) {
-		caustTextures[i] = LoadTexture( mapInfo-&gt;water.causticTextures[i] );
-	}
-
+	foamTexture = LoadTexture(mapInfo-&gt;water.foamTexture);
+	normalTexture = LoadTexture(mapInfo-&gt;water.normalTexture);
 	//heightTexture = readmap-&gt;GetShadingTexture();
-	/*
 
-	*/
+	// caustic textures
+	const vector&lt;string&gt;&amp; causticNames = mapInfo-&gt;water.causticTextures;
+	if (causticNames.size() &lt;= 0) {
+		throw content_error(&quot;no caustic textures&quot;);
+	}
+	for (int i = 0; i &lt; (int)causticNames.size(); i++) {
+		caustTextures.push_back(LoadTexture(causticNames[i]));
+	}
 
 	/* DEFINE SOME RUNTIME CONSTANTS (I don't use Uniforms for that, 'cos the glsl compiler can't optimize those!) */
 	string definitions;
@@ -305,8 +308,10 @@
 		glDeleteTextures(1, &amp;refractTexture);
 
 	glDeleteTextures(1, &amp;foamTexture);
-	glDeleteTextures(CMapInfo::causticTextureCount, caustTextures);
 	glDeleteTextures(1, &amp;normalTexture);
+	for (int i = 0; i &lt; (int)caustTextures.size(); i++) {
+		glDeleteTextures(1, &amp;caustTextures[i]);
+	}
 
 	glDeleteShader(waterVP);
 	glDeleteShader(waterFP);
@@ -332,7 +337,7 @@
 	if (refraction&lt;2)
 		glDepthMask(0);
 
-	const int causticTexNum = (gs-&gt;frameNum % CMapInfo::causticTextureCount);
+	const int causticTexNum = (gs-&gt;frameNum % caustTextures.size());
 	glActiveTexture(GL_TEXTURE1); glBindTexture(GL_TEXTURE_2D, readmap-&gt;GetShadingTexture());
 	glActiveTexture(GL_TEXTURE2); glBindTexture(GL_TEXTURE_2D, caustTextures[causticTexNum]);
 	glActiveTexture(GL_TEXTURE3); glBindTexture(GL_TEXTURE_2D, foamTexture);
@@ -341,8 +346,8 @@
 	glActiveTexture(GL_TEXTURE0); glBindTexture(GL_TEXTURE_2D, normalTexture);
 
 	glUseProgram(waterShader);
-	glUniform1f(frameLoc,gs-&gt;frameNum/15000.0f);
-	glUniformf3(eyePosLoc,camera-&gt;pos);
+	glUniform1f(frameLoc, gs-&gt;frameNum / 15000.0f);
+	glUniformf3(eyePosLoc, camera-&gt;pos);
 
 	glBegin(GL_QUADS);
 		glTexCoord4f(0.0f,0.0f,0.0f,0.0f);

Modified: trunk/rts/Rendering/Env/BumpWater.h
===================================================================
--- trunk/rts/Rendering/Env/BumpWater.h	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Rendering/Env/BumpWater.h	2008-06-02 02:41:57 UTC (rev 5971)
@@ -41,8 +41,8 @@
 
 	GLuint foamTexture;
 	GLuint normalTexture;
-	GLuint caustTextures[32];
 	GLuint* heightTexture;
+	std::vector&lt;GLuint&gt; caustTextures;
 
 	GLuint waterFP;
 	GLuint waterVP;

Modified: trunk/rts/Rendering/InMapDraw.cpp
===================================================================
--- trunk/rts/Rendering/InMapDraw.cpp	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Rendering/InMapDraw.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -63,7 +63,9 @@
 ));
 
 
+const float quadScale = 1.0f / (DRAW_QUAD_SIZE * SQUARE_SIZE);
 
+
 CInMapDraw::CInMapDraw(void)
 {
 	keyPressed = false;
@@ -313,18 +315,21 @@
 		return;
 
 	switch (button) {
-	case SDL_BUTTON_LEFT:
-		if (lastLeftClickTime &gt; gu-&gt;gameTime - 0.3f) {
-			PromptLabel(pos);
+		case SDL_BUTTON_LEFT: {
+			if (lastLeftClickTime &gt; gu-&gt;gameTime - 0.3f) {
+				PromptLabel(pos);
+			}
+			lastLeftClickTime = gu-&gt;gameTime;
+			break;
 		}
-		lastLeftClickTime = gu-&gt;gameTime;
-		break;
-	case SDL_BUTTON_RIGHT:
-		ErasePos(pos);
-		break;
-	case SDL_BUTTON_MIDDLE:{
-		CreatePoint(pos, &quot;&quot;);
-		break;}
+		case SDL_BUTTON_RIGHT: {
+			SendErase(pos);
+			break;
+		}
+		case SDL_BUTTON_MIDDLE:{
+			SendPoint(pos, &quot;&quot;);
+			break;
+		}
 	}
 
 	lastPos = pos;
@@ -333,23 +338,23 @@
 
 void CInMapDraw::MouseRelease(int x, int y, int button)
 {
-
 }
 
 
 void CInMapDraw::MouseMove(int x, int y, int dx,int dy, int button)
 {
 	float3 pos = GetMouseMapPos();
-	if (pos.x &lt; 0)
+	if (pos.x &lt; 0) {
 		return;
-
+	}
 	if (mouse-&gt;buttons[SDL_BUTTON_LEFT].pressed &amp;&amp; lastLineTime &lt; gu-&gt;gameTime - 0.05f) {
-		AddLine(pos, lastPos);
+		SendLine(pos, lastPos);
 		lastLineTime = gu-&gt;gameTime;
 		lastPos = pos;
 	}
-	if (mouse-&gt;buttons[SDL_BUTTON_RIGHT].pressed)
-		ErasePos(pos);
+	if (mouse-&gt;buttons[SDL_BUTTON_RIGHT].pressed) {
+		SendErase(pos);
+	}
 
 }
 
@@ -369,6 +374,32 @@
 void CInMapDraw::GotNetMsg(const unsigned char* msg)
 {
 	const int playerID = msg[2];
+
+	switch (msg[3]) {
+		case NET_POINT: {
+			float3 pos(*(short*) &amp;msg[4], 0, *(short*) &amp;msg[6]);
+			const string label = (char*) &amp;msg[8];
+			LocalPoint(pos, label, playerID);
+			break;
+		}
+		case NET_LINE: {
+			float3 pos1(*(short*) &amp;msg[4], 0, *(short*) &amp;msg[6]);
+			float3 pos2(*(short*) &amp;msg[8], 0, *(short*) &amp;msg[10]);
+			LocalLine(pos1, pos2, playerID);
+			break;
+		}
+		case NET_ERASE: {
+			float3 pos(*(short*) &amp;msg[4], 0, *(short*) &amp;msg[6]);
+			LocalErase(pos, playerID);
+			break;
+		}
+	}
+}
+
+
+void CInMapDraw::LocalPoint(const float3&amp; constPos, const std::string&amp; label,
+                            int playerID)
+{
 	if ((playerID &lt; 0) || (playerID &gt;= MAX_PLAYERS)) {
 		return;
 	}
@@ -376,9 +407,10 @@
 	if (sender == NULL) {
 		return;
 	}
-	const int team = sender-&gt;team;
-	const int allyteam = gs-&gt;AllyTeam(team);
-	const bool alliedMsg = (gs-&gt;Ally(gu-&gt;myAllyTeam, allyteam) &amp;&amp; gs-&gt;Ally(allyteam, gu-&gt;myAllyTeam));
+	const int  team      = sender-&gt;team;
+	const int  allyteam  = gs-&gt;AllyTeam(team);
+	const bool alliedMsg = (gs-&gt;Ally(gu-&gt;myAllyTeam, allyteam) &amp;&amp;
+	                        gs-&gt;Ally(allyteam, gu-&gt;myAllyTeam));
 	bool allowed = true;
 
 	if (!gu-&gt;spectating &amp;&amp; (sender-&gt;spectator || !alliedMsg)) {
@@ -389,130 +421,149 @@
 		allowed = false;
 	}
 
-	const float quadScale = 1.0f / (DRAW_QUAD_SIZE * SQUARE_SIZE);
+	float3 pos = constPos;
+	pos.CheckInBounds();
+	pos.y = ground-&gt;GetHeight(pos.x, pos.z) + 2.0f;
 
-	switch (msg[3]) {
-		case NET_POINT: {
-			float3 pos(*(short*) &amp;msg[4], 0, *(short*) &amp;msg[6]);
-			pos.CheckInBounds();
-			pos.y = ground-&gt;GetHeight(pos.x, pos.z) + 2.0f;
+	if (luaUI &amp;&amp; luaUI-&gt;MapDrawCmd(playerID, NET_POINT, &amp;pos, NULL, &amp;label)) {
+		return;
+	}
 
-			const string label = (char*) &amp;msg[8];
-			if (luaUI &amp;&amp; luaUI-&gt;MapDrawCmd(playerID, NET_POINT, &amp;pos, NULL, &amp;label)) {
-				return;
-			}
+	MapPoint point;
+	point.pos = pos;
+	point.color = gs-&gt;Team(team)-&gt;color;
+	point.label = label;
+	point.senderAllyTeam = allyteam;
+	point.senderSpectator = sender-&gt;spectator;
 
-			MapPoint p;
-			p.pos = pos;
-			p.color = gs-&gt;Team(team)-&gt;color;
-			p.label = label;
-			p.senderAllyTeam = allyteam;
-			p.senderSpectator = sender-&gt;spectator;
+	const int quad = int(pos.z * quadScale) * drawQuadsX +
+	                 int(pos.x * quadScale);
+	drawQuads[quad].points.push_back(point);
 
-			const int quad = int(pos.z * quadScale) * drawQuadsX + int(pos.x * quadScale);
-			drawQuads[quad].points.push_back(p);
+	if (allowed || drawAll) {
+		// if we happen to be in drawAll mode, notify us now
+		// even if this message is not intented for our ears
+		logOutput.Print(&quot;%s added point: %s&quot;,
+		                sender-&gt;playerName.c_str(), point.label.c_str());
+		logOutput.SetLastMsgPos(pos);
+		sound-&gt;PlaySample(blippSound);
+		minimap-&gt;AddNotification(pos, float3(1.0f, 1.0f, 1.0f), 1.0f);
+	}
+}
 
-			if (allowed || drawAll) {
-				// if we happen to be in drawAll mode, notify us now
-				// even if this message is not intented for our ears
-				logOutput.Print(&quot;%s added point: %s&quot;, sender-&gt;playerName.c_str(), p.label.c_str());
-				logOutput.SetLastMsgPos(pos);
-				sound-&gt;PlaySample(blippSound);
-				minimap-&gt;AddNotification(pos, float3(1.0f, 1.0f, 1.0f), 1.0f);
-			}
 
-			break;
-		}
+void CInMapDraw::LocalLine(const float3&amp; constPos1, const float3&amp; constPos2,
+                           int playerID)
+{
+	if ((playerID &lt; 0) || (playerID &gt;= MAX_PLAYERS)) {
+		return;
+	}
+	const CPlayer* sender = gs-&gt;players[playerID];
+	if (sender == NULL) {
+		return;
+	}
+	const int  team      = sender-&gt;team;
+	const int  allyteam  = gs-&gt;AllyTeam(team);
+	const bool alliedMsg = (gs-&gt;Ally(gu-&gt;myAllyTeam, allyteam) &amp;&amp;
+	                        gs-&gt;Ally(allyteam, gu-&gt;myAllyTeam));
 
-		case NET_ERASE: {
-			float3 pos(*(short*) &amp;msg[4], 0, *(short*) &amp;msg[6]);
-			pos.CheckInBounds();
-			pos.y = ground-&gt;GetHeight(pos.x, pos.z) + 2.0f;
-			if (luaUI &amp;&amp; luaUI-&gt;MapDrawCmd(playerID, NET_ERASE, &amp;pos, NULL, NULL)) {
-				return;
-			}
+	float3 pos1 = constPos1;
+	float3 pos2 = constPos2;
+	pos1.CheckInBounds();
+	pos2.CheckInBounds();
+	pos1.y = ground-&gt;GetHeight(pos1.x, pos1.z) + 2.0f;
+	pos2.y = ground-&gt;GetHeight(pos2.x, pos2.z) + 2.0f;
 
-			const float radius = 100.0f;
-			const int maxY = drawQuadsY - 1;
-			const int maxX = drawQuadsX - 1;
-			const int yStart = (int) std::max(0,    int((pos.z - radius) * quadScale));
-			const int xStart = (int) std::max(0,    int((pos.x - radius) * quadScale));
-			const int yEnd   = (int) std::min(maxY, int((pos.z + radius) * quadScale));
-			const int xEnd   = (int) std::min(maxX, int((pos.x + radius) * quadScale));
+	if (luaUI &amp;&amp; luaUI-&gt;MapDrawCmd(playerID, NET_LINE, &amp;pos1, &amp;pos2, NULL)) {
+		return;
+	}
 
-			for (int y = yStart; y &lt;= yEnd; ++y) {
-				for (int x = xStart; x &lt;= xEnd; ++x) {
-					DrawQuad* dq = &amp;drawQuads[(y * drawQuadsX) + x];
+	MapLine line;
+	line.pos  = pos1;
+	line.pos2 = pos2;
+	line.color = gs-&gt;Team(team)-&gt;color;
+	line.senderAllyTeam = allyteam;
+	line.senderSpectator = sender-&gt;spectator;
 
-					std::list&lt;MapPoint&gt;::iterator pi;
-					for (pi = dq-&gt;points.begin(); pi != dq-&gt;points.end(); /* none */) {
-						if (pi-&gt;pos.distance2D(pos) &lt; radius) {
-							pi = dq-&gt;points.erase(pi);
-						} else {
-							++pi;
-						}
-					}
-					std::list&lt;MapLine&gt;::iterator li;
-					for (li = dq-&gt;lines.begin(); li != dq-&gt;lines.end(); /* none */) {
-						if (li-&gt;pos.distance2D(pos) &lt; radius) {
-							li = dq-&gt;lines.erase(li);
-						} else {
-							++li;
-						}
-					}
-				}
-			}
+	const int quad = int(pos1.z * quadScale) * drawQuadsX +
+	                 int(pos1.x * quadScale);
+	drawQuads[quad].lines.push_back(line);
+}
 
-			break;
-		}
 
-		case NET_LINE: {
-			float3 pos(*(short*) &amp;msg[4], 0, *(short*) &amp;msg[6]);
-			float3 pos2(*(short*) &amp;msg[8], 0, *(short*) &amp;msg[10]);
-			pos.CheckInBounds();
-			pos2.CheckInBounds();
-			pos.y = ground-&gt;GetHeight(pos.x, pos.z) + 2.0f;
-			pos2.y = ground-&gt;GetHeight(pos2.x, pos2.z) + 2.0f;
+void CInMapDraw::LocalErase(const float3&amp; constPos, int playerID)
+{
+	if ((playerID &lt; 0) || (playerID &gt;= MAX_PLAYERS)) {
+		return;
+	}
+	const CPlayer* sender = gs-&gt;players[playerID];
+	if (sender == NULL) {
+		return;
+	}
+	const int  team      = sender-&gt;team;
+	const int  allyteam  = gs-&gt;AllyTeam(team);
+	const bool alliedMsg = (gs-&gt;Ally(gu-&gt;myAllyTeam, allyteam) &amp;&amp;
+	                        gs-&gt;Ally(allyteam, gu-&gt;myAllyTeam));
 
-			if (luaUI &amp;&amp; luaUI-&gt;MapDrawCmd(playerID, NET_LINE, &amp;pos, &amp;pos2, NULL)) {
-				return;
-			}
+	float3 pos = constPos;
+	pos.CheckInBounds();
+	pos.y = ground-&gt;GetHeight(pos.x, pos.z) + 2.0f;
+	if (luaUI &amp;&amp; luaUI-&gt;MapDrawCmd(playerID, NET_ERASE, &amp;pos, NULL, NULL)) {
+		return;
+	}
 
-			MapLine l;
-			l.pos = pos;
-			l.pos2 = pos2;
-			l.color = gs-&gt;Team(team)-&gt;color;
-			l.senderAllyTeam = allyteam;
-			l.senderSpectator = sender-&gt;spectator;
+	const float radius = 100.0f;
+	const int maxY = drawQuadsY - 1;
+	const int maxX = drawQuadsX - 1;
+	const int yStart = (int) std::max(0,    int((pos.z - radius) * quadScale));
+	const int xStart = (int) std::max(0,    int((pos.x - radius) * quadScale));
+	const int yEnd   = (int) std::min(maxY, int((pos.z + radius) * quadScale));
+	const int xEnd   = (int) std::min(maxX, int((pos.x + radius) * quadScale));
 
-			const int quad = int(pos.z * quadScale) * drawQuadsX + int(pos.x * quadScale);
-			drawQuads[quad].lines.push_back(l);
+	for (int y = yStart; y &lt;= yEnd; ++y) {
+		for (int x = xStart; x &lt;= xEnd; ++x) {
+			DrawQuad* dq = &amp;drawQuads[(y * drawQuadsX) + x];
 
-			break;
+			std::list&lt;MapPoint&gt;::iterator pi;
+			for (pi = dq-&gt;points.begin(); pi != dq-&gt;points.end(); /* none */) {
+				if (pi-&gt;pos.distance2D(pos) &lt; radius) {
+					pi = dq-&gt;points.erase(pi);
+				} else {
+					++pi;
+				}
+			}
+			std::list&lt;MapLine&gt;::iterator li;
+			for (li = dq-&gt;lines.begin(); li != dq-&gt;lines.end(); /* none */) {
+				if (li-&gt;pos.distance2D(pos) &lt; radius) {
+					li = dq-&gt;lines.erase(li);
+				} else {
+					++li;
+				}
+			}
 		}
 	}
 }
 
 
-void CInMapDraw::ErasePos(const float3&amp; pos)
+void CInMapDraw::SendErase(const float3&amp; pos)
 {
 	net-&gt;SendMapErase(gu-&gt;myPlayerNum, (short)pos.x, (short)pos.z);
 }
 
 
-void CInMapDraw::CreatePoint(const float3&amp; pos, std::string label)
+void CInMapDraw::SendPoint(const float3&amp; pos, const std::string&amp; label)
 {
 	net-&gt;SendMapDrawPoint(gu-&gt;myPlayerNum, (short)pos.x, (short)pos.z, label);
 }
 
 
-void CInMapDraw::AddLine(const float3&amp; pos, const float3&amp; pos2)
+void CInMapDraw::SendLine(const float3&amp; pos, const float3&amp; pos2)
 {
 	net-&gt;SendMapDrawLine(gu-&gt;myPlayerNum, (short)pos.x, (short)pos.z, (short)pos2.x, (short)pos2.z);
 }
 
 
-void CInMapDraw::PromptLabel (const float3&amp; pos)
+void CInMapDraw::PromptLabel(const float3&amp; pos)
 {
 	waitingPoint = pos;
 	game-&gt;userWriting = true;

Modified: trunk/rts/Rendering/InMapDraw.h
===================================================================
--- trunk/rts/Rendering/InMapDraw.h	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Rendering/InMapDraw.h	2008-06-02 02:41:57 UTC (rev 5971)
@@ -16,9 +16,10 @@
 public:
 	CInMapDraw(void);
 	~CInMapDraw(void);
-	void Draw(void);
 	void PostLoad();
 
+	void Draw(void);
+
 	void MousePress(int x, int y, int button);
 	void MouseRelease(int x,int y,int button);
 	void MouseMove(int x, int y, int dx, int dy, int button);
@@ -27,8 +28,15 @@
 	void SetAllVisible(bool b) { drawAll = b; }
 
 	float3 GetMouseMapPos(void);
-	void ErasePos(const float3&amp; pos);
 
+	void LocalPoint(const float3&amp; pos, const std::string&amp; label, int playerID);
+	void LocalLine(const float3&amp; pos1, const float3&amp; pos2, int playerID);
+	void LocalErase(const float3&amp; pos, int playerID);
+
+	void SendPoint(const float3&amp; pos, const std::string&amp; label);
+	void SendLine(const float3&amp; pos1, const float3&amp; pos2);
+	void SendErase(const float3&amp; pos);
+
 	bool keyPressed;
 
 	struct MapPoint {
@@ -80,10 +88,9 @@
 	int blippSound;
 	bool drawAll;
 
-	static void InMapDrawVisCallback (int x,int y,void *userData);
-	void CreatePoint(const float3&amp; pos, std::string label);
-	void AddLine(const float3&amp; pos, const float3&amp; pos2);
-	void PromptLabel (const float3&amp; pos);;
+	static void InMapDrawVisCallback(int x, int y, void* userData);
+
+	void PromptLabel(const float3&amp; pos);;
 };
 
 extern CInMapDraw* inMapDrawer;

Modified: trunk/rts/Sim/Features/FeatureHandler.cpp
===================================================================
--- trunk/rts/Sim/Features/FeatureHandler.cpp	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Sim/Features/FeatureHandler.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -395,7 +395,7 @@
 
 	if (feature-&gt;def-&gt;drawType == DRAWTYPE_3DO) {
 		int quad = int(feature-&gt;pos.z / DRAW_QUAD_SIZE / SQUARE_SIZE) * drawQuadsX +
-				   int(feature-&gt;pos.x / DRAW_QUAD_SIZE / SQUARE_SIZE);
+		           int(feature-&gt;pos.x / DRAW_QUAD_SIZE / SQUARE_SIZE);
 		DrawQuad* dq = &amp;drawQuads[quad];
 		dq-&gt;features.insert(feature);
 		feature-&gt;drawQuad = quad;

Modified: trunk/rts/Sim/Misc/DamageArrayHandler.cpp
===================================================================
--- trunk/rts/Sim/Misc/DamageArrayHandler.cpp	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Sim/Misc/DamageArrayHandler.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -1,7 +1,6 @@
 #include &quot;StdAfx.h&quot;
 #include &quot;DamageArrayHandler.h&quot;
 #include &quot;DamageArray.h&quot;
-#include &quot;TdfParser.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Game/Game.h&quot;
 #include &quot;Lua/LuaParser.h&quot;

Modified: trunk/rts/Sim/Projectiles/ProjectileHandler.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/ProjectileHandler.cpp	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Sim/Projectiles/ProjectileHandler.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -207,8 +207,9 @@
 	//for (int i = 0; i &lt; 12; i++) {
 	for (int i = 1; smokeTable.KeyExists(i); i++) {
 		char num[10];
-		sprintf(num, &quot;%02i&quot;, i-1);
+		sprintf(num, &quot;%02i&quot;, i - 1);
 		smoketex[i] = textureAtlas-&gt;GetTexture(std::string(&quot;ismoke&quot;) + num);
+		smokeTex.push_back(textureAtlas-&gt;GetTexture(std::string(&quot;ismoke&quot;) + num));
 	}
 
 #define GETTEX(t, b) textureAtlas-&gt;GetTextureWithBackup((t), (b))

Modified: trunk/rts/Sim/Projectiles/ProjectileHandler.h
===================================================================
--- trunk/rts/Sim/Projectiles/ProjectileHandler.h	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Sim/Projectiles/ProjectileHandler.h	2008-06-02 02:41:57 UTC (rev 5971)
@@ -100,6 +100,7 @@
 	AtlasedTexture smoketrailtex;
 	AtlasedTexture waketex;
 	AtlasedTexture smoketex[12];
+	std::vector&lt;AtlasedTexture&gt; smokeTex;
 	AtlasedTexture perlintex;
 	AtlasedTexture flametex;
 

Modified: trunk/rts/Sim/Units/CommandAI/TransportCAI.cpp
===================================================================
--- trunk/rts/Sim/Units/CommandAI/TransportCAI.cpp	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Sim/Units/CommandAI/TransportCAI.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -424,9 +424,6 @@
 				continue;
 
 			dropSpots.push_front(nextPos);
-			//float3 p = nextPos; //test to make intended land spots visible
-			//inMapDrawer-&gt;CreatePoint(p,ti-&gt;unit-&gt;unitDef-&gt;name);
-			//p.z +=transport-&gt;transportCapacityUsed*5;
 			nextPos += dir*(gap + ti-&gt;unit-&gt;radius);
 			ti++;
 		}

Modified: trunk/rts/Sim/Units/Unit.cpp
===================================================================
--- trunk/rts/Sim/Units/Unit.cpp	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Sim/Units/Unit.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -1125,8 +1125,6 @@
 /******************************************************************************/
 /******************************************************************************/
 
-
-
 void CUnit::AddExperience(float exp)
 {
 	const float oldExp = experience;
@@ -1385,6 +1383,7 @@
 	return r;
 }
 
+
 bool CUnit::AttackGround(const float3 &amp;pos, bool dgun)
 {
 	bool r=false;
@@ -1403,6 +1402,7 @@
 	return r;
 }
 
+
 void CUnit::SetLastAttacker(CUnit* attacker)
 {
 	if(gs-&gt;Ally(team, attacker-&gt;team) || gs-&gt;AlliedTeams(team, attacker-&gt;team)){
@@ -1417,6 +1417,7 @@
 		AddDeathDependence(attacker);
 }
 
+
 void CUnit::DependentDied(CObject* o)
 {
 	if (o == userTarget)   { userTarget   = NULL; }
@@ -1429,6 +1430,7 @@
 	CSolidObject::DependentDied(o);
 }
 
+
 void CUnit::SetUserTarget(CUnit* target)
 {
 	if(userTarget &amp;&amp; lastAttacker!=userTarget)
@@ -1512,6 +1514,7 @@
 	globalAI-&gt;UnitCreated(this); // FIXME -- add builder?
 }
 
+
 void CUnit::UpdateTerrainType()
 {
 	if (curTerrainType != lastTerrainType) {
@@ -1520,6 +1523,7 @@
 	}
 }
 
+
 void CUnit::CalculateTerrainType()
 {
 	//Optimization: there's only about one unit that actually needs this information
@@ -1551,6 +1555,7 @@
 	}
 }
 
+
 bool CUnit::SetGroup(CGroup* newGroup)
 {
 	if (group != 0) {
@@ -1651,6 +1656,7 @@
 	return false;
 }
 
+
 void CUnit::FinishedBuilding(void)
 {
 	beingBuilt = false;
@@ -1719,7 +1725,6 @@
 }
 
 
-
 // Called when a unit's Killed script finishes executing
 static void CUnitKilledCB(int retCode, void* p1, void* p2)
 {
@@ -1728,6 +1733,7 @@
 	self-&gt;delayedWreckLevel = retCode;
 }
 
+
 void CUnit::KillUnit(bool selfDestruct, bool reclaimed, CUnit* attacker, bool showDeathSequence)
 {
 	if (isDead) {
@@ -1814,7 +1820,6 @@
 }
 
 
-
 bool CUnit::UseMetal(float metal)
 {
 	if (metal &lt; 0) {
@@ -1828,6 +1833,7 @@
 	return canUse;
 }
 
+
 void CUnit::AddMetal(float metal)
 {
 	if (metal &lt; 0) {
@@ -1838,6 +1844,7 @@
 	gs-&gt;Team(team)-&gt;AddMetal(metal);
 }
 
+
 bool CUnit::UseEnergy(float energy)
 {
 	if (energy &lt; 0) {
@@ -1851,6 +1858,7 @@
 	return canUse;
 }
 
+
 void CUnit::AddEnergy(float energy)
 {
 	if (energy &lt; 0) {
@@ -1887,6 +1895,7 @@
 	}
 }
 
+
 void CUnit::Deactivate()
 {
 	if (!activated)
@@ -1909,6 +1918,7 @@
 	}
 }
 
+
 void CUnit::PushWind(float x, float z, float strength)
 {
 	if(strength &gt; unitDef-&gt;windGenerator)
@@ -1923,6 +1933,7 @@
 	cob-&gt;Call(COBFN_SetDirection, (int)GetHeadingFromVector(-x, -z));
 }
 
+
 void CUnit::LoadSave(CLoadSaveInterface* file, bool loading)
 {
 	file-&gt;lsShort(heading);
@@ -1942,6 +1953,7 @@
 	commandAI-&gt;LoadSave(file, loading);
 }
 
+
 void CUnit::IncomingMissile(CMissileProjectile* missile)
 {
 	if (unitDef-&gt;canDropFlare) {
@@ -1955,12 +1967,14 @@
 	}
 }
 
+
 void CUnit::TempHoldFire(void)
 {
 	dontFire = true;
 	AttackUnit(0, true);
 }
 
+
 void CUnit::ReleaseTempHoldFire(void)
 {
 	dontFire = false;

Modified: trunk/rts/Sim/Units/UnitDefHandler.h
===================================================================
--- trunk/rts/Sim/Units/UnitDefHandler.h	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/Sim/Units/UnitDefHandler.h	2008-06-02 02:41:57 UTC (rev 5971)
@@ -6,25 +6,19 @@
 #include &lt;map&gt;
 #include &lt;set&gt;
 #include &quot;Sim/MoveTypes/MoveInfo.h&quot;
-#include &quot;TdfParser.h&quot;
 #include &quot;UnitDef.h&quot;
 
-class CUnitDefHandler;
+
 struct WeaponDef;
+
 class LuaTable;
 
 
-#define TA_UNIT     1
-#define SPRING_UNIT 2
-
-
 //this class takes care of all the unit definitions
 class CUnitDefHandler
 {
 public:
-
-
-	UnitDef *unitDefs;
+	UnitDef* unitDefs;
 	int numUnitDefs;
 	std::map&lt;std::string, int&gt; unitID;
 	std::map&lt;int, std::set&lt;int&gt; &gt; decoyMap;

Modified: trunk/rts/System/FileSystem/ArchiveScanner.cpp
===================================================================
--- trunk/rts/System/FileSystem/ArchiveScanner.cpp	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/System/FileSystem/ArchiveScanner.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -615,7 +615,12 @@
 	for (std::map&lt;std::string, ArchiveInfo&gt;::iterator aii = archiveInfo.begin(); aii != archiveInfo.end(); ++aii) {
 		for (std::vector&lt;MapData&gt;::iterator i = aii-&gt;second.mapData.begin(); i != aii-&gt;second.mapData.end(); ++i) {
 			if (mapName == (*i).name) {
-				return GetArchives(aii-&gt;first);
+				ret = GetArchives(aii-&gt;first);
+				const std::string mapHelperPath = GetArchivePath(&quot;maphelper.sdz&quot;);
+				if (!mapHelperPath.empty()) {
+					ret.push_back(mapHelperPath + &quot;maphelper.sdz&quot;);
+				}
+				break;
 			}
 		}
 	}
@@ -669,8 +674,7 @@
 	unsigned int checksum = 0;
 	std::vector&lt;std::string&gt; ars = GetArchives(root);
 
-	for (std::vector&lt;std::string&gt;::iterator i = ars.begin(); i != ars.end(); ++i)
-	{
+	for (std::vector&lt;std::string&gt;::iterator i = ars.begin(); i != ars.end(); ++i) {
 		unsigned tmp = GetArchiveChecksum(*i);
 		logOutput.Print(&quot;mod checksum %s: %u/%d&quot;, i-&gt;c_str(), tmp, (int)tmp);
 		checksum ^= tmp;

Modified: trunk/rts/System/GlobalStuff.cpp
===================================================================
--- trunk/rts/System/GlobalStuff.cpp	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/System/GlobalStuff.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -41,6 +41,7 @@
 
 CR_REG_METADATA(CGlobalSyncedStuff, (
 				CR_MEMBER(randSeed),
+				CR_MEMBER(initRandSeed),
 				CR_MEMBER(frameNum),
 				CR_MEMBER(speedFactor),
 				CR_MEMBER(userSpeedFactor),
@@ -91,44 +92,45 @@
  */
 CGlobalSyncedStuff::CGlobalSyncedStuff()
 {
-	hmapx=256;
-	hmapy=256;
-	randSeed=18655;//li.LowPart;
-	frameNum=0;
-	speedFactor=1;
-	userSpeedFactor=1;
-	paused=false;
-	godMode=false;
-	cheatEnabled=false;
-	noHelperAIs=false;
-	editDefsEnabled=false;
-	tempNum=2;
-	gameMode=0;
-	useLuaGaia=true;
-	gaiaTeamID=-1;
-	gaiaAllyTeamID=-1;
-	useLuaRules=true;
+	hmapx = 256;
+	hmapy = 256;
+	randSeed = 18655; //li.LowPart;
+	initRandSeed = randSeed;
+	frameNum = 0;
+	speedFactor = 1;
+	userSpeedFactor = 1;
+	paused = false;
+	godMode = false;
+	cheatEnabled = false;
+	noHelperAIs = false;
+	editDefsEnabled = false;
+	tempNum = 2;
+	gameMode = 0;
+	useLuaGaia = true;
+	gaiaTeamID = -1;
+	gaiaAllyTeamID = -1;
+	useLuaRules = true;
 	
-	for(int a=0; a &lt; MAX_TEAMS; ++a){
-		teams[a]=SAFE_NEW CTeam();
-		teams[a]-&gt;teamNum=a;
-		team2allyteam[a]=a;
+	for(int a = 0; a &lt; MAX_TEAMS; ++a) {
+		teams[a] = SAFE_NEW CTeam();
+		teams[a]-&gt;teamNum = a;
+		team2allyteam[a] = a;
 	}
-	for(int a=0; a &lt; MAX_PLAYERS; ++a){
-		players[a]=SAFE_NEW CPlayer();
-		players[a]-&gt;team=0;
+	for(int a = 0; a &lt; MAX_PLAYERS; ++a) {
+		players[a] = SAFE_NEW CPlayer();
+		players[a]-&gt;team = 0;
 	}
 
-	for(int a=0; a &lt; MAX_TEAMS; ++a){
-		for(int b=0;b&lt;MAX_TEAMS;++b){
-			allies[a][b]=false;
+	for (int a = 0; a &lt; MAX_TEAMS; ++a) {
+		for (int b = 0; b &lt; MAX_TEAMS; ++b) {
+			allies[a][b] = false;
 		}
-		allies[a][a]=true;
+		allies[a][a] = true;
 	}
 
-	activeTeams=2;
-	activeAllyTeams=2;
-	activePlayers=MAX_PLAYERS;
+	activeTeams = 2;
+	activeAllyTeams = 2;
+	activePlayers = MAX_PLAYERS;
 }
 
 /**
@@ -136,10 +138,12 @@
  */
 CGlobalSyncedStuff::~CGlobalSyncedStuff()
 {
-	for(int a=0;a&lt;MAX_TEAMS;a++)
+	for(int a = 0; a &lt; MAX_TEAMS; a++) {
 		delete teams[a];
-	for(int a=0;a&lt;gs-&gt;activePlayers;a++)
+	}
+	for(int a = 0; a &lt; gs-&gt;activePlayers; a++) {
 		delete players[a];
+	}
 }
 
 /**
@@ -172,10 +176,10 @@
 float3 CGlobalSyncedStuff::randVector()
 {
 	float3 ret;
-	do{
-		ret.x=randFloat()*2-1;
-		ret.y=randFloat()*2-1;
-		ret.z=randFloat()*2-1;
+	do {
+		ret.x = randFloat()*2-1;
+		ret.y = randFloat()*2-1;
+		ret.z = randFloat()*2-1;
 	} while(ret.SqLength()&gt;1);
 
 	return ret;
@@ -183,10 +187,10 @@
 
 int CGlobalSyncedStuff::Player(const std::string&amp; name)
 {
-	for (int i = 0; i &lt; MAX_PLAYERS; ++i)
-	{
-		if (players[i] &amp;&amp; players[i]-&gt;playerName == name)
+	for (int i = 0; i &lt; MAX_PLAYERS; ++i) {
+		if (players[i] &amp;&amp; players[i]-&gt;playerName == name) {
 			return i;
+		}
 	}
 	return -1;
 }
@@ -198,32 +202,32 @@
 {
 	Uint64 randnum;
 	randnum = SDL_GetTicks();
-	usRandSeed=randnum&amp;0xffffffff;
-	modGameTime=0;
-	gameTime=0;
-	lastFrameTime=0;
-	viewSizeX=100;
-	viewSizeY=100;
-	pixelX=0.01f;
-	pixelY=0.01f;
-	aspectRatio=1.0f;
-	myPlayerNum=0;
-	myTeam=1;
-	myAllyTeam=1;
+	usRandSeed = randnum&amp;0xffffffff;
+	modGameTime = 0;
+	gameTime = 0;
+	lastFrameTime = 0;
+	viewSizeX = 100;
+	viewSizeY = 100;
+	pixelX = 0.01f;
+	pixelY = 0.01f;
+	aspectRatio = 1.0f;
+	myPlayerNum = 0;
+	myTeam = 1;
+	myAllyTeam = 1;
 	spectating           = false;
 	spectatingFullView   = false;
 	spectatingFullSelect = false;
-	drawdebug=false;
-	active=true;
-	viewRange=MAX_VIEW_RANGE;
-	timeOffset=0;
-	drawFog=true;
-	compressTextures=false;
-	teamNanospray=false;
-	autoQuit=false;
-	quitTime=0;
+	drawdebug = false;
+	active = true;
+	viewRange = MAX_VIEW_RANGE;
+	timeOffset = 0;
+	drawFog = true;
+	compressTextures = false;
+	teamNanospray = false;
+	autoQuit = false;
+	quitTime = 0;
 #ifdef DIRECT_CONTROL_ALLOWED
-	directControl=0;
+	directControl = 0;
 #endif
 }
 
@@ -264,11 +268,11 @@
 float3 CGlobalUnsyncedStuff::usRandVector()
 {
 	float3 ret;
-	do{
-		ret.x=usRandFloat()*2-1;
-		ret.y=usRandFloat()*2-1;
-		ret.z=usRandFloat()*2-1;
-	} while(ret.SqLength()&gt;1);
+	do {
+		ret.x = usRandFloat() * 2 - 1;
+		ret.y = usRandFloat() * 2 - 1;
+		ret.z = usRandFloat() * 2 - 1;
+	} while (ret.SqLength() &gt; 1);
 
 	return ret;
 }

Modified: trunk/rts/System/GlobalStuff.h
===================================================================
--- trunk/rts/System/GlobalStuff.h	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/System/GlobalStuff.h	2008-06-02 02:41:57 UTC (rev 5971)
@@ -138,14 +138,20 @@
 {
 public:
 	CR_DECLARE(CGlobalSyncedStuff);
-	CGlobalSyncedStuff(); 		//!&lt; Constructor
-	~CGlobalSyncedStuff(); 	//!&lt; Destructor
+	CGlobalSyncedStuff();  //!&lt; Constructor
+	~CGlobalSyncedStuff(); //!&lt; Destructor
 
-	int randInt();			//!&lt; synced random int
-	float randFloat(); 		//!&lt; synced random float
-	float3 randVector(); 		//!&lt; synced random vector
-	void SetRandSeed(unsigned seed) {randSeed = seed; };
+	int    randInt();    //!&lt; synced random int
+	float  randFloat();  //!&lt; synced random float
+	float3 randVector(); //!&lt; synced random vector
 
+	void SetRandSeed(unsigned int seed, bool init = false) {
+		randSeed = seed;
+		if (init) { initRandSeed = randSeed; }
+	}
+	unsigned int GetRandSeed()     const { return randSeed; }
+	unsigned int GetInitRandSeed() const { return initRandSeed; }
+
 	/**
 	 * @brief frame number
 	 *
@@ -408,6 +414,13 @@
 	int randSeed;
 
 	/**
+	* @brief initial random seed
+	*
+	* Holds the synced initial random seed
+	*/
+	int initRandSeed;
+
+	/**
 	 * @brief allies array
 	 *
 	 * Array indicates whether teams are allied,
@@ -441,12 +454,12 @@
 {
 public:
 	CR_DECLARE(CGlobalUnsyncedStuff);
-	CGlobalUnsyncedStuff(); 		//!&lt; Constructor
-	~CGlobalUnsyncedStuff();	 	//!&lt; Destructor
+	CGlobalUnsyncedStuff();  //!&lt; Constructor
+	~CGlobalUnsyncedStuff(); //!&lt; Destructor
 
-	int usRandInt(); 			//!&lt; Unsynced random int
-	float usRandFloat(); 			//!&lt; Unsynced random float
-	float3 usRandVector(); 			//!&lt; Unsynced random vector
+	int    usRandInt();    //!&lt; Unsynced random int
+	float  usRandFloat();  //!&lt; Unsynced random float
+	float3 usRandVector(); //!&lt; Unsynced random vector
 
 	/**
 	 * Does the user want team colored nanospray if the mod allows it?

Modified: trunk/rts/System/Script/LuaFunctions.cpp
===================================================================
--- trunk/rts/System/Script/LuaFunctions.cpp	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/System/Script/LuaFunctions.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -15,7 +15,7 @@
 #include &quot;Game/StartScripts/Script.h&quot;
 #include &quot;Game/UI/EndGameBox.h&quot;
 #include &quot;Lua/LuaCallInHandler.h&quot;
-#include &quot;Map/MapInfo.h&quot;
+#include &quot;Map/MapParser.h&quot;
 #include &quot;Sim/Features/FeatureDef.h&quot;
 #include &quot;Sim/Features/Feature.h&quot;
 #include &quot;Sim/Features/FeatureHandler.h&quot;
@@ -179,6 +179,6 @@
 
 	string MapGetTDFName()
 	{
-		return CMapInfo::GetTDFName(stupidGlobalMapname);
+		return MapParser::GetMapConfigName(stupidGlobalMapname);
 	}
 }

Modified: trunk/rts/System/StdAfx.h
===================================================================
--- trunk/rts/System/StdAfx.h	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/rts/System/StdAfx.h	2008-06-02 02:41:57 UTC (rev 5971)
@@ -73,27 +73,36 @@
 
 /**
  * content_error
- * thrown when content couldn't be found/loaded.
- * any other type of exception will cause a crashreport box appearing (if it is installed).
+ *   thrown when content couldn't be found/loaded.
+ *   any other type of exception will cause a crashreport box appearing
+ *     (if it is installed).
  */
 class content_error : public std::runtime_error
 {
-public:
-	content_error(const std::string&amp; msg) :
-	  std::runtime_error(msg) {}
+	public:
+		content_error(const std::string&amp; msg) : std::runtime_error(msg) {}
 };
 
-static inline void
-StringToLowerInPlace(std::string &amp;s)
+
+static inline void StringToLowerInPlace(std::string &amp;s)
 {
-	std::transform (s.begin(), s.end(), s.begin(), (int (*)(int))tolower);
+	std::transform(s.begin(), s.end(), s.begin(), (int (*)(int))tolower);
 }
 
-static inline std::string
-StringToLower(std::string s)
+
+static inline std::string StringToLower(std::string s)
 {
 	StringToLowerInPlace(s);
 	return s;
 }
 
+
+static inline std::string IntToString(int i, const std::string&amp; format = &quot;%i&quot;)
+{
+	char buf[64];
+	snprintf(buf, sizeof(buf), format.c_str(), i);
+	return std::string(buf);
+}
+
+
 #endif // __STD_AFX_H__

Modified: trunk/tools/unitsync/javabind.cpp
===================================================================
--- trunk/tools/unitsync/javabind.cpp	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/tools/unitsync/javabind.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -9,7 +9,6 @@
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;Platform/FileSystem.h&quot;
 #include &quot;Rendering/Textures/Bitmap.h&quot;
-#include &quot;TdfParser.h&quot;
 
 #include &quot;Syncer.h&quot;
 #include &quot;SyncServer.h&quot;

Modified: trunk/tools/unitsync/setup.py
===================================================================
--- trunk/tools/unitsync/setup.py	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/tools/unitsync/setup.py	2008-06-02 02:41:57 UTC (rev 5971)
@@ -16,9 +16,10 @@
 	'tools/unitsync/Syncer.cpp',
 	'tools/unitsync/SyncServer.cpp',
 	'tools/unitsync/unitsync.cpp',
+	'rts/Lua/LuaParser.cpp',
+	'rts/Map/MapParser.cpp',
 	'rts/Rendering/Textures/Bitmap.cpp',
 	'rts/Rendering/Textures/nv_dds.cpp',
-	'rts/System/TdfParser.cpp',
 	'rts/System/FileSystem/Archive7Zip.cpp',
 	'rts/System/FileSystem/ArchiveBuffered.cpp',
 	'rts/System/FileSystem/ArchiveDir.cpp',

Modified: trunk/tools/unitsync/test/test.cpp
===================================================================
--- trunk/tools/unitsync/test/test.cpp	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/tools/unitsync/test/test.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -10,7 +10,7 @@
 
 g++ -I../../../rts/System test.tmp.cxx ../../../game/unitsync.so
 
-./a.out CastlesSDD.smf ba52.sdd
+./a.out Castles.smf ba621.sd7
 
 exit
 
@@ -167,6 +167,38 @@
     printf(&quot;    [map %3i]   %s\n&quot;, i, mapName.c_str());
   }
 
+  // map archives
+  printf(&quot;  MAP ARCHIVES  (for %s)\n&quot;, map.c_str());
+  const int mapArcCount = GetMapArchiveCount(map.c_str());
+  for (int a = 0; a &lt; mapArcCount; a++) {
+    printf(&quot;      arc %i: %s\n&quot;, a, GetMapArchiveName(a));
+  }
+  
+  // map info
+  printf(&quot;  MAP INFO  (for %s)\n&quot;, map.c_str());
+  MapInfo mi;
+  char auth[256];
+  char desc[256];
+  mi.author = auth;
+  mi.author[0] = 0;
+  mi.description = desc;
+  mi.description[0] = 0;
+  GetMapInfoEx(map.c_str(), &amp;mi, 1);
+  printf(&quot;    author:    '%s'\n&quot;, mi.author);
+  printf(&quot;    desc:      '%s'\n&quot;, mi.description);
+  printf(&quot;    gravity:   %i\n&quot;,   mi.gravity);
+  printf(&quot;    tidal:     %i\n&quot;,   mi.tidalStrength);
+  printf(&quot;    maxMetal:  %f\n&quot;,   mi.maxMetal);
+  printf(&quot;    mexRad:    %i\n&quot;,   mi.extractorRadius);
+  printf(&quot;    minWind:   %i\n&quot;,   mi.minWind);
+  printf(&quot;    maxWind:   %i\n&quot;,   mi.maxWind);
+  printf(&quot;    width:     %i\n&quot;,   mi.width);
+  printf(&quot;    height:    %i\n&quot;,   mi.height);
+  for (int p = 0; p &lt; mi.posCount; p++) {
+    const StartPos&amp; sp = mi.positions[p];
+    printf(&quot;    pos %i:     &lt;%i, %i&gt;\n&quot;, p, sp.x, sp.z);
+  }
+    
   // mod names
   printf(&quot;  MODS\n&quot;);
   const int modCount = GetPrimaryModCount();
@@ -201,6 +233,12 @@
     printf(&quot;    [unit %3i]   %-16s  &lt;%s&gt;\n&quot;, i,
            unitName.c_str(), unitFullName.c_str());
   }
+  printf(&quot;  SIDES\n&quot;);
+  const int sideCount = GetSideCount();
+  for (int i = 0; i &lt; sideCount; i++) {
+    const string sideName= GetSideName(i);
+    printf(&quot;    side %i = '%s'\n&quot;, i, sideName.c_str());
+  }
 
   // LuaAI options
   printf(&quot;  LuaAI\n&quot;);

Modified: trunk/tools/unitsync/unitsync.cpp
===================================================================
--- trunk/tools/unitsync/unitsync.cpp	2008-06-01 20:48:49 UTC (rev 5970)
+++ trunk/tools/unitsync/unitsync.cpp	2008-06-02 02:41:57 UTC (rev 5971)
@@ -8,11 +8,11 @@
 #include &quot;FileSystem/VFSHandler.h&quot;
 #include &quot;Game/GameVersion.h&quot;
 #include &quot;Lua/LuaParser.h&quot;
+#include &quot;Map/MapParser.h&quot;
 #include &quot;Map/SMF/mapfile.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;Platform/FileSystem.h&quot;
 #include &quot;Rendering/Textures/Bitmap.h&quot;
-#include &quot;TdfParser.h&quot;
 
 #include &quot;Syncer.h&quot;
 #include &quot;SyncServer.h&quot;
@@ -411,28 +411,19 @@
 	const string mapName = name;
 	ScopedMapLoader mapLoader(mapName);
 
-	const string extension = mapName.substr(mapName.length() - 3);
-
-	TdfParser parser;
-	string maptdf;
-	if (extension == &quot;smf&quot;) {
-		maptdf = string(&quot;maps/&quot;) + mapName.substr(0, mapName.find_last_of('.')) + &quot;.smd&quot;;
-	} else if(extension == &quot;sm3&quot;) {
-		maptdf = string(&quot;maps/&quot;) + mapName;
-	}
-
 	string err(&quot;&quot;);
 
-	try {
-		parser.LoadFile(maptdf);
-	} catch (const std::exception&amp; e) {
-		err = e.what();
+	MapParser mapParser(mapName);
+	if (!mapParser.IsValid()) {
+		err = mapParser.GetErrorLog();
 	}
+	const LuaTable mapTable = mapParser.GetRoot();
 
 	// Retrieve the map header as well
 	if (err.empty()) {
+		const string extension = mapName.substr(mapName.length() - 3);
 		if (extension == &quot;smf&quot;) {
-			MapHeader mh;
+			SMFHeader mh;
 			string origName = name;
 			mh.mapx = -1;
 			{
@@ -445,18 +436,15 @@
 			outInfo-&gt;height = mh.mapy * SQUARE_SIZE;
 		}
 		else {
-			int w = atoi(parser.SGetValueDef(string(), &quot;map\\gameAreaW&quot;).c_str());
-			int h = atoi(parser.SGetValueDef(string(), &quot;map\\gameAreaH&quot;).c_str());
+			int w = mapTable.GetInt(&quot;gameAreaW&quot;, 0);
+			int h = mapTable.GetInt(&quot;gameAreaW&quot;, 1);
 
 			outInfo-&gt;width  = w * SQUARE_SIZE;
 			outInfo-&gt;height = h * SQUARE_SIZE;
 		}
 
 		// Make sure we found stuff in both the smd and the header
-		if (!parser.SectionExist(&quot;MAP&quot;)) {
-			err = &quot;Could not parse map&quot;;
-		}
-		else if (outInfo-&gt;width &lt;= 0) {
+		if (outInfo-&gt;width &lt;= 0) {
 			err = &quot;Bad map width&quot;;
 		}
 		else if (outInfo-&gt;height &lt;= 0) {
@@ -479,43 +467,35 @@
 		return 0;
 	}
 
-	map&lt;string, string&gt; values = parser.GetAllValues(&quot;MAP&quot;);
+	const string desc = mapTable.GetString(&quot;description&quot;, &quot;&quot;);
+	strncpy(outInfo-&gt;description, desc.c_str(), 254);
 
-	string tmpdesc = values[&quot;description&quot;];
-	if (tmpdesc.length() &gt; 254) {
-		tmpdesc = tmpdesc.substr(0, 254);
-	}
-	strcpy(outInfo-&gt;description, tmpdesc.c_str());
-	outInfo-&gt;tidalStrength = atoi(values[&quot;tidalstrength&quot;].c_str());
-	outInfo-&gt;gravity = atoi(values[&quot;gravity&quot;].c_str());
-	outInfo-&gt;maxMetal = atof(values[&quot;maxmetal&quot;].c_str());
-	outInfo-&gt;extractorRadius = atoi(values[&quot;extractorradius&quot;].c_str());
+	outInfo-&gt;tidalStrength   = mapTable.GetInt(&quot;tidalstrength&quot;, 0);
+	outInfo-&gt;gravity         = mapTable.GetInt(&quot;gravity&quot;, 0);
+	outInfo-&gt;extractorRadius = mapTable.GetInt(&quot;extractorradius&quot;, 0);
+	outInfo-&gt;maxMetal        = mapTable.GetFloat(&quot;maxmetal&quot;, 0.0f);
 
 	if (version &gt;= 1) {
-		strncpy(outInfo-&gt;author, values[&quot;author&quot;].c_str(), 200);
+		const string author = mapTable.GetString(&quot;author&quot;, &quot;&quot;);
+		strncpy(outInfo-&gt;author, author.c_str(), 200);
 	}
 
-	values = parser.GetAllValues(&quot;MAP\\ATMOSPHERE&quot;);
+	const LuaTable atmoTable = mapTable.SubTable(&quot;atmosphere&quot;);
+	outInfo-&gt;minWind = atmoTable.GetInt(&quot;minWind&quot;, 0);
+	outInfo-&gt;maxWind = atmoTable.GetInt(&quot;maxWind&quot;, 0);
 
-	outInfo-&gt;minWind = atoi(values[&quot;minwind&quot;].c_str());
-	outInfo-&gt;maxWind = atoi(values[&quot;maxwind&quot;].c_str());
-
 	// Find the start positions
-	int curPos;
-	for (curPos = 0; curPos &lt; 16; ++curPos) {
-		char buf[50];
-		sprintf(buf, &quot;MAP\\TEAM%d&quot;, curPos);
-		const string section(buf);
-
-		if (!parser.SectionExist(section)) {
-			break;
+	int curTeam;
+	for (curTeam = 0; curTeam &lt; 16; ++curTeam) {
+		float3 pos(-1.0f, -1.0f, -1.0f); // defaults
+		if (!mapParser.GetStartPos(curTeam, pos)) {
+			break; // position could not be parsed
 		}
-
-		parser.GetDef(outInfo-&gt;positions[curPos].x, &quot;-1&quot;, section + &quot;\\StartPosX&quot;);
-		parser.GetDef(outInfo-&gt;positions[curPos].z, &quot;-1&quot;, section + &quot;\\StartPosZ&quot;);
+		outInfo-&gt;positions[curTeam].x = pos.x;
+		outInfo-&gt;positions[curTeam].z = pos.z;
 	}
 
-	outInfo-&gt;posCount = curPos;
+	outInfo-&gt;posCount = curTeam;
 
 	return 1;
 }
@@ -569,14 +549,8 @@
 
 static void* GetMinimapSM3(string mapName, int miplevel)
 {
-	string minimapFile;
-	try {
-		TdfParser tdf(&quot;Maps/&quot; + mapName);
-		minimapFile = tdf.SGetValueDef(string(), &quot;map\\minimap&quot;);
-	} catch (TdfParser::parse_error&amp;) {
-		memset(imgbuf,0,sizeof(imgbuf));
-		return imgbuf;
-	}
+	MapParser mapParser(mapName);
+	const string minimapFile = mapParser.GetRoot().GetString(&quot;minimap&quot;, &quot;&quot;);
 
 	if (minimapFile.empty()) {
 		memset(imgbuf,0,sizeof(imgbuf));
@@ -633,7 +607,7 @@
 	bool done = false;
 	if (in.FileExists()) {
 
-		MapHeader mh;
+		SMFHeader mh;
 		in.Read(&amp;mh, sizeof(mh));
 		in.Seek(mh.minimapPtr + offset);
 		in.Read(buffer, size);
@@ -1243,12 +1217,21 @@
 
 static void ParseOptions(const string&amp; fileName,
                          const string&amp; fileModes,
-                         const string&amp; accessModes)
+                         const string&amp; accessModes,
+                         const string&amp; mapName = &quot;&quot;)
 {
 	options.clear();
 	optionsSet.clear();
 
 	LuaParser luaParser(fileName, fileModes, accessModes);
+	if (!mapName.empty()) {
+		luaParser.GetTable(&quot;Map&quot;);
+		luaParser.AddString(&quot;fileName&quot;, mapName);
+		luaParser.AddString(&quot;fullName&quot;, &quot;maps/&quot; + mapName);
+		luaParser.AddString(&quot;configFile&quot;, MapParser::GetMapConfigName(mapName));
+		luaParser.EndTable();
+	}
+		
 	if (!luaParser.Execute()) {
 		return;
 	}
@@ -1301,7 +1284,7 @@
 
 	ScopedMapLoader mapLoader(name);
 
-	ParseOptions(&quot;MapOptions.lua&quot;, SPRING_VFS_MAP, SPRING_VFS_MAP);
+	ParseOptions(&quot;MapOptions.lua&quot;, SPRING_VFS_MAP, SPRING_VFS_MAP, name);
 
 	return (int)options.size();
 }


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000750.html">[Taspring-linux-commit] r5970 - in trunk: AI/Global/AAI game/AI/AAI
</A></li>
	<LI>Next message: <A HREF="000752.html">[Taspring-linux-commit] r5972 - trunk/installer/sections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#751">[ date ]</a>
              <a href="thread.html#751">[ thread ]</a>
              <a href="subject.html#751">[ subject ]</a>
              <a href="author.html#751">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
