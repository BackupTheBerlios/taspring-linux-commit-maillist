<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r6049 - in trunk/rts: Game Game/Camera	Game/UI Lua Map/SM3/terrain Map/SMF Rendering Rendering/Env	Rendering/UnitModels Sim/Misc Sim/MoveTypes Sim/Projectiles	Sim/Projectiles/Unsynced Sim/Projectiles/WeaponProjectiles	Sim/Units Sim/Units/CommandAI Sim/Units/UnitTypes Sim/Weapons	System System/Platform System/Platform/Linux System/Platform/Win
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-June/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6049%20-%20in%20trunk/rts%3A%20Game%20Game/Camera%0A%09Game/UI%20Lua%20Map/SM3/terrain%20Map/SMF%20Rendering%20Rendering/Env%0A%09Rendering/UnitModels%20Sim/Misc%20Sim/MoveTypes%20Sim/Projectiles%0A%09Sim/Projectiles/Unsynced%20Sim/Projectiles/WeaponProjectiles%0A%09Sim/Units%20Sim/Units/CommandAI%20Sim/Units/UnitTypes%20Sim/Weapons%0A%09System%20System/Platform%20System/Platform/Linux%20System/Platform/Win&In-Reply-To=%3C20080620001143.388644873%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000828.html">
   <LINK REL="Next"  HREF="000830.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r6049 - in trunk/rts: Game Game/Camera	Game/UI Lua Map/SM3/terrain Map/SMF Rendering Rendering/Env	Rendering/UnitModels Sim/Misc Sim/MoveTypes Sim/Projectiles	Sim/Projectiles/Unsynced Sim/Projectiles/WeaponProjectiles	Sim/Units Sim/Units/CommandAI Sim/Units/UnitTypes Sim/Weapons	System System/Platform System/Platform/Linux System/Platform/Win</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6049%20-%20in%20trunk/rts%3A%20Game%20Game/Camera%0A%09Game/UI%20Lua%20Map/SM3/terrain%20Map/SMF%20Rendering%20Rendering/Env%0A%09Rendering/UnitModels%20Sim/Misc%20Sim/MoveTypes%20Sim/Projectiles%0A%09Sim/Projectiles/Unsynced%20Sim/Projectiles/WeaponProjectiles%0A%09Sim/Units%20Sim/Units/CommandAI%20Sim/Units/UnitTypes%20Sim/Weapons%0A%09System%20System/Platform%20System/Platform/Linux%20System/Platform/Win&In-Reply-To=%3C20080620001143.388644873%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r6049 - in trunk/rts: Game Game/Camera	Game/UI Lua Map/SM3/terrain Map/SMF Rendering Rendering/Env	Rendering/UnitModels Sim/Misc Sim/MoveTypes Sim/Projectiles	Sim/Projectiles/Unsynced Sim/Projectiles/WeaponProjectiles	Sim/Units Sim/Units/CommandAI Sim/Units/UnitTypes Sim/Weapons	System System/Platform System/Platform/Linux System/Platform/Win">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Fri Jun 20 02:11:43 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000828.html">[Taspring-linux-commit] r6048 - in trunk: rts/lib	tools/DedicatedServer
</A></li>
        <LI>Next message: <A HREF="000830.html">[Taspring-linux-commit] r6050 - in trunk/rts: Rendering System	System/Platform/Linux
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#829">[ date ]</a>
              <a href="thread.html#829">[ thread ]</a>
              <a href="subject.html#829">[ subject ]</a>
              <a href="author.html#829">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: Auswaschbar
Date: 2008-06-20 02:11:41 +0200 (Fri, 20 Jun 2008)
New Revision: 6049

Added:
   trunk/rts/System/Platform/Win/DataDirLocater.cpp
   trunk/rts/System/Platform/Win/DataDirLocater.h
Modified:
   trunk/rts/Game/Camera.cpp
   trunk/rts/Game/Camera/FPSController.cpp
   trunk/rts/Game/Camera/FreeController.cpp
   trunk/rts/Game/UI/GuiHandler.cpp
   trunk/rts/Game/UI/MiniMap.cpp
   trunk/rts/Game/UI/MouseCursor.cpp
   trunk/rts/Lua/LuaUnitRendering.cpp
   trunk/rts/Map/SM3/terrain/Lightcalc.cpp
   trunk/rts/Map/SM3/terrain/Textures.cpp
   trunk/rts/Map/SMF/BFGroundDrawer.cpp
   trunk/rts/Map/SMF/BFGroundTextures.cpp
   trunk/rts/Rendering/Env/AdvSky.cpp
   trunk/rts/Rendering/Env/AdvTreeGenerator.cpp
   trunk/rts/Rendering/Env/BasicSky.cpp
   trunk/rts/Rendering/GroundDecalHandler.cpp
   trunk/rts/Rendering/IconHandler.cpp
   trunk/rts/Rendering/UnitModels/UnitDrawer.cpp
   trunk/rts/Sim/Misc/LosHandler.cpp
   trunk/rts/Sim/MoveTypes/MoveInfo.cpp
   trunk/rts/Sim/Projectiles/ExplosionGenerator.cpp
   trunk/rts/Sim/Projectiles/Unsynced/GeoThermSmokeProjectile.cpp
   trunk/rts/Sim/Projectiles/Unsynced/MuzzleFlame.cpp
   trunk/rts/Sim/Projectiles/Unsynced/ShieldPartProjectile.cpp
   trunk/rts/Sim/Projectiles/Unsynced/SpherePartProjectile.cpp
   trunk/rts/Sim/Projectiles/WeaponProjectiles/MissileProjectile.cpp
   trunk/rts/Sim/Units/CommandAI/LineDrawer.cpp
   trunk/rts/Sim/Units/Unit.cpp
   trunk/rts/Sim/Units/UnitHandler.cpp
   trunk/rts/Sim/Units/UnitTypes/Builder.cpp
   trunk/rts/Sim/Weapons/WeaponDefHandler.cpp
   trunk/rts/System/FastMath.h
   trunk/rts/System/Platform/FileSystem.cpp
   trunk/rts/System/Platform/FileSystem.h
   trunk/rts/System/Platform/Linux/DataDirLocater.cpp
   trunk/rts/System/Platform/Linux/UnixFileSystemHandler.cpp
   trunk/rts/System/Platform/Win/WinFileSystemHandler.cpp
   trunk/rts/System/Platform/Win/WinFileSystemHandler.h
Log:
* new old filehandler for windows (see forum post)
* fixed ambigious function calls in various files


Modified: trunk/rts/Game/Camera/FPSController.cpp
===================================================================
--- trunk/rts/Game/Camera/FPSController.cpp	2008-06-19 21:59:28 UTC (rev 6048)
+++ trunk/rts/Game/Camera/FPSController.cpp	2008-06-20 00:11:41 UTC (rev 6049)
@@ -5,9 +5,9 @@
 #include &quot;LogOutput.h&quot;
 #include &quot;Map/Ground.h&quot;
 
-using namespace std;
+using std::min;
+using std::max;
 
-
 CFPSController::CFPSController()
 	: oldHeight(300)
 {

Modified: trunk/rts/Game/Camera/FreeController.cpp
===================================================================
--- trunk/rts/Game/Camera/FreeController.cpp	2008-06-19 21:59:28 UTC (rev 6048)
+++ trunk/rts/Game/Camera/FreeController.cpp	2008-06-20 00:11:41 UTC (rev 6049)
@@ -7,7 +7,8 @@
 #include &quot;LogOutput.h&quot;
 #include &quot;Map/Ground.h&quot;
 
-using namespace std;
+using std::max;
+using std::min;
 extern Uint8 *keys;
 
 /******************************************************************************/
@@ -32,9 +33,9 @@
 	dir = float3(0.0f, -2.0f, -1.0f);
 	dir.Normalize();
 	if (camera) {
-		const float hDist = sqrtf((dir.x * dir.x) + (dir.z * dir.z));
-		camera-&gt;rot.y = atan2f(dir.x, dir.z);
-		camera-&gt;rot.x = atan2f(dir.y, hDist);
+		const float hDist = sqrt((dir.x * dir.x) + (dir.z * dir.z));
+		camera-&gt;rot.y = atan2(dir.x, dir.z);
+		camera-&gt;rot.x = atan2(dir.y, hDist);
 	}
 	pos -= (dir * 1000.0f);
 
@@ -76,7 +77,7 @@
 	camera-&gt;rot.y = rads;
 
 	const float len2D = diff.Length2D();
-	if (fabsf(len2D) &lt;= 0.001f) {
+	if (fabs(len2D) &lt;= 0.001f) {
 		camera-&gt;rot.x = 0.0f;
 	} else {
 		camera-&gt;rot.x = atan2((trackPos.y - pos.y), len2D);
@@ -233,7 +234,7 @@
 		if (pos.y &lt; minHeight) {
 			pos.y = minHeight;
 			if (gndLock) {
-				vel.y = min(fabsf(scrollSpeed), ((minHeight - prevPos.y) / ft));
+				vel.y = min(fabs(scrollSpeed), ((minHeight - prevPos.y) / ft));
 			} else {
 				vel.y = 0.0f;
 			}
@@ -347,7 +348,7 @@
 	if ((yDiff * dir.y) &gt;= 0.0f) {
 		pos = float3(newPos.x, h, newPos.z);
 	} else {
-		pos = target - (dir * fabsf(yDiff / dir.y));
+		pos = target - (dir * fabs(yDiff / dir.y));
 	} // FIXME
 /*
 	const float oldPosY = pos.y;

Modified: trunk/rts/Game/Camera.cpp
===================================================================
--- trunk/rts/Game/Camera.cpp	2008-06-19 21:59:28 UTC (rev 6048)
+++ trunk/rts/Game/Camera.cpp	2008-06-20 00:11:41 UTC (rev 6049)
@@ -132,7 +132,7 @@
 	up.Normalize();
 
 	const float aspect = (float) gu-&gt;viewSizeX / (float) gu-&gt;viewSizeY;
-	const float viewx = tanf(aspect * halfFov);
+	const float viewx = tan(aspect * halfFov);
 	// const float viewx = aspect * tanHalfFov;
 	const float viewy = tanHalfFov;
 
@@ -273,9 +273,9 @@
 
 void CCamera::UpdateForward()
 {
-	forward.z = cosf(rot.y) * cosf(rot.x);
-	forward.x = sinf(rot.y) * cosf(rot.x);
-	forward.y = sinf(rot.x);
+	forward.z = cos(rot.y) * cos(rot.x);
+	forward.x = sin(rot.y) * cos(rot.x);
+	forward.y = sin(rot.x);
 	forward.Normalize();
 }
 
@@ -357,5 +357,5 @@
 {
 	fov = myfov;
 	halfFov = fov * 0.008726646f;
-	tanHalfFov = tanf(halfFov);
+	tanHalfFov = tan(halfFov);
 }

Modified: trunk/rts/Game/UI/GuiHandler.cpp
===================================================================
--- trunk/rts/Game/UI/GuiHandler.cpp	2008-06-19 21:59:28 UTC (rev 6048)
+++ trunk/rts/Game/UI/GuiHandler.cpp	2008-06-20 00:11:41 UTC (rev 6049)
@@ -3807,7 +3807,7 @@
 	const float groundLevel = ground-&gt;GetHeight(camera-&gt;pos.x, camera-&gt;pos.z);
 
 	static float spinTime = 0.0f;
-	spinTime = fmodf(spinTime + gu-&gt;lastFrameTime, 60.0f);
+	spinTime = fmod(spinTime + gu-&gt;lastFrameTime, 60.0f);
 
 	glPushMatrix();
 	glTranslatef(camera-&gt;pos.x, groundLevel, camera-&gt;pos.z);

Modified: trunk/rts/Game/UI/MiniMap.cpp
===================================================================
--- trunk/rts/Game/UI/MiniMap.cpp	2008-06-19 21:59:28 UTC (rev 6048)
+++ trunk/rts/Game/UI/MiniMap.cpp	2008-06-20 00:11:41 UTC (rev 6049)
@@ -586,12 +586,12 @@
 	const float h = float(height);
 	const float mapx = float(gs-&gt;mapx * SQUARE_SIZE);
 	const float mapy = float(gs-&gt;mapy * SQUARE_SIZE);
-	const float ref  = unitBaseSize / powf((200.f * 200.0f), unitExponent);
-	const float dpr  = ref * powf((w * h), unitExponent);
+	const float ref  = unitBaseSize / pow((200.f * 200.0f), unitExponent);
+	const float dpr  = ref * pow((w * h), unitExponent);
 
 	unitSizeX = dpr * (mapx / w);
 	unitSizeY = dpr * (mapy / h);
-	unitSelectRadius = sqrtf(unitSizeX * unitSizeY);
+	unitSelectRadius = sqrt(unitSizeX * unitSizeY);
 
 	// in mouse coordinates
 	mapBox.xmin = xpos;

Modified: trunk/rts/Game/UI/MouseCursor.cpp
===================================================================
--- trunk/rts/Game/UI/MouseCursor.cpp	2008-06-19 21:59:28 UTC (rev 6048)
+++ trunk/rts/Game/UI/MouseCursor.cpp	2008-06-20 00:11:41 UTC (rev 6049)
@@ -344,7 +344,7 @@
 		return;
 	}
 
-	animTime = fmodf(animTime + gu-&gt;lastFrameTime, animPeriod);
+	animTime = fmod(animTime + gu-&gt;lastFrameTime, animPeriod);
 
 	if (animTime &lt; frames[currentFrame].startTime) {
 		currentFrame = 0;

Modified: trunk/rts/Lua/LuaUnitRendering.cpp
===================================================================
--- trunk/rts/Lua/LuaUnitRendering.cpp	2008-06-19 21:59:28 UTC (rev 6048)
+++ trunk/rts/Lua/LuaUnitRendering.cpp	2008-06-20 00:11:41 UTC (rev 6049)
@@ -24,7 +24,8 @@
 #include &quot;Sim/Units/UnitDefHandler.h&quot;
 #include &quot;LogOutput.h&quot;
 
-using namespace std;
+using std::min;
+using std::max;
 
 static void CreateMatRefMetatable(lua_State* L);
 
@@ -136,7 +137,7 @@
 		return 0;
 	}
 	// adjusted for 45 degree FOV with a 1024x768 screen
-	const float scale = 2.0f * (float)tanf((45.0 * 0.5) * (PI / 180.0)) / 768.0f;
+	const float scale = 2.0f * (float)tan((45.0 * 0.5) * (PI / 180.0)) / 768.0f;
 	const float dist = (float)luaL_checknumber(L, 3);
 	unit-&gt;lodLengths[lod] = dist * scale;
 	return 0;

Modified: trunk/rts/Map/SM3/terrain/Lightcalc.cpp
===================================================================
--- trunk/rts/Map/SM3/terrain/Lightcalc.cpp	2008-06-19 21:59:28 UTC (rev 6048)
+++ trunk/rts/Map/SM3/terrain/Lightcalc.cpp	2008-06-20 00:11:41 UTC (rev 6049)
@@ -40,7 +40,7 @@
 
 namespace terrain {
 
-using namespace std;
+using std::min;
 
 void BlurGrayscaleImage(int w, int h, uchar *data)
 {
@@ -217,7 +217,7 @@
 					continue;
 			}
 
-			float len = sqrtf(dx*dx+dy*dy);
+			float len = sqrt(dx*dx+dy*dy);
 			const float step = 5.0f;
 			float invLength2d = step/len;
 			dx *= invLength2d;

Modified: trunk/rts/Map/SM3/terrain/Textures.cpp
===================================================================
--- trunk/rts/Map/SM3/terrain/Textures.cpp	2008-06-19 21:59:28 UTC (rev 6048)
+++ trunk/rts/Map/SM3/terrain/Textures.cpp	2008-06-20 00:11:41 UTC (rev 6049)
@@ -40,7 +40,6 @@
 #include &quot;Rendering/Textures/Bitmap.h&quot;
 #include &quot;Platform/FileSystem.h&quot;
 
-using namespace std;
 
 namespace terrain {
 
@@ -272,7 +271,7 @@
 				}
 
 				// flatness=dotproduct of surface normal with up vector
-				float slope = 1.0f - fabsf (norm_y);
+				float slope = 1.0f - fabs(norm_y);
 
 				if (slope &lt; gi-&gt;minSlope - gi-&gt;minSlopeFuzzy) {
 					bm-&gt;at (x,y) = 0.0f;
@@ -331,7 +330,7 @@
 				Vector3 n;
 
 				if (sx*sx + sy*sy &lt; 32*32) {
-					int sz = (int)sqrtf(32 * 32 - sx*sx - sy*sy);
+					int sz = (int)sqrt(static_cast&lt;float&gt;(32 * 32 - sx*sx - sy*sy));
 					n = Vector3(sx,sy,sz);
 					n.Normalize ();
 				}

Modified: trunk/rts/Map/SMF/BFGroundDrawer.cpp
===================================================================
--- trunk/rts/Map/SMF/BFGroundDrawer.cpp	2008-06-19 21:59:28 UTC (rev 6048)
+++ trunk/rts/Map/SMF/BFGroundDrawer.cpp	2008-06-20 00:11:41 UTC (rev 6049)
@@ -121,7 +121,7 @@
 	const int minz = bty * bigTexH;
 	const int maxz = minz + bigTexH;
 	const float miny = readmap-&gt;minheight;
-	const float maxy = fabsf(cam2-&gt;pos.y); // ??
+	const float maxy = fabs(cam2-&gt;pos.y); // ??
 
 	const float3 mins(minx, miny, minz);
 	const float3 maxs(maxx, maxy, maxz);

Modified: trunk/rts/Map/SMF/BFGroundTextures.cpp
===================================================================
--- trunk/rts/Map/SMF/BFGroundTextures.cpp	2008-06-19 21:59:28 UTC (rev 6048)
+++ trunk/rts/Map/SMF/BFGroundTextures.cpp	2008-06-20 00:11:41 UTC (rev 6049)
@@ -11,7 +11,8 @@
 #include &quot;mmgr.h&quot;
 #include &quot;FastMath.h&quot;
 
-using namespace std;
+using std::string;
+using std::max;
 
 CBFGroundTextures::CBFGroundTextures(CSmfReadMap* rm)
 {

Modified: trunk/rts/Rendering/Env/AdvSky.cpp
===================================================================
--- trunk/rts/Rendering/Env/AdvSky.cpp	2008-06-19 21:59:28 UTC (rev 6048)
+++ trunk/rts/Rendering/Env/AdvSky.cpp	2008-06-20 00:11:41 UTC (rev 6049)
@@ -25,7 +25,8 @@
 
 //static unsigned int cdtex;
 
-using namespace std;
+using std::max;
+using std::min;
 
 CAdvSky::CAdvSky()
 {

Modified: trunk/rts/Rendering/Env/AdvTreeGenerator.cpp
===================================================================
--- trunk/rts/Rendering/Env/AdvTreeGenerator.cpp	2008-06-19 21:59:28 UTC (rev 6048)
+++ trunk/rts/Rendering/Env/AdvTreeGenerator.cpp	2008-06-20 00:11:41 UTC (rev 6049)
@@ -16,7 +16,8 @@
 #include &quot;System/FileSystem/FileHandler.h&quot;
 #include &quot;mmgr.h&quot;
 
-using namespace std;
+using std::max;
+using std::min;
 
 //////////////////////////////////////////////////////////////////////
 // Construction/Destruction

Modified: trunk/rts/Rendering/Env/BasicSky.cpp
===================================================================
--- trunk/rts/Rendering/Env/BasicSky.cpp	2008-06-19 21:59:28 UTC (rev 6048)
+++ trunk/rts/Rendering/Env/BasicSky.cpp	2008-06-20 00:11:41 UTC (rev 6049)
@@ -31,8 +31,6 @@
 #define CLOUD_DETAIL 6
 #define CLOUD_SIZE 256
 
-using namespace std;
-
 CBasicSky::CBasicSky()
 {
 	PrintLoadMsg(&quot;Creating sky&quot;);

Modified: trunk/rts/Rendering/GroundDecalHandler.cpp
===================================================================
--- trunk/rts/Rendering/GroundDecalHandler.cpp	2008-06-19 21:59:28 UTC (rev 6048)
+++ trunk/rts/Rendering/GroundDecalHandler.cpp	2008-06-20 00:11:41 UTC (rev 6049)
@@ -20,9 +20,10 @@
 #include &quot;System/FileSystem/FileHandler.h&quot;
 #include &quot;mmgr.h&quot;
 
-using namespace std;
+using std::list;
+using std::min;
+using std::max;
 
-
 CGroundDecalHandler* groundDecals = NULL;
 
 

Modified: trunk/rts/Rendering/IconHandler.cpp
===================================================================
--- trunk/rts/Rendering/IconHandler.cpp	2008-06-19 21:59:28 UTC (rev 6048)
+++ trunk/rts/Rendering/IconHandler.cpp	2008-06-20 00:11:41 UTC (rev 6049)
@@ -172,7 +172,7 @@
 			const int index = ((y * 128) + x) * 4;
 			const int dx = (x - 64);
 			const int dy = (y - 64);
-			const float r = sqrtf((dx * dx) + (dy * dy)) / 64.0f;
+			const float r = std::sqrt((dx * dx) + (dy * dy)) / 64.0f;
 			if (r &gt; 1.0f) {
 				si[index + 0] = 0;
 				si[index + 1] = 0;

Modified: trunk/rts/Rendering/UnitModels/UnitDrawer.cpp
===================================================================
--- trunk/rts/Rendering/UnitModels/UnitDrawer.cpp	2008-06-19 21:59:28 UTC (rev 6048)
+++ trunk/rts/Rendering/UnitModels/UnitDrawer.cpp	2008-06-20 00:11:41 UTC (rev 6049)
@@ -1535,7 +1535,7 @@
 			if (dot &lt; 0)
 				dot = 0;
 
-			float exp = std::min(1.f, powf(dot, exponent) + powf(dot, 3) * 0.25f);
+			float exp = std::min(1.f, pow(dot, exponent) + pow(dot, 3) * 0.25f);
 			buf[(y * size + x) * 4 + 0] = (unsigned char) (suncolor.x * exp * 255);
 			buf[(y * size + x) * 4 + 1] = (unsigned char) (suncolor.y * exp * 255);
 			buf[(y * size + x) * 4 + 2] = (unsigned char) (suncolor.z * exp * 255);

Modified: trunk/rts/Sim/Misc/LosHandler.cpp
===================================================================
--- trunk/rts/Sim/Misc/LosHandler.cpp	2008-06-19 21:59:28 UTC (rev 6048)
+++ trunk/rts/Sim/Misc/LosHandler.cpp	2008-06-20 00:11:41 UTC (rev 6049)
@@ -16,6 +16,9 @@
 #include &quot;creg/STL_List.h&quot;
 #include &quot;mmgr.h&quot;
 
+using std::min;
+using std::max;
+
 CR_BIND(LosInstance, );
 CR_BIND(CLosHandler, );
 CR_BIND(CLosHandler::DelayedInstance, );
@@ -81,9 +84,7 @@
 // Construction/Destruction
 //////////////////////////////////////////////////////////////////////
 
-using namespace std;
 
-
 CLosHandler* loshandler;
 
 

Modified: trunk/rts/Sim/MoveTypes/MoveInfo.cpp
===================================================================
--- trunk/rts/Sim/MoveTypes/MoveInfo.cpp	2008-06-19 21:59:28 UTC (rev 6048)
+++ trunk/rts/Sim/MoveTypes/MoveInfo.cpp	2008-06-20 00:11:41 UTC (rev 6049)
@@ -12,6 +12,9 @@
 #include &quot;creg/STL_Map.h&quot;
 #include &quot;mmgr.h&quot;
 
+using std::min;
+using std::max;
+
 CR_BIND(MoveData, );
 CR_BIND(CMoveInfo, );
 
@@ -43,9 +46,7 @@
 
 
 CMoveInfo* moveinfo;
-using namespace std;
 
-
 static float DegreesToMaxSlope(float degrees)
 {
 	return (float)(1.0 - cos(degrees * 1.5f * PI / 180.0f));

Modified: trunk/rts/Sim/Projectiles/ExplosionGenerator.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/ExplosionGenerator.cpp	2008-06-19 21:59:28 UTC (rev 6048)
+++ trunk/rts/Sim/Projectiles/ExplosionGenerator.cpp	2008-06-20 00:11:41 UTC (rev 6049)
@@ -23,7 +23,8 @@
 #include &quot;Sim/Projectiles/Unsynced/WreckProjectile.h&quot;
 #include &quot;mmgr.h&quot;
 
-using namespace std;
+using std::min;
+using std::max;
 
 CR_BIND_DERIVED_INTERFACE(CExpGenSpawnable, CWorldObject);
 
@@ -721,7 +722,7 @@
 void CCustomExplosionGenerator::OutputProjectileClassInfo()
 {
 	const vector&lt;creg::Class*&gt;&amp; classes = creg::System::GetClasses();
-	ofstream fs(&quot;projectiles.txt&quot;);
+	std::ofstream fs(&quot;projectiles.txt&quot;);
 	CExplosionGeneratorHandler egh;
 
 	if (fs.bad() || !fs.is_open())
@@ -733,7 +734,7 @@
 			continue;
 
 		creg::Class *klass = *ci;
-		fs &lt;&lt; &quot;Class: &quot; &lt;&lt; klass-&gt;name &lt;&lt; &quot;.  Scriptname: &quot; &lt;&lt; egh.projectileClasses.FindAlias(klass-&gt;name) &lt;&lt; endl;
+		fs &lt;&lt; &quot;Class: &quot; &lt;&lt; klass-&gt;name &lt;&lt; &quot;.  Scriptname: &quot; &lt;&lt; egh.projectileClasses.FindAlias(klass-&gt;name) &lt;&lt; std::endl;
 		for (;klass;klass=klass-&gt;base) {
 			for (unsigned int a=0;a&lt;klass-&gt;members.size();a++)
 			{

Modified: trunk/rts/Sim/Projectiles/Unsynced/GeoThermSmokeProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/Unsynced/GeoThermSmokeProjectile.cpp	2008-06-19 21:59:28 UTC (rev 6048)
+++ trunk/rts/Sim/Projectiles/Unsynced/GeoThermSmokeProjectile.cpp	2008-06-20 00:11:41 UTC (rev 6049)
@@ -25,7 +25,7 @@
 		float sql = d.SqLength();
 		if (sql &gt; 0.0f &amp;&amp; sql &lt; o-&gt;radius*o-&gt;radius &amp;&amp; o-&gt;blocking)
 		{
-			d *= o-&gt;radius / sqrtf(sql);
+			d *= o-&gt;radius / sqrt(sql);
 			pos = pos * 0.3f + (o-&gt;pos + d) * 0.7f;
 
 			if(d.y &lt; o-&gt;radius*0.4f)

Modified: trunk/rts/Sim/Projectiles/Unsynced/MuzzleFlame.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/Unsynced/MuzzleFlame.cpp	2008-06-19 21:59:28 UTC (rev 6048)
+++ trunk/rts/Sim/Projectiles/Unsynced/MuzzleFlame.cpp	2008-06-20 00:11:41 UTC (rev 6049)
@@ -64,7 +64,7 @@
 	inArray=true;
 	unsigned char col[4];
 	float alpha=std::max(0.f,1-age/(4+size*30));
-	float modAge=sqrtf(age+2);
+	float modAge=sqrt(static_cast&lt;float&gt;(age+2));
 
 	for (int a = 0; a &lt; numSmoke; ++a) {
 		int tex = a % ph-&gt;smoketex.size();

Modified: trunk/rts/Sim/Projectiles/Unsynced/ShieldPartProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/Unsynced/ShieldPartProjectile.cpp	2008-06-19 21:59:28 UTC (rev 6048)
+++ trunk/rts/Sim/Projectiles/Unsynced/ShieldPartProjectile.cpp	2008-06-20 00:11:41 UTC (rev 6049)
@@ -6,8 +6,6 @@
 #include &quot;Rendering/Textures/TextureAtlas.h&quot;
 #include &quot;mmgr.h&quot;
 
-using namespace std;
-
 CR_BIND_DERIVED(CShieldPartProjectile, CProjectile, (float3(0,0,0),0,0,0,float3(0,0,0),0,NULL,NULL));
 
 CR_REG_METADATA(CShieldPartProjectile,(

Modified: trunk/rts/Sim/Projectiles/Unsynced/SpherePartProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/Unsynced/SpherePartProjectile.cpp	2008-06-19 21:59:28 UTC (rev 6048)
+++ trunk/rts/Sim/Projectiles/Unsynced/SpherePartProjectile.cpp	2008-06-20 00:11:41 UTC (rev 6049)
@@ -5,8 +5,9 @@
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;SpherePartProjectile.h&quot;
 #include &quot;mmgr.h&quot;
-using namespace std;
 
+using std::min;
+
 CR_BIND_DERIVED(CSpherePartProjectile, CProjectile, (float3(0,0,0),0,0,0.0,0.0,0,NULL,float3(0,0,0)));
 
 CR_REG_METADATA(CSpherePartProjectile,(

Modified: trunk/rts/Sim/Projectiles/WeaponProjectiles/MissileProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/WeaponProjectiles/MissileProjectile.cpp	2008-06-19 21:59:28 UTC (rev 6048)
+++ trunk/rts/Sim/Projectiles/WeaponProjectiles/MissileProjectile.cpp	2008-06-20 00:11:41 UTC (rev 6049)
@@ -244,8 +244,8 @@
 				// is too close or height difference too large)
 				const float horDiff = (targPos - pos).Length2D() + 0.01f;
 				const float verDiff = (targPos.y - pos.y) + 0.01f;
-				const float dirDiff = fabsf(targetDir.y - dir.y);
-				const float ratio = fabsf(verDiff / horDiff);
+				const float dirDiff = fabs(targetDir.y - dir.y);
+				const float ratio = fabs(verDiff / horDiff);
 				dir.y -= (dirDiff * ratio);
 			} else {
 				// missile is still ascending

Modified: trunk/rts/Sim/Units/CommandAI/LineDrawer.cpp
===================================================================
--- trunk/rts/Sim/Units/CommandAI/LineDrawer.cpp	2008-06-19 21:59:28 UTC (rev 6048)
+++ trunk/rts/Sim/Units/CommandAI/LineDrawer.cpp	2008-06-20 00:11:41 UTC (rev 6049)
@@ -14,7 +14,7 @@
 void CLineDrawer::UpdateLineStipple()
 {
 	stippleTimer += (gu-&gt;lastFrameTime * cmdColors.StippleSpeed());
-	stippleTimer = fmodf(stippleTimer, (16.0f / 20.0f));
+	stippleTimer = fmod(stippleTimer, (16.0f / 20.0f));
 }
 
 

Modified: trunk/rts/Sim/Units/Unit.cpp
===================================================================
--- trunk/rts/Sim/Units/Unit.cpp	2008-06-19 21:59:28 UTC (rev 6048)
+++ trunk/rts/Sim/Units/Unit.cpp	2008-06-20 00:11:41 UTC (rev 6049)
@@ -508,7 +508,7 @@
 
 	if (travelPeriod != 0.0f) {
 		travel += speed.Length();
-		travel = fmodf(travel, travelPeriod);
+		travel = fmod(travel, travelPeriod);
 	}
 
 	recentDamage *= 0.9f;

Modified: trunk/rts/Sim/Units/UnitHandler.cpp
===================================================================
--- trunk/rts/Sim/Units/UnitHandler.cpp	2008-06-19 21:59:28 UTC (rev 6048)
+++ trunk/rts/Sim/Units/UnitHandler.cpp	2008-06-20 00:11:41 UTC (rev 6049)
@@ -36,6 +36,9 @@
 #include &quot;Sim/Misc/GroundBlockingObjectMap.h&quot;
 #include &quot;mmgr.h&quot;
 
+using std::min;
+using std::max;
+
 BuildInfo::BuildInfo(const std::string&amp; name, const float3&amp; p, int facing)
 {
 	def = unitDefHandler-&gt;GetUnitByName(name);
@@ -77,7 +80,6 @@
 //////////////////////////////////////////////////////////////////////
 
 CUnitHandler* uh;
-using namespace std;
 
 CR_BIND(CUnitHandler, (true));
 CR_REG_METADATA(CUnitHandler, (
@@ -165,7 +167,7 @@
 
 CUnitHandler::~CUnitHandler()
 {
-	list&lt;CUnit*&gt;::iterator usi;
+	std::list&lt;CUnit*&gt;::iterator usi;
 	for (usi = activeUnits.begin(); usi != activeUnits.end(); usi++) {
 		delete (*usi);
 	}
@@ -269,7 +271,7 @@
 
 	if (!(gs-&gt;frameNum &amp; 15)) {
 		if (diminishingMetalMakers)
-			metalMakerEfficiency = 8.0f / (8.0f + max(0.0f, sqrtf(metalMakerIncome / gs-&gt;activeTeams) - 4));
+			metalMakerEfficiency = 8.0f / (8.0f + max(0.0f, sqrt(metalMakerIncome / gs-&gt;activeTeams) - 4));
 		metalMakerIncome = 0;
 	}
 }
@@ -538,7 +540,7 @@
 {
 	ASSERT_SYNCED_MODE;
 	//todo: fixa en lista med enbart windgenerators kanske blir lite snabbare
-	list&lt;CUnit*&gt;::iterator usi;
+	std::list&lt;CUnit*&gt;::iterator usi;
 	for(usi=activeUnits.begin();usi!=activeUnits.end();usi++)
 	{
 		if((*usi)-&gt;unitDef-&gt;windGenerator)

Modified: trunk/rts/Sim/Units/UnitTypes/Builder.cpp
===================================================================
--- trunk/rts/Sim/Units/UnitTypes/Builder.cpp	2008-06-19 21:59:28 UTC (rev 6048)
+++ trunk/rts/Sim/Units/UnitTypes/Builder.cpp	2008-06-20 00:11:41 UTC (rev 6049)
@@ -30,9 +30,9 @@
 #include &quot;Sound.h&quot;
 #include &quot;mmgr.h&quot;
 
-using namespace std;
+using std::min;
+using std::max;
 
-
 CR_BIND_DERIVED(CBuilder, CUnit, );
 
 CR_REG_METADATA(CBuilder, (

Modified: trunk/rts/Sim/Weapons/WeaponDefHandler.cpp
===================================================================
--- trunk/rts/Sim/Weapons/WeaponDefHandler.cpp	2008-06-19 21:59:28 UTC (rev 6048)
+++ trunk/rts/Sim/Weapons/WeaponDefHandler.cpp	2008-06-20 00:11:41 UTC (rev 6049)
@@ -19,9 +19,9 @@
 #include &quot;System/Sound.h&quot;
 #include &quot;mmgr.h&quot;
 
-using namespace std;
+using std::min;
+using std::max;
 
-
 CR_BIND(WeaponDef, );
 
 
@@ -555,7 +555,7 @@
 	}
 
 	const float gd = max(30.0f, wd.damages[0] / 20.0f);
-	const float defExpSpeed = (8.0f + (gd * 2.5f)) / (9.0f + (sqrtf(gd) * 0.7f)) * 0.5f;
+	const float defExpSpeed = (8.0f + (gd * 2.5f)) / (9.0f + (sqrt(gd) * 0.7f)) * 0.5f;
 	wd.explosionSpeed = wdTable.GetFloat(&quot;explosionSpeed&quot;, defExpSpeed);
 
 	// Dynamic Damage

Modified: trunk/rts/System/FastMath.h
===================================================================
--- trunk/rts/System/FastMath.h	2008-06-19 21:59:28 UTC (rev 6048)
+++ trunk/rts/System/FastMath.h	2008-06-20 00:11:41 UTC (rev 6049)
@@ -159,8 +159,8 @@
 			x = -x - PI;
 		}
 		/* approximation */
-		x = (PIU4) * x + (PISUN4) * x * fabsf(x);
-		x = 0.225 * (x * fabsf(x) - x) + x;
+		x = (PIU4) * x + (PISUN4) * x * fabs(x);
+		x = 0.225 * (x * fabs(x) - x) + x;
 		return x;
 	}
 

Modified: trunk/rts/System/Platform/FileSystem.cpp
===================================================================
--- trunk/rts/System/Platform/FileSystem.cpp	2008-06-19 21:59:28 UTC (rev 6048)
+++ trunk/rts/System/Platform/FileSystem.cpp	2008-06-20 00:11:41 UTC (rev 6049)
@@ -60,7 +60,7 @@
 {
 	if (!instance) {
 #ifdef WIN32
-		instance = new WinFileSystemHandler(verbose);
+		instance = new UnixFileSystemHandler(verbose);
 #elif defined(__APPLE__)
 		instance = new MacFileSystemHandler(verbose);
 #else
@@ -91,39 +91,6 @@
 	instance = this;
 }
 
-/**
- * @brief return a writable directory
- */
-std::string FileSystemHandler::GetWriteDir() const
-{
-	char buf[3];
-	buf[0] = '.';
-	buf[1] = native_path_separator;
-	buf[2] = 0;
-	return buf;
-}
-
-/**
- * @brief return a vector of all data directories
- */
-std::vector&lt;std::string&gt; FileSystemHandler::GetDataDirectories() const
-{
-	std::vector&lt;std::string&gt; f;
-	f.push_back(FileSystemHandler::GetWriteDir());
-	return f;
-}
-
-/**
- * @brief locate a file
- *
- * This implementation just assumes the file lives in the current working
- * directory, so it just returns it's argument: file.
- */
-std::string FileSystemHandler::LocateFile(const std::string&amp; file) const
-{
-	return file;
-}
-
 ////////////////////////////////////////
 ////////// FileSystem
 

Modified: trunk/rts/System/Platform/FileSystem.h
===================================================================
--- trunk/rts/System/Platform/FileSystem.h	2008-06-19 21:59:28 UTC (rev 6048)
+++ trunk/rts/System/Platform/FileSystem.h	2008-06-20 00:11:41 UTC (rev 6049)
@@ -38,18 +38,18 @@
 		virtual bool mkdir(const std::string&amp; dir) const = 0;
 
 		// custom functions
-		virtual std::string GetWriteDir() const;
+		virtual std::string GetWriteDir() const = 0;
 		virtual std::vector&lt;std::string&gt; FindFiles(const std::string&amp; dir, const std::string&amp; pattern, int flags) const = 0;
-		virtual std::string LocateFile(const std::string&amp; file) const;
-		virtual std::vector&lt;std::string&gt; GetDataDirectories() const;
+		virtual std::string LocateFile(const std::string&amp; file) const = 0;
+		virtual std::vector&lt;std::string&gt; GetDataDirectories() const = 0;
 
 		int GetNativePathSeparator() const { return native_path_separator; }
 
-	private:
+	protected:
 
 		static FileSystemHandler* instance;
 
-		int native_path_separator;
+		const int native_path_separator;
 };
 
 /**

Modified: trunk/rts/System/Platform/Linux/DataDirLocater.cpp
===================================================================
--- trunk/rts/System/Platform/Linux/DataDirLocater.cpp	2008-06-19 21:59:28 UTC (rev 6048)
+++ trunk/rts/System/Platform/Linux/DataDirLocater.cpp	2008-06-20 00:11:41 UTC (rev 6049)
@@ -8,6 +8,15 @@
 
 #include &quot;StdAfx.h&quot;
 #include &quot;DataDirLocater.h&quot;
+#ifdef WIN32
+	#include &lt;io.h&gt;
+	#include &lt;windows.h&gt;
+	#include &lt;shlobj.h&gt;
+	#include &lt;shlwapi.h&gt;
+	#ifndef SHGFP_TYPE_CURRENT
+		#define SHGFP_TYPE_CURRENT 0
+	#endif
+#endif
 #include &lt;sstream&gt;
 #include &lt;string.h&gt;
 #include &quot;System/FileSystem/VFSHandler.h&quot;
@@ -23,10 +32,17 @@
  */
 DataDir::DataDir(const std::string&amp; p) : path(p), writable(false)
 {
+#ifndef _WIN32
 	if (path.empty())
 		path = &quot;./&quot;;
 	if (path[path.size() - 1] != '/')
 		path += '/';
+#else
+	if (path.empty())
+		path = &quot;.\\&quot;;
+	if (path[path.size() - 1] != '\\')
+		path += '\\';
+#endif
 }
 
 /**
@@ -51,10 +67,12 @@
 			out &lt;&lt; *ch;
 		} else {
 			switch (*ch) {
+#ifndef _WIN32
 				case '\\': {
 					escape = true;
 					break;
 				}
+#endif
 				case '$': {
 					std::ostringstream envvar;
 					for (++ch; ch != in.end() &amp;&amp; (isalnum(*ch) || *ch == '_'); ++ch)
@@ -81,10 +99,17 @@
 void DataDirLocater::AddDirs(const std::string&amp; in)
 {
 	size_t prev_colon = 0, colon;
+#ifndef _WIN32
 	while ((colon = in.find(':', prev_colon)) != std::string::npos) {
+#else
+	while ((colon = in.find(';', prev_colon)) != std::string::npos) {
+#endif
 		datadirs.push_back(in.substr(prev_colon, colon - prev_colon));
 		prev_colon = colon + 1;
 	}
+#ifdef DEBUG
+	logOutput.Print(&quot;Adding %s to directories&quot; , in.substr(prev_colon).c_str());
+#endif
 	datadirs.push_back(in.substr(prev_colon));
 }
 
@@ -94,7 +119,11 @@
  */
 bool DataDirLocater::DeterminePermissions(DataDir* d)
 {
+#ifndef _WIN32
 	if (d-&gt;path.c_str()[0] != '/' || d-&gt;path.find(&quot;..&quot;) != std::string::npos)
+#else
+	if (d-&gt;path.find(&quot;..&quot;) != std::string::npos)
+#endif
 		throw content_error(&quot;specify data directories using absolute paths please&quot;);
 	// Figure out whether we have read/write permissions
 	// First check read access, if we got that check write access too
@@ -155,12 +184,12 @@
  * On *nix platforms, attempts to locate
  * and change to the spring data directory
  *
- * The data directory to chdir to is determined by the following, in this
+ * In Unixes, the data directory to chdir to is determined by the following, in this
  * order (first items override lower items):
  *
+ * - 'SpringData=/path/to/data' declaration in '~/.springrc'. (colon separated list)
+ * - &quot;$HOME/.spring&quot;
  * - 'SPRING_DATADIR' environment variable. (colon separated list, like PATH)
- * - 'SpringData=/path/to/data' declaration in '~/.springrc'. (colon separated list)
- *   This defaults to &quot;$HOME/.spring&quot;
  * - In the same order any line in '/etc/spring/datadir', if that file exists.
  * - 'datadir=/path/to/data' option passed to 'scons configure'.
  * - 'prefix=/install/path' option passed to scons configure. The datadir is
@@ -169,6 +198,14 @@
  *   (This is set by the build system, ie. SPRING_DATADIR and SPRING_DATADIR_2
  *   preprocessor definitions.)
  *
+ * In Windows, its:
+ * - user configurable (SpringData in registry)
+ * - location of the binary dir (like it has been until 0.76b1)
+ * - the Users 'Documents'-directory (in subdirectory Spring), unless spring is configured to use another
+ * - all users app-data (in subdirectory Spring)
+ * - SPRING_DATADIR env-variable
+ * - compiler flags SPRING_DATADIR and SPRING_DATADIR_2
+ *
  * All of the above methods support environment variable substitution, eg.
  * '$HOME/myspringdatadir' will be converted by spring to something like
  * '/home/username/myspringdatadir'.
@@ -181,15 +218,46 @@
 	// Construct the list of datadirs from various sources.
 	datadirs.clear();
 
+	// user defined (in spring config handler (Linux: ~/.spring, Windows: registry))
+	std::string userDef = configHandler.GetString(&quot;SpringData&quot;, &quot;&quot;);
+	if (!userDef.empty())
+	{
+		AddDirs(SubstEnvVars(userDef));
+	}
+	
+#ifdef WIN32
+	// Add current binary directory to searchpath (and its first one for historic reason)
+	char buf[3];
+	buf[0] = '.';
+	buf[1] = '\\';
+	buf[2] = 0;
+	AddDirs(std::string(buf));
+	
+	// my documents
+	TCHAR strPath[MAX_PATH];
+	SHGetFolderPath( NULL, CSIDL_PERSONAL, NULL, SHGFP_TYPE_CURRENT, strPath);
+	std::string cfg = strPath;
+	cfg += &quot;\\Spring&quot;; // e.g. F:\Dokumente und Einstellungen\Karl-Robert\Eigene Dateien\Spring
+	AddDirs(cfg);
+	cfg.clear();
+
+	// appdata
+	SHGetFolderPath( NULL, CSIDL_COMMON_APPDATA, NULL, SHGFP_TYPE_CURRENT, strPath);
+	cfg = strPath;
+	cfg += &quot;\\Spring&quot;; // e.g. F:\Dokumente und Einstellungen\All Users\Anwendungsdaten\Spring
+	AddDirs(cfg);
+#else
+	// home
+	AddDirs(SubstEnvVars(&quot;$HOME/.spring&quot;));
+#endif
+
+	// environment variable
 	char* env = getenv(&quot;SPRING_DATADIR&quot;);
 	if (env &amp;&amp; *env)
 		AddDirs(SubstEnvVars(env));
 
-	std::string cfg = configHandler.GetString(&quot;SpringData&quot;, &quot;$HOME/.spring&quot;);
-	if (!cfg.empty()) {
-		AddDirs(SubstEnvVars(cfg));
-	}
-
+#ifndef _WIN32
+	// settings in /etc
 	FILE* f = ::fopen(&quot;/etc/spring/datadir&quot;, &quot;r&quot;);
 	if (f) {
 		char buf[1024];
@@ -201,7 +269,9 @@
 		}
 		fclose(f);
 	}
+#endif
 
+	// compiler flags
 #ifdef SPRING_DATADIR
 	datadirs.push_back(SubstEnvVars(SPRING_DATADIR));
 #endif

Modified: trunk/rts/System/Platform/Linux/UnixFileSystemHandler.cpp
===================================================================
--- trunk/rts/System/Platform/Linux/UnixFileSystemHandler.cpp	2008-06-19 21:59:28 UTC (rev 6048)
+++ trunk/rts/System/Platform/Linux/UnixFileSystemHandler.cpp	2008-06-20 00:11:41 UTC (rev 6049)
@@ -3,7 +3,7 @@
  * @brief Abstracts locating of content on different platforms
  * @author Tobi Vollebregt
  *
- * Unix implementation, supporting multiple data directories / search paths.
+ * Linux and Windows implementation, supporting multiple data directories / search paths.
  *
  * Copyright (C) 2006-2008 Tobi Vollebregt.
  * Licensed under the terms of the GNU GPL, v2 or later
@@ -64,7 +64,12 @@
  *
  * Locates data directories and initializes the VFS.
  */
-UnixFileSystemHandler::UnixFileSystemHandler(bool verbose, bool initialize)
+UnixFileSystemHandler::UnixFileSystemHandler(bool verbose, bool initialize) :
+#ifndef _WIN32
+		FileSystemHandler('/')
+#else
+		FileSystemHandler('\\')
+#endif
 {
 	if(initialize){
 		locater.LocateDataDirs();
@@ -165,7 +170,11 @@
 		return true;
 
 	// If it doesn't exist we try to mkdir it and return success if that succeeds.
+#ifndef _WIN32
 	if (::mkdir(dir.c_str(), S_IRWXU | S_IRGRP | S_IXGRP | S_IROTH | S_IXOTH) == 0)
+#else
+	if (::mkdir(dir.c_str()) == 0)
+#endif
 		return true;
 
 	// Otherwise we return false.
@@ -198,11 +207,11 @@
 					// or a directory?
 					if (flags &amp; FileSystem::INCLUDE_DIRS) {
 						if (boost::regex_match(ep-&gt;d_name, regexpattern)) {
-							matches.push_back(dir + ep-&gt;d_name + '/');
+							matches.push_back(dir + ep-&gt;d_name + &quot;/&quot;);
 						}
 					}
 					if (flags &amp; FileSystem::RECURSE) {
-						FindFiles(matches, dir + ep-&gt;d_name + '/', regexpattern, flags);
+						FindFiles(matches, dir + ep-&gt;d_name + &quot;/&quot;, regexpattern, flags);
 					}
 				}
 			}
@@ -225,7 +234,7 @@
  */
 void UnixFileSystemHandler::FindFilesSingleDir(std::vector&lt;std::string&gt;&amp; matches, const std::string&amp; dir, const std::string &amp;pattern, int flags) const
 {
-	assert(!dir.empty() &amp;&amp; dir[dir.length() - 1] == '/');
+	assert(!dir.empty() &amp;&amp; dir[dir.length() - 1] == native_path_separator);
 
 	boost::regex regexpattern(filesystem.glob_to_regex(pattern));
 

Added: trunk/rts/System/Platform/Win/DataDirLocater.cpp
===================================================================
--- trunk/rts/System/Platform/Win/DataDirLocater.cpp	                        (rev 0)
+++ trunk/rts/System/Platform/Win/DataDirLocater.cpp	2008-06-20 00:11:41 UTC (rev 6049)
@@ -0,0 +1 @@
+#include &quot;Platform/Linux/DataDirLocater.cpp&quot;

Added: trunk/rts/System/Platform/Win/DataDirLocater.h
===================================================================
--- trunk/rts/System/Platform/Win/DataDirLocater.h	                        (rev 0)
+++ trunk/rts/System/Platform/Win/DataDirLocater.h	2008-06-20 00:11:41 UTC (rev 6049)
@@ -0,0 +1 @@
+#include &quot;Platform/Linux/DataDirLocater.h&quot;

Modified: trunk/rts/System/Platform/Win/WinFileSystemHandler.cpp
===================================================================
--- trunk/rts/System/Platform/Win/WinFileSystemHandler.cpp	2008-06-19 21:59:28 UTC (rev 6048)
+++ trunk/rts/System/Platform/Win/WinFileSystemHandler.cpp	2008-06-20 00:11:41 UTC (rev 6049)
@@ -1,132 +1 @@
-/**
- * @file WinFileSystemHandler.cpp
- * @brief Abstracts locating of content on different platforms
- * @author Tobi Vollebregt
- *
- * Windows implementation supporting only one directory.
- *
- * Copyright (C) 2006.  Licensed under the terms of the
- * GNU GPL, v2 or later
- */
-
-#include &quot;StdAfx.h&quot;
-#include &lt;limits.h&gt;
-#include &lt;boost/regex.hpp&gt;
-#include &quot;FileSystem/ArchiveScanner.h&quot;
-#include &quot;FileSystem/VFSHandler.h&quot;
-#include &quot;WinFileSystemHandler.h&quot;
-#include &lt;io.h&gt;
-#include &lt;sys/types.h&gt;
-#include &lt;sys/stat.h&gt;
-#include &lt;direct.h&gt;
-#include &quot;mmgr.h&quot;
-
-// fix for windows
-#ifndef S_ISDIR
-#define S_ISDIR(x) (((x) &amp; 0170000) == 0040000) /* directory */
-#endif
-
-/**
- * @brief Creates the archive scanner and vfs handler
- */
-WinFileSystemHandler::WinFileSystemHandler(bool verbose) : FileSystemHandler('\\')
-{
-	//  (same code as originally in CSpringApp::InitVFS())
-
-	// Create the archive scanner and vfs handler
-	archiveScanner = new CArchiveScanner();
-	archiveScanner-&gt;ReadCacheData(archiveScanner-&gt;GetFilename());
-	std::vector&lt;std::string&gt; scanDirs;
-	scanDirs.push_back(&quot;./maps&quot;);
-	scanDirs.push_back(&quot;./base&quot;);
-	scanDirs.push_back(&quot;./mods&quot;);
-	archiveScanner-&gt;ScanDirs(scanDirs, true);
-	archiveScanner-&gt;WriteCacheData(archiveScanner-&gt;GetFilename());
-	hpiHandler = new CVFSHandler();
-}
-
-WinFileSystemHandler::~WinFileSystemHandler()
-{
-}
-
-/**
- * @brief creates a directory
- *
- * Returns true if the postcondition of this function is that dir exists.
- *
- * (Looks quite like the UNIX version but mkdir has different arguments.)
- */
-bool WinFileSystemHandler::mkdir(const std::string&amp; path) const
-{
-	struct stat info;
-
-	// First check if directory exists. We'll return success if it does.
-	if (stat(path.c_str(), &amp;info) == 0 &amp;&amp; S_ISDIR(info.st_mode))
-		return true;
-
-	// If it doesn't exist we try to mkdir it and return success if that succeeds.
-	if (::mkdir(path.c_str()) == 0)
-		return true;
-
-	// Otherwise we return false.
-	return false;
-}
-
-static void FindFiles(std::vector&lt;std::string&gt;&amp; matches, const std::string&amp; dir, const boost::regex &amp;regexpattern, int flags)
-{
-	struct _finddata_t files;
-	long hFile;
-
-	if( (hFile = _findfirst( (dir + &quot;*.*&quot;).c_str() , &amp;files )) == -1L )
-		return;
-
-	do {
-		// exclude hidden/system files
-		if (files.name[0] != '.' &amp;&amp; !(files.attrib &amp; (_A_HIDDEN | _A_SYSTEM))) {
-			// is it a file?
-			if (!(files.attrib &amp; _A_SUBDIR)) {
-				if ((flags &amp; FileSystem::ONLY_DIRS) == 0) {
-					if (boost::regex_match(files.name, regexpattern)) {
-						matches.push_back(dir + files.name);
-					}
-				}
-			}
-			// or a directory?
-			else {
-				if (flags &amp; FileSystem::INCLUDE_DIRS) {
-					if (boost::regex_match(files.name, regexpattern)) {
-						matches.push_back(dir + files.name + '\\');
-					}
-				}					
-				if (flags &amp; FileSystem::RECURSE) {
-					FindFiles(matches, dir + files.name + '\\', regexpattern, flags);
-				}
-			}
-		}
-	} while (_findnext( hFile, &amp;files ) == 0);
-
-	_findclose( hFile );
-}
-
-/**
- * @brief find files
- * @param dir path in which to start looking
- * @param pattern pattern to search for
- * @param recurse whether or not to recursively search
- * @param include_dirs whether or not to include directory names in the result
- * @return vector of std::strings
- *
- * Will search for a file given a particular pattern.
- * Starts from dirpath, descending down if recurse is true.
- */
-std::vector&lt;std::string&gt; WinFileSystemHandler::FindFiles(const std::string&amp; dir, const std::string &amp;pattern, int flags) const
-{
-	assert(!dir.empty() &amp;&amp; dir[dir.length() - 1] == '\\');
-
-	std::vector&lt;std::string&gt; matches;
-	boost::regex regexpattern(filesystem.glob_to_regex(pattern));
-
-	::FindFiles(matches, dir, regexpattern, flags);
-
-	return matches;
-}
+#include &quot;Platform/Linux/UnixFileSystemHandler.cpp&quot;

Modified: trunk/rts/System/Platform/Win/WinFileSystemHandler.h
===================================================================
--- trunk/rts/System/Platform/Win/WinFileSystemHandler.h	2008-06-19 21:59:28 UTC (rev 6048)
+++ trunk/rts/System/Platform/Win/WinFileSystemHandler.h	2008-06-20 00:11:41 UTC (rev 6049)
@@ -1,34 +1,2 @@
-/**
- * @file WinFileSystemHandler.h
- * @brief Abstracts locating of content on different platforms
- * @author Tobi Vollebregt
- *
- * Windows implementation.
- *
- * Copyright (C) 2006.  Licensed under the terms of the
- * GNU GPL, v2 or later
- */
-
-#ifndef WINFILESYSTEMHANDLER_H
-#define WINFILESYSTEMHANDLER_H
-
-#include &quot;Platform/FileSystem.h&quot;
-
-/**
- * @brief Windows data directory handler
- *
- * Pretty boring class with almost nothing in it.
- */
-class WinFileSystemHandler : public FileSystemHandler
-{
-	public:
-
-		virtual ~WinFileSystemHandler();
-		WinFileSystemHandler(bool verbose);
-
-		virtual bool mkdir(const std::string&amp; dir) const;
-
-		virtual std::vector&lt;std::string&gt; FindFiles(const std::string&amp; dir, const std::string&amp; pattern, int flags) const;
-};
-
-#endif // !WINFILESYSTEMHANDLER_H
+//HACK don't want to adjust scons to build the unix one for windows
+#include &quot;Platform/Linux/UnixFileSystemHandler.h&quot;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000828.html">[Taspring-linux-commit] r6048 - in trunk: rts/lib	tools/DedicatedServer
</A></li>
	<LI>Next message: <A HREF="000830.html">[Taspring-linux-commit] r6050 - in trunk/rts: Rendering System	System/Platform/Linux
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#829">[ date ]</a>
              <a href="thread.html#829">[ thread ]</a>
              <a href="subject.html#829">[ subject ]</a>
              <a href="author.html#829">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
