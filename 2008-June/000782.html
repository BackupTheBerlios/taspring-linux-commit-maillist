<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r6002 - in trunk: game game/LuaUI	game/LuaUI/Widgets installer installer/builddata/maphelper	installer/builddata/maphelper/maphelper installer/sections	rts/Game rts/Game/StartScripts rts/Game/UI rts/Lua rts/Map	rts/Rendering/GL rts/Sim/Misc rts/Sim/MoveTypes rts/Sim/Units	rts/Sim/Units/COB rts/System/FileSystem tools/unitsync	tools/unitsync/test
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-June/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6002%20-%20in%20trunk%3A%20game%20game/LuaUI%0A%09game/LuaUI/Widgets%20installer%20installer/builddata/maphelper%0A%09installer/builddata/maphelper/maphelper%20installer/sections%0A%09rts/Game%20rts/Game/StartScripts%20rts/Game/UI%20rts/Lua%20rts/Map%0A%09rts/Rendering/GL%20rts/Sim/Misc%20rts/Sim/MoveTypes%20rts/Sim/Units%0A%09rts/Sim/Units/COB%20rts/System/FileSystem%20tools/unitsync%0A%09tools/unitsync/test&In-Reply-To=%3C20080608233856.6763F47CD%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000781.html">
   <LINK REL="Next"  HREF="000783.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r6002 - in trunk: game game/LuaUI	game/LuaUI/Widgets installer installer/builddata/maphelper	installer/builddata/maphelper/maphelper installer/sections	rts/Game rts/Game/StartScripts rts/Game/UI rts/Lua rts/Map	rts/Rendering/GL rts/Sim/Misc rts/Sim/MoveTypes rts/Sim/Units	rts/Sim/Units/COB rts/System/FileSystem tools/unitsync	tools/unitsync/test</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6002%20-%20in%20trunk%3A%20game%20game/LuaUI%0A%09game/LuaUI/Widgets%20installer%20installer/builddata/maphelper%0A%09installer/builddata/maphelper/maphelper%20installer/sections%0A%09rts/Game%20rts/Game/StartScripts%20rts/Game/UI%20rts/Lua%20rts/Map%0A%09rts/Rendering/GL%20rts/Sim/Misc%20rts/Sim/MoveTypes%20rts/Sim/Units%0A%09rts/Sim/Units/COB%20rts/System/FileSystem%20tools/unitsync%0A%09tools/unitsync/test&In-Reply-To=%3C20080608233856.6763F47CD%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r6002 - in trunk: game game/LuaUI	game/LuaUI/Widgets installer installer/builddata/maphelper	installer/builddata/maphelper/maphelper installer/sections	rts/Game rts/Game/StartScripts rts/Game/UI rts/Lua rts/Map	rts/Rendering/GL rts/Sim/Misc rts/Sim/MoveTypes rts/Sim/Units	rts/Sim/Units/COB rts/System/FileSystem tools/unitsync	tools/unitsync/test">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Mon Jun  9 01:38:54 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000781.html">[Taspring-linux-commit] r6001 - trunk/rts/Game/UI
</A></li>
        <LI>Next message: <A HREF="000783.html">[Taspring-linux-commit] r6003 - trunk/installer/sections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#782">[ date ]</a>
              <a href="thread.html#782">[ thread ]</a>
              <a href="subject.html#782">[ subject ]</a>
              <a href="author.html#782">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: trepan
Date: 2008-06-09 01:38:52 +0200 (Mon, 09 Jun 2008)
New Revision: 6002

Added:
   trunk/game/luaui.lua
Removed:
   trunk/game/LuaUI/modui_dialog.lua
   trunk/game/gui.lua
Modified:
   trunk/game/LuaUI/Widgets/camera_smooth_move.lua
   trunk/game/LuaUI/Widgets/gui_hilight_unit.lua
   trunk/game/LuaUI/main.lua
   trunk/game/LuaUI/widgets.lua
   trunk/installer/builddata/maphelper/MapOptions.lua
   trunk/installer/builddata/maphelper/maphelper/mapinfo.lua
   trunk/installer/make_luaui_nsh.py
   trunk/installer/sections/luaui.nsh
   trunk/rts/Game/StartScripts/CommanderScript.cpp
   trunk/rts/Game/StartScripts/CommanderScript2.cpp
   trunk/rts/Game/StartScripts/GlobalAITestScript.cpp
   trunk/rts/Game/StartScripts/SpawnScript.cpp
   trunk/rts/Game/Team.h
   trunk/rts/Game/UI/GuiHandler.cpp
   trunk/rts/Game/UI/GuiHandler.h
   trunk/rts/Game/UI/LuaUI.cpp
   trunk/rts/Lua/LuaSyncedCtrl.cpp
   trunk/rts/Lua/LuaSyncedCtrl.h
   trunk/rts/Lua/LuaSyncedRead.cpp
   trunk/rts/Lua/LuaUnitDefs.cpp
   trunk/rts/Map/MapInfo.cpp
   trunk/rts/Map/MapInfo.h
   trunk/rts/Map/MapParser.cpp
   trunk/rts/Map/MetalMap.cpp
   trunk/rts/Map/MetalMap.h
   trunk/rts/Rendering/GL/myGL.cpp
   trunk/rts/Sim/Misc/LosHandler.h
   trunk/rts/Sim/Misc/RadarHandler.cpp
   trunk/rts/Sim/Misc/RadarHandler.h
   trunk/rts/Sim/MoveTypes/AirMoveType.cpp
   trunk/rts/Sim/MoveTypes/GroundMoveType.cpp
   trunk/rts/Sim/MoveTypes/ScriptMoveType.cpp
   trunk/rts/Sim/MoveTypes/TAAirMoveType.cpp
   trunk/rts/Sim/Units/COB/CobInstance.cpp
   trunk/rts/Sim/Units/Unit.cpp
   trunk/rts/Sim/Units/Unit.h
   trunk/rts/Sim/Units/UnitDef.h
   trunk/rts/Sim/Units/UnitDefHandler.cpp
   trunk/rts/Sim/Units/UnitLoader.cpp
   trunk/rts/System/FileSystem/ArchiveDir.cpp
   trunk/rts/System/FileSystem/FileHandler.cpp
   trunk/tools/unitsync/test/test.cpp
   trunk/tools/unitsync/unitsync.cpp
Log:

- added the 'sonarStealth' unitDef tag
- added the Spring.SetUnitSonarStealth() lua call-out
- added the SONAR_STEALTH (108) COB get/set parameter

- changed MapParser so that it no longer throws exceptions

- removed the ModUI code  (wasn't being used, afaict)

- fixed the 'frame' table value returned by Spring.GetTeamStatsHistory()
  (and added the 'time' value, which is in seconds)

- updated unit-&gt;isUnderWater in ScriptMoveType::SlowUpdate()

- renamed 'gui.lua' to 'luaui.lua'

- changed gui_highlight_unit.lua to use lua font rendering



Modified: trunk/game/LuaUI/Widgets/camera_smooth_move.lua
===================================================================
--- trunk/game/LuaUI/Widgets/camera_smooth_move.lua	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/game/LuaUI/Widgets/camera_smooth_move.lua	2008-06-08 23:38:52 UTC (rev 6002)
@@ -42,6 +42,7 @@
 local spSendCommands     = Spring.SendCommands
 local spSetCameraState   = Spring.SetCameraState
 local spSetMouseCursor   = Spring.SetMouseCursor
+local spTraceScreenRay   = Spring.TraceScreenRay
 local spWarpMouse        = Spring.WarpMouse
 
 
@@ -115,7 +116,9 @@
       cs.px = cs.px + (mxm * drx) + (mym * dfx)
       cs.pz = cs.pz + (mxm * drz) + (mym * dfz)
     end
+
     spSetCameraState(cs, 0)
+
     if (mmb) then
       spSetMouseCursor('none')
     end
@@ -155,6 +158,95 @@
 end
 
 
+function widget:MouseWheel(up, value)
+  local cs = spGetCameraState()
+  local a,c,m,s = spGetModKeyState()
+  if (m) then
+    local py = math.abs(cs.py)
+    local dy = (1 + math.pow(py * 100, 0.25)) * (up and -1 or 1)
+    local dy = (py / 10) * (up and -1 or 1)
+    print(dy)
+    spSetCameraState({
+      py = py + dy,
+--      vy = cs.vy + value,
+    }, 0)
+    return true
+  end
+  if (cs.name ~= 'free') then
+    return false
+  end
+  local scale = value * 10
+  local mx, my = spGetMouseState()
+  local _, gpos = spTraceScreenRay(mx, my, true)
+  if (not gpos) then
+    spSetCameraState({ vy = cs.vy + scale}, 0)
+  else
+    local dx = gpos[1] - cs.px
+    local dy = gpos[2] - cs.py
+    local dz = gpos[3] - cs.pz
+    local d = math.sqrt((dx * dx) + (dy * dy) + (dz * dz))
+--    local s = (up and -1 or 1) / d
+    local s = (up and 1 or -1) * (1 / 8)
+    
+    dx = dx * s
+    dy = dy * s
+    dz = dz * s
+    local newCS = {
+      px = cs.px + dx,
+      py = cs.py + dy,
+      pz = cs.pz + dz,
+      vx = 0,
+      vy = 0,
+      vz = 0,
+    }
+    spSetCameraState(newCS, 0)
+  end
+  return true
+end
+
+
+function widget:MouseWheel2(up, value)
+  local cs = spGetCameraState()
+  local a,c,m,s = spGetModKeyState()
+  if (not m) then
+    local py = math.abs(cs.py)
+    local dy = (1 + math.pow(py * 100, 0.25)) * (up and -1 or 1)
+    local dy = (py / 10) * (up and -1 or 1)
+    print(dy)
+    spSetCameraState({
+      py = py + dy,
+--      vy = cs.vy + value,
+    }, 0)
+    return true
+  end
+  if (cs.name ~= 'free') then
+    return false
+  end
+  local scale = value * 10
+  local mx, my = spGetMouseState()
+  local _, gpos = spTraceScreenRay(mx, my, true)
+  if (not gpos) then
+    spSetCameraState({ vy = cs.vy + scale}, 0)
+  else
+    local dx = gpos[1] - cs.px
+    local dy = gpos[2] - cs.py
+    local dz = gpos[3] - cs.pz
+    local d = math.sqrt((dx * dx) + (dy * dy) + (dz * dz))
+    local s = -scale / d
+    dx = dx * s
+    dy = dy * s
+    dz = dz * s
+    local newCS = {
+      vx = cs.vx + dx,
+      vy = cs.vy + dy,
+      vz = cs.vz + dz,
+    }
+    spSetCameraState(newCS, 0)
+  end
+  return true
+end
+
+
 local function DrawPoint(x, y, c, s)
   glPointSize(s)
   glColor(c)

Modified: trunk/game/LuaUI/Widgets/gui_hilight_unit.lua
===================================================================
--- trunk/game/LuaUI/Widgets/gui_hilight_unit.lua	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/game/LuaUI/Widgets/gui_hilight_unit.lua	2008-06-08 23:38:52 UTC (rev 6002)
@@ -102,8 +102,13 @@
 --------------------------------------------------------------------------------
 
 include(&quot;colors.h.lua&quot;)
+include(&quot;fonts.lua&quot;)
 
+local font = 'FreeMonoBold'
+local fontSize = 16
+local fontName = ':n:'..LUAUI_DIRNAME..'Fonts/'..font..'_'..fontSize
 
+
 local showName = (1 &gt; 0)
 
 local customTex = LUAUI_DIRNAME .. 'Images/highlight_strip.png'
@@ -470,25 +475,51 @@
     end
   end
 
-  local f = 14
-  local gx = 16
-  local gy = 8
+  local fh = fontHandler
+  if (fh.UseFont(fontName)) then
 
-  local lt = f * glGetTextWidth(typeStr)
-  local lp = pName and (f * glGetTextWidth(pName)) or 0
-  local lm = (lt &gt; lp) and lt or lp  --  max len
+    local f = fh.GetFontSize() * 0.5
+    local gx = 12 -- gap x
+    local gy = 8  -- gap y
 
-  pName = pName and (colorStr .. pName)
+    local lt = fh.GetTextWidth(typeStr)
+    local lp = pName and fh.GetTextWidth(pName) or 0
+    local lm = (lt &gt; lp) and lt or lp  --  max len
 
-  if ((mx + lm + gx) &lt; vsx) then
-    glText(typeStr, mx + gx, my + gy, f, 'o')
-    if (pName) then
-      glText(pName, mx + gx, my - gy - f, f, outlineChar)
+    pName = pName and (colorStr .. pName)
+
+    if ((mx + lm + gx) &lt; vsx) then
+      fh.Draw(typeStr, mx + gx, my + gy)
+      if (pName) then
+        fh.Draw(pName, mx + gx, my - gy - f)
+      end
+    else
+      fh.DrawRight(typeStr, mx - gx, my + gy)
+      if (pName) then
+        fh.DrawRight(pName, mx - gx, my - gy - f)
+      end
     end
   else
-    glText(typeStr, mx - gx, my + gy, f, 'or')
-    if (pName) then
-      glText(pName, mx - gx, my - gy - f, f, outlineChar .. 'r')
+    local f = 14
+    local gx = 16
+    local gy = 8
+
+    local lt = f * glGetTextWidth(typeStr)
+    local lp = pName and (f * glGetTextWidth(pName)) or 0
+    local lm = (lt &gt; lp) and lt or lp  --  max len
+
+    pName = pName and (colorStr .. pName)
+
+    if ((mx + lm + gx) &lt; vsx) then
+      glText(typeStr, mx + gx, my + gy, f, 'o')
+      if (pName) then
+        glText(pName, mx + gx, my - gy - f, f, outlineChar)
+      end
+    else
+      glText(typeStr, mx - gx, my + gy, f, 'or')
+      if (pName) then
+        glText(pName, mx - gx, my - gy - f, f, outlineChar .. 'r')
+      end
     end
   end
 end

Modified: trunk/game/LuaUI/main.lua
===================================================================
--- trunk/game/LuaUI/main.lua	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/game/LuaUI/main.lua	2008-06-08 23:38:52 UTC (rev 6002)
@@ -45,12 +45,7 @@
 
 
 --------------------------------------------------------------------------------
-
-local gl = Spring.Draw  --  easier to use
-
-
 -------------------------------------------------------------------------------
--------------------------------------------------------------------------------
 --
 --  A few helper functions
 --

Deleted: trunk/game/LuaUI/modui_dialog.lua
===================================================================
--- trunk/game/LuaUI/modui_dialog.lua	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/game/LuaUI/modui_dialog.lua	2008-06-08 23:38:52 UTC (rev 6002)
@@ -1,383 +0,0 @@
---------------------------------------------------------------------------------
---------------------------------------------------------------------------------
---
---  file:    modui_dialog.lua
---  brief:   controls how mods' LuaUIs are used
---  author:  Dave Rodgers
---
---  Copyright (C) 2007.
---  Licensed under the terms of the GNU GPL, v2 or later.
---
---------------------------------------------------------------------------------
---------------------------------------------------------------------------------
-
-Spring.SendCommands({
-  &quot;resbar 0&quot;,
-  &quot;console 0&quot;,
-  &quot;tooltip 0&quot;,
-  &quot;minimap slavemode 1&quot;,
-  &quot;minimap minimize 1&quot;,
-})
-local function RevertHiding()
-  Spring.SendCommands({
-    &quot;resbar 1&quot;,
-    &quot;console 1&quot;,
-    &quot;tooltip 1&quot;,
-    &quot;minimap slavemode 0&quot;,
-    &quot;minimap minimize 0&quot;,
-  })
-end
-
-
-local LT = {}  --  local table
-setmetatable(LT, { __index = _G})
-
-local function IncludeFile(filename, t)
-  local success, err = pcall(VFS.Include, LUAUI_DIRNAME .. filename, t)
-  if (not success) then
-    Script.Kill('Failed to load ' .. filename .. ' (' .. err .. ')')
-    return
-  end
-end
-
-IncludeFile('Headers/colors.h.lua', LT);
-IncludeFile('Headers/keysym.h.lua', LT);
-IncludeFile('savetable.lua', LT);
-
-
---------------------------------------------------------------------------------
---
---  Local variables  (with namespace encapsulation)
---
-
-local gl = Spring.Draw
-
-local vsx = -1
-local vsy = -1
-
-local frame = {}
-
-local buttons = {
-  No     = { tooltip = &quot;Do not use this Mod's LuaUI for this game&quot; },
-  Yes    = { tooltip = &quot;Use this Mod's LuaUI for this game&quot; },
-  Never  = { tooltip = &quot;Never use this Mod's LuaUI&quot; },
-  Always = { tooltip = &quot;Always use this Mod's LuaUI&quot; }
-}
-for name,b in pairs(buttons) do
-  b.textWidth = gl.GetTextWidth(name)
-end
-
-local modStr = '\n' .. LT.YellowStr .. LT.Game.modName
-for _,b in pairs(buttons) do
---???  b.tooltip = b.tooltip .. modStr
-end
-local tooltip = &quot;Use Mod's LuaUI?&quot; .. modStr
-
-
---------------------------------------------------------------------------------
-
-local function MouseOverButton(x, y, button)
-  if (x &lt; button.minX) then return false end
-  if (x &gt; button.maxX) then return false end
-  if (y &lt; button.minY) then return false end
-  if (y &gt; button.maxY) then return false end
-  return true
-end
-
-
---------------------------------------------------------------------------------
-
-local function SetupWidgetGeometry()
-  frame.minX = (vsx * 0.5) - 128
-  frame.maxX = (vsx * 0.5) + 128
-  frame.minY = (vsy * 0.25) - 64
-  frame.maxY = (vsy * 0.25) + 64
-  local fSizeX = frame.maxX - frame.minX
-  local fSizeY = frame.maxY - frame.minY
-  frame.midX = (frame.minX + frame.maxX) * 0.5
-  frame.midY = (frame.minY + frame.maxY) * 0.5
-
-  local gap = (fSizeX * 0.05)
-  local xa = frame.minX + gap
-  local xb = frame.midX - (gap * 0.5)
-  local xc = frame.midX + (gap * 0.5)
-  local xd = frame.maxX - gap
-  local ya = frame.minY + gap
-  local yb = frame.midY - (gap * 0.5)
-  local yc = frame.midY + (gap * 0.5)
-  local yd = frame.maxY - gap
-  
-  local b
-  b = buttons.No;     b.minX = xc; b.maxX = xd; b.minY = yc; b.maxY = yd
-  b = buttons.Yes;    b.minX = xa; b.maxX = xb; b.minY = yc; b.maxY = yd
-  b = buttons.Never;  b.minX = xc; b.maxX = xd; b.minY = ya; b.maxY = yb
-  b = buttons.Always; b.minX = xa; b.maxX = xb; b.minY = ya; b.maxY = yb
-
-  for _,b in pairs(buttons) do
-    b.midX = (b.maxX + b.minX) * 0.5
-    b.textY = b.minY + 8
-    b.textSize = 0.5 * ((fSizeY * 0.5) - (gap * 1.5))
-  end
-end
-
-
-local function DrawButton(b)
-  gl.Shape(LT.GL.QUADS, {
-    { v = { b.minX, b.minY } },
-    { v = { b.maxX, b.minY } },
-    { v = { b.maxX, b.maxY } },
-    { v = { b.minX, b.maxY } }
-  })
-end
-
-
-local function DrawBorder(b)
-  gl.Shape(LT.GL.LINE_LOOP, {
-    { v = { b.minX - 0.5, b.minY - 0.5 } },
-    { v = { b.maxX + 0.5, b.minY - 0.5 } },
-    { v = { b.maxX + 0.5, b.maxY + 0.5 } },
-    { v = { b.minX - 0.5, b.maxY + 0.5} }
-  })
-end
-
-
---------------------------------------------------------------------------------
---
---
---
-
-local function ClearLocalTables()
-  DrawScreenItems = nil
-  KeyPress = nil
-  KeyRelease = nil
-  MousePress = nil
-  MouseRelease = nil
-  IsAbove = nil
-  GetTooltip = nil
-end
-
-
-local function LoadUserLuaUI()
-  RevertHiding()
-  ClearLocalTables()
-
-  USER_FILENAME = LUAUI_DIRNAME .. 'main.lua'
-
-  if (not VFS.FileExists(USER_FILENAME)) then
-    -- die quietly
-    LayoutButtons = function () return 'disabled' end
-    return
-  end
-
-  text = VFS.LoadFile(USER_FILENAME)
-  if (text == nil) then
-    Script.Kill('Failed to load ' .. USER_FILENAME)
-  end
-  local chunk, err = loadstring(text)
-  if (chunk == nil) then
-    Script.Kill('Failed to load ' .. USER_FILENAME .. ' (' .. err .. ')')
-  else
-    chunk()
-  end
-end
-
-
-local function LoadModLuaUI()
-  RevertHiding()
-  ClearLocalTables()
-
-
-  local MOD_FILENAME = 'ModUI/main.lua'
-
-  local modText = VFS.LoadFile(MOD_FILENAME, VFS.ZIP_ONLY)
-  if (modText == nil) then
-    Spring.Echo('Failed to load ' .. MOD_FILENAME)
-    LoadUserLuaUI()
-    return
-  end
-
-  local chunk, err = loadstring(modText)
-  if (chunk == nil) then
-    Spring.Echo('Failed to load ' .. MOD_FILENAME .. ': (' .. err .. ')')
-    LoadUserLuaUI()
-    return
-  else
-    LUAUI_DIRNAME = nil
-    VFS.DEF_MODE = VFS.ZIP_FIRST
-    local success, err = pcall(chunk)
-    if (not success) then
-      Spring.Echo('Failed to load ' .. MOD_FILENAME .. ': (' .. err .. ')')
-      VFS.DEF_MODE = VFS.RAW_FIRST
-      LoadUserLuaUI()
-    end
-  end
-end
-
-
-local function SaveModPerm(state)
-  Spring.CreateDir(LUAUI_DIRNAME .. 'Config')
-  local perms
-  local filename = LUAUI_DIRNAME .. 'Config/modui_list.lua'
-  local chunk, err = loadfile(filename)
-  if (chunk ~= nil) then
-    local tmp = {}
-    setfenv(chunk, tmp)
-    perms = chunk()
-  end
-  if (perms == nil) then
-    perms = {}
-  end
-  perms[Game.modName] = state
-  LT.table.save(perms, filename, '-- Mod LuaUI Permissions')
-end
-
-
---------------------------------------------------------------------------------
-
-local timer = 0
-
-function DrawScreenItems(viewSizeX, viewSizeY)
-  if ((vsx ~= viewSizeX) or (vsy ~= viewSizeY)) then
-    vsx = viewSizeX
-    vsy = viewSizeY
-    SetupWidgetGeometry()
-  end
-  
-  local overButton = nil
-  local x,y,lmb = Spring.GetMouseState()
-  for _,b in pairs(buttons) do
-    if (MouseOverButton(x, y, b)) then
-      overButton = b
-      break
-    end
-  end
-  
-  gl.Color(0.1, 0.1, 0.1, 0.7)
---  gl.Color(0, 0, 0)
-  gl.Shape(LT.GL.QUADS, {
-    { v = {   0,   0 } }, { v = { vsx,   0 } },
-    { v = { vsx, vsy } }, { v = {   0, vsy } }
-  })
-  
-  -- draw frame
-  gl.Color(0.35, 0.35, 0.35)
-  DrawButton(frame)
-
-  -- draw frame border
-  timer = math.mod(timer + Spring.GetLastUpdateSeconds(), 60.0)
-  local blink = math.abs(0.5 - math.mod(timer * 1.5, 1.0)) * 2.0
-  gl.LineWidth(3.0)
-  gl.Color(0.3 + (blink * 0.7), 0, 0)
-  DrawBorder(frame)
-  gl.LineWidth(1.0)
-
-  -- draw header  
-  gl.Text(LT.YellowStr..&quot;Use Mod's LuaUI?&quot;, frame.midX, frame.maxY + 4, 24, &quot;oc&quot;)
-
-  -- draw trailer
-  local tt = (overButton and overButton.tooltip) or &quot;Pick one&quot;
-  gl.Text(tt, frame.midX, frame.minY - 28, 18, &quot;oc&quot;)
-
-  -- draw buttons
-  gl.Color(0.3, 0.3, 0.5, 0.9)
-  for _,b in pairs(buttons) do
-    DrawButton(b)
-  end
-
-  -- draw borders
-  gl.Color(1, 1, 1)
-  for _,b in pairs(buttons) do
-    DrawBorder(b)
-  end
-
-  -- draw labels
-  gl.Color(0, 1, 0)
-  for name,b in pairs(buttons) do
-    gl.Text(LT.GreenStr..name, b.midX, b.textY, b.textSize, &quot;c&quot;)
-  end
-  
-  -- draw highlight
-  if (overButton) then
-    gl.Blending(LT.GL.SRC_ALPHA, LT.GL.ONE)
-    if (lmb) then
-      gl.Color(1, 0, 0, 0.5)
-    else 
-      gl.Color(0, 0, 1, 0.5)
-    end
-    DrawButton(overButton)
-    gl.Blending(LT.GL.SRC_ALPHA, LT.GL.ONE_MINUS_SRC_ALPHA)
-  end
-end
-
-
-function KeyPress(key)
-  local ks = LT.KEYSYMS
-  if (key == ks.ESCAPE) then   -- No
-    Spring.Echo(&quot;Not using Mod's LuaUI&quot;)
-    LoadUserLuaUI()
-    return true
-  end
-  return false  --  ??? true?
-end
-
-
-function KeyRelease()
-  return false  --  ??? true?
-end
-
-
-function MousePress(x, y, button)
-  return true  --  eat them
-end
-
-
-function MouseRelease(x, y, button)
-  if (not next(frame)) then
-    return -1
-  end
-  if (button == 1) then
-    if (MouseOverButton(x, y, buttons.No)) then
-      SaveModPerm(nil)
-      LoadUserLuaUI()
-    elseif (MouseOverButton(x, y, buttons.Yes)) then
-      SaveModPerm(nil)
-      LoadModLuaUI()
-    elseif (MouseOverButton(x, y, buttons.Never)) then
-      SaveModPerm(false)
-      LoadUserLuaUI()
-    elseif (MouseOverButton(x, y, buttons.Always)) then
-      SaveModPerm(true)
-      LoadModLuaUI()
-    end
-  end
-  return -1  --  not a command click
-end
-
-
-function IsAbove(x, y)
-  if (not next(frame)) then
-    return false
-  end
-  for _,b in pairs(buttons) do
-    if (MouseOverButton(x, y, b)) then
-      return true
-    end
-  end
-  return true
-end
-
-
-function GetTooltip(x, y)
-  if (not next(frame)) then
-    return false
-  end
-  for _,b in pairs(buttons) do
-    if (MouseOverButton(x, y, b)) then
-      return b.tooltip
-    end
-  end
-  return tooltip
-end
-
-
---------------------------------------------------------------------------------

Modified: trunk/game/LuaUI/widgets.lua
===================================================================
--- trunk/game/LuaUI/widgets.lua	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/game/LuaUI/widgets.lua	2008-06-08 23:38:52 UTC (rev 6002)
@@ -25,12 +25,11 @@
 include(&quot;savetable.lua&quot;)
 
 
-local gl = Spring.Draw
+local gl = gl
 
 local ORDER_FILENAME     = LUAUI_DIRNAME .. 'Config/widget_order.lua'
 local CONFIG_FILENAME    = LUAUI_DIRNAME .. 'Config/widget_data.lua'
 local WIDGET_DIRNAME     = LUAUI_DIRNAME .. 'Widgets/'
-local MOD_WIDGET_DIRNAME = MODUI_DIRNAME .. 'Widgets/'
 
 local SELECTOR_BASENAME = 'selector.lua'
 

Deleted: trunk/game/gui.lua
===================================================================
--- trunk/game/gui.lua	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/game/gui.lua	2008-06-08 23:38:52 UTC (rev 6002)
@@ -1,150 +0,0 @@
---------------------------------------------------------------------------------
---------------------------------------------------------------------------------
---
---  file:    gui.lua
---  brief:   entry point for the user LuaUI, can redirect to a mod's LuaUI
---  author:  Dave Rodgers
---
---  Copyright (C) 2007.
---  Licensed under the terms of the GNU GPL, v2 or later.
---
---------------------------------------------------------------------------------
---------------------------------------------------------------------------------
-
-LUAUI_VERSION = &quot;LuaUI v0.2&quot;
-
---------------------------------------------------------------------------------
---------------------------------------------------------------------------------
-
-if (gl) then
-  Spring.Draw = gl  --  backwards compatibility, 0.74b3 did not have 'gl'
-end
-
-
---------------------------------------------------------------------------------
---------------------------------------------------------------------------------
-
-LUAUI_DIRNAME   = 'LuaUI/'
-do
-  -- use a versionned directory name if it exists
-  local sansslash = string.sub(LUAUI_DIRNAME, 1, -2)
-  local versiondir = sansslash .. '-' .. Game.version .. '/'
-  if (VFS.FileExists(versiondir  .. 'main.lua', VFS.RAW_ONLY)) then
-    LUAUI_DIRNAME = versiondir
-  end
-end
-print('Using LUAUI_DIRNAME = ' .. LUAUI_DIRNAME)
-
-
-USER_FILENAME   = LUAUI_DIRNAME .. 'main.lua'
-CHOOSE_FILENAME = LUAUI_DIRNAME .. 'modui_dialog.lua'
-PERM_FILENAME   = LUAUI_DIRNAME .. 'Config/modui_list.lua'
-
-MODUI_DIRNAME   = 'ModUI/'  --  should version this too, exceptions?
-MOD_FILENAME    = MODUI_DIRNAME .. 'main.lua'
-
-
-VFS.DEF_MODE = VFS.RAW_FIRST
-
-
---------------------------------------------------------------------------------
---------------------------------------------------------------------------------
-
-local function CleanNameSpace()
-	MOD_FILENAME    = nil
-	USER_FILENAME   = nil
-	PERM_FILENAME   = nil
-	CHOOSE_FILENAME = nil
-end
-
-
---------------------------------------------------------------------------------
---------------------------------------------------------------------------------
---
--- get the mod's GUI permission state
---
-
-local loadFromMod = nil
-
-do
-  -- always bring up the mod dialog if CTRL is pressed
-  local alt,ctrl,meta,shift = Spring.GetModKeyState()
-  if (not ctrl) then  
-    local chunk, err = loadfile(PERM_FILENAME)
-    if (chunk ~= nil) then
-      local tmp = {}
-      setfenv(chunk, tmp)
-      local perms = chunk()
-      if (perms) then
-        loadFromMod = perms[Game.modName]
-      end
-    end
-  end
-end
-
-
---------------------------------------------------------------------------------
-
-local text
-
-
-if (loadFromMod ~= false) then
-  text = VFS.LoadFile(MOD_FILENAME, VFS.ZIP_ONLY)
-  if (text == nil) then
-    loadFromMod = false
-  end
-end
-
-
-if (loadFromMod == nil) then
-  -- setup the mod selection UI
-  text = VFS.LoadFile(CHOOSE_FILENAME, VFS.RAW_ONLY)
-  if (text == nil) then
-    Spring.Echo('Failed to load ' .. CHOOSE_FILENAME .. ': (' .. err .. ')')
-  else
-    local chunk, err = loadstring(text)
-    if (chunk == nil) then
-      Spring.Echo('Failed to load ' .. CHOOSE_FILENAME .. ': (' .. err .. ')')
-    else
-      CleanNameSpace()
-      chunk()
-      return
-    end
-  end
-elseif (loadFromMod) then
-  -- load the mod's UI
-  local chunk, err = loadstring(text)
-  if (chunk == nil) then
-    Spring.Echo('Failed to load ' .. MOD_FILENAME .. ': (' .. err .. ')')
-  else
-    CleanNameSpace()
-    chunk()
-    return
-  end
-end
-
-
--------------------------------------------------------------------------------- 
--------------------------------------------------------------------------------- 
---
--- load the user's UI
---
-
-do
-  text = VFS.LoadFile(USER_FILENAME, VFS.RAW_ONLY)
-  if (text == nil) then
-    Script.Kill('Failed to load ' .. USER_FILENAME)
-  end
-  local chunk, err = loadstring(text)
-  if (chunk == nil) then
-    Script.Kill('Failed to load ' .. USER_FILENAME .. ' (' .. err .. ')')
-  else
-    CleanNameSpace()
-    chunk()
-    return
-  end
-end
-
-
--------------------------------------------------------------------------------- 
--------------------------------------------------------------------------------- 

Copied: trunk/game/luaui.lua (from rev 5983, trunk/game/gui.lua)
===================================================================
--- trunk/game/luaui.lua	                        (rev 0)
+++ trunk/game/luaui.lua	2008-06-08 23:38:52 UTC (rev 6002)
@@ -0,0 +1,60 @@
+--------------------------------------------------------------------------------
+--------------------------------------------------------------------------------
+--
+--  file:    gui.lua
+--  brief:   entry point for the user LuaUI, can redirect to a mod's LuaUI
+--  author:  Dave Rodgers
+--
+--  Copyright (C) 2008.
+--  Licensed under the terms of the GNU GPL, v2 or later.
+--
+--------------------------------------------------------------------------------
+--------------------------------------------------------------------------------
+
+LUAUI_VERSION = &quot;LuaUI v0.3&quot;
+
+LUAUI_DIRNAME = 'LuaUI/'
+
+VFS.DEF_MODE = VFS.RAW_FIRST
+
+local STARTUP_FILENAME = LUAUI_DIRNAME .. 'main.lua'
+
+
+--------------------------------------------------------------------------------
+--------------------------------------------------------------------------------
+
+do
+  -- use a versionned directory name if it exists
+  local sansslash = string.sub(LUAUI_DIRNAME, 1, -2)
+  local versiondir = sansslash .. '-' .. Game.version .. '/'
+  if (VFS.FileExists(versiondir  .. 'main.lua', VFS.RAW_ONLY)) then
+    LUAUI_DIRNAME = versiondir
+  end
+end
+
+Spring.Echo('Using LUAUI_DIRNAME = ' .. LUAUI_DIRNAME)
+
+
+--------------------------------------------------------------------------------
+--------------------------------------------------------------------------------
+--
+-- load the user's UI
+--
+
+do
+  text = VFS.LoadFile(STARTUP_FILENAME, VFS.RAW_ONLY)
+  if (text == nil) then
+    Script.Kill('Failed to load ' .. STARTUP_FILENAME)
+  end
+  local chunk, err = loadstring(text)
+  if (chunk == nil) then
+    Script.Kill('Failed to load ' .. STARTUP_FILENAME .. ' (' .. err .. ')')
+  else
+    chunk()
+    return
+  end
+end
+
+
+-------------------------------------------------------------------------------- 
+-------------------------------------------------------------------------------- 

Modified: trunk/installer/builddata/maphelper/MapOptions.lua
===================================================================
--- trunk/installer/builddata/maphelper/MapOptions.lua	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/installer/builddata/maphelper/MapOptions.lua	2008-06-08 23:38:52 UTC (rev 6002)
@@ -1,3 +1,15 @@
+--------------------------------------------------------------------------------
+--------------------------------------------------------------------------------
+--
+--  file:    MapOptions.lua
+--  brief:   example MapOptions.lua
+--  author:  Dave Rodgers
+--
+--  Copyright (C) 2008.
+--  Licensed under the terms of the GNU GPL, v2 or later.
+--
+--------------------------------------------------------------------------------
+--------------------------------------------------------------------------------
 
 --  Custom Options Definition Table format
 
@@ -17,7 +29,6 @@
 --  step:     quantization step, aligned to the def value
 --  maxlen:   the maximum string length for string options
 --  items:    array of item strings for list options
---  scope:    'all', 'player', 'team', 'allyteam'      &lt;&lt;&lt; not supported yet &gt;&gt;&gt;
 --
 
 --------------------------------------------------------------------------------
@@ -28,7 +39,7 @@
 
 local mapInfo = VFS.Include('maphelper/mapinfo.lua')
 
-if (not mapInfo.autooptions) then
+if (not mapInfo.defaultoptions) then
   return {}
 end
 
@@ -39,6 +50,8 @@
 --  Option creation utilities
 --
 
+local options = {}
+
 local function ItemNumbers(min, max, step)
   local t = {}
   for i = min,max,step do
@@ -92,26 +105,30 @@
 
 --------------------------------------------------------------------------------
 --------------------------------------------------------------------------------
---
---  Get our defaults from the map config file  (if available)
---
 
-local defGravity  = mapInfo.gravity         or 130.0
-local defMaxMetal = mapInfo.maxmetal        or 0.02
-local defTidal    = mapInfo.tidalstrength   or 0.0
-local defMexRad   = mapInfo.extractorradius or 500.0
-
-local atmo = mapInfo.atmosphere or {}
-local defMinWind  = atmo.minwind or 5.0
-local defMaxWind  = atmo.maxwind or 25.0
-
-
 --------------------------------------------------------------------------------
 --------------------------------------------------------------------------------
 --
 --  Example MapOptions.lua 
 --
 
+local optionDefs = {
+  gravity = {
+    'gravity', 'Gravity', 'Map Gravity',
+    NumberOption,  mapInfo.gravity, mapDefaults.gravity, 1.0, 1000.0
+  },
+  notdeformable = {
+    'notdeformable', 'NotDeformable', 
+    BoolOption, mapInfo.hardness, true
+  }
+
+for _, opt in ipairs(selOpts) do
+  local optDef = optionDefs[opt]
+  if (optDef) then
+    optDef[4](optDef)
+  end
+end
+
 local options = {
   BoolOption(
     'softground', 'SoftGround', 'Allow for terrain height map to be adjusted',

Modified: trunk/installer/builddata/maphelper/maphelper/mapinfo.lua
===================================================================
--- trunk/installer/builddata/maphelper/maphelper/mapinfo.lua	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/installer/builddata/maphelper/maphelper/mapinfo.lua	2008-06-08 23:38:52 UTC (rev 6002)
@@ -62,13 +62,14 @@
 
 --------------------------------------------------------------------------------
 
-if (Spring.GetMapOptions and mapInfo.autooptions) then
+if (Spring.GetMapOptions and mapInfo.defaultoptions) then
   local optsFunc = VFS.Include('maphelper/applyopts.lua')
   optsFunc(mapInfo)
 end
 
 
 --------------------------------------------------------------------------------
+--------------------------------------------------------------------------------
 
 return mapInfo
 

Modified: trunk/installer/make_luaui_nsh.py
===================================================================
--- trunk/installer/make_luaui_nsh.py	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/installer/make_luaui_nsh.py	2008-06-08 23:38:52 UTC (rev 6002)
@@ -5,14 +5,14 @@
 # !ifdef INSTALL
 #
 #   SetOutPath &quot;$INSTDIR&quot;
-#   File &quot;..\game\gui.lua&quot;
+#   File &quot;..\game\luaui.lua&quot;
 # 
 #   SetOutPath &quot;$INSTDIR\LuaUI&quot;
 #   File /r /x .svn /x Config\*.lua &quot;..\game\LuaUI\*.*&quot;
 # 
 # !else
 #
-#   Delete &quot;$INSTDIR\gui.lua&quot;
+#   Delete &quot;$INSTDIR\luaui.lua&quot;
 #   RmDir /r &quot;$INSTDIR\LuaUI&quot;
 #
 # !endif
@@ -62,7 +62,7 @@
 
 print('')
 print('  SetOutPath &quot;$INSTDIR&quot;')
-print('  File &quot;..\\game\\gui.lua&quot;')
+print('  File &quot;..\\game\\luaui.lua&quot;')
 print('')
 for d in dirs:
   print('  SetOutPath &quot;$INSTDIR\\' + osName(d) + '&quot;')
@@ -73,7 +73,7 @@
 print('!else')
 
 print('')
-print('  Delete &quot;$INSTDIR\\gui.lua&quot;')
+print('  Delete &quot;$INSTDIR\\luaui.lua&quot;')
 print('')
 for d in dirs:
   for f in dirs[d]:

Modified: trunk/installer/sections/luaui.nsh
===================================================================
--- trunk/installer/sections/luaui.nsh	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/installer/sections/luaui.nsh	2008-06-08 23:38:52 UTC (rev 6002)
@@ -4,7 +4,7 @@
   Delete &quot;$INSTDIR\LuaUI\unitdefs.lua&quot;
 
   SetOutPath &quot;$INSTDIR&quot;
-  File &quot;..\game\gui.lua&quot;
+  File &quot;..\game\luaui.lua&quot;
 
   SetOutPath &quot;$INSTDIR\LuaUI\Images\&quot;
   File &quot;..\game\LuaUI\Images\players.png&quot;
@@ -110,7 +110,7 @@
 
 !else
 
-  Delete &quot;$INSTDIR\gui.lua&quot;
+  Delete &quot;$INSTDIR\luaui.lua&quot;
 
   Delete &quot;$INSTDIR\LuaUI\Images\players.png&quot;
   Delete &quot;$INSTDIR\LuaUI\Images\highlight_strip.png&quot;

Modified: trunk/rts/Game/StartScripts/CommanderScript.cpp
===================================================================
--- trunk/rts/Game/StartScripts/CommanderScript.cpp	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/rts/Game/StartScripts/CommanderScript.cpp	2008-06-08 23:38:52 UTC (rev 6002)
@@ -86,7 +86,7 @@
 				const std::string&amp; sideName  = it-&gt;first;
 				const std::string&amp; startUnit = it-&gt;second;
 				if (startUnit.length() == 0) {
-					throw content_error (
+					throw content_error(
 						&quot;Unable to load a commander for side: &quot; + sideName
 					);
 				}
@@ -117,10 +117,13 @@
 		const std::string su2 = StringToLower(side2.GetString(&quot;startUnit&quot;, su1));
 
 		if (su1.length() == 0) {
-			throw content_error (&quot;Unable to load a startUnit for the first side&quot;);
+			throw content_error(&quot;Unable to load a startUnit for the first side&quot;);
 		}
 		
 		MapParser mapParser(stupidGlobalMapname);
+		if (!mapParser.IsValid()) {
+			throw content_error(&quot;MapParser: &quot; + mapParser.GetErrorLog());
+		}
 		float3 startPos0(1000.0f, 80.0f, 1000.0f);
 		float3 startPos1(1200.0f, 80.0f, 1200.0f);
 		mapParser.GetStartPos(0, startPos0);

Modified: trunk/rts/Game/StartScripts/CommanderScript2.cpp
===================================================================
--- trunk/rts/Game/StartScripts/CommanderScript2.cpp	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/rts/Game/StartScripts/CommanderScript2.cpp	2008-06-08 23:38:52 UTC (rev 6002)
@@ -57,6 +57,9 @@
 		}
 
 		MapParser mapParser(stupidGlobalMapname);
+		if (!mapParser.IsValid()) {
+			throw content_error(&quot;MapParser: &quot; + mapParser.GetErrorLog());
+		}
 		float3 startPos0(1000.0f, 80.0f, 1000.0f);
 		float3 startPos1(1200.0f, 80.0f, 1200.0f);
 		mapParser.GetStartPos(0, startPos0);

Modified: trunk/rts/Game/StartScripts/GlobalAITestScript.cpp
===================================================================
--- trunk/rts/Game/StartScripts/GlobalAITestScript.cpp	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/rts/Game/StartScripts/GlobalAITestScript.cpp	2008-06-08 23:38:52 UTC (rev 6002)
@@ -63,6 +63,9 @@
 			}
 
 			MapParser mapParser(stupidGlobalMapname);
+			if (!mapParser.IsValid()) {
+				throw content_error(&quot;MapParser: &quot; + mapParser.GetErrorLog());
+			}
 			float3 startPos0(1000.0f, 80.0f, 1000.0f);
 			float3 startPos1(1200.0f, 80.0f, 1200.0f);
 			mapParser.GetStartPos(0, startPos0);

Modified: trunk/rts/Game/StartScripts/SpawnScript.cpp
===================================================================
--- trunk/rts/Game/StartScripts/SpawnScript.cpp	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/rts/Game/StartScripts/SpawnScript.cpp	2008-06-08 23:38:52 UTC (rev 6002)
@@ -50,7 +50,9 @@
 		}
 
 		MapParser mapParser(stupidGlobalMapname);
-
+		if (!mapParser.IsValid()) {
+			throw content_error(&quot;MapParser: &quot; + mapParser.GetErrorLog());
+		}
 		float3 startPos0(1000.0f, 80.0f, 1000.0f);
 		mapParser.GetStartPos(0, startPos0);
 

Modified: trunk/rts/Game/Team.h
===================================================================
--- trunk/rts/Game/Team.h	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/rts/Game/Team.h	2008-06-08 23:38:52 UTC (rev 6002)
@@ -113,25 +113,25 @@
 
 		/// Change structure from host endian to little endian or vice versa.
 		void swab() {
-			metalUsed = swabfloat(metalUsed);
-			energyUsed = swabfloat(energyUsed);
-			metalProduced = swabfloat(metalProduced);
-			energyProduced = swabfloat(energyProduced);
-			metalExcess = swabfloat(metalExcess);
-			energyExcess = swabfloat(energyExcess);
-			metalReceived = swabfloat(metalReceived);
-			energyReceived = swabfloat(energyReceived);
-			metalSent = swabfloat(metalSent);
-			energySent = swabfloat(energySent);
-			damageDealt = swabfloat(damageDealt);
-			damageReceived = swabfloat(damageReceived);
-			unitsProduced = swabdword(unitsProduced);
-			unitsDied = swabdword(unitsDied);
-			unitsReceived = swabdword(unitsReceived);
-			unitsSent = swabdword(unitsSent);
-			unitsCaptured = swabdword(unitsCaptured);
+			metalUsed        = swabfloat(metalUsed);
+			energyUsed       = swabfloat(energyUsed);
+			metalProduced    = swabfloat(metalProduced);
+			energyProduced   = swabfloat(energyProduced);
+			metalExcess      = swabfloat(metalExcess);
+			energyExcess     = swabfloat(energyExcess);
+			metalReceived    = swabfloat(metalReceived);
+			energyReceived   = swabfloat(energyReceived);
+			metalSent        = swabfloat(metalSent);
+			energySent       = swabfloat(energySent);
+			damageDealt      = swabfloat(damageDealt);
+			damageReceived   = swabfloat(damageReceived);
+			unitsProduced    = swabdword(unitsProduced);
+			unitsDied        = swabdword(unitsDied);
+			unitsReceived    = swabdword(unitsReceived);
+			unitsSent        = swabdword(unitsSent);
+			unitsCaptured    = swabdword(unitsCaptured);
 			unitsOutCaptured = swabdword(unitsOutCaptured);
-			unitsKilled = swabdword(unitsKilled);
+			unitsKilled      = swabdword(unitsKilled);
 		}
 	};
 	Statistics currentStats;

Modified: trunk/rts/Game/UI/GuiHandler.cpp
===================================================================
--- trunk/rts/Game/UI/GuiHandler.cpp	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/rts/Game/UI/GuiHandler.cpp	2008-06-08 23:38:52 UTC (rev 6002)
@@ -59,7 +59,7 @@
 CGuiHandler* guihandler = NULL;
 
 
-const char* CGuiHandler::luaUiFile = &quot;gui.lua&quot;;
+const char* CGuiHandler::luaUiFile = &quot;luaui.lua&quot;;
 
 
 CGuiHandler::CGuiHandler()

Modified: trunk/rts/Game/UI/GuiHandler.h
===================================================================
--- trunk/rts/Game/UI/GuiHandler.h	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/rts/Game/UI/GuiHandler.h	2008-06-08 23:38:52 UTC (rev 6002)
@@ -62,7 +62,7 @@
  		bool GetGatherMode() const { return gatherMode; }
  		void SetGatherMode(bool value) { gatherMode = value; }
 		
-		bool GetOutlineFonts() const {return outlineFonts;};
+		bool GetOutlineFonts() const { return outlineFonts; }
 
 		int  GetDefaultCommand(int x, int y) const;
 

Modified: trunk/rts/Game/UI/LuaUI.cpp
===================================================================
--- trunk/rts/Game/UI/LuaUI.cpp	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/rts/Game/UI/LuaUI.cpp	2008-06-08 23:38:52 UTC (rev 6002)
@@ -132,7 +132,7 @@
 	haveWorldTooltip = false;
 	haveMapDrawCmd = false;
 
-	const string code = LoadFile(&quot;gui.lua&quot;);
+	const string code = LoadFile(&quot;luaui.lua&quot;);
 	if (code.empty()) {
 		KillLua();
 		return;
@@ -188,7 +188,7 @@
 
 	lua_settop(L, 0);
 
-	if (!LoadCode(code, &quot;gui.lua&quot;)) {
+	if (!LoadCode(code, &quot;luaui.lua&quot;)) {
 		KillLua();
 		return;
 	}

Modified: trunk/rts/Lua/LuaSyncedCtrl.cpp
===================================================================
--- trunk/rts/Lua/LuaSyncedCtrl.cpp	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/rts/Lua/LuaSyncedCtrl.cpp	2008-06-08 23:38:52 UTC (rev 6002)
@@ -121,6 +121,7 @@
 	REGISTER_LUA_CFUNC(SetUnitLosState);
 	REGISTER_LUA_CFUNC(SetUnitCloak);
 	REGISTER_LUA_CFUNC(SetUnitStealth);
+	REGISTER_LUA_CFUNC(SetUnitSonarStealth);
 	REGISTER_LUA_CFUNC(SetUnitAlwaysVisible);
 	REGISTER_LUA_CFUNC(SetUnitMetalExtraction);
 	REGISTER_LUA_CFUNC(SetUnitBuildSpeed);
@@ -1337,6 +1338,21 @@
 }
 
 
+int LuaSyncedCtrl::SetUnitSonarStealth(lua_State* L)
+{
+	CUnit* unit = ParseUnit(L, __FUNCTION__, 1);
+	if (unit == NULL) {
+		return 0;
+	}
+	const int args = lua_gettop(L); // number of arguments
+	if ((args &lt; 2) || !lua_isboolean(L, 2)) {
+		luaL_error(L, &quot;Incorrect arguments to SetUnitSonarStealth()&quot;);
+	}
+	unit-&gt;sonarStealth = lua_toboolean(L, 2);
+	return 0;
+}
+
+
 int LuaSyncedCtrl::SetUnitAlwaysVisible(lua_State* L)
 {
 	CUnit* unit = ParseUnit(L, __FUNCTION__, 1);

Modified: trunk/rts/Lua/LuaSyncedCtrl.h
===================================================================
--- trunk/rts/Lua/LuaSyncedCtrl.h	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/rts/Lua/LuaSyncedCtrl.h	2008-06-08 23:38:52 UTC (rev 6002)
@@ -60,6 +60,7 @@
 		static int SetUnitLosState(lua_State* L);
 		static int SetUnitCloak(lua_State* L);
 		static int SetUnitStealth(lua_State* L);
+		static int SetUnitSonarStealth(lua_State* L);
 		static int SetUnitAlwaysVisible(lua_State* L);
 		static int SetUnitMetalExtraction(lua_State* L);
 		static int SetUnitBuildSpeed(lua_State* L);

Modified: trunk/rts/Lua/LuaSyncedRead.cpp
===================================================================
--- trunk/rts/Lua/LuaSyncedRead.cpp	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/rts/Lua/LuaSyncedRead.cpp	2008-06-08 23:38:52 UTC (rev 6002)
@@ -1130,7 +1130,8 @@
 			count++;
 			lua_pushnumber(L, count);
 			lua_newtable(L); {
-				HSTR_PUSH_NUMBER(L, &quot;frame&quot;,            (start + 1) * statsFrames);
+				HSTR_PUSH_NUMBER(L, &quot;time&quot;,             i * CTeam::statsPeriod);
+				HSTR_PUSH_NUMBER(L, &quot;frame&quot;,            i * statsFrames);
 				HSTR_PUSH_NUMBER(L, &quot;metalUsed&quot;,        stats.metalUsed);
 				HSTR_PUSH_NUMBER(L, &quot;metalProduced&quot;,    stats.metalProduced);
 				HSTR_PUSH_NUMBER(L, &quot;metalExcess&quot;,      stats.metalExcess);
@@ -4140,7 +4141,7 @@
 	}
 	float3 dir(0,0,0);
 	float3 pos(0,0,0);
-	localModel-&gt;GetRawEmitDirPos(piece,pos,dir);
+	localModel-&gt;GetRawEmitDirPos(piece, pos, dir);
 	pos = unit-&gt;pos + unit-&gt;frontdir * pos.z
 	                + unit-&gt;updir    * pos.y
 	                + unit-&gt;rightdir * pos.x;

Modified: trunk/rts/Lua/LuaUnitDefs.cpp
===================================================================
--- trunk/rts/Lua/LuaUnitDefs.cpp	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/rts/Lua/LuaUnitDefs.cpp	2008-06-08 23:38:52 UTC (rev 6002)
@@ -724,7 +724,8 @@
 
 	ADD_FLOAT(&quot;seismicSignature&quot;, ud.seismicSignature);
 
-	ADD_BOOL(&quot;stealth&quot;, ud.stealth);
+	ADD_BOOL(&quot;stealth&quot;,      ud.stealth);
+	ADD_BOOL(&quot;sonarStealth&quot;, ud.sonarStealth);
 
 	ADD_FLOAT(&quot;mass&quot;, ud.mass);
 

Modified: trunk/rts/Map/MapInfo.cpp
===================================================================
--- trunk/rts/Map/MapInfo.cpp	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/rts/Map/MapInfo.cpp	2008-06-08 23:38:52 UTC (rev 6002)
@@ -33,14 +33,15 @@
 const CMapInfo* mapInfo;
 
 
-CMapInfo::CMapInfo(const string&amp; mapname)
+CMapInfo::CMapInfo(const string&amp; mapName)
 {
-	map.name = mapname;
+	map.name = mapName;
 
-	MapParser mapParser(mapname);
+	MapParser mapParser(mapName);
 	if (!mapParser.IsValid()) {
-		logOutput.Print(mapParser.GetErrorLog());
+		throw content_error(&quot;MapInfo: &quot; + mapParser.GetErrorLog());
 	}
+
 	LuaTable mapTbl = mapParser.GetRoot();
 	mapRoot = &mapTbl;
 
@@ -157,17 +158,17 @@
 
 	water.repeatX = wt.GetFloat(&quot;repeatX&quot;, 0.0f);
 	water.repeatY = wt.GetFloat(&quot;repeatY&quot;, 0.0f);
-	water.damage  = wt.GetFloat(&quot;damage&quot;, 0.0f) * (16.0f / 30.0f);
+	water.damage  = wt.GetFloat(&quot;damage&quot;,  0.0f) * (16.0f / 30.0f);
 
-	water.absorb       = wt.GetFloat3(&quot;absorb&quot;,       float3(0.0f, 0.0f, 0.0f));
-	water.baseColor    = wt.GetFloat3(&quot;baseColor&quot;,    float3(0.0f, 0.0f, 0.0f));
-	water.minColor     = wt.GetFloat3(&quot;minColor&quot;,     float3(0.0f, 0.0f, 0.0f));
+	water.absorb    = wt.GetFloat3(&quot;absorb&quot;,    float3(0.0f, 0.0f, 0.0f));
+	water.baseColor = wt.GetFloat3(&quot;baseColor&quot;, float3(0.0f, 0.0f, 0.0f));
+	water.minColor  = wt.GetFloat3(&quot;minColor&quot;,  float3(0.0f, 0.0f, 0.0f));
 
 	water.surfaceColor = wt.GetFloat3(&quot;surfaceColor&quot;, float3(0.75f, 0.8f, 0.85f));
 	water.surfaceAlpha = wt.GetFloat(&quot;surfaceAlpha&quot;,  0.55f);
 
-	water.planeColor   = wt.GetFloat3(&quot;planeColor&quot;,   float3(0.0f, 0.4f, 0.0f));
-	hasWaterPlane = wt.KeyExists(&quot;planeColor&quot;);
+	water.planeColor = wt.GetFloat3(&quot;planeColor&quot;, float3(0.0f, 0.4f, 0.0f));
+	hasWaterPlane    = wt.KeyExists(&quot;planeColor&quot;);
 
 	water.specularColor  = wt.GetFloat3(&quot;specularColor&quot;, light.groundSunColor);
 	water.specularFactor = wt.GetFloat(&quot;specularFactor&quot;, 20.0f);
@@ -176,8 +177,8 @@
 	water.fresnelMax   = wt.GetFloat(&quot;fresnelMax&quot;,   0.3f);
 	water.fresnelPower = wt.GetFloat(&quot;fresnelPower&quot;, 4.0f);
 
-	water.texture       = wt.GetString(&quot;texture&quot;, &quot;&quot;);
-	water.foamTexture   = wt.GetString(&quot;foamTexture&quot;, &quot;&quot;);
+	water.texture       = wt.GetString(&quot;texture&quot;,       &quot;&quot;);
+	water.foamTexture   = wt.GetString(&quot;foamTexture&quot;,   &quot;&quot;);
 	water.normalTexture = wt.GetString(&quot;normalTexture&quot;, &quot;&quot;);
 
 	// use 'resources.lua' for missing fields  (our the engine defaults)

Modified: trunk/rts/Map/MapInfo.h
===================================================================
--- trunk/rts/Map/MapInfo.h	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/rts/Map/MapInfo.h	2008-06-08 23:38:52 UTC (rev 6002)
@@ -27,7 +27,7 @@
 {
 public:
 
-	CMapInfo(const std::string&amp; mapname);
+	CMapInfo(const std::string&amp; mapName);
 	~CMapInfo();
 
 	/* The settings are just public members because:

Modified: trunk/rts/Map/MapParser.cpp
===================================================================
--- trunk/rts/Map/MapParser.cpp	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/rts/Map/MapParser.cpp	2008-06-08 23:38:52 UTC (rev 6002)
@@ -12,8 +12,7 @@
 string MapParser::GetMapConfigName(const string&amp; mapName)
 {
 	if (mapName.length() &lt; 3) {
-		throw runtime_error(&quot;CMapInfo::GetMapConfigName(): mapName '&quot;
-		                         + mapName + &quot;' too short&quot;);
+		return &quot;&quot;;
 	}
 
 	const string extension = mapName.substr(mapName.length() - 3);
@@ -26,8 +25,7 @@
 		       mapName.substr(0, mapName.find_last_of('.')) + &quot;.smd&quot;;
 	}
 	else {
-		throw runtime_error(&quot;MapParser::GetMapConfigName(): Unknown extension: &quot;
-		                    + extension);
+		return &quot;&quot;;
 	}
 }
 
@@ -36,11 +34,6 @@
 {
 	const string mapConfig = GetMapConfigName(mapName);
 
-	CFileHandler fh(mapConfig, SPRING_VFS_MAP);
-	if (!fh.FileExists()) {
-		throw runtime_error(&quot;MapParser() missing file: &quot; + mapConfig);
-	}
-
 	parser = SAFE_NEW LuaParser(&quot;maphelper/mapinfo.lua&quot;,
 															SPRING_VFS_MAP_BASE, SPRING_VFS_MAP_BASE);
 	parser-&gt;GetTable(&quot;Map&quot;);
@@ -57,7 +50,7 @@
 	parser-&gt;EndTable();
 #endif
 	if (!parser-&gt;Execute()) {
-		throw content_error(&quot;MapParser error: &quot; + parser-&gt;GetErrorLog());
+		// do nothing
 	}
 }
 

Modified: trunk/rts/Map/MetalMap.cpp
===================================================================
--- trunk/rts/Map/MetalMap.cpp	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/rts/Map/MetalMap.cpp	2008-06-08 23:38:52 UTC (rev 6002)
@@ -5,7 +5,7 @@
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;mmgr.h&quot;
 
-CR_BIND(CMetalMap,(0,0,0,0.0));
+CR_BIND(CMetalMap,(NULL, 0, 0, 0.0f));
 
 CR_REG_METADATA(CMetalMap,(
 				CR_MEMBER(extractionMap)
@@ -13,20 +13,20 @@
 
 /*
 Constructor
-Reciving a map over all metal, and creating a map over extraction.
+Receiving a map over all metal, and creating a map over extraction.
 */
-CMetalMap::CMetalMap(unsigned char *map, int sizex, int sizez, float metalscale)
+CMetalMap::CMetalMap(unsigned char* map,
+                     int _sizeX, int _sizeZ, float _metalScale)
+: metalMap(map),
+  sizeX(_sizeX),
+  sizeZ(_sizeZ),
+  metalScale(_metalScale)
 {
-	this-&gt;metalMap = map;
-	this-&gt;sizex = sizex;
-	this-&gt;sizez = sizez;
-	this-&gt;metalscale = metalscale;
-	
-	//Creating an empty map over extraction.
-//	extractionMap = SAFE_NEW float[sizex * sizez];
-	extractionMap.resize(sizex * sizez,0.0);
+	// Creating an empty map over extraction.
+//	extractionMap = SAFE_NEW float[sizeX * sizeZ];
+	extractionMap.resize(sizeX * sizeZ, 0.0f);
 //	int i;
-//	for(i = 0; i &lt; (sizex * sizez); i++) {
+//	for(i = 0; i &lt; (sizeX * sizeZ); i++) {
 //		extractionMap[i] = 0.0f;
 //	}
 	
@@ -36,17 +36,17 @@
 		/* Swap the green and blue channels. making metal go
 		   black -&gt; blue -&gt; cyan,
 		   rather than the usual black -&gt; green -&gt; cyan. */
-		for(int a=0;a&lt;256;++a){
-			metalPal[a*3+0]=a;
-			metalPal[a*3+1]=std::max(0,a*2-255);
-			metalPal[a*3+2]=std::min(255,a*2);
+		for (int a = 0; a &lt; 256; ++a) {
+			metalPal[a * 3 + 0] = a;
+			metalPal[a * 3 + 1] = std::max(0, a * 2 - 255);
+			metalPal[a * 3 + 2] = std::min(255, a * 2);
 		}
 	}
 	else {
-		for(int a=0;a&lt;256;++a){
-			metalPal[a*3+0]=a;
-			metalPal[a*3+1]=std::min(255,a*2);
-			metalPal[a*3+2]=std::max(0,a*2-255);//a/2+((a*4)&amp;127);
+		for(int a = 0; a &lt; 256; ++a) {
+			metalPal[a * 3 + 0] = a;
+			metalPal[a * 3 + 1] = std::min(255, a * 2);
+			metalPal[a * 3 + 2] = std::max(0, a * 2 - 255);
 		}
 	}
 	
@@ -64,37 +64,34 @@
 }
 
 
+static inline void ClampInt(int&amp; var, int min, int maxPlusOne)
+{
+	if (var &lt; min) {
+		var = min;
+	} else if (var &gt;= maxPlusOne) {
+		var = maxPlusOne - 1;
+	}
+}
+
+
 /*
 Gives the amount of metal over an area.
 */
 float CMetalMap::getMetalAmount(int x1, int z1, int x2, int z2) 
 {
-	if(x1&lt;0)
-		x1=0;
-	else if(x1&gt;=sizex)
-		x1=sizex-1;
-	if(x2&lt;0)
-		x2=0;
-	else if(x2&gt;=sizex)
-		x2=sizex-1;
-
-	if(z1&lt;0)
-		z1=0;
-	else if(z1&gt;=sizez)
-		z1=sizez-1;
-	if(z2&lt;0)
-		z2=0;
-	else if(z2&gt;=sizez)
-		z2=sizez-1;
-
+	ClampInt(x1, 0, sizeX);
+	ClampInt(x2, 0, sizeX);
+	ClampInt(z1, 0, sizeZ);
+	ClampInt(z2, 0, sizeZ);
+	
 	float metal = 0.0f;
 	int x, z;
-	for(x = x1; x &lt; x2; x++) {
-		for(z = z1; z &lt; z2; z++) {
-			metal += metalMap[x + z*sizex];
+	for (x = x1; x &lt; x2; x++) {
+		for (z = z1; z &lt; z2; z++) {
+			metal += metalMap[(z * sizeX) + x];
 		}
 	}
-	return metal * metalscale;
+	return metal * metalScale;
 }
 
 
@@ -103,17 +100,10 @@
 */
 float CMetalMap::getMetalAmount(int x, int z) 
 {
-	if(x&lt;0)
-		x=0;
-	else if(x&gt;=sizex)
-		x=sizex-1;
+	ClampInt(x, 0, sizeX);
+	ClampInt(z, 0, sizeZ);
 
-	if(z&lt;0)
-		z=0;
-	else if(z&gt;=sizez)
-		z=sizez-1;
-
-	return metalMap[x + z*sizex] * metalscale;
+	return metalMap[(z * sizeX) + x] * metalScale;
 }
 
 
@@ -127,21 +117,19 @@
 */
 float CMetalMap::requestExtraction(int x, int z, float toDepth) 
 {
-	if(x&lt;0)
-		x=0;
-	else if(x&gt;=sizex)
-		x=sizex-1;
+	ClampInt(x, 0, sizeX);
+	ClampInt(z, 0, sizeZ);
 
-	if(z&lt;0)
-		z=0;
-	else if(z&gt;=sizez)
-		z=sizez-1;
+	const float current = extractionMap[(z * sizeX) + x];
 
-	if(toDepth &lt;= extractionMap[x + z*sizex])
-		return 0;
+	if (toDepth &lt;= current) {
+		return 0.0f;
+	}
 
-	float available = toDepth - extractionMap[x + z*sizex];
-	extractionMap[x + z*sizex] = toDepth;
+	const float available = toDepth - current;
+
+	extractionMap[(z * sizeX) + x] = toDepth;
+
 	return available;
 }
 
@@ -153,15 +141,8 @@
 */
 void CMetalMap::removeExtraction(int x, int z, float depth) 
 {
-	if(x&lt;0)
-		x=0;
-	else if(x&gt;=sizex)
-		x=sizex-1;
+	ClampInt(x, 0, sizeX);
+	ClampInt(z, 0, sizeZ);
 
-	if(z&lt;0)
-		z=0;
-	else if(z&gt;=sizez)
-		z=sizez-1;
-
-	extractionMap[x + z*sizex] -= depth;
+	extractionMap[(z * sizeX) + x] -= depth;
 }

Modified: trunk/rts/Map/MetalMap.h
===================================================================
--- trunk/rts/Map/MetalMap.h	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/rts/Map/MetalMap.h	2008-06-08 23:38:52 UTC (rev 6002)
@@ -3,31 +3,35 @@
 
 #include &quot;GlobalStuff.h&quot;
 
-const float METAL_MAP_SQUARE_SIZE = SQUARE_SIZE * 2;	//Each square on metalmap is a 2x2 square on normal map.
 
+// Each square on metalmap is a 2x2 square on normal map.
+const float METAL_MAP_SQUARE_SIZE = SQUARE_SIZE * 2;
+
+
 class CMetalMap
 {
 public:
 	CR_DECLARE(CMetalMap);
-	CMetalMap(unsigned char *map, int sizex, int sizez, float metalscale);
+	CMetalMap(unsigned char* map, int sizeX, int sizeZ, float metalScale);
 	virtual ~CMetalMap(void);
 
 	float getMetalAmount(int x1, int z1, int x2, int z2);
 	float getMetalAmount(int x, int z);
 	float requestExtraction(int x, int z, float toDepth);
-	void removeExtraction(int x, int z, float depth);
+	void  removeExtraction(int x, int z, float depth);
 
-	unsigned char *metalMap;
-	unsigned char metalPal[768];
+	unsigned char* metalMap;
+	unsigned char  metalPal[768];
 	std::vector&lt;float&gt; extractionMap;
-	float metalscale;
 
-	int GetSizeX() const { return sizex; }
-	int GetSizeZ() const { return sizez; }
+	int GetSizeX() const { return sizeX; }
+	int GetSizeZ() const { return sizeZ; }
 
 protected:
-	int sizex;
-	int sizez;
+	float metalScale;
+	int sizeX;
+	int sizeZ;
 };
 
+
 #endif /* METALMAP_H */

Modified: trunk/rts/Rendering/GL/myGL.cpp
===================================================================
--- trunk/rts/Rendering/GL/myGL.cpp	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/rts/Rendering/GL/myGL.cpp	2008-06-08 23:38:52 UTC (rev 6002)
@@ -98,12 +98,14 @@
 		ofs.write(s.c_str(), s.length());
 }
 
+
 void UnloadExtensions()
 {
 	delete vertexArray1;
 	delete vertexArray2;
 }
 
+
 /******************************************************************************/
 
 void glBuildMipmaps(const GLenum target,GLint internalFormat,const GLsizei width,const GLsizei height,const GLenum format,const GLenum type,const void *data)
@@ -252,7 +254,7 @@
 	glEnable(GL_TEXTURE_2D);
 	glColor3f(1,1,1);
 
-	if(startupTexture){
+	if (startupTexture) {
 		glBindTexture(GL_TEXTURE_2D,startupTexture);
 		glBegin(GL_QUADS);
 			glTexCoord2f(0,1);glVertex2f(0,0);
@@ -264,8 +266,9 @@
 	font-&gt;glPrintCentered (0.5f,0.48f, 2.0f, text);
 	font-&gt;glPrintCentered(0.5f,0.06f,1.0f,&quot;Spring %s&quot;, VERSION_STRING);
 	font-&gt;glPrintCentered(0.5f,0.02f,0.6f,&quot;This program is distributed under the GNU General Public License, see license.html for more info&quot;);
-	if (swapbuffers)
+	if (swapbuffers) {
 		SDL_GL_SwapBuffers();
+	}
 	POP_CODE_MODE;
 }
 
@@ -379,17 +382,20 @@
 	return ret;
 }
 
+
 unsigned int LoadVertexProgram(const char* filename)
 {
 	return LoadProgram(GL_VERTEX_PROGRAM_ARB, filename, &quot;vertex&quot;);
 }
 
+
 unsigned int LoadFragmentProgram(const char* filename)
 {
 
 	return LoadProgram(GL_FRAGMENT_PROGRAM_ARB, filename, &quot;fragment&quot;);
 }
 
+
 void glSafeDeleteProgram(GLuint program)
 {
 	if (!GLEW_ARB_vertex_program || (program == 0)) {

Modified: trunk/rts/Sim/Misc/LosHandler.h
===================================================================
--- trunk/rts/Sim/Misc/LosHandler.h	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/rts/Sim/Misc/LosHandler.h	2008-06-08 23:38:52 UTC (rev 6002)
@@ -21,7 +21,9 @@
 	CR_DECLARE_STRUCT(LosInstance);
  	std::vector&lt;int&gt; losSquares;
 	LosInstance() {} // default constructor for creg
-	LosInstance(int lossize,int allyteam,int baseX,int baseY,int baseSquare,int baseAirSquare,int hashNum,float baseHeight,int airLosSize)
+	LosInstance(int lossize, int allyteam, int baseX, int baseY,
+	            int baseSquare, int baseAirSquare, int hashNum,
+	            float baseHeight, int airLosSize)
 		: losSize(lossize),
 			airLosSize(airLosSize),
 			refCount(1),
@@ -32,7 +34,7 @@
 			baseAirSquare(baseAirSquare),
 			hashNum(hashNum),
 			baseHeight(baseHeight),
-			toBeDeleted(false){}
+			toBeDeleted(false) {}
 	int losSize;
 	int airLosSize;
 	int refCount;
@@ -58,20 +60,26 @@
 	void FreeInstance(LosInstance* instance);
 
 	bool InLos(const CWorldObject* object, int allyTeam) {
-		if (object-&gt;alwaysVisible)
+		if (object-&gt;alwaysVisible) {
 			return true;
-		if (object-&gt;useAirLos) {
-			const int rowIdx = std::max(0, std::min(airSizeY - 1, ((int (object-&gt;pos.z * invAirDiv))))) * airSizeX;
-			const int colIdx = std::max(0, std::min(airSizeX - 1, ((int (object-&gt;pos.x * invAirDiv)))));
-			const int square = rowIdx + colIdx;
+		}
+		else if (object-&gt;useAirLos) {
+			const int gx = (int)(object-&gt;pos.x * invAirDiv);
+			const int gz = (int)(object-&gt;pos.z * invAirDiv);
+			const int rowIdx = std::max(0, std::min(airSizeY - 1, gz));
+			const int colIdx = std::max(0, std::min(airSizeX - 1, gx));
+			const int square = (rowIdx * airSizeX) + colIdx;
 			#ifdef DEBUG
 			assert(square &lt; airLosMap[allyTeam].size());
 			#endif
 			return !!airLosMap[allyTeam][square];
-		} else {
-			const int rowIdx = std::max(0, std::min(losSizeY - 1, ((int) (object-&gt;pos.z * invLosDiv)))) * losSizeX;
-			const int colIdx = std::max(0, std::min(losSizeX - 1, ((int) (object-&gt;pos.x * invLosDiv))));
-			const int square = rowIdx + colIdx;
+		}
+		else {
+			const int gx = (int)(object-&gt;pos.x * invLosDiv);
+			const int gz = (int)(object-&gt;pos.z * invLosDiv);
+			const int rowIdx = std::max(0, std::min(losSizeY - 1, gz));
+			const int colIdx = std::max(0, std::min(losSizeX - 1, gx));
+			const int square = (rowIdx * losSizeX) + colIdx;
 			#ifdef DEBUG
 			assert(square &lt; losMap[allyTeam].size());
 			#endif
@@ -80,16 +88,19 @@
 	}
 
 	bool InLos(const CUnit* unit, int allyTeam) {
-		if (unit-&gt;alwaysVisible)
+		if (unit-&gt;alwaysVisible) {
 			return true;
-		if (unit-&gt;isCloaked)
+		}
+		if (unit-&gt;isCloaked) {
 			return false;
+		}
 		return InLos(static_cast&lt;const CWorldObject*&gt;(unit), allyTeam);
 	}
 
 	bool InLos(float3 pos, int allyTeam) {
 		pos.CheckInBounds();
-		const int square = ((int) (pos.z * invLosDiv)) * losSizeX + ((int) (pos.x * invLosDiv));
+		const int square = ((int)(pos.z * invLosDiv)) * losSizeX
+		                 + ((int)(pos.x * invLosDiv));
 		#ifdef DEBUG
 		assert(square &lt; losMap[allyTeam].size());
 		#endif
@@ -98,7 +109,8 @@
 
 	bool InAirLos(float3 pos, int allyTeam) {
 		pos.CheckInBounds();
-		const int square = ((int) (pos.z * invAirDiv)) * airSizeX + ((int) (pos.x * invAirDiv));
+		const int square = ((int)(pos.z * invAirDiv)) * airSizeX
+		                 + ((int)(pos.x * invAirDiv));
 		#ifdef DEBUG
 		assert(square &lt; airLosMap[allyTeam].size());
 		#endif

Modified: trunk/rts/Sim/Misc/RadarHandler.cpp
===================================================================
--- trunk/rts/Sim/Misc/RadarHandler.cpp	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/rts/Sim/Misc/RadarHandler.cpp	2008-06-08 23:38:52 UTC (rev 6002)
@@ -9,7 +9,9 @@
 CR_BIND(CRadarHandler, (false));
 
 CR_REG_METADATA(CRadarHandler, (
-	CR_SERIALIZER(Serialize), // radarMaps, airRadarMaps, sonarMaps, jammerMaps, seismicMaps, commonJammerMap, commonSonarJammerMap
+	CR_SERIALIZER(Serialize),
+	// radarMaps, airRadarMaps, sonarMaps, jammerMaps,
+	// seismicMaps, commonJammerMap, commonSonarJammerMap
 	CR_MEMBER(circularRadar),
 	CR_MEMBER(radarErrorSize),
 	CR_MEMBER(baseRadarErrorSize),

Modified: trunk/rts/Sim/Misc/RadarHandler.h
===================================================================
--- trunk/rts/Sim/Misc/RadarHandler.h	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/rts/Sim/Misc/RadarHandler.h	2008-06-08 23:38:52 UTC (rev 6002)
@@ -12,6 +12,7 @@
 {
 	CR_DECLARE(CRadarHandler);
 
+
 public:
 	CRadarHandler(bool circularRadar);
 	~CRadarHandler();
@@ -19,19 +20,24 @@
 	void MoveUnit(CUnit* unit);
 	void RemoveUnit(CUnit* unit);
 
+	inline int GetSquare(const float3&amp; pos) const
+	{
+		const int gx = (int)pos.x / (SQUARE_SIZE * RADAR_SIZE);
+		const int gz = (int)pos.z / (SQUARE_SIZE * RADAR_SIZE);
+		const int rowIdx = std::max(0, std::min(ysize - 1, gz));
+		const int colIdx = std::max(0, std::min(xsize - 1, gx));
+		return (rowIdx * xsize) + colIdx;
+	}
+
 	bool InRadar(const float3&amp; pos, int allyTeam) {
-		const int gx = (int) pos.x / (SQUARE_SIZE * RADAR_SIZE);
-		const int gz = (int) pos.z / (SQUARE_SIZE * RADAR_SIZE);
-		const int rowIdx = std::max(0, std::min(ysize - 1, gz)) * xsize;
-		const int colIdx = std::max(0, std::min(xsize - 1, gx));
-		const int square = rowIdx + colIdx;
+		const int square = GetSquare(pos);
 		if (pos.y &lt; -0.5f) {
 			#ifdef DEBUG
 			assert(square &lt; sonarMaps[allyTeam].size());
 			#endif
 			return (sonarMaps[allyTeam][square] &amp;&amp; !commonSonarJammerMap[square]);
 		}
-		else if (!circularRadar &amp;&amp; pos.y &gt; 0.5f) {
+		else if (!circularRadar &amp;&amp; (pos.y &gt; 0.5f)) {
 			#ifdef DEBUG
 			assert(square &lt; airRadarMaps[allyTeam].size());
 			#endif
@@ -46,36 +52,46 @@
 	}
 
 	bool InRadar(const CUnit* unit, int allyTeam) {
-		if (unit-&gt;stealth)
-			return false;
 
-		const int rowIdx = std::max(0, std::min(ysize - 1, (int) unit-&gt;pos.z / (SQUARE_SIZE * RADAR_SIZE))) * xsize;
-		const int colIdx = std::max(0, std::min(xsize - 1, (int) unit-&gt;pos.x / (SQUARE_SIZE * RADAR_SIZE)));
-		const int square = rowIdx + colIdx;
-
 		if (unit-&gt;isUnderWater) {
+			if (unit-&gt;sonarStealth) {
+				return false;
+			}
+			const int square = GetSquare(unit-&gt;pos);
 			#ifdef DEBUG
 			assert(square &lt; sonarMaps[allyTeam].size());
 			#endif
-			return (!!sonarMaps[allyTeam][square]) &amp;&amp; !commonSonarJammerMap[square];
+			return !!sonarMaps[allyTeam][square] &amp;&amp; !commonSonarJammerMap[square];
 		}
-		if (!circularRadar &amp;&amp; unit-&gt;useAirLos) {
+		else if (!circularRadar &amp;&amp; unit-&gt;useAirLos) {
+			if (unit-&gt;stealth) {
+				return false;
+			}
+			const int square = GetSquare(unit-&gt;pos);
 			#ifdef DEBUG
 			assert(square &lt; airRadarMaps[allyTeam].size());
 			#endif
 			return airRadarMaps[allyTeam][square] &amp;&amp; !commonJammerMap[square];
-		} else {
+		}
+		else {
+			const int square = GetSquare(unit-&gt;pos);
 			#ifdef DEBUG
-			assert(square &lt; radarMaps[allyTeam].size() &amp;&amp; square &lt; sonarMaps[allyTeam].size());
+			assert((square &lt; radarMaps[allyTeam].size()) &amp;&amp;
+			       (square &lt; sonarMaps[allyTeam].size()));
 			#endif
-			return (radarMaps[allyTeam][square] || (unit-&gt;pos.y &lt;= 1 &amp;&amp; sonarMaps[allyTeam][square])) &amp;&amp; !commonJammerMap[square];
+			return (radarMaps[allyTeam][square]
+			        &amp;&amp; !unit-&gt;stealth
+			        &amp;&amp; !commonJammerMap[square])
+			       ||
+			       ((unit-&gt;pos.y &lt;= 1.0f)
+			        &amp;&amp; sonarMaps[allyTeam][square]
+			        &amp;&amp; !unit-&gt;sonarStealth
+			        &amp;&amp; !commonSonarJammerMap[square]);
 		}
 	}
 
 	bool InSeismicDistance(const CUnit* unit, int allyTeam) {
-		const int rowIdx = std::max(0, std::min(ysize - 1, (int) unit-&gt;pos.z / (SQUARE_SIZE * RADAR_SIZE))) * xsize;
-		const int colIdx = std::max(0, std::min(xsize - 1, (int) unit-&gt;pos.x / (SQUARE_SIZE * RADAR_SIZE)));
-		const int square = rowIdx + colIdx;
+		const int square = GetSquare(unit-&gt;pos);
 		#ifdef DEBUG
 		assert(square &lt; seismicMaps[allyTeam].size());
 		#endif

Modified: trunk/rts/Sim/MoveTypes/AirMoveType.cpp
===================================================================
--- trunk/rts/Sim/MoveTypes/AirMoveType.cpp	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/rts/Sim/MoveTypes/AirMoveType.cpp	2008-06-08 23:38:52 UTC (rev 6002)
@@ -7,7 +7,7 @@
 #include &quot;Map/MapInfo.h&quot;
 #include &quot;Mobility.h&quot;
 #include &quot;myMath.h&quot;
-#include &quot;Rendering/UnitModels/3DOParser.h&quot;
+#include &quot;Rendering/UnitModels/3DModelParser.h&quot;
 #include &quot;Sim/Misc/GeometricObjects.h&quot;
 #include &quot;Sim/Misc/GroundBlockingObjectMap.h&quot;
 #include &quot;Sim/Misc/LosHandler.h&quot;

Modified: trunk/rts/Sim/MoveTypes/GroundMoveType.cpp
===================================================================
--- trunk/rts/Sim/MoveTypes/GroundMoveType.cpp	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/rts/Sim/MoveTypes/GroundMoveType.cpp	2008-06-08 23:38:52 UTC (rev 6002)
@@ -10,7 +10,7 @@
 #include &quot;LogOutput.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
 #include &quot;Sync/SyncTracer.h&quot;
-#include &quot;Rendering/UnitModels/3DOParser.h&quot;
+#include &quot;Rendering/UnitModels/3DModelParser.h&quot;
 #include &quot;Sim/Features/Feature.h&quot;
 #include &quot;Sim/Features/FeatureHandler.h&quot;
 #include &quot;Sim/Units/COB/CobInstance.h&quot;

Modified: trunk/rts/Sim/MoveTypes/ScriptMoveType.cpp
===================================================================
--- trunk/rts/Sim/MoveTypes/ScriptMoveType.cpp	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/rts/Sim/MoveTypes/ScriptMoveType.cpp	2008-06-08 23:38:52 UTC (rev 6002)
@@ -1,10 +1,13 @@
 
 #include &quot;StdAfx.h&quot;
+
 #include &quot;ScriptMoveType.h&quot;
+
 #include &quot;Lua/LuaRules.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Map/MapInfo.h&quot;
 #include &quot;Rendering/GroundDecalHandler.h&quot;
+#include &quot;Rendering/UnitModels/3DModelParser.h&quot;
 #include &quot;Sim/Misc/Wind.h&quot;
 #include &quot;Sim/Misc/AirBaseHandler.h&quot;
 #include &quot;Sim/Misc/LosHandler.h&quot;
@@ -14,7 +17,7 @@
 #include &quot;Sim/Units/UnitTypes/Building.h&quot;
 #include &quot;System/Matrix44f.h&quot;
 #include &quot;System/myMath.h&quot;
-#include &quot;mmgr.h&quot;
+#include &quot;System/mmgr.h&quot;
 
 CR_BIND_DERIVED(CScriptMoveType, AMoveType, (NULL));
 
@@ -152,6 +155,8 @@
 		}
 	}
 	qf-&gt;MovedUnit(owner);
+
+	owner-&gt;isUnderWater = ((owner-&gt;pos.y + owner-&gt;model-&gt;height) &lt; 0.0f);
 };
 
 

Modified: trunk/rts/Sim/MoveTypes/TAAirMoveType.cpp
===================================================================
--- trunk/rts/Sim/MoveTypes/TAAirMoveType.cpp	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/rts/Sim/MoveTypes/TAAirMoveType.cpp	2008-06-08 23:38:52 UTC (rev 6002)
@@ -1,22 +1,24 @@
 #include &quot;StdAfx.h&quot;
+
 #include &quot;TAAirMoveType.h&quot;
-#include &quot;Sim/Misc/QuadField.h&quot;
+
+#include &quot;Mobility.h&quot;
+#include &quot;Game/Player.h&quot;
 #include &quot;Map/Ground.h&quot;
+#include &quot;Rendering/UnitModels/3DModelParser.h&quot;
+#include &quot;Sim/Misc/GeometricObjects.h&quot;
+#include &quot;Sim/Misc/GroundBlockingObjectMap.h&quot;
 #include &quot;Sim/Misc/LosHandler.h&quot;
 #include &quot;Sim/Misc/RadarHandler.h&quot;
-#include &quot;Sim/Units/COB/CobFile.h&quot;
-#include &quot;Sim/Units/COB/CobInstance.h&quot;
-#include &quot;LogOutput.h&quot;
-#include &quot;myMath.h&quot;
-#include &quot;Matrix44f.h&quot;
-#include &quot;Rendering/UnitModels/3DOParser.h&quot;
-#include &quot;Game/Player.h&quot;
+#include &quot;Sim/Misc/QuadField.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
-#include &quot;Sim/Misc/GeometricObjects.h&quot;
-#include &quot;Mobility.h&quot;
 #include &quot;Sim/Units/UnitTypes/TransportUnit.h&quot;
 #include &quot;Sim/Units/CommandAI/CommandAI.h&quot;
-#include &quot;Sim/Misc/GroundBlockingObjectMap.h&quot;
+#include &quot;Sim/Units/COB/CobFile.h&quot;
+#include &quot;Sim/Units/COB/CobInstance.h&quot;
+#include &quot;System/LogOutput.h&quot;
+#include &quot;System/myMath.h&quot;
+#include &quot;System/Matrix44f.h&quot;
 
 
 CR_BIND_DERIVED(CTAAirMoveType, AAirMoveType, (NULL));

Modified: trunk/rts/Sim/Units/COB/CobInstance.cpp
===================================================================
--- trunk/rts/Sim/Units/COB/CobInstance.cpp	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/rts/Sim/Units/COB/CobInstance.cpp	2008-06-08 23:38:52 UTC (rev 6002)
@@ -111,6 +111,7 @@
 #define ALPHA_THRESHOLD          103 // set or get
 #define SET_WEAPON_UNIT_TARGET   106 // get (fake set)
 #define SET_WEAPON_GROUND_TARGET 107 // get (fake set)
+#define SONAR_STEALTH            108 // set or get
 
 // NOTE: [LUA0 - LUA9] are defined in CobThread.cpp as [110 - 119]
 
@@ -1177,6 +1178,9 @@
 	case STEALTH: {
 		return unit-&gt;stealth ? 1 : 0;
 	}
+	case SONAR_STEALTH: {
+		return unit-&gt;sonarStealth ? 1 : 0;
+	}
 	case CRASHING:
 		return !!unit-&gt;crashing;
 	case ALPHA_THRESHOLD: {
@@ -1615,6 +1619,10 @@
 			unit-&gt;stealth = !!param;
 			break;
 		}
+		case SONAR_STEALTH: {
+			unit-&gt;sonarStealth = !!param;
+			break;
+		}
 		case CRASHING: {
 			if(dynamic_cast&lt;CAirMoveType*&gt;(unit-&gt;moveType)){
 				if(!!param){

Modified: trunk/rts/Sim/Units/Unit.cpp
===================================================================
--- trunk/rts/Sim/Units/Unit.cpp	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/rts/Sim/Units/Unit.cpp	2008-06-08 23:38:52 UTC (rev 6002)
@@ -1433,14 +1433,16 @@
 
 void CUnit::SetUserTarget(CUnit* target)
 {
-	if(userTarget &amp;&amp; lastAttacker!=userTarget)
+	if (userTarget &amp;&amp; (lastAttacker != userTarget)) {
 		DeleteDeathDependence(userTarget);
+	}
 
 	userTarget=target;
-	for(vector&lt;CWeapon*&gt;::iterator wi=weapons.begin();wi!=weapons.end();++wi)
-		(*wi)-&gt;haveUserTarget=false;
+	for(vector&lt;CWeapon*&gt;::iterator wi=weapons.begin();wi!=weapons.end();++wi) {
+		(*wi)-&gt;haveUserTarget = false;
+	}
 
-	if(target){
+	if (target) {
 		AddDeathDependence(target);
 	}
 }
@@ -1448,39 +1450,50 @@
 
 void CUnit::Init(const CUnit* builder)
 {
-	relMidPos=model-&gt;relMidPos;
-	midPos=pos+frontdir*relMidPos.z + updir*relMidPos.y + rightdir*relMidPos.x;
-	losHeight=relMidPos.y+radius*0.5f;
-	height = model-&gt;height;		//TODO: This one would be much better to have either in Constructor or UnitLoader!//why this is always called in unitloader
-	currentFuel=unitDef-&gt;maxFuel;
+	relMidPos = model-&gt;relMidPos;
+	midPos = pos + (frontdir * relMidPos.z)
+	             + (updir    * relMidPos.y)
+	             + (rightdir * relMidPos.x);
+	losHeight = relMidPos.y + (radius * 0.5f);
+	height = model-&gt;height;
+	// TODO: This one would be much better to have either in Constructor
+	//       or UnitLoader! // why this is always called in unitloader
+	currentFuel = unitDef-&gt;maxFuel;
 
-	//All ships starts on water, all other on ground.
-	//TODO: Improve this. There might be cases when this is not correct.
-	if(unitDef-&gt;movedata &amp;&amp; unitDef-&gt;movedata-&gt;moveType==MoveData::Hover_Move){
+	// all ships starts on water, all other on ground.
+	// TODO: Improve this. There might be cases when this is not correct.
+	if (unitDef-&gt;movedata &amp;&amp;
+	    (unitDef-&gt;movedata-&gt;moveType == MoveData::Hover_Move)) {
 		physicalState = Hovering;
-	} else if(floatOnWater) {
+	} else if (floatOnWater) {
 		physicalState = Floating;
 	} else {
 		physicalState = OnGround;
 	}
 
-	//All units are set as ground-blocking.
+	// all units are set as ground-blocking.
 	blocking = true;
 
-	if(pos.y+model-&gt;height&lt;1)	//some torp launchers etc are exactly in the surface and should be considered uw anyway
-		isUnderWater=true;
+	// some torp launchers etc are exactly in the surface and should be considered uw anyway
+	if ((pos.y + model-&gt;height) &lt; 1) {
+		isUnderWater = true;
+	}
 
-	if(!unitDef-&gt;canKamikaze || unitDef-&gt;type==&quot;Building&quot; || unitDef-&gt;type==&quot;Factory&quot;)	//semi hack to make mines not block ground
+	// semi hack to make mines not block ground
+	if (!unitDef-&gt;canKamikaze ||
+	    (unitDef-&gt;type == &quot;Building&quot;) ||
+	    (unitDef-&gt;type == &quot;Factory&quot;)) {
 		Block();
+	}
 
 	UpdateTerrainType();
 
 	Command c;
 	if (unitDef-&gt;canmove || unitDef-&gt;builder) {
-		if (unitDef-&gt;moveState&lt;0) {
+		if (unitDef-&gt;moveState &lt; 0) {
 			if (builder!=NULL) {
 				moveState = builder-&gt;moveState;
-			}else{
+			} else {
 				moveState = 1;
 			}
 		} else {
@@ -1494,10 +1507,10 @@
 	}
 
 	if (commandAI-&gt;CanChangeFireState()) {
-		if (unitDef-&gt;fireState&lt;0) {
-			if (builder!=NULL) {
+		if (unitDef-&gt;fireState &lt; 0) {
+			if (builder != NULL) {
 				fireState = builder-&gt;fireState;
-			}else{
+			} else {
 				fireState = 2;
 			}
 		} else {
@@ -2205,7 +2218,8 @@
 				CR_MEMBER(radarSquares),
 				CR_MEMBER(oldRadarPos),
 				CR_MEMBER(stealth),
-				CR_RESERVED(16),
+				CR_MEMBER(sonarStealth),
+				CR_RESERVED(15),
 
 				CR_MEMBER(commandAI),
 				CR_MEMBER(moveType),

Modified: trunk/rts/Sim/Units/Unit.h
===================================================================
--- trunk/rts/Sim/Units/Unit.h	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/rts/Sim/Units/Unit.h	2008-06-08 23:38:52 UTC (rev 6002)
@@ -245,6 +245,7 @@
 	std::vector&lt;int&gt; radarSquares;
 	int2 oldRadarPos;
 	bool stealth;
+	bool sonarStealth;
 
 	AMoveType* moveType;
 	AMoveType* prevMoveType;

Modified: trunk/rts/Sim/Units/UnitDef.h
===================================================================
--- trunk/rts/Sim/Units/UnitDef.h	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/rts/Sim/Units/UnitDef.h	2008-06-08 23:38:52 UTC (rev 6002)
@@ -150,6 +150,7 @@
 	int seismicRadius;
 	float seismicSignature;
 	bool stealth;
+	bool sonarStealth;
 
 	bool  buildRange3D;
 	float buildDistance;

Modified: trunk/rts/Sim/Units/UnitDefHandler.cpp
===================================================================
--- trunk/rts/Sim/Units/UnitDefHandler.cpp	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/rts/Sim/Units/UnitDefHandler.cpp	2008-06-08 23:38:52 UTC (rev 6002)
@@ -420,6 +420,7 @@
 	ud.sonarJamRadius = udTable.GetInt(&quot;sonarDistanceJam&quot;, 0);
 
 	ud.stealth        = udTable.GetBool(&quot;stealth&quot;,            false);
+	ud.sonarStealth   = udTable.GetBool(&quot;sonarStealth&quot;,       false);
 	ud.targfac        = udTable.GetBool(&quot;isTargetingUpgrade&quot;, false);
 	ud.isFeature      = udTable.GetBool(&quot;isFeature&quot;,          false);
 	ud.canResurrect   = udTable.GetBool(&quot;canResurrect&quot;,       false);

Modified: trunk/rts/Sim/Units/UnitLoader.cpp
===================================================================
--- trunk/rts/Sim/Units/UnitLoader.cpp	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/rts/Sim/Units/UnitLoader.cpp	2008-06-08 23:38:52 UTC (rev 6002)
@@ -152,6 +152,7 @@
 	                         unit-&gt;jammerRadius || unit-&gt;sonarJamRadius ||
 	                         unit-&gt;seismicRadius;
 	unit-&gt;stealth = ud-&gt;stealth;
+	unit-&gt;sonarStealth = ud-&gt;sonarStealth;
 	unit-&gt;category = ud-&gt;category;
 	unit-&gt;armorType = ud-&gt;armorType;
 	unit-&gt;floatOnWater =

Modified: trunk/rts/System/FileSystem/ArchiveDir.cpp
===================================================================
--- trunk/rts/System/FileSystem/ArchiveDir.cpp	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/rts/System/FileSystem/ArchiveDir.cpp	2008-06-08 23:38:52 UTC (rev 6002)
@@ -4,6 +4,7 @@
 #include &quot;ArchiveDir.h&quot;
 #include &quot;Platform/FileSystem.h&quot;
 
+
 inline CFileHandler* CArchiveDir::GetFileHandler(int handle)
 {
 	std::map&lt;int, CFileHandler*&gt;::iterator it = fileHandles.find(handle);
@@ -11,6 +12,7 @@
 	return it-&gt;second;
 }
 
+
 inline std::vector&lt;std::string&gt;::iterator&amp; CArchiveDir::GetSearchHandle(int handle)
 {
 	std::map&lt;int, std::vector&lt;std::string&gt;::iterator&gt;::iterator it = searchHandles.find(handle);
@@ -18,6 +20,7 @@
 	return it-&gt;second;
 }
 
+
 CArchiveDir::CArchiveDir(const std::string&amp; archivename) :
 		CArchiveBase(archivename),
 		archiveName(archivename + '/'),
@@ -39,15 +42,18 @@
 	}
 }
 
+
 CArchiveDir::~CArchiveDir(void)
 {
 }
 
+
 bool CArchiveDir::IsOpen()
 {
 	return true;
 }
 
+
 int CArchiveDir::OpenFile(const std::string&amp; fileName)
 {
 	CFileHandler* f = SAFE_NEW CFileHandler(archiveName + lcNameToOrigName[StringToLower(fileName)]);
@@ -60,38 +66,45 @@
 	return curFileHandle;
 }
 
+
 int CArchiveDir::ReadFile(int handle, void* buffer, int numBytes)
 {
 	CFileHandler* f = GetFileHandler(handle);
 	return f-&gt;Read(buffer, numBytes);
 }
 
+
 void CArchiveDir::CloseFile(int handle)
 {
 	delete GetFileHandler(handle);
 	fileHandles.erase(handle);
 }
 
+
 void CArchiveDir::Seek(int handle, int pos)
 {
 	GetFileHandler(handle)-&gt;Seek(pos);
 }
 
+
 int CArchiveDir::Peek(int handle)
 {
 	return GetFileHandler(handle)-&gt;Peek();
 }
 
+
 bool CArchiveDir::Eof(int handle)
 {
 	return GetFileHandler(handle)-&gt;Eof();
 }
 
+
 int CArchiveDir::FileSize(int handle)
 {
 	return GetFileHandler(handle)-&gt;FileSize();
 }
 
+
 int CArchiveDir::FindFiles(int cur, std::string* name, int* size)
 {
 	if (cur == 0) {

Modified: trunk/rts/System/FileSystem/FileHandler.cpp
===================================================================
--- trunk/rts/System/FileSystem/FileHandler.cpp	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/rts/System/FileSystem/FileHandler.cpp	2008-06-08 23:38:52 UTC (rev 6002)
@@ -15,13 +15,15 @@
 /******************************************************************************/
 /******************************************************************************/
 
-CFileHandler::CFileHandler(const char* filename, const char* modes) : ifs(NULL), hpiFileBuffer(NULL), hpiOffset(0), filesize(-1)
+CFileHandler::CFileHandler(const char* filename, const char* modes)
+: ifs(NULL), hpiFileBuffer(NULL), hpiOffset(0), filesize(-1)
 {
 	Init(filename, modes);
 }
 
 
-CFileHandler::CFileHandler(const string&amp; filename, const string&amp; modes) : ifs(NULL), hpiFileBuffer(NULL), hpiOffset(0), filesize(-1)
+CFileHandler::CFileHandler(const string&amp; filename, const string&amp; modes)
+: ifs(NULL), hpiFileBuffer(NULL), hpiOffset(0), filesize(-1)
 {
 	Init(filename, modes);
 }

Modified: trunk/tools/unitsync/test/test.cpp
===================================================================
--- trunk/tools/unitsync/test/test.cpp	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/tools/unitsync/test/test.cpp	2008-06-08 23:38:52 UTC (rev 6002)
@@ -31,6 +31,7 @@
 #include &lt;stdlib.h&gt;
 
 #include &lt;string&gt;
+#include &lt;vector&gt;
 using namespace std;
 
 #include &quot;../unitsync.h&quot;
@@ -144,6 +145,39 @@
 /******************************************************************************/
 /******************************************************************************/
 
+static bool PrintMapInfo(const string&amp; mapName)
+{
+  printf(&quot;  MAP INFO  (for %s)\n&quot;, mapName.c_str());
+  MapInfo mi;
+  char auth[256];
+  char desc[256];
+  mi.author = auth;
+  mi.author[0] = 0;
+  mi.description = desc;
+  mi.description[0] = 0;
+  if (!GetMapInfoEx(mapName.c_str(), &amp;mi, 1)) {
+    printf(&quot;ERROR getting info for map %s  (%s)\n&quot;,
+    mapName.c_str(), mi.description);
+  }
+  else {
+    printf(&quot;    author:    '%s'\n&quot;, mi.author);
+    printf(&quot;    desc:      '%s'\n&quot;, mi.description);
+    printf(&quot;    gravity:   %i\n&quot;,   mi.gravity);
+    printf(&quot;    tidal:     %i\n&quot;,   mi.tidalStrength);
+    printf(&quot;    maxMetal:  %f\n&quot;,   mi.maxMetal);
+    printf(&quot;    mexRad:    %i\n&quot;,   mi.extractorRadius);
+    printf(&quot;    minWind:   %i\n&quot;,   mi.minWind);
+    printf(&quot;    maxWind:   %i\n&quot;,   mi.maxWind);
+    printf(&quot;    width:     %i\n&quot;,   mi.width);
+    printf(&quot;    height:    %i\n&quot;,   mi.height);
+    for (int p = 0; p &lt; mi.posCount; p++) {
+      const StartPos&amp; sp = mi.positions[p];
+      printf(&quot;    pos %i:     &lt;%5i, %5i&gt;\n&quot;, p, sp.x, sp.z);
+    }
+  }
+}
+
+
 int main(int argc, char** argv)
 {
   if (argc &lt; 3) {
@@ -162,9 +196,11 @@
 
   // map names
   printf(&quot;  MAPS\n&quot;);
+  vector&lt;string&gt; mapNames;
   const int mapCount = GetMapCount();
   for (int i = 0; i &lt; mapCount; i++) {
     const string mapName = GetMapName(i);
+    mapNames.push_back(mapName);
     printf(&quot;    [map %3i]   %s\n&quot;, i, mapName.c_str());
   }
 
@@ -176,28 +212,12 @@
   }
   
   // map info
-  printf(&quot;  MAP INFO  (for %s)\n&quot;, map.c_str());
-  MapInfo mi;
-  char auth[256];
-  char desc[256];
-  mi.author = auth;
-  mi.author[0] = 0;
-  mi.description = desc;
-  mi.description[0] = 0;
-  GetMapInfoEx(map.c_str(), &amp;mi, 1);
-  printf(&quot;    author:    '%s'\n&quot;, mi.author);
-  printf(&quot;    desc:      '%s'\n&quot;, mi.description);
-  printf(&quot;    gravity:   %i\n&quot;,   mi.gravity);
-  printf(&quot;    tidal:     %i\n&quot;,   mi.tidalStrength);
-  printf(&quot;    maxMetal:  %f\n&quot;,   mi.maxMetal);
-  printf(&quot;    mexRad:    %i\n&quot;,   mi.extractorRadius);
-  printf(&quot;    minWind:   %i\n&quot;,   mi.minWind);
-  printf(&quot;    maxWind:   %i\n&quot;,   mi.maxWind);
-  printf(&quot;    width:     %i\n&quot;,   mi.width);
-  printf(&quot;    height:    %i\n&quot;,   mi.height);
-  for (int p = 0; p &lt; mi.posCount; p++) {
-    const StartPos&amp; sp = mi.positions[p];
-    printf(&quot;    pos %i:     &lt;%i, %i&gt;\n&quot;, p, sp.x, sp.z);
+  PrintMapInfo(map);
+
+  if (true) { // FIXME -- debugging
+    for (int i = 0; i &lt; mapNames.size(); i++) {
+      PrintMapInfo(mapNames[i]);
+    }
   }
     
   // mod names

Modified: trunk/tools/unitsync/unitsync.cpp
===================================================================
--- trunk/tools/unitsync/unitsync.cpp	2008-06-08 20:00:05 UTC (rev 6001)
+++ trunk/tools/unitsync/unitsync.cpp	2008-06-08 23:38:52 UTC (rev 6002)
@@ -25,6 +25,9 @@
 #include &lt;cstdio&gt;
 #include &lt;cstdarg&gt;
 
+using std::string;
+
+
 #define ASSERT(condition, message) \
 	do { \
 		if (!(condition)) { \
@@ -417,7 +420,7 @@
 	if (!mapParser.IsValid()) {
 		err = mapParser.GetErrorLog();
 	}
-	const LuaTable mapTable = mapParser.GetRoot();
+	const	LuaTable mapTable = mapParser.GetRoot();
 
 	// Retrieve the map header as well
 	if (err.empty()) {
@@ -1224,11 +1227,14 @@
 	optionsSet.clear();
 
 	LuaParser luaParser(fileName, fileModes, accessModes);
-	if (!mapName.empty()) {
+
+	const string configName = MapParser::GetMapConfigName(mapName);
+
+	if (!mapName.empty() &amp;&amp; !configName.empty()) {
 		luaParser.GetTable(&quot;Map&quot;);
 		luaParser.AddString(&quot;fileName&quot;, mapName);
 		luaParser.AddString(&quot;fullName&quot;, &quot;maps/&quot; + mapName);
-		luaParser.AddString(&quot;configFile&quot;, MapParser::GetMapConfigName(mapName));
+		luaParser.AddString(&quot;configFile&quot;, configName);
 		luaParser.EndTable();
 	}
 		
@@ -1642,8 +1648,8 @@
 // pass the returned handle to findfiles to get the results
 DLL_EXPORT int __stdcall InitFindVFS(const char* pattern)
 {
-	std::string path = filesystem.GetDirectory(pattern);
-	std::string patt = filesystem.GetFilename(pattern);
+	string path = filesystem.GetDirectory(pattern);
+	string patt = filesystem.GetFilename(pattern);
 	logOutput.Print(&quot;initfindvfs: %s\n&quot;, pattern);
 	curFindFiles = CFileHandler::FindFiles(path, patt);
 	return 0;
@@ -1775,7 +1781,7 @@
  */
 DLL_EXPORT const char* __stdcall GetSpringConfigString( const char* name, const char* defvalue )
 {
-	std::string res = configHandler.GetString( name, defvalue );
+	string res = configHandler.GetString( name, defvalue );
 	return GetStr(res);
 }
 


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000781.html">[Taspring-linux-commit] r6001 - trunk/rts/Game/UI
</A></li>
	<LI>Next message: <A HREF="000783.html">[Taspring-linux-commit] r6003 - trunk/installer/sections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#782">[ date ]</a>
              <a href="thread.html#782">[ thread ]</a>
              <a href="subject.html#782">[ subject ]</a>
              <a href="author.html#782">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
