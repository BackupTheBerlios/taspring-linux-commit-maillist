<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r6037 - in trunk/Lobby/TASClient: . Graphics
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-June/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6037%20-%20in%20trunk/Lobby/TASClient%3A%20.%20Graphics&In-Reply-To=%3C20080616222003.5ADA1487A%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000816.html">
   <LINK REL="Next"  HREF="000818.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r6037 - in trunk/Lobby/TASClient: . Graphics</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6037%20-%20in%20trunk/Lobby/TASClient%3A%20.%20Graphics&In-Reply-To=%3C20080616222003.5ADA1487A%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r6037 - in trunk/Lobby/TASClient: . Graphics">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Tue Jun 17 00:20:03 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000816.html">[Taspring-linux-commit] r6036 - in trunk/rts: Game	Game/StartScripts Rendering System
</A></li>
        <LI>Next message: <A HREF="000818.html">[Taspring-linux-commit] r6038 - trunk/Lobby/TASClient
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#817">[ date ]</a>
              <a href="thread.html#817">[ thread ]</a>
              <a href="subject.html#817">[ subject ]</a>
              <a href="author.html#817">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: satirik
Date: 2008-06-17 00:20:02 +0200 (Tue, 17 Jun 2008)
New Revision: 6037

Modified:
   trunk/Lobby/TASClient/BattleFormUnit.dfm
   trunk/Lobby/TASClient/BattleFormUnit.pas
   trunk/Lobby/TASClient/Graphics/join1.bmp
   trunk/Lobby/TASClient/Graphics/join2.bmp
   trunk/Lobby/TASClient/Graphics/join3.bmp
   trunk/Lobby/TASClient/HostBattleFormUnit.pas
   trunk/Lobby/TASClient/MainUnit.dfm
   trunk/Lobby/TASClient/MainUnit.pas
   trunk/Lobby/TASClient/MapListFormUnit.pas
   trunk/Lobby/TASClient/PerformFormUnit.pas
   trunk/Lobby/TASClient/PreferencesFormUnit.dfm
   trunk/Lobby/TASClient/PreferencesFormUnit.pas
   trunk/Lobby/TASClient/TASClient.dof
   trunk/Lobby/TASClient/TASClient.dpr
   trunk/Lobby/TASClient/TASClient.res
   trunk/Lobby/TASClient/Utility.pas
Log:
- preset filters added and saved in lobby\var\filters\*.Ini
- '-server myserverurl.com:8200' command added
- ladder list downloader thread synchronization improved
- map checksum is now done using GetMapChecksum from unitsync
- the lobby now store the md5 hash of the password in the registry
- the minimap takes the whole available width now (the splitter between the minimap and the game options is no more needed) and the keep ratio option is enabled by default
- when you time out or disconnect and reconnect it rejoins the opened channels
- battle list join icons changed
- in a ladder battle, it opens the options/account after the msgbox when you try to be ready but you don't have a ladder account


Modified: trunk/Lobby/TASClient/BattleFormUnit.dfm
===================================================================
--- trunk/Lobby/TASClient/BattleFormUnit.dfm	2008-06-16 21:09:43 UTC (rev 6036)
+++ trunk/Lobby/TASClient/BattleFormUnit.dfm	2008-06-16 22:20:02 UTC (rev 6037)
@@ -1,6 +1,6 @@
 object BattleForm: TBattleForm
-  Left = 580
-  Top = 253
+  Left = 829
+  Top = 171
   Width = 748
   Height = 586
   Caption = 'Battle window'
@@ -3995,15 +3995,17 @@
         Top = 1
         Width = 4
         Height = 273
+        Align = alRight
         AutoSnap = False
         ResizeStyle = rsUpdate
+        Visible = False
       end
       object Panel5: TPanel
         Left = 341
         Top = 1
         Width = 390
         Height = 273
-        Align = alClient
+        Align = alRight
         BevelOuter = bvNone
         TabOrder = 0
         object SpTBXTabControl1: TSpTBXTabControl
@@ -4011,74 +4013,29 @@
           Top = 0
           Width = 390
           Height = 273
-          Align = alClient
+          Align = alRight
           Color = clBtnFace
           ActiveTabIndex = 0
+          ThemeType = tttFlat
           OnActiveTabChange = SpTBXTabControl1ActiveTabChange
           HiddenItems = &lt;&gt;
           object GameOptionsTab: TSpTBXTabItem
             Caption = 'Game options'
             Checked = True
+            ThemeType = tttFlat
           end
           object DisabledUnitsTab: TSpTBXTabItem
             Caption = 'Disabled Units (0)'
+            ThemeType = tttFlat
           end
           object MapTab: TSpTBXTabItem
             Caption = 'Map options'
+            ThemeType = tttFlat
           end
           object ModTab: TSpTBXTabItem
             Caption = 'Mod options'
+            ThemeType = tttFlat
           end
-          object SpTBXTabSheet1: TSpTBXTabSheet
-            Left = 0
-            Top = 23
-            Width = 390
-            Height = 250
-            Caption = 'Disabled Units (0)'
-            ImageIndex = -1
-            DesignSize = (
-              390
-              250)
-            TabItem = 'DisabledUnitsTab'
-            object UnitsGroupBox: TSpTBXGroupBox
-              Left = 8
-              Top = 4
-              Width = 249
-              Height = 237
-              Caption = 'Disabled units'
-              Anchors = [akLeft, akTop, akBottom]
-              Color = clNone
-              ParentColor = False
-              TabOrder = 0
-              DesignSize = (
-                249
-                237)
-              object AddUnitsSpeedButton: TSpeedButton
-                Left = 120
-                Top = 10
-                Width = 121
-                Height = 22
-                Caption = 'Add more units'
-                OnClick = AddUnitsSpeedButtonClick
-              end
-              object DisabledUnitsListBox: TListBox
-                Left = 8
-                Top = 32
-                Width = 233
-                Height = 193
-                Anchors = [akLeft, akTop, akBottom]
-                Font.Charset = DEFAULT_CHARSET
-                Font.Color = clWindowText
-                Font.Height = -11
-                Font.Name = 'Fixedsys'
-                Font.Style = []
-                ItemHeight = 15
-                MultiSelect = True
-                ParentFont = False
-                TabOrder = 0
-              end
-            end
-          end
           object ModTabSheet: TSpTBXTabSheet
             Left = 0
             Top = 23
@@ -4239,6 +4196,56 @@
               end
             end
           end
+          object SpTBXTabSheet1: TSpTBXTabSheet
+            Left = 0
+            Top = 23
+            Width = 390
+            Height = 250
+            Caption = 'Disabled Units (0)'
+            ImageIndex = -1
+            DesignSize = (
+              390
+              250)
+            TabItem = 'DisabledUnitsTab'
+            object UnitsGroupBox: TSpTBXGroupBox
+              Left = 8
+              Top = 4
+              Width = 249
+              Height = 237
+              Caption = 'Disabled units'
+              Anchors = [akLeft, akTop, akBottom]
+              Color = clNone
+              ParentColor = False
+              TabOrder = 0
+              DesignSize = (
+                249
+                237)
+              object AddUnitsSpeedButton: TSpeedButton
+                Left = 120
+                Top = 10
+                Width = 121
+                Height = 22
+                Caption = 'Add more units'
+                OnClick = AddUnitsSpeedButtonClick
+              end
+              object DisabledUnitsListBox: TListBox
+                Left = 8
+                Top = 32
+                Width = 233
+                Height = 193
+                Anchors = [akLeft, akTop, akBottom]
+                Font.Charset = DEFAULT_CHARSET
+                Font.Color = clWindowText
+                Font.Height = -11
+                Font.Name = 'Fixedsys'
+                Font.Style = []
+                ItemHeight = 15
+                MultiSelect = True
+                ParentFont = False
+                TabOrder = 0
+              end
+            end
+          end
           object SpTBXTabSheet2: TSpTBXTabSheet
             Left = 0
             Top = 23
@@ -4516,7 +4523,7 @@
         Top = 1
         Width = 336
         Height = 273
-        Align = alLeft
+        Align = alClient
         BevelOuter = bvNone
         Constraints.MinWidth = 200
         TabOrder = 1
@@ -5129,6 +5136,7 @@
     object KeepRatioItem: TSpTBXItem
       Caption = 'Keep ratio'
       AutoCheck = True
+      Checked = True
       OnClick = KeepRatioItemClick
     end
   end
@@ -5264,5 +5272,11 @@
       Caption = 'Refresh ranks and cups'
       OnClick = SpTBXItem10Click
     end
+    object SpTBXSeparatorItem8: TSpTBXSeparatorItem
+    end
+    object SpTBXItem12: TSpTBXItem
+      Caption = 'Ladder Headquarters'
+      OnClick = SpTBXItem12Click
+    end
   end
 end

Modified: trunk/Lobby/TASClient/BattleFormUnit.pas
===================================================================
--- trunk/Lobby/TASClient/BattleFormUnit.pas	2008-06-16 21:09:43 UTC (rev 6036)
+++ trunk/Lobby/TASClient/BattleFormUnit.pas	2008-06-16 22:20:02 UTC (rev 6037)
@@ -287,6 +287,8 @@
     Splitter3: TSplitter;
     KeepRatioItem: TSpTBXItem;
     SpTBXSeparatorItem7: TSpTBXSeparatorItem;
+    SpTBXItem12: TSpTBXItem;
+    SpTBXSeparatorItem8: TSpTBXSeparatorItem;
 
     procedure CreateParams(var Params: TCreateParams); override;
 
@@ -490,6 +492,7 @@
     procedure btLoadDefaultMPOClick(Sender: TObject);
     procedure KeepRatioItemClick(Sender: TObject);
     procedure MapPanelResize(Sender: TObject);
+    procedure SpTBXItem12Click(Sender: TObject);
   private
     History: TWideStringList;
     HistoryIndex: Integer;
@@ -1102,9 +1105,22 @@
 var
   MapInfo: TMapInfo;
 begin
-  if MapIndex = -1 then Exit; // you should use ChangeMapToNoMap method instead!
-  if MapIndex &gt; Utility.MapList.Count-1 then Exit; // this should not happen!
-  if MapIndex = CurrentMapIndex then Exit; // no need to change anything, we already have this map loaded!
+  if MapIndex = -1 then // you should use ChangeMapToNoMap method instead!
+  begin
+    MainForm.AddMainLog('Error: map index ('+IntToStr(MapIndex)+') out of bounds.',Colors.Error);
+    Exit;
+  end;
+  if MapIndex &gt; Utility.MapList.Count-1 then // this should not happen!
+  begin
+    MainForm.AddMainLog('Error: map index ('+IntToStr(MapIndex)+') out of bounds.',Colors.Error);
+    Exit;
+  end;
+  if MapIndex = CurrentMapIndex then
+  begin
+    if Debug.Enabled then
+      MainForm.AddMainLog('Debug: map already loaded.',Colors.Normal);
+    Exit; // no need to change anything, we already have this map loaded!
+  end;
     
   {if TMapItem(MapListForm.Maps[MapIndex]).MapImageLoaded then
     MapImage.Picture.Bitmap.Assign(TMapItem(MapListForm.Maps[MapIndex]).MapImage.Picture.Bitmap)
@@ -1799,6 +1815,8 @@
   if UnknownScriptTagList.ValueList &lt;&gt; nil then
     UnknownScriptTagList.ValueList.Clear;
 
+  MainForm.ResetAutoKickMsgSentCounters;
+  MainForm.ResetAutoSpecMsgSentCounters;
 //*** anything else?
 end;
 
@@ -4709,8 +4727,11 @@
 procedure TBattleForm.ReadyButtonClick(Sender: TObject);
 begin
   if (BattleState.LadderIndex &gt; -1) and (Preferences.LadderPassword = '') and not SpectateCheckBox.Checked then begin
-    MessageDlg('You must enter your ladder password in the Options/Account first !',mtWarning,[mbOk],0);
-    Exit;
+    MessageDlg('You must enter your ladder password or register a ladder account in the Options/Account first !',mtWarning,[mbOk],0);
+    PreferencesForm.SpTBXTabControl1.ActiveTabIndex := 1;
+    PreferencesForm.ShowModal;
+    if Preferences.LadderPassword = '' then
+      Exit;
   end;
 
   // check if user has the correct map before readying up:
@@ -5235,6 +5256,8 @@
 
   BattleState.AutoKickRankLimit := True;
   BattleState.AutoSpecRankLimit := False;
+
+  MainForm.ResetAutoSpecMsgSentCounters;
 end;
 
 procedure TBattleForm.SpTBXItem8Click(Sender: TObject);
@@ -5289,6 +5312,7 @@
   BattleState.AutoKickRankLimit := False;
 
   MainForm.ResetAutoKickMsgSentCounters;
+  MainForm.ResetAutoSpecMsgSentCounters;
 end;
 
 procedure TBattleForm.VDTBattleClientsDrawHint(Sender: TBaseVirtualTree;
@@ -6424,4 +6448,9 @@
   RefreshStartRectsPosAndSize;
 end;
 
+procedure TBattleForm.SpTBXItem12Click(Sender: TObject);
+begin
+  Misc.OpenURLInDefaultBrowser('<A HREF="http://springladder.no-ip.org/">http://springladder.no-ip.org/</A>');
+end;
+
 end.

Modified: trunk/Lobby/TASClient/Graphics/join1.bmp
===================================================================
(Binary files differ)

Modified: trunk/Lobby/TASClient/Graphics/join2.bmp
===================================================================
(Binary files differ)

Modified: trunk/Lobby/TASClient/Graphics/join3.bmp
===================================================================
(Binary files differ)

Modified: trunk/Lobby/TASClient/HostBattleFormUnit.pas
===================================================================
--- trunk/Lobby/TASClient/HostBattleFormUnit.pas	2008-06-16 21:09:43 UTC (rev 6036)
+++ trunk/Lobby/TASClient/HostBattleFormUnit.pas	2008-06-16 22:20:02 UTC (rev 6037)
@@ -69,9 +69,15 @@
   private
     DownloadLadderDetailsIndex : integer;
     DownloadAllRulesAtOnce : boolean;
+    StatusMsg: string;
+    procedure Initialize;
+    procedure Finalize;
+    procedure PopulateMenu;
     procedure Refresh;
     function DownloadLadderDetails(ladderIndex : integer):boolean;
     function DownloadAllLadderDetails: boolean;
+    procedure ShowMessageStatus;
+    procedure UpdateMessageStatus(msg : string);
     procedure OnTerminateProcedure(Sender : TObject);
 
   protected
@@ -150,7 +156,7 @@
   end;
 
   ReInitLib;
-  LoadMod(Utility.ModArchiveList[Utility.ModList.IndexOf(ModsComboBox.Text)]);
+  LoadMod(Utility.ModArchiveList[Utility.ModList.IndexOf(ModsComboBox.Items[ModsComboBox.ItemIndex])]);
   validMaps:=GetModValidMapList;
   if validMaps.Count &gt; 0 then
   begin
@@ -719,6 +725,36 @@
     Refresh;
 end;
 
+procedure TLadderListThread.Initialize;
+begin
+  HostBattleForm.LadderComboBox.Clear;
+  HostBattleForm.LadderComboBox.Items.Add('Loading ladder list ...');
+  HostBattleForm.LadderComboBox.ItemIndex := 0;
+  HostBattleForm.HostButton.Enabled := False;
+  HostBattleForm.RefreshButton.Enabled := False;
+end;
+
+procedure TLadderListThread.Finalize;
+begin
+  HostBattleForm.RefreshButton.Enabled := True;
+  HostBattleForm.HostButton.Enabled := True;
+end;
+
+procedure TLadderListThread.PopulateMenu;
+var
+  j: integer;
+begin
+  with HostBattleForm do
+  begin
+    LadderComboBox.Clear;
+    for j:=0 to LadderList.Count -1 do
+      LadderComboBox.Items.Add(TLadder(LadderList[j]).Name);
+    LadderComboBox.ItemIndex := 0;
+    ApplyLadderParams(TLadder(LadderList[0]));
+  end;
+end;
+
+
 procedure TLadderListThread.Refresh;
 var
   i,j,k:integer;
@@ -732,12 +768,9 @@
   LadderList.Clear;
 
   with HostBattleForm do begin
-    LadderComboBox.Clear;
-    LadderComboBox.Items.Add('Loading ladder list ...');
-    LadderComboBox.ItemIndex := 0;
-    HostButton.Enabled := False;
-    RefreshButton.Enabled := False;
 
+    Synchronize(Initialize);
+
     if Preferences.UseProxy then
     begin
       HttpCli1.Proxy := Preferences.ProxyAddress;
@@ -752,10 +785,8 @@
       HttpCli1.Get;
     except
       MainForm.AddMainLog('Error: Ladder server unavailable.', Colors.Error);
-      LadderComboBox.Items.Strings[0] := 'Error: Ladder server unavailable.';
-      LadderComboBox.ItemIndex := 0;
-      RefreshButton.Enabled := True;
-      HostButton.Enabled := True;
+      UpdateMessageStatus('Error: Ladder server unavailable.');
+      Synchronize(Finalize);
       LadderList.Clear;
       Exit;
     end;
@@ -789,23 +820,17 @@
             LadderList.Add(ladder^);
             if not DownloadLadderDetails(LadderList.indexof(ladder^)) then begin
               MainForm.AddMainLog('Error: Ladder details download failed : '+IntToStr(ladder^.id)+'.', Colors.Error);
-              LadderComboBox.Items.Strings[0] := 'Error: Ladder details download failed : '+IntToStr(ladder^.id)+'.';
-              LadderComboBox.ItemIndex := 0;
-              HostButton.Enabled := True;
-              RefreshButton.Enabled := True;
+              UpdateMessageStatus('Error: Ladder details download failed : '+IntToStr(ladder^.id)+'.');
+              Synchronize(Finalize);
               Exit;
             end;
           end;
         end;
     end;
-    LadderComboBox.Clear;
-    for j:=0 to LadderList.Count -1 do
-      LadderComboBox.Items.Add(TLadder(LadderList[j]).Name);
-    LadderComboBox.ItemIndex := 0;
-    ApplyLadderParams(TLadder(LadderList[0]));
+
+    Synchronize(PopulateMenu);
     parse1.Clear;
-    HostButton.Enabled := True;
-    RefreshButton.Enabled := True;
+    Synchronize(Finalize);
   end;
 end;
 
@@ -939,12 +964,9 @@
   parse1 := TStringList.Create;
   parse2 := TStringList.Create;
   with HostBattleForm do begin
-    LadderComboBox.Clear;
-    LadderComboBox.Items.Add('Loading ladder list ...');
-    LadderComboBox.ItemIndex := 0;
-    HostButton.Enabled := False;
-    RefreshButton.Enabled := False;
 
+    Synchronize(Initialize);
+
     if Preferences.UseProxy then
     begin
       HttpCli1.Proxy := Preferences.ProxyAddress;
@@ -959,10 +981,8 @@
       HttpCli1.Get;
     except
       MainForm.AddMainLog('Error: Ladder server unavailable.', Colors.Error);
-      LadderComboBox.Items.Strings[0] := 'Error: Ladder server unavailable.';
-      LadderComboBox.ItemIndex := 0;
-      RefreshButton.Enabled := True;
-      HostButton.Enabled := True;
+      UpdateMessageStatus('Error: Ladder server unavailable.');
+      Synchronize(Finalize);
       LadderList.Clear;
       Exit;
     end;
@@ -1057,27 +1077,32 @@
           Except
             MessageDlgThread('An error occured while parsing the ladder details !',mtError,[mbOk],0);
             Result := False;
-            LadderComboBox.Items.Strings[0] := 'Error: Ladders details download failed.';
-            LadderComboBox.ItemIndex := 0;
-            RefreshButton.Enabled := True;
-            HostButton.Enabled := True;
+            UpdateMessageStatus('Error: Ladders details download failed.');
+            Synchronize(Finalize);
             LadderList.Clear;
             Exit;
           end;
         end;
     end;
 
-    LadderComboBox.Clear;
-    for j:=0 to LadderList.Count -1 do
-      LadderComboBox.Items.Add(TLadder(LadderList[j]).Name);
-    LadderComboBox.ItemIndex := 0;
-    ApplyLadderParams(TLadder(LadderList[0]));
+    Synchronize(PopulateMenu);
     parse1.Clear;
-    HostButton.Enabled := True;
-    RefreshButton.Enabled := True;
+    Synchronize(Finalize);
   end;
 end;
 
+procedure TLadderListThread.ShowMessageStatus;
+begin
+  HostBattleForm.LadderComboBox.Items.Strings[0] := StatusMsg;
+  HostBattleForm.LadderComboBox.ItemIndex := 0;
+end;
+
+procedure TLadderListThread.UpdateMessageStatus(msg : string);
+begin
+  StatusMsg := msg;
+  Synchronize(ShowMessageStatus);
+end;
+
 procedure TLadderListThread.OnTerminateProcedure(Sender: TObject);
 begin
   // nothing

Modified: trunk/Lobby/TASClient/MainUnit.dfm
===================================================================
--- trunk/Lobby/TASClient/MainUnit.dfm	2008-06-16 21:09:43 UTC (rev 6036)
+++ trunk/Lobby/TASClient/MainUnit.dfm	2008-06-16 22:20:02 UTC (rev 6037)
@@ -1,6 +1,6 @@
 object MainForm: TMainForm
-  Left = 274
-  Top = 239
+  Left = 412
+  Top = 200
   Width = 808
   Height = 549
   Caption = '.'
@@ -137,7 +137,7 @@
       Align = alClient
       TabOrder = 2
       Borders = False
-      BorderType = pbrRaised
+      BorderType = pbrBumped
       object Bevel2: TBevel
         Left = 2
         Top = 43
@@ -148,373 +148,19 @@
       end
       object Panel3: TPanel
         Left = 2
-        Top = 227
+        Top = 211
         Width = 625
-        Height = 259
+        Height = 275
         Align = alClient
         BevelOuter = bvNone
         TabOrder = 0
-        object FilterGroup: TSpTBXGroupBox
-          Left = 0
-          Top = 86
-          Width = 625
-          Height = 173
-          Caption = 'Filters'
-          Align = alBottom
-          Font.Charset = DEFAULT_CHARSET
-          Font.Color = clWindowText
-          Font.Height = -11
-          Font.Name = 'MS Sans Serif'
-          Font.Style = []
-          ParentFont = False
-          TabOrder = 0
-          OnResize = FilterGroupResize
-          object FilterValueTextBox: TSpTBXEdit
-            Left = 216
-            Top = 16
-            Width = 161
-            Height = 21
-            TabOrder = 0
-          end
-          object ContainsRadio: TSpTBXRadioButton
-            Left = 112
-            Top = 12
-            Width = 58
-            Height = 15
-            Caption = 'contains'
-            TabOrder = 1
-          end
-          object DoNotContainsRadio: TSpTBXRadioButton
-            Left = 112
-            Top = 28
-            Width = 97
-            Height = 15
-            Caption = 'does not contain'
-            TabOrder = 2
-            TabStop = True
-            Checked = True
-          end
-          object AddToFilterListButton: TSpTBXButton
-            Left = 384
-            Top = 16
-            Width = 33
-            Height = 25
-            Caption = '-&gt;'
-            TabOrder = 3
-            OnClick = AddToFilterListButtonClick
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
-          object FilterListCombo: TSpTBXComboBox
-            Left = 16
-            Top = 16
-            Width = 89
-            Height = 21
-            Style = csDropDownList
-            ItemHeight = 13
-            ItemIndex = 1
-            TabOrder = 4
-            Text = 'Map'
-            Items.Strings = (
-              'Host'
-              'Map'
-              'Mod'
-              'Description')
-          end
-          object RemoveFromFilterListButton: TSpTBXButton
-            Left = 384
-            Top = 48
-            Width = 33
-            Height = 25
-            Caption = '&lt;-'
-            TabOrder = 5
-            OnClick = RemoveFromFilterListButtonClick
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
-          object ClearFilterListButton: TSpTBXButton
-            Left = 384
-            Top = 80
-            Width = 33
-            Height = 25
-            Caption = 'Clear'
-            TabOrder = 6
-            OnClick = ClearFilterListButtonClick
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
-          object EnableFilters: TSpTBXCheckBox
-            Left = 8
-            Top = 150
-            Width = 110
-            Height = 18
-            Caption = 'Enable filters'
-            Font.Charset = DEFAULT_CHARSET
-            Font.Color = clWindowText
-            Font.Height = -13
-            Font.Name = 'MS Sans Serif'
-            Font.Style = [fsBold]
-            ParentFont = False
-            TabOrder = 7
-            OnClick = EnableFiltersClick
-          end
-          object FilterList: TVirtualStringTree
-            Left = 424
-            Top = 16
-            Width = 177
-            Height = 145
-            CheckImageKind = ckSystem
-            ClipboardFormats.Strings = (
-              'Unicode text')
-            CustomCheckImages = ButtonImageList
-            DragOperations = []
-            Header.AutoSizeIndex = 3
-            Header.Font.Charset = DEFAULT_CHARSET
-            Header.Font.Color = clWindowText
-            Header.Font.Height = -11
-            Header.Font.Name = 'MS Sans Serif'
-            Header.Font.Style = []
-            Header.Options = [hoAutoResize, hoColumnResize, hoDrag, hoShowSortGlyphs, hoVisible]
-            Header.SortColumn = 1
-            Header.Style = hsFlatButtons
-            TabOrder = 8
-            TreeOptions.AutoOptions = [toAutoDropExpand, toAutoScrollOnExpand, toAutoSort, toAutoTristateTracking, toAutoDeleteMovedNodes]
-            TreeOptions.MiscOptions = [toAcceptOLEDrop, toCheckSupport, toFullRepaintOnResize, toInitOnSave, toToggleOnDblClick, toWheelPanning]
-            TreeOptions.PaintOptions = [toShowButtons, toShowDropmark, toThemeAware, toUseBlendedImages]
-            TreeOptions.SelectionOptions = [toFullRowSelect, toMultiSelect]
-            OnChecking = FilterListChecking
-            OnCompareNodes = FilterListCompareNodes
-            OnGetText = FilterListGetText
-            OnHeaderClick = FilterListHeaderClick
-            OnResize = FilterListResize
-            Columns = &lt;
-              item
-                MaxWidth = 20
-                MinWidth = 20
-                Options = [coAllowClick, coEnabled, coParentBidiMode, coParentColor, coShowDropMark, coVisible, coFixed]
-                Position = 0
-                Width = 20
-              end
-              item
-                Options = [coAllowClick, coEnabled, coParentBidiMode, coParentColor, coResizable, coShowDropMark, coVisible]
-                Position = 1
-                Width = 80
-                WideText = 'Type'
-              end
-              item
-                Options = [coAllowClick, coEnabled, coParentBidiMode, coParentColor, coResizable, coShowDropMark, coVisible]
-                Position = 2
-                Width = 63
-                WideText = ' '
-              end
-              item
-                Position = 3
-                Width = 10
-                WideText = 'Value'
-              end&gt;
-          end
-          object SpTBXPanel1: TSpTBXPanel
-            Left = 8
-            Top = 48
-            Width = 369
-            Height = 97
-            Caption = 'SpTBXPanel1'
-            ThemeType = thtWindows
-            TabOrder = 9
-            BorderType = pbrRaised
-            object FullFilter: TSpTBXCheckBox
-              Left = 8
-              Top = 8
-              Width = 34
-              Height = 15
-              Caption = 'Full'
-              TabOrder = 0
-              OnClick = FullFilterClick
-            end
-            object InProgressFilter: TSpTBXCheckBox
-              Left = 8
-              Top = 24
-              Width = 70
-              Height = 15
-              Caption = 'In progress'
-              TabOrder = 1
-              OnClick = InProgressFilterClick
-            end
-            object LadderFilter: TSpTBXCheckBox
-              Left = 8
-              Top = 40
-              Width = 51
-              Height = 15
-              Caption = 'Ladder'
-              TabOrder = 2
-              OnClick = LadderFilterClick
-            end
-            object LockedFilter: TSpTBXCheckBox
-              Left = 8
-              Top = 56
-              Width = 54
-              Height = 15
-              Caption = 'Locked'
-              TabOrder = 3
-              OnClick = LockedFilterClick
-            end
-            object PasswordedFilter: TSpTBXCheckBox
-              Left = 8
-              Top = 72
-              Width = 76
-              Height = 15
-              Caption = 'Passworded'
-              TabOrder = 4
-              OnClick = PasswordedFilterClick
-            end
-            object RankLimitFilter: TSpTBXCheckBox
-              Left = 88
-              Top = 72
-              Width = 114
-              Height = 15
-              Caption = 'Rank limit &gt; My rank'
-              TabOrder = 5
-              OnClick = RankLimitFilterClick
-            end
-            object ReplaysFilter: TSpTBXCheckBox
-              Left = 88
-              Top = 56
-              Width = 51
-              Height = 15
-              Caption = 'Replay'
-              TabOrder = 6
-              OnClick = ReplaysFilterClick
-            end
-            object ModsNotAvailableFilter: TSpTBXCheckBox
-              Left = 88
-              Top = 40
-              Width = 102
-              Height = 15
-              Caption = 'Mod not available'
-              TabOrder = 7
-              OnClick = ModsNotAvailableFilterClick
-            end
-            object MapsNotAvailableFilter: TSpTBXCheckBox
-              Left = 88
-              Top = 24
-              Width = 102
-              Height = 15
-              Caption = 'Map not available'
-              TabOrder = 8
-              OnClick = MapsNotAvailableFilterClick
-            end
-            object NatTraversalFilter: TSpTBXCheckBox
-              Left = 88
-              Top = 8
-              Width = 78
-              Height = 15
-              Caption = 'Nat traversal'
-              TabOrder = 9
-              OnClick = NatTraversalFilterClick
-            end
-            object PlayersSignButton: TSpTBXButton
-              Left = 296
-              Top = 8
-              Width = 25
-              Height = 20
-              Caption = '&lt;'
-              TabOrder = 10
-              OnClick = PlayersSignButtonClick
-              LinkFont.Charset = DEFAULT_CHARSET
-              LinkFont.Color = clBlue
-              LinkFont.Height = -11
-              LinkFont.Name = 'MS Sans Serif'
-              LinkFont.Style = [fsUnderline]
-            end
-            object PlayersValueTextBox: TJvSpinEdit
-              Left = 320
-              Top = 8
-              Width = 41
-              Height = 20
-              ButtonKind = bkStandard
-              MaxValue = 16.000000000000000000
-              Value = 10.000000000000000000
-              TabOrder = 11
-              OnChange = PlayersValueTextBoxChange
-            end
-            object MaxPlayersSignButton: TSpTBXButton
-              Left = 296
-              Top = 39
-              Width = 25
-              Height = 20
-              Caption = '&lt;'
-              TabOrder = 12
-              OnClick = MaxPlayersSignButtonClick
-              LinkFont.Charset = DEFAULT_CHARSET
-              LinkFont.Color = clBlue
-              LinkFont.Height = -11
-              LinkFont.Name = 'MS Sans Serif'
-              LinkFont.Style = [fsUnderline]
-            end
-            object MaxPlayersValueTextBox: TJvSpinEdit
-              Left = 320
-              Top = 39
-              Width = 41
-              Height = 20
-              ButtonKind = bkStandard
-              MaxValue = 16.000000000000000000
-              MinValue = 1.000000000000000000
-              Value = 10.000000000000000000
-              TabOrder = 13
-              OnChange = MaxPlayersValueTextBoxChange
-            end
-            object MaxPlayersFilter: TSpTBXCheckBox
-              Left = 216
-              Top = 40
-              Width = 78
-              Height = 15
-              Caption = 'Max Players '
-              TabOrder = 14
-              OnClick = MaxPlayersFilterClick
-            end
-            object PlayersFilter: TSpTBXCheckBox
-              Left = 216
-              Top = 10
-              Width = 55
-              Height = 15
-              Caption = 'Players '
-              TabOrder = 15
-              OnClick = PlayersFilterClick
-            end
-          end
-        end
-        object FiltersButton: TSpTBXButton
-          Left = 0
-          Top = 74
-          Width = 625
-          Height = 12
-          Align = alBottom
-          TabOrder = 1
-          OnClick = FiltersButtonClick
-          Images = ArrowList
-          ImageIndex = 0
-          LinkFont.Charset = DEFAULT_CHARSET
-          LinkFont.Color = clBlue
-          LinkFont.Height = -11
-          LinkFont.Name = 'MS Sans Serif'
-          LinkFont.Style = [fsUnderline]
-        end
         object BattlesPanel: TSpTBXPanel
           Left = 0
           Top = 0
           Width = 625
-          Height = 74
+          Height = 275
           Align = alClient
-          TabOrder = 2
+          TabOrder = 0
           Borders = False
           object QuickJoinPanel: TSpTBXPanel
             Left = 2
@@ -524,7 +170,7 @@
             Hint = 'Quick join panel'
             Caption = 'QuickJoinPanel'
             Align = alTop
-            TabOrder = 0
+            TabOrder = 1
             Borders = False
             DesignSize = (
               621
@@ -619,7 +265,7 @@
             Left = 2
             Top = 27
             Width = 621
-            Height = 45
+            Height = 61
             Align = alClient
             BevelInner = bvNone
             BevelOuter = bvNone
@@ -644,7 +290,7 @@
             ParentShowHint = False
             PopupMenu = BattleListPopupMenu
             ShowHint = True
-            TabOrder = 1
+            TabOrder = 2
             TreeOptions.MiscOptions = [toAcceptOLEDrop, toCheckSupport, toFullRepaintOnResize, toInitOnSave, toToggleOnDblClick, toWheelPanning]
             TreeOptions.PaintOptions = [toHideFocusRect, toShowButtons, toShowDropmark, toThemeAware, toUseBlendedImages]
             TreeOptions.SelectionOptions = [toFullRowSelect]
@@ -728,6 +374,491 @@
                   'mes the list of players in that battle.'
               end&gt;
           end
+          object FilterGroup: TSpTBXPanel
+            Left = 2
+            Top = 100
+            Width = 621
+            Height = 173
+            Caption = 'FilterGroup'
+            Align = alBottom
+            TabOrder = 0
+            OnResize = FilterGroupResize
+            Borders = False
+            DesignSize = (
+              621
+              173)
+            object FiltersTabs: TSpTBXTabControl
+              Left = 2
+              Top = 2
+              Width = 617
+              Height = 169
+              Align = alClient
+              Color = clBtnFace
+              ActiveTabIndex = 1
+              TabPosition = ttpBottom
+              ThemeType = tttNone
+              HiddenItems = &lt;&gt;
+              object SpTBXTabItem1: TSpTBXTabItem
+                Caption = 'Filters'
+                TabPosition = ttpBottom
+                ThemeType = tttNone
+              end
+              object SpTBXTabItem2: TSpTBXTabItem
+                Caption = 'Presets'
+                Checked = True
+                TabPosition = ttpBottom
+                ThemeType = tttNone
+              end
+              object SpTBXTabSheet1: TSpTBXTabSheet
+                Left = 0
+                Top = 0
+                Width = 617
+                Height = 146
+                Caption = 'Filters'
+                ImageIndex = -1
+                TabItem = 'SpTBXTabItem1'
+                object FilterList: TVirtualStringTree
+                  Left = 424
+                  Top = 8
+                  Width = 177
+                  Height = 129
+                  CheckImageKind = ckSystem
+                  ClipboardFormats.Strings = (
+                    'Unicode text')
+                  CustomCheckImages = ButtonImageList
+                  DragOperations = []
+                  Header.AutoSizeIndex = 3
+                  Header.Font.Charset = DEFAULT_CHARSET
+                  Header.Font.Color = clWindowText
+                  Header.Font.Height = -11
+                  Header.Font.Name = 'MS Sans Serif'
+                  Header.Font.Style = []
+                  Header.Options = [hoAutoResize, hoColumnResize, hoDrag, hoShowSortGlyphs, hoVisible]
+                  Header.SortColumn = 1
+                  Header.Style = hsFlatButtons
+                  TabOrder = 0
+                  TreeOptions.AutoOptions = [toAutoDropExpand, toAutoScrollOnExpand, toAutoSort, toAutoTristateTracking, toAutoDeleteMovedNodes]
+                  TreeOptions.MiscOptions = [toAcceptOLEDrop, toCheckSupport, toFullRepaintOnResize, toInitOnSave, toToggleOnDblClick, toWheelPanning]
+                  TreeOptions.PaintOptions = [toShowButtons, toShowDropmark, toThemeAware, toUseBlendedImages]
+                  TreeOptions.SelectionOptions = [toFullRowSelect, toMultiSelect]
+                  OnChecking = FilterListChecking
+                  OnCompareNodes = FilterListCompareNodes
+                  OnGetText = FilterListGetText
+                  OnHeaderClick = FilterListHeaderClick
+                  OnResize = FilterListResize
+                  Columns = &lt;
+                    item
+                      MaxWidth = 20
+                      MinWidth = 20
+                      Options = [coAllowClick, coEnabled, coParentBidiMode, coParentColor, coShowDropMark, coVisible, coFixed]
+                      Position = 0
+                      Width = 20
+                    end
+                    item
+                      Options = [coAllowClick, coEnabled, coParentBidiMode, coParentColor, coResizable, coShowDropMark, coVisible]
+                      Position = 1
+                      Width = 80
+                      WideText = 'Type'
+                    end
+                    item
+                      Options = [coAllowClick, coEnabled, coParentBidiMode, coParentColor, coResizable, coShowDropMark, coVisible]
+                      Position = 2
+                      Width = 63
+                      WideText = ' '
+                    end
+                    item
+                      Position = 3
+                      Width = 10
+                      WideText = 'Value'
+                    end&gt;
+                end
+                object ClearFilterListButton: TSpTBXButton
+                  Left = 384
+                  Top = 72
+                  Width = 33
+                  Height = 25
+                  Caption = 'Clear'
+                  TabOrder = 1
+                  OnClick = ClearFilterListButtonClick
+                  LinkFont.Charset = DEFAULT_CHARSET
+                  LinkFont.Color = clBlue
+                  LinkFont.Height = -11
+                  LinkFont.Name = 'MS Sans Serif'
+                  LinkFont.Style = [fsUnderline]
+                end
+                object RemoveFromFilterListButton: TSpTBXButton
+                  Left = 384
+                  Top = 40
+                  Width = 33
+                  Height = 25
+                  Caption = '&lt;-'
+                  TabOrder = 2
+                  OnClick = RemoveFromFilterListButtonClick
+                  LinkFont.Charset = DEFAULT_CHARSET
+                  LinkFont.Color = clBlue
+                  LinkFont.Height = -11
+                  LinkFont.Name = 'MS Sans Serif'
+                  LinkFont.Style = [fsUnderline]
+                end
+                object AddToFilterListButton: TSpTBXButton
+                  Left = 384
+                  Top = 8
+                  Width = 33
+                  Height = 25
+                  Caption = '-&gt;'
+                  TabOrder = 3
+                  OnClick = AddToFilterListButtonClick
+                  LinkFont.Charset = DEFAULT_CHARSET
+                  LinkFont.Color = clBlue
+                  LinkFont.Height = -11
+                  LinkFont.Name = 'MS Sans Serif'
+                  LinkFont.Style = [fsUnderline]
+                end
+                object FilterValueTextBox: TSpTBXEdit
+                  Left = 216
+                  Top = 8
+                  Width = 161
+                  Height = 21
+                  TabOrder = 4
+                end
+                object DoNotContainsRadio: TSpTBXRadioButton
+                  Left = 112
+                  Top = 20
+                  Width = 97
+                  Height = 15
+                  Caption = 'does not contain'
+                  TabOrder = 5
+                  TabStop = True
+                  Checked = True
+                end
+                object ContainsRadio: TSpTBXRadioButton
+                  Left = 112
+                  Top = 4
+                  Width = 58
+                  Height = 15
+                  Caption = 'contains'
+                  TabOrder = 6
+                end
+                object FilterListCombo: TSpTBXComboBox
+                  Left = 16
+                  Top = 8
+                  Width = 89
+                  Height = 21
+                  Style = csDropDownList
+                  ItemHeight = 13
+                  ItemIndex = 1
+                  TabOrder = 7
+                  Text = 'Map'
+                  Items.Strings = (
+                    'Host'
+                    'Map'
+                    'Mod'
+                    'Description')
+                end
+                object SpTBXPanel2: TSpTBXPanel
+                  Left = 8
+                  Top = 40
+                  Width = 369
+                  Height = 97
+                  Caption = 'SpTBXPanel1'
+                  ThemeType = thtWindows
+                  TabOrder = 8
+                  BorderType = pbrRaised
+                  object FullFilter: TSpTBXCheckBox
+                    Left = 8
+                    Top = 8
+                    Width = 34
+                    Height = 15
+                    Caption = 'Full'
+                    TabOrder = 0
+                    OnClick = FullFilterClick
+                  end
+                  object InProgressFilter: TSpTBXCheckBox
+                    Left = 8
+                    Top = 24
+                    Width = 70
+                    Height = 15
+                    Caption = 'In progress'
+                    TabOrder = 1
+                    OnClick = InProgressFilterClick
+                  end
+                  object LadderFilter: TSpTBXCheckBox
+                    Left = 8
+                    Top = 40
+                    Width = 51
+                    Height = 15
+                    Caption = 'Ladder'
+                    TabOrder = 2
+                    OnClick = LadderFilterClick
+                  end
+                  object LockedFilter: TSpTBXCheckBox
+                    Left = 8
+                    Top = 56
+                    Width = 54
+                    Height = 15
+                    Caption = 'Locked'
+                    TabOrder = 3
+                    OnClick = LockedFilterClick
+                  end
+                  object PasswordedFilter: TSpTBXCheckBox
+                    Left = 8
+                    Top = 72
+                    Width = 76
+                    Height = 15
+                    Caption = 'Passworded'
+                    TabOrder = 4
+                    OnClick = PasswordedFilterClick
+                  end
+                  object RankLimitFilter: TSpTBXCheckBox
+                    Left = 88
+                    Top = 72
+                    Width = 114
+                    Height = 15
+                    Caption = 'Rank limit &gt; My rank'
+                    TabOrder = 5
+                    OnClick = RankLimitFilterClick
+                  end
+                  object ReplaysFilter: TSpTBXCheckBox
+                    Left = 88
+                    Top = 56
+                    Width = 51
+                    Height = 15
+                    Caption = 'Replay'
+                    TabOrder = 6
+                    OnClick = ReplaysFilterClick
+                  end
+                  object ModsNotAvailableFilter: TSpTBXCheckBox
+                    Left = 88
+                    Top = 40
+                    Width = 102
+                    Height = 15
+                    Caption = 'Mod not available'
+                    TabOrder = 7
+                    OnClick = ModsNotAvailableFilterClick
+                  end
+                  object MapsNotAvailableFilter: TSpTBXCheckBox
+                    Left = 88
+                    Top = 24
+                    Width = 102
+                    Height = 15
+                    Caption = 'Map not available'
+                    TabOrder = 8
+                    OnClick = MapsNotAvailableFilterClick
+                  end
+                  object NatTraversalFilter: TSpTBXCheckBox
+                    Left = 88
+                    Top = 8
+                    Width = 78
+                    Height = 15
+                    Caption = 'Nat traversal'
+                    TabOrder = 9
+                    OnClick = NatTraversalFilterClick
+                  end
+                  object PlayersSignButton: TSpTBXButton
+                    Left = 296
+                    Top = 8
+                    Width = 25
+                    Height = 20
+                    Caption = '&lt;'
+                    TabOrder = 10
+                    OnClick = PlayersSignButtonClick
+                    LinkFont.Charset = DEFAULT_CHARSET
+                    LinkFont.Color = clBlue
+                    LinkFont.Height = -11
+                    LinkFont.Name = 'MS Sans Serif'
+                    LinkFont.Style = [fsUnderline]
+                  end
+                  object PlayersValueTextBox: TJvSpinEdit
+                    Left = 320
+                    Top = 8
+                    Width = 41
+                    Height = 20
+                    ButtonKind = bkStandard
+                    MaxValue = 16.000000000000000000
+                    Value = 10.000000000000000000
+                    TabOrder = 11
+                    OnChange = PlayersValueTextBoxChange
+                  end
+                  object MaxPlayersSignButton: TSpTBXButton
+                    Left = 296
+                    Top = 39
+                    Width = 25
+                    Height = 20
+                    Caption = '&lt;'
+                    TabOrder = 12
+                    OnClick = MaxPlayersSignButtonClick
+                    LinkFont.Charset = DEFAULT_CHARSET
+                    LinkFont.Color = clBlue
+                    LinkFont.Height = -11
+                    LinkFont.Name = 'MS Sans Serif'
+                    LinkFont.Style = [fsUnderline]
+                  end
+                  object MaxPlayersValueTextBox: TJvSpinEdit
+                    Left = 320
+                    Top = 39
+                    Width = 41
+                    Height = 20
+                    ButtonKind = bkStandard
+                    MaxValue = 16.000000000000000000
+                    MinValue = 1.000000000000000000
+                    Value = 10.000000000000000000
+                    TabOrder = 13
+                    OnChange = MaxPlayersValueTextBoxChange
+                  end
+                  object MaxPlayersFilter: TSpTBXCheckBox
+                    Left = 216
+                    Top = 40
+                    Width = 78
+                    Height = 15
+                    Caption = 'Max Players '
+                    TabOrder = 14
+                    OnClick = MaxPlayersFilterClick
+                  end
+                  object PlayersFilter: TSpTBXCheckBox
+                    Left = 216
+                    Top = 10
+                    Width = 55
+                    Height = 15
+                    Caption = 'Players '
+                    TabOrder = 15
+                    OnClick = PlayersFilterClick
+                  end
+                end
+              end
+              object SpTBXTabSheet2: TSpTBXTabSheet
+                Left = 0
+                Top = 0
+                Width = 617
+                Height = 146
+                Caption = 'Presets'
+                ImageIndex = -1
+                DesignSize = (
+                  617
+                  146)
+                TabItem = 'SpTBXTabItem2'
+                object PresetListbox: TSpTBXListBox
+                  Left = 152
+                  Top = 26
+                  Width = 457
+                  Height = 113
+                  Anchors = [akLeft, akTop, akRight]
+                  ItemHeight = 16
+                  Items.Strings = (
+                    'default')
+                  TabOrder = 0
+                  OnClick = PresetListboxClick
+                end
+                object SpTBXLabel3: TSpTBXLabel
+                  Left = 152
+                  Top = 8
+                  Width = 64
+                  Height = 16
+                  Caption = 'Preset list :'
+                  Font.Charset = DEFAULT_CHARSET
+                  Font.Color = clWindowText
+                  Font.Height = -13
+                  Font.Name = 'MS Sans Serif'
+                  Font.Style = []
+                  ParentFont = False
+                  LinkFont.Charset = DEFAULT_CHARSET
+                  LinkFont.Color = clBlue
+                  LinkFont.Height = -11
+                  LinkFont.Name = 'MS Sans Serif'
+                  LinkFont.Style = [fsUnderline]
+                end
+                object SpTBXGroupBox1: TSpTBXGroupBox
+                  Left = 8
+                  Top = 8
+                  Width = 137
+                  Height = 129
+                  Caption = 'Options'
+                  TabOrder = 2
+                  object btDeletePreset: TSpTBXButton
+                    Left = 8
+                    Top = 72
+                    Width = 121
+                    Height = 25
+                    Caption = 'Delete'
+                    TabOrder = 1
+                    OnClick = btDeletePresetClick
+                    LinkFont.Charset = DEFAULT_CHARSET
+                    LinkFont.Color = clBlue
+                    LinkFont.Height = -11
+                    LinkFont.Name = 'MS Sans Serif'
+                    LinkFont.Style = [fsUnderline]
+                  end
+                  object btSavePreset: TSpTBXButton
+                    Left = 8
+                    Top = 40
+                    Width = 121
+                    Height = 25
+                    Caption = 'Save'
+                    TabOrder = 2
+                    OnClick = btSavePresetClick
+                    LinkFont.Charset = DEFAULT_CHARSET
+                    LinkFont.Color = clBlue
+                    LinkFont.Height = -11
+                    LinkFont.Name = 'MS Sans Serif'
+                    LinkFont.Style = [fsUnderline]
+                  end
+                  object PresetNameTextbox: TSpTBXEdit
+                    Left = 8
+                    Top = 18
+                    Width = 121
+                    Height = 21
+                    TabOrder = 3
+                    Text = 'Preset name'
+                  end
+                  object btClearPreset: TSpTBXButton
+                    Left = 8
+                    Top = 96
+                    Width = 121
+                    Height = 25
+                    Caption = 'Clear'
+                    TabOrder = 0
+                    OnClick = btClearPresetClick
+                    LinkFont.Charset = DEFAULT_CHARSET
+                    LinkFont.Color = clBlue
+                    LinkFont.Height = -11
+                    LinkFont.Name = 'MS Sans Serif'
+                    LinkFont.Style = [fsUnderline]
+                  end
+                end
+              end
+            end
+            object EnableFilters: TSpTBXCheckBox
+              Left = 501
+              Top = 154
+              Width = 110
+              Height = 18
+              Caption = 'Enable filters'
+              Anchors = [akTop, akRight]
+              Font.Charset = DEFAULT_CHARSET
+              Font.Color = clWindowText
+              Font.Height = -13
+              Font.Name = 'MS Sans Serif'
+              Font.Style = [fsBold]
+              ParentFont = False
+              TabOrder = 1
+              OnClick = EnableFiltersClick
+            end
+          end
+          object FiltersButton: TSpTBXButton
+            Left = 2
+            Top = 88
+            Width = 621
+            Height = 12
+            Align = alBottom
+            TabOrder = 3
+            OnClick = FiltersButtonClick
+            Images = ArrowList
+            ImageIndex = 0
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
+          end
         end
       end
       object Panel4: TSpTBXPanel
@@ -1011,7 +1142,7 @@
         Left = 2
         Top = 47
         Width = 625
-        Height = 170
+        Height = 154
         Align = alTop
         Constraints.MinHeight = 1
         Style = tsButtons
@@ -1022,7 +1153,7 @@
       end
       object Splitter2: TSpTBXSplitter
         Left = 2
-        Top = 217
+        Top = 201
         Width = 625
         Height = 10
         Cursor = crSizeNS
@@ -1049,7 +1180,7 @@
     Left = 176
     Top = 296
     Bitmap = {
-      494C010119001D00040010001000FFFFFFFFFF10FFFFFFFFFFFFFFFF424D3600
+      494C010119001D00040010001000FFFFFFFFFF00FFFFFFFFFFFFFFFF424D3600
       0000000000003600000028000000400000008000000001002000000000000080
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
@@ -1179,129 +1310,129 @@
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
-      0000000000000000000000000000000000000000000000000000000000004242
-      4200636363006B6B6B006B6B6B006B6B6B006B6B6B006B6B6B006B6B6B006363
-      6300424242000000000000000000000000000000000000000000000000000000
+      0000000000000000000000000000000000000000000000000000000000004646
+      4600606060006F6F6F006F6F6F006F6F6F006F6F6F006F6F6F006F6F6F006060
+      6000464646000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
-      000000000000000000000000000000000000000000000000000052525200B5B5
-      B500B5B5B500B5B5B500B5B5B500B5B5B500B5B5B500B5B5B500B5B5B500B5B5
-      B500B5B5B5005252520000000000000000000000000000000000000000000000
+      000000000000000000000000000000000000000000000000000055555500B6B6
+      B600B6B6B600B6B6B600B6B6B600B6B6B600B6B6B600B6B6B600B6B6B600B6B6
+      B600B6B6B6005555550000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
-      00000000000000000000000000000000000000000000393939007B7B7B007B7B
+      000000000000000000000000000000000000000000003B3B3B007B7B7B007B7B
       7B007B7B7B007B7B7B007B7B7B007B7B7B007B7B7B007B7B7B007B7B7B007B7B
-      7B007B7B7B007B7B7B0039393900000000000000000000000000000000000000
+      7B007B7B7B007B7B7B003B3B3B00000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
-      0000000000000000000000000000000000000000000031313100313131003131
-      3100313131002121210010101800313131003131310031313100212121002929
-      2900313131003131310031313100000000000000000000000000000000000000
+      0000000000000000000000000000000000000101010035353500353535003535
+      3500353535002626260015141B00353535003535350035353500212121002E2E
+      2E00353535003535350035353500010101000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
-      0000000000000000000000000000000000000808080010101000101010001010
-      10000808080010105A0010084200101010001010100010101000080839000808
-      3900101010001010100010101000080808000000000000000000000000000000
+      0000000000000000000000000000000000000A0A0A0017171700171717001717
+      17000E0E0E0016145A00100E42001616160017171700161616000F0D3B000E0C
+      39001313130017171700171717000A0A0A000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
-      0000000000000000000000000000000000000808080010101000101010001010
-      10000808080021188400211094000808080010101000000010002110A5001810
-      6B00101010001010100010101000080808000000000000000000000000000000
+      0000000000000000000000000000000000000C0C0C0017171700171717001717
+      17000D0D0D00201B8600201793000A0A0A0016161600070510002216A2001914
+      6F001111110017171700171717000C0C0C000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
-      0000000000000000000000000000000000000808080010101000101010001010
-      100010101000080829002110B50010087B00080029001808A5002110AD000808
-      2100101010001010100010101000080808000000000000000000000000000000
+      0000000000000000000000000000000000000C0C0C0017171700171717001717
+      1700161616000A082B002413B40017097A000A042A001D0AA2002210AF000B09
+      25001717170017171700171717000C0C0C000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
-      0000000000000000000000000000000000000808080010101000101010001010
-      10001010100010101000080042002108CE002100DE001800BD00080029001010
-      1000101010001010100010101000080808000000000000000000000000000000
+      0000000000000000000000000000000000000C0C0C0017171700171717001717
+      170017171700131313000E0647002409CC002303D9001F05B8000B0729001414
+      14001717170017171700171717000C0C0C000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
-      0000000000000000000000000000000000000808080010101000101010001010
-      1000101010000808080010086B002108CE002100D60018009400080810001010
-      1000101010001010100010101000080808000000000000000000000000000000
+      0000000000000000000000000000000000000C0C0C0017171700171717001717
+      1700171717000A0A0A00150A6900240ACB002405D50019059000090814001616
+      16001717170017171700171717000C0C0C000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
-      0000000000000000000000000000000000000808080010101000101010001010
-      100008081000181884002110B5001008730010005A002108C6002110A5000808
-      4200080810001010100010101000080808000000000000000000000000000000
+      0000000000000000000000000000000000000C0C0C0017171700171717001717
+      17000B0B12001D1883002415B100170A770010055800250EC2002010A0000F0C
+      40000B0B120014141400171717000C0C0C000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
-      0000000000000000000000000000000000000808080010101000101010001010
-      1000101042002118940010085200080808001010100008003900211094001810
-      6B00080810001010100010101000080808000000000000000000000000000000
+      0000000000000000000000000000000000000C0C0C0017171700171717001717
+      170012104700241F9600120F51000E0E0E00111111000D073A00201794001915
+      6D000B0B120017171700171717000C0C0C000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
-      0000000000000000000000000000000000000808080010101000101010001010
-      10000808180018186B0008080800101010001010100010101000080808000808
-      0800101010001010100010101000080808000000000000000000000000000000
+      0000000000000000000000000000000000000A0A0A0017171700171717001717
+      17000A0A18001B186B000C0C0C001717170017171700161616000D0D0D000E0E
+      0E001717170017171700171717000A0A0A000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
-      0000000000000000000000000000000000000000000010101000101010001010
-      1000101010000000000010101000101010001010100010101000101010001010
-      1000101010001010100010101000000000000000000000000000000000000000
+      0000000000000000000000000000000000000101010017171700171717001717
+      1700161616000707070011111100171717001717170017171700171717001717
+      1700171717001717170017171700010101000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
-      0000000000000000000000000000000000000000000008080800101010001010
-      1000101010001010100010101000101010001010100010101000101010001010
-      1000101010001010100008080800000000000000000000000000000000000000
+      000000000000000000000000000000000000000000000C0C0C00171717001717
+      1700171717001717170017171700171717001717170017171700171717001717
+      170017171700171717000C0C0C00000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
-      0000000000000000000000000000000000000000000000000000080808001010
-      1000101010001010100010101000101010001010100010101000101010001010
-      1000101010000808080000000000000000000000000000000000000000000000
+      00000000000000000000000000000000000000000000000000000C0C0C001717
+      1700171717001717170017171700171717001717170017171700171717001717
+      1700171717000C0C0C0000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
-      0000000000000000000000000000000000000000000000000000000000004242
-      4200080808000808080008080800080808000808080008080800080808000808
-      0800424242000000000000000000000000000000000000000000000000000000
+      0000000000000000000000000000000000000000000000000000000000004646
+      46000A0A0A000C0C0C000C0C0C000C0C0C000C0C0C000C0C0C000C0C0C000A0A
+      0A00464646000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
@@ -1309,135 +1440,133 @@
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
-      0000000000000000000000000000000000000000000000000000000000004242
-      4200636363006B6B6B006B6B6B006B6B6B006B6B6B006B6B6B006B6B6B006363
-      6300424242000000000000000000000000000000000000000000000000004242
-      4200636363006B6B6B006B6B6B006B6B6B006B6B6B006B6B6B006B6B6B006363
-      6300424242000000000000000000000000000000000000000000000000004242
-      4200313131003939390039393900393939003939390039393900393939003131
-      3100424242000000000000000000000000000000000000000000000000000000
+      0000000000000000000000000000000000002F2F2E002F2F2E002E2E2E002F2F
+      2E002E2F2E002F2E2E002F2E2E002F2E2E002E2E2F002F2E2E002E2E2E002E2E
+      2E002E2E2F002E2F2E002F2E2E002E2F2F002F2F2E002F2F2E002E2E2E002F2F
+      2E002E2F2E002F2E2E002F2E2E002F2E2E002E2E2F002F2E2E002E2E2E002E2E
+      2E002E2E2F002E2F2E002F2E2E002E2F2F00419A5100419A510040995100419A
+      5100409A51004199510041995100419951004099520041995100409951004099
+      510040995200409A510041995100409A52000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
-      000000000000000000000000000000000000000000000000000052525200B5B5
-      B500B5B5B500B5B5B500B5B5B500B5B5B500B5B5B500B5B5B500B5B5B500B5B5
-      B500B5B5B500525252000000000000000000000000000000000052525200B5B5
-      B500B5B5B500B5B5B500B5B5B500B5B5B500B5B5B500B5B5B500B5B5B500B5B5
-      B500B5B5B5005252520000000000000000000000000000000000313131007373
-      73007B7B7B008484840084848400848484008484840084848400848484007B7B
-      7B00737373003131310000000000000000000000000000000000000000000000
+      0000000000000000000000000000000000003232320031323200313132003132
+      3200323231003131310031323200323232003231320032323100323232003232
+      3100313232003231320032323100323231003232320031323200313132003132
+      3200323231003131310031323200323232003231320032323100323232003232
+      310031323200323132003232310032323100449D5500439D5500439C5500439D
+      5500449D5400439C5400439D5500449D5500449C5500449D5400449D5500449D
+      5400439D5500449C5500449D5400449D54000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
-      00000000000000000000000000000000000000000000393939007B7B7B007B7B
-      7B007B7B7B007B7B7B007B7B7B007B7B7B007B7B7B007B7B7B007B7B7B007B7B
-      7B007B7B7B007B7B7B00393939000000000000000000393939007B7B7B007B7B
-      7B007B7B7B007B7B7B007B7B7B007B7B7B007B7B7B007B7B7B007B7B7B007B7B
-      7B007B7B7B007B7B7B0039393900000000000000000021212100525252006363
-      63006B6B6B007373730073737300737373007373730073737300737373006B6B
-      6B00636363005252520021212100000000000000000000000000000000000000
+      0000000000000000000000000000000000003536360035363500353536003535
+      3600353635003636360035353500363536003635360035353500353536003535
+      3500353535003535360036353600363535003536360035363500353536003535
+      3600353635003636360035353500363536003635360035353500353536003535
+      35003535350035353600363536003635350047A1590047A1580047A0590047A0
+      590047A1580048A1590047A0580048A0590048A0590047A0580047A0590047A0
+      580047A0580047A0590048A0590048A058000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
-      0000000000000000000000000000000000000000000031313100313131003131
-      3100313131003131310052525200424242003131310031313100313131003131
-      3100313131003131310031313100000000000000000031313100313131003131
-      3100313131003131310042393100393931003131310031313100313131003131
-      3100313131003131310031313100000000000000000021212100292929003131
-      3100313131003131310042393100393931003131310031313100313131003131
-      3100313131002929290021212100000000000000000000000000000000000000
+      0000000000000000000000000000000000003A3A3900393A3A0039393A00393A
+      3A00393A3A00756C62003D3B3B00393A3A003A3A39003A3A3A003A3A3A003A39
+      3A003A3A39003A3A3A003A3A3A003A3A3A003A3A3900393A3A0039393A00393A
+      3A00393A3A00389E43003C3E3B00393A3A003A3A39003A3A3A003A3A3A003A39
+      3A003A3A39003A3A3A003A3A3A003A3A3A004CA55C004BA55D004BA45D004BA5
+      5D004BA55D003C4D37004CA05B004BA55D004CA55C004CA55D004CA55D004CA4
+      5D004CA55C004CA55D004CA55D004CA55D000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
-      0000000000000000000000000000000000000808080010101000101010001010
-      1000101010001010100052525200D6D6D6002121210010101000101010001010
-      1000101010001010100010101000080808000808080010101000101010001010
-      1000101010001010100039291000945A08002118100010101000101010001010
-      1000101010001010100010101000080808000000000010101000101010001010
-      1000101010001010100039291000945A08002118100010101000101010001010
-      1000101010001010100010101000000000000000000000000000000000000000
+      0000000000000000000000000000000000003F3E3E003B3A3A003B3A3A003A3A
+      3A003A3A3B00988A7B00948678004C4946003A3A3A003A3B3A003A3A3A003A3B
+      3B003A3A3B003A3A3A003A3B3A003F3E3F003F3E3E003B3A3A003B3A3A003A3A
+      3A003A3A3B001BC035001FBD3700405D41003A3A3A003A3B3A003A3A3A003A3B
+      3B003A3A3B003A3A3A003A3B3A003F3E3F0051A961004DA55D004DA55D004CA5
+      5D004CA55E001B1C170020211B004E8A55004CA55D004CA65D004CA55D004CA6
+      5E004CA55E004CA55D004CA65D0051A962000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
-      0000000000000000000000000000000000000808080010101000101010001010
-      1000101010001010100052525200FFFFFF00D6D6D60021212100101010001010
-      1000101010001010100010101000080808000808080010101000101010001010
-      1000101010001010100039291000B56B1000A56B290021181800101010001010
-      1000101010001010100010101000080808000808080010101000101010001010
-      1000101010001010100039291000B56B1000A56B290021181800101010001010
-      1000101010001010100010101000080808000000000000000000000000000000
+      000000000000000000000000000000000000434443003A3A3B003A3A3A003B3A
+      3B003A3B3A00988A7B00AC9B8900A89886006D665D003A3A3B003A3A3A003B3A
+      3B003A3A3B003B3A3A003A3A3A0043444300434443003A3A3B003A3A3A003B3A
+      3B003A3B3A001BC0350000CC260006CA29003C9444003A3A3B003A3A3A003B3A
+      3B003A3A3B003B3A3A003A3A3A004344430055AF66004CA55E004CA55D004DA5
+      5E004CA65D001B1C1700000000000605050042593E004CA55E004CA55D004DA5
+      5E004CA55E004DA55D004CA55D0055AF66000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
-      0000000000000000000000000000000000000808080010101000101010001010
-      100010101000101010004A4A4A00F7F7F700F7F7F700CECECE00212121001010
-      1000101010001010100010101000080808000808080010101000101010001010
-      1000101010001010100039291000CE8C4200E7B57300BD946300212118001010
-      1000101010001010100010101000080808000808080010101000101010001010
-      1000101010001010100039291000CE8C4200E7B57300BD946300212118001010
-      1000101010001010100010101000080808000000000000000000000000000000
+      0000000000000000000000000000000000004948490038383800383838003838
+      380038383800988A7B00AC9B8900AC9B8900AC9B89008B7F7200444241003838
+      3800383838003838380038383800494849004948490038383800383838003838
+      3800383838001BC0350000CC260000CC260000CC260027B63B003D513E003838
+      3800383838003838380038383800494849005BB36C004AA35B004AA35B004AA3
+      5B004AA35B001B1C1700000000000000000000000000292C23004B9156004AA3
+      5B004AA35B004AA35B004AA35B005BB36C000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
-      0000000000000000000000000000000000000808080010101000101010001010
-      100010101000101010004A4A4A00EFEFEF00EFEFEF00EFEFEF00ADADAD001010
-      1000101010001010100010101000080808000808080010101000101010001010
-      1000101010001010100042311800D6A55A00F7D69400EFCE8C009C7342001010
-      1000101010001010100010101000080808000808080010101000101010001010
-      1000101010001010100042311800D6A55A00F7D69400EFCE8C009C7342001010
-      1000101010001010100010101000080808000000000000000000000000000000
+      0000000000000000000000000000000000004D4E4D0034333300333333003433
+      3300333434009D8E7E00AC9B8900AC9B8900AC9B8900AC9B8900A59584005E58
+      52003433340034333400343433004D4D4E004D4E4D0034333300333333003433
+      33003334340014C4310000CC260000CC260000CC260000CC26000AC92C003D81
+      42003433340034333400343433004D4D4E005FB97000469E5600459E5600469E
+      5600459F570014141000000000000000000000000000000000000A0908004466
+      4400469E5700469E5700469F56005FB871000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
-      0000000000000000000000000000000000000808080010101000101010001010
-      1000101010001010100042424200D6D6D600D6D6D600CECECE00393939001010
-      1000101010001010100010101000080808000808080010101000101010001010
-      1000101010001010100039291000CE8C4200E7B57300D6A56B00393121001010
-      1000101010001010100010101000080808000808080010101000101010001010
-      1000101010001010100039291000CE8C4200E7B57300D6A56B00393121001010
-      1000101010001010100010101000080808000000000000000000000000000000
+      000000000000000000000000000000000000525353002E2E2E002E2E2E002E2E
+      2E002E2E2E00A9988700AC9B8900AC9B8900AC9B8900AC9B8900AC9B89008A7E
+      70002E2E2E002E2E2E002E2E2E0053535200525353002E2E2E002E2E2E002E2E
+      2E002E2E2E0005CB290000CC260000CC260000CC260000CC260000CC260025B7
+      3A002E2E2E002E2E2E002E2E2E005353520064BE760040995100409951004099
+      510040995100050404000000000000000000000000000000000000000000272A
+      210040995100409951004099510065BE75000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
-      0000000000000000000000000000000000000808080010101000101010001010
-      1000101010001010100039393900ADADAD00A5A5A50031313100101010001010
-      1000101010001010100010101000080808000808080010101000101010001010
-      1000101010001010100039291000B56B1000B57B290039292100101010001010
-      1000101010001010100010101000080808000808080010101000101010001818
-      1800101010001010100039291000B56B1000B57B290039292100101010001010
-      1000181818001010100010101000080808000000000000000000000000000000
+      0000000000000000000000000000000000005858580027272700272727002727
+      270027272700AB9B8900AC9B8900AC9B8900AC9B8900A99887004D4843002727
+      2700272727002727270027272700585857005858580027272700272727002727
+      27002727270001CC260000CC260000CC260000CC260004CB2800376E3B002727
+      2700272727002727270027272700585857006AC37B0039924A0039924A003992
+      4A0039924A000101010000000000000000000000000004040300406A42003992
+      4A0039924A0039924A0039924A006AC37A000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
-      0000000000000000000000000000000000000808080010101000101010001010
-      10001010100010101000292929006B6B6B002929290010101000101010001010
-      1000101010001010100010101000080808000808080010101000101010001010
-      1000101010001010100039291000AD6300003121100010101000101010001010
-      1000101010001010100010101000080808000808080010101000101010002121
-      2100101010001010100039291000AD6300003121100010101000101010001010
-      1000212121001010100010101000080808000000000000000000000000000000
+      0000000000000000000000000000000000005C5D5C001F1F1F001F1F1F001F1F
+      1F001F1F1F00AB9B8900AC9B8900AC9B8900948677001F1F1F001F1F1F001F1F
+      1F001F1F1F001F1F1F001F1F1F005C5C5D005C5D5C001F1F1F001F1F1F001F1F
+      1F001F1F1F0001CC260000CC260000CC260019C034001F1F1F001F1F1F001F1F
+      1F001F1F1F001F1F1F001F1F1F005C5C5D006EC87F00318A4200318A4200318A
+      4200318A4200010101000000000000000000191A1500318A4200318A4200318A
+      4200318A4200318A4200318A42006EC780000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
-      0000000000000000000000000000000000000808080010101000101010001010
-      1000101010001010100010101000181818001010100010101000101010001010
-      1000101010001010100010101000080808000808080010101000101010001010
-      1000101010001010100031211000312110001010100010101000101010001010
-      1000101010001010100010101000080808000808080010101000101010003939
-      3900181818001010100031211000312110001010100010101000101010001818
-      1800393939001010100010101000080808000000000000000000000000000000
+      0000000000000000000000000000000000006160610016161600161616001616
+      160016161600AB9A8900AB9A8800514A43001616160016161600161616001616
+      1600161616001616160016161600616160006160610016161600161616001616
+      16001616160001CC260001CC2700317D38001616160016161600161616001616
+      16001616160016161600161616006161600073CB840028813900288139002881
+      3900288139000101010001010100385435002881390028813900288139002881
+      390028813900288139002881390073CC83000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
-      0000000000000000000000000000000000000000000010101000101010001010
-      1000101010001010100010101000101010001010100010101000101010001010
-      1000101010001010100010101000000000000000000010101000101010001010
-      1000101010001010100010101000101010001010100010101000101010001010
-      1000101010001010100010101000000000000000000010101000101010006B6B
-      6B00424242002121210018181800101010001010100018181800212121004242
-      42006B6B6B001010100010101000000000000000000000000000000000000000
+      000000000000000000000000000000000000646464000D0D0D000D0D0D000D0D
+      0D000D0D0D009B8B7B00181716000D0D0D000D0D0D000D0D0D000D0D0D000D0D
+      0D000D0D0D000D0D0D000D0D0D0064656500646464000D0D0D000D0D0D000D0D
+      0D000D0D0D0011C52F00162417000D0D0D000D0D0D000D0D0D000D0D0D000D0D
+      0D000D0D0D000D0D0D000D0D0D006465650076CF87001F7830001F7830001F78
+      30001F78300011110E00267132001F7830001F7830001F7830001F7830001F78
+      30001F7830001F7830001F78300076D088000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
-      0000000000000000000000000000000000000000000008080800101010001010
-      1000101010001010100010101000101010001010100010101000101010001010
-      1000101010001010100008080800000000000000000008080800101010001010
-      1000101010001010100010101000101010001010100010101000101010001010
-      1000101010001010100008080800000000000000000008080800101010007373
-      7300BDBDBD00B5B5B500ADADAD00ADADAD00ADADAD00ADADAD00B5B5B500BDBD
-      BD00737373001010100008080800000000000000000000000000000000000000
+      0000000000000000000000000000000000006868670006060600060606000606
+      0600060606000606060006060600060606000606060006060600060606000606
+      0600060606000606060006060600676768006868670006060600060606000606
+      0600060606000606060006060600060606000606060006060600060606000606
+      0600060606000606060006060600676768007AD38A0018712900187129001871
+      2900187129001871290018712900187129001871290018712900187129001871
+      290018712900187129001871290079D28B000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
-      0000000000000000000000000000000000000000000000000000080808001010
-      1000101010001010100010101000101010001010100010101000101010001010
-      1000101010000808080000000000000000000000000000000000080808001010
-      1000101010001010100010101000101010001010100010101000101010001010
-      1000101010000808080000000000000000000000000000000000080808001010
-      10004A4A4A007B7B7B008C8C8C008C8C8C008C8C8C008C8C8C007B7B7B004A4A
-      4A00101010000808080000000000000000000000000000000000000000000000
+      0000000000000000000000000000000000006A6A6A0000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
-      0000000000000000000000000000000000000000000000000000000000004242
-      4200080808000808080008080800080808000808080008080800080808000808
-      0800424242000000000000000000000000000000000000000000000000004242
-      4200080808000808080008080800080808000808080008080800080808000808
-      0800424242000000000000000000000000000000000000000000000000004242
-      4200080808000808080008080800080808000808080008080800080808000808
-      0800424242000000000000000000000000000000000000000000000000000000
+      00000000000000000000000000006A6A6A006A6A6A0000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
+      00000000000000000000000000006A6A6A007CD58D00126B2300126B2300126B
+      2300126B2300126B2300126B2300126B2300126B2300126B2300126B2300126B
+      2300126B2300126B2300126B23007CD58D000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
+      0000000000000000000000000000000000006A6A6A006A6A6A006A6A6A006A6A
+      6A006A6A6A006A6A6A006A6A6A006A6A6A006A6A6A006A6A6A006A6A6A006A6A
+      6A006A6A6A006A6A6A006A6A6A006A6A6A006A6A6A006A6A6A006A6A6A006A6A
+      6A006A6A6A006A6A6A006A6A6A006A6A6A006A6A6A006A6A6A006A6A6A006A6A
+      6A006A6A6A006A6A6A006A6A6A006A6A6A007CD58D007CD58D007CD58D007CD5
+      8D007CD58D007CD58D007CD58D007CD58D007CD58D007CD58D007CD58D007CD5
+      8D007CD58D007CD58D007CD58D007CD58D000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
@@ -2075,6 +2204,8 @@
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
+      0000000000000000000000000000000000000000000000000000000000000000
+      0000000000000000000000000000000000000000000000000000000000000000
       000000000000000000000000000000000000424D3E000000000000003E000000
       2800000040000000800000000100010000000000000400000000000000000000
       000000000000000000000000FFFFFF0000000000000000000000000000000000
@@ -2085,11 +2216,11 @@
       8001000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000000000000000000000
       0000000000000000000000000000000000000000000000008001000000000000
-      C003000000000000E007000000000000FFFFE007E007E007FFFFC003C003C003
-      FFFF800180018001FFFF000000000000FFFF000000000000FFFF000000000000
+      C003000000000000E007000000000000FFFF000000000000FFFF000000000000
       FFFF000000000000FFFF000000000000FFFF000000000000FFFF000000000000
-      FFFF000000000000FFFF000000000000FFFF000000000000FFFF800180018001
-      FFFFC003C003C003FFFFE007E007E007FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
+      FFFF000000000000FFFF000000000000FFFF000000000000FFFF000000000000
+      FFFF000000000000FFFF000000000000FFFF000000000000FFFF000000000000
+      FFFF000000000000FFFF000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
       FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
       FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
       FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
@@ -2109,8 +2240,7 @@
       FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
       FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
       FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-      FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000000000000000000000000000
-      000000000000}
+      FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF}
   end
   object PlayerStateImageList: TImageList
     Left = 209
@@ -6426,7 +6556,7 @@
     end
   end
   object HelpPopupMenu: TSpTBXPopupMenu
-    Left = 444
+    Left = 448
     Top = 86
     object mnuHelp: TSpTBXItem
       Caption = 'Help'
@@ -6512,15 +6642,14 @@
       Caption = 'Spring Ladder'
       OnClick = mnuSpringLadderClick
     end
+    object SpTBXItem4: TSpTBXItem
+      Caption = 'Alternative lobby : SpringLobby'
+      OnClick = SpTBXItem4Click
+    end
     object SpTBXItem3: TSpTBXItem
       Caption = 'Beta lobby changelog'
-      Visible = False
       OnClick = SpTBXItem3Click
     end
-    object SpTBXItem4: TSpTBXItem
-      Caption = 'Alternative lobby : SpringLobby'
-      OnClick = SpTBXItem4Click
-    end
   end
   object HttpCli1: THttpCli
     LocalAddr = '0.0.0.0'

Modified: trunk/Lobby/TASClient/MainUnit.pas
===================================================================
--- trunk/Lobby/TASClient/MainUnit.pas	2008-06-16 21:09:43 UTC (rev 6036)
+++ trunk/Lobby/TASClient/MainUnit.pas	2008-06-16 22:20:02 UTC (rev 6037)
@@ -205,7 +205,7 @@
   JvDesktopAlertForm, DateUtils, Winsock, TBXToolPals, SpTBXItem, TB2Item,
   TBX, SpTBXControls, TBXDkPanels, SpTBXFormPopupMenu,IniFiles,StrUtils,
   TntStdCtrls, SpTBXEditors, Mask, JvExMask, JvSpin,TntComCtrls,JclUnicode,
-  GR32_Image;
+  GR32_Image, SpTBXTabs;
 
 const
   CountryNames: array[0..240] of string = (
@@ -509,10 +509,10 @@
   );
 
 const
-  VERSION_NUMBER = '0.37'; // Must be float value! (with a period as a decimal seperator)
-  BETA_NUMBER = 314;
+  VERSION_NUMBER = '0.38'; // Must be float value! (with a period as a decimal seperator)
+  BETA_NUMBER = 315;
   CHECK_BETA_LOBBY_URL = '<A HREF="http://tasclient.no-ip.org/TASClient.txt">http://tasclient.no-ip.org/TASClient.txt</A>';
-  PROGRAM_VERSION = 'TASClient ' + VERSION_NUMBER;// + ' beta';
+  PROGRAM_VERSION = 'TASClient ' + VERSION_NUMBER + ' beta';
   KEEP_ALIVE_INTERVAL = 10000; // in milliseconds. Tells us what should be the maximum &quot;silence&quot; time before we send a ping to the server.
   ASSUME_TIMEOUT_INTERVAL = 30000; // in milliseconds. Must be greater than KEEP_ALIVE_INTERVAL! If server hasn't send any data to us within this interval, then we assume timeout occured. It's us who must make sure we get constant replies from server by pinging it.
   LOCAL_TAB = '$Local'; // caption of main (command) tab window. Must be special so that is different from channel names or user names, that is why there is a &quot;$&quot; in front of it.
@@ -536,6 +536,7 @@
   MODS_CACHE_FOLDER = CACHE_FOLDER + '\' + 'mods'; // we store info of local mods there like default mod options
   LOG_FOLDER = LOBBY_FOLDER + '\' + 'logs'; // this is where we store chat logs
   VAR_FOLDER = LOBBY_FOLDER + '\' + 'var';
+  FILTERS_FOLDER = VAR_FOLDER + '\filters';
   FIRST_UDP_SOURCEPORT = 8300; // udp source port (used with &quot;fixed source ports&quot; NAT traversal technique) of the second (first one is host) client in clients list of the battle. Third client uses this+1 port, fourth one this+2, etc.
   AIDLL_FOLDER = 'AI/Bot-libs'; // searching for *.dll in this folder will return all bots that you can use to play with
   MAP_DOWNLOADER_ENABLED = False; // integrated map downloader is currently disabled as FileUniverse.com is no longer hosting spring content
@@ -544,6 +545,8 @@
   MAX_TEAMS = 16; // max. teams supported by Spring in a game (MAX_ALLIES would be same as MAX_TEAMS, so no need for it)
   MAX_POPUP = 8; // max popup notification displaying at the same time
 
+  MAX_AUTOSENDMSG = 2; // limit the auto sent msg when auto specing or kicking players
+
   // custom messages:
   WM_DATAHASARRIVED = WM_USER + 0; // used when processing data received through socket
   WM_OPENOPTIONS = WM_USER + 1; // used to open OPTIONS dialog
@@ -648,6 +651,7 @@
     PublicPort: Integer; // client's public UDP source port. Used with NAT traversing (e.g. &quot;hole punching&quot;)
     AwayMessageSent: boolean; // to not resend the away message each time the player send you a message
     AutoKickMsgSent : integer;
+    AutoSpecMsgSent : integer;
 
     constructor Create(Name: string; Status: Integer; Country: string; CPU: Integer);
 
@@ -981,40 +985,12 @@
     Bevel2: TBevel;
     SpTBXSeparatorItem11: TSpTBXSeparatorItem;
     mnuIgnore: TSpTBXItem;
-    FilterGroup: TSpTBXGroupBox;
-    FiltersButton: TSpTBXButton;
     ArrowList: TImageList;
-    FilterValueTextBox: TSpTBXEdit;
-    ContainsRadio: TSpTBXRadioButton;
-    DoNotContainsRadio: TSpTBXRadioButton;
-    AddToFilterListButton: TSpTBXButton;
-    FilterListCombo: TSpTBXComboBox;
-    RemoveFromFilterListButton: TSpTBXButton;
-    ClearFilterListButton: TSpTBXButton;
-    EnableFilters: TSpTBXCheckBox;
-    FilterList: TVirtualStringTree;
     mnuDisplayFilters: TSpTBXItem;
     RemoveMenu: TSpTBXSubmenuItem;
     SpTBXSeparatorItem2: TSpTBXSeparatorItem;
-    SpTBXPanel1: TSpTBXPanel;
-    FullFilter: TSpTBXCheckBox;
-    InProgressFilter: TSpTBXCheckBox;
-    LadderFilter: TSpTBXCheckBox;
-    LockedFilter: TSpTBXCheckBox;
-    PasswordedFilter: TSpTBXCheckBox;
-    RankLimitFilter: TSpTBXCheckBox;
-    ReplaysFilter: TSpTBXCheckBox;
-    ModsNotAvailableFilter: TSpTBXCheckBox;
-    MapsNotAvailableFilter: TSpTBXCheckBox;
-    NatTraversalFilter: TSpTBXCheckBox;
-    PlayersSignButton: TSpTBXButton;
-    PlayersValueTextBox: TJvSpinEdit;
-    MaxPlayersSignButton: TSpTBXButton;
-    MaxPlayersValueTextBox: TJvSpinEdit;
     Sortbygroup1: TMenuItem;
     HighlighBattlesTimer: TTimer;
-    MaxPlayersFilter: TSpTBXCheckBox;
-    PlayersFilter: TSpTBXCheckBox;
     MuteSubitemMenu: TSpTBXSubmenuItem;
     mnuMute5Min: TSpTBXItem;
     mnuMute30Min: TSpTBXItem;
@@ -1067,6 +1043,46 @@
     Splitter2: TSpTBXSplitter;
     Splitter1: TSpTBXSplitter;
     SpTBXItem4: TSpTBXItem;
+    FilterGroup: TSpTBXPanel;
+    FiltersTabs: TSpTBXTabControl;
+    SpTBXTabItem1: TSpTBXTabItem;
+    SpTBXTabItem2: TSpTBXTabItem;
+    SpTBXTabSheet2: TSpTBXTabSheet;
+    SpTBXTabSheet1: TSpTBXTabSheet;
+    FilterList: TVirtualStringTree;
+    ClearFilterListButton: TSpTBXButton;
+    RemoveFromFilterListButton: TSpTBXButton;
+    AddToFilterListButton: TSpTBXButton;
+    FilterValueTextBox: TSpTBXEdit;
+    DoNotContainsRadio: TSpTBXRadioButton;
+    ContainsRadio: TSpTBXRadioButton;
+    FilterListCombo: TSpTBXComboBox;
+    SpTBXPanel2: TSpTBXPanel;
+    FullFilter: TSpTBXCheckBox;
+    InProgressFilter: TSpTBXCheckBox;
+    LadderFilter: TSpTBXCheckBox;
+    LockedFilter: TSpTBXCheckBox;
+    PasswordedFilter: TSpTBXCheckBox;
+    RankLimitFilter: TSpTBXCheckBox;
+    ReplaysFilter: TSpTBXCheckBox;
+    ModsNotAvailableFilter: TSpTBXCheckBox;
+    MapsNotAvailableFilter: TSpTBXCheckBox;
+    NatTraversalFilter: TSpTBXCheckBox;
+    PlayersSignButton: TSpTBXButton;
+    PlayersValueTextBox: TJvSpinEdit;
+    MaxPlayersSignButton: TSpTBXButton;
+    MaxPlayersValueTextBox: TJvSpinEdit;
+    MaxPlayersFilter: TSpTBXCheckBox;
+    PlayersFilter: TSpTBXCheckBox;
+    EnableFilters: TSpTBXCheckBox;
+    FiltersButton: TSpTBXButton;
+    PresetListbox: TSpTBXListBox;
+    SpTBXLabel3: TSpTBXLabel;
+    SpTBXGroupBox1: TSpTBXGroupBox;
+    btClearPreset: TSpTBXButton;
+    btDeletePreset: TSpTBXButton;
+    btSavePreset: TSpTBXButton;
+    PresetNameTextbox: TSpTBXEdit;
     procedure mnuOpenPrivateChatClick(Sender: TObject);
     procedure mnuSelectBattleClick(Sender: TObject);
     procedure SpTBXItem1Click(Sender: TObject);
@@ -1131,8 +1147,10 @@
     procedure FilterListHeaderClick(Sender: TVTHeader;
       Column: TColumnIndex; Button: TMouseButton; Shift: TShiftState; X,
       Y: Integer);
-    procedure SaveFiltersToFile;
-    procedure LoadFiltersFromFile;
+    procedure SaveFiltersToFile(path : string);
+    procedure LoadFiltersFromFile(path : string);
+    procedure LoadPresets;
+    procedure FiltersUpdated;
     procedure UpdateFilters;
     procedure HighlighBattlesTimerTimer(Sender: TObject);
     procedure FormResize(Sender: TObject);
@@ -1153,7 +1171,6 @@
     procedure LadderCupsRefreshTimer(Sender: TObject);
     procedure FilterListChecking(Sender: TBaseVirtualTree;
       Node: PVirtualNode; var NewState: TCheckState; var Allowed: Boolean);
-    procedure Button1Click(Sender: TObject);
     procedure BattleListPopupMenuInitPopup(Sender: TObject;
       PopupView: TTBView);
     procedure ClientPopupMenuInitPopup(Sender: TObject;
@@ -1184,6 +1201,10 @@
     procedure Splitter2Moving(Sender: TObject; var NewSize: Integer;
       var Accept: Boolean);
     procedure SpTBXItem4Click(Sender: TObject);
+    procedure btSavePresetClick(Sender: TObject);
+    procedure PresetListboxClick(Sender: TObject);
+    procedure btDeletePresetClick(Sender: TObject);
+    procedure btClearPresetClick(Sender: TObject);
 
   published
     MainTitleBar: TSpTBXTitleBar;
@@ -1320,6 +1341,7 @@
     procedure SetAway(AwayIndex: integer);
 
     procedure ResetAutoKickMsgSentCounters;
+    procedure ResetAutoSpecMsgSentCounters;
 
   published
     procedure ApplicationEvents1ShortCut(var Msg: TWMKey; var Handled: Boolean);
@@ -2262,6 +2284,7 @@
   Self.CupList := TList.Create;
   Self.CupLadderList := TStringList.Create;
   Self.AutoKickMsgSent := 0;
+  Self.AutoSpecMsgSent := 0;
 end;
 
 function TClient.GetChatTextColor: TColor;
@@ -3250,10 +3273,13 @@
     // nothing
   end;
 
+  FiltersTabs.ActiveTabIndex := 0;
   FilterGroup.Height := 0;
   Filters.TextFilters := TList.Create;
-  LoadFiltersFromFile;
+  LoadFiltersFromFile(FILTERS_FOLDER + '\default.ini');
   UpdateFilters;
+  PresetListbox.Selected[0] := true;
+  LoadPresets;
 
   Randomize;
   Application.UpdateFormatSettings := False; // so that DecimalSeparator doesn't get changed by WM_WININICHANGE message. See <A HREF="http://coding.derkeiler.com/Archive/Delphi/borland.public.delphi.language.objectpascal/2003-11/0223.html">http://coding.derkeiler.com/Archive/Delphi/borland.public.delphi.language.objectpascal/2003-11/0223.html</A>
@@ -3367,6 +3393,11 @@
     Preferences := DEFAULT_PREFERENCES;
     ProgramInitialized := True;
     PreferencesForm.ReadPreferencesFromRegistry;
+    if CommandLineServer &lt;&gt; '' then
+    begin
+      Preferences.ServerIP := CommandLineServer;
+      Preferences.ServerPort := CommandLinePort;
+    end;
     PreferencesForm.UpdatePreferencesFrom(Preferences);
     NotificationsForm.LoadNotificationListFromFile(ExtractFilePath(Application.ExeName) + VAR_FOLDER + '\notify.dat');
     NotificationsForm.UpdateNotificationList;
@@ -3470,6 +3501,17 @@
       end;
     end;
 
+    if not DirectoryExists(ExtractFilePath(Application.ExeName) + FILTERS_FOLDER) then
+    begin
+      MessageDlg('Program has detected that &quot;' + FILTERS_FOLDER + '&quot; folder does not exist. It will be now created.', mtInformation, [mbOK], 0);
+      if not CreateDir(ExtractFilePath(Application.ExeName) + FILTERS_FOLDER) then
+      begin
+        MessageDlg('Unable to create directory. Program will now exit ...', mtError, [mbOK], 0);
+        Application.Terminate;
+        Exit;
+      end;
+    end;
+
     if Preferences.SaveLogs then OpenAllLogs; // do this before all else, so that we don't miss any message
 
     SplashScreenForm.UpdateText('loading maps ...');
@@ -4383,6 +4425,21 @@
       UpdateClientsListBox;
       VDTBattles.Invalidate;
       LadderCupsRefreshTimer(nil);
+
+      // joins every channels opened
+      for i:=0 to PageControl1.PageCount-1 do
+        if (LeftStr(PageControl1.Pages[i].Caption,1) = '#') and (LowerCase(PageControl1.Pages[i].Caption) &lt;&gt; '#main') then
+        begin
+          tmpBool := false;
+          for j:=0 to PerformForm.CommandsListBox.Count-1 do
+            if (AnsiUpperCase(PerformForm.CommandsListBox.Items[j]) = '/J '+AnsiUpperCase(PageControl1.Pages[i].Caption)) or (AnsiUpperCase(PerformForm.CommandsListBox.Items[j]) = '/JOIN '+AnsiUpperCase(PageControl1.Pages[i].Caption)) then
+            begin
+              tmpBool := true;
+              Break;
+            end;
+          if not tmpBool then
+            ProcessCommand('JOIN '+PageControl1.Pages[i].Caption,False);
+        end;
     end
     else if sl[0] = 'REGISTRATIONACCEPTED' then
     begin
@@ -5555,7 +5612,7 @@
           if BattleState.Status = Hosting then
           begin
             if Misc.Contains(Client.Name,BattleState.BanList) then begin
-              if Client.AutoKickMsgSent &lt;3 then
+              if Client.AutoKickMsgSent &lt; MAX_AUTOSENDMSG then
               begin
                 MainForm.TryToSendCommand('SAYBATTLEEX', '*** Banned player auto-kick ***');
                 Client.AutoKickMsgSent := Client.AutoKickMsgSent + 1;
@@ -5565,7 +5622,7 @@
             else
             begin
               if (Client.GetRank &lt; BattleState.Battle.RankLimit) and BattleState.AutoKickRankLimit then begin
-                if Client.AutoKickMsgSent &lt;3 then
+                if Client.AutoKickMsgSent &lt; MAX_AUTOSENDMSG then
                 begin
                   MainForm.TryToSendCommand('SAYBATTLEEX', '*** Rank limit auto-kick ***');
                   Client.AutoKickMsgSent := Client.AutoKickMsgSent + 1;
@@ -5574,7 +5631,7 @@
               end
               else
                 if (Client.GetGroup &gt; -1) and TClientGroup(ClientGroups[Client.GetGroup]).AutoKick then begin
-                  if Client.AutoKickMsgSent &lt;3 then
+                  if Client.AutoKickMsgSent &lt; MAX_AUTOSENDMSG then
                   begin
                     MainForm.TryToSendCommand('SAYBATTLEEX', '*** Banned Group member auto-kick ***');
                     Client.AutoKickMsgSent := Client.AutoKickMsgSent + 1;
@@ -5584,7 +5641,7 @@
             end;
             Inc(Battle.SpectatorCount); //*** test
             BattleForm.SendBattleInfoToServer;
-            if (BattleFormUnit.BattleState.Battle.Description &lt;&gt; '(none)') and BattleState.AutoSendDescription and (Client.AutoKickMsgSent &lt; 3)  then
+            if (BattleFormUnit.BattleState.Battle.Description &lt;&gt; '(none)') and BattleState.AutoSendDescription and (Client.AutoKickMsgSent &lt; MAX_AUTOSENDMSG)  then
               MainForm.TryToSendCommand('SAYBATTLEEX', '*** Description : '+BattleFormUnit.BattleState.Battle.Description+' ***');
           end;
           if not BattleForm.Active then
@@ -6031,18 +6088,30 @@
         if tmpBool then
         begin
           if (BattleState.Status=Hosting) and (Client.GetRank &lt; BattleState.Battle.RankLimit) and BattleState.AutoSpecRankLimit and (Client.GetMode &lt;&gt; 0) then begin
-            MainForm.TryToSendCommand('SAYBATTLEEX', '*** Rank limit auto-spec : '+Client.Name+' ***');
+            if Client.AutoSpecMsgSent &lt; MAX_AUTOSENDMSG then
+            begin
+              MainForm.TryToSendCommand('SAYBATTLEEX', '*** Rank limit auto-spec : '+Client.Name+' ***');
+              Client.AutoSpecMsgSent := Client.AutoSpecMsgSent + 1;
+            end;
             MainForm.TryToSendCommand('FORCESPECTATORMODE', Client.Name);
           end
           else
             if (BattleState.Status=Hosting) and (Client.GetGroup &gt; -1) and TClientGroup(ClientGroups[Client.GetGroup]).AutoSpec and (Client.GetMode &lt;&gt; 0) then begin
-              MainForm.TryToSendCommand('SAYBATTLEEX', '*** Group auto-spec : '+Client.Name+' ***');
+              if Client.AutoSpecMsgSent &lt; MAX_AUTOSENDMSG then
+              begin
+                MainForm.TryToSendCommand('SAYBATTLEEX', '*** Group auto-spec : '+Client.Name+' ***');
+                Client.AutoSpecMsgSent := Client.AutoSpecMsgSent + 1;
+              end;
               MainForm.TryToSendCommand('FORCESPECTATORMODE', Client.Name);
             end
             else
               if (BattleState.Status=Hosting) and (Client.GetMode &lt;&gt; 0) and BattleState.Battle.IsLadderBattle and (Client.CurrentLadderRating=0) then
               begin
-                MainForm.TryToSendCommand('SAYBATTLEEX', '*** No ladder account auto-spec : '+Client.Name+' ***');
+                if Client.AutoSpecMsgSent &lt; MAX_AUTOSENDMSG then
+                begin
+                  MainForm.TryToSendCommand('SAYBATTLEEX', '*** No ladder account auto-spec : '+Client.Name+' ***');
+                  Client.AutoSpecMsgSent := Client.AutoSpecMsgSent + 1;
+                end;
                 MainForm.TryToSendCommand('FORCESPECTATORMODE', Client.Name);
               end;
 
@@ -6817,7 +6886,7 @@
   if ip = '' then ip := '*';
   if ((Password = '') or (Status.ServerMode = 1{LAN MODE})) then Password := '*'; // probably local LAN mode. We have to send something as a password, so we just send an &quot;*&quot;.
   userid := IntToHex(Misc.GetLobbyUserID, 1);
-  TryToSendCommand('LOGIN', Username + ' ' + Misc.GetMD5Hash(Password) + ' ' + IntToStr(Status.MyCPU) + ' ' + ip + ' ' + PROGRAM_VERSION + IFF(userid &lt;&gt; '0', #9 + userid, ''));
+  TryToSendCommand('LOGIN', Username + ' ' + Password + ' ' + IntToStr(Status.MyCPU) + ' ' + ip + ' ' + PROGRAM_VERSION + IFF(userid &lt;&gt; '0', #9 + userid, ''));
 end;
 
 procedure TMainForm.TryToRegister(Username, Password: string);
@@ -7203,6 +7272,8 @@
   begin
     Battle := GetBattleFromNode(Node);
 
+    R := ContentRect;
+
     if (Node = FocusedNode) and Focused then
       Canvas.Font.Color := clHighlightText
     else
@@ -7211,19 +7282,23 @@
 
       // clientgroup highlight
       Canvas.Brush.Color := Battle.GetHighlightColor;
-      R := ContentRect;
-      Dec(R.Left,TextMargin);
-      Canvas.FillRect(R);
     end;
 
-    R := ContentRect;
+    InflateRect(R, TextMargin, 0);
+    if Column = 0 then
+    begin
+      InflateRect(R, -TextMargin+2, 0);
+    end;
+    Canvas.FillRect(R);
     InflateRect(R, -TextMargin, 0);
+
     Dec(R.Right);
     Dec(R.Bottom);
     s := '';
 
     case Column of
-      0: ; // join
+      0: // join
+      ;
       1:
       begin
         if Battle.IsLadderBattle then begin
@@ -7466,6 +7541,12 @@
 procedure TMainForm.FormClose(Sender: TObject; var Action: TCloseAction);
 begin
   if Debug.Log then ((PageControl1.Pages[0] as TMyTabSheet).Controls[1] as TRichEdit).Lines.SaveToFile(ExtractFilePath(Application.ExeName) + LOG_FILENAME);
+  if FiltersButton.ImageIndex = 1 then
+  begin
+    FilterGroup.Height := 0;
+    PageControl1.Height := PageControl1.Height + 173;
+    FiltersButton.ImageIndex := 0;
+  end;
   if SaveToRegOnExit then PreferencesForm.WritePreferencesToRegistry;
 
   OnlineMapsForm.SaveOnlineMapsToCache(ExtractFilePath(Application.ExeName) + ONLINE_CACHE_FOLDER);
@@ -7473,7 +7554,7 @@
   PerformForm.SaveCommandListToFile(ExtractFilePath(Application.ExeName) + VAR_FOLDER + '\perform.dat');
   HighlightingForm.SaveHighlightsToFile(ExtractFilePath(Application.ExeName) + VAR_FOLDER + '\highlights.dat');
   IgnoreListForm.SaveIgnoreListToFile(ExtractFilePath(Application.ExeName) + VAR_FOLDER + '\ignorelist.dat');
-  SaveFiltersToFile;
+  SaveFiltersToFile(FILTERS_FOLDER + '\default.ini');
   ReplaysForm.SaveReplayFiltersToFile;
   SaveGroups;
 end;
@@ -8844,7 +8925,7 @@
   f^.enabled := True;
   FilterList.Invalidate;
   FilterValueTextBox.Text := '';
-  RefreshBattleList;
+  FiltersUpdated;
 end;
 
 procedure TMainForm.PlayersSignButtonClick(Sender: TObject);
@@ -8864,7 +8945,7 @@
     PlayersSignButton.Caption := '&gt;';
     Filters.Players.filterType := Sup;
   end;
-  RefreshBattleList;
+  FiltersUpdated;
 end;
 
 procedure TMainForm.MaxPlayersSignButtonClick(Sender: TObject);
@@ -8884,73 +8965,84 @@
     MaxPlayersSignButton.Caption := '&gt;';
     Filters.MaxPlayers.filterType := Sup;
   end;
-  RefreshBattleList;
+  FiltersUpdated;
 end;
 
 procedure TMainForm.PlayersValueTextBoxChange(Sender: TObject);
 begin
+  if not PlayersValueTextBox.Focused then Exit;
   Filters.Players.value := PlayersValueTextBox.AsInteger;
-  RefreshBattleList;
+  FiltersUpdated;
 end;
 
 procedure TMainForm.MaxPlayersValueTextBoxChange(Sender: TObject);
 begin
+  if not MaxPlayersValueTextBox.Focused then Exit;
   Filters.MaxPlayers.value := MaxPlayersValueTextBox.AsInteger;
-  RefreshBattleList;
+  FiltersUpdated;
 end;
 
 procedure TMainForm.FullFilterClick(Sender: TObject);
 begin
+  if not FullFilter.Focused then Exit;
   Filters.Full := FullFilter.Checked;
-  RefreshBattleList;
+  FiltersUpdated;
 end;
 
 procedure TMainForm.InProgressFilterClick(Sender: TObject);
 begin
+  if not InProgressFilter.Focused then Exit;
   Filters.InProgress := InProgressFilter.Checked;
-  RefreshBattleList;
+  FiltersUpdated;
 end;
 
 procedure TMainForm.LadderFilterClick(Sender: TObject);
 begin
+  if not LadderFilter.Focused then Exit;
   Filters.Ladder := LadderFilter.Checked;
-  RefreshBattleList;
+  FiltersUpdated;
 end;
 
 procedure TMainForm.LockedFilterClick(Sender: TObject);
 begin
+  if not LockedFilter.Focused then Exit;
   Filters.Locked := LockedFilter.Checked;
-  RefreshBattleList;
+  FiltersUpdated;
 end;
 
 procedure TMainForm.PasswordedFilterClick(Sender: TObject);
 begin
+  if not PasswordedFilter.Focused then Exit;
   Filters.Passworded := PasswordedFilter.Checked;
-  RefreshBattleList;
+  FiltersUpdated;
 end;
 
 procedure TMainForm.NatTraversalFilterClick(Sender: TObject);
 begin
+  if not NatTraversalFilter.Focused then Exit;
   Filters.NatTraversal := NatTraversalFilter.Checked;
-  RefreshBattleList;
+  FiltersUpdated;
 end;
 
 procedure TMainForm.RankLimitFilterClick(Sender: TObject);
 begin
+  if not RankLimitFilter.Focused then Exit;
   Filters.RankLimitSupEqMine := RankLimitFilter.Checked;
-  RefreshBattleList;
+  FiltersUpdated;
 end;
 
 procedure TMainForm.MapsNotAvailableFilterClick(Sender: TObject);
 begin
+  if not MapsNotAvailableFilter.Focused then Exit;
   Filters.MapNotAvailable := MapsNotAvailableFilter.Checked;
-  RefreshBattleList;
+  FiltersUpdated;
 end;
 
 procedure TMainForm.ModsNotAvailableFilterClick(Sender: TObject);
 begin
+  if not ModsNotAvailableFilter.Focused then Exit;
   Filters.ModNotAvailable := ModsNotAvailableFilter.Checked;
-  RefreshBattleList;
+  FiltersUpdated;
 end;
 
 procedure TMainForm.FilterListGetText(Sender: TBaseVirtualTree;
@@ -8984,13 +9076,15 @@
 
 procedure TMainForm.FilterGroupResize(Sender: TObject);
 begin
-  FilterList.Width := FilterGroup.Width - 402;
+  //FilterList.Width := FilterGroup.Width - 402;
+  EnableFilters.left := FilterGroup.Width - 120;
 end;
 
 procedure TMainForm.ReplaysFilterClick(Sender: TObject);
 begin
+  if not ReplaysFilter.Focused then Exit;
   Filters.Replays := ReplaysFilter.Checked;
-  RefreshBattleList;
+  FiltersUpdated;
 end;
 
 procedure TMainForm.EnableFiltersClick(Sender: TObject);
@@ -9010,14 +9104,14 @@
     n := FilterList.GetNextSelected(n);
   end;
   FilterList.DeleteSelectedNodes;
-  RefreshBattleList;
+  FiltersUpdated;
 end;
 
 procedure TMainForm.ClearFilterListButtonClick(Sender: TObject);
 begin
   Filters.TextFilters.Clear;
   FilterList.Clear;
-  RefreshBattleList;
+  FiltersUpdated;
 end;
 
 procedure TMainForm.mnuDisplayFiltersClick(Sender: TObject);
@@ -9092,14 +9186,14 @@
   end;
 end;
 
-procedure TMainForm.SaveFiltersToFile;
+procedure TMainForm.SaveFiltersToFile(path : string);
 var
   Filename : String;
   Ini : TIniFile;
   i:integer;
 begin
   try
-    Filename := VAR_FOLDER + '\' + 'filters.ini';
+    Filename := path; //VAR_FOLDER + '\' + 'filters.ini';
     if FileExists(Filename) then
       DeleteFile(Filename);
     Ini := TIniFile.Create(Filename);
@@ -9156,7 +9250,7 @@
   end;
 end;
 
-procedure TMainForm.LoadFiltersFromFile;
+procedure TMainForm.LoadFiltersFromFile(path : string);
 var
   Filename : String;
   Ini : TIniFile;
@@ -9164,7 +9258,7 @@
   tmpStr: String;
   f: ^TFilterText;
 begin
-  Filename := VAR_FOLDER + '\' + 'filters.ini';
+  Filename := path; //VAR_FOLDER + '\' + 'filters.ini';
   Ini := TIniFile.Create(Filename);
   i := 0;
   Filters.Full := Ini.ReadBool('StaticFilters', 'Full', True);
@@ -9198,6 +9292,7 @@
     Filters.MaxPlayers.filterType := Equal;
   Filters.MaxPlayers.value := Ini.ReadInteger('StaticFilters', 'MaxPlayersValue', 1);
 
+  Filters.TextFilters.Clear;
   i := 0;
   while Ini.SectionExists('TextFilter'+IntToStr(i)) do begin
     tmpStr := Ini.ReadString('TextFilter'+IntToStr(i), 'Type', 'Error');
@@ -9225,6 +9320,30 @@
   Ini.Free;
 end;
 
+procedure TMainForm.LoadPresets;
+var
+  FileAttrs: Integer;
+  sr: TSearchRec;
+begin
+  FileAttrs := faAnyFile;
+  if FindFirst(FILTERS_FOLDER + '\*.ini', FileAttrs, sr) = 0 then
+  begin
+    repeat
+      if (sr.Name &lt;&gt; '.') and (sr.Name &lt;&gt; '..') and (sr.Name &lt;&gt; 'default.ini') then
+      begin
+        PresetListbox.Items.Add(LeftStr(''+sr.Name,Length(''+sr.Name)-4));
+      end;
+    until FindNext(sr) &lt;&gt; 0;
+    FindClose(sr);
+  end;
+end;
+
+procedure TMainForm.FiltersUpdated;
+begin
+  PresetListbox.Selected[0] := true;
+  RefreshBattleList;
+end;
+
 procedure TMainForm.UpdateFilters;
 var
   i: integer;
@@ -9258,6 +9377,7 @@
     MaxPlayersSignButton.Caption := '=';
   MaxPlayersValueTextBox.Value := Filters.MaxPlayers.value;
 
+  FilterList.Clear;
   for i:=0 to Filters.TextFilters.Count -1 do
   begin
     TFilterText(Filters.TextFilters[i]^).Node := FilterList.AddChild(FilterList.RootNode);
@@ -9300,14 +9420,16 @@
 
 procedure TMainForm.PlayersFilterClick(Sender: TObject);
 begin
+  if not PlayersFilter.Focused then Exit;
   Filters.Players.enabled := PlayersFilter.Checked;
-  RefreshBattleList;
+  FiltersUpdated;
 end;
 
 procedure TMainForm.MaxPlayersFilterClick(Sender: TObject);
 begin
+  if not MaxPlayersFilter.Focused then Exit;
   Filters.MaxPlayers.enabled := MaxPlayersFilter.Checked;
-  RefreshBattleList;
+  FiltersUpdated;
 end;
 
 procedure TMainForm.FilterListResize(Sender: TObject);
@@ -9450,6 +9572,7 @@
   HttpCli2.RcvdStream.ReadBuffer(Pointer(html)^, HttpCli2.RcvdStream.Size);
 
   // clear players cups
+
   for i:=0 to AllClients.Count-1 do
   begin
     TClient(AllClients[i]).CupList.Clear;
@@ -9539,18 +9662,12 @@
 procedure TMainForm.FilterListChecking(Sender: TBaseVirtualTree;
   Node: PVirtualNode; var NewState: TCheckState; var Allowed: Boolean);
 begin
+  if not FilterList.Focused then Exit;
   TFilterText(Filters.TextFilters[GetFilterIndexFromNode(Node)]^).enabled := NewState = csCheckedNormal;
   RefreshBattleList;
+  FiltersUpdated;
 end;
 
-procedure TMainForm.Button1Click(Sender: TObject);
-var
-  s: string;
-  s2 : WideString;
-begin
-
-end;
-
 procedure TMainForm.BattleListPopupMenuInitPopup(Sender: TObject;
   PopupView: TTBView);
 begin
@@ -9986,9 +10103,57 @@
     TClient(AllClients[i]).AutoKickMsgSent := 0;
 end;
 
+procedure TMainForm.ResetAutoSpecMsgSentCounters;
+var
+  i: integer;
+begin
+  for i:=0 to AllClients.Count-1 do
+    TClient(AllClients[i]).AutoSpecMsgSent := 0;
+end;
+
 procedure TMainForm.SpTBXItem4Click(Sender: TObject);
 begin
     Misc.OpenURLInDefaultBrowser('<A HREF="http://www.springlobby.info">http://www.springlobby.info</A>');
 end;
 
+procedure TMainForm.btSavePresetClick(Sender: TObject);
+begin
+  if PresetListbox.Items.IndexOf(PresetNameTextbox.Text) &gt;= 0 then
+  begin
+    MessageDlg('That preset name already exists. Please choose another name.',mtWarning,[mbOk],0);
+    Exit;
+  end;
+  SaveFiltersToFile(FILTERS_FOLDER + '\'+PresetNameTextbox.Text+'.ini');
+  PresetListbox.Items.Add(PresetNameTextbox.Text);
+  PresetListbox.Selected[PresetListbox.Count-1] := true;
+end;
+
+procedure TMainForm.PresetListboxClick(Sender: TObject);
+begin
+  if (PresetListbox.ItemIndex = 0) and not FileExists(FILTERS_FOLDER + '\' + PresetListbox.Items[PresetListbox.ItemIndex] + '.ini') then Exit;
+  LoadFiltersFromFile(FILTERS_FOLDER + '\' + PresetListbox.Items[PresetListbox.ItemIndex] + '.ini');
+  UpdateFilters;
+  RefreshBattleList;
+end;
+
+procedure TMainForm.btDeletePresetClick(Sender: TObject);
+begin
+  if PresetListbox.ItemIndex = 0 then Exit;
+  DeleteFile(FILTERS_FOLDER + '\' + PresetListbox.Items[PresetListbox.ItemIndex] + '.ini');
+  PresetListbox.Items.Delete(PresetListbox.ItemIndex);
+  PresetListbox.Selected[0] := true;
+end;
+
+procedure TMainForm.btClearPresetClick(Sender: TObject);
+var
+  i: integer;
+begin
+  for i:=PresetListbox.Count-1 downto 1 do
+  begin
+    DeleteFile(FILTERS_FOLDER + '\' + PresetListbox.Items[i] + '.ini');
+    PresetListbox.Items.Delete(i);
+  end;
+  PresetListbox.Selected[0] := true;
+end;
+
 end.

Modified: trunk/Lobby/TASClient/MapListFormUnit.pas
===================================================================
--- trunk/Lobby/TASClient/MapListFormUnit.pas	2008-06-16 21:09:43 UTC (rev 6036)
+++ trunk/Lobby/TASClient/MapListFormUnit.pas	2008-06-16 22:20:02 UTC (rev 6037)
@@ -6,7 +6,7 @@
   Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
   Dialogs, ExtCtrls, Buttons, StdCtrls, Menus, TB2Item, TBX, SpTBXItem,
   TBXDkPanels, SpTBXControls, TBXToolPals, SpTBXTabs, ComCtrls,
-  JvExComCtrls, JvComCtrls, Utility,Misc, TntForms,Math;
+  JvExComCtrls, JvComCtrls, Utility,Misc, TntForms,Math,MainUnit;
 
 const
   MAP_ITEM_WIDTH = 415;
@@ -110,6 +110,7 @@
     MapInfoLoaded: Boolean;
     MapImageLoaded: Boolean;
     MapInfo: TMapInfo; // valid only if MapInfoLoaded is True!
+    Boxes: TScript;
 
     MyGrade: Integer; // 0 if not graded yet, and 1 to 10 for the actual grade otherwise
     GlobalGrade: Float; // avarage grade based on votes from other users
@@ -174,7 +175,7 @@
 
 implementation
 
-uses BattleFormUnit, PreferencesFormUnit, MainUnit, InitWaitFormUnit,
+uses BattleFormUnit, PreferencesFormUnit, InitWaitFormUnit,
   SpTBXLists, TntWideStrings;
 
 {$R *.dfm}

Modified: trunk/Lobby/TASClient/PerformFormUnit.pas
===================================================================
--- trunk/Lobby/TASClient/PerformFormUnit.pas	2008-06-16 21:09:43 UTC (rev 6036)
+++ trunk/Lobby/TASClient/PerformFormUnit.pas	2008-06-16 22:20:02 UTC (rev 6037)
@@ -157,6 +157,7 @@
 var
   i: integer;
 begin
+  if CommandsListBox.ItemIndex = -1 then Exit;
   i := Max(0,CommandsListBox.ItemIndex-1);
   CommandsListBox.Items.Move(CommandsListBox.ItemIndex,i);
   CommandsListBox.ItemIndex := i;
@@ -166,6 +167,7 @@
 var
   i: integer;
 begin
+  if CommandsListBox.ItemIndex = -1 then Exit;
   i := Min(CommandsListBox.Count-1,CommandsListBox.ItemIndex+1);
   CommandsListBox.Items.Move(CommandsListBox.ItemIndex,i);
   CommandsListBox.ItemIndex := i;

Modified: trunk/Lobby/TASClient/PreferencesFormUnit.dfm
===================================================================
--- trunk/Lobby/TASClient/PreferencesFormUnit.dfm	2008-06-16 21:09:43 UTC (rev 6036)
+++ trunk/Lobby/TASClient/PreferencesFormUnit.dfm	2008-06-16 22:20:02 UTC (rev 6037)
@@ -1,6 +1,6 @@
 object PreferencesForm: TPreferencesForm
-  Left = 869
-  Top = 298
+  Left = 415
+  Top = 204
   BorderStyle = bsDialog
   Caption = 'Preferences'
   ClientHeight = 392
@@ -37,7 +37,7 @@
       Width = 361
       Height = 305
       Color = clBtnFace
-      ActiveTabIndex = 3
+      ActiveTabIndex = 1
       TabAutofit = True
       HiddenItems = &lt;&gt;
       object SpTBXTabItem6: TSpTBXTabItem
@@ -46,6 +46,7 @@
       end
       object SpTBXTabItem5: TSpTBXTabItem
         Caption = 'Account'
+        Checked = True
         CustomWidth = 59
       end
       object SpTBXTabItem4: TSpTBXTabItem
@@ -54,7 +55,6 @@
       end
       object SpTBXTabItem3: TSpTBXTabItem
         Caption = 'Interface'
-        Checked = True
         CustomWidth = 59
       end
       object SpTBXTabItem2: TSpTBXTabItem
@@ -267,127 +267,6 @@
           end
         end
       end
-      object SpTBXTabSheet5: TSpTBXTabSheet
-        Left = 0
-        Top = 23
-        Width = 361
-        Height = 282
-        Caption = 'Account'
-        ImageIndex = -1
-        TabItem = 'SpTBXTabItem5'
-        object GroupBox2: TSpTBXGroupBox
-          Left = 16
-          Top = 8
-          Width = 329
-          Height = 257
-          Caption = 'Account details'
-          Color = clNone
-          ParentColor = False
-          TabOrder = 0
-          object RegisterAccountButton: TSpTBXSpeedButton
-            Left = 56
-            Top = 144
-            Width = 185
-            Height = 25
-            Caption = 'Create new account'
-            OnClick = RegisterAccountButtonClick
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
-          object Label4: TSpTBXLabel
-            Left = 24
-            Top = 40
-            Width = 51
-            Height = 13
-            Caption = 'Username:'
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
-          object Label5: TSpTBXLabel
-            Left = 24
-            Top = 72
-            Width = 49
-            Height = 13
-            Caption = 'Password:'
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
-          object UsernameEdit: TSpTBXEdit
-            Left = 120
-            Top = 40
-            Width = 121
-            Height = 21
-            TabOrder = 0
-            OnChange = UsernameEditChange
-          end
-          object PasswordEdit: TSpTBXEdit
-            Left = 120
-            Top = 72
-            Width = 121
-            Height = 21
-            TabOrder = 1
-            PasswordCharW = '*'
-          end
-          object LadderPasswordEdit: TSpTBXEdit
-            Left = 120
-            Top = 104
-            Width = 121
-            Height = 21
-            Enabled = False
-            TabOrder = 5
-            PasswordCharW = '*'
-          end
-          object SpTBXLabel1: TSpTBXLabel
-            Left = 24
-            Top = 104
-            Width = 87
-            Height = 13
-            Caption = 'Ladder password :'
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
-          object ChangeLadderPasswordButton: TSpTBXButton
-            Left = 248
-            Top = 104
-            Width = 41
-            Height = 21
-            Caption = 'Edit'
-            TabOrder = 7
-            OnClick = ChangeLadderPasswordButtonClick
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
-          object RegisterLadderAccountButton: TSpTBXButton
-            Left = 56
-            Top = 176
-            Width = 185
-            Height = 25
-            Caption = 'Create new ladder account'
-            TabOrder = 8
-            OnClick = RegisterLadderAccountButtonClick
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
-        end
-      end
       object SpTBXTabSheet6: TSpTBXTabSheet
         Left = 0
         Top = 23
@@ -845,6 +724,128 @@
           end
         end
       end
+      object SpTBXTabSheet5: TSpTBXTabSheet
+        Left = 0
+        Top = 23
+        Width = 361
+        Height = 282
+        Caption = 'Account'
+        ImageIndex = -1
+        TabItem = 'SpTBXTabItem5'
+        object GroupBox2: TSpTBXGroupBox
+          Left = 16
+          Top = 8
+          Width = 329
+          Height = 257
+          Caption = 'Account details'
+          Color = clNone
+          ParentColor = False
+          TabOrder = 0
+          object RegisterAccountButton: TSpTBXSpeedButton
+            Left = 56
+            Top = 144
+            Width = 185
+            Height = 25
+            Caption = 'Create new account'
+            OnClick = RegisterAccountButtonClick
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
+          end
+          object Label4: TSpTBXLabel
+            Left = 24
+            Top = 40
+            Width = 51
+            Height = 13
+            Caption = 'Username:'
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
+          end
+          object Label5: TSpTBXLabel
+            Left = 24
+            Top = 72
+            Width = 49
+            Height = 13
+            Caption = 'Password:'
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
+          end
+          object UsernameEdit: TSpTBXEdit
+            Left = 120
+            Top = 40
+            Width = 121
+            Height = 21
+            TabOrder = 0
+            OnChange = UsernameEditChange
+          end
+          object PasswordEdit: TSpTBXEdit
+            Left = 120
+            Top = 72
+            Width = 121
+            Height = 21
+            TabOrder = 1
+            OnChange = PasswordEditChange
+            PasswordCharW = '*'
+          end
+          object LadderPasswordEdit: TSpTBXEdit
+            Left = 120
+            Top = 104
+            Width = 121
+            Height = 21
+            Enabled = False
+            TabOrder = 5
+            PasswordCharW = '*'
+          end
+          object SpTBXLabel1: TSpTBXLabel
+            Left = 24
+            Top = 104
+            Width = 87
+            Height = 13
+            Caption = 'Ladder password :'
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
+          end
+          object ChangeLadderPasswordButton: TSpTBXButton
+            Left = 248
+            Top = 104
+            Width = 41
+            Height = 21
+            Caption = 'Edit'
+            TabOrder = 7
+            OnClick = ChangeLadderPasswordButtonClick
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
+          end
+          object RegisterLadderAccountButton: TSpTBXButton
+            Left = 56
+            Top = 176
+            Width = 185
+            Height = 25
+            Caption = 'Create new ladder account'
+            TabOrder = 8
+            OnClick = RegisterLadderAccountButtonClick
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
+          end
+        end
+      end
     end
     object ApplyAndCloseButton: TSpTBXButton
       Left = 24

Modified: trunk/Lobby/TASClient/PreferencesFormUnit.pas
===================================================================
--- trunk/Lobby/TASClient/PreferencesFormUnit.pas	2008-06-16 21:09:43 UTC (rev 6036)
+++ trunk/Lobby/TASClient/PreferencesFormUnit.pas	2008-06-16 22:20:02 UTC (rev 6037)
@@ -207,6 +207,7 @@
     procedure ColorsButtonClick(Sender: TObject);
     procedure ManageGroupsButtonClick(Sender: TObject);
     procedure ChatLogsLimitTrackerChange(Sender: TObject);
+    procedure PasswordEditChange(Sender: TObject);
   private
     { Private declarations }
   public
@@ -260,9 +261,12 @@
 var
   PreferencesForm: TPreferencesForm;
   Preferences: TPreferences;
+  CommandLineServer: string;
+  CommandLinePort: string;
   SaveOnClose: Boolean;
   ProgramInitialized: Boolean = False; // if True, then main initialization has been done already. We use it so we don't reinit anything.
   SaveToRegOnExit: Boolean = True; // should we save preferences to registry on exit?
+  PasswordChanged: Boolean = False; // has the user changed the password ? if yes it must be crypted before being saved
 
   ServerList: array[0..3] of TServerListItem = (
     (Name: 'Official host (taspringmaster.clan-sy.com)'; Address: 'taspringmaster.clan-sy.com'),
@@ -377,6 +381,8 @@
     try MainForm.Panel2.Width := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\MainForm', 'Splitter1'); except end;
     try MainForm.PageControl1.Height := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\MainForm', 'Splitter2'); except end;
     try MainForm.EnableFilters.Checked := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\MainForm', 'EnableFilters'); except end;
+    try MainForm.FiltersTabs.ActiveTabIndex := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\MainForm', 'FiltersActiveTab'); except end;
+
     with MainForm.VDTBattles.Header.Columns do
       for i := 0 to Count-1 do
       try
@@ -393,7 +399,7 @@
     try BattleForm.WindowState := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'WindowState'); except end;
     try BattleForm.Panel1.Height := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'Splitter4'); except end;
     try BattleForm.Panel4.Height := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'Splitter2'); except end;
-    try BattleForm.Panel6.Width := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'Splitter3'); except end;
+    //try BattleForm.Panel6.Width := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'Splitter3'); except end;
     try BattleForm.KeepRatioItem.Checked := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'KeepMinimapRatio'); except end;
 
     {--&gt;} AllowBattleDetailsUpdate := False;
@@ -479,6 +485,7 @@
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\MainForm', 'Splitter1', rdInteger, MainForm.Panel2.Width);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\MainForm', 'Splitter2', rdInteger, MainForm.PageControl1.Height);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\MainForm', 'EnableFilters', rdInteger, Misc.BoolToInt(MainForm.EnableFilters.Checked));
+    Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\MainForm', 'FiltersActiveTab', rdInteger, MainForm.FiltersTabs.ActiveTabIndex);
     with MainForm.VDTBattles.Header.Columns do
       for i := 0 to Count-1 do
       begin
@@ -714,7 +721,7 @@
     Exit;
   end;
 
-  if (not VerifyName(UsernameEdit.Text)) or (not VerifyName(PasswordEdit.Text)) then
+  if (not VerifyName(UsernameEdit.Text)) or (not VerifyName(PasswordEdit.Text) and PasswordChanged) then
   begin
     MessageDlg('Your username and/or password consists of illegal characters!', mtWarning, [mbOK], 0);
     Exit;
@@ -725,6 +732,9 @@
     MainForm.TryToDisconnect;
   end;
 
+  if PasswordChanged then
+    PasswordEdit.Text := Misc.GetMD5Hash(PasswordEdit.Text);
+
   SaveOnClose := True;
   Close;
 end;
@@ -1379,4 +1389,10 @@
   ChatLogsLimitCheckBox.Caption := 'Limit chat logs to ' + IntToStr(ChatLogsLimitTracker.Position) + ' lines';
 end;
 
+procedure TPreferencesForm.PasswordEditChange(Sender: TObject);
+begin
+  if not PasswordEdit.Focused then Exit;
+  PasswordChanged := true;
+end;
+
 end.

Modified: trunk/Lobby/TASClient/TASClient.dof
===================================================================
--- trunk/Lobby/TASClient/TASClient.dof	2008-06-16 21:09:43 UTC (rev 6036)
+++ trunk/Lobby/TASClient/TASClient.dof	2008-06-16 22:20:02 UTC (rev 6037)
@@ -115,7 +115,7 @@
 MajorVer=0
 MinorVer=3
 Release=0
-Build=314
+Build=315
 Debug=0
 PreRelease=0
 Special=0
@@ -126,7 +126,7 @@
 [Version Info Keys]
 CompanyName=
 FileDescription=TA Spring lobby client
-FileVersion=0.3.0.314
+FileVersion=0.3.0.315
 InternalName=
 LegalCopyright=
 LegalTrademarks=

Modified: trunk/Lobby/TASClient/TASClient.dpr
===================================================================
--- trunk/Lobby/TASClient/TASClient.dpr	2008-06-16 21:09:43 UTC (rev 6036)
+++ trunk/Lobby/TASClient/TASClient.dpr	2008-06-16 22:20:02 UTC (rev 6037)
@@ -98,6 +98,8 @@
   ColorsPreferenceUnit in 'ColorsPreferenceUnit.pas' {ColorsPreference},
   Math,
   Classes,
+  Dialogs,
+  StrUtils,
   SearchPlayerFormUnit in 'SearchPlayerFormUnit.pas' {SearchPlayerForm};
 
 var
@@ -114,10 +116,26 @@
 
   // read command line arguments:
   for i := 1 to ParamCount do
+  begin
     MainUnit.RunningUnderWine := MainUnit.RunningUnderWine or (UpperCase(ParamStr(i)) = 'WINE') or (UpperCase(ParamStr(i)) = '-WINE');
+    if UpperCase(ParamStr(i)) = '-SERVER' then
+      if (ParamCount = i) or (Pos(':',ParamStr(i+1)) = 0) then
+        MessageDlg('Wrong -server usage : -server myserver.com:8200',mtWarning,[mbOk],0)
+      else
+      begin
+        try
+          CommandLineServer := LeftStr(ParamStr(i+1),Pos(':',ParamStr(i+1))-1);
+          CommandLinePort := IntToStr(StrToInt(MidStr(ParamStr(i+1),Pos(':',ParamStr(i+1))+1,99999)));
+        except
+          MessageDlg('Wrong -server usage : -server myserver.com:8200',mtWarning,[mbOk],0);
+        end;
+      end;
+  end;
 
   MainUnit.RunningUnderWine := MainUnit.RunningUnderWine;
 
+
+
   // first create splash screen (but preferences must already be loaded!):
   SplashScreenForm := TSplashScreenForm.Create(nil);
   SplashScreenForm.VersionLabel.Caption := VERSION_NUMBER;

Modified: trunk/Lobby/TASClient/TASClient.res
===================================================================
(Binary files differ)

Modified: trunk/Lobby/TASClient/Utility.pas
===================================================================
--- trunk/Lobby/TASClient/Utility.pas	2008-06-16 21:09:43 UTC (rev 6036)
+++ trunk/Lobby/TASClient/Utility.pas	2008-06-16 22:20:02 UTC (rev 6037)
@@ -130,6 +130,7 @@
 {since 0.63} function GetSideName(side: Integer): PChar; stdcall; external 'UnitSync.dll' name 'GetSideName';
 {since 0.71} function GetMapArchiveCount(mapName: PChar): Integer; stdcall; external 'UnitSync.dll' name 'GetMapArchiveCount';
 {since 0.71} function GetMapArchiveName(index: Integer): PChar; stdcall; external 'UnitSync.dll' name 'GetMapArchiveName';
+{since 0.76} function GetMapChecksum(index: Integer): LongWord; stdcall; external 'UnitSync.dll' name 'GetMapChecksum';
 {------------------------------------------------------------------------------}
 {since 0.68}function FindFilesArchive(archive, cur: Integer; nameBuf: PChar; var size: Integer): Integer; stdcall; external 'UnitSync.dll' name 'FindFilesArchive';
 {since 0.68}function OpenArchive(name: PChar): Integer; stdcall; external 'UnitSync.dll' name 'OpenArchive';
@@ -257,6 +258,10 @@
   MapName: string;
   tmp: string;
   time: Cardinal;
+  archiveHwd: Integer;
+  fileHwd: Integer;
+  boxes: string;
+  size: integer;
 begin
   if UpdateSplashScreen and (SplashScreenForm = nil) then UpdateSplashScreen := False; // just in case if caller forgot to set it to false
 
@@ -282,11 +287,26 @@
      if MapList.IndexOf(MapName) &lt;&gt; -1 then Continue;
 
      // calculate checksum:
-     CheckSum := 0;
+     CheckSum := GetMapChecksum(i);
      c := GetMapArchiveCount(PChar(MapName));
-     for j := 0 to c-1 do
-       Inc(CheckSum, GetArchiveCheckSum(GetMapArchiveName(j)));
+     {for j := 0 to c-1 do
+       Inc(CheckSum, GetArchiveCheckSum(GetMapArchiveName(j)));}
 
+     {archiveHwd := OpenArchive(GetMapArchiveName(0));
+     if archiveHwd &lt;&gt; 0 then
+     begin
+        fileHwd := OpenArchiveFile(archiveHwd,'maps/boxes.sdf');
+        if fileHwd &lt;&gt; 0 then
+        begin
+          size := SizeArchiveFile(archiveHwd, fileHwd);
+          boxes := '';
+          SetLength(boxes,size);
+          ReadArchiveFile(archiveHwd,fileHwd,PChar(boxes),size);
+          CloseArchiveFile(archiveHwd,fileHwd);
+        end;
+        CloseArchive(archiveHwd);
+     end;}
+
      // check if map is &quot;valid&quot;:
      if CheckSum = 0 then
      begin
@@ -306,6 +326,8 @@
      MapListForm.AddMap;
      TMapItem(MapListForm.Maps[MapListForm.Maps.Count-1]).LoadMapInfo;
      TMapItem(MapListForm.Maps[MapListForm.Maps.Count-1]).LoadMinimap(True);
+     //TMapItem(MapListForm.Maps[MapListForm.Maps.Count-1]).Boxes := TScript.Create(boxes);
+
 //*** debug     MainForm.AddMainLog(MapName + ' ... ' + IntToStr(c) + ':' + MapCheckSums[MapCheckSums.Count-1], Colors.Info);
   end;
   MapListForm.SortedMaps.Assign(MapListForm.Maps);


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000816.html">[Taspring-linux-commit] r6036 - in trunk/rts: Game	Game/StartScripts Rendering System
</A></li>
	<LI>Next message: <A HREF="000818.html">[Taspring-linux-commit] r6038 - trunk/Lobby/TASClient
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#817">[ date ]</a>
              <a href="thread.html#817">[ thread ]</a>
              <a href="subject.html#817">[ subject ]</a>
              <a href="author.html#817">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
