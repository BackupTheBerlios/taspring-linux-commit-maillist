<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r7423 - in Lobby/TASClient: .	LobbyComponents/DockPanel Python Python/scripts
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2010-March/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r7423%20-%20in%20Lobby/TASClient%3A%20.%0A%09LobbyComponents/DockPanel%20Python%20Python/scripts&In-Reply-To=%3C20100303233252.0E9672D411%40it-l.eu%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="002194.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r7423 - in Lobby/TASClient: .	LobbyComponents/DockPanel Python Python/scripts</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r7423%20-%20in%20Lobby/TASClient%3A%20.%0A%09LobbyComponents/DockPanel%20Python%20Python/scripts&In-Reply-To=%3C20100303233252.0E9672D411%40it-l.eu%3E"
       TITLE="[Taspring-linux-commit] r7423 - in Lobby/TASClient: .	LobbyComponents/DockPanel Python Python/scripts">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Thu Mar  4 00:32:51 CET 2010</I>
    <P><UL>
        
        <LI>Next message: <A HREF="002194.html">[Taspring-linux-commit] r7424 - in Lobby/TASClient: . Python/scripts
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2193">[ date ]</a>
              <a href="thread.html#2193">[ thread ]</a>
              <a href="subject.html#2193">[ subject ]</a>
              <a href="author.html#2193">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: satirik
Date: 2010-03-04 00:32:51 +0100 (Thu, 04 Mar 2010)
New Revision: 7423

Modified:
   Lobby/TASClient/AutoJoinFormUnit.dfm
   Lobby/TASClient/AutoJoinFormUnit.pas
   Lobby/TASClient/BattleFormUnit.dfm
   Lobby/TASClient/LobbyComponents/DockPanel/DockPanel.pas
   Lobby/TASClient/MainUnit.dfm
   Lobby/TASClient/MainUnit.pas
   Lobby/TASClient/PreferencesFormUnit.pas
   Lobby/TASClient/ProgressBarWindow.dfm
   Lobby/TASClient/Python/api.txt
   Lobby/TASClient/Python/scripts/mapdownload.py
   Lobby/TASClient/ReplaysUnit.dfm
   Lobby/TASClient/ReplaysUnit.pas
   Lobby/TASClient/TASClient.dof
   Lobby/TASClient/TASClient.res
   Lobby/TASClient/UploadReplayUnit.dfm
Log:
* PYTHON: mapdownload now auto stop map download when joining a new battle
* Autojoin : &quot;Keep looking for the best battle after joining until I am ready&quot; option added
* New &quot;players&quot; filter added for battles so you can make a #player range
* The current filters presets (for battles and replays) are now called &quot;current&quot; instead of &quot;default&quot;
* Simple click now just select a filters preset, Dbl click loads it

Modified: Lobby/TASClient/AutoJoinFormUnit.dfm
===================================================================
--- Lobby/TASClient/AutoJoinFormUnit.dfm	2010-02-28 17:22:03 UTC (rev 7422)
+++ Lobby/TASClient/AutoJoinFormUnit.dfm	2010-03-03 23:32:51 UTC (rev 7423)
@@ -3,11 +3,11 @@
   Top = 205
   BorderStyle = bsSingle
   Caption = 'AutoJoin'
-  ClientHeight = 426
+  ClientHeight = 482
   ClientWidth = 698
   Color = clBtnFace
-  Constraints.MaxHeight = 750
-  Constraints.MaxWidth = 1280
+  Constraints.MaxHeight = 1150
+  Constraints.MaxWidth = 1920
   Font.Charset = DEFAULT_CHARSET
   Font.Color = clWindowText
   Font.Height = -11
@@ -23,7 +23,7 @@
     Left = 0
     Top = 0
     Width = 698
-    Height = 426
+    Height = 482
     Caption = 'AutoJoin'
     FixedSize = True
     Options.Maximize = False
@@ -340,7 +340,7 @@
     end
     object btClose: TSpTBXButton
       Left = 313
-      Top = 392
+      Top = 448
       Width = 73
       Height = 25
       Caption = 'Close'
@@ -352,5 +352,21 @@
       LinkFont.Name = 'MS Sans Serif'
       LinkFont.Style = [fsUnderline]
     end
+    object SpTBXGroupBox4: TSpTBXGroupBox
+      Left = 8
+      Top = 392
+      Width = 681
+      Height = 49
+      Caption = 'Options'
+      TabOrder = 5
+      object chkKeepLookingAfterJoining: TSpTBXCheckBox
+        Left = 16
+        Top = 24
+        Width = 296
+        Height = 15
+        Caption = 'Keep looking for the best battle after joining until I am ready'
+        TabOrder = 0
+      end
+    end
   end
 end

Modified: Lobby/TASClient/AutoJoinFormUnit.pas
===================================================================
--- Lobby/TASClient/AutoJoinFormUnit.pas	2010-02-28 17:22:03 UTC (rev 7422)
+++ Lobby/TASClient/AutoJoinFormUnit.pas	2010-03-03 23:32:51 UTC (rev 7423)
@@ -37,6 +37,8 @@
     btAutospecRemovePreset: TSpTBXButton;
     btAddPresetToAutospec: TSpTBXButton;
     btClose: TSpTBXButton;
+    SpTBXGroupBox4: TSpTBXGroupBox;
+    chkKeepLookingAfterJoining: TSpTBXCheckBox;
     procedure FormCreate(Sender: TObject);
     procedure FormShow(Sender: TObject);
     procedure btAddPresetToAutoplayClick(Sender: TObject);

Modified: Lobby/TASClient/BattleFormUnit.dfm
===================================================================
--- Lobby/TASClient/BattleFormUnit.dfm	2010-02-28 17:22:03 UTC (rev 7422)
+++ Lobby/TASClient/BattleFormUnit.dfm	2010-03-03 23:32:51 UTC (rev 7423)
@@ -4767,6 +4767,7 @@
         Font.Style = [fsBold]
         ParentFont = False
         Visible = False
+        CaptionGlow = gldBottomRight
         CaptionGlowColor = clBlack
         Smooth = True
         ThemeType = thtTBX

Modified: Lobby/TASClient/LobbyComponents/DockPanel/DockPanel.pas
===================================================================
--- Lobby/TASClient/LobbyComponents/DockPanel/DockPanel.pas	2010-02-28 17:22:03 UTC (rev 7422)
+++ Lobby/TASClient/LobbyComponents/DockPanel/DockPanel.pas	2010-03-03 23:32:51 UTC (rev 7423)
@@ -1259,10 +1259,10 @@
   PageControl.HotTrack := True;
   DockHandler(AOwner).RegisterPageControlHost(Self);
   PageControl.OwnerDraw := False;
-  PageControl.MultiLine := True;
   PageControl.DoubleBuffered := True;
   PageControl.TabWidth := 0;
   PageControl.TabHeight := 0;
+  PageControl.MultiLine := True;
 
   {*
   if DockHandler.TType = ttIcon then begin
@@ -1308,6 +1308,7 @@
 //  end;
 
   DockHandler.Refresh;
+  PageControl.MultiLine := True;
 
 end;
 
@@ -1420,8 +1421,6 @@
   nHeight := StrToIntDef(sl.Values['Height'], 200);
 
   PageControl.TabPosition := TTabPosition(StrToIntDef(sl.Values['TabPos'], 0));
-  if (PageControl.TabPosition &lt;&gt; tpLeft) and (PageControl.TabPosition &lt;&gt; tpRight) then
-  PageControl.MultiLine := False;
   BoundsRect := Rect(nLeft, nTop, nLeft + nWidth, nTop + nHeight);
 
   bFloating := StrToBool(sl.Values['Floating']);
@@ -1429,6 +1428,7 @@
     ManualDock(DockHandler.m_pcShadow);
     Align := alNone;
   end;
+  PageControl.MultiLine := True;
 
   // Set visibility
   Visible := StrToBool(sl.Values['Visible']);

Modified: Lobby/TASClient/MainUnit.dfm
===================================================================
--- Lobby/TASClient/MainUnit.dfm	2010-02-28 17:22:03 UTC (rev 7422)
+++ Lobby/TASClient/MainUnit.dfm	2010-03-03 23:32:51 UTC (rev 7423)
@@ -1,6 +1,6 @@
 object MainForm: TMainForm
-  Left = 936
-  Top = 609
+  Left = 687
+  Top = 93
   Width = 847
   Height = 521
   Caption = '.'
@@ -633,9 +633,10 @@
                   Anchors = [akLeft, akTop, akRight]
                   ItemHeight = 16
                   Items.Strings = (
-                    'default')
+                    'current')
                   TabOrder = 0
                   OnClick = PresetListboxClick
+                  OnDblClick = PresetListboxDblClick
                 end
                 object SpTBXLabel3: TSpTBXLabel
                   Left = 152
@@ -994,7 +995,7 @@
                   end
                   object MaxPlayersSignButton: TSpTBXButton
                     Left = 320
-                    Top = 39
+                    Top = 71
                     Width = 25
                     Height = 20
                     Caption = '&lt;'
@@ -1008,7 +1009,7 @@
                   end
                   object MaxPlayersValueTextBox: TJvSpinEdit
                     Left = 344
-                    Top = 39
+                    Top = 71
                     Width = 41
                     Height = 20
                     ButtonKind = bkStandard
@@ -1020,7 +1021,7 @@
                   end
                   object MaxPlayersFilter: TSpTBXCheckBox
                     Left = 232
-                    Top = 40
+                    Top = 72
                     Width = 78
                     Height = 15
                     Caption = 'Max Players '
@@ -1036,6 +1037,40 @@
                     TabOrder = 15
                     OnClick = PlayersFilterClick
                   end
+                  object Players2Filter: TSpTBXCheckBox
+                    Left = 232
+                    Top = 34
+                    Width = 55
+                    Height = 15
+                    Caption = 'Players '
+                    TabOrder = 16
+                    OnClick = Players2FilterClick
+                  end
+                  object Players2SignButton: TSpTBXButton
+                    Left = 320
+                    Top = 32
+                    Width = 25
+                    Height = 20
+                    Caption = '&lt;'
+                    TabOrder = 17
+                    OnClick = Players2SignButtonClick
+                    LinkFont.Charset = DEFAULT_CHARSET
+                    LinkFont.Color = clBlue
+                    LinkFont.Height = -11
+                    LinkFont.Name = 'MS Sans Serif'
+                    LinkFont.Style = [fsUnderline]
+                  end
+                  object Players2ValueTextBox: TJvSpinEdit
+                    Left = 344
+                    Top = 32
+                    Width = 41
+                    Height = 20
+                    ButtonKind = bkStandard
+                    MaxValue = 16.000000000000000000
+                    Value = 10.000000000000000000
+                    TabOrder = 18
+                    OnChange = Players2ValueTextBoxChange
+                  end
                 end
               end
             end
@@ -7230,8 +7265,8 @@
   end
   object AutojoinPopupMenu: TSpTBXPopupMenu
     AutoHotkeys = maManual
-    Left = 664
-    Top = 231
+    Left = 736
+    Top = 239
     object mnuPlaynow: TSpTBXItem
       Caption = 'Play now'
       OnClick = mnuPlaynowClick
@@ -7263,8 +7298,8 @@
   end
   object AutojoinTimer: TTimer
     OnTimer = AutojoinTimerTimer
-    Left = 632
-    Top = 231
+    Left = 768
+    Top = 239
   end
   object OptionsPopupMenu: TSpTBXPopupMenu
     OnInitPopup = OptionsPopupMenuInitPopup

Modified: Lobby/TASClient/MainUnit.pas
===================================================================
--- Lobby/TASClient/MainUnit.pas	2010-02-28 17:22:03 UTC (rev 7422)
+++ Lobby/TASClient/MainUnit.pas	2010-03-03 23:32:51 UTC (rev 7423)
@@ -405,7 +405,7 @@
   );
 
 const
-  VERSION_NUMBER = '0.66'; // Must be float value! (with a period as a decimal seperator)
+  VERSION_NUMBER = '0.67'; // Must be float value! (with a period as a decimal seperator)
   AUTOUPDATE_URL = '<A HREF="http://tasclient.no-ip.org/TASClient_update_v3.txt">http://tasclient.no-ip.org/TASClient_update_v3.txt</A>';
   PROGRAM_VERSION = 'TASClient ' + VERSION_NUMBER;
   KEEP_ALIVE_INTERVAL = 10000; // in milliseconds. Tells us what should be the maximum &quot;silence&quot; time before we send a ping to the server.
@@ -951,6 +951,7 @@
   TPresetFilters=
   record
     Name: String;
+    FileName: String;
     Full: Boolean;
     InProgress: Boolean;
     Ladder: Boolean;
@@ -962,6 +963,7 @@
     ModNotAvailable: Boolean;
     Replays: Boolean;
     Players: TFilterNumber;
+    Players2: TFilterNumber;
     MaxPlayers: TFilterNumber;
     TextFilters: TList;
   end;
@@ -1217,6 +1219,9 @@
     mnuSpringOptions: TSpTBXItem;
     EnableFilters: TSpTBXCheckBox;
     SpTBXSeparatorItem27: TSpTBXSeparatorItem;
+    Players2Filter: TSpTBXCheckBox;
+    Players2SignButton: TSpTBXButton;
+    Players2ValueTextBox: TJvSpinEdit;
     procedure mnuOpenPrivateChatClick(Sender: TObject);
     procedure mnuSelectBattleClick(Sender: TObject);
     procedure mnuPlayWithClick(Sender: TObject);
@@ -1283,11 +1288,12 @@
     procedure FilterListHeaderClick(Sender: TVTHeader;
       Column: TColumnIndex; Button: TMouseButton; Shift: TShiftState; X,
       Y: Integer);
-    procedure SaveFiltersToFile(path : string;Filters: TPresetFilters);
-    procedure LoadFiltersFromFile(path : string;var Filters: TPresetFilters);
+    procedure SaveFiltersToFile(Filters: TPresetFilters);
+    procedure LoadFiltersFromFile(var Filters: TPresetFilters);
     procedure LoadPresets;
     procedure FiltersUpdated;
     procedure UpdateFilters(pFilters: TPresetFilters);
+    procedure CopyFilters(srcFilters: TPresetFilters; var dstFilters: TPresetFilters);
     procedure HighlighBattlesTimerTimer(Sender: TObject);
     procedure FormResize(Sender: TObject);
     procedure PlayersFilterClick(Sender: TObject);
@@ -1383,6 +1389,10 @@
     procedure mnuDeleteLayoutClick(Sender: TObject);
     procedure LoadLayouts;
     procedure mnuSpringOptionsClick(Sender: TObject);
+    procedure PresetListboxDblClick(Sender: TObject);
+    procedure Players2FilterClick(Sender: TObject);
+    procedure Players2SignButtonClick(Sender: TObject);
+    procedure Players2ValueTextBoxChange(Sender: TObject);
   published
     MainTitleBar: TSpTBXTitleBar;
     ButtonImageList: TImageList;
@@ -1500,6 +1510,7 @@
     procedure SortClientsList(List: TList; SortStyle: Integer);
     procedure SortClientInList(client: TClient;List: TList; SortStyle: Integer);
     procedure SortBattlesList(BattleList: TList; SortStyle: Integer; Ascending: Boolean);
+    procedure RefreshBattlesNodes;
     function CompareClients(Client1: TClient; Client2: TClient; SortStyle: Integer): Shortint; // used with SortClientsList method (and other methods?)
     function CompareBattles(Battle1, Battle2: TBattle; SortStyle: Integer; SortDirection: Boolean): Shortint;
 
@@ -3833,7 +3844,7 @@
   MainPCH.Visible := True;
   MainPCH.Name := 'MainPCH';
   ChatTabs.Add(AddTabWindow(LOCAL_TAB, False));
-  
+
   PlayerListPanel.ManualDock(MainDockPanel,nil,alRight);
   BattlesPanel.ManualDock(MainDockPanel,nil,alBottom);
 
@@ -9026,13 +9037,12 @@
   s: string;
   res: Integer;
   url: string;
-  s1: TStrings;
   i:integer;
 begin
-  s1 := TStringList.Create;
   if BattleForm.IsBattleActive then
   begin
     //MessageDlg('You must first disconnect from current battle!', mtInformation, [mbOK], 0);
+    if Battle = BattleState.Battle then Exit;
     if LobbyScriptUnit.ScriptJoining then Exit;
     if MessageDlg(_('Do you want to disconnect from the current battle to join this one ?'),mtConfirmation, [mbYes,mbNo], 0) = mrYes then
       BattleForm.DisconnectButtonClick(nil)
@@ -9105,8 +9115,8 @@
       Exit;
     end;
   end;
-  mnuAutoplayFirstAvailable.Checked := False;
-  mnuAutospecFirstAvailable.Checked := False;
+  //mnuAutoplayFirstAvailable.Checked := False;
+  //mnuAutospecFirstAvailable.Checked := False;
   BattleState.TryingToJoinLadderBattle := Battle.IsLadderBattle;
   BattleState.LadderIndex := -1;
   TryToSendCommand('JOINBATTLE', IntToStr(Battle.ID) + IFF(Password &lt;&gt; '', ' ' + Password, ''));
@@ -9147,9 +9157,10 @@
   PerformForm.SaveCommandListToFile(ExtractFilePath(Application.ExeName) + VAR_FOLDER + '\perform.dat');
   HighlightingForm.SaveHighlightsToFile(ExtractFilePath(Application.ExeName) + VAR_FOLDER + '\highlights.dat');
   IgnoreListForm.SaveIgnoreListToFile(ExtractFilePath(Application.ExeName) + VAR_FOLDER + '\ignorelist.dat');
-  SaveFiltersToFile(FILTERS_FOLDER + '\default.ini',CurrentFilters);
+
+  SaveFiltersToFile(CurrentFilters);
   AutoJoinForm.SaveAutoJoinPresetLists;
-  ReplaysForm.SaveReplayFiltersToFile(REPLAY_FILTERS_FOLDER + '\default.ini');
+  ReplaysForm.SaveReplayFiltersToFile(REPLAY_FILTERS_FOLDER + '\current.ini');
   if RunningWithMainMenu then
     MenuForm.SaveSettings;
   SaveGroups;
@@ -9476,7 +9487,6 @@
 var
   i, index, j: Integer;
   tmp: TBattle;
-  tmpNode: PVirtualNode;
 begin
   {*
   BattleSorting := SortStyle;
@@ -9499,7 +9509,13 @@
       else break;
     end;
   end;
+end;
 
+procedure TMainForm.RefreshBattlesNodes;
+var
+  i: Integer;
+  tmpNode: PVirtualNode;
+begin
   tmpNode := nil;
   tmpNode := VDTBattles.GetFirst();
   for i:=0 to Battles.Count-1 do
@@ -9566,6 +9582,11 @@
       ((Filters.Players.filterType = Inf) and (Battle.Clients.Count-Battle.SpectatorCount &lt; Filters.Players.value)) or
       ((Filters.Players.filterType = Equal) and (Battle.Clients.Count-Battle.SpectatorCount = Filters.Players.value))
       ) and
+      (not Filters.Players2.enabled or
+      ((Filters.Players2.filterType = Sup) and (Battle.Clients.Count-Battle.SpectatorCount &gt; Filters.Players2.value)) or
+      ((Filters.Players2.filterType = Inf) and (Battle.Clients.Count-Battle.SpectatorCount &lt; Filters.Players2.value)) or
+      ((Filters.Players2.filterType = Equal) and (Battle.Clients.Count-Battle.SpectatorCount = Filters.Players2.value))
+      ) and
       (not Filters.MaxPlayers.enabled or
       ((Filters.MaxPlayers.filterType = Sup) and (Battle.MaxPlayers &gt; Filters.MaxPlayers.value)) or
       ((Filters.MaxPlayers.filterType = Inf) and (Battle.MaxPlayers &lt; Filters.MaxPlayers.value)) or
@@ -9587,14 +9608,11 @@
   while RefreshingBattleList do;
   RefreshingBattleList := true;
 
-  //SortBattlesList(Battles,Preferences.BattleSortStyle,Preferences.BattleSortDirection=0);
-
   j:=0;
   for i:=0 to Battles.Count-1 do begin
     TBattle(Battles[i]).Visible := isBattleVisible(Battles[i],CurrentFilters);
     if TBattle(Battles[i]).Visible then begin
       j:=j+1;
-      //VDTBattles.DeleteNode(TBattle(Battles[i]).Node);
     end;
   end;
   
@@ -9634,7 +9652,10 @@
   tmp: TBattle;
   tmpNode: PVirtualNode;
 begin
+  SortBattlesList(Battles,SortStyle,Ascending);
 
+  Exit;
+
   if (Index &lt; 0) or (Index &gt; Battles.Count-1) then Exit; // this should not happen!
 
   // sort down:
@@ -10065,6 +10086,7 @@
   else
     VDTBattles.Header.SortDirection := sdDescending;
   SortBattlesList(Battles ,Preferences.BattleSortStyle, Preferences.BattleSortDirection = 0);
+  RefreshBattlesNodes;
 
   tmpNode := nil;
   tmpNode := VDTBattles.GetFirst();
@@ -11072,14 +11094,14 @@
   end;
 end;
 
-procedure TMainForm.SaveFiltersToFile(path : string;Filters: TPresetFilters);
+procedure TMainForm.SaveFiltersToFile(Filters: TPresetFilters);
 var
   Filename : String;
   Ini : TIniFile;
   i:integer;
 begin
   try
-    Filename := path; //VAR_FOLDER + '\' + 'filters.ini';
+    Filename := Filters.FileName; //VAR_FOLDER + '\' + 'filters.ini';
     if FileExists(Filename) then
       DeleteFile(Filename);
     Ini := TIniFile.Create(Filename);
@@ -11096,6 +11118,7 @@
     Ini.WriteBool('StaticFilters','ModNotAvailable',Filters.ModNotAvailable);
     Ini.WriteBool('StaticFilters','Replays',Filters.Replays);
     Ini.WriteBool('StaticFilters','Players',Filters.Players.enabled);
+    Ini.WriteBool('StaticFilters','Players2',Filters.Players2.enabled);
     Ini.WriteBool('StaticFilters','MaxPlayers',Filters.MaxPlayers.enabled);
   
     if Filters.Players.filterType = Sup then
@@ -11106,6 +11129,14 @@
       Ini.WriteString('StaticFilters','PlayersSign','equal');
     Ini.WriteInteger('StaticFilters','PlayersValue',Filters.Players.value);
 
+    if Filters.Players2.filterType = Sup then
+      Ini.WriteString('StaticFilters','Players2Sign','sup')
+    else if Filters.Players2.filterType = Inf then
+      Ini.WriteString('StaticFilters','Players2Sign','inf')
+    else
+      Ini.WriteString('StaticFilters','Players2Sign','equal');
+    Ini.WriteInteger('StaticFilters','Players2Value',Filters.Players2.value);
+
     if Filters.MaxPlayers.filterType = Sup then
       Ini.WriteString('StaticFilters','MaxPlayersSign','sup')
     else if Filters.MaxPlayers.filterType = Inf then
@@ -11137,7 +11168,7 @@
   end;
 end;
 
-procedure TMainForm.LoadFiltersFromFile(path : string;var Filters: TPresetFilters);
+procedure TMainForm.LoadFiltersFromFile(var Filters: TPresetFilters);
 var
   Filename : String;
   Ini : TIniFile;
@@ -11145,7 +11176,7 @@
   tmpStr: String;
   f: ^TFilterText;
 begin
-  Filename := path; //VAR_FOLDER + '\' + 'filters.ini';
+  Filename := Filters.FileName; //VAR_FOLDER + '\' + 'filters.ini';
   Ini := TIniFile.Create(Filename);
   i := 0;
   Randomize;
@@ -11161,6 +11192,7 @@
   Filters.ModNotAvailable := Ini.ReadBool('StaticFilters', 'ModNotAvailable', True);
   Filters.Replays := Ini.ReadBool('StaticFilters', 'Replays', True);
   Filters.Players.enabled := Ini.ReadBool('StaticFilters', 'Players', False);
+  Filters.Players2.enabled := Ini.ReadBool('StaticFilters', 'Players2', False);
   Filters.MaxPlayers.enabled := Ini.ReadBool('StaticFilters', 'MaxPlayers', False);
 
   tmpStr := Ini.ReadString('StaticFilters', 'PlayersSign', 'sup');
@@ -11172,6 +11204,15 @@
     Filters.Players.filterType := Equal;
   Filters.Players.value := Ini.ReadInteger('StaticFilters', 'PlayersValue', 0);
 
+  tmpStr := Ini.ReadString('StaticFilters', 'Players2Sign', 'inf');
+  if tmpStr = 'sup' then
+    Filters.Players2.filterType := Sup
+  else if tmpStr = 'inf' then
+    Filters.Players2.filterType := Inf
+  else
+    Filters.Players2.filterType := Equal;
+  Filters.Players2.value := Ini.ReadInteger('StaticFilters', 'Players2Value', 0);
+
   tmpStr := Ini.ReadString('StaticFilters', 'MaxPlayersSign', 'sup');
   if tmpStr = 'sup' then
     Filters.MaxPlayers.filterType := Sup
@@ -11219,11 +11260,12 @@
   if FindFirst(FILTERS_FOLDER + '\*.ini', FileAttrs, sr) = 0 then
   begin
     repeat
-      if (sr.Name &lt;&gt; '.') and (sr.Name &lt;&gt; '..') and (sr.Name &lt;&gt; 'default.ini') then
+      if (sr.Name &lt;&gt; '.') and (sr.Name &lt;&gt; '..') and (sr.Name &lt;&gt; 'current.ini') then
       begin
         New(newPreset);
         newPreset.TextFilters := TList.Create;
-        LoadFiltersFromFile(FILTERS_FOLDER+'\'+sr.Name,newPreset^);
+        newPreset^.FileName := FILTERS_FOLDER+'\'+sr.Name;
+        LoadFiltersFromFile(newPreset^);
         PresetListbox.Items.Add(newPreset.Name);
         PresetList.Add(newPreset);
       end;
@@ -11236,9 +11278,49 @@
 begin
   PresetListbox.Selected[0] := true;
   RefreshBattleList;
-  SaveFiltersToFile(FILTERS_FOLDER + '\default.ini',CurrentFilters);
+  SaveFiltersToFile(CurrentFilters);
 end;
 
+procedure TMainForm.CopyFilters(srcFilters: TPresetFilters; var dstFilters: TPresetFilters);
+var
+  i: integer;
+  f: ^TFilterText;
+begin
+  dstFilters.Full := srcFilters.Full;
+  dstFilters.InProgress := srcFilters.InProgress;
+  dstFilters.Ladder := srcFilters.Ladder;
+  dstFilters.Locked := srcFilters.Locked;
+  dstFilters.Passworded := srcFilters.Passworded;
+  dstFilters.NatTraversal := srcFilters.NatTraversal;
+  dstFilters.MapNotAvailable := srcFilters.MapNotAvailable;
+  dstFilters.ModNotAvailable := srcFilters.ModNotAvailable;
+  dstFilters.Replays := srcFilters.Replays;
+  dstFilters.RankLimitSupEqMine := srcFilters.RankLimitSupEqMine;
+  dstFilters.Players.enabled := srcFilters.Players.enabled;
+  dstFilters.MaxPlayers.enabled := srcFilters.MaxPlayers.enabled;
+
+  dstFilters.Players.filterType := srcFilters.Players.filterType;
+  dstFilters.Players.value := srcFilters.Players.value;
+
+  dstFilters.MaxPlayers.filterType := srcFilters.MaxPlayers.filterType;
+  dstFilters.MaxPlayers.value := srcFilters.MaxPlayers.value;
+
+  dstFilters.TextFilters.Clear; // possible memory leak too lazy to fix
+  for i:=0 to srcFilters.TextFilters.Count -1 do
+  begin
+    New(f);
+    dstFilters.TextFilters.Add(f);
+    with TFilterText(dstFilters.TextFilters[i]^) do
+    begin
+      filterType := TFilterText(srcFilters.TextFilters[i]^).filterType;
+      contains := TFilterText(srcFilters.TextFilters[i]^).contains;
+      node := nil;
+      enabled := TFilterText(srcFilters.TextFilters[i]^).enabled;
+      value := TFilterText(srcFilters.TextFilters[i]^).value;
+    end;
+  end;
+end;
+
 procedure TMainForm.UpdateFilters(pFilters: TPresetFilters);
 var
   i: integer;
@@ -11264,6 +11346,13 @@
     PlayersSignButton.Caption := '=';
   PlayersValueTextBox.value := pFilters.Players.value;
 
+  if pFilters.Players2.filterType = Sup then
+    Players2SignButton.Caption := '&gt;'
+  else if pFilters.Players2.filterType = Inf then
+    Players2SignButton.Caption := '&lt;'
+  else
+    Players2SignButton.Caption := '=';
+  Players2ValueTextBox.value := pFilters.Players2.value;
 
   if pFilters.MaxPlayers.filterType = Sup then
     MaxPlayersSignButton.Caption := '&gt;'
@@ -12131,26 +12220,34 @@
 begin
   if PresetListbox.Items.IndexOf(PresetNameTextbox.Text) &gt;= 0 then
   begin
-    MessageDlg(_('That preset name already exists. Please choose another one.'),mtWarning,[mbOk],0);
-    Exit;
+    if MessageDlg(_('A preset with this name already exists, do you want to replace it ?'),mtWarning,[mbYes, mbNo],0) = mrNo then
+      Exit;
+
+    CopyFilters(CurrentFilters,PPresetFilters(PresetList[PresetListbox.ItemIndex-1])^);
+    SaveFiltersToFile(PPresetFilters(PresetList[PresetListbox.ItemIndex-1])^);
+
+    PresetListbox.ItemIndex := PresetListbox.Items.IndexOf(PresetNameTextbox.Text);
+    PresetListboxClick(nil);
+  end
+  else
+  begin
+    New(newPreset);
+    CopyFilters(CurrentFilters,newPreset^);
+    newPreset.Name := PresetNameTextbox.Text;
+    newPreset.FileName := FILTERS_FOLDER + '\'+PresetNameTextbox.Text+'.ini';
+
+    SaveFiltersToFile(newPreset^);
+    PresetListbox.Items.Add(PresetNameTextbox.Text);
+    PresetListbox.Selected[PresetListbox.Count-1] := true;
+
+    PresetList.Add(newPreset);
   end;
-  CurrentFilters.Name := PresetNameTextbox.Text;
-  SaveFiltersToFile(FILTERS_FOLDER + '\'+PresetNameTextbox.Text+'.ini',CurrentFilters);
-  PresetListbox.Items.Add(PresetNameTextbox.Text);
-  PresetListbox.Selected[PresetListbox.Count-1] := true;
-  New(newPreset);
-  newPreset.TextFilters := TList.Create;
-  LoadFiltersFromFile(FILTERS_FOLDER + '\'+PresetNameTextbox.Text+'.ini',newPreset^);
-  newPreset.Name := PresetNameTextbox.Text;
-  PresetList.Add(newPreset);
 end;
 
 procedure TMainForm.PresetListboxClick(Sender: TObject);
 begin
   if (PresetListbox.ItemIndex &lt; 1) then Exit;
-  CurrentFilters := PPresetFilters(PresetList[PresetListbox.ItemIndex-1])^;
-  UpdateFilters(CurrentFilters);
-  RefreshBattleList;
+  PresetNameTextbox.Text := PPresetFilters(PresetList[PresetListbox.ItemIndex-1])^.Name;
 end;
 
 procedure TMainForm.btDeletePresetClick(Sender: TObject);
@@ -12250,8 +12347,9 @@
   PresetList := TList.Create;
   FiltersTabs.ActiveTabIndex := 0;
   CurrentFilters.TextFilters := TList.Create;
+  CurrentFilters.FileName := FILTERS_FOLDER + '\current.ini';
   LoadPresets;
-  LoadFiltersFromFile(FILTERS_FOLDER + '\default.ini',CurrentFilters);
+  LoadFiltersFromFile(CurrentFilters);
   UpdateFilters(CurrentFilters);
   PresetListbox.Selected[0] := true;
   FilterGroup.Height := 0;
@@ -12474,7 +12572,8 @@
   BattleList: TList;
   SortStyle: byte;
   i,j,k: integer;
-  curPreset : PPresetFilters;
+  curPreset : TPresetFilters;
+  presetFound: boolean;
 begin
   Result := nil;
   if autoJoinPresetList.Count = 0 then
@@ -12482,23 +12581,29 @@
 
   BattleList := TList.Create;
   BattleList.Assign(Battles);
+  curPreset.TextFilters := TList.Create;
 
   for i:=0 to autoJoinPresetList.Count-1 do
   begin
-    curPreset := nil;
-    if LowerCase(PAutoJoinPresetItemList(autoJoinPresetList[i]).PresetName) = 'default' then
-      curPreset := @CurrentFilters
+    presetFound := False;
+    if LowerCase(PAutoJoinPresetItemList(autoJoinPresetList[i]).PresetName) = _('current') then
+    begin
+      CopyFilters(CurrentFilters,curPreset);
+      presetFound := True;
+    end
     else
-    for j:=0 to PresetList.Count-1 do
-    begin
-      if LowerCase(PPresetFilters(PresetList[j]).Name) = LowerCase(PAutoJoinPresetItemList(autoJoinPresetList[i]).PresetName) then
+      for j:=0 to PresetList.Count-1 do
       begin
-        curPreset := PPresetFilters(PresetList[j]);
-        break;
+        if LowerCase(PPresetFilters(PresetList[j]).Name) = LowerCase(PAutoJoinPresetItemList(autoJoinPresetList[i]).PresetName) then
+        begin
+          CopyFilters(PPresetFilters(PresetList[j])^,curPreset);
+          presetFound := True;
+          break;
+        end;
       end;
-    end;
-    if curPreset &lt;&gt; nil then
+    if presetFound then
     begin
+      curPreset.Locked := True;
       case PAutoJoinPresetItemList(autoJoinPresetList[i]).Sorting of
         0: SortStyle := 5; // host
         1: SortStyle := 4; // map
@@ -12509,13 +12614,15 @@
       end;
       SortBattlesList(BattleList,SortStyle,PAutoJoinPresetItemList(autoJoinPresetList[i]).SortingDirection=0);
       for k:=0 to BattleList.Count-1 do
-        if isBattleVisible(TBattle(BattleList[k]),curPreset^) then
+        if isBattleVisible(TBattle(BattleList[k]),curPreset) then
         begin
           Result := TBattle(BattleList[k]);
+          curPreset.TextFilters.Clear;
           Exit;
         end;
     end;
   end;
+  curPreset.TextFilters.Clear;
 end;
 
 procedure TMainForm.mnuPlaynowClick(Sender: TObject);
@@ -12548,27 +12655,25 @@
 var
   Battle:TBattle;
 begin
-
-  if mnuAutoplayFirstAvailable.Checked and not BattleForm.IsBattleActive then
+  AutojoinTimer.Interval := 1000;
+  if (mnuAutoplayFirstAvailable.Checked or mnuAutospecFirstAvailable.Checked) and not BattleForm.AmIReady and not InitWaitForm.Visible and (not Status.Me.GetInGameStatus or (Status.Me.GetInGameStatus and not BattleForm.IsBattleActive)) then
   begin
-    Battle := getAutojoinBestBattle(AutoJoinForm.autoPlayPresetList);
-    if Battle = nil then
+    if mnuAutoplayFirstAvailable.Checked then
+      Battle := getAutojoinBestBattle(AutoJoinForm.autoPlayPresetList)
+    else
+      Battle := getAutojoinBestBattle(AutoJoinForm.autoSpecPresetList);
+    if (Battle = nil) or Battle.Locked or Battle.Password or ((BattleState.Status &lt;&gt; None) and (Battle = BattleState.Battle)) then
     begin
       Exit;
     end;
-    JoinBattle(Battle);
-    mnuAutoplayFirstAvailable.Checked := False;
-    Exit;
-  end;
-  if mnuAutospecFirstAvailable.Checked and not BattleForm.IsBattleActive then
-  begin
-    Battle := getAutojoinBestBattle(AutoJoinForm.autoSpecPresetList);
-    if Battle = nil then
+    AutojoinTimer.Interval := 8000;
+    BattleForm.DisconnectButtonClick(nil);
+    JoinBattle(Battle,mnuAutospecFirstAvailable.Checked);
+    if not AutoJoinForm.chkKeepLookingAfterJoining.Checked then
     begin
-      Exit;
+      mnuAutoplayFirstAvailable.Checked := False;
+      mnuAutospecFirstAvailable.Checked := False;
     end;
-    JoinBattle(Battle,True);
-    mnuAutospecFirstAvailable.Checked := False;
     Exit;
   end;
 end;
@@ -13114,4 +13219,47 @@
   PreferencesForm.GameSettingsButtonClick(nil);
 end;
 
+procedure TMainForm.PresetListboxDblClick(Sender: TObject);
+begin
+  if (PresetListbox.ItemIndex &lt; 1) then Exit;
+  CopyFilters(PPresetFilters(PresetList[PresetListbox.ItemIndex-1])^, CurrentFilters);
+  PresetNameTextbox.Text := PPresetFilters(PresetList[PresetListbox.ItemIndex-1])^.Name;
+  UpdateFilters(CurrentFilters);
+  RefreshBattleList;
+end;
+
+procedure TMainForm.Players2FilterClick(Sender: TObject);
+begin
+  if not Players2Filter.Focused then Exit;
+  CurrentFilters.Players2.enabled := Players2Filter.Checked;
+  FiltersUpdated;
+end;
+
+procedure TMainForm.Players2SignButtonClick(Sender: TObject);
+begin
+  if Players2SignButton.Caption = '&gt;' then
+  begin
+    Players2SignButton.Caption := '&lt;';
+    CurrentFilters.Players2.filterType := Inf;
+  end
+  else if Players2SignButton.Caption = '&lt;' then
+  begin
+    Players2SignButton.Caption := '=';
+    CurrentFilters.Players2.filterType := Equal;
+  end
+  else
+  begin
+    Players2SignButton.Caption := '&gt;';
+    CurrentFilters.Players2.filterType := Sup;
+  end;
+  FiltersUpdated;
+end;
+
+procedure TMainForm.Players2ValueTextBoxChange(Sender: TObject);
+begin
+  if not Players2ValueTextBox.Focused then Exit;
+  CurrentFilters.Players2.value := Players2ValueTextBox.AsInteger;
+  FiltersUpdated;
+end;
+
 end.

Modified: Lobby/TASClient/PreferencesFormUnit.pas
===================================================================
--- Lobby/TASClient/PreferencesFormUnit.pas	2010-02-28 17:22:03 UTC (rev 7422)
+++ Lobby/TASClient/PreferencesFormUnit.pas	2010-03-03 23:32:51 UTC (rev 7423)
@@ -348,7 +348,7 @@
   ManageGroups, ReplaysUnit, PythonScriptDebugFormUnit, LobbyScriptUnit,
   SpringDownloaderFormUnit, LogonFormUnit, TipsFormUnit,
   TemplateEditorFormUnit, SpringSettingsProfileFormUnit, gnugettext,
-  AutoTeamsUnit, ChannelsListFormUnit;
+  AutoTeamsUnit, ChannelsListFormUnit, AutoJoinFormUnit;
 
 {$R *.dfm}
 
@@ -551,6 +551,8 @@
     try TemplateEditorForm.LayoutPropertyChange.Lines.Text := Misc.GetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\TemplateEditor', 'LayoutProperty2'); except end;
     try TemplateEditorForm.RecordPropertyChange.Lines.Text := Misc.GetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\TemplateEditor', 'RecordProperty2'); except end;
 
+    try AutoJoinForm.chkKeepLookingAfterJoining.Checked := Misc.GetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\AutoJoinForm', 'KeepLookingAfterJoining'); except end;
+
     try ChannelsListForm.VDTChannels.Header.SortColumn := Misc.GetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\ChannelsList', 'ChannelsSortColumn'); except end;
     try
       if Misc.GetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\ChannelsList', 'ChannelsSortDirection') = 0 then
@@ -661,6 +663,8 @@
     Misc.SetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\ReplaysForm', 'FiltersEnabled', rdInteger, ReplaysForm.chkEnableFilters.Checked);
     Misc.SetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\ReplaysForm', 'Spliter1', rdInteger, ReplaysForm.BottomPanel.Height);
 
+        Misc.SetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\AutoJoinForm', 'KeepLookingAfterJoining', rdInteger, AutoJoinForm.chkKeepLookingAfterJoining.Checked);
+
     Misc.SetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\TipsForm', 'ShowTips', rdInteger, Misc.BoolToInt(TipsForm.chkShowTips.Checked));
 
     Misc.SetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\ChannelsList', 'ChannelsSortColumn', rdInteger, ChannelsListForm.VDTChannels.Header.SortColumn);

Modified: Lobby/TASClient/ProgressBarWindow.dfm
===================================================================
--- Lobby/TASClient/ProgressBarWindow.dfm	2010-02-28 17:22:03 UTC (rev 7422)
+++ Lobby/TASClient/ProgressBarWindow.dfm	2010-03-03 23:32:51 UTC (rev 7423)
@@ -7,8 +7,8 @@
   VertScrollBar.Visible = False
   Caption = 'ProgressBarForm'
   Color = clBtnFace
-  Constraints.MaxHeight = 1000
-  Constraints.MaxWidth = 1680
+  Constraints.MaxHeight = 1150
+  Constraints.MaxWidth = 1920
   Font.Charset = DEFAULT_CHARSET
   Font.Color = clWindowText
   Font.Height = -11
@@ -43,6 +43,7 @@
       Font.Name = 'MS Sans Serif'
       Font.Style = [fsBold]
       ParentFont = False
+      CaptionGlow = gldBottomRight
       CaptionGlowColor = clBlack
       Smooth = True
       ThemeType = thtTBX

Modified: Lobby/TASClient/Python/api.txt
===================================================================
--- Lobby/TASClient/Python/api.txt	2010-02-28 17:22:03 UTC (rev 7422)
+++ Lobby/TASClient/Python/api.txt	2010-03-03 23:32:51 UTC (rev 7423)
@@ -69,12 +69,14 @@
 - LeaveBattle
 - StartBattle
 - ChangeMap(mapName)
-- DownloadMap(mapName,mapHash,callBackArgs,callBackModuleName,callBackFunctionName) return Cancel : boolean
+- DownloadMap(mapName,mapHash,callBackArgs,callBackModuleName,callBackFunctionName)
 	The progress in % is returned as first argument added to the argsTuple.
 	Progress = -1 : download complete
 	Progress = -2 : download failed (file not found, SD not launched etc)
 	Progress = -3 : download canceled
-- DownloadMod(modName,modHash,callBackArgs,callBackModuleName,callBackFunctionName) return Cancel : boolean
+	
+	callBackFunctionName return Cancel : boolean
+- DownloadMod(modName,modHash,callBackArgs,callBackModuleName,callBackFunctionName)
 	Same as DownloadMap
 
 GUI Class

Modified: Lobby/TASClient/Python/scripts/mapdownload.py
===================================================================
--- Lobby/TASClient/Python/scripts/mapdownload.py	2010-02-28 17:22:03 UTC (rev 7422)
+++ Lobby/TASClient/Python/scripts/mapdownload.py	2010-03-03 23:32:51 UTC (rev 7423)
@@ -9,6 +9,8 @@
 acceptNextDownload = False
 startDownload = False
 dlFormName = ''
+cancelMapDl = False
+dlFailed = False
 
 def changeComponentProp(comp,prop,value):
 	changeComponentPropFull(comp,'',prop,value)
@@ -18,23 +20,39 @@
 	p[prop] = value
 	return gui.SetControlProperties(comp,path,p)
 	
+def out_JOINBATTLE(args):
+	global cancelMapDl
+	global dlFailed
+	if dlFailed:
+		gui.ExecMethod(dlFormName,'CancelButtonClick',())
+	else:
+		cancelMapDl = True
+	
 def onDownloadProgress(progress):
 	global dlFormName
+	global cancelMapDl
+	global dlFailed
 	if progress == -2:
 		p = gui.GetControlProperties(dlFormName+'.lblInfo','')
 		changeComponentProp(dlFormName+'.lblProgress','Caption',p['Caption'])
 		p = gui.GetControlProperties(dlFormName+'.lblInfo','Font')
 		changeComponentPropFull(dlFormName+'.lblProgress','Font','Color',p['Color'])
+		dlFailed = True
 	if progress == -1 or progress == -3:
 		for control in oldParent:
 			changeComponentProp(control,'Parent',oldParent[control])
 		changeComponentProp('BattleForm.MapDescLabel','Visible','True')
 		dlFormName = ''
+	return cancelMapDl
 		
 def all_in(args):
 	global startDownload
+	global cancelMapDl
+	global dlFailed
 	if startDownload and joiningBattleId &gt; -1:
 		battles = api.GetBattles()
+		cancelMapDl = False
+		dlFailed = False
 		api.DownloadMap(battles[joiningBattleId]['Map'],battles[joiningBattleId]['MapHash'],(),'mapdownload','onDownloadProgress')
 		startDownload = False
 		

Modified: Lobby/TASClient/ReplaysUnit.dfm
===================================================================
--- Lobby/TASClient/ReplaysUnit.dfm	2010-02-28 17:22:03 UTC (rev 7422)
+++ Lobby/TASClient/ReplaysUnit.dfm	2010-03-03 23:32:51 UTC (rev 7423)
@@ -5,8 +5,8 @@
   Height = 599
   Caption = 'Replays'
   Color = clBtnFace
-  Constraints.MaxHeight = 1000
-  Constraints.MaxWidth = 1680
+  Constraints.MaxHeight = 1150
+  Constraints.MaxWidth = 1920
   Constraints.MinHeight = 100
   Constraints.MinWidth = 100
   Font.Charset = DEFAULT_CHARSET
@@ -692,117 +692,15 @@
         Height = 225
         Align = alTop
         Color = clBtnFace
-        ActiveTabIndex = 0
+        ActiveTabIndex = 1
         HiddenItems = &lt;&gt;
         object FiltersTab: TSpTBXTabItem
           Caption = 'Filters'
-          Checked = True
         end
         object PresetsTab: TSpTBXTabItem
           Caption = 'Presets'
+          Checked = True
         end
-        object SpTBXTabSheet6: TSpTBXTabSheet
-          Left = 0
-          Top = 23
-          Width = 774
-          Height = 202
-          Caption = 'Presets'
-          ImageIndex = -1
-          Item = PresetsTab
-          TabControl = FiltersTabs
-          DesignSize = (
-            774
-            202)
-          TabItem = 'PresetsTab'
-          object SpTBXGroupBox2: TSpTBXGroupBox
-            Left = 8
-            Top = 8
-            Width = 137
-            Height = 185
-            Caption = 'Options'
-            TabOrder = 0
-            object btDeletePreset: TSpTBXButton
-              Left = 8
-              Top = 72
-              Width = 121
-              Height = 25
-              Caption = 'Delete'
-              TabOrder = 1
-              OnClick = btDeletePresetClick
-              LinkFont.Charset = DEFAULT_CHARSET
-              LinkFont.Color = clBlue
-              LinkFont.Height = -11
-              LinkFont.Name = 'MS Sans Serif'
-              LinkFont.Style = [fsUnderline]
-            end
-            object btSavePreset: TSpTBXButton
-              Left = 8
-              Top = 40
-              Width = 121
-              Height = 25
-              Caption = 'Save'
-              TabOrder = 2
-              OnClick = btSavePresetClick
-              LinkFont.Charset = DEFAULT_CHARSET
-              LinkFont.Color = clBlue
-              LinkFont.Height = -11
-              LinkFont.Name = 'MS Sans Serif'
-              LinkFont.Style = [fsUnderline]
-            end
-            object PresetNameTextbox: TSpTBXEdit
-              Left = 8
-              Top = 18
-              Width = 121
-              Height = 21
-              TabOrder = 3
-              Text = 'Preset name'
-            end
-            object btClearPreset: TSpTBXButton
-              Left = 8
-              Top = 96
-              Width = 121
-              Height = 25
-              Caption = 'Clear'
-              TabOrder = 0
-              OnClick = btClearPresetClick
-              LinkFont.Charset = DEFAULT_CHARSET
-              LinkFont.Color = clBlue
-              LinkFont.Height = -11
-              LinkFont.Name = 'MS Sans Serif'
-              LinkFont.Style = [fsUnderline]
-            end
-          end
-          object SpTBXLabel5: TSpTBXLabel
-            Left = 152
-            Top = 8
-            Width = 64
-            Height = 16
-            Caption = 'Preset list :'
-            Font.Charset = DEFAULT_CHARSET
-            Font.Color = clWindowText
-            Font.Height = -13
-            Font.Name = 'MS Sans Serif'
-            Font.Style = []
-            ParentFont = False
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
-          object PresetListbox: TSpTBXListBox
-            Left = 152
-            Top = 26
-            Width = 614
-            Height = 167
-            Anchors = [akLeft, akTop, akRight]
-            ItemHeight = 16
-            Items.Strings = (
-              'default')
-            TabOrder = 2
-            OnClick = PresetListboxClick
-          end
-        end
         object SpTBXTabSheet5: TSpTBXTabSheet
           Left = 0
           Top = 23
@@ -1363,6 +1261,109 @@
               end&gt;
           end
         end
+        object SpTBXTabSheet6: TSpTBXTabSheet
+          Left = 0
+          Top = 23
+          Width = 774
+          Height = 202
+          Caption = 'Presets'
+          ImageIndex = -1
+          Item = PresetsTab
+          TabControl = FiltersTabs
+          DesignSize = (
+            774
+            202)
+          TabItem = 'PresetsTab'
+          object SpTBXGroupBox2: TSpTBXGroupBox
+            Left = 8
+            Top = 8
+            Width = 137
+            Height = 185
+            Caption = 'Options'
+            TabOrder = 0
+            object btDeletePreset: TSpTBXButton
+              Left = 8
+              Top = 72
+              Width = 121
+              Height = 25
+              Caption = 'Delete'
+              TabOrder = 1
+              OnClick = btDeletePresetClick
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object btSavePreset: TSpTBXButton
+              Left = 8
+              Top = 40
+              Width = 121
+              Height = 25
+              Caption = 'Save'
+              TabOrder = 2
+              OnClick = btSavePresetClick
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object PresetNameTextbox: TSpTBXEdit
+              Left = 8
+              Top = 18
+              Width = 121
+              Height = 21
+              TabOrder = 3
+              Text = 'Preset name'
+            end
+            object btClearPreset: TSpTBXButton
+              Left = 8
+              Top = 96
+              Width = 121
+              Height = 25
+              Caption = 'Clear'
+              TabOrder = 0
+              OnClick = btClearPresetClick
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+          end
+          object SpTBXLabel5: TSpTBXLabel
+            Left = 152
+            Top = 8
+            Width = 64
+            Height = 16
+            Caption = 'Preset list :'
+            Font.Charset = DEFAULT_CHARSET
+            Font.Color = clWindowText
+            Font.Height = -13
+            Font.Name = 'MS Sans Serif'
+            Font.Style = []
+            ParentFont = False
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
+          end
+          object PresetListbox: TSpTBXListBox
+            Left = 152
+            Top = 26
+            Width = 614
+            Height = 167
+            Anchors = [akLeft, akTop, akRight]
+            ItemHeight = 16
+            Items.Strings = (
+              'current')
+            TabOrder = 2
+            OnClick = PresetListboxClick
+            OnDblClick = PresetListboxDblClick
+          end
+        end
       end
       object chkEnableFilters: TSpTBXCheckBox
         Left = 661

Modified: Lobby/TASClient/ReplaysUnit.pas
===================================================================
--- Lobby/TASClient/ReplaysUnit.pas	2010-02-28 17:22:03 UTC (rev 7422)
+++ Lobby/TASClient/ReplaysUnit.pas	2010-03-03 23:32:51 UTC (rev 7423)
@@ -248,6 +248,7 @@
     procedure btSavePresetClick(Sender: TObject);
     procedure btDeletePresetClick(Sender: TObject);
     procedure btClearPresetClick(Sender: TObject);
+    procedure PresetListboxDblClick(Sender: TObject);
     procedure PresetListboxClick(Sender: TObject);
   private
     { Private declarations }
@@ -2908,12 +2909,17 @@
 begin
   if PresetListbox.Items.IndexOf(PresetNameTextbox.Text) &gt;= 0 then
   begin
-    MessageDlg(_('That preset name already exists. Please choose another name.'),mtWarning,[mbOk],0);
-    Exit;
+    if MessageDlg(_('A preset with this name already exists, do you want to replace it ?'),mtWarning,[mbYes, mbNo],0) = mrNo then
+      Exit;
+    PresetListbox.ItemIndex := PresetListbox.Items.IndexOf(PresetNameTextbox.Text);
+  end
+  else
+  begin
+    PresetListbox.Items.Add(PresetNameTextbox.Text);
+    PresetListbox.ItemIndex := PresetListbox.Count-1;
   end;
+
   SaveReplayFiltersToFile(REPLAY_FILTERS_FOLDER + '\'+PresetNameTextbox.Text+'.ini');
-  PresetListbox.Items.Add(PresetNameTextbox.Text);
-  PresetListbox.Selected[PresetListbox.Count-1] := true;
 end;
 
 procedure TReplaysForm.btDeletePresetClick(Sender: TObject);
@@ -2936,14 +2942,6 @@
   PresetListbox.Selected[0] := true;
 end;
 
-procedure TReplaysForm.PresetListboxClick(Sender: TObject);
-begin
-  if (PresetListbox.ItemIndex = 0) and not FileExists(REPLAY_FILTERS_FOLDER + '\' + PresetListbox.Items[PresetListbox.ItemIndex] + '.ini') then Exit;
-  LoadReplayFiltersFromFile(REPLAY_FILTERS_FOLDER + '\' + PresetListbox.Items[PresetListbox.ItemIndex] + '.ini');
-  UpdateReplayFilters;
-  FilterReplayList;
-end;
-
 procedure TReplaysForm.LoadReplayFiltersPresets;
 var
   FileAttrs: Integer;
@@ -2953,7 +2951,7 @@
   if FindFirst(REPLAY_FILTERS_FOLDER + '\*.ini', FileAttrs, sr) = 0 then
   begin
     repeat
-      if (sr.Name &lt;&gt; '.') and (sr.Name &lt;&gt; '..') and (sr.Name &lt;&gt; 'default.ini') then
+      if (sr.Name &lt;&gt; '.') and (sr.Name &lt;&gt; '..') and (sr.Name &lt;&gt; 'current.ini') then
       begin
         PresetListbox.Items.Add(LeftStr(''+sr.Name,Length(''+sr.Name)-4));
       end;
@@ -2966,7 +2964,7 @@
 begin
   FiltersTabs.ActiveTabIndex := 0;
   Filters.TextFilters := TList.Create;
-  LoadReplayFiltersFromFile(REPLAY_FILTERS_FOLDER + '\default.ini');
+  LoadReplayFiltersFromFile(REPLAY_FILTERS_FOLDER + '\current.ini');
   UpdateReplayFilters;
   PresetListbox.Selected[0] := true;
   LoadReplayFiltersPresets;
@@ -2978,4 +2976,18 @@
   FilterReplayList;
 end;
 
+procedure TReplaysForm.PresetListboxDblClick(Sender: TObject);
+begin
+  if (PresetListbox.ItemIndex = 0) and not FileExists(REPLAY_FILTERS_FOLDER + '\' + PresetListbox.Items[PresetListbox.ItemIndex] + '.ini') then Exit;
+  LoadReplayFiltersFromFile(REPLAY_FILTERS_FOLDER + '\' + PresetListbox.Items[PresetListbox.ItemIndex] + '.ini');
+  UpdateReplayFilters;
+  FilterReplayList;
+end;
+
+procedure TReplaysForm.PresetListboxClick(Sender: TObject);
+begin
+  if (PresetListbox.ItemIndex = 0) then Exit;
+  PresetNameTextbox.Text := PresetListbox.Items[PresetListbox.ItemIndex];
+end;
+
 end.

Modified: Lobby/TASClient/TASClient.dof
===================================================================
--- Lobby/TASClient/TASClient.dof	2010-02-28 17:22:03 UTC (rev 7422)
+++ Lobby/TASClient/TASClient.dof	2010-03-03 23:32:51 UTC (rev 7423)
@@ -113,9 +113,9 @@
 IncludeVerInfo=1
 AutoIncBuild=1
 MajorVer=0
-MinorVer=66
+MinorVer=67
 Release=0
-Build=809
+Build=810
 Debug=0
 PreRelease=0
 Special=0
@@ -126,7 +126,7 @@
 [Version Info Keys]
 CompanyName=
 FileDescription=Spring RTS Engine lobby client
-FileVersion=0.66.0.809
+FileVersion=0.67.0.810
 InternalName=
 LegalCopyright=
 LegalTrademarks=

Modified: Lobby/TASClient/TASClient.res
===================================================================
(Binary files differ)

Modified: Lobby/TASClient/UploadReplayUnit.dfm
===================================================================
--- Lobby/TASClient/UploadReplayUnit.dfm	2010-02-28 17:22:03 UTC (rev 7422)
+++ Lobby/TASClient/UploadReplayUnit.dfm	2010-03-03 23:32:51 UTC (rev 7423)
@@ -6,15 +6,15 @@
   ClientHeight = 345
   ClientWidth = 407
   Color = clBtnFace
-  Constraints.MaxHeight = 1000
-  Constraints.MaxWidth = 1680
+  Constraints.MaxHeight = 1150
+  Constraints.MaxWidth = 1920
   Font.Charset = DEFAULT_CHARSET
   Font.Color = clWindowText
   Font.Height = -11
   Font.Name = 'MS Sans Serif'
   Font.Style = []
   OldCreateOrder = False
-  Position = poScreenCenter
+  Position = poMainFormCenter
   Scaled = False
   OnActivate = FormActivate
   OnCreate = FormCreate


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message: <A HREF="002194.html">[Taspring-linux-commit] r7424 - in Lobby/TASClient: . Python/scripts
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2193">[ date ]</a>
              <a href="thread.html#2193">[ thread ]</a>
              <a href="subject.html#2193">[ subject ]</a>
              <a href="author.html#2193">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
