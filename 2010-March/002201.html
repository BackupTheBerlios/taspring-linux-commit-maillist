<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r7431 - in Lobby/TASClient: . Interface	Python
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2010-March/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r7431%20-%20in%20Lobby/TASClient%3A%20.%20Interface%0A%09Python&In-Reply-To=%3C20100317143630.0566E23D2D%40it-l.eu%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002200.html">
   <LINK REL="Next"  HREF="002202.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r7431 - in Lobby/TASClient: . Interface	Python</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r7431%20-%20in%20Lobby/TASClient%3A%20.%20Interface%0A%09Python&In-Reply-To=%3C20100317143630.0566E23D2D%40it-l.eu%3E"
       TITLE="[Taspring-linux-commit] r7431 - in Lobby/TASClient: . Interface	Python">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Wed Mar 17 15:36:29 CET 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="002200.html">[Taspring-linux-commit] r7430 - Lobby/TASClient
</A></li>
        <LI>Next message: <A HREF="002202.html">[Taspring-linux-commit] r7432 - Lobby/TASClient
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2201">[ date ]</a>
              <a href="thread.html#2201">[ thread ]</a>
              <a href="subject.html#2201">[ subject ]</a>
              <a href="author.html#2201">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: satirik
Date: 2010-03-17 15:36:29 +0100 (Wed, 17 Mar 2010)
New Revision: 7431

Modified:
   Lobby/TASClient/AutoTeamsUnit.pas
   Lobby/TASClient/BattleFormUnit.dfm
   Lobby/TASClient/BattleFormUnit.pas
   Lobby/TASClient/ColorsPreferenceUnit.dfm
   Lobby/TASClient/Interface/default.js
   Lobby/TASClient/Interface/modsettings.html
   Lobby/TASClient/Interface/settings.html
   Lobby/TASClient/Interface/skirmish.html
   Lobby/TASClient/LobbyScriptUnit.pas
   Lobby/TASClient/MainUnit.dfm
   Lobby/TASClient/MainUnit.pas
   Lobby/TASClient/ManageGroups.dfm
   Lobby/TASClient/ManageGroups.pas
   Lobby/TASClient/MapListFormUnit.dfm
   Lobby/TASClient/MapListFormUnit.pas
   Lobby/TASClient/MenuFormUnit.pas
   Lobby/TASClient/Minimap3DPreviewUnit.pas
   Lobby/TASClient/PreferencesFormUnit.pas
   Lobby/TASClient/Python/api.txt
   Lobby/TASClient/TASClient.dof
   Lobby/TASClient/TASClient.dpr
   Lobby/TASClient/TASClient.res
   Lobby/TASClient/Utility.pas
Log:
* you can now rename players (filtering and autocompletion work with both, real and custom names)
* PYTHON : new callout SetUserDisplayName(userId, displayName)
* groups : you can now enable or disable the group color, when disabled, the users of the group will be sorted as players without group when sorting by group
* &quot;choose now&quot; start pos in Single Player not working on maps bottom bug fixed
* you can now choose a player name in Single Player
* filter battles by players added
* Ctrl+RightClickDrag to change the 3d map preview Z scale
* map sorting by max metal added

Modified: Lobby/TASClient/AutoTeamsUnit.pas
===================================================================
--- Lobby/TASClient/AutoTeamsUnit.pas	2010-03-15 17:30:30 UTC (rev 7430)
+++ Lobby/TASClient/AutoTeamsUnit.pas	2010-03-17 14:36:29 UTC (rev 7431)
@@ -99,14 +99,14 @@
     if group &lt;&gt; nil then
       if group.BalanceInSameTeam then
       begin
-        Result := group.Name + '64qss87';
+        Result := group.Name + '64q4ss87$';
         Exit;
       end;
 
     s1 := TStringList.Create;
     s2 := TStringList.Create;
     Result := '';
-    Misc.ParseDelimited(s1,Client.Name,'[','');
+    Misc.ParseDelimited(s1,Client.DisplayName,'[','');
     if s1.Count &gt; 1 then
     begin
       i:=1;
@@ -495,7 +495,7 @@
       for k := 0 to TList(TList(Groups[i])[j]).Count-1 do
       begin
         Inc(tmpY, YSpacing);
-        tmpLabel := AddLabel(tmpX, tmpY, TClient(TList(TList(Groups[i])[j])[k]).Name);
+        tmpLabel := AddLabel(tmpX, tmpY, TClient(TList(TList(Groups[i])[j])[k]).DisplayName);
         tmpLabel.Images := MainForm.RanksImageList;
         tmpLabel.ImageIndex := TClient(TList(TList(Groups[i])[j])[k]).GetRank;
         tmpLabel.Spacing := 1;

Modified: Lobby/TASClient/BattleFormUnit.dfm
===================================================================
--- Lobby/TASClient/BattleFormUnit.dfm	2010-03-15 17:30:30 UTC (rev 7430)
+++ Lobby/TASClient/BattleFormUnit.dfm	2010-03-17 14:36:29 UTC (rev 7431)
@@ -1,6 +1,6 @@
 object BattleForm: TBattleForm
-  Left = 851
-  Top = 98
+  Left = 905
+  Top = 665
   Width = 920
   Height = 612
   Caption = 'Battle window'
@@ -13558,7 +13558,7 @@
   end
   object PlayerControlPopupMenu: TSpTBXPopupMenu
     AutoHotkeys = maManual
-    OnInitPopup = PlayerControlPopupMenuInitPopup
+    OnPopup = PlayerControlPopupMenuPopup
     Left = 304
     Top = 352
     object ForceTeamSpin: TTBXSpinEditItem

Modified: Lobby/TASClient/BattleFormUnit.pas
===================================================================
--- Lobby/TASClient/BattleFormUnit.pas	2010-03-15 17:30:30 UTC (rev 7430)
+++ Lobby/TASClient/BattleFormUnit.pas	2010-03-17 14:36:29 UTC (rev 7431)
@@ -582,8 +582,6 @@
     procedure MapPanelMouseMove(Sender: TObject; Shift: TShiftState; X,
       Y: Integer);
     procedure BanPlayerItemClick(Sender: TObject);
-    procedure PlayerControlPopupMenuInitPopup(Sender: TObject;
-      PopupView: TTBView);
     //procedure AdjustFont(Item: TTBCustomItem;
     //  Viewer: TTBItemViewer; Font: TFont; StateFlags: Integer);
     procedure mnuLimitRankAutoKickClick(Sender: TObject);
@@ -750,6 +748,7 @@
     procedure AutoHostInfoBottomPanelResize(Sender: TObject);
     procedure sspOptionsClick(Sender: TObject);
     procedure AutohostControlSplitterMoved(Sender: TObject);
+    procedure PlayerControlPopupMenuPopup(Sender: TObject);
   private
     History: TWideStringList;
     HistoryIndex: Integer;
@@ -4504,9 +4503,9 @@
 begin
   case SortStyle of
     0:
-      if AnsiCompareText(Client1.Name,Client2.Name) = 0  then
+      if AnsiCompareText(Client1.DisplayName,Client2.DisplayName) = 0  then
         Result := 0
-      else if AnsiCompareText(Client1.Name,Client2.Name) &lt; 0 then
+      else if AnsiCompareText(Client1.DisplayName,Client2.DisplayName) &lt; 0 then
         Result := -1
       else
         Result := 1;
@@ -4879,7 +4878,7 @@
           end;
 
           // username:
-          s := TClient(BattleState.Battle.Clients[RealIndex]).Name;
+          s := TClient(BattleState.Battle.Clients[RealIndex]).DisplayName;
           Canvas.TextOut(R.Left + Pos, R.Top, s);
 
           Inc(Pos,Canvas.TextWidth(s)+5);
@@ -5253,7 +5252,7 @@
 
     BanPlayerItem.Enabled := WhatToDraw = NormalClient;
     RingItem.Enabled := WhatToDraw = NormalClient;
-    PlayerControlPopupMenuInitPopup(nil,nil);
+    PlayerControlPopupMenuPopup(nil);
     PlayerControlPopupMenu.Popup(p.X, p.Y);
 
     if VDTBattleClients.FocusedNode &lt;&gt; nil then
@@ -5882,68 +5881,6 @@
   end;
 end;
 
-procedure TBattleForm.PlayerControlPopupMenuInitPopup(Sender: TObject;
-  PopupView: TTBView);
-var
-  i:integer;
-  ClientGroup: TClientGroup;
-  RealIndex: integer;
-  WhatToDraw: TClientNodeType;
-  Client: TClient;
-begin
-  GetNodeClient(VDTBattleClients.FocusedNode.Index,RealIndex,WhatToDraw);
-
-  ForceTeamSpin.Visible := ((WhatToDraw &lt;&gt; OriginalClient) and (BattleState.Status = Hosting) ) or ((WhatToDraw = NormalBot) and ((BattleState.Status = Hosting) or (TBot(BattleState.Battle.Bots[RealIndex]).OwnerName = Status.Username)));
-  ForceAllySpin.Visible := ForceTeamSpin.Visible;
-  SetTeamColorItem.Visible := ForceTeamSpin.Visible;
-  HandicapSpinEditItem.Visible := ForceTeamSpin.Visible;
-  KickPlayerItem.Visible := ForceTeamSpin.Visible;
-  SetBotSideSubitem.Visible := (ForceTeamSpin.Visible) and (WhatToDraw = NormalBot);
-  ForceSpectatorModeItem.Visible := ForceTeamSpin.Visible;
-  RingItem.Visible := (WhatToDraw = NormalClient) and ((BattleState.Status = Hosting) or (RealIndex=0));
-
-  BanPlayerItem.Visible := BattleState.Status = Hosting;
-  UnbanSubitem.Visible := BanPlayerItem.Visible;
-  if UnbanSubitem.Visible then
-  begin
-    UnbanSubitem.Clear;
-    for i:=0 to BattleState.BanList.count-1 do begin
-      UnbanSubitem.Add(TSpTBXItem.Create(UnbanSubitem));
-      with UnbanSubitem.Items[UnbanSubitem.Count-1] as TSpTBXItem do
-      begin
-        Caption := MainForm.GetClientById(BattleState.BanList.Items[i]).Name;
-        Tag := i;
-        OnClick := UnbanItemClick;
-      end;
-    end;
-    UnbanSubitem.Enabled := UnbanSubitem.Count &gt; 0;
-  end;
-
-  if WhatToDraw = NormalClient then
-  begin
-    ForceAllySpin.Value := TClient(BattleState.Battle.Clients[RealIndex]).GetAllyNo+1;
-    ForceTeamSpin.Value := TClient(BattleState.Battle.Clients[RealIndex]).GetTeamNo+1;
-  end
-  else
-  begin
-    ForceAllySpin.Value := TBot(BattleState.Battle.Bots[RealIndex]).GetAllyNo+1;
-    ForceTeamSpin.Value := TBot(BattleState.Battle.Bots[RealIndex]).GetTeamNo+1;
-  end;
-
-  if WhatToDraw = NormalClient then
-  begin
-    PlayerSubmenu.Caption := TClient(BattleState.Battle.Clients[RealIndex]).Name;
-    MainUnit.ContextMenuSelectedClient := TClient(BattleState.Battle.Clients[RealIndex]);
-    MainForm.ClientPopupMenuInitPopup(nil,nil);
-    PlayerSubmenu.Visible := True;
-  end
-  else
-    PlayerSubmenu.Visible := False;
-
-  ChatRichEdit.Refresh;
-  VDTBattleClients.Refresh;
-end;
-
 procedure TBattleForm.mnuLimitRankAutoKickClick(Sender: TObject);
 var
   i: integer;
@@ -8562,5 +8499,66 @@
   ChatRichEdit.ScrollToBottom;
 end;
 
+procedure TBattleForm.PlayerControlPopupMenuPopup(Sender: TObject);
+var
+  i:integer;
+  ClientGroup: TClientGroup;
+  RealIndex: integer;
+  WhatToDraw: TClientNodeType;
+  Client: TClient;
+begin
+  GetNodeClient(VDTBattleClients.FocusedNode.Index,RealIndex,WhatToDraw);
+
+  ForceTeamSpin.Visible := ((WhatToDraw &lt;&gt; OriginalClient) and (BattleState.Status = Hosting) ) or ((WhatToDraw = NormalBot) and ((BattleState.Status = Hosting) or (TBot(BattleState.Battle.Bots[RealIndex]).OwnerName = Status.Username)));
+  ForceAllySpin.Visible := ForceTeamSpin.Visible;
+  SetTeamColorItem.Visible := ForceTeamSpin.Visible;
+  HandicapSpinEditItem.Visible := ForceTeamSpin.Visible;
+  KickPlayerItem.Visible := ForceTeamSpin.Visible;
+  SetBotSideSubitem.Visible := (ForceTeamSpin.Visible) and (WhatToDraw = NormalBot);
+  ForceSpectatorModeItem.Visible := ForceTeamSpin.Visible;
+  RingItem.Visible := (WhatToDraw = NormalClient) and ((BattleState.Status = Hosting) or (RealIndex=0));
+
+  BanPlayerItem.Visible := BattleState.Status = Hosting;
+  UnbanSubitem.Visible := BanPlayerItem.Visible;
+  if UnbanSubitem.Visible then
+  begin
+    UnbanSubitem.Clear;
+    for i:=0 to BattleState.BanList.count-1 do begin
+      UnbanSubitem.Add(TSpTBXItem.Create(UnbanSubitem));
+      with UnbanSubitem.Items[UnbanSubitem.Count-1] as TSpTBXItem do
+      begin
+        Caption := MainForm.GetClientById(BattleState.BanList.Items[i]).Name;
+        Tag := i;
+        OnClick := UnbanItemClick;
+      end;
+    end;
+    UnbanSubitem.Enabled := UnbanSubitem.Count &gt; 0;
+  end;
+
+  if WhatToDraw = NormalClient then
+  begin
+    ForceAllySpin.Value := TClient(BattleState.Battle.Clients[RealIndex]).GetAllyNo+1;
+    ForceTeamSpin.Value := TClient(BattleState.Battle.Clients[RealIndex]).GetTeamNo+1;
+  end
+  else
+  begin
+    ForceAllySpin.Value := TBot(BattleState.Battle.Bots[RealIndex]).GetAllyNo+1;
+    ForceTeamSpin.Value := TBot(BattleState.Battle.Bots[RealIndex]).GetTeamNo+1;
+  end;
+
+  if WhatToDraw = NormalClient then
+  begin
+    PlayerSubmenu.Caption := TClient(BattleState.Battle.Clients[RealIndex]).DisplayName;
+    MainUnit.ContextMenuSelectedClient := TClient(BattleState.Battle.Clients[RealIndex]);
+    MainForm.ClientPopupMenuPopup(nil);
+    PlayerSubmenu.Visible := True;
+  end
+  else
+    PlayerSubmenu.Visible := False;
+
+  ChatRichEdit.Refresh;
+  VDTBattleClients.Refresh;
+end;
+
 end.
 

Modified: Lobby/TASClient/ColorsPreferenceUnit.dfm
===================================================================
--- Lobby/TASClient/ColorsPreferenceUnit.dfm	2010-03-15 17:30:30 UTC (rev 7430)
+++ Lobby/TASClient/ColorsPreferenceUnit.dfm	2010-03-17 14:36:29 UTC (rev 7431)
@@ -1,13 +1,13 @@
 object ColorsPreference: TColorsPreference
-  Left = 311
-  Top = 144
+  Left = 792
+  Top = 519
   BorderStyle = bsDialog
   Caption = 'Color Preferences'
-  ClientHeight = 480
-  ClientWidth = 490
+  ClientHeight = 433
+  ClientWidth = 584
   Color = clBtnFace
-  Constraints.MaxHeight = 750
-  Constraints.MaxWidth = 1280
+  Constraints.MaxHeight = 1150
+  Constraints.MaxWidth = 1920
   Font.Charset = DEFAULT_CHARSET
   Font.Color = clWindowText
   Font.Height = -11
@@ -22,15 +22,15 @@
   object SpTBXTitleBar1: TSpTBXTitleBar
     Left = 0
     Top = 0
-    Width = 490
-    Height = 480
+    Width = 584
+    Height = 433
     Caption = 'Colors and Font Preference'
     FixedSize = True
     Options.Maximize = False
     object btOk: TSpTBXButton
-      Left = 311
-      Top = 440
-      Width = 73
+      Left = 384
+      Top = 392
+      Width = 88
       Height = 25
       Caption = 'Ok'
       TabOrder = 1
@@ -43,7 +43,7 @@
     end
     object btRest: TSpTBXButton
       Left = 22
-      Top = 440
+      Top = 392
       Width = 88
       Height = 25
       Caption = 'Reset'
@@ -62,9 +62,9 @@
       LinkFont.Style = [fsUnderline]
     end
     object btCancel: TSpTBXButton
-      Left = 397
-      Top = 440
-      Width = 70
+      Left = 475
+      Top = 392
+      Width = 88
       Height = 25
       Caption = 'Cancel'
       TabOrder = 3
@@ -78,7 +78,7 @@
     object SpTBXGroupBox1: TSpTBXGroupBox
       Left = 24
       Top = 40
-      Width = 193
+      Width = 265
       Height = 337
       Caption = 'Chat colors'
       Font.Charset = DEFAULT_CHARSET
@@ -101,7 +101,7 @@
         LinkFont.Style = [fsUnderline]
       end
       object Panel0: TPanel
-        Left = 101
+        Left = 173
         Top = 44
         Width = 57
         Height = 21
@@ -111,7 +111,7 @@
         TabOrder = 1
       end
       object SpTBXButton0: TSpTBXButton
-        Left = 160
+        Left = 232
         Top = 44
         Width = 25
         Height = 20
@@ -126,7 +126,7 @@
         ThemeType = thtTBX
       end
       object SpTBXButton1: TSpTBXButton
-        Left = 160
+        Left = 232
         Top = 92
         Width = 25
         Height = 20
@@ -141,7 +141,7 @@
         ThemeType = thtTBX
       end
       object Panel1: TPanel
-        Left = 101
+        Left = 173
         Top = 92
         Width = 57
         Height = 21
@@ -175,7 +175,7 @@
         LinkFont.Style = [fsUnderline]
       end
       object Panel2: TPanel
-        Left = 101
+        Left = 173
         Top = 115
         Width = 57
         Height = 21
@@ -185,7 +185,7 @@
         TabOrder = 7
       end
       object SpTBXButton2: TSpTBXButton
-        Left = 160
+        Left = 232
         Top = 115
         Width = 25
         Height = 20
@@ -200,7 +200,7 @@
         ThemeType = thtTBX
       end
       object SpTBXButton3: TSpTBXButton
-        Left = 160
+        Left = 232
         Top = 139
         Width = 25
         Height = 20
@@ -215,7 +215,7 @@
         ThemeType = thtTBX
       end
       object Panel3: TPanel
-        Left = 101
+        Left = 173
         Top = 140
         Width = 57
         Height = 21
@@ -249,7 +249,7 @@
         LinkFont.Style = [fsUnderline]
       end
       object Panel4: TPanel
-        Left = 101
+        Left = 173
         Top = 162
         Width = 57
         Height = 21
@@ -259,7 +259,7 @@
         TabOrder = 13
       end
       object SpTBXButton4: TSpTBXButton
-        Left = 160
+        Left = 232
         Top = 162
         Width = 25
         Height = 20
@@ -274,7 +274,7 @@
         ThemeType = thtTBX
       end
       object SpTBXButton5: TSpTBXButton
-        Left = 160
+        Left = 232
         Top = 187
         Width = 25
         Height = 20
@@ -289,7 +289,7 @@
         ThemeType = thtTBX
       end
       object Panel5: TPanel
-        Left = 101
+        Left = 173
         Top = 186
         Width = 57
         Height = 21
@@ -323,7 +323,7 @@
         LinkFont.Style = [fsUnderline]
       end
       object Panel6: TPanel
-        Left = 101
+        Left = 173
         Top = 210
         Width = 57
         Height = 21
@@ -333,7 +333,7 @@
         TabOrder = 19
       end
       object SpTBXButton6: TSpTBXButton
-        Left = 160
+        Left = 232
         Top = 210
         Width = 25
         Height = 20
@@ -384,7 +384,7 @@
         LinkFont.Style = [fsUnderline]
       end
       object Panel7: TPanel
-        Left = 101
+        Left = 173
         Top = 234
         Width = 57
         Height = 21
@@ -394,7 +394,7 @@
         TabOrder = 24
       end
       object SpTBXButton7: TSpTBXButton
-        Left = 160
+        Left = 232
         Top = 234
         Width = 25
         Height = 20
@@ -409,7 +409,7 @@
         ThemeType = thtTBX
       end
       object Panel8: TPanel
-        Left = 101
+        Left = 173
         Top = 258
         Width = 57
         Height = 21
@@ -419,7 +419,7 @@
         TabOrder = 26
       end
       object SpTBXButton8: TSpTBXButton
-        Left = 160
+        Left = 232
         Top = 259
         Width = 25
         Height = 20
@@ -434,7 +434,7 @@
         ThemeType = thtTBX
       end
       object Panel9: TPanel
-        Left = 101
+        Left = 173
         Top = 283
         Width = 57
         Height = 21
@@ -444,7 +444,7 @@
         TabOrder = 28
       end
       object SpTBXButton9: TSpTBXButton
-        Left = 160
+        Left = 232
         Top = 283
         Width = 25
         Height = 20
@@ -471,7 +471,7 @@
         LinkFont.Style = [fsUnderline]
       end
       object Panel13: TPanel
-        Left = 101
+        Left = 173
         Top = 19
         Width = 57
         Height = 21
@@ -481,7 +481,7 @@
         TabOrder = 31
       end
       object SpTBXButton13: TSpTBXButton
-        Left = 160
+        Left = 232
         Top = 19
         Width = 25
         Height = 20
@@ -508,7 +508,7 @@
         LinkFont.Style = [fsUnderline]
       end
       object Panel14: TPanel
-        Left = 101
+        Left = 173
         Top = 68
         Width = 57
         Height = 21
@@ -518,7 +518,7 @@
         TabOrder = 34
       end
       object SpTBXButton14: TSpTBXButton
-        Left = 160
+        Left = 232
         Top = 68
         Width = 25
         Height = 20
@@ -545,7 +545,7 @@
         LinkFont.Style = [fsUnderline]
       end
       object Panel15: TPanel
-        Left = 101
+        Left = 173
         Top = 307
         Width = 57
         Height = 21
@@ -555,7 +555,7 @@
         TabOrder = 37
       end
       object SpTBXButton16: TSpTBXButton
-        Left = 160
+        Left = 232
         Top = 307
         Width = 25
         Height = 20
@@ -571,14 +571,14 @@
       end
     end
     object SpTBXGroupBox2: TSpTBXGroupBox
-      Left = 224
+      Left = 296
       Top = 40
-      Width = 241
-      Height = 313
+      Width = 265
+      Height = 281
       Caption = 'Other colors'
       TabOrder = 5
       object SpTBXButton10: TSpTBXButton
-        Left = 208
+        Left = 232
         Top = 19
         Width = 25
         Height = 20
@@ -593,7 +593,7 @@
         ThemeType = thtTBX
       end
       object Panel10: TPanel
-        Left = 149
+        Left = 173
         Top = 19
         Width = 57
         Height = 21
@@ -627,7 +627,7 @@
         LinkFont.Style = [fsUnderline]
       end
       object Panel11: TPanel
-        Left = 149
+        Left = 173
         Top = 43
         Width = 57
         Height = 21
@@ -637,7 +637,7 @@
         TabOrder = 4
       end
       object SpTBXButton11: TSpTBXButton
-        Left = 208
+        Left = 232
         Top = 43
         Width = 25
         Height = 20
@@ -664,7 +664,7 @@
         LinkFont.Style = [fsUnderline]
       end
       object Panel12: TPanel
-        Left = 149
+        Left = 173
         Top = 67
         Width = 57
         Height = 21
@@ -674,7 +674,7 @@
         TabOrder = 7
       end
       object SpTBXButton12: TSpTBXButton
-        Left = 208
+        Left = 232
         Top = 67
         Width = 25
         Height = 20
@@ -690,9 +690,9 @@
       end
     end
     object SpTBXGroupBox3: TSpTBXGroupBox
-      Left = 24
-      Top = 384
-      Width = 193
+      Left = 296
+      Top = 328
+      Width = 265
       Height = 49
       Caption = 'Chat font'
       TabOrder = 6
@@ -709,7 +709,7 @@
         LinkFont.Style = [fsUnderline]
       end
       object SpTBXButton15: TSpTBXButton
-        Left = 152
+        Left = 224
         Top = 16
         Width = 33
         Height = 25
@@ -730,7 +730,7 @@
     Font.Height = -11
     Font.Name = 'MS Sans Serif'
     Font.Style = []
-    Left = 136
-    Top = 400
+    Left = 384
+    Top = 344
   end
 end

Modified: Lobby/TASClient/Interface/default.js
===================================================================
--- Lobby/TASClient/Interface/default.js	2010-03-15 17:30:30 UTC (rev 7430)
+++ Lobby/TASClient/Interface/default.js	2010-03-17 14:36:29 UTC (rev 7431)
@@ -31,13 +31,16 @@
 
 function selectOption(selectId,val){
 	x = document.getElementById(selectId);
-	x.selectedIndex = 0;
-	for(k=0;k&lt;x.options.length;k++)
+	if(x != null)
 	{
-		if(x.options[k].value == val)
+		x.selectedIndex = 0;
+		for(k=0;k&lt;x.options.length;k++)
 		{
-			x.selectedIndex = k;
-			return;
+			if(x.options[k].value == val)
+			{
+				x.selectedIndex = k;
+				return;
+			}
 		}
 	}
 }
\ No newline at end of file

Modified: Lobby/TASClient/Interface/modsettings.html
===================================================================
--- Lobby/TASClient/Interface/modsettings.html	2010-03-15 17:30:30 UTC (rev 7430)
+++ Lobby/TASClient/Interface/modsettings.html	2010-03-17 14:36:29 UTC (rev 7431)
@@ -43,11 +43,15 @@
 			&lt;h1&gt;Settings&lt;/h1&gt;
 		&lt;/div&gt;
 		&lt;div style=&quot;margin:10px&quot;&gt;
-			&lt;div style=&quot;margin-bottom: 10px&quot;&gt;Game settings : &lt;a href=&quot;lobby:gamesettings&quot; class=&quot;button&quot; onmouseover=&quot;sendData('playsound:button.wav');&quot;&gt;Open&lt;/a&gt;&lt;/div&gt;
-
+			&lt;form method=&quot;POST&quot; action=&quot;url&quot; enctype=&quot;x-www-form-urlencoded&quot;&gt;
+				&lt;div style=&quot;margin-bottom: 10px&quot;&gt;Game settings : &lt;a href=&quot;lobby:gamesettings&quot; class=&quot;button&quot; onmouseover=&quot;sendData('playsound:button.wav');&quot;&gt;Open&lt;/a&gt;&lt;/div&gt;
+				&lt;div style=&quot;margin-top:10px&quot;&gt;
+					Player name :&lt;input type=&quot;text&quot; value=&quot;[PlayerName]&quot; name=&quot;PlayerName&quot; id=&quot;PlayerNameInput&quot; size=&quot;15&quot;/&gt;
+				&lt;/div&gt;
+			&lt;/form&gt;
 		&lt;/div&gt;
 		&lt;div class=&quot;footer&quot;&gt;
-			&lt;a href=&quot;#&quot; class=&quot;button&quot; style=&quot;float: left;&quot; onmouseover=&quot;sendData('playsound:button.wav');&quot; onclick=&quot;fadeOff();&quot;&gt;Return to main menu&lt;/a&gt;
+			&lt;a href=&quot;#&quot; class=&quot;button&quot; style=&quot;float: left;&quot; onmouseover=&quot;sendData('playsound:button.wav');&quot; onclick=&quot;sendData('changemyname:'+getElementById('PlayerNameInput').value);fadeOff();&quot;&gt;Return to main menu&lt;/a&gt;
 		&lt;/div&gt;
 	&lt;/div&gt;
 &lt;/body&gt;

Modified: Lobby/TASClient/Interface/settings.html
===================================================================
--- Lobby/TASClient/Interface/settings.html	2010-03-15 17:30:30 UTC (rev 7430)
+++ Lobby/TASClient/Interface/settings.html	2010-03-17 14:36:29 UTC (rev 7431)
@@ -43,17 +43,22 @@
 			&lt;h1&gt;Settings&lt;/h1&gt;
 		&lt;/div&gt;
 		&lt;div style=&quot;margin:10px&quot;&gt;
-			&lt;div style=&quot;margin-bottom: 10px&quot;&gt;Game settings : &lt;a href=&quot;lobby:gamesettings&quot; class=&quot;button&quot; onmouseover=&quot;sendData('playsound:button.wav');&quot;&gt;Open&lt;/a&gt;&lt;/div&gt;
-			&lt;div&gt;
-				Single player skin :
-				&lt;select id=&quot;SkinList&quot;&gt;
-					[SkinList]
-				&lt;/select&gt;
-				&lt;a href=&quot;#&quot; class=&quot;button&quot; onmouseover=&quot;sendData('playsound:button.wav');&quot; onclick=&quot;sendData('changeskin:'+getSelectedValue('SkinList'));&quot;&gt;Change&lt;/a&gt;
-			&lt;/div&gt;
+			&lt;form method=&quot;POST&quot; action=&quot;url&quot; enctype=&quot;x-www-form-urlencoded&quot;&gt;
+				&lt;div style=&quot;margin-bottom: 10px&quot;&gt;Game settings : &lt;a href=&quot;lobby:gamesettings&quot; class=&quot;button&quot; onmouseover=&quot;sendData('playsound:button.wav');&quot;&gt;Open&lt;/a&gt;&lt;/div&gt;
+				&lt;div&gt;
+					Single player skin :
+					&lt;select id=&quot;SkinList&quot;&gt;
+						[SkinList]
+					&lt;/select&gt;
+					&lt;a href=&quot;#&quot; class=&quot;button&quot; onmouseover=&quot;sendData('playsound:button.wav');&quot; onclick=&quot;sendData('changeskin:'+getSelectedValue('SkinList'));&quot;&gt;Change&lt;/a&gt;
+				&lt;/div&gt;
+				&lt;div style=&quot;margin-top:10px&quot;&gt;
+					Player name :&lt;input type=&quot;text&quot; value=&quot;[PlayerName]&quot; name=&quot;PlayerName&quot; id=&quot;PlayerNameInput&quot; size=&quot;15&quot;/&gt;
+				&lt;/div&gt;
+			&lt;/form&gt;
 		&lt;/div&gt;
 		&lt;div class=&quot;footer&quot;&gt;
-			&lt;a href=&quot;#&quot; class=&quot;button&quot; style=&quot;float: left;&quot; onmouseover=&quot;sendData('playsound:button.wav');&quot; onclick=&quot;fadeOff();&quot;&gt;Return to main menu&lt;/a&gt;
+			&lt;a href=&quot;#&quot; class=&quot;button&quot; style=&quot;float: left;&quot; onmouseover=&quot;sendData('playsound:button.wav');&quot; onclick=&quot;sendData('changemyname:'+getElementById('PlayerNameInput').value);fadeOff();&quot;&gt;Return to main menu&lt;/a&gt;
 		&lt;/div&gt;
 	&lt;/div&gt;
 &lt;/body&gt;

Modified: Lobby/TASClient/Interface/skirmish.html
===================================================================
--- Lobby/TASClient/Interface/skirmish.html	2010-03-15 17:30:30 UTC (rev 7430)
+++ Lobby/TASClient/Interface/skirmish.html	2010-03-17 14:36:29 UTC (rev 7431)
@@ -141,7 +141,7 @@
 		if(movingBox != null)
 		{
 			saveParam(&quot;box&quot;+curPlayerUniqueId+&quot;:&quot;+getPixelValue(movingBox.style.left)+&quot;:&quot;+getPixelValue(movingBox.style.top));
-			sendData('changestartpos:'+curPlayerId+':'+(getPixelValue(movingBox.style.left)+(getPixelValue(movingBox.style.width)+2*getPixelValue(movingBox.style.borderWidth))/2)/(getPixelValue(document.getElementById('minimap').style.width)*[MAP%WIDTH]/100)+':'+(getPixelValue(movingBox.style.top)+(getPixelValue(movingBox.style.height)/2+2*getPixelValue(movingBox.style.borderWidth)))/(getPixelValue(document.getElementById('minimap').style.height)*[MAP%HEIGHT]/100));
+			sendData('changestartpos:'+curPlayerId+':'+(getPixelValue(movingBox.style.left)+(getPixelValue(movingBox.style.width)+2*getPixelValue(movingBox.style.borderWidth))/2)/(getPixelValue(document.getElementById('minimap').style.width))+':'+(getPixelValue(movingBox.style.top)+(getPixelValue(movingBox.style.height)/2+2*getPixelValue(movingBox.style.borderWidth)))/(getPixelValue(document.getElementById('minimap').style.height)));
 		}
 		movingBox=null;
 	}
@@ -195,8 +195,8 @@
 			movingBox = document.getElementById('box'+i);
 			curBoxId = 'box'+i;
 			curPlayerId = i;
-			maxLeft = getPixelValue(document.getElementById('minimap').style.width)*[MAP%WIDTH]/100-getPixelValue(movingBox.style.width)-getPixelValue(movingBox.style.borderWidth)*2;
-			maxTop = getPixelValue(document.getElementById('minimap').style.height)*[MAP%HEIGHT]/100-getPixelValue(movingBox.style.height)-getPixelValue(movingBox.style.borderWidth)*2;
+			maxLeft = getPixelValue(document.getElementById('minimap').style.width)-getPixelValue(movingBox.style.width)-getPixelValue(movingBox.style.borderWidth)*2;
+			maxTop = getPixelValue(document.getElementById('minimap').style.height)-getPixelValue(movingBox.style.height)-getPixelValue(movingBox.style.borderWidth)*2;
 			movingBox.style.left = Math.min(maxLeft,Math.max(0,getPixelValue(movingBox.style.left)))+'px';
 			movingBox.style.top = Math.min(maxTop,Math.max(0,getPixelValue(movingBox.style.top)))+'px';
 			endMovingBox();

Modified: Lobby/TASClient/LobbyScriptUnit.pas
===================================================================
--- Lobby/TASClient/LobbyScriptUnit.pas	2010-03-15 17:30:30 UTC (rev 7430)
+++ Lobby/TASClient/LobbyScriptUnit.pas	2010-03-17 14:36:29 UTC (rev 7431)
@@ -147,6 +147,7 @@
 
 
       procedure SetBattleVisible(battleId: integer; bVisible: integer);
+      procedure SetUserDisplayName(userId: integer; displayName: string);
   end;
 
   TCallback = class(TPersistent)
@@ -676,6 +677,7 @@
 
       PyDict_SetItemStringDecRef( Result, 'Id', Id );
       PyDict_SetItemStringDecRef( Result, 'Name', Name );
+      PyDict_SetItemStringDecRef( Result, 'DisplayName', DisplayName );
       PyDict_SetItemStringDecRef( Result, 'Status', Status );
       PyDict_SetItemStringDecRef( Result, 'BattleStatus', BattleStatus );
       PyDict_SetItemStringDecRef( Result, 'TeamColor', TeamColor );
@@ -839,6 +841,7 @@
       Result := PyDict_New();
 
       PyDict_SetItemStringDecRef( Result, 'Name', Name );
+      PyDict_SetItemStringDecRef( Result, 'EnableColor', EnableColor );
       PyDict_SetItemStringDecRef( Result, 'Color', Color );
       PyDict_SetItemStringDecRef( Result, 'AutoKick', AutoKick );
       PyDict_SetItemStringDecRef( Result, 'AutoSpec', AutoSpec );
@@ -1022,6 +1025,7 @@
       group := PyDict_GetItem(groupsDict,key);
       cg := TClientGroup.Create(groupName,0);
 
+      cg.EnableColor := IntToBool(PyInt_AsLong(PyDict_GetItem(group,PyString_FromString('EnableColor'))));
       cg.Color := PyInt_AsLong(PyDict_GetItem(group,PyString_FromString('Color')));
       cg.AutoKick := IntToBool(PyInt_AsLong(PyDict_GetItem(group,PyString_FromString('AutoKick'))));
       cg.AutoSpec := IntToBool(PyInt_AsLong(PyDict_GetItem(group,PyString_FromString('AutoSpec'))));
@@ -1857,6 +1861,36 @@
   UnlockGUI;
 end;
 
+procedure TGUI.SetUserDisplayName(userId: integer; displayName: string);
+var
+  client: TClient;
+  i: integer;
+begin
+  LockGUI;
+    client := MainForm.GetClientById(userId);
+    if client &lt;&gt; nil then
+    begin
+      client.DisplayName := displayName;
+      MainForm.SortClientInLists(client);
+      if Preferences.BattleSortStyle = 5 then
+      begin
+        MainForm.SortBattleInList(client.GetBattleId,Preferences.BattleSortStyle,Preferences.BattleSortDirection=0);
+        MainForm.RefreshBattlesNodes;
+      end;
+      if client.InBattle and BattleForm.IsBattleActive and (BattleState.Battle.Clients.IndexOf(client) &gt; -1) and (Preferences.BattleClientSortStyle = 0) then
+        BattleForm.SortClientList(Preferences.BattleClientSortStyle,Preferences.BattleClientSortDirection,True);
+    end;
+    i := RenamesIds.IndexOf(userId);
+    if i&gt;-1 then
+      RenamesNames[i] := displayName
+    else
+    begin
+      RenamesIds.Add(userId);
+      RenamesNames.Add(displayName);
+    end;
+  UnlockGUI;
+end;
+
 procedure TGUI.RemoveFromMenu(id: integer);
 var
   i: integer;

Modified: Lobby/TASClient/MainUnit.dfm
===================================================================
--- Lobby/TASClient/MainUnit.dfm	2010-03-15 17:30:30 UTC (rev 7430)
+++ Lobby/TASClient/MainUnit.dfm	2010-03-17 14:36:29 UTC (rev 7431)
@@ -1,6 +1,6 @@
 object MainForm: TMainForm
-  Left = 722
-  Top = 250
+  Left = 767
+  Top = 471
   Width = 847
   Height = 521
   Caption = '.'
@@ -861,14 +861,15 @@
                   Height = 21
                   Style = csDropDownList
                   ItemHeight = 13
-                  ItemIndex = 1
+                  ItemIndex = 0
                   TabOrder = 7
-                  Text = 'Map'
+                  Text = 'Host'
                   Items.Strings = (
                     'Host'
                     'Map'
                     'Mod'
-                    'Description')
+                    'Description'
+                    'Players')
                 end
                 object SpTBXPanel2: TSpTBXPanel
                   Left = 8
@@ -6604,6 +6605,10 @@
         Caption = 'Ignore'
         OnClick = mnuIgnoreClick
       end
+      object mnuRename: TSpTBXItem
+        Caption = 'Rename'
+        OnClick = mnuRenameClick
+      end
       object mnuAddToGroup: TSpTBXSubmenuItem
         Caption = 'Add to group'
         object mnuNewGroup: TSpTBXItem
@@ -6634,7 +6639,7 @@
   end
   object BattleListPopupMenu: TSpTBXPopupMenu
     AutoHotkeys = maManual
-    OnInitPopup = BattleListPopupMenuInitPopup
+    OnPopup = BattleListPopupMenuPopup
     Left = 112
     Top = 288
     object mnuBattleHost: TSpTBXSubmenuItem
@@ -7236,8 +7241,8 @@
   end
   object ClientPopupMenu: TSpTBXPopupMenu
     AutoHotkeys = maManual
+    OnPopup = ClientPopupMenuPopup
     LinkSubitems = PlayerSubMenu
-    OnInitPopup = ClientPopupMenuInitPopup
     Left = 540
     Top = 190
   end

Modified: Lobby/TASClient/MainUnit.pas
===================================================================
--- Lobby/TASClient/MainUnit.pas	2010-03-15 17:30:30 UTC (rev 7430)
+++ Lobby/TASClient/MainUnit.pas	2010-03-17 14:36:29 UTC (rev 7431)
@@ -405,7 +405,7 @@
   );
 
 const
-  VERSION_NUMBER = '0.69'; // Must be float value! (with a period as a decimal seperator)
+  VERSION_NUMBER = '0.70'; // Must be float value! (with a period as a decimal seperator)
   AUTOUPDATE_URL = '<A HREF="http://tasclient.no-ip.org/TASClient_update_v3.txt">http://tasclient.no-ip.org/TASClient_update_v3.txt</A>';
   PROGRAM_VERSION = 'TASClient ' + VERSION_NUMBER;
   KEEP_ALIVE_INTERVAL = 10000; // in milliseconds. Tells us what should be the maximum &quot;silence&quot; time before we send a ping to the server.
@@ -436,6 +436,7 @@
   AUTOJOIN_PRESETS_FOLDER = VAR_FOLDER + '\autoJoinPresets';
   MENU_SETTINGS_FILE = VAR_FOLDER + '\' + 'menuSettings.ini';
   TIPS_FILE = VAR_FOLDER+'\tips.txt';
+  RENAMES_FILE = VAR_FOLDER+'\renames.ini';
   SPRING_SETTINGS_PROFILE_FILE = VAR_FOLDER + '\SpringSettingsProfiles.ini';
   FILTERS_FOLDER = VAR_FOLDER + '\filters';
   REPLAY_FILTERS_FOLDER = VAR_FOLDER + '\replayFilters';
@@ -616,6 +617,7 @@
   TClientGroup = class
   public
     Name: string;
+    EnableColor: boolean;
     Color: integer;
     Clients: TStrings;
     ClientsIds: TIntegerList;
@@ -647,6 +649,7 @@
   public
     Id: integer;
     Name: WideString; // client's username
+    DisplayName: WideString;
     RecentNames: string; // use for modos with FINDIP
     FStatus: Integer; // client's status (normal, in game)
     FBattleStatus: Integer; // only used for clients participating in the same battle as the player
@@ -886,7 +889,7 @@
     function IsLadderBattle: Boolean;
     function GetLadderId: integer;
     function GetState: Integer; // use it to get index of image from BattleStatusImageList
-    function ClientsToString: string; // returns user names in a string, separated by spaces
+    function ClientsToString(separator: string=', ';displayName: boolean=True): string; // returns user names in a string, separated by spaces
     function GetClient(Name: string): TClient;
     function GetBot(Name: string): TBot;
     procedure RemoveAllBots;
@@ -1231,6 +1234,7 @@
     RankFilter: TSpTBXCheckBox;
     RankSignButton: TSpTBXButton;
     RankValueTextBox: TJvSpinEdit;
+    mnuRename: TSpTBXItem;
     procedure mnuOpenPrivateChatClick(Sender: TObject);
     procedure mnuSelectBattleClick(Sender: TObject);
     procedure mnuPlayWithClick(Sender: TObject);
@@ -1314,10 +1318,6 @@
     procedure LadderCupsRefreshTimer(Sender: TObject);
     procedure FilterListChecking(Sender: TBaseVirtualTree;
       Node: PVirtualNode; var NewState: TCheckState; var Allowed: Boolean);
-    procedure BattleListPopupMenuInitPopup(Sender: TObject;
-      PopupView: TTBView);
-    procedure ClientPopupMenuInitPopup(Sender: TObject;
-      PopupView: TTBView);
     procedure mnuDisplayOnlyHostClick(Sender: TObject);
     procedure mnuDisplayOnlyModClick(Sender: TObject);
     procedure mnuDisplayOnlyMapClick(Sender: TObject);
@@ -1402,6 +1402,9 @@
     procedure RankSignButtonClick(Sender: TObject);
     procedure RankValueTextBoxChange(Sender: TObject);
     procedure OptionsPopupMenuPopup(Sender: TObject);
+    procedure mnuRenameClick(Sender: TObject);
+    procedure BattleListPopupMenuPopup(Sender: TObject);
+    procedure ClientPopupMenuPopup(Sender: TObject);
   published
     MainTitleBar: TSpTBXTitleBar;
     ButtonImageList: TImageList;
@@ -1565,6 +1568,9 @@
     procedure FiltersUpdated;
     procedure UpdateFilters(pFilters: TPresetFilters);
     procedure CopyFilters(srcFilters: TPresetFilters; var dstFilters: TPresetFilters);
+
+    procedure SaveRenames;
+    procedure LoadRenames;
   published
     MainPCH : TPageControlHost;
     procedure ApplicationEvents1ShortCut(var Msg: TWMKey; var Handled: Boolean);
@@ -1672,6 +1678,8 @@
     All other clients lists (in channels, battles) contain objects linking to actual objects in this list. Never free
     any clients in any list except in this one, since freeing them in any other list will also free them in this list! }
   AllClients: TList;
+  RenamesIds: TIntegerList;
+  RenamesNames: TWideStringList;
 
   ClientGroups: TList;
 
@@ -2398,13 +2406,24 @@
 
 function TMainForm.RemoveClientFromAllClientsList(Name: WideString): Boolean;
 var
-  i: Integer;
+  i,j: Integer;
 begin
   Result := False;
 
   for i := 0 to AllClients.Count - 1 do
     if TClient(AllClients[i]).Name = Name then
     begin
+      if TClient(AllClients[i]).Name &lt;&gt; TClient(AllClients[i]).DisplayName then
+      begin
+        j := RenamesIds.IndexOf(TClient(AllClients[i]).Id);
+        if j &gt; -1 then
+          RenamesNames[j] := TClient(AllClients[i]).DisplayName
+        else
+        begin
+          RenamesIds.Add(TClient(AllClients[i]).Id);
+          RenamesNames.Add(TClient(AllClients[i]).DisplayName);
+        end;
+      end;
       AllClients.Delete(i);
       Result := True;
       Exit;
@@ -2559,6 +2578,11 @@
 begin
   Self.Id := id;
   Self.Name := Name;
+  i := RenamesIds.IndexOf(id);
+  if i &gt; -1 then
+    Self.DisplayName := RenamesNames[i]
+  else
+    Self.DisplayName := Name;
   Self.Status := Status;
   Self.BattleStatus := 0;
   Self.InBattle := False;
@@ -3070,13 +3094,14 @@
   if IsLadderBattle and Password then Inc(Result,11);
 end;
 
-function TBattle.ClientsToString: string; // returns user names in a string, separated by spaces
+function TBattle.ClientsToString(separator: string=', ';displayName: boolean=True): string;
 var
   i: Integer;
 begin
   Result := '';
-  for i := 0 to Clients.Count-1 do Result := Result + TClient(Clients[i]).Name + ', ';
-  if Length(Result) &gt; 0 then Delete(Result, Length(Result)-1, 2);
+  for i := 0 to Clients.Count-1 do
+    Result := Result + TClient(Clients[i]).DisplayName + separator;
+  if Length(Result) &gt; 0 then Delete(Result, Length(Result)-1, Length(separator));
 end;
 
 function TBattle.GetClient(Name: string): TClient;
@@ -3847,6 +3872,8 @@
     Misc.TryToAddLog(MainUnit.StartDebugLog,'Initializing variables ...');
 
   AllClients := TList.Create;
+  RenamesIds := TIntegerList.Create;
+  RenamesNames := TWideStringList.Create;
 
   ClientGroups := TList.Create;
 
@@ -4060,6 +4087,9 @@
     end;
 
     if MainUnit.Debug.Enabled then
+      Misc.TryToAddLog(MainUnit.StartDebugLog,'Loading renames ...');
+    LoadRenames;
+    if MainUnit.Debug.Enabled then
       Misc.TryToAddLog(MainUnit.StartDebugLog,'Loading groups ...');
     LoadGroups;
     if MainUnit.Debug.Enabled then
@@ -4616,7 +4646,7 @@
   for i:=0 to cList.Count-1 do
   begin
     try
-      TClient(cList[i]).Visible := (PlayerFiltersTextbox.Text = '') or RegExpr.ExecRegExpr(LowerCase(PlayerFiltersTextbox.Text),LowerCase(TClient(cList[i]).Name));
+      TClient(cList[i]).Visible := (PlayerFiltersTextbox.Text = '') or RegExpr.ExecRegExpr(LowerCase(PlayerFiltersTextbox.Text),LowerCase(TClient(cList[i]).Name)) or RegExpr.ExecRegExpr(LowerCase(PlayerFiltersTextbox.Text),LowerCase(TClient(cList[i]).DisplayName));
     except
       TClient(cList[i]).Visible := True;
     end;
@@ -5575,7 +5605,7 @@
       if (lastActiveTab.Caption = LOCAL_TAB) and (not Status.ReceivingLoginInfo) then UpdateClientsListBox;
 
       if not Status.ReceivingLoginInfo and (TClient(GetClient(sl[1])).GetGroup &lt;&gt; nil) and TClient(GetClient(sl[1])).GetGroup.NotifyOnConnect then
-        AddNotification(_('Player connection'), '&lt;' + sl[1] + _('&gt; has joined the server.'), 2000);
+        AddNotification(_('Player connection'), '&lt;' + TClient(GetClient(sl[1])).DisplayName + _('&gt; has joined the server.'), 2000);
 
       i := GetTabWindowPageIndex(sl[1]);
       if i &lt;&gt; -1 then
@@ -5616,7 +5646,8 @@
       if i &lt;&gt; -1 then
       begin
         RemoveClientFromTab(TMyTabSheet(MainForm.ChatTabs[i]), sl[1]);
-        AddTextToChatWindow(TMyTabSheet(MainForm.ChatTabs[i]),sl[1]+_(' has left the server.'),Colors.ChanLeft,True);
+        Client := GetClient(sl[1]);
+        AddTextToChatWindow(TMyTabSheet(MainForm.ChatTabs[i]),Client.DisplayName+_(' has left the server.'),Colors.ChanLeft,True);
       end;
 
       if not RemoveClientFromAllClientsList(sl[1]) then
@@ -6017,6 +6048,8 @@
         Exit;
       end;
 
+      Client := GetClient(sl[2]);
+
       i := GetTabWindowPageIndex('#' + sl[1]);
       if i = -1 then
       begin
@@ -6034,7 +6067,7 @@
       begin
         tmp := '';
         if sl.Count &gt; 3 then tmp := ' (' + MakeSentenceWS(sl, 3) + ')';
-        AddTextToChatWindow(TMyTabSheet(MainForm.ChatTabs[i]), '* ' + sl[2] + _(' has left ') + TMyTabSheet(MainForm.ChatTabs[i]).Caption + tmp, Colors.ChanLeft, true);
+        AddTextToChatWindow(TMyTabSheet(MainForm.ChatTabs[i]), '* ' + Client.DisplayName + _(' has left ') + TMyTabSheet(MainForm.ChatTabs[i]).Caption + tmp, Colors.ChanLeft, true);
       end;
 
       UpdateClientsListBox;
@@ -6140,7 +6173,7 @@
 
       Client := GetClient(sl[2]);
 
-      AddTextToChatWindow(TMyTabSheet(MainForm.ChatTabs[i]), '&lt;' + Client.Name + '&gt; ' + MakeSentenceWS(sl, 3), Client.GetChatTextColor, Length(sl[2])+2);
+      AddTextToChatWindow(TMyTabSheet(MainForm.ChatTabs[i]), '&lt;' + Client.DisplayName + '&gt; ' + MakeSentenceWS(sl, 3), Client.GetChatTextColor, Length(sl[2])+2);
     end
     else if sl[0] = 'CHANNELMESSAGE' then
     begin
@@ -6187,7 +6220,7 @@
         Exit;
       end;
 
-      AddTextToChatWindow(TMyTabSheet(MainForm.ChatTabs[i]), '* ' + sl[2] + ' ' + MakeSentenceWS(sl, 3), Colors.SayEx);
+      AddTextToChatWindow(TMyTabSheet(MainForm.ChatTabs[i]), '* ' + Client.DisplayName + ' ' + MakeSentenceWS(sl, 3), Colors.SayEx);
     end
     else if sl[0] = 'SAIDPRIVATE' then
     begin
@@ -6266,7 +6299,7 @@
         UpdateClientsListBox;
       end;
 
-      AddTextToChatWindow(TMyTabSheet(MainForm.ChatTabs[i]), '&lt;' + sl[1] + '&gt; ' + MakeSentenceWS(sl, 2), Colors.Normal, Length(sl[1])+2,False,False);
+      AddTextToChatWindow(TMyTabSheet(MainForm.ChatTabs[i]), '&lt;' + Client.DisplayName + '&gt; ' + MakeSentenceWS(sl, 2), Colors.Normal, Length(sl[1])+2,False,False);
 
       // auto replay away message
       Client := GetClient(sl[1]);
@@ -6276,7 +6309,7 @@
       end;
 
       // add notification if private message:
-      if (NotificationsForm.CheckBox1.Checked) and ((lastActiveTab &lt;&gt; MainForm.ChatTabs[i]) or not GetControlForm(TMyTabSheet(ChatTabs[i])).Active) then AddNotification(_('Private message'), '&lt;' + sl[1] + '&gt; ' + MakeSentenceWS(sl, 2), 2500);
+      if (NotificationsForm.CheckBox1.Checked) and ((lastActiveTab &lt;&gt; MainForm.ChatTabs[i]) or not GetControlForm(TMyTabSheet(ChatTabs[i])).Active) then AddNotification(_('Private message'), '&lt;' + Client.DisplayName + '&gt; ' + MakeSentenceWS(sl, 2), 2500);
     end
     else if sl[0] = 'SAYPRIVATE' then
     begin
@@ -6331,7 +6364,7 @@
       if Preferences.UseIgnoreList then
         if IgnoreListForm.IgnoringUser(Client) then Exit; // don't display the message
 
-      BattleForm.AddTextToChat('&lt;' + Client.Name + '&gt; ' + MakeSentenceWS(sl, 2), Client.GetChatTextColor, Length(sl[1])+2);
+      BattleForm.AddTextToChat('&lt;' + Client.DisplayName + '&gt; ' + MakeSentenceWS(sl, 2), Client.GetChatTextColor, Length(sl[1])+2);
     end
     else if sl[0] = 'SAIDBATTLEEX' then
     begin
@@ -6348,6 +6381,8 @@
         BattleState.Battle.RefreshRanksNCupsOnSuccessReport := false;
       end;
 
+      Client := GetClient(sl[1]);
+
       if Preferences.DisplayAutohostInterface and (TClient(BattleState.Battle.Clients[0]).Name = sl[1]) then
       begin
         tmpBool := BattleForm.ChatRichEdit.atBottom;
@@ -6420,7 +6455,7 @@
         if BattleState.AutoHost and BattleForm.mnuHideAutoHostMsgs.Checked then Exit;
       end;
 
-      BattleForm.AddTextToChat('* ' + sl[1] + ' ' + tmp, Colors.SayEx, 1);
+      BattleForm.AddTextToChat('* ' + Client.DisplayName + ' ' + tmp, Colors.SayEx, 1);
     end
     else if sl[0] = 'REQUESTBATTLESTATUS' then
     begin
@@ -6822,7 +6857,7 @@
       if ((not Application.Active) or (not BattleForm.Active)) and not Status.ReceivingLoginInfo then
         if (not ((BattleForm.IsBattleActive) and (Battle.ID = BattleState.Battle.ID))) then
           if NotificationsForm.FindNotification(nfStatusInBattle, [Client.Name]) or ((Client.GetGroup &lt;&gt; nil) and Client.GetGroup.NotifyOnHost and (Battle.ID &lt;&gt; Status.Me.GetBattleId)) then
-            AddNotification(_('Player joined battle'), '&lt;' + Client.Name + _('&gt; has joined ') + TClient(Battle.Clients[0]).Name + _('''s battle.') , 5000,true,Battle.ID);
+            AddNotification(_('Player joined battle'), '&lt;' + Client.DisplayName + _('&gt; has joined ') + TClient(Battle.Clients[0]).DisplayName + _('''s battle.') , 5000,true,Battle.ID);
 
       SortBattleInList(Battles.IndexOf(Battle),Preferences.BattleSortStyle,Preferences.BattleSortDirection = 0);
       RefreshBattleList;
@@ -6833,7 +6868,7 @@
         if Battle.ID = BattleFormUnit.BattleState.Battle.ID then
         begin
           if not Preferences.FilterBattleJoinLeftMessages then
-            BattleForm.AddTextToChat('* ' + Client.Name + _(' has joined battle'), Colors.ChanJoin, 1);
+            BattleForm.AddTextToChat('* ' + Client.DisplayName + _(' has joined battle'), Colors.ChanJoin, 1);
           BattleForm.SortClientList(Preferences.BattleClientSortStyle,Preferences.BattleClientSortDirection,False);
           BattleForm.UpdateClientsListBox;
           if BattleState.Status = Hosting then
@@ -6873,7 +6908,7 @@
           end;
           if not BattleForm.Active then
             if NotificationsForm.FindNotification(nfJoinedBattle, []) or ((BattleState.Status = Hosting) and NotificationsForm.FindNotification(nfJoinedMyHostedBattle, [])) then
-              AddNotification(_('Player joined battle'), '&lt;'+ Client.Name + _('&gt; has joined battle.'), 2000);
+              AddNotification(_('Player joined battle'), '&lt;'+ Client.DisplayName + _('&gt; has joined battle.'), 2000);
           Client.CurrentLadderRank := -1;
           Client.CurrentLadderRating := -1;
           BattleForm.RefreshLadderRanks;
@@ -6927,7 +6962,7 @@
         if Battle.ID = BattleFormUnit.BattleState.Battle.ID then
         begin
           if not Preferences.FilterBattleJoinLeftMessages then
-            BattleForm.AddTextToChat('* ' + Client.Name + _(' has left battle'), Colors.ChanLeft, 1);
+            BattleForm.AddTextToChat('* ' + Client.DisplayName + _(' has left battle'), Colors.ChanLeft, 1);
           BattleForm.SortClientList(Preferences.BattleClientSortStyle,Preferences.BattleClientSortDirection,True);
           BattleForm.UpdateClientsListBox;
           BattleForm.RefreshTeamNbr;
@@ -7011,7 +7046,7 @@
       end;
 
       if changed and not Client.GetInGameStatus and (Client.GetBattleId &lt;&gt; Status.Me.GetBattleId) and (Client.GetGroup &lt;&gt; nil) and Client.GetGroup.NotifyOnBattleEnd then
-        AddNotification(_('Player battle end'), '&lt;' + Client.Name + _('&gt; has end his battle.'), 2000);
+        AddNotification(_('Player battle end'), '&lt;' + Client.DisplayName + _('&gt; has end his battle.'), 2000);
 
 
       if Client.Name = Status.Username then Status.MyRank := Client.GetRank;
@@ -8057,7 +8092,7 @@
   realIndex := i;
 
   group := TClient(cList[realIndex]).GetGroup;
-  if (group &lt;&gt; nil) and (ClientsListBox.ItemIndex &lt;&gt; Index) then
+  if (group &lt;&gt; nil) and (ClientsListBox.ItemIndex &lt;&gt; Index) and (group.EnableColor) then
     (Control as TTntListBox).Canvas.Brush.Color := group.Color;
 
   // this ensures the correct highlite color is used
@@ -8091,8 +8126,8 @@
     Inc(xpos, BotImage.Picture.Bitmap.Width + 4{leave some space between username and the icon});
   end;
 
-  WideCanvasTextOut((Control as TTntListBox).Canvas, xpos, Rect.Top, TClient(cList[realIndex]).Name);
-  Inc(xpos, WideCanvasTextWidth((Control as TTntListBox).Canvas,TClient(cList[realIndex]).Name));
+  WideCanvasTextOut((Control as TTntListBox).Canvas, xpos, Rect.Top, TClient(cList[realIndex]).DisplayName);
+  Inc(xpos, WideCanvasTextWidth((Control as TTntListBox).Canvas,TClient(cList[realIndex]).DisplayName));
 
   // ladder cup
   with TClient(cList[realIndex]) do
@@ -8438,7 +8473,11 @@
 
   try
   for i:=0 to Clients.Count-1 do
+  begin
+    if TClient(Clients[i]).DisplayName &lt;&gt; TClient(Clients[i]).Name then
+      SortedClientsList.Add(TClient(Clients[i]).DisplayName);
     SortedClientsList.Add(TClient(Clients[i]).Name);
+  end;
 
   SortedClientsList.Sort;
 
@@ -8916,7 +8955,7 @@
         else
           s := Battle.Description; // game's name (description, title)
       end;
-      2: s := TClient(Battle.Clients[0]).Name; // host
+      2: s := TClient(Battle.Clients[0]).DisplayName; // host
       3: // map
       begin
         if Preferences.MarkUnknownMaps then
@@ -9203,6 +9242,7 @@
   if RunningWithMainMenu then
     MenuForm.SaveSettings;
   SaveGroups;
+  SaveRenames;
 
   if Preferences.EnableSpringDownloader then
     CloseSpringDownloader;
@@ -9357,7 +9397,7 @@
   case SortStyle of
     0: Result := 0; // no sorting
     // sort by name:
-    1: if AnsiCompareText(Client1.Name, Client2.Name) = 0 then Result := 0 else if AnsiCompareText(Client1.Name, Client2.Name) &gt; 0 then Result := 1 else Result := -1;
+    1: if AnsiCompareText(Client1.DisplayName, Client2.DisplayName) = 0 then Result := 0 else if AnsiCompareText(Client1.DisplayName, Client2.DisplayName) &gt; 0 then Result := 1 else Result := -1;
     // sort by status:
     2: if Client1.GetInGameStatus and Client2.GetInGameStatus then Result := CompareClients(Client1, Client2, 1)
        else if Client1.GetInGameStatus and not Client2.GetInGameStatus then Result := 1
@@ -9374,14 +9414,12 @@
     4: if CompareText(Client1.Country, Client2.Country) = 0 then Result := CompareClients(Client1, Client2, 1) else if CompareText(Client1.Country, Client2.Country) &gt; 0 then Result := 1 else Result := -1;
     // sort by group (then by name):
     5:
-      if ((Client1.GetGroup = nil) and (Client2.GetGroup = nil)) or (Client1.GetGroup = Client2.GetGroup) then
-        if AnsiCompareText(Client1.Name, Client2.Name) = 0 then Result := 0 else if AnsiCompareText(Client1.Name, Client2.Name) &gt; 0 then Result := 1 else Result := -1
+      if (((Client1.GetGroup = nil) or (not Client1.GetGroup.EnableColor)) and ((Client2.GetGroup = nil) or (not Client2.GetGroup.EnableColor))) or (Client1.GetGroup = Client2.GetGroup) then
+        if AnsiCompareText(Client1.DisplayName, Client2.DisplayName) = 0 then Result := 0 else if AnsiCompareText(Client1.DisplayName, Client2.DisplayName) &gt; 0 then Result := 1 else Result := -1
       else
-        if Client2.GetGroup = Client1.GetGroup then
-          Result := 0
-        else if Client1.GetGroup = nil then
+        if (Client1.GetGroup = nil) or not Client1.GetGroup.EnableColor then
           Result := 1
-        else if Client2.GetGroup = nil then
+        else if (Client2.GetGroup = nil) or not Client2.GetGroup.EnableColor then
           Result := -1
         else
           Result := CompareStr(Client2.GetGroup.Name,Client1.GetGroup.Name)
@@ -9445,7 +9483,7 @@
     // sort by map:
     4: if AnsiCompareText(Battle1.Map, Battle2.Map) = 0 then Result := 0 else if AnsiCompareText(Battle1.Map, Battle2.Map) &gt; 0 then Result := 1 else Result := -1;
     // sort by host:
-    5: if AnsiCompareText(TClient(Battle1.Clients[0]).Name, TClient(Battle2.Clients[0]).Name) = 0 then Result := 0 else if AnsiCompareText(TClient(Battle1.Clients[0]).Name, TClient(Battle2.Clients[0]).Name) &gt; 0 then Result := 1 else Result := -1;
+    5: if AnsiCompareText(TClient(Battle1.Clients[0]).DisplayName, TClient(Battle2.Clients[0]).DisplayName) = 0 then Result := 0 else if AnsiCompareText(TClient(Battle1.Clients[0]).DisplayName, TClient(Battle2.Clients[0]).DisplayName) &gt; 0 then Result := 1 else Result := -1;
     // sort by average rank
     6:
     begin
@@ -9637,13 +9675,18 @@
       if enabled then
       begin
         if filterType = HostName then
-          tmpStr := TClient(Battle.Clients[0]).Name
+          if TClient(Battle.Clients[0]).Name &lt;&gt; TClient(Battle.Clients[0]).DisplayName then
+            tmpStr := TClient(Battle.Clients[0]).Name+' '+TClient(Battle.Clients[0]).DisplayName
+          else
+            tmpStr := TClient(Battle.Clients[0]).Name
         else if filterType = MapName then
           tmpStr := LeftStr(Battle.Map,Length(Battle.Map)-4) // left to remove the .smf (or whatever the extension is)
         else if filterType = ModName then
           tmpStr := Battle.ModName
         else if filterType = Description then
           tmpStr := Battle.Description
+        else if filterType = Players then
+          tmpStr := Battle.ClientsToString(' ',True)+' '+Battle.ClientsToString(' ',False)
         else
           raise Exception.Create(_('Filter type not handled.'));
 
@@ -10224,7 +10267,7 @@
   begin
     ClientsListBox.ItemIndex := ClientsListBox.ItemAtPos(Point(X, Y), True);
     ContextMenuSelectedClient := nil;
-    ClientPopupMenuInitPopup(nil,nil);
+    ClientPopupMenuPopup(nil);
   end;
 end;
 
@@ -10521,6 +10564,7 @@
     Ini := TIniFile.Create(FileName);
     for i:=0 to ClientGroups.Count-1 do begin
       Ini.WriteString(IntToStr(i), 'Name', TClientGroup(ClientGroups[i]).Name);
+      Ini.WriteString(IntToStr(i), 'EnableColor', BoolToStr(TClientGroup(ClientGroups[i]).EnableColor));
       Ini.WriteString(IntToStr(i), 'Color', IntToStr(TClientGroup(ClientGroups[i]).Color));
       Ini.WriteString(IntToStr(i), 'AutoKick', BoolToStr(TClientGroup(ClientGroups[i]).AutoKick));
       Ini.WriteString(IntToStr(i), 'AutoSpec', BoolToStr(TClientGroup(ClientGroups[i]).AutoSpec));
@@ -10562,6 +10606,7 @@
   while Ini.SectionExists(IntToStr(i)) do begin
     cg := TClientGroup.Create('empty',0);
     cg.Name := Ini.ReadString(IntToStr(i), 'Name', 'Empty');
+    cg.EnableColor := StrToBool(Ini.ReadString(IntToStr(i), 'EnableColor', '1'));
     cg.Color := StrToInt(Ini.ReadString(IntToStr(i), 'Color', '0'));
     cg.AutoKick := StrToBool(Ini.ReadString(IntToStr(i), 'AutoKick', '0'));
     cg.AutoSpec := StrToBool(Ini.ReadString(IntToStr(i), 'AutoSpec', '0'));
@@ -10915,6 +10960,7 @@
     1:f^.filterType := MapName;
     2:f^.filterType := ModName;
     3:f^.filterType := Description;
+    4:f^.filterType := Players;
   end;
   f^.node := nil;
   f^.contains := ContainsRadio.Checked;
@@ -11065,7 +11111,9 @@
       else if filter.filterType = ModName then
         CellText := _('Mod')
       else if filter.filterType = Description then
-        CellText := _('Description');
+        CellText := _('Description')
+      else if filter.filterType = Players then
+        CellText := _('Players');
     2:
       if filter.contains then
         CellText := _('with')
@@ -11265,7 +11313,9 @@
         else if filterType = ModName then
           Ini.WriteString('TextFilter'+IntToStr(i), 'Type', 'Mod')
         else if filterType = Description then
-          Ini.WriteString('TextFilter'+IntToStr(i), 'Type', 'Description');
+          Ini.WriteString('TextFilter'+IntToStr(i), 'Type', 'Description')
+        else if filterType = Players then
+          Ini.WriteString('TextFilter'+IntToStr(i), 'Type', 'Players');
         
         Ini.WriteBool('TextFilter'+IntToStr(i), 'Contains', contains);
         Ini.WriteString('TextFilter'+IntToStr(i), 'Value', value);
@@ -11356,7 +11406,9 @@
     else if tmpStr = 'Mod' then
       TFilterText(f^).filterType := ModName
     else if tmpStr = 'Description' then
-      TFilterText(f^).filterType := Description;
+      TFilterText(f^).filterType := Description
+    else if tmpStr = 'Players' then
+      TFilterText(f^).filterType := Players;
 
     TFilterText(f^).value := Ini.ReadString('TextFilter'+IntToStr(i),'Value','');
     TFilterText(f^).contains := Ini.ReadBool('TextFilter'+IntToStr(i),'Contains',True);
@@ -11857,106 +11909,6 @@
   FiltersUpdated;
 end;
 
-procedure TMainForm.BattleListPopupMenuInitPopup(Sender: TObject;
-  PopupView: TTBView);
-begin
-  VDTBattles.SetFocus;
-  if (VDTBattles.FocusedNode &lt;&gt; nil) and VDTBattles.Selected[VDTBattles.FocusedNode] then
-  begin
-    SelectedBattle := GetBattleFromNode(VDTBattles.FocusedNode);
-    ContextMenuSelectedClient := SelectedBattle.Clients[0];
-    ClientPopupMenuInitPopup(nil,nil);
-    mnuBattleHost.Caption := ContextMenuSelectedClient.Name;
-    mnuBattleDlMap.Enabled := Utility.MapList.IndexOf(SelectedBattle.Map) = -1;
-    mnuBattleDlMod.Enabled := Utility.ModList.IndexOf(SelectedBattle.ModName) = -1;
-  end;
-  mnuBattleHost.Visible := VDTBattles.FocusedNode &lt;&gt; nil;
-  mnuBattleAddToFilters.Visible := VDTBattles.FocusedNode &lt;&gt; nil;
-  mnuBattleDlMap.Visible := VDTBattles.FocusedNode &lt;&gt; nil;
-  mnuBattleDlMod.Visible := VDTBattles.FocusedNode &lt;&gt; nil;
-  mnuBattleHost.Visible := VDTBattles.FocusedNode &lt;&gt; nil;
-  mnuBattleAddToFilters.Visible := VDTBattles.FocusedNode &lt;&gt; nil;
-  if QuickJoinPanel.Visible then
-    mnuQuickJoinPanel.Caption := _('Hide Quick join panel')
-  else
-    mnuQuickJoinPanel.Caption := _('Show Quick join panel');
-
-  VDTBattles.Repaint;
-end;
-
-procedure TMainForm.ClientPopupMenuInitPopup(Sender: TObject;
-  PopupView: TTBView);
-var
-  Client: TClient;
-  ClientGroup : TClientGroup;
-  i : Integer;
-  tmp,realIndex: integer;
-  cList: TList;
-begin
-
-  if ContextMenuSelectedClient = nil then // showing player context menu from the richedit
-  begin
-    if ClientsListBox.ItemIndex = -1 then Exit; // I don't think this can actually happen, since we must click in ListBox and so select an item
-      if lastActiveTab.Caption = LOCAL_TAB then
-        cList := AllClients
-      else
-        cList := lastActiveTab.Clients;
-
-      tmp := ClientsListBox.ItemIndex;
-      for i:=0 to cList.Count-1 do
-      begin
-        if TClient(cList[i]).Visible then Dec(tmp);
-        if tmp = -1 then break;
-      end;
-      realIndex := i;
-      if realIndex &gt; -1 then
-        Client := TClient(cList[realIndex])
-      else
-        AddMainLog('Error: Player not found in the global player list.',Colors.Error);
-  end
-  else
-    Client := ContextMenuSelectedClient;
-
-  ModerationSubmenuItem.Visible := Status.Me.GetAccess; // only moderators may see moderation menu!
-  MuteSubitemMenu.Visible := LeftStr(lastActiveTab.Caption,1) = '#';
-  mnuUnmute.Visible := LeftStr(lastActiveTab.Caption,1) = '#';
-
-  mnuPlayWith.Enabled := Client.GetBattleId &lt;&gt; -1;
-  mnuSelectBattle.Enabled := mnuPlayWith.Enabled;
-
-  ClientGroup := Client.GetGroup;
-
-  if ClientGroup &lt;&gt; nil then begin
-    mnuAddToGroup.Caption := _('Move to group');
-    mnuRemoveFromGroup.Enabled := True;
-  end
-  else
-  begin
-    mnuAddToGroup.Caption := _('Add to group');
-    mnuRemoveFromGroup.Enabled := False;
-  end;
-
-  mnuIgnore.Checked := IgnoreListForm.IgnoringUser(Client);
-
-  mnuManageGroups.Enabled := ClientGroups.Count &gt; 0;
-
-  for i:= mnuAddToGroup.Count-1 downto 2 do
-    mnuAddToGroup.Remove(mnuAddToGroup.Items[i]);
-
-  for i:=0 to ClientGroups.Count-1 do
-  begin
-    mnuAddToGroup.Add(TSpTBXItem.Create(mnuAddToGroup));
-    with mnuAddToGroup.Items[mnuAddToGroup.Count-1] as TSpTBXItem do
-    begin
-      Caption := TClientGroup(ClientGroups[i]).Name;
-      Tag := i;
-      OnClick := AddToGroupItemClick;
-    end;
-  end;
-
-  SelectedUserName := Client.Name;
-end;
-
 procedure TMainForm.mnuDisplayOnlyHostClick(Sender: TObject);
 var
   f: ^TFilterText;
@@ -12075,7 +12027,7 @@
   Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
 begin
   if Button = mbRight then
-    BattleListPopupMenuInitPopup(nil,nil);
+    BattleListPopupMenuPopup(nil);
 end;
 
 constructor TLobbyUpdateThread.Create(Suspended: Boolean;downloadBeta: boolean; autoUpdate: boolean; delayed : integer = 0; forceUpdate: boolean = False);
@@ -13575,4 +13527,171 @@
   end;
 end;
 
+procedure TMainForm.mnuRenameClick(Sender: TObject);
+var
+  client: TClient;
+begin
+  client := GetClient(SelectedUserName);
+  client.DisplayName := InputBox(_('Rename user'),_('New name :'),client.Name);
+  SortClientInLists(client);
+  UpdateClientsListBox;
+  if Preferences.BattleSortStyle = 5 then
+  begin
+    SortBattlesList(Battles ,Preferences.BattleSortStyle, Preferences.BattleSortDirection = 0);
+    RefreshBattlesNodes;
+  end;
+  VDTBattles.Refresh;
+  if client.InBattle and BattleForm.IsBattleActive and (BattleState.Battle.Clients.IndexOf(Client) &gt; -1) and (Preferences.BattleClientSortStyle = 0) then
+  begin
+    BattleForm.SortClientList(Preferences.BattleClientSortStyle,Preferences.BattleClientSortDirection,True);
+    BattleForm.VDTBattleClients.Refresh;
+  end;
+end;
+
+// must be done when not logged in otherwise all new connected users renames won't be saved
+procedure TMainForm.SaveRenames;
+var
+  FileName: String;
+  Ini : TIniFile;
+  i:integer;
+begin
+  try
+    FileName := ExtractFilePath(Application.ExeName) + RENAMES_FILE;
+    if FileExists(FileName) then
+      DeleteFile(FileName);
+    Ini := TIniFile.Create(FileName);
+    for i:=0 to RenamesIds.Count-1 do
+      Ini.WriteString('Renames',IntToStr(RenamesIds.Items[i]),RenamesNames[i]);
+    Ini.Free;
+  except
+    MainForm.AddMainLog(_('An error occured while saving the Renames file.'),Colors.Error);
+  end;
+end;
+procedure TMainForm.LoadRenames;
+var
+  FileName: String;
+  Ini : TIniFile;
+  i:integer;
+  sl: TStringList;
+begin
+  try
+    FileName := ExtractFilePath(Application.ExeName) + RENAMES_FILE;
+    Ini := TIniFile.Create(FileName);
+    sl := TStringList.Create;
+    Ini.ReadSection('Renames',sl);
+    RenamesIds.Clear;
+    for i:=0 to sl.Count-1 do
+      RenamesIds.Add(StrToInt(sl[i]));
+    sl.Clear;
+    ini.ReadSectionValues('Renames',sl);
+    RenamesNames.Clear;
+    for i:=0 to sl.Count-1 do
+      RenamesNames.Add(MidStr(sl[i],1+Pos('=',sl[i]),99999));
+    sl.Free;
+    Ini.Free;
+  except
+    MainForm.AddMainLog(_('An error occured while loading the Renames file.'),Colors.Error);
+    RenamesIds.Clear;
+    RenamesNames.Clear;
+  end;
+end;
+
+procedure TMainForm.BattleListPopupMenuPopup(Sender: TObject);
+begin
+  VDTBattles.SetFocus;
+  if (VDTBattles.FocusedNode &lt;&gt; nil) and VDTBattles.Selected[VDTBattles.FocusedNode] then
+  begin
+    SelectedBattle := GetBattleFromNode(VDTBattles.FocusedNode);
+    ContextMenuSelectedClient := SelectedBattle.Clients[0];
+    ClientPopupMenuPopup(nil);
+    mnuBattleHost.Caption := ContextMenuSelectedClient.DisplayName;
+    mnuBattleDlMap.Enabled := Utility.MapList.IndexOf(SelectedBattle.Map) = -1;
+    mnuBattleDlMod.Enabled := Utility.ModList.IndexOf(SelectedBattle.ModName) = -1;
+  end;
+  mnuBattleHost.Visible := VDTBattles.FocusedNode &lt;&gt; nil;
+  mnuBattleAddToFilters.Visible := VDTBattles.FocusedNode &lt;&gt; nil;
+  mnuBattleDlMap.Visible := VDTBattles.FocusedNode &lt;&gt; nil;
+  mnuBattleDlMod.Visible := VDTBattles.FocusedNode &lt;&gt; nil;
+  mnuBattleHost.Visible := VDTBattles.FocusedNode &lt;&gt; nil;
+  mnuBattleAddToFilters.Visible := VDTBattles.FocusedNode &lt;&gt; nil;
+  if QuickJoinPanel.Visible then
+    mnuQuickJoinPanel.Caption := _('Hide Quick join panel')
+  else
+    mnuQuickJoinPanel.Caption := _('Show Quick join panel');
+
+  VDTBattles.Repaint;
+end;
+
+procedure TMainForm.ClientPopupMenuPopup(Sender: TObject);
+var
+  Client: TClient;
+  ClientGroup : TClientGroup;
+  i : Integer;
+  tmp,realIndex: integer;
+  cList: TList;
+begin
+
+  if ContextMenuSelectedClient = nil then // showing player context menu from the richedit
+  begin
+    if ClientsListBox.ItemIndex = -1 then Exit; // I don't think this can actually happen, since we must click in ListBox and so select an item
+      if lastActiveTab.Caption = LOCAL_TAB then
+        cList := AllClients
+      else
+        cList := lastActiveTab.Clients;
+
+      tmp := ClientsListBox.ItemIndex;
+      for i:=0 to cList.Count-1 do
+      begin
+        if TClient(cList[i]).Visible then Dec(tmp);
+        if tmp = -1 then break;
+      end;
+      realIndex := i;
+      if realIndex &gt; -1 then
+        Client := TClient(cList[realIndex])
+      else
+        AddMainLog('Error: Player not found in the global player list.',Colors.Error);
+  end
+  else
+    Client := ContextMenuSelectedClient;
+
+  ModerationSubmenuItem.Visible := Status.Me.GetAccess; // only moderators may see moderation menu!
+  MuteSubitemMenu.Visible := LeftStr(lastActiveTab.Caption,1) = '#';
+  mnuUnmute.Visible := LeftStr(lastActiveTab.Caption,1) = '#';
+
+  mnuPlayWith.Enabled := Client.GetBattleId &lt;&gt; -1;
+  mnuSelectBattle.Enabled := mnuPlayWith.Enabled;
+
+  ClientGroup := Client.GetGroup;
+
+  if ClientGroup &lt;&gt; nil then begin
+    mnuAddToGroup.Caption := _('Move to group');
+    mnuRemoveFromGroup.Enabled := True;
+  end
+  else
+  begin
+    mnuAddToGroup.Caption := _('Add to group');
+    mnuRemoveFromGroup.Enabled := False;
+  end;
+
+  mnuIgnore.Checked := IgnoreListForm.IgnoringUser(Client);
+
+  mnuManageGroups.Enabled := ClientGroups.Count &gt; 0;
+
+  for i:= mnuAddToGroup.Count-1 downto 2 do
+    mnuAddToGroup.Remove(mnuAddToGroup.Items[i]);
+
+  for i:=0 to ClientGroups.Count-1 do
+  begin
+    mnuAddToGroup.Add(TSpTBXItem.Create(mnuAddToGroup));
+    with mnuAddToGroup.Items[mnuAddToGroup.Count-1] as TSpTBXItem do
+    begin
+      Caption := TClientGroup(ClientGroups[i]).Name;
+      Tag := i;
+      OnClick := AddToGroupItemClick;
+    end;
+  end;
+
+  SelectedUserName := Client.Name;
+end;
+
 end.

Modified: Lobby/TASClient/ManageGroups.dfm
===================================================================
--- Lobby/TASClient/ManageGroups.dfm	2010-03-15 17:30:30 UTC (rev 7430)
+++ Lobby/TASClient/ManageGroups.dfm	2010-03-17 14:36:29 UTC (rev 7431)
@@ -1,6 +1,6 @@
 object ManageGroupsForm: TManageGroupsForm
-  Left = 395
-  Top = 240
+  Left = 457
+  Top = 625
   BorderIcons = [biSystemMenu]
   BorderStyle = bsSingle
   Caption = 'Manage groups'
@@ -153,9 +153,9 @@
         Caption = 'Replace rank :'
       end
       object ColorPanel: TPanel
-        Left = 208
+        Left = 232
         Top = 32
-        Width = 97
+        Width = 73
         Height = 21
         BevelOuter = bvNone
         BorderStyle = bsSingle
@@ -488,6 +488,14 @@
         TabOrder = 28
         OnClick = IgnoreCheckBoxClick
       end
+      object ColorCheckBox: TSpTBXCheckBox
+        Left = 208
+        Top = 36
+        Width = 14
+        Height = 15
+        TabOrder = 29
+        OnClick = ColorCheckBoxClick
+      end
     end
   end
 end

Modified: Lobby/TASClient/ManageGroups.pas
===================================================================
--- Lobby/TASClient/ManageGroups.pas	2010-03-15 17:30:30 UTC (rev 7430)
+++ Lobby/TASClient/ManageGroups.pas	2010-03-17 14:36:29 UTC (rev 7431)
@@ -49,6 +49,7 @@
     SpTBXLabel12: TSpTBXLabel;
     IgnoreCheckBox: TSpTBXCheckBox;
     Label2: TLabel;
+    ColorCheckBox: TSpTBXCheckBox;
     procedure FormShow(Sender: TObject);
     procedure cmbGroupsChange(Sender: TObject);
     procedure btRemoveClick(Sender: TObject);
@@ -78,6 +79,7 @@
     procedure lstClientsDragDrop(Sender, Source: TObject; X, Y: Integer);
     procedure lstClientsDragOver(Sender, Source: TObject; X, Y: Integer;
       State: TDragState; var Accept: Boolean);
+    procedure ColorCheckBoxClick(Sender: TObject);
   private
     { Private declarations }
   public
@@ -89,7 +91,8 @@
 
 implementation
 
-uses ColorPicker, LobbyScriptUnit, gnugettext, BattleFormUnit;
+uses ColorPicker, LobbyScriptUnit, gnugettext, BattleFormUnit,
+  PreferencesFormUnit;
 
 {$R *.dfm}
 
@@ -148,6 +151,7 @@
   ReplaceRankCmb.ItemIndex := TClientGroup(ClientGroups[cmbGroups.ItemIndex]).Rank;
   BalanceInSameTeamCheckBox.Checked := TClientGroup(ClientGroups[cmbGroups.ItemIndex]).BalanceInSameTeam;
   IgnoreCheckBox.Checked := TClientGroup(ClientGroups[cmbGroups.ItemIndex]).Ignore;
+  ColorCheckBox.Checked := TClientGroup(ClientGroups[cmbGroups.ItemIndex]).EnableColor;
 end;
 
 procedure TManageGroupsForm.btRemoveClick(Sender: TObject);
@@ -397,4 +401,11 @@
   Accept := (Source = MainForm.ClientsListBox) or (Source = BattleForm.VDTBattleClients);
 end;
 
+procedure TManageGroupsForm.ColorCheckBoxClick(Sender: TObject);
+begin
+  TClientGroup(ClientGroups[cmbGroups.ItemIndex]).EnableColor := ColorCheckBox.Checked;
+  if Preferences.SortStyle = 5 then
+    MainForm.ResortClientsLists;
+end;
+
 end.

Modified: Lobby/TASClient/MapListFormUnit.dfm
===================================================================
--- Lobby/TASClient/MapListFormUnit.dfm	2010-03-15 17:30:30 UTC (rev 7430)
+++ Lobby/TASClient/MapListFormUnit.dfm	2010-03-17 14:36:29 UTC (rev 7431)
@@ -1207,5 +1207,29 @@
     AutoHotkeys = maManual
     Left = 264
     Top = 24
+    object mnuNoSorting: TSpTBXItem
+      Caption = 'No sorting'
+      OnClick = SortStylePopupMenuItemClick
+    end
+    object mnuSortByName: TSpTBXItem
+      Tag = 1
+      Caption = 'By name'
+      OnClick = SortStylePopupMenuItemClick
+    end
+    object mnuSortByMapSize: TSpTBXItem
+      Tag = 2
+      Caption = 'By map size'
+      OnClick = SortStylePopupMenuItemClick
+    end
+    object mnuSortByAvgWind: TSpTBXItem
+      Tag = 5
+      Caption = 'By average wind'
+      OnClick = SortStylePopupMenuItemClick
+    end
+    object mnuSortByMaxMetal: TSpTBXItem
+      Tag = 6
+      Caption = 'By max metal'
+      OnClick = SortStylePopupMenuItemClick
+    end
   end
 end

Modified: Lobby/TASClient/MapListFormUnit.pas
===================================================================
--- Lobby/TASClient/MapListFormUnit.pas	2010-03-15 17:30:30 UTC (rev 7430)
+++ Lobby/TASClient/MapListFormUnit.pas	2010-03-17 14:36:29 UTC (rev 7431)
@@ -41,6 +41,11 @@
     txtSearch: TEdit;
     lblSearch: TSpTBXLabel;
     ScrollBox1: TScrollBox;
+    mnuNoSorting: TSpTBXItem;
+    mnuSortByAvgWind: TSpTBXItem;
+    mnuSortByMapSize: TSpTBXItem;
+    mnuSortByName: TSpTBXItem;
+    mnuSortByMaxMetal: TSpTBXItem;
 
     procedure CreateParams(var Params: TCreateParams); override;
     procedure ClearMapList;
@@ -51,7 +56,6 @@
     procedure SortMapList(SortStyle: Byte);
     procedure FilterMapList(s:String);
     procedure SortMapInList(Index: Integer; SortStyle: Byte);
-    procedure PopulateSortStylePopupMenu;
     procedure SortStylePopupMenuItemClick(Sender: TObject);
 
     procedure LoadAllMissingMinimaps; // this will load and cache minimaps for all maps for which we haven't loaded/cached minimap yet. Note that this process may take up several minutes!
@@ -861,7 +865,7 @@
   Maps := TList.Create;
   SortedMaps := TList.Create;
 
-  PopulateSortStylePopupMenu;
+  //PopulateSortStylePopupMenu;
 end;
 
 procedure TMapListForm.FormDestroy(Sender: TObject);
@@ -1131,7 +1135,7 @@
     // sort by map name:
     1: Result := AnsiCompareText(Map1.MapName, Map2.MapName);
     // sort by map size:
-    2: Result := Map1.MapInfo.Width * Map1.MapInfo.Height - Map2.MapInfo.Width * Map2.MapInfo.Height;
+    2: Result := (Map1.MapInfo.Width * Map1.MapInfo.Height - Map2.MapInfo.Width * Map2.MapInfo.Height);
     // sort by my grade:
     3: Result := Map2.MyGrade - Map1.MyGrade;
     // sort by global grade:
@@ -1141,7 +1145,10 @@
       globalGradeVotes2 := Round((Map2.GlobalGrade - 5)*Map2.TotalVotes);
       if globalGradeVotes1 = globalGradeVotes2 then Result := 0 else if globalGradeVotes1 &gt; globalGradeVotes2 then Result := -1 else Result := 1;
     end;
-    5: Result := Round((Map2.MapInfo.MaxWind+Map2.MapInfo.MinWind)/2) - Round((Map1.MapInfo.MaxWind+Map1.MapInfo.MinWind)/2);
+    // avg wind
+    5: Result := Round((Map1.MapInfo.MaxWind+Map1.MapInfo.MinWind)/2)-Round((Map2.MapInfo.MaxWind+Map2.MapInfo.MinWind)/2);
+    // max metal
+    6: Result := CompareValue(Map1.MapInfo.MaxMetal,Map2.MapInfo.MaxMetal);
   else
     Result := 0;
   end;
@@ -1155,34 +1162,18 @@
   SortStylePopupMenu.Popup(p.X, p.Y);
 end;
 
-procedure TMapListForm.PopulateSortStylePopupMenu;
-var
-  i: Integer;
-begin
-  SortStylePopupMenu.Items.Clear;
-  for i := 0 to High(MapSortStyleDescriptions) do
-  begin
-    SortStylePopupMenu.Items.Add(TSpTBXItem.Create(SortStylePopupMenu.Items.Owner));
-
-    with SortStylePopupMenu.Items[SortStylePopupMenu.Items.Count-1] as TSpTBXItem do
-    begin
-      Caption := MapSortStyleDescriptions[i];
-      Tag := i;
-      RadioItem := True;
-      OnClick := SortStylePopupMenuItemClick;
-    end;
-  end;
-end;
-
 procedure TMapListForm.SortStylePopupMenuItemClick(Sender: TObject);
 var
   i: Integer;
 begin
   Preferences.MapSortStyle := (Sender as TSpTBXItem).Tag;
 
-  BattleForm.SetRadioItem(SortStylePopupMenu, (Sender as TSpTBXItem).Tag);
-  SortLabel.Caption := MapSortStyleDescriptions[Preferences.MapSortStyle];
+  for i := 0 to SortStylePopupMenu.Items.Count-1 do
+    SortStylePopupMenu.Items[i].Checked := False;
+  (Sender as TSpTBXItem).Checked := True;
 
+  SortLabel.Caption := (Sender as TSpTBXItem).Caption;
+
   SortMapList(Preferences.MapSortStyle);
 end;
 
@@ -1225,8 +1216,33 @@
   i: integer;
 begin
   txtSearch.Text := '';
-  BattleForm.SetRadioItem(SortStylePopupMenu, Preferences.MapSortStyle);
-  SortLabel.Caption := TSpTBXItem(SortStylePopupMenu.Items[Preferences.MapSortStyle]).Caption;
+  case Preferences.MapSortStyle of
+    0:
+    begin
+      mnuNoSorting.Checked := True;
+      SortLabel.Caption := mnuNoSorting.Caption;
+    end;
+    1:
+    begin
+      mnuSortByName.Checked := True;
+      SortLabel.Caption := mnuSortByName.Caption;
+    end;
+    2:
+    begin
+      mnuSortByMapSize.Checked := True;
+      SortLabel.Caption := mnuSortByMapSize.Caption;
+    end;
+    5:
+    begin
+      mnuSortByAvgWind.Checked := True;
+      SortLabel.Caption := mnuSortByAvgWind.Caption;
+    end;
+    6:
+    begin
+      mnuSortByMaxMetal.Checked := True;
+      SortLabel.Caption := mnuSortByMaxMetal.Caption;
+    end;
+  end;
 
   FilterMapList('');
   txtSearch.SetFocus;

Modified: Lobby/TASClient/MenuFormUnit.pas
===================================================================
--- Lobby/TASClient/MenuFormUnit.pas	2010-03-15 17:30:30 UTC (rev 7430)
+++ Lobby/TASClient/MenuFormUnit.pas	2010-03-17 14:36:29 UTC (rev 7431)
@@ -130,15 +130,6 @@
     
     CampaignList: TList;
 
-    MePlayer:
-    record
-      Id: integer;
-      Team: integer;
-      Side: integer;
-      StartPosX: double;
-      StartPosY: double;
-      Handicap: integer;
-    end;
     AIPlayerList: TList;
 
     Process: // we need this information when we launch game exe
@@ -157,6 +148,17 @@
     function getBotIndex(id: integer): integer;
     procedure LoadCampaigns;
   public
+    MePlayer:
+    record
+      Id: integer;
+      Name: string;
+      Team: integer;
+      Side: integer;
+      StartPosX: double;
+      StartPosY: double;
+      Handicap: integer;
+    end;
+    
     htmlBrowser: TWebBrowserWrapper;
     htmlContainer: TWBContainer;
 
@@ -501,6 +503,7 @@
   BrowseHistory := TStack.Create;
   skinList := TStringList.Create;
   MenuLoaded := False;
+  MePlayer.Name := _('Me');
 
   GameMode := -1;
 
@@ -526,8 +529,8 @@
   htmlBrowser.OnNewWindow2 := htmlBrowserControlNewWindow2;
 
   htmlBrowser.Show3DBorder := false;
-  htmlBrowser.AllowTextSelection := false;
-  htmlBrowser.UseCustomCtxMenu := true;
+  htmlBrowser.AllowTextSelection := RunningWithMainMenuDev;
+  htmlBrowser.UseCustomCtxMenu := not RunningWithMainMenuDev;
   htmlBrowser.ShowScrollBars := false;
   htmlBrowser.Silent := not RunningWithMainMenuDev;
   htmlBrowser.Offline := true;
@@ -684,6 +687,7 @@
   htmlCode := Misc.ReadFile2(CurrentPath+fileName);
 
   htmlCode := StringReplace(htmlCode,'[SpringVersion]',springExeVersion,[rfIgnoreCase,rfReplaceAll]);
+  htmlCode := StringReplace(htmlCode,'[PlayerName]',MePlayer.Name,[rfIgnoreCase,rfReplaceAll]);
 
   if pageType = Main then // [SKINLIST]
   begin
@@ -911,9 +915,9 @@
     templateStr := ReadFile2(CurrentPath+'playerItemBox.html');
     tmp := templateStr;
     tmp := StringReplace(tmp,'[SideList]',varHtmlCode2,[rfReplaceAll,rfIgnoreCase]);
+    tmp := StringReplace(tmp,'[PlayerName]',MePlayer.Name,[rfReplaceAll,rfIgnoreCase]);
     tmp := StringReplace(tmp,'[PlayerId]','1',[rfReplaceAll,rfIgnoreCase]);
     tmp := StringReplace(tmp,'[PlayerUniqueId]','0',[rfReplaceAll,rfIgnoreCase]);
-    tmp := StringReplace(tmp,'[PlayerName]','Me',[rfReplaceAll,rfIgnoreCase]);
     tmp := StringReplace(tmp,'[SelectedSide]',IntToStr(MePlayer.Side),[rfReplaceAll,rfIgnoreCase]);
     tmp := StringReplace(tmp,'[SelectedId]',IntToStr(MePlayer.Id),[rfReplaceAll,rfIgnoreCase]);
     tmp := StringReplace(tmp,'[SelectedTeam]',IntToStr(MePlayer.Team),[rfReplaceAll,rfIgnoreCase]);
@@ -947,7 +951,7 @@
     tmp := StringReplace(tmp,'[SideList]',varHtmlCode2,[rfReplaceAll,rfIgnoreCase]);
     tmp := StringReplace(tmp,'[PlayerId]','1',[rfReplaceAll,rfIgnoreCase]);
     tmp := StringReplace(tmp,'[PlayerUniqueId]','0',[rfReplaceAll,rfIgnoreCase]);
-    tmp := StringReplace(tmp,'[PlayerName]','Me',[rfReplaceAll,rfIgnoreCase]);
+    tmp := StringReplace(tmp,'[PlayerName]',MePlayer.Name,[rfReplaceAll,rfIgnoreCase]);
     tmp := StringReplace(tmp,'[SelectedSide]',IntToStr(MePlayer.Side),[rfReplaceAll,rfIgnoreCase]);
     tmp := StringReplace(tmp,'[SelectedId]',IntToStr(MePlayer.Id),[rfReplaceAll,rfIgnoreCase]);
     tmp := StringReplace(tmp,'[SelectedTeam]',IntToStr(MePlayer.Team),[rfReplaceAll,rfIgnoreCase]);
@@ -1815,6 +1819,11 @@
       sl.Free;
       Exit;
     end;
+    if LeftStr(LowerCase(command),13) = 'changemyname:' then
+    begin
+      MePlayer.Name := MidStr(command,14,99999);
+      Exit;
+    end;
     if LeftStr(LowerCase(command),7) = 'addbot:' then
     begin
       if freeIds.Count = 0 then Exit; // 16 players/bots max

Modified: Lobby/TASClient/Minimap3DPreviewUnit.pas
===================================================================
--- Lobby/TASClient/Minimap3DPreviewUnit.pas	2010-03-15 17:30:30 UTC (rev 7430)
+++ Lobby/TASClient/Minimap3DPreviewUnit.pas	2010-03-17 14:36:29 UTC (rev 7431)
@@ -44,6 +44,8 @@
 
 implementation
 
+uses BattleFormUnit, MapListFormUnit;
+
 {$R *.dfm}
 
 procedure TMinimap3DPreview.GLSceneViewerMouseDown(Sender: TObject;
@@ -93,6 +95,14 @@
     my:=y;
     Exit;
   end;
+  if (ssRight in Shift) and (ssCtrl in Shift) then
+  begin
+    Minimap.Scale.Z := Minimap.Scale.Z - (my-y)/10000;
+    Water.Position.Z := 128*Minimap.Scale.Z+256*Minimap.Scale.Z*GetMapItem(BattleForm.CurrentMapIndex).MinHeight/(GetMapItem(BattleForm.CurrentMapIndex).MaxHeight-GetMapItem(BattleForm.CurrentMapIndex).MinHeight);
+    mx:=x;
+    my:=y;
+    Exit;
+  end;
   if ssRight in Shift then
   begin
     if ((Camera.DistanceToTarget &gt; 30) or (my-y &lt; 0)) and ((Camera.DistanceToTarget &lt; 150) or (my-y &gt; 0)) then

Modified: Lobby/TASClient/PreferencesFormUnit.pas
===================================================================
--- Lobby/TASClient/PreferencesFormUnit.pas	2010-03-15 17:30:30 UTC (rev 7430)
+++ Lobby/TASClient/PreferencesFormUnit.pas	2010-03-17 14:36:29 UTC (rev 7431)
@@ -335,18 +335,8 @@
 
   ServerList: array of TServerListItem;
 
-  // note: you shouldn't change order of sort styles or certain parts of code may not work anymore! (e.g.: when we receive MAPGRADES command, we sort map list only if sorting style is set to &quot;sort by global grade&quot;)
-  MapSortStyleDescriptions: array[0..5] of WideString = (
-    'No sorting',
-    'By name',
-    'By map size',
-    'By my grade',
-    'By global grade',
-    'By average wind'
-  );
+  implementation
 
-implementation
-
 uses Misc, ShellAPI, Registry, BattleFormUnit, HostBattleFormUnit, Math,
   NotificationsUnit, PerformFormUnit, HighlightingUnit,
   NewAccountUnit, IgnoreListUnit, MapListFormUnit, ColorsPreferenceUnit,
@@ -354,7 +344,7 @@
   SpringDownloaderFormUnit, LogonFormUnit, TipsFormUnit,
   TemplateEditorFormUnit, SpringSettingsProfileFormUnit, gnugettext,
   AutoTeamsUnit, ChannelsListFormUnit, AutoJoinFormUnit, InitWaitFormUnit,
-  DisableUnitsFormUnit;
+  DisableUnitsFormUnit, MenuFormUnit;
 
 {$R *.dfm}
 
@@ -572,6 +562,9 @@
         ChannelsListForm.VDTChannels.Header.SortDirection := sdDescending;
     except
     end;
+
+    try MenuForm.MePlayer.Name := Misc.GetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\MenuForm', 'PlayerName'); except end;
+
     ReadPreferencesRecordFromRegistry(Preferences);
   except
   end;
@@ -684,6 +677,11 @@
     else
       Misc.SetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\ChannelsList', 'ChannelsSortDirection', rdInteger, 1);
 
+    try
+      Misc.SetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\MenuForm', 'PlayerName', rdString, MenuForm.MePlayer.Name);
+    except
+    end;
+
     // write custom team colors to registry:
     for i := 0 to High(TeamColors) do
       Misc.SetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\TeamColors', 'Color' + IntToStr(i), rdInteger, TeamColors[i]);

Modified: Lobby/TASClient/Python/api.txt
===================================================================
--- Lobby/TASClient/Python/api.txt	2010-03-15 17:30:30 UTC (rev 7430)
+++ Lobby/TASClient/Python/api.txt	2010-03-17 14:36:29 UTC (rev 7431)
@@ -133,6 +133,8 @@
 	Default event handler : TEvent(Sender)
 - SetBattleVisible(battleId, visible)
 	allow a script to hide a battle even if the filters show it
+- SetUserDisplayName(userId, displayName)
+	change the user display name
 - ExecMethod(componentName,methodName,argumentList)
 	allow you to execute a published method (mostly control events functions)
 	check the TASClient sources to get the list of functions (ex: ExecMethod('MainForm','mnuPlaynowClick',()) )

Modified: Lobby/TASClient/TASClient.dof
===================================================================
--- Lobby/TASClient/TASClient.dof	2010-03-15 17:30:30 UTC (rev 7430)
+++ Lobby/TASClient/TASClient.dof	2010-03-17 14:36:29 UTC (rev 7431)
@@ -113,9 +113,9 @@
 IncludeVerInfo=1
 AutoIncBuild=1
 MajorVer=0
-MinorVer=69
+MinorVer=70
 Release=0
-Build=828
+Build=830
 Debug=0
 PreRelease=0
 Special=0
@@ -126,7 +126,7 @@
 [Version Info Keys]
 CompanyName=
 FileDescription=Spring RTS Engine lobby client
-FileVersion=0.69.0.828
+FileVersion=0.70.0.830
 InternalName=
 LegalCopyright=
 LegalTrademarks=

Modified: Lobby/TASClient/TASClient.dpr
===================================================================
--- Lobby/TASClient/TASClient.dpr	2010-03-15 17:30:30 UTC (rev 7430)
+++ Lobby/TASClient/TASClient.dpr	2010-03-17 14:36:29 UTC (rev 7431)
@@ -142,8 +142,8 @@
   while i &lt;= ParamCount do
   begin
     MainUnit.RunningUnderWine := MainUnit.RunningUnderWine or (UpperCase(ParamStr(i)) = '-WINE');
-    MainUnit.RunningWithMainMenu := MainUnit.RunningWithMainMenu or (UpperCase(ParamStr(i)) = '-MENU');
     MainUnit.RunningWithMainMenuDev := MainUnit.RunningWithMainMenuDev or (UpperCase(ParamStr(i)) = '-MENUDEV');
+    MainUnit.RunningWithMainMenu := MainUnit.RunningWithMainMenu or MainUnit.RunningWithMainMenuDev or (UpperCase(ParamStr(i)) = '-MENU');
     MainUnit.Debug.Enabled := MainUnit.Debug.Enabled or (UpperCase(ParamStr(i)) = '-DEBUG');
     MainUnit.Debug.Log := MainUnit.Debug.Log or (UpperCase(ParamStr(i)) = '-LOG');
     MainUnit.NO3D := MainUnit.NO3D or (UpperCase(ParamStr(i)) = '-NO3D');

Modified: Lobby/TASClient/TASClient.res
===================================================================
(Binary files differ)

Modified: Lobby/TASClient/Utility.pas
===================================================================
--- Lobby/TASClient/Utility.pas	2010-03-15 17:30:30 UTC (rev 7430)
+++ Lobby/TASClient/Utility.pas	2010-03-17 14:36:29 UTC (rev 7431)
@@ -398,7 +398,7 @@
 //*** debug     MainForm.AddMainLog(MapName + ' ... ' + IntToStr(c) + ':' + MapCheckSums[MapCheckSums.Count-1], Colors.Info);
   end;
   MapListForm.SortedMaps.Assign(MapListForm.Maps);
-  MapListForm.SortStylePopupMenu.Items[Preferences.MapSortStyle].OnClick(MapListForm.SortStylePopupMenu.Items[Preferences.MapSortStyle]); // this will also sort map list
+  MapListForm.SortMapList(Preferences.MapSortStyle);
   BattleForm.ChangeMapToNoMap(''); // we have to set CurrentMapIndex to -1 or else ChangeMap method may not change map later on if old map index collides with new one!
   BattleForm.PopulatePopupMenuMapList;
 


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002200.html">[Taspring-linux-commit] r7430 - Lobby/TASClient
</A></li>
	<LI>Next message: <A HREF="002202.html">[Taspring-linux-commit] r7432 - Lobby/TASClient
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2201">[ date ]</a>
              <a href="thread.html#2201">[ thread ]</a>
              <a href="subject.html#2201">[ subject ]</a>
              <a href="author.html#2201">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
