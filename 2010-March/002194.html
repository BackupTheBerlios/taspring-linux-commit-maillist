<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r7424 - in Lobby/TASClient: . Python/scripts
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2010-March/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r7424%20-%20in%20Lobby/TASClient%3A%20.%20Python/scripts&In-Reply-To=%3C20100305002037.ACC6229CC3%40it-l.eu%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002193.html">
   <LINK REL="Next"  HREF="002195.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r7424 - in Lobby/TASClient: . Python/scripts</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r7424%20-%20in%20Lobby/TASClient%3A%20.%20Python/scripts&In-Reply-To=%3C20100305002037.ACC6229CC3%40it-l.eu%3E"
       TITLE="[Taspring-linux-commit] r7424 - in Lobby/TASClient: . Python/scripts">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Fri Mar  5 01:20:37 CET 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="002193.html">[Taspring-linux-commit] r7423 - in Lobby/TASClient: .	LobbyComponents/DockPanel Python Python/scripts
</A></li>
        <LI>Next message: <A HREF="002195.html">[Taspring-linux-commit] r7425 - Lobby/TASClient
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2194">[ date ]</a>
              <a href="thread.html#2194">[ thread ]</a>
              <a href="subject.html#2194">[ subject ]</a>
              <a href="author.html#2194">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: satirik
Date: 2010-03-05 01:20:36 +0100 (Fri, 05 Mar 2010)
New Revision: 7424

Added:
   Lobby/TASClient/Python/scripts/forumIt.py
Modified:
   Lobby/TASClient/AutoJoinFormUnit.dfm
   Lobby/TASClient/AutoJoinFormUnit.pas
   Lobby/TASClient/HostBattleFormUnit.dfm
   Lobby/TASClient/MainUnit.dfm
   Lobby/TASClient/MainUnit.pas
   Lobby/TASClient/ReplaysUnit.dfm
   Lobby/TASClient/ReplaysUnit.pas
   Lobby/TASClient/SetStringsUnit.dfm
   Lobby/TASClient/TASClient.dof
   Lobby/TASClient/TASClient.res
Log:
* PYTHON: new forumIt.py script : type &quot;/forum request&quot; to search for &quot;request&quot; on the forum
* Fixed a bug when sorting by ascending players in autojoin (joining a battle changes its number of players, when sorting by ascending players it was joining the first two battles in loop)
* all battles/replays text filters are now using regular expression, players filtering now only use regular expression
* you can now edit a text filter value directly in the list (for battles or replays)
* VirtualTreeView updated to latest version
* You can now save Autojoin presets and switch from one to another


Modified: Lobby/TASClient/AutoJoinFormUnit.dfm
===================================================================
--- Lobby/TASClient/AutoJoinFormUnit.dfm	2010-03-03 23:32:51 UTC (rev 7423)
+++ Lobby/TASClient/AutoJoinFormUnit.dfm	2010-03-05 00:20:36 UTC (rev 7424)
@@ -1,9 +1,9 @@
 object AutoJoinForm: TAutoJoinForm
-  Left = 382
-  Top = 205
+  Left = 335
+  Top = 253
   BorderStyle = bsSingle
   Caption = 'AutoJoin'
-  ClientHeight = 482
+  ClientHeight = 565
   ClientWidth = 698
   Color = clBtnFace
   Constraints.MaxHeight = 1150
@@ -23,11 +23,11 @@
     Left = 0
     Top = 0
     Width = 698
-    Height = 482
+    Height = 565
     Caption = 'AutoJoin'
     FixedSize = True
     Options.Maximize = False
-    object SpTBXGroupBox1: TSpTBXGroupBox
+    object gbAutoPlay: TSpTBXGroupBox
       Left = 192
       Top = 40
       Width = 497
@@ -44,6 +44,7 @@
         Height = 145
         Anchors = [akLeft, akTop, akRight, akBottom]
         Header.AutoSizeIndex = 0
+        Header.DefaultHeight = 17
         Header.Font.Charset = DEFAULT_CHARSET
         Header.Font.Color = clWindowText
         Header.Font.Height = -11
@@ -124,7 +125,7 @@
         LinkFont.Style = [fsUnderline]
       end
     end
-    object SpTBXGroupBox2: TSpTBXGroupBox
+    object gbAddPreset: TSpTBXGroupBox
       Left = 8
       Top = 40
       Width = 177
@@ -241,7 +242,7 @@
         LinkFont.Style = [fsUnderline]
       end
     end
-    object SpTBXGroupBox3: TSpTBXGroupBox
+    object gbAutoSpec: TSpTBXGroupBox
       Left = 192
       Top = 216
       Width = 497
@@ -258,6 +259,7 @@
         Height = 145
         Anchors = [akLeft, akTop, akRight, akBottom]
         Header.AutoSizeIndex = 0
+        Header.DefaultHeight = 17
         Header.Font.Charset = DEFAULT_CHARSET
         Header.Font.Color = clWindowText
         Header.Font.Height = -11
@@ -340,7 +342,7 @@
     end
     object btClose: TSpTBXButton
       Left = 313
-      Top = 448
+      Top = 528
       Width = 73
       Height = 25
       Caption = 'Close'
@@ -352,11 +354,11 @@
       LinkFont.Name = 'MS Sans Serif'
       LinkFont.Style = [fsUnderline]
     end
-    object SpTBXGroupBox4: TSpTBXGroupBox
+    object gbOptions: TSpTBXGroupBox
       Left = 8
       Top = 392
-      Width = 681
-      Height = 49
+      Width = 321
+      Height = 129
       Caption = 'Options'
       TabOrder = 5
       object chkKeepLookingAfterJoining: TSpTBXCheckBox
@@ -368,5 +370,81 @@
         TabOrder = 0
       end
     end
+    object gbPresets: TSpTBXGroupBox
+      Left = 336
+      Top = 392
+      Width = 353
+      Height = 129
+      Caption = 'Presets'
+      Font.Charset = DEFAULT_CHARSET
+      Font.Color = clWindowText
+      Font.Height = -11
+      Font.Name = 'MS Sans Serif'
+      Font.Style = []
+      ParentFont = False
+      TabOrder = 6
+      object btSavePreset: TSpTBXButton
+        Left = 8
+        Top = 40
+        Width = 97
+        Height = 25
+        Caption = 'Save'
+        TabOrder = 0
+        OnClick = btSavePresetClick
+        LinkFont.Charset = DEFAULT_CHARSET
+        LinkFont.Color = clBlue
+        LinkFont.Height = -11
+        LinkFont.Name = 'MS Sans Serif'
+        LinkFont.Style = [fsUnderline]
+      end
+      object btDeletePreset: TSpTBXButton
+        Left = 8
+        Top = 72
+        Width = 97
+        Height = 25
+        Caption = 'Delete'
+        TabOrder = 1
+        OnClick = btDeletePresetClick
+        LinkFont.Charset = DEFAULT_CHARSET
+        LinkFont.Color = clBlue
+        LinkFont.Height = -11
+        LinkFont.Name = 'MS Sans Serif'
+        LinkFont.Style = [fsUnderline]
+      end
+      object txtPresetName: TSpTBXEdit
+        Left = 8
+        Top = 16
+        Width = 97
+        Height = 21
+        TabOrder = 2
+        Text = 'preset name'
+      end
+      object btClearPresets: TSpTBXButton
+        Left = 8
+        Top = 96
+        Width = 97
+        Height = 25
+        Caption = 'Clear'
+        TabOrder = 3
+        OnClick = btClearPresetsClick
+        LinkFont.Charset = DEFAULT_CHARSET
+        LinkFont.Color = clBlue
+        LinkFont.Height = -11
+        LinkFont.Name = 'MS Sans Serif'
+        LinkFont.Style = [fsUnderline]
+      end
+      object lstPresetList: TSpTBXListBox
+        Left = 112
+        Top = 16
+        Width = 233
+        Height = 105
+        ItemHeight = 16
+        Items.Strings = (
+          'current')
+        TabOrder = 4
+        OnClick = lstPresetListClick
+        OnDblClick = lstPresetListDblClick
+      end
+    end
   end
 end

Modified: Lobby/TASClient/AutoJoinFormUnit.pas
===================================================================
--- Lobby/TASClient/AutoJoinFormUnit.pas	2010-03-03 23:32:51 UTC (rev 7423)
+++ Lobby/TASClient/AutoJoinFormUnit.pas	2010-03-05 00:20:36 UTC (rev 7424)
@@ -5,7 +5,7 @@
 uses
   Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
   Dialogs, TBXDkPanels, SpTBXControls, VirtualTrees, SpTBXItem, StdCtrls,
-  TntStdCtrls, SpTBXEditors, IniFiles;
+  TntStdCtrls, SpTBXEditors, IniFiles, StrUtils;
 
 type
   TAutoJoinPresetItemList =
@@ -17,12 +17,12 @@
   PAutoJoinPresetItemList = ^TAutoJoinPresetItemList;
   TAutoJoinForm = class(TForm)
     SpTBXTitleBar1: TSpTBXTitleBar;
-    SpTBXGroupBox1: TSpTBXGroupBox;
+    gbAutoPlay: TSpTBXGroupBox;
     VSTAutoplayPresetList: TVirtualStringTree;
     btAutoplayPriorityUp: TSpTBXButton;
     btAutoplayPriorityDown: TSpTBXButton;
     btAutoplayRemovePreset: TSpTBXButton;
-    SpTBXGroupBox2: TSpTBXGroupBox;
+    gbAddPreset: TSpTBXGroupBox;
     SpTBXLabel1: TSpTBXLabel;
     cmbFilterPresetList: TSpTBXComboBox;
     SpTBXLabel2: TSpTBXLabel;
@@ -30,15 +30,21 @@
     SpTBXLabel3: TSpTBXLabel;
     cmbSortDir: TSpTBXComboBox;
     btAddPresetToAutoplay: TSpTBXButton;
-    SpTBXGroupBox3: TSpTBXGroupBox;
+    gbAutoSpec: TSpTBXGroupBox;
     VSTAutospecPresetList: TVirtualStringTree;
     btAutospecPriorityUp: TSpTBXButton;
     btAutospecPriorityDown: TSpTBXButton;
     btAutospecRemovePreset: TSpTBXButton;
     btAddPresetToAutospec: TSpTBXButton;
     btClose: TSpTBXButton;
-    SpTBXGroupBox4: TSpTBXGroupBox;
+    gbOptions: TSpTBXGroupBox;
     chkKeepLookingAfterJoining: TSpTBXCheckBox;
+    gbPresets: TSpTBXGroupBox;
+    btSavePreset: TSpTBXButton;
+    btDeletePreset: TSpTBXButton;
+    txtPresetName: TSpTBXEdit;
+    btClearPresets: TSpTBXButton;
+    lstPresetList: TSpTBXListBox;
     procedure FormCreate(Sender: TObject);
     procedure FormShow(Sender: TObject);
     procedure btAddPresetToAutoplayClick(Sender: TObject);
@@ -56,14 +62,21 @@
     procedure btAutospecPriorityDownClick(Sender: TObject);
     procedure btAutoplayRemovePresetClick(Sender: TObject);
     procedure btAutospecRemovePresetClick(Sender: TObject);
+    procedure btSavePresetClick(Sender: TObject);
+    procedure btDeletePresetClick(Sender: TObject);
+    procedure btClearPresetsClick(Sender: TObject);
+    procedure lstPresetListClick(Sender: TObject);
+    procedure lstPresetListDblClick(Sender: TObject);
   private
     { Private declarations }
   public
     autoPlayPresetList: TList;
     autoSpecPresetList: TList;
 
-    procedure SaveAutoJoinPresetLists;
-    procedure LoadAutoJoinPresetLists;
+    procedure SaveAutoJoinPreset(FileName: string);
+    procedure LoadAutoJoinPreset(FileName: string);
+    procedure LoadAutoJoinPresets;
+    procedure initPresets;
   end;
 
 var
@@ -82,8 +95,7 @@
   if not SpTBXTitleBar1.Active then
     RemoveSpTBXTitleBarMarges(self);
 
-  autoPlayPresetList := TList.Create;
-  autoSpecPresetList := TList.Create;
+  initPresets;
 end;
 
 procedure TAutoJoinForm.FormShow(Sender: TObject);
@@ -257,18 +269,17 @@
   VSTAutospecPresetList.Refresh;
 end;
 
-procedure TAutoJoinForm.LoadAutoJoinPresetLists;
+procedure TAutoJoinForm.LoadAutoJoinPreset(FileName: string);
 var
   Ini : TIniFile;
   i:integer;
-  FileName: String;
   newPresetItem: PAutoJoinPresetItemList;
 begin
-  FileName := ExtractFilePath(Application.ExeName) + AUTOJOIN_SETTINGS;
   Ini := TIniFile.Create(FileName);
   autoPlayPresetList.Clear;
   autoSpecPresetList.Clear;
   VSTAutoplayPresetList.Clear;
+  VSTAutospecPresetList.Clear;
   i := 0;
   while Ini.ValueExists('AutoPlay', 'PresetName_'+IntToStr(i)) do
   begin
@@ -295,14 +306,12 @@
   VSTAutospecPresetList.Refresh;
 end;
 
-procedure TAutoJoinForm.SaveAutoJoinPresetLists;
+procedure TAutoJoinForm.SaveAutoJoinPreset(FileName: string);
 var
   Ini : TIniFile;
   i:integer;
-  FileName: String;
 begin
   try
-    FileName := ExtractFilePath(Application.ExeName) + AUTOJOIN_SETTINGS;
     if FileExists(FileName) then
       DeleteFile(FileName);
     Ini := TIniFile.Create(FileName);
@@ -324,5 +333,86 @@
   end;
 end;
 
+procedure TAutoJoinForm.btSavePresetClick(Sender: TObject);
+begin
+  if lstPresetList.Items.IndexOf(txtPresetName.Text) &gt;= 0 then
+  begin
+    if MessageDlg(_('A preset with this name already exists, do you want to replace it ?'),mtWarning,[mbYes, mbNo],0) = mrNo then
+      Exit;
+    lstPresetList.ItemIndex := lstPresetList.Items.IndexOf(txtPresetName.Text);
+  end
+  else
+  begin
+    lstPresetList.Items.Add(txtPresetName.Text);
+    lstPresetList.ItemIndex := lstPresetList.Count-1;
+  end;
+
+  SaveAutoJoinPreset(AUTOJOIN_PRESETS_FOLDER + '\'+txtPresetName.Text+'.ini');
+end;
+
+procedure TAutoJoinForm.btDeletePresetClick(Sender: TObject);
+begin
+  if lstPresetList.ItemIndex = 0 then Exit;
+  DeleteFile(AUTOJOIN_PRESETS_FOLDER + '\' + lstPresetList.Items[lstPresetList.ItemIndex] + '.ini');
+  lstPresetList.Items.Delete(lstPresetList.ItemIndex);
+  lstPresetList.Selected[0] := true;
+end;
+
+procedure TAutoJoinForm.btClearPresetsClick(Sender: TObject);
+var
+  i:integer;
+begin
+  for i:=lstPresetList.Count-1 downto 1 do
+  begin
+    DeleteFile(AUTOJOIN_PRESETS_FOLDER + '\' + lstPresetList.Items[i] + '.ini');
+    lstPresetList.Items.Delete(i);
+  end;
+  lstPresetList.Selected[0] := true;
+end;
+
+procedure TAutoJoinForm.lstPresetListClick(Sender: TObject);
+begin
+  if (lstPresetList.ItemIndex = 0) then Exit;
+  txtPresetName.Text := lstPresetList.Items[lstPresetList.ItemIndex]
+end;
+
+procedure TAutoJoinForm.lstPresetListDblClick(Sender: TObject);
+begin
+  if (lstPresetList.ItemIndex = 0) or not FileExists(AUTOJOIN_PRESETS_FOLDER + '\' + lstPresetList.Items[lstPresetList.ItemIndex] + '.ini') then Exit;
+  LoadAutoJoinPreset(AUTOJOIN_PRESETS_FOLDER + '\' + lstPresetList.Items[lstPresetList.ItemIndex] + '.ini');
+  VSTAutoplayPresetList.Refresh;
+  VSTAutospecPresetList.Refresh;
+end;
+
+procedure TAutoJoinForm.LoadAutoJoinPresets;
+var
+  FileAttrs: Integer;
+  sr: TSearchRec;
+begin
+  FileAttrs := faAnyFile;
+  if FindFirst(AUTOJOIN_PRESETS_FOLDER + '\*.ini', FileAttrs, sr) = 0 then
+  begin
+    repeat
+      if (sr.Name &lt;&gt; '.') and (sr.Name &lt;&gt; '..') and (sr.Name &lt;&gt; 'current.ini') then
+      begin
+        lstPresetList.Items.Add(LeftStr(''+sr.Name,Length(''+sr.Name)-4));
+      end;
+    until FindNext(sr) &lt;&gt; 0;
+    FindClose(sr);
+  end;
+end;
+
+procedure TAutoJoinForm.initPresets;
+begin
+  autoPlayPresetList := TList.Create;
+  autoSpecPresetList := TList.Create;
+
+  LoadAutoJoinPreset(AUTOJOIN_PRESETS_FOLDER + '\current.ini');
+  lstPresetList.Selected[0] := true;
+  LoadAutoJoinPresets;
+end;
+
 end.
 
+
+

Modified: Lobby/TASClient/HostBattleFormUnit.dfm
===================================================================
--- Lobby/TASClient/HostBattleFormUnit.dfm	2010-03-03 23:32:51 UTC (rev 7423)
+++ Lobby/TASClient/HostBattleFormUnit.dfm	2010-03-05 00:20:36 UTC (rev 7424)
@@ -6,8 +6,8 @@
   ClientHeight = 380
   ClientWidth = 331
   Color = clBtnFace
-  Constraints.MaxHeight = 1000
-  Constraints.MaxWidth = 1680
+  Constraints.MaxHeight = 1150
+  Constraints.MaxWidth = 1920
   Font.Charset = DEFAULT_CHARSET
   Font.Color = clWindowText
   Font.Height = -11
@@ -318,7 +318,7 @@
     Top = 312
     object Host1: TMenuItem
       AutoHotkeys = maAutomatic
-      Caption = 'Host'
+      Caption = 'Host a game'
       Checked = True
       RadioItem = True
       OnClick = Host1Click
@@ -331,7 +331,7 @@
     end
     object HostReplay1: TMenuItem
       AutoHotkeys = maAutomatic
-      Caption = 'Host Replay'
+      Caption = 'Host a replay'
       RadioItem = True
       OnClick = HostReplay1Click
     end

Modified: Lobby/TASClient/MainUnit.dfm
===================================================================
--- Lobby/TASClient/MainUnit.dfm	2010-03-03 23:32:51 UTC (rev 7423)
+++ Lobby/TASClient/MainUnit.dfm	2010-03-05 00:20:36 UTC (rev 7424)
@@ -1,6 +1,6 @@
 object MainForm: TMainForm
-  Left = 687
-  Top = 93
+  Left = 547
+  Top = 543
   Width = 847
   Height = 521
   Caption = '.'
@@ -269,12 +269,10 @@
               Top = 0
               Width = 145
               Height = 21
-              Hint = 
-                'Simple filtering : separate keywords by a space. Regular express' +
-                'ion filtering : re=my_regular_expression'
+              HelpType = htKeyword
               Anchors = [akLeft, akTop, akRight]
               ParentShowHint = False
-              ShowHint = True
+              ShowHint = False
               TabOrder = 1
               OnChange = PlayerFiltersTextboxChange
             end
@@ -474,6 +472,7 @@
             Font.Name = 'MS Sans Serif'
             Font.Style = []
             Header.AutoSizeIndex = 8
+            Header.DefaultHeight = 17
             Header.Font.Charset = DEFAULT_CHARSET
             Header.Font.Color = clWindowText
             Header.Font.Height = -11
@@ -597,125 +596,21 @@
               Height = 169
               Align = alClient
               Color = clBtnFace
-              ActiveTabIndex = 0
+              ActiveTabIndex = 1
               TabPosition = ttpBottom
               ThemeType = tttNone
               HiddenItems = &lt;&gt;
               object SpTBXTabItem1: TSpTBXTabItem
                 Caption = 'Filters'
-                Checked = True
                 TabPosition = ttpBottom
                 ThemeType = tttNone
               end
               object SpTBXTabItem2: TSpTBXTabItem
                 Caption = 'Presets'
+                Checked = True
                 TabPosition = ttpBottom
                 ThemeType = tttNone
               end
-              object SpTBXTabSheet2: TSpTBXTabSheet
-                Left = 0
-                Top = 0
-                Width = 819
-                Height = 146
-                Caption = 'Presets'
-                ImageIndex = -1
-                Item = SpTBXTabItem2
-                TabControl = FiltersTabs
-                DesignSize = (
-                  819
-                  146)
-                TabItem = 'SpTBXTabItem2'
-                object PresetListbox: TSpTBXListBox
-                  Left = 152
-                  Top = 26
-                  Width = 866
-                  Height = 113
-                  Anchors = [akLeft, akTop, akRight]
-                  ItemHeight = 16
-                  Items.Strings = (
-                    'current')
-                  TabOrder = 0
-                  OnClick = PresetListboxClick
-                  OnDblClick = PresetListboxDblClick
-                end
-                object SpTBXLabel3: TSpTBXLabel
-                  Left = 152
-                  Top = 8
-                  Width = 64
-                  Height = 16
-                  Caption = 'Preset list :'
-                  Font.Charset = DEFAULT_CHARSET
-                  Font.Color = clWindowText
-                  Font.Height = -13
-                  Font.Name = 'MS Sans Serif'
-                  Font.Style = []
-                  ParentFont = False
-                  LinkFont.Charset = DEFAULT_CHARSET
-                  LinkFont.Color = clBlue
-                  LinkFont.Height = -11
-                  LinkFont.Name = 'MS Sans Serif'
-                  LinkFont.Style = [fsUnderline]
-                end
-                object SpTBXGroupBox1: TSpTBXGroupBox
-                  Left = 8
-                  Top = 8
-                  Width = 137
-                  Height = 129
-                  Caption = 'Options'
-                  TabOrder = 2
-                  TBXStyleBackground = True
-                  object btDeletePreset: TSpTBXButton
-                    Left = 8
-                    Top = 72
-                    Width = 121
-                    Height = 25
-                    Caption = 'Delete'
-                    TabOrder = 1
-                    OnClick = btDeletePresetClick
-                    LinkFont.Charset = DEFAULT_CHARSET
-                    LinkFont.Color = clBlue
-                    LinkFont.Height = -11
-                    LinkFont.Name = 'MS Sans Serif'
-                    LinkFont.Style = [fsUnderline]
-                  end
-                  object btSavePreset: TSpTBXButton
-                    Left = 8
-                    Top = 40
-                    Width = 121
-                    Height = 25
-                    Caption = 'Save'
-                    TabOrder = 2
-                    OnClick = btSavePresetClick
-                    LinkFont.Charset = DEFAULT_CHARSET
-                    LinkFont.Color = clBlue
-                    LinkFont.Height = -11
-                    LinkFont.Name = 'MS Sans Serif'
-                    LinkFont.Style = [fsUnderline]
-                  end
-                  object PresetNameTextbox: TSpTBXEdit
-                    Left = 8
-                    Top = 18
-                    Width = 121
-                    Height = 21
-                    TabOrder = 3
-                    Text = 'Preset name'
-                  end
-                  object btClearPreset: TSpTBXButton
-                    Left = 8
-                    Top = 96
-                    Width = 121
-                    Height = 25
-                    Caption = 'Clear'
-                    TabOrder = 0
-                    OnClick = btClearPresetClick
-                    LinkFont.Charset = DEFAULT_CHARSET
-                    LinkFont.Color = clBlue
-                    LinkFont.Height = -11
-                    LinkFont.Name = 'MS Sans Serif'
-                    LinkFont.Style = [fsUnderline]
-                  end
-                end
-              end
               object SpTBXTabSheet1: TSpTBXTabSheet
                 Left = 0
                 Top = 0
@@ -735,12 +630,13 @@
                   Width = 570
                   Height = 129
                   Anchors = [akLeft, akTop, akRight]
-                  CheckImageKind = ckSystem
+                  CheckImageKind = ckSystemFlat
                   ClipboardFormats.Strings = (
                     'Unicode text')
-                  CustomCheckImages = ButtonImageList
                   DragOperations = []
+                  EditDelay = 150
                   Header.AutoSizeIndex = 3
+                  Header.DefaultHeight = 17
                   Header.Font.Charset = DEFAULT_CHARSET
                   Header.Font.Color = clWindowText
                   Header.Font.Height = -11
@@ -751,16 +647,20 @@
                   Header.Style = hsFlatButtons
                   TabOrder = 0
                   TreeOptions.AutoOptions = [toAutoDropExpand, toAutoScrollOnExpand, toAutoSort, toAutoTristateTracking, toAutoDeleteMovedNodes]
-                  TreeOptions.MiscOptions = [toAcceptOLEDrop, toCheckSupport, toFullRepaintOnResize, toInitOnSave, toToggleOnDblClick, toWheelPanning]
+                  TreeOptions.MiscOptions = [toAcceptOLEDrop, toCheckSupport, toEditable, toFullRepaintOnResize, toInitOnSave, toToggleOnDblClick, toWheelPanning, toEditOnClick]
                   TreeOptions.PaintOptions = [toShowButtons, toShowDropmark, toThemeAware, toUseBlendedImages]
-                  TreeOptions.SelectionOptions = [toFullRowSelect, toMultiSelect]
+                  TreeOptions.SelectionOptions = [toFullRowSelect]
                   OnChecking = FilterListChecking
+                  OnClick = FilterListClick
                   OnCompareNodes = FilterListCompareNodes
+                  OnEditing = FilterListEditing
                   OnGetText = FilterListGetText
                   OnHeaderClick = FilterListHeaderClick
+                  OnNewText = FilterListNewText
                   OnResize = FilterListResize
                   Columns = &lt;
                     item
+                      CheckBox = True
                       MaxWidth = 20
                       MinWidth = 20
                       Options = [coAllowClick, coEnabled, coParentBidiMode, coParentColor, coShowDropMark, coVisible, coFixed]
@@ -832,6 +732,9 @@
                   Top = 8
                   Width = 185
                   Height = 21
+                  Hint = 'You can use a regular expression'
+                  ParentShowHint = False
+                  ShowHint = True
                   TabOrder = 4
                 end
                 object DoNotContainsRadio: TSpTBXRadioButton
@@ -1073,6 +976,110 @@
                   end
                 end
               end
+              object SpTBXTabSheet2: TSpTBXTabSheet
+                Left = 0
+                Top = 0
+                Width = 819
+                Height = 146
+                Caption = 'Presets'
+                ImageIndex = -1
+                Item = SpTBXTabItem2
+                TabControl = FiltersTabs
+                DesignSize = (
+                  819
+                  146)
+                TabItem = 'SpTBXTabItem2'
+                object PresetListbox: TSpTBXListBox
+                  Left = 152
+                  Top = 26
+                  Width = 866
+                  Height = 113
+                  Anchors = [akLeft, akTop, akRight]
+                  ItemHeight = 16
+                  Items.Strings = (
+                    'current')
+                  TabOrder = 0
+                  OnClick = PresetListboxClick
+                  OnDblClick = PresetListboxDblClick
+                end
+                object SpTBXLabel3: TSpTBXLabel
+                  Left = 152
+                  Top = 8
+                  Width = 64
+                  Height = 16
+                  Caption = 'Preset list :'
+                  Font.Charset = DEFAULT_CHARSET
+                  Font.Color = clWindowText
+                  Font.Height = -13
+                  Font.Name = 'MS Sans Serif'
+                  Font.Style = []
+                  ParentFont = False
+                  LinkFont.Charset = DEFAULT_CHARSET
+                  LinkFont.Color = clBlue
+                  LinkFont.Height = -11
+                  LinkFont.Name = 'MS Sans Serif'
+                  LinkFont.Style = [fsUnderline]
+                end
+                object SpTBXGroupBox1: TSpTBXGroupBox
+                  Left = 8
+                  Top = 8
+                  Width = 137
+                  Height = 129
+                  Caption = 'Options'
+                  TabOrder = 2
+                  TBXStyleBackground = True
+                  object btDeletePreset: TSpTBXButton
+                    Left = 8
+                    Top = 72
+                    Width = 121
+                    Height = 25
+                    Caption = 'Delete'
+                    TabOrder = 1
+                    OnClick = btDeletePresetClick
+                    LinkFont.Charset = DEFAULT_CHARSET
+                    LinkFont.Color = clBlue
+                    LinkFont.Height = -11
+                    LinkFont.Name = 'MS Sans Serif'
+                    LinkFont.Style = [fsUnderline]
+                  end
+                  object btSavePreset: TSpTBXButton
+                    Left = 8
+                    Top = 40
+                    Width = 121
+                    Height = 25
+                    Caption = 'Save'
+                    TabOrder = 2
+                    OnClick = btSavePresetClick
+                    LinkFont.Charset = DEFAULT_CHARSET
+                    LinkFont.Color = clBlue
+                    LinkFont.Height = -11
+                    LinkFont.Name = 'MS Sans Serif'
+                    LinkFont.Style = [fsUnderline]
+                  end
+                  object PresetNameTextbox: TSpTBXEdit
+                    Left = 8
+                    Top = 18
+                    Width = 121
+                    Height = 21
+                    TabOrder = 3
+                    Text = 'Preset name'
+                  end
+                  object btClearPreset: TSpTBXButton
+                    Left = 8
+                    Top = 96
+                    Width = 121
+                    Height = 25
+                    Caption = 'Clear'
+                    TabOrder = 0
+                    OnClick = btClearPresetClick
+                    LinkFont.Charset = DEFAULT_CHARSET
+                    LinkFont.Color = clBlue
+                    LinkFont.Height = -11
+                    LinkFont.Name = 'MS Sans Serif'
+                    LinkFont.Style = [fsUnderline]
+                  end
+                end
+              end
             end
             object EnableFilters: TSpTBXCheckBox
               Left = 713
@@ -7265,24 +7272,37 @@
   end
   object AutojoinPopupMenu: TSpTBXPopupMenu
     AutoHotkeys = maManual
+    OnInitPopup = AutojoinPopupMenuInitPopup
     Left = 736
     Top = 239
+    object SubMenuPlaynow: TSpTBXSubmenuItem
+      Caption = 'Play now'
+    end
     object mnuPlaynow: TSpTBXItem
       Caption = 'Play now'
       OnClick = mnuPlaynowClick
     end
+    object SubMenuSpecnow: TSpTBXSubmenuItem
+      Caption = 'Spectate now'
+    end
     object mnuSpecnow: TSpTBXItem
       Caption = 'Spectate now'
       OnClick = mnuSpecnowClick
     end
     object SpTBXSeparatorItem22: TSpTBXSeparatorItem
     end
+    object SubMenuAutoplayFirstAvailable: TSpTBXSubmenuItem
+      Caption = 'Autoplay first available battle'
+    end
     object mnuAutoplayFirstAvailable: TSpTBXItem
       Caption = 'Autoplay first available battle'
       AutoCheck = True
       RadioItem = True
       OnClick = mnuAutoplayFirstAvailableClick
     end
+    object SubMenuAutospecFirstAvailable: TSpTBXSubmenuItem
+      Caption = 'Autospec first available battle'
+    end
     object mnuAutospecFirstAvailable: TSpTBXItem
       Caption = 'Autospec first available battle'
       AutoCheck = True

Modified: Lobby/TASClient/MainUnit.pas
===================================================================
--- Lobby/TASClient/MainUnit.pas	2010-03-03 23:32:51 UTC (rev 7423)
+++ Lobby/TASClient/MainUnit.pas	2010-03-05 00:20:36 UTC (rev 7424)
@@ -405,7 +405,7 @@
   );
 
 const
-  VERSION_NUMBER = '0.67'; // Must be float value! (with a period as a decimal seperator)
+  VERSION_NUMBER = '0.68'; // Must be float value! (with a period as a decimal seperator)
   AUTOUPDATE_URL = '<A HREF="http://tasclient.no-ip.org/TASClient_update_v3.txt">http://tasclient.no-ip.org/TASClient_update_v3.txt</A>';
   PROGRAM_VERSION = 'TASClient ' + VERSION_NUMBER;
   KEEP_ALIVE_INTERVAL = 10000; // in milliseconds. Tells us what should be the maximum &quot;silence&quot; time before we send a ping to the server.
@@ -433,7 +433,7 @@
   GROUPS_FILE = VAR_FOLDER + '\' + 'groups.ini';
   LAYOUTS_FILE = VAR_FOLDER + '\' + 'layouts.ini';
   AWAY_MSGS_FILE = VAR_FOLDER + '\' + 'away_messages.ini';
-  AUTOJOIN_SETTINGS = VAR_FOLDER + '\' + 'autojoin.ini';
+  AUTOJOIN_PRESETS_FOLDER = VAR_FOLDER + '\autoJoinPresets';
   MENU_SETTINGS_FILE = VAR_FOLDER + '\' + 'menuSettings.ini';
   TIPS_FILE = VAR_FOLDER+'\tips.txt';
   SPRING_SETTINGS_PROFILE_FILE = VAR_FOLDER + '\SpringSettingsProfiles.ini';
@@ -1222,6 +1222,10 @@
     Players2Filter: TSpTBXCheckBox;
     Players2SignButton: TSpTBXButton;
     Players2ValueTextBox: TJvSpinEdit;
+    SubMenuAutoplayFirstAvailable: TSpTBXSubmenuItem;
+    SubMenuAutospecFirstAvailable: TSpTBXSubmenuItem;
+    SubMenuPlaynow: TSpTBXSubmenuItem;
+    SubMenuSpecnow: TSpTBXSubmenuItem;
     procedure mnuOpenPrivateChatClick(Sender: TObject);
     procedure mnuSelectBattleClick(Sender: TObject);
     procedure mnuPlayWithClick(Sender: TObject);
@@ -1286,8 +1290,7 @@
     procedure FilterListCompareNodes(Sender: TBaseVirtualTree; Node1,
       Node2: PVirtualNode; Column: TColumnIndex; var Result: Integer);
     procedure FilterListHeaderClick(Sender: TVTHeader;
-      Column: TColumnIndex; Button: TMouseButton; Shift: TShiftState; X,
-      Y: Integer);
+  HitInfo: TVTHeaderHitInfo);
     procedure SaveFiltersToFile(Filters: TPresetFilters);
     procedure LoadFiltersFromFile(var Filters: TPresetFilters);
     procedure LoadPresets;
@@ -1393,6 +1396,13 @@
     procedure Players2FilterClick(Sender: TObject);
     procedure Players2SignButtonClick(Sender: TObject);
     procedure Players2ValueTextBoxChange(Sender: TObject);
+    procedure FilterListEditing(Sender: TBaseVirtualTree;
+      Node: PVirtualNode; Column: TColumnIndex; var Allowed: Boolean);
+    procedure FilterListNewText(Sender: TBaseVirtualTree;
+      Node: PVirtualNode; Column: TColumnIndex; NewText: WideString);
+    procedure FilterListClick(Sender: TObject);
+    procedure AutojoinPopupMenuInitPopup(Sender: TObject;
+      PopupView: TTBView);
   published
     MainTitleBar: TSpTBXTitleBar;
     ButtonImageList: TImageList;
@@ -1419,6 +1429,11 @@
     mnuKickReason: TSpTBXItem;
     ScrollingNewsBrowser: TWebBrowserWrapper;
     NewsBrowser: TWebBrowserWrapper;
+
+    procedure AutoSpecFirstAvailablePresetClick(Sender: TObject);
+    procedure AutoPlayFirstAvailablePresetClick(Sender: TObject);
+    procedure PlayNowClick(Sender: TObject);
+    procedure SpecNowClick(Sender: TObject);
   public
     lastActiveTab: TMyTabSheet;
     ChatTabs: TList;
@@ -1509,12 +1524,12 @@
 
     procedure SortClientsList(List: TList; SortStyle: Integer);
     procedure SortClientInList(client: TClient;List: TList; SortStyle: Integer);
-    procedure SortBattlesList(BattleList: TList; SortStyle: Integer; Ascending: Boolean);
+    procedure SortBattlesList(BattleList: TList; SortStyle: Integer; Ascending: Boolean; CountMe: Boolean = True);
     procedure RefreshBattlesNodes;
     function CompareClients(Client1: TClient; Client2: TClient; SortStyle: Integer): Shortint; // used with SortClientsList method (and other methods?)
-    function CompareBattles(Battle1, Battle2: TBattle; SortStyle: Integer; SortDirection: Boolean): Shortint;
+    function CompareBattles(Battle1, Battle2: TBattle; SortStyle: Integer; SortDirection: Boolean; CountMe: Boolean = False): Shortint;
 
-    function isBattleVisible(Battle:TBattle;Filters: TPresetFilters):Boolean;
+    function isBattleVisible(Battle:TBattle;Filters: TPresetFilters; countMe: Boolean = True):Boolean;
     procedure SortBattleInList(Index: Integer; SortStyle: Integer; Ascending: Boolean);
 
     procedure AddNotification(HeaderText, MessageText: string; DisplayTime: Integer;OnClick: Boolean = false;BattleId: integer = -1);
@@ -1595,8 +1610,7 @@
     procedure RichEditPopupMenuPopup(Sender: TObject);
     procedure AutoScroll1Click(Sender: TObject);
     procedure VDTBattlesHeaderClick(Sender: TVTHeader;
-      Column: TColumnIndex; Button: TMouseButton; Shift: TShiftState; X,
-      Y: Integer);
+  HitInfo: TVTHeaderHitInfo);
     procedure ClientsListBoxMouseUp(Sender: TObject; Button: TMouseButton;
       Shift: TShiftState; X, Y: Integer);
     procedure ClientsListBoxMouseDown(Sender: TObject;
@@ -1705,6 +1719,7 @@
   TeamColors: TTeamColors;
 
   Battles: TList;
+  AutoJoinBattles: TList;
   ReplayList: TList;
 
   CurrentFilters : TPresetFilters;
@@ -2273,6 +2288,7 @@
   if Battle.BattleType = 0 then Battle.SpectatorCount := 0 else Battle.SpectatorCount := 1;
 
   Battles.Add(Battle);
+  AutoJoinBattles.Add(Battle);
 
   with VDTBattles do
   begin
@@ -2292,18 +2308,13 @@
 begin
   Result := False;
 
-  j := -1;
-  for i := 0 to Battles.Count - 1 do
-    if TBattle(Battles[i]).ID = ID then
-    begin
-      j := i;
-      Break;
-    end;
+  j := GetBattleIndex(ID);
 
   if j = -1 then Exit;
 
   if TBattle(Battles[j]).Visible then
     VDTBattles.DeleteNode(TBattle(Battles[j]).Node, True);
+  AutoJoinBattles.Delete(AutoJoinBattles.IndexOf(Battles[j]));
   TBattle(Battles[j]).Free;
   Battles.Delete(j);
 
@@ -2319,6 +2330,7 @@
   if TBattle(Battles[index]).Visible then
     VDTBattles.DeleteNode(TBattle(Battles[Index]).Node, True);
   TBattle(Battles[Index]).Free;
+  AutoJoinBattles.Delete(AutoJoinBattles.IndexOf(Battles[Index]));
   Battles.Delete(Index);
 
   Result := True;
@@ -3820,6 +3832,7 @@
   mainLogBuffer := TWideStringList.Create;
   mainLogBufferColor := TIntegerList.Create;
   Battles := TList.Create;
+  AutoJoinBattles := TList.Create;
 
   if MainUnit.Debug.Enabled then
     Misc.TryToAddLog(MainUnit.StartDebugLog,'Loading docking settings ...');
@@ -4030,7 +4043,7 @@
     LoadAwayMessages;
     if MainUnit.Debug.Enabled then
       Misc.TryToAddLog(MainUnit.StartDebugLog,'Loading autojoin settings ...');
-    AutoJoinForm.LoadAutoJoinPresetLists;
+    AutoJoinForm.LoadAutoJoinPreset(AUTOJOIN_PRESETS_FOLDER + '\current.ini');
 
     initLobbyScript;
 
@@ -4553,12 +4566,10 @@
   TempItemIndex: Integer;
   TempCount: Integer;
   words: TStringList;
-  regExp: TRegExpr;
   i,j: integer;
   cList: TList;
 begin
   words := TStringList.Create;
-  regExp := TRegExpr.Create;
   c := 0;
 
   if lastActiveTab.Caption = LOCAL_TAB then
@@ -4566,32 +4577,15 @@
   else
     cList := lastActiveTab.Clients;
 
-  if LowerCase(LeftStr(PlayerFiltersTextbox.Text,3)) = 're=' then
+
+  for i:=0 to cList.Count-1 do
   begin
-    regExp.Expression := LowerCase(MidStr(PlayerFiltersTextbox.Text,4,90000));
-    for i:=0 to cList.Count-1 do
-    begin
-      try
-        TClient(cList[i]).Visible := RegExpr.ExecRegExpr(regExp.Expression,LowerCase(TClient(cList[i]).Name));
-      except
-        TClient(cList[i]).Visible := True;
-      end;
-      if TClient(cList[i]).Visible then Inc(c);
+    try
+      TClient(cList[i]).Visible := (PlayerFiltersTextbox.Text = '') or RegExpr.ExecRegExpr(LowerCase(PlayerFiltersTextbox.Text),LowerCase(TClient(cList[i]).Name));
+    except
+      TClient(cList[i]).Visible := True;
     end;
-  end
-  else
-  begin
-    ParseDelimited(words,LowerCase(PlayerFiltersTextbox.Text),' ','');
-    for i:=0 to cList.Count-1 do
-    begin
-      TClient(cList[i]).Visible := False;
-      for j:=0 to words.Count-1 do
-      begin
-        TClient(cList[i]).Visible := (words[j] = '') or (Pos(words[j],LowerCase(TClient(cList[i]).Name)) &gt; 0);
-        if TClient(cList[i]).Visible then break;
-      end;
-      if TClient(cList[i]).Visible then Inc(c);
-    end;
+    if TClient(cList[i]).Visible then Inc(c);
   end;
 
 
@@ -6762,9 +6756,9 @@
         Exit;
       end;
 
-      Client.BattleStatus := 0;
+      Client.SetMode(1);
+      Battle.Clients.Add(Client);
 
-      Battle.Clients.Add(Client);
       if Battle.Visible then
         if battle.Node &lt;&gt; nil then begin
           VDTBattles.InvalidateNode(Battle.Node);
@@ -6867,6 +6861,8 @@
         Exit;
       end;
 
+      tmpBool := Client.GetMode=0;
+
       Battle.Clients.Remove(Client);
       if Battle.Visible then
         VDTBattles.InvalidateNode(Battle.Node);
@@ -6891,15 +6887,12 @@
 
           if BattleState.Status = Hosting then
           begin
-            tmpInt := BattleState.Battle.SpectatorCount;
-
-            // update spectator count:
-            count := 0;
-            for i := 0 to Battle.Clients.Count-1 do if TClient(Battle.Clients[i]).GetMode = 0 then Inc(count);
-            Battle.SpectatorCount := count;
-
-            tmpBool := BattleState.Battle.SpectatorCount &lt;&gt; tmpInt; // did SpectatorCount change?
-            if tmpBool then BattleForm.SendBattleInfoToServer;
+            tmpInt := Battle.SpectatorCount;
+            if tmpBool then
+            begin
+              Battle.SpectatorCount := Battle.SpectatorCount - 1;
+              BattleForm.SendBattleInfoToServer;
+            end;
           end;
           if Client = Status.Me then // this should normally not happen since we disconnect from the battle immediately after receiving FORCEQUITBATTLE command from the server
           begin
@@ -7281,6 +7274,12 @@
         BattleForm.ChangeTeamColor(Misc.GetColorIndex(TeamColors, teamcolor),False);
       end;
 
+      // update spectator count:
+      BattleState.Battle.SpectatorCount := 0;
+      for i:=0 to BattleState.Battle.Clients.Count-1 do
+        if TClient(BattleState.Battle.Clients[i]).GetMode = 0 then
+          BattleState.Battle.SpectatorCount := BattleState.Battle.SpectatorCount + 1;
+
       if BattleState.Status = Hosting then if BattleState.Battle.Clients.IndexOf(Client) &lt;&gt; -1 then
       begin
         if tmpBool then
@@ -7313,11 +7312,6 @@
                 MainForm.TryToSendCommand('FORCESPECTATORMODE', Client.Name);
               end;
 
-          // update spectator count:
-          count := 0;
-          for i := 0 to BattleState.Battle.Clients.Count-1 do if TClient(BattleState.Battle.Clients[i]).GetMode = 0 then Inc(count);
-          BattleState.Battle.SpectatorCount := count;
-
           BattleForm.SendBattleInfoToServer;
         end;
         BattleForm.StartButton.Enabled := BattleForm.isBattleReadyToStart;
@@ -9159,7 +9153,7 @@
   IgnoreListForm.SaveIgnoreListToFile(ExtractFilePath(Application.ExeName) + VAR_FOLDER + '\ignorelist.dat');
 
   SaveFiltersToFile(CurrentFilters);
-  AutoJoinForm.SaveAutoJoinPresetLists;
+  AutoJoinForm.SaveAutoJoinPreset(AUTOJOIN_PRESETS_FOLDER + '\current.ini');
   ReplaysForm.SaveReplayFiltersToFile(REPLAY_FILTERS_FOLDER + '\current.ini');
   if RunningWithMainMenu then
     MenuForm.SaveSettings;
@@ -9351,11 +9345,12 @@
   end;
 end;
 
-function TMainForm.CompareBattles(Battle1, Battle2: TBattle; SortStyle: Integer; SortDirection: Boolean): Shortint;
+function TMainForm.CompareBattles(Battle1, Battle2: TBattle; SortStyle: Integer; SortDirection: Boolean; CountMe: Boolean = False): Shortint;
 var
   avgRank1,avgRank2: float;
   i:integer;
   asc: ShortInt;
+  meAsPlayer1,meAsSpec1,meAsPlayer2,meAsSpec2: integer;
 begin
   if SortDirection then asc := 1 else asc := -1;
   case SortStyle of
@@ -9371,17 +9366,37 @@
     // sort by mod:
     2: if AnsiCompareText(Battle1.ModName, Battle2.ModName) = 0 then Result := 0 else if AnsiCompareText(Battle1.ModName, Battle2.ModName) &gt; 0 then Result := 1 else Result := -1;
     // sort by players:
-    3:  if Battle1.Clients.Count - Battle1.SpectatorCount = Battle2.Clients.Count - Battle2.SpectatorCount then
-          if Battle1.SpectatorCount = Battle2.SpectatorCount then
+    3:
+    begin
+        meAsPlayer1 := 0;
+        meAsSpec1 := 0;
+        meAsPlayer2 := 0;
+        meAsSpec2 := 0;
+        if not CountMe then
+        begin
+          if Status.Me.InBattle and (Battle1.Clients.IndexOf(Status.Me) &gt; -1) then
+            if Status.Me.GetMode = 1 then
+              meAsPlayer1 := 1
+            else
+              meAsSpec1 := 1
+          else if Status.Me.InBattle and (Battle2.Clients.IndexOf(Status.Me) &gt; -1) then
+            if Status.Me.GetMode = 1 then
+              meAsPlayer2 := 1
+            else
+              meAsSpec2 := 1;
+        end;
+        if Battle1.Clients.Count - Battle1.SpectatorCount - meAsPlayer1 = Battle2.Clients.Count - Battle2.SpectatorCount - meAsPlayer2 then
+          if Battle1.SpectatorCount-meAsSpec1 = Battle2.SpectatorCount-meAsSpec2 then
             Result := 0
-          else if Battle1.SpectatorCount &gt; Battle2.SpectatorCount then
+          else if Battle1.SpectatorCount-meAsSpec1 &gt; Battle2.SpectatorCount-meAsSpec2 then
             Result := 1
           else
             Result := -1
-        else if Battle1.Clients.Count - Battle1.SpectatorCount &gt; Battle2.Clients.Count - Battle2.SpectatorCount then
+        else if Battle1.Clients.Count - Battle1.SpectatorCount - meAsPlayer1 &gt; Battle2.Clients.Count - Battle2.SpectatorCount - meAsPlayer2 then
           Result := 1
         else
           Result := -1;
+    end;
     // sort by map:
     4: if AnsiCompareText(Battle1.Map, Battle2.Map) = 0 then Result := 0 else if AnsiCompareText(Battle1.Map, Battle2.Map) &gt; 0 then Result := 1 else Result := -1;
     // sort by host:
@@ -9391,10 +9406,12 @@
     begin
       avgRank1 := 0;
       for i:=0 to Battle1.Clients.Count-1 do
+        if (Battle1.Clients[i] &lt;&gt; Status.Me) or CountMe then
           avgRank1 := avgRank1 + TClient(Battle1.Clients[i]).GetRank;
       avgRank1 := avgRank1 / Battle1.Clients.Count;
       avgRank2 := 0;
       for i:=0 to Battle2.Clients.Count-1 do
+        if (Battle2.Clients[i] &lt;&gt; Status.Me) or CountMe then
           avgRank2 := avgRank2 + TClient(Battle2.Clients[i]).GetRank;
       avgRank2 := avgRank2 / Battle2.Clients.Count;
       Result := CompareValue(avgRank1,avgRank2);
@@ -9483,7 +9500,7 @@
 
 { will sort &quot;Battles&quot; list. It won't invalidate (repaint) VDTBattles tree! Call VDTBattles.Invalidate to do that manually.
   If Ascending is False, then the list will be sorted in descending order. }
-procedure TMainForm.SortBattlesList(BattleList: TList; SortStyle: Integer; Ascending: Boolean);
+procedure TMainForm.SortBattlesList(BattleList: TList; SortStyle: Integer; Ascending: Boolean; CountMe: Boolean = True);
 var
   i, index, j: Integer;
   tmp: TBattle;
@@ -9498,7 +9515,7 @@
   begin
     Index := j;
     for i := Index-1 downto 0 do begin
-      if (CompareBattles(TBattle(BattleList[Index]), TBattle(BattleList[i]), SortStyle, Ascending) &lt; 0) then
+      if (CompareBattles(TBattle(BattleList[Index]), TBattle(BattleList[i]), SortStyle, Ascending, CountMe) &lt; 0) then
       begin
         // swap:
         tmp := BattleList[i];
@@ -9525,10 +9542,11 @@
     end;
 end;
 
-function TMainForm.isBattleVisible(Battle:TBattle;Filters: TPresetFilters):Boolean;
+function TMainForm.isBattleVisible(Battle:TBattle;Filters: TPresetFilters; countMe: Boolean = True):Boolean;
 var
   i,j: integer;
   tmpStr: string;
+  meAsPlayer : integer;
 begin
   if Battle.ForcedHidden then
   begin
@@ -9557,8 +9575,10 @@
         else
           raise Exception.Create(_('Filter type not handled.'));
 
-        j := Pos(LowerCase(value),LowerCase(tmpStr));
-        if (contains and (j = 0)) or ((not contains) and (j &gt; 0)) then
+        //j := Pos(LowerCase(value),LowerCase(tmpStr));
+        //if (contains and (j = 0)) or ((not contains) and (j &gt; 0)) then
+        if value = '' then value := '.';
+        if RegExpr.ExecRegExpr(LowerCase(value),LowerCase(tmpStr)) xor contains then
         begin
           Result := False;
           Exit;
@@ -9567,6 +9587,12 @@
     end; // with
   end; // for
 
+  if countMe then
+    meAsPlayer := 0
+  else
+    if Status.Me.InBattle and (Battle.Clients.IndexOf(Status.Me) &gt; -1) and (Status.Me.GetMode = 1) then
+      meAsPlayer := 1;
+
   Result :=
       (Filters.Locked or (not Battle.Locked)) and
       ((Filters.Passworded and Filters.Ladder) or (not Battle.Password) or (not Filters.Passworded and Filters.Ladder and Battle.IsLadderBattle) or (Filters.Passworded and not Battle.IsLadderBattle)) and
@@ -9578,14 +9604,14 @@
       (Filters.Replays or (Battle.BattleType = 0)) and
       (Filters.RankLimitSupEqMine or (Battle.RankLimit &lt;= Status.Me.GetRank)) and
       (not Filters.Players.enabled or
-      ((Filters.Players.filterType = Sup) and (Battle.Clients.Count-Battle.SpectatorCount &gt; Filters.Players.value)) or
-      ((Filters.Players.filterType = Inf) and (Battle.Clients.Count-Battle.SpectatorCount &lt; Filters.Players.value)) or
-      ((Filters.Players.filterType = Equal) and (Battle.Clients.Count-Battle.SpectatorCount = Filters.Players.value))
+      ((Filters.Players.filterType = Sup) and (Battle.Clients.Count-Battle.SpectatorCount-meAsPlayer &gt; Filters.Players.value)) or
+      ((Filters.Players.filterType = Inf) and (Battle.Clients.Count-Battle.SpectatorCount-meAsPlayer &lt; Filters.Players.value)) or
+      ((Filters.Players.filterType = Equal) and (Battle.Clients.Count-Battle.SpectatorCount-meAsPlayer = Filters.Players.value))
       ) and
       (not Filters.Players2.enabled or
-      ((Filters.Players2.filterType = Sup) and (Battle.Clients.Count-Battle.SpectatorCount &gt; Filters.Players2.value)) or
-      ((Filters.Players2.filterType = Inf) and (Battle.Clients.Count-Battle.SpectatorCount &lt; Filters.Players2.value)) or
-      ((Filters.Players2.filterType = Equal) and (Battle.Clients.Count-Battle.SpectatorCount = Filters.Players2.value))
+      ((Filters.Players2.filterType = Sup) and (Battle.Clients.Count-Battle.SpectatorCount-meAsPlayer &gt; Filters.Players2.value)) or
+      ((Filters.Players2.filterType = Inf) and (Battle.Clients.Count-Battle.SpectatorCount-meAsPlayer &lt; Filters.Players2.value)) or
+      ((Filters.Players2.filterType = Equal) and (Battle.Clients.Count-Battle.SpectatorCount-meAsPlayer = Filters.Players2.value))
       ) and
       (not Filters.MaxPlayers.enabled or
       ((Filters.MaxPlayers.filterType = Sup) and (Battle.MaxPlayers &gt; Filters.MaxPlayers.value)) or
@@ -10065,8 +10091,7 @@
 end;
 
 procedure TMainForm.VDTBattlesHeaderClick(Sender: TVTHeader;
-  Column: TColumnIndex; Button: TMouseButton; Shift: TShiftState; X,
-  Y: Integer);
+  HitInfo: TVTHeaderHitInfo);
 var
   tmpNode: PVirtualNode;
   i: integer;
@@ -10074,13 +10099,13 @@
   // note: when moving columns, their indexes remain the same!
   // (so the header of the first column may not have index 0)
 
-  if VDTBattles.Header.SortColumn = Column then
+  if VDTBattles.Header.SortColumn = HitInfo.Column then
     if Preferences.BattleSortDirection = 0 then Preferences.BattleSortDirection := 1
     else Preferences.BattleSortDirection := 0
   else Preferences.BattleSortDirection := 0;
     
-  Preferences.BattleSortStyle := PreferencesForm.ColumnToBattleSortStyle(Column);
-  VDTBattles.Header.SortColumn := Column;
+  Preferences.BattleSortStyle := PreferencesForm.ColumnToBattleSortStyle(HitInfo.Column);
+  VDTBattles.Header.SortColumn := HitInfo.Column;
   if Preferences.BattleSortDirection = 0 then
     VDTBattles.Header.SortDirection := sdAscending
   else
@@ -11079,17 +11104,16 @@
 end;
 
 procedure TMainForm.FilterListHeaderClick(Sender: TVTHeader;
-  Column: TColumnIndex; Button: TMouseButton; Shift: TShiftState; X,
-  Y: Integer);
+  HitInfo: TVTHeaderHitInfo);
 begin
-  if FilterList.Header.SortColumn = Column then
+  if FilterList.Header.SortColumn = HitInfo.Column then
     if FilterList.Header.SortDirection = sdDescending then
       FilterList.Header.SortDirection := sdAscending
     else
       FilterList.Header.SortDirection := sdDescending
   else
   begin
-    FilterList.Header.SortColumn := Column;
+    FilterList.Header.SortColumn := HitInfo.Column;
     FilterList.Header.SortDirection := sdAscending
   end;
 end;
@@ -11297,11 +11321,15 @@
   dstFilters.Replays := srcFilters.Replays;
   dstFilters.RankLimitSupEqMine := srcFilters.RankLimitSupEqMine;
   dstFilters.Players.enabled := srcFilters.Players.enabled;
+  dstFilters.Players2.enabled := srcFilters.Players2.enabled;
   dstFilters.MaxPlayers.enabled := srcFilters.MaxPlayers.enabled;
 
   dstFilters.Players.filterType := srcFilters.Players.filterType;
   dstFilters.Players.value := srcFilters.Players.value;
 
+  dstFilters.Players2.filterType := srcFilters.Players2.filterType;
+  dstFilters.Players2.value := srcFilters.Players2.value;
+
   dstFilters.MaxPlayers.filterType := srcFilters.MaxPlayers.filterType;
   dstFilters.MaxPlayers.value := srcFilters.MaxPlayers.value;
 
@@ -11336,6 +11364,7 @@
   ReplaysFilter.Checked := pFilters.Replays;
   RankLimitFilter.Checked := pFilters.RankLimitSupEqMine;
   PlayersFilter.Checked := pFilters.Players.enabled;
+  Players2Filter.Checked := pFilters.Players2.enabled;
   MaxPlayersFilter.Checked := pFilters.MaxPlayers.enabled;
 
   if pFilters.Players.filterType = Sup then
@@ -12569,7 +12598,6 @@
 
 function TMainForm.getAutojoinBestBattle(autoJoinPresetList:TList):TBattle;
 var
-  BattleList: TList;
   SortStyle: byte;
   i,j,k: integer;
   curPreset : TPresetFilters;
@@ -12579,8 +12607,6 @@
   if autoJoinPresetList.Count = 0 then
     Exit;
 
-  BattleList := TList.Create;
-  BattleList.Assign(Battles);
   curPreset.TextFilters := TList.Create;
 
   for i:=0 to autoJoinPresetList.Count-1 do
@@ -12612,11 +12638,11 @@
         4: SortStyle := 6; // avg rank
         5: SortStyle := 3; // players
       end;
-      SortBattlesList(BattleList,SortStyle,PAutoJoinPresetItemList(autoJoinPresetList[i]).SortingDirection=0);
-      for k:=0 to BattleList.Count-1 do
-        if isBattleVisible(TBattle(BattleList[k]),curPreset) then
+      SortBattlesList(AutoJoinBattles,SortStyle,PAutoJoinPresetItemList(autoJoinPresetList[i]).SortingDirection=0,False);
+      for k:=0 to AutoJoinBattles.Count-1 do
+        if isBattleVisible(TBattle(AutoJoinBattles[k]),curPreset,False) then
         begin
-          Result := TBattle(BattleList[k]);
+          Result := TBattle(AutoJoinBattles[k]);
           curPreset.TextFilters.Clear;
           Exit;
         end;
@@ -13262,4 +13288,151 @@
   FiltersUpdated;
 end;
 
+procedure TMainForm.FilterListEditing(Sender: TBaseVirtualTree;
+  Node: PVirtualNode; Column: TColumnIndex; var Allowed: Boolean);
+begin
+  Allowed := Column = 3;
+end;
+
+procedure TMainForm.FilterListNewText(Sender: TBaseVirtualTree;
+  Node: PVirtualNode; Column: TColumnIndex; NewText: WideString);
+begin
+  TFilterText(CurrentFilters.TextFilters[GetFilterIndexFromNode(Node)]^).value := NewText;
+  RefreshBattleList;
+  FiltersUpdated;
+end;
+
+procedure TMainForm.FilterListClick(Sender: TObject);
+var
+  ht: THitInfo;
+  pt: TPoint;
+begin
+  GetCursorPos(pt);
+  pt := FilterList.ScreenToClient(pt);
+  FilterList.GetHitTestInfoAt(pt.X,pt.Y,False,ht);
+  FilterList.FocusedColumn := ht.HitColumn;
+end;
+
+procedure TMainForm.AutojoinPopupMenuInitPopup(Sender: TObject;
+  PopupView: TTBView);
+var
+  i:integer;
+begin
+  SubMenuAutoplayFirstAvailable.Clear;
+  SubMenuAutospecFirstAvailable.Clear;
+  SubMenuPlaynow.Clear;
+  SubMenuSpecnow.Clear;
+
+  if AutoJoinForm.lstPresetList.Items.Count = 1 then
+  begin
+    mnuAutoplayFirstAvailable.Visible := True;
+    mnuAutospecFirstAvailable.Visible := True;
+    mnuPlaynow.Visible := True;
+    mnuSpecnow.Visible := True;
+    SubMenuAutoplayFirstAvailable.Visible := False;
+    SubMenuAutospecFirstAvailable.Visible := False;
+    SubMenuPlaynow.Visible := False;
+    SubMenuSpecnow.Visible := False;
+  end
+  else
+  begin
+    mnuAutoplayFirstAvailable.Visible := False;
+    mnuAutospecFirstAvailable.Visible := False;
+    mnuPlaynow.Visible := False;
+    mnuSpecnow.Visible := False;
+    SubMenuAutoplayFirstAvailable.Visible := True;
+    SubMenuAutospecFirstAvailable.Visible := True;
+    SubMenuPlaynow.Visible := True;
+    SubMenuSpecnow.Visible := True;
+
+    for i:=0 to AutoJoinForm.lstPresetList.Items.Count-1 do
+    begin
+      SubMenuSpecnow.Add(TSpTBXItem.Create(SubMenuSpecnow));
+      with SubMenuSpecnow.Items[SubMenuSpecnow.Count-1] as TSpTBXItem do
+      begin
+        Caption := AutoJoinForm.lstPresetList.Items[i];
+        Tag := i;
+        OnClick := SpecNowClick;
+      end;
+      SubMenuPlaynow.Add(TSpTBXItem.Create(SubMenuPlaynow));
+      with SubMenuPlaynow.Items[SubMenuPlaynow.Count-1] as TSpTBXItem do
+      begin
+        Caption := AutoJoinForm.lstPresetList.Items[i];
+        Tag := i;
+        OnClick := PlayNowClick;
+      end;
+
+      SubMenuAutospecFirstAvailable.Add(TSpTBXItem.Create(SubMenuAutospecFirstAvailable));
+      with SubMenuAutospecFirstAvailable.Items[SubMenuAutospecFirstAvailable.Count-1] as TSpTBXItem do
+      begin
+        Caption := AutoJoinForm.lstPresetList.Items[i];
+        Tag := i;
+        OnClick := AutoSpecFirstAvailablePresetClick;
+        if mnuAutospecFirstAvailable.Checked then
+          if mnuAutospecFirstAvailable.Tag = i then
+            Checked := True;
+      end;
+      SubMenuAutoplayFirstAvailable.Add(TSpTBXItem.Create(SubMenuAutoplayFirstAvailable));
+      with SubMenuAutoplayFirstAvailable.Items[SubMenuAutoplayFirstAvailable.Count-1] as TSpTBXItem do
+      begin
+        Caption := AutoJoinForm.lstPresetList.Items[i];
+        Tag := i;
+        OnClick := AutoPlayFirstAvailablePresetClick;
+        if mnuAutoplayFirstAvailable.Checked then
+          if mnuAutoplayFirstAvailable.Tag = i then
+            Checked := True;
+      end;
+    end;
+  end;
+  MainForm.Refresh;
+end;
+
+procedure TMainForm.AutoSpecFirstAvailablePresetClick(Sender: TObject);
+begin
+  AutoJoinForm.lstPresetList.ItemIndex := TSpTBXItem(Sender).Tag;
+  AutoJoinForm.lstPresetListDblClick(nil);
+  if TSpTBXItem(Sender).Checked then
+  begin
+    mnuAutospecFirstAvailable.Checked := False;
+    mnuAutoplayFirstAvailable.Checked := False;
+  end
+  else
+  begin
+    mnuAutospecFirstAvailable.Checked := True;
+    mnuAutoplayFirstAvailable.Checked := False;
+  end;
+  mnuAutospecFirstAvailable.Tag := TSpTBXItem(Sender).Tag;
+end;
+
+procedure TMainForm.AutoPlayFirstAvailablePresetClick(Sender: TObject);
+begin
+  AutoJoinForm.lstPresetList.ItemIndex := TSpTBXItem(Sender).Tag;
+  AutoJoinForm.lstPresetListDblClick(nil);
+  if TSpTBXItem(Sender).Checked then
+  begin
+    mnuAutospecFirstAvailable.Checked := False;
+    mnuAutoplayFirstAvailable.Checked := False;
+  end
+  else
+  begin
+    mnuAutospecFirstAvailable.Checked := False;
+    mnuAutoplayFirstAvailable.Checked := True;
+  end;
+  mnuAutoplayFirstAvailable.Tag := TSpTBXItem(Sender).Tag;
+end;
+
+procedure TMainForm.PlayNowClick(Sender: TObject);
+begin
+  AutoJoinForm.lstPresetList.ItemIndex := TSpTBXItem(Sender).Tag;
+  AutoJoinForm.lstPresetListDblClick(nil);
+  mnuPlaynowClick(nil);
+end;
+
+procedure TMainForm.SpecNowClick(Sender: TObject);
+begin
+  AutoJoinForm.lstPresetList.ItemIndex := TSpTBXItem(Sender).Tag;
+  AutoJoinForm.lstPresetListDblClick(nil);
+  mnuSpecnowClick(nil);
+end;
+
 end.

Added: Lobby/TASClient/Python/scripts/forumIt.py
===================================================================
--- Lobby/TASClient/Python/scripts/forumIt.py	                        (rev 0)
+++ Lobby/TASClient/Python/scripts/forumIt.py	2010-03-05 00:20:36 UTC (rev 7424)
@@ -0,0 +1,12 @@
+import time,thread
+import lobbyscript
+import webbrowser
+import string
+
+api = lobbyscript.Callback()
+gui = lobbyscript.GUI()
+
+def cmd_forum(args):
+	webbrowser.open(&quot;<A HREF="http://springrts.com/phpbb/search.php?keywords=">http://springrts.com/phpbb/search.php?keywords=</A>&quot;+string.join(args, '' )+&quot;&amp;terms=all&amp;author=&amp;sc=1&amp;sf=all&amp;sk=t&amp;sd=d&amp;sr=topics&amp;st=0&amp;ch=300&amp;t=0&amp;submit=Search&quot;)
+	return True
+	
\ No newline at end of file

Modified: Lobby/TASClient/ReplaysUnit.dfm
===================================================================
--- Lobby/TASClient/ReplaysUnit.dfm	2010-03-03 23:32:51 UTC (rev 7423)
+++ Lobby/TASClient/ReplaysUnit.dfm	2010-03-05 00:20:36 UTC (rev 7424)
@@ -1,6 +1,6 @@
 object ReplaysForm: TReplaysForm
-  Left = 332
-  Top = 113
+  Left = 1026
+  Top = 174
   Width = 790
   Height = 599
   Caption = 'Replays'
@@ -39,6 +39,7 @@
       BevelInner = bvNone
       BevelOuter = bvNone
       Header.AutoSizeIndex = 8
+      Header.DefaultHeight = 17
       Header.Font.Charset = DEFAULT_CHARSET
       Header.Font.Color = clWindowText
       Header.Font.Height = -11
@@ -438,6 +439,7 @@
             Height = 168
             Align = alClient
             Header.AutoSizeIndex = 7
+            Header.DefaultHeight = 17
             Header.Font.Charset = DEFAULT_CHARSET
             Header.Font.Color = clWindowText
             Header.Font.Height = -11
@@ -1157,7 +1159,7 @@
               Height = 21
               Hint = 
                 'For map/mod option type '#39'key=value'#39' or just '#39'key'#39' or just '#39'value' +
-                #39
+                #39'. Regexp are supported.'
               ParentShowHint = False
               ShowHint = True
               TabOrder = 3
@@ -1212,11 +1214,13 @@
             Height = 185
             Align = alCustom
             Anchors = [akLeft, akTop, akRight]
-            CheckImageKind = ckSystem
+            CheckImageKind = ckSystemFlat
             ClipboardFormats.Strings = (
               'Unicode text')
             DragOperations = []
+            EditDelay = 150
             Header.AutoSizeIndex = 3
+            Header.DefaultHeight = 17
             Header.Font.Charset = DEFAULT_CHARSET
             Header.Font.Color = clWindowText
             Header.Font.Height = -11
@@ -1227,15 +1231,19 @@
             Header.Style = hsFlatButtons
             TabOrder = 5
             TreeOptions.AutoOptions = [toAutoDropExpand, toAutoScrollOnExpand, toAutoSort, toAutoTristateTracking, toAutoDeleteMovedNodes]
-            TreeOptions.MiscOptions = [toAcceptOLEDrop, toCheckSupport, toFullRepaintOnResize, toInitOnSave, toToggleOnDblClick, toWheelPanning]
+            TreeOptions.MiscOptions = [toAcceptOLEDrop, toCheckSupport, toEditable, toFullRepaintOnResize, toInitOnSave, toToggleOnDblClick, toWheelPanning, toEditOnClick]
             TreeOptions.PaintOptions = [toShowButtons, toShowDropmark, toThemeAware, toUseBlendedImages]
-            TreeOptions.SelectionOptions = [toFullRowSelect, toMultiSelect]
+            TreeOptions.SelectionOptions = [toFullRowSelect]
             OnChecking = FilterListChecking
+            OnClick = FilterListClick
             OnCompareNodes = FilterListCompareNodes
+            OnEditing = FilterListEditing
             OnGetText = FilterListGetText
             OnHeaderClick = FilterListHeaderClick
+            OnNewText = FilterListNewText
             Columns = &lt;
               item
+                CheckBox = True
                 MaxWidth = 20
                 MinWidth = 20
                 Options = [coAllowClick, coEnabled, coParentBidiMode, coParentColor, coShowDropMark, coVisible, coFixed]

Modified: Lobby/TASClient/ReplaysUnit.pas
===================================================================
--- Lobby/TASClient/ReplaysUnit.pas	2010-03-03 23:32:51 UTC (rev 7423)
+++ Lobby/TASClient/ReplaysUnit.pas	2010-03-05 00:20:36 UTC (rev 7424)
@@ -23,7 +23,7 @@
   TntStdCtrls, SpTBXEditors, TBXDkPanels, SpTBXTabs, TB2Item, TBX,
   SpTBXItem, IdBaseComponent, IdComponent, IdTCPConnection, IdTCPClient,
   IdHTTP,MainUnit,DateUtils, VirtualTrees,Utility, Mask, JvExMask, JvSpin,
-  IniFiles,MapListFormUnit, Menus;
+  IniFiles,MapListFormUnit, Menus, RegExpr;
 
 type
   TReplaysForm = class(TForm)
@@ -175,8 +175,7 @@
     procedure VDTReplaysCompareNodes(Sender: TBaseVirtualTree; Node1,
       Node2: PVirtualNode; Column: TColumnIndex; var Result: Integer);
     procedure VDTReplaysHeaderClick(Sender: TVTHeader;
-      Column: TColumnIndex; Button: TMouseButton; Shift: TShiftState; X,
-      Y: Integer);
+  HitInfo: TVTHeaderHitInfo);
     procedure InitVDTForRefresh;
     procedure TerminateVDTRefresh;
     procedure VDTReplaysClick(Sender: TObject);overload;
@@ -185,8 +184,7 @@
     procedure VDTPlayersCompareNodes(Sender: TBaseVirtualTree; Node1,
       Node2: PVirtualNode; Column: TColumnIndex; var Result: Integer);
     procedure VDTPlayersHeaderClick(Sender: TVTHeader;
-      Column: TColumnIndex; Button: TMouseButton; Shift: TShiftState; X,
-      Y: Integer);
+  HitInfo: TVTHeaderHitInfo);
     procedure chkEnableFiltersClick(Sender: TObject);
     procedure FiltersButtonClick(Sender: TObject);
     procedure FilterListGetText(Sender: TBaseVirtualTree;
@@ -237,8 +235,7 @@
     procedure FilterListCompareNodes(Sender: TBaseVirtualTree; Node1,
       Node2: PVirtualNode; Column: TColumnIndex; var Result: Integer);
     procedure FilterListHeaderClick(Sender: TVTHeader;
-      Column: TColumnIndex; Button: TMouseButton; Shift: TShiftState; X,
-      Y: Integer);
+  HitInfo: TVTHeaderHitInfo);
     procedure VDTReplaysGetHintSize(Sender: TBaseVirtualTree;
       Node: PVirtualNode; Column: TColumnIndex; var R: TRect);
     procedure VDTReplaysDrawHint(Sender: TBaseVirtualTree;
@@ -246,10 +243,15 @@
       Column: TColumnIndex);
     procedure DeleteAllVisibleButtonClick(Sender: TObject);
     procedure btSavePresetClick(Sender: TObject);
-    procedure btDeletePresetClick(Sender: TObject);
     procedure btClearPresetClick(Sender: TObject);
     procedure PresetListboxDblClick(Sender: TObject);
     procedure PresetListboxClick(Sender: TObject);
+    procedure FilterListEditing(Sender: TBaseVirtualTree;
+      Node: PVirtualNode; Column: TColumnIndex; var Allowed: Boolean);
+    procedure FilterListClick(Sender: TObject);
+    procedure FilterListNewText(Sender: TBaseVirtualTree;
+      Node: PVirtualNode; Column: TColumnIndex; NewText: WideString);
+    procedure btDeletePresetClick(Sender: TObject);
   private
     { Private declarations }
   public
@@ -1399,17 +1401,16 @@
 end;
 
 procedure TReplaysForm.VDTReplaysHeaderClick(Sender: TVTHeader;
-  Column: TColumnIndex; Button: TMouseButton; Shift: TShiftState; X,
-  Y: Integer);
+  HitInfo: TVTHeaderHitInfo);
 begin
-  if VDTReplays.Header.SortColumn = Column then
+  if VDTReplays.Header.SortColumn = HitInfo.Column then
     if VDTReplays.Header.SortDirection = sdDescending then
       VDTReplays.Header.SortDirection := sdAscending
     else
       VDTReplays.Header.SortDirection := sdDescending
   else
   begin
-    VDTReplays.Header.SortColumn := Column;
+    VDTReplays.Header.SortColumn := HitInfo.Column;
     VDTReplays.Header.SortDirection := sdDescending;
   end;
 end;
@@ -1638,17 +1639,16 @@
 end;
 
 procedure TReplaysForm.VDTPlayersHeaderClick(Sender: TVTHeader;
-  Column: TColumnIndex; Button: TMouseButton; Shift: TShiftState; X,
-  Y: Integer);
+  HitInfo: TVTHeaderHitInfo);
 begin
-  if VDTPlayers.Header.SortColumn = Column then
+  if VDTPlayers.Header.SortColumn = HitInfo.Column then
     if VDTPlayers.Header.SortDirection = sdDescending then
       VDTPlayers.Header.SortDirection := sdAscending
     else
       VDTPlayers.Header.SortDirection := sdDescending
   else
   begin
-    VDTPlayers.Header.SortColumn := Column;
+    VDTPlayers.Header.SortColumn := HitInfo.Column;
     VDTPlayers.Header.SortDirection := sdAscending;
   end;
 end;
@@ -1697,8 +1697,9 @@
         else
           raise Exception.Create(_('Filter type not handled.'));
 
-        j := Pos(LowerCase(value),LowerCase(tmpStr));
-        if (contains and (j = 0)) or ((not contains) and (j &gt; 0)) then
+        //j := Pos(LowerCase(value),LowerCase(tmpStr));
+        //if (contains and (j = 0)) or ((not contains) and (j &gt; 0)) then
+        if RegExpr.ExecRegExpr(LowerCase(value),LowerCase(tmpStr)) xor contains then
         begin
           Result := False;
           Exit;
@@ -2740,17 +2741,16 @@
 end;
 
 procedure TReplaysForm.FilterListHeaderClick(Sender: TVTHeader;
-  Column: TColumnIndex; Button: TMouseButton; Shift: TShiftState; X,
-  Y: Integer);
+  HitInfo: TVTHeaderHitInfo);
 begin
-  if FilterList.Header.SortColumn = Column then
+  if FilterList.Header.SortColumn = HitInfo.Column then
     if FilterList.Header.SortDirection = sdDescending then
       FilterList.Header.SortDirection := sdAscending
     else
       FilterList.Header.SortDirection := sdDescending
   else
   begin
-    FilterList.Header.SortColumn := Column;
+    FilterList.Header.SortColumn := HitInfo.Column;
     FilterList.Header.SortDirection := sdAscending
   end;
 end;
@@ -2922,14 +2922,6 @@
   SaveReplayFiltersToFile(REPLAY_FILTERS_FOLDER + '\'+PresetNameTextbox.Text+'.ini');
 end;
 
-procedure TReplaysForm.btDeletePresetClick(Sender: TObject);
-begin
-  if PresetListbox.ItemIndex = 0 then Exit;
-  DeleteFile(REPLAY_FILTERS_FOLDER + '\' + PresetListbox.Items[PresetListbox.ItemIndex] + '.ini');
-  PresetListbox.Items.Delete(PresetListbox.ItemIndex);
-  PresetListbox.Selected[0] := true;
-end;
-
 procedure TReplaysForm.btClearPresetClick(Sender: TObject);
 var
   i: integer;
@@ -2978,7 +2970,7 @@
 
 procedure TReplaysForm.PresetListboxDblClick(Sender: TObject);
 begin
-  if (PresetListbox.ItemIndex = 0) and not FileExists(REPLAY_FILTERS_FOLDER + '\' + PresetListbox.Items[PresetListbox.ItemIndex] + '.ini') then Exit;
+  if (PresetListbox.ItemIndex = 0) or not FileExists(REPLAY_FILTERS_FOLDER + '\' + PresetListbox.Items[PresetListbox.ItemIndex] + '.ini') then Exit;
   LoadReplayFiltersFromFile(REPLAY_FILTERS_FOLDER + '\' + PresetListbox.Items[PresetListbox.ItemIndex] + '.ini');
   UpdateReplayFilters;
   FilterReplayList;
@@ -2990,4 +2982,36 @@
   PresetNameTextbox.Text := PresetListbox.Items[PresetListbox.ItemIndex];
 end;
 
+procedure TReplaysForm.FilterListEditing(Sender: TBaseVirtualTree;
+  Node: PVirtualNode; Column: TColumnIndex; var Allowed: Boolean);
+begin
+  Allowed := Column = 3;
+end;
+
+procedure TReplaysForm.FilterListClick(Sender: TObject);
+var
+  ht: THitInfo;
+  pt: TPoint;
+begin
+  GetCursorPos(pt);
+  pt := FilterList.ScreenToClient(pt);
+  FilterList.GetHitTestInfoAt(pt.X,pt.Y,False,ht);
+  FilterList.FocusedColumn := ht.HitColumn;
+end;
+
+procedure TReplaysForm.FilterListNewText(Sender: TBaseVirtualTree;
+  Node: PVirtualNode; Column: TColumnIndex; NewText: WideString);
+begin
+  TFilterText(Filters.TextFilters[GetReplayFilterIndexFromNode(Node)]^).value := NewText;
+  FiltersUpdated;
+end;
+
+procedure TReplaysForm.btDeletePresetClick(Sender: TObject);
+begin
+  if PresetListbox.ItemIndex = 0 then Exit;
+  DeleteFile(REPLAY_FILTERS_FOLDER + '\' + PresetListbox.Items[PresetListbox.ItemIndex] + '.ini');
+  PresetListbox.Items.Delete(PresetListbox.ItemIndex);
+  PresetListbox.Selected[0] := true;
+end;
+
 end.

Modified: Lobby/TASClient/SetStringsUnit.dfm
===================================================================
--- Lobby/TASClient/SetStringsUnit.dfm	2010-03-03 23:32:51 UTC (rev 7423)
+++ Lobby/TASClient/SetStringsUnit.dfm	2010-03-05 00:20:36 UTC (rev 7424)
@@ -22,6 +22,7 @@
     Width = 209
     Height = 177
     Anchors = [akLeft, akTop, akRight, akBottom]
+    ScrollBars = ssVertical
     TabOrder = 0
     OnChange = StringsMemoChange
   end

Modified: Lobby/TASClient/TASClient.dof
===================================================================
--- Lobby/TASClient/TASClient.dof	2010-03-03 23:32:51 UTC (rev 7423)
+++ Lobby/TASClient/TASClient.dof	2010-03-05 00:20:36 UTC (rev 7424)
@@ -113,9 +113,9 @@
 IncludeVerInfo=1
 AutoIncBuild=1
 MajorVer=0
-MinorVer=67
+MinorVer=68
 Release=0
-Build=810
+Build=813
 Debug=0
 PreRelease=0
 Special=0
@@ -126,7 +126,7 @@
 [Version Info Keys]
 CompanyName=
 FileDescription=Spring RTS Engine lobby client
-FileVersion=0.67.0.810
+FileVersion=0.68.0.813
 InternalName=
 LegalCopyright=
 LegalTrademarks=

Modified: Lobby/TASClient/TASClient.res
===================================================================
(Binary files differ)


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002193.html">[Taspring-linux-commit] r7423 - in Lobby/TASClient: .	LobbyComponents/DockPanel Python Python/scripts
</A></li>
	<LI>Next message: <A HREF="002195.html">[Taspring-linux-commit] r7425 - Lobby/TASClient
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2194">[ date ]</a>
              <a href="thread.html#2194">[ thread ]</a>
              <a href="subject.html#2194">[ subject ]</a>
              <a href="author.html#2194">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
