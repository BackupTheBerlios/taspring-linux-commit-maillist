<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r6851 - in branches/caiinterface: AI/Group/MexUpgraderAI AI/Skirmish/AAI AI/Skirmish/JCAI AI/Skirmish/KAI AI/Skirmish/KAIK AI/Skirmish/NTai AI/Skirmish/NTai/AI/NTai/Helpers AI/Skirmish/NTai/AI/NTai/SDK Documentation installer installer/builddata/maphelper/maphelper installer/builddata/springcontent installer/sections rts/ExternalAI rts/ExternalAI/Interface rts/ExternalAI/Interface/LegacyCppWrapper rts/Game rts/Game/Camera rts/Game/StartScripts rts/Game/UI rts/Lua rts/Map rts/Map/SM3 rts/Map/SM3/terrain rts/Map/SMF rts/Rendering rts/Rendering/Env rts/Rendering/GL rts/Rendering/Textures rts/Rendering/UnitModels rts/Sim rts/Sim/Features rts/Sim/Misc rts/Sim/MoveTypes rts/Sim/Objects rts/Sim/Path rts/Sim/Projectiles rts/Sim/Projectiles/Unsynced rts/Sim/Projectiles/WeaponProjectiles rts/Sim/Units rts/Sim/Units/COB rts/Sim/Units/CommandAI rts/Sim/Units/UnitTypes rts/Sim/Weapons rts/System rts/System/Platform rts/System/Platform/Linux rts/System/Script rts/System/Sync rts/b uild/vstudio8 tools/unitsync tools/unitsync/test
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-October/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6851%20-%20in%20branches/caiinterface%3A%0A%20AI/Group/MexUpgraderAI%20AI/Skirmish/AAI%20AI/Skirmish/JCAI%20AI/Skirmish/KAI%0A%20AI/Skirmish/KAIK%20AI/Skirmish/NTai%20AI/Skirmish/NTai/AI/NTai/Helpers%0A%20AI/Skirmish/NTai/AI/NTai/SDK%20Documentation%20installer%0A%20installer/builddata/maphelper/maphelper%20installer/builddata/springcontent%0A%20installer/sections%20rts/ExternalAI%20rts/ExternalAI/Interface%0A%20rts/ExternalAI/Interface/LegacyCppWrapper%20rts/Game%20rts/Game/Camera%0A%20rts/Game/StartScripts%20rts/Game/UI%20rts/Lua%20rts/Map%20rts/Map/SM3%0A%20rts/Map/SM3/terrain%20rts/Map/SMF%20rts/Rendering%20rts/Rendering/Env%0A%20rts/Rendering/GL%20rts/Rendering/Textures%20rts/Rendering/UnitModels%20rts/Sim%0A%20rts/Sim/Features%20rts/Sim/Misc%20rts/Sim/MoveTypes%20rts/Sim/Objects%0A%20rts/Sim/Path%20rts/Sim/Projectiles%20rts/Sim/Projectiles/Unsynced%0A%20rts/Sim/Projectiles/WeaponProjectiles%20rts/Sim/Units%20rts/Sim/Units/COB%0A%20rts/Sim/Units/CommandAI%20rts/Sim/Units/UnitTypes%20rts/Sim/Weapons%20rts/System%0A%20rts/System/Platform%20rts/System/Platform/Linux%20rts/System/Script%0A%20rts/System/Sync%20rts/b%20uild/vstudio8%20tools/unitsync%20tools/unitsync/test&In-Reply-To=%3C20081022143015.8D5E74730%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001619.html">
   <LINK REL="Next"  HREF="001621.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r6851 - in branches/caiinterface: AI/Group/MexUpgraderAI AI/Skirmish/AAI AI/Skirmish/JCAI AI/Skirmish/KAI AI/Skirmish/KAIK AI/Skirmish/NTai AI/Skirmish/NTai/AI/NTai/Helpers AI/Skirmish/NTai/AI/NTai/SDK Documentation installer installer/builddata/maphelper/maphelper installer/builddata/springcontent installer/sections rts/ExternalAI rts/ExternalAI/Interface rts/ExternalAI/Interface/LegacyCppWrapper rts/Game rts/Game/Camera rts/Game/StartScripts rts/Game/UI rts/Lua rts/Map rts/Map/SM3 rts/Map/SM3/terrain rts/Map/SMF rts/Rendering rts/Rendering/Env rts/Rendering/GL rts/Rendering/Textures rts/Rendering/UnitModels rts/Sim rts/Sim/Features rts/Sim/Misc rts/Sim/MoveTypes rts/Sim/Objects rts/Sim/Path rts/Sim/Projectiles rts/Sim/Projectiles/Unsynced rts/Sim/Projectiles/WeaponProjectiles rts/Sim/Units rts/Sim/Units/COB rts/Sim/Units/CommandAI rts/Sim/Units/UnitTypes rts/Sim/Weapons rts/System rts/System/Platform rts/System/Platform/Linux rts/System/Script rts/System/Sync rts/b uild/vstudio8 tools/unitsync tools/unitsync/test</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6851%20-%20in%20branches/caiinterface%3A%0A%20AI/Group/MexUpgraderAI%20AI/Skirmish/AAI%20AI/Skirmish/JCAI%20AI/Skirmish/KAI%0A%20AI/Skirmish/KAIK%20AI/Skirmish/NTai%20AI/Skirmish/NTai/AI/NTai/Helpers%0A%20AI/Skirmish/NTai/AI/NTai/SDK%20Documentation%20installer%0A%20installer/builddata/maphelper/maphelper%20installer/builddata/springcontent%0A%20installer/sections%20rts/ExternalAI%20rts/ExternalAI/Interface%0A%20rts/ExternalAI/Interface/LegacyCppWrapper%20rts/Game%20rts/Game/Camera%0A%20rts/Game/StartScripts%20rts/Game/UI%20rts/Lua%20rts/Map%20rts/Map/SM3%0A%20rts/Map/SM3/terrain%20rts/Map/SMF%20rts/Rendering%20rts/Rendering/Env%0A%20rts/Rendering/GL%20rts/Rendering/Textures%20rts/Rendering/UnitModels%20rts/Sim%0A%20rts/Sim/Features%20rts/Sim/Misc%20rts/Sim/MoveTypes%20rts/Sim/Objects%0A%20rts/Sim/Path%20rts/Sim/Projectiles%20rts/Sim/Projectiles/Unsynced%0A%20rts/Sim/Projectiles/WeaponProjectiles%20rts/Sim/Units%20rts/Sim/Units/COB%0A%20rts/Sim/Units/CommandAI%20rts/Sim/Units/UnitTypes%20rts/Sim/Weapons%20rts/System%0A%20rts/System/Platform%20rts/System/Platform/Linux%20rts/System/Script%0A%20rts/System/Sync%20rts/b%20uild/vstudio8%20tools/unitsync%20tools/unitsync/test&In-Reply-To=%3C20081022143015.8D5E74730%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r6851 - in branches/caiinterface: AI/Group/MexUpgraderAI AI/Skirmish/AAI AI/Skirmish/JCAI AI/Skirmish/KAI AI/Skirmish/KAIK AI/Skirmish/NTai AI/Skirmish/NTai/AI/NTai/Helpers AI/Skirmish/NTai/AI/NTai/SDK Documentation installer installer/builddata/maphelper/maphelper installer/builddata/springcontent installer/sections rts/ExternalAI rts/ExternalAI/Interface rts/ExternalAI/Interface/LegacyCppWrapper rts/Game rts/Game/Camera rts/Game/StartScripts rts/Game/UI rts/Lua rts/Map rts/Map/SM3 rts/Map/SM3/terrain rts/Map/SMF rts/Rendering rts/Rendering/Env rts/Rendering/GL rts/Rendering/Textures rts/Rendering/UnitModels rts/Sim rts/Sim/Features rts/Sim/Misc rts/Sim/MoveTypes rts/Sim/Objects rts/Sim/Path rts/Sim/Projectiles rts/Sim/Projectiles/Unsynced rts/Sim/Projectiles/WeaponProjectiles rts/Sim/Units rts/Sim/Units/COB rts/Sim/Units/CommandAI rts/Sim/Units/UnitTypes rts/Sim/Weapons rts/System rts/System/Platform rts/System/Platform/Linux rts/System/Script rts/System/Sync rts/b uild/vstudio8 tools/unitsync tools/unitsync/test">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Wed Oct 22 16:30:14 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001619.html">[Taspring-linux-commit] r6850 - in Lobby/springie/Springie: .	downloader spring
</A></li>
        <LI>Next message: <A HREF="001621.html">[Taspring-linux-commit] r6852 - Lobby/TASClient
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1620">[ date ]</a>
              <a href="thread.html#1620">[ thread ]</a>
              <a href="subject.html#1620">[ subject ]</a>
              <a href="author.html#1620">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: hoijui
Date: 2008-10-22 16:30:10 +0200 (Wed, 22 Oct 2008)
New Revision: 6851

Added:
   branches/caiinterface/installer/builddata/springcontent/EngineOptions.lua
   branches/caiinterface/rts/Game/GlobalConstants.h
   branches/caiinterface/rts/Game/GlobalSynced.cpp
   branches/caiinterface/rts/Game/GlobalSynced.h
   branches/caiinterface/rts/System/GlobalUnsynced.cpp
   branches/caiinterface/rts/System/GlobalUnsynced.h
   branches/caiinterface/rts/System/Vec2.h
Removed:
   branches/caiinterface/rts/System/GlobalStuff.cpp
   branches/caiinterface/rts/System/GlobalStuff.h
   branches/caiinterface/rts/System/nommgr.h
Modified:
   branches/caiinterface/AI/Group/MexUpgraderAI/GroupAI.cpp
   branches/caiinterface/AI/Skirmish/AAI/aidef.h
   branches/caiinterface/AI/Skirmish/JCAI/
   branches/caiinterface/AI/Skirmish/JCAI/BaseAIDef.h
   branches/caiinterface/AI/Skirmish/JCAI/ForceHandler.cpp
   branches/caiinterface/AI/Skirmish/KAI/
   branches/caiinterface/AI/Skirmish/KAI/CoverageHandler.cpp
   branches/caiinterface/AI/Skirmish/KAI/DamageControl.cpp
   branches/caiinterface/AI/Skirmish/KAIK/AttackHandler.cpp
   branches/caiinterface/AI/Skirmish/KAIK/AttackHandler.h
   branches/caiinterface/AI/Skirmish/KAIK/DefenseMatrix.cpp
   branches/caiinterface/AI/Skirmish/KAIK/Defines.h
   branches/caiinterface/AI/Skirmish/KAIK/GlobalAI.cpp
   branches/caiinterface/AI/Skirmish/KAIK/PathFinder.cpp
   branches/caiinterface/AI/Skirmish/KAIK/SunParser.cpp
   branches/caiinterface/AI/Skirmish/KAIK/Unit.cpp
   branches/caiinterface/AI/Skirmish/KAIK/UnitTable.cpp
   branches/caiinterface/AI/Skirmish/NTai/
   branches/caiinterface/AI/Skirmish/NTai/AI/NTai/Helpers/Log.cpp
   branches/caiinterface/AI/Skirmish/NTai/AI/NTai/SDK/AI.h
   branches/caiinterface/Documentation/Spring start.txt
   branches/caiinterface/Documentation/changelog.txt
   branches/caiinterface/installer/builddata/maphelper/maphelper/parse_tdf_map.lua
   branches/caiinterface/installer/make_gamedata_arch.sh
   branches/caiinterface/installer/sections/kp.nsh
   branches/caiinterface/installer/sections/shortcuts.nsh
   branches/caiinterface/installer/sections/tasclient.nsh
   branches/caiinterface/installer/spring.nsi
   branches/caiinterface/installer/springsettings.nsh
   branches/caiinterface/rts/ExternalAI/AICallback.cpp
   branches/caiinterface/rts/ExternalAI/AICallback.h
   branches/caiinterface/rts/ExternalAI/AICheats.cpp
   branches/caiinterface/rts/ExternalAI/AILibraryManager.cpp
   branches/caiinterface/rts/ExternalAI/GlobalAIHandler.cpp
   branches/caiinterface/rts/ExternalAI/GlobalAIHandler.h
   branches/caiinterface/rts/ExternalAI/Group.cpp
   branches/caiinterface/rts/ExternalAI/GroupHandler.h
   branches/caiinterface/rts/ExternalAI/IAICallback.h
   branches/caiinterface/rts/ExternalAI/Interface/AISCommands.h
   branches/caiinterface/rts/ExternalAI/Interface/LegacyCppWrapper/AIAICallback.cpp
   branches/caiinterface/rts/ExternalAI/Interface/LegacyCppWrapper/AIAICallback.h
   branches/caiinterface/rts/ExternalAI/Interface/SOption.cpp
   branches/caiinterface/rts/ExternalAI/Interface/SOption.h
   branches/caiinterface/rts/ExternalAI/SStaticGlobalData.cpp
   branches/caiinterface/rts/ExternalAI/SkirmishAIWrapper.cpp
   branches/caiinterface/rts/Game/Camera.cpp
   branches/caiinterface/rts/Game/Camera/FPSController.cpp
   branches/caiinterface/rts/Game/Camera/FreeController.cpp
   branches/caiinterface/rts/Game/Camera/OrbitController.cpp
   branches/caiinterface/rts/Game/Camera/OrbitController.h
   branches/caiinterface/rts/Game/Camera/OverheadController.cpp
   branches/caiinterface/rts/Game/Camera/OverviewController.cpp
   branches/caiinterface/rts/Game/Camera/RotOverheadController.cpp
   branches/caiinterface/rts/Game/Camera/SmoothController.cpp
   branches/caiinterface/rts/Game/Camera/TWController.cpp
   branches/caiinterface/rts/Game/CameraHandler.cpp
   branches/caiinterface/rts/Game/Game.cpp
   branches/caiinterface/rts/Game/GameHelper.cpp
   branches/caiinterface/rts/Game/GameServer.cpp
   branches/caiinterface/rts/Game/GameServer.h
   branches/caiinterface/rts/Game/GameSetup.cpp
   branches/caiinterface/rts/Game/GameSetup.h
   branches/caiinterface/rts/Game/GameVersion.cpp
   branches/caiinterface/rts/Game/Player.cpp
   branches/caiinterface/rts/Game/PlayerRoster.cpp
   branches/caiinterface/rts/Game/PreGame.cpp
   branches/caiinterface/rts/Game/SelectedUnits.cpp
   branches/caiinterface/rts/Game/SelectedUnitsAI.cpp
   branches/caiinterface/rts/Game/StartScripts/AirScript.cpp
   branches/caiinterface/rts/Game/Team.cpp
   branches/caiinterface/rts/Game/Team.h
   branches/caiinterface/rts/Game/UI/EndGameBox.cpp
   branches/caiinterface/rts/Game/UI/EndGameBox.h
   branches/caiinterface/rts/Game/UI/GameSetupDrawer.cpp
   branches/caiinterface/rts/Game/UI/GuiHandler.cpp
   branches/caiinterface/rts/Game/UI/InputReceiver.h
   branches/caiinterface/rts/Game/UI/MouseCursor.cpp
   branches/caiinterface/rts/Game/UI/MouseHandler.cpp
   branches/caiinterface/rts/Game/UI/QuitBox.cpp
   branches/caiinterface/rts/Game/UI/ResourceBar.cpp
   branches/caiinterface/rts/Game/UI/SelectionKeyHandler.cpp
   branches/caiinterface/rts/Game/UI/ShareBox.cpp
   branches/caiinterface/rts/Game/UI/TooltipConsole.cpp
   branches/caiinterface/rts/Game/WaitCommandsAI.cpp
   branches/caiinterface/rts/Lua/LuaFeatureDefs.cpp
   branches/caiinterface/rts/Lua/LuaGaia.cpp
   branches/caiinterface/rts/Lua/LuaHandle.cpp
   branches/caiinterface/rts/Lua/LuaHandle.h
   branches/caiinterface/rts/Lua/LuaHandleSynced.cpp
   branches/caiinterface/rts/Lua/LuaPathFinder.cpp
   branches/caiinterface/rts/Lua/LuaRules.cpp
   branches/caiinterface/rts/Lua/LuaSyncedCtrl.cpp
   branches/caiinterface/rts/Lua/LuaSyncedRead.cpp
   branches/caiinterface/rts/Lua/LuaUtils.cpp
   branches/caiinterface/rts/Lua/LuaUtils.h
   branches/caiinterface/rts/Lua/LuaWeaponDefs.cpp
   branches/caiinterface/rts/Map/Ground.h
   branches/caiinterface/rts/Map/MapInfo.cpp
   branches/caiinterface/rts/Map/MetalMap.cpp
   branches/caiinterface/rts/Map/MetalMap.h
   branches/caiinterface/rts/Map/ReadMap.h
   branches/caiinterface/rts/Map/SM3/Frustum.cpp
   branches/caiinterface/rts/Map/SM3/Sm3GroundDrawer.cpp
   branches/caiinterface/rts/Map/SM3/terrain/Lightcalc.cpp
   branches/caiinterface/rts/Map/SM3/terrain/QuadRenderData.cpp
   branches/caiinterface/rts/Map/SM3/terrain/Terrain.cpp
   branches/caiinterface/rts/Map/SM3/terrain/TerrainTexture.cpp
   branches/caiinterface/rts/Map/SM3/terrain/TerrainTextureGLSL.cpp
   branches/caiinterface/rts/Map/SM3/terrain/TerrainUtil.cpp
   branches/caiinterface/rts/Map/SM3/terrain/Textures.cpp
   branches/caiinterface/rts/Map/SMF/BFGroundDrawer.cpp
   branches/caiinterface/rts/Map/SMF/SmfReadMap.cpp
   branches/caiinterface/rts/Rendering/Env/AdvSky.cpp
   branches/caiinterface/rts/Rendering/Env/AdvTreeDrawer.cpp
   branches/caiinterface/rts/Rendering/Env/AdvTreeGenerator.cpp
   branches/caiinterface/rts/Rendering/Env/AdvWater.cpp
   branches/caiinterface/rts/Rendering/Env/BaseTreeDrawer.cpp
   branches/caiinterface/rts/Rendering/Env/BasicSky.cpp
   branches/caiinterface/rts/Rendering/Env/BumpWater.cpp
   branches/caiinterface/rts/Rendering/Env/DynWater.cpp
   branches/caiinterface/rts/Rendering/Env/GrassDrawer.cpp
   branches/caiinterface/rts/Rendering/Env/RefractWater.cpp
   branches/caiinterface/rts/Rendering/Env/SkyBox.cpp
   branches/caiinterface/rts/Rendering/FartextureHandler.cpp
   branches/caiinterface/rts/Rendering/GL/myGL.cpp
   branches/caiinterface/rts/Rendering/GroundDecalHandler.cpp
   branches/caiinterface/rts/Rendering/GroundFlash.cpp
   branches/caiinterface/rts/Rendering/IconHandler.cpp
   branches/caiinterface/rts/Rendering/InMapDraw.cpp
   branches/caiinterface/rts/Rendering/ShadowHandler.cpp
   branches/caiinterface/rts/Rendering/Textures/NamedTextures.cpp
   branches/caiinterface/rts/Rendering/Textures/TextureAtlas.cpp
   branches/caiinterface/rts/Rendering/Textures/TextureHandler.cpp
   branches/caiinterface/rts/Rendering/UnitModels/3DModelParser.h
   branches/caiinterface/rts/Rendering/UnitModels/3DOParser.cpp
   branches/caiinterface/rts/Rendering/UnitModels/UnitDrawer.cpp
   branches/caiinterface/rts/Rendering/glFont.cpp
   branches/caiinterface/rts/Rendering/glFont.h
   branches/caiinterface/rts/Sim/Features/Feature.cpp
   branches/caiinterface/rts/Sim/Features/FeatureHandler.cpp
   branches/caiinterface/rts/Sim/Misc/AirBaseHandler.cpp
   branches/caiinterface/rts/Sim/Misc/AirBaseHandler.h
   branches/caiinterface/rts/Sim/Misc/GeometricObjects.cpp
   branches/caiinterface/rts/Sim/Misc/GroundBlockingObjectMap.cpp
   branches/caiinterface/rts/Sim/Misc/InterceptHandler.cpp
   branches/caiinterface/rts/Sim/Misc/QuadField.cpp
   branches/caiinterface/rts/Sim/Misc/QuadField.h
   branches/caiinterface/rts/Sim/Misc/Wind.cpp
   branches/caiinterface/rts/Sim/ModInfo.cpp
   branches/caiinterface/rts/Sim/MoveTypes/GroundMoveType.cpp
   branches/caiinterface/rts/Sim/MoveTypes/ScriptMoveType.cpp
   branches/caiinterface/rts/Sim/MoveTypes/TAAirMoveType.cpp
   branches/caiinterface/rts/Sim/Objects/SolidObject.cpp
   branches/caiinterface/rts/Sim/Objects/SolidObject.h
   branches/caiinterface/rts/Sim/Path/PathCache.cpp
   branches/caiinterface/rts/Sim/Path/PathCache.h
   branches/caiinterface/rts/Sim/Projectiles/ExplosionGenerator.cpp
   branches/caiinterface/rts/Sim/Projectiles/FireProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/FlareProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/PieceProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/Projectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/ProjectileHandler.cpp
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/BitmapMuzzleFlame.cpp
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/BubbleProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/DirtProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/ExploSpikeProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/GenericParticleProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/GeoSquareProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/GeoThermSmokeProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/GfxProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/HeatCloudProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/MuzzleFlame.cpp
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/RepulseGfx.cpp
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/ShieldPartProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/SimpleParticleSystem.cpp
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/SmokeProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/SmokeProjectile2.cpp
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/SmokeTrailProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/SmokeTrailProjectile.h
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/SpherePartProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/TracerProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/WakeProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/WreckProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/EmgProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/ExplosiveProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/FireBallProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/FlameProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/LargeBeamLaserProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/LaserProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/LightingProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/MissileProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/StarburstProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/TorpedoProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/WeaponProjectile.cpp
   branches/caiinterface/rts/Sim/Units/COB/CobInstance.cpp
   branches/caiinterface/rts/Sim/Units/COB/CobInstance.h
   branches/caiinterface/rts/Sim/Units/COB/CobThread.cpp
   branches/caiinterface/rts/Sim/Units/CommandAI/AirCAI.cpp
   branches/caiinterface/rts/Sim/Units/CommandAI/BuilderCAI.cpp
   branches/caiinterface/rts/Sim/Units/CommandAI/CommandAI.cpp
   branches/caiinterface/rts/Sim/Units/CommandAI/FactoryCAI.cpp
   branches/caiinterface/rts/Sim/Units/CommandAI/LineDrawer.cpp
   branches/caiinterface/rts/Sim/Units/CommandAI/MobileCAI.cpp
   branches/caiinterface/rts/Sim/Units/CommandAI/TransportCAI.cpp
   branches/caiinterface/rts/Sim/Units/Unit.cpp
   branches/caiinterface/rts/Sim/Units/Unit.h
   branches/caiinterface/rts/Sim/Units/UnitHandler.cpp
   branches/caiinterface/rts/Sim/Units/UnitTracker.cpp
   branches/caiinterface/rts/Sim/Units/UnitTypes/Builder.cpp
   branches/caiinterface/rts/Sim/Units/UnitTypes/Building.cpp
   branches/caiinterface/rts/Sim/Units/UnitTypes/ExtractorBuilding.cpp
   branches/caiinterface/rts/Sim/Units/UnitTypes/ExtractorBuilding.h
   branches/caiinterface/rts/Sim/Units/UnitTypes/Factory.cpp
   branches/caiinterface/rts/Sim/Weapons/DGunWeapon.cpp
   branches/caiinterface/rts/Sim/Weapons/PlasmaRepulser.cpp
   branches/caiinterface/rts/Sim/Weapons/WeaponDefHandler.cpp
   branches/caiinterface/rts/Sim/Weapons/bombdropper.cpp
   branches/caiinterface/rts/System/DemoRecorder.cpp
   branches/caiinterface/rts/System/FastMath.h
   branches/caiinterface/rts/System/LoadSaveHandler.cpp
   branches/caiinterface/rts/System/LogOutput.cpp
   branches/caiinterface/rts/System/Matrix44f.cpp
   branches/caiinterface/rts/System/Matrix44f.h
   branches/caiinterface/rts/System/Messages.cpp
   branches/caiinterface/rts/System/MouseInput.cpp
   branches/caiinterface/rts/System/MouseInput.h
   branches/caiinterface/rts/System/Platform/FileSystem.h
   branches/caiinterface/rts/System/Platform/Linux/DataDirLocater.cpp
   branches/caiinterface/rts/System/Script/LuaBinder.cpp
   branches/caiinterface/rts/System/Script/LuaFunctions.cpp
   branches/caiinterface/rts/System/Sound.cpp
   branches/caiinterface/rts/System/Sound.h
   branches/caiinterface/rts/System/SpringApp.cpp
   branches/caiinterface/rts/System/SpringApp.h
   branches/caiinterface/rts/System/StdAfx.h
   branches/caiinterface/rts/System/Sync/SyncDebugger.cpp
   branches/caiinterface/rts/System/Sync/SyncDebugger.h
   branches/caiinterface/rts/System/Sync/SyncedPrimitive.h
   branches/caiinterface/rts/System/float3.h
   branches/caiinterface/rts/System/myMath.cpp
   branches/caiinterface/rts/System/myMath.h
   branches/caiinterface/rts/build/vstudio8/rts.vcproj
   branches/caiinterface/tools/unitsync/CMakeLists.txt
   branches/caiinterface/tools/unitsync/test/test.cpp
   branches/caiinterface/tools/unitsync/unitsync.cpp
   branches/caiinterface/tools/unitsync/unitsync_api.h
Log:
reintegrated trunk up to 6844

Modified: branches/caiinterface/AI/Group/MexUpgraderAI/GroupAI.cpp
===================================================================
--- branches/caiinterface/AI/Group/MexUpgraderAI/GroupAI.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/AI/Group/MexUpgraderAI/GroupAI.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -13,7 +13,7 @@
 #include &quot;creg/STL_Set.h&quot;
 #include &quot;creg/Serializer.h&quot;
 #include &quot;creg/cregex.h&quot;
-#include &quot;System/GlobalStuff.h&quot;
+#include &quot;Game/GlobalConstants.h&quot;
 
 #define CMD_CHANGE_MODE 	160
 #define CMD_AREA_UPGRADE 	165

Modified: branches/caiinterface/AI/Skirmish/AAI/aidef.h
===================================================================
--- branches/caiinterface/AI/Skirmish/AAI/aidef.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/AI/Skirmish/AAI/aidef.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -18,9 +18,10 @@
 #include &quot;ExternalAI/IGlobalAICallback.h&quot;
 #include &quot;ExternalAI/IAICallback.h&quot;
 #include &quot;ExternalAI/aibase.h&quot;
+#include &quot;System/Vec2.h&quot;
+#include &quot;Game/GlobalConstants.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;Sim/MoveTypes/MoveInfo.h&quot;
-#include &quot;GlobalStuff.h&quot;
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
 #include &quot;Sim/Units/CommandAI/CommandQueue.h&quot;
 #include &quot;AAIConfig.h&quot;


Property changes on: branches/caiinterface/AI/Skirmish/JCAI
___________________________________________________________________
Name: svn:mergeinfo
   - 

Modified: branches/caiinterface/AI/Skirmish/JCAI/BaseAIDef.h
===================================================================
--- branches/caiinterface/AI/Skirmish/JCAI/BaseAIDef.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/AI/Skirmish/JCAI/BaseAIDef.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -9,7 +9,8 @@
 #ifndef JC_BASE_AI_DEF_H
 #define JC_BASE_AI_DEF_H
 
-#include &quot;GlobalStuff.h&quot;
+#include &quot;System/Vec2.h&quot;
+#include &quot;Game/GlobalConstants.h&quot;
 #include &quot;ExternalAI/IGlobalAI.h&quot;
 #include &quot;ExternalAI/IGlobalAICallback.h&quot;
 #include &quot;ExternalAI/IAICallback.h&quot;

Modified: branches/caiinterface/AI/Skirmish/JCAI/ForceHandler.cpp
===================================================================
--- branches/caiinterface/AI/Skirmish/JCAI/ForceHandler.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/AI/Skirmish/JCAI/ForceHandler.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -312,7 +312,7 @@
 bool UnitGroup::CalcPositioning (float2&amp; pmin, float2&amp; pmax, float2&amp; mid, int2&amp; cs)
 {
 	const float l=10000000;
-	float2 sum= {0.0f,0.0f};
+	float2 sum(0.0f,0.0f);
 	pmin.x=pmin.y=l;pmax.x=pmax.y=-l;
 
 	int bestdis=10000000;


Property changes on: branches/caiinterface/AI/Skirmish/KAI
___________________________________________________________________
Name: svn:mergeinfo
   - 

Modified: branches/caiinterface/AI/Skirmish/KAI/CoverageHandler.cpp
===================================================================
--- branches/caiinterface/AI/Skirmish/KAI/CoverageHandler.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/AI/Skirmish/KAI/CoverageHandler.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -1,7 +1,6 @@
 
 #include &quot;CoverageHandler.h&quot;
 
-#include &quot;System/GlobalStuff.h&quot;
 
 #define COVERAGE_SQUARE 4.0
 #define COVERAGE_SQUARE2 32.0

Modified: branches/caiinterface/AI/Skirmish/KAI/DamageControl.cpp
===================================================================
--- branches/caiinterface/AI/Skirmish/KAI/DamageControl.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/AI/Skirmish/KAI/DamageControl.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -1,6 +1,6 @@
 #include &quot;DamageControl.h&quot;
 
-#include &quot;System/GlobalStuff.h&quot;
+#include &quot;Game/GlobalConstants.h&quot;
 
 CDamageControl::CDamageControl(AIClasses* ai)
 {

Modified: branches/caiinterface/AI/Skirmish/KAIK/AttackHandler.cpp
===================================================================
--- branches/caiinterface/AI/Skirmish/KAIK/AttackHandler.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/AI/Skirmish/KAIK/AttackHandler.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -17,7 +17,7 @@
 CR_REG_METADATA(CAttackHandler, (
 	CR_MEMBER(ai),
 
-	CR_MEMBER(units),
+	CR_MEMBER(attackUnits),
 	CR_MEMBER(stuckUnits),
 	CR_MEMBER(unarmedAirUnits),
 	CR_MEMBER(armedAirUnits),
@@ -81,14 +81,13 @@
 
 		// patrol orders need to be updated
 		airPatrolOrdersGiven = false;
-	}
-	else {
+	} else {
 		// the groupID of this &quot;group&quot; is 0, to separate them from other idle units
 		ai-&gt;MyUnits[unitID]-&gt;groupID = IDLE_GROUP_ID;
 		// this might be a new unit with the same id as an older dead unit
 		ai-&gt;MyUnits[unitID]-&gt;stuckCounter = 0;
 		// do some checking then essentially add it to defense group
-		units.push_back(unitID);
+		attackUnits.push_back(unitID);
 		// TODO: not that good
 		this-&gt;PlaceIdleUnit(unitID);
 	}
@@ -102,14 +101,20 @@
 	if (attackGroupID == IDLE_GROUP_ID) {
 		bool found_dead_unit_in_attackHandler = false;
 
-		for (list&lt;int&gt;::iterator it = units.begin(); it != units.end(); it++) {
+		for (list&lt;int&gt;::iterator it = attackUnits.begin(); it != attackUnits.end(); it++) {
 			if (*it == unitID) {
-				units.erase(it);
+				attackUnits.erase(it);
 				found_dead_unit_in_attackHandler = true;
 				break;
 			}
 		}
-		assert(found_dead_unit_in_attackHandler);
+
+		if (!found_dead_unit_in_attackHandler) {
+			// one of our (idle) attack units died but
+			// we somehow have lost track of it before
+			L(&quot;[CAttackHandler::UnitDestroyed(&quot; &lt;&lt; unitID &lt;&lt; &quot;)] idle attacker destroyed but already erased&quot;);
+			return;
+		}
 	}
 
 	else if (attackGroupID &gt;= GROUND_GROUP_ID_START) {
@@ -961,7 +966,7 @@
 
 	// check if we have any new units, add them to a
 	// nearby defending group of less than 16 units
-	if (frameNr % 30 == 0 &amp;&amp; units.size() &gt; 0) {
+	if (frameNr % 30 == 0 &amp;&amp; attackUnits.size() &gt; 0) {
 		CAttackGroup* existingGroup = NULL;
 		for (list&lt;CAttackGroup&gt;::iterator it = attackGroups.begin(); it != attackGroups.end(); it++) {
 			if (it-&gt;Size() &lt; 16 &amp;&amp; it-&gt;defending &amp;&amp; this-&gt;DistanceToBase(it-&gt;GetGroupPos()) &lt; 300) {
@@ -973,14 +978,14 @@
 
 		if (existingGroup != NULL) {
 			// add all new units to found group
-			for (list&lt;int&gt;::iterator it = units.begin(); it != units.end(); it++) {
+			for (list&lt;int&gt;::iterator it = attackUnits.begin(); it != attackUnits.end(); it++) {
 				int unit = *it;
 				if (ai-&gt;cb-&gt;GetUnitDef(unit) != NULL) {
 					existingGroup-&gt;AddUnit(unit);
 				}
 			}
 
-			units.clear();
+			attackUnits.clear();
 		}
 		else {
 			// no suitable group found, make new defending one
@@ -988,14 +993,14 @@
 			CAttackGroup newGroup(ai, newGroupID);
 			newGroup.defending = true;
 
-			for (list&lt;int&gt;::iterator it = units.begin(); it != units.end(); it++) {
+			for (list&lt;int&gt;::iterator it = attackUnits.begin(); it != attackUnits.end(); it++) {
 				int unit = *it;
 				if (ai-&gt;cb-&gt;GetUnitDef(unit) != NULL) {
 					newGroup.AddUnit(unit);
 				}
 			}
 
-			units.clear();
+			attackUnits.clear();
 			attackGroups.push_back(newGroup);
 		}
 	}

Modified: branches/caiinterface/AI/Skirmish/KAIK/AttackHandler.h
===================================================================
--- branches/caiinterface/AI/Skirmish/KAIK/AttackHandler.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/AI/Skirmish/KAIK/AttackHandler.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -56,7 +56,7 @@
 	private:
 		AIClasses* ai;
 
-		list&lt;int&gt; units;
+		list&lt;int&gt; attackUnits;
 		list&lt; pair&lt;int, float3&gt; &gt; stuckUnits;
 		// TODO: should be sets
 		list&lt;int&gt; unarmedAirUnits;

Modified: branches/caiinterface/AI/Skirmish/KAIK/DefenseMatrix.cpp
===================================================================
--- branches/caiinterface/AI/Skirmish/KAIK/DefenseMatrix.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/AI/Skirmish/KAIK/DefenseMatrix.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -1,6 +1,5 @@
 #include &quot;DefenseMatrix.h&quot;
 
-#include &quot;System/GlobalStuff.h&quot;
 
 CR_BIND(CDefenseMatrix, (NULL));
 CR_REG_METADATA(CDefenseMatrix, (

Modified: branches/caiinterface/AI/Skirmish/KAIK/Defines.h
===================================================================
--- branches/caiinterface/AI/Skirmish/KAIK/Defines.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/AI/Skirmish/KAIK/Defines.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -2,12 +2,12 @@
 #define DEFINES_H
 
 #define AI_NAME			&quot;KAIK 0.13 Unofficial&quot;
-#define AI_DATE			&quot;14/10/2008&quot;
+#define AI_DATE			&quot;20/10/2008&quot;
 #define AI_VERSION		AI_NAME &quot; (rev. &quot; AI_DATE &quot;)&quot;
 #define AI_CREDITS		&quot;(original developer: Krogothe, current maintainer: Kloot)&quot;
 
 // Logger
-#define L(a)			(*ai-&gt;LOGGER &lt;&lt; a &lt;&lt; endl)
+#define L(a)			(*ai-&gt;LOGGER &lt;&lt; a &lt;&lt; std::endl)
 #define LN(a)			(*ai-&gt;LOGGER &lt;&lt; a)
 
 // Shortcuts

Modified: branches/caiinterface/AI/Skirmish/KAIK/GlobalAI.cpp
===================================================================
--- branches/caiinterface/AI/Skirmish/KAIK/GlobalAI.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/AI/Skirmish/KAIK/GlobalAI.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -165,7 +165,7 @@
 
 	int team = ai-&gt;cb-&gt;GetMyTeam();
 
-	sprintf(c, &quot;%s%s %2.2d-%2.2d-%4.4d %2.2d%2.2d (%d).log&quot;,
+	sprintf(c, &quot;%s%s %2.2d-%2.2d-%4.4d %2.2d%2.2d (team %d).log&quot;,
 		string(LOGFOLDER).c_str(), mapname.c_str(), now2-&gt;tm_mon + 1, now2-&gt;tm_mday, now2-&gt;tm_year + 1900, now2-&gt;tm_hour, now2-&gt;tm_min, team);
 
 	char cfgFolder[256]; sprintf(cfgFolder, &quot;%s&quot;, CFGFOLDER);
@@ -236,7 +236,7 @@
 	struct tm* now2 = localtime(&amp;now1);
 
 	// timestamp logfile name
-	sprintf(this-&gt;c, &quot;%s%s %2.2d-%2.2d-%4.4d %2.2d%2.2d (%d).log&quot;,
+	sprintf(this-&gt;c, &quot;%s%s %2.2d-%2.2d-%4.4d %2.2d%2.2d (team %d).log&quot;,
 		string(LOGFOLDER).c_str(), mapname.c_str(), (now2-&gt;tm_mon + 1), now2-&gt;tm_mday, (now2-&gt;tm_year + 1900), now2-&gt;tm_hour, now2-&gt;tm_min, team);
 
 	char cfgFolder[256]; sprintf(cfgFolder, &quot;%s&quot;, CFGFOLDER);

Modified: branches/caiinterface/AI/Skirmish/KAIK/PathFinder.cpp
===================================================================
--- branches/caiinterface/AI/Skirmish/KAIK/PathFinder.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/AI/Skirmish/KAIK/PathFinder.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -72,7 +72,6 @@
 	}
 
 	// get all the different movetypes
-	// L(&quot;Getting Movearrays&quot;);
 	vector&lt;int&gt; moveslopes;
 	vector&lt;int&gt; maxwaterdepths;
 	vector&lt;int&gt;	minwaterdepths;
@@ -81,26 +80,23 @@
 	string Valuestring = &quot;0&quot;;
 	char k[50];
 
-	// L(&quot;Loading sidedata&quot;);
+	// FIXME: can be a .lua script now
 	ai-&gt;parser-&gt;LoadVirtualFile(&quot;gamedata\\MOVEINFO.tdf&quot;);
 
-	// L(&quot;Starting Loop&quot;);
 	while(Valuestring != errorstring) {
-		// L(&quot;Run Number: &quot; &lt;&lt; NumOfMoveTypes);
 		sprintf(k, &quot;%i&quot;, NumOfMoveTypes);
 		ai-&gt;parser-&gt;GetDef(Valuestring, errorstring, string(sectionstring + k + &quot;\\Name&quot;));
-		// L(&quot;Movetype: &quot; &lt;&lt; Valuestring);
 
 		if (Valuestring != errorstring) {
 			ai-&gt;parser-&gt;GetDef(Valuestring, string(&quot;10000&quot;), string(sectionstring + k + &quot;\\MaxWaterDepth&quot;));
 			maxwaterdepths.push_back(atoi(Valuestring.c_str()));
-			// L(&quot;Max water depth: &quot; &lt;&lt; Valuestring);
+
 			ai-&gt;parser-&gt;GetDef(Valuestring, string(&quot;-10000&quot;), string(sectionstring + k + &quot;\\MinWaterDepth&quot;));
 			minwaterdepths.push_back(atoi(Valuestring.c_str()));
-			// L(&quot;minwaterdepths: &quot; &lt;&lt; Valuestring);
+
 			ai-&gt;parser-&gt;GetDef(Valuestring, string(&quot;10000&quot;), string(sectionstring + k + &quot;\\MaxSlope&quot;));
 			moveslopes.push_back(atoi(Valuestring.c_str()));
-			// L(&quot;moveslopes: &quot; &lt;&lt; Valuestring);
+
 			NumOfMoveTypes++;
 		}
 	}
@@ -124,7 +120,6 @@
 			if (SlopeMap[i] &gt; moveslopes[m] || HeightMap[i] &lt;= -maxwaterdepths[m] || HeightMap[i] &gt;= -minwaterdepths[m]) {
 				MoveArrays[m][i] = false;
 				TestMoveArray[i] = true;
-				// L(&quot;false&quot;);
 			}
 			else {
 				MoveArrays[m][i] = true;
@@ -242,7 +237,6 @@
 
 void CPathFinder::PrintData(string s) {
 	s = s;
-	// L(s);
 }
 
 void CPathFinder::ClearPath() {
@@ -275,7 +269,6 @@
 }
 
 void* CPathFinder::Pos2Node(float3 pos) {
-	// L(&quot;pos.x = &quot; &lt;&lt; pos.x &lt;&lt; &quot; pos.z= &quot; &lt;&lt; pos.z &lt;&lt; &quot; node: &quot; &lt;&lt; (pos.z / (8 * THREATRES)) * PathMapXSize +  (pos.x / (8 * THREATRES)));
 	return ((void*) (int(pos.z / 8 / THREATRES) * PathMapXSize + int((pos.x / 8 / THREATRES))));
 }
 
@@ -326,7 +319,6 @@
 	pair&lt;int, int&gt;* offsets;
 
 	{
-		// L(&quot;radius: &quot; &lt;&lt; radius);
 		int DoubleRadius = radius * 2;
 		// used to speed up loops so no recalculation needed
 		int SquareRadius = radius * radius;
@@ -346,7 +338,6 @@
 		index++;
 
 		for (int a = 1; a &lt; radius + 1; a++) {
-			// L(&quot;a: &quot; &lt;&lt; a);
 			int endPos = xend[a];
 			int startPos = xend[a - 1];
 
@@ -387,7 +378,6 @@
 	for (unsigned i = 0; i &lt; possibleTargets-&gt;size(); i++) {
 		float3 f = (*possibleTargets)[i];
 		int x, y;
-		// L(&quot;Added: x: &quot; &lt;&lt; f.x &lt;&lt; &quot;, z: &quot; &lt;&lt; f.z);
 		// TODO: make the circle here
 
 		ai-&gt;math-&gt;F3MapBound(&amp;f);

Modified: branches/caiinterface/AI/Skirmish/KAIK/SunParser.cpp
===================================================================
--- branches/caiinterface/AI/Skirmish/KAIK/SunParser.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/AI/Skirmish/KAIK/SunParser.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -90,7 +90,7 @@
 			}
 		}
 		else if (buf[0] == '/' &amp;&amp; buf[1] == '*') {
-			//comment
+			// comment
 			while ((buf != endptr) &amp;&amp; buf[0] != '*' || buf[1] != '/') {
 				buf++;
 			}

Modified: branches/caiinterface/AI/Skirmish/KAIK/Unit.cpp
===================================================================
--- branches/caiinterface/AI/Skirmish/KAIK/Unit.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/AI/Skirmish/KAIK/Unit.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -1,7 +1,7 @@
 #include &quot;Unit.h&quot;
 #include &quot;GlobalAI.h&quot;
 
-#include &quot;System/GlobalStuff.h&quot;
+#include &quot;Game/GlobalConstants.h&quot;
 
 CR_BIND(CUNIT, )
 CR_REG_METADATA(CUNIT, (

Modified: branches/caiinterface/AI/Skirmish/KAIK/UnitTable.cpp
===================================================================
--- branches/caiinterface/AI/Skirmish/KAIK/UnitTable.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/AI/Skirmish/KAIK/UnitTable.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -2,7 +2,7 @@
 
 #include &quot;UnitTable.h&quot;
 
-#include &quot;System/GlobalStuff.h&quot;
+#include &quot;Game/GlobalConstants.h&quot;
 #include &quot;System/Util.h&quot;
 
 /// CR_BIND(CUnitTable, );
@@ -79,6 +79,8 @@
 
 
 int CUnitTable::BuildModSideMap() {
+	L(&quot;[CUnitTable::BuildModSideMap()]&quot;);
+
 	// get all sides and commanders
 	std::string commKey;	// eg. &quot;SIDE4\\commander&quot;
 	std::string commName;	// eg. &quot;arm_commander&quot;
@@ -86,12 +88,13 @@
 	std::string sideName;	// eg. &quot;Arm&quot;
 	char sideNum[64] = {0};
 
+	// FIXME: can be a .lua script now
 	ai-&gt;parser-&gt;LoadVirtualFile(&quot;gamedata\\SIDEDATA.tdf&quot;);
 
 	// look at SIDE0 through SIDE9
 	// (should be enough for any mod)
-	for (int i = 0; i &lt; 10; i++) {
-		sprintf(sideNum, &quot;%i&quot;, i);
+	for (int side = 0; side &lt; 10; side++) {
+		sprintf(sideNum, &quot;%i&quot;, side);
 
 		commKey = &quot;SIDE&quot; + std::string(sideNum) + &quot;\\commander&quot;;
 		sideKey = &quot;SIDE&quot; + std::string(sideNum) + &quot;\\name&quot;;
@@ -108,8 +111,12 @@
 			StringToLowerInPlace(sideName);
 
 			sideNames.push_back(sideName);
-			modSideMap[sideName] = i;
-			numOfSides = i + 1;
+			modSideMap[sideName] = side;
+			numOfSides = side + 1;
+
+			L(&quot;\tside index: &quot; &lt;&lt; side &lt;&lt; &quot;, root unit: &quot; &lt;&lt; udef-&gt;name &lt;&lt; &quot;, side name: &quot; &lt;&lt; sideName &lt;&lt; &quot;, &quot; &lt;&lt; sideName &lt;&lt; &quot; ==&gt; &quot; &lt;&lt; side);
+		} else {
+			L(&quot;\tside &quot; &lt;&lt; side &lt;&lt; &quot; not defined&quot;);
 		}
 	}
 
@@ -117,18 +124,24 @@
 }
 
 int CUnitTable::ReadTeamSides() {
+	L(&quot;[CUnitTable::ReadTeamSides()]&quot;);
+
 	teamSides.resize(MAX_TEAMS, 0);
 	teamSides[0] = 0;	// team 0 defaults to side 0 (in GlobalAI startscript)
 	teamSides[1] = 1;	// team 1 defaults to side 1 (in GlobalAI startscript)
 
-	for (int i = 0; i &lt; MAX_TEAMS; i++) {
-		const char* sideKey = ai-&gt;cb-&gt;GetTeamSide(i);
+	for (int team = 0; team &lt; MAX_TEAMS; team++) {
+		const char* sideKey = ai-&gt;cb-&gt;GetTeamSide(team);
 
 		if (sideKey) {
 			// FIXME: Gaia-team side?
 			// team index was valid (and we are in a GameSetup-type
 			// game), override the default side index for this team
-			teamSides[i] = modSideMap[sideKey];
+			teamSides[team] = modSideMap[sideKey];
+
+			L(&quot;\tteam: &quot; &lt;&lt; team &lt;&lt; &quot;, side: &quot; &lt;&lt; modSideMap[sideKey] &lt;&lt; &quot; (index: &quot; &lt;&lt; teamSides[team] &lt;&lt; &quot;)&quot;);
+		} else {
+			L(&quot;\tno \&quot;game\\team\\side\&quot; value found for team &quot; &lt;&lt; team);
 		}
 	}
 
@@ -137,6 +150,8 @@
 
 // called at the end of Init()
 void CUnitTable::ReadModConfig() {
+	L(&quot;[CUnitTable::ReadModConfig()]&quot;);
+
 	const char* modName = ai-&gt;cb-&gt;GetModName();
 	char configFileName[1024] = {0};
 	char logMsg[2048] = {0};
@@ -146,6 +161,8 @@
 	FILE* f = fopen(configFileName, &quot;r&quot;);
 
 	if (f) {
+		L(&quot;\tparsing existing mod configuration file &quot; &lt;&lt; configFileName);
+
 		// read the mod's .cfg file
 		char str[1024];
 		char name[512];
@@ -166,13 +183,17 @@
 				utype-&gt;costMultiplier = costMult;
 				utype-&gt;techLevel = techLvl;
 
+				L(&quot;\t\tudef-&gt;id: &quot; &lt;&lt; udef-&gt;id &lt;&lt; &quot;, udef-&gt;name: &quot; &lt;&lt; udef-&gt;name &lt;&lt; &quot;, utype-&gt;category: &quot; &lt;&lt; utype-&gt;category &lt;&lt; &quot;, .cfg category: &quot; &lt;&lt; category);
+
 				// TODO: look for any possible side-effects that might arise
 				// from overriding categories like this, then enable overrides
-				// other than builder --&gt; attacker
+				// other than builder --&gt; attacker?
 				// FIXME: SEGV when unarmed CAT_BUILDER units masquerading as
 				// CAT_G_ATTACK'ers want to or are attacked
 				if (category &gt;= 0 &amp;&amp; category &lt; LASTCATEGORY) {
 					if (category == CAT_G_ATTACK &amp;&amp; utype-&gt;category == CAT_BUILDER) {
+						L(&quot;\t\t\t.cfg category (CAT_G_ATTACK) overrides utype-&gt;category (CAT_BUILDER)&quot;);
+
 						// maps unit categories to indices into all_lists
 						// FIXME: hackish, poorly maintainable, bad style
 						int catLstIdx[11] = {0, 5, 3, 4, 1, 8, 7, 0, 6, 2, 9};
@@ -211,6 +232,8 @@
 
 		sprintf(logMsg, &quot;read mod configuration file %s&quot;, configFileName);
 	} else {
+		L(&quot;\tcreating new mod configuration file &quot; &lt;&lt; configFileName);
+
 		// write a new .cfg file with default values
 		f = fopen(configFileName, &quot;w&quot;);
 		fprintf(f, &quot;// unitName costMultiplier techLevel category\n&quot;);
@@ -222,6 +245,8 @@
 			utype-&gt;costMultiplier = 1.0f;
 			utype-&gt;techLevel = -1;
 			fprintf(f, &quot;%s %.2f %d %d\n&quot;, utype-&gt;def-&gt;name.c_str(), utype-&gt;costMultiplier, utype-&gt;techLevel, utype-&gt;category);
+
+			L(&quot;\t\tname: &quot; &lt;&lt; (utype-&gt;def-&gt;name) &lt;&lt; &quot;, .cfg category: &quot; &lt;&lt; (utype-&gt;category));
 		}
 
 		sprintf(logMsg, &quot;wrote mod configuration file %s&quot;, configFileName);
@@ -245,9 +270,14 @@
 }
 
 int CUnitTable::GetCategory(int unit) {
-	assert(ai-&gt;cb-&gt;GetUnitDef(unit) != NULL);
+	const UnitDef* udef = ai-&gt;cb-&gt;GetUnitDef(unit);
 
-	return (unitTypes[ai-&gt;cb-&gt;GetUnitDef(unit)-&gt;id].category);
+	if (udef != NULL) {
+		UnitType&amp; utype = unitTypes[udef-&gt;id];
+		return (utype.category);
+	} else {
+		return -1;
+	}
 }
 
 


Property changes on: branches/caiinterface/AI/Skirmish/NTai
___________________________________________________________________
Name: svn:mergeinfo
   - 

Modified: branches/caiinterface/AI/Skirmish/NTai/AI/NTai/Helpers/Log.cpp
===================================================================
--- branches/caiinterface/AI/Skirmish/NTai/AI/NTai/Helpers/Log.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/AI/Skirmish/NTai/AI/NTai/Helpers/Log.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -286,4 +286,4 @@
 	bool Log::IsVerbose(){
 		return verbose;
 	}
-}
\ No newline at end of file
+}

Modified: branches/caiinterface/AI/Skirmish/NTai/AI/NTai/SDK/AI.h
===================================================================
--- branches/caiinterface/AI/Skirmish/NTai/AI/NTai/SDK/AI.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/AI/Skirmish/NTai/AI/NTai/SDK/AI.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -28,7 +28,7 @@
 #include &quot;ExternalAI/IAICallback.h&quot; // AI Callback
 #include &quot;ExternalAI/IGlobalAICallback.h&quot; //GlobalAI callback
 #include &quot;ExternalAI/IAICheats.h&quot; // Cheat Interface
-#include &quot;GlobalStuff.h&quot; // Common definitions in spring
+#include &quot;Game/GlobalConstants.h&quot; // Common definitions in spring
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot; // Needed for WeaponDef
 #include &quot;Sim/Misc/DamageArray.h&quot; // Needed for WeaponDef
 #include &quot;Sim/MoveTypes/MoveInfo.h&quot;

Modified: branches/caiinterface/Documentation/Spring start.txt
===================================================================
--- branches/caiinterface/Documentation/Spring start.txt	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/Documentation/Spring start.txt	2008-10-22 14:30:10 UTC (rev 6851)
@@ -26,23 +26,8 @@
 	Mapname=;           //with .smf extension
 	Gametype=xtape.sd7; //the primary mod archive
 	Scriptname=Commanders;
-	StartMetal=1000;
-	StartEnergy=1000;
-	MaxUnits=500;       // per team
 	StartPosType=x;     // 0 fixed, 1 random, 2 choose in game, 3 choose before game (see StartPosX)
-	GameMode=x;         // 0 cmdr dead-&gt;game continues, 1 cmdr dead-&gt;game ends, 2 lineage
-	LimitDgun=0;        // limit dgun to fixed radius around startpos?
-	DiminishingMMs=0;   // diminish metal maker's metal production for every new one of them?
-	DisableMapDamage=0; // disable map craters?
-	GhostedBuildings=1; // ghost enemy buildings after losing los on them
-	NoHelperAIs=0;      // are GroupAIs and other helper AIs allowed?
-	LuaGaia=1;          // Use LuaGaia?
-	LuaRules=1;         // Use LuaRules?
-	FixedAllies=1;      // Are ingame alliances allowed?
 
-	MaxSpeed=3;         // speed limits at game start
-	MinSpeed=0.3;
-
 	Demofile=demo.sdf;  // if set this game is a multiplayer demo replay
 	Savefile=save.ssf;  // if set this game is a continuation of a saved game
 
@@ -109,4 +94,21 @@
 		Limit1=50;      // &gt;0 can be used for limiting, like build restrictions in TA
 		//...
 	}
+	[MODOPTIONS]
+	{
+		StartMetal=1000;
+		StartEnergy=1000;
+		MaxUnits=500;       // per team
+		GameMode=x;         // 0 cmdr dead-&gt;game continues, 1 cmdr dead-&gt;game ends, 2 lineage
+		LimitDgun=0;        // limit dgun to fixed radius around startpos?
+		DiminishingMMs=0;   // diminish metal maker's metal production for every new one of them?
+		DisableMapDamage=0; // disable map craters?
+		GhostedBuildings=1; // ghost enemy buildings after losing los on them
+		NoHelperAIs=0;      // are GroupAIs and other helper AIs allowed?
+		LuaGaia=1;          // Use LuaGaia?
+		LuaRules=1;         // Use LuaRules?
+		FixedAllies=1;      // Are ingame alliances allowed?
+		MaxSpeed=3;         // speed limits at game start
+		MinSpeed=0.3;
+	}
 }

Modified: branches/caiinterface/Documentation/changelog.txt
===================================================================
--- branches/caiinterface/Documentation/changelog.txt	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/Documentation/changelog.txt	2008-10-22 14:30:10 UTC (rev 6851)
@@ -1,13 +1,46 @@
 Spring change log
 
 0.77b5
+Installer:
+ - check if common unitsync users are running, abort installation if any is found
+ - don't download and install RiverDale and SmallDivide when the user already has it
+
 Crashes:
+ - even more preventions of DIV0
 
+User Interface:
+ - whe watching a demo with a setup locally, overwrite maxspeed with 10
+ - fix mousehover detection for radar icons
+ - fixed performance of Lua fontHandler
+ - make the orbit-controller actually do something on win32
+ - make the orbit-controller speeds configurable
+ - rescale fonts on window resize so they don't look ugly
+ - fixed black border blending of fonts
+ - ATI drivers lie about not supporting extensions required by shadows. we ignore that extension now
+
 Engine:
  - new fbi tag: bankingAllowed - only affects hoverAttack=1 units; controls if the aircraft can bank.
  - fbi tag upright now affects gunships
+ - fix CAirMoveType using an uninitialized variable (maxSpeed)
+ - fix Aircraft fuel not working properly on units with multiple weapons
+ - fix SendLuaMsg
+ - improve heading table resolution, this makes huge units less jerky
+ - fix the gamespeed not going back up after it was slowed down
+ - when ArchiveCache has not been written yet, do not add archive dependencies that are already in the chain (was breaking demos)
+ - fix factories switching their yardmap to fully-blocked when a unit is present inside (so units don't getstuck inside)
+ - fixed map defined detailtex
+ - fix LUA Spring.GetTeamResources does not return &quot;received&quot; for one player on each team
 
+Unitsync / Lobby interface:
+ - engine now loads many start script options from GAME\ModOptions\ section in start script, instead of just GAME\
+ - added EngineOptions.lua to springcontent.sdz, this contains the default engine options for backward compatibility
+ - GetModOptions unitsync call parses both EngineOptions.lua and ModOptions.lua, and returns combined list of options
 
+Random:
+ - lots of fixes to CMake and dedicated server (already released)
+ - minor KAIK stability fixes
+
+
 0.77b4:
 Crashes:
  - fixed a crash (on exit) in colormap.cpp
@@ -55,7 +88,7 @@
  - Added /allmapmarks [0|1]
  - Added /forcestart command
  - Added /ally teamID [0|1] (Ingame alliances)
- - Adde /commands (shows all registered commands in the console)
+ - Added /commands (shows all registered commands in the console)
  - whisper private messages to any other player ingame (excluding spectators) by typing &quot;/w Playername Your secret message&quot;
  - Added new camera controller: SmoothCamera
    behaves like overview controller, but feels much smoother
@@ -175,6 +208,7 @@
  - Made MeleeWeapon obey impulseFactor.
 
 Maps:
+ - Maps have their own resource_map.lua/resource_map.tdf now.
  - converted map config scripts to lua format (LuaParser / MapParser)
    - MapOptions.lua is now handed the 'Map' table information as well
      (allows one to write a generic MapOptions.lua file that accesses

Modified: branches/caiinterface/installer/builddata/maphelper/maphelper/parse_tdf_map.lua
===================================================================
--- branches/caiinterface/installer/builddata/maphelper/maphelper/parse_tdf_map.lua	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/installer/builddata/maphelper/maphelper/parse_tdf_map.lua	2008-10-22 14:30:10 UTC (rev 6851)
@@ -1,166 +1,167 @@
---------------------------------------------------------------------------------
---------------------------------------------------------------------------------
---
---  file:     load_tdf_map.lua
---  brief:    tdf map lua parser (original SMD and SM3 formats)
---  authors:  Dave Rodgers
---
---  Copyright (C) 2008.
---  Licensed under the terms of the GNU GPL, v2 or later.
---
---------------------------------------------------------------------------------
---------------------------------------------------------------------------------
-
--- Special table for map config files
---
---   Map.name
---   Map.fullName
---   Map.configFile
-
-local mapConfig = Map.configFile
-
-local TDF = VFS.Include('maphelper/parse_tdf.lua')
-
-
---------------------------------------------------------------------------------
---------------------------------------------------------------------------------
---
---  Conversion Helpers
---
-
-local function ConvertMoveSpeeds(terrain)
-  local moveSpeeds = {}
-  for k, v in pairs(terrain) do
-    local s, e, type = k:find('^(.*)movespeed$')
-    if (type) then
-      moveSpeeds[type] = v
-      terrain[k] = nil
-    end
-  end
-  terrain.movespeeds = moveSpeeds
-end
-
-
-local function ConvertTerrainTypes(map)
-  local typeArray = {}
-  for k, v in pairs(map) do
-    if (type(v) == 'table') then
-      local s, e, num = k:find('^terraintype(.*)$')
-      local num = tonumber(num)
-      if (num) then
-        ConvertMoveSpeeds(v)
-        typeArray[num] = v
-        map[k] = nil
-      end
-    end
-  end
-  map.terraintypes = typeArray
-end
-
-
-local function ConvertTeams(map)
-  local teamArray = {}
-  for k, v in pairs(map) do
-    local s, e, num = k:find('^team(.*)$')
-    local num = tonumber(num)
-    if (num) then
-      teamArray[num] = {
-        startpos = {
-          x = v.startposx,
-          z = v.startposz,
-        },
-      }
-      map[k] = nil
-    end
-  end
-  map.teams = teamArray
-end
-
-
-local function ConvertLighting(map)
-  local light = map.light
-  if (type(light) ~= 'table') then
-    return
-  end
-  local lighting = {}
-  for k, v in pairs(light) do
-    local s, e, prefix = k:find('^(.*)suncolor$')
-    if (prefix) then
-      k = prefix .. 'diffusecolor'
-    end
-    lighting[k] = v
-  end
-  map.light = nil
-  map.lighting = lighting
-end
-
-
-local function ConvertWater(map)
-  -- remove the 'water' prefix
-  local water = map.water
-  if (type(water) ~= 'table') then
-    return
-  end
-  for k, v in pairs(water) do
-    local s, e, suffix = k:find('^water(.*)$')
-    if (suffix) then
-      water[suffix] = v
-      water[k] = nil
-    end
-  end
-  -- FIXME -- handle caustics?
-end
-
-
---------------------------------------------------------------------------------
---------------------------------------------------------------------------------
-
-local function PrintTable(t, indent)
-  indent = indent or ''
-  for k,v in pairs(t) do
-    k = tonumber(k) and '['..k..']' or k
-    if (type(v) == 'table') then
-      print(indent .. k .. ' = {')
-      PrintTable(v, indent .. '  ')
-      print(indent .. '},')
-    else
-      print(indent .. k .. ' = &quot;' .. v .. '&quot;,')
-    end
-  end
-end
-
-
---------------------------------------------------------------------------------
---------------------------------------------------------------------------------
---
---  Main Routine
---
-
-return function(sourceText)
-  local mapData, err = TDF.ParseText(sourceText)
-  if (mapData == nil) then
-    error('Error parsing ' .. mapConfig .. ': ' .. err)
-  end
-
-  local map = mapData.map
-  if (map == nil) then
-    error('Error parsing ' .. mapConfig .. ': missing MAP section')
-  end
-
-
-  ConvertTerrainTypes(map)
-
-  ConvertLighting(map)
-
-  ConvertWater(map)
-
-  ConvertTeams(map)
-
---  PrintTable(map)  -- FIXME -- debugging
-
-  return map
-end
-
-
---------------------------------------------------------------------------------
---------------------------------------------------------------------------------
+--------------------------------------------------------------------------------
+--------------------------------------------------------------------------------
+--
+--  file:     load_tdf_map.lua
+--  brief:    tdf map lua parser (original SMD and SM3 formats)
+--  authors:  Dave Rodgers
+--
+--  Copyright (C) 2008.
+--  Licensed under the terms of the GNU GPL, v2 or later.
+--
+--------------------------------------------------------------------------------
+--------------------------------------------------------------------------------
+
+-- Special table for map config files
+--
+--   Map.name
+--   Map.fullName
+--   Map.configFile
+
+local mapConfig = Map.configFile
+
+local TDF = VFS.Include('maphelper/parse_tdf.lua')
+
+
+--------------------------------------------------------------------------------
+--------------------------------------------------------------------------------
+--
+--  Conversion Helpers
+--
+
+local function ConvertMoveSpeeds(terrain)
+  local moveSpeeds = {}
+  for k, v in pairs(terrain) do
+    local s, e, type = k:find('^(.*)movespeed$')
+    if (type) then
+      moveSpeeds[type] = v
+      terrain[k] = nil
+    end
+  end
+  terrain.movespeeds = moveSpeeds
+end
+
+
+local function ConvertTerrainTypes(map)
+  local typeArray = {}
+  for k, v in pairs(map) do
+    if (type(v) == 'table') then
+      local s, e, num = k:find('^terraintype(.*)$')
+      local num = tonumber(num)
+      if (num) then
+        ConvertMoveSpeeds(v)
+        typeArray[num] = v
+        map[k] = nil
+      end
+    end
+  end
+  map.terraintypes = typeArray
+end
+
+
+local function ConvertTeams(map)
+  local teamArray = {}
+  for k, v in pairs(map) do
+    local s, e, num = k:find('^team(.*)$')
+    local num = tonumber(num)
+    if (num) then
+      teamArray[num] = {
+        startpos = {
+          x = v.startposx,
+          z = v.startposz,
+        },
+      }
+      map[k] = nil
+    end
+  end
+  map.teams = teamArray
+end
+
+
+local function ConvertLighting(map)
+  local light = map.light
+  if (type(light) ~= 'table') then
+    return
+  end
+  local lighting = {}
+  for k, v in pairs(light) do
+    local s, e, prefix = k:find('^(.*)suncolor$')
+    if (prefix) then
+      k = prefix .. 'diffusecolor'
+    end
+    lighting[k] = v
+  end
+  map.light = nil
+  map.lighting = lighting
+end
+
+
+local function ConvertWater(map)
+  -- remove the 'water' prefix
+  local water = map.water
+  if (type(water) ~= 'table') then
+    return
+  end
+  for k, v in pairs(water) do
+    local s, e, suffix = k:find('^water(.*)$')
+    if (suffix) then
+      water[suffix] = v
+      water[k] = nil
+    end
+  end
+  -- FIXME -- handle caustics?
+end
+
+
+--------------------------------------------------------------------------------
+--------------------------------------------------------------------------------
+
+local function PrintTable(t, indent)
+  indent = indent or ''
+  for k,v in pairs(t) do
+    k = tonumber(k) and '['..k..']' or k
+    if (type(v) == 'table') then
+      print(indent .. k .. ' = {')
+      PrintTable(v, indent .. '  ')
+      print(indent .. '},')
+    else
+      print(indent .. k .. ' = &quot;' .. v .. '&quot;,')
+    end
+  end
+end
+
+
+--------------------------------------------------------------------------------
+--------------------------------------------------------------------------------
+--
+--  Main Routine
+--
+
+return function(sourceText)
+  local mapData, err = TDF.ParseText(sourceText)
+  if (mapData == nil) then
+    error('Error parsing ' .. mapConfig .. ': ' .. err)
+  end
+
+  local map = mapData.map
+  if (map == nil) then
+    error('Error parsing ' .. mapConfig .. ': missing MAP section')
+  end
+
+  map.resources = {detailTex = map.detailtex}
+
+  ConvertTerrainTypes(map)
+
+  ConvertLighting(map)
+
+  ConvertWater(map)
+
+  ConvertTeams(map)
+
+--  PrintTable(map)  -- FIXME -- debugging
+
+  return map
+end
+
+
+--------------------------------------------------------------------------------
+--------------------------------------------------------------------------------

Copied: branches/caiinterface/installer/builddata/springcontent/EngineOptions.lua (from rev 6844, trunk/installer/builddata/springcontent/EngineOptions.lua)
===================================================================
--- branches/caiinterface/installer/builddata/springcontent/EngineOptions.lua	                        (rev 0)
+++ branches/caiinterface/installer/builddata/springcontent/EngineOptions.lua	2008-10-22 14:30:10 UTC (rev 6851)
@@ -0,0 +1,201 @@
+--  Custom Options Definition Table format
+
+--  NOTES:
+--  - using an enumerated table lets you specify the options order
+
+--
+--  These keywords must be lowercase for LuaParser to read them.
+--
+--  key:      the string used in the script.txt
+--  name:     the displayed name
+--  desc:     the description (could be used as a tooltip)
+--  type:     the option type
+--  def:      the default value
+--  min:      minimum value for number options
+--  max:      maximum value for number options
+--  step:     quantization step, aligned to the def value
+--  maxlen:   the maximum string length for string options
+--  items:    array of item strings for list options
+--  scope:    'all', 'player', 'team', 'allyteam'      &lt;&lt;&lt; not supported yet &gt;&gt;&gt;
+--
+
+--------------------------------------------------------------------------------
+--------------------------------------------------------------------------------
+--
+--  Example EngineOptions.lua 
+--
+
+local options = 
+{
+  {
+    key    = 'GameMode',
+    name   = 'Game end condition',
+    desc   = 'Determines what condition triggers the defeat of a player',
+    type   = 'list',
+    def    = '0',
+    items  = 
+    {
+      { 
+        key  = '0',
+        name = 'Kill everything',
+        desc = 'The player will lose when only after all units of the player will be killed',
+      },
+      {
+        key  = '1',
+        name = 'Commander ends',
+        desc = 'The player will lose when his commander will be dead',
+      },
+      {
+        key  = '2',
+        name = 'Commander lineage ends',
+        desc = 'This is a stricter form of commander ends\nevery unit will inherit the lineage from the player whom built it\neven if shared, when the commander dies the unit will still die',
+      },
+    },
+  },
+  
+  {
+    key    = 'StartingResources',
+    name   = 'Starting Resources',
+    desc   = 'Sets storage and amount of resources that players will start with',
+    type   = 'section',
+  },
+  
+  {
+    key    = 'StartMetal',
+    name   = 'Starting metal',
+    desc   = 'Determines amount of metal and metal storage that each player will start with',
+    type   = 'number',
+    section= 'StartingResources',
+    def    = 1000,
+    min    = 0,
+    max    = 10000,
+    step   = 1,  -- quantization is aligned to the def value
+                    -- (step &lt;= 0) means that there is no quantization
+  },
+  {
+    key    = 'StartEnergy',
+    name   = 'Starting energy',
+    desc   = 'Determines amount of metal and metal storage that each player will start with',
+    type   = 'number',
+    section= 'StartingResources',
+    def    = 500,
+    min    = 0,
+    max    = 10000,
+    step   = 1,  -- quantization is aligned to the def value
+                    -- (step &lt;= 0) means that there is no quantization
+  },
+  
+  {
+    key    = 'MaxUnits',
+    name   = 'Max units',
+    desc   = 'Determines the ceiling of how many units and buildings a player is allowed  to own at the same time',
+    type   = 'number',
+    def    = 1000,
+    min    = 1,
+    max    = 10000,
+    step   = 1,  -- quantization is aligned to the def value
+                    -- (step &lt;= 0) means that there is no quantization
+  },
+  
+  {
+    key    = 'LimitDgun',
+    name   = 'Limit D-Gun range',
+    desc   = &quot;The commander's D-Gun weapon will be usable only close to the player's starting location&quot;,
+    type   = 'bool',
+    def    = false,
+  },
+  
+  {
+    key    = 'GhostedBuildings',
+    name   = 'Ghosted buildings',
+    desc   = &quot;Once an enemy building will be spotted\n a ghost trail will be placed to memorize location even after the loss of the line of sight&quot;,
+    type   = 'bool',
+    def    = true,
+  },
+  {
+    key    = 'DiminishingMMs',
+    name   = 'Diminishing efficiency MetalMakers',
+    desc   = &quot;Everytime a new metal maker will be built, the energy/metal efficiency ratio will decrease&quot;,
+    type   = 'bool',
+    def    = false,
+  },
+
+  {
+    key    = 'FixedAllies',
+    name   = 'Fixed ingame alliances',
+    desc   = 'Disables the possibility of players to dynamically change allies ingame',
+    type   = 'bool',
+    def    = true,
+  },
+
+  {
+    key    = 'LimitSpeed',
+    name   = 'Speed Restriction',
+    desc   = 'Limits maximum and minimum speed that the players will be allowed to change to',
+    type   = 'section',
+  },
+  
+  {
+    key    = 'MaxSpeed',
+    name   = 'Maximum game speed',
+    desc   = 'Sets the maximum speed that the players will be allowed to change to',
+    type   = 'number',
+    section= 'LimitSpeed',
+    def    = 3,
+    min    = 0.1,
+    max    = 100,
+    step   = 0.1,  -- quantization is aligned to the def value
+                    -- (step &lt;= 0) means that there is no quantization
+  },
+  
+  {
+    key    = 'MinSpeed',
+    name   = 'Minimum game speed',
+    desc   = 'Sets the minimum speed that the players will be allowed to change to',
+    type   = 'number',
+    section= 'LimitSpeed',
+    def    = 0.3,
+    min    = 0.1,
+    max    = 100,
+    step   = 0.1,  -- quantization is aligned to the def value
+                    -- (step &lt;= 0) means that there is no quantization
+  },
+  
+  {
+    key    = 'DisableMapDamage',
+    name   = 'Underformable map',
+    desc   = 'Prevents the map shape from being changed by weapons',
+    type   = 'bool',
+    def    = false,
+  },
+--[[
+-- the following options can create problems and were never used by interface programs, thus are commented out for the moment
+  
+  {
+    key    = 'LuaGaia',
+    name   = 'Enables gaia',
+    desc   = 'Enables gaia player',
+    type   = 'bool',
+    def    = true,
+  },
+  
+  {
+    key    = 'NoHelperAIs',
+    name   = 'Disable helper AIs',
+    desc   = 'Disables luaui and group ai usage for all players',
+    type   = 'bool',
+    def    = false,
+  },
+  
+  {
+    key    = 'LuaRules',
+    name   = 'Enable LuaRules',
+    desc   = 'Enable mod usage of LuaRules',
+    type   = 'bool',
+    def    = true,
+  },
+
+--]]
+
+}
+return options

Modified: branches/caiinterface/installer/make_gamedata_arch.sh
===================================================================
--- branches/caiinterface/installer/make_gamedata_arch.sh	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/installer/make_gamedata_arch.sh	2008-10-22 14:30:10 UTC (rev 6851)
@@ -36,6 +36,7 @@
 echo Updating springcontent.sdz
 cd springcontent/
 zip -qu ../../../game/base/springcontent.sdz modinfo.tdf
+zip -qu ../../../game/base/springcontent.sdz EngineOptions.lua
 zip -qu ../../../game/base/springcontent.sdz gamedata/*
 zip -qu ../../../game/base/springcontent.sdz gamedata/*/*
 zip -qu ../../../game/base/springcontent.sdz bitmaps/*

Modified: branches/caiinterface/installer/sections/kp.nsh
===================================================================
--- branches/caiinterface/installer/sections/kp.nsh	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/installer/sections/kp.nsh	2008-10-22 14:30:10 UTC (rev 6851)
@@ -1,13 +1,15 @@
 !ifdef INSTALL
   SetOutPath &quot;$INSTDIR\mods&quot;
   inetc::get \
-             &quot;<A HREF="http://installer.clan-sy.com/mods/Kernel_Panic.sd7">http://installer.clan-sy.com/mods/Kernel_Panic.sd7</A>&quot; &quot;$INSTDIR\mods\Kernel_Panic.sd7&quot; \
-	     &quot;<A HREF="http://installer.clan-sy.com/mods/Kernel_Panic_Evilless.sd7">http://installer.clan-sy.com/mods/Kernel_Panic_Evilless.sd7</A>&quot; &quot;$INSTDIR\mods\Kernel_Panic_Evilless.sd7&quot; \
+             &quot;<A HREF="http://installer.clan-sy.com/mods/Kernel_Panic.sd7">http://installer.clan-sy.com/mods/Kernel_Panic.sd7</A>&quot; &quot;$INSTDIR\mods\Kernel_Panic_Installer_Version.sd7&quot; \
+	     &quot;<A HREF="http://installer.clan-sy.com/Kernel_Panic_Launcher.exe">http://installer.clan-sy.com/Kernel_Panic_Launcher.exe</A>&quot; &quot;$INSTDIR\Kernel_Panic_Launcher.exe&quot; \
 	     &quot;<A HREF="http://installer.clan-sy.com/maps/modspecificmaps/kernel_panic/Direct_Memory_Access_0.5c_beta.sd7">http://installer.clan-sy.com/maps/modspecificmaps/kernel_panic/Direct_Memory_Access_0.5c_beta.sd7</A>&quot; &quot;$INSTDIR\maps\Direct_Memory_Access_0.5c_beta.sd7&quot; \
 	     &quot;<A HREF="http://installer.clan-sy.com/maps/modspecificmaps/kernel_panic/Direct_Memory_Access_0.5e_beta.sd7">http://installer.clan-sy.com/maps/modspecificmaps/kernel_panic/Direct_Memory_Access_0.5e_beta.sd7</A>&quot; &quot;$INSTDIR\maps\Direct_Memory_Access_0.5e_beta.sd7&quot; \
 	     &quot;<A HREF="http://installer.clan-sy.com/maps/modspecificmaps/kernel_panic/Major_Madness3.0.sd7">http://installer.clan-sy.com/maps/modspecificmaps/kernel_panic/Major_Madness3.0.sd7</A>&quot; &quot;$INSTDIR\maps\Major_Madness3.0.sd7&quot; \
 	     &quot;<A HREF="http://installer.clan-sy.com/maps/modspecificmaps/kernel_panic/Marble_Madness_Map.sd7">http://installer.clan-sy.com/maps/modspecificmaps/kernel_panic/Marble_Madness_Map.sd7</A>&quot; &quot;$INSTDIR\maps\Marble_Madness_Map.sd7&quot; \
-	     &quot;<A HREF="http://installer.clan-sy.com/maps/modspecificmaps/kernel_panic/Speed_Balls_16_Way.sdz">http://installer.clan-sy.com/maps/modspecificmaps/kernel_panic/Speed_Balls_16_Way.sdz</A>&quot; &quot;$INSTDIR\maps\Speed_Balls_16_Way.sdz&quot; 
+	     &quot;<A HREF="http://installer.clan-sy.com/maps/modspecificmaps/kernel_panic/Speed_Balls_16_Way.sdz">http://installer.clan-sy.com/maps/modspecificmaps/kernel_panic/Speed_Balls_16_Way.sdz</A>&quot; &quot;$INSTDIR\maps\Speed_Balls_16_Way.sdz&quot; \
+             &quot;<A HREF="http://installer.clan-sy.com/maps/modspecificmaps/kernel_panic/Spooler_Buffer_0.5_beta.sd7">http://installer.clan-sy.com/maps/modspecificmaps/kernel_panic/Spooler_Buffer_0.5_beta.sd7</A>&quot; &quot;$INSTDIR\maps\Spooler_Buffer_0.5_beta.sd7&quot; \
+             &quot;<A HREF="http://installer.clan-sy.com/maps/modspecificmaps/kernel_panic/DigitalDivide_PT2.sd7">http://installer.clan-sy.com/maps/modspecificmaps/kernel_panic/DigitalDivide_PT2.sd7</A>&quot; &quot;$INSTDIR\maps\DigitalDivide_PT2.sd7&quot;              
 
   SetOutPath &quot;$INSTDIR\AI\NTai&quot;
   inetc::get \

Modified: branches/caiinterface/installer/sections/shortcuts.nsh
===================================================================
--- branches/caiinterface/installer/sections/shortcuts.nsh	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/installer/sections/shortcuts.nsh	2008-10-22 14:30:10 UTC (rev 6851)
@@ -10,8 +10,8 @@
   ${If} ${SectionIsSelected} ${SEC_SPRINGLOBBY}
     CreateShortCut &quot;$SMPROGRAMS\${PRODUCT_NAME}\Multiplayer\SpringLobby.lnk&quot; &quot;$INSTDIR\springlobby.exe&quot;
   ${EndIf}
-  ${If} ${SectionIsSelected} ${SEC_CA}
-    CreateShortCut &quot;$SMPROGRAMS\${PRODUCT_NAME}\Update CA.lnk&quot; &quot;$INSTDIR\CaDownloader.exe&quot;
+  ${If} ${SectionIsSelected} ${SEC_KP}
+    CreateShortCut &quot;$SMPROGRAMS\${PRODUCT_NAME}\Play Kernel Panic Singleplayer.lnk&quot; &quot;$INSTDIR\Kernel_Panic_Launcher.exe&quot;
   ${EndIf}  
   CreateShortCut &quot;$SMPROGRAMS\${PRODUCT_NAME}\Selectionkeys editor.lnk&quot; &quot;$INSTDIR\SelectionEditor.exe&quot;
   CreateShortCut &quot;$SMPROGRAMS\${PRODUCT_NAME}\Settings.lnk&quot; &quot;$INSTDIR\springsettings.exe&quot;
@@ -32,7 +32,7 @@
   Delete &quot;$SMPROGRAMS\${PRODUCT_NAME}\Uninstall Spring.lnk&quot;
   Delete &quot;$SMPROGRAMS\${PRODUCT_NAME}\Spring Website.lnk&quot;
   Delete &quot;$SMPROGRAMS\${PRODUCT_NAME}\Download Content.lnk&quot;
-  Delete &quot;$SMPROGRAMS\${PRODUCT_NAME}\Update CA.lnk&quot;
+  Delete &quot;$SMPROGRAMS\${PRODUCT_NAME}\Play Kernel Panic Singleplayer.lnk&quot;
   
   ; delete the old shortcuts if they're present from a prior installation
   Delete &quot;$SMPROGRAMS\${PRODUCT_NAME}\Uninstall.lnk&quot;
@@ -40,6 +40,7 @@
   Delete &quot;$SMPROGRAMS\${PRODUCT_NAME}\Spring test.lnk&quot;
   Delete &quot;$SMPROGRAMS\${PRODUCT_NAME}\Spring multiplayer battleroom.lnk&quot;
   Delete &quot;$SMPROGRAMS\${PRODUCT_NAME}\Selectionkeys editor.lnk&quot;
+  Delete &quot;$SMPROGRAMS\${PRODUCT_NAME}\Update CA.lnk&quot;
 
   ; delete the .url files
   Delete &quot;$INSTDIR\Spring.url&quot;

Modified: branches/caiinterface/installer/sections/tasclient.nsh
===================================================================
--- branches/caiinterface/installer/sections/tasclient.nsh	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/installer/sections/tasclient.nsh	2008-10-22 14:30:10 UTC (rev 6851)
@@ -19,7 +19,12 @@
   CreateDirectory &quot;$INSTDIR\lobby\python&quot;
 
   SetOutPath &quot;$INSTDIR\lobby\var&quot;
+
+${IfNot} ${FileExists} &quot;$INSTDIR\lobby\var\groups.ini&quot;
   File &quot;..\external\TASClient\groups.ini&quot;
+${EndIf}
+  
+
   File &quot;..\external\TASClient\tips.txt&quot;
 
   SetOutPath &quot;$INSTDIR\lobby\python&quot;

Modified: branches/caiinterface/installer/spring.nsi
===================================================================
--- branches/caiinterface/installer/spring.nsi	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/installer/spring.nsi	2008-10-22 14:30:10 UTC (rev 6851)
@@ -359,9 +359,9 @@
   SetOutPath &quot;$INSTDIR&quot;
   CreateShortCut &quot;$DESKTOP\${PRODUCT_NAME} battleroom.lnk&quot; &quot;$INSTDIR\TASClient.exe&quot;
 ${EndIf}
-${If} ${SectionIsSelected} ${SEC_CA}
+${If} ${SectionIsSelected} ${SEC_KP}
   SetOutPath &quot;$INSTDIR&quot;
-  CreateShortCut &quot;$DESKTOP\${PRODUCT_NAME} Update CA.lnk&quot; &quot;$INSTDIR\CaDownloader.exe&quot;
+  CreateShortCut &quot;$DESKTOP\${PRODUCT_NAME} Play Kernel Panic Singleplayer.lnk&quot; &quot;$INSTDIR\Kernel_Panic_Launcher.exe&quot;
 ${EndIf}
 SectionEnd
 
@@ -443,7 +443,7 @@
   !include &quot;sections\CA.nsh&quot;
 
   Delete &quot;$DESKTOP\${PRODUCT_NAME} battleroom.lnk&quot;
-  Delete &quot;$DESKTOP\${PRODUCT_NAME} Update CA.lnk&quot;
+  Delete &quot;$DESKTOP\${PRODUCT_NAME} Play Kernel Panic Singleplayer.lnk&quot;
 
   ; All done
   RMDir &quot;$INSTDIR&quot;

Modified: branches/caiinterface/installer/springsettings.nsh
===================================================================
--- branches/caiinterface/installer/springsettings.nsh	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/installer/springsettings.nsh	2008-10-22 14:30:10 UTC (rev 6851)
@@ -1,10 +1,10 @@
 !ifdef TEST_BUILD
  !define PRODUCT_NAME &quot;Spring - Test Build&quot;
- !define PRODUCT_VERSION &quot;0.77b4+svn${REVISION}&quot;
+ !define PRODUCT_VERSION &quot;0.77b5+svn${REVISION}&quot;
  !define SP_BASENAME &quot;spring_${PRODUCT_VERSION}&quot;
 !else
  !define PRODUCT_NAME &quot;Spring&quot;
- !define PRODUCT_VERSION &quot;0.77b4&quot;
+ !define PRODUCT_VERSION &quot;0.77b5&quot;
  !define SP_BASENAME &quot;spring_${PRODUCT_VERSION}&quot;
 !endif
 

Modified: branches/caiinterface/rts/ExternalAI/AICallback.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/AICallback.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/ExternalAI/AICallback.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -252,7 +252,7 @@
 				&quot;Spring is closing:&quot;, MBF_OK | MBF_EXCL);
 }
 
-int CAICallback::CreateGroup(char* libraryName, unsigned aiNumber)
+int CAICallback::CreateGroup(const char* libraryName, unsigned aiNumber)
 {
 	AIKey key;
 	key.dllName=libraryName;

Modified: branches/caiinterface/rts/ExternalAI/AICallback.h
===================================================================
--- branches/caiinterface/rts/ExternalAI/AICallback.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/ExternalAI/AICallback.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -37,7 +37,7 @@
 	void* CreateSharedMemArea(char* name, int size);
 	void ReleasedSharedMemArea(char* name);
 
-	int CreateGroup(char* libraryName, unsigned aiNumber);
+	int CreateGroup(const char* libraryName, unsigned aiNumber);
 	void EraseGroup(int groupId);
 	bool AddUnitToGroup(int unitId, int groupId);
 	bool RemoveUnitFromGroup(int unitId);

Modified: branches/caiinterface/rts/ExternalAI/AICheats.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/AICheats.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/ExternalAI/AICheats.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -8,6 +8,7 @@
 #include &quot;Sim/Units/UnitHandler.h&quot;
 #include &quot;Sim/Units/UnitLoader.h&quot;
 #include &quot;NetProtocol.h&quot;
+#include &quot;Game/GlobalSynced.h&quot;
 #include &quot;Game/Team.h&quot;
 #include &quot;Game/GameServer.h&quot;
 #include &quot;Game/GameSetup.h&quot;

Modified: branches/caiinterface/rts/ExternalAI/AILibraryManager.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/AILibraryManager.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/ExternalAI/AILibraryManager.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -28,7 +28,7 @@
 #include &quot;Platform/errorhandler.h&quot;
 #include &quot;Platform/SharedLib.h&quot;
 #include &quot;FileSystem/FileHandler.h&quot;
-#include &quot;GlobalStuff.h&quot;
+#include &quot;Game/GlobalSynced.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Game/Team.h&quot;
 

Modified: branches/caiinterface/rts/ExternalAI/GlobalAIHandler.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/GlobalAIHandler.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/ExternalAI/GlobalAIHandler.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -7,6 +7,7 @@
 #include &quot;SkirmishAI.h&quot;
 #include &quot;SkirmishAIWrapper.h&quot;
 #include &quot;IGlobalAI.h&quot;
+#include &quot;Game/GlobalSynced.h&quot;
 #include &quot;Game/GameHelper.h&quot;
 #include &quot;Game/Player.h&quot;
 #include &quot;Game/Team.h&quot;
@@ -268,7 +269,7 @@
 			if(ais[attacked-&gt;team])
 				if(attacker){
 					float3 dir=helper-&gt;GetUnitErrorPos(attacker,attacked-&gt;allyteam)-attacked-&gt;pos;
-					dir.Normalize();
+					dir.ANormalize();
 					ais[attacked-&gt;team]-&gt;UnitDamaged(attacked-&gt;id,attacker-&gt;id,damage,dir);
 				} else {
 					ais[attacked-&gt;team]-&gt;UnitDamaged(attacked-&gt;id,-1,damage,ZeroVector);
@@ -278,7 +279,7 @@
 				int a = attacker-&gt;team;
 				if(ais[attacker-&gt;team] &amp;&amp; !gs-&gt;Ally(gs-&gt;AllyTeam(a),attacked-&gt;allyteam) &amp;&amp; (ais[a]-&gt;IsCheatEventsEnabled() || (attacked-&gt;losStatus[a] &amp; (LOS_INLOS | LOS_INRADAR)))) {
 					float3 dir=attacker-&gt;pos-helper-&gt;GetUnitErrorPos(attacked,attacker-&gt;allyteam);
-					dir.Normalize();
+					dir.ANormalize();
 					ais[a]-&gt;EnemyDamaged(attacked-&gt;id,attacker-&gt;id,damage,dir);
 				}
 			}

Modified: branches/caiinterface/rts/ExternalAI/GlobalAIHandler.h
===================================================================
--- branches/caiinterface/rts/ExternalAI/GlobalAIHandler.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/ExternalAI/GlobalAIHandler.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -6,7 +6,7 @@
 #include &quot;Object.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;float3.h&quot;
-#include &quot;GlobalStuff.h&quot;
+#include &quot;Game/GlobalConstants.h&quot;
 #include &lt;map&gt;
 #include &lt;string&gt;
 

Modified: branches/caiinterface/rts/ExternalAI/Group.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/Group.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/ExternalAI/Group.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -9,6 +9,7 @@
 #include &quot;GroupHandler.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;System/EventHandler.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Platform/errorhandler.h&quot;

Modified: branches/caiinterface/rts/ExternalAI/GroupHandler.h
===================================================================
--- branches/caiinterface/rts/ExternalAI/GroupHandler.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/ExternalAI/GroupHandler.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -9,7 +9,7 @@
 #include &lt;vector&gt;
 #include &lt;set&gt;
 #include &quot;ExternalAI/aikey.h&quot;
-#include &quot;System/GlobalStuff.h&quot;
+#include &quot;Game/GlobalConstants.h&quot;
 
 class CGroup;
 class CUnitSet;

Modified: branches/caiinterface/rts/ExternalAI/IAICallback.h
===================================================================
--- branches/caiinterface/rts/ExternalAI/IAICallback.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/ExternalAI/IAICallback.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -74,7 +74,7 @@
 struct AIHCAddMapPoint ///&lt; result of HandleCommand is 1 - ok supported
 {
 	float3 pos; ///&lt; on this position, only x and z matter
-	char* label; ///&lt; create this text on pos in my team color
+	const char* label; ///&lt; create this text on pos in my team color
 };
 
 struct AIHCAddMapLine ///&lt; result of HandleCommand is 1 - ok supported
@@ -154,7 +154,7 @@
 	// release your reference to a memory area
 	virtual void ReleasedSharedMemArea(char* name) = 0;
 
-	virtual int CreateGroup(char* libraryName, unsigned aiNumber) = 0;							// creates a group and return the id it was given, return -1 on
+	virtual int CreateGroup(const char* libraryName, unsigned aiNumber) = 0;			// creates a group and return the id it was given, return -1 on
 																						// failure (dll didn't exist, etc)
 	virtual void EraseGroup(int groupId) = 0;											// erases a specified group
 	virtual bool AddUnitToGroup(int unitId, int groupId) = 0;							// adds a unit to a specific group, if it was previously in a group

Modified: branches/caiinterface/rts/ExternalAI/Interface/AISCommands.h
===================================================================
--- branches/caiinterface/rts/ExternalAI/Interface/AISCommands.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/ExternalAI/Interface/AISCommands.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -180,7 +180,7 @@
 };
 
 struct SCreateGroupCommand {
-	char* libraryName;
+	const char* libraryName;
 	unsigned int aiNumber;
 	int ret_groupId;
 };
@@ -244,7 +244,7 @@
 struct SAddPointDrawCommand ///&lt; result of HandleCommand is 1 - ok supported
 {
 	struct SAIFloat3 pos; ///&lt; on this position, only x and z matter
-	char* label; ///&lt; create this text on pos in my team color
+	const char* label; ///&lt; create this text on pos in my team color
 };
 struct SRemovePointDrawCommand ///&lt; result of HandleCommand is 1 - ok supported
 {

Modified: branches/caiinterface/rts/ExternalAI/Interface/LegacyCppWrapper/AIAICallback.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/Interface/LegacyCppWrapper/AIAICallback.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/ExternalAI/Interface/LegacyCppWrapper/AIAICallback.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -1753,7 +1753,7 @@
 	SReleaseSharedMemAreaCommand cmd = {name}; sAICallback-&gt;handleCommand(teamId, COMMAND_TO_ID_ENGINE, -1, COMMAND_SHARED_MEM_AREA_RELEASE, &amp;cmd);
 }
 
-int CAIAICallback::CreateGroup(char* libraryName, unsigned aiNumber) {
+int CAIAICallback::CreateGroup(const char* libraryName, unsigned aiNumber) {
 		SCreateGroupCommand cmd = {libraryName, aiNumber}; sAICallback-&gt;handleCommand(teamId, COMMAND_TO_ID_ENGINE, -1, COMMAND_GROUP_CREATE, &amp;cmd); return cmd.ret_groupId;
 }
 

Modified: branches/caiinterface/rts/ExternalAI/Interface/LegacyCppWrapper/AIAICallback.h
===================================================================
--- branches/caiinterface/rts/ExternalAI/Interface/LegacyCppWrapper/AIAICallback.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/ExternalAI/Interface/LegacyCppWrapper/AIAICallback.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -51,7 +51,7 @@
 	
 	virtual void ReleasedSharedMemArea(char* name);
 
-	virtual int CreateGroup(char* dll, unsigned aiNumber);							
+	virtual int CreateGroup(const char* dll, unsigned aiNumber);							
 																						
 	virtual void EraseGroup(int groupid);											
 	virtual bool AddUnitToGroup(int unitid, int groupid);							

Modified: branches/caiinterface/rts/ExternalAI/Interface/SOption.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/Interface/SOption.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/ExternalAI/Interface/SOption.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -206,6 +206,6 @@
 	return i;
 }
 
-#endif	/* defined(__cplusplus) &amp;&amp; !defined(BUILDING_AI) &amp;&amp; !defined(BUILDING_AI_INTERFACE) */
+#endif	// defined(__cplusplus) &amp;&amp; !defined(BUILDING_AI) &amp;&amp; !defined(BUILDING_AI_INTERFACE)
 
-#endif	/* _SOPTION_CPP */
+#endif	// _SOPTION_CPP

Modified: branches/caiinterface/rts/ExternalAI/Interface/SOption.h
===================================================================
--- branches/caiinterface/rts/ExternalAI/Interface/SOption.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/ExternalAI/Interface/SOption.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -25,6 +25,8 @@
 extern &quot;C&quot; {
 #endif
 
+#define Option_badKeyChars &quot; =;\r\n\t&quot;
+
 struct OptionListItem {
 	const char* key;
 	const char* name;

Modified: branches/caiinterface/rts/ExternalAI/SStaticGlobalData.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/SStaticGlobalData.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/ExternalAI/SStaticGlobalData.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -21,7 +21,7 @@
 #include &lt;string.h&gt;	// strcpy
 
 #if defined	__cplusplus &amp;&amp; !defined BUILDING_AI &amp;&amp; !defined BUILDING_AI_INTERFACE
-#include &quot;System/GlobalStuff.h&quot;			// for MAX_TEAMS
+#include &quot;Game/GlobalConstants.h&quot;			// for MAX_TEAMS
 #define MAX_GROUPS	10	// 0..9
 #include &quot;Game/GameVersion.h&quot;			// for VERSION_STRING
 #include &quot;System/Platform/FileSystem.h&quot;	// for data directories

Modified: branches/caiinterface/rts/ExternalAI/SkirmishAIWrapper.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/SkirmishAIWrapper.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/ExternalAI/SkirmishAIWrapper.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -18,6 +18,7 @@
 #include &quot;SkirmishAIWrapper.h&quot;
 
 #include &quot;StdAfx.h&quot;
+#include &quot;Game/GlobalSynced.h&quot;
 #include &quot;IGlobalAI.h&quot;
 #include &quot;SkirmishAI.h&quot;
 #include &quot;GlobalAICallback.h&quot;

Modified: branches/caiinterface/rts/Game/Camera/FPSController.cpp
===================================================================
--- branches/caiinterface/rts/Game/Camera/FPSController.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Game/Camera/FPSController.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -7,6 +7,7 @@
 #include &quot;Game/Camera.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Map/Ground.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 using std::min;
 using std::max;
@@ -82,7 +83,7 @@
 	dir.x = (float)(cos(camera-&gt;rot.x) * sin(camera-&gt;rot.y));
 	dir.z = (float)(cos(camera-&gt;rot.x) * cos(camera-&gt;rot.y));
 	dir.y = (float)(sin(camera-&gt;rot.x));
-	dir.Normalize();
+	dir.ANormalize();
 	return dir;
 }
 

Modified: branches/caiinterface/rts/Game/Camera/FreeController.cpp
===================================================================
--- branches/caiinterface/rts/Game/Camera/FreeController.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Game/Camera/FreeController.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -10,6 +10,7 @@
 #include &quot;Game/Camera.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Map/Ground.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 using std::max;
 using std::min;
@@ -35,7 +36,7 @@
   gndLock(false)
 {
 	dir = float3(0.0f, -2.0f, -1.0f);
-	dir.Normalize();
+	dir.ANormalize();
 	if (camera) {
 		const float hDist = sqrt((dir.x * dir.x) + (dir.z * dir.z));
 		camera-&gt;rot.y = atan2(dir.x, dir.z);
@@ -143,7 +144,7 @@
 		}
 		else {
 			float3 forwardNoY(camera-&gt;forward.x, 0.0f, camera-&gt;forward.z);
-			forwardNoY.Normalize();
+			forwardNoY.ANormalize();
 			const float3 tmpVel((forwardNoY    * vel.x) +
 			                    (UpVector      * vel.y) +
 			                    (camera-&gt;right * vel.z));
@@ -382,7 +383,7 @@
 	dir.x = (float)(sin(camera-&gt;rot.y) * cos(camera-&gt;rot.x));
 	dir.z = (float)(cos(camera-&gt;rot.y) * cos(camera-&gt;rot.x));
 	dir.y = (float)(sin(camera-&gt;rot.x));
-	dir.Normalize();
+	dir.ANormalize();
 	return dir;
 }
 

Modified: branches/caiinterface/rts/Game/Camera/OrbitController.cpp
===================================================================
--- branches/caiinterface/rts/Game/Camera/OrbitController.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Game/Camera/OrbitController.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -26,6 +26,14 @@
 	elevation(0.0f), cElevation(0.0f)
 {
 	enabled = !!configHandler.GetInt(&quot;OrbitControllerEnabled&quot;, 1);
+
+	orbitSpeedFact = configHandler.GetFloat(&quot;OrbitControllerOrbitSpeed&quot;, 0.25f);
+	panSpeedFact   = configHandler.GetFloat(&quot;OrbitControllerPanSpeed&quot;,   2.00f);
+	zoomSpeedFact  = configHandler.GetFloat(&quot;OrbitControllerZoomSpeed&quot;,  5.00f);
+
+	orbitSpeedFact = std::max(0.1f, std::min(10.0f, orbitSpeedFact));
+	panSpeedFact   = std::max(0.1f, std::min(10.0f, panSpeedFact));
+	zoomSpeedFact  = std::max(0.1f, std::min(10.0f, zoomSpeedFact));
 }
 
 void COrbitController::Init(const float3&amp; p, const float3&amp; tar)
@@ -58,14 +66,9 @@
 		return;
 	}
 
-	// can't use mouse-&gt;last{x, y}, since they
-	// have already been updated to the current
-	// pos at this point
-	int x = 0;
-	int y = 0;
+	const int x = mouse-&gt;lastx;
+	const int y = mouse-&gt;lasty;
 
-	SDL_GetMouseState(&amp;x, &amp;y);
-
 	const int pdx = lastMousePressX - x;
 	const int pdy = lastMousePressY - y;
 	const int rdx = lastMouseMoveX - x;
@@ -77,10 +80,6 @@
 	MyMouseMove(pdx, pdy, rdx, rdy, lastMouseButton);
 }
 
-void COrbitController::KeyMove(float3 move)
-{
-	// todo
-}
 
 
 void COrbitController::MousePress(int x, int y, int button)
@@ -115,16 +114,14 @@
 
 void COrbitController::MyMouseMove(int dx, int dy, int rdx, int rdy, int button)
 {
-	CCamera* cam = camera;
-
 	switch (button) {
 		case SDL_BUTTON_LEFT: {
-			rotation = cRotation - (dx * 0.25f);
-			elevation = cElevation - (dy * 0.25f);
+			rotation = cRotation - (dx * orbitSpeedFact);
+			elevation = cElevation - (dy * orbitSpeedFact);
 		} break;
 
 		case SDL_BUTTON_RIGHT: {
-			distance = cDistance - (dy * 0.5f * 10.0f);
+			distance = cDistance - (dy * zoomSpeedFact);
 		} break;
 	}
 
@@ -134,46 +131,77 @@
 
 	switch (button) {
 		case SDL_BUTTON_LEFT: {
-			cam-&gt;pos = cen + GetOrbitPos();
-			cam-&gt;pos.y = std::max(cam-&gt;pos.y, ground-&gt;GetHeight2(cam-&gt;pos.x, cam-&gt;pos.z));
-			cam-&gt;forward = (cen - cam-&gt;pos).Normalize();
-			cam-&gt;up = YVEC;
+			Orbit();
 		} break;
 
+		case SDL_BUTTON_MIDDLE: {
+			Pan(rdx, rdy);
+		} break;
+
 		case SDL_BUTTON_RIGHT: {
-			cam-&gt;pos = cen - (cam-&gt;forward * distance);
+			Zoom();
 		} break;
+	}
+}
 
-		case SDL_BUTTON_MIDDLE: {
-			// horizontal pan
-			cam-&gt;pos += (cam-&gt;right * -rdx * 2);
-			cen += (cam-&gt;right * -rdx * 2);
 
-			// vertical pan
-			cam-&gt;pos += (cam-&gt;up * rdy * 2);
-			cen += (cam-&gt;up * rdy * 2);
 
+void COrbitController::Orbit()
+{
+	CCamera* cam = camera;
 
-			// don't allow orbit center or ourselves to drop below the terrain
-			const float camGH = ground-&gt;GetHeight2(cam-&gt;pos.x, cam-&gt;pos.z);
-			const float cenGH = ground-&gt;GetHeight2(cen.x, cen.z);
+	cam-&gt;pos = cen + GetOrbitPos();
+	cam-&gt;pos.y = std::max(cam-&gt;pos.y, ground-&gt;GetHeight2(cam-&gt;pos.x, cam-&gt;pos.z));
+	cam-&gt;forward = (cen - cam-&gt;pos).ANormalize();
+	cam-&gt;up = YVEC;
+}
 
-			if (cam-&gt;pos.y &lt; camGH) {
-				cam-&gt;pos.y = camGH;
-			}
+void COrbitController::Pan(int rdx, int rdy)
+{
+	CCamera* cam = camera;
 
-			if (cen.y &lt; cenGH) {
-				cen.y = cenGH;
-				cam-&gt;forward = (cen - cam-&gt;pos).Normalize();
+	// horizontal pan
+	cam-&gt;pos += (cam-&gt;right * -rdx * panSpeedFact);
+	cen += (cam-&gt;right * -rdx * panSpeedFact);
 
-				Init(cam-&gt;pos, cen);
-			}
-		} break;
+	// vertical pan
+	cam-&gt;pos += (cam-&gt;up * rdy * panSpeedFact);
+	cen += (cam-&gt;up * rdy * panSpeedFact);
+
+
+	// don't allow orbit center or ourselves to drop below the terrain
+	const float camGH = ground-&gt;GetHeight2(cam-&gt;pos.x, cam-&gt;pos.z);
+	const float cenGH = ground-&gt;GetHeight2(cen.x, cen.z);
+
+	if (cam-&gt;pos.y &lt; camGH) {
+		cam-&gt;pos.y = camGH;
 	}
+
+	if (cen.y &lt; cenGH) {
+		cen.y = cenGH;
+		cam-&gt;forward = (cen - cam-&gt;pos).ANormalize();
+
+		Init(cam-&gt;pos, cen);
+	}
 }
 
+void COrbitController::Zoom()
+{
+	camera-&gt;pos = cen - (camera-&gt;forward * distance);
+}
+
+
+
+void COrbitController::KeyMove(float3 move)
+{
+	// higher framerate means we take smaller steps per frame
+	// (x and y are lastFrameTime in secs., 200FPS ==&gt; 0.005s)
+	Pan(int(move.x * -1000), int(move.y * 1000));
+}
+
 void COrbitController::ScreenEdgeMove(float3 move)
 {
+	Pan(int(move.x * -1000), int(move.y * 1000));
 }
 
 void COrbitController::MouseWheelMove(float move)
@@ -209,7 +237,7 @@
 
 float3 COrbitController::GetDir()
 {
-	return (cen - camera-&gt;pos).Normalize();
+	return (cen - camera-&gt;pos).ANormalize();
 }
 
 float3 COrbitController::GetOrbitPos() const

Modified: branches/caiinterface/rts/Game/Camera/OrbitController.h
===================================================================
--- branches/caiinterface/rts/Game/Camera/OrbitController.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Game/Camera/OrbitController.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -2,7 +2,6 @@
 #define __ORBIT_CONTROLLER_H__
 
 #include &quot;CameraController.h&quot;
-#include &quot;GlobalStuff.h&quot;
 
 class COrbitController: public CCameraController {
 	public:
@@ -32,6 +31,10 @@
 
 	private:
 		void MyMouseMove(int, int, int, int, int);
+		void Orbit();
+		void Pan(int, int);
+		void Zoom();
+
 		float3 GetOrbitPos() const;
 
 		int lastMouseMoveX;
@@ -43,9 +46,12 @@
 		float distance, cDistance;
 		float rotation, cRotation;
 		float elevation, cElevation;
+		float orbitSpeedFact;
+		float panSpeedFact;
+		float zoomSpeedFact;
 		float3 cen;
 
-		enum States {None, Orbiting, Zooming, Panning};
+		enum States {None, Orbiting, Panning, Zooming};
 };
 
 #endif

Modified: branches/caiinterface/rts/Game/Camera/OverheadController.cpp
===================================================================
--- branches/caiinterface/rts/Game/Camera/OverheadController.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Game/Camera/OverheadController.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -12,6 +12,7 @@
 #include &quot;Game/UI/MouseHandler.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Map/Ground.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 
 
@@ -132,7 +133,7 @@
 	}
 
 	pos.y = ground-&gt;GetHeight(pos.x,pos.z);
-	dir = float3(0.0f, -1.0f, flipped ? zscale : -zscale).Normalize();
+	dir = float3(0.0f, -1.0f, flipped ? zscale : -zscale).ANormalize();
 
 	float3 cpos = pos - dir * height;
 

Modified: branches/caiinterface/rts/Game/Camera/OverviewController.cpp
===================================================================
--- branches/caiinterface/rts/Game/Camera/OverviewController.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Game/Camera/OverviewController.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -42,7 +42,7 @@
 
 float3 COverviewController::GetDir()
 {
-	return float3(0.0f, -1.0f, -0.001f).Normalize();
+	return float3(0.0f, -1.0f, -0.001f).ANormalize();
 }
 
 void COverviewController::SetPos(const float3&amp; newPos)

Modified: branches/caiinterface/rts/Game/Camera/RotOverheadController.cpp
===================================================================
--- branches/caiinterface/rts/Game/Camera/RotOverheadController.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Game/Camera/RotOverheadController.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -27,7 +27,7 @@
 	if(camera-&gt;forward.y&lt;-0.9f)
 		flatForward+=camera-&gt;up;
 	flatForward.y=0;
-	flatForward.Normalize();
+	flatForward.ANormalize();
 
 	pos+=(flatForward*move.y+camera-&gt;right*move.x)*scrollSpeed;
 }
@@ -86,7 +86,7 @@
 	dir.x=(float)(sin(camera-&gt;rot.y)*cos(camera-&gt;rot.x));
 	dir.y=(float)(sin(camera-&gt;rot.x));
 	dir.z=(float)(cos(camera-&gt;rot.y)*cos(camera-&gt;rot.x));
-	dir.Normalize();
+	dir.ANormalize();
 	return dir;
 }
 

Modified: branches/caiinterface/rts/Game/Camera/SmoothController.cpp
===================================================================
--- branches/caiinterface/rts/Game/Camera/SmoothController.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Game/Camera/SmoothController.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -14,6 +14,7 @@
 #include &quot;Game/UI/MouseHandler.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Map/Ground.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 
 
@@ -183,7 +184,7 @@
 	}
 
 	pos.y = ground-&gt;GetHeight(pos.x,pos.z);
-	dir = float3(0.0f, -1.0f, flipped ? zscale : -zscale).Normalize();
+	dir = float3(0.0f, -1.0f, flipped ? zscale : -zscale).ANormalize();
 
 	float3 cpos = pos - dir * height;
 

Modified: branches/caiinterface/rts/Game/Camera/TWController.cpp
===================================================================
--- branches/caiinterface/rts/Game/Camera/TWController.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Game/Camera/TWController.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -12,6 +12,7 @@
 #include &quot;LogOutput.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Game/UI/MouseHandler.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 extern Uint8 *keys;
 
@@ -28,7 +29,7 @@
 {
 	float3 flatForward=camera-&gt;forward;
 	flatForward.y=0;
-	flatForward.Normalize();
+	flatForward.ANormalize();
 
 	move*=sqrt(move.z)*200;
 	pos+=(flatForward*move.y+camera-&gt;right*move.x)*scrollSpeed;
@@ -42,7 +43,7 @@
 	move*=(1+keys[SDLK_LSHIFT]*3)*pixelsize;
 	float3 flatForward=camera-&gt;forward;
 	flatForward.y=0;
-	flatForward.Normalize();
+	flatForward.ANormalize();
 
 	pos+=-(flatForward*move.y-camera-&gt;right*move.x)*scrollSpeed;
 }
@@ -85,7 +86,7 @@
 	dir.x=(float)(sin(camera-&gt;rot.y)*cos(camera-&gt;rot.x));
 	dir.y=(float)(sin(camera-&gt;rot.x));
 	dir.z=(float)(cos(camera-&gt;rot.y)*cos(camera-&gt;rot.x));
-	dir.Normalize();
+	dir.ANormalize();
 
 	float dist=-camera-&gt;rot.x*1500;
 
@@ -104,7 +105,7 @@
 	dir.x=(float)(sin(camera-&gt;rot.y)*cos(camera-&gt;rot.x));
 	dir.y=(float)(sin(camera-&gt;rot.x));
 	dir.z=(float)(cos(camera-&gt;rot.y)*cos(camera-&gt;rot.x));
-	dir.Normalize();
+	dir.ANormalize();
 	return dir;
 }
 

Modified: branches/caiinterface/rts/Game/Camera.cpp
===================================================================
--- branches/caiinterface/rts/Game/Camera.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Game/Camera.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -5,6 +5,7 @@
 
 #include &quot;mmgr.h&quot;
 
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;Camera.h&quot;
 #include &quot;Map/Ground.h&quot;
 
@@ -128,13 +129,13 @@
 void CCamera::Update(bool freeze)
 {
 	pos2 = pos;
-	up.Normalize();
+	up.ANormalize();
 
 	right = forward.cross(up);
-	right.Normalize();
+	right.ANormalize();
 	
 	up = right.cross(forward);
-	up.Normalize();
+	up.ANormalize();
 
 	const float aspect = (float) gu-&gt;viewSizeX / (float) gu-&gt;viewSizeY;
 	const float viewx = tan(aspect * halfFov);
@@ -150,15 +151,15 @@
 
 	const float3 forwardy = (-forward * viewy);
 	top    = forwardy + up;
-	top.Normalize();
+	top.ANormalize();
 	bottom = forwardy - up;
-	bottom.Normalize();
+	bottom.ANormalize();
 	
 	const float3 forwardx = (-forward * viewx);
 	rightside = forwardx + right;
-	rightside.Normalize();
+	rightside.ANormalize();
 	leftside  = forwardx - right;
-	leftside.Normalize();
+	leftside.ANormalize();
 
 	if (!freeze) {
 		cam2-&gt;bottom    = bottom;
@@ -197,7 +198,7 @@
 	                (up      * tiltOffset.y);
 
 	const float3 camPos = pos + posOffset;
-	const float3 center = camPos + fShake.Normalize();
+	const float3 center = camPos + fShake.ANormalize();
 
 	// apply and store the transform, should be faster
 	// than calling glGetDoublev(GL_MODELVIEW_MATRIX)
@@ -281,7 +282,7 @@
 	forward.z = cos(rot.y) * cos(rot.x);
 	forward.x = sin(rot.y) * cos(rot.x);
 	forward.y = sin(rot.x);
-	forward.Normalize();
+	forward.ANormalize();
 }
 
 
@@ -290,7 +291,7 @@
 	float dx = float(x-gu-&gt;viewPosX-gu-&gt;viewSizeX/2)/gu-&gt;viewSizeY * tanHalfFov * 2;
 	float dy = float(y-gu-&gt;viewSizeY/2)/gu-&gt;viewSizeY * tanHalfFov * 2;
 	float3 dir = forward - up * dy + right * dx;
-	dir.Normalize();
+	dir.ANormalize();
 	return dir;
 }
 
@@ -325,7 +326,7 @@
 }
 
 inline void CCamera::myGluLookAt(const float3&amp; eye, const float3&amp; center, const float3&amp; up) {
-	float3 f = (center - eye).Normalize();
+	float3 f = (center - eye).ANormalize();
 	float3 s = f.cross(up);
 	float3 u = s.cross(f);
 

Modified: branches/caiinterface/rts/Game/CameraHandler.cpp
===================================================================
--- branches/caiinterface/rts/Game/CameraHandler.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Game/CameraHandler.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -18,7 +18,7 @@
 #include &quot;Game/Camera/OrbitController.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;LogOutput.h&quot;
-#include &quot;GlobalStuff.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 
 CCameraHandler* camHandler = NULL;
@@ -116,7 +116,7 @@
 		camera-&gt;SetFov(camera-&gt;GetFov() + (deltaFOV * ratio));
 		camera-&gt;pos     += deltaPos * ratio;
 		camera-&gt;forward += deltaDir * ratio;
-		camera-&gt;forward.Normalize();
+		camera-&gt;forward.ANormalize();
 	}
 }
 

Modified: branches/caiinterface/rts/Game/Game.cpp
===================================================================
--- branches/caiinterface/rts/Game/Game.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Game/Game.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -3075,7 +3075,7 @@
 		}
 		while(!gmlProcessor.PumpAux()) {
 			// could possibly make more calls to Draw here
-			boost::thread::yield(); 
+			boost::thread::yield();
 		}
 	}
 	else
@@ -3181,6 +3181,9 @@
 
 	if (!(gs-&gt;frameNum &amp; 31)) {
 		for (int a = 0; a &lt; gs-&gt;activeTeams; ++a) {
+			gs-&gt;Team(a)-&gt;ResetFrameVariables();
+		}
+		for (int a = 0; a &lt; gs-&gt;activeTeams; ++a) {
 			gs-&gt;Team(a)-&gt;SlowUpdate();
 		}
 	}
@@ -4343,8 +4346,8 @@
 		}
 		if(w-&gt;targetType!=Target_None){
 			float3 pos=w-&gt;targetPos;
-			float3 v1=(pos-camera-&gt;pos).Normalize();
-			float3 v2=(v1.cross(UpVector)).Normalize();
+			float3 v1=(pos-camera-&gt;pos).ANormalize();
+			float3 v2=(v1.cross(UpVector)).ANormalize();
 			float3 v3=(v2.cross(v1)).Normalize();
 			float radius=10;
 			if(w-&gt;targetType==Target_Unit)
@@ -4359,9 +4362,9 @@
 			if(!w-&gt;onlyForward){
 				float dist=std::min(w-&gt;owner-&gt;directControl-&gt;targetDist,w-&gt;range*0.9f);
 				pos=w-&gt;weaponPos+w-&gt;wantedDir*dist;
-				v1=(pos-camera-&gt;pos).Normalize();
-				v2=(v1.cross(UpVector)).Normalize();
-				v3=(v2.cross(v1)).Normalize();
+				v1=(pos-camera-&gt;pos).ANormalize();
+				v2=(v1.cross(UpVector)).ANormalize();
+				v3=(v2.cross(v1)).ANormalize();
 				radius=dist/100;
 
 				glBegin(GL_LINE_STRIP);
@@ -4381,7 +4384,7 @@
 				glVertexf3(pos+(v2*streflop::sin(PI*-0.25f)+v3*streflop::cos(PI*-0.25f))*radius);
 				glVertexf3(pos+(v2*streflop::sin(PI*-1.25f)+v3*streflop::cos(PI*-1.25f))*radius);
 			}
-			if((w-&gt;targetPos-camera-&gt;pos).Normalize().dot(camera-&gt;forward)&lt;0.7f){
+			if((w-&gt;targetPos-camera-&gt;pos).ANormalize().dot(camera-&gt;forward)&lt;0.7f){
 				glVertexf3(w-&gt;targetPos);
 				glVertexf3(camera-&gt;pos+camera-&gt;forward*100);
 			}

Modified: branches/caiinterface/rts/Game/GameHelper.cpp
===================================================================
--- branches/caiinterface/rts/Game/GameHelper.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Game/GameHelper.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -6,6 +6,7 @@
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;mmgr.h&quot;
 
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;Camera.h&quot;
 #include &quot;Game/GameSetup.h&quot;
 #include &quot;Game.h&quot;

Modified: branches/caiinterface/rts/Game/GameServer.cpp
===================================================================
--- branches/caiinterface/rts/Game/GameServer.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Game/GameServer.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -27,6 +27,7 @@
 
 #include &quot;LogOutput.h&quot;
 #include &quot;GameSetup.h&quot;
+#include &quot;GlobalSynced.h&quot;
 #include &quot;Action.h&quot;
 #include &quot;ChatMessage.h&quot;
 #include &quot;CommandMessage.h&quot;
@@ -39,6 +40,7 @@
 #include &quot;System/DemoReader.h&quot;
 #include &quot;System/AutohostInterface.h&quot;
 #include &quot;System/Util.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot; // for syncdebug
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;FileSystem/CRC.h&quot;
 #include &quot;Player.h&quot;

Modified: branches/caiinterface/rts/Game/GameServer.h
===================================================================
--- branches/caiinterface/rts/Game/GameServer.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Game/GameServer.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -8,11 +8,12 @@
 #include &lt;map&gt;
 #include &lt;deque&gt;
 #include &lt;set&gt;
+#include &lt;vector&gt;
 
 #include &quot;Console.h&quot;
 #include &quot;GameData.h&quot;
 #include &quot;PlayerBase.h&quot;
-#include &quot;System/GlobalStuff.h&quot;
+#include &quot;Game/GlobalConstants.h&quot;
 #include &quot;System/UnsyncedRNG.h&quot;
 #include &quot;SFloat3.h&quot;
 
@@ -90,7 +91,7 @@
 #ifdef DEBUG
 	bool gameClientUpdated;			//used to prevent the server part to update to fast when the client is mega slow (running some sort of debug mode)
 #endif
-	
+
 private:
 	/**
 	@brief catch commands from chat messages and handle them
@@ -118,19 +119,19 @@
 
 	void GenerateAndSendGameID();
 	std::string GetPlayerNames(const std::vector&lt;int&gt;&amp; indices) const;
-	
+
 	/// read data from demo and send it to clients
 	void SendDemoData(const bool skipping=false);
-	
+
 	void Broadcast(boost::shared_ptr&lt;const netcode::RawPacket&gt; packet);
-	
+
 	/**
 	@brief skip frames
-	
+
 	If you are watching a demo, this will push out all data until targetframe to all clients
 	*/
 	void SkipTo(int targetframe);
-	
+
 	void Message(const std::string&amp; message);
 	void Warning(const std::string&amp; message);
 
@@ -181,12 +182,12 @@
 	int delayedSyncResponseFrame;
 
 	///////////////// internal stuff //////////////////
-	
+
 	bool hasLocalClient;
 	unsigned localClientNumber;
-	
+
 	void RestrictedAction(const std::string&amp; action);
-	
+
 	/// If the server recieves a command, it will forward it to clients if it is not in this set
 	std::set&lt;std::string&gt; commandBlacklist;
 	boost::scoped_ptr&lt;netcode::UDPListener&gt; UDPNet;

Modified: branches/caiinterface/rts/Game/GameSetup.cpp
===================================================================
--- branches/caiinterface/rts/Game/GameSetup.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Game/GameSetup.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -404,31 +404,31 @@
 
 	baseMod     = file.SGetValueDef(&quot;&quot;,  &quot;GAME\\Gametype&quot;);
 	mapName     = file.SGetValueDef(&quot;&quot;,  &quot;GAME\\MapName&quot;);
-	luaGaiaStr  = file.SGetValueDef(&quot;1&quot;, &quot;GAME\\LuaGaia&quot;);
+	luaGaiaStr  = file.SGetValueDef(&quot;1&quot;, &quot;GAME\\ModOptions\\LuaGaia&quot;);
 	if (luaGaiaStr == &quot;0&quot;)
 		useLuaGaia = false;
 	else
 		useLuaGaia = true;
-	luaRulesStr = file.SGetValueDef(&quot;1&quot;, &quot;GAME\\LuaRules&quot;);
+	luaRulesStr = file.SGetValueDef(&quot;1&quot;, &quot;GAME\\ModOptions\\LuaRules&quot;);
 	saveName    = file.SGetValueDef(&quot;&quot;,  &quot;GAME\\Savefile&quot;);
 	demoName    = file.SGetValueDef(&quot;&quot;,  &quot;GAME\\Demofile&quot;);
 	hostDemo    = !demoName.empty();
 
-	file.GetDef(gameMode,         &quot;0&quot;, &quot;GAME\\GameMode&quot;);
-	file.GetDef(noHelperAIs,      &quot;0&quot;, &quot;GAME\\NoHelperAIs&quot;);
-	file.GetDef(maxUnits,       &quot;500&quot;, &quot;GAME\\MaxUnits&quot;);
-	file.GetDef(limitDgun,        &quot;0&quot;, &quot;GAME\\LimitDgun&quot;);
-	file.GetDef(diminishingMMs,   &quot;0&quot;, &quot;GAME\\DiminishingMMs&quot;);
-	file.GetDef(disableMapDamage, &quot;0&quot;, &quot;GAME\\DisableMapDamage&quot;);
-	file.GetDef(ghostedBuildings, &quot;1&quot;, &quot;GAME\\GhostedBuildings&quot;);
-	file.GetDef(startMetal,    &quot;1000&quot;, &quot;GAME\\StartMetal&quot;);
-	file.GetDef(startEnergy,   &quot;1000&quot;, &quot;GAME\\StartEnergy&quot;);
+	file.GetDef(gameMode,         &quot;0&quot;, &quot;GAME\\ModOptions\\GameMode&quot;);
+	file.GetDef(noHelperAIs,      &quot;0&quot;, &quot;GAME\\ModOptions\\NoHelperAIs&quot;);
+	file.GetDef(maxUnits,       &quot;500&quot;, &quot;GAME\\ModOptions\\MaxUnits&quot;);
+	file.GetDef(limitDgun,        &quot;0&quot;, &quot;GAME\\ModOptions\\LimitDgun&quot;);
+	file.GetDef(diminishingMMs,   &quot;0&quot;, &quot;GAME\\ModOptions\\DiminishingMMs&quot;);
+	file.GetDef(disableMapDamage, &quot;0&quot;, &quot;GAME\\ModOptions\\DisableMapDamage&quot;);
+	file.GetDef(ghostedBuildings, &quot;1&quot;, &quot;GAME\\ModOptions\\GhostedBuildings&quot;);
+	file.GetDef(startMetal,    &quot;1000&quot;, &quot;GAME\\ModOptions\\StartMetal&quot;);
+	file.GetDef(startEnergy,   &quot;1000&quot;, &quot;GAME\\ModOptions\\StartEnergy&quot;);
 
-	file.GetDef(maxSpeed, &quot;3.0&quot;, &quot;GAME\\MaxSpeed&quot;);
-	file.GetDef(minSpeed, &quot;0.3&quot;, &quot;GAME\\MinSpeed&quot;);
+	file.GetDef(maxSpeed, &quot;3.0&quot;, &quot;GAME\\ModOptions\\MaxSpeed&quot;);
+	file.GetDef(minSpeed, &quot;0.3&quot;, &quot;GAME\\ModOptions\\MinSpeed&quot;);
 
 	file.GetDef(myPlayerNum,  &quot;0&quot;, &quot;GAME\\MyPlayerNum&quot;);
-	file.GetDef(fixedAllies, &quot;1&quot;, &quot;GAME\\FixedAllies&quot;);
+	file.GetDef(fixedAllies, &quot;1&quot;, &quot;GAME\\ModOptions\\FixedAllies&quot;);
 
 	// Read the map &amp; mod options
 	if (file.SectionExist(&quot;GAME\\MapOptions&quot;)) {

Modified: branches/caiinterface/rts/Game/GameSetup.h
===================================================================
--- branches/caiinterface/rts/Game/GameSetup.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Game/GameSetup.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -6,7 +6,7 @@
 #include &lt;vector&gt;
 
 #include &quot;SFloat3.h&quot;
-#include &quot;GlobalStuff.h&quot;
+#include &quot;GlobalConstants.h&quot;
 #include &quot;PlayerBase.h&quot;
 
 class TdfParser;

Modified: branches/caiinterface/rts/Game/GameVersion.cpp
===================================================================
--- branches/caiinterface/rts/Game/GameVersion.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Game/GameVersion.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -11,10 +11,10 @@
 
 /** The game version as it's returned by unitsync and Spring on commandline.
 This version string is the one that's used to check sync. */
-const char* const VERSION_STRING = &quot;0.77b4+&quot;;
+const char* const VERSION_STRING = &quot;0.77b5&quot;;
 
 /** The game version as it's printed to infolog, for e.g. stacktrace translator. */
-const char* const VERSION_STRING_DETAILED = &quot;0.77b4+&quot;;
+const char* const VERSION_STRING_DETAILED = &quot;0.77b5&quot;;
 
 /** Build date and time. */
 const char* const BUILD_DATETIME = __DATE__ &quot; &quot; __TIME__;

Copied: branches/caiinterface/rts/Game/GlobalConstants.h (from rev 6844, trunk/rts/Game/GlobalConstants.h)
===================================================================
--- branches/caiinterface/rts/Game/GlobalConstants.h	                        (rev 0)
+++ branches/caiinterface/rts/Game/GlobalConstants.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -0,0 +1,62 @@
+#ifndef GLOBAL_CONSTANTS_H
+#define GLOBAL_CONSTANTS_H
+
+/**
+ * @brief maximum world size
+ *
+ * Defines the maximum world size as 1000000
+ */
+const int MAX_WORLD_SIZE = 1000000;
+
+/**
+ * @brief square size
+ *
+ * Defines the size of 1 square as 8
+ */
+const int  SQUARE_SIZE = 8;
+
+/**
+ * @brief game speed
+ *
+ * Defines the game speed as 30
+ */
+const int GAME_SPEED = 30;
+
+/**
+ * @brief max view range
+ *
+ * Defines the maximum view range as 8000
+ */
+const int MAX_VIEW_RANGE = 8000;
+
+/**
+ * @brief max teams
+ *
+ * Defines the maximum number of teams
+ * as 17 (16 real teams, and an extra slot for the GAIA team)
+ */
+const int MAX_TEAMS = 17;
+
+/**
+ * @brief max players
+ *
+ * Defines the maximum number of players as 32
+ */
+const int MAX_PLAYERS = 32;
+
+/**
+ * @brief near plane
+ *
+ * Defines the near plane as 2.8f
+ */
+const float NEAR_PLANE = 2.8f;
+
+/**
+ * @brief randint max
+ *
+ * Defines the maximum random integer as 0x7fff
+ */
+const int RANDINT_MAX = 0x7fff;
+
+
+#endif

Copied: branches/caiinterface/rts/Game/GlobalSynced.cpp (from rev 6844, trunk/rts/Game/GlobalSynced.cpp)
===================================================================
--- branches/caiinterface/rts/Game/GlobalSynced.cpp	                        (rev 0)
+++ branches/caiinterface/rts/Game/GlobalSynced.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -0,0 +1,253 @@
+#include &quot;GlobalSynced.h&quot;
+
+#include &lt;assert.h&gt;
+#include &lt;cstring&gt;
+
+#include &quot;GameSetup.h&quot;
+#include &quot;Team.h&quot;
+#include &quot;Player.h&quot;
+#include &quot;Lua/LuaGaia.h&quot;
+#include &quot;Lua/LuaRules.h&quot;
+#include &quot;Util.h&quot;
+#include &quot;Platform/errorhandler.h&quot;
+#include &quot;ExternalAI/IAILibraryManager.h&quot;
+
+/**
+ * @brief global synced
+ *
+ * Global instance of CGlobalSyncedStuff
+ */
+CGlobalSyncedStuff* gs;
+
+
+
+CR_BIND(CGlobalSyncedStuff,);
+
+CR_REG_METADATA(CGlobalSyncedStuff, (
+	CR_MEMBER(randSeed),
+	CR_MEMBER(initRandSeed),
+	CR_MEMBER(frameNum),
+	CR_MEMBER(speedFactor),
+	CR_MEMBER(userSpeedFactor),
+	CR_MEMBER(paused),
+	CR_MEMBER(tempNum),
+	CR_MEMBER(godMode),
+	CR_MEMBER(globalLOS),
+	CR_MEMBER(cheatEnabled),
+	CR_MEMBER(noHelperAIs),
+	CR_MEMBER(editDefsEnabled),
+	CR_MEMBER(useLuaRules),
+	CR_MEMBER(useLuaGaia),
+	CR_MEMBER(gaiaTeamID),
+	CR_MEMBER(gaiaAllyTeamID),
+	CR_MEMBER(gameMode),
+	CR_MEMBER(players),
+	CR_MEMBER(activeTeams),
+	CR_MEMBER(activeAllyTeams),
+	CR_MEMBER(activePlayers),
+	CR_MEMBER(allies),
+	CR_MEMBER(team2allyteam),
+	CR_MEMBER(teams),
+	CR_RESERVED(64)
+));
+
+
+/**
+ * Initializes variables in CGlobalSyncedStuff
+ */
+CGlobalSyncedStuff::CGlobalSyncedStuff()
+{
+	hmapx = 256;
+	hmapy = 256;
+	randSeed = 18655;
+	initRandSeed = randSeed;
+	frameNum = 0;
+	speedFactor = 1;
+	userSpeedFactor = 1;
+	paused = false;
+	godMode = false;
+	globalLOS = false;
+	cheatEnabled = false;
+	noHelperAIs = false;
+	editDefsEnabled = false;
+	tempNum = 2;
+	gameMode = 0;
+	useLuaGaia = true;
+	gaiaTeamID = -1;
+	gaiaAllyTeamID = -1;
+	useLuaRules = true;
+	
+	for(int a = 0; a &lt; MAX_TEAMS; ++a) {
+		teams[a] = SAFE_NEW CTeam();
+		teams[a]-&gt;teamNum = a;
+		team2allyteam[a] = a;
+	}
+	for(int a = 0; a &lt; MAX_PLAYERS; ++a) {
+		players[a] = SAFE_NEW CPlayer();
+		players[a]-&gt;playerNum = a;
+	}
+
+	for (int a = 0; a &lt; MAX_TEAMS; ++a) {
+		for (int b = 0; b &lt; MAX_TEAMS; ++b) {
+			allies[a][b] = false;
+		}
+		allies[a][a] = true;
+	}
+
+	activeTeams = 2;
+	activeAllyTeams = 2;
+	activePlayers = MAX_PLAYERS;
+}
+
+/**
+ * Destroys data inside CGlobalSyncedStuff
+ */
+CGlobalSyncedStuff::~CGlobalSyncedStuff()
+{
+	for(int a = 0; a &lt; MAX_TEAMS; a++) {
+		delete teams[a];
+	}
+	for(int a = 0; a &lt; MAX_PLAYERS; a++) {
+		delete players[a];
+	}
+}
+
+void CGlobalSyncedStuff::LoadFromSetup(const CGameSetup* setup)
+{
+	gameMode = setup-&gt;gameMode;
+	noHelperAIs = !!setup-&gt;noHelperAIs;
+
+	useLuaGaia  = CLuaGaia::SetConfigString(setup-&gt;luaGaiaStr);
+	useLuaRules = CLuaRules::SetConfigString(setup-&gt;luaRulesStr);
+
+	activePlayers = setup-&gt;numPlayers;
+	activeTeams = setup-&gt;numTeams;
+	activeAllyTeams = setup-&gt;numAllyTeams;
+	
+	assert(activeTeams &lt;= MAX_TEAMS);
+	assert(activeAllyTeams &lt;= MAX_TEAMS);
+
+	for (int i = 0; i &lt; activePlayers; ++i)
+	{
+		// TODO: refactor
+		*static_cast&lt;PlayerBase*&gt;(players[i]) = setup-&gt;playerStartingData[i];
+	}
+
+	for (int i = 0; i &lt; activeTeams; ++i)
+	{
+		teams[i]-&gt;metal = setup-&gt;startMetal;
+		teams[i]-&gt;metalIncome = setup-&gt;startMetal; // for the endgame statistics
+
+		teams[i]-&gt;energy = setup-&gt;startEnergy;
+		teams[i]-&gt;energyIncome = setup-&gt;startEnergy;
+
+		float3 start(setup-&gt;teamStartingData[i].startPos.x, setup-&gt;teamStartingData[i].startPos.y, setup-&gt;teamStartingData[i].startPos.z);
+		teams[i]-&gt;StartposMessage(start, (setup-&gt;startPosType != CGameSetup::StartPos_ChooseInGame));
+		std::memcpy(teams[i]-&gt;color, setup-&gt;teamStartingData[i].color, 4);
+		teams[i]-&gt;handicap = setup-&gt;teamStartingData[i].handicap;
+		teams[i]-&gt;leader = setup-&gt;teamStartingData[i].leader;
+		teams[i]-&gt;side = setup-&gt;teamStartingData[i].side;
+		SetAllyTeam(i, setup-&gt;teamStartingData[i].teamAllyteam);
+		if (!(setup-&gt;teamStartingData[i].luaAI.empty())) {
+			teams[i]-&gt;luaAI = setup-&gt;teamStartingData[i].luaAI;
+			teams[i]-&gt;isAI = true;
+		}
+		else {
+			if (setup-&gt;hostDemo) {
+				SSAIKey key = {{NULL, NULL}, {NULL, NULL}};
+				teams[i]-&gt;skirmishAISpecifier = key;
+			}
+			else
+			{
+				const char* sn = setup-&gt;teamStartingData[i].skirmishAIShortName.c_str();
+				const char* v = setup-&gt;teamStartingData[i].skirmishAIVersion.empty() ? NULL : setup-&gt;teamStartingData[i].skirmishAIVersion.c_str();
+				SSAISpecifier spec = {sn, v};
+				std::vector&lt;SSAIKey&gt; fittingKeys = IAILibraryManager::GetInstance()-&gt;ResolveSkirmishAIKey(spec);
+				if (fittingKeys.size() &gt; 0) {
+					teams[i]-&gt;skirmishAISpecifier = fittingKeys[0];
+					teams[i]-&gt;isAI = true;
+				} else {
+					const int MAX_MSG_LENGTH = 511;
+					char s_msg[MAX_MSG_LENGTH + 1];
+					SNPRINTF(s_msg, MAX_MSG_LENGTH, &quot;Specifyed Skirmish AI could not be found: %s (version: %s)&quot;, spec.shortName, spec.version != NULL ? spec.version : &quot;&lt;not specifyed&gt;&quot;);
+					handleerror(NULL, s_msg, &quot;Game Script Error&quot;, MBF_OK | MBF_EXCL);
+				}
+			}
+		}
+	}
+
+	for (int allyTeam1 = 0; allyTeam1 &lt; activeAllyTeams; ++allyTeam1)
+	{
+		for (int allyTeam2 = 0; allyTeam2 &lt; activeAllyTeams; ++allyTeam2)
+			allies[allyTeam1][allyTeam2] = setup-&gt;allyStartingData[allyTeam1].allies[allyTeam2];
+	}
+
+	if (useLuaGaia) {
+		//TODO duplicated in SpringApp::CreateGameSetup()
+		// Gaia adjustments
+		gaiaTeamID = activeTeams;
+		gaiaAllyTeamID = activeAllyTeams;
+		activeTeams++;
+		activeAllyTeams++;
+
+		// Setup the gaia team
+		CTeam* team = gs-&gt;Team(gs-&gt;gaiaTeamID);
+		team-&gt;color[0] = 255;
+		team-&gt;color[1] = 255;
+		team-&gt;color[2] = 255;
+		team-&gt;color[3] = 255;
+		team-&gt;gaia = true;
+		team-&gt;StartposMessage(float3(0.0, 0.0, 0.0), true);
+		//players[setup-&gt;numPlayers]-&gt;team = gaiaTeamID;
+		SetAllyTeam(gaiaTeamID, gaiaAllyTeamID);
+	}
+}
+
+/**
+ * @return synced random integer
+ *
+ * returns a synced random integer
+ */
+int CGlobalSyncedStuff::randInt()
+{
+	randSeed = (randSeed * 214013L + 2531011L);
+	return randSeed &amp; RANDINT_MAX;
+}
+
+/**
+ * @return synced random float
+ *
+ * returns a synced random float
+ */
+float CGlobalSyncedStuff::randFloat()
+{
+	randSeed = (randSeed * 214013L + 2531011L);
+	return float(randSeed &amp; RANDINT_MAX)/RANDINT_MAX;
+}
+
+/**
+ * @return synced random vector
+ *
+ * returns a synced random vector
+ */
+float3 CGlobalSyncedStuff::randVector()
+{
+	float3 ret;
+	do {
+		ret.x = randFloat()*2-1;
+		ret.y = randFloat()*2-1;
+		ret.z = randFloat()*2-1;
+	} while(ret.SqLength()&gt;1);
+
+	return ret;
+}
+
+int CGlobalSyncedStuff::Player(const std::string&amp; name)
+{
+	for (int i = 0; i &lt; MAX_PLAYERS; ++i) {
+		if (players[i] &amp;&amp; players[i]-&gt;name == name) {
+			return i;
+		}
+	}
+	return -1;
+}

Copied: branches/caiinterface/rts/Game/GlobalSynced.h (from rev 6844, trunk/rts/Game/GlobalSynced.h)
===================================================================
--- branches/caiinterface/rts/Game/GlobalSynced.h	                        (rev 0)
+++ branches/caiinterface/rts/Game/GlobalSynced.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -0,0 +1,341 @@
+#ifndef GLOBAL_UNSYNCED_H
+#define GLOBAL_UNSYNCED_H
+
+#include &lt;string&gt;
+
+#include &quot;float3.h&quot;
+#include &quot;GlobalConstants.h&quot;
+#include &quot;creg/creg.h&quot;
+
+
+class CGameSetup;
+class CTeam;
+class CPlayer;
+
+/**
+ * @brief Global synced stuff
+ *
+ * Class contains globally accessible
+ * stuff that remains synced.
+ */
+class CGlobalSyncedStuff
+{
+public:
+	CR_DECLARE(CGlobalSyncedStuff);
+	CGlobalSyncedStuff();  //!&lt; Constructor
+	~CGlobalSyncedStuff(); //!&lt; Destructor
+	void LoadFromSetup(const CGameSetup*);
+
+	int    randInt();    //!&lt; synced random int
+	float  randFloat();  //!&lt; synced random float
+	float3 randVector(); //!&lt; synced random vector
+
+	void SetRandSeed(unsigned int seed, bool init = false) {
+		randSeed = seed;
+		if (init) { initRandSeed = randSeed; }
+	}
+	unsigned int GetRandSeed()     const { return randSeed; }
+	unsigned int GetInitRandSeed() const { return initRandSeed; }
+
+	/**
+	* @brief frame number
+	*
+	* Stores the current frame number
+	*/
+	int frameNum;
+
+	/**
+	* @brief speed factor
+	*
+	* Contains the actual gamespeed used by the game
+	*/
+	float speedFactor;
+
+	/**
+	* @brief user speed factor
+	*
+	* Contains the user's speed factor.
+	* The real gamespeed can be up to this
+	* but is lowered if a computer can't keep up
+	*/
+	float userSpeedFactor;
+
+	/**
+	* @brief paused
+	*
+	* Holds whether the game is paused
+	*/
+	bool paused;
+
+	/**
+	* @brief map x
+	*
+	* The map's number of squares in the x direction
+	* (note that the number of vertices is one more)
+	*/
+	int mapx;
+
+	/**
+	* @brief map y
+	*
+	* The map's number of squares in the y direction
+	*/
+	int mapy;
+
+	/**
+	* @brief map squares
+	*
+	* Total number of squares on the map
+	*/
+	int mapSquares;
+
+	/**
+	* @brief half map x
+	*
+	* Contains half of the number of squares in the x direction
+	*/
+	int hmapx;
+
+	/**
+	* @brief half map y
+	*
+	* Contains half of the number of squares in the y direction
+	*/
+	int hmapy;
+
+	/**
+	* @brief map x power of 2
+	*
+	* Map's size in the x direction rounded
+	* up to the next power of 2
+	*/
+	int pwr2mapx;
+
+	/**
+	* @brief map y power of 2
+	*
+	* Map's size in the y direction rounded
+	* up to the next power of 2
+	*/
+	int pwr2mapy;
+
+	/**
+	* @brief temp num
+	*
+	* Used for getting temporary but unique numbers
+	* (increase after each use)
+	*/
+	int tempNum;
+
+	/**
+	* @brief god mode
+	*
+	* Whether god mode is enabled, allows all players to control all units (even specs)
+	*/
+	bool godMode;
+
+	/**
+	* @brief global line-of-sight
+	*
+	* Whether everything on the map is visible at all times
+	*/
+	bool globalLOS;
+
+	/**
+	* @brief cheat enabled
+	*
+	* Whether cheating is enabled
+	*/
+	bool cheatEnabled;
+
+	/**
+	* @brief disable helper AIs
+	*
+	* Whether helper AIs are allowed, including GroupAI and LuaUI control widgets
+	*/
+	bool noHelperAIs;
+
+	/**
+	* @brief definition editing enabled
+	*
+	* Whether definition editing is enabled
+	*/
+	bool editDefsEnabled;
+
+	/**
+	* @brief LuaRules control
+	*
+	* Whether or not LuaRules is enabled
+	*/
+	bool useLuaRules;
+
+	/**
+	* @brief LuaGaia control
+	*
+	* Whether or not LuaGaia is enabled
+	*/
+	bool useLuaGaia;
+
+	/**
+	* @brief gaia team
+	*
+	* gaia's team id
+	*/
+	int gaiaTeamID;
+
+	/**
+	* @brief gaia team
+	*
+	* gaia's team id
+	*/
+	int gaiaAllyTeamID;
+
+	/**
+	* @brief game mode
+	*
+	* Determines the commander mode of this game
+	*   0: game continues after commander dies
+	*   1: game ends when commander dies
+	*   2: lineage mode (all descendants die when a commander dies)
+	*/
+	int gameMode;
+
+	/**
+	* @brief players
+	*
+	* Array of CPlayer pointers, for all the
+	* players in the game
+	* (size MAX_PLAYERS)
+	*/
+	CPlayer* players[MAX_PLAYERS];
+
+	/**
+	* @brief active teams
+	*
+	* The number of active teams
+	* (don't change during play)
+	*/
+	int activeTeams;
+
+	/**
+	* @brief active ally teams
+	*
+	* The number of active ally teams
+	*/
+	int activeAllyTeams;
+
+	/**
+	* @brief active players
+	*
+	* The number of active players
+	*/
+	int activePlayers;
+
+	/**
+	* @brief Player
+	* @param name name of the player
+	* @return his playernumber of -1 if not found
+	*
+	* Search a player by name.
+	*/
+	int Player(const std::string&amp; name);
+
+	/**
+	* @brief Team
+	* @param i index to fetch
+	* @return CTeam pointer
+	*
+	* Accesses a CTeam pointer at a given index
+	*/
+	CTeam *Team(int i) { return teams[i]; }
+
+	/**
+	* @brief ally
+	* @param a first index
+	* @param b second index
+	* @return allies[a][b]
+	*
+	* Returns ally at [a][b]
+	*/
+	bool Ally(int a,int b) { return allies[a][b]; }
+
+	/**
+	* @brief ally team
+	* @param team team to find
+	* @return the ally team
+	*
+	* returns the team2ally at given index
+	*/
+	int AllyTeam(int team) { return team2allyteam[team]; }
+
+	/**
+	* @brief allied teams
+	* @param a first team
+	* @param b second team
+	* @return whether teams are allied
+	*
+	* Tests whether teams are allied
+	*/
+	bool AlliedTeams(int a,int b) { return allies[team2allyteam[a]][team2allyteam[b]]; }
+
+	/**
+	* @brief set ally team
+	* @param team team to set
+	* @param allyteam allyteam to set
+	*
+	* Sets team's ally team
+	*/
+	void SetAllyTeam(int team, int allyteam) { team2allyteam[team]=allyteam; }
+
+	/**
+	* @brief set ally
+	* @param allyteamA first allyteam
+	* @param allyteamB second allyteam
+	* @param allied whether or not these two teams are allied
+	*
+	* Sets two allyteams to be allied or not
+	*/
+	void SetAlly(int allyteamA,int allyteamB, bool allied) { allies[allyteamA][allyteamB]=allied; }
+
+private:
+	/**
+	* @brief random seed
+	*
+	* Holds the synced random seed
+	*/
+	int randSeed;
+
+	/**
+	* @brief initial random seed
+	*
+	* Holds the synced initial random seed
+	*/
+	int initRandSeed;
+
+	/**
+	* @brief allies array
+	*
+	* Array indicates whether teams are allied,
+	* allies[a][b] means allyteam a is allied with
+	* allyteam b, NOT the other way around
+	*/
+	bool allies[MAX_TEAMS][MAX_TEAMS];
+
+	/**
+	* @brief team to ally team
+	*
+	* Array stores what ally team a specific team is part of
+	*/
+	int team2allyteam[MAX_TEAMS];
+
+	/**
+	* @brief teams
+	*
+	* Array of CTeam pointers for teams in game
+	*/
+	CTeam* teams[MAX_TEAMS];
+};
+
+extern CGlobalSyncedStuff* gs;
+
+#endif //GLOBAL_UNSYNCED_H

Modified: branches/caiinterface/rts/Game/Player.cpp
===================================================================
--- branches/caiinterface/rts/Game/Player.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Game/Player.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -8,12 +8,14 @@
 
 #include &quot;Player.h&quot;
 #include &quot;Team.h&quot;
+#include &quot;GlobalSynced.h&quot;
 #ifdef DIRECT_CONTROL_ALLOWED
 #  include &quot;UI/MouseHandler.h&quot;
 #  include &quot;CameraHandler.h&quot;
 #  include &quot;Camera.h&quot;
 #endif
 #include &quot;System/EventHandler.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 CR_BIND(CPlayer,);
 

Modified: branches/caiinterface/rts/Game/PlayerRoster.cpp
===================================================================
--- branches/caiinterface/rts/Game/PlayerRoster.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Game/PlayerRoster.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -11,6 +11,8 @@
 #include &quot;Player.h&quot;
 #include &quot;Team.h&quot;
 #include &quot;Util.h&quot;
+#include &quot;GlobalSynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 static int CompareAllies     (const void* a, const void* b);
 static int CompareTeamIDs    (const void* a, const void* b);

Modified: branches/caiinterface/rts/Game/PreGame.cpp
===================================================================
--- branches/caiinterface/rts/Game/PreGame.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Game/PreGame.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -15,6 +15,7 @@
 #include &quot;GameServer.h&quot;
 #include &quot;GameSetup.h&quot;
 #include &quot;GameData.h&quot;
+#include &quot;GlobalSynced.h&quot;
 #include &quot;NetProtocol.h&quot;
 #include &quot;Net/RawPacket.h&quot;
 #include &quot;DemoRecorder.h&quot;

Modified: branches/caiinterface/rts/Game/SelectedUnits.cpp
===================================================================
--- branches/caiinterface/rts/Game/SelectedUnits.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Game/SelectedUnits.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -10,6 +10,7 @@
 #include &quot;mmgr.h&quot;
 
 #include &quot;Game/Team.h&quot;
+#include &quot;Game/GlobalSynced.h&quot;
 #include &quot;SelectedUnits.h&quot;
 #include &quot;WaitCommandsAI.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;

Modified: branches/caiinterface/rts/Game/SelectedUnitsAI.cpp
===================================================================
--- branches/caiinterface/rts/Game/SelectedUnitsAI.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Game/SelectedUnitsAI.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -13,7 +13,8 @@
 #include &quot;SelectedUnits.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;NetProtocol.h&quot;
-#include &quot;GlobalStuff.h&quot;
+#include &quot;GlobalSynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 #include &quot;Player.h&quot;
 #include &quot;WaitCommandsAI.h&quot;
 #include &quot;Map/Ground.h&quot;
@@ -38,29 +39,7 @@
 	lineDist = 64;
 }
 
-/*
-Group-AI.
-Processing commands given to selected group.
-*/
 
-
-/*
-void CSelectedUnitsAI::AddUnit(int unit)
-{
-	myUnits.insert(unit);
-	unitsChanged=true;
-	return true;
-}
-
-
-void CSelectedUnitsAI::RemoveUnit(int unit)
-{
-	myUnits.erase(unit);
-	unitsChanged=true;
-}
-*/
-
-
 inline void CSelectedUnitsAI::AddUnitSetMaxSpeedCommand(CUnit* unit,
                                                         unsigned char options)
 {
@@ -185,7 +164,7 @@
 		const float3 pos(c.params[0], c.params[1], c.params[2]);
 		float3 frontdir = pos - centerCoor;
 		frontdir.y = 0.0f;
-		frontdir.Normalize();
+		frontdir.ANormalize();
 		const float3 sideDir = frontdir.cross(UpVector);
 
 		// calculate so that the units form in an aproximate square
@@ -348,7 +327,7 @@
 	sideDir.y=0;
 	float3 sd = sideDir;
 	sd.y=frontLength/2;
-	sideDir.Normalize();
+	sideDir.ANormalize();
 	frontDir=sideDir.cross(float3(0,1,0));
 
 	numColumns=(int)(frontLength/columnDist);

Modified: branches/caiinterface/rts/Game/StartScripts/AirScript.cpp
===================================================================
--- branches/caiinterface/rts/Game/StartScripts/AirScript.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Game/StartScripts/AirScript.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -13,6 +13,7 @@
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Map/Ground.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 
 
@@ -163,12 +164,12 @@
 	float3 modPlanePos=u-&gt;pos-u-&gt;frontdir*25+u-&gt;speed*gu-&gt;timeOffset;
 	tcp+=(modPlanePos-tcp)*(1-pow(0.95f,deltaTime));
 	tcf+=(u-&gt;frontdir-tcf)*(1-pow(0.9f,deltaTime));
-	tcf.Normalize();
+	tcf.ANormalize();
 
 	camera-&gt;pos=tcp;
-	//camera-&gt;forward=((u-&gt;pos+u-&gt;speed*gu-&gt;timeOffset-camera-&gt;pos).Normalize()+u-&gt;frontdir).Normalize();
-	camera-&gt;forward=((u-&gt;pos+u-&gt;speed*gu-&gt;timeOffset-camera-&gt;pos).Normalize()+tcf.Normalize());
-	camera-&gt;forward.Normalize();
+	//camera-&gt;forward=((u-&gt;pos+u-&gt;speed*gu-&gt;timeOffset-camera-&gt;pos).Normalize()+u-&gt;frontdir).ANormalize();
+	camera-&gt;forward=((u-&gt;pos+u-&gt;speed*gu-&gt;timeOffset-camera-&gt;pos).ANormalize()+tcf.ANormalize());
+	camera-&gt;forward.ANormalize();
 
 	if(doRoll){
 		oldUp[gs-&gt;frameNum%32]=u-&gt;updir;

Modified: branches/caiinterface/rts/Game/Team.cpp
===================================================================
--- branches/caiinterface/rts/Game/Team.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Game/Team.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -5,10 +5,13 @@
 #include &quot;StdAfx.h&quot;
 #include &quot;mmgr.h&quot;
 
+#include &quot;Team.h&quot;
+
 #include &quot;Messages.h&quot;
-#include &quot;Team.h&quot;
+#include &quot;GlobalSynced.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Player.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 #include &quot;Game/UI/LuaUI.h&quot;
 #include &quot;Lua/LuaRules.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
@@ -16,6 +19,7 @@
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;ExternalAI/GlobalAIHandler.h&quot;
 #include &quot;System/EventHandler.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;creg/STL_List.h&quot;
 #include &quot;creg/STL_Map.h&quot;
 #include &quot;creg/STL_Set.h&quot;
@@ -284,13 +288,10 @@
 	startPos = pos;
 }
 
-void CTeam::SlowUpdate()
+/** This has to be called for every team before SlowUpdates start,
+	otherwise values get overwritten. */
+void CTeam::ResetFrameVariables()
 {
-	currentStats.metalProduced  += metalIncome;
-	currentStats.energyProduced += energyIncome;
-	currentStats.metalUsed  += metalUpkeep + metalExpense;
-	currentStats.energyUsed += energyUpkeep + energyExpense;
-
 	prevMetalPull     = metalPull;
 	prevMetalIncome   = metalIncome;
 	prevMetalExpense  = metalExpense;
@@ -313,7 +314,15 @@
 	energySent = 0;
 	metalReceived = 0;
 	energyReceived = 0;
+}
 
+void CTeam::SlowUpdate()
+{
+	currentStats.metalProduced  += metalIncome;
+	currentStats.energyProduced += energyIncome;
+	currentStats.metalUsed  += metalUpkeep + metalExpense;
+	currentStats.energyUsed += energyUpkeep + energyExpense;
+
 	float eShare = 0.0f, mShare = 0.0f;
 	for (int a = 0; a &lt; gs-&gt;activeTeams; ++a) {
 		if ((a != teamNum) &amp;&amp; (gs-&gt;AllyTeam(teamNum) == gs-&gt;AllyTeam(a))) {

Modified: branches/caiinterface/rts/Game/Team.h
===================================================================
--- branches/caiinterface/rts/Game/Team.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Game/Team.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -19,6 +19,7 @@
 	CR_DECLARE_SUB(Statistics);
 	CTeam();
 	~CTeam();
+	void ResetFrameVariables();
 	void SlowUpdate();
 
 
@@ -33,12 +34,12 @@
 	void SetBaseEnergyStorage(float storage) {energyStorage = storage;};
 
 	void GiveEverythingTo(const unsigned toTeam);
-	
+
 	void Died();
 
 	void StartposMessage(const float3&amp; pos, const bool isReady);
 	void StartposMessage(const float3&amp; pos);
-	
+
 	inline bool IsReadyToStart() const {return readyToStart;};
 	enum AddType{
 		AddBuilt,

Modified: branches/caiinterface/rts/Game/UI/EndGameBox.cpp
===================================================================
--- branches/caiinterface/rts/Game/UI/EndGameBox.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Game/UI/EndGameBox.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -10,6 +10,7 @@
 #include &quot;Rendering/glFont.h&quot;
 #include &quot;NetProtocol.h&quot;
 #include &quot;Game/Game.h&quot;
+#include &quot;Game/GlobalSynced.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
 #include &quot;Rendering/Textures/Bitmap.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;

Modified: branches/caiinterface/rts/Game/UI/EndGameBox.h
===================================================================
--- branches/caiinterface/rts/Game/UI/EndGameBox.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Game/UI/EndGameBox.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -5,6 +5,7 @@
 #include &lt;list&gt;
 #include &lt;vector&gt;
 #include &quot;Rendering/GL/myGL.h&quot;
+#include &quot;Game/GlobalConstants.h&quot;
 
 
 // msvc behaves really strange

Modified: branches/caiinterface/rts/Game/UI/GameSetupDrawer.cpp
===================================================================
--- branches/caiinterface/rts/Game/UI/GameSetupDrawer.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Game/UI/GameSetupDrawer.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -16,6 +16,7 @@
 #include &quot;../Player.h&quot;
 #include &quot;../Team.h&quot;
 #include &quot;../GameSetup.h&quot;
+#include &quot;Game/GlobalSynced.h&quot;
 #include &quot;StartPosSelecter.h&quot;
 #include &quot;Rendering/glFont.h&quot;
 #include &quot;System/EventHandler.h&quot;

Modified: branches/caiinterface/rts/Game/UI/GuiHandler.cpp
===================================================================
--- branches/caiinterface/rts/Game/UI/GuiHandler.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Game/UI/GuiHandler.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -2306,7 +2306,7 @@
 				if (!commands[tempInCommand].params.empty() &amp;&amp;
 				    pos.distance2D(pos2) &gt; atof(commands[tempInCommand].params[0].c_str())) {
 					float3 dif=pos2-pos;
-					dif.Normalize();
+					dif.ANormalize();
 					pos2=pos+dif*atoi(commands[tempInCommand].params[0].c_str());
 				}
 
@@ -4027,7 +4027,7 @@
 	ProcessFrontPositions(pos1, pos2);
 
 	float3 forward=(pos1-pos2).cross(UpVector);
-	forward.Normalize();
+	forward.ANormalize();
 	float3 side=forward.cross(UpVector);
 	if(pos1.distance2D(pos2)&gt;maxSize){
 		pos2=pos1+side*maxSize;

Modified: branches/caiinterface/rts/Game/UI/InputReceiver.h
===================================================================
--- branches/caiinterface/rts/Game/UI/InputReceiver.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Game/UI/InputReceiver.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -5,7 +5,7 @@
 #include &lt;string&gt;
 
 #include &quot;Object.h&quot;
-#include &quot;GlobalStuff.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 class CInputReceiver :
 	public CObject

Modified: branches/caiinterface/rts/Game/UI/MouseCursor.cpp
===================================================================
--- branches/caiinterface/rts/Game/UI/MouseCursor.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Game/UI/MouseCursor.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -7,6 +7,7 @@
 #include &quot;FileSystem/SimpleParser.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;System/Util.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;MouseCursor.h&quot;
 #include &quot;HwMouseCursor.h&quot;
 #include &quot;myMath.h&quot;

Modified: branches/caiinterface/rts/Game/UI/MouseHandler.cpp
===================================================================
--- branches/caiinterface/rts/Game/UI/MouseHandler.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Game/UI/MouseHandler.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -349,9 +349,9 @@
 			float3 pos2=camera-&gt;pos+dir*dist;
 
 			float3 dir1=pos1-camera-&gt;pos;
-			dir1.Normalize();
+			dir1.ANormalize();
 			float3 dir2=pos2-camera-&gt;pos;
-			dir2.Normalize();
+			dir2.ANormalize();
 
 			float rl1=(dir1.dot(camera-&gt;right))/dir1.dot(camera-&gt;forward);
 			float ul1=(dir1.dot(camera-&gt;up))/dir1.dot(camera-&gt;forward);

Modified: branches/caiinterface/rts/Game/UI/QuitBox.cpp
===================================================================
--- branches/caiinterface/rts/Game/UI/QuitBox.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Game/UI/QuitBox.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -3,6 +3,7 @@
 #include &quot;mmgr.h&quot;
 
 #include &quot;Game/Team.h&quot;
+#include &quot;Game/GlobalSynced.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;MouseHandler.h&quot;
 #include &quot;NetProtocol.h&quot;

Modified: branches/caiinterface/rts/Game/UI/ResourceBar.cpp
===================================================================
--- branches/caiinterface/rts/Game/UI/ResourceBar.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Game/UI/ResourceBar.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -5,6 +5,7 @@
 #include &quot;MouseHandler.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Game/Team.h&quot;
+#include &quot;Game/GlobalSynced.h&quot;
 #include &quot;Rendering/glFont.h&quot;
 #include &quot;NetProtocol.h&quot;
 #include &quot;TimeProfiler.h&quot;

Modified: branches/caiinterface/rts/Game/UI/SelectionKeyHandler.cpp
===================================================================
--- branches/caiinterface/rts/Game/UI/SelectionKeyHandler.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Game/UI/SelectionKeyHandler.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -522,7 +522,7 @@
 			wantedCamDir.x=(float)(sin(camera-&gt;rot.y)*cos(camera-&gt;rot.x));
 			wantedCamDir.y=(float)(sin(camera-&gt;rot.x));
 			wantedCamDir.z=(float)(cos(camera-&gt;rot.y)*cos(camera-&gt;rot.x));
-			wantedCamDir.Normalize();
+			wantedCamDir.ANormalize();
 
 			camHandler-&gt;GetCurrentController().SetPos(sel-&gt;pos - wantedCamDir*800);
 		}

Modified: branches/caiinterface/rts/Game/UI/ShareBox.cpp
===================================================================
--- branches/caiinterface/rts/Game/UI/ShareBox.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Game/UI/ShareBox.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -7,6 +7,7 @@
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Game/Team.h&quot;
 #include &quot;Game/Player.h&quot;
+#include &quot;Game/GlobalSynced.h&quot;
 #include &quot;Rendering/glFont.h&quot;
 #include &quot;NetProtocol.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;

Modified: branches/caiinterface/rts/Game/UI/TooltipConsole.cpp
===================================================================
--- branches/caiinterface/rts/Game/UI/TooltipConsole.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Game/UI/TooltipConsole.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -345,6 +345,6 @@
 	        pos.x, pos.z, pos.y, ttype.c_str(),
 	        tt-&gt;tankSpeed, tt-&gt;kbotSpeed, tt-&gt;hoverSpeed, tt-&gt;shipSpeed,
 	        tt-&gt;hardness * mapDamage-&gt;mapHardness,
-	        readmap-&gt;metalMap-&gt;getMetalAmount((int)(pos.x/16), (int)(pos.z/16)));
+	        readmap-&gt;metalMap-&gt;GetMetalAmount((int)(pos.x/16), (int)(pos.z/16)));
 	return tmp;
 }

Modified: branches/caiinterface/rts/Game/WaitCommandsAI.cpp
===================================================================
--- branches/caiinterface/rts/Game/WaitCommandsAI.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Game/WaitCommandsAI.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -18,7 +18,8 @@
 #include &quot;Sim/Units/CommandAI/FactoryCAI.h&quot;
 #include &quot;Sim/Units/CommandAI/LineDrawer.h&quot;
 #include &quot;Sim/Units/UnitTypes/Factory.h&quot;
-#include &quot;System/GlobalStuff.h&quot;
+#include &quot;Game/GlobalSynced.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;System/Object.h&quot;
 #include &quot;UI/CommandColors.h&quot;
 #include &quot;UI/CursorIcons.h&quot;

Modified: branches/caiinterface/rts/Lua/LuaFeatureDefs.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaFeatureDefs.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Lua/LuaFeatureDefs.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -16,6 +16,7 @@
 
 #include &quot;LuaInclude.h&quot;
 
+#include &quot;Game/GlobalSynced.h&quot;
 #include &quot;LuaDefs.h&quot;
 #include &quot;LuaHandle.h&quot;
 #include &quot;LuaUtils.h&quot;

Modified: branches/caiinterface/rts/Lua/LuaGaia.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaGaia.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Lua/LuaGaia.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -19,6 +19,7 @@
 #include &quot;LuaWeaponDefs.h&quot;
 #include &quot;LuaOpenGL.h&quot;
 
+#include &quot;Game/GlobalSynced.h&quot;
 #include &quot;Sim/Units/CommandAI/Command.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Rendering/UnitModels/UnitDrawer.h&quot;

Modified: branches/caiinterface/rts/Lua/LuaHandle.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaHandle.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Lua/LuaHandle.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -26,6 +26,7 @@
 #include &quot;Game/UI/KeySet.h&quot;
 #include &quot;Game/UI/KeyBindings.h&quot;
 #include &quot;Game/UI/MiniMap.h&quot;
+#include &quot;Game/GlobalSynced.h&quot;
 #include &quot;Rendering/InMapDraw.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Rendering/UnitModels/UnitDrawer.h&quot;
@@ -60,9 +61,15 @@
   cobCallback(callback),
   killMe     (false),
   synced     (false),
+#ifdef DEBUG
+  printTracebacks(true),
+#else
+  printTracebacks(false),
+#endif
   callinErrors(0)
 {
 	L = lua_open();
+	luaopen_debug(L);
 }
 
 
@@ -183,17 +190,33 @@
 /******************************************************************************/
 /******************************************************************************/
 
-bool CLuaHandle::RunCallIn(const LuaHashString&amp; hs, int inArgs, int outArgs)
+int CLuaHandle::SetupTraceback()
 {
+	if (!printTracebacks)
+		return 0;
+
+	return LuaUtils::PushDebugTraceback(L);
+}
+
+
+bool CLuaHandle::RunCallInTraceback(const LuaHashString&amp; hs, int inArgs, int outArgs, int errfuncIndex)
+{
 	CLuaHandle* orig = activeHandle;
 	SetActiveHandle();
-	const int error = lua_pcall(L, inArgs, outArgs, 0);
+	const int error = lua_pcall(L, inArgs, outArgs, errfuncIndex);
 	SetActiveHandle(orig);
 
-	if (error != 0) {
+	if (error == 0) {
+		// pop the error handler
+		if (errfuncIndex != 0) {
+			lua_remove(L, errfuncIndex);
+		}
+	} else {
 		logOutput.Print(&quot;%s::RunCallIn: error = %i, %s, %s\n&quot;, GetName().c_str(), error,
 		                hs.GetString().c_str(), lua_tostring(L, -1));
 		lua_pop(L, 1);
+		if (errfuncIndex != 0)
+			lua_remove(L, errfuncIndex);
 		// log only errors that lead to a crash
 		callinErrors += (error == 2);
 		return false;
@@ -202,6 +225,13 @@
 }
 
 
+bool CLuaHandle::RunCallIn(const LuaHashString&amp; hs, int inArgs, int outArgs)
+{
+	return RunCallInTraceback(hs, inArgs, outArgs, 0);
+}
+
+
+
 inline bool CLuaHandle::RunCallInUnsynced(const LuaHashString&amp; hs,
                                           int inArgs, int outArgs)
 {
@@ -217,107 +247,142 @@
 void CLuaHandle::Shutdown()
 {
 	LUA_CALL_IN_CHECK(L);
-	lua_checkstack(L, 2);
+	lua_checkstack(L, 3);
+
+	int errfunc = SetupTraceback();
+
 	static const LuaHashString cmdStr(&quot;Shutdown&quot;);
 	if (!cmdStr.GetGlobalFunc(L)) {
+		// remove error handler
+		if (errfunc) lua_pop(L, 1);
 		return; // the call is not defined
 	}
 
 	// call the routine
-	RunCallIn(cmdStr, 0, 0);
+	RunCallInTraceback(cmdStr, 0, 0, errfunc);
 	return;
 }
 
 void CLuaHandle::GamePreload()
 {
-	LUA_CALL_IN_CHECK(L);	
-	lua_checkstack(L, 2);
+	LUA_CALL_IN_CHECK(L);
+	lua_checkstack(L, 3);
+
+	int errfunc = SetupTraceback();
+
 	static const LuaHashString cmdStr(&quot;GamePreload&quot;);
 	if (!cmdStr.GetGlobalFunc(L)) {
+		// remove error handler
+		if (errfunc) lua_pop(L, 1);
 		return; // the call is not defined
 	}
 
 	// call the routine
-	RunCallIn(cmdStr, 0, 0);
+	RunCallInTraceback(cmdStr, 0, 0, errfunc);
 	return;
 }
 
 void CLuaHandle::GameStart()
 {
-	LUA_CALL_IN_CHECK(L);	
-	lua_checkstack(L, 2);
+	LUA_CALL_IN_CHECK(L);
+	lua_checkstack(L, 3);
+
+	int errfunc = SetupTraceback();
+
 	static const LuaHashString cmdStr(&quot;GameStart&quot;);
 	if (!cmdStr.GetGlobalFunc(L)) {
+		// remove error handler
+		if (errfunc) lua_pop(L, 1);
 		return; // the call is not defined
 	}
 
 	// call the routine
-	RunCallIn(cmdStr, 0, 0);
+	RunCallInTraceback(cmdStr, 0, 0, errfunc);
 	return;
 }
 
 void CLuaHandle::GameOver()
 {
-	LUA_CALL_IN_CHECK(L);	
+	LUA_CALL_IN_CHECK(L);
 	lua_checkstack(L, 2);
+
+	int errfunc = SetupTraceback();
+
 	static const LuaHashString cmdStr(&quot;GameOver&quot;);
 	if (!cmdStr.GetGlobalFunc(L)) {
+		// remove error handler
+		if (errfunc) lua_pop(L, 1);
 		return; // the call is not defined
 	}
 
 	// call the routine
-	RunCallIn(cmdStr, 0, 0);
+	RunCallInTraceback(cmdStr, 0, 0, errfunc);
 	return;
 }
 
 
 void CLuaHandle::TeamDied(int teamID)
 {
-	LUA_CALL_IN_CHECK(L);	
-	lua_checkstack(L, 3);
+	LUA_CALL_IN_CHECK(L);
+	lua_checkstack(L, 4);
+
+	int errfunc = SetupTraceback();
+
 	static const LuaHashString cmdStr(&quot;TeamDied&quot;);
 	if (!cmdStr.GetGlobalFunc(L)) {
+		// remove error handler
+		if (errfunc) lua_pop(L, 1);
 		return; // the call is not defined
 	}
 
 	lua_pushnumber(L, teamID);
 
 	// call the routine
-	RunCallIn(cmdStr, 1, 0);
+	RunCallInTraceback(cmdStr, 1, 0, errfunc);
 	return;
 }
 
 
 void CLuaHandle::TeamChanged(int teamID)
 {
-	LUA_CALL_IN_CHECK(L);	
-	lua_checkstack(L, 3);
+	LUA_CALL_IN_CHECK(L);
+	lua_checkstack(L, 4);
+
+	int errfunc = SetupTraceback();
+
 	static const LuaHashString cmdStr(&quot;TeamChanged&quot;);
 	if (!cmdStr.GetGlobalFunc(L)) {
+		// remove error handler
+		if (errfunc) lua_pop(L, 1);
 		return; // the call is not defined
 	}
 
 	lua_pushnumber(L, teamID);
 
 	// call the routine
-	RunCallIn(cmdStr, 1, 0);
+	RunCallInTraceback(cmdStr, 1, 0, errfunc);
 	return;
 }
 
 
 void CLuaHandle::PlayerChanged(int playerID)
 {
-	LUA_CALL_IN_CHECK(L);	
-	lua_checkstack(L, 3);
+	LUA_CALL_IN_CHECK(L);
+	lua_checkstack(L, 4);
+
+	int errfunc = SetupTraceback();
+
 	static const LuaHashString cmdStr(&quot;PlayerChanged&quot;);
 	if (!cmdStr.GetGlobalFunc(L)) {
+		// remove error handler
+		if (errfunc) lua_pop(L, 1);
 		return; // the call is not defined
 	}
 
 	lua_pushnumber(L, playerID);
 
 	// call the routine
-	RunCallIn(cmdStr, 1, 0);
+	RunCallInTraceback(cmdStr, 1, 0, errfunc);
 	return;
 }
 
@@ -326,9 +391,13 @@
 
 inline void CLuaHandle::UnitCallIn(const LuaHashString&amp; hs, const CUnit* unit)
 {
-	LUA_CALL_IN_CHECK(L);	
-	lua_checkstack(L, 5);
+	LUA_CALL_IN_CHECK(L);
+	lua_checkstack(L, 6);
+	int errfunc = SetupTraceback();
+
 	if (!hs.GetGlobalFunc(L)) {
+		// remove error handler
+		if (errfunc) lua_pop(L, 1);
 		return; // the call is not defined
 	}
 
@@ -337,7 +406,7 @@
 	lua_pushnumber(L, unit-&gt;team);
 
 	// call the routine
-	RunCallIn(hs, 3, 0);
+	RunCallInTraceback(hs, 3, 0, errfunc);
 
 	return;
 }
@@ -345,10 +414,15 @@
 
 void CLuaHandle::UnitCreated(const CUnit* unit, const CUnit* builder)
 {
-	LUA_CALL_IN_CHECK(L);	
-	lua_checkstack(L, 6);
+	LUA_CALL_IN_CHECK(L);
+	lua_checkstack(L, 7);
+
+	int errfunc = SetupTraceback();
+
 	static const LuaHashString cmdStr(&quot;UnitCreated&quot;);
 	if (!cmdStr.GetGlobalFunc(L)) {
+		// remove error handler
+		if (errfunc) lua_pop(L, 1);
 		return; // the call is not defined
 	}
 
@@ -359,8 +433,9 @@
 		lua_pushnumber(L, builder-&gt;id);
 	}
 
+	int args = (builder != NULL) ? 4 : 3;
 	// call the routine
-	RunCallIn(cmdStr, (builder != NULL) ? 4 : 3, 0);
+	RunCallInTraceback(cmdStr, args, 0, errfunc);
 	return;
 }
 
@@ -376,10 +451,15 @@
 void CLuaHandle::UnitFromFactory(const CUnit* unit,
                                  const CUnit* factory, bool userOrders)
 {
-	LUA_CALL_IN_CHECK(L);	
-	lua_checkstack(L, 8);
+	LUA_CALL_IN_CHECK(L);
+	lua_checkstack(L, 9);
+
+	int errfunc = SetupTraceback();
+
 	static const LuaHashString cmdStr(&quot;UnitFromFactory&quot;);
 	if (!cmdStr.GetGlobalFunc(L)) {
+		// remove error handler
+		if (errfunc) lua_pop(L, 1);
 		return; // the call is not defined
 	}
 
@@ -391,17 +471,22 @@
 	lua_pushboolean(L, userOrders);
 
 	// call the routine
-	RunCallIn(cmdStr, 6, 0);
+	RunCallInTraceback(cmdStr, 6, 0, errfunc);
 	return;
 }
 
 
 void CLuaHandle::UnitDestroyed(const CUnit* unit, const CUnit* attacker)
 {
-	LUA_CALL_IN_CHECK(L);	
-	lua_checkstack(L, 8);
+	LUA_CALL_IN_CHECK(L);
+	lua_checkstack(L, 9);
+
+	int errfunc = SetupTraceback();
+
 	static const LuaHashString cmdStr(&quot;UnitDestroyed&quot;);
 	if (!cmdStr.GetGlobalFunc(L)) {
+		// remove error handler
+		if (errfunc) lua_pop(L, 1);
 		return; // the call is not defined
 	}
 
@@ -417,17 +502,21 @@
 	}
 
 	// call the routine
-	RunCallIn(cmdStr, argCount, 0);
+	RunCallInTraceback(cmdStr, argCount, 0, errfunc);
 	return;
 }
 
 
 void CLuaHandle::UnitTaken(const CUnit* unit, int newTeam)
 {
-	LUA_CALL_IN_CHECK(L);	
-	lua_checkstack(L, 6);
+	LUA_CALL_IN_CHECK(L);
+	lua_checkstack(L, 7);
+	int errfunc = SetupTraceback();
+
 	static const LuaHashString cmdStr(&quot;UnitTaken&quot;);
 	if (!cmdStr.GetGlobalFunc(L)) {
+		// remove error handler
+		if (errfunc) lua_pop(L, 1);
 		return; // the call is not defined
 	}
 
@@ -437,17 +526,21 @@
 	lua_pushnumber(L, newTeam);
 
 	// call the routine
-	RunCallIn(cmdStr, 4, 0);
+	RunCallInTraceback(cmdStr, 4, 0, errfunc);
 	return;
 }
 
 
 void CLuaHandle::UnitGiven(const CUnit* unit, int oldTeam)
 {
-	LUA_CALL_IN_CHECK(L);	
-	lua_checkstack(L, 6);
+	LUA_CALL_IN_CHECK(L);
+	lua_checkstack(L, 7);
+	int errfunc = SetupTraceback();
+
 	static const LuaHashString cmdStr(&quot;UnitGiven&quot;);
 	if (!cmdStr.GetGlobalFunc(L)) {
+		// remove error handler
+		if (errfunc) lua_pop(L, 1);
 		return; // the call is not defined
 	}
 
@@ -457,7 +550,7 @@
 	lua_pushnumber(L, oldTeam);
 
 	// call the routine
-	RunCallIn(cmdStr, 4, 0);
+	RunCallInTraceback(cmdStr, 4, 0, errfunc);
 	return;
 }
 
@@ -472,10 +565,15 @@
 
 void CLuaHandle::UnitCommand(const CUnit* unit, const Command&amp; command)
 {
-	LUA_CALL_IN_CHECK(L);	
-	lua_checkstack(L, 10);
+	LUA_CALL_IN_CHECK(L);
+	lua_checkstack(L, 11);
+
+	int errfunc = SetupTraceback();
+
 	static const LuaHashString cmdStr(&quot;UnitCommand&quot;);
 	if (!cmdStr.GetGlobalFunc(L)) {
+		// remove error handler
+		if (errfunc) lua_pop(L, 1);
 		return; // the call is not defined
 	}
 
@@ -495,17 +593,22 @@
 	}
 
 	// call the routine
-	RunCallIn(cmdStr, 6, 0);
+	RunCallInTraceback(cmdStr, 6, 0, errfunc);
 	return;
 }
 
 
 void CLuaHandle::UnitCmdDone(const CUnit* unit, int cmdID, int cmdTag)
 {
-	LUA_CALL_IN_CHECK(L);	
-	lua_checkstack(L, 7);
+	LUA_CALL_IN_CHECK(L);
+	lua_checkstack(L, 8);
+
+	int errfunc = SetupTraceback();
+
 	static const LuaHashString cmdStr(&quot;UnitCmdDone&quot;);
 	if (!cmdStr.GetGlobalFunc(L)) {
+		// remove error handler
+		if (errfunc) lua_pop(L, 1);
 		return; // the call is not defined
 	}
 
@@ -516,7 +619,7 @@
 	lua_pushnumber(L, cmdTag);
 
 	// call the routine
-	RunCallIn(cmdStr, 5, 0);
+	RunCallInTraceback(cmdStr, 5, 0, errfunc);
 	return;
 }
 
@@ -524,10 +627,15 @@
 void CLuaHandle::UnitDamaged(const CUnit* unit, const CUnit* attacker,
                              float damage, int weaponID, bool paralyzer)
 {
-	LUA_CALL_IN_CHECK(L);	
+	LUA_CALL_IN_CHECK(L);
 	lua_checkstack(L, 11);
+
+	int errfunc = SetupTraceback();
+
 	static const LuaHashString cmdStr(&quot;UnitDamaged&quot;);
 	if (!cmdStr.GetGlobalFunc(L)) {
+		// remove error handler
+		if (errfunc) lua_pop(L, 1);
 		return; // the call is not defined
 	}
 
@@ -549,17 +657,22 @@
 	}
 
 	// call the routine
-	RunCallIn(cmdStr, argCount, 0);
+	RunCallInTraceback(cmdStr, argCount, 0, errfunc);
 	return;
 }
 
 
 void CLuaHandle::UnitExperience(const CUnit* unit, float oldExperience)
 {
-	LUA_CALL_IN_CHECK(L);	
-	lua_checkstack(L, 7);
+	LUA_CALL_IN_CHECK(L);
+	lua_checkstack(L, 8);
+
+	int errfunc = SetupTraceback();
+
 	static const LuaHashString cmdStr(&quot;UnitExperience&quot;);
 	if (!cmdStr.GetGlobalFunc(L)) {
+		// remove error handler
+		if (errfunc) lua_pop(L, 1);
 		return; // the call is not defined
 	}
 
@@ -570,7 +683,7 @@
 	lua_pushnumber(L, oldExperience);
 
 	// call the routine
-	RunCallIn(cmdStr, 5, 0);
+	RunCallInTraceback(cmdStr, 5, 0, errfunc);
 	return;
 }
 
@@ -580,7 +693,7 @@
 void CLuaHandle::UnitSeismicPing(const CUnit* unit, int allyTeam,
                                  const float3&amp; pos, float strength)
 {
-	LUA_CALL_IN_CHECK(L);	
+	LUA_CALL_IN_CHECK(L);
 	lua_checkstack(L, 9);
 	if ((readAllyTeam &gt;= 0) &amp;&amp; (unit-&gt;losStatus[readAllyTeam] &amp; LOS_INLOS)) {
 		return; // don't need to see this ping
@@ -612,7 +725,7 @@
 void CLuaHandle::LosCallIn(const LuaHashString&amp; hs,
                            const CUnit* unit, int allyTeam)
 {
-	LUA_CALL_IN_CHECK(L);	
+	LUA_CALL_IN_CHECK(L);
 	lua_checkstack(L, 6);
 	if (!hs.GetGlobalFunc(L)) {
 		return; // the call is not defined
@@ -663,10 +776,15 @@
 
 void CLuaHandle::UnitLoaded(const CUnit* unit, const CUnit* transport)
 {
-	LUA_CALL_IN_CHECK(L);	
-	lua_checkstack(L, 7);
+	LUA_CALL_IN_CHECK(L);
+	lua_checkstack(L, 8);
+
+	int errfunc = SetupTraceback();
+
 	static const LuaHashString cmdStr(&quot;UnitLoaded&quot;);
 	if (!cmdStr.GetGlobalFunc(L)) {
+		// remove error handler
+		if (errfunc) lua_pop(L, 1);
 		return; // the call is not defined
 	}
 
@@ -677,17 +795,22 @@
 	lua_pushnumber(L, transport-&gt;team);
 
 	// call the routine
-	RunCallIn(cmdStr, 5, 0);
+	RunCallInTraceback(cmdStr, 5, 0, errfunc);
 	return;
 }
 
 
 void CLuaHandle::UnitUnloaded(const CUnit* unit, const CUnit* transport)
 {
-	LUA_CALL_IN_CHECK(L);	
-	lua_checkstack(L, 7);
+	LUA_CALL_IN_CHECK(L);
+	lua_checkstack(L, 8);
+
+	int errfunc = SetupTraceback();
+
 	static const LuaHashString cmdStr(&quot;UnitUnloaded&quot;);
 	if (!cmdStr.GetGlobalFunc(L)) {
+		// remove error handler
+		if (errfunc) lua_pop(L, 1);
 		return; // the call is not defined
 	}
 
@@ -698,7 +821,7 @@
 	lua_pushnumber(L, transport-&gt;team);
 
 	// call the routine
-	RunCallIn(cmdStr, 5, 0);
+	RunCallInTraceback(cmdStr, 5, 0, errfunc);
 	return;
 }
 
@@ -768,9 +891,14 @@
 void CLuaHandle::FeatureCreated(const CFeature* feature)
 {
 	LUA_CALL_IN_CHECK(L);
-	lua_checkstack(L, 4);
+	lua_checkstack(L, 5);
+
+	int errfunc = SetupTraceback();
+
 	static const LuaHashString cmdStr(&quot;FeatureCreated&quot;);
 	if (!cmdStr.GetGlobalFunc(L)) {
+		// remove error handler
+		if (errfunc) lua_pop(L, 1);
 		return; // the call is not defined
 	}
 
@@ -778,7 +906,7 @@
 	lua_pushnumber(L, feature-&gt;allyteam);
 
 	// call the routine
-	RunCallIn(cmdStr, 2, 0);
+	RunCallInTraceback(cmdStr, 2, 0, errfunc);
 	return;
 }
 
@@ -786,9 +914,14 @@
 void CLuaHandle::FeatureDestroyed(const CFeature* feature)
 {
 	LUA_CALL_IN_CHECK(L);
-	lua_checkstack(L, 4);
+	lua_checkstack(L, 5);
+
+	int errfunc = SetupTraceback();
+
 	static const LuaHashString cmdStr(&quot;FeatureDestroyed&quot;);
 	if (!cmdStr.GetGlobalFunc(L)) {
+		// remove error handler
+		if (errfunc) lua_pop(L, 1);
 		return; // the call is not defined
 	}
 
@@ -796,7 +929,7 @@
 	lua_pushnumber(L, feature-&gt;allyteam);
 
 	// call the routine
-	RunCallIn(cmdStr, 2, 0);
+	RunCallInTraceback(cmdStr, 2, 0, errfunc);
 	return;
 }
 
@@ -850,7 +983,7 @@
 		return false;
 	}
 
-	LUA_CALL_IN_CHECK(L);	
+	LUA_CALL_IN_CHECK(L);
 	lua_checkstack(L, 7);
 	static const LuaHashString cmdStr(&quot;Explosion&quot;);
 	if (!cmdStr.GetGlobalFunc(L)) {
@@ -884,7 +1017,7 @@
 void CLuaHandle::StockpileChanged(const CUnit* unit,
                                   const CWeapon* weapon, int oldCount)
 {
-	LUA_CALL_IN_CHECK(L);	
+	LUA_CALL_IN_CHECK(L);
 	lua_checkstack(L, 8);
 	static const LuaHashString cmdStr(&quot;StockpileChanged&quot;);
 	if (!cmdStr.GetGlobalFunc(L)) {
@@ -907,7 +1040,7 @@
 
 bool CLuaHandle::RecvLuaMsg(const string&amp; msg, int playerID)
 {
-	LUA_CALL_IN_CHECK(L);	
+	LUA_CALL_IN_CHECK(L);
 	//lua_checkstack(L, 8);
 	static const LuaHashString cmdStr(&quot;RecvLuaMsg&quot;);
 	if (!cmdStr.GetGlobalFunc(L)) {
@@ -994,7 +1127,7 @@
 
 void CLuaHandle::Update()
 {
-	LUA_CALL_IN_CHECK(L);	
+	LUA_CALL_IN_CHECK(L);
 	lua_checkstack(L, 2);
 	static const LuaHashString cmdStr(&quot;Update&quot;);
 	if (!PushUnsyncedCallIn(cmdStr)) {
@@ -1010,7 +1143,7 @@
 
 void CLuaHandle::ViewResize()
 {
-	LUA_CALL_IN_CHECK(L);	
+	LUA_CALL_IN_CHECK(L);
 	lua_checkstack(L, 5);
 	static const LuaHashString cmdStr(&quot;ViewResize&quot;);
 	if (!PushUnsyncedCallIn(cmdStr)) {
@@ -1041,7 +1174,7 @@
 bool CLuaHandle::DefaultCommand(const CUnit* unit,
                                 const CFeature* feature, int&amp; cmd)
 {
-	LUA_CALL_IN_CHECK(L);	
+	LUA_CALL_IN_CHECK(L);
 	lua_checkstack(L, 4);
 	static const LuaHashString cmdStr(&quot;DefaultCommand&quot;);
 	if (!PushUnsyncedCallIn(cmdStr)) {
@@ -1091,7 +1224,7 @@
 
 void CLuaHandle::DrawGenesis()
 {
-	LUA_CALL_IN_CHECK(L);	
+	LUA_CALL_IN_CHECK(L);
 	lua_checkstack(L, 2);
 	static const LuaHashString cmdStr(&quot;DrawGenesis&quot;);
 	if (!PushUnsyncedCallIn(cmdStr)) {
@@ -1107,7 +1240,7 @@
 
 void CLuaHandle::DrawWorld()
 {
-	LUA_CALL_IN_CHECK(L);	
+	LUA_CALL_IN_CHECK(L);
 	lua_checkstack(L, 2);
 	static const LuaHashString cmdStr(&quot;DrawWorld&quot;);
 	if (!PushUnsyncedCallIn(cmdStr)) {
@@ -1123,7 +1256,7 @@
 
 void CLuaHandle::DrawWorldPreUnit()
 {
-	LUA_CALL_IN_CHECK(L);	
+	LUA_CALL_IN_CHECK(L);
 	lua_checkstack(L, 2);
 	static const LuaHashString cmdStr(&quot;DrawWorldPreUnit&quot;);
 	if (!PushUnsyncedCallIn(cmdStr)) {
@@ -1139,7 +1272,7 @@
 
 void CLuaHandle::DrawWorldShadow()
 {
-	LUA_CALL_IN_CHECK(L);	
+	LUA_CALL_IN_CHECK(L);
 	lua_checkstack(L, 2);
 	static const LuaHashString cmdStr(&quot;DrawWorldShadow&quot;);
 	if (!PushUnsyncedCallIn(cmdStr)) {
@@ -1155,7 +1288,7 @@
 
 void CLuaHandle::DrawWorldReflection()
 {
-	LUA_CALL_IN_CHECK(L);	
+	LUA_CALL_IN_CHECK(L);
 	lua_checkstack(L, 2);
 	static const LuaHashString cmdStr(&quot;DrawWorldReflection&quot;);
 	if (!PushUnsyncedCallIn(cmdStr)) {
@@ -1171,7 +1304,7 @@
 
 void CLuaHandle::DrawWorldRefraction()
 {
-	LUA_CALL_IN_CHECK(L);	
+	LUA_CALL_IN_CHECK(L);
 	lua_checkstack(L, 2);
 	static const LuaHashString cmdStr(&quot;DrawWorldRefraction&quot;);
 	if (!PushUnsyncedCallIn(cmdStr)) {
@@ -1187,7 +1320,7 @@
 
 void CLuaHandle::DrawScreen()
 {
-	LUA_CALL_IN_CHECK(L);	
+	LUA_CALL_IN_CHECK(L);
 	lua_checkstack(L, 4);
 	static const LuaHashString cmdStr(&quot;DrawScreen&quot;);
 	if (!PushUnsyncedCallIn(cmdStr)) {
@@ -1206,7 +1339,7 @@
 
 void CLuaHandle::DrawScreenEffects()
 {
-	LUA_CALL_IN_CHECK(L);	
+	LUA_CALL_IN_CHECK(L);
 	lua_checkstack(L, 4);
 	static const LuaHashString cmdStr(&quot;DrawScreenEffects&quot;);
 	if (!PushUnsyncedCallIn(cmdStr)) {
@@ -1225,7 +1358,7 @@
 
 void CLuaHandle::DrawInMiniMap()
 {
-	LUA_CALL_IN_CHECK(L);	
+	LUA_CALL_IN_CHECK(L);
 	lua_checkstack(L, 4);
 	static const LuaHashString cmdStr(&quot;DrawInMiniMap&quot;);
 	if (!PushUnsyncedCallIn(cmdStr)) {
@@ -1254,7 +1387,7 @@
 
 static inline bool CheckModUICtrl()
 {
-	return CLuaHandle::GetModUICtrl() || 
+	return CLuaHandle::GetModUICtrl() ||
 	       CLuaHandle::GetActiveHandle()-&gt;GetUserMode();
 }
 

Modified: branches/caiinterface/rts/Lua/LuaHandle.h
===================================================================
--- branches/caiinterface/rts/Lua/LuaHandle.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Lua/LuaHandle.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -48,7 +48,7 @@
 		void CheckStack();
 		int GetCallInErrors() const { return callinErrors; }
 		void ResetCallinErrors() { callinErrors = 0; }
-		
+
 	public:
 		inline bool CanCtrlTeam(int team) {
 			if (ctrlTeam &lt; 0) {
@@ -223,8 +223,12 @@
 		bool AddEntriesToTable(lua_State* L, const char* name,
 		                       bool (*entriesFunc)(lua_State*));
 
+		/// returns stack index of traceback function
+		int SetupTraceback();
+		bool RunCallInTraceback(const LuaHashString&amp; hs, int inArgs, int outArgs, int errfuncIndex);
 		bool RunCallIn(const LuaHashString&amp; hs, int inArgs, int outArgs);
 		bool RunCallInUnsynced(const LuaHashString&amp; hs, int inArgs, int outArgs);
+
 		void LosCallIn(const LuaHashString&amp; hs, const CUnit* unit, int allyTeam);
 		void UnitCallIn(const LuaHashString&amp; hs, const CUnit* unit);
 		bool PushUnsyncedCallIn(const LuaHashString&amp; hs);
@@ -242,6 +246,8 @@
 
 		bool fullCtrl;
 		bool fullRead;
+		bool printTracebacks;
+
 		int  ctrlTeam;
 		int  readTeam;
 		int  readAllyTeam;

Modified: branches/caiinterface/rts/Lua/LuaHandleSynced.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaHandleSynced.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Lua/LuaHandleSynced.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -35,6 +35,7 @@
 #include &quot;Sim/Units/CommandAI/Command.h&quot;
 #include &quot;Game/Game.h&quot;
 #include &quot;Game/WordCompletion.h&quot;
+#include &quot;Game/GlobalSynced.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;Sim/Units/COB/CobInstance.h&quot;
@@ -53,7 +54,7 @@
 #else
 #  define LUA_OPEN_LIB(L, lib) \
      lua_pushcfunction((L), lib); \
-     lua_pcall((L), 0, 0, 0); 
+     lua_pcall((L), 0, 0, 0);
 #endif
 
 
@@ -69,6 +70,7 @@
   allowUnsafeChanges(false),
   teamsLocked(false)
 {
+	printTracebacks = true;
 }
 
 
@@ -93,14 +95,14 @@
 			watchWeapons.push_back(false);
 		}
 	}
-	
+
 	const string syncedCode   = LoadFile(syncedFile, modes);
 	const string unsyncedCode = LoadFile(unsyncedFile, modes);
 	if (syncedCode.empty() &amp;&amp; unsyncedCode.empty()) {
 		KillLua();
 		return;
 	}
-	
+
 	// load the standard libraries
 	LUA_OPEN_LIB(L, luaopen_base);
 	LUA_OPEN_LIB(L, luaopen_math);
@@ -125,7 +127,7 @@
 	lua_pushnil(L); lua_setglobal(L, &quot;newproxy&quot;);
 	lua_pushnil(L); lua_setglobal(L, &quot;gcinfo&quot;);
 	lua_pushnil(L); lua_setglobal(L, &quot;collectgarbage&quot;);
-	
+
 	// use gs-&gt;randFloat() for the synchronized code, and disable randomseed()
 	// (this first copies the original functions to the registry for unsynced)
 	if (!SyncifyRandomFuncs()) {
@@ -195,7 +197,7 @@
 	LuaPushNamedCFunc(L, &quot;AllowUnsafeChanges&quot;, AllowUnsafeChanges);
 
 	LuaPushNamedNumber(L, &quot;COBSCALE&quot;, COBSCALE);
-	
+
 	// load our libraries  (LuaSyncedCtrl overrides some LuaUnsyncedCtrl entries)
 	if (!AddEntriesToTable(L, &quot;VFS&quot;,         LuaVFS::PushSynced)           ||
 	    !AddEntriesToTable(L, &quot;UnitDefs&quot;,    LuaUnitDefs::PushEntries)     ||
@@ -296,7 +298,7 @@
 		KillLua();
 		return false;
 	}
-	
+
 	lua_settop(L, 0);
 
 	// note the absence of loadstring() -- global access
@@ -363,13 +365,13 @@
 	lua_pushstring(L, &quot;random&quot;);
 	lua_rawget(L, -3); // math table
 	lua_rawset(L, LUA_REGISTRYINDEX);
-	
+
 	// copy the original randomseed() into the registry
 	lua_pushstring(L, &quot;randomseed&quot;);
 	lua_pushstring(L, &quot;randomseed&quot;);
 	lua_rawget(L, -3); // math table
 	lua_rawset(L, LUA_REGISTRYINDEX);
-	
+
 	// install our custom random()
 	lua_pushstring(L, &quot;random&quot;);
 	lua_pushcfunction(L, SyncedRandom);
@@ -403,7 +405,7 @@
 
 	lua_pop(L, 1); // remove 'math'
 
-	return true;	
+	return true;
 }
 
 
@@ -449,11 +451,11 @@
 	lua_settop(L, 0);
 	unsyncedStr.GetRegistry(L);
 	const int unsynced = lua_gettop(L);
-	
+
 	lua_pushstring(L, name);
 	lua_getglobal(L, name);
 	lua_rawset(L, unsynced);
-	
+
 	lua_settop(L, 0);
 	return true;
 }
@@ -506,7 +508,7 @@
 		return false;
 	}
 	lua_setfenv(L, -2);
-	
+
 	CLuaHandle* orig = activeHandle;
 	SetActiveHandle();
 	error = lua_pcall(L, 0, 0, 0);
@@ -583,7 +585,7 @@
 		eventHandler.RemoveEvent(this, name);
 	}
 	return true;
-}	
+}
 
 
 bool CLuaHandleSynced::UnsyncedUpdateCallIn(const string&amp; name)
@@ -601,7 +603,7 @@
 	}
 	SetupUnsyncedFunction(name.c_str());
 	return true;
-}	
+}
 
 
 /******************************************************************************/
@@ -619,10 +621,13 @@
 		return true;
 	}
 
+	int errfunc = SetupTraceback() ? -2 : 0;
+	logOutput.Print(&quot;Initialize errfunc=%d\n&quot;, errfunc);
+
 	lua_pushlstring(L, syncData.c_str(), syncData.size());
-	
+
 	// call the routine
-	if (!RunCallIn(cmdStr, 1, 1)) {
+	if (!RunCallInTraceback(cmdStr, 1, 1, errfunc)) {
 		return false;
 	}
 
@@ -640,7 +645,7 @@
 string CLuaHandleSynced::GetSyncData()
 {
 	string syncData;
-	
+
 	LUA_CALL_IN_CHECK(L);
 	lua_checkstack(L, 2);
 	static const LuaHashString cmdStr(&quot;GetSyncData&quot;);
@@ -704,17 +709,21 @@
 	}
 
 	LUA_CALL_IN_CHECK(L);
-	lua_checkstack(L, 3);
+	lua_checkstack(L, 4);
+
+	int errfunc = SetupTraceback();
+
 	static const LuaHashString cmdStr(&quot;GameFrame&quot;);
 	if (!cmdStr.GetGlobalFunc(L)) {
+		if (errfunc) lua_pop(L, 1);
 		return;
 	}
 
 	lua_pushnumber(L, frameNumber); // 6 day roll-over
-	
+
 	// call the routine
 	allowChanges = true;
-	RunCallIn(cmdStr, 1, 0);
+	RunCallInTraceback(cmdStr, 1, 0, errfunc);
 	allowChanges = allowUnsafeChanges;
 
 	return;
@@ -1085,7 +1094,7 @@
 		luaL_error(L, &quot;Incorrect arguments to AllowUnsafeChanges()&quot;);
 	}
 	const string magic = lua_tostring(L, 1);
-	const bool value = (magic == &quot;USE AT YOUR OWN PERIL&quot;);	
+	const bool value = (magic == &quot;USE AT YOUR OWN PERIL&quot;);
 	CLuaHandleSynced* lhs = GetActiveHandle();
 	lhs-&gt;allowChanges = value;
 	lhs-&gt;allowUnsafeChanges = value;
@@ -1142,7 +1151,7 @@
 	}
 
 	CLuaHandleSynced* lhs = GetActiveHandle();
-	
+
 	map&lt;string, string&gt;::iterator it = lhs-&gt;textCommands.find(cmd);
 	if (it != lhs-&gt;textCommands.end()) {
 		lhs-&gt;textCommands.erase(it);

Modified: branches/caiinterface/rts/Lua/LuaPathFinder.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaPathFinder.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Lua/LuaPathFinder.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -18,7 +18,6 @@
 #include &quot;LuaUtils.h&quot;
 #include &quot;Sim/MoveTypes/MoveInfo.h&quot;
 #include &quot;Sim/Path/PathManager.h&quot;
-#include &quot;GlobalStuff.h&quot;
 
 
 static void CreatePathMetatable(lua_State* L);

Modified: branches/caiinterface/rts/Lua/LuaRules.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaRules.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Lua/LuaRules.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -25,6 +25,7 @@
 #include &quot;Sim/Units/CommandAI/Command.h&quot;
 #include &quot;Game/Game.h&quot;
 #include &quot;Game/Team.h&quot;
+#include &quot;Game/GlobalSynced.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Rendering/UnitModels/UnitDrawer.h&quot;
 #include &quot;Rendering/UnitModels/3DModelParser.h&quot;

Modified: branches/caiinterface/rts/Lua/LuaSyncedCtrl.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaSyncedCtrl.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Lua/LuaSyncedCtrl.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -61,7 +61,6 @@
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
 #include &quot;System/myMath.h&quot;
 #include &quot;System/LogOutput.h&quot;
-#include &quot;Sync/SyncDebugger.h&quot;
 
 using namespace std;
 

Modified: branches/caiinterface/rts/Lua/LuaSyncedRead.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaSyncedRead.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Lua/LuaSyncedRead.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -3874,7 +3874,7 @@
 	const int ix = (int)(max(0.0f, min(float3::maxxpos, x)) / 16.0f);
 	const int iz = (int)(max(0.0f, min(float3::maxzpos, z)) / 16.0f);
 
-	const float metal = readmap-&gt;metalMap-&gt;getMetalAmount(ix, iz);
+	const float metal = readmap-&gt;metalMap-&gt;GetMetalAmount(ix, iz);
 
 	const int maxIndex = (gs-&gt;hmapx * gs-&gt;hmapy) - 1;
 	const int index = min(maxIndex, (gs-&gt;hmapx * iz) + ix);

Modified: branches/caiinterface/rts/Lua/LuaUtils.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaUtils.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Lua/LuaUtils.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -219,7 +219,7 @@
 	for (lua_pushnil(L); lua_next(L, changed) != 0; lua_pop(L, 1)) {
 		lua_pushvalue(L, -2); // copy the key to the top
 		lua_pushvalue(L, -2); // copy the value to the top
-		lua_rawset(L, table);		
+		lua_rawset(L, table);
 	}
 
 	lua_pop(L, 1); // pop the changed table
@@ -597,3 +597,25 @@
 
 /******************************************************************************/
 /******************************************************************************/
+
+#define DEBUG_TABLE &quot;debug&quot;
+#define DEBUG_FUNC &quot;traceback&quot;
+
+int LuaUtils::PushDebugTraceback(lua_State *L)
+{
+	lua_getglobal(L, DEBUG_TABLE);
+	if (!lua_istable(L, -1)) {
+		return 0;
+	}
+	lua_getfield(L, -1, DEBUG_FUNC);
+	if (!lua_isfunction(L, -1)) {
+		return 0;
+	}
+	lua_remove(L, -2);
+
+	return lua_gettop(L);
+}
+
+
+/******************************************************************************/
+/******************************************************************************/

Modified: branches/caiinterface/rts/Lua/LuaUtils.h
===================================================================
--- branches/caiinterface/rts/Lua/LuaUtils.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Lua/LuaUtils.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -25,6 +25,8 @@
 
 		static void PushCurrentFuncEnv(lua_State* L, const char* caller);
 
+		static int PushDebugTraceback(lua_State *L);
+
 		// lower case all keys in the table, with recursion
 		static bool LowerKeys(lua_State* L, int tableIndex);
 
@@ -61,7 +63,7 @@
 		static int isfunction(lua_State* L);
 		static int isuserdata(lua_State* L);
 
-		// not implemented...		
+		// not implemented...
 		static int ParseIntArray(lua_State* L, int tableIndex,
 		                         int* array, int arraySize);
 		static int ParseFloatArray(lua_State* L, int tableIndex,

Modified: branches/caiinterface/rts/Lua/LuaWeaponDefs.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaWeaponDefs.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Lua/LuaWeaponDefs.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -27,7 +27,7 @@
 #include &quot;System/FileSystem/SimpleParser.h&quot;
 #include &quot;System/LogOutput.h&quot;
 #include &quot;System/Util.h&quot;
-#include &quot;System/GlobalStuff.h&quot;
+#include &quot;Game/GlobalSynced.h&quot;
 
 using namespace std;
 

Modified: branches/caiinterface/rts/Map/Ground.h
===================================================================
--- branches/caiinterface/rts/Map/Ground.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Map/Ground.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -4,7 +4,9 @@
 //
 //////////////////////////////////////////////////////////////////////
 
-#include &quot;GlobalStuff.h&quot;
+#include &quot;float3.h&quot;
+#include &quot;Game/GlobalConstants.h&quot;
+#include &quot;Game/GlobalSynced.h&quot;
 
 class CProjectileHandler;
 class CProjectile;

Modified: branches/caiinterface/rts/Map/MapInfo.cpp
===================================================================
--- branches/caiinterface/rts/Map/MapInfo.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Map/MapInfo.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -4,11 +4,11 @@
 
 #include &quot;MapInfo.h&quot;
 
+#include &quot;Game/GlobalConstants.h&quot;
 #include &quot;MapParser.h&quot;
 #include &quot;Lua/LuaParser.h&quot;
 #include &quot;System/LogOutput.h&quot;
 #include &quot;System/FileSystem/FileHandler.h&quot;
-#include &quot;System/GlobalStuff.h&quot;
 #include &quot;System/Exceptions.h&quot;
 
 
@@ -139,7 +139,7 @@
 	const LuaTable lightTable = mapRoot-&gt;SubTable(&quot;lighting&quot;);
 
 	light.sunDir = lightTable.GetFloat3(&quot;sunDir&quot;, float3(0.0f, 1.0f, 2.0f));
-	light.sunDir.Normalize();
+	light.sunDir.ANormalize();
 
 	light.groundAmbientColor  = lightTable.GetFloat3(&quot;groundAmbientColor&quot;,
 	                                                float3(0.5f, 0.5f, 0.5f));

Modified: branches/caiinterface/rts/Map/MetalMap.cpp
===================================================================
--- branches/caiinterface/rts/Map/MetalMap.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Map/MetalMap.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -2,7 +2,6 @@
 #include &quot;mmgr.h&quot;
 
 #include &quot;MetalMap.h&quot;
-#include &quot;GlobalStuff.h&quot;
 #include &quot;ReadMap.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
 
@@ -30,7 +29,7 @@
 //	for(i = 0; i &lt; (sizeX * sizeZ); i++) {
 //		extractionMap[i] = 0.0f;
 //	}
-	
+
 	int whichPalette = configHandler.GetInt(&quot;MetalMapPalette&quot;, 0);
 
 	if (whichPalette == 1){
@@ -50,12 +49,12 @@
 			metalPal[a * 3 + 2] = std::max(0, a * 2 - 255);
 		}
 	}
-	
+
 }
 
 
 /*
-Destrcutor
+Destructor
 Free the memory used by maps.
 */
 CMetalMap::~CMetalMap(void)
@@ -78,13 +77,13 @@
 /*
 Gives the amount of metal over an area.
 */
-float CMetalMap::getMetalAmount(int x1, int z1, int x2, int z2) 
+float CMetalMap::GetMetalAmount(int x1, int z1, int x2, int z2)
 {
 	ClampInt(x1, 0, sizeX);
 	ClampInt(x2, 0, sizeX);
 	ClampInt(z1, 0, sizeZ);
 	ClampInt(z2, 0, sizeZ);
-	
+
 	float metal = 0.0f;
 	int x, z;
 	for (x = x1; x &lt; x2; x++) {
@@ -99,7 +98,7 @@
 /*
 Gives the amount of metal on a single square.
 */
-float CMetalMap::getMetalAmount(int x, int z) 
+float CMetalMap::GetMetalAmount(int x, int z)
 {
 	ClampInt(x, 0, sizeX);
 	ClampInt(z, 0, sizeZ);
@@ -109,14 +108,14 @@
 
 
 /*
-Makes a reqest for extracting metal from a given square.
+Makes a request for extracting metal from a given square.
 If there is metal left to extract to the requested depth,
 the amount available will be returned and the requested
 depth will be sat as new extraction-depth on the extraction-map.
-If the requested depth is grounder than the current
+If the requested depth is greater than the current
 extraction-depth 0.0 will be returned and nothing changed.
 */
-float CMetalMap::requestExtraction(int x, int z, float toDepth) 
+float CMetalMap::RequestExtraction(int x, int z, float toDepth)
 {
 	ClampInt(x, 0, sizeX);
 	ClampInt(z, 0, sizeZ);
@@ -140,7 +139,7 @@
 back to the extraction-map. To be available for other
 extractors to use.
 */
-void CMetalMap::removeExtraction(int x, int z, float depth) 
+void CMetalMap::RemoveExtraction(int x, int z, float depth)
 {
 	ClampInt(x, 0, sizeX);
 	ClampInt(z, 0, sizeZ);

Modified: branches/caiinterface/rts/Map/MetalMap.h
===================================================================
--- branches/caiinterface/rts/Map/MetalMap.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Map/MetalMap.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -1,8 +1,10 @@
 #ifndef METALMAP_H
 #define METALMAP_H
 
-#include &quot;GlobalStuff.h&quot;
+#include &lt;vector&gt;
 
+#include &quot;creg/creg.h&quot;
+#include &quot;Game/GlobalConstants.h&quot;
 
 // Each square on metalmap is a 2x2 square on normal map.
 const float METAL_MAP_SQUARE_SIZE = SQUARE_SIZE * 2;
@@ -15,10 +17,10 @@
 	CMetalMap(unsigned char* map, int sizeX, int sizeZ, float metalScale);
 	virtual ~CMetalMap(void);
 
-	float getMetalAmount(int x1, int z1, int x2, int z2);
-	float getMetalAmount(int x, int z);
-	float requestExtraction(int x, int z, float toDepth);
-	void  removeExtraction(int x, int z, float depth);
+	float GetMetalAmount(int x1, int z1, int x2, int z2);
+	float GetMetalAmount(int x, int z);
+	float RequestExtraction(int x, int z, float toDepth);
+	void  RemoveExtraction(int x, int z, float depth);
 
 	unsigned char* metalMap;
 	unsigned char  metalPal[768];

Modified: branches/caiinterface/rts/Map/ReadMap.h
===================================================================
--- branches/caiinterface/rts/Map/ReadMap.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Map/ReadMap.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -7,7 +7,8 @@
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;creg/creg.h&quot;
 #include &quot;float3.h&quot;
-#include &quot;GlobalStuff.h&quot;
+#include &quot;Game/GlobalConstants.h&quot;
+#include &quot;Game/GlobalSynced.h&quot;
 
 class CMetalMap;
 class CCamera;

Modified: branches/caiinterface/rts/Map/SM3/Frustum.cpp
===================================================================
--- branches/caiinterface/rts/Map/SM3/Frustum.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Map/SM3/Frustum.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -55,9 +55,9 @@
 	planes[3].MakePlane (base, pos[0], pos[1]); // right
 	planes[4].MakePlane (base, pos[1], pos[2]);// down
 
-	right.Normalize();
-	up.Normalize();
-	front.Normalize();
+	right.ANormalize();
+	up.ANormalize();
+	front.ANormalize();
 }
 
 void Frustum::Draw ()

Modified: branches/caiinterface/rts/Map/SM3/Sm3GroundDrawer.cpp
===================================================================
--- branches/caiinterface/rts/Map/SM3/Sm3GroundDrawer.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Map/SM3/Sm3GroundDrawer.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -10,6 +10,7 @@
 #include &quot;Rendering/GroundDecalHandler.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Map/MapInfo.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
 
 #include &lt;SDL_keysym.h&gt;
@@ -53,10 +54,10 @@
 	tc.aspect = gu-&gt;viewSizeX / (float)gu-&gt;viewSizeY;
 
 	tc.right = tc.front.cross(tc.up);
-	tc.right.Normalize();
+	tc.right.ANormalize();
 
 	tc.up=tc.right.cross(tc.front);
-	tc.up.Normalize();
+	tc.up.ANormalize();
 }
 
 void CSm3GroundDrawer::Update()

Modified: branches/caiinterface/rts/Map/SM3/terrain/Lightcalc.cpp
===================================================================
--- branches/caiinterface/rts/Map/SM3/terrain/Lightcalc.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Map/SM3/terrain/Lightcalc.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -146,7 +146,7 @@
 				uchar* normal = hm-&gt;GetNormal (x,y);
 				Vector3 normv((2 * (int)normal[0] - 256)/255.0f, (2 * (int)normal[1] - 256)/255.0f, (2 * (int)normal[2] - 256)/255.0f);
 
-				wp.Normalize();
+				wp.ANormalize();
 				float dot = wp.dot(normv);
 				if(dot &lt; 0.0f) dot = 0.0f;
 				if(dot &gt; 1.0f) dot = 1.0f;

Modified: branches/caiinterface/rts/Map/SM3/terrain/QuadRenderData.cpp
===================================================================
--- branches/caiinterface/rts/Map/SM3/terrain/QuadRenderData.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Map/SM3/terrain/QuadRenderData.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -186,15 +186,15 @@
 				Vector3 tangent, binormal;
 				CalculateTangents (hm, x,y, tangent, binormal);
 				Vector3 normal = binormal.cross(tangent);
-				normal.Normalize ();
+				normal.ANormalize ();
 
 				if (vda &amp; VRT_Normal)
 					*(v++) = normal;
 
 				if (vda &amp; VRT_TangentSpaceMatrix)
 				{
-					tangent.Normalize ();
-					binormal.Normalize ();
+					tangent.ANormalize ();
+					binormal.ANormalize ();
 
 					// orthonormal matrix, so inverse=transpose
 					// Take the inverse of the tangent space -&gt; world space transformation

Modified: branches/caiinterface/rts/Map/SM3/terrain/Terrain.cpp
===================================================================
--- branches/caiinterface/rts/Map/SM3/terrain/Terrain.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Map/SM3/terrain/Terrain.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -571,9 +571,9 @@
 				CalculateTangents(hm, x,y, tangent, binormal);
 
 				Vector3 normal = binormal.cross(tangent);
-				normal.Normalize();
-				binormal.Normalize ();
-				tangent.Normalize ();
+				normal.ANormalize();
+				binormal.ANormalize ();
+				tangent.ANormalize ();
 
 				glColor3f (1,1,0);
 				glVertex3fv(&amp;origin[0]);

Modified: branches/caiinterface/rts/Map/SM3/terrain/TerrainTexture.cpp
===================================================================
--- branches/caiinterface/rts/Map/SM3/terrain/TerrainTexture.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Map/SM3/terrain/TerrainTexture.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -564,7 +564,7 @@
 	void TerrainTexture::SetShaderParams (const Vector3&amp; lightDir, const Vector3&amp; eyePos)
 	{
 		wsLightDir = lightDir;
-		wsLightDir.Normalize ();
+		wsLightDir.ANormalize ();
 		wsEyePos = eyePos;
 	}
 

Modified: branches/caiinterface/rts/Map/SM3/terrain/TerrainTextureGLSL.cpp
===================================================================
--- branches/caiinterface/rts/Map/SM3/terrain/TerrainTextureGLSL.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Map/SM3/terrain/TerrainTextureGLSL.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -38,7 +38,7 @@
 #include &quot;Platform/FileSystem.h&quot;
 #include &quot;bitops.h&quot;
 #include &quot;System/Util.h&quot;
-#include &quot;System/GlobalStuff.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;System/Exceptions.h&quot;
 
 #include &lt;fstream&gt;

Modified: branches/caiinterface/rts/Map/SM3/terrain/TerrainUtil.cpp
===================================================================
--- branches/caiinterface/rts/Map/SM3/terrain/TerrainUtil.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Map/SM3/terrain/TerrainUtil.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -121,7 +121,7 @@
 				CalculateTangents(this, x,y,tangent,binormal);
 
 				Vector3 normal = binormal.cross(tangent);
-				normal.Normalize ();
+				normal.ANormalize ();
 
 				*(cnorm++) = (uchar)((normal.x * 0.5f + 0.5f) * 255);
 				*(cnorm++) = (uchar)((normal.y * 0.5f + 0.5f) * 255);

Modified: branches/caiinterface/rts/Map/SM3/terrain/Textures.cpp
===================================================================
--- branches/caiinterface/rts/Map/SM3/terrain/Textures.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Map/SM3/terrain/Textures.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -267,7 +267,7 @@
 					Vector3 tangent, binormal;
 					CalculateTangents(heightmap, x,y,tangent,binormal);
 					Vector3 normal = tangent.cross(binormal);
-					normal.Normalize();
+					normal.ANormalize();
 					norm_y = normal.y;
 				}
 
@@ -333,7 +333,7 @@
 				if (sx*sx + sy*sy &lt; 32*32) {
 					int sz = (int)sqrt(static_cast&lt;float&gt;(32 * 32 - sx*sx - sy*sy));
 					n = Vector3(sx,sy,sz);
-					n.Normalize ();
+					n.ANormalize ();
 				}
 
 				// compress it into a color

Modified: branches/caiinterface/rts/Map/SMF/BFGroundDrawer.cpp
===================================================================
--- branches/caiinterface/rts/Map/SMF/BFGroundDrawer.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Map/SMF/BFGroundDrawer.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -13,6 +13,7 @@
 #include &quot;Rendering/GroundDecalHandler.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;System/FastMath.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;mmgr.h&quot;
 
 #ifdef USE_GML
@@ -1376,7 +1377,7 @@
 	float3 side = cam2-&gt;forward;
 	float3 camHorizontal = cam2-&gt;forward;
 	camHorizontal.y = 0;
-	camHorizontal.Normalize();
+	camHorizontal.ANormalize();
 	// get vector for collision between frustum and horizontal plane
 	float3 b = up.cross(camHorizontal);
 

Modified: branches/caiinterface/rts/Map/SMF/SmfReadMap.cpp
===================================================================
--- branches/caiinterface/rts/Map/SMF/SmfReadMap.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Map/SMF/SmfReadMap.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -213,7 +213,7 @@
 {
 	float3 n1 = facenormals[((y * gs-&gt;mapx) + x) * 2] +
 	            facenormals[((y * gs-&gt;mapx) + x) * 2 + 1];
-	n1.Normalize();
+	n1.ANormalize();
 
 	float3 light = mapInfo-&gt;light.groundSunColor*mapInfo-&gt;light.sunDir.dot(n1);
 	for (int a = 0; a &lt; 3; ++a) {

Modified: branches/caiinterface/rts/Rendering/Env/AdvSky.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/Env/AdvSky.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Rendering/Env/AdvSky.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -17,6 +17,7 @@
 #include &quot;TimeProfiler.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;Matrix44f.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 #define Y_PART 10.0
 #define X_PART 10.0
@@ -44,7 +45,7 @@
 	sundir2.y=0;
 	if(sundir2.Length()==0)
 		sundir2.x=1;
-	sundir2.Normalize();
+	sundir2.ANormalize();
 	sundir1=sundir2.cross(UpVector);
 
 	modSunDir.y=mapInfo-&gt;light.sunDir.y;
@@ -659,7 +660,7 @@
 	delete [] mem;
 
 	float3 ldir=modSunDir.cross(UpVector);
-	ldir.Normalize();
+	ldir.ANormalize();
 	float3 udir=modSunDir.cross(ldir);
 
 	sunFlareList=glGenLists(1);
@@ -812,7 +813,7 @@
 	float fy=asin(hdist/400);
 	dir.y=(cos(fy)-domeheight)*400;
 
-	dir.Normalize();
+	dir.ANormalize();
 
 	return dir;
 }

Modified: branches/caiinterface/rts/Rendering/Env/AdvTreeDrawer.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/Env/AdvTreeDrawer.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Rendering/Env/AdvTreeDrawer.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -434,7 +434,7 @@
 				float ang=fti-&gt;fallPos*PI;
 				float3 up(fti-&gt;dir.x*sin(ang),cos(ang),fti-&gt;dir.z*sin(ang));
 				float3 z(up.cross(float3(-1,0,0)));
-				z.Normalize();
+				z.ANormalize();
 				float3 x(up.cross(z));
 				CMatrix44f transMatrix(pos,x,up,z);
 
@@ -728,7 +728,7 @@
 				float ang=fti-&gt;fallPos*PI;
 				float3 up(fti-&gt;dir.x*sin(ang),cos(ang),fti-&gt;dir.z*sin(ang));
 				float3 z(up.cross(float3(1,0,0)));
-				z.Normalize();
+				z.ANormalize();
 				float3 x(z.cross(up));
 				CMatrix44f transMatrix(pos,x,up,z);
 

Modified: branches/caiinterface/rts/Rendering/Env/AdvTreeGenerator.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/Env/AdvTreeGenerator.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Rendering/Env/AdvTreeGenerator.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -14,6 +14,7 @@
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Rendering/Textures/Bitmap.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;System/LogOutput.h&quot;
 #include &quot;System/Exceptions.h&quot;
 
@@ -188,7 +189,7 @@
 		float angle=baseAngle+a*3.88f+fRand(0.5f);
 		float3 dir=orto1*sin(angle)+orto2*cos(angle);
 		dir.y=0.3f+fRand(0.4f);
-		dir.Normalize();
+		dir.ANormalize();
 		float3 start(0,(a+5)*height/(numBranch+5),0);
 		float length=(height*(0.4f+fRand(0.1f)))*sqrt(float(numBranch-a)/numBranch);
 		TrunkIterator(start,dir,length,length*0.05f,1);
@@ -197,7 +198,7 @@
 		float angle=a*3.88f+fRand(0.5f);
 		float3 dir=orto1*sin(angle)+orto2*cos(angle);
 		dir.y=0.8f;
-		dir.Normalize();
+		dir.ANormalize();
 		float3 start(0,height-0.3f,0);
 		float length=MAX_TREE_HEIGHT*0.1f;
 		TrunkIterator(start,dir,length,length*0.05f,0);
@@ -211,9 +212,9 @@
 		orto1=dir.cross(UpVector);
 	else
 		orto1=dir.cross(float3(1,0,0));
-	orto1.Normalize();
+	orto1.ANormalize();
 	float3 orto2=dir.cross(orto1);
-	orto2.Normalize();
+	orto2.ANormalize();
 
 	DrawTrunk(start,start+dir*length,orto1,orto2,size);
 
@@ -229,7 +230,7 @@
 		float angle=PI+float(a)*PI+fRand(0.3f);
 		float3 newbase=start+dir*length*(float(a+1)/(numTrunks+1));
 		float3 newDir=dir+orto1*cos(angle)*dirDif+orto2*sin(angle)*dirDif;
-		newDir.Normalize();
+		newDir.ANormalize();
 		float newLength=length*(float(numTrunks-a)/(numTrunks+1));
 		TrunkIterator(newbase,newDir,newLength,newLength*0.05f,depth-1);
 	}
@@ -255,7 +256,7 @@
 
 		float3 npos=pos;
 		npos.y=0;
-		npos.Normalize();
+		npos.ANormalize();
 		float col=0.5f+npos.dot(flatSun)*0.3f+fRand(0.1f);
 		va-&gt;AddVertexTN(pos,0.126f+tex+flipTex,0.98f,float3(0.09f*MAX_TREE_HEIGHT,-0.09f*MAX_TREE_HEIGHT,col));
 		va-&gt;AddVertexTN(pos,0.249f+tex-flipTex,0.98f,float3(-0.09f*MAX_TREE_HEIGHT,-0.09f*MAX_TREE_HEIGHT,col));
@@ -269,7 +270,7 @@
 
 	float3 npos=pos;
 	npos.y=0;
-	npos.Normalize();
+	npos.ANormalize();
 	float col=0.5f+npos.dot(flatSun)*0.3f+fRand(0.1f);
 	va-&gt;AddVertexTN(pos,0.126f+tex+flipTex,0.98f,float3(0.09f*MAX_TREE_HEIGHT,-0.09f*MAX_TREE_HEIGHT,col));
 	va-&gt;AddVertexTN(pos,0.249f+tex-flipTex,0.98f,float3(-0.09f*MAX_TREE_HEIGHT,-0.09f*MAX_TREE_HEIGHT,col));
@@ -621,7 +622,7 @@
 {
 	float3 dir=end-start;
 	float length=dir.Length();
-	dir.Normalize();
+	dir.ANormalize();
 	float3 orto=dir.cross(float3(0,0,1));
 
 	glBegin(GL_QUADS);
@@ -644,7 +645,7 @@
 	while(tipDist&lt;length*(0.83f+fRand(0.15f))){
 		float3 bstart=start+dir*(length-tipDist);
 		float3 bdir=dir+orto*side*(1.0f+fRand(0.7f));
-		bdir.Normalize();
+		bdir.ANormalize();
 		float3 bend=bstart+bdir*tipDist*((6-tipDist)*(0.10f+fRand(0.05f)));
 		CreateGranTexBranch(bstart,bend);
 		side*=-1;
@@ -665,7 +666,7 @@
 		float angle=baseAngle+(a*0.618f+fRand(0.1f))*2*PI;
 		float3 dir(orto1*sin(angle)+orto2*cos(angle));
 		dir.y=(a-numBranch)*0.01f-fRand(0.2f)-0.2f;
-		dir.Normalize();
+		dir.ANormalize();
 		float size=sqrt((float)numBranch-a+5)*0.08f*MAX_TREE_HEIGHT;
 		DrawPineBranch(float3(0,h,0),dir,size);
 	}
@@ -710,7 +711,7 @@
 	flatSun.y=0;
 
 	float3 orto1=dir.cross(UpVector);
-	orto1.Normalize();
+	orto1.ANormalize();
 	float3 orto2=dir.cross(orto1);
 
 	float tex=float(int(rand()*3.0f/(float)RAND_MAX))*0.125f;

Modified: branches/caiinterface/rts/Rendering/Env/AdvWater.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/Env/AdvWater.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Rendering/Env/AdvWater.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -17,6 +17,7 @@
 #include &quot;Rendering/UnitModels/UnitDrawer.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;Sim/Features/FeatureHandler.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;System/EventHandler.h&quot;
 #include &quot;Map/MapInfo.h&quot;
 
@@ -167,7 +168,7 @@
 
 	float3 forward=camera-&gt;forward;
 	forward.y=0;
-	forward.Normalize();
+	forward.ANormalize();
 
 	glProgramEnvParameter4fARB(GL_FRAGMENT_PROGRAM_ARB,0, forward.z,forward.x,0,0);
 	glProgramEnvParameter4fARB(GL_FRAGMENT_PROGRAM_ARB,1, -forward.x,forward.z,0,0);
@@ -179,7 +180,7 @@
 		bool maxReached=false;
 		for(int y=0;y&lt;numDivs;++y){
 			dir=base;
-			dir.Normalize();
+			dir.ANormalize();
 
 			if(dir.y&gt;=maxY){
 				maxReached=true;
@@ -189,14 +190,14 @@
 			xbase=base;
 			for(int x=0;x&lt;numDivs+1;++x){ //! CAUTION: loop count must match EnlargeArrays above
 				dir=xbase+dv;
-				dir.Normalize();
+				dir.ANormalize();
 				zpos=camera-&gt;pos+dir*(camera-&gt;pos.y/-dir.y);
 				zpos.y=sin(zpos.z*0.1f+gs-&gt;frameNum*0.06f)*0.06f+0.05f;
 				col[3]=(unsigned char)((0.8f+0.7f*(dir.y))*255);
 				va-&gt;AddVertexQTC(zpos,x*(1.0f/numDivs),screenY-yInc,col);
 
 				dir=xbase;
-				dir.Normalize();
+				dir.ANormalize();
 				zpos=camera-&gt;pos+dir*(camera-&gt;pos.y/-dir.y);
 				zpos.y=sin(zpos.z*0.1f+gs-&gt;frameNum*0.06f)*0.06f+0.05f;
 				col[3]=(unsigned char)((0.8f+0.7f*(dir.y))*255);

Modified: branches/caiinterface/rts/Rendering/Env/BaseTreeDrawer.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/Env/BaseTreeDrawer.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Rendering/Env/BaseTreeDrawer.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -7,7 +7,7 @@
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;Game/Camera.h&quot;
-#include &quot;System/GlobalStuff.h&quot;
+#include &quot;Game/GlobalConstants.h&quot;
 
 CBaseTreeDrawer* treeDrawer=0;
 

Modified: branches/caiinterface/rts/Rendering/Env/BasicSky.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/Env/BasicSky.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Rendering/Env/BasicSky.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -18,6 +18,7 @@
 #include &quot;Rendering/Textures/Bitmap.h&quot;
 #include &quot;TimeProfiler.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;Matrix44f.h&quot;
 #include &quot;LogOutput.h&quot;
 
@@ -47,7 +48,7 @@
 	sundir2.y=0;
 	if(sundir2.Length()==0)
 		sundir2.x=1;
-	sundir2.Normalize();
+	sundir2.ANormalize();
 	sundir1=sundir2.cross(UpVector);
 
 	modSunDir.y=mapInfo-&gt;light.sunDir.y;
@@ -139,7 +140,7 @@
 	glEnable(GL_TEXTURE_2D);
 	glBindTexture(GL_TEXTURE_2D,sunTex);
 	float3 sundir(0,0.5f,1);
-	sundir.Normalize();
+	sundir.ANormalize();
 
 	float3 ldir=sundir.cross(UpVector);
 	float3 udir=sundir.cross(ldir);
@@ -767,7 +768,7 @@
 	float fy=asin(hdist/400);
 	dir.y=(cos(fy)-domeheight)*400;
 
-	dir.Normalize();
+	dir.ANormalize();
 
 	return dir;
 }

Modified: branches/caiinterface/rts/Rendering/Env/BumpWater.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/Env/BumpWater.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Rendering/Env/BumpWater.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -32,6 +32,7 @@
 #include &quot;System/Platform/ConfigHandler.h&quot;
 #include &quot;TimeProfiler.h&quot;
 #include &quot;LogOutput.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;System/Exceptions.h&quot;
 
 using std::string;

Modified: branches/caiinterface/rts/Rendering/Env/DynWater.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/Env/DynWater.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Rendering/Env/DynWater.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -22,6 +22,7 @@
 #include &quot;Sim/Units/UnitHandler.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;System/EventHandler.h&quot;
 #include &quot;System/Exceptions.h&quot;
 
@@ -816,7 +817,7 @@
 	float3 side=cam2-&gt;forward;
 	float3 camHorizontal=cam2-&gt;forward;
 	camHorizontal.y=0;
-	camHorizontal.Normalize();
+	camHorizontal.ANormalize();
 	float3 b=up.cross(camHorizontal);			//get vector for collision between frustum and horizontal plane
 	if(fabs(b.z)&gt;0.0001f){
 		temp.dir=b.x/b.z;				//set direction to that

Modified: branches/caiinterface/rts/Rendering/Env/GrassDrawer.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/Env/GrassDrawer.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Rendering/Env/GrassDrawer.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -18,6 +18,7 @@
 #include &quot;Map/MapInfo.h&quot;
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;Rendering/ShadowHandler.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;System/Util.h&quot;
 #include &quot;System/Exceptions.h&quot;
 //#include &quot;TimeProfiler.h&quot;
@@ -476,9 +477,9 @@
 			glColor4f(0.62f,0.62f,0.62f,1-((*gi).dist+128-grassDistance)/128.0f);			
 
 		float3 v=grass[(*gi).num].pos-camera-&gt;pos;
-		v.Normalize();
+		v.ANormalize();
 		float3 side(v.cross(UpVector));
-		side.Normalize();
+		side.ANormalize();
 		glProgramEnvParameter4fARB(GL_VERTEX_PROGRAM_ARB,8,  side.x,side.y,side.z,0);
 		float3 up(side.cross(v));
 		glProgramEnvParameter4fARB(GL_VERTEX_PROGRAM_ARB,9,  up.x,up.y,up.z,0);
@@ -497,9 +498,9 @@
 			float3 squarePos((x+0.5f)*gSSsq, 0, (y+0.5f)*gSSsq);
 			squarePos.y=ground-&gt;GetHeight2(squarePos.x,squarePos.z);
 			float3 v=squarePos-camera-&gt;pos;
-			v.Normalize();
+			v.ANormalize();
 			float3 side(v.cross(UpVector));
-			side.Normalize();
+			side.ANormalize();
 			glProgramEnvParameter4fARB(GL_VERTEX_PROGRAM_ARB,8,  side.x,side.y,side.z,0);
 			float3 up(side.cross(v));
 			glProgramEnvParameter4fARB(GL_VERTEX_PROGRAM_ARB,9,  up.x,up.y,up.z,0);
@@ -617,7 +618,7 @@
 	for(int a=0;a&lt;strawPerTurf;++a){
 		float maxAng=fRand(PI/2);
 		float3 sideVect(fRand(1)-0.5f,0,fRand(1)-0.5f);
-		sideVect.Normalize();
+		sideVect.ANormalize();
 		float3 forwardVect=sideVect.cross(UpVector);
 		sideVect*=0.32f;
 

Modified: branches/caiinterface/rts/Rendering/Env/RefractWater.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/Env/RefractWater.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Rendering/Env/RefractWater.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -7,6 +7,7 @@
 #include &quot;LogOutput.h&quot;
 #include &quot;Map/MapInfo.h&quot;
 #include &quot;Map/ReadMap.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;bitops.h&quot;
 
 CRefractWater::CRefractWater() : CAdvWater(false)

Modified: branches/caiinterface/rts/Rendering/Env/SkyBox.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/Env/SkyBox.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Rendering/Env/SkyBox.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -6,7 +6,7 @@
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Rendering/Textures/Bitmap.h&quot;
 #include &quot;Game/Camera.h&quot;
-#include &quot;GlobalStuff.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;Map/MapInfo.h&quot;
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;Rendering/UnitModels/UnitDrawer.h&quot;

Modified: branches/caiinterface/rts/Rendering/FartextureHandler.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/FartextureHandler.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Rendering/FartextureHandler.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -5,7 +5,7 @@
 #include &quot;FartextureHandler.h&quot;
 #include &quot;UnitModels/3DOParser.h&quot;
 #include &quot;GL/myGL.h&quot;
-#include &quot;GlobalStuff.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 #include &quot;UnitModels/UnitDrawer.h&quot;
 #include &quot;Rendering/Textures/Bitmap.h&quot;
 #include &quot;Map/MapInfo.h&quot;

Modified: branches/caiinterface/rts/Rendering/GL/myGL.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/GL/myGL.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Rendering/GL/myGL.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -15,7 +15,7 @@
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;FPUCheck.h&quot;
-#include &quot;System/GlobalStuff.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;System/Util.h&quot;
 #include &quot;System/Exceptions.h&quot;
 

Modified: branches/caiinterface/rts/Rendering/GroundDecalHandler.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/GroundDecalHandler.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Rendering/GroundDecalHandler.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -18,6 +18,7 @@
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;Sim/Units/UnitTypes/Building.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;System/LogOutput.h&quot;
 #include &quot;System/Util.h&quot;
 #include &quot;System/Exceptions.h&quot;

Modified: branches/caiinterface/rts/Rendering/GroundFlash.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/GroundFlash.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Rendering/GroundFlash.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -8,6 +8,7 @@
 #include &quot;GL/VertexArray.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Rendering/Textures/ColorMap.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CGroundFlash, CExpGenSpawnable, );
 
@@ -98,14 +99,14 @@
 	p4.y=ground-&gt;GetApproximateHeight(p4.x,p4.z);
 	p4 += fw;
 	float3 n1((p3-p1).cross(p4-p1));
-	n1.Normalize();
+	n1.ANormalize();
 	float3 n2((p4-p2).cross(p3-p2));
-	n2.Normalize();
+	n2.ANormalize();
 
 	float3 normal=n1+n2;
-	normal.Normalize();
+	normal.ANormalize();
 	side1=normal.cross(float3(1,0,0));
-	side1.Normalize();
+	side1.ANormalize();
 	side2=side1.cross(normal);
 	ph-&gt;AddGroundFlash(this);
 }
@@ -205,14 +206,14 @@
 	p4.y=ground-&gt;GetApproximateHeight(p4.x,p4.z);
 	p4 += fw;
 	float3 n1((p3-p1).cross(p4-p1));
-	n1.Normalize();
+	n1.ANormalize();
 	float3 n2((p4-p2).cross(p3-p2));
-	n2.Normalize();
+	n2.ANormalize();
 
 	float3 normal=n1+n2;
-	normal.Normalize();
+	normal.ANormalize();
 	side1=normal.cross(float3(1,0,0));
-	side1.Normalize();
+	side1.ANormalize();
 	side2=side1.cross(normal);
 	ph-&gt;AddGroundFlash(this);
 }
@@ -271,16 +272,16 @@
 	p4.y=ground-&gt;GetApproximateHeight(p4.x,p4.z);
 	p4 += fw;
 	float3 n1((p3-p1).cross(p4-p1));
-	n1.Normalize();
+	n1.ANormalize();
 	float3 n2((p4-p2).cross(p3-p2));
-	n2.Normalize();
+	n2.ANormalize();
 
 	//pos += fw;
 
 	float3 normal=n1+n2;
-	normal.Normalize();
+	normal.ANormalize();
 	side1=normal.cross(float3(1,0,0));
-	side1.Normalize();
+	side1.ANormalize();
 	side2=side1.cross(normal);
 	ph-&gt;AddGroundFlash(this);
 

Modified: branches/caiinterface/rts/Rendering/IconHandler.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/IconHandler.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Rendering/IconHandler.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -9,7 +9,6 @@
 #include &lt;string&gt;
 #include &quot;mmgr.h&quot;
 
-#include &quot;GlobalStuff.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;IconHandler.h&quot;
 #include &quot;Lua/LuaParser.h&quot;

Modified: branches/caiinterface/rts/Rendering/InMapDraw.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/InMapDraw.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Rendering/InMapDraw.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -249,7 +249,7 @@
 			float camDist = dif.Length();
 			dif /= camDist;
 			float3 dir1(dif.cross(UpVector));
-			dir1.Normalize();
+			dir1.ANormalize();
 			float3 dir2(dif.cross(dir1));
 
 			unsigned char col[4];

Modified: branches/caiinterface/rts/Rendering/ShadowHandler.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/ShadowHandler.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Rendering/ShadowHandler.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -51,8 +51,8 @@
 	shadowMapSize=configHandler.GetInt(&quot;ShadowMapSize&quot;,DEFAULT_SHADOWMAPSIZE);
 
 	if (tmpFirstInstance) {
-		if(!(GLEW_ARB_fragment_program &amp;&amp; GLEW_ARB_fragment_program_shadow)){
-			logOutput.Print(&quot;You are missing an OpenGL extension needed to use shadowmaps (fragment_program_shadow)&quot;);
+		if(!(GLEW_ARB_fragment_program)){
+			logOutput.Print(&quot;You are missing an OpenGL extension needed to use shadowmaps (fragment_program)&quot;);
 			return;
 		}
 
@@ -62,7 +62,7 @@
 		}
 
 		if(!(GLEW_ARB_shadow &amp;&amp; GLEW_ARB_depth_texture &amp;&amp; GLEW_ARB_vertex_program &amp;&amp; GLEW_ARB_texture_env_combine &amp;&amp; GLEW_ARB_texture_env_crossbar)){
-			if(GLEW_ARB_shadow &amp;&amp; GLEW_ARB_depth_texture &amp;&amp; GLEW_ARB_vertex_program &amp;&amp; GLEW_ARB_texture_env_combine &amp;&amp; GLEW_ARB_fragment_program &amp;&amp; GLEW_ARB_fragment_program_shadow){
+			if(GLEW_ARB_shadow &amp;&amp; GLEW_ARB_depth_texture &amp;&amp; GLEW_ARB_vertex_program &amp;&amp; GLEW_ARB_texture_env_combine &amp;&amp; GLEW_ARB_fragment_program){
 				//logOutput.Print(&quot;Using ARB_fragment_program_shadow&quot;);
 				useFPShadows=true; // FIXME -- always true
 			} else {
@@ -72,7 +72,7 @@
 		}
 
 		if(!GLEW_ARB_shadow_ambient){
-			if(GLEW_ARB_fragment_program &amp;&amp; GLEW_ARB_fragment_program_shadow){
+			if(GLEW_ARB_fragment_program){
 				if(!useFPShadows){
 					//logOutput.Print(&quot;Using ARB_fragment_program_shadow&quot;);
 				}
@@ -203,7 +203,7 @@
 	glLoadIdentity();
 
 	float3 sundir=mapInfo-&gt;light.sunDir;
-	cross1=(sundir.cross(UpVector)).Normalize();
+	cross1=(sundir.cross(UpVector)).ANormalize();
 	cross2=cross1.cross(sundir);
 	centerPos=camera-&gt;pos;
 //	centerPos.x=((int)((centerPos.x+4)/8))*8;
@@ -380,7 +380,7 @@
 	if(fabs(b.z)&gt;0.0001f){
 		temp.dir=b.x/b.z;				//set direction to that
 		float3 c=b.cross(side);			//get vector from camera to collision line
-		c.Normalize();
+		c.ANormalize();
 		float3 colpoint;				//a point on the collision line
 
 		if(side.y&gt;0){

Modified: branches/caiinterface/rts/Rendering/Textures/NamedTextures.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/Textures/NamedTextures.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Rendering/Textures/NamedTextures.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -9,7 +9,7 @@
 #include &quot;NamedTextures.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Rendering/Textures/Bitmap.h&quot;
-#include &quot;System/GlobalStuff.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 
 map&lt;string, CNamedTextures::TexInfo&gt; CNamedTextures::texMap;

Modified: branches/caiinterface/rts/Rendering/Textures/TextureAtlas.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/Textures/TextureAtlas.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Rendering/Textures/TextureAtlas.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -9,7 +9,7 @@
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;System/Util.h&quot;
 #include &quot;System/Exceptions.h&quot;
-#include &quot;System/GlobalStuff.h&quot;
+#include &quot;System/Vec2.h&quot;
 
 CR_BIND(AtlasedTexture, );
 CR_BIND_DERIVED(GroundFXTexture, AtlasedTexture, );

Modified: branches/caiinterface/rts/Rendering/Textures/TextureHandler.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/Textures/TextureHandler.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Rendering/Textures/TextureHandler.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -13,6 +13,7 @@
 #include &quot;TextureHandler.h&quot;
 #include &quot;FileSystem/FileHandler.h&quot;
 #include &quot;FileSystem/SimpleParser.h&quot;
+#include &quot;Game/GlobalSynced.h&quot;
 #include &quot;Game/Team.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;

Modified: branches/caiinterface/rts/Rendering/UnitModels/3DModelParser.h
===================================================================
--- branches/caiinterface/rts/Rendering/UnitModels/3DModelParser.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Rendering/UnitModels/3DModelParser.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -4,8 +4,8 @@
 #include &lt;vector&gt;
 #include &lt;set&gt;
 #include &lt;string&gt;
+#include &lt;set&gt;
 #include &quot;Matrix44f.h&quot;
-#include &quot;System/GlobalStuff.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 
 struct S3DO;
@@ -80,7 +80,7 @@
 
 
 struct LocalS3DOModel
-{	
+{
 	int numpieces;
 	//LocalS3DO *rootobject;
 	LocalS3DO *pieces;

Modified: branches/caiinterface/rts/Rendering/UnitModels/3DOParser.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/UnitModels/3DOParser.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Rendering/UnitModels/3DOParser.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -13,7 +13,6 @@
 
 #include &quot;3DOParser.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
-#include &quot;GlobalStuff.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;FileSystem/VFSHandler.h&quot;

Modified: branches/caiinterface/rts/Rendering/UnitModels/UnitDrawer.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/UnitModels/UnitDrawer.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Rendering/UnitModels/UnitDrawer.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -42,6 +42,7 @@
 #include &quot;Sim/Units/UnitHandler.h&quot;
 #include &quot;Sim/Units/UnitTypes/TransportUnit.h&quot;
 #include &quot;Sim/Weapons/Weapon.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;mmgr.h&quot;
 
 #ifdef USE_GML
@@ -462,7 +463,7 @@
 	glBindTexture(GL_TEXTURE_2D, fartextureHandler-&gt;GetTextureID());
 	camNorm = camera-&gt;forward;
 	camNorm.y = -0.1f;
-	camNorm.Normalize();
+	camNorm.ANormalize();
 	glColor3f(1, 1, 1);
 	glEnable(GL_FOG);
 	glFogfv(GL_FOG_COLOR, mapInfo-&gt;atmosphere.fogColor);
@@ -1457,7 +1458,7 @@
 	for (int y = 0; y &lt; size; ++y) {
 		for (int x = 0; x &lt; size; ++x) {
 			float3 vec = baseDir + (xdif * (x + 0.5f)) / size + (ydif * (y + 0.5f)) / size;
-			vec.Normalize();
+			vec.ANormalize();
 			float dot = vec.dot(sundir);
 
 			if (dot &lt; 0)

Modified: branches/caiinterface/rts/Rendering/glFont.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/glFont.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Rendering/glFont.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -12,6 +12,7 @@
 #include &quot;Game/Camera.h&quot;
 #include &quot;myMath.h&quot;
 #include &quot;Platform/FileSystem.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;System/Util.h&quot;
 #include &quot;System/Exceptions.h&quot;
 
@@ -56,7 +57,7 @@
 	this-&gt;width = width;
 	this-&gt;height = height;
 	buffer = SAFE_NEW unsigned char[2*width*height];		// luminance and alpha per pixel
-	memset(buffer, 0, 2*width*height);
+	memset(buffer, 0xFF00, width*height);
 	cur = buffer;
 	curX = curY = 0;
 	curHeight = 0;
@@ -114,6 +115,7 @@
 	glBindTexture(GL_TEXTURE_2D, tex);
 	glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
 	glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR);
+
 	if (GLEW_EXT_texture_edge_clamp) {
 		glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE);
 		glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE);
@@ -121,12 +123,17 @@
 		glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_CLAMP);
 		glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_CLAMP);
 	}
+
 	glTexImage2D(GL_TEXTURE_2D, 0, GL_LUMINANCE_ALPHA,
 		width, height, 0, GL_LUMINANCE_ALPHA, GL_UNSIGNED_BYTE, buffer);
+
 	delete [] buffer;
 	buffer = 0;
-	if (glGetError() != GL_NO_ERROR)
+
+	int glError = glGetError();
+	if (glError != GL_NO_ERROR &amp;&amp; glError != GL_INVALID_ENUM) {
 		throw std::runtime_error(&quot;Could not allocate font texture.&quot;);
+	}
 	return tex;
 }
 
@@ -233,18 +240,25 @@
 
 	outline = false;
 	color = outlineColor = 0;
+
+	defaultColor[0] = 1.0f;
+	defaultColor[1] = 1.0f;
+	defaultColor[2] = 1.0f;
+	defaultColor[3] = 1.0f;
 }
 
 
-CglFont *CglFont::TryConstructFont(std::string fontFile, int start, int end, float size)
+CglFont* CglFont::TryConstructFont(std::string fontFile, int start, int end, float size)
 {
-	CglFont *newFont = 0;
+	CglFont* newFont = 0;
 	int texWidth = 128, texHeight = 128;
+
 	while (true) {
 		try {
+			// warning: this resets color* and outlineColor* to 0
 			newFont = SAFE_NEW CglFont(start, end, fontFile.c_str(), size, texWidth, texHeight);
 			return newFont;
-		} catch(texture_size_exception&amp;) {
+		} catch (texture_size_exception&amp;) {
 			// texture size too small; make higher or wider
 			if (texHeight &lt;= texWidth)
 				texHeight *= 2;
@@ -317,22 +331,23 @@
 }
 
 
-void CglFont::Outline(bool enable, const float *color, const float *outlineColor)
+void CglFont::Outline(bool enable, const float* col, const float* outlineCol)
 {
 	this-&gt;outline = enable;
 	if (enable) {
-		if (color) {		// if color is null, we keep the old settings (which should better not be null)
-			this-&gt;color = color;
-			this-&gt;outlineColor = outlineColor ? outlineColor : ChooseOutlineColor(color);
+		if (col) {
+			// if color is null, we keep the old settings (which should better not be null)
+			this-&gt;color = col;
+			this-&gt;outlineColor = outlineCol? outlineCol: ChooseOutlineColor(col);
 		}
 	}
 }
 
-void CglFont::OutlineS(bool enable, const float *outlineColor)
+void CglFont::OutlineS(bool enable, const float* outlineCol)
 {
 	this-&gt;outline = enable;
 	if (enable) {;
-		this-&gt;outlineColor = outlineColor ? outlineColor : ChooseOutlineColor(color);
+		this-&gt;outlineColor = outlineCol? outlineCol: ChooseOutlineColor(color);
 	}
 }
 
@@ -394,6 +409,9 @@
 	glEnable(GL_BLEND);
 	glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
 
+	if (       color == 0x0) {        color = &amp;defaultColor[0]; }
+	if (outlineColor == 0x0) { outlineColor = &amp;defaultColor[0]; }
+
 	glBegin(GL_QUADS);
 	for (int i = 0; i &lt; strlen((const char*)text); i++) {
 		const unsigned int ch = (unsigned char)text[i];
@@ -559,33 +577,39 @@
 
 void CglFont::glPrintColorAt(GLfloat x, GLfloat y, float s, const char *str)
 {
-	//TODO both glColor and float* color is set, make RenderString respect the float *color
-	const float *oldcolor = color;
-	float newcolor[4] = {1.0, 1.0, 1.0, 1.0};
-	color = const_cast&lt;const float*&gt;(newcolor);
+	// TODO both glColor and float* color set, make RenderString respect the float *color
+	const float* oldColor = color;
+	float newColor[4] = {1.0f, 1.0f, 1.0f, 1.0f};
+
+	color = const_cast&lt;const float*&gt;(newColor);
 	glColor4fv(color);
+
 	size_t lf;
-	string temp=str;
-	while((lf=temp.find(&quot;\xff&quot;))!=string::npos) {
-		if (outline)
-		{
-			x = RenderStringOutlined(x, y, s, (const unsigned char*)temp.substr(0, lf).c_str());
+	string temp = str;
+
+	while ((lf = temp.find(&quot;\xff&quot;)) != string::npos) {
+		if (outline) {
+			x = RenderStringOutlined(x, y, s, (const unsigned char*) temp.substr(0, lf).c_str());
 			outline = true; //HACK RenderStringOutlined resets outline
+		} else {
+			x = RenderString(x, y, s, (const unsigned char*) temp.substr(0, lf).c_str());
 		}
-		else
-			x = RenderString(x, y, s, (const unsigned char*)temp.substr(0, lf).c_str());
-		temp=temp.substr(lf, string::npos);
-		newcolor[0] = ((unsigned char)temp[1])/255.0f;
-		newcolor[1] = ((unsigned char)temp[2])/255.0f;
-		newcolor[2] = ((unsigned char)temp[3])/255.0f;
+
+		temp = temp.substr(lf, string::npos);
+		newColor[0] = ((unsigned char) temp[1]) / 255.0f;
+		newColor[1] = ((unsigned char) temp[2]) / 255.0f;
+		newColor[2] = ((unsigned char) temp[3]) / 255.0f;
 		glColor4fv(color);
-		temp=temp.substr(4, string::npos);
+		temp = temp.substr(4, string::npos);
 	}
-	if (outline)
-		RenderStringOutlined(x, y, s, (const unsigned char*)temp.c_str());
-	else
-		RenderString(x, y, s, (const unsigned char*)temp.c_str());
-	color = oldcolor;
+
+	if (outline) {
+		RenderStringOutlined(x, y, s, (const unsigned char*) temp.c_str());
+	} else {
+		RenderString(x, y, s, (const unsigned char*) temp.c_str());
+	}
+
+	color = oldColor;
 }
 
 void CglFont::glFormatAt(GLfloat x, GLfloat y, float s, const char *fmt, ...)

Modified: branches/caiinterface/rts/Rendering/glFont.h
===================================================================
--- branches/caiinterface/rts/Rendering/glFont.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Rendering/glFont.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -58,6 +58,7 @@
 	float fontHeight;
 	bool outline;
 	const float *color, *outlineColor;
+	float defaultColor[4];
 	GlyphInfo *glyphs;
 
 	static const float* ChooseOutlineColor(const float *textColor);

Modified: branches/caiinterface/rts/Sim/Features/Feature.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Features/Feature.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Features/Feature.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -24,6 +24,7 @@
 #include &quot;Sim/Projectiles/Unsynced/SmokeProjectile.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &lt;assert.h&gt;
 
 CR_BIND_DERIVED(CFeature, CSolidObject, )

Modified: branches/caiinterface/rts/Sim/Features/FeatureHandler.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Features/FeatureHandler.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Features/FeatureHandler.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -25,6 +25,7 @@
 #include &quot;Sim/Misc/CollisionVolume.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
 #include &quot;Sim/Units/CommandAI/BuilderCAI.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;System/EventHandler.h&quot;
 #include &quot;System/TimeProfiler.h&quot;
 #include &quot;System/Platform/ConfigHandler.h&quot;

Modified: branches/caiinterface/rts/Sim/Misc/AirBaseHandler.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Misc/AirBaseHandler.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Misc/AirBaseHandler.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -1,6 +1,8 @@
 #include &quot;StdAfx.h&quot;
 #include &quot;mmgr.h&quot;
 #include &quot;AirBaseHandler.h&quot;
+
+#include &quot;Game/GlobalSynced.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/COB/CobInstance.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;

Modified: branches/caiinterface/rts/Sim/Misc/AirBaseHandler.h
===================================================================
--- branches/caiinterface/rts/Sim/Misc/AirBaseHandler.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Misc/AirBaseHandler.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -1,12 +1,13 @@
 #ifndef AIRBASEHANDLER_H
 #define AIRBASEHANDLER_H
 
-#include &quot;Object.h&quot;
-#include &quot;System/float3.h&quot;
-#include &quot;System/GlobalStuff.h&quot;
 #include &lt;list&gt;
 #include &lt;boost/noncopyable.hpp&gt;
 
+#include &quot;Object.h&quot;
+#include &quot;System/float3.h&quot;
+#include &quot;Game/GlobalConstants.h&quot;
+
 class CUnit;
 
 class CAirBaseHandler : public boost::noncopyable

Modified: branches/caiinterface/rts/Sim/Misc/GeometricObjects.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Misc/GeometricObjects.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Misc/GeometricObjects.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -43,8 +43,8 @@
 	old2=CalcSpline( 0.05f,b1,b2,b3,b4);
 	for(int a=0;a&lt;20;++a){
 		float3 np=CalcSpline(a*0.05f+0.1f,b1,b2,b3,b4);
-		float3 dir1=(old2-old1).Normalize();
-		float3 dir2=(np-old2).Normalize();
+		float3 dir1=(old2-old1).ANormalize();
+		float3 dir2=(np-old2).ANormalize();
 
 		if(arrow==1 &amp;&amp; a==19){
 			CGeoSquareProjectile* gsp=SAFE_NEW CGeoSquareProjectile(old1,old2,dir1,dir2,width,0);
@@ -108,7 +108,7 @@
 	if(group==0)
 		group=firstFreeGroup++;
 
-	float3 dir=(end-start).Normalize();
+	float3 dir=(end-start).ANormalize();
 	if(arrow){
 		CGeoSquareProjectile* gsp=SAFE_NEW CGeoSquareProjectile(start,start*0.2f+end*0.8f,dir,dir,width*0.5f,width*0.5f);
 		geoGroups[group].squares.push_back(gsp);

Modified: branches/caiinterface/rts/Sim/Misc/GroundBlockingObjectMap.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Misc/GroundBlockingObjectMap.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Misc/GroundBlockingObjectMap.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -3,6 +3,8 @@
 #include &quot;mmgr.h&quot;
 
 #include &quot;GroundBlockingObjectMap.h&quot;
+
+#include &quot;Game/GlobalSynced.h&quot;
 #include &quot;Sim/Objects/SolidObject.h&quot;
 #include &quot;Sim/Path/PathManager.h&quot;
 #include &quot;creg/STL_Map.h&quot;

Modified: branches/caiinterface/rts/Sim/Misc/InterceptHandler.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Misc/InterceptHandler.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Misc/InterceptHandler.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -2,6 +2,8 @@
 #include &quot;mmgr.h&quot;
 
 #include &quot;InterceptHandler.h&quot;
+
+#include &quot;Game/GlobalSynced.h&quot;
 #include &quot;Sim/Weapons/Weapon.h&quot;
 #include &quot;Sim/Projectiles/WeaponProjectiles/WeaponProjectile.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;

Modified: branches/caiinterface/rts/Sim/Misc/QuadField.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Misc/QuadField.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Misc/QuadField.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -8,6 +8,7 @@
 
 #include &quot;QuadField.h&quot;
 
+#include &quot;Game/GlobalSynced.h&quot;
 #include &quot;Sim/Features/Feature.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;LogOutput.h&quot;

Modified: branches/caiinterface/rts/Sim/Misc/QuadField.h
===================================================================
--- branches/caiinterface/rts/Sim/Misc/QuadField.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Misc/QuadField.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -11,7 +11,7 @@
 
 #include &quot;creg/creg.h&quot;
 #include &quot;float3.h&quot;
-#include &quot;GlobalStuff.h&quot;
+#include &quot;Game/GlobalConstants.h&quot;
 
 class CUnit;
 class CWorldObject;

Modified: branches/caiinterface/rts/Sim/Misc/Wind.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Misc/Wind.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Misc/Wind.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -2,6 +2,7 @@
 #include &quot;mmgr.h&quot;
 
 #include &quot;Wind.h&quot;
+#include &quot;Game/GlobalSynced.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
 #include &quot;Map/MapInfo.h&quot;
 

Modified: branches/caiinterface/rts/Sim/ModInfo.cpp
===================================================================
--- branches/caiinterface/rts/Sim/ModInfo.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/ModInfo.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -2,7 +2,7 @@
 #include &quot;StdAfx.h&quot;
 #include &quot;mmgr.h&quot;
 
-#include &quot;GlobalStuff.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 #include &quot;ModInfo.h&quot;
 #include &quot;Game/GameSetup.h&quot;
 #include &quot;Lua/LuaParser.h&quot;

Modified: branches/caiinterface/rts/Sim/MoveTypes/GroundMoveType.cpp
===================================================================
--- branches/caiinterface/rts/Sim/MoveTypes/GroundMoveType.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/MoveTypes/GroundMoveType.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -30,6 +30,7 @@
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
 #include &quot;Sim/Weapons/Weapon.h&quot;
 #include &quot;Sync/SyncTracer.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;System/EventHandler.h&quot;
 #include &quot;System/LogOutput.h&quot;
 #include &quot;System/Sound.h&quot;

Modified: branches/caiinterface/rts/Sim/MoveTypes/ScriptMoveType.cpp
===================================================================
--- branches/caiinterface/rts/Sim/MoveTypes/ScriptMoveType.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/MoveTypes/ScriptMoveType.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -15,6 +15,7 @@
 #include &quot;Sim/Misc/RadarHandler.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;Sim/Units/UnitTypes/Building.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;System/Matrix44f.h&quot;
 #include &quot;System/myMath.h&quot;
 

Modified: branches/caiinterface/rts/Sim/MoveTypes/TAAirMoveType.cpp
===================================================================
--- branches/caiinterface/rts/Sim/MoveTypes/TAAirMoveType.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/MoveTypes/TAAirMoveType.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -25,6 +25,7 @@
 
 CR_REG_METADATA(CTAAirMoveType, (
 	CR_MEMBER(dontCheckCol),
+	CR_MEMBER(bankingAllowed),
 
 	CR_MEMBER(orgWantedHeight),
 

Modified: branches/caiinterface/rts/Sim/Objects/SolidObject.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Objects/SolidObject.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Objects/SolidObject.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -26,7 +26,9 @@
 	CR_MEMBER(isMoving),
 	CR_MEMBER(residualImpulse),
 	CR_MEMBER(mobility),
-	CR_MEMBER(mapPos),
+	// can't get creg work on templates
+	CR_MEMBER(mapPos.x),
+	CR_MEMBER(mapPos.y),
 	CR_MEMBER(buildFacing),
 	CR_MEMBER(isMarkedOnBlockingMap),
 	CR_MEMBER(speed),

Modified: branches/caiinterface/rts/Sim/Objects/SolidObject.h
===================================================================
--- branches/caiinterface/rts/Sim/Objects/SolidObject.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Objects/SolidObject.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -3,7 +3,7 @@
 
 #include &quot;WorldObject.h&quot;
 #include &quot;Sim/MoveTypes/MoveInfo.h&quot;
-#include &quot;GlobalStuff.h&quot;
+#include &quot;Vec2.h&quot;
 #include &quot;Sync/SyncedFloat3.h&quot;
 
 class CUnit;

Modified: branches/caiinterface/rts/Sim/Path/PathCache.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Path/PathCache.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Path/PathCache.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -3,6 +3,8 @@
 #include &quot;mmgr.h&quot;
 
 #include &quot;PathCache.h&quot;
+
+#include &quot;Game/GlobalSynced.h&quot;
 #include &quot;LogOutput.h&quot;
 
 using namespace std;

Modified: branches/caiinterface/rts/Sim/Path/PathCache.h
===================================================================
--- branches/caiinterface/rts/Sim/Path/PathCache.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Path/PathCache.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -5,7 +5,7 @@
 #include &lt;list&gt;
 
 #include &quot;IPath.h&quot;
-#include &quot;System/GlobalStuff.h&quot;
+#include &quot;System/Vec2.h&quot;
 
 class CPathCache
 {

Modified: branches/caiinterface/rts/Sim/Projectiles/ExplosionGenerator.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/ExplosionGenerator.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Projectiles/ExplosionGenerator.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -24,6 +24,7 @@
 #include &quot;Sim/Projectiles/Unsynced/WakeProjectile.h&quot;
 #include &quot;Sim/Projectiles/Unsynced/WreckProjectile.h&quot;
 #include &lt;assert.h&gt;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;System/Exceptions.h&quot;
 
 using std::min;

Modified: branches/caiinterface/rts/Sim/Projectiles/FireProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/FireProjectile.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Projectiles/FireProjectile.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -5,10 +5,12 @@
 #include &quot;Sim/Misc/Wind.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Game/Camera.h&quot;
+#include &quot;Game/GlobalSynced.h&quot;
 #include &quot;Sim/Misc/QuadField.h&quot;
 #include &quot;Sim/Features/Feature.h&quot;
 #include &quot;ProjectileHandler.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;creg/STL_List.h&quot;
 
 CR_BIND_DERIVED(CFireProjectile, CProjectile, (float3(0,0,0),float3(0,0,0),NULL,0,0,0,0));

Modified: branches/caiinterface/rts/Sim/Projectiles/FlareProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/FlareProjectile.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Projectiles/FlareProjectile.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -2,6 +2,7 @@
 #include &quot;mmgr.h&quot;
 
 #include &quot;FlareProjectile.h&quot;
+#include &quot;Game/GlobalSynced.h&quot;
 #include &quot;Game/Camera.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Map/MapInfo.h&quot;
@@ -11,6 +12,7 @@
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;WeaponProjectiles/MissileProjectile.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CFlareProjectile, CProjectile, (float3(0,0,0),float3(0,0,0),0,0));
 

Modified: branches/caiinterface/rts/Sim/Projectiles/PieceProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/PieceProjectile.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Projectiles/PieceProjectile.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -3,7 +3,8 @@
 
 #include &quot;Game/Camera.h&quot;
 #include &quot;Game/GameHelper.h&quot;
-#include &quot;GlobalStuff.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
+#include &quot;Game/GlobalSynced.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Map/MapInfo.h&quot;

Modified: branches/caiinterface/rts/Sim/Projectiles/Projectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Projectile.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Projectiles/Projectile.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -13,6 +13,7 @@
 #include &quot;LogOutput.h&quot;
 #include &quot;Rendering/UnitModels/3DModelParser.h&quot;
 #include &quot;Map/MapInfo.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CProjectile, CExpGenSpawnable, );
 

Modified: branches/caiinterface/rts/Sim/Projectiles/ProjectileHandler.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/ProjectileHandler.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Projectiles/ProjectileHandler.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -33,6 +33,7 @@
 #include &quot;Sim/Projectiles/Unsynced/ShieldPartProjectile.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;System/EventHandler.h&quot;
 #include &quot;System/LogOutput.h&quot;
 #include &quot;System/TimeProfiler.h&quot;
@@ -892,7 +893,7 @@
 	fp-&gt;verts=NULL;
 
 	fp-&gt;rotAxis=gu-&gt;usRandVector();
-	fp-&gt;rotAxis.Normalize();
+	fp-&gt;rotAxis.ANormalize();
 	fp-&gt;rotSpeed=gu-&gt;usRandFloat()*0.1f;
 	fp-&gt;rot=0;
 
@@ -928,7 +929,7 @@
 
 	/* Duplicated with AddFlyingPiece. */
 	fp-&gt;rotAxis=gu-&gt;usRandVector();
-	fp-&gt;rotAxis.Normalize();
+	fp-&gt;rotAxis.ANormalize();
 	fp-&gt;rotSpeed=gu-&gt;usRandFloat()*0.1f;
 	fp-&gt;rot=0;
 

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/BitmapMuzzleFlame.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/BitmapMuzzleFlame.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/BitmapMuzzleFlame.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -2,11 +2,12 @@
 #include &quot;mmgr.h&quot;
 
 #include &quot;BitmapMuzzleFlame.h&quot;
+#include &quot;Game/GlobalSynced.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Rendering/Textures/ColorMap.h&quot;
 #include &quot;Rendering/Textures/TextureAtlas.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
-#include &quot;System/GlobalStuff.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CBitmapMuzzleFlame, CProjectile, );
 
@@ -51,8 +52,8 @@
 	float isize = size + size * igrowth;
 	float ilength = length + length * igrowth;
 
-	float3 sidedir = dir.cross(float3(0, 1, 0)).Normalize();
-	float3 updir = dir.cross(sidedir).Normalize();
+	float3 sidedir = dir.cross(float3(0, 1, 0)).ANormalize();
+	float3 updir = dir.cross(sidedir).ANormalize();
 
 	va-&gt;AddVertexTC(pos + updir * isize,                 sideTexture-&gt;xstart, sideTexture-&gt;ystart, col);
 	va-&gt;AddVertexTC(pos + updir * isize + dir * ilength, sideTexture-&gt;xend,   sideTexture-&gt;ystart, col);

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/BubbleProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/BubbleProjectile.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/BubbleProjectile.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -5,7 +5,7 @@
 #include &quot;Game/Camera.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
-#include &quot;System/GlobalStuff.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CBubbleProjectile, CProjectile, (float3(0,0,0),float3(0,0,0),0,0,0,NULL,0));
 

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/DirtProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/DirtProjectile.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/DirtProjectile.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -10,6 +10,7 @@
 #include &quot;Map/MapInfo.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CDirtProjectile, CProjectile, );
 

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/ExploSpikeProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/ExploSpikeProjectile.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/ExploSpikeProjectile.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -5,7 +5,7 @@
 #include &quot;Game/Camera.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
-#include &quot;System/GlobalStuff.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CExploSpikeProjectile, CProjectile, );
 
@@ -66,9 +66,9 @@
 	inArray=true;
 
 	float3 dif(pos-camera-&gt;pos2);
-	dif.Normalize();
+	dif.ANormalize();
 	float3 dir2(dif.cross(dir));
-	dir2.Normalize();
+	dir2.ANormalize();
 
 	unsigned char col[4];
 	float a=std::max(0.f,alpha-alphaDecay*gu-&gt;timeOffset)*255;

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/GenericParticleProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/GenericParticleProjectile.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/GenericParticleProjectile.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -3,7 +3,7 @@
 
 #include &quot;Game/Camera.h&quot;
 #include &quot;GenericParticleProjectile.h&quot;
-#include &quot;GlobalStuff.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Rendering/Textures/ColorMap.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
@@ -60,7 +60,7 @@
 		float camDist=dif.Length();
 		dif/=camDist;
 		float3 dir1(dif.cross(speed));
-		dir1.Normalize();
+		dir1.ANormalize();
 		float3 dir2(dif.cross(dir1));
 
 		unsigned char color[4];

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/GeoSquareProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/GeoSquareProjectile.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/GeoSquareProjectile.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -5,7 +5,7 @@
 #include &quot;GeoSquareProjectile.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
-#include &quot;System/GlobalStuff.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CGeoSquareProjectile, CProjectile, (float3(0,0,0),float3(0,0,0),float3(0,0,0),float3(0,0,0),0,0));
 
@@ -55,13 +55,13 @@
 	col[3]=(unsigned char) (a*255);
 
 	float3 dif(p1-camera-&gt;pos);
-	dif.Normalize();
+	dif.ANormalize();
 	float3 dir1(dif.cross(v1));
-	dir1.Normalize();
+	dir1.ANormalize();
 	float3 dif2(p2-camera-&gt;pos);
-	dif2.Normalize();
+	dif2.ANormalize();
 	float3 dir2(dif2.cross(v2));
-	dir2.Normalize();
+	dir2.ANormalize();
 
 
 	float u = (ph-&gt;geosquaretex.xstart + ph-&gt;geosquaretex.xend) / 2;

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/GeoThermSmokeProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/GeoThermSmokeProjectile.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/GeoThermSmokeProjectile.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -34,7 +34,7 @@
 				float speedlen = speed.Length();
 				float3 right(d.z, 0.0f, -d.x);
 				speed = d.cross(right);
-				speed.Normalize();
+				speed.ANormalize();
 				speed *= speedlen;
 			}
 		}

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/GfxProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/GfxProjectile.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/GfxProjectile.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -4,11 +4,12 @@
 //////////////////////////////////////////////////////////////////////
 #include &quot;mmgr.h&quot;
 
+#include &quot;Game/GlobalSynced.h&quot;
 #include &quot;Game/Camera.h&quot;
 #include &quot;GfxProjectile.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
-#include &quot;System/GlobalStuff.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CGfxProjectile, CProjectile, );
 

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/HeatCloudProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/HeatCloudProjectile.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/HeatCloudProjectile.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -8,7 +8,7 @@
 #include &quot;HeatCloudProjectile.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
-#include &quot;System/GlobalStuff.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CHeatCloudProjectile, CProjectile, );
 

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/MuzzleFlame.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/MuzzleFlame.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/MuzzleFlame.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -5,7 +5,7 @@
 #include &quot;MuzzleFlame.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
-#include &quot;System/GlobalStuff.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 
 CR_BIND_DERIVED(CMuzzleFlame, CProjectile, (float3(0,0,0),float3(0,0,0),float3(0,0,0),0));

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/RepulseGfx.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/RepulseGfx.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/RepulseGfx.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -6,6 +6,7 @@
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CRepulseGfx, CProjectile, (NULL,NULL,0,float3(0,0,0)));
 
@@ -67,12 +68,12 @@
 		return;
 
 	float3 dir=repulsed-&gt;pos-owner-&gt;pos;
-	dir.Normalize();
+	dir.ANormalize();
 
 	pos=repulsed-&gt;pos-dir*10+repulsed-&gt;speed*gu-&gt;timeOffset;
 
 	float3 dir1=dir.cross(UpVector);
-	dir1.Normalize();
+	dir1.ANormalize();
 	float3 dir2=dir1.cross(dir);
 
 	inArray=true;

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/ShieldPartProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/ShieldPartProjectile.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/ShieldPartProjectile.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -6,7 +6,7 @@
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;Rendering/Textures/TextureAtlas.h&quot;
-#include &quot;System/GlobalStuff.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CShieldPartProjectile, CProjectile, (float3(0,0,0),0,0,0,float3(0,0,0),0,NULL,NULL));
 

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/SimpleParticleSystem.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/SimpleParticleSystem.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/SimpleParticleSystem.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -2,8 +2,9 @@
 #include &quot;mmgr.h&quot;
 
 #include &quot;Game/Camera.h&quot;
+#include &quot;Game/GlobalConstants.h&quot;
 #include &quot;GenericParticleProjectile.h&quot;
-#include &quot;GlobalStuff.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Rendering/Textures/ColorMap.h&quot;
 #include &quot;SimpleParticleSystem.h&quot;
@@ -82,7 +83,7 @@
 				float camDist=dif.Length();
 				dif/=camDist;
 				float3 dir1(dif.cross(particles[i].speed));
-				dir1.Normalize();
+				dir1.ANormalize();
 				float3 dir2(dif.cross(dir1));
 
 				unsigned char color[4];

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/SmokeProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/SmokeProjectile.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/SmokeProjectile.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -5,12 +5,14 @@
 #include &quot;StdAfx.h&quot;
 #include &quot;mmgr.h&quot;
 
+#include &quot;SmokeProjectile.h&quot;
+
 #include &quot;Game/Camera.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Sim/Misc/Wind.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
-#include &quot;SmokeProjectile.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CSmokeProjectile, CProjectile, );
 

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/SmokeProjectile2.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/SmokeProjectile2.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/SmokeProjectile2.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -5,12 +5,14 @@
 #include &quot;StdAfx.h&quot;
 #include &quot;mmgr.h&quot;
 
+#include &quot;SmokeProjectile2.h&quot;
+
 #include &quot;Game/Camera.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Sim/Misc/Wind.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
-#include &quot;SmokeProjectile2.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CSmokeProjectile2, CProjectile, );
 

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/SmokeTrailProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/SmokeTrailProjectile.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/SmokeTrailProjectile.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -5,6 +5,9 @@
 #include &quot;StdAfx.h&quot;
 #include &quot;mmgr.h&quot;
 
+#include &quot;SmokeTrailProjectile.h&quot;
+
+#include &quot;Rendering/Textures/TextureAtlas.h&quot;
 #include &quot;Game/Camera.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;myMath.h&quot;
@@ -12,7 +15,7 @@
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Sim/Misc/Wind.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
-#include &quot;SmokeTrailProjectile.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CSmokeTrailProjectile, CProjectile, (float3(0,0,0),float3(0,0,0),float3(0,0,0),float3(0,0,0),NULL,0,0,0,0,0,0,NULL,NULL));
 
@@ -78,7 +81,7 @@
 		dirpos2=pos2+dir2*dist*0.33f;
 		float3 mp=(pos1+pos2)/2;
 		midpos=CalcBeizer(0.5f,pos1,dirpos1,dirpos2,pos2);
-		middir=(dir1+dir2).Normalize();
+		middir=(dir1+dir2).ANormalize();
 		drawSegmented=true;
 	}
 	SetRadius(pos1.distance(pos2));
@@ -100,13 +103,13 @@
 
 	if(drawTrail){
 		float3 dif(pos1-camera-&gt;pos2);
-		dif.Normalize();
+		dif.ANormalize();
 		float3 odir1(dif.cross(dir1));
-		odir1.Normalize();
+		odir1.ANormalize();
 		float3 dif2(pos2-camera-&gt;pos2);
-		dif2.Normalize();
+		dif2.ANormalize();
 		float3 odir2(dif2.cross(dir2));
-		odir2.Normalize();
+		odir2.ANormalize();
 
 		unsigned char col[4];
 		float a1=(1-float(age)/(lifeTime))*255;
@@ -135,9 +138,9 @@
 
 		if(drawSegmented){
 			float3 dif3(midpos-camera-&gt;pos2);
-			dif3.Normalize();
+			dif3.ANormalize();
 			float3 odir3(dif3.cross(middir));
-			odir3.Normalize();
+			odir3.ANormalize();
 			float size3=0.2f+((age+4)*(1.0f/lifeTime))*orgSize;
 
 			unsigned char col3[4];

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/SmokeTrailProjectile.h
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/SmokeTrailProjectile.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/SmokeTrailProjectile.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -6,6 +6,8 @@
 
 #include &quot;Sim/Projectiles/Projectile.h&quot;
 
+class AtlasedTexture;
+
 class CSmokeTrailProjectile : public CProjectile
 {
 	CR_DECLARE(CSmokeTrailProjectile);

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/SpherePartProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/SpherePartProjectile.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/SpherePartProjectile.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -2,11 +2,12 @@
 #include &lt;algorithm&gt;
 #include &quot;mmgr.h&quot;
 
+#include &quot;Game/GlobalConstants.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;SpherePartProjectile.h&quot;
-#include &quot;System/GlobalStuff.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 using std::min;
 

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/TracerProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/TracerProjectile.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/TracerProjectile.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -7,7 +7,7 @@
 
 #include &quot;TracerProjectile.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;			// Header File For The OpenGL32 Library
-#include &quot;System/GlobalStuff.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CTracerProjectile, CProjectile, )
 

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/WakeProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/WakeProjectile.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/WakeProjectile.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -2,12 +2,13 @@
 #include &quot;mmgr.h&quot;
 
 #include &quot;Game/Camera.h&quot;
+#include &quot;Game/GlobalConstants.h&quot;
 #include &quot;Rendering/Env/BaseWater.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Sim/Misc/Wind.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;WakeProjectile.h&quot;
-#include &quot;System/GlobalStuff.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CWakeProjectile, CProjectile, (float3(0,0,0),float3(0,0,0),0,0,NULL,0,0,0));
 

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/WreckProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/WreckProjectile.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/WreckProjectile.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -13,6 +13,7 @@
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;SmokeProjectile.h&quot;
 #include &quot;WreckProjectile.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CWreckProjectile, CProjectile, (float3(0,0,0),float3(0,0,0),0,0));
 

Modified: branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/EmgProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/EmgProjectile.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/EmgProjectile.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -8,6 +8,7 @@
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
 #include &quot;Sync/SyncTracer.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CEmgProjectile, CWeaponProjectile, (float3(0,0,0),float3(0,0,0),NULL,float3(0,0,0),0,0,NULL));
 

Modified: branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/ExplosiveProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/ExplosiveProjectile.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/ExplosiveProjectile.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -14,6 +14,7 @@
 #include &quot;Sim/Misc/InterceptHandler.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 #ifdef TRACE_SYNC
 	#include &quot;Sync/SyncTracer.h&quot;

Modified: branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/FireBallProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/FireBallProjectile.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/FireBallProjectile.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -9,6 +9,7 @@
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CFireBallProjectile, CWeaponProjectile, (float3(0,0,0),float3(0,0,0),NULL,NULL,float3(0,0,0),NULL));
 CR_BIND(CFireBallProjectile::Spark, );

Modified: branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/FlameProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/FlameProjectile.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/FlameProjectile.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -8,6 +8,7 @@
 #include &quot;Rendering/Textures/ColorMap.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CFlameProjectile, CWeaponProjectile, (float3(0,0,0),float3(0,0,0),float3(0,0,0),NULL,NULL,0));
 

Modified: branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/LargeBeamLaserProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/LargeBeamLaserProjectile.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/LargeBeamLaserProjectile.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -8,6 +8,7 @@
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CLargeBeamLaserProjectile, CWeaponProjectile, (float3(0,0,0),float3(0,0,0),float3(0,0,0),float3(0,0,0),NULL,NULL));
 

Modified: branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/LaserProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/LaserProjectile.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/LaserProjectile.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -9,6 +9,7 @@
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;Sim/Projectiles/Unsynced/SimpleParticleSystem.h&quot;
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 #ifdef TRACE_SYNC
 	#include &quot;Sync/SyncTracer.h&quot;

Modified: branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/LightingProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/LightingProjectile.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/LightingProjectile.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -7,7 +7,7 @@
 #include &quot;Sim/Weapons/Weapon.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
-#include &quot;System/GlobalStuff.h&quot;
+#include &quot;Game/GlobalSynced.h&quot;
 
 #ifdef TRACE_SYNC
 	#include &quot;Sync/SyncTracer.h&quot;

Modified: branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/MissileProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/MissileProjectile.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/MissileProjectile.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -21,6 +21,7 @@
 #include &quot;Sync/SyncTracer.h&quot;
 #include &quot;Rendering/UnitModels/s3oParser.h&quot;
 #include &quot;Rendering/UnitModels/3DOParser.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 static const float Smoke_Time=60;
 

Modified: branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/StarburstProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/StarburstProjectile.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/StarburstProjectile.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -18,6 +18,7 @@
 #include &quot;StarburstProjectile.h&quot;
 #include &quot;Sync/SyncTracer.h&quot;
 #include &quot;Rendering/UnitModels/s3oParser.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 static const float Smoke_Time=70;
 

Modified: branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/TorpedoProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/TorpedoProjectile.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/TorpedoProjectile.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -13,6 +13,7 @@
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
 #include &quot;TorpedoProjectile.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 #ifdef TRACE_SYNC
 	#include &quot;Sync/SyncTracer.h&quot;

Modified: branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/WeaponProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/WeaponProjectile.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/WeaponProjectile.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -18,6 +18,7 @@
 #include &quot;Sim/Features/Feature.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Misc/InterceptHandler.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;System/LogOutput.h&quot;
 #ifdef TRACE_SYNC
 	#include &quot;Sync/SyncTracer.h&quot;

Modified: branches/caiinterface/rts/Sim/Units/COB/CobInstance.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/COB/CobInstance.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Units/COB/CobInstance.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -38,6 +38,7 @@
 #include &quot;Sim/Weapons/PlasmaRepulser.h&quot;
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
 #include &quot;Sim/Weapons/Weapon.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;Sound.h&quot;
 #include &quot;Sync/SyncTracer.h&quot;
 

Modified: branches/caiinterface/rts/Sim/Units/COB/CobInstance.h
===================================================================
--- branches/caiinterface/rts/Sim/Units/COB/CobInstance.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Units/COB/CobInstance.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -10,7 +10,7 @@
 const float  RAD2TAANG = 9.587526207370107576104371709781e-5f;
 
 #include &quot;Object.h&quot;
-#include &quot;GlobalStuff.h&quot;
+#include &quot;Game/GlobalConstants.h&quot;
 
 
 #define PACKXZ(x,z) (((int)(x) &lt;&lt; 16)+((int)(z) &amp; 0xffff))

Modified: branches/caiinterface/rts/Sim/Units/COB/CobThread.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/COB/CobThread.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Units/COB/CobThread.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -10,11 +10,7 @@
 
 #include &quot;LogOutput.h&quot;
 
-#ifdef _CONSOLE
-#include &quot;GlobalStuff.h&quot;
-#else
-#include &quot;GlobalStuff.h&quot;
-#endif
+#include &quot;Game/GlobalSynced.h&quot;
 
 CCobThread::CCobThread(CCobFile &amp;script, CCobInstance *owner)
 : owner(owner), script(script)

Modified: branches/caiinterface/rts/Sim/Units/CommandAI/AirCAI.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/CommandAI/AirCAI.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Units/CommandAI/AirCAI.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -18,6 +18,7 @@
 #include &quot;System/myMath.h&quot;
 #include &quot;System/LogOutput.h&quot;
 #include &lt;assert.h&gt;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;System/Util.h&quot;
 
 
@@ -549,7 +550,8 @@
 				attackPos.y = ground-&gt;GetHeight(attackPos.x, attackPos.z);
 				owner-&gt;AttackGround(attackPos, false);
 			} else {
-				int num = (int) (gs-&gt;randFloat() * eu.size());
+				// the range of randFloat() is inclusive of 1.0f
+				int num = (int) (gs-&gt;randFloat() * (eu.size() - 1));
 				orderTarget = uh-&gt;units[eu[num]];
 				owner-&gt;AttackUnit(orderTarget, false);
 				AddDeathDependence(orderTarget);

Modified: branches/caiinterface/rts/Sim/Units/CommandAI/BuilderCAI.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/CommandAI/BuilderCAI.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Units/CommandAI/BuilderCAI.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -36,6 +36,7 @@
 #include &quot;Sim/Units/UnitTypes/TransportUnit.h&quot;
 #include &quot;myMath.h&quot;
 #include &quot;creg/STL_Map.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;System/Util.h&quot;
 #include &quot;System/Exceptions.h&quot;
 

Modified: branches/caiinterface/rts/Sim/Units/CommandAI/CommandAI.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/CommandAI/CommandAI.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Units/CommandAI/CommandAI.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -33,6 +33,7 @@
 #include &quot;creg/STL_Set.h&quot;
 #include &quot;creg/STL_Deque.h&quot;
 #include &lt;assert.h&gt;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;System/Util.h&quot;
 
 const int TARGET_LOST_TIMER =120;	// in calls to SlowUpdate() (approx. once every second)

Modified: branches/caiinterface/rts/Sim/Units/CommandAI/FactoryCAI.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/CommandAI/FactoryCAI.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Units/CommandAI/FactoryCAI.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -4,6 +4,7 @@
 #include &quot;FactoryCAI.h&quot;
 #include &quot;LineDrawer.h&quot;
 #include &quot;ExternalAI/Group.h&quot;
+#include &quot;Game/GlobalSynced.h&quot;
 #include &quot;Game/GameHelper.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
 #include &quot;Game/Team.h&quot;
@@ -20,6 +21,7 @@
 #include &quot;Sim/Units/UnitTypes/Factory.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;creg/STL_Map.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;System/Util.h&quot;
 #include &quot;System/Exceptions.h&quot;
 

Modified: branches/caiinterface/rts/Sim/Units/CommandAI/LineDrawer.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/CommandAI/LineDrawer.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Units/CommandAI/LineDrawer.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -1,7 +1,7 @@
 #include &quot;StdAfx.h&quot;
 #include &quot;LineDrawer.h&quot;
 #include &quot;Game/UI/CommandColors.h&quot;
-#include &quot;GlobalStuff.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 CLineDrawer lineDrawer;
 

Modified: branches/caiinterface/rts/Sim/Units/CommandAI/MobileCAI.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/CommandAI/MobileCAI.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Units/CommandAI/MobileCAI.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -25,6 +25,7 @@
 #include &quot;myMath.h&quot;
 #include &lt;assert.h&gt;
 #include &quot;System/Util.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CMobileCAI ,CCommandAI , );
 

Modified: branches/caiinterface/rts/Sim/Units/CommandAI/TransportCAI.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/CommandAI/TransportCAI.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Units/CommandAI/TransportCAI.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -19,6 +19,7 @@
 #include &quot;Sim/ModInfo.h&quot;
 #include &quot;Rendering/UnitModels/3DOParser.h&quot;
 #include &quot;creg/STL_List.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 #define AIRTRANSPORT_DOCKING_RADIUS 16
 #define AIRTRANSPORT_DOCKING_ANGLE 50

Modified: branches/caiinterface/rts/Sim/Units/Unit.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/Unit.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Units/Unit.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -2336,7 +2336,8 @@
 	CR_MEMBER(sonarJamRadius),
 	CR_MEMBER(hasRadarCapacity),
 	CR_MEMBER(radarSquares),
-	CR_MEMBER(oldRadarPos),
+	CR_MEMBER(oldRadarPos.x),
+	CR_MEMBER(oldRadarPos.y),
 	CR_MEMBER(stealth),
 	CR_MEMBER(sonarStealth),
 	CR_RESERVED(15),

Modified: branches/caiinterface/rts/Sim/Units/Unit.h
===================================================================
--- branches/caiinterface/rts/Sim/Units/Unit.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Units/Unit.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -8,10 +8,12 @@
 #include &lt;vector&gt;
 #include &lt;string&gt;
 #include &lt;deque&gt;
+
 #include &quot;Lua/LuaUnitMaterial.h&quot;
 #include &quot;Sim/Objects/SolidObject.h&quot;
 #include &quot;System/Matrix44f.h&quot;
-#include &quot;GlobalStuff.h&quot;
+#include &quot;Game/GlobalConstants.h&quot;
+#include &quot;Vec2.h&quot;
 
 class CCobInstance;
 class CCommandAI;

Modified: branches/caiinterface/rts/Sim/Units/UnitHandler.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/UnitHandler.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Units/UnitHandler.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -27,6 +27,7 @@
 #include &quot;Sim/Misc/QuadField.h&quot;
 #include &quot;Sim/Units/CommandAI/Command.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;System/FileSystem/FileHandler.h&quot;
 #include &quot;System/LoadSaveInterface.h&quot;
 #include &quot;System/LogOutput.h&quot;

Modified: branches/caiinterface/rts/Sim/Units/UnitTracker.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/UnitTracker.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Units/UnitTracker.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -10,6 +10,7 @@
 #include &quot;Game/SelectedUnits.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;LogOutput.h&quot;
 
 
@@ -291,14 +292,14 @@
 
 	trackPos += (modPlanePos - trackPos) * (1 - pow(0.95f, deltaTime));
 	trackDir += (u-&gt;frontdir - trackDir) * (1 - pow(0.90f, deltaTime));
-	trackDir.Normalize();
+	trackDir.ANormalize();
 
 	camera-&gt;pos=trackPos;
 
 	camera-&gt;forward = u-&gt;pos + (u-&gt;speed * gu-&gt;timeOffset) - camera-&gt;pos;
-	camera-&gt;forward.Normalize();
+	camera-&gt;forward.ANormalize();
 	camera-&gt;forward += trackDir;
-	camera-&gt;forward.Normalize();
+	camera-&gt;forward.ANormalize();
 	if (camHandler-&gt;GetCurrentControllerNum() == 0)
 	{
 		CFPSController&amp; fpsCamera = dynamic_cast&lt;CFPSController&amp;&gt;(camHandler-&gt;GetCurrentController());

Modified: branches/caiinterface/rts/Sim/Units/UnitTypes/Builder.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/UnitTypes/Builder.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Units/UnitTypes/Builder.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -26,6 +26,7 @@
 #include &quot;Sim/Units/UnitDefHandler.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
 #include &quot;Sim/Units/UnitLoader.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;System/EventHandler.h&quot;
 #include &quot;Sound.h&quot;
 #include &quot;mmgr.h&quot;

Modified: branches/caiinterface/rts/Sim/Units/UnitTypes/Building.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/UnitTypes/Building.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Units/UnitTypes/Building.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -14,6 +14,7 @@
 #include &quot;Rendering/GroundDecalHandler.h&quot;
 #include &quot;Game/GameSetup.h&quot;
 #include &quot;Rendering/UnitModels/UnitDrawer.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 #include &quot;mmgr.h&quot;
 

Modified: branches/caiinterface/rts/Sim/Units/UnitTypes/ExtractorBuilding.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/UnitTypes/ExtractorBuilding.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Units/UnitTypes/ExtractorBuilding.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -62,9 +62,8 @@
 void CExtractorBuilding::ResetExtraction()
 {
 	// undo the extraction-area
-	for(std::list&lt;MetalSquareOfControl*&gt;::iterator si = metalAreaOfControl.begin(); si != metalAreaOfControl.end(); ++si) {
-		readmap-&gt;metalMap-&gt;removeExtraction((*si)-&gt;x, (*si)-&gt;z, (*si)-&gt;extractionDepth);
-		delete *si;
+	for(std::vector&lt;MetalSquareOfControl&gt;::iterator si = metalAreaOfControl.begin(); si != metalAreaOfControl.end(); ++si) {
+		readmap-&gt;metalMap-&gt;RemoveExtraction(si-&gt;x, si-&gt;z, si-&gt;extractionDepth);
 	}
 
 	metalAreaOfControl.clear();
@@ -154,6 +153,8 @@
 	int zBegin = std::max(0,                (int) ((pos.z - extractionRange) / METAL_MAP_SQUARE_SIZE));
 	int zEnd   = std::min(gs-&gt;mapy / 2 - 1, (int) ((pos.z + extractionRange) / METAL_MAP_SQUARE_SIZE));
 
+	metalAreaOfControl.reserve((xEnd - xBegin + 1) * (zEnd - zBegin + 1));
+
 	// go through the whole (x, z)-square
 	for (int x = xBegin; x &lt;= xEnd; x++) {
 		for (int z = zBegin; z &lt;= zEnd; z++) {
@@ -163,13 +164,13 @@
 			const float sqrCenterDistance = msqrPos.distance2D(this-&gt;pos);
 
 			if (unitDef-&gt;extractSquare || sqrCenterDistance &lt; extractionRange) {
-				MetalSquareOfControl* msqr = SAFE_NEW MetalSquareOfControl;
-				msqr-&gt;x = x;
-				msqr-&gt;z = z;
+				MetalSquareOfControl msqr;
+				msqr.x = x;
+				msqr.z = z;
 				// extraction is done in a cylinder of height &lt;depth&gt;
-				msqr-&gt;extractionDepth = readmap-&gt;metalMap-&gt;requestExtraction(x, z, depth);
+				msqr.extractionDepth = readmap-&gt;metalMap-&gt;RequestExtraction(x, z, depth);
 				metalAreaOfControl.push_back(msqr);
-				metalExtract += msqr-&gt;extractionDepth * readmap-&gt;metalMap-&gt;getMetalAmount(msqr-&gt;x, msqr-&gt;z);
+				metalExtract += msqr.extractionDepth * readmap-&gt;metalMap-&gt;GetMetalAmount(msqr.x, msqr.z);
 			}
 		}
 	}
@@ -206,13 +207,13 @@
 void CExtractorBuilding::ReCalculateMetalExtraction()
 {
 	metalExtract = 0;
-	for (std::list&lt;MetalSquareOfControl*&gt;::iterator si = metalAreaOfControl.begin(); si != metalAreaOfControl.end(); ++si) {
-		MetalSquareOfControl* msqr = *si;
-		readmap-&gt;metalMap-&gt;removeExtraction(msqr-&gt;x, msqr-&gt;z, msqr-&gt;extractionDepth);
+	for (std::vector&lt;MetalSquareOfControl&gt;::iterator si = metalAreaOfControl.begin(); si != metalAreaOfControl.end(); ++si) {
+		MetalSquareOfControl&amp; msqr = *si;
+		readmap-&gt;metalMap-&gt;RemoveExtraction(msqr.x, msqr.z, msqr.extractionDepth);
 
 		// extraction is done in a cylinder
-		msqr-&gt;extractionDepth = readmap-&gt;metalMap-&gt;requestExtraction(msqr-&gt;x, msqr-&gt;z, extractionDepth);
-		metalExtract += msqr-&gt;extractionDepth * readmap-&gt;metalMap-&gt;getMetalAmount(msqr-&gt;x, msqr-&gt;z);
+		msqr.extractionDepth = readmap-&gt;metalMap-&gt;RequestExtraction(msqr.x, msqr.z, extractionDepth);
+		metalExtract += msqr.extractionDepth * readmap-&gt;metalMap-&gt;GetMetalAmount(msqr.x, msqr.z);
 	}
 
 	// set the new rotation-speed

Modified: branches/caiinterface/rts/Sim/Units/UnitTypes/ExtractorBuilding.h
===================================================================
--- branches/caiinterface/rts/Sim/Units/UnitTypes/ExtractorBuilding.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Units/UnitTypes/ExtractorBuilding.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -33,7 +33,7 @@
 	};
 
 	float extractionRange, extractionDepth;
-	std::list&lt;MetalSquareOfControl*&gt; metalAreaOfControl;
+	std::vector&lt;MetalSquareOfControl&gt; metalAreaOfControl;
 	std::list&lt;CExtractorBuilding*&gt; neighbours;
 
 	static float maxExtractionRange;

Modified: branches/caiinterface/rts/Sim/Units/UnitTypes/Factory.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/UnitTypes/Factory.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Units/UnitTypes/Factory.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -25,6 +25,7 @@
 #include &quot;Sim/Units/UnitHandler.h&quot;
 #include &quot;Sim/Units/UnitLoader.h&quot;
 #include &quot;Sync/SyncTracer.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;System/EventHandler.h&quot;
 #include &quot;Sound.h&quot;
 #include &quot;LogOutput.h&quot;

Modified: branches/caiinterface/rts/Sim/Weapons/DGunWeapon.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Weapons/DGunWeapon.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Weapons/DGunWeapon.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -1,5 +1,6 @@
 #include &quot;StdAfx.h&quot;
 #include &quot;DGunWeapon.h&quot;
+#include &quot;Game/GlobalSynced.h&quot;
 #include &quot;Game/Team.h&quot;
 #include &quot;Sim/Projectiles/WeaponProjectiles/FireBallProjectile.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;

Modified: branches/caiinterface/rts/Sim/Weapons/PlasmaRepulser.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Weapons/PlasmaRepulser.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Weapons/PlasmaRepulser.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -1,6 +1,7 @@
 #include &quot;StdAfx.h&quot;
 #include &quot;creg/STL_List.h&quot;
 #include &quot;creg/STL_Set.h&quot;
+#include &quot;Game/GlobalSynced.h&quot;
 #include &quot;Game/Team.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;PlasmaRepulser.h&quot;

Modified: branches/caiinterface/rts/Sim/Weapons/WeaponDefHandler.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Weapons/WeaponDefHandler.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Weapons/WeaponDefHandler.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -4,6 +4,7 @@
 #include &lt;iostream&gt;
 #include &lt;stdexcept&gt;
 #include &quot;WeaponDefHandler.h&quot;
+#include &quot;Game/GlobalConstants.h&quot;
 #include &quot;Game/Game.h&quot;
 #include &quot;Lua/LuaParser.h&quot;
 #include &quot;FileSystem/FileHandler.h&quot;

Modified: branches/caiinterface/rts/Sim/Weapons/bombdropper.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Weapons/bombdropper.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/Sim/Weapons/bombdropper.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -5,6 +5,7 @@
 #include &quot;StdAfx.h&quot;
 #include &quot;bombdropper.h&quot;
 #include &quot;Game/GameHelper.h&quot;
+#include &quot;Game/GlobalSynced.h&quot;
 #include &quot;Game/Team.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Map/MapInfo.h&quot;

Modified: branches/caiinterface/rts/System/DemoRecorder.cpp
===================================================================
--- branches/caiinterface/rts/System/DemoRecorder.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/System/DemoRecorder.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -13,6 +13,7 @@
 #include &quot;Game/GameVersion.h&quot;
 #include &quot;Game/GameSetup.h&quot;
 #include &quot;System/Util.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 
 #include &quot;LogOutput.h&quot;
 

Modified: branches/caiinterface/rts/System/FastMath.h
===================================================================
--- branches/caiinterface/rts/System/FastMath.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/System/FastMath.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -174,6 +174,7 @@
 	}
 }
 
+using fastmath::PI;
 namespace math {
 	using fastmath::isqrt;
 	using fastmath::isqrt2;

Deleted: branches/caiinterface/rts/System/GlobalStuff.cpp
===================================================================
--- branches/caiinterface/rts/System/GlobalStuff.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/System/GlobalStuff.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -1,407 +0,0 @@
-/**
- * @file GlobalStuff.cpp
- * @brief Globally accessible stuff
- *
- * Contains implementation of synced and
- * unsynced global stuff
- */
-#include &quot;StdAfx.h&quot;
-#include &quot;Platform/errorhandler.h&quot;
-#include &lt;cstring&gt;
-#include &quot;mmgr.h&quot;
-#include &quot;Util.h&quot;
-#include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
-#include &quot;Game/GameHelper.h&quot;
-#include &quot;Game/GameSetup.h&quot;
-#include &quot;Sync/SyncTracer.h&quot;
-#include &quot;Game/Team.h&quot;
-#include &quot;Game/Player.h&quot;
-#include &quot;Rendering/Textures/TAPalette.h&quot;
-#include &quot;Lua/LuaGaia.h&quot;
-#include &quot;Lua/LuaRules.h&quot;
-#include &quot;SDL_types.h&quot;
-#include &quot;SDL_timer.h&quot;
-#include &lt;assert.h&gt;
-#include &quot;ExternalAI/IAILibraryManager.h&quot;
-
-/**
- * @brief global synced
- *
- * Global instance of CGlobalSyncedStuff
- */
-CGlobalSyncedStuff* gs;
-
-/**
- * @brief global unsynced
- *
- * Global instance of CGlobalUnsyncedStuff
- */
-CGlobalUnsyncedStuff* gu;
-
-/**
- * @brief randint max
- *
- * Defines the maximum random integer as 0x7fff
- */
-const int RANDINT_MAX = 0x7fff;
-
-CR_BIND(CGlobalSyncedStuff,);
-
-CR_REG_METADATA(CGlobalSyncedStuff, (
-				CR_MEMBER(randSeed),
-				CR_MEMBER(initRandSeed),
-				CR_MEMBER(frameNum),
-				CR_MEMBER(speedFactor),
-				CR_MEMBER(userSpeedFactor),
-				CR_MEMBER(paused),
-				CR_MEMBER(tempNum),
-				CR_MEMBER(godMode),
-				CR_MEMBER(globalLOS),
-				CR_MEMBER(cheatEnabled),
-				CR_MEMBER(noHelperAIs),
-				CR_MEMBER(editDefsEnabled),
-				CR_MEMBER(useLuaRules),
-				CR_MEMBER(useLuaGaia),
-				CR_MEMBER(gaiaTeamID),
-				CR_MEMBER(gaiaAllyTeamID),
-				CR_MEMBER(gameMode),
-				CR_MEMBER(players),
-				CR_MEMBER(activeTeams),
-				CR_MEMBER(activeAllyTeams),
-				CR_MEMBER(activePlayers),
-				CR_MEMBER(allies),
-				CR_MEMBER(team2allyteam),
-				CR_MEMBER(teams),
-				CR_RESERVED(64)
-				));
-
-CR_BIND(CGlobalUnsyncedStuff,);
-
-CR_REG_METADATA(CGlobalUnsyncedStuff, (
-				CR_MEMBER(usRandSeed),
-				CR_MEMBER(modGameTime),
-				CR_MEMBER(gameTime),
-				CR_MEMBER(lastFrameTime),
-				CR_MEMBER(myPlayerNum),
-				CR_MEMBER(myTeam),
-				CR_MEMBER(myAllyTeam),
-				CR_MEMBER(spectating),
-				CR_MEMBER(spectatingFullView),
-				CR_MEMBER(spectatingFullSelect),
-				CR_MEMBER(viewRange),
-				CR_MEMBER(timeOffset),
-				CR_MEMBER(drawFog),
-				CR_MEMBER(autoQuit),
-				CR_MEMBER(quitTime),
-				CR_RESERVED(64)
-				));
-
-/**
- * Initializes variables in CGlobalSyncedStuff
- */
-CGlobalSyncedStuff::CGlobalSyncedStuff()
-{
-	hmapx = 256;
-	hmapy = 256;
-	randSeed = 18655;
-	initRandSeed = randSeed;
-	frameNum = 0;
-	speedFactor = 1;
-	userSpeedFactor = 1;
-	paused = false;
-	godMode = false;
-	globalLOS = false;
-	cheatEnabled = false;
-	noHelperAIs = false;
-	editDefsEnabled = false;
-	tempNum = 2;
-	gameMode = 0;
-	useLuaGaia = true;
-	gaiaTeamID = -1;
-	gaiaAllyTeamID = -1;
-	useLuaRules = true;
-	
-	for(int a = 0; a &lt; MAX_TEAMS; ++a) {
-		teams[a] = SAFE_NEW CTeam();
-		teams[a]-&gt;teamNum = a;
-		team2allyteam[a] = a;
-	}
-	for(int a = 0; a &lt; MAX_PLAYERS; ++a) {
-		players[a] = SAFE_NEW CPlayer();
-		players[a]-&gt;playerNum = a;
-	}
-
-	for (int a = 0; a &lt; MAX_TEAMS; ++a) {
-		for (int b = 0; b &lt; MAX_TEAMS; ++b) {
-			allies[a][b] = false;
-		}
-		allies[a][a] = true;
-	}
-
-	activeTeams = 2;
-	activeAllyTeams = 2;
-	activePlayers = MAX_PLAYERS;
-}
-
-/**
- * Destroys data inside CGlobalSyncedStuff
- */
-CGlobalSyncedStuff::~CGlobalSyncedStuff()
-{
-	for(int a = 0; a &lt; MAX_TEAMS; a++) {
-		delete teams[a];
-	}
-	for(int a = 0; a &lt; MAX_PLAYERS; a++) {
-		delete players[a];
-	}
-}
-
-void CGlobalSyncedStuff::LoadFromSetup(const CGameSetup* setup)
-{
-	gameMode = setup-&gt;gameMode;
-	noHelperAIs = !!setup-&gt;noHelperAIs;
-
-	useLuaGaia  = CLuaGaia::SetConfigString(setup-&gt;luaGaiaStr);
-	useLuaRules = CLuaRules::SetConfigString(setup-&gt;luaRulesStr);
-
-	activePlayers = setup-&gt;numPlayers;
-	activeTeams = setup-&gt;numTeams;
-	activeAllyTeams = setup-&gt;numAllyTeams;
-	
-	assert(activeTeams &lt;= MAX_TEAMS);
-	assert(activeAllyTeams &lt;= MAX_TEAMS);
-
-	for (int i = 0; i &lt; activePlayers; ++i)
-	{
-		// TODO: refactor
-		*static_cast&lt;PlayerBase*&gt;(players[i]) = setup-&gt;playerStartingData[i];
-	}
-
-	for (int i = 0; i &lt; activeTeams; ++i)
-	{
-		teams[i]-&gt;metal = setup-&gt;startMetal;
-		teams[i]-&gt;metalIncome = setup-&gt;startMetal; // for the endgame statistics
-
-		teams[i]-&gt;energy = setup-&gt;startEnergy;
-		teams[i]-&gt;energyIncome = setup-&gt;startEnergy;
-
-		float3 start(setup-&gt;teamStartingData[i].startPos.x, setup-&gt;teamStartingData[i].startPos.y, setup-&gt;teamStartingData[i].startPos.z);
-		teams[i]-&gt;StartposMessage(start, (setup-&gt;startPosType != CGameSetup::StartPos_ChooseInGame));
-		std::memcpy(teams[i]-&gt;color, setup-&gt;teamStartingData[i].color, 4);
-		teams[i]-&gt;handicap = setup-&gt;teamStartingData[i].handicap;
-		teams[i]-&gt;leader = setup-&gt;teamStartingData[i].leader;
-		teams[i]-&gt;side = setup-&gt;teamStartingData[i].side;
-		SetAllyTeam(i, setup-&gt;teamStartingData[i].teamAllyteam);
-		if (!(setup-&gt;teamStartingData[i].luaAI.empty())) {
-			teams[i]-&gt;luaAI = setup-&gt;teamStartingData[i].luaAI;
-			teams[i]-&gt;isAI = true;
-		}
-		else {
-			if (setup-&gt;hostDemo) {
-				SSAIKey key = {{NULL, NULL}, {NULL, NULL}};
-				teams[i]-&gt;skirmishAISpecifier = key;
-			}
-			else
-			{
-				const char* sn = setup-&gt;teamStartingData[i].skirmishAIShortName.c_str();
-				const char* v = setup-&gt;teamStartingData[i].skirmishAIVersion.empty() ? NULL : setup-&gt;teamStartingData[i].skirmishAIVersion.c_str();
-				SSAISpecifier spec = {sn, v};
-				std::vector&lt;SSAIKey&gt; fittingKeys = IAILibraryManager::GetInstance()-&gt;ResolveSkirmishAIKey(spec);
-				if (fittingKeys.size() &gt; 0) {
-					teams[i]-&gt;skirmishAISpecifier = fittingKeys[0];
-					teams[i]-&gt;isAI = true;
-				} else {
-					const int MAX_MSG_LENGTH = 511;
-					char s_msg[MAX_MSG_LENGTH + 1];
-					SNPRINTF(s_msg, MAX_MSG_LENGTH, &quot;Specifyed Skirmish AI could not be found: %s (version: %s)&quot;, spec.shortName, spec.version != NULL ? spec.version : &quot;&lt;not specifyed&gt;&quot;);
-					handleerror(NULL, s_msg, &quot;Game Script Error&quot;, MBF_OK | MBF_EXCL);
-				}
-			}
-		}
-	}
-
-	for (int allyTeam1 = 0; allyTeam1 &lt; activeAllyTeams; ++allyTeam1)
-	{
-		for (int allyTeam2 = 0; allyTeam2 &lt; activeAllyTeams; ++allyTeam2)
-			allies[allyTeam1][allyTeam2] = setup-&gt;allyStartingData[allyTeam1].allies[allyTeam2];
-	}
-
-	if (useLuaGaia) {
-		//TODO duplicated in SpringApp::CreateGameSetup()
-		// Gaia adjustments
-		gaiaTeamID = activeTeams;
-		gaiaAllyTeamID = activeAllyTeams;
-		activeTeams++;
-		activeAllyTeams++;
-
-		// Setup the gaia team
-		CTeam* team = gs-&gt;Team(gs-&gt;gaiaTeamID);
-		team-&gt;color[0] = 255;
-		team-&gt;color[1] = 255;
-		team-&gt;color[2] = 255;
-		team-&gt;color[3] = 255;
-		team-&gt;gaia = true;
-		team-&gt;StartposMessage(float3(0.0, 0.0, 0.0), true);
-		//players[setup-&gt;numPlayers]-&gt;team = gaiaTeamID;
-		SetAllyTeam(gaiaTeamID, gaiaAllyTeamID);
-	}
-}
-
-/**
- * @return synced random integer
- *
- * returns a synced random integer
- */
-int CGlobalSyncedStuff::randInt()
-{
-	randSeed = (randSeed * 214013L + 2531011L);
-	return randSeed &amp; RANDINT_MAX;
-}
-
-/**
- * @return synced random float
- *
- * returns a synced random float
- */
-float CGlobalSyncedStuff::randFloat()
-{
-	randSeed = (randSeed * 214013L + 2531011L);
-	return float(randSeed &amp; RANDINT_MAX)/RANDINT_MAX;
-}
-
-/**
- * @return synced random vector
- *
- * returns a synced random vector
- */
-float3 CGlobalSyncedStuff::randVector()
-{
-	float3 ret;
-	do {
-		ret.x = randFloat()*2-1;
-		ret.y = randFloat()*2-1;
-		ret.z = randFloat()*2-1;
-	} while(ret.SqLength()&gt;1);
-
-	return ret;
-}
-
-int CGlobalSyncedStuff::Player(const std::string&amp; name)
-{
-	for (int i = 0; i &lt; MAX_PLAYERS; ++i) {
-		if (players[i] &amp;&amp; players[i]-&gt;name == name) {
-			return i;
-		}
-	}
-	return -1;
-}
-
-CGlobalSyncedStuff* CGlobalSyncedStuff::instance = NULL;
-CGlobalSyncedStuff* CGlobalSyncedStuff::GetInstance() {
-	return instance;
-}
-
-/**
- * Initializes variables in CGlobalUnsyncedStuff
- */
-CGlobalUnsyncedStuff::CGlobalUnsyncedStuff()
-{
-	Uint64 randnum;
-	randnum = SDL_GetTicks();
-	usRandSeed = randnum&amp;0xffffffff;
-	modGameTime = 0;
-	gameTime = 0;
-	lastFrameTime = 0;
-	drawFrame = 1;
-	viewSizeX = 100;
-	viewSizeY = 100;
-	pixelX = 0.01f;
-	pixelY = 0.01f;
-	aspectRatio = 1.0f;
-	myPlayerNum = 0;
-	myTeam = 1;
-	myAllyTeam = 1;
-	spectating           = false;
-	spectatingFullView   = false;
-	spectatingFullSelect = false;
-	drawdebug = false;
-	active = true;
-	viewRange = MAX_VIEW_RANGE;
-	timeOffset = 0;
-	drawFog = true;
-	compressTextures = false;
-	atiHacks = false;
-	teamNanospray = false;
-	autoQuit = false;
-	quitTime = 0;
-#ifdef DIRECT_CONTROL_ALLOWED
-	directControl = 0;
-#endif
-}
-
-/**
- * Destroys variables in CGlobalUnsyncedStuff
- */
-CGlobalUnsyncedStuff::~CGlobalUnsyncedStuff()
-{
-}
-
-/**
- * @return unsynced random integer
- *
- * Returns an unsynced random integer
- */
-int CGlobalUnsyncedStuff::usRandInt()
-{
-	usRandSeed = (usRandSeed * 214013L + 2531011L);
-	return usRandSeed &amp; RANDINT_MAX;
-}
-
-/**
- * @return unsynced random float
- *
- * returns an unsynced random float
- */
-float CGlobalUnsyncedStuff::usRandFloat()
-{
-	usRandSeed = (usRandSeed * 214013L + 2531011L);
-	return float(usRandSeed &amp; RANDINT_MAX)/RANDINT_MAX;
-}
-
-/**
- * @return unsynced random vector
- *
- * returns an unsynced random vector
- */
-float3 CGlobalUnsyncedStuff::usRandVector()
-{
-	float3 ret;
-	do {
-		ret.x = usRandFloat() * 2 - 1;
-		ret.y = usRandFloat() * 2 - 1;
-		ret.z = usRandFloat() * 2 - 1;
-	} while (ret.SqLength() &gt; 1);
-
-	return ret;
-}
-
-void CGlobalUnsyncedStuff::LoadFromSetup(const CGameSetup* setup)
-{
-	myPlayerNum = setup-&gt;myPlayerNum;
-	myTeam = setup-&gt;playerStartingData[myPlayerNum].team;
-	myAllyTeam = setup-&gt;teamStartingData[myTeam].teamAllyteam;
-
-	spectating = setup-&gt;playerStartingData[myPlayerNum].spectator;
-	spectatingFullView   = setup-&gt;playerStartingData[myPlayerNum].spectator;
-	spectatingFullSelect = setup-&gt;playerStartingData[myPlayerNum].spectator;
-	
-	assert(myPlayerNum &gt;= 0 &amp;&amp; myPlayerNum &lt; MAX_PLAYERS &amp;&amp;
-			setup-&gt;playerStartingData.size() &gt;= myPlayerNum &amp;&amp;
-			setup-&gt;teamStartingData.size() &gt;= myTeam);
-}
-
-CGlobalUnsyncedStuff* CGlobalUnsyncedStuff::instance = NULL;
-CGlobalUnsyncedStuff* CGlobalUnsyncedStuff::GetInstance() {
-	return instance;
-}
-

Deleted: branches/caiinterface/rts/System/GlobalStuff.h
===================================================================
--- branches/caiinterface/rts/System/GlobalStuff.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/System/GlobalStuff.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -1,705 +0,0 @@
-/**
- * @file GlobalStuff.h
- * @brief Globally accessible stuff
- *
- * Contains the synced and unsynced global
- * data accessed by the program
- */
-#ifndef GLOBALSTUFF_H
-#define GLOBALSTUFF_H
-
-#include &quot;float3.h&quot;
-
-/**
- * @brief pi
- *
- * Defines PI as a float
- */
-const float PI = 3.141592654f;
-
-/**
- * @brief maximum world size
- *
- * Defines the maximum world size as 1000000
- */
-const int MAX_WORLD_SIZE = 1000000;
-
-/**
- * @brief square size
- *
- * Defines the size of 1 square as 8
- */
-const int  SQUARE_SIZE = 8;
-
-/**
- * @brief game speed
- *
- * Defines the game speed as 30
- */
-const int GAME_SPEED = 30;
-
-/**
- * @brief max view range
- *
- * Defines the maximum view range as 8000
- */
-const int MAX_VIEW_RANGE = 8000;
-
-/**
- * @brief max teams
- *
- * Defines the maximum number of teams
- * as 17 (16 real teams, and an extra slot for the GAIA team)
- */
-const int MAX_TEAMS = 17;
-
-/**
- * @brief max players
- *
- * Defines the maximum number of players as 32
- */
-const int MAX_PLAYERS = 32;
-
-/**
- * @brief near plane
- *
- * Defines the near plane as 2.8f
- */
-const float NEAR_PLANE = 2.8f;
-
-
-/**
- * @brief int2 struct
- *
- * Struct containing two integers
- */
-struct int2 {
-	CR_DECLARE_STRUCT(int2);
-
-	/**
-	 * @brief Constructor
-	 *
-	 * Does nothing
-	 */
-	int2(){};
-
-	/**
-	 * @brief Constructor
-	 * @param x x value to use
-	 * @param y y value to use
-	 *
-	 * Initializes struct with a
-	 * given x and y
-	 */
-	int2(int x,int y):x(x),y(y){};
-
-	int x; //!&lt; x component of int2
-	int y; //!&lt; y component of int2
-};
-
-/**
- * @brief float2 struct
- *
- * Struct containing two floats
- */
-struct float2 {
-	CR_DECLARE_STRUCT(float2);
-	float x; //!&lt; x component of float2
-	float y; //!&lt; y component of float2
-};
-
-/**
- * @brief upwards vector
- *
- * Defines constant upwards vector
- * (0,1,0)
- */
-const float3 UpVector(0,1,0);
-
-/**
- * @brief zero vector
- *
- * Defines constant zero vector
- * (0,0,0)
- */
-const float3 ZeroVector(0,0,0);
-
-#if !defined BUILDING_AI &amp;&amp; !defined BUILDING_AI_INTERFACE
-class CTeam;
-class CUnit;
-class CPlayer;
-class LuaParser;
-class CGameSetup;
-
-/**
- * @brief Global synced stuff
- *
- * Class contains globally accessible
- * stuff that remains synced.
- */
-class CGlobalSyncedStuff
-{
-public:
-	CR_DECLARE(CGlobalSyncedStuff);
-	CGlobalSyncedStuff();  //!&lt; Constructor
-	~CGlobalSyncedStuff(); //!&lt; Destructor
-	void LoadFromSetup(const CGameSetup*);
-
-	int    randInt();    //!&lt; synced random int
-	float  randFloat();  //!&lt; synced random float
-	float3 randVector(); //!&lt; synced random vector
-
-	void SetRandSeed(unsigned int seed, bool init = false) {
-		randSeed = seed;
-		if (init) { initRandSeed = randSeed; }
-	}
-	unsigned int GetRandSeed()     const { return randSeed; }
-	unsigned int GetInitRandSeed() const { return initRandSeed; }
-	
-	static CGlobalSyncedStuff* GetInstance();
-private:
-	static CGlobalSyncedStuff* instance;
-public:
-
-	/**
-	 * @brief frame number
-	 *
-	 * Stores the current frame number
-	 */
-	int frameNum;
-
-	/**
-	 * @brief speed factor
-	 *
-	 * Contains the actual gamespeed used by the game
-	 */
-	float speedFactor;
-
-	/**
-	 * @brief user speed factor
-	 *
-	 * Contains the user's speed factor.
-	 * The real gamespeed can be up to this
-	 * but is lowered if a computer can't keep up
-	 */
-	float userSpeedFactor;
-
-	/**
-	 * @brief paused
-	 *
-	 * Holds whether the game is paused
-	 */
-	bool paused;
-
-	/**
-	 * @brief map x
-	 *
-	 * The map's number of squares in the x direction
-	 * (note that the number of vertices is one more)
-	 */
-	int mapx;
-
-	/**
-	 * @brief map y
-	 *
-	 * The map's number of squares in the y direction
-	 */
-	int mapy;
-
-	/**
-	 * @brief map squares
-	 *
-	 * Total number of squares on the map
-	 */
-	int mapSquares;
-
-	/**
-	 * @brief half map x
-	 *
-	 * Contains half of the number of squares in the x direction
-	 */
-	int hmapx;
-
-	/**
-	 * @brief half map y
-	 *
-	 * Contains half of the number of squares in the y direction
-	 */
-	int hmapy;
-
-	/**
-	 * @brief map x power of 2
-	 *
-	 * Map's size in the x direction rounded
-	 * up to the next power of 2
-	 */
-	int pwr2mapx;
-
-	/**
-	 * @brief map y power of 2
-	 *
-	 * Map's size in the y direction rounded
-	 * up to the next power of 2
-	 */
-	int pwr2mapy;
-
-	/**
-	 * @brief temp num
-	 *
-	 * Used for getting temporary but unique numbers
-	 * (increase after each use)
-	 */
-	int tempNum;
-
-	/**
-	 * @brief god mode
-	 *
-	 * Whether god mode is enabled, allows all players to control all units (even specs)
-	 */
-	bool godMode;
-
-	/**
-	 * @brief global line-of-sight
-	 *
-	 * Whether everything on the map is visible at all times
-	 */
-	bool globalLOS;
-
-	/**
-	 * @brief cheat enabled
-	 *
-	 * Whether cheating is enabled
-	 */
-	bool cheatEnabled;
-
-	/**
-	 * @brief disable helper AIs
-	 *
-	 * Whether helper AIs are allowed, including GroupAI and LuaUI control widgets
-	 */
-	bool noHelperAIs;
-
-	/**
-	 * @brief definition editing enabled
-	 *
-	 * Whether definition editing is enabled
-	 */
-	bool editDefsEnabled;
-
-	/**
-	 * @brief LuaRules control
-	 *
-	 * Whether or not LuaRules is enabled
-	 */
-	bool useLuaRules;
-
-	/**
-	 * @brief LuaGaia control
-	 *
-	 * Whether or not LuaGaia is enabled
-	 */
-	bool useLuaGaia;
-
-	/**
-	 * @brief gaia team
-	 *
-	 * gaia's team id
-	 */
-	int gaiaTeamID;
-
-	/**
-	 * @brief gaia team
-	 *
-	 * gaia's team id
-	 */
-	int gaiaAllyTeamID;
-
-	/**
-	 * @brief game mode
-	 *
-	 * Determines the commander mode of this game
-	 *   0: game continues after commander dies
-	 *   1: game ends when commander dies
-	 *   2: lineage mode (all descendants die when a commander dies)
-	 */
-	int gameMode;
-
-	/**
-	 * @brief players
-	 *
-	 * Array of CPlayer pointers, for all the
-	 * players in the game
-	 * (size MAX_PLAYERS)
-	 */
-	CPlayer* players[MAX_PLAYERS];
-
-	/**
-	 * @brief active teams
-	 *
-	 * The number of active teams
-	 * (don't change during play)
-	 */
-	int activeTeams;
-
-	/**
-	 * @brief active ally teams
-	 *
-	 * The number of active ally teams
-	 */
-	int activeAllyTeams;
-
-	/**
-	 * @brief active players
-	 *
-	 * The number of active players
-	 */
-	int activePlayers;
-
-	/**
-	 * @brief Player
-	 * @param name name of the player
-	 * @return his playernumber of -1 if not found
-	 *
-	 * Search a player by name.
-	 */
-	int Player(const std::string&amp; name);
-
-	/**
-	 * @brief Team
-	 * @param i index to fetch
-	 * @return CTeam pointer
-	 *
-	 * Accesses a CTeam pointer at a given index
-	 */
-	CTeam *Team(int i) { return teams[i]; }
-
-	/**
-	 * @brief ally
-	 * @param a first index
-	 * @param b second index
-	 * @return allies[a][b]
-	 *
-	 * Returns ally at [a][b]
-	 */
-	bool Ally(int a,int b) { return allies[a][b]; }
-
-	/**
-	 * @brief ally team
-	 * @param team team to find
-	 * @return the ally team
-	 *
-	 * returns the team2ally at given index
-	 */
-	int AllyTeam(int team) { return team2allyteam[team]; }
-
-	/**
-	 * @brief allied teams
-	 * @param a first team
-	 * @param b second team
-	 * @return whether teams are allied
-	 *
-	 * Tests whether teams are allied
-	 */
-	bool AlliedTeams(int a,int b) { return allies[team2allyteam[a]][team2allyteam[b]]; }
-
-	/**
-	 * @brief set ally team
-	 * @param team team to set
-	 * @param allyteam allyteam to set
-	 *
-	 * Sets team's ally team
-	 */
-	void SetAllyTeam(int team, int allyteam) { team2allyteam[team]=allyteam; }
-
-	/**
-	 * @brief set ally
-	 * @param allyteamA first allyteam
-	 * @param allyteamB second allyteam
-	 * @param allied whether or not these two teams are allied
-	 *
-	 * Sets two allyteams to be allied or not
-	 */
-	void SetAlly(int allyteamA,int allyteamB, bool allied) { allies[allyteamA][allyteamB]=allied; }
-
-private:
-	/**
-	* @brief random seed
-	*
-	* Holds the synced random seed
-	*/
-	int randSeed;
-
-	/**
-	* @brief initial random seed
-	*
-	* Holds the synced initial random seed
-	*/
-	int initRandSeed;
-
-	/**
-	 * @brief allies array
-	 *
-	 * Array indicates whether teams are allied,
-	 * allies[a][b] means allyteam a is allied with
-	 * allyteam b, NOT the other way around
-	 */
-	bool allies[MAX_TEAMS][MAX_TEAMS];
-
-	/**
-	 * @brief team to ally team
-	 *
-	 * Array stores what ally team a specific team is part of
-	 */
-	int team2allyteam[MAX_TEAMS];
-
-	/**
-	 * @brief teams
-	 *
-	 * Array of CTeam pointers for teams in game
-	 */
-	CTeam* teams[MAX_TEAMS];
-};
-
-/**
- * @brief Global unsynced stuff
- *
- * Class containing globally accessible
- * stuff that does not remain synced
- */
-class CGlobalUnsyncedStuff
-{
-public:
-	CR_DECLARE(CGlobalUnsyncedStuff);
-	CGlobalUnsyncedStuff();  //!&lt; Constructor
-	~CGlobalUnsyncedStuff(); //!&lt; Destructor
-
-	int    usRandInt();    //!&lt; Unsynced random int
-	float  usRandFloat();  //!&lt; Unsynced random float
-	float3 usRandVector(); //!&lt; Unsynced random vector
-
-	void LoadFromSetup(const CGameSetup*);
-	
-	static CGlobalUnsyncedStuff* GetInstance();
-private:
-	static CGlobalUnsyncedStuff* instance;
-public:
-
-	/**
-	 * Does the user want team colored nanospray if the mod allows it?
-	 */
-	bool teamNanospray;
-
-	/**
-	 * @brief mod game time
-	 *
-	 * How long the game has been going on
-	 * (modified with game's speed factor)
-	 */
-	float modGameTime;
-
-	/**
-	 * @brief game time
-	 *
-	 * How long the game has been going on
-	 * in real time
-	 */
-	float gameTime;
-
-	/**
-	 * @brief last frame time
-	 *
-	 * How long the last draw cycle took in real time
-	 */
-	float lastFrameTime;
-
-	// the draw frame number (never 0)
-	unsigned int drawFrame;
-
-	// the screen size in pixels
-	int screenSizeX;
-	int screenSizeY;
-
-	// the window position relative to the screen's bottom-left corner
-	int winPosX;
-	int winPosY;
-
-	// the window size in pixels
-	int winSizeX;
-	int winSizeY;
-
-	// the viewport position relative to the window's bottom-left corner
-	int viewPosX;
-	int viewPosY;
-
-	// the viewport size in pixels
-	int viewSizeX;
-	int viewSizeY;
-
-	// size of one pixel in viewport coordinates, i.e. 1/viewSizeX and 1/viewSizeY
-	float pixelX;
-	float pixelY;
-
-	/**
-	 * @brief aspect ratio
-	 *
-	 * (float)viewSizeX / (float)viewSizeY
-	 */
-	float aspectRatio;
-
-	/**
-	 * @brief Depthbuffer bits
-	 *
-	 * depthbuffer precision
-	 */
-	int depthBufferBits;
-
-	/**
-	 * @brief my player num
-	 *
-	 * Local player's number
-	 */
-	int myPlayerNum;
-
-	/**
-	 * @brief my team
-	 *
-	 * Local player's team
-	 */
-	int myTeam;
-
-	/**
-	 * @brief my ally team
-	 *
-	 * Local player's ally team
-	 */
-	int myAllyTeam;
-
-	/**
-	 * @brief spectating
-	 *
-	 * Whether this player is spectating
-	 * (can't give orders, and can see everything if spectateFullView is true)
-	 */
-	bool spectating;
-
-	/**
-	 * @brief spectatingFullView
-	 *
-	 * Whether this player is a spectator, and can see everything
-	 * (if set to false, visibility is determined by the current team)
-	 */
-	bool spectatingFullView;
-
-	/**
-	 * @brief spectatingFullSelect
-	 *
-	 * Can all units be selected when spectating?
-	 */
-	bool spectatingFullSelect;
-
-	/**
-	 * @brief draw debug
-	 *
-	 * Whether debugging info is drawn
-	 */
-	bool drawdebug;
-
-	/**
-	 * @brief active video
-	 *
-	 * Whether the graphics need to be drawn
-	 */
-	bool active;
-
-	/**
-	 * @brief view range
-	 *
-	 * Player's view range
-	 */
-	float viewRange;
-
-	/**
-	 * @brief time offset
-	 *
-	 * Time in number of frames since last update
-	 * (for interpolation)
-	 */
-	float timeOffset;
-
-	/**
-	 * @brief draw fog
-	 *
-	 * Whether fog (of war) is drawn or not
-	 */
-	bool drawFog;
-
-	/**
-	 * @brief compressTextures
-	 *
-	 * If set, many (not all) textures will compressed on run-time.
-	*/
-	bool compressTextures;
-
-	/**
-	 * @brief collection of some ATI bugfixes
-	 *
-	 * enables some ATI bugfixes
-	 */
-	bool atiHacks;
-
-	/**
-	 * @brief quit automatically?
-	 *
-	 * If set, quit immediately on game over or if gameTime &gt; quitTime,
-	 * whichever comes first.
-	 */
-	bool autoQuit;
-
-	/**
-	 * @brief quit time
-	 *
-	 * If autoQuit is set, the host quits if gameTime &gt; quitTime.
-	 * (This automatically causes all other clients to quit too.)
-	 */
-	float quitTime;
-
-	/**
-	 * @brief dual screen mode
-	 * In dual screen mode, the screen is split up between a game screen and a minimap screen.
-	 * In this case viewSizeX is half of the actual GL viewport width,
-	 */
-	bool dualScreenMode;
-
-	/**
-	 * @brief dual screen minimap on left
-	 * In dual screen mode, allow the minimap to either be shown on the left or the right display.
-	 * Minimap on the right is the default.
-	 */
-	bool dualScreenMiniMapOnLeft;
-
-#ifdef DIRECT_CONTROL_ALLOWED
-	/**
-	 * @brief direct control
-	 *
-	 * Pointer to unit being directly controlled by
-	 * this player
-	 */
-	CUnit* directControl;
-#endif	/* DIRECT_CONTROL_ALLOWED */
-
-private:
-	/**
-	* @brief rand seed
-	*
-	* Stores the unsynced random seed
-	*/
-	int usRandSeed;
-
-};
-
-extern CGlobalSyncedStuff* gs;
-extern CGlobalUnsyncedStuff* gu;
-extern bool fullscreen;
-#endif /* !defined BUILDING_AI &amp;&amp; !defined BUILDING_AI_INTERFACE */
-
-#endif /* GLOBALSTUFF_H */

Copied: branches/caiinterface/rts/System/GlobalUnsynced.cpp (from rev 6844, trunk/rts/System/GlobalUnsynced.cpp)
===================================================================
--- branches/caiinterface/rts/System/GlobalUnsynced.cpp	                        (rev 0)
+++ branches/caiinterface/rts/System/GlobalUnsynced.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -0,0 +1,157 @@
+/**
+ * @file GlobalStuff.cpp
+ * @brief Globally accessible stuff
+ *
+ * Contains implementation of synced and
+ * unsynced global stuff
+ */
+#include &quot;StdAfx.h&quot;
+
+#include &quot;GlobalUnsynced.h&quot;
+
+#include &lt;cstring&gt;
+#include &lt;assert.h&gt;
+
+#include &quot;mmgr.h&quot;
+#include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
+#include &quot;Game/GameHelper.h&quot;
+#include &quot;Game/GameSetup.h&quot;
+#include &quot;Sync/SyncTracer.h&quot;
+#include &quot;Game/Team.h&quot;
+#include &quot;Game/Player.h&quot;
+#include &quot;Game/GlobalConstants.h&quot;
+#include &quot;Rendering/Textures/TAPalette.h&quot;
+#include &quot;Lua/LuaGaia.h&quot;
+#include &quot;Lua/LuaRules.h&quot;
+#include &quot;SDL_types.h&quot;
+#include &quot;SDL_timer.h&quot;
+
+
+/**
+ * @brief global unsynced
+ *
+ * Global instance of CGlobalUnsyncedStuff
+ */
+CGlobalUnsyncedStuff* gu;
+
+
+CR_BIND(CGlobalUnsyncedStuff,);
+
+CR_REG_METADATA(CGlobalUnsyncedStuff, (
+				CR_MEMBER(usRandSeed),
+				CR_MEMBER(modGameTime),
+				CR_MEMBER(gameTime),
+				CR_MEMBER(lastFrameTime),
+				CR_MEMBER(myPlayerNum),
+				CR_MEMBER(myTeam),
+				CR_MEMBER(myAllyTeam),
+				CR_MEMBER(spectating),
+				CR_MEMBER(spectatingFullView),
+				CR_MEMBER(spectatingFullSelect),
+				CR_MEMBER(viewRange),
+				CR_MEMBER(timeOffset),
+				CR_MEMBER(drawFog),
+				CR_MEMBER(autoQuit),
+				CR_MEMBER(quitTime),
+				CR_RESERVED(64)
+				));
+
+/**
+ * Initializes variables in CGlobalUnsyncedStuff
+ */
+CGlobalUnsyncedStuff::CGlobalUnsyncedStuff()
+{
+	Uint64 randnum;
+	randnum = SDL_GetTicks();
+	usRandSeed = randnum&amp;0xffffffff;
+	modGameTime = 0;
+	gameTime = 0;
+	lastFrameTime = 0;
+	drawFrame = 1;
+	viewSizeX = 100;
+	viewSizeY = 100;
+	pixelX = 0.01f;
+	pixelY = 0.01f;
+	aspectRatio = 1.0f;
+	myPlayerNum = 0;
+	myTeam = 1;
+	myAllyTeam = 1;
+	spectating           = false;
+	spectatingFullView   = false;
+	spectatingFullSelect = false;
+	drawdebug = false;
+	active = true;
+	viewRange = MAX_VIEW_RANGE;
+	timeOffset = 0;
+	drawFog = true;
+	compressTextures = false;
+	atiHacks = false;
+	teamNanospray = false;
+	autoQuit = false;
+	quitTime = 0;
+#ifdef DIRECT_CONTROL_ALLOWED
+	directControl = 0;
+#endif
+}
+
+/**
+ * Destroys variables in CGlobalUnsyncedStuff
+ */
+CGlobalUnsyncedStuff::~CGlobalUnsyncedStuff()
+{
+}
+
+/**
+ * @return unsynced random integer
+ *
+ * Returns an unsynced random integer
+ */
+int CGlobalUnsyncedStuff::usRandInt()
+{
+	usRandSeed = (usRandSeed * 214013L + 2531011L);
+	return usRandSeed &amp; RANDINT_MAX;
+}
+
+/**
+ * @return unsynced random float
+ *
+ * returns an unsynced random float
+ */
+float CGlobalUnsyncedStuff::usRandFloat()
+{
+	usRandSeed = (usRandSeed * 214013L + 2531011L);
+	return float(usRandSeed &amp; RANDINT_MAX)/RANDINT_MAX;
+}
+
+/**
+ * @return unsynced random vector
+ *
+ * returns an unsynced random vector
+ */
+float3 CGlobalUnsyncedStuff::usRandVector()
+{
+	float3 ret;
+	do {
+		ret.x = usRandFloat() * 2 - 1;
+		ret.y = usRandFloat() * 2 - 1;
+		ret.z = usRandFloat() * 2 - 1;
+	} while (ret.SqLength() &gt; 1);
+
+	return ret;
+}
+
+void CGlobalUnsyncedStuff::LoadFromSetup(const CGameSetup* setup)
+{
+	myPlayerNum = setup-&gt;myPlayerNum;
+	myTeam = setup-&gt;playerStartingData[myPlayerNum].team;
+	myAllyTeam = setup-&gt;teamStartingData[myTeam].teamAllyteam;
+
+	spectating = setup-&gt;playerStartingData[myPlayerNum].spectator;
+	spectatingFullView   = setup-&gt;playerStartingData[myPlayerNum].spectator;
+	spectatingFullSelect = setup-&gt;playerStartingData[myPlayerNum].spectator;
+	
+	assert(myPlayerNum &gt;= 0 &amp;&amp; myPlayerNum &lt; MAX_PLAYERS &amp;&amp;
+			setup-&gt;playerStartingData.size() &gt;= myPlayerNum &amp;&amp;
+			setup-&gt;teamStartingData.size() &gt;= myTeam);
+}
+

Copied: branches/caiinterface/rts/System/GlobalUnsynced.h (from rev 6844, trunk/rts/System/GlobalUnsynced.h)
===================================================================
--- branches/caiinterface/rts/System/GlobalUnsynced.h	                        (rev 0)
+++ branches/caiinterface/rts/System/GlobalUnsynced.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -0,0 +1,254 @@
+/**
+ * @file GlobalStuff.h
+ * @brief Globally accessible stuff
+ *
+ * Contains the synced and unsynced global
+ * data accessed by the program
+ */
+#ifndef GLOBALSTUFF_H
+#define GLOBALSTUFF_H
+
+#include &quot;float3.h&quot;
+
+
+class CUnit;
+class LuaParser;
+class CGameSetup;
+
+
+/**
+ * @brief Global unsynced stuff
+ *
+ * Class containing globally accessible
+ * stuff that does not remain synced
+ */
+class CGlobalUnsyncedStuff
+{
+public:
+	CR_DECLARE(CGlobalUnsyncedStuff);
+	CGlobalUnsyncedStuff();  //!&lt; Constructor
+	~CGlobalUnsyncedStuff(); //!&lt; Destructor
+
+	int    usRandInt();    //!&lt; Unsynced random int
+	float  usRandFloat();  //!&lt; Unsynced random float
+	float3 usRandVector(); //!&lt; Unsynced random vector
+
+	void LoadFromSetup(const CGameSetup*);
+
+	/**
+	 * Does the user want team colored nanospray if the mod allows it?
+	 */
+	bool teamNanospray;
+
+	/**
+	 * @brief mod game time
+	 *
+	 * How long the game has been going on
+	 * (modified with game's speed factor)
+	 */
+	float modGameTime;
+
+	/**
+	 * @brief game time
+	 *
+	 * How long the game has been going on
+	 * in real time
+	 */
+	float gameTime;
+
+	/**
+	 * @brief last frame time
+	 *
+	 * How long the last draw cycle took in real time
+	 */
+	float lastFrameTime;
+
+	// the draw frame number (never 0)
+	unsigned int drawFrame;
+
+	// the screen size in pixels
+	int screenSizeX;
+	int screenSizeY;
+
+	// the window position relative to the screen's bottom-left corner
+	int winPosX;
+	int winPosY;
+
+	// the window size in pixels
+	int winSizeX;
+	int winSizeY;
+
+	// the viewport position relative to the window's bottom-left corner
+	int viewPosX;
+	int viewPosY;
+
+	// the viewport size in pixels
+	int viewSizeX;
+	int viewSizeY;
+
+	// size of one pixel in viewport coordinates, i.e. 1/viewSizeX and 1/viewSizeY
+	float pixelX;
+	float pixelY;
+
+	/**
+	 * @brief aspect ratio
+	 *
+	 * (float)viewSizeX / (float)viewSizeY
+	 */
+	float aspectRatio;
+
+	/**
+	 * @brief Depthbuffer bits
+	 *
+	 * depthbuffer precision
+	 */
+	int depthBufferBits;
+
+	/**
+	 * @brief my player num
+	 *
+	 * Local player's number
+	 */
+	int myPlayerNum;
+
+	/**
+	 * @brief my team
+	 *
+	 * Local player's team
+	 */
+	int myTeam;
+
+	/**
+	 * @brief my ally team
+	 *
+	 * Local player's ally team
+	 */
+	int myAllyTeam;
+
+	/**
+	 * @brief spectating
+	 *
+	 * Whether this player is spectating
+	 * (can't give orders, and can see everything if spectateFullView is true)
+	 */
+	bool spectating;
+
+	/**
+	 * @brief spectatingFullView
+	 *
+	 * Whether this player is a spectator, and can see everything
+	 * (if set to false, visibility is determined by the current team)
+	 */
+	bool spectatingFullView;
+
+	/**
+	 * @brief spectatingFullSelect
+	 *
+	 * Can all units be selected when spectating?
+	 */
+	bool spectatingFullSelect;
+
+	/**
+	 * @brief draw debug
+	 *
+	 * Whether debugging info is drawn
+	 */
+	bool drawdebug;
+
+	/**
+	 * @brief active video
+	 *
+	 * Whether the graphics need to be drawn
+	 */
+	bool active;
+
+	/**
+	 * @brief view range
+	 *
+	 * Player's view range
+	 */
+	float viewRange;
+
+	/**
+	 * @brief time offset
+	 *
+	 * Time in number of frames since last update
+	 * (for interpolation)
+	 */
+	float timeOffset;
+
+	/**
+	 * @brief draw fog
+	 *
+	 * Whether fog (of war) is drawn or not
+	 */
+	bool drawFog;
+
+	/**
+	 * @brief compressTextures
+	 *
+	 * If set, many (not all) textures will compressed on run-time.
+	*/
+	bool compressTextures;
+
+	/**
+	 * @brief collection of some ATI bugfixes
+	 *
+	 * enables some ATI bugfixes
+	 */
+	bool atiHacks;
+
+	/**
+	 * @brief quit automatically?
+	 *
+	 * If set, quit immediately on game over or if gameTime &gt; quitTime,
+	 * whichever comes first.
+	 */
+	bool autoQuit;
+
+	/**
+	 * @brief quit time
+	 *
+	 * If autoQuit is set, the host quits if gameTime &gt; quitTime.
+	 * (This automatically causes all other clients to quit too.)
+	 */
+	float quitTime;
+
+	/**
+	 * @brief dual screen mode
+	 * In dual screen mode, the screen is split up between a game screen and a minimap screen.
+	 * In this case viewSizeX is half of the actual GL viewport width,
+	 */
+	bool dualScreenMode;
+
+	/**
+	 * @brief dual screen minimap on left
+	 * In dual screen mode, allow the minimap to either be shown on the left or the right display.
+	 * Minimap on the right is the default.
+	 */
+	bool dualScreenMiniMapOnLeft;
+
+#ifdef DIRECT_CONTROL_ALLOWED
+	/**
+	 * @brief direct control
+	 *
+	 * Pointer to unit being directly controlled by
+	 * this player
+	 */
+	CUnit* directControl;
+#endif
+
+private:
+	/**
+	* @brief rand seed
+	*
+	* Stores the unsynced random seed
+	*/
+	int usRandSeed;
+
+};
+
+extern CGlobalUnsyncedStuff* gu;
+extern bool fullscreen;
+
+#endif /* GLOBALSTUFF_H */

Modified: branches/caiinterface/rts/System/LoadSaveHandler.cpp
===================================================================
--- branches/caiinterface/rts/System/LoadSaveHandler.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/System/LoadSaveHandler.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -29,6 +29,7 @@
 #include &quot;Sim/Units/CommandAI/BuilderCAI.h&quot;
 #include &quot;Game/GameServer.h&quot;
 #include &quot;Rendering/InMapDraw.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;System/Exceptions.h&quot;
 
 extern std::string stupidGlobalMapname;

Modified: branches/caiinterface/rts/System/LogOutput.cpp
===================================================================
--- branches/caiinterface/rts/System/LogOutput.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/System/LogOutput.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -1,6 +1,7 @@
 #include &quot;StdAfx.h&quot;
 
 #include &quot;LogOutput.h&quot;
+
 #include &lt;assert.h&gt;
 #include &lt;cstdarg&gt;
 #include &lt;fstream&gt;
@@ -15,7 +16,7 @@
 #include &quot;Util.h&quot;
 #include &quot;float3.h&quot;
 #if !defined DEDICATED &amp;&amp; !defined BUILDING_AI &amp;&amp; !defined BUILDING_AI_INTERFACE
-#include &quot;GlobalStuff.h&quot;
+#include &quot;Game/GlobalSynced.h&quot;
 #endif	/* !defined DEDICATED &amp;&amp; !defined BUILDING_AI &amp;&amp; !defined BUILDING_AI_INTERFACE */
 
 

Modified: branches/caiinterface/rts/System/Matrix44f.cpp
===================================================================
--- branches/caiinterface/rts/System/Matrix44f.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/System/Matrix44f.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -8,7 +8,7 @@
 CR_REG_METADATA(CMatrix44f, CR_MEMBER(m));
 
 
-CMatrix44f::CMatrix44f(void)
+CMatrix44f::CMatrix44f()
 {
 	LoadIdentity();
 }
@@ -32,6 +32,16 @@
 }
 
 
+CMatrix44f&amp; CMatrix44f::operator=(const CMatrix44f&amp; n)
+{
+	m[0]  = n[0];   m[1]  = n[1];   m[2]  = n[2];   m[3]  = n[3];
+	m[4]  = n[4];   m[5]  = n[5];   m[6]  = n[6];   m[7]  = n[7];
+	m[8]  = n[8];   m[9]  = n[9];   m[10] = n[10];  m[11] = n[11];
+	m[12] = n[12];  m[13] = n[13];  m[14] = n[14];  m[15] = n[15];
+	return *this;
+}
+
+
 CMatrix44f::CMatrix44f(const float3&amp; pos)
 {
 	m[0]  = m[5]  = m[10] = m[15] = 1.0f;
@@ -44,11 +54,6 @@
 }
 
 
-CMatrix44f::~CMatrix44f(void)
-{
-}
-
-
 void CMatrix44f::LoadIdentity()
 {
 	m[0]  = m[5]  = m[10] = m[15] = 1.0f;
@@ -208,7 +213,7 @@
 }
 
 
-CMatrix44f CMatrix44f::Mul(const CMatrix44f&amp; m2) const 
+CMatrix44f CMatrix44f::Mul(const CMatrix44f&amp; m2) const
 {
 	CMatrix44f res;
 
@@ -268,7 +273,7 @@
 }
 
 
-void CMatrix44f::Rotate(float rad, float3&amp; axis)
+void CMatrix44f::Rotate(float rad, const float3&amp; axis)
 {
 	const float sr = sin(rad);
 	const float cr = cos(rad);

Modified: branches/caiinterface/rts/System/Matrix44f.h
===================================================================
--- branches/caiinterface/rts/System/Matrix44f.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/System/Matrix44f.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -1,6 +1,7 @@
 #ifndef MATRIX44F_H
 #define MATRIX44F_H
 
+#include &quot;Sync/Syncify.h&quot;
 #include &quot;float3.h&quot;
 #include &quot;Sync/Syncify.h&quot;
 
@@ -9,22 +10,22 @@
 public:
 	CR_DECLARE_STRUCT(CMatrix44f);
 
-	CMatrix44f(void);
+	CMatrix44f();
 	CMatrix44f(const float3&amp; pos, const float3&amp; x, const float3&amp; y, const float3&amp; z);
+	explicit CMatrix44f(const float3&amp; pos);
+
 	CMatrix44f(const CMatrix44f&amp; n);
-	CMatrix44f(const float3&amp; pos);
-	~CMatrix44f(void);
+	CMatrix44f&amp; operator=(const CMatrix44f&amp; n);
 
 	void LoadIdentity();
 
-	inline float&amp; operator[](int a) { return m[a]; }
-	inline float operator[](int a) const { return m[a]; }
-	void operator = (const CMatrix44f&amp; other) { for (int a = 0; a &lt; 16; ++a) m[a] = other[a]; }
+	float&amp; operator[](int a) { return m[a]; }
+	float operator[](int a) const { return m[a]; }
 
 	void RotateX(float rad);
 	void RotateY(float rad);
 	void RotateZ(float rad);
-	void Rotate(float rad, float3&amp; axis);	//axis assumed normalized
+	void Rotate(float rad, const float3&amp; axis);	//axis assumed normalized
 	void Translate(float x, float y, float z);
 	CMatrix44f Mul(const CMatrix44f&amp; other) const;
 
@@ -32,13 +33,13 @@
 	CMatrix44f Invert() const;
 
 	float3 Mul(const float3&amp; vect) const;
-	inline float3 GetPos(void) { return float3(m[12], m[13], m[14]); }
+	float3 GetPos(void) const { return float3(m[12], m[13], m[14]); }
 
+	void SetUpVector(float3&amp; up);
+	void Translate(const float3&amp; pos);
+
 	// OpenGL ordered (ie. column-major)
 	float m[16];
-
-	void SetUpVector(float3&amp; up);
-	void Translate(const float3&amp; pos);
 };
 
 
@@ -47,19 +48,19 @@
 // but can also be casted to and used as pointers.
 template&lt;class T&gt;
 T **newmat2(int x, int y) {
-	T *mat2=SAFE_NEW T[x*y], **mat=SAFE_NEW T *[x];
-	for(int i=0; i&lt;x; ++i)
-		mat[i]=mat2+i*y;
+	T *mat2 = SAFE_NEW T[x*y], **mat = SAFE_NEW T *[x];
+	for (int i = 0; i &lt; x; ++i)
+		mat[i] = mat2 + i*y;
 	return mat;
 }
 
 template&lt;class T&gt;
 T ***newmat3(int x, int y, int z) {
 	T *mat3=SAFE_NEW T[x*y*z], **mat2=SAFE_NEW T *[x*y], ***mat=SAFE_NEW T **[x];
-	for(int i=0; i&lt;x; ++i) {
-		for(int j=0; j&lt;y; ++j)
-			mat2[i*y+j]=mat3+(i*y+j)*z;
-		mat[i]=mat2+i*y;
+	for (int i = 0; i &lt; x; ++i) {
+		for(int j = 0; j &lt; y; ++j)
+			mat2[i*y+j] = mat3 + (i*y+j)*z;
+		mat[i] = mat2 + i*y;
 	}
 	return mat;
 }

Modified: branches/caiinterface/rts/System/Messages.cpp
===================================================================
--- branches/caiinterface/rts/System/Messages.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/System/Messages.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -10,7 +10,7 @@
 #include &lt;map&gt;
 #include &quot;mmgr.h&quot;
 
-#include &quot;GlobalStuff.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Messages.h&quot;
 #include &quot;Lua/LuaParser.h&quot;

Modified: branches/caiinterface/rts/System/MouseInput.cpp
===================================================================
--- branches/caiinterface/rts/System/MouseInput.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/System/MouseInput.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -12,15 +12,18 @@
 #include &quot;StdAfx.h&quot;
 #include &quot;mmgr.h&quot;
 
-#include &quot;Platform/Win/win32.h&quot;
-#include &quot;MouseInput.h&quot;
 #include &quot;Game/UI/MouseHandler.h&quot;
-#include &quot;LogOutput.h&quot;
 
 #include &lt;SDL_events.h&gt;
 #include &lt;SDL_syswm.h&gt;
 
+#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;Platform/Win/win32.h&quot;
+#include &quot;MouseInput.h&quot;
+#include &quot;LogOutput.h&quot;
 
+
+
 IMouseInput* mouseInput = NULL;
 
 

Modified: branches/caiinterface/rts/System/MouseInput.h
===================================================================
--- branches/caiinterface/rts/System/MouseInput.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/System/MouseInput.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -3,7 +3,7 @@
 
 #include &lt;SDL_events.h&gt;
 
-#include &quot;GlobalStuff.h&quot;
+#include &quot;Vec2.h&quot;
 
 class IMouseInput
 {

Modified: branches/caiinterface/rts/System/Platform/FileSystem.h
===================================================================
--- branches/caiinterface/rts/System/Platform/FileSystem.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/System/Platform/FileSystem.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -11,6 +11,7 @@
 #define FILESYSTEM_H
 
 #include &lt;vector&gt;
+#include &lt;string&gt;
 
 // winapi redifines this which breaks things
 #if defined(CreateDirectory)

Modified: branches/caiinterface/rts/System/Platform/Linux/DataDirLocater.cpp
===================================================================
--- branches/caiinterface/rts/System/Platform/Linux/DataDirLocater.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/System/Platform/Linux/DataDirLocater.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -235,11 +235,10 @@
 	if (env &amp;&amp; *env)
 		AddDirs(SubstEnvVars(env));
 
-	// user defined (in spring config handler (Linux: ~/.spring, Windows: registry))
+	// user defined (in spring config handler (Linux: ~/.springrc, Windows: registry))
 	#if !defined WIN32 || !(defined BUILDING_AI || defined BUILDING_AI_INTERFACE)
 	std::string userDef = configHandler.GetString(&quot;SpringData&quot;, &quot;&quot;);
-	if (!userDef.empty())
-	{
+	if (!userDef.empty()) {
 		AddDirs(SubstEnvVars(userDef));
 	}
 	#endif	/* !defined WIN32 || !(defined BUILDING_AI || defined BUILDING_AI_INTERFACE) */
@@ -249,7 +248,7 @@
 	::GetCurrentDirectory(sizeof(currentDir) - 1, currentDir);
 	std::string curPath = currentDir;
 	AddDirs(std::string(currentDir));
-	
+
 	// my documents
 	TCHAR strPath[MAX_PATH];
 	SHGetFolderPath( NULL, CSIDL_PERSONAL, NULL, SHGFP_TYPE_CURRENT, strPath);

Modified: branches/caiinterface/rts/System/Script/LuaBinder.cpp
===================================================================
--- branches/caiinterface/rts/System/Script/LuaBinder.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/System/Script/LuaBinder.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -3,7 +3,7 @@
 #include &quot;Game/StartScripts/Script.h&quot;
 #include &quot;float3.h&quot;
 #include &quot;LogOutput.h&quot;
-#include &quot;GlobalStuff.h&quot;
+#include &quot;Game/GlobalSynced.h&quot;
 #include &quot;Game/Team.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitTypes/TransportUnit.h&quot;

Modified: branches/caiinterface/rts/System/Script/LuaFunctions.cpp
===================================================================
--- branches/caiinterface/rts/System/Script/LuaFunctions.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/System/Script/LuaFunctions.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -5,7 +5,7 @@
 #include &quot;StdAfx.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;LuaFunctions.h&quot;
-#include &quot;GlobalStuff.h&quot;
+#include &quot;Game/GlobalSynced.h&quot;
 #include &quot;float3.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;ExternalAI/GlobalAIHandler.h&quot;

Modified: branches/caiinterface/rts/System/Sound.cpp
===================================================================
--- branches/caiinterface/rts/System/Sound.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/System/Sound.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -1,7 +1,6 @@
 #include &quot;StdAfx.h&quot;
 #include &quot;mmgr.h&quot;
 #include &quot;Sound.h&quot;
-#include &quot;GlobalStuff.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;

Modified: branches/caiinterface/rts/System/Sound.h
===================================================================
--- branches/caiinterface/rts/System/Sound.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/System/Sound.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -1,12 +1,14 @@
 #ifndef SOUNDSYSTEM_INTERFACE_H
 #define SOUNDSYSTEM_INTERFACE_H
 
-#include &quot;float3.h&quot;
-#include &quot;GlobalStuff.h&quot;
 #include &lt;set&gt;
+#include &lt;string&gt;
 
+#include &quot;System/float3.h&quot; // for zerovector
+
 class CWorldObject;
 class CUnit;
+class float3;
 
 // Sound system interface
 class CSound

Modified: branches/caiinterface/rts/System/SpringApp.cpp
===================================================================
--- branches/caiinterface/rts/System/SpringApp.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/System/SpringApp.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -14,6 +14,7 @@
 #undef KeyPress
 #undef KeyRelease
 
+#include &quot;Game/GlobalSynced.h&quot;
 #include &quot;Game/GameVersion.h&quot;
 #include &quot;Game/GameSetup.h&quot;
 #include &quot;Game/GameController.h&quot;
@@ -40,6 +41,7 @@
 #include &quot;MouseInput.h&quot;
 #include &quot;bitops.h&quot;
 #include &quot;Sync/Syncify.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;System/Util.h&quot;
 #include &quot;System/Exceptions.h&quot;
 
@@ -266,27 +268,8 @@
 	keys = SAFE_NEW Uint8[SDLK_LAST];
 	memset (keys,0,sizeof(Uint8)*SDLK_LAST);
 
-	// Initialize font
-	const int charFirst = configHandler.GetInt(&quot;FontCharFirst&quot;, 32);
-	const int charLast  = configHandler.GetInt(&quot;FontCharLast&quot;, 255);
-	std::string fontFile = configHandler.GetString(&quot;FontFile&quot;, &quot;fonts/Luxi.ttf&quot;);
+	LoadFonts();
 
-	const float fontSize = 0.027f;      // ~20 pixels at 1024x768
-	const float smallFontSize = 0.016f; // ~12 pixels at 1024x768
-
-	try {
-		font = CglFont::TryConstructFont(fontFile, charFirst, charLast, fontSize);
-		smallFont = CglFont::TryConstructFont(fontFile, charFirst, charLast, smallFontSize);
-	} catch(content_error&amp;) {
-		// If the standard location fails, retry in fonts directory or vice versa.
-		if (fontFile.substr(0, 6) == &quot;fonts/&quot;)
-			fontFile = fontFile.substr(6);
-		else
-			fontFile = &quot;fonts/&quot; + fontFile;
-		font = CglFont::TryConstructFont(fontFile, charFirst, charLast, fontSize);
-		smallFont = CglFont::TryConstructFont(fontFile, charFirst, charLast, smallFontSize);
-	}
-
 	// Initialize GLEW
 	LoadExtensions();
 	glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
@@ -622,6 +605,32 @@
 	glDepthFunc(GL_LEQUAL);
 }
 
+
+void SpringApp::LoadFonts()
+{
+	// Initialize font
+	const int charFirst = configHandler.GetInt(&quot;FontCharFirst&quot;, 32);
+	const int charLast  = configHandler.GetInt(&quot;FontCharLast&quot;, 255);
+	std::string fontFile = configHandler.GetString(&quot;FontFile&quot;, &quot;fonts/Luxi.ttf&quot;);
+
+	const float fontSize = 0.027f;      // ~20 pixels at 1024x768
+	const float smallFontSize = 0.016f; // ~12 pixels at 1024x768
+
+	try {
+		font = CglFont::TryConstructFont(fontFile, charFirst, charLast, fontSize);
+		smallFont = CglFont::TryConstructFont(fontFile, charFirst, charLast, smallFontSize);
+	} catch (content_error&amp;) {
+		// If the standard location fails, retry in fonts directory or vice versa.
+		if (fontFile.substr(0, 6) == &quot;fonts/&quot;)
+			fontFile = fontFile.substr(6);
+		else
+			fontFile = &quot;fonts/&quot; + fontFile;
+
+		font = CglFont::TryConstructFont(fontFile, charFirst, charLast, fontSize);
+		smallFont = CglFont::TryConstructFont(fontFile, charFirst, charLast, smallFontSize);
+	}
+}
+
 /**
  * @return whether commandline parsing was successful
  *
@@ -1011,6 +1020,7 @@
 					SetSDLVideoMode();
 #endif
 					InitOpenGL();
+					LoadFonts();
 					activeController-&gt;ResizeEvent();
 					break;
 				}

Modified: branches/caiinterface/rts/System/SpringApp.h
===================================================================
--- branches/caiinterface/rts/System/SpringApp.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/System/SpringApp.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -29,6 +29,7 @@
 	void CreateGameSetup (); 			//!&lt; Creates GameSetup
 	bool InitWindow (const char* title); 		//!&lt; Initializes window
 	void InitOpenGL (); 				//!&lt; Initializes OpenGL
+	void LoadFonts();
 	bool SetSDLVideoMode(); 			//!&lt; Sets SDL video mode
 	void Shutdown (); 				//!&lt; Shuts down application
 	int Update (); 					//!&lt; Run simulation and draw

Modified: branches/caiinterface/rts/System/StdAfx.h
===================================================================
--- branches/caiinterface/rts/System/StdAfx.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/System/StdAfx.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -58,16 +58,18 @@
 // also, they shouldn't get in the way of mmgr
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;float3.h&quot;
-#include &quot;GlobalStuff.h&quot;
 #include &quot;System/Util.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
 #if !defined BUILDING_AI &amp;&amp; !defined BUILDING_AI_INTERFACE
 #include &quot;Map/Ground.h&quot;
 #include &quot;Map/ReadMap.h&quot;
+#include &quot;Game/GlobalSynced.h&quot;
+#include &quot;Game/GlobalConstants.h&quot;
 #include &quot;Game/Camera.h&quot;
 #endif	/* !defined BUILDING_AI &amp;&amp; !defined BUILDING_AI_INTERFACE */
 #endif // USE_PRECOMPILED_HEADER
 
-#endif	/* __cplusplus */
+#endif	// __cplusplus
 
 
 #endif // __STD_AFX_H__

Modified: branches/caiinterface/rts/System/Sync/SyncDebugger.cpp
===================================================================
--- branches/caiinterface/rts/System/Sync/SyncDebugger.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/System/Sync/SyncDebugger.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -7,7 +7,8 @@
 #include &lt;boost/format.hpp&gt;
 
 #include &quot;LogOutput.h&quot;
-#include &quot;System/GlobalStuff.h&quot;
+#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalSynced.h&quot;
 #include &quot;System/BaseNetProtocol.h&quot;
 #include &quot;System/NetProtocol.h&quot;
 #include &quot;SyncDebugger.h&quot;
@@ -63,13 +64,6 @@
 		disable_history(false), may_enable_history(false),
 		flop(0), waitingForBlockResponse(false)
 {
-	// Need to allocate those here instead of having them inlined in the class,
-	// because of #include dependency: MAX_PLAYERS is in GlobalStuff.h, which
-	// needs creg.h. But creg.h needs SyncedPrimitive.h, which needs
-	// SyncDebugger.h. Hence we can't use MAX_PLAYERS in SyncDebugger.h.  :-)
-	checksumResponses = new std::vector&lt;unsigned&gt; [MAX_PLAYERS];
-	remoteHistory     = new std::vector&lt;unsigned&gt; [MAX_PLAYERS];
-	remoteFlop = new Uint64 [MAX_PLAYERS];
 }
 
 
@@ -80,9 +74,6 @@
 {
 	delete[] history;
 	delete[] historybt;
-	delete[] checksumResponses;
-	delete[] remoteHistory;
-	delete[] remoteFlop;
 }
 
 

Modified: branches/caiinterface/rts/System/Sync/SyncDebugger.h
===================================================================
--- branches/caiinterface/rts/System/Sync/SyncDebugger.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/System/Sync/SyncDebugger.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -10,6 +10,8 @@
 #include &lt;vector&gt;
 #include &lt;SDL_types.h&gt;
 
+#include &quot;Game/GlobalConstants.h&quot;
+
 /**
  * @brief sync debugger class
  *
@@ -100,12 +102,12 @@
 
 		// server thread
 
-		std::vector&lt;unsigned&gt;* checksumResponses;    ///&lt; Received checksums after a checkum request.
-		Uint64* remoteFlop;                          ///&lt; Received operation number.
+		std::vector&lt;unsigned&gt; checksumResponses[MAX_PLAYERS];    ///&lt; Received checksums after a checkum request.
+		Uint64 remoteFlop[MAX_PLAYERS];                          ///&lt; Received operation number.
 		std::deque&lt;unsigned&gt; requestedBlocks;        ///&lt; We are processing these blocks.
 		std::deque&lt;unsigned&gt; pendingBlocksToRequest; ///&lt; We still need to receive these blocks (slowly emptied).
 		bool waitingForBlockResponse;                ///&lt; Are we still waiting for a block response?
-		std::vector&lt;unsigned&gt;* remoteHistory;        ///&lt; Chk field of history of clients (only of differing blocks).
+		std::vector&lt;unsigned&gt; remoteHistory[MAX_PLAYERS];        ///&lt; Chk field of history of clients (only of differing blocks).
 
 	private:
 

Modified: branches/caiinterface/rts/System/Sync/SyncedPrimitive.h
===================================================================
--- branches/caiinterface/rts/System/Sync/SyncedPrimitive.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/System/Sync/SyncedPrimitive.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -6,7 +6,9 @@
 #if defined(SYNCDEBUG) || defined(SYNCCHECK)
 
 #include &quot;SyncChecker.h&quot;  // for CSyncedPrimitiveBase (if SYNCCHECK is defined)
-#include &quot;SyncDebugger.h&quot; // for CSyncedPrimitiveBase (if SYNCDEBUG is defined)
+#ifdef SYNCDEBUG
+	#include &quot;SyncDebugger.h&quot; // for CSyncedPrimitiveBase (if SYNCDEBUG is defined)
+#endif // SYNCDEBUG
 #include &quot;SyncedPrimitiveBase.h&quot;
 #include &quot;Upcast.h&quot;       // for UPCAST macro
 

Copied: branches/caiinterface/rts/System/Vec2.h (from rev 6844, trunk/rts/System/Vec2.h)
===================================================================
--- branches/caiinterface/rts/System/Vec2.h	                        (rev 0)
+++ branches/caiinterface/rts/System/Vec2.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -0,0 +1,19 @@
+#ifndef VEC2_H
+#define VEC2_H
+
+
+template&lt;typename T&gt;
+class Vec2
+{
+public:
+	Vec2() {};
+	Vec2(const T nx, const T ny) : x(nx), y(ny) {};
+
+	T x;
+	T y;
+};
+
+typedef Vec2&lt;int&gt; int2;
+typedef Vec2&lt;float&gt; float2;
+
+#endif

Modified: branches/caiinterface/rts/System/float3.h
===================================================================
--- branches/caiinterface/rts/System/float3.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/System/float3.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -480,4 +480,21 @@
 	SAIFloat3 toSAIFloat3() const;
 };
 
+/**
+ * @brief upwards vector
+ *
+ * Defines constant upwards vector
+ * (0,1,0)
+ */
+const float3 UpVector(0,1,0);
+
+/**
+ * @brief zero vector
+ *
+ * Defines constant zero vector
+ * (0,0,0)
+ */
+const float3 ZeroVector(0,0,0);
+
+
 #endif /* FLOAT3_H */

Modified: branches/caiinterface/rts/System/myMath.cpp
===================================================================
--- branches/caiinterface/rts/System/myMath.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/System/myMath.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -4,12 +4,7 @@
 #include &quot;myMath.h&quot;
 #include &quot;mmgr.h&quot;
 
-CR_BIND(float2, );
-CR_REG_METADATA(float2, (CR_MEMBER(x), CR_MEMBER(y)));
 
-CR_BIND(int2, );
-CR_REG_METADATA(int2, (CR_MEMBER(x),CR_MEMBER(y)));
-
 float2 headingToVectorTable[NUM_HEADINGS];
 
 class CMyMath

Modified: branches/caiinterface/rts/System/myMath.h
===================================================================
--- branches/caiinterface/rts/System/myMath.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/System/myMath.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -1,7 +1,9 @@
 #ifndef MYMATH_H
 #define MYMATH_H
 
-#include &quot;GlobalStuff.h&quot;
+#include &quot;Game/GlobalConstants.h&quot;
+#include &quot;Vec2.h&quot;
+#include &quot;float3.h&quot;
 
 #define MaxByAbs(a,b) (abs((a)) &gt; abs((b))) ? (a) : (b);
 

Deleted: branches/caiinterface/rts/System/nommgr.h
===================================================================
--- branches/caiinterface/rts/System/nommgr.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/System/nommgr.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -1,40 +0,0 @@
-// ---------------------------------------------------------------------------------------------------------------------------------
-// Copyright 2000, Paul Nettle. All rights reserved.
-//
-// You are free to use this source code in any commercial or non-commercial product.
-//
-// nommgr.h - Memory manager &amp; tracking software
-//
-// The most recent version of this software can be found at: <A HREF="ftp://ftp.GraphicsPapers.com/pub/ProgrammingTools/MemoryManagers/">ftp://ftp.GraphicsPapers.com/pub/ProgrammingTools/MemoryManagers/</A>
-//
-// [NOTE: Best when viewed with 8-character tabs]
-// ---------------------------------------------------------------------------------------------------------------------------------
-
-#ifdef	new
-#undef	new
-#endif
-
-#ifdef	delete
-#undef	delete
-#endif
-
-#ifdef	malloc
-#undef	malloc
-#endif
-
-#ifdef	calloc
-#undef	calloc
-#endif
-
-#ifdef	realloc
-#undef	realloc
-#endif
-
-#ifdef	free
-#undef	free
-#endif
-
-// ---------------------------------------------------------------------------------------------------------------------------------
-// nommgr.h - End of file
-// ---------------------------------------------------------------------------------------------------------------------------------
-

Modified: branches/caiinterface/rts/build/vstudio8/rts.vcproj
===================================================================
--- branches/caiinterface/rts/build/vstudio8/rts.vcproj	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/rts/build/vstudio8/rts.vcproj	2008-10-22 14:30:10 UTC (rev 6851)
@@ -792,6 +792,18 @@
 				&gt;
 			&lt;/File&gt;
 			&lt;File
+				RelativePath=&quot;..\..\Game\GlobalConstants.h&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
+				RelativePath=&quot;..\..\Game\GlobalSynced.cpp&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
+				RelativePath=&quot;..\..\Game\GlobalSynced.h&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
 				RelativePath=&quot;..\..\Game\Player.cpp&quot;
 				&gt;
 			&lt;/File&gt;
@@ -3652,11 +3664,11 @@
 				&gt;
 			&lt;/File&gt;
 			&lt;File
-				RelativePath=&quot;..\..\System\GlobalStuff.cpp&quot;
+				RelativePath=&quot;..\..\System\GlobalUnsynced.cpp&quot;
 				&gt;
 			&lt;/File&gt;
 			&lt;File
-				RelativePath=&quot;..\..\System\GlobalStuff.h&quot;
+				RelativePath=&quot;..\..\System\GlobalUnsynced.h&quot;
 				&gt;
 			&lt;/File&gt;
 			&lt;File
@@ -3760,10 +3772,6 @@
 				&gt;
 			&lt;/File&gt;
 			&lt;File
-				RelativePath=&quot;..\..\System\nommgr.h&quot;
-				&gt;
-			&lt;/File&gt;
-			&lt;File
 				RelativePath=&quot;..\..\System\Object.cpp&quot;
 				&gt;
 			&lt;/File&gt;
@@ -3947,6 +3955,10 @@
 				RelativePath=&quot;..\..\System\UnsyncedRNG.h&quot;
 				&gt;
 			&lt;/File&gt;
+			&lt;File
+				RelativePath=&quot;..\..\System\Vec2.h&quot;
+				&gt;
+			&lt;/File&gt;
 			&lt;Filter
 				Name=&quot;FileSystem&quot;
 				&gt;

Modified: branches/caiinterface/tools/unitsync/CMakeLists.txt
===================================================================
--- branches/caiinterface/tools/unitsync/CMakeLists.txt	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/tools/unitsync/CMakeLists.txt	2008-10-22 14:30:10 UTC (rev 6851)
@@ -2,7 +2,9 @@
 	set (unitsync_libs glew32 opengl32 glu32 devil ilu python25)
 	set (PYTHONLIBS_FOUND TRUE) # Python libs are part of the mingwlibs package
 	INCLUDE_DIRECTORIES(${MINGWLIBS}/include/python2.5)
+
 	set (JAVA_FOUND TRUE)
+	INCLUDE_DIRECTORIES(${MINGWLIBS}/include/java)
 ELSE (MINGW)
 	FIND_PACKAGE(Freetype REQUIRED)
 	INCLUDE_DIRECTORIES(${FREETYPE_INCLUDE_DIR})

Modified: branches/caiinterface/tools/unitsync/test/test.cpp
===================================================================
--- branches/caiinterface/tools/unitsync/test/test.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/tools/unitsync/test/test.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -2,9 +2,12 @@
 ################################################################################
 file=test.cpp
 
+map=&quot;${1:-Castles.smf}&quot;
+mod=&quot;${2:-ba621.sd7}&quot;
+
 g++ -g -I../../../rts/System $file ../../../game/unitsync.so &amp;&amp; \
-echo ./a.out Castles.smf ba621.sd7 &amp;&amp; \
-./a.out Castles.smf ba621.sd7
+echo ./a.out &quot;$map&quot; &quot;$mod&quot; &amp;&amp; \
+./a.out &quot;$map&quot; &quot;$mod&quot;
 
 exit
 

Modified: branches/caiinterface/tools/unitsync/unitsync.cpp
===================================================================
--- branches/caiinterface/tools/unitsync/unitsync.cpp	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/tools/unitsync/unitsync.cpp	2008-10-22 14:30:10 UTC (rev 6851)
@@ -1046,7 +1046,174 @@
 
 
 static vector&lt;Option&gt; options;
+static set&lt;string&gt; optionsSet;
 
+
+static bool ParseOption(const LuaTable&amp; root, int index, Option&amp; opt)
+{
+	const LuaTable&amp; optTbl = root.SubTable(index);
+	if (!optTbl.IsValid()) {
+		return false;
+	}
+
+	// common options properties
+	std::string opt_key = optTbl.GetString(&quot;key&quot;, &quot;&quot;);
+	if (opt_key.empty() ||
+	    (opt_key.find_first_of(Option_badKeyChars) != std::string::npos)) {
+		return false;
+	}
+	opt_key = StringToLower(opt_key);
+	if (optionsSet.find(opt_key) != optionsSet.end()) {
+		return false;
+	}
+	opt.key = mallocCopyString(opt_key.c_str());
+	
+	std::string opt_name = optTbl.GetString(&quot;name&quot;, opt_key);
+	if (opt_name.empty()) {
+		return false;
+	}
+	opt.name = mallocCopyString(opt_name.c_str());
+	
+	std::string opt_desc = optTbl.GetString(&quot;desc&quot;, opt_name);
+	opt.desc = mallocCopyString(opt_desc.c_str());
+	
+	std::string opt_section = optTbl.GetString(&quot;section&quot;, &quot;&quot;);
+	opt.section = mallocCopyString(opt_section.c_str());
+	
+	std::string opt_style = optTbl.GetString(&quot;style&quot;, &quot;&quot;);
+	opt.style = mallocCopyString(opt_style.c_str());
+
+	std::string opt_type = optTbl.GetString(&quot;type&quot;, &quot;&quot;);
+	opt_type = StringToLower(opt_type);
+	opt.type = mallocCopyString(opt_type.c_str());
+
+	// option type specific properties
+	if (opt_type == &quot;bool&quot;) {
+		opt.typeCode = opt_bool;
+		opt.boolDef = optTbl.GetBool(&quot;def&quot;, false);
+	}
+	else if (opt_type == &quot;number&quot;) {
+		opt.typeCode = opt_number;
+		opt.numberDef  = optTbl.GetFloat(&quot;def&quot;,  0.0f);
+		opt.numberMin  = optTbl.GetFloat(&quot;min&quot;,  -1.0e30f);
+		opt.numberMax  = optTbl.GetFloat(&quot;max&quot;,  +1.0e30f);
+		opt.numberStep = optTbl.GetFloat(&quot;step&quot;, 0.0f);
+	}
+	else if (opt_type == &quot;string&quot;) {
+		opt.typeCode = opt_string;
+		opt.stringDef    = mallocCopyString(optTbl.GetString(&quot;def&quot;, &quot;&quot;).c_str());
+		opt.stringMaxLen = optTbl.GetInt(&quot;maxlen&quot;, 0);
+	}
+	else if (opt_type == &quot;list&quot;) {
+		opt.typeCode = opt_list;
+
+		const LuaTable&amp; listTbl = optTbl.SubTable(&quot;items&quot;);
+		if (!listTbl.IsValid()) {
+			return false;
+		}
+
+		vector&lt;OptionListItem&gt; opt_list;
+		for (int i = 1; listTbl.KeyExists(i); i++) {
+			OptionListItem item;
+
+			// string format
+			std::string item_key = listTbl.GetString(i, &quot;&quot;);
+			if (!item_key.empty() &amp;&amp;
+			    (item_key.find_first_of(Option_badKeyChars) == string::npos)) {
+				item.key = mallocCopyString(item_key.c_str());
+				item.name = item.key;
+				item.desc = item.name;
+				opt_list.push_back(item);
+				continue;
+			}
+
+			// table format  (name &amp; desc)
+			const LuaTable&amp; itemTbl = listTbl.SubTable(i);
+			if (!itemTbl.IsValid()) {
+				break;
+			}
+			item_key = itemTbl.GetString(&quot;key&quot;, &quot;&quot;);
+			if (item_key.empty() ||
+			    (item_key.find_first_of(Option_badKeyChars) != string::npos)) {
+				return false;
+			}
+			item_key = StringToLower(item_key);
+			//item.key = item_key.c_str();
+			item.key = mallocCopyString(item_key.c_str());
+			std::string item_name = itemTbl.GetString(&quot;name&quot;, item_key);
+			if (item_name.empty()) {
+				return false;
+			}
+			//item.name = item_name.c_str();
+			item.name = mallocCopyString(item_name.c_str());
+			std::string item_desc = itemTbl.GetString(&quot;desc&quot;, item_name);
+			//item.desc = item_desc.c_str();
+			item.desc = mallocCopyString(item_desc.c_str());
+			opt_list.push_back(item);
+		}
+
+		if (opt_list.size() &lt;= 0) {
+			return false; // no empty lists
+		}
+		
+		opt.numListItems = opt_list.size();
+		opt.list = (OptionListItem*) calloc(sizeof(OptionListItem), opt.numListItems);
+        for (int i=0; i &lt; opt.numListItems; ++i) {
+            opt.list[i] = opt_list.at(i);
+        }
+
+		//opt.listDef = optTbl.GetString(&quot;def&quot;, opt.list[0].name).c_str();
+		opt.listDef = mallocCopyString(optTbl.GetString(&quot;def&quot;, opt.list[0].name).c_str());
+	}
+	else {
+		return false; // unknown type
+	}
+
+	optionsSet.insert(opt.key);
+
+	return true;
+}
+
+
+static void ParseOptions(const string&amp; fileName,
+                         const string&amp; fileModes,
+                         const string&amp; accessModes,
+                         const string&amp; mapName = &quot;&quot;)
+{
+	LuaParser luaParser(fileName, fileModes, accessModes);
+
+	const string configName = MapParser::GetMapConfigName(mapName);
+
+	if (!mapName.empty() &amp;&amp; !configName.empty()) {
+		luaParser.GetTable(&quot;Map&quot;);
+		luaParser.AddString(&quot;fileName&quot;, mapName);
+		luaParser.AddString(&quot;fullName&quot;, &quot;maps/&quot; + mapName);
+		luaParser.AddString(&quot;configFile&quot;, configName);
+		luaParser.EndTable();
+	}
+
+	if (!luaParser.Execute()) {
+		logOutput.Print(&quot;ParseOptions(%s) ERROR: %s\n&quot;,
+		       fileName.c_str(), luaParser.GetErrorLog().c_str());
+		return;
+	}
+
+	const LuaTable root = luaParser.GetRoot();
+	if (!root.IsValid()) {
+		return;
+	}
+
+	for (int index = 1; root.KeyExists(index); index++) {
+		Option opt;
+		if (ParseOption(root, index, opt)) {
+			options.push_back(opt);
+		}
+	}
+
+	return;
+};
+
+
 static bool InvalidOptionIndex(int optIndex)
 {
 	if ((optIndex &lt; 0) || (optIndex &gt;= (int)options.size())) {
@@ -1068,28 +1235,6 @@
 }
 
 
-vector&lt;InfoItem&gt; infos;
-set&lt;string&gt; infosSet;
-
-std::vector&lt;Option&gt; ParseOptions(
-		const std::string&amp; fileName,
-		const std::string&amp; fileModes,
-		const std::string&amp; accessModes,
-		const std::string&amp; mapName = &quot;&quot;)
-{
-	std::vector&lt;Option&gt; options;
-	
-	static const unsigned int MAX_OPTIONS = 128;
-	Option tmpOptions[MAX_OPTIONS];
-	unsigned int num = ParseOptions(fileName.c_str(), fileModes.c_str(),
-			accessModes.c_str(), mapName.c_str(), tmpOptions, MAX_OPTIONS);
-	for (unsigned int i=0; i &lt; num; ++i) {
-		options.push_back(tmpOptions[i]);
-	}
-	
-	return options;
-}
-
 Export(int) GetMapOptionCount(const char* name)
 {
 	CHECK_INIT();
@@ -1097,19 +1242,36 @@
 
 	ScopedMapLoader mapLoader(name);
 
-	options = ParseOptions(&quot;MapOptions.lua&quot;, SPRING_VFS_MAP, SPRING_VFS_MAP, name);
+	options.clear();
+	optionsSet.clear();
 
+	ParseOptions(&quot;MapOptions.lua&quot;, SPRING_VFS_MAP, SPRING_VFS_MAP, name);
+
+	optionsSet.clear();
+
 	return (int)options.size();
 }
 
 
 Export(int) GetModOptionCount()
 {
-	options = ParseOptions(&quot;ModOptions.lua&quot;, SPRING_VFS_MOD, SPRING_VFS_MOD);
+	options.clear();
+	optionsSet.clear();
+
+	// EngineOptions must be read first, so accidentally &quot;overloading&quot; engine
+	// options with mod options with identical names is not possible.
+	ParseOptions(&quot;EngineOptions.lua&quot;, SPRING_VFS_MOD_BASE, SPRING_VFS_MOD_BASE);
+	ParseOptions(&quot;ModOptions.lua&quot;, SPRING_VFS_MOD, SPRING_VFS_MOD);
+
+	optionsSet.clear();
+
 	return (int)options.size();
 }
 
 
+vector&lt;InfoItem&gt; infos;
+set&lt;string&gt; infosSet;
+
 // Updated on every call to GetSkirmishAICount
 static vector&lt;string&gt; skirmishAIDataDirs;
 
@@ -1192,11 +1354,15 @@
 }
 
 
+Export(int) GetSkirmishAIOptionCount(int index) {
 
-Export(int) GetSkirmishAIOptionCount(int index) {
-	
-	ASSERT(!skirmishAIDataDirs.empty(), &quot;Call GetSkirmishAICount before GetSkirmishAIOptionCount.&quot;);
-	options = ParseOptions(skirmishAIDataDirs[index] + &quot;/AIOptions.lua&quot;, SPRING_VFS_RAW, SPRING_VFS_RAW);
+	options.clear();
+	optionsSet.clear();
+
+	ParseOptions(skirmishAIDataDirs[index] + &quot;/AIOptions.lua&quot;, SPRING_VFS_RAW, SPRING_VFS_RAW);
+
+	optionsSet.clear();
+
 	return (int)options.size();
 }
 
@@ -1261,6 +1427,8 @@
 }
 
 
+// Number Options
+
 Export(float) GetOptionNumberDef(int optIndex)
 {
 	if (WrongOptionType(optIndex, opt_number)) {
@@ -1297,6 +1465,8 @@
 }
 
 
+// String Options
+
 Export(const char*) GetOptionStringDef(int optIndex)
 {
 	if (WrongOptionType(optIndex, opt_string)) {
@@ -1315,6 +1485,8 @@
 }
 
 
+// List Options
+
 Export(int) GetOptionListCount(int optIndex)
 {
 	if (WrongOptionType(optIndex, opt_list)) {
@@ -1491,6 +1663,7 @@
 //////////////////////////
 //////////////////////////
 
+// Map the wanted archives into the VFS with AddArchive before using these functions
 
 static map&lt;int, CFileHandler*&gt; openFiles;
 static int nextFile = 0;

Modified: branches/caiinterface/tools/unitsync/unitsync_api.h
===================================================================
--- branches/caiinterface/tools/unitsync/unitsync_api.h	2008-10-22 14:25:11 UTC (rev 6850)
+++ branches/caiinterface/tools/unitsync/unitsync_api.h	2008-10-22 14:30:10 UTC (rev 6851)
@@ -4,8 +4,7 @@
 #include &quot;unitsync.h&quot;
 
 
-/******************************************************************************/
-/******************************************************************************/
+// from unitsync.cpp:
 
 Export(const char*) GetSpringVersion();
 
@@ -33,6 +32,7 @@
 Export(void) AddArchive(const char* name);
 Export(void) AddAllArchives(const char* root);
 Export(unsigned int) GetArchiveChecksum(const char* arname);
+Export(const char*) GetArchivePath(const char* arname);
 
 Export(int) GetMapCount();
 Export(const char*) GetMapName(int index);
@@ -41,6 +41,7 @@
 Export(int) GetMapArchiveCount(const char* mapName);
 Export(const char*) GetMapArchiveName(int index);
 Export(unsigned int) GetMapChecksum(int index);
+Export(unsigned int) GetMapChecksumFromName(const char* mapName);
 Export(void*) GetMinimap(const char* filename, int miplevel);
 Export(int) GetInfoMapSize(const char* filename, const char* name, int* width, int* height);
 Export(int) GetInfoMap(const char* filename, const char* name, void* data, int typeHint);
@@ -57,11 +58,15 @@
 Export(const char*) GetPrimaryModShortName(int index);
 Export(const char*) GetPrimaryModVersion(int index);
 Export(const char*) GetPrimaryModMutator(int index);
+Export(const char*) GetPrimaryModGame(int index);
+Export(const char*) GetPrimaryModShortGame(int index);
+Export(const char*) GetPrimaryModDescription(int index);
 Export(const char*) GetPrimaryModArchive(int index);
 Export(int) GetPrimaryModArchiveCount(int index);
 Export(const char*) GetPrimaryModArchiveList(int arnr);
 Export(int) GetPrimaryModIndex(const char* name);
 Export(unsigned int) GetPrimaryModChecksum(int index);
+Export(unsigned int) GetPrimaryModChecksumFromName(const char* name);
 
 Export(int) GetSideCount();
 Export(const char*) GetSideName(int side);
@@ -101,12 +106,8 @@
 Export(int) FileSizeVFS(int handle);
 
 Export(int) InitFindVFS(const char* pattern);
-Export(int) InitDirListVFS(const char* path,
-                                                 const char* pattern,
-                                                 const char* modes);
-Export(int) InitSubDirsVFS(const char* path,
-                                                 const char* pattern,
-                                                 const char* modes);
+Export(int) InitDirListVFS(const char* path, const char* pattern, const char* modes);
+Export(int) InitSubDirsVFS(const char* path, const char* pattern, const char* modes);
 Export(int) FindFilesVFS(int handle, char* nameBuf, int size);
 
 Export(int) OpenArchive(const char* name);
@@ -118,12 +119,19 @@
 Export(void) CloseArchiveFile(int archive, int handle);
 Export(int) SizeArchiveFile(int archive, int handle);
 
+Export(const char*) GetSpringConfigString(const char* name, const char* defvalue);
+Export(int) GetSpringConfigInt(const char* name, const int defvalue);
+Export(float) GetSpringConfigFloat( const char* name, const float defvalue );
+Export(void) SetSpringConfigString(const char* name, const char* value);
+Export(void) SetSpringConfigInt(const char* name, const int value);
+Export(void) SetSpringConfigFloat(const char* name, const float value);
+
+
+// from LuaParserAPI.cpp:
+
 Export(void) lpClose();
-Export(int) lpOpenFile(const char* filename,
-                                            const char* fileModes,
-                                            const char* accessModes);
-Export(int) lpOpenSource(const char* source,
-                                              const char* accessModes);
+Export(int) lpOpenFile(const char* filename, const char* fileModes, const char* accessModes);
+Export(int) lpOpenSource(const char* source, const char* accessModes);
 Export(int) lpExecute();
 Export(const char*) lpErrorLog();
 


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001619.html">[Taspring-linux-commit] r6850 - in Lobby/springie/Springie: .	downloader spring
</A></li>
	<LI>Next message: <A HREF="001621.html">[Taspring-linux-commit] r6852 - Lobby/TASClient
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1620">[ date ]</a>
              <a href="thread.html#1620">[ thread ]</a>
              <a href="subject.html#1620">[ subject ]</a>
              <a href="author.html#1620">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
