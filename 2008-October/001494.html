<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r6725 - in branches/caiinterface:	AI/Interfaces/C AI/Skirmish/AAI AI/Skirmish/KAIK	Documentation game/AI/AAI game/AI/AAI/cfg/mod rts/ExternalAI	rts/Sim/MoveTypes rts/Sim/Units rts/Sim/Units/CommandAI	rts/System/Net
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-October/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6725%20-%20in%20branches/caiinterface%3A%0A%09AI/Interfaces/C%20AI/Skirmish/AAI%20AI/Skirmish/KAIK%0A%09Documentation%20game/AI/AAI%20game/AI/AAI/cfg/mod%20rts/ExternalAI%0A%09rts/Sim/MoveTypes%20rts/Sim/Units%20rts/Sim/Units/CommandAI%0A%09rts/System/Net&In-Reply-To=%3C20081014172657.9F13C4730%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001493.html">
   <LINK REL="Next"  HREF="001495.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r6725 - in branches/caiinterface:	AI/Interfaces/C AI/Skirmish/AAI AI/Skirmish/KAIK	Documentation game/AI/AAI game/AI/AAI/cfg/mod rts/ExternalAI	rts/Sim/MoveTypes rts/Sim/Units rts/Sim/Units/CommandAI	rts/System/Net</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6725%20-%20in%20branches/caiinterface%3A%0A%09AI/Interfaces/C%20AI/Skirmish/AAI%20AI/Skirmish/KAIK%0A%09Documentation%20game/AI/AAI%20game/AI/AAI/cfg/mod%20rts/ExternalAI%0A%09rts/Sim/MoveTypes%20rts/Sim/Units%20rts/Sim/Units/CommandAI%0A%09rts/System/Net&In-Reply-To=%3C20081014172657.9F13C4730%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r6725 - in branches/caiinterface:	AI/Interfaces/C AI/Skirmish/AAI AI/Skirmish/KAIK	Documentation game/AI/AAI game/AI/AAI/cfg/mod rts/ExternalAI	rts/Sim/MoveTypes rts/Sim/Units rts/Sim/Units/CommandAI	rts/System/Net">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Tue Oct 14 19:26:57 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001493.html">[Taspring-linux-commit] r6724 - in trunk/rts/Sim: MoveTypes Units	Units/CommandAI
</A></li>
        <LI>Next message: <A HREF="001495.html">[Taspring-linux-commit] r6726 - trunk/rts/Sim/MoveTypes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1494">[ date ]</a>
              <a href="thread.html#1494">[ thread ]</a>
              <a href="subject.html#1494">[ subject ]</a>
              <a href="author.html#1494">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: hoijui
Date: 2008-10-14 19:26:56 +0200 (Tue, 14 Oct 2008)
New Revision: 6725

Added:
   branches/caiinterface/game/AI/AAI/cfg/mod/S44_Installer_Version.cfg
Removed:
   branches/caiinterface/game/AI/AAI/cfg/mod/1944DemoReleasev0.01b.cfg
   branches/caiinterface/game/AI/AAI/cfg/mod/1944publicalpha_v0.01b3d.cfg
   branches/caiinterface/game/AI/AAI/cfg/mod/BA58.cfg
   branches/caiinterface/game/AI/AAI/cfg/mod/BA591.cfg
   branches/caiinterface/game/AI/AAI/cfg/mod/BA60.cfg
   branches/caiinterface/game/AI/AAI/cfg/mod/BA621.cfg
   branches/caiinterface/game/AI/AAI/cfg/mod/FleabowlNR10.cfg
   branches/caiinterface/game/AI/AAI/cfg/mod/S44LiteRelease.cfg
Modified:
   branches/caiinterface/AI/Interfaces/C/InterfaceExport.cpp
   branches/caiinterface/AI/Skirmish/AAI/
   branches/caiinterface/AI/Skirmish/AAI/AAI ReadMe.txt
   branches/caiinterface/AI/Skirmish/AAI/AAIBrain.cpp
   branches/caiinterface/AI/Skirmish/AAI/AAIBuildTable.cpp
   branches/caiinterface/AI/Skirmish/AAI/AAIBuildTable.h
   branches/caiinterface/AI/Skirmish/AAI/AAIConfig.h
   branches/caiinterface/AI/Skirmish/AAI/AAIConstructor.cpp
   branches/caiinterface/AI/Skirmish/AAI/AAIConstructor.h
   branches/caiinterface/AI/Skirmish/AAI/AAIExecute.cpp
   branches/caiinterface/AI/Skirmish/AAI/AAIExecute.h
   branches/caiinterface/AI/Skirmish/AAI/AAIGroup.cpp
   branches/caiinterface/AI/Skirmish/AAI/AAIGroup.h
   branches/caiinterface/AI/Skirmish/AAI/AAIMap.cpp
   branches/caiinterface/AI/Skirmish/AAI/AAISector.cpp
   branches/caiinterface/AI/Skirmish/AAI/AAISector.h
   branches/caiinterface/AI/Skirmish/AAI/aidef.h
   branches/caiinterface/AI/Skirmish/KAIK/
   branches/caiinterface/AI/Skirmish/KAIK/BuildUp.cpp
   branches/caiinterface/AI/Skirmish/KAIK/DGunController.cpp
   branches/caiinterface/AI/Skirmish/KAIK/DGunController.hpp
   branches/caiinterface/AI/Skirmish/KAIK/Defines.h
   branches/caiinterface/AI/Skirmish/KAIK/GlobalAI.cpp
   branches/caiinterface/AI/Skirmish/KAIK/GlobalAI.h
   branches/caiinterface/AI/Skirmish/KAIK/SunParser.cpp
   branches/caiinterface/AI/Skirmish/KAIK/Unit.cpp
   branches/caiinterface/AI/Skirmish/KAIK/Unit.h
   branches/caiinterface/AI/Skirmish/KAIK/UnitHandler.cpp
   branches/caiinterface/AI/Skirmish/KAIK/UnitTable.cpp
   branches/caiinterface/Documentation/changelog.txt
   branches/caiinterface/game/AI/AAI/AAI FAQ.txt
   branches/caiinterface/game/AI/AAI/AAI ReadMe.txt
   branches/caiinterface/game/AI/AAI/cfg/mod/BA_Installer_Version.cfg
   branches/caiinterface/game/AI/AAI/cfg/mod/XTA_Installer_Version.cfg
   branches/caiinterface/rts/ExternalAI/AIInterfaceLibrary.cpp
   branches/caiinterface/rts/ExternalAI/AIInterfaceLibrary.h
   branches/caiinterface/rts/Sim/MoveTypes/AirMoveType.cpp
   branches/caiinterface/rts/Sim/Units/CommandAI/MobileCAI.cpp
   branches/caiinterface/rts/Sim/Units/Unit.cpp
   branches/caiinterface/rts/System/Net/UDPConnection.h
Log:
* reintegrated trunk up to 6724
* now issuing warnings when static initialization or release of an AI Interface library fails

Modified: branches/caiinterface/AI/Interfaces/C/InterfaceExport.cpp
===================================================================
--- branches/caiinterface/AI/Interfaces/C/InterfaceExport.cpp	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/AI/Interfaces/C/InterfaceExport.cpp	2008-10-14 17:26:56 UTC (rev 6725)
@@ -79,7 +79,7 @@
 }
 */
 Export(const struct SGAILibrary*) loadGroupAILibrary(
-const struct InfoItem info[], unsigned int numInfoItems) {
+		const struct InfoItem info[], unsigned int numInfoItems) {
 	return myInterface-&gt;LoadGroupAILibrary(info, numInfoItems);
 }
 Export(int) unloadGroupAILibrary(const struct SGAISpecifier* const gAISpecifier) {


Property changes on: branches/caiinterface/AI/Skirmish/AAI
___________________________________________________________________
Name: svn:mergeinfo
   - 

Modified: branches/caiinterface/AI/Skirmish/AAI/AAI ReadMe.txt
===================================================================
--- branches/caiinterface/AI/Skirmish/AAI/AAI ReadMe.txt	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/AI/Skirmish/AAI/AAI ReadMe.txt	2008-10-14 17:26:56 UTC (rev 6725)
@@ -1,4 +1,5 @@
-Author: 	Alexander 'submarine' Seizinger		icq: 138100896		<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">alexander.seizinger at gmx.net</A>
+Author: 	Alexander 		Icq: 138100896					email:	alexander.seizinger
+		Seizinger		Jabber: <A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">alexander.seizinger at jabber.org</A>				@gmx.net
 
 
 Installation: 	Windows users:
@@ -105,15 +106,20 @@
 		- Brandon Potter for his TBT 12 cfg file
 
 
+
+AAI v0.872	- Refactored code for getting rally points and positions to withdraw units and made 
+
+		- Construction units that are member of the DONT_BUILD list will not be built anymore
+		
+		- Fixed two bugs that have been introduced in v0.87 and could cripple AAI's economy a lot
+
+
 AAI v0.87	- Proper detection of amphibious ground units (was causing AAI to freeze on water maps)
 
 		- Prevent AAI from blocking buildqueues for combat units by requesting too many scouts
 
+		- Added proper handling of resurrected units (however AAI does not build resurrectors atm)	
 
-AAI v0.869	- Added proper handling of resurrected units (however AAI does not build resurrectors atm)
-		
-		- Fixed a bug that could prevent AAI from rebuilding destroyed factories	
-
 		- Added some unit specific combat behaviour: Units with high ranged weapons  will now try to keep enemies distant (if 
 		  their turnrate is not too low)
 
@@ -140,6 +146,7 @@
 
 		- Fixed various freezes that have been caused by AAI flooding the ai interface with thousands of orders per frame
 
+		- Fixed a bug that could prevent AAI from rebuilding destroyed factories
 
 		- Bumped mod learning file version to 0.86 due to some changes in handling of amphibious units
 

Modified: branches/caiinterface/AI/Skirmish/AAI/AAIBrain.cpp
===================================================================
--- branches/caiinterface/AI/Skirmish/AAI/AAIBrain.cpp	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/AI/Skirmish/AAI/AAIBrain.cpp	2008-10-14 17:26:56 UTC (rev 6725)
@@ -198,7 +198,7 @@
 					// possible scout dest, try to find pos in sector
 					pos = ZeroVector;
 
-					sector-&gt;GetMovePos(&amp;pos, scout_movement_type, continent); 
+					sector-&gt;GetMovePosOnContinent(&amp;pos, scout_movement_type, continent); 
 					
 					if(pos.x &gt; 0)
 					{

Modified: branches/caiinterface/AI/Skirmish/AAI/AAIBuildTable.cpp
===================================================================
--- branches/caiinterface/AI/Skirmish/AAI/AAIBuildTable.cpp	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/AI/Skirmish/AAI/AAIBuildTable.cpp	2008-10-14 17:26:56 UTC (rev 6725)
@@ -2598,7 +2598,7 @@
 void AAIBuildTable::CalcBuildTree(int unit)
 {
 	// go through all possible build options and set side if necessary
-	for(list&lt;int&gt;::iterator i = units_static[unit].canBuildList.begin(); i != units_static[unit].canBuildList.end(); i++)
+	for(list&lt;int&gt;::iterator i = units_static[unit].canBuildList.begin(); i != units_static[unit].canBuildList.end(); ++i)
 	{
 		// add this unit to targets builtby-list
 		units_static[*i].builtByList.push_back(unit);
@@ -2608,7 +2608,7 @@
 			units_static[*i].builder_cost = units_static[unit].cost;
 
 		// continue with all builldoptions (if they have not been visited yet)
-		if(!units_static[*i].side)
+		if(!units_static[*i].side &amp;&amp; AllowedToBuild(*i))
 		{
 			// unit has not been checked yet, set side as side of its builder and continue 
 			units_static[*i].side = units_static[unit].side;

Modified: branches/caiinterface/AI/Skirmish/AAI/AAIBuildTable.h
===================================================================
--- branches/caiinterface/AI/Skirmish/AAI/AAIBuildTable.h	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/AI/Skirmish/AAI/AAIBuildTable.h	2008-10-14 17:26:56 UTC (rev 6725)
@@ -1,3 +1,12 @@
+// -------------------------------------------------------------------------
+// AAI
+//
+// A skirmish AI for the TA Spring engine.
+// Copyright Alexander Seizinger
+// 
+// Released under GPL license: see LICENSE.html for more information.
+// -------------------------------------------------------------------------
+
 #pragma once
 
 class AAI;

Modified: branches/caiinterface/AI/Skirmish/AAI/AAIConfig.h
===================================================================
--- branches/caiinterface/AI/Skirmish/AAI/AAIConfig.h	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/AI/Skirmish/AAI/AAIConfig.h	2008-10-14 17:26:56 UTC (rev 6725)
@@ -1,3 +1,12 @@
+// -------------------------------------------------------------------------
+// AAI
+//
+// A skirmish AI for the TA Spring engine.
+// Copyright Alexander Seizinger
+// 
+// Released under GPL license: see LICENSE.html for more information.
+// -------------------------------------------------------------------------
+
 #pragma once
 
 

Modified: branches/caiinterface/AI/Skirmish/AAI/AAIConstructor.cpp
===================================================================
--- branches/caiinterface/AI/Skirmish/AAI/AAIConstructor.cpp	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/AI/Skirmish/AAI/AAIConstructor.cpp	2008-10-14 17:26:56 UTC (rev 6725)
@@ -110,8 +110,6 @@
 					construction_def_id = def_id;
 					task = BUILDING;
 
-					++ai-&gt;futureUnits[cat];
-
 					//if(bt-&gt;IsFactory(def_id))
 					//	++ai-&gt;futureFactories;
 
@@ -568,7 +566,7 @@
 		
 
 		// get safe position
-		pos = ai-&gt;execute-&gt;GetSafePos(def_id);
+		pos = ai-&gt;execute-&gt;GetSafePos(def_id, pos);
 
 		if(pos.x &gt; 0)
 		{

Modified: branches/caiinterface/AI/Skirmish/AAI/AAIConstructor.h
===================================================================
--- branches/caiinterface/AI/Skirmish/AAI/AAIConstructor.h	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/AI/Skirmish/AAI/AAIConstructor.h	2008-10-14 17:26:56 UTC (rev 6725)
@@ -1,3 +1,12 @@
+// -------------------------------------------------------------------------
+// AAI
+//
+// A skirmish AI for the TA Spring engine.
+// Copyright Alexander Seizinger
+// 
+// Released under GPL license: see LICENSE.html for more information.
+// -------------------------------------------------------------------------
+
 #pragma once
 
 #include &quot;aidef.h&quot;

Modified: branches/caiinterface/AI/Skirmish/AAI/AAIExecute.cpp
===================================================================
--- branches/caiinterface/AI/Skirmish/AAI/AAIExecute.cpp	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/AI/Skirmish/AAI/AAIExecute.cpp	2008-10-14 17:26:56 UTC (rev 6725)
@@ -252,9 +252,16 @@
 {
 	UnitType unit_type = bt-&gt;GetUnitType(def_id);
 
+	// determine continent if necessary
+	int continent_id = -1;
+
+	if(bt-&gt;units_static[def_id].movement_type &amp; MOVE_TYPE_CONTINENT_BOUND) 
+		continent_id = map-&gt;GetContinentID(&amp;cb-&gt;GetUnitPos(unit_id));
+
+	// try to add unit to an existing group 
 	for(list&lt;AAIGroup*&gt;::iterator group = ai-&gt;group_list[category].begin(); group != ai-&gt;group_list[category].end(); ++group)
 	{
-		if((*group)-&gt;AddUnit(unit_id, def_id, unit_type))
+		if((*group)-&gt;AddUnit(unit_id, def_id, unit_type, continent_id))
 		{
 			ai-&gt;ut-&gt;units[unit_id].group = *group;
 			return;
@@ -262,21 +269,16 @@
 	}
 
 	// end of grouplist has been reached and unit has not been assigned to any group
-	// -&gt; create newone
-	AAIGroup *new_group;
+	// -&gt; create new one
 
-	try
-	{
-		new_group = new AAIGroup(cb, ai, bt-&gt;unitList[def_id-1], unit_type);
-	}
-	catch(...) //catches everything
-	{
-		fprintf(ai-&gt;file, &quot;Exception thrown when allocating memory for new group&quot;);
-		return;
-	}
+	// get continent for ground assault units, even if they are amphibious (otherwise non amphib ground units will be added no matter which continent they are on)
+	if(category == GROUND_ASSAULT  &amp;&amp; continent_id == 1)
+		continent_id = map-&gt;GetContinentID(&amp;cb-&gt;GetUnitPos(unit_id));
 
+	AAIGroup *new_group = new AAIGroup(ai, bt-&gt;unitList[def_id-1], unit_type, continent_id);
+
 	ai-&gt;group_list[category].push_back(new_group);
-	new_group-&gt;AddUnit(unit_id, def_id, unit_type);
+	new_group-&gt;AddUnit(unit_id, def_id, unit_type, continent_id);
 	ai-&gt;ut-&gt;units[unit_id].group = new_group;
 }
 
@@ -681,74 +683,96 @@
 	}
 }
 
-float3 AAIExecute::GetRallyPoint(unsigned int unit_movement_type, int min_dist, int max_dist)
+float3 AAIExecute::GetRallyPoint(unsigned int unit_movement_type, int continent_id, int min_dist, int max_dist)
 {
 	float3 pos;
 
-	// check neighbouring sectors
-	for(int i = min_dist; i &lt;= max_dist; ++i)
+	// continent bound units must get a rally point on their current continent
+	if(unit_movement_type &amp; MOVE_TYPE_CONTINENT_BOUND)
 	{
-		if(unit_movement_type &amp; MOVE_TYPE_GROUND)
-			brain-&gt;sectors[i].sort(suitable_for_ground_rallypoint);
-		else if(unit_movement_type &amp; MOVE_TYPE_SEA)
-			brain-&gt;sectors[i].sort(suitable_for_sea_rallypoint);
-		else 
-			brain-&gt;sectors[i].sort(suitable_for_all_rallypoint);
+		// check neighbouring sectors
+		for(int i = min_dist; i &lt;= max_dist; ++i)
+		{
+			if(unit_movement_type &amp; MOVE_TYPE_GROUND)
+				brain-&gt;sectors[i].sort(suitable_for_ground_rallypoint);
+			else if(unit_movement_type &amp; MOVE_TYPE_SEA)
+				brain-&gt;sectors[i].sort(suitable_for_sea_rallypoint);
 
-		for(list&lt;AAISector*&gt;::iterator sector = brain-&gt;sectors[i].begin(); sector != brain-&gt;sectors[i].end(); sector++)
+			for(list&lt;AAISector*&gt;::iterator sector = brain-&gt;sectors[i].begin(); sector != brain-&gt;sectors[i].end(); ++sector)
+			{
+				(*sector)-&gt;GetMovePosOnContinent(&amp;pos, unit_movement_type, continent_id);
+
+				if(pos.x &gt; 0)
+					return pos;
+			}
+		}
+	}
+	else // non continent bound units may get rally points at any pos (sea or ground)
+	{
+		// check neighbouring sectors
+		for(int i = min_dist; i &lt;= max_dist; ++i)
 		{
-			pos = (*sector)-&gt;GetMovePos(unit_movement_type);
+			brain-&gt;sectors[i].sort(suitable_for_all_rallypoint);
 
-			if(pos.x &gt; 0)
-				return pos;
+			for(list&lt;AAISector*&gt;::iterator sector = brain-&gt;sectors[i].begin(); sector != brain-&gt;sectors[i].end(); ++sector)
+			{
+				(*sector)-&gt;GetMovePos(&amp;pos);
+
+				if(pos.x &gt; 0)
+					return pos;
+			}
 		}
 	}
 
 	return ZeroVector;	
 }
 
-float3 AAIExecute::GetRallyPointCloseTo(UnitCategory category, unsigned int unit_movement_type, float3 pos, int min_dist, int max_dist)
+float3 AAIExecute::GetRallyPointCloseTo(UnitCategory category, unsigned int unit_movement_type, int continent_id, float3 pos, int min_dist, int max_dist)
 {
-	//float3 pos;
+	float3 move_pos;
+	
 
-	// check neighbouring sectors
-	for(int i = min_dist; i &lt;= max_dist; ++i)
+	if(unit_movement_type &amp; MOVE_TYPE_CONTINENT_BOUND)
 	{
-		if(unit_movement_type &amp; MOVE_TYPE_GROUND)
-			brain-&gt;sectors[i].sort(suitable_for_ground_rallypoint);
-		else if(unit_movement_type &amp; MOVE_TYPE_SEA)
-			brain-&gt;sectors[i].sort(suitable_for_sea_rallypoint);
-		else 
-			brain-&gt;sectors[i].sort(suitable_for_all_rallypoint);
+		for(int i = min_dist; i &lt;= max_dist; ++i)
+		{
+			if(unit_movement_type &amp; MOVE_TYPE_GROUND)
+				brain-&gt;sectors[i].sort(suitable_for_ground_rallypoint);
+			else if(unit_movement_type &amp; MOVE_TYPE_SEA)
+				brain-&gt;sectors[i].sort(suitable_for_sea_rallypoint);
 
-		for(list&lt;AAISector*&gt;::iterator sector = brain-&gt;sectors[i].begin(); sector != brain-&gt;sectors[i].end(); sector++)
+			for(list&lt;AAISector*&gt;::iterator sector = brain-&gt;sectors[i].begin(); sector != brain-&gt;sectors[i].end(); ++sector)
+			{
+				(*sector)-&gt;GetMovePosOnContinent(&amp;move_pos, unit_movement_type, continent_id);
+
+				if(move_pos.x &gt; 0)
+					return move_pos;
+			}
+		}
+	}
+	else
+	{
+		for(int i = min_dist; i &lt;= max_dist; ++i)
 		{
-			pos = (*sector)-&gt;GetMovePos(unit_movement_type);
+			brain-&gt;sectors[i].sort(suitable_for_all_rallypoint);
 
-			if(pos.x &gt; 0)
-				return pos;
+			for(list&lt;AAISector*&gt;::iterator sector = brain-&gt;sectors[i].begin(); sector != brain-&gt;sectors[i].end(); ++sector)
+			{
+				(*sector)-&gt;GetMovePos(&amp;move_pos);
+
+				if(move_pos.x &gt; 0)
+					return move_pos;
+			}
 		}
 	}
 
+
 	return ZeroVector;	
 
 	/*AAISector* best_sector = 0;
 	float best_rating = 0, my_rating;
 	float3 center;
 
-	int combat_cat = bt-&gt;GetIDOfAssaultCategory(category);
-
-	bool land = true; 
-	bool water = true;
-
-	if(!cfg-&gt;AIR_ONLY_MOD)
-	{
-		if(category == GROUND_ASSAULT)
-			water = false;
-		else if(category == SEA_ASSAULT || category == SUBMARINE_ASSAULT)
-			land = false;
-	}	
-
 	// check neighbouring sectors
 	for(int i = min_dist; i &lt;= max_dist; i++)
 	{
@@ -962,12 +986,14 @@
 						builder-&gt;GiveConstructionOrder(mex, spot-&gt;pos, water);
 						spot-&gt;occupied = true;
 					}
+					else //try to request more builders if none available	
+						bt-&gt;AddBuilder(mex);
 				}
 			}
 			else
 			{	
 				// check mex upgrade
-				if(ai-&gt;futureUnits[EXTRACTOR] + ai-&gt;requestedUnits[EXTRACTOR] &lt; 1)
+				if(ai-&gt;futureUnits[EXTRACTOR] + ai-&gt;requestedUnits[EXTRACTOR] + ai-&gt;requestedUnits[EXTRACTOR] &lt; 1)
 					CheckMexUpgrade();
 
 				// request metal makers if no spot found
@@ -2595,7 +2621,7 @@
 
 		if(status == BUILDORDER_NOBUILDER)
 		{
-			float temp = 0.05 + 2.0 / ( (float) first-&gt;defences.size() + 0.5f); 
+			float temp = 0.05f + 1.5f / ( (float) first-&gt;defences.size() + 0.5f); 
 
 			if(urgency[STATIONARY_DEF] &lt; temp)
 				urgency[STATIONARY_DEF] = temp;
@@ -3419,7 +3445,6 @@
 					best_rating = my_rating;
 				}
 			}
-
 		}
 	}
 
@@ -3579,54 +3604,49 @@
 	}
 }
 
-float3 AAIExecute::GetSafePos(int def_id)
+float3 AAIExecute::GetSafePos(int def_id, float3 unit_pos)
 {
-	// determine if land or water pos needed
-	bool land = false;
-	bool water = false;
+	float3 best_pos = ZeroVector;
+	float my_rating, best_rating = 10000.0f;
 
-	if(cfg-&gt;AIR_ONLY_MOD)
+	if(bt-&gt;units_static[def_id].movement_type &amp; MOVE_TYPE_CONTINENT_BOUND)
 	{
-		land = true; 
-		water = true;
-	}
-	else
-	{
-		if(bt-&gt;unitList[def_id-1]-&gt;movedata)
+		// get continent id of the unit pos 
+		float3 pos;
+		int cont_id = map-&gt;GetContinentID(&amp;unit_pos);
+
+		for(list&lt;AAISector*&gt;::iterator sector = brain-&gt;sectors[0].begin(); sector != brain-&gt;sectors[0].end(); ++sector)
 		{
-			if(bt-&gt;unitList[def_id-1]-&gt;movedata-&gt;moveType == MoveData::Ground_Move)
-				land = true;
-			else if(bt-&gt;unitList[def_id-1]-&gt;movedata-&gt;moveType == MoveData::Ship_Move)
-				water = true;
-			else // hover 
+			pos = (*sector)-&gt;GetCenter();
+
+			if(map-&gt;GetContinentID(&amp;pos) == cont_id)
 			{
-				land = true; 
-				water = true;
+				my_rating = (*sector)-&gt;threat - (*sector)-&gt;GetMapBorderDist();
+
+				if((*sector)-&gt;threat &lt; best_rating)
+				{
+					best_rating = my_rating;
+					best_pos = pos;
+				}
 			}
 		}
-		else // air
-		{
-			land = true; 
-			water = true;
-		}
+
 	}
-
-	return GetSafePos(land, water);
-}
-
-float3 AAIExecute::GetSafePos(bool land, bool water)
-{
-	// check all base sectors
-	for(list&lt;AAISector*&gt;::iterator sector = brain-&gt;sectors[0].begin(); sector != brain-&gt;sectors[0].end(); ++sector)
+	else // non continent bound movement types (air, hover, amphibious)
 	{
-		if((*sector)-&gt;threat &lt; 1)
+		for(list&lt;AAISector*&gt;::iterator sector = brain-&gt;sectors[0].begin(); sector != brain-&gt;sectors[0].end(); ++sector)
 		{
-			if( (land &amp;&amp; (*sector)-&gt;water_ratio &lt; 0.7) || (water &amp;&amp; (*sector)-&gt;water_ratio &gt; 0.35)) 
-				return (*sector)-&gt;GetCenter();
+			my_rating = (*sector)-&gt;threat - (*sector)-&gt;GetMapBorderDist();
+
+			if((*sector)-&gt;threat &lt; best_rating)
+			{
+				best_rating = my_rating;
+				best_pos = (*sector)-&gt;GetCenter();
+			}
 		}
 	}
 
-	return ZeroVector;
+	return best_pos;
 }
 
 void AAIExecute::ChooseDifferentStartingSector(int x, int y)
@@ -3762,8 +3782,8 @@
 {
 	++issued_orders;
 
-	if(issued_orders%50 == 0)
-		fprintf(ai-&gt;file, &quot;%i th order has been given by %s in frame %i\n&quot;, issued_orders, owner,  cb-&gt;GetCurrentFrame());
+	//if(issued_orders%50 == 0)
+	//	fprintf(ai-&gt;file, &quot;%i th order has been given by %s in frame %i\n&quot;, issued_orders, owner,  cb-&gt;GetCurrentFrame());
 
 	cb-&gt;GiveOrder(unit, c);
-}
+}
\ No newline at end of file

Modified: branches/caiinterface/AI/Skirmish/AAI/AAIExecute.h
===================================================================
--- branches/caiinterface/AI/Skirmish/AAI/AAIExecute.h	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/AI/Skirmish/AAI/AAIExecute.h	2008-10-14 17:26:56 UTC (rev 6725)
@@ -1,3 +1,12 @@
+// -------------------------------------------------------------------------
+// AAI
+//
+// A skirmish AI for the TA Spring engine.
+// Copyright Alexander Seizinger
+// 
+// Released under GPL license: see LICENSE.html for more information.
+// -------------------------------------------------------------------------
+
 #pragma once
 
 #include &quot;AAI.h&quot;
@@ -36,8 +45,7 @@
 	void UpdateRecon(); 
 
 	// returns a position to retreat unit of certain type
-	float3 GetSafePos(int def_id);
-	float3 GetSafePos(bool land, bool water);
+	float3 GetSafePos(int def_id, float3 unit_pos);
 
 	// updates average ressource usage
 	void UpdateRessources();
@@ -125,8 +133,8 @@
 	// 
 	AAIGroup* GetClosestGroupOfCategory(UnitCategory category, UnitType type, float3 pos, int importance); 
 
-	float3 GetRallyPoint(unsigned int unit_movement_type, int min_dist, int max_dist);
-	float3 GetRallyPointCloseTo(UnitCategory category, unsigned int unit_movement_type, float3 pos, int min_dist, int max_dist);
+	float3 GetRallyPoint(unsigned int unit_movement_type, int continent_id, int min_dist, int max_dist);
+	float3 GetRallyPointCloseTo(UnitCategory category, unsigned int unit_movement_type, int continent_id, float3 pos, int min_dist, int max_dist);
 
 	AAIMetalSpot* FindMetalSpotClosestToBuilder(int land_mex, int water_mex);
 	AAIMetalSpot* FindMetalSpot(bool land, bool water);

Modified: branches/caiinterface/AI/Skirmish/AAI/AAIGroup.cpp
===================================================================
--- branches/caiinterface/AI/Skirmish/AAI/AAIGroup.cpp	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/AI/Skirmish/AAI/AAIGroup.cpp	2008-10-14 17:26:56 UTC (rev 6725)
@@ -12,11 +12,12 @@
 #include &quot;AAIBuildTable.h&quot;
 #include &quot;AAIAttack.h&quot;
 
-AAIGroup::AAIGroup(IAICallback *cb, AAI *ai, const UnitDef *def, UnitType unit_type)
+AAIGroup::AAIGroup(AAI *ai, const UnitDef *def, UnitType unit_type, int continent_id)
 {
-	this-&gt;cb = cb;
+	
 	this-&gt;ai = ai;
-	this-&gt;bt = ai-&gt;bt;
+	cb = ai-&gt;cb;
+	bt = ai-&gt;bt;
 
 	attack = 0;
 	rally_point = ZeroVector;
@@ -29,6 +30,8 @@
 
 	// set movement type of group (filter out add. movement info like underwater, floater, etc.)
 	group_movement_type = bt-&gt;units_static[def-&gt;id].movement_type &amp; MOVE_TYPE_UNIT;
+	
+	continent = continent_id;
 
 	// now we know type and category, determine max group size
 	if(cfg-&gt;AIR_ONLY_MOD)
@@ -87,8 +90,8 @@
 	}
 
 	avg_speed = bt-&gt;unitList[def-&gt;id-1]-&gt;speed;
-	//fprintf(ai-&gt;file, &quot;Creating new group - max size: %i move type: %i speed group: %i\n&quot;, maxSize, (int)move_type, speed_group);
-	//fprintf(ai-&gt;file, &quot;speedgroup: %i,  min: %f,  avg: %f,  this: %f\n&quot;, speed_group, val1, val2, bt-&gt;unitList[def-&gt;id-1]-&gt;speed);
+	
+	//fprintf(ai-&gt;file, &quot;Creating new group - max size: %i   move type: %i   speed group: %i   continent: %i\n&quot;, maxSize, group_movement_type, speed_group, continent);
 }
 
 AAIGroup::~AAIGroup(void)
@@ -108,49 +111,54 @@
 	}
 }
 
-bool AAIGroup::AddUnit(int unit_id, int def_id, UnitType type)
+bool AAIGroup::AddUnit(int unit_id, int def_id, UnitType type, int continent_id)
 {
-	// check the type match &amp;&amp; current size
-	if(type == group_unit_type &amp;&amp; units.size() &lt; maxSize &amp;&amp; !attack &amp;&amp; (task == GROUP_IDLE || task == GROUP_RETREATING))
+	// for continent bound units: check if unit is on the same continent as the group
+	if(continent_id == -1 || continent_id == continent)
 	{
-		// check if speed group is matching
-		if(cfg-&gt;AIR_ONLY_MOD)
+		//check if type match &amp;&amp; current size
+		if(type == group_unit_type &amp;&amp; units.size() &lt; maxSize &amp;&amp; !attack &amp;&amp; (task == GROUP_IDLE || task == GROUP_RETREATING))
 		{
-			if(category == AIR_ASSAULT &amp;&amp; speed_group != floor((bt-&gt;unitList[def_id-1]-&gt;speed - bt-&gt;min_speed[1][ai-&gt;side-1])/bt-&gt;group_speed[1][ai-&gt;side-1]))
-				return false;
-		}
-		else
-		{
-			if(category == GROUND_ASSAULT &amp;&amp; speed_group != floor((bt-&gt;unitList[def_id-1]-&gt;speed - bt-&gt;min_speed[0][ai-&gt;side-1])/bt-&gt;group_speed[0][ai-&gt;side-1]))
-				return false;
+			// check if speed group is matching
+			if(cfg-&gt;AIR_ONLY_MOD)
+			{
+				if(category == AIR_ASSAULT &amp;&amp; speed_group != floor((bt-&gt;unitList[def_id-1]-&gt;speed - bt-&gt;min_speed[1][ai-&gt;side-1])/bt-&gt;group_speed[1][ai-&gt;side-1]))
+					return false;
+			}
+			else
+			{
+				if(category == GROUND_ASSAULT &amp;&amp; speed_group != floor((bt-&gt;unitList[def_id-1]-&gt;speed - bt-&gt;min_speed[0][ai-&gt;side-1])/bt-&gt;group_speed[0][ai-&gt;side-1]))
+					return false;
 			
-			if(category == SEA_ASSAULT &amp;&amp; speed_group != floor((bt-&gt;unitList[def_id-1]-&gt;speed - bt-&gt;min_speed[3][ai-&gt;side-1])/bt-&gt;group_speed[3][ai-&gt;side-1]))
-				return false;
-		}
+				if(category == SEA_ASSAULT &amp;&amp; speed_group != floor((bt-&gt;unitList[def_id-1]-&gt;speed - bt-&gt;min_speed[3][ai-&gt;side-1])/bt-&gt;group_speed[3][ai-&gt;side-1]))
+					return false;
+			}
 
-		units.push_back(int2(unit_id, def_id));
+			units.push_back(int2(unit_id, def_id));
 
-		size++;
+			++size;
 
-		// send unit to rally point of the group
-		if(rally_point.x &gt; 0)
-		{
-			Command c;
-			c.id = CMD_MOVE;
-			c.params.resize(3);
-			c.params[0] = rally_point.x;
-			c.params[1] = rally_point.y;
-			c.params[2] = rally_point.z;
+			// send unit to rally point of the group
+			if(rally_point.x &gt; 0)
+			{
+				Command c;
+				c.id = CMD_MOVE;
+				c.params.resize(3);
+				c.params[0] = rally_point.x;
+				c.params[1] = rally_point.y;
+				c.params[2] = rally_point.z;
 
-			if(category != AIR_ASSAULT)
-				c.options |= SHIFT_KEY;
+				if(category != AIR_ASSAULT)
+					c.options |= SHIFT_KEY;
 
-			//cb-&gt;GiveOrder(unit_id, &amp;c);
-			ai-&gt;execute-&gt;GiveOrder(&amp;c, unit_id, &quot;Group::AddUnit&quot;);
+				//cb-&gt;GiveOrder(unit_id, &amp;c);
+				ai-&gt;execute-&gt;GiveOrder(&amp;c, unit_id, &quot;Group::AddUnit&quot;);
+			}
+
+			return true;
 		}
+	}
 
-		return true;
-	}
 	return false;
 }
 
@@ -637,7 +645,7 @@
 		--sector-&gt;rally_points;
 	}
 
-	rally_point = ai-&gt;execute-&gt;GetRallyPoint(group_movement_type, 1, 1);
+	rally_point = ai-&gt;execute-&gt;GetRallyPoint(group_movement_type, continent, 1, 1);
 
 	if(rally_point.x &gt; 0)
 	{

Modified: branches/caiinterface/AI/Skirmish/AAI/AAIGroup.h
===================================================================
--- branches/caiinterface/AI/Skirmish/AAI/AAIGroup.h	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/AI/Skirmish/AAI/AAIGroup.h	2008-10-14 17:26:56 UTC (rev 6725)
@@ -1,3 +1,12 @@
+// -------------------------------------------------------------------------
+// AAI
+//
+// A skirmish AI for the TA Spring engine.
+// Copyright Alexander Seizinger
+// 
+// Released under GPL license: see LICENSE.html for more information.
+// -------------------------------------------------------------------------
+
 #pragma once
 
 #include &quot;aidef.h&quot;
@@ -10,10 +19,10 @@
 class AAIGroup
 {
 public:
-	AAIGroup(IAICallback *cb, AAI* ai, const UnitDef *def, UnitType unit_type);
+	AAIGroup(AAI* ai, const UnitDef *def, UnitType unit_type, int continent_id);
 	~AAIGroup(void);
 
-	bool AddUnit(int unit_id, int def_id, UnitType type);
+	bool AddUnit(int unit_id, int def_id, UnitType type, int continent_id);
 
 	bool RemoveUnit(int unit, int attacker);
 
@@ -86,6 +95,9 @@
 	// rally point of the group, ZeroVector if none...
 	float3 rally_point;
 
+	// id of the continent the units of this group are stationed on (only matters if group_movement_type is continent bound)
+	int continent;
+
 private:
 	
 	IAICallback *cb;

Modified: branches/caiinterface/AI/Skirmish/AAI/AAIMap.cpp
===================================================================
--- branches/caiinterface/AI/Skirmish/AAI/AAIMap.cpp	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/AI/Skirmish/AAI/AAIMap.cpp	2008-10-14 17:26:56 UTC (rev 6725)
@@ -2665,4 +2665,4 @@
 		y = yContMapSize - 1;
 
 	return continent_map[y * xContMapSize + x];
-}
+}
\ No newline at end of file

Modified: branches/caiinterface/AI/Skirmish/AAI/AAISector.cpp
===================================================================
--- branches/caiinterface/AI/Skirmish/AAI/AAISector.cpp	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/AI/Skirmish/AAI/AAISector.cpp	2008-10-14 17:26:56 UTC (rev 6725)
@@ -219,6 +219,13 @@
 	return pos;
 }
 
+/*float3 AAISector::GetCenterRallyPoint()
+{
+
+	return ZeroVector;
+}*/
+
+
 float3 AAISector::GetBuildsite(int building, bool water)
 {
 	int xStart, xEnd, yStart, yEnd;
@@ -679,41 +686,23 @@
 	return false;
 }
 
-float3 AAISector::GetMovePos(unsigned int unit_movement_type)
+void AAISector::GetMovePos(float3 *pos)
 {
 	int x,y;
-
-	float height;
-
-	float3 pos = ZeroVector;	
+	*pos = ZeroVector;
 		
 	// try to get random spot
 	for(int i = 0; i &lt; 6; ++i)
 	{
-		pos.x = left + map-&gt;xSectorSize * (0.2f + 0.06f * (float)(rand()%11) );
-		pos.z = top + map-&gt;ySectorSize * (0.2f + 0.06f * (float)(rand()%11) );
+		pos-&gt;x = left + map-&gt;xSectorSize * (0.2f + 0.06f * (float)(rand()%11) );
+		pos-&gt;z = top + map-&gt;ySectorSize * (0.2f + 0.06f * (float)(rand()%11) );
 
-		height = ai-&gt;cb-&gt;GetElevation(pos.x, pos.z);
+		// check if blocked by  building
+		x = (int) (pos-&gt;x / SQUARE_SIZE);
+		y = (int) (pos-&gt;z / SQUARE_SIZE);
 
-		// check if cell height matches movement type 
-		if(height &gt;= 0 &amp;&amp; !(unit_movement_type &amp; MOVE_TYPE_SEA) )
-		{			
-			// get cell index of middlepoint
-			x = (int) (pos.x / SQUARE_SIZE);
-			y = (int) (pos.z / SQUARE_SIZE);
-
-			if(map-&gt;buildmap[x + y * map-&gt;xMapSize] != 1)
-				return pos;
-		}	
-		else if(height &lt; 0 &amp;&amp; !(unit_movement_type &amp; MOVE_TYPE_GROUND) )
-		{			
-			// get cell index of middlepoint
-			x = (int) (pos.x / SQUARE_SIZE);
-			y = (int) (pos.z / SQUARE_SIZE);
-
-			if(map-&gt;buildmap[x + y * map-&gt;xMapSize] != 5)
-				return pos;
-		}	
+		if(map-&gt;buildmap[x + y * map-&gt;xMapSize] != 1)
+			return;
 	}
 
 	// search systematically 
@@ -721,72 +710,64 @@
 	{
 		for(int j = 0; j &lt; map-&gt;ySectorSizeMap; j += 8)
 		{
-			pos.x = left + i * SQUARE_SIZE;
-			pos.z = top + j * SQUARE_SIZE;
-	
-			height = ai-&gt;cb-&gt;GetElevation(pos.x, pos.z);
+			pos-&gt;x = left + i * SQUARE_SIZE;
+			pos-&gt;z = top + j * SQUARE_SIZE;
+			
+			// get cell index of middlepoint
+			x = (int) (pos-&gt;x / SQUARE_SIZE);
+			y = (int) (pos-&gt;z / SQUARE_SIZE);
 
-			// check if cell height matches movement type 
-			if(height &gt;= 0 &amp;&amp; !(unit_movement_type &amp; MOVE_TYPE_SEA) )
-			{			
-				// get cell index of middlepoint
-				x = (int) (pos.x / SQUARE_SIZE);
-				y = (int) (pos.z / SQUARE_SIZE);
-
-				if(map-&gt;buildmap[x + y * map-&gt;xMapSize] != 1)
-					return pos;
-			}	
-			else if(height &lt; 0 &amp;&amp; !(unit_movement_type &amp; MOVE_TYPE_GROUND) )
-			{			
-				// get cell index of middlepoint
-				x = (int) (pos.x / SQUARE_SIZE);
-				y = (int) (pos.z / SQUARE_SIZE);
-
-				if(map-&gt;buildmap[x + y * map-&gt;xMapSize] != 5)
-					return pos;
-			}
+			if(map-&gt;buildmap[x + y * map-&gt;xMapSize] != 1)
+				return;
 		}
 	}
 
-	return ZeroVector;
+	// no free cell found (should not happen)
+	*pos = ZeroVector;
 }
 
-void AAISector::GetMovePos(float3 *pos, unsigned int movement_type, int continent)
+void AAISector::GetMovePosOnContinent(float3 *pos, unsigned int movement_type, int continent)
 {
-	if(movement_type &amp;  MOVE_TYPE_CONTINENT_BOUND)
-	{
-		*pos = ZeroVector;
+	int x,y;
+	*pos = ZeroVector;
 		
-		// try to get random spot
-		for(int i = 0; i &lt; 6; ++i)
-		{
-			pos-&gt;x = left + map-&gt;xSectorSize * (0.2f + 0.06f * (float)(rand()%11) );
-			pos-&gt;z = top + map-&gt;ySectorSize * (0.2f + 0.06f * (float)(rand()%11) );
+	// try to get random spot
+	for(int i = 0; i &lt; 6; ++i)
+	{
+		pos-&gt;x = left + map-&gt;xSectorSize * (0.2f + 0.06f * (float)(rand()%11) );
+		pos-&gt;z = top + map-&gt;ySectorSize * (0.2f + 0.06f * (float)(rand()%11) );
 
+		// check if blocked by  building
+		x = (int) (pos-&gt;x / SQUARE_SIZE);
+		y = (int) (pos-&gt;z / SQUARE_SIZE);
+
+		if(map-&gt;buildmap[x + y * map-&gt;xMapSize] != 1)
+		{
+			//check continent
 			if(map-&gt;GetContinentID(pos) == continent)
 				return;
-			else
-				*pos = ZeroVector;
 		}
-
-		// search systematically 
-		for(int i = 0; i &lt; map-&gt;xSectorSizeMap; i += 8)
+	}
+	
+	// search systematically 
+	for(int i = 0; i &lt; map-&gt;xSectorSizeMap; i += 8)
+	{
+		for(int j = 0; j &lt; map-&gt;ySectorSizeMap; j += 8)
 		{
-			for(int j = 0; j &lt; map-&gt;ySectorSizeMap; j += 8)
+			pos-&gt;x = left + i * SQUARE_SIZE;
+			pos-&gt;z = top + j * SQUARE_SIZE;
+			
+			// get cell index of middlepoint
+			x = (int) (pos-&gt;x / SQUARE_SIZE);
+			y = (int) (pos-&gt;z / SQUARE_SIZE);
+
+			if(map-&gt;buildmap[x + y * map-&gt;xMapSize] != 1)
 			{
-				if(map-&gt;GetContinentID(i + left/SQUARE_SIZE, j + top/SQUARE_SIZE) == continent)
-				{
-					pos-&gt;x = left + i * SQUARE_SIZE;
-					pos-&gt;z = top + j * SQUARE_SIZE;
-					return;
-				}
+				if(map-&gt;GetContinentID(pos) == continent)
+					return;	
 			}
 		}
-
 	}
-	else	// air/hover/amphib -&gt; can reach any pos
-	{
-			pos-&gt;x = left + map-&gt;xSectorSize * (0.2f + 0.06f * (float)(rand()%11) );
-			pos-&gt;z = top + map-&gt;ySectorSize * (0.2f + 0.06f * (float)(rand()%11) );
-	}
-}
+
+	*pos = ZeroVector;
+}
\ No newline at end of file

Modified: branches/caiinterface/AI/Skirmish/AAI/AAISector.h
===================================================================
--- branches/caiinterface/AI/Skirmish/AAI/AAISector.h	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/AI/Skirmish/AAI/AAISector.h	2008-10-14 17:26:56 UTC (rev 6725)
@@ -1,3 +1,12 @@
+// -------------------------------------------------------------------------
+// AAI
+//
+// A skirmish AI for the TA Spring engine.
+// Copyright Alexander Seizinger
+// 
+// Released under GPL license: see LICENSE.html for more information.
+// -------------------------------------------------------------------------
+
 #pragma once
 
 #include &quot;aidef.h&quot;
@@ -87,16 +96,16 @@
 	// returns center of the sector
 	float3 GetCenter();
 
-	// returns a position in sector for the movement type (ZeroVector if none found)
-	float3 GetMovePos(unsigned int unit_movement_type);
+	// returns a free position in sector where units can be send to regardless of movement_type (ZeroVector if none found)
+	void GetMovePos(float3 *pos);
 
-	// returns a position in sector on specified continent for the movement type (ZeroVector if none found)
-	void GetMovePos(float3 *pos, unsigned int movement_type, int continent); 
+	// returns a free position in sector on specified continent for the movement type (ZeroVector if none found)
+	void GetMovePosOnContinent(float3 *pos, unsigned int movement_type, int continent); 
 
 	// returns true is pos is within sector
 	bool PosInSector(float3 *pos);
 
-	// get water/flat gorund ratio
+	// get water/flat ground ratio
 	float GetWaterRatio();
 	float GetFlatRatio();
 

Modified: branches/caiinterface/AI/Skirmish/AAI/aidef.h
===================================================================
--- branches/caiinterface/AI/Skirmish/AAI/aidef.h	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/AI/Skirmish/AAI/aidef.h	2008-10-14 17:26:56 UTC (rev 6725)
@@ -1,6 +1,11 @@
-// AAI          <A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">alexander.seizinger at gmx.net</A>	 
+// -------------------------------------------------------------------------
+// AAI
+//
+// A skirmish AI for the TA Spring engine.
+// Copyright Alexander Seizinger
 // 
-// standard headers 
+// Released under GPL license: see LICENSE.html for more information.
+// -------------------------------------------------------------------------
 
 #include &lt;list&gt;
 #include &lt;vector&gt;
@@ -31,9 +36,9 @@
 #ifndef AIDEF_H
 #define AIDEF_H
 
-#define AAI_VERSION &quot;0.87&quot;
+#define AAI_VERSION &quot;0.872&quot;
 #define MAP_FILE_VERSION &quot;MAP_LEARN_0_80&quot;
-#define TABLE_FILE_VERSION &quot;MOD_LEARN_0_86&quot;
+#define TABLE_FILE_VERSION &quot;MOD_LEARN_0_87&quot;
 #define MAP_DATA_VERSION &quot;MAP_DATA_0_86&quot;
 #define CONTINENT_DATA_VERSION &quot;MOVEMENT_MAPS_0_86&quot;
 


Property changes on: branches/caiinterface/AI/Skirmish/KAIK
___________________________________________________________________
Name: svn:mergeinfo
   - 

Modified: branches/caiinterface/AI/Skirmish/KAIK/BuildUp.cpp
===================================================================
--- branches/caiinterface/AI/Skirmish/KAIK/BuildUp.cpp	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/AI/Skirmish/KAIK/BuildUp.cpp	2008-10-14 17:26:56 UTC (rev 6725)
@@ -102,9 +102,9 @@
 
 	if (ai-&gt;uh-&gt;NumIdleUnits(CAT_BUILDER)) {
 		// get first idle (mobile) builder every Update() cycle
-		int builder = ai-&gt;uh-&gt;GetIU(CAT_BUILDER);
-		const UnitDef* builderDef = ai-&gt;cb-&gt;GetUnitDef(builder);
-		const UnitDef* factoryDef = ai-&gt;ut-&gt;GetUnitByScore(builder, CAT_FACTORY);
+		int builderID = ai-&gt;uh-&gt;GetIU(CAT_BUILDER);
+		const UnitDef* builderDef = ai-&gt;cb-&gt;GetUnitDef(builderID);
+		const UnitDef* factoryDef = ai-&gt;ut-&gt;GetUnitByScore(builderID, CAT_FACTORY);
 
 		// if this builder cannot build any factories, pretend it's feasible
 		bool factFeasM = (factoryDef? ai-&gt;math-&gt;MFeasibleConstruction(builderDef, factoryDef): true);
@@ -119,7 +119,7 @@
 
 
 		if (!builderDef) {
-			ai-&gt;uh-&gt;UnitDestroyed(builder);
+			ai-&gt;uh-&gt;UnitDestroyed(builderID);
 		}
 
 		else {
@@ -133,11 +133,12 @@
 					int numF = ai-&gt;uh-&gt;AllUnitsByCat[CAT_FACTORY].size();
 
 					// note: in EE metal processors belong to CAT_ENERGY
-					if ((numM &lt; 3 &amp;&amp; numE &lt;= 3) &amp;&amp; BuildUpgradeExtractor(builder)) { return; }
-					if ((numE &lt; 3 &amp;&amp; numM &lt;= 3) &amp;&amp; BuildUpgradeReactor(builder)) { return; }
-					if ((numF &lt; 1 &amp;&amp; factFeas) &amp;&amp; BuildNow(builder, CAT_FACTORY, factoryDef)) { return; }
+					// note: this probably breaks mods with static commanders
+					if ((numM &lt; 3 &amp;&amp; numE &lt;= 3) &amp;&amp; BuildUpgradeExtractor(builderID)) { return; }
+					if ((numE &lt; 3 &amp;&amp; numM &lt;= 3) &amp;&amp; BuildUpgradeReactor(builderID)) { return; }
+					if ((numF &lt; 1 &amp;&amp; factFeas) &amp;&amp; BuildNow(builderID, CAT_FACTORY, factoryDef)) { return; }
 
-					if (ai-&gt;uh-&gt;FactoryBuilderAdd(builder)) {
+					if (ai-&gt;uh-&gt;FactoryBuilderAdd(builderID)) {
 						// add commander to factory so it doesn't wander around too much (works best if
 						// AI given bonus, otherwise initial expansion still mostly done by commander)
 						// note: 5 minutes should be enough to get the resource income needed for this,
@@ -149,11 +150,11 @@
 
 
 			else if (buildNukeSilo &amp;&amp; nukeSiloTimer &lt;= 0) {
-				if (!ai-&gt;uh-&gt;BuildTaskAddBuilder(builder, CAT_NUKE)) {
+				if (!ai-&gt;uh-&gt;BuildTaskAddBuilder(builderID, CAT_NUKE)) {
 					// always favor building one silo at a time rather than
 					// many in parallel to prevent a sudden massive resource
 					// drain when silos are finished
-					if (BuildNow(builder, CAT_NUKE))
+					if (BuildNow(builderID, CAT_NUKE))
 						nukeSiloTimer += 300;
 				}
 			}
@@ -163,25 +164,25 @@
 				// only reclaim features during odd frames so we don't
 				// spend the entire game just chasing after rocks etc.
 				// (problem on Cooper Hill and similar maps)
-				bool reclaimFeature = ((frame &amp; 1) &amp;&amp; ai-&gt;MyUnits[builder]-&gt;ReclaimBestFeature(true));
+				bool reclaimFeature = ((frame &amp; 1) &amp;&amp; ai-&gt;MyUnits[builderID]-&gt;ReclaimBestFeature(true));
 
 				if (!reclaimFeature) {
-					bool b = BuildUpgradeExtractor(builder);
+					bool b = BuildUpgradeExtractor(builderID);
 					bool eOverflow = (eStorage / (eIncome + 0.01) &lt; STORAGETIME);
 					bool eExcess = (eIncome &gt; (eUsage * 1.5));
 
 					// if we couldn't build or upgrade an extractor
 					if (!b &amp;&amp; eOverflow &amp;&amp; buildableEStorage &gt; 0 &amp;&amp; storageTimer &lt;= 0) {
-						if (!ai-&gt;uh-&gt;BuildTaskAddBuilder(builder, CAT_ESTOR)) {
+						if (!ai-&gt;uh-&gt;BuildTaskAddBuilder(builderID, CAT_ESTOR)) {
 							// build energy storage
-							if (BuildNow(builder, CAT_ESTOR))
+							if (BuildNow(builderID, CAT_ESTOR))
 								storageTimer += 90;
 						}
 					}
 					else if (!b &amp;&amp; buildableMMakers &gt; 0 &amp;&amp; eExcess &amp;&amp; ((RANDINT % 10) == 0)) {
 						// build metal maker
-						if (!ai-&gt;uh-&gt;BuildTaskAddBuilder(builder, CAT_MMAKER)) {
-							BuildNow(builder, CAT_MMAKER);
+						if (!ai-&gt;uh-&gt;BuildTaskAddBuilder(builderID, CAT_MMAKER)) {
+							BuildNow(builderID, CAT_MMAKER);
 						}
 					}
 				}
@@ -190,16 +191,16 @@
 
 			// we're producing lots of energy but aren't using it
 			else if (eIncome &gt; 2000.0f &amp;&amp; eUsage &lt; (eIncome - 1000.0f) &amp;&amp; (mStall &amp;&amp; mLevel &lt; 100.0f) &amp;&amp; buildableMMakers &gt; 0) {
-				if (!ai-&gt;uh-&gt;BuildTaskAddBuilder(builder, CAT_MMAKER)) {
-					BuildNow(builder, CAT_MMAKER);
+				if (!ai-&gt;uh-&gt;BuildTaskAddBuilder(builderID, CAT_MMAKER)) {
+					BuildNow(builderID, CAT_MMAKER);
 				}
 			}
 
 
 			else if (eStall || !factFeasE) {
 				// build energy generator
-				if (!ai-&gt;uh-&gt;BuildTaskAddBuilder(builder, CAT_ENERGY)) {
-					BuildUpgradeReactor(builder);
+				if (!ai-&gt;uh-&gt;BuildTaskAddBuilder(builderID, CAT_ENERGY)) {
+					BuildUpgradeReactor(builderID);
 				}
 			}
 
@@ -212,23 +213,23 @@
 				// do we have more factories than defense (and have at least 10 minutes passed)?
 				if (numFactories &gt; (numDefenses / DEFENSEFACTORYRATIO) &amp;&amp; frame &gt; 18000) {
 					if (mOverflow &amp;&amp; numMStorage &gt; 0 &amp;&amp; storageTimer &lt;= 0 &amp;&amp; (numFactories &gt; 0)) {
-						if (!ai-&gt;uh-&gt;BuildTaskAddBuilder(builder, CAT_MSTOR)) {
+						if (!ai-&gt;uh-&gt;BuildTaskAddBuilder(builderID, CAT_MSTOR)) {
 							// build metal storage
-							if (BuildNow(builder, CAT_MSTOR))
+							if (BuildNow(builderID, CAT_MSTOR))
 								storageTimer += 90;
 						}
 					} else {
-						if (!ai-&gt;uh-&gt;BuildTaskAddBuilder(builder, CAT_DEFENCE)) {
+						if (!ai-&gt;uh-&gt;BuildTaskAddBuilder(builderID, CAT_DEFENCE)) {
 							// if we can't add this builder to some defense
 							// task then build something in CAT_DEFENCE
-							const UnitDef* building = ai-&gt;ut-&gt;GetUnitByScore(builder, CAT_DEFENCE);
+							const UnitDef* building = ai-&gt;ut-&gt;GetUnitByScore(builderID, CAT_DEFENCE);
 							bool r = false;
 
 							if (building) {
-								float3 buildPos = ai-&gt;dm-&gt;GetDefensePos(building, ai-&gt;MyUnits[builder]-&gt;pos());
-								r = ai-&gt;MyUnits[builder]-&gt;Build_ClosestSite(building, buildPos, 2);
+								float3 buildPos = ai-&gt;dm-&gt;GetDefensePos(building, ai-&gt;MyUnits[builderID]-&gt;pos());
+								r = ai-&gt;MyUnits[builderID]-&gt;Build_ClosestSite(building, buildPos, 2);
 							} else {
-								FallbackBuild(builder, CAT_DEFENCE);
+								FallbackBuild(builderID, CAT_DEFENCE);
 							}
 						}
 					}
@@ -236,14 +237,14 @@
 
 				// no, build more factories
 				else {
-					if (!ai-&gt;uh-&gt;BuildTaskAddBuilder(builder, CAT_FACTORY)) {
+					if (!ai-&gt;uh-&gt;BuildTaskAddBuilder(builderID, CAT_FACTORY)) {
 						// if we can't add this builder to some other buildtask
-						if (!ai-&gt;uh-&gt;FactoryBuilderAdd(builder)) {
+						if (!ai-&gt;uh-&gt;FactoryBuilderAdd(builderID)) {
 							// if we can't add this builder to some
 							// other factory then construct new one
 							if (ai-&gt;uh-&gt;AllUnitsByCat[CAT_FACTORY].size() &lt; 1 || frame &gt; 9000) {
 								// one factory for the first 5 minutes
-								BuildNow(builder, CAT_FACTORY, factoryDef);
+								BuildNow(builderID, CAT_FACTORY, factoryDef);
 							}
 						}
 					}
@@ -310,10 +311,10 @@
 				}
 
 				else {
-					const UnitDef* leastBuiltBuilder = GetLeastBuiltBuilder();
-					const UnitDef* builderUnit = ai-&gt;ut-&gt;GetUnitByScore(factoryUnitID, CAT_BUILDER);
+					const UnitDef* leastBuiltBuilderDef = GetLeastBuiltBuilder();
+					const UnitDef* builderUnitDef = ai-&gt;ut-&gt;GetUnitByScore(factoryUnitID, CAT_BUILDER);
 
-					if (builderUnit &amp;&amp; builderUnit == leastBuiltBuilder) {
+					if (builderUnitDef &amp;&amp; builderUnitDef == leastBuiltBuilderDef) {
 						// if this factory makes the builder that we are short of
 						producedCat = CAT_BUILDER;
 						builderTimer += 4;
@@ -364,48 +365,48 @@
 
 
 
-void CBuildUp::FallbackBuild(int builder, int failedCat) {
+void CBuildUp::FallbackBuild(int builderID, int failedCat) {
 	// called if an idle builder was selected to construct
 	// some category of unit, but builder not capable of
 	// constructing anything of that category (note that
 	// if AI is swimming in resources then most L1 builders
 	// will be used in assisting roles)
 
-	bool b1 = ai-&gt;uh-&gt;BuildTaskAddBuilder(builder, CAT_MEX);
+	bool b1 = ai-&gt;uh-&gt;BuildTaskAddBuilder(builderID, CAT_MEX);
 	bool b2 = false;
 	bool b3 = false;
 	bool b4 = false;
-	float3 builderPos = ai-&gt;cb-&gt;GetUnitPos(builder);
+	float3 builderPos = ai-&gt;cb-&gt;GetUnitPos(builderID);
 
-	if (!b1              ) { b2 = ai-&gt;uh-&gt;BuildTaskAddBuilder(builder, CAT_ENERGY); }
-	if (!b1 &amp;&amp; !b2       ) { b3 = ai-&gt;uh-&gt;BuildTaskAddBuilder(builder, CAT_DEFENCE); }
-	if (!b1 &amp;&amp; !b2 &amp;&amp; !b3) { b4 = ai-&gt;uh-&gt;BuildTaskAddBuilder(builder, CAT_FACTORY); }
+	if (!b1              ) { b2 = ai-&gt;uh-&gt;BuildTaskAddBuilder(builderID, CAT_ENERGY); }
+	if (!b1 &amp;&amp; !b2       ) { b3 = ai-&gt;uh-&gt;BuildTaskAddBuilder(builderID, CAT_DEFENCE); }
+	if (!b1 &amp;&amp; !b2 &amp;&amp; !b3) { b4 = ai-&gt;uh-&gt;BuildTaskAddBuilder(builderID, CAT_FACTORY); }
 
 /*
 	if (!b1 &amp;&amp; !b2 &amp;&amp; !b3 &amp;&amp; !b4) {
 		// failed to add builder to any task, try building something
-		const UnitDef* udef1 = ai-&gt;ut-&gt;GetUnitByScore(builder, CAT_MEX);
-		const UnitDef* udef2 = ai-&gt;ut-&gt;GetUnitByScore(builder, CAT_ENERGY);
-		const UnitDef* udef3 = ai-&gt;ut-&gt;GetUnitByScore(builder, CAT_DEFENCE);
-		const UnitDef* udef4 = ai-&gt;ut-&gt;GetUnitByScore(builder, CAT_FACTORY);
+		const UnitDef* udef1 = ai-&gt;ut-&gt;GetUnitByScore(builderID, CAT_MEX);
+		const UnitDef* udef2 = ai-&gt;ut-&gt;GetUnitByScore(builderID, CAT_ENERGY);
+		const UnitDef* udef3 = ai-&gt;ut-&gt;GetUnitByScore(builderID, CAT_DEFENCE);
+		const UnitDef* udef4 = ai-&gt;ut-&gt;GetUnitByScore(builderID, CAT_FACTORY);
 
 		if (udef2 &amp;&amp; failedCat != CAT_ENERGY) {
-			ai-&gt;MyUnits[builder]-&gt;Build_ClosestSite(udef2, builderPos);
+			ai-&gt;MyUnits[builderID]-&gt;Build_ClosestSite(udef2, builderPos);
 			return;
 		}
 		if (udef3 &amp;&amp; failedCat != CAT_DEFENCE) {
 			float3 pos = ai-&gt;dm-&gt;GetDefensePos(udef3, builderPos);
-			ai-&gt;MyUnits[builder]-&gt;Build_ClosestSite(udef3, pos);
+			ai-&gt;MyUnits[builderID]-&gt;Build_ClosestSite(udef3, pos);
 			return;
 		}
 		if (udef4 &amp;&amp; failedCat != CAT_FACTORY) {
-			ai-&gt;MyUnits[builder]-&gt;Build_ClosestSite(udef4, builderPos);
+			ai-&gt;MyUnits[builderID]-&gt;Build_ClosestSite(udef4, builderPos);
 			return;
 		}
 		if (udef1 &amp;&amp; failedCat != CAT_MEX) {
-			float3 pos = ai-&gt;mm-&gt;GetNearestMetalSpot(builder, udef1);
+			float3 pos = ai-&gt;mm-&gt;GetNearestMetalSpot(builderID, udef1);
 			if (pos != ERRORVECTOR)
-				ai-&gt;MyUnits[builder]-&gt;Build(pos, udef1, -1);
+				ai-&gt;MyUnits[builderID]-&gt;Build(pos, udef1, -1);
 			return;
 		}
 	}
@@ -413,7 +414,7 @@
 
 	// unable to assist and unable to build, just patrol
 	if (!b1 &amp;&amp; !b2 &amp;&amp; !b3 &amp;&amp; !b4)
-		ai-&gt;MyUnits[builder]-&gt;Patrol(builderPos);
+		ai-&gt;MyUnits[builderID]-&gt;Patrol(builderPos);
 }
 
 
@@ -450,26 +451,26 @@
 
 
 
-bool CBuildUp::BuildNow(int builder, int category) {
-	const UnitDef* building = ai-&gt;ut-&gt;GetUnitByScore(builder, category);
+bool CBuildUp::BuildNow(int builderID, int category) {
+	const UnitDef* building = ai-&gt;ut-&gt;GetUnitByScore(builderID, category);
 	bool r = false;
 
 	if (building) {
-		r = ai-&gt;MyUnits[builder]-&gt;Build_ClosestSite(building, ai-&gt;cb-&gt;GetUnitPos(builder));
+		r = ai-&gt;MyUnits[builderID]-&gt;Build_ClosestSite(building, ai-&gt;cb-&gt;GetUnitPos(builderID));
 	} else {
-		FallbackBuild(builder, category);
+		FallbackBuild(builderID, category);
 	}
 
 	return r;
 }
 
-bool CBuildUp::BuildNow(int builder, int category, const UnitDef* udef) {
+bool CBuildUp::BuildNow(int builderID, int category, const UnitDef* udef) {
 	bool r = false;
 
 	if (udef) {
-		r = ai-&gt;MyUnits[builder]-&gt;Build_ClosestSite(udef, ai-&gt;cb-&gt;GetUnitPos(builder));
+		r = ai-&gt;MyUnits[builderID]-&gt;Build_ClosestSite(udef, ai-&gt;cb-&gt;GetUnitPos(builderID));
 	} else {
-		FallbackBuild(builder, CAT_FACTORY);
+		FallbackBuild(builderID, CAT_FACTORY);
 	}
 
 	return r;
@@ -477,16 +478,16 @@
 
 
 
-bool CBuildUp::BuildUpgradeExtractor(int builder) {
-	const UnitDef* mexDef = ai-&gt;ut-&gt;GetUnitByScore(builder, CAT_MEX);
+bool CBuildUp::BuildUpgradeExtractor(int builderID) {
+	const UnitDef* mexDef = ai-&gt;ut-&gt;GetUnitByScore(builderID, CAT_MEX);
 
 	if (mexDef) {
-		float3 mexPos = ai-&gt;mm-&gt;GetNearestMetalSpot(builder, mexDef);
+		float3 mexPos = ai-&gt;mm-&gt;GetNearestMetalSpot(builderID, mexDef);
 
 		if (mexPos != ERRORVECTOR) {
-			if (!ai-&gt;uh-&gt;BuildTaskAddBuilder(builder, CAT_MEX)) {
+			if (!ai-&gt;uh-&gt;BuildTaskAddBuilder(builderID, CAT_MEX)) {
 				// build metal extractor
-				return (ai-&gt;MyUnits[builder]-&gt;Build(mexPos, mexDef, -1));
+				return (ai-&gt;MyUnits[builderID]-&gt;Build(mexPos, mexDef, -1));
 			}
 		} else {
 			// upgrade existing mex (NOTE: GetNearestMetalSpot()
@@ -497,7 +498,7 @@
 
 			if (oldMex) {
 				if ((mexDef-&gt;extractsMetal / oldMex-&gt;extractsMetal) &gt;= 2.0f) {
-					return (ai-&gt;MyUnits[builder]-&gt;Upgrade(oldMexID, mexDef));
+					return (ai-&gt;MyUnits[builderID]-&gt;Upgrade(oldMexID, mexDef));
 				}
 			}
 		}
@@ -509,11 +510,11 @@
 
 
 
-bool CBuildUp::BuildUpgradeReactor(int builder) {
-	const UnitDef* reactorDef = ai-&gt;ut-&gt;GetUnitByScore(builder, CAT_ENERGY);
+bool CBuildUp::BuildUpgradeReactor(int builderID) {
+	const UnitDef* reactorDef = ai-&gt;ut-&gt;GetUnitByScore(builderID, CAT_ENERGY);
 
 	if (reactorDef) {
-		const float3 builderPos = ai-&gt;cb-&gt;GetUnitPos(builder);
+		const float3 builderPos = ai-&gt;cb-&gt;GetUnitPos(builderID);
 		float netEnergy = reactorDef-&gt;energyMake - reactorDef-&gt;energyUpkeep;
 
 		float closestDstSq = 999999999999999.0f;
@@ -545,10 +546,10 @@
 
 		if (bestItReactor != -1) {
 			// upgrade
-			return (ai-&gt;MyUnits[builder]-&gt;Upgrade(bestItReactor, reactorDef));
+			return (ai-&gt;MyUnits[builderID]-&gt;Upgrade(bestItReactor, reactorDef));
 		} else {
 			// nothing to upgrade
-			return BuildNow(builder, 0, reactorDef);
+			return BuildNow(builderID, 0, reactorDef);
 		}
 	}
 

Modified: branches/caiinterface/AI/Skirmish/KAIK/DGunController.cpp
===================================================================
--- branches/caiinterface/AI/Skirmish/KAIK/DGunController.cpp	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/AI/Skirmish/KAIK/DGunController.cpp	2008-10-14 17:26:56 UTC (rev 6725)
@@ -32,12 +32,11 @@
 	if (ai)
 		CALLOUT = ai-&gt;cb;
 
-	units = (int*) calloc(MAX_UNITS, sizeof(int));
+	units.resize(MAX_UNITS, 0);
 	srand((unsigned) time(0));
 }
 
 DGunController::~DGunController(void) {
-	free(units);
 }
 
 void DGunController::PostLoad() {
@@ -46,14 +45,18 @@
 
 
 void DGunController::init(int commID) {
-	commanderID		= commID;
-	commanderUD		= CALLOUT-&gt;GetUnitDef(commID);
-	state.inited	= true;
+	commanderID  = commID;
+	commanderUD  = CALLOUT-&gt;GetUnitDef(commID);
+	state.inited = true;
 
-	// set commander to hold fire
-	setFireState(0);
+	// set the commander to hold fire (we need this since
+	// FAW and RF interfere with dgun and reclaim orders)
+	CUNIT* commander = ai-&gt;MyUnits[commanderID];
+	commander-&gt;SetFireState(0);
 
-	for (std::vector&lt;UnitDef::UnitDefWeapon&gt;::const_iterator i = commanderUD-&gt;weapons.begin(); i != commanderUD-&gt;weapons.end(); i++) {
+	std::vector&lt;UnitDef::UnitDefWeapon&gt;::const_iterator i = commanderUD-&gt;weapons.begin();
+
+	for (; i != commanderUD-&gt;weapons.end(); i++) {
 		if (i-&gt;def-&gt;type == &quot;DGun&quot;) {
 			commanderWD = i-&gt;def;
 			break;
@@ -122,7 +125,7 @@
 
 	// get all units within immediate (non-walking) dgun range
 	float maxRange = CALLOUT-&gt;GetUnitMaxRange(commanderID);
-	int numUnits = CALLOUT-&gt;GetEnemyUnits(units, commanderPos, maxRange * 0.9f);
+	int numUnits = CALLOUT-&gt;GetEnemyUnits(&amp;units[0], commanderPos, maxRange * 0.9f);
 
 	for (int i = 0; i &lt; numUnits; i++) {
 		// if enemy unit with valid ID found in array
@@ -185,17 +188,6 @@
 	CALLOUT-&gt;GiveOrder(commanderID, &amp;c);
 }
 
-
-// we need this since FAW and RF interfere with dgun and reclaim orders
-// (fireState can be 0: hold fire, 1: return fire, 2: fire at will)
-void DGunController::setFireState(int fireState) {
-	Command c;
-	c.id = CMD_FIRE_STATE;
-	c.params.push_back(fireState);
-
-	CALLOUT-&gt;GiveOrder(commanderID, &amp;c);
-}
-
 bool DGunController::isBusy(void) {
 	return (state.dgunOrderFrame &gt; 0 || state.reclaimOrderFrame &gt; 0);
 }

Modified: branches/caiinterface/AI/Skirmish/KAIK/DGunController.hpp
===================================================================
--- branches/caiinterface/AI/Skirmish/KAIK/DGunController.hpp	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/AI/Skirmish/KAIK/DGunController.hpp	2008-10-14 17:26:56 UTC (rev 6725)
@@ -80,13 +80,12 @@
 
 		void issueOrder(int, int, int);
 		void issueOrder(float3, int, int);
-		void setFireState(int);
 
 		IAICallback* gAICallback;
 		AIClasses* ai;
 		const UnitDef* commanderUD;
 		const WeaponDef* commanderWD;
-		int* units;
+		std::vector&lt;int&gt; units;
 		ControllerState state;
 		int commanderID;
 };

Modified: branches/caiinterface/AI/Skirmish/KAIK/Defines.h
===================================================================
--- branches/caiinterface/AI/Skirmish/KAIK/Defines.h	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/AI/Skirmish/KAIK/Defines.h	2008-10-14 17:26:56 UTC (rev 6725)
@@ -2,7 +2,7 @@
 #define DEFINES_H
 
 #define AI_NAME			&quot;KAIK 0.13 Unofficial&quot;
-#define AI_DATE			&quot;8/04/2008&quot;
+#define AI_DATE			&quot;14/10/2008&quot;
 #define AI_VERSION		AI_NAME &quot; (rev. &quot; AI_DATE &quot;)&quot;
 #define AI_CREDITS		&quot;(original developer: Krogothe, current maintainer: Kloot)&quot;
 

Modified: branches/caiinterface/AI/Skirmish/KAIK/GlobalAI.cpp
===================================================================
--- branches/caiinterface/AI/Skirmish/KAIK/GlobalAI.cpp	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/AI/Skirmish/KAIK/GlobalAI.cpp	2008-10-14 17:26:56 UTC (rev 6725)
@@ -125,6 +125,10 @@
 }
 
 CGlobalAI::~CGlobalAI() {
+	for (int i = 0; i &lt; MAX_UNITS; i++) {
+		delete ai-&gt;MyUnits[i]; ai-&gt;MyUnits[i] = 0x0;
+	}
+
 	delete ai-&gt;LOGGER;
 	delete ai-&gt;ah;
 	delete ai-&gt;bu;
@@ -195,22 +199,23 @@
 }
 
 void CGlobalAI::Serialize(creg::ISerializer* s) {
-	if (!s-&gt;IsWriting())
-		MyUnits.resize(MAX_UNITS, CUNIT(ai));
+	if (!s-&gt;IsWriting()) {
+		// if de-serializing a saved state, allocate
+		// here instead of in InitAI() which we skip
+		ai-&gt;MyUnits.resize(MAX_UNITS, new CUNIT(ai));
+	}
 
 	for (int i = 0; i &lt; MAX_UNITS; i++) {
 		if (ai-&gt;cheat-&gt;GetUnitDef(i)) {
 			// do not save non-existing units
-			s-&gt;SerializeObjectInstance(&amp;(MyUnits[i]), MyUnits[i].GetClass());
+			s-&gt;SerializeObjectInstance(ai-&gt;MyUnits[i], ai-&gt;MyUnits[i]-&gt;GetClass());
 			if (!s-&gt;IsWriting()) {
-				MyUnits[i].myid = i;
+				ai-&gt;MyUnits[i]-&gt;myid = i;
 			}
 		} else if (!s-&gt;IsWriting()) {
-			MyUnits[i].myid = i;
-			MyUnits[i].groupID = -1;
+			ai-&gt;MyUnits[i]-&gt;myid = i;
+			ai-&gt;MyUnits[i]-&gt;groupID = -1;
 		}
-		if (!s-&gt;IsWriting())
-			ai-&gt;MyUnits.push_back(&amp;MyUnits[i]);
 	}
 
 	s-&gt;SerializeObjectInstance(ai, ai-&gt;GetClass());
@@ -243,18 +248,17 @@
 	ai-&gt;cb-&gt;GetValue(AIVAL_LOCATE_FILE_W, this-&gt;c);
 	ai-&gt;cb-&gt;GetValue(AIVAL_LOCATE_FILE_W, cfgFolder);
 
-	MyUnits.reserve(MAX_UNITS);
-	ai-&gt;MyUnits.reserve(MAX_UNITS);
 
+	ai-&gt;MyUnits.resize(MAX_UNITS, 0x0);
+
 	// initialize MAX_UNITS CUNIT objects
 	for (int i = 0; i &lt; MAX_UNITS; i++) {
-		MyUnits.push_back(CUNIT(ai));
-		MyUnits[i].myid = i;
-		MyUnits[i].groupID = -1;
-
-		ai-&gt;MyUnits.push_back(&amp;MyUnits[i]);
+		ai-&gt;MyUnits[i] = new CUNIT(ai);
+		ai-&gt;MyUnits[i]-&gt;myid = i;
+		ai-&gt;MyUnits[i]-&gt;groupID = -1;
 	}
 
+
 	ai-&gt;debug			= new CDebug(ai);
 	ai-&gt;math			= new CMaths(ai);
 	ai-&gt;LOGGER			= new std::ofstream(this-&gt;c);
@@ -279,24 +283,18 @@
 }
 
 
-void CGlobalAI::UnitCreated(int unit) {
-	ai-&gt;uh-&gt;UnitCreated(unit);
-	ai-&gt;econTracker-&gt;UnitCreated(unit);
-
-	const UnitDef* ud = ai-&gt;cb-&gt;GetUnitDef(unit);
-
-	if (ud &amp;&amp; ud-&gt;isCommander &amp;&amp; ud-&gt;canDGun) {
-		ai-&gt;dgunController-&gt;init(unit);
-	}
+void CGlobalAI::UnitCreated(int unitID) {
+	ai-&gt;uh-&gt;UnitCreated(unitID);
+	ai-&gt;econTracker-&gt;UnitCreated(unitID);
 }
 
 void CGlobalAI::UnitFinished(int unit) {
-	// let attackhandler handle cat_g_attack units
 	ai-&gt;econTracker-&gt;UnitFinished(unit);
 	int frame = ai-&gt;cb-&gt;GetCurrentFrame();
 	const UnitDef* udef = ai-&gt;cb-&gt;GetUnitDef(unit);
 
 	if (udef) {
+		// let attackhandler handle cat_g_attack units
 		if (GCAT(unit) == CAT_G_ATTACK) {
 			ai-&gt;ah-&gt;AddUnit(unit);
 		} else {
@@ -333,7 +331,7 @@
 	}
 
 	// AttackHandler handles cat_g_attack units
-	if (GCAT(unit) == CAT_G_ATTACK &amp;&amp; ai-&gt;MyUnits.at(unit)-&gt;groupID != -1) {
+	if (GCAT(unit) == CAT_G_ATTACK &amp;&amp; ai-&gt;MyUnits[unit]-&gt;groupID != -1) {
 		// attackHandler-&gt;UnitIdle(unit);
 	} else {
 		ai-&gt;uh-&gt;IdleUnitAdd(unit, ai-&gt;cb-&gt;GetCurrentFrame());

Modified: branches/caiinterface/AI/Skirmish/KAIK/GlobalAI.h
===================================================================
--- branches/caiinterface/AI/Skirmish/KAIK/GlobalAI.h	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/AI/Skirmish/KAIK/GlobalAI.h	2008-10-14 17:26:56 UTC (rev 6725)
@@ -39,7 +39,6 @@
 		void Serialize(creg::ISerializer* s);
 
 		AIClasses* ai;
-		std::vector&lt;CUNIT&gt; MyUnits;
 
 		char c[1024];
 };

Modified: branches/caiinterface/AI/Skirmish/KAIK/SunParser.cpp
===================================================================
--- branches/caiinterface/AI/Skirmish/KAIK/SunParser.cpp	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/AI/Skirmish/KAIK/SunParser.cpp	2008-10-14 17:26:56 UTC (rev 6725)
@@ -1,8 +1,5 @@
 #include &quot;SunParser.h&quot;
 
-using std::ifstream;
-
-
 CSunParser::CSunParser(AIClasses* ai) {
 	this-&gt;ai = ai;
 }
@@ -46,7 +43,7 @@
 	ai-&gt;cb-&gt;GetValue(AIVAL_LOCATE_FILE_R, filename_buf);
 
 	this-&gt;filename = filename_buf;
-	ifstream RealFile(filename_buf);
+	std::ifstream RealFile(filename_buf);
 
 	if (RealFile.fail()) {
 		return;

Modified: branches/caiinterface/AI/Skirmish/KAIK/Unit.cpp
===================================================================
--- branches/caiinterface/AI/Skirmish/KAIK/Unit.cpp	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/AI/Skirmish/KAIK/Unit.cpp	2008-10-14 17:26:56 UTC (rev 6725)
@@ -326,17 +326,12 @@
 	return c;
 }
 
-Command CUNIT::MakeIntCommand(int id, int number, int maxnum) {
+Command CUNIT::MakeIntCommand(int cmdID, int param, int) {
 	assert(ai-&gt;cb-&gt;GetUnitDef(myid) != NULL);
 
-	if (number &gt; maxnum)
-		number = maxnum;
-	if (number &lt; 0)
-		number = 0;
-
 	Command c;
-	c.id = id;
-	c.params.push_back(number);
+	c.id = cmdID;
+	c.params.push_back(param);
 
 	ai-&gt;uh-&gt;IdleUnitRemove(myid);
 	return c;
@@ -639,9 +634,11 @@
 	return true;
 }
 
-bool CUNIT::SetFiringMode(int mode) {
+// state can be 0: hold fire, 1: return fire, 2: fire at will
+bool CUNIT::SetFireState(int state) {
 	assert(ai-&gt;cb-&gt;GetUnitDef(myid) != NULL);
-	Command c = MakeIntCommand(CMD_FIRE_STATE, mode, 2);
+	Command c = MakeIntCommand(CMD_FIRE_STATE, state);
+
 	if (c.id != 0) {
 		ai-&gt;cb-&gt;GiveOrder(myid, &amp;c);
 		return true;

Modified: branches/caiinterface/AI/Skirmish/KAIK/Unit.h
===================================================================
--- branches/caiinterface/AI/Skirmish/KAIK/Unit.h	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/AI/Skirmish/KAIK/Unit.h	2008-10-14 17:26:56 UTC (rev 6725)
@@ -89,7 +89,7 @@
 
 		// special abilities
 		bool SelfDestruct();
-		bool SetFiringMode(int mode);
+		bool SetFireState(int state);
 		bool Stop();
 		bool SetMaxSpeed(float speed);
 
@@ -99,8 +99,8 @@
 		AIClasses *ai;
 
 		// command generators
-		Command MakePosCommand(int id, float3 pos, float radius = -1.0f, int facing = -1);
-		Command MakeIntCommand(int id, int number, int maxnum = 4999);
+		Command MakePosCommand(int cmdID, float3 pos, float radius = -1.0f, int facing = -1);
+		Command MakeIntCommand(int cmdID, int param, int maxParam = 4999);
 };
 
 

Modified: branches/caiinterface/AI/Skirmish/KAIK/UnitHandler.cpp
===================================================================
--- branches/caiinterface/AI/Skirmish/KAIK/UnitHandler.cpp	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/AI/Skirmish/KAIK/UnitHandler.cpp	2008-10-14 17:26:56 UTC (rev 6725)
@@ -117,24 +117,24 @@
 
 // called when unit nanoframe first created
 // (CEconomyTracker deals with UnitFinished())
-void CUnitHandler::UnitCreated(int unit) {
-	int category = ai-&gt;ut-&gt;GetCategory(unit);
-	const UnitDef* newUnitDef = ai-&gt;cb-&gt;GetUnitDef(unit);
+void CUnitHandler::UnitCreated(int unitID) {
+	int ucat = ai-&gt;ut-&gt;GetCategory(unitID);
+	const UnitDef* udef = ai-&gt;cb-&gt;GetUnitDef(unitID);
 
-	if (category != -1) {
-		AllUnitsByCat[category].push_back(unit);
-		AllUnitsByType[newUnitDef-&gt;id].push_back(unit);
+	if (ucat != -1) {
+		AllUnitsByCat[ucat].push_back(unitID);
+		AllUnitsByType[udef-&gt;id].push_back(unitID);
 
-		if (category == CAT_FACTORY) {
-			FactoryAdd(unit);
+		if (ucat == CAT_FACTORY) {
+			FactoryAdd(unitID);
 		}
 
-		BuildTaskCreate(unit);
+		BuildTaskCreate(unitID);
 
-		if (category == CAT_BUILDER) {
+		if (ucat == CAT_BUILDER) {
 			// add the new builder
 			BuilderTracker* builderTracker = new BuilderTracker;
-			builderTracker-&gt;builderID = unit;
+			builderTracker-&gt;builderID = unitID;
 			builderTracker-&gt;buildTaskId = 0;
 			builderTracker-&gt;taskPlanId = 0;
 			builderTracker-&gt;factoryId = 0;
@@ -148,17 +148,24 @@
 			BuilderTrackers.push_back(builderTracker);
 		}
 
-		if (category == CAT_MMAKER) {
-			MMakerAdd(unit);
+		if (ucat == CAT_MMAKER) {
+			MMakerAdd(unitID);
 		}
-		if (category == CAT_MEX) {
-			MetalExtractorAdd(unit);
+		if (ucat == CAT_MEX) {
+			MetalExtractorAdd(unitID);
 		}
 
-		if (category == CAT_NUKE) {
-			NukeSiloAdd(unit);
+		if (ucat == CAT_NUKE) {
+			NukeSiloAdd(unitID);
 		}
 	}
+
+	if (udef-&gt;isCommander &amp;&amp; udef-&gt;canDGun) {
+		ai-&gt;dgunController-&gt;init(unitID);
+	} else {
+		CUNIT* u = ai-&gt;MyUnits[unitID];
+		u-&gt;SetFireState(2);
+	}
 }
 
 void CUnitHandler::UnitDestroyed(int unit) {

Modified: branches/caiinterface/AI/Skirmish/KAIK/UnitTable.cpp
===================================================================
--- branches/caiinterface/AI/Skirmish/KAIK/UnitTable.cpp	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/AI/Skirmish/KAIK/UnitTable.cpp	2008-10-14 17:26:56 UTC (rev 6725)
@@ -770,12 +770,12 @@
 
 
 void CUnitTable::Init() {
-	// get unit defs from game and stick them in the unitTypes[] array
+	// get the unitdefs and stick them in the unitTypes[] array
 	numOfUnits = ai-&gt;cb-&gt;GetNumUnitDefs();
 	unitList = new const UnitDef*[numOfUnits];
 	ai-&gt;cb-&gt;GetUnitDefList(unitList);
 
-	// one more than needed because 0 is dummy object (so
+	// one more than needed because [0] is a dummy object (so
 	// UnitDef-&gt;id can be used to adress that unit in array)
 	unitTypes = new UnitType[numOfUnits + 1];
 
@@ -785,13 +785,19 @@
 		// side has not been assigned - will be done later
 		unitTypes[i].category = -1;
 
+		// GetUnitDefList() filled our unitList
+		// partially with null UnitDef*'s (bad,
+		// nothing much to do if this happens)
+		assert(unitTypes[i].def != 0x0);
+
 		// get build options
 		for (map&lt;int, string&gt;::const_iterator j = unitTypes[i].def-&gt;buildOptions.begin(); j != unitTypes[i].def-&gt;buildOptions.end(); j++) {
-			unitTypes[i].canBuildList.push_back(ai-&gt;cb-&gt;GetUnitDef(j-&gt;second.c_str())-&gt;id);
+			const char* buildOptionName = j-&gt;second.c_str();
+			const UnitDef* buildOptionDef = ai-&gt;cb-&gt;GetUnitDef(buildOptionName);
+			unitTypes[i].canBuildList.push_back(buildOptionDef-&gt;id);
 		}
 	}
 
-
 	// now set sides and create buildtree for each
 	// note: this skips Lua commanders completely!
 	for (int s = 0; s &lt; numOfSides; s++) {

Modified: branches/caiinterface/Documentation/changelog.txt
===================================================================
--- branches/caiinterface/Documentation/changelog.txt	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/Documentation/changelog.txt	2008-10-14 17:26:56 UTC (rev 6725)
@@ -1,5 +1,29 @@
 Spring change log
 
+0.77b4:
+Crashes:
+ - fixed a crash (on exit) in colormap.cpp
+ - fixed another division /0
+ - fix crashes on &quot;/take&quot;
+ - fix crash when loading units into transporters
+
+User Interface:
+ - fix tabulator toggling overview mode
+ - reduce the maxBreaking-is-zero message spam
+ - fix far textures showing up as gray rectangles
+ - the error message &quot;no writable directories found&quot; now has a windows version too
+ - Fix explosion spheres appearing at wrong position
+ - fix attackorder for radar dots
+
+ Engine:
+ - fix attacking gaia units
+ - fix the collision detection for dgun (and other noExplode) projectiles
+ - Made gunships (and possibly other units too) point their noses at the midPos of their target instead of the pos, the old behaviour could cause trouble with units where midPos and pos differ much.
+ - added crashDrag tag (float, default 0.005) to fighter/bomber planes, when the plane is crashing it uses this drag instead of the automatically calculated drag it uses when flying. The calculated drag is no longer used when crashing, even if no crashDrag tag is present in the unit fbi
+ - fix (AirMoveType) aircraft refueling
+ - fix gameend detected not propperly
+ - gameslowdown triggers at higher CPU usage and is limited to half the userspeed
+
 0.77b3:
 User Interface
  - added a simple Orbit-Camera controller

Modified: branches/caiinterface/game/AI/AAI/AAI FAQ.txt
===================================================================
--- branches/caiinterface/game/AI/AAI/AAI FAQ.txt	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/game/AI/AAI/AAI FAQ.txt	2008-10-14 17:26:56 UTC (rev 6725)
@@ -1,7 +1,6 @@
+Author: 	Alexander 		Icq: 138100896					email:	alexander.seizinger
+		Seizinger		Jabber: <A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">alexander.seizinger at jabber.org</A>				@gmx.net
 
-Alexander 'submarine' Seizinger			icq: 138100896			<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">alexander.seizinger at gmx.net</A>
-
-
 Questions:
 
 - The message &quot;AAI not properly initialized, please view ai log for further information&quot; appears

Modified: branches/caiinterface/game/AI/AAI/AAI ReadMe.txt
===================================================================
--- branches/caiinterface/game/AI/AAI/AAI ReadMe.txt	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/game/AI/AAI/AAI ReadMe.txt	2008-10-14 17:26:56 UTC (rev 6725)
@@ -1,4 +1,5 @@
-Author: 	Alexander 'submarine' Seizinger		icq: 138100896		<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">alexander.seizinger at gmx.net</A>
+Author: 	Alexander 		Icq: 138100896					email:	alexander.seizinger
+		Seizinger		Jabber: <A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">alexander.seizinger at jabber.org</A>				@gmx.net
 
 
 Installation: 	Windows users:
@@ -105,15 +106,20 @@
 		- Brandon Potter for his TBT 12 cfg file
 
 
+
+AAI v0.872	- Refactored code for getting rally points and positions to withdraw units and made 
+
+		- Construction units that are member of the DONT_BUILD list will not be built anymore
+		
+		- Fixed two bugs that have been introduced in v0.87 and could cripple AAI's economy a lot
+
+
 AAI v0.87	- Proper detection of amphibious ground units (was causing AAI to freeze on water maps)
 
 		- Prevent AAI from blocking buildqueues for combat units by requesting too many scouts
 
+		- Added proper handling of resurrected units (however AAI does not build resurrectors atm)	
 
-AAI v0.869	- Added proper handling of resurrected units (however AAI does not build resurrectors atm)
-		
-		- Fixed a bug that could prevent AAI from rebuilding destroyed factories	
-
 		- Added some unit specific combat behaviour: Units with high ranged weapons  will now try to keep enemies distant (if 
 		  their turnrate is not too low)
 
@@ -140,6 +146,7 @@
 
 		- Fixed various freezes that have been caused by AAI flooding the ai interface with thousands of orders per frame
 
+		- Fixed a bug that could prevent AAI from rebuilding destroyed factories
 
 		- Bumped mod learning file version to 0.86 due to some changes in handling of amphibious units
 

Deleted: branches/caiinterface/game/AI/AAI/cfg/mod/1944DemoReleasev0.01b.cfg
===================================================================
--- branches/caiinterface/game/AI/AAI/cfg/mod/1944DemoReleasev0.01b.cfg	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/game/AI/AAI/cfg/mod/1944DemoReleasev0.01b.cfg	2008-10-14 17:26:56 UTC (rev 6725)
@@ -1,32 +0,0 @@
-SIDES 2
-START_UNITS heerhq shaefhq
-SIDE_NAMES GERMANY USA
-MAX_SCOUTS 4
-MAX_BUILDERS 50
-MAX_BUILDERS_PER_TYPE 5
-MAX_FACTORIES_PER_TYPE 3
-MIN_ASSISTANCE_BUILDSPEED 50
-MAX_GROUP_SIZE 10
-MAX_AIR_GROUP_SIZE 4
-MAX_XROW 8
-MAX_YROW 8
-X_SPACE 16
-Y_SPACE 16
-MAX_BASE_SIZE 10
-HIGH_RANGE_UNITS_RATE 5
-SCOUT_SPEED 120.0
-GROUND_ARTY_RANGE 2000.0
-STATIONARY_ARTY_RANGE 3210.0
-MIN_ENERGY 18 
-AIRCRAFT_RATE 5 
-AIR_DEFENCE 5
-MAX_METAL_COST 8000
-MAX_DEFENCES 12
-METAL_ENERGY_RATIO 25
-MAX_METAL_MAKERS 15
-MAX_MEX_DISTANCE 9
-MAX_MEX_DEFENCE_DISTANCE 7
-MIN_FACTORIES_FOR_STORAGE 2
-MAX_STAT_ARTY 0
-
-SCOUTS 4 Jeep Kubelwagen GERBeobInf USObserv
\ No newline at end of file

Deleted: branches/caiinterface/game/AI/AAI/cfg/mod/1944publicalpha_v0.01b3d.cfg
===================================================================
--- branches/caiinterface/game/AI/AAI/cfg/mod/1944publicalpha_v0.01b3d.cfg	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/game/AI/AAI/cfg/mod/1944publicalpha_v0.01b3d.cfg	2008-10-14 17:26:56 UTC (rev 6725)
@@ -1,32 +0,0 @@
-SIDES 2
-START_UNITS heerhq shaefhq
-SIDE_NAMES GERMANY USA
-MAX_SCOUTS 4
-MAX_BUILDERS 50
-MAX_BUILDERS_PER_TYPE 5
-MAX_FACTORIES_PER_TYPE 3
-MIN_ASSISTANCE_BUILDSPEED 50
-MAX_GROUP_SIZE 10
-MAX_AIR_GROUP_SIZE 4
-MAX_XROW 8
-MAX_YROW 8
-X_SPACE 16
-Y_SPACE 16
-MAX_BASE_SIZE 10
-HIGH_RANGE_UNITS_RATE 5
-SCOUT_SPEED 120.0
-GROUND_ARTY_RANGE 2000.0
-STATIONARY_ARTY_RANGE 3210.0
-MIN_ENERGY 18 
-AIRCRAFT_RATE 5 
-AIR_DEFENCE 5
-MAX_METAL_COST 8000
-MAX_DEFENCES 12
-METAL_ENERGY_RATIO 25
-MAX_METAL_MAKERS 15
-MAX_MEX_DISTANCE 9
-MAX_MEX_DEFENCE_DISTANCE 7
-MIN_FACTORIES_FOR_STORAGE 2
-MAX_STAT_ARTY 0
-
-SCOUTS 4 Jeep Kubelwagen GERBeobInf USObserv
\ No newline at end of file

Deleted: branches/caiinterface/game/AI/AAI/cfg/mod/BA58.cfg
===================================================================
--- branches/caiinterface/game/AI/AAI/cfg/mod/BA58.cfg	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/game/AI/AAI/cfg/mod/BA58.cfg	2008-10-14 17:26:56 UTC (rev 6725)
@@ -1,37 +0,0 @@
-SIDES 2
-START_UNITS ARMCOM CORCOM
-SIDE_NAMES Arm Core
-MAX_SCOUTS 6
-MAX_BUILDERS 50
-MAX_BUILDERS_PER_TYPE 5
-MAX_FACTORIES_PER_TYPE 3
-MAX_GROUP_SIZE 12
-MAX_AIR_GROUP_SIZE 4
-MAX_XROW 8
-MAX_YROW 8
-X_SPACE 16
-Y_SPACE 16
-MAX_BASE_SIZE 12
-
-HIGH_RANGE_UNITS_RATE 4
-AIRCRAFT_RATE 4 
-
-SCOUT_SPEED 120.0
-SEA_ARTY_RANGE 1300.0
-STATIONARY_ARTY_RANGE 3210.0
-MAX_STAT_ARTY 3
-
-MIN_ENERGY 18 
-
-MAX_METAL_COST 8000
-MAX_DEFENCES 14
-METAL_ENERGY_RATIO 25
-MAX_METAL_MAKERS 15
-MAX_MEX_DISTANCE 8
-MAX_MEX_DEFENCE_DISTANCE 7
-
-NON_AMPHIB_MAX_WATERDEPTH 22
-
-SCOUTS 14 CORFAV ARMFAV ARMPEEP CORFINK ARMAWAC CORAWAC ARMFLEA ARMFAST ARMSH CORSH CORPT ARMPT ARMSPY CORSPY
-DONT_BUILD 4 aafus cafus armmlv cormlv
-TRANSPORTERS 8 corthovr armthovr corvalk armatlas armsl armdfly cortship armtship

Deleted: branches/caiinterface/game/AI/AAI/cfg/mod/BA591.cfg
===================================================================
--- branches/caiinterface/game/AI/AAI/cfg/mod/BA591.cfg	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/game/AI/AAI/cfg/mod/BA591.cfg	2008-10-14 17:26:56 UTC (rev 6725)
@@ -1,37 +0,0 @@
-SIDES 2
-START_UNITS ARMCOM CORCOM
-SIDE_NAMES Arm Core
-MAX_SCOUTS 6
-MAX_BUILDERS 50
-MAX_BUILDERS_PER_TYPE 5
-MAX_FACTORIES_PER_TYPE 3
-MAX_GROUP_SIZE 12
-MAX_AIR_GROUP_SIZE 4
-MAX_XROW 8
-MAX_YROW 8
-X_SPACE 16
-Y_SPACE 16
-MAX_BASE_SIZE 12
-
-HIGH_RANGE_UNITS_RATE 4
-AIRCRAFT_RATE 4 
-
-SCOUT_SPEED 120.0
-SEA_ARTY_RANGE 1300.0
-STATIONARY_ARTY_RANGE 3210.0
-MAX_STAT_ARTY 3
-
-MIN_ENERGY 18 
-
-MAX_METAL_COST 8000
-MAX_DEFENCES 14
-METAL_ENERGY_RATIO 25
-MAX_METAL_MAKERS 15
-MAX_MEX_DISTANCE 8
-MAX_MEX_DEFENCE_DISTANCE 7
-
-NON_AMPHIB_MAX_WATERDEPTH 22
-
-SCOUTS 14 CORFAV ARMFAV ARMPEEP CORFINK ARMAWAC CORAWAC ARMFLEA ARMFAST ARMSH CORSH CORPT ARMPT ARMSPY CORSPY
-DONT_BUILD 4 aafus cafus armmlv cormlv
-TRANSPORTERS 8 corthovr armthovr corvalk armatlas armsl armdfly cortship armtship
\ No newline at end of file

Deleted: branches/caiinterface/game/AI/AAI/cfg/mod/BA60.cfg
===================================================================
--- branches/caiinterface/game/AI/AAI/cfg/mod/BA60.cfg	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/game/AI/AAI/cfg/mod/BA60.cfg	2008-10-14 17:26:56 UTC (rev 6725)
@@ -1,37 +0,0 @@
-SIDES 2
-START_UNITS ARMCOM CORCOM
-SIDE_NAMES Arm Core
-MAX_SCOUTS 6
-MAX_BUILDERS 50
-MAX_BUILDERS_PER_TYPE 5
-MAX_FACTORIES_PER_TYPE 3
-MAX_GROUP_SIZE 12
-MAX_AIR_GROUP_SIZE 4
-MAX_XROW 8
-MAX_YROW 8
-X_SPACE 16
-Y_SPACE 16
-MAX_BASE_SIZE 12
-
-HIGH_RANGE_UNITS_RATE 4
-AIRCRAFT_RATE 4 
-
-SCOUT_SPEED 120.0
-SEA_ARTY_RANGE 1300.0
-STATIONARY_ARTY_RANGE 3210.0
-MAX_STAT_ARTY 3
-
-MIN_ENERGY 18 
-
-MAX_METAL_COST 8000
-MAX_DEFENCES 14
-METAL_ENERGY_RATIO 25
-MAX_METAL_MAKERS 15
-MAX_MEX_DISTANCE 8
-MAX_MEX_DEFENCE_DISTANCE 7
-
-NON_AMPHIB_MAX_WATERDEPTH 22
-
-SCOUTS 14 CORFAV ARMFAV ARMPEEP CORFINK ARMAWAC CORAWAC ARMFLEA ARMFAST ARMSH CORSH CORPT ARMPT ARMSPY CORSPY
-DONT_BUILD 4 aafus cafus armmlv cormlv
-TRANSPORTERS 8 corthovr armthovr corvalk armatlas armsl armdfly cortship armtship
\ No newline at end of file

Deleted: branches/caiinterface/game/AI/AAI/cfg/mod/BA621.cfg
===================================================================
--- branches/caiinterface/game/AI/AAI/cfg/mod/BA621.cfg	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/game/AI/AAI/cfg/mod/BA621.cfg	2008-10-14 17:26:56 UTC (rev 6725)
@@ -1,37 +0,0 @@
-SIDES 2
-START_UNITS ARMCOM CORCOM
-SIDE_NAMES Arm Core
-MAX_SCOUTS 6
-MAX_BUILDERS 50
-MAX_BUILDERS_PER_TYPE 5
-MAX_FACTORIES_PER_TYPE 3
-MAX_GROUP_SIZE 12
-MAX_AIR_GROUP_SIZE 4
-MAX_XROW 8
-MAX_YROW 8
-X_SPACE 16
-Y_SPACE 16
-MAX_BASE_SIZE 12
-
-HIGH_RANGE_UNITS_RATE 4
-AIRCRAFT_RATE 4 
-
-SCOUT_SPEED 120.0
-SEA_ARTY_RANGE 1300.0
-STATIONARY_ARTY_RANGE 3210.0
-MAX_STAT_ARTY 3
-
-MIN_ENERGY 18 
-
-MAX_METAL_COST 8000
-MAX_DEFENCES 14
-METAL_ENERGY_RATIO 25
-MAX_METAL_MAKERS 15
-MAX_MEX_DISTANCE 8
-MAX_MEX_DEFENCE_DISTANCE 7
-
-NON_AMPHIB_MAX_WATERDEPTH 22
-
-SCOUTS 14 CORFAV ARMFAV ARMPEEP CORFINK ARMAWAC CORAWAC ARMFLEA ARMFAST ARMSH CORSH CORPT ARMPT ARMSPY CORSPY
-DONT_BUILD 4 aafus cafus armmlv cormlv
-TRANSPORTERS 8 corthovr armthovr corvalk armatlas armsl armdfly cortship armtship
\ No newline at end of file

Modified: branches/caiinterface/game/AI/AAI/cfg/mod/BA_Installer_Version.cfg
===================================================================
--- branches/caiinterface/game/AI/AAI/cfg/mod/BA_Installer_Version.cfg	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/game/AI/AAI/cfg/mod/BA_Installer_Version.cfg	2008-10-14 17:26:56 UTC (rev 6725)
@@ -33,5 +33,5 @@
 NON_AMPHIB_MAX_WATERDEPTH 22
 
 SCOUTS 14 CORFAV ARMFAV ARMPEEP CORFINK ARMAWAC CORAWAC ARMFLEA ARMFAST ARMSH CORSH CORPT ARMPT ARMSPY CORSPY
-DONT_BUILD 4 aafus cafus armmlv cormlv
+DONT_BUILD 12 aafus cafus armmlv cormlv armfmine3 armmine1 armmine2 armmine3 corfmine3 cormine1 cormine2 cormine3
 TRANSPORTERS 8 corthovr armthovr corvalk armatlas armsl armdfly cortship armtship
\ No newline at end of file

Deleted: branches/caiinterface/game/AI/AAI/cfg/mod/FleabowlNR10.cfg
===================================================================
--- branches/caiinterface/game/AI/AAI/cfg/mod/FleabowlNR10.cfg	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/game/AI/AAI/cfg/mod/FleabowlNR10.cfg	2008-10-14 17:26:56 UTC (rev 6725)
@@ -1,21 +0,0 @@
-SIDES 4
-START_UNITS ARMCOM CORCOM AKCOM FBCOM
-SIDE_NAMES Arm Core AKBowl Fleabowl
-MAX_SCOUTS 0
-MAX_BUILDERS 25
-MAX_BUILDERS_PER_TYPE 3
-MAX_GROUP_SIZE 16
-MIN_EFFICIENCY 0.1
-MAX_XROW 8
-MAX_YROW 8
-X_SPACE 12
-Y_SPACE 12
-SECTOR_SIZE 100.0
-MAX_SECTOR_IMPORTANCE 6
-MAX_BASE_SIZE 4
-SCOUT_SPEED 950.0
-MOBILE_ARTY_RANGE 1000.0
-STATIONARY_ARTY_RANGE 3000.0
-MIN_ENERGY 18  
-AIR_DEFENCE 0
-SCOUTS 0
\ No newline at end of file

Deleted: branches/caiinterface/game/AI/AAI/cfg/mod/S44LiteRelease.cfg
===================================================================
--- branches/caiinterface/game/AI/AAI/cfg/mod/S44LiteRelease.cfg	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/game/AI/AAI/cfg/mod/S44LiteRelease.cfg	2008-10-14 17:26:56 UTC (rev 6725)
@@ -1,32 +0,0 @@
-SIDES 4
-START_UNITS GERHQBunker GBRHQ RUSCommander USHQ
-SIDE_NAMES GERMANY GB USSR USA
-MAX_SCOUTS 4
-MAX_BUILDERS 50
-MAX_BUILDERS_PER_TYPE 5
-MAX_FACTORIES_PER_TYPE 3
-MIN_ASSISTANCE_BUILDSPEED 50
-MAX_GROUP_SIZE 10
-MAX_AIR_GROUP_SIZE 4
-MAX_XROW 8
-MAX_YROW 8
-X_SPACE 16
-Y_SPACE 16
-MAX_BASE_SIZE 10
-HIGH_RANGE_UNITS_RATE 5
-SCOUT_SPEED 1200.0
-GROUND_ARTY_RANGE 3000.0
-STATIONARY_ARTY_RANGE 3210.0
-MIN_ENERGY 1
-AIRCRAFT_RATE 5 
-AIR_DEFENCE 5
-MAX_METAL_COST 8000
-MAX_DEFENCES 12
-METAL_ENERGY_RATIO 25
-MAX_METAL_MAKERS 15
-MAX_MEX_DISTANCE 9
-MAX_MEX_DEFENCE_DISTANCE 7
-MIN_FACTORIES_FOR_STORAGE 2
-MAX_STAT_ARTY 0
-SCOUTS 7 USM8Greyhound GERBeobInf USObserv GBRObserv GBRDaimler RUSObserv RUSBA64
-ATTACKERS 6 GBRRifle GBRSTEN USGIRifle USGIThompson GERPanzerGren GERMP40
\ No newline at end of file

Copied: branches/caiinterface/game/AI/AAI/cfg/mod/S44_Installer_Version.cfg (from rev 6724, trunk/game/AI/AAI/cfg/mod/S44_Installer_Version.cfg)
===================================================================
--- branches/caiinterface/game/AI/AAI/cfg/mod/S44_Installer_Version.cfg	                        (rev 0)
+++ branches/caiinterface/game/AI/AAI/cfg/mod/S44_Installer_Version.cfg	2008-10-14 17:26:56 UTC (rev 6725)
@@ -0,0 +1,33 @@
+SIDES 4
+START_UNITS GERHQBunker GBRHQ RUSCommander USHQ
+SIDE_NAMES GERMANY GB USSR USA
+MAX_SCOUTS 4
+MAX_BUILDERS 50
+MAX_BUILDERS_PER_TYPE 5
+MAX_FACTORIES_PER_TYPE 3
+MIN_ASSISTANCE_BUILDSPEED 50
+MAX_GROUP_SIZE 10
+MAX_AIR_GROUP_SIZE 4
+MAX_XROW 8
+MAX_YROW 8
+X_SPACE 16
+Y_SPACE 16
+MAX_BASE_SIZE 10
+HIGH_RANGE_UNITS_RATE 5
+SCOUT_SPEED 1200.0
+GROUND_ARTY_RANGE 3000.0
+STATIONARY_ARTY_RANGE 3210.0
+MIN_ENERGY 1
+AIRCRAFT_RATE 5 
+AIR_DEFENCE 5
+MAX_METAL_COST 8000
+MAX_DEFENCES 12
+METAL_ENERGY_RATIO 25
+MAX_METAL_MAKERS 15
+MAX_MEX_DISTANCE 9
+MAX_MEX_DEFENCE_DISTANCE 7
+MIN_FACTORIES_FOR_STORAGE 2
+MAX_STAT_ARTY 0
+SCOUTS 7 USM8Greyhound GERBeobInf USObserv GBRObserv GBRDaimler RUSObserv RUSBA64
+ATTACKERS 6 GBRRifle GBRSTEN USGIRifle USGIThompson GERPanzerGren GERMP40
+DONT_BUILD 2 atmine apmine
\ No newline at end of file

Modified: branches/caiinterface/game/AI/AAI/cfg/mod/XTA_Installer_Version.cfg
===================================================================
--- branches/caiinterface/game/AI/AAI/cfg/mod/XTA_Installer_Version.cfg	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/game/AI/AAI/cfg/mod/XTA_Installer_Version.cfg	2008-10-14 17:26:56 UTC (rev 6725)
@@ -24,3 +24,5 @@
 MAX_MEX_DEFENCE_DISTANCE 8
 NON_AMPHIB_MAX_WATERDEPTH 25
 SCOUTS 13 arm_jeffy core_weasel arm_peeper core_fink arm_eagle core_vulture arm_zipper core_freaker arm_flea arm_skimmer core_scrubber arm_skeeter core_searcher
+
+DONT_BUILD 2 arm_podger core_spoiler

Modified: branches/caiinterface/rts/ExternalAI/AIInterfaceLibrary.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/AIInterfaceLibrary.cpp	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/rts/ExternalAI/AIInterfaceLibrary.cpp	2008-10-14 17:26:56 UTC (rev 6725)
@@ -38,8 +38,6 @@
 */
 CAIInterfaceLibrary::CAIInterfaceLibrary(const CAIInterfaceLibraryInfo* _info)
 		: info(_info) {
-	
-	std::string libFilePath;
 
 	std::string libFileName = info-&gt;GetFileName();
 	if (libFileName.empty()) {
@@ -74,7 +72,17 @@
 	
 	if (sAIInterfaceLibrary.initStatic != NULL) {
 		staticGlobalData = createStaticGlobalData();
-		sAIInterfaceLibrary.initStatic(staticGlobalData);
+		int ret = sAIInterfaceLibrary.initStatic(staticGlobalData);
+		if (ret != 0) {
+			// initializing the library failed!
+			const int MAX_MSG_LENGTH = 511;
+			char s_msg[MAX_MSG_LENGTH + 1];
+			SNPRINTF(s_msg, MAX_MSG_LENGTH,
+					&quot;Error initializing AI Interface library from file\n\&quot;%s\&quot;.\n&quot;
+					&quot;The call to initStatic() returned unsuccessfuly.&quot;,
+					libFilePath.c_str());
+			handleerror(NULL, s_msg, &quot;AI Interface Error&quot;, MBF_OK | MBF_EXCL);
+		}
 	} else {
 		staticGlobalData = NULL;
 	}
@@ -82,7 +90,17 @@
 void CAIInterfaceLibrary::ReleaseStatic() {
 	
 	if (sAIInterfaceLibrary.releaseStatic != NULL) {
-		sAIInterfaceLibrary.releaseStatic();
+		int ret = sAIInterfaceLibrary.releaseStatic();
+		if (ret != 0) {
+			// releasing the library failed!
+			const int MAX_MSG_LENGTH = 511;
+			char s_msg[MAX_MSG_LENGTH + 1];
+			SNPRINTF(s_msg, MAX_MSG_LENGTH,
+					&quot;Error releasing AI Interface Library from file\n\&quot;%s\&quot;.\n&quot;
+					&quot;The call to releaseStatic() returned unsuccessfuly.&quot;,
+					libFilePath.c_str());
+			handleerror(NULL, s_msg, &quot;AI Interface Error&quot;, MBF_OK | MBF_EXCL);
+		}
 	}
 	if (staticGlobalData != NULL) {
 		freeStaticGlobalData(staticGlobalData);

Modified: branches/caiinterface/rts/ExternalAI/AIInterfaceLibrary.h
===================================================================
--- branches/caiinterface/rts/ExternalAI/AIInterfaceLibrary.h	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/rts/ExternalAI/AIInterfaceLibrary.h	2008-10-14 17:26:56 UTC (rev 6725)
@@ -75,6 +75,7 @@
 	
 private:
 	//std::string aiInterfacesLibDir;
+	std::string libFilePath;
 	SharedLib* sharedLib;
 	SAIInterfaceLibrary sAIInterfaceLibrary;
 	//SAIInterfaceSpecifier specifier;

Modified: branches/caiinterface/rts/Sim/MoveTypes/AirMoveType.cpp
===================================================================
--- branches/caiinterface/rts/Sim/MoveTypes/AirMoveType.cpp	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/rts/Sim/MoveTypes/AirMoveType.cpp	2008-10-14 17:26:56 UTC (rev 6725)
@@ -219,7 +219,7 @@
 			owner-&gt;pos = pos;
 
 			owner-&gt;AddBuildPower(unit-&gt;unitDef-&gt;buildSpeed / 30, unit);
-			owner-&gt;currentFuel = std::min (owner-&gt;unitDef-&gt;maxFuel, owner-&gt;currentFuel + (owner-&gt;unitDef-&gt;maxFuel / (GAME_SPEED * owner-&gt;unitDef-&gt;refuelTime)));
+			owner-&gt;currentFuel = std::min(owner-&gt;unitDef-&gt;maxFuel, owner-&gt;currentFuel + (owner-&gt;unitDef-&gt;maxFuel / (GAME_SPEED * owner-&gt;unitDef-&gt;refuelTime)));
 
 			if (owner-&gt;health &gt;= owner-&gt;maxHealth - 1 &amp;&amp; owner-&gt;currentFuel &gt;= owner-&gt;unitDef-&gt;maxFuel) {
 				// repaired and filled up, leave the pad
@@ -234,7 +234,7 @@
 
 
 	switch (aircraftState) {
-		case AIRCRAFT_FLYING:
+		case AIRCRAFT_FLYING: {
 	#ifdef DEBUG_AIRCRAFT
 			if (selectedUnits.selectedUnits.find(this) != selectedUnits.selectedUnits.end()) {
 				logOutput.Print(&quot;Flying %i %i %.1f %i&quot;, moveState, fireState, inefficientAttackTime, (int) isFighter);
@@ -243,7 +243,13 @@
 
 			owner-&gt;restTime = 0;
 
-			if (!reservedPad &amp;&amp; (owner-&gt;userTarget || owner-&gt;userAttackGround)) {
+			// somewhat hackish, but planes that have attack orders
+			// while no pad is available would otherwise continue
+			// attacking even if out of fuel
+			bool continueAttack =
+				(!reservedPad &amp;&amp; ((owner-&gt;currentFuel &gt; 0.0f) || owner-&gt;unitDef-&gt;maxFuel &lt;= 0.0f));
+
+			if (continueAttack &amp;&amp; ((owner-&gt;userTarget &amp;&amp; !owner-&gt;userTarget-&gt;isDead) || owner-&gt;userAttackGround)) {
 				inefficientAttackTime = std::min(inefficientAttackTime, float(gs-&gt;frameNum) - owner-&gt;lastFireWeapon);
 
 				if (owner-&gt;userTarget) {
@@ -265,7 +271,7 @@
 				inefficientAttackTime = 0;
 				UpdateFlying(wantedHeight, 1);
 			}
-			break;
+		} break;
 		case AIRCRAFT_LANDED:
 			inefficientAttackTime = 0;
 			UpdateLanded();
@@ -615,44 +621,18 @@
 	}
 #endif
 
-	if(groundTarget)
+	if (groundTarget)
 		engine = 1;
 	else
 		engine = std::min(1.f, (float)(goalLength / owner-&gt;maxRange + 1 - goalDir.dot(frontdir) * 0.7f));
 
 	UpdateAirPhysics(rudder, aileron, elevator, engine, owner-&gt;frontdir);
-/*
-	std::vector&lt;CWeapon*&gt;::iterator wi;
-	for(wi=owner-&gt;weapons.begin();wi!=owner-&gt;weapons.end();++wi){
-		(*wi)-&gt;targetPos=goalPos;
-		if(owner-&gt;userTarget){
-			(*wi)-&gt;AttackUnit(owner-&gt;userTarget,true);
-		}
-	}*/
-/*	DrawLine dl;
-	dl.color=UpVector;
-	dl.pos1=pos;
-	dl.pos2=goalPos;
-	lines.push_back(dl);
-	dl.color=float3(1,0,0);
-	dl.pos1=pos;
-	dl.pos2=pos+frontdir*maxRange;
-	lines.push_back(dl);/**/
 }
 
 
 
 void CAirMoveType::UpdateAttack(void)
 {
-	/*
-	std::vector&lt;CWeapon*&gt;::iterator wi;
-	for (wi = owner-&gt;weapons.begin(); wi != owner-&gt;weapons.end(); ++wi) {
-		(*wi)-&gt;targetPos = goalPos;
-		if (owner-&gt;userTarget) {
-			(*wi)-&gt;AttackUnit(owner-&gt;userTarget, true);
-		}
-	}
-	*/
 	UpdateFlying(wantedHeight, 1);
 }
 
@@ -660,16 +640,16 @@
 
 void CAirMoveType::UpdateFlying(float wantedHeight, float engine)
 {
-	float3 &amp;pos = owner-&gt;pos;
-	SyncedFloat3 &amp;rightdir = owner-&gt;rightdir;
-	SyncedFloat3 &amp;frontdir = owner-&gt;frontdir;
-	SyncedFloat3 &amp;updir = owner-&gt;updir;
-	float3 &amp;speed = owner-&gt;speed;
+	float3&amp; pos = owner-&gt;pos;
+	SyncedFloat3&amp; rightdir = owner-&gt;rightdir;
+	SyncedFloat3&amp; frontdir = owner-&gt;frontdir;
+	SyncedFloat3&amp; updir = owner-&gt;updir;
+	float3&amp; speed = owner-&gt;speed;
 
 	float speedf = speed.Length();
 	float goalLength = (goalPos - pos).Length2D() + 0.01f;
 	float3 goalDir = (goalPos - pos) / goalLength;
-	float3 adjustedGoalDir = float3(goalPos.x,0,goalPos.z) - float3(pos.x,0,pos.z);
+	float3 adjustedGoalDir = float3(goalPos.x, 0, goalPos.z) - float3(pos.x, 0, pos.z);
 	goalDir.Normalize();
 	adjustedGoalDir.Normalize();
 
@@ -686,8 +666,8 @@
 	float3 otherDir;
 	if (lastColWarning) {
 		float3 otherDif = lastColWarning-&gt;pos - pos;
-		float otherLength = otherDif.Length();
-		otherDir = otherDif / (otherLength + 0.01f);
+		float otherLength = otherDif.Length() + 0.01f;
+		otherDir = otherDif / (otherLength);
 		otherThreat = std::max(1200.0f, goalLength) / otherLength * 0.036f;
 	}
 
@@ -886,18 +866,24 @@
 	// update our speed
 	float3 dif = reservedLandingPos - pos;
 	float dist = dif.Length();
-	dif /= dist;
 
+	if (dist &gt; 0.0f) {
+		dif /= dist;
+	}
+
 	float wsf = std::min(owner-&gt;maxSpeed, dist / speedf * 1.8f * maxAcc);
 	float3 wantedSpeed = dif * wsf;
 
 	float3 delta = wantedSpeed - speed;
 	float dl = delta.Length();
 
-	if (dl &lt; maxAcc * 3)
+	if (dl &lt; maxAcc * 3) {
 		speed = wantedSpeed;
-	else
-		speed += delta / dl * maxAcc * 3;
+	} else {
+		if (dl &gt; 0.0f) {
+			speed += delta / dl * maxAcc * 3;
+		}
+	}
 
 	pos += speed;
 

Modified: branches/caiinterface/rts/Sim/Units/CommandAI/MobileCAI.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/CommandAI/MobileCAI.cpp	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/rts/Sim/Units/CommandAI/MobileCAI.cpp	2008-10-14 17:26:56 UTC (rev 6725)
@@ -275,22 +275,26 @@
 		if (owner-&gt;currentFuel &lt;= 0) {
 			// we're out of fuel
 			StopMove();
+
 			owner-&gt;userAttackGround = false;
 			owner-&gt;userTarget = 0;
 			inCommand = false;
 
-			CAirBaseHandler::LandingPad* lp = airBaseHandler-&gt;FindAirBase(
-				owner, owner-&gt;unitDef-&gt;minAirBasePower);
+			CAirBaseHandler::LandingPad* lp =
+				airBaseHandler-&gt;FindAirBase(owner, owner-&gt;unitDef-&gt;minAirBasePower);
 
 			if (lp) {
 				// found a pad
 				owner-&gt;moveType-&gt;ReservePad(lp);
 			} else {
-				float3 landingPos = airBaseHandler-&gt;FindClosestAirBasePos(
-					owner, owner-&gt;unitDef-&gt;minAirBasePower);
+				// no pads available, search for a landing
+				// spot near any that are currently occupied
+				float3 landingPos =
+					airBaseHandler-&gt;FindClosestAirBasePos(owner, owner-&gt;unitDef-&gt;minAirBasePower);
 
-				if (landingPos != ZeroVector &amp;&amp; owner-&gt;pos.distance2D(landingPos) &gt; 800) {
-					// didn't find a pad, but we have an in-range ('&gt;' ?) landing pos
+				if (landingPos != ZeroVector) {
+					// NOTE: owner-&gt;userAttackGround is wrongly reset to
+					// true in CUnit::AttackGround() via ExecuteAttack()
 					SetGoal(landingPos, owner-&gt;pos);
 				} else {
 					owner-&gt;moveType-&gt;StopMoving();

Modified: branches/caiinterface/rts/Sim/Units/Unit.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/Unit.cpp	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/rts/Sim/Units/Unit.cpp	2008-10-14 17:26:56 UTC (rev 6725)
@@ -244,10 +244,6 @@
 	// clean up if we are still under movectrl here
 	DisableScriptMoveType();
 
-	// not all unit deletions run through KillUnit(),
-	// but we always want to call this for ourselves
-	UnBlock();
-
 	if (delayedWreckLevel &gt;= 0) {
 		// note: could also do this in Update() or even in CUnitKilledCB()
 		// where we wouldn't need deathSpeed, but not in KillUnit() since
@@ -287,6 +283,10 @@
 	delete prevMoveType;    prevMoveType    = NULL;
 	delete collisionVolume; collisionVolume = NULL;
 
+	// not all unit deletions run through KillUnit(),
+	// but we always want to call this for ourselves
+	UnBlock();
+
 	if (group) {
 		group-&gt;RemoveUnit(this);
 	}
@@ -1445,12 +1445,13 @@
 	userAttackGround = false;
 	commandShotCount = 0;
 	SetUserTarget(unit);
+
 	std::vector&lt;CWeapon*&gt;::iterator wi;
-	for(wi = weapons.begin(); wi != weapons.end(); ++wi){
+	for (wi = weapons.begin(); wi != weapons.end(); ++wi) {
 		(*wi)-&gt;haveUserTarget = false;
 		(*wi)-&gt;targetType = Target_None;
-		if(dgun || !unitDef-&gt;canDGun || !(*wi)-&gt;weaponDef-&gt;manualfire)
-			if((*wi)-&gt;AttackUnit(unit, true))
+		if (dgun || !unitDef-&gt;canDGun || !(*wi)-&gt;weaponDef-&gt;manualfire)
+			if ((*wi)-&gt;AttackUnit(unit, true))
 				r = true;
 	}
 	return r;
@@ -1459,18 +1460,19 @@
 
 bool CUnit::AttackGround(const float3 &amp;pos, bool dgun)
 {
-	bool r=false;
-	haveDGunRequest=dgun;
+	bool r = false;
+	haveDGunRequest = dgun;
 	SetUserTarget(0);
-	userAttackPos=pos;
-	userAttackGround=true;
-	commandShotCount=0;
+	userAttackPos = pos;
+	userAttackGround = true;
+	commandShotCount = 0;
+
 	std::vector&lt;CWeapon*&gt;::iterator wi;
-	for(wi=weapons.begin();wi!=weapons.end();++wi){
-		(*wi)-&gt;haveUserTarget=false;
-		if(dgun || !unitDef-&gt;canDGun || !(*wi)-&gt;weaponDef-&gt;manualfire)
-			if((*wi)-&gt;AttackGround(pos,true))
-				r=true;
+	for (wi = weapons.begin(); wi != weapons.end(); ++wi) {
+		(*wi)-&gt;haveUserTarget = false;
+		if (dgun || !unitDef-&gt;canDGun || !(*wi)-&gt;weaponDef-&gt;manualfire)
+			if ((*wi)-&gt;AttackGround(pos, true))
+				r = true;
 	}
 	return r;
 }

Modified: branches/caiinterface/rts/System/Net/UDPConnection.h
===================================================================
--- branches/caiinterface/rts/System/Net/UDPConnection.h	2008-10-14 15:51:55 UTC (rev 6724)
+++ branches/caiinterface/rts/System/Net/UDPConnection.h	2008-10-14 17:26:56 UTC (rev 6725)
@@ -11,7 +11,7 @@
 
 namespace netcode {
 #ifndef SYNCDEBUG
-const unsigned UDPBufferSize = 8192;
+const unsigned UDPBufferSize = 16384;
 #else
 const unsigned UDPBufferSize = 40000;
 #endif


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001493.html">[Taspring-linux-commit] r6724 - in trunk/rts/Sim: MoveTypes Units	Units/CommandAI
</A></li>
	<LI>Next message: <A HREF="001495.html">[Taspring-linux-commit] r6726 - trunk/rts/Sim/MoveTypes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1494">[ date ]</a>
              <a href="thread.html#1494">[ thread ]</a>
              <a href="subject.html#1494">[ subject ]</a>
              <a href="author.html#1494">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
