<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r6609 - in branches/caiinterface:	AI/Interfaces/C AI/Skirmish AI/Skirmish/KAIK-0.13	AI/Skirmish/NullAI AI/Skirmish/NullLegacyCppAI	AI/Skirmish/RAI-0.553 rts/ExternalAI rts/ExternalAI/Interface
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-October/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6609%20-%20in%20branches/caiinterface%3A%0A%09AI/Interfaces/C%20AI/Skirmish%20AI/Skirmish/KAIK-0.13%0A%09AI/Skirmish/NullAI%20AI/Skirmish/NullLegacyCppAI%0A%09AI/Skirmish/RAI-0.553%20rts/ExternalAI%20rts/ExternalAI/Interface&In-Reply-To=%3C20081008120609.BDE5D46E8%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001377.html">
   <LINK REL="Next"  HREF="001379.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r6609 - in branches/caiinterface:	AI/Interfaces/C AI/Skirmish AI/Skirmish/KAIK-0.13	AI/Skirmish/NullAI AI/Skirmish/NullLegacyCppAI	AI/Skirmish/RAI-0.553 rts/ExternalAI rts/ExternalAI/Interface</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6609%20-%20in%20branches/caiinterface%3A%0A%09AI/Interfaces/C%20AI/Skirmish%20AI/Skirmish/KAIK-0.13%0A%09AI/Skirmish/NullAI%20AI/Skirmish/NullLegacyCppAI%0A%09AI/Skirmish/RAI-0.553%20rts/ExternalAI%20rts/ExternalAI/Interface&In-Reply-To=%3C20081008120609.BDE5D46E8%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r6609 - in branches/caiinterface:	AI/Interfaces/C AI/Skirmish AI/Skirmish/KAIK-0.13	AI/Skirmish/NullAI AI/Skirmish/NullLegacyCppAI	AI/Skirmish/RAI-0.553 rts/ExternalAI rts/ExternalAI/Interface">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Wed Oct  8 14:06:09 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001377.html">[Taspring-linux-commit] r6608 - trunk/rts/Rendering/Env
</A></li>
        <LI>Next message: <A HREF="001379.html">[Taspring-linux-commit] r6610 - trunk/tools/DedicatedServer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1378">[ date ]</a>
              <a href="thread.html#1378">[ thread ]</a>
              <a href="subject.html#1378">[ subject ]</a>
              <a href="author.html#1378">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: hoijui
Date: 2008-10-08 14:06:09 +0200 (Wed, 08 Oct 2008)
New Revision: 6609

Removed:
   branches/caiinterface/AI/Skirmish/NullLegacyCppAI/TestAI.cpp
Modified:
   branches/caiinterface/AI/Interfaces/C/Interface.cpp
   branches/caiinterface/AI/Skirmish/CMakeLists.txt
   branches/caiinterface/AI/Skirmish/KAIK-0.13/AIExport.h
   branches/caiinterface/AI/Skirmish/KAIK-0.13/AIExports.cpp
   branches/caiinterface/AI/Skirmish/NullAI/AIExport.cpp
   branches/caiinterface/AI/Skirmish/NullAI/AIExport.h
   branches/caiinterface/AI/Skirmish/NullLegacyCppAI/AIExport.cpp
   branches/caiinterface/AI/Skirmish/NullLegacyCppAI/AIExport.h
   branches/caiinterface/AI/Skirmish/RAI-0.553/AIExport.cpp
   branches/caiinterface/AI/Skirmish/RAI-0.553/AIExport.h
   branches/caiinterface/rts/ExternalAI/AIInterfaceLibrary.cpp
   branches/caiinterface/rts/ExternalAI/GroupAILibrary.cpp
   branches/caiinterface/rts/ExternalAI/Interface/AISEvents.h
   branches/caiinterface/rts/ExternalAI/Interface/SAICallback.h
   branches/caiinterface/rts/ExternalAI/Interface/SAIInterfaceLibrary.cpp
   branches/caiinterface/rts/ExternalAI/Interface/SAIInterfaceLibrary.h
   branches/caiinterface/rts/ExternalAI/Interface/SGAILibrary.h
   branches/caiinterface/rts/ExternalAI/Interface/SInfo.cpp
   branches/caiinterface/rts/ExternalAI/Interface/SInfo.h
   branches/caiinterface/rts/ExternalAI/Interface/SOption.cpp
   branches/caiinterface/rts/ExternalAI/Interface/SOption.h
   branches/caiinterface/rts/ExternalAI/Interface/SSAILibrary.h
   branches/caiinterface/rts/ExternalAI/SkirmishAILibrary.cpp
   branches/caiinterface/rts/ExternalAI/SkirmishAIWrapper.cpp
   branches/caiinterface/rts/ExternalAI/SkirmishAIWrapper.h
Log:
- made NullLegacyCppAI working
- beautify ExternalAI/Interface stuff (see below)
- added comments for all functions in the three AI library structs
- as we have init() and INIT)EVENT, we also need a RELEASE_EVENT (in addition to release(team)) - done
- made init() and release() optional (as they make no sense for non-OO languages)
- removed some unnecessary files

Modified: branches/caiinterface/AI/Interfaces/C/Interface.cpp
===================================================================
--- branches/caiinterface/AI/Interfaces/C/Interface.cpp	2008-10-08 11:14:09 UTC (rev 6608)
+++ branches/caiinterface/AI/Interfaces/C/Interface.cpp	2008-10-08 12:06:09 UTC (rev 6609)
@@ -287,14 +287,14 @@
 	std::string funcName;
 	
 	funcName = &quot;getInfos&quot;;
-    skirmishAILibrary-&gt;getInfos = (int (CALLING_CONV_FUNC_POINTER *)(InfoItem[], int)) sharedLib-&gt;FindAddress(funcName.c_str());
+    skirmishAILibrary-&gt;getInfos = (unsigned int (CALLING_CONV_FUNC_POINTER *)(InfoItem[], unsigned int)) sharedLib-&gt;FindAddress(funcName.c_str());
     if (skirmishAILibrary-&gt;getInfos == NULL) {
 		// do nothing: this is permitted, if the AI supplies infos through an AIInfo.lua file
 		//reportInterfaceFunctionError(libFilePath, funcName);
     }
 	
 	funcName = &quot;getOptions&quot;;
-    skirmishAILibrary-&gt;getOptions = (int (CALLING_CONV_FUNC_POINTER *)(Option*, int max)) sharedLib-&gt;FindAddress(funcName.c_str());
+    skirmishAILibrary-&gt;getOptions = (unsigned int (CALLING_CONV_FUNC_POINTER *)(Option[], unsigned int max)) sharedLib-&gt;FindAddress(funcName.c_str());
     if (skirmishAILibrary-&gt;getOptions == NULL) {
 		// do nothing: this is permitted, if the AI supplies options through an AIOptions.lua file
 		//reportInterfaceFunctionError(libFilePath, funcName);
@@ -310,13 +310,17 @@
 	funcName = &quot;init&quot;;
     skirmishAILibrary-&gt;init = (int (CALLING_CONV_FUNC_POINTER *)(int)) sharedLib-&gt;FindAddress(funcName.c_str());
     if (skirmishAILibrary-&gt;init == NULL) {
-		reportInterfaceFunctionError(libFilePath, funcName);
+		// do nothing: it is permitted that an AI does not export this function,
+		// as it can still use EVENT_INIT instead
+		//reportInterfaceFunctionError(libFilePath, funcName);
     }
 	
 	funcName = &quot;release&quot;;
     skirmishAILibrary-&gt;release = (int (CALLING_CONV_FUNC_POINTER *)(int)) sharedLib-&gt;FindAddress(funcName.c_str());
     if (skirmishAILibrary-&gt;release == NULL) {
-		reportInterfaceFunctionError(libFilePath, funcName);
+		// do nothing: it is permitted that an AI does not export this function,
+		// as it can still use EVENT_RELEASE instead
+		//reportInterfaceFunctionError(libFilePath, funcName);
     }
 	
 	funcName = &quot;handleEvent&quot;;
@@ -340,7 +344,7 @@
 	std::string funcName;
 	
 	funcName = &quot;getInfos&quot;;
-    groupAILibrary-&gt;getInfos = (int (CALLING_CONV_FUNC_POINTER *)(InfoItem[], int)) sharedLib-&gt;FindAddress(funcName.c_str());
+    groupAILibrary-&gt;getInfos = (unsigned int (CALLING_CONV_FUNC_POINTER *)(InfoItem[], unsigned int max)) sharedLib-&gt;FindAddress(funcName.c_str());
     if (groupAILibrary-&gt;getInfos == NULL) {
 		// do nothing: this is permitted, if the AI supplies infos through an AIInfo.lua file
 		//reportInterfaceFunctionError(libFilePath, funcName);
@@ -349,11 +353,12 @@
 	funcName = &quot;getLevelOfSupportFor&quot;;
     groupAILibrary-&gt;getLevelOfSupportFor = (LevelOfSupport (CALLING_CONV_FUNC_POINTER *)(const char*, int, const char*, const char*)) sharedLib-&gt;FindAddress(funcName.c_str());
     if (groupAILibrary-&gt;getLevelOfSupportFor == NULL) {
-		reportInterfaceFunctionError(libFilePath, funcName);
+		// do nothing: it is permitted that an AI does not export this function
+		//reportInterfaceFunctionError(libFilePath, funcName);
     }
 	
 	funcName = &quot;getOptions&quot;;
-    groupAILibrary-&gt;getOptions = (int (CALLING_CONV_FUNC_POINTER *)(Option*, int max)) sharedLib-&gt;FindAddress(funcName.c_str());
+    groupAILibrary-&gt;getOptions = (unsigned int (CALLING_CONV_FUNC_POINTER *)(Option[], unsigned int max)) sharedLib-&gt;FindAddress(funcName.c_str());
     if (groupAILibrary-&gt;getOptions == NULL) {
 		// do nothing: this is permitted, if the AI supplies options through an AIOptions.lua file
 		//reportInterfaceFunctionError(libFilePath, funcName);
@@ -362,13 +367,17 @@
 	funcName = &quot;init&quot;;
     groupAILibrary-&gt;init = (int (CALLING_CONV_FUNC_POINTER *)(int, int)) sharedLib-&gt;FindAddress(funcName.c_str());
     if (groupAILibrary-&gt;init == NULL) {
-		reportInterfaceFunctionError(libFilePath, funcName);
+		// do nothing: it is permitted that an AI does not export this function,
+		// as it can still use EVENT_INIT instead
+		//reportInterfaceFunctionError(libFilePath, funcName);
     }
 	
 	funcName = &quot;release&quot;;
     groupAILibrary-&gt;release = (int (CALLING_CONV_FUNC_POINTER *)(int, int)) sharedLib-&gt;FindAddress(funcName.c_str());
     if (groupAILibrary-&gt;release == NULL) {
-		reportInterfaceFunctionError(libFilePath, funcName);
+		// do nothing: it is permitted that an AI does not export this function,
+		// as it can still use EVENT_RELEASE instead
+		//reportInterfaceFunctionError(libFilePath, funcName);
     }
 	
 	funcName = &quot;handleEvent&quot;;

Modified: branches/caiinterface/AI/Skirmish/CMakeLists.txt
===================================================================
--- branches/caiinterface/AI/Skirmish/CMakeLists.txt	2008-10-08 11:14:09 UTC (rev 6608)
+++ branches/caiinterface/AI/Skirmish/CMakeLists.txt	2008-10-08 12:06:09 UTC (rev 6609)
@@ -39,7 +39,7 @@
 
 ## Null Legacy C++ AI
 aux_source_directory(${CMAKE_SOURCE_DIR}/AI/Skirmish/NullLegacyCppAI nullLegacyCppAI)
-add_library(NullLegacyCppAI-0.1 MODULE ${nullLegacyCppAI} ${legacycppaienv})
+add_library(NullLegacyCppAI-0.1 MODULE ${nullLegacyCppAI} ${legacycppaienv} ${creg})
 install (FILES ${CMAKE_SOURCE_DIR}/AI/Skirmish/NullLegacyCppAI/AIInfo.lua DESTINATION ${DATADIR}/AI/Skirmish/data/NullLegacyCppAI-0.1)
 install (FILES ${CMAKE_SOURCE_DIR}/AI/Skirmish/NullLegacyCppAI/AIOptions.lua DESTINATION ${DATADIR}/AI/Skirmish/data/NullLegacyCppAI-0.1)
 

Modified: branches/caiinterface/AI/Skirmish/KAIK-0.13/AIExport.h
===================================================================
--- branches/caiinterface/AI/Skirmish/KAIK-0.13/AIExport.h	2008-10-08 11:14:09 UTC (rev 6608)
+++ branches/caiinterface/AI/Skirmish/KAIK-0.13/AIExport.h	2008-10-08 12:06:09 UTC (rev 6609)
@@ -13,11 +13,22 @@
 
     You should have received a copy of the GNU General Public License
     along with this program.  If not, see &lt;<A HREF="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</A>&gt;.
+	
+	@author Nicolas Wu
+	@author Robin Vobruba &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">hoijui.quaero at gmail.com</A>&gt;
 */
 
 #ifndef _AIEXPORT_H
 #define _AIEXPORT_H
 
+// check if build system uses correct defines
+#if	!defined BUILDING_AI
+	#error BUILDING_AI should be defined when building AIs
+#endif
+#if	defined BUILDING_AI_INTERFACE
+	#error BUILDING_AI_INTERFACE should not be defined when building AIs
+#endif
+
 #include &quot;ExternalAI/Interface/aidefines.h&quot;
 #include &quot;ExternalAI/Interface/ELevelOfSupport.h&quot;
 
@@ -27,12 +38,12 @@
 // for a list of the functions that have to be exported,
 // see struct SSAILibrary in &quot;ExternalAI/Interface/SSAILibrary.h&quot;
 
-// static AI library methods
-Export(int) getInfos(InfoItem infos[], int max); // static properties
+// static AI library methods (optional to implement)
+Export(unsigned int) getInfos(InfoItem infos[], unsigned int max);
 Export(enum LevelOfSupport) getLevelOfSupportFor(
 		const char* engineVersionString, int engineVersionNumber,
 		const char* aiInterfaceShortName, const char* aiInterfaceVersion);
-Export(int) getOptions(struct Option options[], int max);
+Export(unsigned int) getOptions(struct Option options[], unsigned int max);
 
 // team instance functions
 Export(int) init(int teamId);

Modified: branches/caiinterface/AI/Skirmish/KAIK-0.13/AIExports.cpp
===================================================================
--- branches/caiinterface/AI/Skirmish/KAIK-0.13/AIExports.cpp	2008-10-08 11:14:09 UTC (rev 6608)
+++ branches/caiinterface/AI/Skirmish/KAIK-0.13/AIExports.cpp	2008-10-08 12:06:09 UTC (rev 6609)
@@ -1,3 +1,23 @@
+/*
+    Copyright 2008  Nicolas Wu
+    
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program.  If not, see &lt;<A HREF="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</A>&gt;.
+	
+	@author Nicolas Wu
+	@author Robin Vobruba &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">hoijui.quaero at gmail.com</A>&gt;
+*/
+
 #include &quot;AIExport.h&quot;
 
 #include &lt;map&gt;
@@ -2,53 +22,18 @@
 
+// AI interface stuff
+#include &quot;ExternalAI/Interface/SSAILibrary.h&quot;
 #include &quot;ExternalAI/Interface/LegacyCppWrapper/AI.h&quot;
 #include &quot;ExternalAI/Interface/LegacyCppWrapper/AIGlobalAI.h&quot;
-#include &quot;ExternalAI/Interface/SSAILibrary.h&quot;
 
+// KAIK stuff
 #include &quot;GlobalAI.h&quot;
 
-/*
-std::set&lt;IGlobalAI*&gt; ais;
 
-
-DLL_EXPORT int GetGlobalAiVersion() {
-	return GLOBAL_AI_INTERFACE_VERSION;
-}
-
-DLL_EXPORT void GetAiName(char* name) {
-	strcpy(name, AI_VERSION);
-}
-
-DLL_EXPORT IGlobalAI* GetNewAI() {
-	if (ais.empty())
-		creg::System::InitializeClasses();
-
-	CGlobalAI* ai = new CGlobalAI();
-	ais.insert(ai);
-	return ai;
-}
-
-DLL_EXPORT void ReleaseAI(IGlobalAI* i) {
-	ais.erase(i);
-	delete (CGlobalAI*) i;
-
-	if (ais.empty())
-		creg::System::FreeClasses();
-}
-
-DLL_EXPORT int IsCInterface(void) {
-	return 0;
-}
-
-DLL_EXPORT int IsLoadSupported() {
-	return 1;
-}
-*/
-
-
-std::map&lt;int, CAI*&gt; ais;
+std::map&lt;int, CAIGlobalAI*&gt; myAIs; // teamId -&gt; AI map
 std::vector&lt;InfoItem&gt; myInfos;
 
-int getInfos(InfoItem infos[], int max) {
+
+Export(unsigned int) getInfos(InfoItem infos[], unsigned int max) {
 	
-	int i = 0;
+	unsigned int i = 0;
 	
@@ -71,11 +56,11 @@
 		i++;
 	}
 
-	// return the number of key-value pairs copied into properties
+	// return the number of elements copied to infos 
 	return i;
 }
 
-enum LevelOfSupport getLevelOfSupportFor(
+Export(enum LevelOfSupport) getLevelOfSupportFor(
 		const char* engineVersionString, int engineVersionNumber,
 		const char* aiInterfaceShortName, const char* aiInterfaceVersion) {
 	
@@ -87,50 +72,52 @@
 	return LOS_None;
 }
 
-int getOptions(struct Option options[], int max) {
+Export(unsigned int) getOptions(struct Option options[], unsigned int max) {
 	return 0;
 }
 
-// Since this is a C interface, we can only be told by the engine
-// to set up an AI with the number team that indicates a receiver
-// of any handleEvent() call.
 Export(int) init(int teamId) {
-    // the map already has an AI for this team.
-    // raise an error, since it's probably a mistake if we're trying
-    // reinitialise a team that's already had init() called on it.
-    if (ais.count(teamId) &gt; 0) {
+	
+    if (myAIs.count(teamId) &gt; 0) {
+		// the map already has an AI for this team.
+		// raise an error, since it's probably a mistake if we're trying
+		// to reinitialise a team that already had init() called on it.
         return -1;
     }
-    //TODO:
-    // Change the line below so that CAI is 
-    // your AI, which should be a subclass of CAI that
-    // overrides the handleEvent() method.
-    ais[teamId] = new CAIGlobalAI(teamId, new CGlobalAI());
 	
+    // CAIGlobalAI is the Legacy C++ wrapper, CGlobalAI is KAIK
+    myAIs[teamId] = new CAIGlobalAI(teamId, new CGlobalAI());
+	
+	// signal: everything went ok
 	return 0;
 }
 
 Export(int) release(int teamId) {
-    // the map has no AI for this team.
-    // raise an error, since it's probably a mistake if we're trying to
-    // release a team that's not initialized.
-    if (ais.count(teamId) == 0) {
+	
+    if (myAIs.count(teamId) == 0) {
+		// the map has no AI for this team.
+		// raise an error, since it's probably a mistake if we're trying to
+		// release a team that's not initialized.
         return -1;
     }
 	
-    delete ais[teamId];
-	ais.erase(teamId);
+    delete myAIs[teamId];
+	myAIs.erase(teamId);
 	
+	// signal: everything went ok
 	return 0;
 }
 
 Export(int) handleEvent(int teamId, int topic, const void* data) {
-    // events sent to team -1 will always be to the AI object itself,
-    // not to a particular team.
-    if (ais.count(teamId) &gt; 0){
+	
+    if (teamId &lt; 0) {
+		// events sent to team -1 will always be to the AI object itself,
+		// not to a particular team.
+	} else if (myAIs.count(teamId) &gt; 0) {
         // allow the AI instance to handle the event.
-        return ais[teamId]-&gt;handleEvent(topic, data);
-    }
-    // no ai with value, so return error.
-    else return -1;
+        return myAIs[teamId]-&gt;handleEvent(topic, data);
+	}
+	
+	// no AI for that team, so return error.
+	return -1;
 }

Modified: branches/caiinterface/AI/Skirmish/NullAI/AIExport.cpp
===================================================================
--- branches/caiinterface/AI/Skirmish/NullAI/AIExport.cpp	2008-10-08 11:14:09 UTC (rev 6608)
+++ branches/caiinterface/AI/Skirmish/NullAI/AIExport.cpp	2008-10-08 12:06:09 UTC (rev 6609)
@@ -26,15 +26,15 @@
 
 Therefore, the handleEvent code would look like this:
 [code]
-Export(int) handleEvent(int team, int eventID, void* event) {
-    if (eventID == INIT_EVENT) {
-        ais[team] = CAIObject();
+Export(int) handleEvent(int teamId, int topic, const void* data) {
+    if (topic == INIT_EVENT) {
+        myAIs[teamId] = CAIObject();
     }
-    if (ais.count(team) &gt; 0){
+    if (myAIs.count(teamId) &gt; 0){
         // allow the AI instance to handle the event.
-        return ais[team].handleEvent(eventID, event);
+        return myAIs[teamId].handleEvent(topic, data);
     }
-    // no ai with value, so return error.
+    // no AI for that team, so return error.
     else return -1;
 }
 [/code]
@@ -72,35 +72,24 @@
 for a special case that we know only happens once at the beginning of the game, before
 every single event after.
 
-Of course, we still need an INIT_EVENT, since initialising the existance of a team
+Of course, we still need an EVENT_INIT, since initialising the existance of a team
 member is not the same as initialising its state.
 
 You might also argue that we do this check in the handleEvent switch within each
 team. This is true, although the difference there is that a switch is translated
 to address lookups and so there is no increase in cost if there are more switch
-cases. 
+cases.
+
+The same issues and reasonins described here for init() and EVENT_INIT applies
+to release() and EVENT_RELEASE.
 */
 
-
 #include &quot;AIExport.h&quot;
 
-//#include &quot;ExternalAI/Interface/SSAILibrary.h&quot;
-
-// Since this is a C interface, we can only be told by the engine
-// to set up an AI with the number team that indicates a receiver
-// of any handleEvent() call.
-Export(int) init(int teamId) {
-	// TODO: do something
-	return 0;
-}
-
-Export(int) release(int teamId) {
-	// TODO: do something
-	return 0;
-}
-
 Export(int) handleEvent(int teamId, int topic, const void* data) {
+	
 	// TODO: do something
+	
+	// signal: ok
 	return 0;
 }
-

Modified: branches/caiinterface/AI/Skirmish/NullAI/AIExport.h
===================================================================
--- branches/caiinterface/AI/Skirmish/NullAI/AIExport.h	2008-10-08 11:14:09 UTC (rev 6608)
+++ branches/caiinterface/AI/Skirmish/NullAI/AIExport.h	2008-10-08 12:06:09 UTC (rev 6609)
@@ -21,11 +21,12 @@
 #ifndef _AIEXPORT_H
 #define _AIEXPORT_H
 
+// check if build system uses correct defines
 #if	!defined BUILDING_AI
-#error BUILDING_AI should be defined when building AIs
+	#error BUILDING_AI should be defined when building AIs
 #endif
 #if	defined BUILDING_AI_INTERFACE
-#error BUILDING_AI_INTERFACE should not be defined when building AIs
+	#error BUILDING_AI_INTERFACE should not be defined when building AIs
 #endif
 
 #include &quot;ExternalAI/Interface/aidefines.h&quot;
@@ -37,16 +38,16 @@
 // for a list of the functions that have to be exported,
 // see struct SSAILibrary in &quot;ExternalAI/Interface/SSAILibrary.h&quot;
 
-// static AI library methods (OPTIONAL TO IMPLEMENT)
-//Export(unsigned int) getInfos(InfoItem infos[], unsigned int max); // static properties
+// static AI library methods (optional to implement)
+//Export(unsigned int) getInfos(InfoItem infos[], unsigned int max);
 //Export(enum LevelOfSupport) getLevelOfSupportFor(
 //		const char* engineVersionString, int engineVersionNumber,
 //		const char* aiInterfaceShortName, const char* aiInterfaceVersion);
 //Export(unsigned int) getOptions(struct Option options[], unsigned int max);
 
 // team instance functions
-Export(int) init(int teamId);
-Export(int) release(int teamId);
+//Export(int) init(int teamId);
+//Export(int) release(int teamId);
 Export(int) handleEvent(int teamId, int topic, const void* data);
 
 #endif /* _AIEXPORT_H */

Modified: branches/caiinterface/AI/Skirmish/NullLegacyCppAI/AIExport.cpp
===================================================================
--- branches/caiinterface/AI/Skirmish/NullLegacyCppAI/AIExport.cpp	2008-10-08 11:14:09 UTC (rev 6608)
+++ branches/caiinterface/AI/Skirmish/NullLegacyCppAI/AIExport.cpp	2008-10-08 12:06:09 UTC (rev 6609)
@@ -1,3 +1,23 @@
+/*
+    Copyright 2008  Nicolas Wu
+    
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program.  If not, see &lt;<A HREF="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</A>&gt;.
+	
+	@author Nicolas Wu
+	@author Robin Vobruba &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">hoijui.quaero at gmail.com</A>&gt;
+*/
+
 #include &quot;AIExport.h&quot;
 
 #include &lt;map&gt;
@@ -2,97 +22,27 @@
 
+// AI interface stuff
+#include &quot;ExternalAI/Interface/SSAILibrary.h&quot;
 #include &quot;ExternalAI/Interface/LegacyCppWrapper/AI.h&quot;
 #include &quot;ExternalAI/Interface/LegacyCppWrapper/AIGlobalAI.h&quot;
-#include &quot;ExternalAI/Interface/SSAILibrary.h&quot;
 
-/*
-If we do not have an init() method, then we would instead pass
-an event InitEvent to handleEvent. However, we would have to make
-handleEvent have to wait for an InitEvent as a special case, since
-the team in question would not yet exist. 
+// NullLegacyCppAI stuff
+#include &quot;TestGlobalAI.h&quot;
 
-Therefore, the handleEvent code would look like this:
-[code]
-DLL_EXPORT int handleEvent(int team, int eventID, void* event) {
-    if (eventID == INIT_EVENT) {
-        ais[team] = CAIObject();
-    }
-    if (ais.count(team) &gt; 0){
-        // allow the AI instance to handle the event.
-        return ais[team].handleEvent(eventID, event);
-    }
-    // no ai with value, so return error.
-    else return -1;
-}
-[/code]
-Advantages:
-* All events to AI go through handleEvent.
-* People don't get confused and start adding bananaSplitz() functions.
 
-Disadvantages:
-* We need to check for INIT_EVENT before *every message*.
-* These events will happen only once per game -- after that the check becomes a necessary waste of time.
-* Handling events is no longer about getting the right object to deal with an event, it also includes initialising object properly.
+std::map&lt;int, CAIGlobalAI*&gt; myAIs; // teamId -&gt; AI map
 
-I understand that we want to keep the interface simple. In fact,
-I think we should keep it as minimal as possible, and ideally everything
-would go through handleEvent. Practically though, it does not make sense
-to do this: we'll be wasting our own time for no good reason in the
-case of initialisation. 
 
-The (in my opinion much cleaner) alternative is the one I've implemented.
-Advantages:
-* One function that initialises a team before everything is passed to handlEvent
-* No redundant if statements.
-* Simple design.
-
-Disadvantage:
-* People might start adding other functions to the interface.
-
-I don't think that the disadvantage is a real one: it's pretty standard to 
-see initialisation as a special case. It's pretty clear that everything
-else goes through handleEvent. 
-
-The advantage is clear: a more efficient, simpler design. Of course, you could
-argue that the efficiency is nominal, one extra if per event is very little cost,
-and granted, that's true; but this doesn't change the fact that we're checking
-for a special case that we know only happens once at the beginning of the game, before
-every single event after.
-
-Of course, we still need an INIT_EVENT, since initialising the existance of a team
-member is not the same as initialising its state.
-
-You might also argue that we do this check in the handleEvent switch within each
-team. This is true, although the difference there is that a switch is translated
-to address lookups and so there is no increase in cost if there are more switch
-cases. 
-*/
-
-//std::map&lt;int, CAI*&gt; ais;
-
-/*
-DLL_EXPORT int version() {
-    return 1;
-}
-*/
-
-// Since this is a C interface, we can only be told by the engine
-// to set up an AI with the number team that indicates a receiver
-// of any handleEvent() call.
 Export(int) init(int teamId) {
 	
-/*
-    if (ais.count(teamId) &gt; 0) {
+    if (myAIs.count(teamId) &gt; 0) {
 		// the map already has an AI for this team.
 		// raise an error, since it's probably a mistake if we're trying
-		// reinitialise a team that's already had init() called on it.
+		// to reinitialise a team that already had init() called on it.
         return -1;
     }
 	
-    //TODO:
-    // Change the line below so that CAI is 
-    // your AI, which should be a subclass of CAI that
-    // overrides the handleEvent() method.
-    ais[teamId] = new CAI(teamId, NULL);
-*/
+    // CAIGlobalAI is the Legacy C++ wrapper, TestGlobalAI is NullLegacyCppAI
+    myAIs[teamId] = new CAIGlobalAI(teamId, new TestGlobalAI());
 	
+	// signal: everything went ok
 	return 0;
@@ -102,34 +52,31 @@
 
 Export(int) release(int teamId) {
 	
-/*
-    if (ais.count(teamId) == 0) {
+    if (myAIs.count(teamId) == 0) {
 		// the map has no AI for this team.
 		// raise an error, since it's probably a mistake if we're trying to
 		// release a team that's not initialized.
         return -1;
     }
 	
-    delete ais[teamId];
-	ais.erase(teamId);
-*/
+    delete myAIs[teamId];
+	myAIs.erase(teamId);
 	
+	// signal: everything went ok
 	return 0;
 }
 
 Export(int) handleEvent(int teamId, int topic, const void* data) {
 	
-/*
-	if (ais.count(teamId) &gt; 0) {
-        // allow the AI instance to handle the event.
-        return ais[teamId]-&gt;handleEvent(topic, data);
-    } else {
+    if (teamId &lt; 0) {
 		// events sent to team -1 will always be to the AI object itself,
 		// not to a particular team.
-		
-		// no ai with value, so return error.
-		return -1;
+	} else if (myAIs.count(teamId) &gt; 0) {
+        // allow the AI instance to handle the event.
+        return myAIs[teamId]-&gt;handleEvent(topic, data);
 	}
-*/ return 0;
+	
+	// no AI for that team, so return error.
+	return -1;
 }
 

Modified: branches/caiinterface/AI/Skirmish/NullLegacyCppAI/AIExport.h
===================================================================
--- branches/caiinterface/AI/Skirmish/NullLegacyCppAI/AIExport.h	2008-10-08 11:14:09 UTC (rev 6608)
+++ branches/caiinterface/AI/Skirmish/NullLegacyCppAI/AIExport.h	2008-10-08 12:06:09 UTC (rev 6609)
@@ -13,16 +13,20 @@
 
     You should have received a copy of the GNU General Public License
     along with this program.  If not, see &lt;<A HREF="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</A>&gt;.
+	
+	@author Nicolas Wu
+	@author Robin Vobruba &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">hoijui.quaero at gmail.com</A>&gt;
 */
 
 #ifndef _AIEXPORT_H
 #define _AIEXPORT_H
 
+// check if build system uses correct defines
 #if	!defined BUILDING_AI
-#error BUILDING_AI should be defined when building AIs
+	#error BUILDING_AI should be defined when building AIs
 #endif
 #if	defined BUILDING_AI_INTERFACE
-#error BUILDING_AI_INTERFACE should not be defined when building AIs
+	#error BUILDING_AI_INTERFACE should not be defined when building AIs
 #endif
 
 #include &quot;ExternalAI/Interface/aidefines.h&quot;
@@ -34,12 +38,12 @@
 // for a list of the functions that have to be exported,
 // see struct SSAILibrary in &quot;ExternalAI/Interface/SSAILibrary.h&quot;
 
-// static AI library methods (OPTIONAL TO IMPLEMENT)
-//Export(int) getInfos(InfoItem infos[], int max); // static properties
+// static AI library methods (optional to implement)
+//Export(unsigned int) getInfos(InfoItem infos[], unsigned int max);
 //Export(enum LevelOfSupport) getLevelOfSupportFor(
 //		const char* engineVersionString, int engineVersionNumber,
 //		const char* aiInterfaceShortName, const char* aiInterfaceVersion);
-//Export(int) getOptions(struct Option options[], int max);
+//Export(unsigned int) getOptions(struct Option options[], unsigned int max);
 
 // team instance functions
 Export(int) init(int teamId);

Deleted: branches/caiinterface/AI/Skirmish/NullLegacyCppAI/TestAI.cpp
===================================================================
--- branches/caiinterface/AI/Skirmish/NullLegacyCppAI/TestAI.cpp	2008-10-08 11:14:09 UTC (rev 6608)
+++ branches/caiinterface/AI/Skirmish/NullLegacyCppAI/TestAI.cpp	2008-10-08 12:06:09 UTC (rev 6609)
@@ -1,31 +0,0 @@
-#include &lt;string.h&gt;
-#include &lt;stdlib.h&gt;
-#include &quot;TestGlobalAI.h&quot;
-#include &quot;ExternalAI/aibase.h&quot;
-
-/////////////////////////////////////////////////////////////////////////////
-
-std::set&lt;IGlobalAI*&gt; ais;
-
-DLL_EXPORT int GetGlobalAiVersion()
-{
-	return GLOBAL_AI_INTERFACE_VERSION;
-}
-
-DLL_EXPORT void GetAiName(char* name)
-{
-	strcpy(name,AI_NAME);
-}
-
-DLL_EXPORT IGlobalAI* GetNewAI()
-{
-	TestGlobalAI* ai=new TestGlobalAI;
-	ais.insert(ai);
-	return ai;
-}
-
-DLL_EXPORT void ReleaseAI(IGlobalAI* i)
-{
-	delete i;
-	ais.erase(i);
-}

Modified: branches/caiinterface/AI/Skirmish/RAI-0.553/AIExport.cpp
===================================================================
--- branches/caiinterface/AI/Skirmish/RAI-0.553/AIExport.cpp	2008-10-08 11:14:09 UTC (rev 6608)
+++ branches/caiinterface/AI/Skirmish/RAI-0.553/AIExport.cpp	2008-10-08 12:06:09 UTC (rev 6609)
@@ -1,3 +1,23 @@
+/*
+    Copyright 2008  Nicolas Wu
+    
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; either version 2 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program.  If not, see &lt;<A HREF="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</A>&gt;.
+	
+	@author Nicolas Wu
+	@author Robin Vobruba &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">hoijui.quaero at gmail.com</A>&gt;
+*/
+
 #include &quot;AIExport.h&quot;
 
 #include &lt;map&gt;
@@ -2,77 +22,17 @@
 
+// AI interface stuff
+#include &quot;ExternalAI/Interface/SSAILibrary.h&quot;
 #include &quot;ExternalAI/Interface/LegacyCppWrapper/AI.h&quot;
 #include &quot;ExternalAI/Interface/LegacyCppWrapper/AIGlobalAI.h&quot;
-#include &quot;ExternalAI/Interface/SSAILibrary.h&quot;
 
+// RAI stuff
 #include &quot;RAI.h&quot;
 
-/*
-If we do not have an init() method, then we would instead pass
-an event InitEvent to handleEvent. However, we would have to make
-handleEvent have to wait for an InitEvent as a special case, since
-the team in question would not yet exist. 
 
-Therefore, the handleEvent code would look like this:
-[code]
-DLL_EXPORT int handleEvent(int team, int eventID, void* event) {
-    if (eventID == INIT_EVENT) {
-        ais[team] = CAIObject();
-    }
-    if (ais.count(team) &gt; 0){
-        // allow the AI instance to handle the event.
-        return ais[team].handleEvent(eventID, event);
-    }
-    // no ai with value, so return error.
-    else return -1;
-}
-[/code]
-Advantages:
-* All events to AI go through handleEvent.
-* People don't get confused and start adding bananaSplitz() functions.
+std::map&lt;int, CAIGlobalAI*&gt; myAIs; // teamId -&gt; AI map
 
-Disadvantages:
-* We need to check for INIT_EVENT before *every message*.
-* These events will happen only once per game -- after that the check becomes a necessary waste of time.
-* Handling events is no longer about getting the right object to deal with an event, it also includes initialising object properly.
 
-I understand that we want to keep the interface simple. In fact,
-I think we should keep it as minimal as possible, and ideally everything
-would go through handleEvent. Practically though, it does not make sense
-to do this: we'll be wasting our own time for no good reason in the
-case of initialisation. 
-
-The (in my opinion much cleaner) alternative is the one I've implemented.
-Advantages:
-* One function that initialises a team before everything is passed to handlEvent
-* No redundant if statements.
-* Simple design.
-
-Disadvantage:
-* People might start adding other functions to the interface.
-
-I don't think that the disadvantage is a real one: it's pretty standard to 
-see initialisation as a special case. It's pretty clear that everything
-else goes through handleEvent. 
-
-The advantage is clear: a more efficient, simpler design. Of course, you could
-argue that the efficiency is nominal, one extra if per event is very little cost,
-and granted, that's true; but this doesn't change the fact that we're checking
-for a special case that we know only happens once at the beginning of the game, before
-every single event after.
-
-Of course, we still need an INIT_EVENT, since initialising the existance of a team
-member is not the same as initialising its state. (It's for this reason that
-I would consider renaming init() to create()).
-
-You might also argue that we do this check in the handleEvent switch within each
-team. This is true, although the difference there is that a switch is translated
-to address lookups and so there is no increase in cost if there are more switch
-cases. 
-*/
-
-std::map&lt;int, CAI*&gt; ais;
-
-int getInfos(InfoItem infos[], int max) {
+Export(unsigned int) getInfos(InfoItem infos[], unsigned int max) {
 	
-	int i = 0;
+	unsigned int i = 0;
 	
@@ -109,9 +69,11 @@
 		i++;
 	}
 	
+	// return the number of elements copied to infos 
 	return i;
 }
-enum LevelOfSupport getLevelOfSupportFor(
+
+Export(enum LevelOfSupport) getLevelOfSupportFor(
 		const char* engineVersionString, int engineVersionNumber,
 		const char* aiInterfaceShortName, const char* aiInterfaceVersion) {
 	
@@ -123,50 +85,52 @@
 	return LOS_None;
 }
 
-int getOptions(struct Option options[], int max) {
+Export(unsigned int) getOptions(struct Option options[], unsigned int max) {
 	return 0;
 }
 
-// Since this is a C interface, we can only be told by the engine
-// to set up an AI with the number team that indicates a receiver
-// of any handleEvent() call.
-int init(int teamId) {
-    // the map already has an AI for this team.
-    // raise an error, since it's probably a mistake if we're trying
-    // reinitialise a team that's already had init() called on it.
-    if (ais.count(teamId) &gt; 0) {
+Export(int) init(int teamId) {
+	
+    if (myAIs.count(teamId) &gt; 0) {
+		// the map already has an AI for this team.
+		// raise an error, since it's probably a mistake if we're trying
+		// to reinitialise a team that already had init() called on it.
         return -1;
     }
-    //TODO:
-    // Change the line below so that CAI is 
-    // your AI, which should be a subclass of CAI that
-    // overrides the handleEvent() method.
-    ais[teamId] = new CAIGlobalAI(teamId, new cRAI);
 	
+    // CAIGlobalAI is the Legacy C++ wrapper, cRAI is RAI
+    myAIs[teamId] = new CAIGlobalAI(teamId, new cRAI());
+	
+	// signal: everything went ok
 	return 0;
 }
 
-int release(int teamId) {
-    // the map has no AI for this team.
-    // raise an error, since it's probably a mistake if we're trying to
-    // release a team that's not initialized.
-    if (ais.count(teamId) == 0) {
+Export(int) release(int teamId) {
+    
+    if (myAIs.count(teamId) == 0) {
+		// the map has no AI for this team.
+		// raise an error, since it's probably a mistake if we're trying to
+		// release a team that's not initialized.
         return -1;
     }
 	
-    delete ais[teamId];
-	ais.erase(teamId);
+    delete myAIs[teamId];
+	myAIs.erase(teamId);
 	
+	// signal: everything went ok
 	return 0;
 }
 
-int handleEvent(int teamId, int topic, const void* data) {
-    // events sent to team -1 will always be to the AI object itself,
-    // not to a particular team.
-    if (ais.count(teamId) &gt; 0){
+Export(int) handleEvent(int teamId, int topic, const void* data) {
+    
+    if (teamId &lt; 0) {
+		// events sent to team -1 will always be to the AI object itself,
+		// not to a particular team.
+	} else if (myAIs.count(teamId) &gt; 0) {
         // allow the AI instance to handle the event.
-        return ais[teamId]-&gt;handleEvent(topic, data);
-    }
-    // no ai with value, so return error.
-    else return -1;
+        return myAIs[teamId]-&gt;handleEvent(topic, data);
+	}
+	
+	// no AI for that team, so return error.
+	return -1;
 }

Modified: branches/caiinterface/AI/Skirmish/RAI-0.553/AIExport.h
===================================================================
--- branches/caiinterface/AI/Skirmish/RAI-0.553/AIExport.h	2008-10-08 11:14:09 UTC (rev 6608)
+++ branches/caiinterface/AI/Skirmish/RAI-0.553/AIExport.h	2008-10-08 12:06:09 UTC (rev 6609)
@@ -13,11 +13,22 @@
 
     You should have received a copy of the GNU General Public License
     along with this program.  If not, see &lt;<A HREF="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</A>&gt;.
+	
+	@author Nicolas Wu
+	@author Robin Vobruba &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">hoijui.quaero at gmail.com</A>&gt;
 */
 
 #ifndef _AIEXPORT_H
 #define _AIEXPORT_H
 
+// check if build system uses correct defines
+#if	!defined BUILDING_AI
+	#error BUILDING_AI should be defined when building AIs
+#endif
+#if	defined BUILDING_AI_INTERFACE
+	#error BUILDING_AI_INTERFACE should not be defined when building AIs
+#endif
+
 #include &quot;ExternalAI/Interface/aidefines.h&quot;
 #include &quot;ExternalAI/Interface/ELevelOfSupport.h&quot;
 
@@ -27,12 +38,12 @@
 // for a list of the functions that have to be exported,
 // see struct SSAILibrary in &quot;ExternalAI/Interface/SSAILibrary.h&quot;
 
-// static AI library methods
-Export(int) getInfos(InfoItem infos[], int max); // static properties
+// static AI library methods (optional to implement)
+Export(unsigned int) getInfos(InfoItem infos[], unsigned int max);
 Export(enum LevelOfSupport) getLevelOfSupportFor(
 		const char* engineVersionString, int engineVersionNumber,
 		const char* aiInterfaceShortName, const char* aiInterfaceVersion);
-Export(int) getOptions(struct Option options[], int max);
+Export(unsigned int) getOptions(struct Option options[], unsigned int max);
 
 // team instance functions
 Export(int) init(int teamId);

Modified: branches/caiinterface/rts/ExternalAI/AIInterfaceLibrary.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/AIInterfaceLibrary.cpp	2008-10-08 11:14:09 UTC (rev 6608)
+++ branches/caiinterface/rts/ExternalAI/AIInterfaceLibrary.cpp	2008-10-08 12:06:09 UTC (rev 6609)
@@ -288,7 +288,7 @@
 	std::string funcName;
 	
 	funcName = &quot;getInfos&quot;;
-    sAIInterfaceLibrary.getInfos = (int (CALLING_CONV_FUNC_POINTER *)(InfoItem[], unsigned int)) sharedLib-&gt;FindAddress(funcName.c_str());
+    sAIInterfaceLibrary.getInfos = (unsigned int (CALLING_CONV_FUNC_POINTER *)(InfoItem[], unsigned int)) sharedLib-&gt;FindAddress(funcName.c_str());
     if (sAIInterfaceLibrary.getInfos == NULL) {
 		// do nothing: this is permitted, if the AI supplies infos through an AIInfo.lua file
 		//reportInterfaceFunctionError(&amp;libFilePath, &amp;funcName);

Modified: branches/caiinterface/rts/ExternalAI/GroupAILibrary.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/GroupAILibrary.cpp	2008-10-08 11:14:09 UTC (rev 6608)
+++ branches/caiinterface/rts/ExternalAI/GroupAILibrary.cpp	2008-10-08 12:06:09 UTC (rev 6609)
@@ -18,6 +18,7 @@
 #include &quot;GroupAILibrary.h&quot;
 
 #include &quot;Interface/SAIInterfaceLibrary.h&quot;
+#include &quot;LogOutput.h&quot;
 #include &lt;string&gt;
 
 CGroupAILibrary::CGroupAILibrary(const SGAILibrary&amp; ai) {
@@ -83,11 +84,25 @@
 
 
 void CGroupAILibrary::Init(int teamId, int groupId) const {
-	sGAI.init(teamId, groupId);
+	
+	if (sGAI.init != NULL) {
+		int error = sGAI.init(teamId, groupId);
+		if (error != 0) {
+			// init failed
+			logOutput.Print(&quot;Failed to initialize an AI for team %d and group %d, error: %d&quot;, teamId, groupId, error);
+		}
+	}
 }
 
 void CGroupAILibrary::Release(int teamId, int groupId) const {
-	sGAI.release(teamId, groupId);
+	
+	if (sGAI.release != NULL) {
+		int error = sGAI.release(teamId, groupId);
+		if (error != 0) {
+			// release failed
+			logOutput.Print(&quot;Failed to release the AI for team %d and group %d, error: %d&quot;, teamId, groupId, error);
+		}
+	}
 }
 
 int CGroupAILibrary::HandleEvent(int teamId, int groupId, int topic, const void* data) const {

Modified: branches/caiinterface/rts/ExternalAI/Interface/AISEvents.h
===================================================================
--- branches/caiinterface/rts/ExternalAI/Interface/AISEvents.h	2008-10-08 11:14:09 UTC (rev 6608)
+++ branches/caiinterface/rts/ExternalAI/Interface/AISEvents.h	2008-10-08 12:06:09 UTC (rev 6609)
@@ -23,27 +23,28 @@
 
 #define EVENT_NULL				0
 #define EVENT_INIT				1
-#define EVENT_UPDATE			2
-#define EVENT_MESSAGE			3
-#define EVENT_UNIT_CREATED		4
-#define EVENT_UNIT_FINISHED		5
-#define EVENT_UNIT_IDLE			6
-#define EVENT_UNIT_MOVE_FAILED	7
-#define EVENT_UNIT_DAMAGED		8
-#define EVENT_UNIT_DESTROYED	9
-#define EVENT_UNIT_GIVEN		10
-#define EVENT_UNIT_CAPTURED		11
-#define EVENT_ENEMY_ENTER_LOS	12
-#define EVENT_ENEMY_LEAVE_LOS	13
-#define EVENT_ENEMY_ENTER_RADAR 14
-#define EVENT_ENEMY_LEAVE_RADAR 15
-#define EVENT_ENEMY_DAMAGED		16
-#define EVENT_ENEMY_DESTROYED	17
-#define EVENT_WEAPON_FIRED		18
-#define EVENT_PLAYER_COMMAND	19
-#define EVENT_SEISMIC_PING		20
+#define EVENT_RELEASE			2
+#define EVENT_UPDATE			3
+#define EVENT_MESSAGE			4
+#define EVENT_UNIT_CREATED		5
+#define EVENT_UNIT_FINISHED		6
+#define EVENT_UNIT_IDLE			7
+#define EVENT_UNIT_MOVE_FAILED	8
+#define EVENT_UNIT_DAMAGED		9
+#define EVENT_UNIT_DESTROYED	10
+#define EVENT_UNIT_GIVEN		11
+#define EVENT_UNIT_CAPTURED		12
+#define EVENT_ENEMY_ENTER_LOS	13
+#define EVENT_ENEMY_LEAVE_LOS	14
+#define EVENT_ENEMY_ENTER_RADAR 15
+#define EVENT_ENEMY_LEAVE_RADAR 16
+#define EVENT_ENEMY_DAMAGED		17
+#define EVENT_ENEMY_DESTROYED	18
+#define EVENT_WEAPON_FIRED		19
+#define EVENT_PLAYER_COMMAND	20
+#define EVENT_SEISMIC_PING		21
 
-#define NUM_EVENTS				21
+#define NUM_EVENTS				22
 
 
 struct SInitEvent {
@@ -51,6 +52,10 @@
 	SAICallback* c_callback;
 };
 
+struct SReleaseEvent {
+	int team;
+};
+
 struct SUpdateEvent {
 	int frame;
 };

Modified: branches/caiinterface/rts/ExternalAI/Interface/SAICallback.h
===================================================================
--- branches/caiinterface/rts/ExternalAI/Interface/SAICallback.h	2008-10-08 11:14:09 UTC (rev 6608)
+++ branches/caiinterface/rts/ExternalAI/Interface/SAICallback.h	2008-10-08 12:06:09 UTC (rev 6609)
@@ -25,7 +25,7 @@
 #include &quot;aidefines.h&quot;
 
 /**
- * Global AI Callback function pointers.
+ * Skirmish AI Callback function pointers.
  */
 struct SAICallback {
 

Modified: branches/caiinterface/rts/ExternalAI/Interface/SAIInterfaceLibrary.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/Interface/SAIInterfaceLibrary.cpp	2008-10-08 11:14:09 UTC (rev 6608)
+++ branches/caiinterface/rts/ExternalAI/Interface/SAIInterfaceLibrary.cpp	2008-10-08 12:06:09 UTC (rev 6609)
@@ -20,6 +20,11 @@
 #include &lt;string.h&gt;
 #include &lt;stdlib.h&gt;
 
+#if defined __cplusplus &amp;&amp; !defined BUILDING_AI &amp;&amp; !defined BUILDING_AI_INTERFACE
+#define __USE_CREG_HERE
+#include &quot;creg/creg.h&quot;
+#endif /* __cplusplus &amp;&amp; !defined BUILDING_AI &amp;&amp; !defined BUILDING_AI_INTERFACE */
+
 SAIInterfaceSpecifier copySAIInterfaceSpecifier(const struct SAIInterfaceSpecifier* const orig) {
 	
 	struct SAIInterfaceSpecifier copy;
@@ -42,10 +47,10 @@
 
 #ifdef	__cplusplus
 
-#ifdef	__USE_CREG
+#ifdef	__USE_CREG_HERE
 CR_BIND(SSAIKey,)
 CR_BIND(SGAIKey,)
-#endif /* __USE_CREG */
+#endif /* __USE_CREG_HERE */
 
 bool SAIInterfaceSpecifier_Comparator::operator()(const struct SAIInterfaceSpecifier&amp; a, const struct SAIInterfaceSpecifier&amp; b) const {
 
@@ -133,5 +138,9 @@
 	return empty;
 }
 
+#ifdef __USE_CREG_HERE
+#undef __USE_CREG_HERE
+#endif	/* __USE_CREG_HERE */
+
 #endif /* __cplusplus */
 

Modified: branches/caiinterface/rts/ExternalAI/Interface/SAIInterfaceLibrary.h
===================================================================
--- branches/caiinterface/rts/ExternalAI/Interface/SAIInterfaceLibrary.h	2008-10-08 11:14:09 UTC (rev 6608)
+++ branches/caiinterface/rts/ExternalAI/Interface/SAIInterfaceLibrary.h	2008-10-08 12:06:09 UTC (rev 6609)
@@ -19,10 +19,11 @@
 #define	_SAIINTERFACELIBRARY_H
 
 #if defined __cplusplus &amp;&amp; !defined BUILDING_AI &amp;&amp; !defined BUILDING_AI_INTERFACE
-#define __USE_CREG
+#define __USE_CREG_HERE
 #include &quot;creg/creg.h&quot;
 #endif /* __cplusplus &amp;&amp; !defined BUILDING_AI &amp;&amp; !defined BUILDING_AI_INTERFACE */
 
+
 #ifdef	__cplusplus
 extern &quot;C&quot; {
 #endif
@@ -70,9 +71,9 @@
  * Compleetly specifies a skirmish AI together with an interface.
  */
 struct SSAIKey {
-#ifdef	__USE_CREG
+#ifdef	__USE_CREG_HERE
 	CR_DECLARE_STRUCT(SSAIKey);
-#endif /* __USE_CREG */
+#endif /* __USE_CREG_HERE */
 	struct SAIInterfaceSpecifier interface;
 	struct SSAISpecifier ai;
 };
@@ -95,9 +96,9 @@
  * Compleetly specifies a group AI together with an interface.
  */
 struct SGAIKey {
-#ifdef	__USE_CREG
+#ifdef	__USE_CREG_HERE
 	CR_DECLARE_STRUCT(SGAIKey);
-#endif /* __USE_CREG */
+#endif /* __USE_CREG_HERE */
 	struct SAIInterfaceSpecifier interface;
 	struct SGAISpecifier ai;
 };
@@ -119,9 +120,12 @@
  * @brief struct Artificial Intelligence Interface
  */
 struct SAIInterfaceLibrary {
+	
 	// static AI interface library functions
+	
 	/**
 	 * Level of Support for a specific engine version.
+	 *
 	 * NOTE: this method is optional. An AI Interface not exporting this
 	 * function is still valid.
 	 */
@@ -129,20 +133,26 @@
 			const char* engineVersionString, int engineVersionNumber);
 	/**
 	 * Returns static properties with info about this AI Interface library.
+	 *
 	 * NOTE: this method is optional. An AI Interface not exporting this
 	 * function is still valid.
+	 *
 	 * @return number of elements stored into parameter infos
 	 */
-	int (CALLING_CONV *getInfos)(struct InfoItem infos[], unsigned int max);
+	unsigned int (CALLING_CONV *getInfos)(struct InfoItem infos[], unsigned int max);
 	
+	
 	// skirmish AI methods
+	
 	//int (CALLING_CONV *getSkirmishAISpecifiers)(struct SSAISpecifier* sAISpecifiers, int max);
 	//const struct SSAILibrary* (CALLING_CONV *loadSkirmishAILibrary)(const struct SSAISpecifier* const sAISpecifier);
 	const struct SSAILibrary* (CALLING_CONV *loadSkirmishAILibrary)(const struct InfoItem infos[], unsigned int numInfos);
 	int (CALLING_CONV *unloadSkirmishAILibrary)(const struct SSAISpecifier* const sAISpecifier);
 	int (CALLING_CONV *unloadAllSkirmishAILibraries)();
 	
+	
 	// group AI methods
+	
 	//int (CALLING_CONV *getGroupAISpecifiers)(struct SGAISpecifier* gAISpecifiers, int max);
 	//const struct SGAILibrary* (CALLING_CONV *loadGroupAILibrary)(const struct SGAISpecifier* const gAISpecifier);
 	const struct SGAILibrary* (CALLING_CONV *loadGroupAILibrary)(const struct InfoItem infos[], unsigned int numInfos);
@@ -150,11 +160,12 @@
 	int (CALLING_CONV *unloadAllGroupAILibraries)();
 };
 
+#ifdef __USE_CREG_HERE
+#undef __USE_CREG_HERE
+#endif	/* __USE_CREG_HERE */
+
 #ifdef	__cplusplus
 }
-//#ifdef __USE_CREG
-//#undef __USE_CREG
-//#endif
 #endif
 
 #endif	/* _SAIINTERFACELIBRARY_H */

Modified: branches/caiinterface/rts/ExternalAI/Interface/SGAILibrary.h
===================================================================
--- branches/caiinterface/rts/ExternalAI/Interface/SGAILibrary.h	2008-10-08 11:14:09 UTC (rev 6608)
+++ branches/caiinterface/rts/ExternalAI/Interface/SGAILibrary.h	2008-10-08 12:06:09 UTC (rev 6609)
@@ -57,44 +57,74 @@
 	 * than its second argument, and false otherwise.
 	 * This is also defined as map::key_compare.
 	 */
-	bool operator()(const struct SGAISpecifier&amp; a, const struct SGAISpecifier&amp; b) const;
+	bool operator()(const struct SGAISpecifier&amp; a,
+			const struct SGAISpecifier&amp; b) const;
 	static bool IsEmpty(const struct SGAISpecifier&amp; spec);
 };
 #endif /* __cplusplus */
 
 /**
+ * This is the interface between the engine and an implementation of a Group AI.
+ *
  * @brief struct Group Artificial Intelligence
- * This is the interface between the engine and an implementation of a Skirmish AI.
  */
 struct SGAILibrary {
+	
 	// static AI library functions
+	
 	/**
-	 * Level of Support for a specific engine version.
+	 * Level of Support for a specific engine version and AI interface version.
+	 *
 	 * NOTE: this method is optional. An AI not exporting this function is still
 	 * valid.
+	 *
+	 * @return	the level of support for the supplied engine and AI interface
+	 *			versions
 	 */
 	enum LevelOfSupport (CALLING_CONV *getLevelOfSupportFor)(
 			const char* engineVersionString, int engineVersionNumber,
 			const char* aiInterfaceShortName, const char* aiInterfaceVersion);
+	
 	/**
-	 * Returns static properties with info about this AI library.
+	 * Returns info about this AI library.
+	 *
 	 * NOTE: this method is optional. An AI not exporting this function is still
 	 * valid.
+	 *
+	 * @param	infos	where the info about this AI library shall be stored to
+	 * @param	max	the maximum number of elements to store into param infos
 	 * @return number of elements stored into parameter infos
 	 */
-	int (CALLING_CONV *getInfos)(struct InfoItem infos[], int max);
+	unsigned int (CALLING_CONV *getInfos)(struct InfoItem infos[],
+			unsigned int max);
+	
 	/**
 	 * Returns options that can be set on this AI.
+	 *
 	 * NOTE: this method is optional. An AI not exporting this function is still
 	 * valid.
+	 *
+	 * @param	infos	where the options of this AI library shall be stored to
+	 * @param	max	the maximum number of elements to store into param options
 	 * @return number of elements stored into parameter options
 	 */
-	int (CALLING_CONV *getOptions)(struct Option optionsInfo[], int max);
+	unsigned int (CALLING_CONV *getOptions)(struct Option options[],
+			unsigned int max);
 
 	// team and group instance functions
+	
+	/**
+	 * NOTE: this method is optional. An AI not exporting this function is still
+	 * valid.
+	 */
 	int (CALLING_CONV *init)(int teamId, int groupId);
+	/**
+	 * NOTE: this method is optional. An AI not exporting this function is still
+	 * valid.
+	 */
 	int (CALLING_CONV *release)(int teamId, int groupId);
-	int (CALLING_CONV *handleEvent)(int teamId, int groupId, int topic, const void* data);
+	int (CALLING_CONV *handleEvent)(int teamId, int groupId, int topic,
+			const void* data);
 };
 
 #ifdef	__cplusplus

Modified: branches/caiinterface/rts/ExternalAI/Interface/SInfo.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/Interface/SInfo.cpp	2008-10-08 11:14:09 UTC (rev 6608)
+++ branches/caiinterface/rts/ExternalAI/Interface/SInfo.cpp	2008-10-08 12:06:09 UTC (rev 6609)
@@ -15,15 +15,12 @@
 	along with this program.  If not, see &lt;<A HREF="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</A>&gt;.
 */
 
-//#ifndef _SINFO_CPP
-//#define	_SINFO_CPP
-
 #include &quot;SInfo.h&quot;
 
 #include &quot;string.h&quot;
 #include &quot;System/Util.h&quot;
+#include &lt;cstdlib&gt;
 
-
 InfoItem copyInfoItem(const struct InfoItem* const orig) {
 	
 	struct InfoItem copy;
@@ -52,9 +49,8 @@
 	mutableInfo-&gt;desc = NULL;
 }
 
-#if	defined(__cplusplus) &amp;&amp; !defined(BUILDING_AI)
-#include &quot;StdAfx.h&quot;
-#include &lt;cstdlib&gt;
+#if	defined(__cplusplus) &amp;&amp; !defined(BUILDING_AI) &amp;&amp; !defined(BUILDING_AI_INTERFACE)
+
 #include &quot;Lua/LuaParser.h&quot;
 
 #include &lt;set&gt;
@@ -98,38 +94,6 @@
 	return true;
 }
 
-/*
-std::vector&lt;InfoItem&gt; ParseInfos(
-		const std::string&amp; fileName,
-		const std::string&amp; fileModes,
-		const std::string&amp; accessModes)
-{
-	std::vector&lt;InfoItem&gt; infos;
-	
-	LuaParser luaParser(fileName, fileModes, accessModes);
-		
-	if (!luaParser.Execute()) {
-		printf(&quot;ParseInfos(%s) ERROR: %s\n&quot;,
-		       fileName.c_str(), luaParser.GetErrorLog().c_str());
-		return infos;
-	}
-
-	const LuaTable root = luaParser.GetRoot();
-	if (!root.IsValid()) {
-		return infos;
-	}
-
-	std::set&lt;std::string&gt; infosSet;
-	for (int index = 1; root.KeyExists(index); index++) {
-		InfoItem info;
-		if (ParseInfo(root, index, info, infosSet)) {
-			infos.push_back(info);
-		}
-	}
-	
-	return infos;
-}
-*/
 unsigned int ParseInfos(
 		const char* fileName,
 		const char* fileModes,
@@ -165,6 +129,6 @@
 		InfoItem infos[], unsigned int max) {
 	return ParseInfos(fileName, SPRING_VFS_RAW, SPRING_VFS_RAW, infos, max);
 }
-#endif	/* defined(__cplusplus) &amp;&amp; !defined(BUILDING_AI) */
 
-//#endif	/* _SINFO_CPP */
+#endif	/* defined(__cplusplus) &amp;&amp; !defined(BUILDING_AI) &amp;&amp; !defined(BUILDING_AI_INTERFACE) */
+

Modified: branches/caiinterface/rts/ExternalAI/Interface/SInfo.h
===================================================================
--- branches/caiinterface/rts/ExternalAI/Interface/SInfo.h	2008-10-08 11:14:09 UTC (rev 6608)
+++ branches/caiinterface/rts/ExternalAI/Interface/SInfo.h	2008-10-08 12:06:09 UTC (rev 6609)
@@ -34,7 +34,7 @@
 InfoItem copyInfoItem(const struct InfoItem* const orig);
 void deleteInfoItem(const struct InfoItem* const info);
 
-#if	defined(__cplusplus) &amp;&amp; !defined(BUILDING_AI)
+#if	defined(__cplusplus) &amp;&amp; !defined(BUILDING_AI) &amp;&amp; !defined(BUILDING_AI_INTERFACE)
 unsigned int ParseInfos(
 		const char* fileName,
 		const char* fileModes,
@@ -43,20 +43,11 @@
 unsigned int ParseInfosRawFileSystem(
 		const char* fileName,
 		InfoItem infos[], unsigned int max);
-#endif	/* defined(__cplusplus) &amp;&amp; !defined(BUILDING_AI) */
+#endif	/* defined(__cplusplus) &amp;&amp; !defined(BUILDING_AI) &amp;&amp; !defined(BUILDING_AI_INTERFACE) */
 
 #ifdef	__cplusplus
 }
 #endif
 
-//#ifdef	__cplusplus
-//#include &lt;vector&gt;
-//#include &lt;string&gt;
-//std::vector&lt;InfoItem&gt; ParseInfos(
-//		const std::string&amp; fileName,
-//		const std::string&amp; fileModes,
-//		const std::string&amp; accessModes);
-//#endif
-
 #endif	/* _SINFO_H */
 

Modified: branches/caiinterface/rts/ExternalAI/Interface/SOption.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/Interface/SOption.cpp	2008-10-08 11:14:09 UTC (rev 6608)
+++ branches/caiinterface/rts/ExternalAI/Interface/SOption.cpp	2008-10-08 12:06:09 UTC (rev 6609)
@@ -1,10 +1,27 @@
+/*
+	Copyright (c) 2008 Robin Vobruba &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">hoijui.quaero at gmail.com</A>&gt;
+	
+	This program is free software; you can redistribute it and/or modify
+	it under the terms of the GNU General Public License as published by
+	the Free Software Foundation; either version 2 of the License, or
+	(at your option) any later version.
 
+	This program is distributed in the hope that it will be useful,
+	but WITHOUT ANY WARRANTY; without even the implied warranty of
+	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+	GNU General Public License for more details.
+
+	You should have received a copy of the GNU General Public License
+	along with this program.  If not, see &lt;<A HREF="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</A>&gt;.
+*/
+
 #ifndef _SOPTION_CPP
 #define	_SOPTION_CPP
 
 #include &quot;SOption.h&quot;
 
-#if	defined(__cplusplus) &amp;&amp; !defined(BUILDING_AI)
+#if	defined(__cplusplus) &amp;&amp; !defined(BUILDING_AI) &amp;&amp; !defined(BUILDING_AI_INTERFACE)
+
 #include &quot;System/Util.h&quot;
 #include &quot;Lua/LuaParser.h&quot;
 #include &quot;Map/MapParser.h&quot;
@@ -13,7 +30,6 @@
 
 static const char* badKeyChars = &quot; =;\r\n\t&quot;;
 
-
 bool ParseOption(const LuaTable&amp; root, int index, Option&amp; opt, std::set&lt;std::string&gt; optionsSet)
 {
 	const LuaTable&amp; optTbl = root.SubTable(index);
@@ -189,6 +205,7 @@
 
 	return i;
 }
-#endif	/* defined(__cplusplus) &amp;&amp; !defined(BUILDING_AI) */
 
+#endif	/* defined(__cplusplus) &amp;&amp; !defined(BUILDING_AI) &amp;&amp; !defined(BUILDING_AI_INTERFACE) */
+
 #endif	/* _SOPTION_CPP */

Modified: branches/caiinterface/rts/ExternalAI/Interface/SOption.h
===================================================================
--- branches/caiinterface/rts/ExternalAI/Interface/SOption.h	2008-10-08 11:14:09 UTC (rev 6608)
+++ branches/caiinterface/rts/ExternalAI/Interface/SOption.h	2008-10-08 12:06:09 UTC (rev 6609)
@@ -1,3 +1,20 @@
+/*
+	Copyright (c) 2008 Robin Vobruba &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">hoijui.quaero at gmail.com</A>&gt;
+	
+	This program is free software; you can redistribute it and/or modify
+	it under the terms of the GNU General Public License as published by
+	the Free Software Foundation; either version 2 of the License, or
+	(at your option) any later version.
+
+	This program is distributed in the hope that it will be useful,
+	but WITHOUT ANY WARRANTY; without even the implied warranty of
+	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+	GNU General Public License for more details.
+
+	You should have received a copy of the GNU General Public License
+	along with this program.  If not, see &lt;<A HREF="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</A>&gt;.
+*/
+
 // The structs in this files relate to *Options.lua files
 // They are used for Mods and Skirmish AIs eg
 
@@ -49,34 +66,22 @@
 	int    stringMaxLen;
 
 	const char* listDef;
-	//vector&lt;ListItem&gt; list;
 	int numListItems;
 	OptionListItem* list;
 };
 
-#if	defined(__cplusplus) &amp;&amp; !defined(BUILDING_AI)
+#if	defined(__cplusplus) &amp;&amp; !defined(BUILDING_AI) &amp;&amp; !defined(BUILDING_AI_INTERFACE)
 int ParseOptions(
 		const char* fileName,
 		const char* fileModes,
 		const char* accessModes,
 		const char* mapName,
 		Option options[], unsigned int max);
-#endif	/* defined(__cplusplus) &amp;&amp; !defined(BUILDING_AI) */
+#endif	/* defined(__cplusplus) &amp;&amp; !defined(BUILDING_AI) &amp;&amp; !defined(BUILDING_AI_INTERFACE) */
 
 #ifdef	__cplusplus
 }
 #endif
 
-
-//#ifdef	__cplusplus
-//#include &lt;vector&gt;
-//#include &lt;string&gt;
-//std::vector&lt;Option&gt; ParseOptions(const std::string&amp; fileName,
-//                         const std::string&amp; fileModes,
-//                         const std::string&amp; accessModes,
-//                         const std::string&amp; mapName = &quot;&quot;);
-//#endif
-
-
 #endif	/* _SOPTION_H */
 

Modified: branches/caiinterface/rts/ExternalAI/Interface/SSAILibrary.h
===================================================================
--- branches/caiinterface/rts/ExternalAI/Interface/SSAILibrary.h	2008-10-08 11:14:09 UTC (rev 6608)
+++ branches/caiinterface/rts/ExternalAI/Interface/SSAILibrary.h	2008-10-08 12:06:09 UTC (rev 6609)
@@ -57,43 +57,139 @@
 	 * than its second argument, and false otherwise.
 	 * This is also defined as map::key_compare.
 	 */
-	bool operator()(const struct SSAISpecifier&amp; a, const struct SSAISpecifier&amp; b) const;
+	bool operator()(const struct SSAISpecifier&amp; a,
+			const struct SSAISpecifier&amp; b) const;
 	static bool IsEmpty(const struct SSAISpecifier&amp; spec);
 };
 #endif /* __cplusplus */
 
 /**
+ * This is the interface between the engine and an implementation of a
+ * Skirmish AI.
+ *
  * @brief struct Skirmish Artificial Intelligence
- * This is the interface between the engine and an implementation of a Skirmish AI.
  */
 struct SSAILibrary {
+	
 	// static AI library functions
+	
 	/**
-	 * Level of Support for a specific engine version.
+	 * Level of Support for a specific engine version and AI interface version.
+	 *
 	 * NOTE: this method is optional. An AI not exporting this function is still
 	 * valid.
+	 *
+	 * @return	the level of support for the supplied engine and AI interface
+	 *			versions
 	 */
 	enum LevelOfSupport (CALLING_CONV *getLevelOfSupportFor)(
 			const char* engineVersionString, int engineVersionNumber,
 			const char* aiInterfaceShortName, const char* aiInterfaceVersion);
+	
 	/**
-	 * Returns static properties with info about this AI library.
+	 * Returns info about this AI library.
+	 *
 	 * NOTE: this method is optional. An AI not exporting this function is still
 	 * valid.
-	 * @return number of elements stored into parameter infos
+	 *
+	 * @param	infos	where the info about this AI library shall be stored to
+	 * @param	max	the maximum number of elements to store into param infos
+	 * @return	number of elements stored into parameter infos
 	 */
-	int (CALLING_CONV *getInfos)(struct InfoItem infos[], int max);
+	unsigned int (CALLING_CONV *getInfos)(struct InfoItem infos[],
+			unsigned int max);
+	
 	/**
 	 * Returns options that can be set on this AI.
+	 *
 	 * NOTE: this method is optional. An AI not exporting this function is still
 	 * valid.
-	 * @return number of elements stored into parameter options
+	 *
+	 * @param	infos	where the options of this AI library shall be stored to
+	 * @param	max	the maximum number of elements to store into param options
+	 * @return	number of elements stored into parameter options
 	 */
-	int (CALLING_CONV *getOptions)(struct Option options[], int max);
+	unsigned int (CALLING_CONV *getOptions)(struct Option options[],
+			unsigned int max);
 
+	
 	// team instance functions
+	
+	/**
+	 * This function is called, when an AI instance shall be created for teamId.
+	 * It is called before the first call to handleEvent() for teamId.
+	 *
+	 * A typical series of events (engine point of view, conceptual):
+	 * [code]
+	 * KAIK.init(1)
+	 * KAIK.handleEvent(EVENT_INIT, InitEvent(1))
+	 * RAI.init(2)
+	 * RAI.handleEvent(EVENT_INIT, InitEvent(2))
+	 * KAIK.handleEvent(EVENT_UPDATE, UpdateEvent(0))
+	 * RAI.handleEvent(EVENT_UPDATE, UpdateEvent(0))
+	 * KAIK.handleEvent(EVENT_UPDATE, UpdateEvent(1))
+	 * RAI.handleEvent(EVENT_UPDATE, UpdateEvent(1))
+	 * ...
+	 * [/code]
+	 *
+	 * This method exists only for performance reasons, which come into play on
+	 * OO languages. For non-OO language AIs, this method can be ignored,
+	 * because using only EVENT_INIT will cause no performance decrease.
+	 * 
+	 * NOTE: this method is optional. An AI not exporting this function is still
+	 * valid.
+	 *
+	 * @param	teamId	the teamId this library shall create an instance for
+	 * @return	init ok: 0, on error: any other value then 0
+	 */
 	int (CALLING_CONV *init)(int teamId);
+	
+	/**
+	 * This function is called, when an AI instance shall be deleted.
+	 * It is called after the last call to handleEvent() for teamId.
+	 *
+	 * A typical series of events (engine point of view, conceptual):
+	 * [code]
+	 * ...
+	 * KAIK.handleEvent(EVENT_UPDATE, UpdateEvent(654321))
+	 * RAI.handleEvent(EVENT_UPDATE, UpdateEvent(654321))
+	 * KAIK.handleEvent(EVENT_UPDATE, UpdateEvent(654322))
+	 * RAI.handleEvent(EVENT_UPDATE, UpdateEvent(654322))
+	 * KAIK.handleEvent(EVENT_RELEASE, ReleaseEvent(1))
+	 * KAIK.release(1)
+	 * RAI.handleEvent(EVENT_RELEASE, ReleaseEvent(2))
+	 * RAI.release(2)
+	 * [/code]
+	 *
+	 * This method exists only for performance reasons, which come into play on
+	 * OO languages. For non-OO language AIs, this method can be ignored,
+	 * because using only EVENT_RELEASE will cause no performance decrease.
+	 * 
+	 * NOTE: this method is optional. An AI not exporting this function is still
+	 * valid.
+	 *
+	 * @param	teamId	the teamId this library shall create an instance for
+	 * @return	init ok: 0, on error: any other value then 0
+	 */
 	int (CALLING_CONV *release)(int teamId);
+	
+	/**
+	 * Through this function, the AI receives events from the engine.
+	 * For details about events that may arrive here, see file AISEvents.h.
+	 *
+	 * @param	teamId	the instance of the AI that the event is addressed to
+//	 * @param	fromId	the id of the AI the event comes from, or FROM_ENGINE_ID
+//	 *					if it comes from spring
+//	 * @param	eventId	used on asynchronous events. this allows the AI to
+//	 *					identify a possible result message, which was sent with
+//	 *					the same eventId
+	 * @param	topic	unique identifyer of a message
+	 *					(see EVENT_* defines in AISEvents.h)
+	 * @param	data	an topic specific struct, which contains the data
+	 *					associatedwith the event
+	 *					(see S*Event structs in AISEvents.h)
+	 * @return	event was handled: 0, on error: any other value then 0
+	 */
 	int (CALLING_CONV *handleEvent)(int teamId, int topic, const void* data);
 };
 

Modified: branches/caiinterface/rts/ExternalAI/SkirmishAILibrary.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/SkirmishAILibrary.cpp	2008-10-08 11:14:09 UTC (rev 6608)
+++ branches/caiinterface/rts/ExternalAI/SkirmishAILibrary.cpp	2008-10-08 12:06:09 UTC (rev 6609)
@@ -18,6 +18,7 @@
 #include &quot;SkirmishAILibrary.h&quot;
 
 #include &quot;Interface/SAIInterfaceLibrary.h&quot;
+#include &quot;LogOutput.h&quot;
 #include &lt;string&gt;
 
 CSkirmishAILibrary::CSkirmishAILibrary(const SSAILibrary&amp; ai,
@@ -84,11 +85,25 @@
 
 
 void CSkirmishAILibrary::Init(int teamId) const {
-	sSAI.init(teamId);
+	
+	if (sSAI.init != NULL) {
+		int error = sSAI.init(teamId);
+		if (error != 0) {
+			// init failed
+			logOutput.Print(&quot;Failed to initialize an AI for team %d, error: %d&quot;, teamId, error);
+		}
+	}
 }
 
 void CSkirmishAILibrary::Release(int teamId) const {
-	sSAI.release(teamId);
+	
+	if (sSAI.release != NULL) {
+		int error = sSAI.release(teamId);
+		if (error != 0) {
+			// release failed
+			logOutput.Print(&quot;Failed to release the AI for team %d, error: %d&quot;, teamId, error);
+		}
+	}
 }
 
 int CSkirmishAILibrary::HandleEvent(int teamId, int topic, const void* data) const {

Modified: branches/caiinterface/rts/ExternalAI/SkirmishAIWrapper.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/SkirmishAIWrapper.cpp	2008-10-08 11:14:09 UTC (rev 6608)
+++ branches/caiinterface/rts/ExternalAI/SkirmishAIWrapper.cpp	2008-10-08 12:06:09 UTC (rev 6609)
@@ -92,6 +92,7 @@
 CSkirmishAIWrapper::~CSkirmishAIWrapper() {
 	
 	if (ai) {
+		Release();
 /*
 		if (!IsCInterface) {
 			try {
@@ -262,7 +263,15 @@
 	ai-&gt;HandleEvent(EVENT_INIT, &amp;evtData);
 }
 
+void CSkirmishAIWrapper::Release() {
+	
+	SReleaseEvent evtData = {teamId};
+	ai-&gt;HandleEvent(EVENT_RELEASE, &amp;evtData);
+	
+	// further cleanup is done in the destructor
+}
 
+
 void CSkirmishAIWrapper::Load(std::istream* s) {
 	
 /* TODO

Modified: branches/caiinterface/rts/ExternalAI/SkirmishAIWrapper.h
===================================================================
--- branches/caiinterface/rts/ExternalAI/SkirmishAIWrapper.h	2008-10-08 11:14:09 UTC (rev 6608)
+++ branches/caiinterface/rts/ExternalAI/SkirmishAIWrapper.h	2008-10-08 12:06:09 UTC (rev 6609)
@@ -82,6 +82,7 @@
 
 private:
 	virtual void Init();
+	virtual void Release();
 	
 private:
 	int teamId;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001377.html">[Taspring-linux-commit] r6608 - trunk/rts/Rendering/Env
</A></li>
	<LI>Next message: <A HREF="001379.html">[Taspring-linux-commit] r6610 - trunk/tools/DedicatedServer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1378">[ date ]</a>
              <a href="thread.html#1378">[ thread ]</a>
              <a href="subject.html#1378">[ subject ]</a>
              <a href="author.html#1378">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
