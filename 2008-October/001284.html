<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r6514 - in trunk/rts: Game/UI Rendering	Rendering/Env Rendering/GL Sim/Projectiles	Sim/Projectiles/Unsynced Sim/Projectiles/WeaponProjectiles
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-October/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6514%20-%20in%20trunk/rts%3A%20Game/UI%20Rendering%0A%09Rendering/Env%20Rendering/GL%20Sim/Projectiles%0A%09Sim/Projectiles/Unsynced%20Sim/Projectiles/WeaponProjectiles&In-Reply-To=%3C20081003225522.CC0E34A5F%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001283.html">
   <LINK REL="Next"  HREF="001285.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r6514 - in trunk/rts: Game/UI Rendering	Rendering/Env Rendering/GL Sim/Projectiles	Sim/Projectiles/Unsynced Sim/Projectiles/WeaponProjectiles</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6514%20-%20in%20trunk/rts%3A%20Game/UI%20Rendering%0A%09Rendering/Env%20Rendering/GL%20Sim/Projectiles%0A%09Sim/Projectiles/Unsynced%20Sim/Projectiles/WeaponProjectiles&In-Reply-To=%3C20081003225522.CC0E34A5F%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r6514 - in trunk/rts: Game/UI Rendering	Rendering/Env Rendering/GL Sim/Projectiles	Sim/Projectiles/Unsynced Sim/Projectiles/WeaponProjectiles">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Sat Oct  4 00:55:22 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001283.html">[Taspring-linux-commit] r6513 - trunk/rts/Rendering
</A></li>
        <LI>Next message: <A HREF="001285.html">[Taspring-linux-commit] r6515 - in trunk/rts: Game/UI Lua
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1284">[ date ]</a>
              <a href="thread.html#1284">[ thread ]</a>
              <a href="subject.html#1284">[ subject ]</a>
              <a href="author.html#1284">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: zerver
Date: 2008-10-04 00:55:21 +0200 (Sat, 04 Oct 2008)
New Revision: 6514

Modified:
   trunk/rts/Game/UI/MiniMap.cpp
   trunk/rts/Rendering/Env/AdvSky.cpp
   trunk/rts/Rendering/Env/AdvTreeDrawer.cpp
   trunk/rts/Rendering/Env/AdvWater.cpp
   trunk/rts/Rendering/Env/BumpWater.cpp
   trunk/rts/Rendering/Env/DynWater.cpp
   trunk/rts/Rendering/Env/GrassDrawer.cpp
   trunk/rts/Rendering/GL/VertexArray.h
   trunk/rts/Rendering/GroundDecalHandler.cpp
   trunk/rts/Rendering/GroundFlash.cpp
   trunk/rts/Rendering/InMapDraw.cpp
   trunk/rts/Sim/Projectiles/FireProjectile.cpp
   trunk/rts/Sim/Projectiles/FlareProjectile.cpp
   trunk/rts/Sim/Projectiles/PieceProjectile.cpp
   trunk/rts/Sim/Projectiles/ProjectileHandler.cpp
   trunk/rts/Sim/Projectiles/Unsynced/MuzzleFlame.cpp
   trunk/rts/Sim/Projectiles/Unsynced/RepulseGfx.cpp
   trunk/rts/Sim/Projectiles/Unsynced/ShieldPartProjectile.cpp
   trunk/rts/Sim/Projectiles/Unsynced/SimpleParticleSystem.cpp
   trunk/rts/Sim/Projectiles/Unsynced/SmokeTrailProjectile.cpp
   trunk/rts/Sim/Projectiles/Unsynced/SpherePartProjectile.cpp
   trunk/rts/Sim/Projectiles/WeaponProjectiles/BeamLaserProjectile.cpp
   trunk/rts/Sim/Projectiles/WeaponProjectiles/ExplosiveProjectile.cpp
   trunk/rts/Sim/Projectiles/WeaponProjectiles/FireBallProjectile.cpp
   trunk/rts/Sim/Projectiles/WeaponProjectiles/LargeBeamLaserProjectile.cpp
   trunk/rts/Sim/Projectiles/WeaponProjectiles/LaserProjectile.cpp
   trunk/rts/Sim/Projectiles/WeaponProjectiles/LightingProjectile.cpp
   trunk/rts/Sim/Projectiles/WeaponProjectiles/MissileProjectile.cpp
   trunk/rts/Sim/Projectiles/WeaponProjectiles/StarburstProjectile.cpp
   trunk/rts/Sim/Projectiles/WeaponProjectiles/TorpedoProjectile.cpp
Log:
Increased usage of CVertexArray::AddVertexQ**

Modified: trunk/rts/Game/UI/MiniMap.cpp
===================================================================
--- trunk/rts/Game/UI/MiniMap.cpp	2008-10-03 22:09:22 UTC (rev 6513)
+++ trunk/rts/Game/UI/MiniMap.cpp	2008-10-03 22:55:21 UTC (rev 6514)
@@ -1101,7 +1101,9 @@
 		CVertexArray* lines=GetVertexArray();
 		CVertexArray* points=GetVertexArray();
 		lines-&gt;Initialize();
+		lines-&gt;EnlargeArrays(ph-&gt;ps.size()*2,0,VA_SIZE_C);
 		points-&gt;Initialize();
+		points-&gt;EnlargeArrays(ph-&gt;ps.size(),0,VA_SIZE_C);
 
 		static unsigned char red[4]    = {255,0,0,255};
 		static unsigned char redA[4]   = {255,0,0,128};
@@ -1118,30 +1120,30 @@
 
 				if (dynamic_cast&lt;CGeoThermSmokeProjectile*&gt;(p)) {
 				} else if (dynamic_cast&lt;CGfxProjectile*&gt;(p)) {//Nano-piece
-					points-&gt;AddVertexC(p-&gt;pos,green);
+					points-&gt;AddVertexQC(p-&gt;pos,green);
 				} else if (dynamic_cast&lt;CBeamLaserProjectile*&gt;(p)) {
 					CBeamLaserProjectile&amp; beam = *(CBeamLaserProjectile*)p;
 					unsigned char color[4] = {beam.kocolstart[0],beam.kocolstart[1],beam.kocolstart[2],255};
-					lines-&gt;AddVertexC(beam.startPos,color);
-					lines-&gt;AddVertexC(beam.endPos,color);
+					lines-&gt;AddVertexQC(beam.startPos,color);
+					lines-&gt;AddVertexQC(beam.endPos,color);
 				} else if (dynamic_cast&lt;CLargeBeamLaserProjectile*&gt;(p)) {
 					CLargeBeamLaserProjectile&amp; beam = *(CLargeBeamLaserProjectile*)p;
 					unsigned char color[4] = {beam.kocolstart[0],beam.kocolstart[1],beam.kocolstart[2],255};
-					lines-&gt;AddVertexC(beam.startPos,color);
-					lines-&gt;AddVertexC(beam.endPos,color);
+					lines-&gt;AddVertexQC(beam.startPos,color);
+					lines-&gt;AddVertexQC(beam.endPos,color);
 				} else if (dynamic_cast&lt;CLightingProjectile*&gt;(p)) {
 					CLightingProjectile&amp; beam = *(CLightingProjectile*)p;
 					unsigned char color[4] = {(unsigned char)beam.color[0]*255,(unsigned char)beam.color[1]*255,(unsigned char)beam.color[2]*255,255};
-					lines-&gt;AddVertexC(beam.pos,color);
-					lines-&gt;AddVertexC(beam.endPos,color);
+					lines-&gt;AddVertexQC(beam.pos,color);
+					lines-&gt;AddVertexQC(beam.endPos,color);
 				} else if (dynamic_cast&lt;CPieceProjectile*&gt;(p)) {
-					points-&gt;AddVertexC(p-&gt;pos,red);
+					points-&gt;AddVertexQC(p-&gt;pos,red);
 				} else if (dynamic_cast&lt;CWreckProjectile*&gt;(p)) {
-					points-&gt;AddVertexC(p-&gt;pos,redA);
+					points-&gt;AddVertexQC(p-&gt;pos,redA);
 				} else if (dynamic_cast&lt;CWeaponProjectile*&gt;(p)) {
-					points-&gt;AddVertexC(p-&gt;pos,yellow);
+					points-&gt;AddVertexQC(p-&gt;pos,yellow);
 				} else {
-					points-&gt;AddVertexC(p-&gt;pos,white);
+					points-&gt;AddVertexQC(p-&gt;pos,white);
 				}
 			}
 		}

Modified: trunk/rts/Rendering/Env/AdvSky.cpp
===================================================================
--- trunk/rts/Rendering/Env/AdvSky.cpp	2008-10-03 22:09:22 UTC (rev 6513)
+++ trunk/rts/Rendering/Env/AdvSky.cpp	2008-10-03 22:55:21 UTC (rev 6514)
@@ -781,9 +781,7 @@
 //		logOutput.Print(&quot;%f&quot;,c);
 		CVertexArray* va=GetVertexArray();
 		va-&gt;Initialize();
-#if VA_INIT_VERTEXES &lt; 4*VA_SIZE_T
-#error &quot;Vertex array too small&quot;
-#endif
+		va-&gt;CheckInitSize(4*VA_SIZE_T);
 		va-&gt;AddVertexQT(ZeroVector,0,0);
 		va-&gt;AddVertexQT(float3(1,0,0),tSize,0);
 		va-&gt;AddVertexQT(float3(1,1,0),tSize,tSize);

Modified: trunk/rts/Rendering/Env/AdvTreeDrawer.cpp
===================================================================
--- trunk/rts/Rendering/Env/AdvTreeDrawer.cpp	2008-10-03 22:09:22 UTC (rev 6513)
+++ trunk/rts/Rendering/Env/AdvTreeDrawer.cpp	2008-10-03 22:55:21 UTC (rev 6514)
@@ -467,9 +467,8 @@
 		for(FadeTree *pFTree=fadeTrees; pFTree&lt;pFT; ++pFTree) { //faded close trees
 			va=GetVertexArray();
 			va-&gt;Initialize();
-#if VA_INIT_VERTEXES &lt; 12*VA_SIZE_T
-#error &quot;Vertex array too small&quot;
-#endif
+			va-&gt;CheckInitSize(12*VA_SIZE_T);
+
 			DrawTreeVertex(pFTree-&gt;pos, pFTree-&gt;type*0.125f, pFTree-&gt;deltaY, false);
 
 			glAlphaFunc(GL_GREATER,1-pFTree-&gt;relDist*0.5f);
@@ -749,9 +748,8 @@
 		for(FadeTree *pFTree=fadeTrees; pFTree&lt;pFT; ++pFTree) { //faded close trees
 			va=GetVertexArray();
 			va-&gt;Initialize();
-#if VA_INIT_VERTEXES &lt; 12*VA_SIZE_T
-#error &quot;Vertex array too small&quot;
-#endif
+			va-&gt;CheckInitSize(12*VA_SIZE_T);
+
 			DrawTreeVertex(pFTree-&gt;pos, pFTree-&gt;type*0.125f, pFTree-&gt;deltaY, false);
 
 			glAlphaFunc(GL_GREATER,1-pFTree-&gt;relDist*0.5f);

Modified: trunk/rts/Rendering/Env/AdvWater.cpp
===================================================================
--- trunk/rts/Rendering/Env/AdvWater.cpp	2008-10-03 22:09:22 UTC (rev 6513)
+++ trunk/rts/Rendering/Env/AdvWater.cpp	2008-10-03 22:55:21 UTC (rev 6514)
@@ -175,7 +175,7 @@
 	CVertexArray* va=GetVertexArray();
 	va-&gt;Initialize();
 	va-&gt;EnlargeArrays(5*numDivs*(numDivs+1)*2,5*numDivs,VA_SIZE_TC); //!alloc room for all vertexes and strips
-	for(int a=0;a&lt;5;++a){
+	for(int a=0;a&lt;5;++a){ //! CAUTION: loop count must match EnlargeArrays above
 		bool maxReached=false;
 		for(int y=0;y&lt;numDivs;++y){
 			dir=base;
@@ -187,7 +187,7 @@
 			}
 
 			xbase=base;
-			for(int x=0;x&lt;numDivs+1;++x){
+			for(int x=0;x&lt;numDivs+1;++x){ //! CAUTION: loop count must match EnlargeArrays above
 				dir=xbase+dv;
 				dir.Normalize();
 				zpos=camera-&gt;pos+dir*(camera-&gt;pos.y/-dir.y);

Modified: trunk/rts/Rendering/Env/BumpWater.cpp
===================================================================
--- trunk/rts/Rendering/Env/BumpWater.cpp	2008-10-03 22:09:22 UTC (rev 6513)
+++ trunk/rts/Rendering/Env/BumpWater.cpp	2008-10-03 22:55:21 UTC (rev 6514)
@@ -189,9 +189,7 @@
 
 	CVertexArray *va = GetVertexArray();
 	va-&gt;Initialize();
-#if VA_INIT_VERTEXES &lt; 4*34*2*VA_SIZE_0
-#error &quot;Vertex array too small&quot;
-#endif
+	va-&gt;CheckInitSize(4*34*2*VA_SIZE_0);
 
 	const float alphainc = fastmath::PI2 / 32;
 	const float alphaincpi2 = alphainc + fastmath::PI2;	

Modified: trunk/rts/Rendering/Env/DynWater.cpp
===================================================================
--- trunk/rts/Rendering/Env/DynWater.cpp	2008-10-03 22:09:22 UTC (rev 6513)
+++ trunk/rts/Rendering/Env/DynWater.cpp	2008-10-03 22:55:21 UTC (rev 6514)
@@ -1303,9 +1303,7 @@
 
 	CVertexArray* va=GetVertexArray();
 	va-&gt;Initialize();
-#if VA_INIT_VERTEXES &lt; 4*VA_SIZE_T
-#error &quot;Vertex array too small&quot;
-#endif
+	va-&gt;CheckInitSize(4*VA_SIZE_T);
 
 	va-&gt;AddVertexQT(float3(startx,starty,0),texstart + startx*texdif,texstart + starty*texdif);
 	va-&gt;AddVertexQT(float3(startx,endy,0),texstart + startx*texdif,texstart + endy*texdif  );
@@ -1325,13 +1323,13 @@
 	float posy=camPosBig2.z-WH_SIZE-WF_SIZE;
 
 	float ys=posy;
-	for(int y=-1;y&lt;=1;++y,ys+=WF_SIZE){
+	for(int y=-1;y&lt;=1;++y,ys+=WF_SIZE){ //! CAUTION: loop count must match EnlargeArrays above
 		float xs=posx;
 		for(int x=-1;x&lt;=1;++x,xs+=WF_SIZE){
 			if(x==0 &amp;&amp; y==0)
 				continue;
 			float pys=ys;
-			for(int y2=0;y2&lt;16;++y2){
+			for(int y2=0;y2&lt;16;++y2){ //! CAUTION: loop count must match EnlargeArrays above
 				float pxs=xs;
 				float pys1=pys+WF_SIZE/16;
 				for(int x2=0;x2&lt;16;++x2){

Modified: trunk/rts/Rendering/Env/GrassDrawer.cpp
===================================================================
--- trunk/rts/Rendering/Env/GrassDrawer.cpp	2008-10-03 22:09:22 UTC (rev 6513)
+++ trunk/rts/Rendering/Env/GrassDrawer.cpp	2008-10-03 22:55:21 UTC (rev 6514)
@@ -261,15 +261,15 @@
 			int numGrass=gd-&gt;numTurfs;
 			va-&gt;EnlargeArrays(grassBlockSize*grassBlockSize*numGrass*4,0,VA_SIZE_TN);
 			int ygbsy=ygbs;
-			for(int y2=0; y2&lt;grassBlockSize; ++y2){
+			for(int y2=0; y2&lt;grassBlockSize; ++y2){ //! CAUTION: loop count must match EnlargeArrays above
 				int xgbsx=xgbs;
 				unsigned char* gm=gd-&gt;grassMap+ygbsy*gs-&gt;mapx/grassSquareSize+xgbsx;
-				for(int x2=0; x2&lt;grassBlockSize; ++x2){
+				for(int x2=0; x2&lt;grassBlockSize; ++x2){ //! CAUTION: loop count must match EnlargeArrays above
 					if(*gm){
 						srand(ygbsy*1025+xgbsx);
 						rand();
 						rand();
-						for(int a=0;a&lt;numGrass;a++){
+						for(int a=0;a&lt;numGrass;a++){ //! CAUTION: loop count must match EnlargeArrays above
 							float dx=(xgbsx+fRand(1))*gSSsq;
 							float dy=(ygbsy+fRand(1))*gSSsq;
 							float3 pos(dx,ground-&gt;GetHeight2(dx,dy)+0.5f,dy);
@@ -511,7 +511,7 @@
 			va=GetVertexArray();
 			va-&gt;Initialize();
 			va-&gt;EnlargeArrays(numGrass*4,0,VA_SIZE_TN);
-			for(int a=0;a&lt;numGrass;a++){
+			for(int a=0;a&lt;numGrass;a++){ //! CAUTION: loop count must match EnlargeArrays above
 				float dx=(x+fRand(1))*gSSsq;
 				float dy=(y+fRand(1))*gSSsq;
 				float3 pos(dx,ground-&gt;GetHeight2(dx,dy)+0.5f,dy);

Modified: trunk/rts/Rendering/GL/VertexArray.h
===================================================================
--- trunk/rts/Rendering/GL/VertexArray.h	2008-10-03 22:09:22 UTC (rev 6513)
+++ trunk/rts/Rendering/GL/VertexArray.h	2008-10-03 22:55:21 UTC (rev 6514)
@@ -1,6 +1,7 @@
 #ifndef VERTEXARRAY_H
 #define VERTEXARRAY_H
 #include &quot;myGL.h&quot;
+#include &quot;System/Platform/errorhandler.h&quot;
 // VertexArray.h: interface for the CVertexArray class.
 //
 //////////////////////////////////////////////////////////////////////
@@ -8,6 +9,7 @@
 #define VA_INIT_VERTEXES 1000 // please don't change this, some files rely on specific initial sizes
 #define VA_INIT_STRIPS 100
 #define VA_SIZE_0 3
+#define VA_SIZE_C 4
 #define VA_SIZE_T 5
 #define VA_SIZE_TN 8
 #define VA_SIZE_TC 6
@@ -18,6 +20,7 @@
 	CVertexArray();
 	~CVertexArray();
 	void Initialize();
+	inline void CheckInitSize(int vertexes, int strips=0);
 
 	inline void AddVertexTC(const float3 &amp;pos,float tx,float ty,unsigned char* color);
 	void DrawArrayTC(int drawType,int stride=24);
@@ -32,16 +35,18 @@
 	inline void AddVertexC(const float3&amp; pos,unsigned char* color);
 	void DrawArrayC(int drawType,int stride=16);
 
-	//! same as AddVertex0, but without autmated CheckEnlargeDrawArray
+	//! same as AddVertex0, but without automated CheckEnlargeDrawArray
 	inline void AddVertexQ0(float x, float y, float z);
-	//! same as AddVertexT, but without autmated CheckEnlargeDrawArray
+	//! same as AddVertexC, but without automated CheckEnlargeDrawArray
+	inline void AddVertexQC(const float3&amp; pos,unsigned char* color);
+	//! same as AddVertexT, but without automated CheckEnlargeDrawArray
 	inline void AddVertexQT(const float3&amp; pos,float tx,float ty);
-	//! same as AddVertexTN, but without autmated CheckEnlargeDrawArray
+	//! same as AddVertexTN, but without automated CheckEnlargeDrawArray
 	inline void AddVertexQTN(const float3 &amp;pos,float tx,float ty,const float3&amp; norm);
-	//! same as AddVertexTC, but without autmated CheckEnlargeDrawArray
+	//! same as AddVertexTC, but without automated CheckEnlargeDrawArray
 	inline void AddVertexQTC(const float3 &amp;pos,float tx,float ty,unsigned char* color);
 
-	//! same as EndStrip, but without autmated EnlargeStripArray
+	//! same as EndStrip, but without automated EnlargeStripArray
 	inline void EndStripQ();
 
 	bool IsReady();
@@ -75,6 +80,13 @@
 	}
 }
 
+// calls to this function will be removed by the optimizer unless the size is too small
+inline void CVertexArray::CheckInitSize(int vertexes, int strips) {
+	if(vertexes&gt;VA_INIT_VERTEXES || strips&gt;VA_INIT_STRIPS) { 
+		handleerror(drawArrayPos=NULL, &quot;Vertex array initial size is too small&quot;, &quot;Rendering error&quot;, MBF_OK | MBF_EXCL);
+	}
+}
+
 inline void CVertexArray::CheckEnlargeDrawArray() {
 	if((char *)drawArrayPos&gt;(char *)drawArraySize-10*sizeof(float))
 		EnlargeDrawArray();
@@ -94,6 +106,13 @@
 	*drawArrayPos++=z;
 }
 
+inline void CVertexArray::AddVertexQC(const float3&amp; pos,unsigned char* color) {
+	*drawArrayPos++=pos.x;
+	*drawArrayPos++=pos.y;
+	*drawArrayPos++=pos.z;
+	*drawArrayPos++=*((float*)(color));
+}
+
 inline void CVertexArray::AddVertexQT(const float3&amp; pos,float tx,float ty) {
 	*drawArrayPos++=pos.x;
 	*drawArrayPos++=pos.y;

Modified: trunk/rts/Rendering/GroundDecalHandler.cpp
===================================================================
--- trunk/rts/Rendering/GroundDecalHandler.cpp	2008-10-03 22:09:22 UTC (rev 6513)
+++ trunk/rts/Rendering/GroundDecalHandler.cpp	2008-10-03 22:55:21 UTC (rev 6514)
@@ -493,13 +493,14 @@
 					list&lt;TrackPart&gt;::iterator ppi = track-&gt;parts.begin();
 					color2[3] = track-&gt;trackAlpha - (int) ((gs-&gt;frameNum - ppi-&gt;creationTime) * track-&gt;alphaFalloff);
 
+					va-&gt;EnlargeArrays(track-&gt;parts.size()*4,0,VA_SIZE_TC);
 					for (list&lt;TrackPart&gt;::iterator pi = ++track-&gt;parts.begin(); pi != track-&gt;parts.end(); ++pi) {
 						color[3] = track-&gt;trackAlpha - (int) ((gs-&gt;frameNum - ppi-&gt;creationTime) * track-&gt;alphaFalloff);
 						if (pi-&gt;connected) {
-							va-&gt;AddVertexTC(ppi-&gt;pos1, ppi-&gt;texPos, 0, color2);
-							va-&gt;AddVertexTC(ppi-&gt;pos2, ppi-&gt;texPos, 1, color2);
-							va-&gt;AddVertexTC(pi-&gt;pos2, pi-&gt;texPos, 1, color);
-							va-&gt;AddVertexTC(pi-&gt;pos1, pi-&gt;texPos, 0, color);
+							va-&gt;AddVertexQTC(ppi-&gt;pos1, ppi-&gt;texPos, 0, color2);
+							va-&gt;AddVertexQTC(ppi-&gt;pos2, ppi-&gt;texPos, 1, color2);
+							va-&gt;AddVertexQTC(pi-&gt;pos2, pi-&gt;texPos, 1, color);
+							va-&gt;AddVertexQTC(pi-&gt;pos1, pi-&gt;texPos, 0, color);
 						}
 						color2[3] = color[3];
 						ppi = pi;

Modified: trunk/rts/Rendering/GroundFlash.cpp
===================================================================
--- trunk/rts/Rendering/GroundFlash.cpp	2008-10-03 22:09:22 UTC (rev 6513)
+++ trunk/rts/Rendering/GroundFlash.cpp	2008-10-03 22:55:21 UTC (rev 6514)
@@ -142,10 +142,10 @@
 		float3 p3=pos+( side1+side2)*iSize;
 		float3 p4=pos+(-side1+side2)*iSize;
 
-		va-&gt;AddVertexTC(p1,ph-&gt;groundringtex.xstart,ph-&gt;groundringtex.ystart,col);
-		va-&gt;AddVertexTC(p2,ph-&gt;groundringtex.xend,ph-&gt;groundringtex.ystart,col);
-		va-&gt;AddVertexTC(p3,ph-&gt;groundringtex.xend,ph-&gt;groundringtex.yend,col);
-		va-&gt;AddVertexTC(p4,ph-&gt;groundringtex.xstart,ph-&gt;groundringtex.yend,col);
+		va-&gt;AddVertexQTC(p1,ph-&gt;groundringtex.xstart,ph-&gt;groundringtex.ystart,col);
+		va-&gt;AddVertexQTC(p2,ph-&gt;groundringtex.xend,ph-&gt;groundringtex.ystart,col);
+		va-&gt;AddVertexQTC(p3,ph-&gt;groundringtex.xend,ph-&gt;groundringtex.yend,col);
+		va-&gt;AddVertexQTC(p4,ph-&gt;groundringtex.xstart,ph-&gt;groundringtex.yend,col);
 	}
 
 	float iAge=flashAge+flashAgeSpeed*gu-&gt;timeOffset;
@@ -167,10 +167,10 @@
 		float3 p3=pos+( side1+side2)*iSize;
 		float3 p4=pos+(-side1+side2)*iSize;
 
-		va-&gt;AddVertexTC(p1,ph-&gt;groundflashtex.xstart,ph-&gt;groundflashtex.yend,col);
-		va-&gt;AddVertexTC(p2,ph-&gt;groundflashtex.xend,ph-&gt;groundflashtex.yend,col);
-		va-&gt;AddVertexTC(p3,ph-&gt;groundflashtex.xend,ph-&gt;groundflashtex.ystart,col);
-		va-&gt;AddVertexTC(p4,ph-&gt;groundflashtex.xstart,ph-&gt;groundflashtex.ystart,col);
+		va-&gt;AddVertexQTC(p1,ph-&gt;groundflashtex.xstart,ph-&gt;groundflashtex.yend,col);
+		va-&gt;AddVertexQTC(p2,ph-&gt;groundflashtex.xend,ph-&gt;groundflashtex.yend,col);
+		va-&gt;AddVertexQTC(p3,ph-&gt;groundflashtex.xend,ph-&gt;groundflashtex.ystart,col);
+		va-&gt;AddVertexQTC(p4,ph-&gt;groundflashtex.xstart,ph-&gt;groundflashtex.ystart,col);
 	}
 }
 
@@ -230,10 +230,10 @@
 	float3 p3=pos+( side1+side2)*size;
 	float3 p4=pos+(-side1+side2)*size;
 
-	va-&gt;AddVertexTC(p1,texture.xstart,texture.ystart,color);
-	va-&gt;AddVertexTC(p2,texture.xend,texture.ystart,color);
-	va-&gt;AddVertexTC(p3,texture.xend,texture.yend,color);
-	va-&gt;AddVertexTC(p4,texture.xstart,texture.yend,color);
+	va-&gt;AddVertexQTC(p1,texture.xstart,texture.ystart,color);
+	va-&gt;AddVertexQTC(p2,texture.xend,texture.ystart,color);
+	va-&gt;AddVertexQTC(p3,texture.xend,texture.yend,color);
+	va-&gt;AddVertexQTC(p4,texture.xstart,texture.yend,color);
 }
 
 bool CSeismicGroundFlash::Update()
@@ -298,10 +298,10 @@
 	float3 p3=pos+( side1+side2)*size;
 	float3 p4=pos+(-side1+side2)*size;
 
-	va-&gt;AddVertexTC(p1,texture-&gt;xstart,texture-&gt;ystart,color);
-	va-&gt;AddVertexTC(p2,texture-&gt;xend,texture-&gt;ystart,color);
-	va-&gt;AddVertexTC(p3,texture-&gt;xend,texture-&gt;yend,color);
-	va-&gt;AddVertexTC(p4,texture-&gt;xstart,texture-&gt;yend,color);
+	va-&gt;AddVertexQTC(p1,texture-&gt;xstart,texture-&gt;ystart,color);
+	va-&gt;AddVertexQTC(p2,texture-&gt;xend,texture-&gt;ystart,color);
+	va-&gt;AddVertexQTC(p3,texture-&gt;xend,texture-&gt;yend,color);
+	va-&gt;AddVertexQTC(p4,texture-&gt;xstart,texture-&gt;yend,color);
 }
 
 bool CSimpleGroundFlash::Update()

Modified: trunk/rts/Rendering/InMapDraw.cpp
===================================================================
--- trunk/rts/Rendering/InMapDraw.cpp	2008-10-03 22:09:22 UTC (rev 6513)
+++ trunk/rts/Rendering/InMapDraw.cpp	2008-10-03 22:55:21 UTC (rev 6514)
@@ -235,6 +235,7 @@
 	int drawQuadsX = imd-&gt;drawQuadsX;
 	CInMapDraw::DrawQuad* dq = &amp;imd-&gt;drawQuads[y * drawQuadsX + x];
 
+	va-&gt;EnlargeArrays(dq-&gt;points.size()*12,0,VA_SIZE_TC);
 	// draw point markers
 	for (std::list&lt;CInMapDraw::MapPoint&gt;::iterator pi = dq-&gt;points.begin(); pi != dq-&gt;points.end(); ++pi) {
 		const int allyteam = pi-&gt;senderAllyTeam;
@@ -262,20 +263,20 @@
 			float3 pos2 = pos1;
 			pos2.y += 100;
 
-			va-&gt;AddVertexTC(pos1 - dir1 * size,               0.25f, 0, col);
-			va-&gt;AddVertexTC(pos1 + dir1 * size,               0.25f, 1, col);
-			va-&gt;AddVertexTC(pos1 + dir1 * size + dir2 * size, 0.00f, 1, col);
-			va-&gt;AddVertexTC(pos1 - dir1 * size + dir2 * size, 0.00f, 0, col);
+			va-&gt;AddVertexQTC(pos1 - dir1 * size,               0.25f, 0, col);
+			va-&gt;AddVertexQTC(pos1 + dir1 * size,               0.25f, 1, col);
+			va-&gt;AddVertexQTC(pos1 + dir1 * size + dir2 * size, 0.00f, 1, col);
+			va-&gt;AddVertexQTC(pos1 - dir1 * size + dir2 * size, 0.00f, 0, col);
 
-			va-&gt;AddVertexTC(pos1 - dir1 * size,               0.75f, 0, col);
-			va-&gt;AddVertexTC(pos1 + dir1 * size,               0.75f, 1, col);
-			va-&gt;AddVertexTC(pos2 + dir1 * size,               0.75f, 1, col);
-			va-&gt;AddVertexTC(pos2 - dir1 * size,               0.75f, 0, col);
+			va-&gt;AddVertexQTC(pos1 - dir1 * size,               0.75f, 0, col);
+			va-&gt;AddVertexQTC(pos1 + dir1 * size,               0.75f, 1, col);
+			va-&gt;AddVertexQTC(pos2 + dir1 * size,               0.75f, 1, col);
+			va-&gt;AddVertexQTC(pos2 - dir1 * size,               0.75f, 0, col);
 
-			va-&gt;AddVertexTC(pos2 - dir1 * size,               0.25f, 0, col);
-			va-&gt;AddVertexTC(pos2 + dir1 * size,               0.25f, 1, col);
-			va-&gt;AddVertexTC(pos2 + dir1 * size - dir2 * size, 0.00f, 1, col);
-			va-&gt;AddVertexTC(pos2 - dir1 * size - dir2 * size, 0.00f, 0, col);
+			va-&gt;AddVertexQTC(pos2 - dir1 * size,               0.25f, 0, col);
+			va-&gt;AddVertexQTC(pos2 + dir1 * size,               0.25f, 1, col);
+			va-&gt;AddVertexQTC(pos2 + dir1 * size - dir2 * size, 0.00f, 1, col);
+			va-&gt;AddVertexQTC(pos2 - dir1 * size - dir2 * size, 0.00f, 0, col);
 
 			if (pi-&gt;label.size() &gt; 0) {
 				glPushMatrix();
@@ -288,6 +289,7 @@
 		}
 	}
 
+	va-&gt;EnlargeArrays(dq-&gt;lines.size()*2,0,VA_SIZE_C);
 	// draw line markers
 	for (std::list&lt;CInMapDraw::MapLine&gt;::iterator li = dq-&gt;lines.begin(); li != dq-&gt;lines.end(); ++li) {
 		const int allyteam = li-&gt;senderAllyTeam;
@@ -296,8 +298,8 @@
 		const bool maySee = (gu-&gt;spectating || (!spec &amp;&amp; allied) || imd-&gt;drawAll);
 
 		if (maySee) {
-			lineva-&gt;AddVertexC(li-&gt;pos - (li-&gt;pos - camera-&gt;pos).ANormalize() * 26, li-&gt;color);
-			lineva-&gt;AddVertexC(li-&gt;pos2 - (li-&gt;pos2 - camera-&gt;pos).ANormalize() * 26, li-&gt;color);
+			lineva-&gt;AddVertexQC(li-&gt;pos - (li-&gt;pos - camera-&gt;pos).ANormalize() * 26, li-&gt;color);
+			lineva-&gt;AddVertexQC(li-&gt;pos2 - (li-&gt;pos2 - camera-&gt;pos).ANormalize() * 26, li-&gt;color);
 		}
 	}
 }

Modified: trunk/rts/Sim/Projectiles/FireProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/FireProjectile.cpp	2008-10-03 22:09:22 UTC (rev 6513)
+++ trunk/rts/Sim/Projectiles/FireProjectile.cpp	2008-10-03 22:55:21 UTC (rev 6514)
@@ -129,6 +129,7 @@
 	unsigned char col[4];
 	col[3]=1;
 	unsigned char col2[4];
+	va-&gt;EnlargeArrays(subParticles2.size()*4+subParticles.size()*8,0,VA_SIZE_TC);
 	for(std::list&lt;SubParticle&gt;::iterator pi=subParticles2.begin();pi!=subParticles2.end();++pi){
 		float age=pi-&gt;age+ageSpeed*gu-&gt;timeOffset;
 		float size=pi-&gt;maxSize*(age);
@@ -145,10 +146,10 @@
 		col[1]=(unsigned char)((1-age)*255);
 		col[2]=(unsigned char)((1-age)*255);
 
-		va-&gt;AddVertexTC(interPos-dir1-dir2,ph-&gt;explotex.xstart,ph-&gt;explotex.ystart,col);
-		va-&gt;AddVertexTC(interPos+dir1-dir2,ph-&gt;explotex.xend ,ph-&gt;explotex.ystart,col);
-		va-&gt;AddVertexTC(interPos+dir1+dir2,ph-&gt;explotex.xend ,ph-&gt;explotex.yend ,col);
-		va-&gt;AddVertexTC(interPos-dir1+dir2,ph-&gt;explotex.xstart,ph-&gt;explotex.yend ,col);
+		va-&gt;AddVertexQTC(interPos-dir1-dir2,ph-&gt;explotex.xstart,ph-&gt;explotex.ystart,col);
+		va-&gt;AddVertexQTC(interPos+dir1-dir2,ph-&gt;explotex.xend ,ph-&gt;explotex.ystart,col);
+		va-&gt;AddVertexQTC(interPos+dir1+dir2,ph-&gt;explotex.xend ,ph-&gt;explotex.yend ,col);
+		va-&gt;AddVertexQTC(interPos-dir1+dir2,ph-&gt;explotex.xstart,ph-&gt;explotex.yend ,col);
 	}
 	for(std::list&lt;SubParticle&gt;::iterator pi=subParticles.begin();pi!=subParticles.end();++pi){
 		float age=pi-&gt;age+ageSpeed*gu-&gt;timeOffset;
@@ -168,10 +169,10 @@
 			col[2]=(unsigned char)((1-age*1.3f)*255);
 			col[3]=1;
 
-			va-&gt;AddVertexTC(interPos-dir1-dir2,ph-&gt;explotex.xstart,ph-&gt;explotex.ystart,col);
-			va-&gt;AddVertexTC(interPos+dir1-dir2,ph-&gt;explotex.xend ,ph-&gt;explotex.ystart,col);
-			va-&gt;AddVertexTC(interPos+dir1+dir2,ph-&gt;explotex.xend ,ph-&gt;explotex.yend ,col);
-			va-&gt;AddVertexTC(interPos-dir1+dir2,ph-&gt;explotex.xstart,ph-&gt;explotex.yend ,col);
+			va-&gt;AddVertexQTC(interPos-dir1-dir2,ph-&gt;explotex.xstart,ph-&gt;explotex.ystart,col);
+			va-&gt;AddVertexQTC(interPos+dir1-dir2,ph-&gt;explotex.xend ,ph-&gt;explotex.ystart,col);
+			va-&gt;AddVertexQTC(interPos+dir1+dir2,ph-&gt;explotex.xend ,ph-&gt;explotex.yend ,col);
+			va-&gt;AddVertexQTC(interPos-dir1+dir2,ph-&gt;explotex.xstart,ph-&gt;explotex.yend ,col);
 		}
 
 		unsigned char c;
@@ -185,10 +186,10 @@
 		col2[2]=(unsigned char)(c*0.6f);
 		col2[3]=c;
 
-		va-&gt;AddVertexTC(interPos-dir1-dir2,ph-&gt;smoketex[pi-&gt;smokeType].xstart,ph-&gt;smoketex[pi-&gt;smokeType].ystart,col2);
-		va-&gt;AddVertexTC(interPos+dir1-dir2,ph-&gt;smoketex[pi-&gt;smokeType].xend,ph-&gt;smoketex[pi-&gt;smokeType].ystart,col2);
-		va-&gt;AddVertexTC(interPos+dir1+dir2,ph-&gt;smoketex[pi-&gt;smokeType].xend,ph-&gt;smoketex[pi-&gt;smokeType].yend,col2);
-		va-&gt;AddVertexTC(interPos-dir1+dir2,ph-&gt;smoketex[pi-&gt;smokeType].xstart,ph-&gt;smoketex[pi-&gt;smokeType].yend,col2);
+		va-&gt;AddVertexQTC(interPos-dir1-dir2,ph-&gt;smoketex[pi-&gt;smokeType].xstart,ph-&gt;smoketex[pi-&gt;smokeType].ystart,col2);
+		va-&gt;AddVertexQTC(interPos+dir1-dir2,ph-&gt;smoketex[pi-&gt;smokeType].xend,ph-&gt;smoketex[pi-&gt;smokeType].ystart,col2);
+		va-&gt;AddVertexQTC(interPos+dir1+dir2,ph-&gt;smoketex[pi-&gt;smokeType].xend,ph-&gt;smoketex[pi-&gt;smokeType].yend,col2);
+		va-&gt;AddVertexQTC(interPos-dir1+dir2,ph-&gt;smoketex[pi-&gt;smokeType].xstart,ph-&gt;smoketex[pi-&gt;smokeType].yend,col2);
 	}
 }
 

Modified: trunk/rts/Sim/Projectiles/FlareProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/FlareProjectile.cpp	2008-10-03 22:09:22 UTC (rev 6513)
+++ trunk/rts/Sim/Projectiles/FlareProjectile.cpp	2008-10-03 22:55:21 UTC (rev 6514)
@@ -105,12 +105,13 @@
 	col[3]=1;
 
 	float rad=6.0;
-	for(int a=0;a&lt;numSub;++a){
+	va-&gt;EnlargeArrays(numSub*4,0,VA_SIZE_TC);
+	for(int a=0;a&lt;numSub;++a){ //! CAUTION: loop count must match EnlargeArrays above
 		float3 interPos=subPos[a]+subSpeed[a]*gu-&gt;timeOffset;
 
-		va-&gt;AddVertexTC(interPos-camera-&gt;right*rad-camera-&gt;up*rad,ph-&gt;flareprojectiletex.xstart,ph-&gt;flareprojectiletex.ystart,col);
-		va-&gt;AddVertexTC(interPos+camera-&gt;right*rad-camera-&gt;up*rad,ph-&gt;flareprojectiletex.xend,ph-&gt;flareprojectiletex.ystart,col);
-		va-&gt;AddVertexTC(interPos+camera-&gt;right*rad+camera-&gt;up*rad,ph-&gt;flareprojectiletex.xend,ph-&gt;flareprojectiletex.yend,col);
-		va-&gt;AddVertexTC(interPos-camera-&gt;right*rad+camera-&gt;up*rad,ph-&gt;flareprojectiletex.xstart,ph-&gt;flareprojectiletex.yend,col);
+		va-&gt;AddVertexQTC(interPos-camera-&gt;right*rad-camera-&gt;up*rad,ph-&gt;flareprojectiletex.xstart,ph-&gt;flareprojectiletex.ystart,col);
+		va-&gt;AddVertexQTC(interPos+camera-&gt;right*rad-camera-&gt;up*rad,ph-&gt;flareprojectiletex.xend,ph-&gt;flareprojectiletex.ystart,col);
+		va-&gt;AddVertexQTC(interPos+camera-&gt;right*rad+camera-&gt;up*rad,ph-&gt;flareprojectiletex.xend,ph-&gt;flareprojectiletex.yend,col);
+		va-&gt;AddVertexQTC(interPos-camera-&gt;right*rad+camera-&gt;up*rad,ph-&gt;flareprojectiletex.xstart,ph-&gt;flareprojectiletex.yend,col);
 	}
 }

Modified: trunk/rts/Sim/Projectiles/PieceProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/PieceProjectile.cpp	2008-10-03 22:09:22 UTC (rev 6513)
+++ trunk/rts/Sim/Projectiles/PieceProjectile.cpp	2008-10-03 22:55:21 UTC (rev 6514)
@@ -341,6 +341,8 @@
 			float3 dir = speed;
 			dir.Normalize();
 
+			int numParts = age &amp; 7;
+			va-&gt;EnlargeArrays(4+4*numParts,0,VA_SIZE_TC);
 			if (drawTrail) {
 				// draw the trail as a single quad if camera close enough
 				float3 dif(interPos - camera-&gt;pos);
@@ -375,18 +377,17 @@
 				float size2 = 1 + (age2 * (1 / Smoke_Time)) * 14;
 				float txs = ph-&gt;smoketrailtex.xstart - (ph-&gt;smoketrailtex.xend - ph-&gt;smoketrailtex.xstart) * (age2 / 8.0f);
 
-				va-&gt;AddVertexTC(interPos - dir1 * size, txs, ph-&gt;smoketrailtex.ystart, col);
-				va-&gt;AddVertexTC(interPos + dir1 * size, txs, ph-&gt;smoketrailtex.yend,   col);
-				va-&gt;AddVertexTC(oldSmoke + dir2 * size2, ph-&gt;smoketrailtex.xend, ph-&gt;smoketrailtex.yend,   col2);
-				va-&gt;AddVertexTC(oldSmoke - dir2 * size2, ph-&gt;smoketrailtex.xend, ph-&gt;smoketrailtex.ystart, col2);
+				va-&gt;AddVertexQTC(interPos - dir1 * size, txs, ph-&gt;smoketrailtex.ystart, col);
+				va-&gt;AddVertexQTC(interPos + dir1 * size, txs, ph-&gt;smoketrailtex.yend,   col);
+				va-&gt;AddVertexQTC(oldSmoke + dir2 * size2, ph-&gt;smoketrailtex.xend, ph-&gt;smoketrailtex.yend,   col2);
+				va-&gt;AddVertexQTC(oldSmoke - dir2 * size2, ph-&gt;smoketrailtex.xend, ph-&gt;smoketrailtex.ystart, col2);
 			} else {
 				// draw the trail as particles
 				float dist = pos.distance(oldSmoke);
 				float3 dirpos1 = pos - dir * dist * 0.33f;
 				float3 dirpos2 = oldSmoke + oldSmokeDir * dist * 0.33f;
 
-				int numParts = age &amp; 7;
-				for (int a = 0; a &lt; numParts; ++a) {
+				for (int a = 0; a &lt; numParts; ++a) { //! CAUTION: loop count must match EnlargeArrays above
 					float alpha = 255;
 					col[0] = (unsigned char) (color * alpha);
 					col[1] = (unsigned char) (color * alpha);
@@ -395,10 +396,10 @@
 					float size = 1 + ((a) * (1 / Smoke_Time)) * 14;
 					float3 pos1 = CalcBeizer(float(a) / (numParts), pos, dirpos1, dirpos2, oldSmoke);
 
-					va-&gt;AddVertexTC(pos1 + ( camera-&gt;up+camera-&gt;right) * size, ph-&gt;smoketex[0].xstart, ph-&gt;smoketex[0].ystart, col);
-					va-&gt;AddVertexTC(pos1 + ( camera-&gt;up-camera-&gt;right) * size, ph-&gt;smoketex[0].xend,   ph-&gt;smoketex[0].ystart, col);
-					va-&gt;AddVertexTC(pos1 + (-camera-&gt;up-camera-&gt;right) * size, ph-&gt;smoketex[0].xend,   ph-&gt;smoketex[0].ystart, col);
-					va-&gt;AddVertexTC(pos1 + (-camera-&gt;up+camera-&gt;right) * size, ph-&gt;smoketex[0].xstart, ph-&gt;smoketex[0].ystart, col);
+					va-&gt;AddVertexQTC(pos1 + ( camera-&gt;up+camera-&gt;right) * size, ph-&gt;smoketex[0].xstart, ph-&gt;smoketex[0].ystart, col);
+					va-&gt;AddVertexQTC(pos1 + ( camera-&gt;up-camera-&gt;right) * size, ph-&gt;smoketex[0].xend,   ph-&gt;smoketex[0].ystart, col);
+					va-&gt;AddVertexQTC(pos1 + (-camera-&gt;up-camera-&gt;right) * size, ph-&gt;smoketex[0].xend,   ph-&gt;smoketex[0].ystart, col);
+					va-&gt;AddVertexQTC(pos1 + (-camera-&gt;up+camera-&gt;right) * size, ph-&gt;smoketex[0].xstart, ph-&gt;smoketex[0].ystart, col);
 				}
 			}
 		}
@@ -423,6 +424,7 @@
 	unsigned char col[4];
 
 	if (flags &amp; PP_Fire) {
+		va-&gt;EnlargeArrays(8*4,0,VA_SIZE_TC);
 		for (int age = 0; age &lt; 8; ++age) {
 			float modage = age;
 			float3 interPos = oldInfos[age]-&gt;pos;
@@ -435,10 +437,10 @@
 			col[3] = (unsigned char) (alpha * 50);
 			float drawsize = (0.5f + modage) * size;
 
-			va-&gt;AddVertexTC(interPos - camera-&gt;right * drawsize-camera-&gt;up * drawsize, ph-&gt;explofadetex.xstart, ph-&gt;explofadetex.ystart, col);
-			va-&gt;AddVertexTC(interPos + camera-&gt;right * drawsize-camera-&gt;up * drawsize, ph-&gt;explofadetex.xend,   ph-&gt;explofadetex.ystart, col);
-			va-&gt;AddVertexTC(interPos + camera-&gt;right * drawsize+camera-&gt;up * drawsize, ph-&gt;explofadetex.xend,   ph-&gt;explofadetex.yend,   col);
-			va-&gt;AddVertexTC(interPos - camera-&gt;right * drawsize+camera-&gt;up * drawsize, ph-&gt;explofadetex.xstart, ph-&gt;explofadetex.yend,   col);
+			va-&gt;AddVertexQTC(interPos - camera-&gt;right * drawsize-camera-&gt;up * drawsize, ph-&gt;explofadetex.xstart, ph-&gt;explofadetex.ystart, col);
+			va-&gt;AddVertexQTC(interPos + camera-&gt;right * drawsize-camera-&gt;up * drawsize, ph-&gt;explofadetex.xend,   ph-&gt;explofadetex.ystart, col);
+			va-&gt;AddVertexQTC(interPos + camera-&gt;right * drawsize+camera-&gt;up * drawsize, ph-&gt;explofadetex.xend,   ph-&gt;explofadetex.yend,   col);
+			va-&gt;AddVertexQTC(interPos - camera-&gt;right * drawsize+camera-&gt;up * drawsize, ph-&gt;explofadetex.xstart, ph-&gt;explofadetex.yend,   col);
 		}
 	}
 }

Modified: trunk/rts/Sim/Projectiles/ProjectileHandler.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/ProjectileHandler.cpp	2008-10-03 22:09:22 UTC (rev 6513)
+++ trunk/rts/Sim/Projectiles/ProjectileHandler.cpp	2008-10-03 22:55:21 UTC (rev 6514)
@@ -482,6 +482,7 @@
 	unitDrawer-&gt;SetupForUnitDrawing();
 
 	va-&gt;Initialize();
+	va-&gt;EnlargeArrays(flying3doPieces-&gt;size()*4,0,VA_SIZE_TN);
 	numFlyingPieces += flying3doPieces-&gt;size();
 	for(list&lt;FlyingPiece*&gt;::iterator pi=flying3doPieces-&gt;begin();pi!=flying3doPieces-&gt;end();++pi){
 		CMatrix44f m;
@@ -495,25 +496,25 @@
 		float3 tp=m.Mul(v-&gt;pos);
 		float3 tn=m.Mul(v-&gt;normal);
 		tp+=interPos;
-		va-&gt;AddVertexTN(tp,tex-&gt;xstart,tex-&gt;ystart,tn);
+		va-&gt;AddVertexQTN(tp,tex-&gt;xstart,tex-&gt;ystart,tn);
 
 		v=&amp;vertices[verticesIdx[1]];
 		tp=m.Mul(v-&gt;pos);
 		tn=m.Mul(v-&gt;normal);
 		tp+=interPos;
-		va-&gt;AddVertexTN(tp,tex-&gt;xend,tex-&gt;ystart,tn);
+		va-&gt;AddVertexQTN(tp,tex-&gt;xend,tex-&gt;ystart,tn);
 
 		v=&amp;vertices[verticesIdx[2]];
 		tp=m.Mul(v-&gt;pos);
 		tn=m.Mul(v-&gt;normal);
 		tp+=interPos;
-		va-&gt;AddVertexTN(tp,tex-&gt;xend,tex-&gt;yend,tn);
+		va-&gt;AddVertexQTN(tp,tex-&gt;xend,tex-&gt;yend,tn);
 
 		v=&amp;vertices[verticesIdx[3]];
 		tp=m.Mul(v-&gt;pos);
 		tn=m.Mul(v-&gt;normal);
 		tp+=interPos;
-		va-&gt;AddVertexTN(tp,tex-&gt;xstart,tex-&gt;yend,tn);
+		va-&gt;AddVertexQTN(tp,tex-&gt;xstart,tex-&gt;yend,tn);
 	}
 	drawnPieces+=va-&gt;drawIndex()/32;
 	va-&gt;DrawArrayTN(GL_QUADS);
@@ -534,6 +535,7 @@
 			unitDrawer-&gt;SetS3OTeamColour(team);
 
 			va-&gt;Initialize();
+			va-&gt;EnlargeArrays(fpl-&gt;size()*4,0,VA_SIZE_TN);
 
 			numFlyingPieces += fpl-&gt;size();
 
@@ -550,7 +552,7 @@
 					tp=m.Mul(verts[i].pos);
 					tn=m.Mul(verts[i].normal);
 					tp+=interPos;
-					va-&gt;AddVertexTN(tp,verts[i].textureX,verts[i].textureY,tn);
+					va-&gt;AddVertexQTN(tp,verts[i].textureX,verts[i].textureY,tn);
 				}
 			}
 			drawnPieces+=va-&gt;drawIndex()/32;
@@ -832,6 +834,7 @@
 
 	CGroundFlash::va=GetVertexArray();
 	CGroundFlash::va-&gt;Initialize();
+	CGroundFlash::va-&gt;EnlargeArrays(8*groundFlashes.size(),0,VA_SIZE_TC);
 
 	vector&lt;CGroundFlash*&gt;::iterator gfi;
 	for(gfi=groundFlashes.begin();gfi!=groundFlashes.end();++gfi){
@@ -971,13 +974,14 @@
 
 		CVertexArray* va=GetVertexArray();
 		va-&gt;Initialize();
+		va-&gt;CheckInitSize(4*VA_SIZE_TC,0);
 		for(int b=0;b&lt;4;++b)
 			col[b]=int((1-perlinBlend[a])*16*size);
 		glBindTexture(GL_TEXTURE_2D, perlinTex[a*2]);
-		va-&gt;AddVertexTC(float3(0,0,0),0,0,col);
-		va-&gt;AddVertexTC(float3(0,1,0),0,tsize,col);
-		va-&gt;AddVertexTC(float3(1,1,0),tsize,tsize,col);
-		va-&gt;AddVertexTC(float3(1,0,0),tsize,0,col);
+		va-&gt;AddVertexQTC(float3(0,0,0),0,0,col);
+		va-&gt;AddVertexQTC(float3(0,1,0),0,tsize,col);
+		va-&gt;AddVertexQTC(float3(1,1,0),tsize,tsize,col);
+		va-&gt;AddVertexQTC(float3(1,0,0),tsize,0,col);
 		va-&gt;DrawArrayTC(GL_QUADS);
 
 		if(a==0)
@@ -985,13 +989,14 @@
 
 		va=GetVertexArray();
 		va-&gt;Initialize();
+		va-&gt;CheckInitSize(4*VA_SIZE_TC,0);
 		for(int b=0;b&lt;4;++b)
 			col[b]=int(perlinBlend[a]*16*size);
 		glBindTexture(GL_TEXTURE_2D, perlinTex[a*2+1]);
-		va-&gt;AddVertexTC(float3(0,0,0),0,0,col);
-		va-&gt;AddVertexTC(float3(0,1,0),0,tsize,col);
-		va-&gt;AddVertexTC(float3(1,1,0),tsize,tsize,col);
-		va-&gt;AddVertexTC(float3(1,0,0),tsize,0,col);
+		va-&gt;AddVertexQTC(float3(0,0,0),0,0,col);
+		va-&gt;AddVertexQTC(float3(0,1,0),0,tsize,col);
+		va-&gt;AddVertexQTC(float3(1,1,0),tsize,tsize,col);
+		va-&gt;AddVertexQTC(float3(1,0,0),tsize,0,col);
 		va-&gt;DrawArrayTC(GL_QUADS);
 
 		speed*=0.6f;

Modified: trunk/rts/Sim/Projectiles/Unsynced/MuzzleFlame.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/Unsynced/MuzzleFlame.cpp	2008-10-03 22:09:22 UTC (rev 6513)
+++ trunk/rts/Sim/Projectiles/Unsynced/MuzzleFlame.cpp	2008-10-03 22:55:21 UTC (rev 6514)
@@ -68,7 +68,9 @@
 	float alpha=std::max(0.f,1-age/(4+size*30));
 	float modAge=sqrt(static_cast&lt;float&gt;(age+2));
 
-	for (int a = 0; a &lt; numSmoke; ++a) {
+	va-&gt;EnlargeArrays(numSmoke*8,0,VA_SIZE_TC);
+
+	for (int a = 0; a &lt; numSmoke; ++a) { //! CAUTION: loop count must match EnlargeArrays above
 		int tex = a % ph-&gt;smoketex.size();
 		//float xmod=0.125f+(float(int(tex%6)))/16;
 		//float ymod=(int(tex/6))/16.0f;
@@ -82,10 +84,10 @@
 		col[2]=(unsigned char) (180*alpha*fade);
 		col[3]=(unsigned char) (alpha*255*fade);
 
-		va-&gt;AddVertexTC(interPos-camera-&gt;right*drawsize-camera-&gt;up*drawsize,ph-&gt;smoketex[tex].xstart,ph-&gt;smoketex[tex].ystart,col);
-		va-&gt;AddVertexTC(interPos+camera-&gt;right*drawsize-camera-&gt;up*drawsize,ph-&gt;smoketex[tex].xend,ph-&gt;smoketex[tex].ystart,col);
-		va-&gt;AddVertexTC(interPos+camera-&gt;right*drawsize+camera-&gt;up*drawsize,ph-&gt;smoketex[tex].xend,ph-&gt;smoketex[tex].yend,col);
-		va-&gt;AddVertexTC(interPos-camera-&gt;right*drawsize+camera-&gt;up*drawsize,ph-&gt;smoketex[tex].xstart,ph-&gt;smoketex[tex].yend,col);
+		va-&gt;AddVertexQTC(interPos-camera-&gt;right*drawsize-camera-&gt;up*drawsize,ph-&gt;smoketex[tex].xstart,ph-&gt;smoketex[tex].ystart,col);
+		va-&gt;AddVertexQTC(interPos+camera-&gt;right*drawsize-camera-&gt;up*drawsize,ph-&gt;smoketex[tex].xend,ph-&gt;smoketex[tex].ystart,col);
+		va-&gt;AddVertexQTC(interPos+camera-&gt;right*drawsize+camera-&gt;up*drawsize,ph-&gt;smoketex[tex].xend,ph-&gt;smoketex[tex].yend,col);
+		va-&gt;AddVertexQTC(interPos-camera-&gt;right*drawsize+camera-&gt;up*drawsize,ph-&gt;smoketex[tex].xstart,ph-&gt;smoketex[tex].yend,col);
 
 		if(fade&lt;1){
 			float ifade= 1-fade;
@@ -94,10 +96,10 @@
 			col[2]=(unsigned char)(ifade*255);
 			col[3]=(unsigned char)(1);
 
-			va-&gt;AddVertexTC(interPos-camera-&gt;right*drawsize-camera-&gt;up*drawsize,ph-&gt;muzzleflametex.xstart,ph-&gt;muzzleflametex.ystart,col);
-			va-&gt;AddVertexTC(interPos+camera-&gt;right*drawsize-camera-&gt;up*drawsize,ph-&gt;muzzleflametex.xend ,ph-&gt;muzzleflametex.ystart,col);
-			va-&gt;AddVertexTC(interPos+camera-&gt;right*drawsize+camera-&gt;up*drawsize,ph-&gt;muzzleflametex.xend ,ph-&gt;muzzleflametex.yend ,col);
-			va-&gt;AddVertexTC(interPos-camera-&gt;right*drawsize+camera-&gt;up*drawsize,ph-&gt;muzzleflametex.xstart,ph-&gt;muzzleflametex.yend ,col);
+			va-&gt;AddVertexQTC(interPos-camera-&gt;right*drawsize-camera-&gt;up*drawsize,ph-&gt;muzzleflametex.xstart,ph-&gt;muzzleflametex.ystart,col);
+			va-&gt;AddVertexQTC(interPos+camera-&gt;right*drawsize-camera-&gt;up*drawsize,ph-&gt;muzzleflametex.xend ,ph-&gt;muzzleflametex.ystart,col);
+			va-&gt;AddVertexQTC(interPos+camera-&gt;right*drawsize+camera-&gt;up*drawsize,ph-&gt;muzzleflametex.xend ,ph-&gt;muzzleflametex.yend ,col);
+			va-&gt;AddVertexQTC(interPos-camera-&gt;right*drawsize+camera-&gt;up*drawsize,ph-&gt;muzzleflametex.xstart,ph-&gt;muzzleflametex.yend ,col);
 		}
 	}
 }

Modified: trunk/rts/Sim/Projectiles/Unsynced/RepulseGfx.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/Unsynced/RepulseGfx.cpp	2008-10-03 22:09:22 UTC (rev 6513)
+++ trunk/rts/Sim/Projectiles/Unsynced/RepulseGfx.cpp	2008-10-03 22:55:21 UTC (rev 6514)
@@ -91,16 +91,17 @@
 	float txs=et.xend-et.xstart;
 	float tys=et.yend-et.ystart;
 
-	for(int y=0;y&lt;4;++y){
+	va-&gt;EnlargeArrays(4*4*4+16,0,VA_SIZE_TC);
+	for(int y=0;y&lt;4;++y){ //! CAUTION: loop count must match EnlargeArrays above
 		float dy=y-2;
 		float ry=y*0.25f;
 		for(int x=0;x&lt;4;++x){
 			float dx=x-2;
 			float rx=x*0.25f;
-			va-&gt;AddVertexTC(pos+dir1*drawsize*(dx+0)+dir2*drawsize*(dy+0)+dir*difs[y*5+x]			 ,txo+ry*txs				,tyo+(rx)*tys			,col);
-			va-&gt;AddVertexTC(pos+dir1*drawsize*(dx+0)+dir2*drawsize*(dy+1)+dir*difs[(y+1)*5+x]  ,txo+(ry+0.25f)*txs	,tyo+(rx)*tys			,col);
-			va-&gt;AddVertexTC(pos+dir1*drawsize*(dx+1)+dir2*drawsize*(dy+1)+dir*difs[(y+1)*5+x+1],txo+(ry+0.25f)*txs	,tyo+(rx+0.25f)*tys,col);
-			va-&gt;AddVertexTC(pos+dir1*drawsize*(dx+1)+dir2*drawsize*(dy+0)+dir*difs[y*5+x+1]		 ,txo+ry*txs				,tyo+(rx+0.25f)*tys,col);
+			va-&gt;AddVertexQTC(pos+dir1*drawsize*(dx+0)+dir2*drawsize*(dy+0)+dir*difs[y*5+x]			 ,txo+ry*txs				,tyo+(rx)*tys			,col);
+			va-&gt;AddVertexQTC(pos+dir1*drawsize*(dx+0)+dir2*drawsize*(dy+1)+dir*difs[(y+1)*5+x]  ,txo+(ry+0.25f)*txs	,tyo+(rx)*tys			,col);
+			va-&gt;AddVertexQTC(pos+dir1*drawsize*(dx+1)+dir2*drawsize*(dy+1)+dir*difs[(y+1)*5+x+1],txo+(ry+0.25f)*txs	,tyo+(rx+0.25f)*tys,col);
+			va-&gt;AddVertexQTC(pos+dir1*drawsize*(dx+1)+dir2*drawsize*(dy+0)+dir*difs[y*5+x+1]		 ,txo+ry*txs				,tyo+(rx+0.25f)*tys,col);
 		}
 	}
 	drawsize=7;
@@ -120,25 +121,25 @@
 	col2[2]=0;
 	col2[3]=0;
 
-	va-&gt;AddVertexTC(owner-&gt;pos+(-dir1+dir2)*drawsize*0.2f,tx,ty,col2);
-	va-&gt;AddVertexTC(owner-&gt;pos+(dir1+dir2)*drawsize*0.2f,tx,ty,col2);
-	va-&gt;AddVertexTC(pos+dir1*drawsize+dir2*drawsize+dir*difs[6],tx,ty,col);
-	va-&gt;AddVertexTC(pos-dir1*drawsize+dir2*drawsize+dir*difs[6],tx,ty,col);
+	va-&gt;AddVertexQTC(owner-&gt;pos+(-dir1+dir2)*drawsize*0.2f,tx,ty,col2);
+	va-&gt;AddVertexQTC(owner-&gt;pos+(dir1+dir2)*drawsize*0.2f,tx,ty,col2);
+	va-&gt;AddVertexQTC(pos+dir1*drawsize+dir2*drawsize+dir*difs[6],tx,ty,col);
+	va-&gt;AddVertexQTC(pos-dir1*drawsize+dir2*drawsize+dir*difs[6],tx,ty,col);
 
-	va-&gt;AddVertexTC(owner-&gt;pos+(-dir1-dir2)*drawsize*0.2f,tx,ty,col2);
-	va-&gt;AddVertexTC(owner-&gt;pos+(dir1-dir2)*drawsize*0.2f,tx,ty,col2);
-	va-&gt;AddVertexTC(pos+dir1*drawsize-dir2*drawsize+dir*difs[6],tx,ty,col);
-	va-&gt;AddVertexTC(pos-dir1*drawsize-dir2*drawsize+dir*difs[6],tx,ty,col);
+	va-&gt;AddVertexQTC(owner-&gt;pos+(-dir1-dir2)*drawsize*0.2f,tx,ty,col2);
+	va-&gt;AddVertexQTC(owner-&gt;pos+(dir1-dir2)*drawsize*0.2f,tx,ty,col2);
+	va-&gt;AddVertexQTC(pos+dir1*drawsize-dir2*drawsize+dir*difs[6],tx,ty,col);
+	va-&gt;AddVertexQTC(pos-dir1*drawsize-dir2*drawsize+dir*difs[6],tx,ty,col);
 
-	va-&gt;AddVertexTC(owner-&gt;pos+(dir1-dir2)*drawsize*0.2f,tx,ty,col2);
-	va-&gt;AddVertexTC(owner-&gt;pos+(dir1+dir2)*drawsize*0.2f,tx,ty,col2);
-	va-&gt;AddVertexTC(pos+dir1*drawsize+dir2*drawsize+dir*difs[6],tx,ty,col);
-	va-&gt;AddVertexTC(pos+dir1*drawsize-dir2*drawsize+dir*difs[6],tx,ty,col);
+	va-&gt;AddVertexQTC(owner-&gt;pos+(dir1-dir2)*drawsize*0.2f,tx,ty,col2);
+	va-&gt;AddVertexQTC(owner-&gt;pos+(dir1+dir2)*drawsize*0.2f,tx,ty,col2);
+	va-&gt;AddVertexQTC(pos+dir1*drawsize+dir2*drawsize+dir*difs[6],tx,ty,col);
+	va-&gt;AddVertexQTC(pos+dir1*drawsize-dir2*drawsize+dir*difs[6],tx,ty,col);
 
-	va-&gt;AddVertexTC(owner-&gt;pos+(-dir1-dir2)*drawsize*0.2f,tx,ty,col2);
-	va-&gt;AddVertexTC(owner-&gt;pos+(-dir1+dir2)*drawsize*0.2f,tx,ty,col2);
-	va-&gt;AddVertexTC(pos-dir1*drawsize+dir2*drawsize+dir*difs[6],tx,ty,col);
-	va-&gt;AddVertexTC(pos-dir1*drawsize-dir2*drawsize+dir*difs[6],tx,ty,col);
+	va-&gt;AddVertexQTC(owner-&gt;pos+(-dir1-dir2)*drawsize*0.2f,tx,ty,col2);
+	va-&gt;AddVertexQTC(owner-&gt;pos+(-dir1+dir2)*drawsize*0.2f,tx,ty,col2);
+	va-&gt;AddVertexQTC(pos-dir1*drawsize+dir2*drawsize+dir*difs[6],tx,ty,col);
+	va-&gt;AddVertexQTC(pos-dir1*drawsize-dir2*drawsize+dir*difs[6],tx,ty,col);
 }
 
 void CRepulseGfx::Update(void)

Modified: trunk/rts/Sim/Projectiles/Unsynced/ShieldPartProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/Unsynced/ShieldPartProjectile.cpp	2008-10-03 22:09:22 UTC (rev 6513)
+++ trunk/rts/Sim/Projectiles/Unsynced/ShieldPartProjectile.cpp	2008-10-03 22:55:21 UTC (rev 6514)
@@ -73,7 +73,8 @@
 	inArray = true;
 	unsigned char col[4];
 
-	for (int y = 0; y &lt; 4; ++y) {
+	va-&gt;EnlargeArrays(4*4*4,0,VA_SIZE_TC);
+	for (int y = 0; y &lt; 4; ++y) { //! CAUTION: loop count must match EnlargeArrays above
 		for (int x = 0; x &lt; 4; ++x) {
 			float alpha = baseAlpha * 255;
 
@@ -81,10 +82,10 @@
 			col[1] = (unsigned char) (color.y * alpha);
 			col[2] = (unsigned char) (color.z * alpha);
 			col[3] = (unsigned char) (alpha);
-			va-&gt;AddVertexTC(centerPos + vectors[(y    ) * 5 + x    ] * sphereSize, texCoords[(y    ) * 5 + x    ].x, texCoords[(y    ) * 5 + x    ].y, col);
-			va-&gt;AddVertexTC(centerPos + vectors[(y    ) * 5 + x + 1] * sphereSize, texCoords[(y    ) * 5 + x + 1].x, texCoords[(y    ) * 5 + x + 1].y, col);
-			va-&gt;AddVertexTC(centerPos + vectors[(y + 1) * 5 + x + 1] * sphereSize, texCoords[(y + 1) * 5 + x + 1].x, texCoords[(y + 1) * 5 + x + 1].y, col);
-			va-&gt;AddVertexTC(centerPos + vectors[(y + 1) * 5 + x    ] * sphereSize, texCoords[(y + 1) * 5 + x    ].x, texCoords[(y + 1) * 5 + x    ].y, col);
+			va-&gt;AddVertexQTC(centerPos + vectors[(y    ) * 5 + x    ] * sphereSize, texCoords[(y    ) * 5 + x    ].x, texCoords[(y    ) * 5 + x    ].y, col);
+			va-&gt;AddVertexQTC(centerPos + vectors[(y    ) * 5 + x + 1] * sphereSize, texCoords[(y    ) * 5 + x + 1].x, texCoords[(y    ) * 5 + x + 1].y, col);
+			va-&gt;AddVertexQTC(centerPos + vectors[(y + 1) * 5 + x + 1] * sphereSize, texCoords[(y + 1) * 5 + x + 1].x, texCoords[(y + 1) * 5 + x + 1].y, col);
+			va-&gt;AddVertexQTC(centerPos + vectors[(y + 1) * 5 + x    ] * sphereSize, texCoords[(y + 1) * 5 + x    ].x, texCoords[(y + 1) * 5 + x    ].y, col);
 		}
 	}
 }

Modified: trunk/rts/Sim/Projectiles/Unsynced/SimpleParticleSystem.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/Unsynced/SimpleParticleSystem.cpp	2008-10-03 22:09:22 UTC (rev 6513)
+++ trunk/rts/Sim/Projectiles/Unsynced/SimpleParticleSystem.cpp	2008-10-03 22:55:21 UTC (rev 6514)
@@ -71,6 +71,7 @@
 {
 	inArray=true;
 
+	va-&gt;EnlargeArrays(numParticles*4,0,VA_SIZE_TC);
 	if(directional)
 	{
 		for(int i=0; i&lt;numParticles; i++)
@@ -89,10 +90,10 @@
 				colorMap-&gt;GetColor(color, particles[i].life);
 				float3 interPos=particles[i].pos+particles[i].speed*gu-&gt;timeOffset;
 				float size = particles[i].size;
-				va-&gt;AddVertexTC(interPos-dir1*size-dir2*size,texture-&gt;xstart,texture-&gt;ystart,color);
-				va-&gt;AddVertexTC(interPos-dir1*size+dir2*size,texture-&gt;xend ,texture-&gt;ystart,color);
-				va-&gt;AddVertexTC(interPos+dir1*size+dir2*size,texture-&gt;xend ,texture-&gt;yend ,color);
-				va-&gt;AddVertexTC(interPos+dir1*size-dir2*size,texture-&gt;xstart,texture-&gt;yend ,color);
+				va-&gt;AddVertexQTC(interPos-dir1*size-dir2*size,texture-&gt;xstart,texture-&gt;ystart,color);
+				va-&gt;AddVertexQTC(interPos-dir1*size+dir2*size,texture-&gt;xend ,texture-&gt;ystart,color);
+				va-&gt;AddVertexQTC(interPos+dir1*size+dir2*size,texture-&gt;xend ,texture-&gt;yend ,color);
+				va-&gt;AddVertexQTC(interPos+dir1*size-dir2*size,texture-&gt;xstart,texture-&gt;yend ,color);
 			}
 		}
 	}
@@ -108,10 +109,10 @@
 				float3 interPos=particles[i].pos+particles[i].speed*gu-&gt;timeOffset;
 				float size = particles[i].size;
 
-				va-&gt;AddVertexTC(interPos-camera-&gt;right*size-camera-&gt;up*size,texture-&gt;xstart,texture-&gt;ystart,color);
-				va-&gt;AddVertexTC(interPos+camera-&gt;right*size-camera-&gt;up*size,texture-&gt;xend ,texture-&gt;ystart,color);
-				va-&gt;AddVertexTC(interPos+camera-&gt;right*size+camera-&gt;up*size,texture-&gt;xend ,texture-&gt;yend ,color);
-				va-&gt;AddVertexTC(interPos-camera-&gt;right*size+camera-&gt;up*size,texture-&gt;xstart,texture-&gt;yend ,color);
+				va-&gt;AddVertexQTC(interPos-camera-&gt;right*size-camera-&gt;up*size,texture-&gt;xstart,texture-&gt;ystart,color);
+				va-&gt;AddVertexQTC(interPos+camera-&gt;right*size-camera-&gt;up*size,texture-&gt;xend ,texture-&gt;ystart,color);
+				va-&gt;AddVertexQTC(interPos+camera-&gt;right*size+camera-&gt;up*size,texture-&gt;xend ,texture-&gt;yend ,color);
+				va-&gt;AddVertexQTC(interPos-camera-&gt;right*size+camera-&gt;up*size,texture-&gt;xstart,texture-&gt;yend ,color);
 			}
 		}
 	}

Modified: trunk/rts/Sim/Projectiles/Unsynced/SmokeTrailProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/Unsynced/SmokeTrailProjectile.cpp	2008-10-03 22:09:22 UTC (rev 6513)
+++ trunk/rts/Sim/Projectiles/Unsynced/SmokeTrailProjectile.cpp	2008-10-03 22:55:21 UTC (rev 6514)
@@ -96,6 +96,7 @@
 {
 	inArray=true;
 	float age=gs-&gt;frameNum+gu-&gt;timeOffset-creationTime;
+	va-&gt;EnlargeArrays(8*4,0,VA_SIZE_TC);
 
 	if(drawTrail){
 		float3 dif(pos1-camera-&gt;pos2);
@@ -150,20 +151,20 @@
 
 			float midtexx = texture-&gt;xstart + (texture-&gt;xend - texture-&gt;xstart)*0.5f;
 
-			va-&gt;AddVertexTC(pos1-odir1*size,texture-&gt;xstart,texture-&gt;ystart,col);
-			va-&gt;AddVertexTC(pos1+odir1*size,texture-&gt;xstart,texture-&gt;yend,col);
-			va-&gt;AddVertexTC(midpos+odir3*size3,midtexx,texture-&gt;yend,col3);
-			va-&gt;AddVertexTC(midpos-odir3*size3,midtexx,texture-&gt;ystart,col3);
+			va-&gt;AddVertexQTC(pos1-odir1*size,texture-&gt;xstart,texture-&gt;ystart,col);
+			va-&gt;AddVertexQTC(pos1+odir1*size,texture-&gt;xstart,texture-&gt;yend,col);
+			va-&gt;AddVertexQTC(midpos+odir3*size3,midtexx,texture-&gt;yend,col3);
+			va-&gt;AddVertexQTC(midpos-odir3*size3,midtexx,texture-&gt;ystart,col3);
 
-			va-&gt;AddVertexTC(midpos-odir3*size3,midtexx,texture-&gt;ystart,col3);
-			va-&gt;AddVertexTC(midpos+odir3*size3,midtexx,texture-&gt;yend,col3);
-			va-&gt;AddVertexTC(pos2+odir2*size2,texture-&gt;xend,texture-&gt;yend,col2);
-			va-&gt;AddVertexTC(pos2-odir2*size2,texture-&gt;xend,texture-&gt;ystart,col2);
+			va-&gt;AddVertexQTC(midpos-odir3*size3,midtexx,texture-&gt;ystart,col3);
+			va-&gt;AddVertexQTC(midpos+odir3*size3,midtexx,texture-&gt;yend,col3);
+			va-&gt;AddVertexQTC(pos2+odir2*size2,texture-&gt;xend,texture-&gt;yend,col2);
+			va-&gt;AddVertexQTC(pos2-odir2*size2,texture-&gt;xend,texture-&gt;ystart,col2);
 		} else {
-			va-&gt;AddVertexTC(pos1-odir1*size,texture-&gt;xstart,texture-&gt;ystart,col);
-			va-&gt;AddVertexTC(pos1+odir1*size,texture-&gt;xstart,texture-&gt;yend,col);
-			va-&gt;AddVertexTC(pos2+odir2*size2,texture-&gt;xend,texture-&gt;yend,col2);
-			va-&gt;AddVertexTC(pos2-odir2*size2,texture-&gt;xend,texture-&gt;ystart,col2);
+			va-&gt;AddVertexQTC(pos1-odir1*size,texture-&gt;xstart,texture-&gt;ystart,col);
+			va-&gt;AddVertexQTC(pos1+odir1*size,texture-&gt;xstart,texture-&gt;yend,col);
+			va-&gt;AddVertexQTC(pos2+odir2*size2,texture-&gt;xend,texture-&gt;yend,col2);
+			va-&gt;AddVertexQTC(pos2-odir2*size2,texture-&gt;xend,texture-&gt;ystart,col2);
 		}
 	} else {	//draw as particles
 		unsigned char col[4];
@@ -177,10 +178,10 @@
 			float size=((0.2f+(age+a)*(1.0f/lifeTime))*orgSize)*1.2f;
 
 			float3 pos=CalcBeizer(a/8.0f,pos1,dirpos1,dirpos2,pos2);
-			va-&gt;AddVertexTC(pos1+( camera-&gt;up+camera-&gt;right)*size, ph-&gt;smoketex[0].xstart, ph-&gt;smoketex[0].ystart, col);
-			va-&gt;AddVertexTC(pos1+( camera-&gt;up-camera-&gt;right)*size, ph-&gt;smoketex[0].xend, ph-&gt;smoketex[0].ystart, col);
-			va-&gt;AddVertexTC(pos1+(-camera-&gt;up-camera-&gt;right)*size, ph-&gt;smoketex[0].xend, ph-&gt;smoketex[0].ystart, col);
-			va-&gt;AddVertexTC(pos1+(-camera-&gt;up+camera-&gt;right)*size, ph-&gt;smoketex[0].xstart, ph-&gt;smoketex[0].ystart, col);
+			va-&gt;AddVertexQTC(pos1+( camera-&gt;up+camera-&gt;right)*size, ph-&gt;smoketex[0].xstart, ph-&gt;smoketex[0].ystart, col);
+			va-&gt;AddVertexQTC(pos1+( camera-&gt;up-camera-&gt;right)*size, ph-&gt;smoketex[0].xend, ph-&gt;smoketex[0].ystart, col);
+			va-&gt;AddVertexQTC(pos1+(-camera-&gt;up-camera-&gt;right)*size, ph-&gt;smoketex[0].xend, ph-&gt;smoketex[0].ystart, col);
+			va-&gt;AddVertexQTC(pos1+(-camera-&gt;up+camera-&gt;right)*size, ph-&gt;smoketex[0].xstart, ph-&gt;smoketex[0].ystart, col);
 		}
 	}
 	if(drawCallbacker)

Modified: trunk/rts/Sim/Projectiles/Unsynced/SpherePartProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/Unsynced/SpherePartProjectile.cpp	2008-10-03 22:09:22 UTC (rev 6513)
+++ trunk/rts/Sim/Projectiles/Unsynced/SpherePartProjectile.cpp	2008-10-03 22:55:21 UTC (rev 6514)
@@ -72,6 +72,7 @@
 void CSpherePartProjectile::Draw(void)
 {
 	unsigned char col[4];
+	va-&gt;EnlargeArrays(4*4*4,0,VA_SIZE_TC);
 
 	float interSize=sphereSize+expansionSpeed*gu-&gt;timeOffset;
 	for(int y=0;y&lt;4;++y){
@@ -82,16 +83,16 @@
 			col[1]=(unsigned char) (color.y*255.0f*alpha);
 			col[2]=(unsigned char) (color.z*255.0f*alpha);
 			col[3]=((unsigned char) (40*alpha))+1;
-			va-&gt;AddVertexTC(centerPos+vectors[y*5+x]*interSize,texx,texy,col);
-			va-&gt;AddVertexTC(centerPos+vectors[y*5+x+1]*interSize,texx,texy,col);
+			va-&gt;AddVertexQTC(centerPos+vectors[y*5+x]*interSize,texx,texy,col);
+			va-&gt;AddVertexQTC(centerPos+vectors[y*5+x+1]*interSize,texx,texy,col);
 			alpha=baseAlpha*(1.0f-min(float(1.0f),float(age+gu-&gt;timeOffset)/(float)ttl))*(1-fabs(y+1+ybase-8.0f)/8.0f*1.0f);
 
 			col[0]=(unsigned char) (color.x*255.0f*alpha);
 			col[1]=(unsigned char) (color.y*255.0f*alpha);
 			col[2]=(unsigned char) (color.z*255.0f*alpha);
 			col[3]=((unsigned char) (40*alpha))+1;
-			va-&gt;AddVertexTC(centerPos+vectors[(y+1)*5+x+1]*interSize,texx,texy,col);
-			va-&gt;AddVertexTC(centerPos+vectors[(y+1)*5+x]*interSize,texx,texy,col);
+			va-&gt;AddVertexQTC(centerPos+vectors[(y+1)*5+x+1]*interSize,texx,texy,col);
+			va-&gt;AddVertexQTC(centerPos+vectors[(y+1)*5+x]*interSize,texx,texy,col);
 		}
 	}
 }

Modified: trunk/rts/Sim/Projectiles/WeaponProjectiles/BeamLaserProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/WeaponProjectiles/BeamLaserProjectile.cpp	2008-10-03 22:09:22 UTC (rev 6513)
+++ trunk/rts/Sim/Projectiles/WeaponProjectiles/BeamLaserProjectile.cpp	2008-10-03 22:55:21 UTC (rev 6514)
@@ -113,55 +113,55 @@
 	float3 pos1=startPos;
 	float3 pos2=endPos;
 
-
+  va-&gt;EnlargeArrays(32,0,VA_SIZE_TC);
 	if(camDist&lt;1000){
-		va-&gt;AddVertexTC(pos1-dir1*size,	midtexx,weaponDef-&gt;visuals.texture2-&gt;ystart,    kocolstart);
-		va-&gt;AddVertexTC(pos1+dir1*size,	midtexx,weaponDef-&gt;visuals.texture2-&gt;yend,kocolstart);
-		va-&gt;AddVertexTC(pos1+dir1*size-dir2*size, weaponDef-&gt;visuals.texture2-&gt;xend,weaponDef-&gt;visuals.texture2-&gt;yend,kocolstart);
-		va-&gt;AddVertexTC(pos1-dir1*size-dir2*size, weaponDef-&gt;visuals.texture2-&gt;xend,weaponDef-&gt;visuals.texture2-&gt;ystart,kocolstart);
-		va-&gt;AddVertexTC(pos1-dir1*coresize,midtexx,weaponDef-&gt;visuals.texture2-&gt;ystart,    corecolstart);
-		va-&gt;AddVertexTC(pos1+dir1*coresize,midtexx,weaponDef-&gt;visuals.texture2-&gt;yend,corecolstart);
-		va-&gt;AddVertexTC(pos1+dir1*coresize-dir2*coresize,weaponDef-&gt;visuals.texture2-&gt;xend,weaponDef-&gt;visuals.texture2-&gt;yend,corecolstart);
-		va-&gt;AddVertexTC(pos1-dir1*coresize-dir2*coresize,weaponDef-&gt;visuals.texture2-&gt;xend,weaponDef-&gt;visuals.texture2-&gt;ystart,corecolstart);
+		va-&gt;AddVertexQTC(pos1-dir1*size,	midtexx,weaponDef-&gt;visuals.texture2-&gt;ystart,    kocolstart);
+		va-&gt;AddVertexQTC(pos1+dir1*size,	midtexx,weaponDef-&gt;visuals.texture2-&gt;yend,kocolstart);
+		va-&gt;AddVertexQTC(pos1+dir1*size-dir2*size, weaponDef-&gt;visuals.texture2-&gt;xend,weaponDef-&gt;visuals.texture2-&gt;yend,kocolstart);
+		va-&gt;AddVertexQTC(pos1-dir1*size-dir2*size, weaponDef-&gt;visuals.texture2-&gt;xend,weaponDef-&gt;visuals.texture2-&gt;ystart,kocolstart);
+		va-&gt;AddVertexQTC(pos1-dir1*coresize,midtexx,weaponDef-&gt;visuals.texture2-&gt;ystart,    corecolstart);
+		va-&gt;AddVertexQTC(pos1+dir1*coresize,midtexx,weaponDef-&gt;visuals.texture2-&gt;yend,corecolstart);
+		va-&gt;AddVertexQTC(pos1+dir1*coresize-dir2*coresize,weaponDef-&gt;visuals.texture2-&gt;xend,weaponDef-&gt;visuals.texture2-&gt;yend,corecolstart);
+		va-&gt;AddVertexQTC(pos1-dir1*coresize-dir2*coresize,weaponDef-&gt;visuals.texture2-&gt;xend,weaponDef-&gt;visuals.texture2-&gt;ystart,corecolstart);
 
-		va-&gt;AddVertexTC(pos1-dir1*size,weaponDef-&gt;visuals.texture1-&gt;xstart,weaponDef-&gt;visuals.texture1-&gt;ystart,		kocolstart);
-		va-&gt;AddVertexTC(pos1+dir1*size,weaponDef-&gt;visuals.texture1-&gt;xstart,weaponDef-&gt;visuals.texture1-&gt;yend,			kocolstart);
-		va-&gt;AddVertexTC(pos2+dir1*size,weaponDef-&gt;visuals.texture1-&gt;xend,weaponDef-&gt;visuals.texture1-&gt;yend,			kocolend);
-		va-&gt;AddVertexTC(pos2-dir1*size,weaponDef-&gt;visuals.texture1-&gt;xend,weaponDef-&gt;visuals.texture1-&gt;ystart,			kocolend);
-		va-&gt;AddVertexTC(pos1-dir1*coresize,weaponDef-&gt;visuals.texture1-&gt;xstart,weaponDef-&gt;visuals.texture1-&gt;ystart,	corecolstart);
-		va-&gt;AddVertexTC(pos1+dir1*coresize,weaponDef-&gt;visuals.texture1-&gt;xstart,weaponDef-&gt;visuals.texture1-&gt;yend,	corecolstart);
-		va-&gt;AddVertexTC(pos2+dir1*coresize,weaponDef-&gt;visuals.texture1-&gt;xend,weaponDef-&gt;visuals.texture1-&gt;yend,		corecolend);
-		va-&gt;AddVertexTC(pos2-dir1*coresize,weaponDef-&gt;visuals.texture1-&gt;xend,weaponDef-&gt;visuals.texture1-&gt;ystart,		corecolend);
+		va-&gt;AddVertexQTC(pos1-dir1*size,weaponDef-&gt;visuals.texture1-&gt;xstart,weaponDef-&gt;visuals.texture1-&gt;ystart,		kocolstart);
+		va-&gt;AddVertexQTC(pos1+dir1*size,weaponDef-&gt;visuals.texture1-&gt;xstart,weaponDef-&gt;visuals.texture1-&gt;yend,			kocolstart);
+		va-&gt;AddVertexQTC(pos2+dir1*size,weaponDef-&gt;visuals.texture1-&gt;xend,weaponDef-&gt;visuals.texture1-&gt;yend,			kocolend);
+		va-&gt;AddVertexQTC(pos2-dir1*size,weaponDef-&gt;visuals.texture1-&gt;xend,weaponDef-&gt;visuals.texture1-&gt;ystart,			kocolend);
+		va-&gt;AddVertexQTC(pos1-dir1*coresize,weaponDef-&gt;visuals.texture1-&gt;xstart,weaponDef-&gt;visuals.texture1-&gt;ystart,	corecolstart);
+		va-&gt;AddVertexQTC(pos1+dir1*coresize,weaponDef-&gt;visuals.texture1-&gt;xstart,weaponDef-&gt;visuals.texture1-&gt;yend,	corecolstart);
+		va-&gt;AddVertexQTC(pos2+dir1*coresize,weaponDef-&gt;visuals.texture1-&gt;xend,weaponDef-&gt;visuals.texture1-&gt;yend,		corecolend);
+		va-&gt;AddVertexQTC(pos2-dir1*coresize,weaponDef-&gt;visuals.texture1-&gt;xend,weaponDef-&gt;visuals.texture1-&gt;ystart,		corecolend);
 
-		va-&gt;AddVertexTC(pos2-dir1*size,	midtexx,weaponDef-&gt;visuals.texture2-&gt;ystart,    kocolstart);
-		va-&gt;AddVertexTC(pos2+dir1*size,	midtexx,weaponDef-&gt;visuals.texture2-&gt;yend,kocolstart);
-		va-&gt;AddVertexTC(pos2+dir1*size+dir2*size, weaponDef-&gt;visuals.texture2-&gt;xend,weaponDef-&gt;visuals.texture2-&gt;yend,kocolstart);
-		va-&gt;AddVertexTC(pos2-dir1*size+dir2*size, weaponDef-&gt;visuals.texture2-&gt;xend,weaponDef-&gt;visuals.texture2-&gt;ystart,kocolstart);
-		va-&gt;AddVertexTC(pos2-dir1*coresize,midtexx,weaponDef-&gt;visuals.texture2-&gt;ystart,    corecolstart);
-		va-&gt;AddVertexTC(pos2+dir1*coresize,midtexx,weaponDef-&gt;visuals.texture2-&gt;yend,corecolstart);
-		va-&gt;AddVertexTC(pos2+dir1*coresize+dir2*coresize,weaponDef-&gt;visuals.texture2-&gt;xend,weaponDef-&gt;visuals.texture2-&gt;yend,corecolstart);
-		va-&gt;AddVertexTC(pos2-dir1*coresize+dir2*coresize,weaponDef-&gt;visuals.texture2-&gt;xend,weaponDef-&gt;visuals.texture2-&gt;ystart,corecolstart);
+		va-&gt;AddVertexQTC(pos2-dir1*size,	midtexx,weaponDef-&gt;visuals.texture2-&gt;ystart,    kocolstart);
+		va-&gt;AddVertexQTC(pos2+dir1*size,	midtexx,weaponDef-&gt;visuals.texture2-&gt;yend,kocolstart);
+		va-&gt;AddVertexQTC(pos2+dir1*size+dir2*size, weaponDef-&gt;visuals.texture2-&gt;xend,weaponDef-&gt;visuals.texture2-&gt;yend,kocolstart);
+		va-&gt;AddVertexQTC(pos2-dir1*size+dir2*size, weaponDef-&gt;visuals.texture2-&gt;xend,weaponDef-&gt;visuals.texture2-&gt;ystart,kocolstart);
+		va-&gt;AddVertexQTC(pos2-dir1*coresize,midtexx,weaponDef-&gt;visuals.texture2-&gt;ystart,    corecolstart);
+		va-&gt;AddVertexQTC(pos2+dir1*coresize,midtexx,weaponDef-&gt;visuals.texture2-&gt;yend,corecolstart);
+		va-&gt;AddVertexQTC(pos2+dir1*coresize+dir2*coresize,weaponDef-&gt;visuals.texture2-&gt;xend,weaponDef-&gt;visuals.texture2-&gt;yend,corecolstart);
+		va-&gt;AddVertexQTC(pos2-dir1*coresize+dir2*coresize,weaponDef-&gt;visuals.texture2-&gt;xend,weaponDef-&gt;visuals.texture2-&gt;ystart,corecolstart);
 	} else {
-		va-&gt;AddVertexTC(pos1-dir1*size,weaponDef-&gt;visuals.texture1-&gt;xstart,weaponDef-&gt;visuals.texture1-&gt;ystart,		kocolstart);
-		va-&gt;AddVertexTC(pos1+dir1*size,weaponDef-&gt;visuals.texture1-&gt;xstart,weaponDef-&gt;visuals.texture1-&gt;yend,			kocolstart);
-		va-&gt;AddVertexTC(pos2+dir1*size,weaponDef-&gt;visuals.texture1-&gt;xend,weaponDef-&gt;visuals.texture1-&gt;yend,			kocolend);
-		va-&gt;AddVertexTC(pos2-dir1*size,weaponDef-&gt;visuals.texture1-&gt;xend,weaponDef-&gt;visuals.texture1-&gt;ystart,			kocolend);
-		va-&gt;AddVertexTC(pos1-dir1*coresize,weaponDef-&gt;visuals.texture1-&gt;xstart,weaponDef-&gt;visuals.texture1-&gt;ystart,	corecolstart);
-		va-&gt;AddVertexTC(pos1+dir1*coresize,weaponDef-&gt;visuals.texture1-&gt;xstart,weaponDef-&gt;visuals.texture1-&gt;yend,	corecolstart);
-		va-&gt;AddVertexTC(pos2+dir1*coresize,weaponDef-&gt;visuals.texture1-&gt;xend,weaponDef-&gt;visuals.texture1-&gt;yend,		corecolend);
-		va-&gt;AddVertexTC(pos2-dir1*coresize,weaponDef-&gt;visuals.texture1-&gt;xend,weaponDef-&gt;visuals.texture1-&gt;ystart,		corecolend);
+		va-&gt;AddVertexQTC(pos1-dir1*size,weaponDef-&gt;visuals.texture1-&gt;xstart,weaponDef-&gt;visuals.texture1-&gt;ystart,		kocolstart);
+		va-&gt;AddVertexQTC(pos1+dir1*size,weaponDef-&gt;visuals.texture1-&gt;xstart,weaponDef-&gt;visuals.texture1-&gt;yend,			kocolstart);
+		va-&gt;AddVertexQTC(pos2+dir1*size,weaponDef-&gt;visuals.texture1-&gt;xend,weaponDef-&gt;visuals.texture1-&gt;yend,			kocolend);
+		va-&gt;AddVertexQTC(pos2-dir1*size,weaponDef-&gt;visuals.texture1-&gt;xend,weaponDef-&gt;visuals.texture1-&gt;ystart,			kocolend);
+		va-&gt;AddVertexQTC(pos1-dir1*coresize,weaponDef-&gt;visuals.texture1-&gt;xstart,weaponDef-&gt;visuals.texture1-&gt;ystart,	corecolstart);
+		va-&gt;AddVertexQTC(pos1+dir1*coresize,weaponDef-&gt;visuals.texture1-&gt;xstart,weaponDef-&gt;visuals.texture1-&gt;yend,	corecolstart);
+		va-&gt;AddVertexQTC(pos2+dir1*coresize,weaponDef-&gt;visuals.texture1-&gt;xend,weaponDef-&gt;visuals.texture1-&gt;yend,		corecolend);
+		va-&gt;AddVertexQTC(pos2-dir1*coresize,weaponDef-&gt;visuals.texture1-&gt;xend,weaponDef-&gt;visuals.texture1-&gt;ystart,		corecolend);
 	}
 
 	//draw flare
 	float fsize = size*flaresize;
-	va-&gt;AddVertexTC(pos1-camera-&gt;right*fsize-camera-&gt;up*fsize,weaponDef-&gt;visuals.texture3-&gt;xstart,weaponDef-&gt;visuals.texture3-&gt;ystart,kocolstart);
-	va-&gt;AddVertexTC(pos1+camera-&gt;right*fsize-camera-&gt;up*fsize,weaponDef-&gt;visuals.texture3-&gt;xend,weaponDef-&gt;visuals.texture3-&gt;ystart,kocolstart);
-	va-&gt;AddVertexTC(pos1+camera-&gt;right*fsize+camera-&gt;up*fsize,weaponDef-&gt;visuals.texture3-&gt;xend,weaponDef-&gt;visuals.texture3-&gt;yend,kocolstart);
-	va-&gt;AddVertexTC(pos1-camera-&gt;right*fsize+camera-&gt;up*fsize,weaponDef-&gt;visuals.texture3-&gt;xstart,weaponDef-&gt;visuals.texture3-&gt;yend,kocolstart);
+	va-&gt;AddVertexQTC(pos1-camera-&gt;right*fsize-camera-&gt;up*fsize,weaponDef-&gt;visuals.texture3-&gt;xstart,weaponDef-&gt;visuals.texture3-&gt;ystart,kocolstart);
+	va-&gt;AddVertexQTC(pos1+camera-&gt;right*fsize-camera-&gt;up*fsize,weaponDef-&gt;visuals.texture3-&gt;xend,weaponDef-&gt;visuals.texture3-&gt;ystart,kocolstart);
+	va-&gt;AddVertexQTC(pos1+camera-&gt;right*fsize+camera-&gt;up*fsize,weaponDef-&gt;visuals.texture3-&gt;xend,weaponDef-&gt;visuals.texture3-&gt;yend,kocolstart);
+	va-&gt;AddVertexQTC(pos1-camera-&gt;right*fsize+camera-&gt;up*fsize,weaponDef-&gt;visuals.texture3-&gt;xstart,weaponDef-&gt;visuals.texture3-&gt;yend,kocolstart);
 
 	fsize = fsize*corethickness;
-	va-&gt;AddVertexTC(pos1-camera-&gt;right*fsize-camera-&gt;up*fsize,weaponDef-&gt;visuals.texture3-&gt;xstart,weaponDef-&gt;visuals.texture3-&gt;ystart,corecolstart);
-	va-&gt;AddVertexTC(pos1+camera-&gt;right*fsize-camera-&gt;up*fsize,weaponDef-&gt;visuals.texture3-&gt;xend,weaponDef-&gt;visuals.texture3-&gt;ystart,corecolstart);
-	va-&gt;AddVertexTC(pos1+camera-&gt;right*fsize+camera-&gt;up*fsize,weaponDef-&gt;visuals.texture3-&gt;xend,weaponDef-&gt;visuals.texture3-&gt;yend,corecolstart);
-	va-&gt;AddVertexTC(pos1-camera-&gt;right*fsize+camera-&gt;up*fsize,weaponDef-&gt;visuals.texture3-&gt;xstart,weaponDef-&gt;visuals.texture3-&gt;yend,corecolstart);
+	va-&gt;AddVertexQTC(pos1-camera-&gt;right*fsize-camera-&gt;up*fsize,weaponDef-&gt;visuals.texture3-&gt;xstart,weaponDef-&gt;visuals.texture3-&gt;ystart,corecolstart);
+	va-&gt;AddVertexQTC(pos1+camera-&gt;right*fsize-camera-&gt;up*fsize,weaponDef-&gt;visuals.texture3-&gt;xend,weaponDef-&gt;visuals.texture3-&gt;ystart,corecolstart);
+	va-&gt;AddVertexQTC(pos1+camera-&gt;right*fsize+camera-&gt;up*fsize,weaponDef-&gt;visuals.texture3-&gt;xend,weaponDef-&gt;visuals.texture3-&gt;yend,corecolstart);
+	va-&gt;AddVertexQTC(pos1-camera-&gt;right*fsize+camera-&gt;up*fsize,weaponDef-&gt;visuals.texture3-&gt;xstart,weaponDef-&gt;visuals.texture3-&gt;yend,corecolstart);
 }

Modified: trunk/rts/Sim/Projectiles/WeaponProjectiles/ExplosiveProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/WeaponProjectiles/ExplosiveProjectile.cpp	2008-10-03 22:09:22 UTC (rev 6513)
+++ trunk/rts/Sim/Projectiles/WeaponProjectiles/ExplosiveProjectile.cpp	2008-10-03 22:55:21 UTC (rev 6514)
@@ -144,7 +144,8 @@
 	dir.Normalize();
 	dir *= separation * 0.6f;
 
-	for (int a = 0; a &lt; stages; ++a) {
+	va-&gt;EnlargeArrays(stages*4,0,VA_SIZE_TC);
+	for (int a = 0; a &lt; stages; ++a) { //! CAUTION: loop count must match EnlargeArrays above
 		const float aDecay = (stages - (a * alphaDecay)) * invStages;
 		col[0] = int(aDecay * col[0]);
 		col[1] = int(aDecay * col[1]);
@@ -156,10 +157,10 @@
 		const float3 right = camera-&gt;right * size;
 		const float3 interPos2 = interPos - ((noGap)?(dir * size * a):(dir * drawRadius * a));
 
-		va-&gt;AddVertexTC(interPos2 - right - up, tex-&gt;xstart, tex-&gt;ystart, col);
-		va-&gt;AddVertexTC(interPos2 + right - up, tex-&gt;xend,   tex-&gt;ystart, col);
-		va-&gt;AddVertexTC(interPos2 + right + up, tex-&gt;xend,   tex-&gt;yend,   col);
-		va-&gt;AddVertexTC(interPos2 - right + up, tex-&gt;xstart, tex-&gt;yend,   col);
+		va-&gt;AddVertexQTC(interPos2 - right - up, tex-&gt;xstart, tex-&gt;ystart, col);
+		va-&gt;AddVertexQTC(interPos2 + right - up, tex-&gt;xend,   tex-&gt;ystart, col);
+		va-&gt;AddVertexQTC(interPos2 + right + up, tex-&gt;xend,   tex-&gt;yend,   col);
+		va-&gt;AddVertexQTC(interPos2 - right + up, tex-&gt;xstart, tex-&gt;yend,   col);
 	}
 }
 

Modified: trunk/rts/Sim/Projectiles/WeaponProjectiles/FireBallProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/WeaponProjectiles/FireBallProjectile.cpp	2008-10-03 22:09:22 UTC (rev 6513)
+++ trunk/rts/Sim/Projectiles/WeaponProjectiles/FireBallProjectile.cpp	2008-10-03 22:55:21 UTC (rev 6514)
@@ -55,30 +55,31 @@
 	float size = radius*1.3f;
 
 	int numSparks=sparks.size();
-	for(int i=0; i&lt;numSparks; i++)
+	int numFire=std::min(10,numSparks);
+	va-&gt;EnlargeArrays((numSparks+numFire)*4,0,VA_SIZE_TC);
+	for(int i=0; i&lt;numSparks; i++) //! CAUTION: loop count must match EnlargeArrays above
 	{
 		col[0]=(numSparks-i)*12;
 		col[1]=(numSparks-i)*6;
 		col[2]=(numSparks-i)*4;
-		va-&gt;AddVertexTC(sparks[i].pos-camera-&gt;right*sparks[i].size-camera-&gt;up*sparks[i].size,ph-&gt;explotex.xstart,ph-&gt;explotex.ystart,col);
-		va-&gt;AddVertexTC(sparks[i].pos+camera-&gt;right*sparks[i].size-camera-&gt;up*sparks[i].size,ph-&gt;explotex.xend ,ph-&gt;explotex.ystart,col);
-		va-&gt;AddVertexTC(sparks[i].pos+camera-&gt;right*sparks[i].size+camera-&gt;up*sparks[i].size,ph-&gt;explotex.xend ,ph-&gt;explotex.yend ,col);
-		va-&gt;AddVertexTC(sparks[i].pos-camera-&gt;right*sparks[i].size+camera-&gt;up*sparks[i].size,ph-&gt;explotex.xstart,ph-&gt;explotex.yend ,col);
+		va-&gt;AddVertexQTC(sparks[i].pos-camera-&gt;right*sparks[i].size-camera-&gt;up*sparks[i].size,ph-&gt;explotex.xstart,ph-&gt;explotex.ystart,col);
+		va-&gt;AddVertexQTC(sparks[i].pos+camera-&gt;right*sparks[i].size-camera-&gt;up*sparks[i].size,ph-&gt;explotex.xend ,ph-&gt;explotex.ystart,col);
+		va-&gt;AddVertexQTC(sparks[i].pos+camera-&gt;right*sparks[i].size+camera-&gt;up*sparks[i].size,ph-&gt;explotex.xend ,ph-&gt;explotex.yend ,col);
+		va-&gt;AddVertexQTC(sparks[i].pos-camera-&gt;right*sparks[i].size+camera-&gt;up*sparks[i].size,ph-&gt;explotex.xstart,ph-&gt;explotex.yend ,col);
 	}
 
-	int numFire=std::min(10,numSparks);
 	int maxCol=numFire;
 	if(checkCol)
 		maxCol=10;
-	for(int i=0; i&lt;numFire; i++)
+	for(int i=0; i&lt;numFire; i++) //! CAUTION: loop count must match EnlargeArrays above
 	{
 		col[0]=(maxCol-i)*25;
 		col[1]=(maxCol-i)*15;
 		col[2]=(maxCol-i)*10;
-		va-&gt;AddVertexTC(interPos-camera-&gt;right*size-camera-&gt;up*size,ph-&gt;dguntex.xstart ,ph-&gt;dguntex.ystart ,col);
-		va-&gt;AddVertexTC(interPos+camera-&gt;right*size-camera-&gt;up*size,ph-&gt;dguntex.xend ,ph-&gt;dguntex.ystart ,col);
-		va-&gt;AddVertexTC(interPos+camera-&gt;right*size+camera-&gt;up*size,ph-&gt;dguntex.xend ,ph-&gt;dguntex.yend ,col);
-		va-&gt;AddVertexTC(interPos-camera-&gt;right*size+camera-&gt;up*size,ph-&gt;dguntex.xstart ,ph-&gt;dguntex.yend ,col);
+		va-&gt;AddVertexQTC(interPos-camera-&gt;right*size-camera-&gt;up*size,ph-&gt;dguntex.xstart ,ph-&gt;dguntex.ystart ,col);
+		va-&gt;AddVertexQTC(interPos+camera-&gt;right*size-camera-&gt;up*size,ph-&gt;dguntex.xend ,ph-&gt;dguntex.ystart ,col);
+		va-&gt;AddVertexQTC(interPos+camera-&gt;right*size+camera-&gt;up*size,ph-&gt;dguntex.xend ,ph-&gt;dguntex.yend ,col);
+		va-&gt;AddVertexQTC(interPos-camera-&gt;right*size+camera-&gt;up*size,ph-&gt;dguntex.xstart ,ph-&gt;dguntex.yend ,col);
 		interPos = interPos-speed*0.5f;
 	}
 }

Modified: trunk/rts/Sim/Projectiles/WeaponProjectiles/LargeBeamLaserProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/WeaponProjectiles/LargeBeamLaserProjectile.cpp	2008-10-03 22:09:22 UTC (rev 6513)
+++ trunk/rts/Sim/Projectiles/WeaponProjectiles/LargeBeamLaserProjectile.cpp	2008-10-03 22:55:21 UTC (rev 6514)
@@ -138,55 +138,57 @@
 
 	float polylength = (tex.xend-beamtex.xstart)*(1/texxsize)*tilelength;
 
-
-	if(polylength*(1-starttex)&gt;beamlength)  //beam short enough to be drawn by one polygon
+	float istart=polylength*(1-starttex);
+	float iend=beamlength-tilelength;
+  va-&gt;EnlargeArrays(64+8*((int)((iend-istart)/tilelength)+2),0,VA_SIZE_TC);
+	if(istart&gt;beamlength)  //beam short enough to be drawn by one polygon
 	{
 		pos2=endPos;
 
 		//draw laser start
 		tex.xstart = beamtex.xstart + starttex*((beamtex.xend-beamtex.xstart));
 
-		va-&gt;AddVertexTC(pos1-dir1*size,tex.xstart,tex.ystart,		kocolstart);
-		va-&gt;AddVertexTC(pos1+dir1*size,tex.xstart,tex.yend,			kocolstart);
-		va-&gt;AddVertexTC(pos2+dir1*size,tex.xend,tex.yend,			kocolstart);
-		va-&gt;AddVertexTC(pos2-dir1*size,tex.xend,tex.ystart,			kocolstart);
-		va-&gt;AddVertexTC(pos1-dir1*coresize,tex.xstart,tex.ystart,	corecolstart);
-		va-&gt;AddVertexTC(pos1+dir1*coresize,tex.xstart,tex.yend,	corecolstart);
-		va-&gt;AddVertexTC(pos2+dir1*coresize,tex.xend,tex.yend,		corecolstart);
-		va-&gt;AddVertexTC(pos2-dir1*coresize,tex.xend,tex.ystart,		corecolstart);
+		va-&gt;AddVertexQTC(pos1-dir1*size,tex.xstart,tex.ystart,		kocolstart);
+		va-&gt;AddVertexQTC(pos1+dir1*size,tex.xstart,tex.yend,			kocolstart);
+		va-&gt;AddVertexQTC(pos2+dir1*size,tex.xend,tex.yend,			kocolstart);
+		va-&gt;AddVertexQTC(pos2-dir1*size,tex.xend,tex.ystart,			kocolstart);
+		va-&gt;AddVertexQTC(pos1-dir1*coresize,tex.xstart,tex.ystart,	corecolstart);
+		va-&gt;AddVertexQTC(pos1+dir1*coresize,tex.xstart,tex.yend,	corecolstart);
+		va-&gt;AddVertexQTC(pos2+dir1*coresize,tex.xend,tex.yend,		corecolstart);
+		va-&gt;AddVertexQTC(pos2-dir1*coresize,tex.xend,tex.ystart,		corecolstart);
 	}
 	else  //beam longer than one polygon
 	{
-		pos2=pos1+dir*polylength*(1-starttex);
+		pos2=pos1+dir*istart;
 
 		//draw laser start
 		tex.xstart = beamtex.xstart + starttex*((beamtex.xend-beamtex.xstart));
 
-		va-&gt;AddVertexTC(pos1-dir1*size,tex.xstart,tex.ystart,		kocolstart);
-		va-&gt;AddVertexTC(pos1+dir1*size,tex.xstart,tex.yend,			kocolstart);
-		va-&gt;AddVertexTC(pos2+dir1*size,tex.xend,tex.yend,			kocolstart);
-		va-&gt;AddVertexTC(pos2-dir1*size,tex.xend,tex.ystart,			kocolstart);
-		va-&gt;AddVertexTC(pos1-dir1*coresize,tex.xstart,tex.ystart,	corecolstart);
-		va-&gt;AddVertexTC(pos1+dir1*coresize,tex.xstart,tex.yend,	corecolstart);
-		va-&gt;AddVertexTC(pos2+dir1*coresize,tex.xend,tex.yend,		corecolstart);
-		va-&gt;AddVertexTC(pos2-dir1*coresize,tex.xend,tex.ystart,		corecolstart);
+		va-&gt;AddVertexQTC(pos1-dir1*size,tex.xstart,tex.ystart,		kocolstart);
+		va-&gt;AddVertexQTC(pos1+dir1*size,tex.xstart,tex.yend,			kocolstart);
+		va-&gt;AddVertexQTC(pos2+dir1*size,tex.xend,tex.yend,			kocolstart);
+		va-&gt;AddVertexQTC(pos2-dir1*size,tex.xend,tex.ystart,			kocolstart);
+		va-&gt;AddVertexQTC(pos1-dir1*coresize,tex.xstart,tex.ystart,	corecolstart);
+		va-&gt;AddVertexQTC(pos1+dir1*coresize,tex.xstart,tex.yend,	corecolstart);
+		va-&gt;AddVertexQTC(pos2+dir1*coresize,tex.xend,tex.yend,		corecolstart);
+		va-&gt;AddVertexQTC(pos2-dir1*coresize,tex.xend,tex.ystart,		corecolstart);
 
 		//draw continous beam
 		tex.xstart = beamtex.xstart;
 		float i;
-		for(i=polylength*(1-starttex); i&lt;beamlength-tilelength; i+=tilelength)
+		for(i=istart; i&lt;iend; i+=tilelength) //! CAUTION: loop count must match EnlargeArrays above
 		{
 			pos1=startPos+dir*i;
 			pos2=startPos+dir*(i+tilelength);
 
-			va-&gt;AddVertexTC(pos1-dir1*size,tex.xstart,tex.ystart,		kocolstart);
-			va-&gt;AddVertexTC(pos1+dir1*size,tex.xstart,tex.yend,			kocolstart);
-			va-&gt;AddVertexTC(pos2+dir1*size,tex.xend,tex.yend,			kocolstart);
-			va-&gt;AddVertexTC(pos2-dir1*size,tex.xend,tex.ystart,			kocolstart);
-			va-&gt;AddVertexTC(pos1-dir1*coresize,tex.xstart,tex.ystart,	corecolstart);
-			va-&gt;AddVertexTC(pos1+dir1*coresize,tex.xstart,tex.yend,	corecolstart);
-			va-&gt;AddVertexTC(pos2+dir1*coresize,tex.xend,tex.yend,		corecolstart);
-			va-&gt;AddVertexTC(pos2-dir1*coresize,tex.xend,tex.ystart,		corecolstart);
+			va-&gt;AddVertexQTC(pos1-dir1*size,tex.xstart,tex.ystart,		kocolstart);
+			va-&gt;AddVertexQTC(pos1+dir1*size,tex.xstart,tex.yend,			kocolstart);
+			va-&gt;AddVertexQTC(pos2+dir1*size,tex.xend,tex.yend,			kocolstart);
+			va-&gt;AddVertexQTC(pos2-dir1*size,tex.xend,tex.ystart,			kocolstart);
+			va-&gt;AddVertexQTC(pos1-dir1*coresize,tex.xstart,tex.ystart,	corecolstart);
+			va-&gt;AddVertexQTC(pos1+dir1*coresize,tex.xstart,tex.yend,	corecolstart);
+			va-&gt;AddVertexQTC(pos2+dir1*coresize,tex.xend,tex.yend,		corecolstart);
+			va-&gt;AddVertexQTC(pos2-dir1*coresize,tex.xend,tex.ystart,		corecolstart);
 
 		}
 
@@ -194,25 +196,25 @@
 		pos1=startPos+dir*i;
 		pos2=endPos;
 		tex.xend = tex.xstart + ((pos2-pos1).Length()/tilelength)*texxsize;
-		va-&gt;AddVertexTC(pos1-dir1*size,tex.xstart,tex.ystart,		kocolstart);
-		va-&gt;AddVertexTC(pos1+dir1*size,tex.xstart,tex.yend,			kocolstart);
-		va-&gt;AddVertexTC(pos2+dir1*size,tex.xend,tex.yend,			kocolstart);
-		va-&gt;AddVertexTC(pos2-dir1*size,tex.xend,tex.ystart,			kocolstart);
-		va-&gt;AddVertexTC(pos1-dir1*coresize,tex.xstart,tex.ystart,	corecolstart);
-		va-&gt;AddVertexTC(pos1+dir1*coresize,tex.xstart,tex.yend,	corecolstart);
-		va-&gt;AddVertexTC(pos2+dir1*coresize,tex.xend,tex.yend,		corecolstart);
-		va-&gt;AddVertexTC(pos2-dir1*coresize,tex.xend,tex.ystart,		corecolstart);
+		va-&gt;AddVertexQTC(pos1-dir1*size,tex.xstart,tex.ystart,		kocolstart);
+		va-&gt;AddVertexQTC(pos1+dir1*size,tex.xstart,tex.yend,			kocolstart);
+		va-&gt;AddVertexQTC(pos2+dir1*size,tex.xend,tex.yend,			kocolstart);
+		va-&gt;AddVertexQTC(pos2-dir1*size,tex.xend,tex.ystart,			kocolstart);
+		va-&gt;AddVertexQTC(pos1-dir1*coresize,tex.xstart,tex.ystart,	corecolstart);
+		va-&gt;AddVertexQTC(pos1+dir1*coresize,tex.xstart,tex.yend,	corecolstart);
+		va-&gt;AddVertexQTC(pos2+dir1*coresize,tex.xend,tex.yend,		corecolstart);
+		va-&gt;AddVertexQTC(pos2-dir1*coresize,tex.xend,tex.ystart,		corecolstart);
 	}
 
 	//float 	midtexx = weaponDef-&gt;visuals.texture2-&gt;xstart + (weaponDef-&gt;visuals.texture2-&gt;xend-weaponDef-&gt;visuals.texture2-&gt;xstart)*0.5f;
-	va-&gt;AddVertexTC(pos2-dir1*size,	weaponDef-&gt;visuals.texture2-&gt;xstart,weaponDef-&gt;visuals.texture2-&gt;ystart,    kocolstart);
-	va-&gt;AddVertexTC(pos2+dir1*size,	weaponDef-&gt;visuals.texture2-&gt;xstart,weaponDef-&gt;visuals.texture2-&gt;yend,kocolstart);
-	va-&gt;AddVertexTC(pos2+dir1*size+dir2*size, weaponDef-&gt;visuals.texture2-&gt;xend,weaponDef-&gt;visuals.texture2-&gt;yend,kocolstart);
-	va-&gt;AddVertexTC(pos2-dir1*size+dir2*size, weaponDef-&gt;visuals.texture2-&gt;xend,weaponDef-&gt;visuals.texture2-&gt;ystart,kocolstart);
-	va-&gt;AddVertexTC(pos2-dir1*coresize,weaponDef-&gt;visuals.texture2-&gt;xstart,weaponDef-&gt;visuals.texture2-&gt;ystart,    corecolstart);
-	va-&gt;AddVertexTC(pos2+dir1*coresize,weaponDef-&gt;visuals.texture2-&gt;xstart,weaponDef-&gt;visuals.texture2-&gt;yend,corecolstart);
-	va-&gt;AddVertexTC(pos2+dir1*coresize+dir2*coresize,weaponDef-&gt;visuals.texture2-&gt;xend,weaponDef-&gt;visuals.texture2-&gt;yend,corecolstart);
-	va-&gt;AddVertexTC(pos2-dir1*coresize+dir2*coresize,weaponDef-&gt;visuals.texture2-&gt;xend,weaponDef-&gt;visuals.texture2-&gt;ystart,corecolstart);
+	va-&gt;AddVertexQTC(pos2-dir1*size,	weaponDef-&gt;visuals.texture2-&gt;xstart,weaponDef-&gt;visuals.texture2-&gt;ystart,    kocolstart);
+	va-&gt;AddVertexQTC(pos2+dir1*size,	weaponDef-&gt;visuals.texture2-&gt;xstart,weaponDef-&gt;visuals.texture2-&gt;yend,kocolstart);
+	va-&gt;AddVertexQTC(pos2+dir1*size+dir2*size, weaponDef-&gt;visuals.texture2-&gt;xend,weaponDef-&gt;visuals.texture2-&gt;yend,kocolstart);
+	va-&gt;AddVertexQTC(pos2-dir1*size+dir2*size, weaponDef-&gt;visuals.texture2-&gt;xend,weaponDef-&gt;visuals.texture2-&gt;ystart,kocolstart);
+	va-&gt;AddVertexQTC(pos2-dir1*coresize,weaponDef-&gt;visuals.texture2-&gt;xstart,weaponDef-&gt;visuals.texture2-&gt;ystart,    corecolstart);
+	va-&gt;AddVertexQTC(pos2+dir1*coresize,weaponDef-&gt;visuals.texture2-&gt;xstart,weaponDef-&gt;visuals.texture2-&gt;yend,corecolstart);
+	va-&gt;AddVertexQTC(pos2+dir1*coresize+dir2*coresize,weaponDef-&gt;visuals.texture2-&gt;xend,weaponDef-&gt;visuals.texture2-&gt;yend,corecolstart);
+	va-&gt;AddVertexQTC(pos2-dir1*coresize+dir2*coresize,weaponDef-&gt;visuals.texture2-&gt;xend,weaponDef-&gt;visuals.texture2-&gt;ystart,corecolstart);
 
 	//for(float bpos=0; bpos
 	//CTextureAtlas::Texture side = ph-&gt;textureAtlas-&gt;GetTexture(&quot;muzzleside&quot;);
@@ -234,15 +236,15 @@
 
 		pos1 = startPos-dir*(size*flaresize)*0.02f;
 
-		va-&gt;AddVertexTC(pos1+dir1*muzzlesize,side.xstart,side.ystart,kocol);
-		va-&gt;AddVertexTC(pos1+dir1*muzzlesize+dir*muzzlesize,side.xend,side.ystart,kocol);
-		va-&gt;AddVertexTC(pos1-dir1*muzzlesize+dir*muzzlesize,side.xend,side.yend,kocol);
-		va-&gt;AddVertexTC(pos1-dir1*muzzlesize,side.xstart,side.yend,kocol);
+		va-&gt;AddVertexQTC(pos1+dir1*muzzlesize,side.xstart,side.ystart,kocol);
+		va-&gt;AddVertexQTC(pos1+dir1*muzzlesize+dir*muzzlesize,side.xend,side.ystart,kocol);
+		va-&gt;AddVertexQTC(pos1-dir1*muzzlesize+dir*muzzlesize,side.xend,side.yend,kocol);
+		va-&gt;AddVertexQTC(pos1-dir1*muzzlesize,side.xstart,side.yend,kocol);
 		muzzlesize = muzzlesize*0.6f;
-		va-&gt;AddVertexTC(pos1+dir1*muzzlesize,side.xstart,side.ystart,corcol);
-		va-&gt;AddVertexTC(pos1+dir1*muzzlesize+dir*muzzlesize,side.xend,side.ystart,corcol);
-		va-&gt;AddVertexTC(pos1-dir1*muzzlesize+dir*muzzlesize,side.xend,side.yend,corcol);
-		va-&gt;AddVertexTC(pos1-dir1*muzzlesize,side.xstart,side.yend,corcol);
+		va-&gt;AddVertexQTC(pos1+dir1*muzzlesize,side.xstart,side.ystart,corcol);
+		va-&gt;AddVertexQTC(pos1+dir1*muzzlesize+dir*muzzlesize,side.xend,side.ystart,corcol);
+		va-&gt;AddVertexQTC(pos1-dir1*muzzlesize+dir*muzzlesize,side.xend,side.yend,corcol);
+		va-&gt;AddVertexQTC(pos1-dir1*muzzlesize,side.xstart,side.yend,corcol);
 
 		starttex+=0.5f;
 		if(starttex&gt;1)
@@ -253,15 +255,15 @@
 			kocol[i] = int(kocolstart[i]*(1-starttex));
 		}
 		muzzlesize = size*flaresize*starttex;
-		va-&gt;AddVertexTC(pos1+dir1*muzzlesize,side.xstart,side.ystart,kocol);
-		va-&gt;AddVertexTC(pos1+dir1*muzzlesize+dir*muzzlesize,side.xend,side.ystart,kocol);
-		va-&gt;AddVertexTC(pos1-dir1*muzzlesize+dir*muzzlesize,side.xend,side.yend,kocol);
-		va-&gt;AddVertexTC(pos1-dir1*muzzlesize,side.xstart,side.yend,kocol);
+		va-&gt;AddVertexQTC(pos1+dir1*muzzlesize,side.xstart,side.ystart,kocol);
+		va-&gt;AddVertexQTC(pos1+dir1*muzzlesize+dir*muzzlesize,side.xend,side.ystart,kocol);
+		va-&gt;AddVertexQTC(pos1-dir1*muzzlesize+dir*muzzlesize,side.xend,side.yend,kocol);
+		va-&gt;AddVertexQTC(pos1-dir1*muzzlesize,side.xstart,side.yend,kocol);
 		muzzlesize = muzzlesize*0.6f;
-		va-&gt;AddVertexTC(pos1+dir1*muzzlesize,side.xstart,side.ystart,corcol);
-		va-&gt;AddVertexTC(pos1+dir1*muzzlesize+dir*muzzlesize,side.xend,side.ystart,corcol);
-		va-&gt;AddVertexTC(pos1-dir1*muzzlesize+dir*muzzlesize,side.xend,side.yend,corcol);
-		va-&gt;AddVertexTC(pos1-dir1*muzzlesize,side.xstart,side.yend,corcol);
+		va-&gt;AddVertexQTC(pos1+dir1*muzzlesize,side.xstart,side.ystart,corcol);
+		va-&gt;AddVertexQTC(pos1+dir1*muzzlesize+dir*muzzlesize,side.xend,side.ystart,corcol);
+		va-&gt;AddVertexQTC(pos1-dir1*muzzlesize+dir*muzzlesize,side.xend,side.yend,corcol);
+		va-&gt;AddVertexQTC(pos1-dir1*muzzlesize,side.xstart,side.yend,corcol);
 
 
 	//CTextureAtlas::Texture texture = ph-&gt;textureAtlas-&gt;GetTexture(&quot;largebeam&quot;);
@@ -269,15 +271,15 @@
 	//draw flare
 	float fsize = size*flaresize;
 	pos1 = startPos - camera-&gt;forward*3;//move flare slightly in camera direction
-	va-&gt;AddVertexTC(pos1-camera-&gt;right*fsize-camera-&gt;up*fsize,weaponDef-&gt;visuals.texture4-&gt;xstart,weaponDef-&gt;visuals.texture4-&gt;ystart,kocolstart);
-	va-&gt;AddVertexTC(pos1+camera-&gt;right*fsize-camera-&gt;up*fsize,weaponDef-&gt;visuals.texture4-&gt;xend,weaponDef-&gt;visuals.texture4-&gt;ystart,kocolstart);
-	va-&gt;AddVertexTC(pos1+camera-&gt;right*fsize+camera-&gt;up*fsize,weaponDef-&gt;visuals.texture4-&gt;xend,weaponDef-&gt;visuals.texture4-&gt;yend,kocolstart);
-	va-&gt;AddVertexTC(pos1-camera-&gt;right*fsize+camera-&gt;up*fsize,weaponDef-&gt;visuals.texture4-&gt;xstart,weaponDef-&gt;visuals.texture4-&gt;yend,kocolstart);
+	va-&gt;AddVertexQTC(pos1-camera-&gt;right*fsize-camera-&gt;up*fsize,weaponDef-&gt;visuals.texture4-&gt;xstart,weaponDef-&gt;visuals.texture4-&gt;ystart,kocolstart);
+	va-&gt;AddVertexQTC(pos1+camera-&gt;right*fsize-camera-&gt;up*fsize,weaponDef-&gt;visuals.texture4-&gt;xend,weaponDef-&gt;visuals.texture4-&gt;ystart,kocolstart);
+	va-&gt;AddVertexQTC(pos1+camera-&gt;right*fsize+camera-&gt;up*fsize,weaponDef-&gt;visuals.texture4-&gt;xend,weaponDef-&gt;visuals.texture4-&gt;yend,kocolstart);
+	va-&gt;AddVertexQTC(pos1-camera-&gt;right*fsize+camera-&gt;up*fsize,weaponDef-&gt;visuals.texture4-&gt;xstart,weaponDef-&gt;visuals.texture4-&gt;yend,kocolstart);
 
 	fsize = fsize*corethickness;
-	va-&gt;AddVertexTC(pos1-camera-&gt;right*fsize-camera-&gt;up*fsize,weaponDef-&gt;visuals.texture4-&gt;xstart,weaponDef-&gt;visuals.texture4-&gt;ystart,corecolstart);
-	va-&gt;AddVertexTC(pos1+camera-&gt;right*fsize-camera-&gt;up*fsize,weaponDef-&gt;visuals.texture4-&gt;xend,weaponDef-&gt;visuals.texture4-&gt;ystart,corecolstart);
-	va-&gt;AddVertexTC(pos1+camera-&gt;right*fsize+camera-&gt;up*fsize,weaponDef-&gt;visuals.texture4-&gt;xend,weaponDef-&gt;visuals.texture4-&gt;yend,corecolstart);
-	va-&gt;AddVertexTC(pos1-camera-&gt;right*fsize+camera-&gt;up*fsize,weaponDef-&gt;visuals.texture4-&gt;xstart,weaponDef-&gt;visuals.texture4-&gt;yend,corecolstart);
+	va-&gt;AddVertexQTC(pos1-camera-&gt;right*fsize-camera-&gt;up*fsize,weaponDef-&gt;visuals.texture4-&gt;xstart,weaponDef-&gt;visuals.texture4-&gt;ystart,corecolstart);
+	va-&gt;AddVertexQTC(pos1+camera-&gt;right*fsize-camera-&gt;up*fsize,weaponDef-&gt;visuals.texture4-&gt;xend,weaponDef-&gt;visuals.texture4-&gt;ystart,corecolstart);
+	va-&gt;AddVertexQTC(pos1+camera-&gt;right*fsize+camera-&gt;up*fsize,weaponDef-&gt;visuals.texture4-&gt;xend,weaponDef-&gt;visuals.texture4-&gt;yend,corecolstart);
+	va-&gt;AddVertexQTC(pos1-camera-&gt;right*fsize+camera-&gt;up*fsize,weaponDef-&gt;visuals.texture4-&gt;xstart,weaponDef-&gt;visuals.texture4-&gt;yend,corecolstart);
 
 }

Modified: trunk/rts/Sim/Projectiles/WeaponProjectiles/LaserProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/WeaponProjectiles/LaserProjectile.cpp	2008-10-03 22:09:22 UTC (rev 6513)
+++ trunk/rts/Sim/Projectiles/WeaponProjectiles/LaserProjectile.cpp	2008-10-03 22:55:21 UTC (rev 6514)
@@ -228,6 +228,7 @@
 	float size=weaponDef-&gt;thickness;
 	float coresize=size * weaponDef-&gt;corethickness;
 
+	va-&gt;EnlargeArrays(32,0,VA_SIZE_TC);
 	if(camDist&lt;weaponDef-&gt;lodDistance){
 		float3 pos1=pos+speed*gu-&gt;timeOffset;
 		float3 pos2=pos1-dir*curLength;
@@ -242,32 +243,32 @@
 			texEndOffset= ((float)stayTime * speedf/length)*(weaponDef-&gt;visuals.texture1-&gt;xstart - weaponDef-&gt;visuals.texture1-&gt;xend);
 		}
 
-		va-&gt;AddVertexTC(pos1-dir1*size,	midtexx,weaponDef-&gt;visuals.texture2-&gt;ystart,    col);
-		va-&gt;AddVertexTC(pos1+dir1*size,	midtexx,weaponDef-&gt;visuals.texture2-&gt;yend,col);
-		va-&gt;AddVertexTC(pos1+dir1*size-dir2*size, weaponDef-&gt;visuals.texture2-&gt;xstart,weaponDef-&gt;visuals.texture2-&gt;yend,col);
-		va-&gt;AddVertexTC(pos1-dir1*size-dir2*size, weaponDef-&gt;visuals.texture2-&gt;xstart,weaponDef-&gt;visuals.texture2-&gt;ystart,col);
-		va-&gt;AddVertexTC(pos1-dir1*coresize,midtexx,weaponDef-&gt;visuals.texture2-&gt;ystart,    col2);
-		va-&gt;AddVertexTC(pos1+dir1*coresize,midtexx,weaponDef-&gt;visuals.texture2-&gt;yend,col2);
-		va-&gt;AddVertexTC(pos1+dir1*coresize-dir2*coresize,weaponDef-&gt;visuals.texture2-&gt;xstart,weaponDef-&gt;visuals.texture2-&gt;yend,col2);
-		va-&gt;AddVertexTC(pos1-dir1*coresize-dir2*coresize,weaponDef-&gt;visuals.texture2-&gt;xstart,weaponDef-&gt;visuals.texture2-&gt;ystart,col2);
+		va-&gt;AddVertexQTC(pos1-dir1*size,	midtexx,weaponDef-&gt;visuals.texture2-&gt;ystart,    col);
+		va-&gt;AddVertexQTC(pos1+dir1*size,	midtexx,weaponDef-&gt;visuals.texture2-&gt;yend,col);
+		va-&gt;AddVertexQTC(pos1+dir1*size-dir2*size, weaponDef-&gt;visuals.texture2-&gt;xstart,weaponDef-&gt;visuals.texture2-&gt;yend,col);
+		va-&gt;AddVertexQTC(pos1-dir1*size-dir2*size, weaponDef-&gt;visuals.texture2-&gt;xstart,weaponDef-&gt;visuals.texture2-&gt;ystart,col);
+		va-&gt;AddVertexQTC(pos1-dir1*coresize,midtexx,weaponDef-&gt;visuals.texture2-&gt;ystart,    col2);
+		va-&gt;AddVertexQTC(pos1+dir1*coresize,midtexx,weaponDef-&gt;visuals.texture2-&gt;yend,col2);
+		va-&gt;AddVertexQTC(pos1+dir1*coresize-dir2*coresize,weaponDef-&gt;visuals.texture2-&gt;xstart,weaponDef-&gt;visuals.texture2-&gt;yend,col2);
+		va-&gt;AddVertexQTC(pos1-dir1*coresize-dir2*coresize,weaponDef-&gt;visuals.texture2-&gt;xstart,weaponDef-&gt;visuals.texture2-&gt;ystart,col2);
 
-		va-&gt;AddVertexTC(pos1-dir1*size,weaponDef-&gt;visuals.texture1-&gt;xstart + texStartOffset,weaponDef-&gt;visuals.texture1-&gt;ystart,		col);
-		va-&gt;AddVertexTC(pos1+dir1*size,weaponDef-&gt;visuals.texture1-&gt;xstart + texStartOffset,weaponDef-&gt;visuals.texture1-&gt;yend,			col);
-		va-&gt;AddVertexTC(pos2+dir1*size,weaponDef-&gt;visuals.texture1-&gt;xend + texEndOffset,weaponDef-&gt;visuals.texture1-&gt;yend,			col);
-		va-&gt;AddVertexTC(pos2-dir1*size,weaponDef-&gt;visuals.texture1-&gt;xend + texEndOffset,weaponDef-&gt;visuals.texture1-&gt;ystart,			col);
-		va-&gt;AddVertexTC(pos1-dir1*coresize,weaponDef-&gt;visuals.texture1-&gt;xstart + texStartOffset,weaponDef-&gt;visuals.texture1-&gt;ystart,	col2);
-		va-&gt;AddVertexTC(pos1+dir1*coresize,weaponDef-&gt;visuals.texture1-&gt;xstart + texStartOffset,weaponDef-&gt;visuals.texture1-&gt;yend,	col2);
-		va-&gt;AddVertexTC(pos2+dir1*coresize,weaponDef-&gt;visuals.texture1-&gt;xend + texEndOffset,weaponDef-&gt;visuals.texture1-&gt;yend,		col2);
-		va-&gt;AddVertexTC(pos2-dir1*coresize,weaponDef-&gt;visuals.texture1-&gt;xend + texEndOffset,weaponDef-&gt;visuals.texture1-&gt;ystart,		col2);
+		va-&gt;AddVertexQTC(pos1-dir1*size,weaponDef-&gt;visuals.texture1-&gt;xstart + texStartOffset,weaponDef-&gt;visuals.texture1-&gt;ystart,		col);
+		va-&gt;AddVertexQTC(pos1+dir1*size,weaponDef-&gt;visuals.texture1-&gt;xstart + texStartOffset,weaponDef-&gt;visuals.texture1-&gt;yend,			col);
+		va-&gt;AddVertexQTC(pos2+dir1*size,weaponDef-&gt;visuals.texture1-&gt;xend + texEndOffset,weaponDef-&gt;visuals.texture1-&gt;yend,			col);
+		va-&gt;AddVertexQTC(pos2-dir1*size,weaponDef-&gt;visuals.texture1-&gt;xend + texEndOffset,weaponDef-&gt;visuals.texture1-&gt;ystart,			col);
+		va-&gt;AddVertexQTC(pos1-dir1*coresize,weaponDef-&gt;visuals.texture1-&gt;xstart + texStartOffset,weaponDef-&gt;visuals.texture1-&gt;ystart,	col2);
+		va-&gt;AddVertexQTC(pos1+dir1*coresize,weaponDef-&gt;visuals.texture1-&gt;xstart + texStartOffset,weaponDef-&gt;visuals.texture1-&gt;yend,	col2);
+		va-&gt;AddVertexQTC(pos2+dir1*coresize,weaponDef-&gt;visuals.texture1-&gt;xend + texEndOffset,weaponDef-&gt;visuals.texture1-&gt;yend,		col2);
+		va-&gt;AddVertexQTC(pos2-dir1*coresize,weaponDef-&gt;visuals.texture1-&gt;xend + texEndOffset,weaponDef-&gt;visuals.texture1-&gt;ystart,		col2);
 
-		va-&gt;AddVertexTC(pos2-dir1*size,	midtexx,weaponDef-&gt;visuals.texture2-&gt;ystart,    col);
-		va-&gt;AddVertexTC(pos2+dir1*size,	midtexx,weaponDef-&gt;visuals.texture2-&gt;yend,col);
-		va-&gt;AddVertexTC(pos2+dir1*size+dir2*size, weaponDef-&gt;visuals.texture2-&gt;xend,weaponDef-&gt;visuals.texture2-&gt;yend,col);
-		va-&gt;AddVertexTC(pos2-dir1*size+dir2*size, weaponDef-&gt;visuals.texture2-&gt;xend,weaponDef-&gt;visuals.texture2-&gt;ystart,col);
-		va-&gt;AddVertexTC(pos2-dir1*coresize,midtexx,weaponDef-&gt;visuals.texture2-&gt;ystart,    col2);
-		va-&gt;AddVertexTC(pos2+dir1*coresize,midtexx,weaponDef-&gt;visuals.texture2-&gt;yend,col2);
-		va-&gt;AddVertexTC(pos2+dir1*coresize+dir2*coresize,weaponDef-&gt;visuals.texture2-&gt;xend,weaponDef-&gt;visuals.texture2-&gt;yend,col2);
-		va-&gt;AddVertexTC(pos2-dir1*coresize+dir2*coresize,weaponDef-&gt;visuals.texture2-&gt;xend,weaponDef-&gt;visuals.texture2-&gt;ystart,col2);
+		va-&gt;AddVertexQTC(pos2-dir1*size,	midtexx,weaponDef-&gt;visuals.texture2-&gt;ystart,    col);
+		va-&gt;AddVertexQTC(pos2+dir1*size,	midtexx,weaponDef-&gt;visuals.texture2-&gt;yend,col);
+		va-&gt;AddVertexQTC(pos2+dir1*size+dir2*size, weaponDef-&gt;visuals.texture2-&gt;xend,weaponDef-&gt;visuals.texture2-&gt;yend,col);
+		va-&gt;AddVertexQTC(pos2-dir1*size+dir2*size, weaponDef-&gt;visuals.texture2-&gt;xend,weaponDef-&gt;visuals.texture2-&gt;ystart,col);
+		va-&gt;AddVertexQTC(pos2-dir1*coresize,midtexx,weaponDef-&gt;visuals.texture2-&gt;ystart,    col2);
+		va-&gt;AddVertexQTC(pos2+dir1*coresize,midtexx,weaponDef-&gt;visuals.texture2-&gt;yend,col2);
+		va-&gt;AddVertexQTC(pos2+dir1*coresize+dir2*coresize,weaponDef-&gt;visuals.texture2-&gt;xend,weaponDef-&gt;visuals.texture2-&gt;yend,col2);
+		va-&gt;AddVertexQTC(pos2-dir1*coresize+dir2*coresize,weaponDef-&gt;visuals.texture2-&gt;xend,weaponDef-&gt;visuals.texture2-&gt;ystart,col2);
 	} else {
 		float3 pos1=pos+speed*gu-&gt;timeOffset+dir*(size*0.5f);
 		float3 pos2=pos1-dir*(curLength+size);
@@ -282,14 +283,14 @@
 			texEndOffset= ((float)stayTime * speedf/length)*(weaponDef-&gt;visuals.texture1-&gt;xstart - weaponDef-&gt;visuals.texture1-&gt;xend);
 		}
 
-		va-&gt;AddVertexTC(pos1-dir1*size,weaponDef-&gt;visuals.texture1-&gt;xstart + texStartOffset,weaponDef-&gt;visuals.texture1-&gt;ystart,		col);
-		va-&gt;AddVertexTC(pos1+dir1*size,weaponDef-&gt;visuals.texture1-&gt;xstart + texStartOffset,weaponDef-&gt;visuals.texture1-&gt;yend,			col);
-		va-&gt;AddVertexTC(pos2+dir1*size,weaponDef-&gt;visuals.texture1-&gt;xend + texEndOffset,weaponDef-&gt;visuals.texture1-&gt;yend,			col);
-		va-&gt;AddVertexTC(pos2-dir1*size,weaponDef-&gt;visuals.texture1-&gt;xend + texEndOffset,weaponDef-&gt;visuals.texture1-&gt;ystart,			col);
-		va-&gt;AddVertexTC(pos1-dir1*coresize,weaponDef-&gt;visuals.texture1-&gt;xstart + texStartOffset,weaponDef-&gt;visuals.texture1-&gt;ystart,	col2);
-		va-&gt;AddVertexTC(pos1+dir1*coresize,weaponDef-&gt;visuals.texture1-&gt;xstart + texStartOffset,weaponDef-&gt;visuals.texture1-&gt;yend,	col2);
-		va-&gt;AddVertexTC(pos2+dir1*coresize,weaponDef-&gt;visuals.texture1-&gt;xend + texEndOffset,weaponDef-&gt;visuals.texture1-&gt;yend,		col2);
-		va-&gt;AddVertexTC(pos2-dir1*coresize,weaponDef-&gt;visuals.texture1-&gt;xend + texEndOffset,weaponDef-&gt;visuals.texture1-&gt;ystart,		col2);
+		va-&gt;AddVertexQTC(pos1-dir1*size,weaponDef-&gt;visuals.texture1-&gt;xstart + texStartOffset,weaponDef-&gt;visuals.texture1-&gt;ystart,		col);
+		va-&gt;AddVertexQTC(pos1+dir1*size,weaponDef-&gt;visuals.texture1-&gt;xstart + texStartOffset,weaponDef-&gt;visuals.texture1-&gt;yend,			col);
+		va-&gt;AddVertexQTC(pos2+dir1*size,weaponDef-&gt;visuals.texture1-&gt;xend + texEndOffset,weaponDef-&gt;visuals.texture1-&gt;yend,			col);
+		va-&gt;AddVertexQTC(pos2-dir1*size,weaponDef-&gt;visuals.texture1-&gt;xend + texEndOffset,weaponDef-&gt;visuals.texture1-&gt;ystart,			col);
+		va-&gt;AddVertexQTC(pos1-dir1*coresize,weaponDef-&gt;visuals.texture1-&gt;xstart + texStartOffset,weaponDef-&gt;visuals.texture1-&gt;ystart,	col2);
+		va-&gt;AddVertexQTC(pos1+dir1*coresize,weaponDef-&gt;visuals.texture1-&gt;xstart + texStartOffset,weaponDef-&gt;visuals.texture1-&gt;yend,	col2);
+		va-&gt;AddVertexQTC(pos2+dir1*coresize,weaponDef-&gt;visuals.texture1-&gt;xend + texEndOffset,weaponDef-&gt;visuals.texture1-&gt;yend,		col2);
+		va-&gt;AddVertexQTC(pos2-dir1*coresize,weaponDef-&gt;visuals.texture1-&gt;xend + texEndOffset,weaponDef-&gt;visuals.texture1-&gt;ystart,		col2);
 	}
 }
 

Modified: trunk/rts/Sim/Projectiles/WeaponProjectiles/LightingProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/WeaponProjectiles/LightingProjectile.cpp	2008-10-03 22:09:22 UTC (rev 6513)
+++ trunk/rts/Sim/Projectiles/WeaponProjectiles/LightingProjectile.cpp	2008-10-03 22:55:21 UTC (rev 6514)
@@ -97,23 +97,24 @@
 	dir1.Normalize();
 	float3 tempPos=pos;
 
+	va-&gt;EnlargeArrays(18*4,0,VA_SIZE_TC);
 	for(int a=0;a&lt;9;++a){
 		float f=(a+1)*0.111f;
-		va-&gt;AddVertexTC(tempPos+dir1*(displacements[a]+weaponDef-&gt;thickness),weaponDef-&gt;visuals.texture1-&gt;xstart,weaponDef-&gt;visuals.texture1-&gt;ystart,    col);
-		va-&gt;AddVertexTC(tempPos+dir1*(displacements[a]-weaponDef-&gt;thickness),weaponDef-&gt;visuals.texture1-&gt;xstart,weaponDef-&gt;visuals.texture1-&gt;yend,col);
+		va-&gt;AddVertexQTC(tempPos+dir1*(displacements[a]+weaponDef-&gt;thickness),weaponDef-&gt;visuals.texture1-&gt;xstart,weaponDef-&gt;visuals.texture1-&gt;ystart,    col);
+		va-&gt;AddVertexQTC(tempPos+dir1*(displacements[a]-weaponDef-&gt;thickness),weaponDef-&gt;visuals.texture1-&gt;xstart,weaponDef-&gt;visuals.texture1-&gt;yend,col);
 		tempPos=pos*(1-f)+endPos*f;
-		va-&gt;AddVertexTC(tempPos+dir1*(displacements[a+1]-weaponDef-&gt;thickness),weaponDef-&gt;visuals.texture1-&gt;xend,weaponDef-&gt;visuals.texture1-&gt;yend,col);
-		va-&gt;AddVertexTC(tempPos+dir1*(displacements[a+1]+weaponDef-&gt;thickness),weaponDef-&gt;visuals.texture1-&gt;xend,weaponDef-&gt;visuals.texture1-&gt;ystart    ,col);
+		va-&gt;AddVertexQTC(tempPos+dir1*(displacements[a+1]-weaponDef-&gt;thickness),weaponDef-&gt;visuals.texture1-&gt;xend,weaponDef-&gt;visuals.texture1-&gt;yend,col);
+		va-&gt;AddVertexQTC(tempPos+dir1*(displacements[a+1]+weaponDef-&gt;thickness),weaponDef-&gt;visuals.texture1-&gt;xend,weaponDef-&gt;visuals.texture1-&gt;ystart    ,col);
 	}
 
 	tempPos=pos;
 	for(int a=0;a&lt;9;++a){
 		float f=(a+1)*0.111f;
-		va-&gt;AddVertexTC(tempPos+dir1*(displacements2[a]+weaponDef-&gt;thickness),weaponDef-&gt;visuals.texture1-&gt;xstart,weaponDef-&gt;visuals.texture1-&gt;ystart,    col);
-		va-&gt;AddVertexTC(tempPos+dir1*(displacements2[a]-weaponDef-&gt;thickness),weaponDef-&gt;visuals.texture1-&gt;xstart,weaponDef-&gt;visuals.texture1-&gt;yend,col);
+		va-&gt;AddVertexQTC(tempPos+dir1*(displacements2[a]+weaponDef-&gt;thickness),weaponDef-&gt;visuals.texture1-&gt;xstart,weaponDef-&gt;visuals.texture1-&gt;ystart,    col);
+		va-&gt;AddVertexQTC(tempPos+dir1*(displacements2[a]-weaponDef-&gt;thickness),weaponDef-&gt;visuals.texture1-&gt;xstart,weaponDef-&gt;visuals.texture1-&gt;yend,col);
 		tempPos=pos*(1-f)+endPos*f;
-		va-&gt;AddVertexTC(tempPos+dir1*(displacements2[a+1]-weaponDef-&gt;thickness),weaponDef-&gt;visuals.texture1-&gt;xend,weaponDef-&gt;visuals.texture1-&gt;yend,col);
-		va-&gt;AddVertexTC(tempPos+dir1*(displacements2[a+1]+weaponDef-&gt;thickness),weaponDef-&gt;visuals.texture1-&gt;xend,weaponDef-&gt;visuals.texture1-&gt;ystart    ,col);
+		va-&gt;AddVertexQTC(tempPos+dir1*(displacements2[a+1]-weaponDef-&gt;thickness),weaponDef-&gt;visuals.texture1-&gt;xend,weaponDef-&gt;visuals.texture1-&gt;yend,col);
+		va-&gt;AddVertexQTC(tempPos+dir1*(displacements2[a+1]+weaponDef-&gt;thickness),weaponDef-&gt;visuals.texture1-&gt;xend,weaponDef-&gt;visuals.texture1-&gt;ystart    ,col);
 	}
 }
 

Modified: trunk/rts/Sim/Projectiles/WeaponProjectiles/MissileProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/WeaponProjectiles/MissileProjectile.cpp	2008-10-03 22:09:22 UTC (rev 6513)
+++ trunk/rts/Sim/Projectiles/WeaponProjectiles/MissileProjectile.cpp	2008-10-03 22:55:21 UTC (rev 6514)
@@ -334,6 +334,7 @@
 	float color = 0.6f;
 	unsigned char col[4];
 
+	va-&gt;EnlargeArrays(8+4*numParts,0,VA_SIZE_TC);
 	if (weaponDef-&gt;visuals.smokeTrail) {
 		if (drawTrail) {
 			// draw the trail as a single quad
@@ -371,17 +372,17 @@
 			float size2 = (1 + (age2 * (1 / Smoke_Time)) * 7);
 			float txs = weaponDef-&gt;visuals.texture2-&gt;xend - (weaponDef-&gt;visuals.texture2-&gt;xend - weaponDef-&gt;visuals.texture2-&gt;xstart) * (age2 / 8.0f);
 
-			va-&gt;AddVertexTC(interPos - dir1 * size,  txs,                               weaponDef-&gt;visuals.texture2-&gt;ystart, col);
-			va-&gt;AddVertexTC(interPos + dir1 * size,  txs,                               weaponDef-&gt;visuals.texture2-&gt;yend,   col);
-			va-&gt;AddVertexTC(oldSmoke + dir2 * size2, weaponDef-&gt;visuals.texture2-&gt;xend, weaponDef-&gt;visuals.texture2-&gt;yend,   col2);
-			va-&gt;AddVertexTC(oldSmoke - dir2 * size2, weaponDef-&gt;visuals.texture2-&gt;xend, weaponDef-&gt;visuals.texture2-&gt;ystart, col2);
+			va-&gt;AddVertexQTC(interPos - dir1 * size,  txs,                               weaponDef-&gt;visuals.texture2-&gt;ystart, col);
+			va-&gt;AddVertexQTC(interPos + dir1 * size,  txs,                               weaponDef-&gt;visuals.texture2-&gt;yend,   col);
+			va-&gt;AddVertexQTC(oldSmoke + dir2 * size2, weaponDef-&gt;visuals.texture2-&gt;xend, weaponDef-&gt;visuals.texture2-&gt;yend,   col2);
+			va-&gt;AddVertexQTC(oldSmoke - dir2 * size2, weaponDef-&gt;visuals.texture2-&gt;xend, weaponDef-&gt;visuals.texture2-&gt;ystart, col2);
 		} else {
 			// draw the trail as particles
 			float dist = pos.distance(oldSmoke);
 			float3 dirpos1 = pos - dir * dist * 0.33f;
 			float3 dirpos2 = oldSmoke + oldDir * dist * 0.33f;
 
-			for (int a = 0; a &lt; numParts; ++a) {
+			for (int a = 0; a &lt; numParts; ++a) { //! CAUTION: loop count must match EnlargeArrays above
 				float alpha = 255.0f;
 				col[0] = (unsigned char) (color * alpha);
 				col[1] = (unsigned char) (color * alpha);
@@ -391,10 +392,10 @@
 				float size = (1 + (a * (1 / Smoke_Time)) * 7);
 				float3 pos1 = CalcBeizer(float(a) / (numParts), pos, dirpos1, dirpos2, oldSmoke);
 
-				va-&gt;AddVertexTC(pos1 + ( camera-&gt;up + camera-&gt;right) * size, ph-&gt;smoketex[0].xstart, ph-&gt;smoketex[0].ystart, col);
-				va-&gt;AddVertexTC(pos1 + ( camera-&gt;up - camera-&gt;right) * size, ph-&gt;smoketex[0].xend,   ph-&gt;smoketex[0].ystart, col);
-				va-&gt;AddVertexTC(pos1 + (-camera-&gt;up - camera-&gt;right) * size, ph-&gt;smoketex[0].xend,   ph-&gt;smoketex[0].ystart, col);
-				va-&gt;AddVertexTC(pos1 + (-camera-&gt;up + camera-&gt;right) * size, ph-&gt;smoketex[0].xstart, ph-&gt;smoketex[0].ystart, col);
+				va-&gt;AddVertexQTC(pos1 + ( camera-&gt;up + camera-&gt;right) * size, ph-&gt;smoketex[0].xstart, ph-&gt;smoketex[0].ystart, col);
+				va-&gt;AddVertexQTC(pos1 + ( camera-&gt;up - camera-&gt;right) * size, ph-&gt;smoketex[0].xend,   ph-&gt;smoketex[0].ystart, col);
+				va-&gt;AddVertexQTC(pos1 + (-camera-&gt;up - camera-&gt;right) * size, ph-&gt;smoketex[0].xend,   ph-&gt;smoketex[0].ystart, col);
+				va-&gt;AddVertexQTC(pos1 + (-camera-&gt;up + camera-&gt;right) * size, ph-&gt;smoketex[0].xstart, ph-&gt;smoketex[0].ystart, col);
 			}
 		}
 	}
@@ -405,10 +406,10 @@
 	col[2] = 180;
 	col[3] = 1;
 	float fsize = radius * 0.4f;
-	va-&gt;AddVertexTC(interPos - camera-&gt;right * fsize-camera-&gt;up * fsize, weaponDef-&gt;visuals.texture1-&gt;xstart, weaponDef-&gt;visuals.texture1-&gt;ystart, col);
-	va-&gt;AddVertexTC(interPos + camera-&gt;right * fsize-camera-&gt;up * fsize, weaponDef-&gt;visuals.texture1-&gt;xend,   weaponDef-&gt;visuals.texture1-&gt;ystart, col);
-	va-&gt;AddVertexTC(interPos + camera-&gt;right * fsize+camera-&gt;up * fsize, weaponDef-&gt;visuals.texture1-&gt;xend,   weaponDef-&gt;visuals.texture1-&gt;yend,   col);
-	va-&gt;AddVertexTC(interPos - camera-&gt;right * fsize+camera-&gt;up * fsize, weaponDef-&gt;visuals.texture1-&gt;xstart, weaponDef-&gt;visuals.texture1-&gt;yend,   col);
+	va-&gt;AddVertexQTC(interPos - camera-&gt;right * fsize-camera-&gt;up * fsize, weaponDef-&gt;visuals.texture1-&gt;xstart, weaponDef-&gt;visuals.texture1-&gt;ystart, col);
+	va-&gt;AddVertexQTC(interPos + camera-&gt;right * fsize-camera-&gt;up * fsize, weaponDef-&gt;visuals.texture1-&gt;xend,   weaponDef-&gt;visuals.texture1-&gt;ystart, col);
+	va-&gt;AddVertexQTC(interPos + camera-&gt;right * fsize+camera-&gt;up * fsize, weaponDef-&gt;visuals.texture1-&gt;xend,   weaponDef-&gt;visuals.texture1-&gt;yend,   col);
+	va-&gt;AddVertexQTC(interPos - camera-&gt;right * fsize+camera-&gt;up * fsize, weaponDef-&gt;visuals.texture1-&gt;xstart, weaponDef-&gt;visuals.texture1-&gt;yend,   col);
 
 /*	col[0]=200;
 	col[1]=200;

Modified: trunk/rts/Sim/Projectiles/WeaponProjectiles/StarburstProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/WeaponProjectiles/StarburstProjectile.cpp	2008-10-03 22:09:22 UTC (rev 6513)
+++ trunk/rts/Sim/Projectiles/WeaponProjectiles/StarburstProjectile.cpp	2008-10-03 22:55:21 UTC (rev 6514)
@@ -266,7 +266,8 @@
 	unsigned char col[4];
 	unsigned char col2[4];
 
-	if (weaponDef-&gt;visuals.smokeTrail)
+	if (weaponDef-&gt;visuals.smokeTrail) {
+		va-&gt;EnlargeArrays(4+4*numParts,0,VA_SIZE_TC);
 		if(drawTrail){		//draw the trail as a single quad
 
 			float3 dif(interPos-camera-&gt;pos);
@@ -301,16 +302,16 @@
 			float size2=(1+age2*(1/Smoke_Time)*7);
 
 			float txs=weaponDef-&gt;visuals.texture2-&gt;xend - (weaponDef-&gt;visuals.texture2-&gt;xend-weaponDef-&gt;visuals.texture2-&gt;xstart)*(age2/8.0f);//(1-age2/8.0f);
-			va-&gt;AddVertexTC(interPos-dir1*size, txs, weaponDef-&gt;visuals.texture2-&gt;ystart, col);
-			va-&gt;AddVertexTC(interPos+dir1*size, txs, weaponDef-&gt;visuals.texture2-&gt;yend, col);
-			va-&gt;AddVertexTC(oldSmoke+dir2*size2, weaponDef-&gt;visuals.texture2-&gt;xend, weaponDef-&gt;visuals.texture2-&gt;yend, col2);
-			va-&gt;AddVertexTC(oldSmoke-dir2*size2, weaponDef-&gt;visuals.texture2-&gt;xend, weaponDef-&gt;visuals.texture2-&gt;ystart, col2);
+			va-&gt;AddVertexQTC(interPos-dir1*size, txs, weaponDef-&gt;visuals.texture2-&gt;ystart, col);
+			va-&gt;AddVertexQTC(interPos+dir1*size, txs, weaponDef-&gt;visuals.texture2-&gt;yend, col);
+			va-&gt;AddVertexQTC(oldSmoke+dir2*size2, weaponDef-&gt;visuals.texture2-&gt;xend, weaponDef-&gt;visuals.texture2-&gt;yend, col2);
+			va-&gt;AddVertexQTC(oldSmoke-dir2*size2, weaponDef-&gt;visuals.texture2-&gt;xend, weaponDef-&gt;visuals.texture2-&gt;ystart, col2);
 		} else {	//draw the trail as particles
 			float dist=pos.distance(oldSmoke);
 			float3 dirpos1=pos-dir*dist*0.33f;
 			float3 dirpos2=oldSmoke+oldSmokeDir*dist*0.33f;
 
-			for(int a=0;a&lt;numParts;++a){
+			for(int a=0;a&lt;numParts;++a){ //! CAUTION: loop count must match EnlargeArrays above
 				//float a1=1-float(a)/Smoke_Time;
 				col[0]=(unsigned char) (color*255);
 				col[1]=(unsigned char) (color*255);
@@ -319,13 +320,13 @@
 				float size=(1+(a)*(1/Smoke_Time)*7);
 
 				float3 pos1=CalcBeizer(float(a)/(numParts),pos,dirpos1,dirpos2,oldSmoke);
-				va-&gt;AddVertexTC(pos1+( camera-&gt;up+camera-&gt;right)*size, ph-&gt;smoketex[0].xstart, ph-&gt;smoketex[0].ystart, col);
-				va-&gt;AddVertexTC(pos1+( camera-&gt;up-camera-&gt;right)*size, ph-&gt;smoketex[0].xend, ph-&gt;smoketex[0].ystart, col);
-				va-&gt;AddVertexTC(pos1+(-camera-&gt;up-camera-&gt;right)*size, ph-&gt;smoketex[0].xend, ph-&gt;smoketex[0].ystart, col);
-				va-&gt;AddVertexTC(pos1+(-camera-&gt;up+camera-&gt;right)*size, ph-&gt;smoketex[0].xstart, ph-&gt;smoketex[0].ystart, col);
+				va-&gt;AddVertexQTC(pos1+( camera-&gt;up+camera-&gt;right)*size, ph-&gt;smoketex[0].xstart, ph-&gt;smoketex[0].ystart, col);
+				va-&gt;AddVertexQTC(pos1+( camera-&gt;up-camera-&gt;right)*size, ph-&gt;smoketex[0].xend, ph-&gt;smoketex[0].ystart, col);
+				va-&gt;AddVertexQTC(pos1+(-camera-&gt;up-camera-&gt;right)*size, ph-&gt;smoketex[0].xend, ph-&gt;smoketex[0].ystart, col);
+				va-&gt;AddVertexQTC(pos1+(-camera-&gt;up+camera-&gt;right)*size, ph-&gt;smoketex[0].xstart, ph-&gt;smoketex[0].ystart, col);
 			}
-
 		}
+	}
 	DrawCallback();
 	if(curCallback==0)
 		DrawCallback();

Modified: trunk/rts/Sim/Projectiles/WeaponProjectiles/TorpedoProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/WeaponProjectiles/TorpedoProjectile.cpp	2008-10-03 22:09:22 UTC (rev 6513)
+++ trunk/rts/Sim/Projectiles/WeaponProjectiles/TorpedoProjectile.cpp	2008-10-03 22:55:21 UTC (rev 6514)
@@ -188,44 +188,47 @@
 	float3 u=dir.cross(r);
 	const float h=12;
 	const float w=2;
-	va-&gt;AddVertexTC(interPos+r*w, texx,texy,col);
-	va-&gt;AddVertexTC(interPos+u*w, texx,texy,col);
-	va-&gt;AddVertexTC(interPos+u*w+dir*h, texx,texy,col);
-	va-&gt;AddVertexTC(interPos+r*w+dir*h, texx,texy,col);
 
-	va-&gt;AddVertexTC(interPos+u*w, texx,texy,col);
-	va-&gt;AddVertexTC(interPos-r*w, texx,texy,col);
-	va-&gt;AddVertexTC(interPos-r*w+dir*h, texx,texy,col);
-	va-&gt;AddVertexTC(interPos+u*w+dir*h, texx,texy,col);
+	va-&gt;EnlargeArrays(32,0,VA_SIZE_TC);
 
-	va-&gt;AddVertexTC(interPos-r*w, texx,texy,col);
-	va-&gt;AddVertexTC(interPos-u*w, texx,texy,col);
-	va-&gt;AddVertexTC(interPos-u*w+dir*h, texx,texy,col);
-	va-&gt;AddVertexTC(interPos-r*w+dir*h, texx,texy,col);
+	va-&gt;AddVertexQTC(interPos+r*w, texx,texy,col);
+	va-&gt;AddVertexQTC(interPos+u*w, texx,texy,col);
+	va-&gt;AddVertexQTC(interPos+u*w+dir*h, texx,texy,col);
+	va-&gt;AddVertexQTC(interPos+r*w+dir*h, texx,texy,col);
 
-	va-&gt;AddVertexTC(interPos-u*w, texx,texy,col);
-	va-&gt;AddVertexTC(interPos+r*w, texx,texy,col);
-	va-&gt;AddVertexTC(interPos+r*w+dir*h, texx,texy,col);
-	va-&gt;AddVertexTC(interPos-u*w+dir*h, texx,texy,col);
+	va-&gt;AddVertexQTC(interPos+u*w, texx,texy,col);
+	va-&gt;AddVertexQTC(interPos-r*w, texx,texy,col);
+	va-&gt;AddVertexQTC(interPos-r*w+dir*h, texx,texy,col);
+	va-&gt;AddVertexQTC(interPos+u*w+dir*h, texx,texy,col);
 
+	va-&gt;AddVertexQTC(interPos-r*w, texx,texy,col);
+	va-&gt;AddVertexQTC(interPos-u*w, texx,texy,col);
+	va-&gt;AddVertexQTC(interPos-u*w+dir*h, texx,texy,col);
+	va-&gt;AddVertexQTC(interPos-r*w+dir*h, texx,texy,col);
 
-	va-&gt;AddVertexTC(interPos+r*w+dir*h, texx,texy,col);
-	va-&gt;AddVertexTC(interPos+u*w+dir*h, texx,texy,col);
-	va-&gt;AddVertexTC(interPos+dir*h*1.2f, texx,texy,col);
-	va-&gt;AddVertexTC(interPos+dir*h*1.2f, texx,texy,col);
+	va-&gt;AddVertexQTC(interPos-u*w, texx,texy,col);
+	va-&gt;AddVertexQTC(interPos+r*w, texx,texy,col);
+	va-&gt;AddVertexQTC(interPos+r*w+dir*h, texx,texy,col);
+	va-&gt;AddVertexQTC(interPos-u*w+dir*h, texx,texy,col);
 
-	va-&gt;AddVertexTC(interPos+u*w+dir*h, texx,texy,col);
-	va-&gt;AddVertexTC(interPos-r*w+dir*h, texx,texy,col);
-	va-&gt;AddVertexTC(interPos+dir*h*1.2f, texx,texy,col);
-	va-&gt;AddVertexTC(interPos+dir*h*1.2f, texx,texy,col);
 
-	va-&gt;AddVertexTC(interPos-r*w+dir*h, texx,texy,col);
-	va-&gt;AddVertexTC(interPos-u*w+dir*h, texx,texy,col);
-	va-&gt;AddVertexTC(interPos+dir*h*1.2f, texx,texy,col);
-	va-&gt;AddVertexTC(interPos+dir*h*1.2f, texx,texy,col);
+	va-&gt;AddVertexQTC(interPos+r*w+dir*h, texx,texy,col);
+	va-&gt;AddVertexQTC(interPos+u*w+dir*h, texx,texy,col);
+	va-&gt;AddVertexQTC(interPos+dir*h*1.2f, texx,texy,col);
+	va-&gt;AddVertexQTC(interPos+dir*h*1.2f, texx,texy,col);
 
-	va-&gt;AddVertexTC(interPos-u*w+dir*h, texx,texy,col);
-	va-&gt;AddVertexTC(interPos+r*w+dir*h, texx,texy,col);
-	va-&gt;AddVertexTC(interPos+dir*h*1.2f, texx,texy,col);
-	va-&gt;AddVertexTC(interPos+dir*h*1.2f, texx,texy,col);
+	va-&gt;AddVertexQTC(interPos+u*w+dir*h, texx,texy,col);
+	va-&gt;AddVertexQTC(interPos-r*w+dir*h, texx,texy,col);
+	va-&gt;AddVertexQTC(interPos+dir*h*1.2f, texx,texy,col);
+	va-&gt;AddVertexQTC(interPos+dir*h*1.2f, texx,texy,col);
+
+	va-&gt;AddVertexQTC(interPos-r*w+dir*h, texx,texy,col);
+	va-&gt;AddVertexQTC(interPos-u*w+dir*h, texx,texy,col);
+	va-&gt;AddVertexQTC(interPos+dir*h*1.2f, texx,texy,col);
+	va-&gt;AddVertexQTC(interPos+dir*h*1.2f, texx,texy,col);
+
+	va-&gt;AddVertexQTC(interPos-u*w+dir*h, texx,texy,col);
+	va-&gt;AddVertexQTC(interPos+r*w+dir*h, texx,texy,col);
+	va-&gt;AddVertexQTC(interPos+dir*h*1.2f, texx,texy,col);
+	va-&gt;AddVertexQTC(interPos+dir*h*1.2f, texx,texy,col);
 }


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001283.html">[Taspring-linux-commit] r6513 - trunk/rts/Rendering
</A></li>
	<LI>Next message: <A HREF="001285.html">[Taspring-linux-commit] r6515 - in trunk/rts: Game/UI Lua
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1284">[ date ]</a>
              <a href="thread.html#1284">[ thread ]</a>
              <a href="subject.html#1284">[ subject ]</a>
              <a href="author.html#1284">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
