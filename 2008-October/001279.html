<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r6509 - in trunk/Lobby/TASClient: .	Interface Interface/images Python Python/engine	Python/scripts Python/scripts/subf
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-October/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6509%20-%20in%20trunk/Lobby/TASClient%3A%20.%0A%09Interface%20Interface/images%20Python%20Python/engine%0A%09Python/scripts%20Python/scripts/subf&In-Reply-To=%3C20081003153241.1ACDA4A5F%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001278.html">
   <LINK REL="Next"  HREF="001280.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r6509 - in trunk/Lobby/TASClient: .	Interface Interface/images Python Python/engine	Python/scripts Python/scripts/subf</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6509%20-%20in%20trunk/Lobby/TASClient%3A%20.%0A%09Interface%20Interface/images%20Python%20Python/engine%0A%09Python/scripts%20Python/scripts/subf&In-Reply-To=%3C20081003153241.1ACDA4A5F%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r6509 - in trunk/Lobby/TASClient: .	Interface Interface/images Python Python/engine	Python/scripts Python/scripts/subf">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Fri Oct  3 17:32:40 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001278.html">[Taspring-linux-commit] r6508 - trunk/rts/System/Platform/Linux
</A></li>
        <LI>Next message: <A HREF="001280.html">[Taspring-linux-commit] r6510 - in trunk/rts: System build/scons
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1279">[ date ]</a>
              <a href="thread.html#1279">[ thread ]</a>
              <a href="subject.html#1279">[ subject ]</a>
              <a href="author.html#1279">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: satirik
Date: 2008-10-03 17:32:39 +0200 (Fri, 03 Oct 2008)
New Revision: 6509

Added:
   trunk/Lobby/TASClient/Interface/images/singleplayer.gif
   trunk/Lobby/TASClient/Interface/images/singleplayer.png
   trunk/Lobby/TASClient/Interface/images/singleplayer_over.png
   trunk/Lobby/TASClient/Interface/modMain.html
   trunk/Lobby/TASClient/Interface/modsettings.html
   trunk/Lobby/TASClient/Interface/selectmod.html
   trunk/Lobby/TASClient/Python/scripts/subf/stick.py
Removed:
   trunk/Lobby/TASClient/Interface/Campaign/
   trunk/Lobby/TASClient/Interface/Mission/
   trunk/Lobby/TASClient/Python/scripts/stick.py
Modified:
   trunk/Lobby/TASClient/BattleFormUnit.dfm
   trunk/Lobby/TASClient/HostBattleFormUnit.dfm
   trunk/Lobby/TASClient/HostBattleFormUnit.pas
   trunk/Lobby/TASClient/HttpGetUnit.pas
   trunk/Lobby/TASClient/Interface/campaigns.html
   trunk/Lobby/TASClient/Interface/defaultMissionSkin.html
   trunk/Lobby/TASClient/Interface/main.html
   trunk/Lobby/TASClient/Interface/modItem.html
   trunk/Lobby/TASClient/Interface/settings.html
   trunk/Lobby/TASClient/Interface/skirmish.html
   trunk/Lobby/TASClient/LobbyScriptUnit.pas
   trunk/Lobby/TASClient/MainUnit.dfm
   trunk/Lobby/TASClient/MainUnit.pas
   trunk/Lobby/TASClient/ManageGroups.dfm
   trunk/Lobby/TASClient/MenuFormUnit.dfm
   trunk/Lobby/TASClient/MenuFormUnit.pas
   trunk/Lobby/TASClient/Misc.pas
   trunk/Lobby/TASClient/PreferencesFormUnit.pas
   trunk/Lobby/TASClient/Python/api.txt
   trunk/Lobby/TASClient/Python/engine/handlers.py
   trunk/Lobby/TASClient/Python/scripts/subf/frenchTranslationTest.py
   trunk/Lobby/TASClient/Python/scripts/subf/layoutTest.py
   trunk/Lobby/TASClient/Python/scripts/subf/windowedTASClient.py
   trunk/Lobby/TASClient/TASClient.cfg
   trunk/Lobby/TASClient/TASClient.dof
   trunk/Lobby/TASClient/TASClient.dpr
   trunk/Lobby/TASClient/TASClient.res
   trunk/Lobby/TASClient/Utility.pas
Log:
* python: addpanel,addtabs and addspliter removed, addcontrol added (see api.txt)
* unitsync unloaded before updating the lobby
* open logs added to the channel's context menu
* onChatDblClick handler bug fixed
* unitsync lua parser api added
* small fixes (in manage groups form, the tdf parser, the chat context menu init, multi line sending)
* python : getcolors moved to GUI, AddToTextBox and GetTextBoxList renamed to AddToRichEdit and GetRichEditList, and moved to GUI (test scripts using it updated)
* first step to the new SP system

Modified: trunk/Lobby/TASClient/BattleFormUnit.dfm
===================================================================
--- trunk/Lobby/TASClient/BattleFormUnit.dfm	2008-10-03 13:47:09 UTC (rev 6508)
+++ trunk/Lobby/TASClient/BattleFormUnit.dfm	2008-10-03 15:32:39 UTC (rev 6509)
@@ -1,6 +1,6 @@
 object BattleForm: TBattleForm
-  Left = 687
-  Top = 50
+  Left = 726
+  Top = 303
   Width = 830
   Height = 586
   Caption = 'Battle window'
@@ -4165,18 +4165,18 @@
               end
             end
           end
-          object ModTabSheet: TSpTBXTabSheet
+          object MapTabSheet: TSpTBXTabSheet
             Left = 0
             Top = 34
             Width = 419
             Height = 239
-            Caption = 'Mod options'
+            Caption = 'Map options'
             ImageIndex = -1
             DesignSize = (
               419
               239)
-            TabItem = 'ModTab'
-            object ModOptionsScrollBox: TTntScrollBox
+            TabItem = 'MapTab'
+            object MapOptionsScrollBox: TTntScrollBox
               Left = 8
               Top = 48
               Width = 402
@@ -4194,49 +4194,49 @@
               ParentCtl3D = False
               TabOrder = 0
             end
-            object panelModOptionsDefault: TSpTBXPanel
+            object panelMapOptionsDefault: TSpTBXPanel
               Left = 8
               Top = 4
               Width = 402
               Height = 41
               Align = alCustom
               TabOrder = 1
-              object btLoadDefaultMDO: TSpTBXButton
+              object btLoadDefaultMPO: TSpTBXButton
                 Left = 149
                 Top = 8
                 Width = 113
                 Height = 25
                 Caption = 'Load default'
                 TabOrder = 0
-                OnClick = btLoadDefaultMDOClick
+                OnClick = btLoadDefaultMPOClick
                 LinkFont.Charset = DEFAULT_CHARSET
                 LinkFont.Color = clBlue
                 LinkFont.Height = -11
                 LinkFont.Name = 'MS Sans Serif'
                 LinkFont.Style = [fsUnderline]
               end
-              object btSetAsDefaultMDO: TSpTBXButton
+              object btSetAsDefaultMPO: TSpTBXButton
                 Left = 269
                 Top = 8
                 Width = 113
                 Height = 25
                 Caption = 'Set as default'
                 TabOrder = 1
-                OnClick = btSetAsDefaultMDOClick
+                OnClick = btSetAsDefaultMPOClick
                 LinkFont.Charset = DEFAULT_CHARSET
                 LinkFont.Color = clBlue
                 LinkFont.Height = -11
                 LinkFont.Name = 'MS Sans Serif'
                 LinkFont.Style = [fsUnderline]
               end
-              object btLoadModsDefaultMDO: TSpTBXButton
+              object btLoadMapsDefaultMPO: TSpTBXButton
                 Left = 29
                 Top = 8
                 Width = 113
                 Height = 25
-                Caption = 'Load mod'#39's default'
+                Caption = 'Load map'#39's default'
                 TabOrder = 2
-                OnClick = btLoadModsDefaultMDOClick
+                OnClick = btLoadMapsDefaultMPOClick
                 LinkFont.Charset = DEFAULT_CHARSET
                 LinkFont.Color = clBlue
                 LinkFont.Height = -11
@@ -4245,18 +4245,18 @@
               end
             end
           end
-          object MapTabSheet: TSpTBXTabSheet
+          object ModTabSheet: TSpTBXTabSheet
             Left = 0
             Top = 34
             Width = 419
             Height = 239
-            Caption = 'Map options'
+            Caption = 'Mod options'
             ImageIndex = -1
             DesignSize = (
               419
               239)
-            TabItem = 'MapTab'
-            object MapOptionsScrollBox: TTntScrollBox
+            TabItem = 'ModTab'
+            object ModOptionsScrollBox: TTntScrollBox
               Left = 8
               Top = 48
               Width = 402
@@ -4274,49 +4274,49 @@
               ParentCtl3D = False
               TabOrder = 0
             end
-            object panelMapOptionsDefault: TSpTBXPanel
+            object panelModOptionsDefault: TSpTBXPanel
               Left = 8
               Top = 4
               Width = 402
               Height = 41
               Align = alCustom
               TabOrder = 1
-              object btLoadDefaultMPO: TSpTBXButton
+              object btLoadDefaultMDO: TSpTBXButton
                 Left = 149
                 Top = 8
                 Width = 113
                 Height = 25
                 Caption = 'Load default'
                 TabOrder = 0
-                OnClick = btLoadDefaultMPOClick
+                OnClick = btLoadDefaultMDOClick
                 LinkFont.Charset = DEFAULT_CHARSET
                 LinkFont.Color = clBlue
                 LinkFont.Height = -11
                 LinkFont.Name = 'MS Sans Serif'
                 LinkFont.Style = [fsUnderline]
               end
-              object btSetAsDefaultMPO: TSpTBXButton
+              object btSetAsDefaultMDO: TSpTBXButton
                 Left = 269
                 Top = 8
                 Width = 113
                 Height = 25
                 Caption = 'Set as default'
                 TabOrder = 1
-                OnClick = btSetAsDefaultMPOClick
+                OnClick = btSetAsDefaultMDOClick
                 LinkFont.Charset = DEFAULT_CHARSET
                 LinkFont.Color = clBlue
                 LinkFont.Height = -11
                 LinkFont.Name = 'MS Sans Serif'
                 LinkFont.Style = [fsUnderline]
               end
-              object btLoadMapsDefaultMPO: TSpTBXButton
+              object btLoadModsDefaultMDO: TSpTBXButton
                 Left = 29
                 Top = 8
                 Width = 113
                 Height = 25
-                Caption = 'Load map'#39's default'
+                Caption = 'Load mod'#39's default'
                 TabOrder = 2
-                OnClick = btLoadMapsDefaultMPOClick
+                OnClick = btLoadModsDefaultMDOClick
                 LinkFont.Charset = DEFAULT_CHARSET
                 LinkFont.Color = clBlue
                 LinkFont.Height = -11

Modified: trunk/Lobby/TASClient/HostBattleFormUnit.dfm
===================================================================
--- trunk/Lobby/TASClient/HostBattleFormUnit.dfm	2008-10-03 13:47:09 UTC (rev 6508)
+++ trunk/Lobby/TASClient/HostBattleFormUnit.dfm	2008-10-03 15:32:39 UTC (rev 6509)
@@ -1,6 +1,6 @@
 object HostBattleForm: THostBattleForm
-  Left = 289
-  Top = 106
+  Left = 847
+  Top = 104
   BorderStyle = bsDialog
   Caption = 'Host battle'
   ClientHeight = 355

Modified: trunk/Lobby/TASClient/HostBattleFormUnit.pas
===================================================================
--- trunk/Lobby/TASClient/HostBattleFormUnit.pas	2008-10-03 13:47:09 UTC (rev 6508)
+++ trunk/Lobby/TASClient/HostBattleFormUnit.pas	2008-10-03 15:32:39 UTC (rev 6509)
@@ -133,40 +133,43 @@
 var
   i,j: Integer;
   s: WideString;
-  validMaps: TStringList;
   CheckPasswordThread : TLadderCheckAccountThread;
 begin
   try
-    i := StrToInt(PortEdit.Text);
-    if (i &lt; 1024) or (i &gt; 65535) then raise Exception.Create('Number out of range');
+    i := StrToInt(Trim(PortEdit.Text));
+  if (i &lt; 1024) or (i &gt; 65535) then raise Exception.Create('Number out of range');
   except
-    MessageDlg('Port number must be a whole number within a proper range (1024..65535)', mtError, [mbOK], 0);
+    if not LobbyScriptUnit.ScriptHostingRunning and not LobbyScriptUnit.ScriptHostingReplayRunning then
+      MessageDlg('Port number must be a whole number within a proper range (1024..65535)', mtError, [mbOK], 0);
     Exit;
   end;
 
   if not (PasswordEdit.Text = '') then if not ValidatePassword(PasswordEdit.Text) then
   begin
-    MessageDlg('Invalid password! Must contain letters and numbers only!', mtError, [mbOK], 0);
+    if not LobbyScriptUnit.ScriptHostingRunning and not LobbyScriptUnit.ScriptHostingReplayRunning then
+      MessageDlg('Invalid password! Must contain letters and numbers only!', mtError, [mbOK], 0);
     Exit;
   end;
 
   if BattleForm.CurrentMapIndex = -1 then // this should not happen!
   begin
-    MessageDlg('Cannot proceed: no map is selected!', mtWarning, [mbOK], 0);
+    if not LobbyScriptUnit.ScriptHostingRunning and not LobbyScriptUnit.ScriptHostingReplayRunning then
+      MessageDlg('Cannot proceed: no map is selected!', mtWarning, [mbOK], 0);
     Exit;
   end;
 
   ReInitLib;
   LoadMod(Utility.ModArchiveList[Utility.ModList.IndexOf(ModsComboBox.Items[ModsComboBox.ItemIndex])]);
-  validMaps:=GetModValidMapList;
-  if validMaps.Count &gt; 0 then
+
+  if Utility.ModValidMaps.Count &gt; 0 then
   begin
     i:=0;
-    while (i &lt; validMaps.Count) and (Utility.MapList.IndexOf(validMaps[i]) = -1) do
+    while (i &lt; Utility.ModValidMaps.Count) and (Utility.MapList.IndexOf(Utility.ModValidMaps[i]) = -1) do
       i := i+1;
-    if i = validMaps.Count then
+    if i = Utility.ModValidMaps.Count then
     begin
-      MessageDlg('Cannot proceed: this mod requires one of the following map :'+EOL+Misc.JoinStringList(validMaps,' ; '), mtWarning, [mbOK], 0);
+      if not LobbyScriptUnit.ScriptHostingRunning and not LobbyScriptUnit.ScriptHostingReplayRunning then
+        MessageDlg('Cannot proceed: this mod requires one of the following map :'+EOL+Misc.JoinStringList(Utility.ModValidMaps,' ; '), mtWarning, [mbOK], 0);
       Exit;
     end;
   end;
@@ -179,7 +182,8 @@
 }
 
   if (Status.MyRank &lt; RankComboBox.ItemIndex) then
-    if MessageDlg('Your rank (' + Ranks[Status.MyRank] + ') is lower than the battle rank limit (' + Ranks[RankComboBox.ItemIndex] + '). Do you wish to continue anyway?', mtConfirmation, [mbYes, mbNo], 0) = mrNo then Exit;
+    if not LobbyScriptUnit.ScriptHostingRunning and not LobbyScriptUnit.ScriptHostingReplayRunning then
+      if MessageDlg('Your rank (' + Ranks[Status.MyRank] + ') is lower than the battle rank limit (' + Ranks[RankComboBox.ItemIndex] + '). Do you wish to continue anyway?', mtConfirmation, [mbYes, mbNo], 0) = mrNo then Exit;
 
   // loading default battle preferences
   PreferencesForm.LoadDefaultBattlePreferencesFromRegistry;
@@ -257,7 +261,7 @@
     if PasswordEdit.Text = '' then s := s + '* ' else s := s + PasswordEdit.Text + ' ';
   // port:
   if NATRadioGroup.ItemIndex = 1 then s := s + IntToStr(NATTraversal.MyPublicUDPSourcePort) + ' '
-  else s := s + PortEdit.Text + ' ';
+  else s := s + Trim(PortEdit.Text) + ' ';
   // max. players:
   s := s + IntToStr(PlayersTracker.Value) + ' ';
   
@@ -325,7 +329,7 @@
   s: WideString;
 begin
   try
-    i := StrToInt(PortEdit.Text);
+    i := StrToInt(Trim(PortEdit.Text));
     if (i &lt; 1024) or (i &gt; 65535) then raise Exception.Create('Number out of range');
   except
     MessageDlg('Port number must be a whole number within a proper range (1024..65535)', mtError, [mbOK], 0);
@@ -389,7 +393,7 @@
   if PasswordEdit.Text = '' then s := s + '* ' else s := s + PasswordEdit.Text + ' ';
   // port:
   if NATRadioGroup.ItemIndex = 1 then s := s + IntToStr(NATTraversal.MyPublicUDPSourcePort) + ' '
-  else s := s + PortEdit.Text + ' ';
+  else s := s + Trim(PortEdit.Text) + ' ';
   // max. players:
   s := s + IntToStr(PlayersTracker.Value) + ' ';
 

Modified: trunk/Lobby/TASClient/HttpGetUnit.pas
===================================================================
--- trunk/Lobby/TASClient/HttpGetUnit.pas	2008-10-03 13:47:09 UTC (rev 6508)
+++ trunk/Lobby/TASClient/HttpGetUnit.pas	2008-10-03 15:32:39 UTC (rev 6509)
@@ -5,7 +5,7 @@
 uses
   Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
   Dialogs, HttpProt, StdCtrls, Buttons, ComCtrls, MainUnit, Misc, ShellAPI,
-  SpTBXControls, TBXDkPanels, SpTBXItem,StrUtils, SevenZipVCL;
+  SpTBXControls, TBXDkPanels, SpTBXItem,StrUtils, SevenZipVCL,Utility;
 
 type
   THttpGetForm = class(TForm)
@@ -194,6 +194,9 @@
           // closes springdownloader
           CloseSpringDownloader;
 
+          // uninit unitsync
+          Utility.DeInitLib;
+
           // updates files
           MoveTree(ExtractFilePath(appExePath)+'TASClientUpdateTemp\',ExtractFilePath(appExePath));
 

Modified: trunk/Lobby/TASClient/Interface/campaigns.html
===================================================================
--- trunk/Lobby/TASClient/Interface/campaigns.html	2008-10-03 13:47:09 UTC (rev 6508)
+++ trunk/Lobby/TASClient/Interface/campaigns.html	2008-10-03 15:32:39 UTC (rev 6509)
@@ -11,7 +11,7 @@
 				x.style.left = (getPercentValue(x.style.left) + 0.82) + '%'
 				setTimeout(&quot;resizeBar()&quot;,40);
 			}else{
-				sendData('main');
+				sendData('modmain');
 			}
 		}
 

Modified: trunk/Lobby/TASClient/Interface/defaultMissionSkin.html
===================================================================
--- trunk/Lobby/TASClient/Interface/defaultMissionSkin.html	2008-10-03 13:47:09 UTC (rev 6508)
+++ trunk/Lobby/TASClient/Interface/defaultMissionSkin.html	2008-10-03 15:32:39 UTC (rev 6509)
@@ -14,7 +14,7 @@
 	&lt;div id=&quot;bar&quot; style=&quot;position:absolute;left:10%;top:0;width:80%;height:100%;filter : alpha(opacity=44);background-color: black&quot;&gt;&lt;/div&gt;
 	&lt;div style=&quot;border: 0;position:absolute;left:10%;top:0;width:80%;height:100%;&quot;&gt;
 		&lt;div id=&quot;briefing&quot; style=&quot;margin: 20px;width: 100%;height: 20px;overflow: auto;padding: 10px;color: #ffa573&quot;&gt;
-			[MissionContent]
+			[CampaignContent]
 		&lt;/div&gt;
 		&lt;div class=&quot;footer&quot;&gt;
 			&lt;a href=&quot;lobby:back&quot; class=&quot;button&quot; style=&quot;float: left;&quot; onmouseover=&quot;sendData('playsound:..\button.wav');&quot;&gt;Back&lt;/a&gt;

Added: trunk/Lobby/TASClient/Interface/images/singleplayer.gif
===================================================================
(Binary files differ)


Property changes on: trunk/Lobby/TASClient/Interface/images/singleplayer.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/Lobby/TASClient/Interface/images/singleplayer.png
===================================================================
(Binary files differ)


Property changes on: trunk/Lobby/TASClient/Interface/images/singleplayer.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/Lobby/TASClient/Interface/images/singleplayer_over.png
===================================================================
(Binary files differ)


Property changes on: trunk/Lobby/TASClient/Interface/images/singleplayer_over.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: trunk/Lobby/TASClient/Interface/main.html
===================================================================
--- trunk/Lobby/TASClient/Interface/main.html	2008-10-03 13:47:09 UTC (rev 6508)
+++ trunk/Lobby/TASClient/Interface/main.html	2008-10-03 15:32:39 UTC (rev 6509)
@@ -83,45 +83,23 @@
 			color: #a26949;
 		}
 
-		#campaigns {
+		#singleplayer {
 			position: absolute;
 			top:30%;
 			left:22.75%;
 			width: 21%;
 			z-index:1000;
-			filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src=&quot;images/campaigns.png&quot;, sizingMethod=&quot;scale&quot;);
+			filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src=&quot;images/singleplayer.png&quot;, sizingMethod=&quot;scale&quot;);
 		}
-		a:hover #campaigns {
-			filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src=&quot;images/campaigns_over.png&quot;, sizingMethod=&quot;scale&quot;);
+		a:hover #singleplayer {
+			filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src=&quot;images/singleplayer_over.png&quot;, sizingMethod=&quot;scale&quot;);
 		}
-		#missions {
+		#multiplayer {
 			position: absolute;
 			top:40%;
 			left:22.75%;
 			width: 21%;
 			z-index:1000;
-			filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src=&quot;images/missions.png&quot;, sizingMethod=&quot;scale&quot;);
-		}
-		a:hover #missions {
-			filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src=&quot;images/missions_over.png&quot;, sizingMethod=&quot;scale&quot;);
-		}
-		#skirmish {
-			position: absolute;
-			top:50%;
-			left:22.75%;
-			width: 21%;
-			z-index:1000;
-			filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src=&quot;images/skirmish.png&quot;, sizingMethod=&quot;scale&quot;);
-		}
-		a:hover #skirmish {
-			filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src=&quot;images/skirmish_over.png&quot;, sizingMethod=&quot;scale&quot;);
-		}
-		#multiplayer {
-			position: absolute;
-			top:60%;
-			left:22.75%;
-			width: 21%;
-			z-index:1000;
 			filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src=&quot;images/multiplayer.png&quot;, sizingMethod=&quot;scale&quot;);
 		}
 		a:hover #multiplayer {
@@ -129,7 +107,7 @@
 		}
 		#settings {
 			position: absolute;
-			top:70%;
+			top:50%;
 			left:22.75%;
 			width: 21%;
 			z-index:1000;
@@ -140,7 +118,7 @@
 		}
 		#quit {
 			position: absolute;
-			top:80%;
+			top:60%;
 			left:22.75%;
 			width: 21%;
 			z-index:1000;
@@ -157,13 +135,11 @@
 	&lt;div id=&quot;bar&quot; style=&quot;position:absolute;left:22%;width:22%;height:100%;filter : alpha(opacity=44);background-color: black&quot;&gt;&lt;/div&gt;
 	&lt;div id=&quot;springVersion&quot;&gt;v[SpringVersion]&lt;/div&gt;
 	&lt;div id=&quot;menu&quot; style=&quot;position: absolute;width:100%;height:100%;top:0;left:0&quot;&gt;
-	&lt;a href=&quot;#&quot; onmouseover=&quot;sendData('playsound:button.wav');&quot;  onclick=&quot;goPage='campaigns';fadeOff();&quot;&gt;&lt;img id=&quot;campaigns&quot; src=&quot;images/campaigns.gif&quot;&gt;&lt;/img&gt;&lt;/a&gt;
-	&lt;a href=&quot;#&quot; onmouseover=&quot;sendData('playsound:button.wav');&quot; onclick=&quot;goPage='missions';fadeOff();&quot;&gt;&lt;img id=&quot;missions&quot; src=&quot;images/missions.gif&quot;&gt;&lt;/img&gt;&lt;/a&gt;
-	&lt;a href=&quot;#&quot; onmouseover=&quot;sendData('playsound:button.wav');&quot; onclick=&quot;goPage='skirmish';fadeOff();&quot;&gt;&lt;img id=&quot;skirmish&quot; src=&quot;images/skirmish.gif&quot;&gt;&lt;/img&gt;&lt;/a&gt;
-	&lt;a href=&quot;lobby:showMultiplayerLobby&quot; onmouseover=&quot;sendData('playsound:button.wav');&quot;&gt;&lt;img id=&quot;multiplayer&quot; src=&quot;images/multiplayer.gif&quot;&gt;&lt;/img&gt;&lt;/a&gt;
-	&lt;a href=&quot;#&quot; onmouseover=&quot;sendData('playsound:button.wav');&quot; onclick=&quot;goPage='localfile:settings.html';fadeOff();&quot;&gt;&lt;img id=&quot;settings&quot; src=&quot;images/settings.gif&quot;&gt;&lt;/img&gt;&lt;/a&gt;
-	&lt;a href=&quot;lobby:quit&quot; onmouseover=&quot;sendData('playsound:button.wav');&quot;&gt;&lt;img id=&quot;quit&quot; src=&quot;images/quit.gif&quot;&gt;&lt;/img&gt;&lt;/a&gt;
-	&lt;div id=&quot;website&quot;&gt;&lt;a href=&quot;<A HREF="http://taspring.clan-sy.com">http://taspring.clan-sy.com</A>&quot;&gt;Official Website&lt;/a&gt;&lt;/div&gt;
+    &lt;a href=&quot;#&quot; onmouseover=&quot;sendData('playsound:button.wav');&quot; onclick=&quot;goPage='localfile:selectmod.html';fadeOff();&quot;&gt;&lt;img id=&quot;singleplayer&quot; src=&quot;images/singleplayer.gif&quot;&gt;&lt;/img&gt;&lt;/a&gt;
+    &lt;a href=&quot;lobby:showMultiplayerLobby&quot; onmouseover=&quot;sendData('playsound:button.wav');&quot;&gt;&lt;img id=&quot;multiplayer&quot; src=&quot;images/multiplayer.gif&quot;&gt;&lt;/img&gt;&lt;/a&gt;
+    &lt;a href=&quot;#&quot; onmouseover=&quot;sendData('playsound:button.wav');&quot; onclick=&quot;goPage='localfile:settings.html';fadeOff();&quot;&gt;&lt;img id=&quot;settings&quot; src=&quot;images/settings.gif&quot;&gt;&lt;/img&gt;&lt;/a&gt;
+    &lt;a href=&quot;lobby:quit&quot; onmouseover=&quot;sendData('playsound:button.wav');&quot;&gt;&lt;img id=&quot;quit&quot; src=&quot;images/quit.gif&quot;&gt;&lt;/img&gt;&lt;/a&gt;
+    &lt;div id=&quot;website&quot;&gt;&lt;a href=&quot;<A HREF="http://taspring.clan-sy.com">http://taspring.clan-sy.com</A>&quot;&gt;Official Website&lt;/a&gt;&lt;/div&gt;
 	&lt;/div&gt;
 &lt;/body&gt;
 &lt;/html&gt;
\ No newline at end of file

Modified: trunk/Lobby/TASClient/Interface/modItem.html
===================================================================
--- trunk/Lobby/TASClient/Interface/modItem.html	2008-10-03 13:47:09 UTC (rev 6508)
+++ trunk/Lobby/TASClient/Interface/modItem.html	2008-10-03 15:32:39 UTC (rev 6509)
@@ -1 +1 @@
-&lt;option value =&quot;[modId]&quot;&gt;[modName]&lt;/option&gt;
\ No newline at end of file
+&lt;a href=&quot;#&quot; onclick=&quot;sendData('selectmod:[modId]');&quot;&gt;[modName]&lt;/a&gt;&lt;br/&gt;
\ No newline at end of file

Added: trunk/Lobby/TASClient/Interface/modMain.html
===================================================================
--- trunk/Lobby/TASClient/Interface/modMain.html	                        (rev 0)
+++ trunk/Lobby/TASClient/Interface/modMain.html	2008-10-03 15:32:39 UTC (rev 6509)
@@ -0,0 +1,183 @@
+&lt;html&gt;
+&lt;head&gt;
+	&lt;link type=&quot;text/css&quot; rel=&quot;StyleSheet&quot; href=&quot;default.css&quot; /&gt;
+	&lt;script type=&quot;text/javascript&quot; src=&quot;default.js&quot;&gt;&lt;/script&gt;
+	&lt;script type=&quot;text/javascript&quot;&gt;
+		currentOpacityFadeOff = 100;
+
+		goPage = '';
+
+		function fadeOff(){
+			currentOpacityFadeOff = currentOpacityFadeOff - 25;
+			document.getElementById('menu').style.filter = &quot;alpha(opacity=&quot;+currentOpacityFadeOff+&quot;)&quot;;
+			document.getElementById('title').style.filter = &quot;alpha(opacity=&quot;+currentOpacityFadeOff+&quot;)&quot;;
+			document.getElementById('springVersion').style.filter = &quot;alpha(opacity=&quot;+currentOpacityFadeOff+&quot;)&quot;;
+			document.getElementById('modName').style.filter = &quot;alpha(opacity=&quot;+currentOpacityFadeOff+&quot;)&quot;;
+			if (currentOpacityFadeOff &gt; 0) {
+				setTimeout(&quot;fadeOff()&quot;,40);
+			}else{
+				document.getElementById('menu').style.visibility = 'hidden';
+				document.getElementById('title').style.visibility = 'hidden';
+				document.getElementById('springVersion').style.visibility = 'hidden';
+				resizeBar();
+			}
+		}
+
+		function resizeBar(){
+			x = document.getElementById('bar');
+			if (getPercentValue(x.style.width) &lt; 77) {
+				x.style.width = (getPercentValue(x.style.width) + 4) + '%';
+				x.style.left = (getPercentValue(x.style.left) - 0.82) + '%'
+				setTimeout(&quot;resizeBar()&quot;,40);
+			}else{
+				sendData(goPage);
+			}
+		}
+
+		//sendData('playmusic:music.mp3');
+		//sendData('stopmusic');
+	&lt;/script&gt;
+	&lt;style type=&quot;text/css&quot;&gt;
+
+		a,a:hover{
+			cursor: arrow;
+			text-decoration: none;
+			border: 0;
+		}
+		a img {
+			border: 0;
+		}
+
+		#website {
+			position: absolute;
+			width: 22%;
+			left:22%;
+			top: 95%;
+			text-align: center;
+		}
+
+		#website a{
+			color: #a26949;
+		}
+
+		#website a:hover{
+			color: white;
+		}
+
+		#title {
+			position: absolute;
+			top:0;
+			left:8%;
+			width: 50%;
+			z-index:1000;
+			filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src=&quot;images/title.png&quot;, sizingMethod=&quot;scale&quot;);
+		}
+
+		#springVersion {
+			position: absolute;
+			bottom:0;
+			left:0;
+			width: 100%;
+			height: 20px;
+			z-index:1001;
+			text-align: right;
+			font-size: 16px;
+			color: white;
+		}
+		
+		#modName {
+			position: absolute;
+			top:25%;
+			left:22%;
+			width: 22%;
+			z-index:1001;
+			text-align: center;
+			font-size: 20px;
+			color: #a26949;
+		}
+
+		#campaigns {
+			position: absolute;
+			top:30%;
+			left:22.75%;
+			width: 21%;
+			z-index:1000;
+			filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src=&quot;images/campaigns.png&quot;, sizingMethod=&quot;scale&quot;);
+		}
+		a:hover #campaigns {
+			filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src=&quot;images/campaigns_over.png&quot;, sizingMethod=&quot;scale&quot;);
+		}
+		#missions {
+			position: absolute;
+			top:40%;
+			left:22.75%;
+			width: 21%;
+			z-index:1000;
+			filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src=&quot;images/missions.png&quot;, sizingMethod=&quot;scale&quot;);
+		}
+		a:hover #missions {
+			filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src=&quot;images/missions_over.png&quot;, sizingMethod=&quot;scale&quot;);
+		}
+		#skirmish {
+			position: absolute;
+			top:50%;
+			left:22.75%;
+			width: 21%;
+			z-index:1000;
+			filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src=&quot;images/skirmish.png&quot;, sizingMethod=&quot;scale&quot;);
+		}
+		a:hover #skirmish {
+			filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src=&quot;images/skirmish_over.png&quot;, sizingMethod=&quot;scale&quot;);
+		}
+		#multiplayer {
+			position: absolute;
+			top:60%;
+			left:22.75%;
+			width: 21%;
+			z-index:1000;
+			filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src=&quot;images/multiplayer.png&quot;, sizingMethod=&quot;scale&quot;);
+		}
+		a:hover #multiplayer {
+			filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src=&quot;images/multiplayer_over.png&quot;, sizingMethod=&quot;scale&quot;);
+		}
+		#settings {
+			position: absolute;
+			top:70%;
+			left:22.75%;
+			width: 21%;
+			z-index:1000;
+			filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src=&quot;images/settings.png&quot;, sizingMethod=&quot;scale&quot;);
+		}
+		a:hover #settings {
+			filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src=&quot;images/settings_over.png&quot;, sizingMethod=&quot;scale&quot;);
+		}
+		#quit {
+			position: absolute;
+			top:80%;
+			left:22.75%;
+			width: 21%;
+			z-index:1000;
+			filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src=&quot;images/quit.png&quot;, sizingMethod=&quot;scale&quot;);
+		}
+		a:hover #quit {
+			filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src=&quot;images/quit_over.png&quot;, sizingMethod=&quot;scale&quot;);
+		}
+	&lt;/style&gt;
+&lt;/head&gt;
+&lt;body&gt;
+	&lt;img id=&quot;title&quot; src=&quot;images/title.gif&quot;&gt;&lt;/img&gt;
+	&lt;img src=&quot;images\background.jpg&quot; style=&quot;height:100%;position: absolute; top:0;left:0;z-index:-1&quot;  /&gt;
+	&lt;div id=&quot;bar&quot; style=&quot;position:absolute;left:22%;width:22%;height:100%;filter : alpha(opacity=44);background-color: black&quot;&gt;&lt;/div&gt;
+	&lt;div id=&quot;springVersion&quot;&gt;v[SpringVersion]&lt;/div&gt;
+	&lt;div id=&quot;modName&quot;&gt;[SelectedModName]&lt;/div&gt;
+	&lt;div id=&quot;menu&quot; style=&quot;position: absolute;width:100%;height:100%;top:0;left:0&quot;&gt;
+	&lt;a href=&quot;#&quot; onmouseover=&quot;sendData('playsound:button.wav');&quot;  onclick=&quot;goPage='campaigns';fadeOff();&quot;&gt;&lt;img id=&quot;campaigns&quot; src=&quot;images/campaigns.gif&quot;&gt;&lt;/img&gt;&lt;/a&gt;
+	&lt;a href=&quot;#&quot; onmouseover=&quot;sendData('playsound:button.wav');&quot; onclick=&quot;goPage='missions';fadeOff();&quot;&gt;&lt;img id=&quot;missions&quot; src=&quot;images/missions.gif&quot;&gt;&lt;/img&gt;&lt;/a&gt;
+	&lt;a href=&quot;#&quot; onmouseover=&quot;sendData('playsound:button.wav');&quot; onclick=&quot;goPage='skirmish';fadeOff();&quot;&gt;&lt;img id=&quot;skirmish&quot; src=&quot;images/skirmish.gif&quot;&gt;&lt;/img&gt;&lt;/a&gt;
+	&lt;a href=&quot;lobby:showMultiplayerLobby&quot; onmouseover=&quot;sendData('playsound:button.wav');&quot;&gt;&lt;img id=&quot;multiplayer&quot; src=&quot;images/multiplayer.gif&quot;&gt;&lt;/img&gt;&lt;/a&gt;
+	&lt;a href=&quot;#&quot; onmouseover=&quot;sendData('playsound:button.wav');&quot; onclick=&quot;goPage='localfile:modsettings.html';fadeOff();&quot;&gt;&lt;img id=&quot;settings&quot; src=&quot;images/settings.gif&quot;&gt;&lt;/img&gt;&lt;/a&gt;
+	&lt;a href=&quot;lobby:main&quot; onmouseover=&quot;sendData('playsound:button.wav');&quot;&gt;&lt;img id=&quot;quit&quot; src=&quot;images/quit.gif&quot;&gt;&lt;/img&gt;&lt;/a&gt;
+	&lt;div id=&quot;website&quot;&gt;&lt;a href=&quot;<A HREF="http://taspring.clan-sy.com">http://taspring.clan-sy.com</A>&quot;&gt;Official Website&lt;/a&gt;&lt;/div&gt;
+	&lt;/div&gt;
+&lt;/body&gt;
+&lt;/html&gt;
\ No newline at end of file

Added: trunk/Lobby/TASClient/Interface/modsettings.html
===================================================================
--- trunk/Lobby/TASClient/Interface/modsettings.html	                        (rev 0)
+++ trunk/Lobby/TASClient/Interface/modsettings.html	2008-10-03 15:32:39 UTC (rev 6509)
@@ -0,0 +1,53 @@
+&lt;html&gt;
+&lt;head&gt;
+	&lt;script type=&quot;text/javascript&quot; src=&quot;default.js&quot;&gt;&lt;/script&gt;
+	&lt;script type=&quot;text/javascript&quot;&gt;
+		currentOpacityFadeOff = 100;
+
+		function resizeBar(){
+			x = document.getElementById('bar');
+			if (getPercentValue(x.style.width) &gt; 26) {
+				x.style.width = (getPercentValue(x.style.width) - 4) + '%';
+				x.style.left = (getPercentValue(x.style.left) + 0.82) + '%'
+				setTimeout(&quot;resizeBar()&quot;,40);
+			}else{
+				sendData('back');
+			}
+		}
+
+		function fadeOff(){
+			currentOpacityFadeOff = currentOpacityFadeOff - 25;
+			document.getElementById('contentBlock').style.filter = &quot;alpha(opacity=&quot;+currentOpacityFadeOff+&quot;)&quot;;
+			if (currentOpacityFadeOff &gt; 0) {
+				setTimeout(&quot;fadeOff()&quot;,40);
+			}else{
+				document.getElementById('contentBlock').style.visibility = 'hidden';
+				resizeBar();
+			}
+		}
+	&lt;/script&gt;
+	&lt;style type=&quot;text/css&quot;&gt;
+		@import &quot;default.css&quot;;
+
+		a img{
+			border: 0;
+		}
+	&lt;/style&gt;
+&lt;/head&gt;
+&lt;body style=&quot;background-color: #[clBtnFace]&quot; onload=&quot;selectOption('SkinList','[SelectedSkin]');&quot;&gt;
+	&lt;img src=&quot;images\background.jpg&quot; style=&quot;height:100%;position: absolute; top:0;left:0;z-index:-1&quot;  /&gt;
+	&lt;div id=&quot;bar&quot; style=&quot;position:absolute;left:10%;top:0;width:80%;height:100%;filter : alpha(opacity=44);background-color: black&quot;&gt;&lt;/div&gt;
+	&lt;div id=&quot;contentBlock&quot; style=&quot;border: 0;position:absolute;left:10%;top:0;width:80%;height:100%;&quot;&gt;
+		&lt;div style=&quot;margin:10px 10px 20px 10px;&quot;&gt;
+			&lt;h1&gt;Settings&lt;/h1&gt;
+		&lt;/div&gt;
+		&lt;div style=&quot;margin:10px&quot;&gt;
+			&lt;div style=&quot;margin-bottom: 10px&quot;&gt;Game settings : &lt;a href=&quot;lobby:gamesettings&quot; class=&quot;button&quot; onmouseover=&quot;sendData('playsound:button.wav');&quot;&gt;Open&lt;/a&gt;&lt;/div&gt;
+
+		&lt;/div&gt;
+		&lt;div class=&quot;footer&quot;&gt;
+			&lt;a href=&quot;#&quot; class=&quot;button&quot; style=&quot;float: left;&quot; onmouseover=&quot;sendData('playsound:button.wav');&quot; onclick=&quot;fadeOff();&quot;&gt;Return to main menu&lt;/a&gt;
+		&lt;/div&gt;
+	&lt;/div&gt;
+&lt;/body&gt;
+&lt;/html&gt;
\ No newline at end of file

Added: trunk/Lobby/TASClient/Interface/selectmod.html
===================================================================
--- trunk/Lobby/TASClient/Interface/selectmod.html	                        (rev 0)
+++ trunk/Lobby/TASClient/Interface/selectmod.html	2008-10-03 15:32:39 UTC (rev 6509)
@@ -0,0 +1,24 @@
+&lt;html&gt;
+&lt;head&gt;
+	&lt;script type=&quot;text/javascript&quot; src=&quot;default.js&quot;&gt;&lt;/script&gt;
+	&lt;style type=&quot;text/css&quot;&gt;
+		@import &quot;default.css&quot;;
+
+		a img{
+			border: 0;
+		}
+	&lt;/style&gt;
+&lt;/head&gt;
+&lt;body style=&quot;background-color: #[clBtnFace]&quot;&gt;
+	&lt;img src=&quot;images\background.jpg&quot; style=&quot;height:100%;position: absolute; top:0;left:0;z-index:-1&quot;  /&gt;
+	&lt;div id=&quot;bar&quot; style=&quot;position:absolute;left:10%;top:0;width:80%;height:100%;filter : alpha(opacity=44);background-color: black&quot;&gt;&lt;/div&gt;
+	&lt;div style=&quot;border: 0;position:absolute;left:10%;top:0;width:80%;height: 50px;margin:0;padding:2em;&quot;&gt;
+		&lt;div style=&quot;height: 40px;&quot;&gt;
+			&lt;h1&gt;Select a game please&lt;/h1&gt;
+		&lt;/div&gt;
+		&lt;div style=&quot;width:100%;height:100%;margin:0;padding:0;overflow: auto&quot;&gt;
+			[ModList]
+		&lt;/div&gt;
+	&lt;/div&gt;
+&lt;/body&gt;
+&lt;/html&gt;

Modified: trunk/Lobby/TASClient/Interface/settings.html
===================================================================
--- trunk/Lobby/TASClient/Interface/settings.html	2008-10-03 13:47:09 UTC (rev 6508)
+++ trunk/Lobby/TASClient/Interface/settings.html	2008-10-03 15:32:39 UTC (rev 6509)
@@ -11,7 +11,7 @@
 				x.style.left = (getPercentValue(x.style.left) + 0.82) + '%'
 				setTimeout(&quot;resizeBar()&quot;,40);
 			}else{
-				sendData('main');
+				sendData('back');
 			}
 		}
 

Modified: trunk/Lobby/TASClient/Interface/skirmish.html
===================================================================
--- trunk/Lobby/TASClient/Interface/skirmish.html	2008-10-03 13:47:09 UTC (rev 6508)
+++ trunk/Lobby/TASClient/Interface/skirmish.html	2008-10-03 15:32:39 UTC (rev 6509)
@@ -93,7 +93,7 @@
 			x.style.left = (getPercentValue(x.style.left) + 0.82) + '%'
 			setTimeout(&quot;resizeBar()&quot;,40);
 		}else{
-			sendData('main');
+			sendData('modmain');
 		}
 	}
 
@@ -331,13 +331,7 @@
 		&lt;table id=&quot;tableId&quot; cellpadding=&quot;0&quot; cellspacing=&quot;0&quot; style=&quot;border: 0;position:absolute;left:10%;top:0;width:80%;height:100%;margin:0;padding:0;&quot;&gt;
 			&lt;tr style=&quot;height:30px&quot;&gt;
 				&lt;td&gt;
-					&lt;form action=&quot;&quot; method=&quot;POST&quot;&gt;
-						Select the mod :
-						&lt;select id=&quot;modList&quot; onchange=&quot;sendData('selectmod:'+getSelectedValue('modList'));&quot;&gt;
-							&lt;option value=&quot;&quot;&gt;-Select a mod-&lt;/option&gt;
-							[ModList]
-						&lt;/select&gt;
-					&lt;/form&gt;
+          Current game : [SelectedModName]
 				&lt;/td&gt;
 			&lt;/tr&gt;
 			&lt;tr id=&quot;tabContainer&quot; valign=&quot;top&quot;&gt;

Modified: trunk/Lobby/TASClient/LobbyScriptUnit.pas
===================================================================
--- trunk/Lobby/TASClient/LobbyScriptUnit.pas	2008-10-03 13:47:09 UTC (rev 6508)
+++ trunk/Lobby/TASClient/LobbyScriptUnit.pas	2008-10-03 15:32:39 UTC (rev 6509)
@@ -45,9 +45,13 @@
     protected
       menuIdInc : integer;
       MenuItemList: TList;
+      textBoxStringList: TStringList;
+      textBoxList: TList;
       CS: TCriticalSection;
 
       pyProperties: PPyObject;
+      pyTextBoxes: PPyObject;
+      pyColors: PPyObject;
 
       function GetMenu(name: string): TTBCustomItem;
       function GetMenuSelectedId(menu: TTBCustomItem): string;
@@ -56,6 +60,8 @@
       procedure NotificationClick(Sender: TObject);
       procedure LockGUI;
       procedure UnlockGUI;
+      procedure RefreshRichEditLists;
+      procedure ClearRefs;
 
     public
       constructor Create;
@@ -69,11 +75,12 @@
 
       function GetControlProperties(component: string): Variant;
       function SetControlProperties(component: string; propertiesV : Variant): boolean;
-      function AddPanel(name: string;parent : string):boolean;
-      function AddSplitter(name: string;parent : string):boolean;
-      function AddTabsPanel(name: string;parent : string):boolean;
       function AddTab(caption: string;name: string;tabsPanel : string):boolean;
       function AddForm(name: string;caption: string; style: integer):boolean;
+      function AddControl(name: string;parent: string; className: string):boolean;
+      function AddToRichEdit(richedit : string; msg : string; color : integer): boolean;
+      function GetRichEditList: Variant;
+      function GetColors: Variant;
 
       procedure RemoveFromMenu(id: integer);
   end;
@@ -90,12 +97,8 @@
       pyBattles: PPyObject;
       pyReplays: PPyObject;
       pyGroups: PPyObject;
-      pyTextBoxes: PPyObject;
-      pyColors: PPyObject;
       pyCurrentBattle: PPyObject;
       pyServers: PPyObject;
-      textBoxStringList: TStringList;
-      textBoxList: TList;
       CS: TCriticalSection;
 
     protected
@@ -105,7 +108,6 @@
       function GetPyUser(user: TClient): PPyObject;
       function GetPyGroup(group: TClientGroup): PPyObject;
       procedure RefreshPythonLists;
-      procedure RefreshTextBoxesLists;
       procedure ClearRefs;
       procedure LockCallback;
       procedure UnlockCallback;
@@ -136,7 +138,6 @@
       procedure SetGroups(gV : Variant);
       function GetMaps: Variant;
       function GetMods: Variant;
-      function GetTextBoxList: Variant;
       function HostBattle(nbPlayers: integer; RankLimit: Integer; ModName: string; Description: string; Password: string; UDPHostPort: integer; NatTraversal: integer) : Boolean;
       function HostReplay(replayFile: string; nbPlayers: integer; RankLimit: Integer; Description: string; Password: string; UDPHostPort: integer; NatTraversal: integer) : Boolean;
       function JoinBattle(battleId: integer; Password: String) : Boolean;
@@ -145,8 +146,6 @@
       function SetMyReadyStatus(b: Boolean): Boolean;
       procedure SetMyBattleStatus(spec: boolean);
       function GetCurrentBattle: Variant;
-      function AddToTextBox(textBox : string; msg : string; color : integer): boolean;
-      function GetColors: Variant;
       function GetServers: Variant;
       procedure SetServers(sV : Variant);
       function ChangeMap(mapName: string): Boolean;
@@ -238,7 +237,6 @@
     pyMods := Py_None;
     pyMaps := Py_None;
     pyCurrentBattle := Py_None;
-    pyTextBoxes := Py_None;
     pyReplays := Py_None;
     pyServers := Py_None;
 
@@ -246,26 +244,7 @@
     pyBattleList := TList.Create;
     pyGroupList := TList.Create;
     userRefCountList := TIntegerList.Create;
-    textBoxStringList := TStringList.Create;
-    textBoxList := TList.Create;
     CS := TCriticalSection.Create;
-
-    pyColors := PyDict_New();
-    PyDict_SetItemStringDecRef(pyColors,'Normal',Colors.Normal);
-    PyDict_SetItemStringDecRef(pyColors,'Data',Colors.Data);
-    PyDict_SetItemStringDecRef(pyColors,'Error',Colors.Error);
-    PyDict_SetItemStringDecRef(pyColors,'Info',Colors.Info);
-    PyDict_SetItemStringDecRef(pyColors,'MinorInfo',Colors.MinorInfo);
-    PyDict_SetItemStringDecRef(pyColors,'ChanJoin',Colors.ChanJoin);
-    PyDict_SetItemStringDecRef(pyColors,'ChanLeft',Colors.ChanLeft);
-    PyDict_SetItemStringDecRef(pyColors,'MOTD',Colors.MOTD);
-    PyDict_SetItemStringDecRef(pyColors,'SayEx',Colors.SayEx);
-    PyDict_SetItemStringDecRef(pyColors,'Topic',Colors.Topic);
-    PyDict_SetItemStringDecRef(pyColors,'ClientAway',Colors.ClientAway);
-    PyDict_SetItemStringDecRef(pyColors,'MapModUnavailable',Colors.MapModUnavailable);
-    PyDict_SetItemStringDecRef(pyColors,'BotText',Colors.BotText);
-    PyDict_SetItemStringDecRef(pyColors,'MyText',Colors.MyText);
-    PyDict_SetItemStringDecRef(pyColors,'AdminText',Colors.AdminText);
   end;
 end;
 
@@ -375,7 +354,7 @@
   PostMessage(PythonScriptDebugForm.Handle, WM_REFRESHOUTPUT, 0, 0);
 end;
 
-procedure TCallback.RefreshTextBoxesLists;
+procedure TGUI.RefreshRichEditLists;
 var
   i : integer;
 begin
@@ -521,7 +500,7 @@
     RefreshPythonLists;
 
     for i:=0 to AllClients.Count-1 do
-      PyDict_SetItemString(pyUsers,PChar(TClient(AllClients[i]).Name),PPyObject(pyUserList[i]));
+      PyDict_SetItemString(pyUsers,PChar(String(TClient(AllClients[i]).Name)),PPyObject(pyUserList[i]));
 
     Result := PyObjectAsVariant(pyUsers);
   end;
@@ -798,11 +777,16 @@
   SafeDecRef(pyMods);
   SafeDecRef(pyMaps);
   SafeDecRef(pyCurrentBattle);
-  SafeDecRef(pyTextBoxes);
   SafeDecRef(pyReplays);
   SafeDecRef(pyServers);
 end;
 
+procedure TGUI.ClearRefs;
+begin
+  SafeDecRef(pyProperties);
+  SafeDecRef(pyTextBoxes);
+end;
+
 function TCallback.GetGroups: Variant;
 var
   i: integer;
@@ -886,7 +870,7 @@
   end;
 end;
 
-function TCallback.GetColors: Variant;
+function TGUI.GetColors: Variant;
 begin
   Result := GetPythonEngine.PyObjectAsVariant(pyColors);
 end;
@@ -1103,7 +1087,7 @@
 begin
   Result := True;
 
-  if ScriptHostingRunning or ScriptHostingReplayRunning or (BattleState.Status &lt;&gt; None) then
+  if ScriptHostingRunning or ScriptHostingReplayRunning or (BattleState.Status &lt;&gt; None) or not MainForm.AreWeLoggedIn then
   begin
     Result := False;
     Exit;
@@ -1149,7 +1133,7 @@
 begin
   Result := True;
 
-  if ScriptHostingRunning or (BattleState.Status &lt;&gt; None) then
+  if ScriptHostingRunning or (BattleState.Status &lt;&gt; None) or not MainForm.AreWeLoggedIn then
   begin
     Result := False;
     Exit;
@@ -1240,29 +1224,29 @@
   AcquireMainThread;
 end;
 
-function TCallback.GetTextBoxList: Variant;
+function TGUI.GetRichEditList: Variant;
 begin
-  LockCallback;
+  LockGUI;
   with GetPythonEngine do
   begin
     ClearRefs;
 
-    RefreshTextBoxesLists;
+    RefreshRichEditLists;
 
     pyTextBoxes := StringsToPyList(textBoxStringList);
 
     Result := PyObjectAsVariant(pyTextBoxes)
   end;
-  UnlockCallback;
+  UnlockGUI;
 end;
 
-function TCallback.AddToTextBox(textBox : string; msg : string; color : integer): boolean;
+function TGUI.AddToRichEdit(richedit : string; msg : string; color : integer): boolean;
 var
   i: integer;
 begin
-  RefreshTextBoxesLists;
+  RefreshRichEditLists;
 
-  i := textBoxStringList.IndexOf(textBox);
+  i := textBoxStringList.IndexOf(richedit);
 
   Result := i &gt; -1;
   if Result then
@@ -1282,8 +1266,32 @@
   menuIdInc :=1;
   MenuItemList := TList.Create;
   CS := TCriticalSection.Create;
+  textBoxStringList := TStringList.Create;
+  textBoxList := TList.Create;
 
-  pyProperties := GetPythonEngine.Py_None;
+  with GetPythonEngine do
+  begin
+    pyProperties := Py_None;
+    pyTextBoxes := Py_None;
+
+
+    pyColors := PyDict_New();
+    PyDict_SetItemStringDecRef(pyColors,'Normal',Colors.Normal);
+    PyDict_SetItemStringDecRef(pyColors,'Data',Colors.Data);
+    PyDict_SetItemStringDecRef(pyColors,'Error',Colors.Error);
+    PyDict_SetItemStringDecRef(pyColors,'Info',Colors.Info);
+    PyDict_SetItemStringDecRef(pyColors,'MinorInfo',Colors.MinorInfo);
+    PyDict_SetItemStringDecRef(pyColors,'ChanJoin',Colors.ChanJoin);
+    PyDict_SetItemStringDecRef(pyColors,'ChanLeft',Colors.ChanLeft);
+    PyDict_SetItemStringDecRef(pyColors,'MOTD',Colors.MOTD);
+    PyDict_SetItemStringDecRef(pyColors,'SayEx',Colors.SayEx);
+    PyDict_SetItemStringDecRef(pyColors,'Topic',Colors.Topic);
+    PyDict_SetItemStringDecRef(pyColors,'ClientAway',Colors.ClientAway);
+    PyDict_SetItemStringDecRef(pyColors,'MapModUnavailable',Colors.MapModUnavailable);
+    PyDict_SetItemStringDecRef(pyColors,'BotText',Colors.BotText);
+    PyDict_SetItemStringDecRef(pyColors,'MyText',Colors.MyText);
+    PyDict_SetItemStringDecRef(pyColors,'AdminText',Colors.AdminText);
+  end;
 end;
 
 function TGUI.GetFreeMenuId: integer;
@@ -1421,7 +1429,7 @@
       Exit;
     end;
 
-    m.Add(TSpTBXItem.Create(m.ParentComponent));
+    m.Add(TSpTBXItem.Create(m.Owner));
     with m.Items[m.Count-1] as TSpTBXItem do
     begin
       Caption := itemCaption;
@@ -1455,7 +1463,7 @@
   with GetPythonEngine do
   begin
 
-    m.Add(TSpTBXSubmenuItem.Create(m.ParentComponent));
+    m.Add(TSpTBXSubmenuItem.Create(m.Owner));
     with m.Items[m.Count-1] as TSpTBXSubmenuItem do
     begin
       Caption := itemCaption;
@@ -1576,7 +1584,7 @@
   LockGUI;
   with GetPythonEngine do
   begin
-    SafeDecRef(pyProperties);
+    ClearRefs;
     pyProperties := PyDict_New();
 
 
@@ -1661,53 +1669,25 @@
   end;
 end;
 
-function TGUI.AddPanel(name: string;parent : string):boolean;
-var
-  p: TPanel;
-begin
-  try
-    p := TPanel.Create(GetComponentFromString(parent));
-    p.Parent := GetComponentFromString(parent) as TWinControl;
-    p.Name := name;
-    p.BevelInner := bvNone;
-    p.BevelOuter := bvNone;
-    p.Caption := '';
-    Result := True;
-  except
-    Result := False;
-  end;
-end;
 
-function TGUI.AddSplitter(name: string;parent : string):boolean;
+function TGUI.AddControl(name: string;parent: string; className: string):boolean;
 var
-  p: TSpTBXSplitter;
+  classV: TPersistentClass;
+  control: TWinControl;
+  parentC: TWinControl;
 begin
   try
-    p := TSpTBXSplitter.Create(GetComponentFromString(parent));
-    p.Parent := GetComponentFromString(parent) as TWinControl;
-    p.Name := name;
-    p.ResizeStyle := rsUpdate;
-    p.Align := alTop;
+    parentC := GetComponentFromString(parent) as TWinControl;
+    classV := GetClass(className);
+    control := TWinControlClass(classV).Create(parentC);
+    control.Parent := parentC;
+    control.Name := name;
     Result := True;
   except
     Result := False;
   end;
 end;
 
-function TGUI.AddTabsPanel(name: string;parent : string):boolean;
-var
-  p: TSpTBXTabControl;
-begin
-  try
-    p := TSpTBXTabControl.Create(GetComponentFromString(parent));
-    p.Parent := GetComponentFromString(parent) as TWinControl;
-    p.Name := name;
-    Result := True;
-  except
-    Result := False;
-  end;
-end;
-
 function TGUI.AddTab(caption: string;name: string;tabsPanel : string):boolean;
 var
   p: TSpTBXTabControl;

Modified: trunk/Lobby/TASClient/MainUnit.dfm
===================================================================
--- trunk/Lobby/TASClient/MainUnit.dfm	2008-10-03 13:47:09 UTC (rev 6508)
+++ trunk/Lobby/TASClient/MainUnit.dfm	2008-10-03 15:32:39 UTC (rev 6509)
@@ -1,6 +1,6 @@
 object MainForm: TMainForm
-  Left = 419
-  Top = 218
+  Left = 907
+  Top = 319
   Width = 773
   Height = 535
   Caption = '.'
@@ -6729,6 +6729,10 @@
       Caption = 'Auto Join'
       OnClick = AutoJoin1Click
     end
+    object OpenLogs1: TSpTBXItem
+      Caption = 'Open logs'
+      OnClick = OpenLogs1Click
+    end
   end
   object ArrowList: TImageList
     Left = 496

Modified: trunk/Lobby/TASClient/MainUnit.pas
===================================================================
--- trunk/Lobby/TASClient/MainUnit.pas	2008-10-03 13:47:09 UTC (rev 6508)
+++ trunk/Lobby/TASClient/MainUnit.pas	2008-10-03 15:32:39 UTC (rev 6509)
@@ -207,7 +207,7 @@
   TntStdCtrls, SpTBXEditors, Mask, JvExMask, JvSpin,TntComCtrls,JclUnicode,
   GR32_Image, SpTBXTabs, PythonEngine, AtomPythonEngine,VarPyth, PythonGUIInputOutput,
   WrapDelphi,RichEdit2, ExRichEdit, JvComponentBase, JvMTComponents, class_TIntegerList,
-  TntGraphics;
+  TntGraphics,SpTBXDkPanels, TB2Dock;
 
 const
   CountryNames: array[0..240] of string = (
@@ -640,6 +640,7 @@
     HistoryIndex: Integer;
     AutoScroll: Boolean; // if true, we will scroll rich edit to the new line added
     LogFile: TFileStream;
+    LogFileName: String;
     constructor Create(AOwner: TComponent); override;
     destructor Destroy; override;
   end;
@@ -1157,6 +1158,7 @@
     DefaultArmImage: TImage;
     DefaultSideImage: TImage;
     DefaultCoreImage: TImage;
+    OpenLogs1: TSpTBXItem;
     procedure mnuOpenPrivateChatClick(Sender: TObject);
     procedure mnuSelectBattleClick(Sender: TObject);
     procedure SpTBXItem1Click(Sender: TObject);
@@ -1287,6 +1289,8 @@
     procedure lobbyscriptWrapperInitialization(Sender: TObject);
     procedure RichEditURLClick(Sender: TObject; URL: String);
     procedure mnuTipsClick(Sender: TObject);
+    procedure OpenLogs1Click(Sender: TObject);
+    procedure Button1Click(Sender: TObject);
   published
     MainTitleBar: TSpTBXTitleBar;
     Panel2: TSpTBXPanel;
@@ -2074,6 +2078,7 @@
       FileName := ExtractFilePath(Application.ExeName) + LOG_FOLDER + '\' + (PageControl1.Pages[i] as TMyTabSheet).Caption + '.log';
       try
         (PageControl1.Pages[i] as TMyTabSheet).LogFile := OpenLog(FileName);
+        (PageControl1.Pages[i] as TMyTabSheet).LogFileName := FileName;
         if (PageControl1.Pages[i] as TMyTabSheet).LogFile = nil then raise Exception.Create('');
       except
         AddMainLog('Error: unable to access file: ' + FileName, Colors.Error);
@@ -3253,7 +3258,7 @@
 var
   currentCompleteKey: TStrings;
   lineScript: TStrings;
-  lineWithoutTabs: String;
+  trimedLine: String;
   i: integer;
   key: string;
   value: string;
@@ -3263,22 +3268,22 @@
   Misc.ParseDelimited(lineScript,FScript,EOL,#$A);
   for i:=0 to lineScript.Count-1 do
   begin
-    lineWithoutTabs := StringReplace(lineScript[i],#9,'',[rfReplaceAll]);
-    if (lineWithoutTabs &lt;&gt; '') then
+    trimedLine := Trim(lineScript[i]);
+    if (trimedLine &lt;&gt; '') then
     begin
-      if LeftStr(lineWithoutTabs,1) = '[' then // [KEY]
+      if LeftStr(trimedLine,1) = '[' then // [KEY]
       begin
-        key := MidStr(lineWithoutTabs,2,Pos(']',lineWithoutTabs)-2);
+        key := MidStr(trimedLine,2,Pos(']',trimedLine)-2);
         currentCompleteKey.Add(key);
       end
-      else if LeftStr(lineWithoutTabs,1) = '}' then
+      else if LeftStr(trimedLine,1) = '}' then
       begin
         currentCompleteKey.Delete(currentCompleteKey.Count-1);
       end
-      else if (Length(lineWithoutTabs) &gt; 4) and (currentCompleteKey.Count&gt;0) then // key=value
+      else if (Length(trimedLine) &gt; 4) and (currentCompleteKey.Count&gt;0) then // key=value
       begin
-        key := MidStr(lineWithoutTabs,1,Pos('=',lineWithoutTabs)-1);
-        value := MidStr(lineWithoutTabs,Pos('=',lineWithoutTabs)+1,Pos(';',lineWithoutTabs)-Pos('=',lineWithoutTabs)-1);
+        key := MidStr(trimedLine,1,Pos('=',trimedLine)-1);
+        value := MidStr(trimedLine,Pos('=',trimedLine)+1,Pos(';',trimedLine)-Pos('=',trimedLine)-1);
         CompleteKeyList.Add(LowerCase(Misc.JoinStringList(currentCompleteKey,'/')+'/'+key));
         CompleteOriginalKeyList.Add(Misc.JoinStringList(currentCompleteKey,'/')+'/'+key);
         KeyValueList.Add(value);
@@ -3895,6 +3900,7 @@
   begin
     FileName := ExtractFilePath(Application.ExeName) + LOG_FOLDER + '\' + tmpts.Caption + '.log';
     tmpts.LogFile := OpenLog(FileName);
+    tmpts.LogFileName := FileName;
     if tmpts.LogFile = nil then
       AddMainLog('Error: unable to access file: ' + FileName, Colors.Error)
     else
@@ -6851,7 +6857,7 @@
       msgLines.Add((Sender as TTntMemo).Lines.Strings[i]);
     s := (Sender as TTntMemo).Lines.Strings[0];
     (Sender as TTntMemo).Text := '';
-    if s = '' then Exit;
+    if (s = '') and ((Sender as TTntMemo).Lines.Count = 1) then Exit;
 
     with ((Sender as TTntMemo).Parent as TMyTabSheet) do
     begin
@@ -6859,11 +6865,13 @@
       HistoryIndex := History.Count;
     end;
 
-    if (s[1] = '/') or (s[1] = '.') then
-    begin
-      ProcessCommand(Copy(s, 2, Length(s)-1), False);
-      Exit;
-    end;
+    if Length(s) &gt; 1 then
+      if (s[1] = '/') or (s[1] = '.') then
+      begin
+        ProcessCommand(Copy(s, 2, Length(s)-1), False);
+        Exit;
+      end;
+
     if ((Sender as TTntMemo).Parent as TMyTabSheet).Caption[1] = '$' then
     begin
       sl := StringParser.ParseString(s, ' ');
@@ -6879,7 +6887,8 @@
           if ((Sender as TTntMemo).Parent as TMyTabSheet).Caption[1] = '#' then
             TryToSendCommand('SAY',Copy(((Sender as TTntMemo).Parent as TMyTabSheet).Caption, 2, Length(((Sender as TTntMemo).Parent as TMyTabSheet).Caption))+' '+msgLines[i])
           else
-            TryToSendCommand('SAYPRIVATE',TClient(((Sender as TTntMemo).Parent as TMyTabSheet).Clients[0]).Name+' '+msgLines[i]);
+            if ((Sender as TTntMemo).Parent as TMyTabSheet).Clients.Count &gt; 0 then
+              TryToSendCommand('SAYPRIVATE',TClient(((Sender as TTntMemo).Parent as TMyTabSheet).Clients[0]).Name+' '+msgLines[i]);
     end;
   end
   else if Key = VK_UP then
@@ -8665,14 +8674,15 @@
 begin
   with (Sender as TSpTBXPopupMenu) do
   begin
-    (Items[Items.IndexOf(AutoScroll1)] as TSpTBXItem).Visible := RunningUnderWine;
-    (Items[Items.IndexOf(AutoScroll1)] as TSpTBXItem).Checked := (PageControl1.ActivePage as TMyTabSheet).AutoScroll;
-    (Items[Items.IndexOf(AutoJoin1)] as TSpTBXItem).Visible := (PageControl1.ActivePage.Caption &lt;&gt; LOCAL_TAB) and (PageControl1.ActivePage.Caption &lt;&gt; '#main') and (LeftStr(PageControl1.ActivePage.Caption,1) = '#');
-    (Items[Items.IndexOf(AutoJoin1)] as TSpTBXItem).Checked := True;
+    OpenLogs1.Visible := (PageControl1.ActivePage as TMyTabSheet).LogFile &lt;&gt; nil;
+    AutoScroll1.Visible := RunningUnderWine;
+    AutoScroll1.Checked := (PageControl1.ActivePage as TMyTabSheet).AutoScroll;
+    AutoJoin1.Visible := (PageControl1.ActivePage.Caption &lt;&gt; LOCAL_TAB) and (PageControl1.ActivePage.Caption &lt;&gt; '#main') and (LeftStr(PageControl1.ActivePage.Caption,1) = '#');
+    AutoJoin1.Checked := True;
     for i:=0 to PerformForm.CommandsListBox.Count-1 do
       if (AnsiUpperCase(PerformForm.CommandsListBox.Items[i]) = '/J '+AnsiUpperCase(PageControl1.ActivePage.Caption)) or (AnsiUpperCase(PerformForm.CommandsListBox.Items[i]) = '/JOIN '+AnsiUpperCase(PageControl1.ActivePage.Caption)) then
         Exit;
-    (Items[Items.IndexOf(AutoJoin1)] as TSpTBXItem).Checked := False;
+    AutoJoin1.Checked := False;
   end;
 end;
 
@@ -8789,7 +8799,7 @@
 
 procedure TMainForm.ConnectButtonClick(Sender: TObject);
 begin
-  if (Status.ConnectionState &lt;&gt; Connected) and Preferences.UseLogonForm then
+  if (Status.ConnectionState = Disconnected) and Preferences.UseLogonForm then
   begin
     LogonForm.Show;
     Exit;
@@ -10216,7 +10226,7 @@
   begin
     html := StringReplace(html,#$A,'',[rfReplaceAll]);
     DownloadFile.URL := '<A HREF="http://evolutionrts.info/">http://evolutionrts.info/</A>'+html;
-    DownloadFile.FileName := 'maps\'+Misc.ExtractFileNameFromUrl(DownloadFile.URL);
+    DownloadFile.FileName := 'maps\'+Misc.ExtractAfterLastSlash(DownloadFile.URL);
     DownloadFile.ServerOptions := 8;
     PostMessage(HttpGetForm.Handle, WM_STARTDOWNLOAD, 0, 0);
   end;
@@ -10767,6 +10777,7 @@
 procedure TMainForm.initLobbyScript;
 begin
   if Preferences.DisableScripts then Exit;
+  RegisterClasses([TSpTBXDock, TSpTBXMultiDock, TSpTBXToolbar, TSpTBXDockablePanel, TSpTBXTabSet, TSpTBXTabControl, TSpTBXStatusBar, TSpTBXLabel, TSpTBXCheckBox, TSpTBXRadioButton, TSpTBXProgressBar, TSpTBXTrackBar, TSpTBXSplitter, TSpTBXPanel, TSpTBXGroupBox, TSpTBXRadioGroup, TSpTBXEdit,TSpTBXSpinEdit, TSpTBXComboBox,TSpTBXListBox, TSpTBXCheckListBox, TExRichEdit, TImage32]);
   PyEngine.LoadDll;
   with GetPythonEngine do
   begin
@@ -10850,4 +10861,20 @@
   TipsForm.ShowTips(0,True);
 end;
 
+procedure TMainForm.OpenLogs1Click(Sender: TObject);
+begin
+  ShellExecute(0,'open',PChar((PageControl1.ActivePage as TMyTabSheet).LogFileName),nil,nil,SW_SHOWNORMAL);
+end;
+
+procedure TMainForm.Button1Click(Sender: TObject);
+var
+  a: TPersistentClass;
+  b: TWinControl;
+begin
+  RegisterClasses([TPanel, TButton]);
+  a := GetClass('TButton');
+  b := TWinControlClass(a).Create(MainForm);
+  b.Parent := MainForm;
+end;
+
 end.

Modified: trunk/Lobby/TASClient/ManageGroups.dfm
===================================================================
--- trunk/Lobby/TASClient/ManageGroups.dfm	2008-10-03 13:47:09 UTC (rev 6508)
+++ trunk/Lobby/TASClient/ManageGroups.dfm	2008-10-03 15:32:39 UTC (rev 6509)
@@ -124,12 +124,9 @@
       Top = 40
       Width = 265
       Height = 297
-      Hint = 
-        'Act like if all member of the group were in the same clan when b' +
-        'alancing teams.'
       Caption = 'SpTBXPanel2'
       ParentShowHint = False
-      ShowHint = True
+      ShowHint = False
       TabOrder = 4
       object Label1: TLabel
         Left = 8
@@ -422,6 +419,11 @@
         Top = 272
         Width = 14
         Height = 15
+        Hint = 
+          'Act like if all member of the group were in the same clan when b' +
+          'alancing teams.'
+        ParentShowHint = False
+        ShowHint = True
         TabOrder = 26
         OnClick = BalanceInSameTeamCheckBoxClick
       end

Modified: trunk/Lobby/TASClient/MenuFormUnit.dfm
===================================================================
--- trunk/Lobby/TASClient/MenuFormUnit.dfm	2008-10-03 13:47:09 UTC (rev 6508)
+++ trunk/Lobby/TASClient/MenuFormUnit.dfm	2008-10-03 15:32:39 UTC (rev 6509)
@@ -1,6 +1,6 @@
 object MenuForm: TMenuForm
-  Left = 987
-  Top = 299
+  Left = 765
+  Top = 302
   BorderStyle = bsNone
   Caption = 'MenuForm'
   ClientHeight = 671

Modified: trunk/Lobby/TASClient/MenuFormUnit.pas
===================================================================
--- trunk/Lobby/TASClient/MenuFormUnit.pas	2008-10-03 13:47:09 UTC (rev 6508)
+++ trunk/Lobby/TASClient/MenuFormUnit.pas	2008-10-03 15:32:39 UTC (rev 6509)
@@ -10,17 +10,39 @@
 type
   TPageType = (Main, ModMain, CampaignsMenu, Campaign, CampaignMission, MissionsMenu, Mission, Skirmish, Loading);
 
-  TMission =
-  record
-    FileName: string;
-    UseHTML: boolean;
-    descriptor: TTDFParser;
-  end;
+  TCampaign = class
+  protected
+    FLuaFileName: string;
+    FLuaFile: string;
+    FName: string;
+    FShortDesc: string;
+    FIncrustedHtml: boolean;
+    FLinearCampaign: boolean;
+    FIsCampaign: boolean;
+    FCampaignProgressDir: string;
+    FCurrentReturnLua: string;
+    FWarmapPath: string;
 
-  TCampaign =
-  record
-    FileName: string;
-    descriptor: TTDFParser;
+    FNextMissionsName: TStringList;
+    FNextMissionsScriptPath: TStringList;
+
+    FTemplateVarName: TStringList;
+    FTemplateVarValue: TStringList;
+  public
+    constructor Create(luaFileName: string);
+
+    procedure GetCurrentLuaFile;
+    procedure LoadReturnFile;
+    //procedure ResetCampaign;
+
+    property CampaignName: string read FName;
+    property ShortDesc: string read FShortDesc;
+    property IncrustedHtml: boolean read FIncrustedHtml;
+    property IsCampaign: boolean read FIsCampaign;
+    property LinearCampaign: boolean read FLinearCampaign;
+    property WarmapPath: string read FWarmapPath;
+    property TemplateVarName: TStringList read FTemplateVarName;
+    property TemplateVarValue: TStringList read FTemplateVarValue;
   end;
 
   TAIItem =
@@ -69,17 +91,16 @@
     HookID: THandle;
     AutorisedURLFiles: TStringList;
     MenuCurrentPath: String;
-    MissionCurrentPath: string;
-    CampaignCurrentPath: string;
+    ModMenuPath : String;
+    LoadMenuFromMod: Boolean;
     CurrentPath: string;
-    CurrentMissionIndex: integer;
     CurrentCampaignIndex: integer;
-    CurrentCampaignMission: TMission;
     CurrentWinStep: string;
     CurrentLostStep: string;
     BrowseHistory: TStack;
     soundValue: string;
     skinList: TStringList;
+    currentProfileName: string;
 
     springExeVersion: string;
     mapListHtmlCode: string;
@@ -105,8 +126,7 @@
     DiminishMM: Boolean;
     LoadingMessage: string;
     DisabledUnitList: TStringList;
-
-    MissionList: TList;
+    
     CampaignList: TList;
 
     MePlayer:
@@ -134,7 +154,6 @@
     function GetLuaHtmlCode(options: TList): String;
     procedure ColorCallBack(const AName: String);
     function getBotIndex(id: integer): integer;
-    procedure LoadMissions;
     procedure LoadCampaigns;
   public
     htmlBrowser: TWebBrowserWrapper;
@@ -146,8 +165,6 @@
     procedure StartSkirmish;
     procedure StartMission;
     function GenerateScript(FileName: string):boolean;
-    procedure ExtractMissionFiles(FileName: string);
-    procedure ExtractCampaignFiles(FileName: string);
     function playerHasWon(scriptFileName: string): boolean;
     procedure SaveSettings;
     procedure LoadSettings;
@@ -186,6 +203,167 @@
   end;
 end;
 
+constructor TCampaign.Create(luaFileName: string);
+var
+  fileHnd : integer;
+  size: integer;
+  sl: TStringList;
+begin
+  FNextMissionsName := TStringList.Create;
+  FNextMissionsScriptPath := TStringList.Create;
+  FTemplateVarName := TStringList.Create;
+  FTemplateVarValue := TStringList.Create;
+
+  FLuaFileName := luaFileName;
+  fileHnd := Utility.OpenFileVFS(PChar(luaFileName));
+  if fileHnd = 0 then
+    Raise Exception.Create('Lua file not found : '+luaFileName);
+  size := Utility.FileSizeVFS(fileHnd);
+  SetLength(FLuaFile,size);
+  Utility.ReadFileVFS(fileHnd,PChar(FLuaFile),size);
+  Utility.CloseFileVFS(fileHnd);
+
+  lpOpenSource(PChar(FLuaFile),'r');
+
+  if Utility.lpExecute = 0 then
+    Raise Exception.Create('Invalid lua file : '+luaFileName);
+
+  if Utility.lpGetKeyExistsStr('name') = 0 then
+    Raise Exception.Create('Campaign doesn''''t have a name : '+luaFileName);
+
+  FName := Utility.lpGetStrKeyStrVal('name','');
+  FShortDesc := Utility.lpGetStrKeyStrVal('shortdesc','');
+  FIncrustedHtml := IntToBool(Utility.lpGetStrKeyBoolVal('incrustedhtml',1));
+  FIsCampaign := IntToBool(Utility.lpGetStrKeyBoolVal('iscampaign',1));
+  FLinearCampaign := False;
+
+  Utility.lpClose;
+
+  // constructing the progress dir (adding the profile name to the path)
+  FCampaignProgressDir := ExtractBeforeLastSlash(luaFileName);
+  sl := TStringList.Create;
+  ParseDelimited(sl,FCampaignProgressDir,'/','');
+  sl.Insert(1,MenuForm.currentProfileName);
+  FCampaignProgressDir := JoinStringList(sl,'/');
+
+  // get the latest mission accomplished return file
+  self.GetCurrentLuaFile;
+end;
+
+procedure TCampaign.GetCurrentLuaFile;
+var
+  missionsAccomplishedList: TStringList;
+  fileHnd,size,res: integer;
+  luaContent: string;
+  progressPath: string;
+  i: integer;
+  tmpStr: string;
+begin
+  missionsAccomplishedList := TStringList.Create;
+
+  // open the progress.lua
+  progressPath := ExtractBeforeLastSlash(FLuaFileName)+'/progress.lua';
+  fileHnd := Utility.OpenFileVFS(PChar(progressPath));
+  if fileHnd &lt;&gt; 0 then
+  begin
+    size := Utility.FileSizeVFS(fileHnd);
+    SetLength(luaContent,size);
+    Utility.ReadFileVFS(fileHnd,PChar(luaContent),size);
+    Utility.CloseFileVFS(fileHnd);
+
+    // parse the progress.lua file
+    Utility.lpOpenSource(PChar(luaContent),'r');
+
+    if Utility.lpExecute = 0 then
+      Raise Exception.Create('Invalid lua file : '+progressPath);
+
+    for i:=1 to Utility.lpGetIntKeyListCount do
+    begin
+      if not IntToBool(Utility.lpGetKeyExistsInt(i)) then
+        Raise Exception.Create('Invalid progress.lua file (keys) : '+progressPath);
+      tmpStr := Utility.lpGetIntKeyStrVal(i,'');
+      if tmpStr = '' then
+        Raise Exception.Create('Invalid progress.lua file (values) : '+progressPath);
+      missionsAccomplishedList.Add(tmpStr);
+    end;
+  end;
+
+  if missionsAccomplishedList.Count &gt; 0 then
+    FCurrentReturnLua := FCampaignProgressDir + '/' + missionsAccomplishedList[missionsAccomplishedList.Count-1]
+  else
+    FCurrentReturnLua := FLuaFileName;
+end;
+
+procedure TCampaign.LoadReturnFile;
+var
+  fileHnd,size: integer;
+  content : string;
+  i: integer;
+  tmpStr: string;
+begin
+  fileHnd := Utility.OpenFileVFS(PChar(FCurrentReturnLua));
+  if fileHnd = 0 then
+    Raise Exception.Create('Lua file not found : '+FCurrentReturnLua);
+  size := Utility.FileSizeVFS(fileHnd);
+  SetLength(content,size);
+  Utility.ReadFileVFS(fileHnd,PChar(content),size);
+  Utility.CloseFileVFS(fileHnd);
+
+  lpOpenSource(PChar(content),'r');
+
+  if Utility.lpExecute = 0 then
+    Raise Exception.Create('Invalid lua file : '+FCurrentReturnLua);
+
+  if Utility.lpGetKeyExistsStr('nextmissionlist') = 0 then
+    Raise Exception.Create('Campaign doesn''''t have a nextmissionlist : '+FCurrentReturnLua);
+
+  Utility.lpSubTableStr('nextmissionlist');
+
+  if Utility.lpGetKeyExistsStr('warmap') = 0 then
+    Raise Exception.Create('Campaign doesn''''t have a warmap : '+FCurrentReturnLua);
+
+  FWarmapPath := Utility.lpGetStrKeyStrVal('warmap','');
+
+  if FWarmapPath = '' then
+    Raise Exception.Create('Campaign doesn''''t have a valid warmap : '+FCurrentReturnLua);
+
+  for i:=1 to Utility.lpGetIntKeyListCount do
+  begin
+    if not IntToBool(Utility.lpGetKeyExistsInt(i)) then
+      Raise Exception.Create('Invalid next missions (keys) : '+FCurrentReturnLua);
+    Utility.lpSubTableInt(i);
+    tmpStr := Utility.lpGetStrKeyStrVal('name','');
+    if tmpStr = '' then
+      Raise Exception.Create('Mission name empty : '+FCurrentReturnLua);
+    FNextMissionsName.Add(tmpStr);
+    tmpStr := Utility.lpGetStrKeyStrVal('script','');
+    if tmpStr = '' then
+      Raise Exception.Create('Mission script empty : '+FCurrentReturnLua);
+    FNextMissionsScriptPath.Add(tmpStr);
+    Utility.lpPopTable;
+  end;
+  Utility.lpPopTable;
+
+  if Utility.lpGetKeyExistsStr('template') &lt;&gt; 0 then
+  begin
+    Utility.lpSubTableStr('template');
+
+    for i:=0 to Utility.lpGetStrKeyListCount-1 do
+    begin
+      tmpStr := Utility.lpGetStrKeyListEntry(i);
+
+      FTemplateVarName.Add(tmpStr);
+      FTemplateVarValue.Add(Utility.lpGetStrKeyStrVal(PChar(tmpStr),''));
+    end;
+
+    Utility.lpPopTable;
+  end;
+
+
+  Utility.lpClose;
+end;
+
+
 procedure TMenuForm.CreateParams(var Params: TCreateParams);
 begin
   inherited CreateParams(Params);
@@ -215,9 +393,7 @@
   AIPlayerList := TList.Create;
   DisabledUnitList := TStringList.Create;
   freeIds := TIntegerList.Create;
-  MissionList := TList.Create;
   CampaignList := TList.Create;
-  CurrentCampaignMission.descriptor := TTDFParser.Create('');
   BrowseHistory := TStack.Create;
   skinList := TStringList.Create;
   MenuLoaded := False;
@@ -240,6 +416,7 @@
   StartMetal := 1000;
   StartEnergy := 1000;
   MaxUnits := 5000;
+  currentProfileName := 'default';
 
   LoadSettings;
 
@@ -250,8 +427,7 @@
   else
     MenuCurrentPath := GetLongPathName(GetEnvironmentVariable('TEMP'))+'\tasclientgui\';
 
-  MissionCurrentPath := MenuCurrentPath+'Mission\';
-  CampaignCurrentPath := MenuCurrentPath+'Campaign\';
+  ModMenuPath := GetLongPathName(GetEnvironmentVariable('TEMP'))+'\tasclientmodgui\';
 
   AutorisedURLFiles := TStringList.Create;
   
@@ -373,7 +549,6 @@
   tmpStr: string;
   templateStr: string;
   sl: TStringList;
-  tmpMission: TMission;
   browsepage: ^TBrowsePage;
 begin
   sl := TStringList.Create;
@@ -383,15 +558,9 @@
   browsepage^.PageType := pageType;
   BrowseHistory.Push(browsepage);
 
-  if pageType = CampaignMission then
-    tmpMission := CurrentCampaignMission
-  else if pageType = Mission then
-    tmpMission := TMission(MissionList[CurrentMissionIndex]^);
 
-  if ((pageType = Mission) or (pageType = CampaignMission)) and tmpMission.UseHTML then
-    CurrentPath := MissionCurrentPath
-  else if (pageType = Campaign) then
-    CurrentPath := CampaignCurrentPath
+  if LoadMenuFromMod then
+    CurrentPath := ModMenuPath
   else
     CurrentPath := MenuCurrentPath;
 
@@ -422,55 +591,20 @@
     htmlCode := StringReplace(htmlCode,'[MSG]',LoadingMessage,[rfIgnoreCase,rfReplaceAll]);
   end;
 
-  if (pageType = Campaign) then
-  begin
-    with TCampaign(CampaignList[CurrentCampaignIndex]^) do
-    begin
-      htmlCode := StringReplace(htmlCode,'[CampaignId]',IntToStr(CurrentCampaignIndex),[rfIgnoreCase,rfReplaceAll]);
-      htmlCode := StringReplace(htmlCode,'[CampaignName]',descriptor.ReadKeyValue('campaign/name'),[rfIgnoreCase,rfReplaceAll]);
-
-      if descriptor.ReadKeyValue('campaign/IncludeHtml') = '1' then
-      begin
-        varHtmlCode := htmlCode;
-
-        htmlCode := Misc.ReadFile2(CurrentPath+'defaultCampaignSkin.html');
-
-        htmlCode := StringReplace(htmlCode,'[CampaignContent]',varHtmlCode,[rfIgnoreCase,rfReplaceAll]);
-      end;
-    end;
-  end;
-
-  if (pageType = Mission) or (pageType = CampaignMission) then
-  begin
-    with tmpMission do
-    begin
-      htmlCode := StringReplace(htmlCode,'[MissionId]',IntToStr(CurrentMissionIndex),[rfIgnoreCase,rfReplaceAll]);
-      htmlCode := StringReplace(htmlCode,'[MissionName]',descriptor.ReadKeyValue('mission/name'),[rfIgnoreCase,rfReplaceAll]);
-      htmlCode := StringReplace(htmlCode,'[MissionDescription]',descriptor.ReadKeyValue('mission/description'),[rfIgnoreCase,rfReplaceAll]);
-      htmlCode := StringReplace(htmlCode,'[MissionBriefing]',descriptor.ReadKeyValue('mission/briefing'),[rfIgnoreCase,rfReplaceAll]);
-
-      if UseHTML and (descriptor.ReadKeyValue('mission/IncludeHtml') = '1') then
-      begin
-        varHtmlCode := htmlCode;
-
-        htmlCode := Misc.ReadFile2(CurrentPath+'defaultMissionSkin.html');
-
-        htmlCode := StringReplace(htmlCode,'[MissionContent]',varHtmlCode,[rfIgnoreCase,rfReplaceAll]);
-      end;
-    end;
-  end;
-
   if (pageType = CampaignsMenu) then // [CampaignList]
   begin
     templateStr := ReadFile2(CurrentPath+'campaignItem.html');
     varHtmlCode := '';
     for i := 0 to CampaignList.Count-1  do
     begin
-      tmp := templateStr;
-      tmp := StringReplace(tmp,'[CampaignId]',IntToStr(i),[rfReplaceAll,rfIgnoreCase]);
-      tmp := StringReplace(tmp,'[CampaignName]',TCampaign(CampaignList[i]^).descriptor.ReadKeyValue('campaign/name'),[rfReplaceAll,rfIgnoreCase]);
-      tmp := StringReplace(tmp,'[CampaignDescription]',TCampaign(CampaignList[i]^).descriptor.ReadKeyValue('campaign/description'),[rfReplaceAll,rfIgnoreCase]);
-      varHtmlCode := varHtmlCode + tmp;
+      if TCampaign(CampaignList[i]).IsCampaign then
+      begin
+        tmp := templateStr;
+        tmp := StringReplace(tmp,'[CampaignId]',IntToStr(i),[rfReplaceAll,rfIgnoreCase]);
+        tmp := StringReplace(tmp,'[CampaignName]',TCampaign(CampaignList[i]).CampaignName,[rfReplaceAll,rfIgnoreCase]);
+        tmp := StringReplace(tmp,'[CampaignDescription]',TCampaign(CampaignList[i]).ShortDesc,[rfReplaceAll,rfIgnoreCase]);
+        varHtmlCode := varHtmlCode + tmp;
+      end;
     end;
     htmlCode := StringReplace(htmlCode,'[CampaignList]',varHtmlCode,[rfIgnoreCase,rfReplaceAll]);
   end;
@@ -479,13 +613,16 @@
   begin
     templateStr := ReadFile2(CurrentPath+'missionItem.html');
     varHtmlCode := '';
-    for i := 0 to MissionList.Count-1  do
+    for i := 0 to CampaignList.Count-1  do
     begin
-      tmp := templateStr;
-      tmp := StringReplace(tmp,'[MissionId]',IntToStr(i),[rfReplaceAll,rfIgnoreCase]);
-      tmp := StringReplace(tmp,'[MissionName]',TMission(MissionList[i]^).descriptor.ReadKeyValue('mission/name'),[rfReplaceAll,rfIgnoreCase]);
-      tmp := StringReplace(tmp,'[MissionDescription]',TMission(MissionList[i]^).descriptor.ReadKeyValue('mission/description'),[rfReplaceAll,rfIgnoreCase]);
-      varHtmlCode := varHtmlCode + tmp;
+      if not TCampaign(CampaignList[i]).IsCampaign then
+      begin
+        tmp := templateStr;
+        tmp := StringReplace(tmp,'[MissionId]',IntToStr(i),[rfReplaceAll,rfIgnoreCase]);
+        tmp := StringReplace(tmp,'[MissionName]',TCampaign(CampaignList[i]).CampaignName,[rfReplaceAll,rfIgnoreCase]);
+        tmp := StringReplace(tmp,'[MissionDescription]',TCampaign(CampaignList[i]).ShortDesc,[rfReplaceAll,rfIgnoreCase]);
+        varHtmlCode := varHtmlCode + tmp;
+      end;
     end;
     htmlCode := StringReplace(htmlCode,'[MissionList]',varHtmlCode,[rfIgnoreCase,rfReplaceAll]);
   end;
@@ -513,7 +650,8 @@
     htmlCode := StringReplace(htmlCode,'[STARTENERGY]',IntToStr(StartEnergy),[rfIgnoreCase,rfReplaceAll]);
     htmlCode := StringReplace(htmlCode,'[MAXUNITS]',IntToStr(MaxUnits),[rfIgnoreCase,rfReplaceAll]);
   end;
-  if (pageType = Skirmish) then // [MODLIST]
+
+  if (pageType = Main) then // [MODLIST]
   begin
     templateStr := ReadFile2(CurrentPath+'modItem.html');
     varHtmlCode := '';
@@ -525,14 +663,19 @@
       varHtmlCode := varHtmlCode + tmp;
     end;
     htmlCode := StringReplace(htmlCode,'[MODLIST]',varHtmlCode,[rfIgnoreCase,rfReplaceAll]);
+  end;
+  if pageType &lt;&gt; Main then
+  begin
     htmlCode := StringReplace(htmlCode,'[SelectedModId]',IntToStr(Utility.ModList.IndexOf(BattleForm.CurrentModName)),[rfIgnoreCase,rfReplaceAll]);
     htmlCode := StringReplace(htmlCode,'[SelectedModName]',BattleForm.CurrentModName,[rfIgnoreCase,rfReplaceAll]);
   end;
+
   if (pageType = Skirmish) then // [MODOPTIONLIST] [MAPOPTIONLIST]
   begin
     htmlCode := StringReplace(htmlCode,'[MODOPTIONLIST]',GetLuaHtmlCode(BattleForm.ModOptionsList),[rfIgnoreCase,rfReplaceAll]);
     htmlCode := StringReplace(htmlCode,'[MAPOPTIONLIST]',GetLuaHtmlCode(BattleForm.MapOptionsList),[rfIgnoreCase,rfReplaceAll]);
   end;
+
   if (pageType = Skirmish) then // [AILIST]
   begin
 
@@ -548,6 +691,7 @@
 
     htmlCode := StringReplace(htmlCode,'[AILIST]',varHtmlCode,[rfIgnoreCase,rfReplaceAll]);
   end;
+
   if (pageType = Skirmish) then // [UNITLIST]
   begin
     varHtmlCode := '';
@@ -565,6 +709,7 @@
 
     htmlCode := StringReplace(htmlCode,'[UNITLIST]',varHtmlCode,[rfIgnoreCase,rfReplaceAll]);
   end;
+  
   if (pageType = Skirmish) then // [PlayerList] [PlayerBoxList] [NbPlayers]
   begin
     // sides
@@ -652,13 +797,41 @@
     htmlCode := StringReplace(htmlCode,'[NbPlayers]',IntToStr(1+AIPlayerList.Count),[rfIgnoreCase,rfReplaceAll]);
   end;
 
+  if (pageType = Campaign) or (pageType = Mission) then
+  begin
+    with TCampaign(CampaignList[CurrentCampaignIndex]) do
+    begin
+      htmlCode := StringReplace(htmlCode,'[CampaignId]',IntToStr(CurrentCampaignIndex),[rfIgnoreCase,rfReplaceAll]);
+      htmlCode := StringReplace(htmlCode,'[CampaignName]',CampaignName,[rfIgnoreCase,rfReplaceAll]);
 
+      for i:=0 to TemplateVarName.Count-1 do
+        htmlCode := StringReplace(htmlCode,'['+TemplateVarName[i]+']',TemplateVarValue[i],[rfIgnoreCase,rfReplaceAll]);
+
+      if IncrustedHtml then
+      begin
+        varHtmlCode := htmlCode;
+
+        if pageType = Mission then
+          htmlCode := Misc.ReadFile2(CurrentPath+'defaultMissionSkin.html')
+        else
+          htmlCode := Misc.ReadFile2(CurrentPath+'defaultCampaignSkin.html');
+
+        htmlCode := StringReplace(htmlCode,'[CampaignContent]',varHtmlCode,[rfIgnoreCase,rfReplaceAll]);
+      end;
+    end;
+  end;
+
+
   for i:=0 to ColorsList.Count-1 do
     htmlCode := StringReplace(htmlCode,'['+ColorsList[i]+']',IntToHex(Misc.ColorToStandardRGB(ColorToRGB(StringToColor(ColorsList[i]))),6),[rfIgnoreCase,rfReplaceAll]);
 
   htmlCode := replaceParams(htmlCode,fileName,'LOBBY:LOADPARAM',paramNames,paramValues);
   htmlCode := replaceParams(htmlCode,fileName,'LOBBY:LOADSETTINGS',settingsNames,settingsValues);
 
+  // make sure the file can be loaded
+  if AutorisedURLFiles.IndexOf(ExtractFilePath(CurrentPath+fileName)+'temp654dsq.html') = -1 then
+    AutorisedURLFiles.Add(ExtractFilePath(CurrentPath+fileName)+'temp654dsq.html');
+    
   // save new html file and open it
   SaveFile(ExtractFilePath(CurrentPath+fileName)+'temp654dsq.html',htmlCode);
   //Sleep(100); // to fix some loading bugs
@@ -775,7 +948,7 @@
 
 procedure TMenuForm.FormShow(Sender: TObject);
 begin
-  if not MenuLoaded then
+  if not MenuLoaded and not RunningWithMainMenuDev then
   begin
     MessageDlg('An error occured during the Single Player skin loading. Program will now exit ...',mtError,[mbOk],0);
     Application.Terminate;
@@ -786,10 +959,9 @@
   SaveIERegistry;
   springExeVersion := Utility.AcquireSpringVersion;
 
-  AutorisedURLFiles.Add(MenuCurrentPath+'main.html');
+  //AutorisedURLFiles.Add(MenuCurrentPath+'main.html');
   AutorisedURLFiles.Add(MenuCurrentPath+'temp654dsq.html');
-  AutorisedURLFiles.Add(MissionCurrentPath+'temp654dsq.html');
-  AutorisedURLFiles.Add(CampaignCurrentPath+'temp654dsq.html');
+  AutorisedURLFiles.Add(ModMenuPath+'temp654dsq.html');
 
   ListSkins;
 
@@ -833,8 +1005,9 @@
 var
   mapIndex: integer;
   tmp: string;
-  tmpMission: TMission;
+  //tmpMission: TMission;
 begin
+{
   if TBrowsePage(BrowseHistory.Peek^).PageType = CampaignMission then
     tmpMission := CurrentCampaignMission
   else
@@ -887,7 +1060,7 @@
     end;
   except
     Application.MessageBox('An error occured while starting the mission.', 'Error', MB_ICONEXCLAMATION);
-  end;
+  end;}
 end;
 
 function TMenuForm.GenerateScript(FileName: string):boolean;
@@ -1149,18 +1322,23 @@
     end;
     if LowerCase(command) = 'main' then
     begin
+      LoadMenuFromMod := False;
       LoadMenu('main.html',Main);
       Exit;
     end;
+    if LowerCase(command) = 'modmain' then
+    begin
+      if BattleForm.CurrentModName = '' then Exit;
+      LoadMenu('modmain.html',ModMain);
+      Exit;
+    end;
     if LowerCase(command) = 'campaigns' then
     begin
-      LoadCampaigns;
       LoadMenu('campaigns.html',CampaignsMenu);
       Exit;
     end;
     if LowerCase(command) = 'missions' then
     begin
-      LoadMissions;
       LoadMenu('missions.html',MissionsMenu);
       Exit;
     end;
@@ -1182,7 +1360,6 @@
     begin
       browsePage := BrowseHistory.Pop;
       browsePage := BrowseHistory.Pop;
-      LoadMissions;
       LoadMenu(browsePage^.PageName,browsePage^.PageType);
       Exit;
     end;
@@ -1233,31 +1410,28 @@
     if LeftStr(LowerCase(command),14) = 'selectmission:' then
     begin
       tmp := StrToInt(MidStr(command,15,99999));
-      with TMission(MissionList[tmp]^) do
+      with TCampaign(CampaignList[tmp]) do
       begin
-        ExtractMissionFiles(FileName);
-        CurrentMissionIndex := tmp;
-        if UseHTML then
-          LoadMenu(descriptor.ReadKeyValue('mission/htmlbriefing'),Mission)
-        else
-          LoadMenu('defaultMissionBriefing.html',Mission);
+        LoadReturnFile;
+        CurrentCampaignIndex := tmp;
+        LoadMenu(StringReplace(WarmapPath,'/','\',[rfReplaceAll]),Mission)
       end;
       Exit;
     end;
     if LeftStr(LowerCase(command),15) = 'selectcampaign:' then
     begin
       tmp := StrToInt(MidStr(command,16,99999));
-      with TCampaign(CampaignList[tmp]^) do
+      with TCampaign(CampaignList[tmp]) do
       begin
-        ExtractCampaignFiles(FileName);
+        LoadReturnFile;
         CurrentCampaignIndex := tmp;
-        LoadMenu(descriptor.ReadKeyValue('campaign/step1'),Campaign)
+        LoadMenu(StringReplace(WarmapPath,'/','\',[rfReplaceAll]),Campaign)
       end;
       Exit;
     end;
     if LeftStr(LowerCase(command),12) = 'pickmission:' then
     begin
-      tmpStr := MidStr(command,13,99999);
+      {tmpStr := MidStr(command,13,99999);
 
       Misc.ParseDelimited(sl,tmpStr,':','');
 
@@ -1287,7 +1461,7 @@
       end;
 
       sl.Free;
-      Exit;
+      Exit;}
     end;
     if LeftStr(LowerCase(command),10) = 'selectmap:' then
     begin
@@ -1342,7 +1516,11 @@
       LoadMenu('loading.html',Loading);
       BrowseHistory.Pop;
       BattleForm.ChangeCurrentMod(Utility.ModList[tmp]);
+      DelTree(ModMenuPath);
+      CopyTree(MenuCurrentPath,ModMenuPath);
+      LoadMenuFromMod := ExtractVFSDir('SPTheme/IE',ModMenuPath);
       Utility.ReloadUnitList;
+      LoadCampaigns;
 
       // reload bot list
       AddBotForm.ReloadButtonClick(nil);
@@ -1351,7 +1529,7 @@
       for i:=0 to AIPlayerList.Count-1 do
         TAIItem(AIPlayerList[i]^).Side := 0;
 
-      LoadMenu(TBrowsePage(browsePage^).PageName,TBrowsePage(browsePage^).PageType);
+      LoadMenu('modMain.html',ModMain);
       Exit;
     end;
     if LeftStr(LowerCase(command),10) = 'saveparam:' then
@@ -1733,68 +1911,24 @@
     Misc.OpenURLInDefaultBrowser(URL);
 end;
 
-procedure TMenuForm.LoadMissions;
-var
-  sr: TSearchRec;
-  FileAttrs: Integer;
-  m: ^TMission;
-  d: string;
-begin
-  MissionList.Clear;
-
-  FileAttrs := faAnyFile;
-
-  if FindFirst(ExtractFilePath(Application.ExeName) + 'missions\*.sd7', FileAttrs, sr) = 0 then
-  begin
-    repeat
-      if (sr.Name &lt;&gt; '.') and (sr.Name &lt;&gt; '..') then
-      begin
-        d := Utility.GetArchiveDescriptor('.\missions\'+sr.Name);
-        if d &lt;&gt; '' then
-        begin
-          New(m);
-          m^.FileName := '.\missions\'+sr.Name;
-          m^.descriptor := TTDFParser.Create(d);
-          m^.UseHTML := m^.descriptor.ReadKeyValue('mission/htmlbriefing') &lt;&gt; '';
-          MissionList.Add(m);
-        end;
-        //else
-          //MessageDlg('Mission descriptor not found in '''+sr.Name+'''',mtWarning,[mbOk],0);
-      end;
-    until FindNext(sr) &lt;&gt; 0;
-    FindClose(sr);
-  end;
-end;
-
 procedure TMenuForm.LoadCampaigns;
 var
-  sr: TSearchRec;
-  FileAttrs: Integer;
-  m: ^TCampaign;
-  d: string;
+  c: TCampaign;
+  res : integer;
+  s, modShortName: string;
 begin
   CampaignList.Clear;
 
-  FileAttrs := faAnyFile;
+  modShortName := GetModShortName;
 
-  if FindFirst(ExtractFilePath(Application.ExeName) + 'campaigns\*.sd7', FileAttrs, sr) = 0 then
+  res := InitSubDirsVFS(PChar('Campaign/'+modShortName),'*',nil);
+  SetLength(s, 255);
+  res := FindFilesVFS(res, PChar(s), 255);
+  while res &lt;&gt; 0 do
   begin
-    repeat
-      if (sr.Name &lt;&gt; '.') and (sr.Name &lt;&gt; '..') then
-      begin
-        d := Utility.GetArchiveDescriptor('.\campaigns\'+sr.Name);
-        if d &lt;&gt; '' then
-        begin
-          New(m);
-          m^.FileName := '.\campaigns\'+sr.Name;
-          m^.descriptor := TTDFParser.Create(d);
-          CampaignList.Add(m);
-        end;
-        //else
-          //MessageDlg('Mission descriptor not found in '''+sr.Name+'''',mtWarning,[mbOk],0);
-      end;
-    until FindNext(sr) &lt;&gt; 0;
-    FindClose(sr);
+    c := TCampaign.Create(Trim(s)+modShortName+'.lua');
+    CampaignList.Add(c);
+    res := FindFilesVFS(res, PChar(s), 255);
   end;
 end;
 
@@ -1842,31 +1976,6 @@
   end;
 end;
 
-procedure TMenuForm.ExtractMissionFiles(FileName: string);
-begin
-  if DirectoryExists(MissionCurrentPath) then
-    DelTree(MissionCurrentPath);
-  SevenZip1.SZFileName := FileName;
-  SevenZip1.ExtrBaseDir := MissionCurrentPath;
-  SevenZip1.Extract(false);
-
-  // copy the default skin into the mission dir
-  CopyFile(PChar(MenuCurrentPath+'defaultMissionSkin.html'),PChar(MissionCurrentPath+'defaultMissionSkin.html'),true)
-end;
-
-procedure TMenuForm.ExtractCampaignFiles(FileName: string);
-begin
-  if DirectoryExists(CampaignCurrentPath) then
-    DelTree(CampaignCurrentPath);
-  SevenZip1.SZFileName := FileName;
-  SevenZip1.ExtrBaseDir := CampaignCurrentPath;
-  SevenZip1.Extract(false);
-
-  // copy the default skin into the mission dir
-  CopyFile(PChar(MenuCurrentPath+'defaultCampaignSkin.html'),PChar(CampaignCurrentPath+'defaultCampaignSkin.html'),true)
-end;
-
-
 procedure TMenuForm.tmrMusicTimer(Sender: TObject);
 begin
   if (MP1.FileName &lt;&gt; '') and not (MP1.Mode = mpPlaying) then

Modified: trunk/Lobby/TASClient/Misc.pas
===================================================================
--- trunk/Lobby/TASClient/Misc.pas	2008-10-03 13:47:09 UTC (rev 6508)
+++ trunk/Lobby/TASClient/Misc.pas	2008-10-03 15:32:39 UTC (rev 6509)
@@ -136,7 +136,8 @@
 Function CopyTree(DirFrom : string; DirTo : string): LongInt;
 Function MoveTree(DirFrom : string; DirTo : string): LongInt;
 Function BitmapFlip(Const Vertical : Boolean;Const Horizontal : Boolean;var BitmapIn : TBitmap;out BitmapOut : TBitmap): Boolean;
-function ExtractFileNameFromUrl(url: string): string;
+function ExtractAfterLastSlash(path: string): string;
+function ExtractBeforeLastSlash(path: string): string;
 function GetLobbyRevision: integer;
 procedure MakePath(Path: string);
 function URLDecode(const S: string): string;
@@ -2146,20 +2147,34 @@
    End;
 End;
 
-function ExtractFileNameFromUrl(url: string): string;
+function ExtractAfterLastSlash(path: string): string;
 var
   i: integer;
 begin
-  for i:=Length(url) downto 1 do
+  for i:=Length(path) downto 1 do
   begin
-    if MidStr(url,i,1) = '/' then
+    if MidStr(path,i,1) = '/' then
     begin
-      Result := MidStr(url,i+1,9999999);
+      Result := MidStr(path,i+1,9999999);
       Exit;
     end;
   end;
 end;
 
+function ExtractBeforeLastSlash(path: string): string;
+var
+  i: integer;
+begin
+  for i:=Length(path) downto 1 do
+  begin
+    if MidStr(path,i,1) = '/' then
+    begin
+      Result := LeftStr(path,i-1);
+      Exit;
+    end;
+  end;
+end;
+
 function GetLobbyRevision: integer;
 var
   exe: string;

Modified: trunk/Lobby/TASClient/PreferencesFormUnit.pas
===================================================================
--- trunk/Lobby/TASClient/PreferencesFormUnit.pas	2008-10-03 13:47:09 UTC (rev 6508)
+++ trunk/Lobby/TASClient/PreferencesFormUnit.pas	2008-10-03 15:32:39 UTC (rev 6509)
@@ -1051,7 +1051,7 @@
     oldPref := Preferences;
     UpdatePreferencesTo(Preferences); // save changes to p
     UpdatePreferencesFrom(Preferences); // update changes from p
-    if Preferences.SortLocal then
+    if not oldPref.SortLocal and Preferences.SortLocal then
       MainForm.ResortClientsLists;
     if Preferences.EnableSpringDownloader &lt;&gt; oldPref.EnableSpringDownloader then
       if Preferences.EnableSpringDownloader then

Modified: trunk/Lobby/TASClient/Python/api.txt
===================================================================
--- trunk/Lobby/TASClient/Python/api.txt	2008-10-03 13:47:09 UTC (rev 6508)
+++ trunk/Lobby/TASClient/Python/api.txt	2008-10-03 15:32:39 UTC (rev 6509)
@@ -59,9 +59,9 @@
 
 menuName = [HostBattle, Help, HelpWiki, HelpDownload, BattleItem (returning the BattleId), PlayerItem (Returning the Player Name), PlayerItemModeration (Returning the Player Name), BattlePlayerItem (Returning the Player Name), BattleMinimap, BattleAdmin, BattleAdminBalance, BattleAdminRankLimit, BattleLadder, ReplayItem (Returning the Replay index)] 
 
-- AddItemToMenu(menuName/SubmenuId,caption,callbackModuleName,callbackFunctionName,argsTuple) return itemId
+- AddItemToMenu(menuName/SubmenuId,caption,callbackModuleName,callbackFunctionName,argsTuple,name) return itemId
 	The selected item id is returned as first argument added to the argsTuple.
-- AddSubmenuToMenu(menuName/SubmenuId,caption) return SubmenuId
+- AddSubmenuToMenu(menuName/SubmenuId,caption,name) return SubmenuId
 - AddSeparatorToMenu(menuName/SubmenuId) return SeparatorId
 - SetMenuItemState(id,checked,enabled)
 - RemoveFromMenu(id)
@@ -71,11 +71,13 @@
 	displayTime in ms
 - GetControlProperties(controlName)
 - SetControlProperties(controlName, properties)
-- AddPanel(name, parent)
-- AddSplitter(name, parent)
-- AddTabsPanel(name, parent)
+- AddControl(name, parent, className)
+	classname = [TSpTBXDock, TSpTBXMultiDock, TSpTBXToolbar, TSpTBXDockablePanel, TSpTBXTabSet, TSpTBXTabControl, TSpTBXStatusBar, TSpTBXLabel, TSpTBXCheckBox, TSpTBXRadioButton, TSpTBXProgressBar, TSpTBXTrackBar, TSpTBXSplitter, TSpTBXPanel, TSpTBXGroupBox, TSpTBXRadioGroup, TSpTBXEdit,TSpTBXSpinEdit, TSpTBXComboBox,TSpTBXListBox, TSpTBXCheckListBox, TExRichEdit, TImage32]
 - AddTab(caption, name, TabsPanelName)
 - AddForm(name, caption, borderStyle (0-&gt;5))
+- GetColors
+- GetRichEditList
+- AddToRichEdit(textbox, msg, color)
 
 
 

Modified: trunk/Lobby/TASClient/Python/engine/handlers.py
===================================================================
--- trunk/Lobby/TASClient/Python/engine/handlers.py	2008-10-03 13:47:09 UTC (rev 6508)
+++ trunk/Lobby/TASClient/Python/engine/handlers.py	2008-10-03 15:32:39 UTC (rev 6509)
@@ -221,7 +221,7 @@
 	return _handle_callin('onURLClick',url)
 	
 def onChatDblClick(charPos,line):
-	return _handle_callin('onChatDblClick',charPos+' '+line)
+	return _handle_callin('onChatDblClick',str(charPos)+' '+line)
 	
 def handleCommand(cmd):
 	spaces = cmd.count(' ')

Deleted: trunk/Lobby/TASClient/Python/scripts/stick.py
===================================================================
--- trunk/Lobby/TASClient/Python/scripts/stick.py	2008-10-03 13:47:09 UTC (rev 6508)
+++ trunk/Lobby/TASClient/Python/scripts/stick.py	2008-10-03 15:32:39 UTC (rev 6509)
@@ -1,148 +0,0 @@
-import time,thread
-import lobbyscript
-import sys
-
-api = lobbyscript.Callback()
-gui = lobbyscript.GUI()
-
-stickingNick = ''
-specMode = 0
-battleJoinedAndStatusChanged = 0
-stickJoin = False
-
-subMenuId = 0
-menuStickSpecId = 0
-menuStickId = 0
-menuUnstickId = 0
-
-
-colors = api.GetColors()
-
-def onUnStickClick(id):
-  global menuUnstickId
-  cmd_unstick()
-  gui.RemoveFromMenu(menuUnstickId)
-  menuUnstickId = 0
-
-def onStickClick(id,spec):
-  global subMenuId
-  global menuStickSpecId
-  global menuStickId
-  global menuUnstickId
-  if spec:
-    cmd_stick(id+' 1')
-  else:
-    cmd_stick(id+' 0')
-  
-  if menuUnstickId == 0:    
-    menuUnstickId = gui.AddItemToMenu(subMenuId,'UnStick',(),'stick','onUnStickClick')
-    
-
-def _init():
-  global subMenuId
-  global menuStickSpecId
-  global menuStickId
-  global menuUnstickId
-  subMenuId = gui.AddSubmenuToMenu('PlayerItem','Stick')
-  menuStickSpecId = gui.AddItemToMenu(subMenuId,'Stick',(False,),'stick','onStickClick')
-  menuStickId = gui.AddItemToMenu(subMenuId,'Stick Spec',(True,),'stick','onStickClick')
-  gui.AddSeparatorToMenu(subMenuId)
-  
-
-# exit stick mode if the sticked user left
-def in_REMOVEUSER(nick):
-  global stickingNick
-  global menuUnstickId
-  if nick == stickingNick:
-    stickingNick = ''
-    api.AddToTextBox('$current','Exiting stick mode ('+nick+' left).',colors['Info'])
-    gui.RemoveFromMenu(menuUnstickId)
-
-
-# we're joining a battle and we start waiting for 2 in_CLIENTBATTLESTATUS 
-def in_JOINBATTLE(data):
-  global battleJoinedAndStatusChanged
-  global specMode
-  global stickJoin
-  if specMode != '0' and stickJoin:
-    stickJoin = False
-    battleJoinedAndStatusChanged = 2
-
-def in_FORCEQUITBATTLE():
-  global stickingNick
-  if stickingNick  != '':
-    stickingNick = ''
-    api.AddToTextBox('$current','Exiting stick mode (You were kicked from the battle).',colors['Info'])
-
-# when joining a battle we wait for the two CLIENTBATTLESTATUS from server 
-# and then we set us to spectator if the option is checked 
-def in_CLIENTBATTLESTATUS(nick, status, color):
-  global battleJoinedAndStatusChanged
-  global specMode
-  if specMode == '1':
-    if nick == api.GetMyUser()['Name'] and battleJoinedAndStatusChanged &gt; 0: 
-      battleJoinedAndStatusChanged -= 1   
-      api.SetMyBattleStatus(1)
-        
-
-# the timer tryin to connect you to the sticked user
-def timer_2():
-  global stickingNick
-  global specMode
-  global stickJoin
-  
-  if stickingNick != '': 
-    curBat = api.GetCurrentBattle()
-    if curBat != None:
-      curBat = dict(curBat)
-    users = dict(api.GetUsers())
-    if stickingNick in users:
-      if 'Battle' in users[stickingNick]:
-        if curBat != None:
-          if curBat['Battle']['Id'] == users[stickingNick]['Battle']['Id']:
-            return
-          else:
-            api.LeaveBattle()
-        mods = dict(api.GetMods())
-        if users[stickingNick]['Battle']['ModName'] in mods:
-          stickJoin = True
-          api.JoinBattle(users[stickingNick]['Battle']['Id'],'')
-      else:
-        api.LeaveBattle()
-
-def cmd_unstick():
-  global stickingNick
-  stickingNick = ''
-  api.AddToTextBox('$current','Exiting stick mode.',colors['Info'])
-  return True
-
-def cmd_stick(data):
-  args = data.split(' ')
-
-  if len(args) != 2:
-      api.AddToTextBox('$current',&quot;Stick usage : /stick user joinAsSpec={0/1} (Ex : '/stick haxor465 1' will join as spectator every battle the player haxor465 joins.&quot;,colors['Error'])
-      return 1
-  nick = args[0]
-  spec = args[1]
-  global stickingNick
-  global specMode
-  
-  if stickingNick != '':
-    api.AddToTextBox('$current','Exiting stick mode.',colors['Info'])
- 
-  users = api.GetUsers()
-  if nick in users:
-    stickingNick = nick
-    specMode = spec
-    if specMode == '1':
-      api.AddToTextBox('$current','Entering spectator sticking mode on : '+nick,colors['Info'])
-    else:
-      api.AddToTextBox('$current','Entering sticking mode on : '+nick,colors['Info'])
-    api.AddToTextBox('$current','Type /unstick to leave that mode.',colors['Info'])
-    
-  else:
-    stickingNick = ''
-    api.AddToTextBox('$current',&quot;User '&quot;+nick+&quot;' does not exist.&quot;,colors['Error'])
-
-  # the command won't be processed by the lobby
-  return True
\ No newline at end of file

Modified: trunk/Lobby/TASClient/Python/scripts/subf/frenchTranslationTest.py
===================================================================
--- trunk/Lobby/TASClient/Python/scripts/subf/frenchTranslationTest.py	2008-10-03 13:47:09 UTC (rev 6508)
+++ trunk/Lobby/TASClient/Python/scripts/subf/frenchTranslationTest.py	2008-10-03 15:32:39 UTC (rev 6509)
@@ -9,10 +9,10 @@
 def changeControlProp(cont,prop,value):
   p = gui.GetControlProperties(cont)
   p[prop] = value
-  gui.SetControlProperties(cont,p)
+  return gui.SetControlProperties(cont,p)
   
 def translate(cont,value):
-  changeControlProp(cont,'Caption',value)
+  return changeControlProp(cont,'Caption',value)
 
 
 def _init():

Modified: trunk/Lobby/TASClient/Python/scripts/subf/layoutTest.py
===================================================================
--- trunk/Lobby/TASClient/Python/scripts/subf/layoutTest.py	2008-10-03 13:47:09 UTC (rev 6508)
+++ trunk/Lobby/TASClient/Python/scripts/subf/layoutTest.py	2008-10-03 15:32:39 UTC (rev 6509)
@@ -7,18 +7,19 @@
 def changeComponentProp(comp,prop,value):
   p = gui.GetControlProperties(comp)
   p[prop] = value
-  gui.SetControlProperties(comp,p)
+  return gui.SetControlProperties(comp,p)
 
 def _init():
   # move the player list to the right of the chat with battle list under
-  gui.AddPanel('testPanel','MainForm.Panel1')
+  gui.AddControl('testPanel','MainForm.Panel1','TSpTBXPanel')
+  changeComponentProp('MainForm.Panel1.testPanel','Borders','False')
+  
+  changeComponentProp('MainForm.Splitter1','parent','MainForm.Panel1.testPanel')
    
   changeComponentProp('MainForm.Panel2','align','alRight')
   changeComponentProp('MainForm.Panel2','parent','MainForm.Panel1.testPanel')
   
-  changeComponentProp('MainForm.Splitter1','align','alLeft')
-  changeComponentProp('MainForm.Splitter1','parent','MainForm.Panel1.testPanel')
-  changeComponentProp('MainForm.Splitter1','align','alRight')
+
   
   changeComponentProp('MainForm.PageControl1','align','alClient')
   changeComponentProp('MainForm.PageControl1','parent','MainForm.Panel1.testPanel')

Added: trunk/Lobby/TASClient/Python/scripts/subf/stick.py
===================================================================
--- trunk/Lobby/TASClient/Python/scripts/subf/stick.py	                        (rev 0)
+++ trunk/Lobby/TASClient/Python/scripts/subf/stick.py	2008-10-03 15:32:39 UTC (rev 6509)
@@ -0,0 +1,149 @@
+import time,thread
+import lobbyscript
+import sys
+
+api = lobbyscript.Callback()
+gui = lobbyscript.GUI()
+
+stickingNick = ''
+specMode = 0
+battleJoinedAndStatusChanged = 0
+stickJoin = False
+
+subMenuId = 0
+menuStickSpecId = 0
+menuStickId = 0
+menuUnstickId = 0
+
+
+colors = gui.GetColors()
+
+def onUnStickClick(id):
+  global menuUnstickId
+  cmd_unstick()
+  gui.RemoveFromMenu(menuUnstickId)
+  menuUnstickId = 0
+
+def onStickClick(id,spec):
+  global subMenuId
+  global menuStickSpecId
+  global menuStickId
+  global menuUnstickId
+  if spec:
+    cmd_stick(id+' 1')
+  else:
+    cmd_stick(id+' 0')
+  
+  if menuUnstickId == 0:    
+    menuUnstickId = gui.AddItemToMenu(subMenuId,'UnStick',(),'stick','onUnStickClick')
+    
+
+def _init():
+  global subMenuId
+  global menuStickSpecId
+  global menuStickId
+  global menuUnstickId
+  subMenuId = gui.AddSubmenuToMenu('PlayerItem','Stick')
+  menuStickSpecId = gui.AddItemToMenu(subMenuId,'Stick',(False,),'stick','onStickClick')
+  menuStickId = gui.AddItemToMenu(subMenuId,'Stick Spec',(True,),'stick','onStickClick')
+  gui.AddSeparatorToMenu(subMenuId)
+  
+
+# exit stick mode if the sticked user left
+def in_REMOVEUSER(nick):
+  global stickingNick
+  global menuUnstickId
+  if nick == stickingNick:
+    stickingNick = ''
+    gui.AddToRichEdit('$current','Exiting stick mode ('+nick+' left).',colors['Info'])
+    gui.RemoveFromMenu(menuUnstickId)
+
+
+# we're joining a battle and we start waiting for 2 in_CLIENTBATTLESTATUS 
+def in_JOINBATTLE(data):
+  global battleJoinedAndStatusChanged
+  global specMode
+  global stickJoin
+  if specMode != '0' and stickJoin:
+    stickJoin = False
+    battleJoinedAndStatusChanged = 2
+
+def in_FORCEQUITBATTLE():
+  global stickingNick
+  if stickingNick  != '':
+    stickingNick = ''
+    gui.AddToTextBox('$current','Exiting stick mode (You were kicked from the battle).',colors['Info'])
+
+# when joining a battle we wait for the two CLIENTBATTLESTATUS from server 
+# and then we set us to spectator if the option is checked 
+def in_CLIENTBATTLESTATUS(nick, status, color):
+  global battleJoinedAndStatusChanged
+  global specMode
+  if specMode == '1':
+    if nick == api.GetMyUser()['Name'] and battleJoinedAndStatusChanged &gt; 0: 
+      battleJoinedAndStatusChanged -= 1   
+      api.SetMyBattleStatus(1)
+        
+
+# the timer tryin to connect you to the sticked user
+def timer_2():
+  global stickingNick
+  global specMode
+  global stickJoin
+  
+  if stickingNick != '': 
+    curBat = api.GetCurrentBattle()
+    if curBat != None:
+      curBat = dict(curBat)
+    users = dict(api.GetUsers())
+    if stickingNick in users:
+      if 'Battle' in users[stickingNick]:
+        if curBat != None:
+          if curBat['Battle']['Id'] == users[stickingNick]['Battle']['Id']:
+            return
+          else:
+            api.LeaveBattle()
+        mods = dict(api.GetMods())
+        if users[stickingNick]['Battle']['ModName'] in mods:
+          stickJoin = True
+          api.JoinBattle(users[stickingNick]['Battle']['Id'],'')
+      else:
+        api.LeaveBattle()
+
+def cmd_unstick():
+  global stickingNick
+  stickingNick = ''
+  gui.AddToRichEdit('$current','Exiting stick mode.',colors['Info'])
+  return True
+
+def cmd_stick(data):
+  args = data.split(' ')
+
+  if len(args) != 2:
+      gui.AddToRichEdit('$current',&quot;Stick usage : /stick user joinAsSpec={0/1} (Ex : '/stick haxor465 1' will join as spectator every battle the player haxor465 joins.&quot;,colors['Error'])
+      return 1
+  nick = args[0]
+  spec = args[1]
+  global stickingNick
+  global specMode
+  
+  if stickingNick != '':
+    gui.AddToRichEdit('$current','Exiting stick mode.',colors['Info'])
+ 
+  users = api.GetUsers()
+  print users
+  if nick in users:
+    stickingNick = nick
+    specMode = spec
+    if specMode == '1':
+      gui.AddToRichEdit('$current','Entering spectator sticking mode on : '+nick,colors['Info'])
+    else:
+      gui.AddToRichEdit('$current','Entering sticking mode on : '+nick,colors['Info'])
+    gui.AddToRichEdit('$current','Type /unstick to leave that mode.',colors['Info'])
+    
+  else:
+    stickingNick = ''
+    gui.AddToRichEdit('$current',&quot;User '&quot;+nick+&quot;' does not exist.&quot;,colors['Error'])
+
+  # the command won't be processed by the lobby
+  return True
\ No newline at end of file

Modified: trunk/Lobby/TASClient/Python/scripts/subf/windowedTASClient.py
===================================================================
--- trunk/Lobby/TASClient/Python/scripts/subf/windowedTASClient.py	2008-10-03 13:47:09 UTC (rev 6508)
+++ trunk/Lobby/TASClient/Python/scripts/subf/windowedTASClient.py	2008-10-03 15:32:39 UTC (rev 6509)
@@ -7,7 +7,7 @@
 def changeComponentProp(comp,prop,value):
   p = gui.GetControlProperties(comp)
   p[prop] = value
-  gui.SetControlProperties(comp,p)
+  return gui.SetControlProperties(comp,p)
 
 def _init():
   gui.AddForm('PlayerListForm','Player List',2)

Modified: trunk/Lobby/TASClient/TASClient.cfg
===================================================================
--- trunk/Lobby/TASClient/TASClient.cfg	2008-10-03 13:47:09 UTC (rev 6508)
+++ trunk/Lobby/TASClient/TASClient.cfg	2008-10-03 15:32:39 UTC (rev 6509)
@@ -31,13 +31,13 @@
 -M
 -$M16384,1048576
 -K$00400000
--E&quot;C:\Program Files\Spring&quot;
+-E&quot;E:\Program Files\SpringSVN&quot;
 -LE&quot;c:\program files\borland\delphi7\Projects\Bpl&quot;
 -LN&quot;c:\program files\borland\delphi7\Projects\Bpl&quot;
--U&quot;E:\Tools\Developpement\spring_0.74b3_src\SVN\LobbyComponents\graphics32-1_5_1&quot;
--O&quot;E:\Tools\Developpement\spring_0.74b3_src\SVN\LobbyComponents\graphics32-1_5_1&quot;
--I&quot;E:\Tools\Developpement\spring_0.74b3_src\SVN\LobbyComponents\graphics32-1_5_1&quot;
--R&quot;E:\Tools\Developpement\spring_0.74b3_src\SVN\LobbyComponents\graphics32-1_5_1&quot;
+-U&quot;hics32-1_5_1&quot;
+-O&quot;hics32-1_5_1&quot;
+-I&quot;hics32-1_5_1&quot;
+-R&quot;hics32-1_5_1&quot;
 -w-UNSAFE_TYPE
 -w-UNSAFE_CODE
 -w-UNSAFE_CAST

Modified: trunk/Lobby/TASClient/TASClient.dof
===================================================================
--- trunk/Lobby/TASClient/TASClient.dof	2008-10-03 13:47:09 UTC (rev 6508)
+++ trunk/Lobby/TASClient/TASClient.dof	2008-10-03 15:32:39 UTC (rev 6509)
@@ -90,21 +90,21 @@
 ImageBase=4194304
 ExeDescription=
 [Directories]
-OutputDir=C:\Program Files\Spring
+OutputDir=E:\Program Files\SpringSVN
 UnitOutputDir=
 PackageDLLOutputDir=
 PackageDCPOutputDir=
-SearchPath=E:\Tools\Developpement\spring_0.74b3_src\SVN\LobbyComponents\graphics32-1_5_1
+SearchPath=hics32-1_5_1
 Packages=vcl;rtl;vclx;indy;inet;xmlrtl;vclie;inetdbbde;inetdbxpress;dbrtl;dsnap;dsnapcon;vcldb;soaprtl;VclSmp;dbexpress;dbxcds;inetdb;bdertl;vcldbx;webdsnap;websnap;adortl;ibxpress;teeui;teedb;tee;dss;visualclx;visualdbclx;vclactnband;vclshlctrls;IntrawebDB_50_70;Intraweb_50_70;Rave50CLX;Rave50VCL;dclOfficeXP;OmegaD7;VirtualTreesD7
 Conditionals=
 DebugSourceDirs=
 UsePackages=0
 [Parameters]
-RunParams=
-HostApplication=C:\Program Files\Spring\TASClient.exe
+RunParams=-server taspringmaster.servegame.com:8300 -menu -menudev
+HostApplication=E:\Program Files\SpringSVN\TASClient.exe
 Launcher=
 UseLauncher=0
-DebugCWD=C:\Program Files\Spring
+DebugCWD=E:\Program Files\SpringSVN
 [Language]
 ActiveLang=
 ProjectLang=
@@ -115,7 +115,7 @@
 MajorVer=0
 MinorVer=3
 Release=0
-Build=472
+Build=474
 Debug=0
 PreRelease=0
 Special=0
@@ -126,7 +126,7 @@
 [Version Info Keys]
 CompanyName=
 FileDescription=TA Spring lobby client
-FileVersion=0.3.0.472
+FileVersion=0.3.0.474
 InternalName=
 LegalCopyright=
 LegalTrademarks=
@@ -134,19 +134,20 @@
 ProductName=TASClient
 ProductVersion=1.0.0.0
 Comments=
-[Excluded Packages]
-C:\Program Files\Borland\Delphi7\Projects\Bpl\Jcl70.bpl=JEDI Code Library RTL package
 [HistoryLists\hlUnitAliases]
 Count=1
 Item0=WinTypes=Windows;WinProcs=Windows;DbiTypes=BDE;DbiProcs=BDE;DbiErrs=BDE;
 [HistoryLists\hlSearchPath]
-Count=1
-Item0=E:\Tools\Developpement\spring_0.74b3_src\SVN\LobbyComponents\graphics32-1_5_1
+Count=2
+Item0=hics32-1_5_1
+Item1=E:\Tools\Developpement\spring_0.74b3_src\SVN\LobbyComponents\graphics32-1_5_1
 [HistoryLists\hlUnitOutputDirectory]
 Count=1
 Item0=C:\Program Files\TASpring
 [HistoryLists\hlOutputDirectorry]
-Count=3
-Item0=C:\Program Files\Spring
-Item1=C:\Program Files\SpringSVN
-Item2=C:\Program Files\TASpring
+Count=5
+Item0=E:\Program Files\SpringSVN
+Item1=D:\Program Files\SpringSVN
+Item2=C:\Program Files\SpringSVN
+Item3=C:\Program Files\Spring
+Item4=C:\Program Files\TASpring

Modified: trunk/Lobby/TASClient/TASClient.dpr
===================================================================
--- trunk/Lobby/TASClient/TASClient.dpr	2008-10-03 13:47:09 UTC (rev 6508)
+++ trunk/Lobby/TASClient/TASClient.dpr	2008-10-03 15:32:39 UTC (rev 6509)
@@ -132,8 +132,8 @@
   for i := 1 to ParamCount do
   begin
     MainUnit.RunningUnderWine := MainUnit.RunningUnderWine or (UpperCase(ParamStr(i)) = '-WINE');
-    //MainUnit.RunningWithMainMenu := MainUnit.RunningWithMainMenu or (UpperCase(ParamStr(i)) = '-MENU');
-    //MainUnit.RunningWithMainMenuDev := MainUnit.RunningWithMainMenuDev or (UpperCase(ParamStr(i)) = '-MENUDEV');
+    MainUnit.RunningWithMainMenu := MainUnit.RunningWithMainMenu or (UpperCase(ParamStr(i)) = '-MENU');
+    MainUnit.RunningWithMainMenuDev := MainUnit.RunningWithMainMenuDev or (UpperCase(ParamStr(i)) = '-MENUDEV');
 
     if UpperCase(ParamStr(i)) = '-SERVER' then
       if (ParamCount = i) or (Pos(':',ParamStr(i+1)) = 0) then

Modified: trunk/Lobby/TASClient/TASClient.res
===================================================================
(Binary files differ)

Modified: trunk/Lobby/TASClient/Utility.pas
===================================================================
--- trunk/Lobby/TASClient/Utility.pas	2008-10-03 13:47:09 UTC (rev 6508)
+++ trunk/Lobby/TASClient/Utility.pas	2008-10-03 15:32:39 UTC (rev 6509)
@@ -64,36 +64,9 @@
 function GetLuaAIList:TStrings;
 function GetModValidMapList: TStringList;
 function GetMapArchive(mapName: String):String;
-function GetArchiveDescriptor(FileName: string): String;
-//function ExtractVFSDir(Dir: string;ExtractTo: string): boolean;
+function GetModShortName: String;
+function ExtractVFSDir(Dir: string;ExtractTo: string): boolean;
 
-var
-  ModList: TStrings; // names of mods
-  ModArchiveList: TStrings; // names of files in which mods are
-
-  UnitNames: TStrings; // list of unit names
-  UnitList: TStrings; // list of &quot;code names&quot; of units
-  UnitBitmaps: TList; // list of TBitmap icon of units
-  UnitNodes: TList; // node associated in the disable form list
-
-  ModValidMaps: TStringList; //
-
-  SideList: TStringList; // list of mod's sides, like &quot;Arm&quot;, &quot;Core&quot;, etc.
-  SideImageList: TImageList; // images of sides. Also see SideList
-
-  MapList: TStringList;
-  MapChecksums: TStringList;
-
-  LastInitSuccess: Boolean = True; // check this var to see if last call to InitLib/ReInitLib was successful!
-
-implementation
-
-uses
-  SysUtils, StrUtils, Dialogs, Forms, Misc, InitWaitFormUnit,
-  MapListFormUnit, SplashScreenUnit, BattleFormUnit, PreferencesFormUnit,
-  LobbyScriptUnit;
-
-
 { I assume bools are 1 byte in size (not 4) in unitsync.dll (from MSDN: &quot;In Visual C++ 4.2,
   the Standard C++ header files contained a typedef that equated bool with int.
   In Visual C++ 5.0 and later, bool is implemented as a built-in type with a size
@@ -152,8 +125,8 @@
 {since 0.68}procedure ReadFileVFS(handle: Integer; buf: Pointer; length: Integer); stdcall; external 'UnitSync.dll' name 'ReadFileVFS';
 {since 0.68}function FileSizeVFS(handle: Integer): Integer; stdcall; external 'UnitSync.dll' name 'FileSizeVFS';
 {since 0.68}function InitFindVFS(const pattern: PChar): Integer; stdcall; external 'UnitSync.dll' name 'InitFindVFS';
-{since 0.77}//function InitDirListVFS(const path: PChar; const pattern: PChar; const modes: PChar): Integer; stdcall; external 'UnitSync.dll' name 'InitDirListVFS';
-{since 0.77}//function InitSubDirsVFS(const path: PChar; const pattern: PChar; const modes: PChar): Integer; stdcall; external 'UnitSync.dll' name 'InitSubDirsVFS';
+{since 0.77}function InitDirListVFS(const path: PChar; const pattern: PChar; const modes: PChar): Integer; stdcall; external 'UnitSync.dll' name 'InitDirListVFS';
+{since 0.77}function InitSubDirsVFS(const path: PChar; const pattern: PChar; const modes: PChar): Integer; stdcall; external 'UnitSync.dll' name 'InitSubDirsVFS';
 {since 0.68}function FindFilesVFS(handle: Integer; nameBuf: PChar; size: Integer): Integer; stdcall; external 'UnitSync.dll' name 'FindFilesVFS';
 {------------------------------------------------------------------------------}
 {since 0.76}function GetLuaAICount: Integer; stdcall; external 'UnitSync.dll' name 'GetLuaAICount';
@@ -164,8 +137,8 @@
 {since 0.76}function GetModOptionCount: Integer; stdcall; external 'UnitSync.dll' name 'GetModOptionCount';
 {since 0.76}function GetOptionKey(optIndex: Integer): PChar; stdcall; external 'UnitSync.dll' name 'GetOptionKey';
 {since 0.76}function GetOptionName(optIndex: Integer): PChar; stdcall; external 'UnitSync.dll' name 'GetOptionName';
-{since 0.77}//function GetOptionSection(optIndex: Integer): PChar; stdcall; external 'UnitSync.dll' name 'GetOptionSection';
-{since 0.77}//function GetOptionStyle(optIndex: Integer): PChar; stdcall; external 'UnitSync.dll' name 'GetOptionStyle';
+{since 0.77}function GetOptionSection(optIndex: Integer): PChar; stdcall; external 'UnitSync.dll' name 'GetOptionSection';
+{since 0.77}function GetOptionStyle(optIndex: Integer): PChar; stdcall; external 'UnitSync.dll' name 'GetOptionStyle';
 {since 0.76}function GetOptionDesc(optIndex: Integer): PChar; stdcall; external 'UnitSync.dll' name 'GetOptionDesc';
 {since 0.76}function GetOptionType(optIndex: Integer): Integer; stdcall; external 'UnitSync.dll' name 'GetOptionType';
 {since 0.76}function GetOptionBoolDef(optIndex: Integer): Boolean; stdcall; external 'UnitSync.dll' name 'GetOptionBoolDef';
@@ -182,8 +155,81 @@
 {since 0.76}function GetOptionListItemKey(optIndex: Integer; itemIndex: Integer): PChar; stdcall; external 'UnitSync.dll' name 'GetOptionListItemKey';
 {since 0.76}function GetModValidMapCount: integer; stdcall; external 'UnitSync.dll' name 'GetModValidMapCount';
 {since 0.76}function GetModValidMap(index: Integer): PChar; stdcall; external 'UnitSync.dll' name 'GetModValidMap';
+{------------------------------------------------------------------------------}
+{since 0.77}procedure lpClose; stdcall; external 'UnitSync.dll' name 'lpClose';
+{since 0.77}function lpOpenFile(const filename: PChar;const fileModes: PChar;const accessModes: PChar): Integer; stdcall; external 'UnitSync.dll' name 'lpOpenFile';
+{since 0.77}function lpOpenSource(const source: PChar;const accessModes: PChar): Integer; stdcall; external 'UnitSync.dll' name 'lpOpenSource';
+{since 0.77}function lpExecute:Integer; stdcall; external 'UnitSync.dll' name 'lpExecute';
+{since 0.77}procedure lpErrorLog; stdcall; external 'UnitSync.dll' name 'lpErrorLog';
+{since 0.77}procedure lpAddTableInt(key: integer;over_ride: integer); stdcall; external 'UnitSync.dll' name 'lpAddTableInt';
+{since 0.77}procedure lpAddTableStr(const key: PChar;over_ride: integer); stdcall; external 'UnitSync.dll' name 'lpAddTableStr';
+{since 0.77}procedure lpEndTable; stdcall; external 'UnitSync.dll' name 'lpEndTable';
 
+{since 0.77}procedure lpAddIntKeyIntVal(key: integer;val: integer); stdcall; external 'UnitSync.dll' name 'lpAddIntKeyIntVal';
+{since 0.77}procedure lpAddStrKeyIntVal(const key: PChar;val: integer); stdcall; external 'UnitSync.dll' name 'lpAddStrKeyIntVal';
 
+{since 0.77}procedure lpAddIntKeyBoolVal(key: integer;val: integer); stdcall; external 'UnitSync.dll' name 'lpAddIntKeyBoolVal';
+{since 0.77}procedure lpAddStrKeyBoolVal(const key: PChar;val: integer); stdcall; external 'UnitSync.dll' name 'lpAddStrKeyBoolVal';
+
+{since 0.77}procedure lpAddIntKeyFloatVal(key: integer;val: Float); stdcall; external 'UnitSync.dll' name 'lpAddIntKeyFloatVal';
+{since 0.77}procedure lpAddStrKeyFloatVal(const key: PChar;val: Float); stdcall; external 'UnitSync.dll' name 'lpAddStrKeyFloatVal';
+
+{since 0.77}procedure lpAddIntKeyStrVal(key: integer;const val: PChar); stdcall; external 'UnitSync.dll' name 'lpAddIntKeyStrVal';
+{since 0.77}procedure lpAddStrKeyStrVal(const key: PChar;const val: PChar); stdcall; external 'UnitSync.dll' name 'lpAddStrKeyStrVal';
+
+{since 0.77}function lpRootTable:Integer; stdcall; external 'UnitSync.dll' name 'lpRootTable';
+{since 0.77}function lpRootTableExpr(const expr: PChar):Integer; stdcall; external 'UnitSync.dll' name 'lpRootTableExpr';
+{since 0.77}function lpSubTableInt(key: Integer):Integer; stdcall; external 'UnitSync.dll' name 'lpSubTableInt';
+{since 0.77}function lpSubTableStr(const key: PChar):Integer; stdcall; external 'UnitSync.dll' name 'lpSubTableStr';
+{since 0.77}function lpSubTableExpr(const expr: PChar):Integer; stdcall; external 'UnitSync.dll' name 'lpSubTableExpr';
+{since 0.77}procedure lpPopTable; stdcall; external 'UnitSync.dll' name 'lpPopTable';
+
+{since 0.77}function lpGetKeyExistsInt(key: Integer):Integer; stdcall; external 'UnitSync.dll' name 'lpGetKeyExistsInt';
+{since 0.77}function lpGetKeyExistsStr(const key: PChar):Integer; stdcall; external 'UnitSync.dll' name 'lpGetKeyExistsStr';
+
+{since 0.77}function lpGetIntKeyType(key: Integer):Integer; stdcall; external 'UnitSync.dll' name 'lpGetIntKeyType';
+{since 0.77}function lpGetStrKeyType(const key: PChar):Integer; stdcall; external 'UnitSync.dll' name 'lpGetStrKeyType';
+
+{since 0.77}function lpGetIntKeyListCount:Integer; stdcall; external 'UnitSync.dll' name 'lpGetIntKeyListCount';
+{since 0.77}function lpGetIntKeyListEntry(index: Integer):Integer; stdcall; external 'UnitSync.dll' name 'lpGetIntKeyListEntry';
+{since 0.77}function lpGetStrKeyListCount:Integer; stdcall; external 'UnitSync.dll' name 'lpGetStrKeyListCount';
+{since 0.77}function lpGetStrKeyListEntry(index: Integer):PChar; stdcall; external 'UnitSync.dll' name 'lpGetStrKeyListEntry';
+
+{since 0.77}function lpGetIntKeyIntVal(key: Integer;defVal: Integer):Integer; stdcall; external 'UnitSync.dll' name 'lpGetIntKeyIntVal';
+{since 0.77}function lpGetStrKeyIntVal(const key: PChar;defVal: Integer):Integer; stdcall; external 'UnitSync.dll' name 'lpGetStrKeyIntVal';
+{since 0.77}function lpGetIntKeyBoolVal(key: Integer;defVal: Integer):Integer; stdcall; external 'UnitSync.dll' name 'lpGetIntKeyBoolVal';
+{since 0.77}function lpGetStrKeyBoolVal(const key: PChar;defVal: Integer):Integer; stdcall; external 'UnitSync.dll' name 'lpGetStrKeyBoolVal';
+{since 0.77}function lpGetIntKeyFloatVal(key: Integer;defVal: Float):Float; stdcall; external 'UnitSync.dll' name 'lpGetIntKeyFloatVal';
+{since 0.77}function lpGetStrKeyFloatVal(const key: PChar;defVal: Float):Float; stdcall; external 'UnitSync.dll' name 'lpGetStrKeyFloatVal';
+{since 0.77}function lpGetIntKeyStrVal(key: Integer;const defVal: PCHar):PChar; stdcall; external 'UnitSync.dll' name 'lpGetIntKeyStrVal';
+{since 0.77}function lpGetStrKeyStrVal(const key: PChar;const defVal: PChar):PChar; stdcall; external 'UnitSync.dll' name 'lpGetStrKeyStrVal';
+
+var
+  ModList: TStrings; // names of mods
+  ModArchiveList: TStrings; // names of files in which mods are
+
+  UnitNames: TStrings; // list of unit names
+  UnitList: TStrings; // list of &quot;code names&quot; of units
+  UnitBitmaps: TList; // list of TBitmap icon of units
+  UnitNodes: TList; // node associated in the disable form list
+
+  ModValidMaps: TStringList; //
+
+  SideList: TStringList; // list of mod's sides, like &quot;Arm&quot;, &quot;Core&quot;, etc.
+  SideImageList: TImageList; // images of sides. Also see SideList
+
+  MapList: TStringList;
+  MapChecksums: TStringList;
+
+  LastInitSuccess: Boolean = True; // check this var to see if last call to InitLib/ReInitLib was successful!
+
+implementation
+
+uses
+  SysUtils, StrUtils, Dialogs, Forms, Misc, InitWaitFormUnit,
+  MapListFormUnit, SplashScreenUnit, BattleFormUnit, PreferencesFormUnit,
+  LobbyScriptUnit;
+
 // some internal routines:
 function RED_RGB565(c: Word): Word; forward;
 function GREEN_RGB565(c: Word): Word; forward;
@@ -300,24 +346,7 @@
      // calculate checksum:
      CheckSum := GetMapChecksum(i);
      c := GetMapArchiveCount(PChar(MapName));
-     {for j := 0 to c-1 do
-       Inc(CheckSum, GetArchiveCheckSum(GetMapArchiveName(j)));}
 
-     {archiveHwd := OpenArchive(GetMapArchiveName(0));
-     if archiveHwd &lt;&gt; 0 then
-     begin
-        fileHwd := OpenArchiveFile(archiveHwd,'maps/boxes.sdf');
-        if fileHwd &lt;&gt; 0 then
-        begin
-          size := SizeArchiveFile(archiveHwd, fileHwd);
-          boxes := '';
-          SetLength(boxes,size);
-          ReadArchiveFile(archiveHwd,fileHwd,PChar(boxes),size);
-          CloseArchiveFile(archiveHwd,fileHwd);
-        end;
-        CloseArchive(archiveHwd);
-     end;}
-
      // check if map is &quot;valid&quot;:
      if CheckSum = 0 then
      begin
@@ -739,7 +768,7 @@
     o^.Key := StrNew(GetOptionKey(i));
     o^.Name := StrNew(GetOptionName(i));
     o^.Description := StrNew(GetOptionDesc(i));
-    //o^.Section := StrNew(GetOptionSection(i));
+    o^.Section := StrNew(GetOptionSection(i));
     if modOptions then
     begin
       o^.KeyPrefix := 'GAME/MODOPTIONS/';
@@ -791,30 +820,26 @@
   Result := GetMapArchiveName(0);
 end;
 
-function GetArchiveDescriptor(FileName: string): String;
+function GetModShortName: String;
 var
-  archiveHwd,fileHwd,size: integer;
+  fileHwd,size: integer;
   fileContent: string;
+  s: TTDFParser;
 begin
   Result := '';
-  archiveHwd := OpenArchive(PChar(FileName));
-  if archiveHwd &lt;&gt; 0 then
+  fileHwd := OpenFileVFS('modinfo.tdf');
+  if fileHwd &lt;&gt; 0 then
   begin
-    fileHwd := OpenArchiveFile(archiveHwd,'descriptor.tdf');
-    if fileHwd &lt;&gt; 0 then
-    begin
-      size := SizeArchiveFile(archiveHwd, fileHwd);
-      fileContent := '';
-      SetLength(fileContent,size);
-      ReadArchiveFile(archiveHwd,fileHwd,PChar(fileContent),size);
-      Result := fileContent;
-      CloseArchiveFile(archiveHwd,fileHwd);
-    end;
-    CloseArchive(archiveHwd);
+    size := FileSizeVFS(fileHwd);
+    SetLength(fileContent,size);
+    ReadFileVFS(fileHwd,PChar(fileContent),size);
+    CloseFileVFS(fileHwd);
+    s := TTDFParser.Create(fileContent);
+    Result := s.ReadKeyValue('mod/shortname')
   end;
 end;
 
-{function ExtractVFSDir(Dir: string;ExtractTo: string): boolean;
+function ExtractVFSDir(Dir: string;ExtractTo: string): boolean;
 var
   archiveHwd,fileHwd,size: integer;
   fileContent: string;
@@ -823,17 +848,30 @@
   subDirs: TStringList;
   i: integer;
   fs: TFileStream;
+  outputFileName : string;
 begin
+  // make the subdirs list
+  subDirs := TStringList.Create;
+  res := InitSubDirsVFS(PChar(Dir),'*',nil);
+  SetLength(s, 255);
+  res := FindFilesVFS(res, PChar(s), 255);
+  while res &lt;&gt; 0 do
+  begin
+    subDirs.Add(Trim(s));
+    res := FindFilesVFS(res, PChar(s), 255);
+  end;
+
   res := InitDirListVFS(PChar(Dir),'*',nil);
   SetLength(s, 255);
   res := FindFilesVFS(res, PChar(s), 255);
 
-  if res = 0 then
+  if (res = 0) and (subDirs.Count = 0) then
   begin
     Result := false;
   end
   else
   begin
+    Result := True;
     if not DirectoryExists(ExtractTo) then
       MkDir(ExtractTo);
 
@@ -847,7 +885,10 @@
         size := FileSizeVFS(fileHwd);
         SetLength(fileContent,size);
         ReadFileVFS(fileHwd,PChar(fileContent),size);
-        fs := TFileStream.Create(ExtractTo+'\'+ExtractFileName(StringReplace(Trim(s),'/','\',[rfReplaceAll])),fmOpenWrite or fmCreate );
+        outputFileName := ExtractTo+'\'+ExtractFileName(StringReplace(Trim(s),'/','\',[rfReplaceAll]));
+        if FileExists(outputFileName) then
+          DeleteFile(outputFileName);
+        fs := TFileStream.Create(outputFileName,fmOpenWrite or fmCreate );
         fs.WriteBuffer(fileContent[1],size);
         fs.Free;
         CloseFileVFS(fileHwd);
@@ -856,21 +897,10 @@
       res := FindFilesVFS(res, PChar(s), 255);
     end;
 
-    // make the subdirs list
-    subDirs := TStringList.Create;
-    res := InitSubDirsVFS(PChar(Dir),'*',nil);
-    SetLength(s, 255);
-    res := FindFilesVFS(res, PChar(s), 255);
-    while res &lt;&gt; 0 do
-    begin
-      subDirs.Add(Trim(s));
-      res := FindFilesVFS(res, PChar(s), 255);
-    end;
-
     for i:=0 to subDirs.Count-1 do
-      ExtractVFSDir(subDirs[i],ExtractTo+'\'+ExtractFileNameFromUrl(LeftStr(subDirs[i],Length(subDirs[i])-1)));
+      ExtractVFSDir(subDirs[i],ExtractTo+'\'+ExtractAfterLastSlash(LeftStr(subDirs[i],Length(subDirs[i])-1)));
   end;
-end;}
+end;
 
 
 { ------------------------------------------------------------------------ }


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001278.html">[Taspring-linux-commit] r6508 - trunk/rts/System/Platform/Linux
</A></li>
	<LI>Next message: <A HREF="001280.html">[Taspring-linux-commit] r6510 - in trunk/rts: System build/scons
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1279">[ date ]</a>
              <a href="thread.html#1279">[ thread ]</a>
              <a href="subject.html#1279">[ subject ]</a>
              <a href="author.html#1279">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
