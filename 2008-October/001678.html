<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r6909 - in trunk/rts: Game Lua	Rendering/UnitModels Sim/Projectiles Sim/Projectiles/Unsynced	Sim/Projectiles/WeaponProjectiles Sim/Units System
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-October/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6909%20-%20in%20trunk/rts%3A%20Game%20Lua%0A%09Rendering/UnitModels%20Sim/Projectiles%20Sim/Projectiles/Unsynced%0A%09Sim/Projectiles/WeaponProjectiles%20Sim/Units%20System&In-Reply-To=%3C20081026221159.B15D84751%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001677.html">
   <LINK REL="Next"  HREF="001679.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r6909 - in trunk/rts: Game Lua	Rendering/UnitModels Sim/Projectiles Sim/Projectiles/Unsynced	Sim/Projectiles/WeaponProjectiles Sim/Units System</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6909%20-%20in%20trunk/rts%3A%20Game%20Lua%0A%09Rendering/UnitModels%20Sim/Projectiles%20Sim/Projectiles/Unsynced%0A%09Sim/Projectiles/WeaponProjectiles%20Sim/Units%20System&In-Reply-To=%3C20081026221159.B15D84751%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r6909 - in trunk/rts: Game Lua	Rendering/UnitModels Sim/Projectiles Sim/Projectiles/Unsynced	Sim/Projectiles/WeaponProjectiles Sim/Units System">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Sun Oct 26 23:11:59 CET 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001677.html">[Taspring-linux-commit] r6908 -	trunk/installer/builddata/springcontent
</A></li>
        <LI>Next message: <A HREF="001679.html">[Taspring-linux-commit] r6910 - trunk/AI/Global/AAI
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1678">[ date ]</a>
              <a href="thread.html#1678">[ thread ]</a>
              <a href="subject.html#1678">[ subject ]</a>
              <a href="author.html#1678">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: zerver
Date: 2008-10-26 23:11:58 +0100 (Sun, 26 Oct 2008)
New Revision: 6909

Modified:
   trunk/rts/Game/Game.cpp
   trunk/rts/Game/SelectedUnits.cpp
   trunk/rts/Lua/LuaOpenGL.cpp
   trunk/rts/Lua/LuaUnsyncedRead.cpp
   trunk/rts/Rendering/UnitModels/UnitDrawer.cpp
   trunk/rts/Sim/Projectiles/PieceProjectile.cpp
   trunk/rts/Sim/Projectiles/Projectile.cpp
   trunk/rts/Sim/Projectiles/Projectile.h
   trunk/rts/Sim/Projectiles/ProjectileHandler.cpp
   trunk/rts/Sim/Projectiles/Unsynced/BubbleProjectile.cpp
   trunk/rts/Sim/Projectiles/Unsynced/DirtProjectile.cpp
   trunk/rts/Sim/Projectiles/Unsynced/ExploSpikeProjectile.cpp
   trunk/rts/Sim/Projectiles/Unsynced/GenericParticleProjectile.cpp
   trunk/rts/Sim/Projectiles/Unsynced/GfxProjectile.cpp
   trunk/rts/Sim/Projectiles/Unsynced/HeatCloudProjectile.cpp
   trunk/rts/Sim/Projectiles/Unsynced/RepulseGfx.cpp
   trunk/rts/Sim/Projectiles/Unsynced/SmokeProjectile.cpp
   trunk/rts/Sim/Projectiles/Unsynced/TracerProjectile.cpp
   trunk/rts/Sim/Projectiles/Unsynced/WakeProjectile.cpp
   trunk/rts/Sim/Projectiles/Unsynced/WreckProjectile.cpp
   trunk/rts/Sim/Projectiles/WeaponProjectiles/EmgProjectile.cpp
   trunk/rts/Sim/Projectiles/WeaponProjectiles/ExplosiveProjectile.cpp
   trunk/rts/Sim/Projectiles/WeaponProjectiles/FireBallProjectile.cpp
   trunk/rts/Sim/Projectiles/WeaponProjectiles/FlameProjectile.cpp
   trunk/rts/Sim/Projectiles/WeaponProjectiles/LaserProjectile.cpp
   trunk/rts/Sim/Projectiles/WeaponProjectiles/MissileProjectile.cpp
   trunk/rts/Sim/Projectiles/WeaponProjectiles/StarburstProjectile.cpp
   trunk/rts/Sim/Projectiles/WeaponProjectiles/TorpedoProjectile.cpp
   trunk/rts/Sim/Projectiles/WeaponProjectiles/WeaponProjectile.cpp
   trunk/rts/Sim/Units/Unit.cpp
   trunk/rts/Sim/Units/Unit.h
   trunk/rts/Sim/Units/UnitHandler.cpp
   trunk/rts/System/GlobalUnsynced.h
Log:
Reduced interpolation stutter for multithreaded rendering

Modified: trunk/rts/Game/Game.cpp
===================================================================
--- trunk/rts/Game/Game.cpp	2008-10-26 22:03:55 UTC (rev 6908)
+++ trunk/rts/Game/Game.cpp	2008-10-26 22:11:58 UTC (rev 6909)
@@ -204,6 +204,8 @@
 
 	CR_MEMBER(moveWarnings),
 
+	CR_MEMBER(lastSimFrame),
+
 //	CR_MEMBER(script),
 	CR_RESERVED(64),
 	CR_POSTLOAD(PostLoad)
@@ -2756,9 +2758,9 @@
 
 //	logOutput &lt;&lt; mouse-&gt;lastx &lt;&lt; &quot;\n&quot;;
 	if(!gs-&gt;paused &amp;&amp; !HasLag() &amp;&amp; gs-&gt;frameNum&gt;1 &amp;&amp; !creatingVideo){
-		unsigned startDraw = SDL_GetTicks();
-		gu-&gt;timeOffset = ((float)(startDraw - lastUpdate) * 0.001f)
-		                 * (float)(GAME_SPEED * gs-&gt;speedFactor);
+		gu-&gt;lastFrameStart = SDL_GetTicks();
+		gu-&gt;weightedSpeedFactor = 0.001f * GAME_SPEED * gs-&gt;speedFactor;
+		gu-&gt;timeOffset = (float)(gu-&gt;lastFrameStart - lastUpdate) * gu-&gt;weightedSpeedFactor;
 	} else  {
 		gu-&gt;timeOffset=0;
 		lastUpdate = SDL_GetTicks();
@@ -4322,7 +4324,7 @@
 			             float3(camera-&gt;right.z, camera-&gt;up.z, camera-&gt;forward.z));
 			glMultMatrixf(m.m);
 		}
-		glTranslatef3(-unit-&gt;pos - (unit-&gt;speed * gu-&gt;timeOffset));
+		glTranslatef3(-unit-&gt;drawPos);
 		glDisable(GL_BLEND);
 		unit-&gt;currentLOD = 0;
 		unitDrawer-&gt;DrawIndividual(unit); // draw the unit

Modified: trunk/rts/Game/SelectedUnits.cpp
===================================================================
--- trunk/rts/Game/SelectedUnits.cpp	2008-10-26 22:03:55 UTC (rev 6908)
+++ trunk/rts/Game/SelectedUnits.cpp	2008-10-26 22:11:58 UTC (rev 6909)
@@ -366,7 +366,7 @@
 {
 	// if unit is being transported by eg. Hulk or Atlas
 	// then we should not be able to select it
-	CTransportUnit *trans=unit-&gt;transporter;
+	CTransportUnit *trans=unit-&gt;GetTransporter();
 	if (trans != NULL &amp;&amp; !trans-&gt;unitDef-&gt;isFirePlatform) {
 		return;
 	}
@@ -478,11 +478,11 @@
 			if (unit-&gt;isIcon) {
 				continue;
 			}
-			const float3 pos(unit-&gt;pos + unit-&gt;speed * gu-&gt;timeOffset);
-			glVertexf3(pos + float3( unit-&gt;xsize * 4, 0,  unit-&gt;ysize * 4));
-			glVertexf3(pos + float3(-unit-&gt;xsize * 4, 0,  unit-&gt;ysize * 4));
-			glVertexf3(pos + float3(-unit-&gt;xsize * 4, 0, -unit-&gt;ysize * 4));
-			glVertexf3(pos + float3( unit-&gt;xsize * 4, 0, -unit-&gt;ysize * 4));
+
+			glVertexf3(unit-&gt;drawPos + float3( unit-&gt;xsize * 4, 0,  unit-&gt;ysize * 4));
+			glVertexf3(unit-&gt;drawPos + float3(-unit-&gt;xsize * 4, 0,  unit-&gt;ysize * 4));
+			glVertexf3(unit-&gt;drawPos + float3(-unit-&gt;xsize * 4, 0, -unit-&gt;ysize * 4));
+			glVertexf3(unit-&gt;drawPos + float3( unit-&gt;xsize * 4, 0, -unit-&gt;ysize * 4));
 		}
 		glEnd();
 	}

Modified: trunk/rts/Lua/LuaOpenGL.cpp
===================================================================
--- trunk/rts/Lua/LuaOpenGL.cpp	2008-10-26 22:03:55 UTC (rev 6908)
+++ trunk/rts/Lua/LuaOpenGL.cpp	2008-10-26 22:11:58 UTC (rev 6909)
@@ -1968,7 +1968,7 @@
 	}
 
 	float3 pos = midPos ? (float3)unit-&gt;midPos : (float3)unit-&gt;pos;
-	CTransportUnit *trans=unit-&gt;transporter;
+	CTransportUnit *trans=unit-&gt;GetTransporter();
 	if (trans == NULL) {
 		pos += (unit-&gt;speed * gu-&gt;timeOffset);
 	} else {
@@ -2017,7 +2017,7 @@
 	}
 
 	float3 pos = midPos ? (float3)unit-&gt;midPos : (float3)unit-&gt;pos;
-	CTransportUnit *trans=unit-&gt;transporter;
+	CTransportUnit *trans=unit-&gt;GetTransporter();
 	if (trans == NULL) {
 		pos += (unit-&gt;speed * gu-&gt;timeOffset);
 	} else {

Modified: trunk/rts/Lua/LuaUnsyncedRead.cpp
===================================================================
--- trunk/rts/Lua/LuaUnsyncedRead.cpp	2008-10-26 22:03:55 UTC (rev 6908)
+++ trunk/rts/Lua/LuaUnsyncedRead.cpp	2008-10-26 22:11:58 UTC (rev 6909)
@@ -568,10 +568,11 @@
 	const bool midPos = (lua_isboolean(L, 2) &amp;&amp; lua_toboolean(L, 2));
 
 	float3 pos = midPos ? (float3)unit-&gt;midPos : (float3)unit-&gt;pos;
-	if (unit-&gt;transporter == NULL) {
+	CTransportUnit *trans=unit-&gt;GetTransporter();
+	if (trans == NULL) {
 		pos += (unit-&gt;speed * gu-&gt;timeOffset);
 	} else {
-		pos += (unit-&gt;transporter-&gt;speed * gu-&gt;timeOffset);
+		pos += (trans-&gt;speed * gu-&gt;timeOffset);
 	}
 
 	lua_pushnumber(L, pos.x);

Modified: trunk/rts/Rendering/UnitModels/UnitDrawer.cpp
===================================================================
--- trunk/rts/Rendering/UnitModels/UnitDrawer.cpp	2008-10-26 22:03:55 UTC (rev 6908)
+++ trunk/rts/Rendering/UnitModels/UnitDrawer.cpp	2008-10-26 22:11:58 UTC (rev 6909)
@@ -298,6 +298,7 @@
 
 
 inline void CUnitDrawer::DoDrawUnit(CUnit *unit, bool drawReflection, bool drawRefraction, CUnit *excludeUnit) {
+	unit-&gt;UpdateDrawPos();
 #ifdef DIRECT_CONTROL_ALLOWED
 	if (unit == excludeUnit) {
 		return;
@@ -724,7 +725,7 @@
 
 inline void CUnitDrawer::DrawFar(CUnit *unit)
 {
-	float3 interPos = unit-&gt;pos + unit-&gt;speed * gu-&gt;timeOffset + UpVector * unit-&gt;model-&gt;height * 0.5f;
+	float3 interPos = unit-&gt;drawPos + UpVector * unit-&gt;model-&gt;height * 0.5f;
 	int snurr =- unit-&gt;heading + GetHeadingFromVector(camera-&gt;pos.x - unit-&gt;pos.x, camera-&gt;pos.z - unit-&gt;pos.z) + (0xffff &gt;&gt; 4);
 
 	if (snurr &lt; 0)
@@ -2043,15 +2044,8 @@
 		return;
 	}
 
-	float3 interPos;
+	float3 interPos = unit-&gt;drawPos;
 
-	CTransportUnit *trans=unit-&gt;transporter;
-	if (!trans) {
-		interPos = unit-&gt;pos + (unit-&gt;speed * gu-&gt;timeOffset);
-	} else {
-		interPos = unit-&gt;pos + (trans-&gt;speed * gu-&gt;timeOffset);
-	}
-
 	interPos.y += unit-&gt;model-&gt;height + 5.0f;
 
 	// setup the billboard transformation

Modified: trunk/rts/Sim/Projectiles/PieceProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/PieceProjectile.cpp	2008-10-26 22:03:55 UTC (rev 6908)
+++ trunk/rts/Sim/Projectiles/PieceProjectile.cpp	2008-10-26 22:11:58 UTC (rev 6909)
@@ -334,7 +334,6 @@
 	if (flags &amp; PP_NoCEGTrail) {
 		if (flags &amp; PP_Smoke) {
 			// this piece leaves a default (non-CEG) smoketrail
-			float3 interPos = pos + speed * gu-&gt;timeOffset;
 			inArray = true;
 			float age2 = (age &amp; 7) + gu-&gt;timeOffset;
 			float color = 0.5f;
@@ -347,7 +346,7 @@
 			va-&gt;EnlargeArrays(4+4*numParts,0,VA_SIZE_TC);
 			if (drawTrail) {
 				// draw the trail as a single quad if camera close enough
-				float3 dif(interPos - camera-&gt;pos);
+				float3 dif(drawPos - camera-&gt;pos);
 				dif.Normalize();
 				float3 dir1(dif.cross(dir));
 				dir1.Normalize();
@@ -379,8 +378,8 @@
 				float size2 = 1 + (age2 * (1 / Smoke_Time)) * 14;
 				float txs = ph-&gt;smoketrailtex.xstart - (ph-&gt;smoketrailtex.xend - ph-&gt;smoketrailtex.xstart) * (age2 / 8.0f);
 
-				va-&gt;AddVertexQTC(interPos - dir1 * size, txs, ph-&gt;smoketrailtex.ystart, col);
-				va-&gt;AddVertexQTC(interPos + dir1 * size, txs, ph-&gt;smoketrailtex.yend,   col);
+				va-&gt;AddVertexQTC(drawPos - dir1 * size, txs, ph-&gt;smoketrailtex.ystart, col);
+				va-&gt;AddVertexQTC(drawPos + dir1 * size, txs, ph-&gt;smoketrailtex.yend,   col);
 				va-&gt;AddVertexQTC(oldSmoke + dir2 * size2, ph-&gt;smoketrailtex.xend, ph-&gt;smoketrailtex.yend,   col2);
 				va-&gt;AddVertexQTC(oldSmoke - dir2 * size2, ph-&gt;smoketrailtex.xend, ph-&gt;smoketrailtex.ystart, col2);
 			} else {

Modified: trunk/rts/Sim/Projectiles/Projectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/Projectile.cpp	2008-10-26 22:03:55 UTC (rev 6908)
+++ trunk/rts/Sim/Projectiles/Projectile.cpp	2008-10-26 22:11:58 UTC (rev 6909)
@@ -23,7 +23,8 @@
 	CR_MEMBER(castShadow),
 	CR_MEMBER(owner),
 	CR_MEMBER(synced),
-
+	CR_MEMBER(drawPos),
+	CR_RESERVED(4),
 	CR_MEMBER_BEGINFLAG(CM_Config),
 		CR_MEMBER(speed),
 	CR_MEMBER_ENDFLAG(CM_Config),
@@ -43,7 +44,11 @@
 	castShadow(false),
 	s3domodel(0),
 	collisionFlags(0)
-{}
+{
+#if defined(USE_GML) &amp;&amp; GML_ENABLE_SIMDRAW
+	lastProjUpdate=gu-&gt;lastFrameStart;
+#endif
+}
 
 
 void CProjectile::Init(const float3&amp; explosionPos, CUnit* owner)
@@ -116,11 +121,10 @@
 	col[1]=(unsigned char) (0.5f*255);
 	col[2]=0*255;
 	col[3]=10;
-	float3 interPos=pos+speed*gu-&gt;timeOffset;
-	va-&gt;AddVertexTC(interPos-camera-&gt;right*drawRadius-camera-&gt;up*drawRadius,ph-&gt;projectiletex.xstart,ph-&gt;projectiletex.ystart,col);
-	va-&gt;AddVertexTC(interPos+camera-&gt;right*drawRadius-camera-&gt;up*drawRadius,ph-&gt;projectiletex.xend,ph-&gt;projectiletex.ystart,col);
-	va-&gt;AddVertexTC(interPos+camera-&gt;right*drawRadius+camera-&gt;up*drawRadius,ph-&gt;projectiletex.xend,ph-&gt;projectiletex.yend,col);
-	va-&gt;AddVertexTC(interPos-camera-&gt;right*drawRadius+camera-&gt;up*drawRadius,ph-&gt;projectiletex.xstart,ph-&gt;projectiletex.yend,col);
+	va-&gt;AddVertexTC(drawPos-camera-&gt;right*drawRadius-camera-&gt;up*drawRadius,ph-&gt;projectiletex.xstart,ph-&gt;projectiletex.ystart,col);
+	va-&gt;AddVertexTC(drawPos+camera-&gt;right*drawRadius-camera-&gt;up*drawRadius,ph-&gt;projectiletex.xend,ph-&gt;projectiletex.ystart,col);
+	va-&gt;AddVertexTC(drawPos+camera-&gt;right*drawRadius+camera-&gt;up*drawRadius,ph-&gt;projectiletex.xend,ph-&gt;projectiletex.yend,col);
+	va-&gt;AddVertexTC(drawPos-camera-&gt;right*drawRadius+camera-&gt;up*drawRadius,ph-&gt;projectiletex.xstart,ph-&gt;projectiletex.yend,col);
 }
 
 void CProjectile::DrawArray()
@@ -146,3 +150,11 @@
 void CProjectile::DrawUnitPart(void)
 {
 }
+
+void CProjectile::UpdateDrawPos() {
+#if defined(USE_GML) &amp;&amp; GML_ENABLE_SIMDRAW
+		drawPos = pos + (speed * ((float)gu-&gt;lastFrameStart - (float)lastProjUpdate) * gu-&gt;weightedSpeedFactor);
+#else
+		drawPos = pos + (speed * gu-&gt;timeOffset);
+#endif
+}
\ No newline at end of file

Modified: trunk/rts/Sim/Projectiles/Projectile.h
===================================================================
--- trunk/rts/Sim/Projectiles/Projectile.h	2008-10-26 22:03:55 UTC (rev 6908)
+++ trunk/rts/Sim/Projectiles/Projectile.h	2008-10-26 22:11:58 UTC (rev 6909)
@@ -1,5 +1,6 @@
 #ifndef PROJECTILE_H
 #define PROJECTILE_H
+#include &quot;Rendering/GL/myGL.h&quot;
 // Projectile.h: interface for the CProjectile class.
 //
 //////////////////////////////////////////////////////////////////////
@@ -48,6 +49,12 @@
 	bool castShadow;
 	unsigned int collisionFlags;
 
+	void UpdateDrawPos();
+	float3 drawPos;
+#if defined(USE_GML) &amp;&amp; GML_ENABLE_SIMDRAW
+	unsigned lastProjUpdate;
+#endif
+
 	CUnit* owner;
 	float3 speed;
 	virtual void DrawCallback(void);

Modified: trunk/rts/Sim/Projectiles/ProjectileHandler.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/ProjectileHandler.cpp	2008-10-26 22:03:55 UTC (rev 6908)
+++ trunk/rts/Sim/Projectiles/ProjectileHandler.cpp	2008-10-26 22:11:58 UTC (rev 6909)
@@ -429,6 +429,9 @@
 			delete p;
 		} else {
 			p-&gt;Update();
+#if defined(USE_GML) &amp;&amp; GML_ENABLE_SIMDRAW
+			p-&gt;lastProjUpdate=gu-&gt;lastFrameStart;
+#endif
 			++psi;
 		}
 	}
@@ -580,11 +583,13 @@
 	for (psi = ps.begin(); psi != ps.end(); ++psi) {
 		CProjectile* pro = *psi;
 
+		pro-&gt;UpdateDrawPos();
+
 		if (camera-&gt;InView(pro-&gt;pos, pro-&gt;drawRadius) &amp;&amp; (gu-&gt;spectatingFullView || loshandler-&gt;InLos(pro, gu-&gt;myAllyTeam) ||
 			(pro-&gt;owner &amp;&amp; gs-&gt;Ally(pro-&gt;owner-&gt;allyteam, gu-&gt;myAllyTeam)))) {
 
 			CUnit* owner = pro-&gt;owner;
-			CUnit* trans = owner? (CUnit*) owner-&gt;transporter: 0;
+			CUnit* trans = owner? (CUnit*) owner-&gt;GetTransporter(): 0;
 			bool stunned = owner? owner-&gt;stunned: false;
 
 			if (owner &amp;&amp; trans &amp;&amp; stunned &amp;&amp; dynamic_cast&lt;CShieldPartProjectile*&gt;(pro)) {

Modified: trunk/rts/Sim/Projectiles/Unsynced/BubbleProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/Unsynced/BubbleProjectile.cpp	2008-10-26 22:03:55 UTC (rev 6908)
+++ trunk/rts/Sim/Projectiles/Unsynced/BubbleProjectile.cpp	2008-10-26 22:11:58 UTC (rev 6909)
@@ -67,10 +67,9 @@
 	col[2]=(unsigned char)(255*alpha);
 	col[3]=(unsigned char)(255*alpha);
 
-	float3 interPos=pos+speed*gu-&gt;timeOffset;
 	float interSize=size+sizeExpansion*gu-&gt;timeOffset;
-	va-&gt;AddVertexTC(interPos-camera-&gt;right*interSize-camera-&gt;up*interSize,ph-&gt;bubbletex.xstart    ,ph-&gt;bubbletex.ystart    ,col);
-	va-&gt;AddVertexTC(interPos+camera-&gt;right*interSize-camera-&gt;up*interSize,ph-&gt;bubbletex.xend,ph-&gt;bubbletex.ystart    ,col);
-	va-&gt;AddVertexTC(interPos+camera-&gt;right*interSize+camera-&gt;up*interSize,ph-&gt;bubbletex.xend,ph-&gt;bubbletex.yend,col);
-	va-&gt;AddVertexTC(interPos-camera-&gt;right*interSize+camera-&gt;up*interSize,ph-&gt;bubbletex.xstart    ,ph-&gt;bubbletex.yend,col);
+	va-&gt;AddVertexTC(drawPos-camera-&gt;right*interSize-camera-&gt;up*interSize,ph-&gt;bubbletex.xstart    ,ph-&gt;bubbletex.ystart    ,col);
+	va-&gt;AddVertexTC(drawPos+camera-&gt;right*interSize-camera-&gt;up*interSize,ph-&gt;bubbletex.xend,ph-&gt;bubbletex.ystart    ,col);
+	va-&gt;AddVertexTC(drawPos+camera-&gt;right*interSize+camera-&gt;up*interSize,ph-&gt;bubbletex.xend,ph-&gt;bubbletex.yend,col);
+	va-&gt;AddVertexTC(drawPos-camera-&gt;right*interSize+camera-&gt;up*interSize,ph-&gt;bubbletex.xstart    ,ph-&gt;bubbletex.yend,col);
 }

Modified: trunk/rts/Sim/Projectiles/Unsynced/DirtProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/Unsynced/DirtProjectile.cpp	2008-10-26 22:03:55 UTC (rev 6908)
+++ trunk/rts/Sim/Projectiles/Unsynced/DirtProjectile.cpp	2008-10-26 22:11:58 UTC (rev 6909)
@@ -90,12 +90,11 @@
 	col[2]=(unsigned char) (color.z*alpha);
 	col[3]=(unsigned char) (alpha)/*-gu-&gt;timeOffset*alphaFalloff*/;
 
-	float3 interPos=pos+speed*gu-&gt;timeOffset;
 	float interSize=size+gu-&gt;timeOffset*sizeExpansion;
 	float texx = texture-&gt;xstart + (texture-&gt;xend-texture-&gt;xstart)*((1-partAbove)*0.5f);//0.25f*(1-partAbove)
 
-	va-&gt;AddVertexTC(interPos-camera-&gt;right*interSize-camera-&gt;up*interSize*partAbove,texx,texture-&gt;ystart,col);
-	va-&gt;AddVertexTC(interPos+camera-&gt;right*interSize-camera-&gt;up*interSize*partAbove,texx,texture-&gt;yend,col);
-	va-&gt;AddVertexTC(interPos+camera-&gt;right*interSize+camera-&gt;up*interSize,texture-&gt;xend,texture-&gt;yend,col);
-	va-&gt;AddVertexTC(interPos-camera-&gt;right*interSize+camera-&gt;up*interSize,texture-&gt;xend,texture-&gt;ystart,col);
+	va-&gt;AddVertexTC(drawPos-camera-&gt;right*interSize-camera-&gt;up*interSize*partAbove,texx,texture-&gt;ystart,col);
+	va-&gt;AddVertexTC(drawPos+camera-&gt;right*interSize-camera-&gt;up*interSize*partAbove,texx,texture-&gt;yend,col);
+	va-&gt;AddVertexTC(drawPos+camera-&gt;right*interSize+camera-&gt;up*interSize,texture-&gt;xend,texture-&gt;yend,col);
+	va-&gt;AddVertexTC(drawPos-camera-&gt;right*interSize+camera-&gt;up*interSize,texture-&gt;xend,texture-&gt;ystart,col);
 }

Modified: trunk/rts/Sim/Projectiles/Unsynced/ExploSpikeProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/Unsynced/ExploSpikeProjectile.cpp	2008-10-26 22:03:55 UTC (rev 6908)
+++ trunk/rts/Sim/Projectiles/Unsynced/ExploSpikeProjectile.cpp	2008-10-26 22:11:58 UTC (rev 6909)
@@ -77,14 +77,13 @@
 	col[2]=(unsigned char)(a*color.z);
 	col[3]=1;
 
-	float3 interpos=pos+speed*gu-&gt;timeOffset;
 	float3 l=dir*length+lengthGrowth*gu-&gt;timeOffset;
 	float3 w=dir2*width;
 
-	va-&gt;AddVertexTC(interpos+l+w, ph-&gt;laserendtex.xend, ph-&gt;laserendtex.yend, col);
-	va-&gt;AddVertexTC(interpos+l-w, ph-&gt;laserendtex.xend, ph-&gt;laserendtex.ystart, col);
-	va-&gt;AddVertexTC(interpos-l-w, ph-&gt;laserendtex.xstart, ph-&gt;laserendtex.ystart, col);
-	va-&gt;AddVertexTC(interpos-l+w, ph-&gt;laserendtex.xstart, ph-&gt;laserendtex.yend, col);
+	va-&gt;AddVertexTC(drawPos+l+w, ph-&gt;laserendtex.xend, ph-&gt;laserendtex.yend, col);
+	va-&gt;AddVertexTC(drawPos+l-w, ph-&gt;laserendtex.xend, ph-&gt;laserendtex.ystart, col);
+	va-&gt;AddVertexTC(drawPos-l-w, ph-&gt;laserendtex.xstart, ph-&gt;laserendtex.ystart, col);
+	va-&gt;AddVertexTC(drawPos-l+w, ph-&gt;laserendtex.xstart, ph-&gt;laserendtex.yend, col);
 }
 
 void CExploSpikeProjectile::Init(const float3&amp; pos, CUnit *owner)

Modified: trunk/rts/Sim/Projectiles/Unsynced/GenericParticleProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/Unsynced/GenericParticleProjectile.cpp	2008-10-26 22:03:55 UTC (rev 6908)
+++ trunk/rts/Sim/Projectiles/Unsynced/GenericParticleProjectile.cpp	2008-10-26 22:11:58 UTC (rev 6909)
@@ -65,23 +65,21 @@
 		unsigned char color[4];
 
 		colorMap-&gt;GetColor(color, life);
-		float3 interPos=pos+speed*gu-&gt;timeOffset;
 
-		va-&gt;AddVertexTC(interPos-dir1*size-dir2*size,texture-&gt;xstart,texture-&gt;ystart,color);
-		va-&gt;AddVertexTC(interPos-dir1*size+dir2*size,texture-&gt;xend ,texture-&gt;ystart,color);
-		va-&gt;AddVertexTC(interPos+dir1*size+dir2*size,texture-&gt;xend ,texture-&gt;yend ,color);
-		va-&gt;AddVertexTC(interPos+dir1*size-dir2*size,texture-&gt;xstart,texture-&gt;yend ,color);
+		va-&gt;AddVertexTC(drawPos-dir1*size-dir2*size,texture-&gt;xstart,texture-&gt;ystart,color);
+		va-&gt;AddVertexTC(drawPos-dir1*size+dir2*size,texture-&gt;xend ,texture-&gt;ystart,color);
+		va-&gt;AddVertexTC(drawPos+dir1*size+dir2*size,texture-&gt;xend ,texture-&gt;yend ,color);
+		va-&gt;AddVertexTC(drawPos+dir1*size-dir2*size,texture-&gt;xstart,texture-&gt;yend ,color);
 	}
 	else
 	{
 		unsigned char color[4];
 
 		colorMap-&gt;GetColor(color, life);
-		float3 interPos=pos+speed*gu-&gt;timeOffset;
 
-		va-&gt;AddVertexTC(interPos-camera-&gt;right*size-camera-&gt;up*size,texture-&gt;xstart,texture-&gt;ystart,color);
-		va-&gt;AddVertexTC(interPos+camera-&gt;right*size-camera-&gt;up*size,texture-&gt;xend ,texture-&gt;ystart,color);
-		va-&gt;AddVertexTC(interPos+camera-&gt;right*size+camera-&gt;up*size,texture-&gt;xend ,texture-&gt;yend ,color);
-		va-&gt;AddVertexTC(interPos-camera-&gt;right*size+camera-&gt;up*size,texture-&gt;xstart,texture-&gt;yend ,color);
+		va-&gt;AddVertexTC(drawPos-camera-&gt;right*size-camera-&gt;up*size,texture-&gt;xstart,texture-&gt;ystart,color);
+		va-&gt;AddVertexTC(drawPos+camera-&gt;right*size-camera-&gt;up*size,texture-&gt;xend ,texture-&gt;ystart,color);
+		va-&gt;AddVertexTC(drawPos+camera-&gt;right*size+camera-&gt;up*size,texture-&gt;xend ,texture-&gt;yend ,color);
+		va-&gt;AddVertexTC(drawPos-camera-&gt;right*size+camera-&gt;up*size,texture-&gt;xstart,texture-&gt;yend ,color);
 	}
 }

Modified: trunk/rts/Sim/Projectiles/Unsynced/GfxProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/Unsynced/GfxProjectile.cpp	2008-10-26 22:03:55 UTC (rev 6908)
+++ trunk/rts/Sim/Projectiles/Unsynced/GfxProjectile.cpp	2008-10-26 22:11:58 UTC (rev 6909)
@@ -65,9 +65,8 @@
 {
 	inArray=true;
 
-	float3 interPos=pos+speed*gu-&gt;timeOffset;
-	va-&gt;AddVertexTC(interPos-camera-&gt;right*drawRadius-camera-&gt;up*drawRadius,ph-&gt;gfxtex.xstart,ph-&gt;gfxtex.ystart,color);
-	va-&gt;AddVertexTC(interPos+camera-&gt;right*drawRadius-camera-&gt;up*drawRadius,ph-&gt;gfxtex.xend,ph-&gt;gfxtex.ystart,color);
-	va-&gt;AddVertexTC(interPos+camera-&gt;right*drawRadius+camera-&gt;up*drawRadius,ph-&gt;gfxtex.xend,ph-&gt;gfxtex.yend,color);
-	va-&gt;AddVertexTC(interPos-camera-&gt;right*drawRadius+camera-&gt;up*drawRadius,ph-&gt;gfxtex.xstart,ph-&gt;gfxtex.yend,color);
+	va-&gt;AddVertexTC(drawPos-camera-&gt;right*drawRadius-camera-&gt;up*drawRadius,ph-&gt;gfxtex.xstart,ph-&gt;gfxtex.ystart,color);
+	va-&gt;AddVertexTC(drawPos+camera-&gt;right*drawRadius-camera-&gt;up*drawRadius,ph-&gt;gfxtex.xend,ph-&gt;gfxtex.ystart,color);
+	va-&gt;AddVertexTC(drawPos+camera-&gt;right*drawRadius+camera-&gt;up*drawRadius,ph-&gt;gfxtex.xend,ph-&gt;gfxtex.yend,color);
+	va-&gt;AddVertexTC(drawPos-camera-&gt;right*drawRadius+camera-&gt;up*drawRadius,ph-&gt;gfxtex.xstart,ph-&gt;gfxtex.yend,color);
 }

Modified: trunk/rts/Sim/Projectiles/Unsynced/HeatCloudProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/Unsynced/HeatCloudProjectile.cpp	2008-10-26 22:03:55 UTC (rev 6908)
+++ trunk/rts/Sim/Projectiles/Unsynced/HeatCloudProjectile.cpp	2008-10-26 22:11:58 UTC (rev 6909)
@@ -87,9 +87,8 @@
 	col[2]=(unsigned char)alpha;
 	col[3]=1;//(dheat/maxheat)*255.0f;
 	float drawsize=(size+sizeGrowth*gu-&gt;timeOffset)*(1-sizemod);
-	float3 interPos=pos+speed*gu-&gt;timeOffset;
-	va-&gt;AddVertexTC(interPos-camera-&gt;right*drawsize-camera-&gt;up*drawsize,texture-&gt;xstart,texture-&gt;ystart,col);
-	va-&gt;AddVertexTC(interPos+camera-&gt;right*drawsize-camera-&gt;up*drawsize,texture-&gt;xend,texture-&gt;ystart,col);
-	va-&gt;AddVertexTC(interPos+camera-&gt;right*drawsize+camera-&gt;up*drawsize,texture-&gt;xend,texture-&gt;yend,col);
-	va-&gt;AddVertexTC(interPos-camera-&gt;right*drawsize+camera-&gt;up*drawsize,texture-&gt;xstart,texture-&gt;yend,col);
+	va-&gt;AddVertexTC(drawPos-camera-&gt;right*drawsize-camera-&gt;up*drawsize,texture-&gt;xstart,texture-&gt;ystart,col);
+	va-&gt;AddVertexTC(drawPos+camera-&gt;right*drawsize-camera-&gt;up*drawsize,texture-&gt;xend,texture-&gt;ystart,col);
+	va-&gt;AddVertexTC(drawPos+camera-&gt;right*drawsize+camera-&gt;up*drawsize,texture-&gt;xend,texture-&gt;yend,col);
+	va-&gt;AddVertexTC(drawPos-camera-&gt;right*drawsize+camera-&gt;up*drawsize,texture-&gt;xstart,texture-&gt;yend,col);
 }

Modified: trunk/rts/Sim/Projectiles/Unsynced/RepulseGfx.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/Unsynced/RepulseGfx.cpp	2008-10-26 22:03:55 UTC (rev 6908)
+++ trunk/rts/Sim/Projectiles/Unsynced/RepulseGfx.cpp	2008-10-26 22:11:58 UTC (rev 6909)
@@ -84,7 +84,6 @@
 	col[2]=(unsigned char)(color.z*alpha);
 	col[3]=(unsigned char)(alpha*0.2f);
 	float drawsize=10;
-	float3 interPos=pos+speed*gu-&gt;timeOffset;
 
 	AtlasedTexture&amp; et=ph-&gt;repulsetex;
 	float txo=et.xstart;

Modified: trunk/rts/Sim/Projectiles/Unsynced/SmokeProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/Unsynced/SmokeProjectile.cpp	2008-10-26 22:03:55 UTC (rev 6908)
+++ trunk/rts/Sim/Projectiles/Unsynced/SmokeProjectile.cpp	2008-10-26 22:11:58 UTC (rev 6909)
@@ -108,12 +108,11 @@
 	//float xmod=0.125f+(float(int(frame%6)))/16;
 	//float ymod=(int(frame/6))/16.0f;
 
-	const float3 interPos(pos+speed*gu-&gt;timeOffset);
 	const float interSize=size+sizeExpansion*gu-&gt;timeOffset;
 	const float3 pos1 ((camera-&gt;right - camera-&gt;up) * interSize);
 	const float3 pos2 ((camera-&gt;right + camera-&gt;up) * interSize);
-	va-&gt;AddVertexTC(interPos-pos2,ph-&gt;smoketex[textureNum].xstart,ph-&gt;smoketex[textureNum].ystart,col);
-	va-&gt;AddVertexTC(interPos+pos1,ph-&gt;smoketex[textureNum].xend,ph-&gt;smoketex[textureNum].ystart,col);
-	va-&gt;AddVertexTC(interPos+pos2,ph-&gt;smoketex[textureNum].xend,ph-&gt;smoketex[textureNum].yend,col);
-	va-&gt;AddVertexTC(interPos-pos1,ph-&gt;smoketex[textureNum].xstart,ph-&gt;smoketex[textureNum].yend,col);
+	va-&gt;AddVertexTC(drawPos-pos2,ph-&gt;smoketex[textureNum].xstart,ph-&gt;smoketex[textureNum].ystart,col);
+	va-&gt;AddVertexTC(drawPos+pos1,ph-&gt;smoketex[textureNum].xend,ph-&gt;smoketex[textureNum].ystart,col);
+	va-&gt;AddVertexTC(drawPos+pos2,ph-&gt;smoketex[textureNum].xend,ph-&gt;smoketex[textureNum].yend,col);
+	va-&gt;AddVertexTC(drawPos-pos1,ph-&gt;smoketex[textureNum].xstart,ph-&gt;smoketex[textureNum].yend,col);
 }

Modified: trunk/rts/Sim/Projectiles/Unsynced/TracerProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/Unsynced/TracerProjectile.cpp	2008-10-26 22:03:55 UTC (rev 6908)
+++ trunk/rts/Sim/Projectiles/Unsynced/TracerProjectile.cpp	2008-10-26 22:11:58 UTC (rev 6909)
@@ -76,11 +76,10 @@
 	if(drawLength&gt;3)
 		drawLength=3;
 
-	float3 interPos=pos+speed*gu-&gt;timeOffset;
 	glTexCoord2f(1.0f/16,1.0f/16);
 	glColor4f(1,1,0.1f,0.4f);
 	glBegin(GL_LINES);
-		glVertexf3( interPos);				
-		glVertexf3( interPos-dir*drawLength);				
+		glVertexf3( drawPos);				
+		glVertexf3( drawPos-dir*drawLength);				
 	glEnd();
 }

Modified: trunk/rts/Sim/Projectiles/Unsynced/WakeProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/Unsynced/WakeProjectile.cpp	2008-10-26 22:03:55 UTC (rev 6908)
+++ trunk/rts/Sim/Projectiles/Unsynced/WakeProjectile.cpp	2008-10-26 22:11:58 UTC (rev 6909)
@@ -81,14 +81,13 @@
 	col[2]=(unsigned char) (255*alpha);
 	col[3]=(unsigned char) (255*alpha)/*-alphaFalloff*gu-&gt;timeOffset*/;
 
-	float3 interPos=pos+speed*gu-&gt;timeOffset;
 	float interSize=size+sizeExpansion*gu-&gt;timeOffset;
 	float interRot=rotation+rotSpeed*gu-&gt;timeOffset;
 
 	float3 dir1=float3(cos(interRot),0,sin(interRot))*interSize;
 	float3 dir2=dir1.cross(UpVector);
-	va-&gt;AddVertexTC(interPos+dir1+dir2, ph-&gt;waketex.xstart,ph-&gt;waketex.ystart,col);
-	va-&gt;AddVertexTC(interPos+dir1-dir2, ph-&gt;waketex.xstart,ph-&gt;waketex.yend,col);
-	va-&gt;AddVertexTC(interPos-dir1-dir2, ph-&gt;waketex.xend,ph-&gt;waketex.yend,col);
-	va-&gt;AddVertexTC(interPos-dir1+dir2, ph-&gt;waketex.xend,ph-&gt;waketex.ystart,col);
+	va-&gt;AddVertexTC(drawPos+dir1+dir2, ph-&gt;waketex.xstart,ph-&gt;waketex.ystart,col);
+	va-&gt;AddVertexTC(drawPos+dir1-dir2, ph-&gt;waketex.xstart,ph-&gt;waketex.yend,col);
+	va-&gt;AddVertexTC(drawPos-dir1-dir2, ph-&gt;waketex.xend,ph-&gt;waketex.yend,col);
+	va-&gt;AddVertexTC(drawPos-dir1+dir2, ph-&gt;waketex.xend,ph-&gt;waketex.ystart,col);
 }

Modified: trunk/rts/Sim/Projectiles/Unsynced/WreckProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/Unsynced/WreckProjectile.cpp	2008-10-26 22:03:55 UTC (rev 6908)
+++ trunk/rts/Sim/Projectiles/Unsynced/WreckProjectile.cpp	2008-10-26 22:11:58 UTC (rev 6909)
@@ -63,9 +63,8 @@
 	col[2]=(unsigned char) (0.05f*200);
 	col[3]=200;
 
-	float3 interPos=pos+speed*gu-&gt;timeOffset;
-	va-&gt;AddVertexTC(interPos-camera-&gt;right*drawRadius-camera-&gt;up*drawRadius,ph-&gt;wrecktex.xstart,ph-&gt;wrecktex.ystart,col);
-	va-&gt;AddVertexTC(interPos+camera-&gt;right*drawRadius-camera-&gt;up*drawRadius,ph-&gt;wrecktex.xend,ph-&gt;wrecktex.ystart,col);
-	va-&gt;AddVertexTC(interPos+camera-&gt;right*drawRadius+camera-&gt;up*drawRadius,ph-&gt;wrecktex.xend,ph-&gt;wrecktex.yend,col);
-	va-&gt;AddVertexTC(interPos-camera-&gt;right*drawRadius+camera-&gt;up*drawRadius,ph-&gt;wrecktex.xstart,ph-&gt;wrecktex.yend,col);
+	va-&gt;AddVertexTC(drawPos-camera-&gt;right*drawRadius-camera-&gt;up*drawRadius,ph-&gt;wrecktex.xstart,ph-&gt;wrecktex.ystart,col);
+	va-&gt;AddVertexTC(drawPos+camera-&gt;right*drawRadius-camera-&gt;up*drawRadius,ph-&gt;wrecktex.xend,ph-&gt;wrecktex.ystart,col);
+	va-&gt;AddVertexTC(drawPos+camera-&gt;right*drawRadius+camera-&gt;up*drawRadius,ph-&gt;wrecktex.xend,ph-&gt;wrecktex.yend,col);
+	va-&gt;AddVertexTC(drawPos-camera-&gt;right*drawRadius+camera-&gt;up*drawRadius,ph-&gt;wrecktex.xstart,ph-&gt;wrecktex.yend,col);
 }

Modified: trunk/rts/Sim/Projectiles/WeaponProjectiles/EmgProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/WeaponProjectiles/EmgProjectile.cpp	2008-10-26 22:03:55 UTC (rev 6908)
+++ trunk/rts/Sim/Projectiles/WeaponProjectiles/EmgProjectile.cpp	2008-10-26 22:11:58 UTC (rev 6909)
@@ -82,11 +82,10 @@
 	col[1]=(unsigned char) (color.y*intensity*255);
 	col[2]=(unsigned char) (color.z*intensity*255);
 	col[3]=5;//intensity*255;
-	float3 interPos=pos+speed*gu-&gt;timeOffset;
-	va-&gt;AddVertexTC(interPos-camera-&gt;right*drawRadius-camera-&gt;up*drawRadius,weaponDef-&gt;visuals.texture1-&gt;xstart,weaponDef-&gt;visuals.texture1-&gt;ystart,col);
-	va-&gt;AddVertexTC(interPos+camera-&gt;right*drawRadius-camera-&gt;up*drawRadius,weaponDef-&gt;visuals.texture1-&gt;xend,weaponDef-&gt;visuals.texture1-&gt;ystart,col);
-	va-&gt;AddVertexTC(interPos+camera-&gt;right*drawRadius+camera-&gt;up*drawRadius,weaponDef-&gt;visuals.texture1-&gt;xend,weaponDef-&gt;visuals.texture1-&gt;yend,col);
-	va-&gt;AddVertexTC(interPos-camera-&gt;right*drawRadius+camera-&gt;up*drawRadius,weaponDef-&gt;visuals.texture1-&gt;xstart,weaponDef-&gt;visuals.texture1-&gt;yend,col);
+	va-&gt;AddVertexTC(drawPos-camera-&gt;right*drawRadius-camera-&gt;up*drawRadius,weaponDef-&gt;visuals.texture1-&gt;xstart,weaponDef-&gt;visuals.texture1-&gt;ystart,col);
+	va-&gt;AddVertexTC(drawPos+camera-&gt;right*drawRadius-camera-&gt;up*drawRadius,weaponDef-&gt;visuals.texture1-&gt;xend,weaponDef-&gt;visuals.texture1-&gt;ystart,col);
+	va-&gt;AddVertexTC(drawPos+camera-&gt;right*drawRadius+camera-&gt;up*drawRadius,weaponDef-&gt;visuals.texture1-&gt;xend,weaponDef-&gt;visuals.texture1-&gt;yend,col);
+	va-&gt;AddVertexTC(drawPos-camera-&gt;right*drawRadius+camera-&gt;up*drawRadius,weaponDef-&gt;visuals.texture1-&gt;xstart,weaponDef-&gt;visuals.texture1-&gt;yend,col);
 }
 
 int CEmgProjectile::ShieldRepulse(CPlasmaRepulser* shield,float3 shieldPos, float shieldForce, float shieldMaxSpeed)

Modified: trunk/rts/Sim/Projectiles/WeaponProjectiles/ExplosiveProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/WeaponProjectiles/ExplosiveProjectile.cpp	2008-10-26 22:03:55 UTC (rev 6908)
+++ trunk/rts/Sim/Projectiles/WeaponProjectiles/ExplosiveProjectile.cpp	2008-10-26 22:11:58 UTC (rev 6909)
@@ -139,7 +139,6 @@
 	const bool   noGap      = weaponDef-&gt;visuals.noGap;
 	const int    stages     = weaponDef-&gt;visuals.stages;
 	const float  invStages  = 1.0f / (float)stages;
-	const float3 interPos   = pos + (speed * gu-&gt;timeOffset);
 
 	float3 dir = speed;
 	dir.Normalize();
@@ -156,7 +155,7 @@
 		const float  size  = drawRadius * (1.0f - (a * sizeDecay));
 		const float3 up    = camera-&gt;up    * size;
 		const float3 right = camera-&gt;right * size;
-		const float3 interPos2 = interPos - ((noGap)?(dir * size * a):(dir * drawRadius * a));
+		const float3 interPos2 = drawPos - ((noGap)?(dir * size * a):(dir * drawRadius * a));
 
 		va-&gt;AddVertexQTC(interPos2 - right - up, tex-&gt;xstart, tex-&gt;ystart, col);
 		va-&gt;AddVertexQTC(interPos2 + right - up, tex-&gt;xend,   tex-&gt;ystart, col);

Modified: trunk/rts/Sim/Projectiles/WeaponProjectiles/FireBallProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/WeaponProjectiles/FireBallProjectile.cpp	2008-10-26 22:03:55 UTC (rev 6908)
+++ trunk/rts/Sim/Projectiles/WeaponProjectiles/FireBallProjectile.cpp	2008-10-26 22:11:58 UTC (rev 6909)
@@ -50,9 +50,7 @@
 	inArray=true;
 	unsigned char col[4] = {255,150, 100, 1};
 
-	float3 interPos = pos;
-	if(checkCol)
-		interPos+=speed*gu-&gt;timeOffset;
+	float3 interPos = checkCol ? drawPos : pos;
 	float size = radius*1.3f;
 
 	int numSparks=sparks.size();

Modified: trunk/rts/Sim/Projectiles/WeaponProjectiles/FlameProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/WeaponProjectiles/FlameProjectile.cpp	2008-10-26 22:03:55 UTC (rev 6908)
+++ trunk/rts/Sim/Projectiles/WeaponProjectiles/FlameProjectile.cpp	2008-10-26 22:11:58 UTC (rev 6909)
@@ -95,12 +95,11 @@
 	inArray = true;
 	unsigned char col[4];
 	weaponDef-&gt;visuals.colorMap-&gt;GetColor(col, curTime);
-	float3 interPos = pos + speed * gu-&gt;timeOffset;
 
-	va-&gt;AddVertexTC(interPos - camera-&gt;right * radius - camera-&gt;up * radius, weaponDef-&gt;visuals.texture1-&gt;xstart, weaponDef-&gt;visuals.texture1-&gt;ystart, col);
-	va-&gt;AddVertexTC(interPos + camera-&gt;right * radius - camera-&gt;up * radius, weaponDef-&gt;visuals.texture1-&gt;xend,   weaponDef-&gt;visuals.texture1-&gt;ystart, col);
-	va-&gt;AddVertexTC(interPos + camera-&gt;right * radius + camera-&gt;up * radius, weaponDef-&gt;visuals.texture1-&gt;xend,   weaponDef-&gt;visuals.texture1-&gt;yend,   col);
-	va-&gt;AddVertexTC(interPos - camera-&gt;right * radius + camera-&gt;up * radius, weaponDef-&gt;visuals.texture1-&gt;xstart, weaponDef-&gt;visuals.texture1-&gt;yend,   col);
+	va-&gt;AddVertexTC(drawPos - camera-&gt;right * radius - camera-&gt;up * radius, weaponDef-&gt;visuals.texture1-&gt;xstart, weaponDef-&gt;visuals.texture1-&gt;ystart, col);
+	va-&gt;AddVertexTC(drawPos + camera-&gt;right * radius - camera-&gt;up * radius, weaponDef-&gt;visuals.texture1-&gt;xend,   weaponDef-&gt;visuals.texture1-&gt;ystart, col);
+	va-&gt;AddVertexTC(drawPos + camera-&gt;right * radius + camera-&gt;up * radius, weaponDef-&gt;visuals.texture1-&gt;xend,   weaponDef-&gt;visuals.texture1-&gt;yend,   col);
+	va-&gt;AddVertexTC(drawPos - camera-&gt;right * radius + camera-&gt;up * radius, weaponDef-&gt;visuals.texture1-&gt;xstart, weaponDef-&gt;visuals.texture1-&gt;yend,   col);
 }
 
 int CFlameProjectile::ShieldRepulse(CPlasmaRepulser* shield,float3 shieldPos, float shieldForce, float shieldMaxSpeed)

Modified: trunk/rts/Sim/Projectiles/WeaponProjectiles/LaserProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/WeaponProjectiles/LaserProjectile.cpp	2008-10-26 22:03:55 UTC (rev 6908)
+++ trunk/rts/Sim/Projectiles/WeaponProjectiles/LaserProjectile.cpp	2008-10-26 22:11:58 UTC (rev 6909)
@@ -231,8 +231,7 @@
 
 	va-&gt;EnlargeArrays(32,0,VA_SIZE_TC);
 	if(camDist&lt;weaponDef-&gt;lodDistance){
-		float3 pos1=pos+speed*gu-&gt;timeOffset;
-		float3 pos2=pos1-dir*curLength;
+		float3 pos2=drawPos-dir*curLength;
 		float texStartOffset;
 		float texEndOffset;
 		if (checkCol) { //expanding or contracting?
@@ -244,21 +243,21 @@
 			texEndOffset= ((float)stayTime * speedf/length)*(weaponDef-&gt;visuals.texture1-&gt;xstart - weaponDef-&gt;visuals.texture1-&gt;xend);
 		}
 
-		va-&gt;AddVertexQTC(pos1-dir1*size,	midtexx,weaponDef-&gt;visuals.texture2-&gt;ystart,    col);
-		va-&gt;AddVertexQTC(pos1+dir1*size,	midtexx,weaponDef-&gt;visuals.texture2-&gt;yend,col);
-		va-&gt;AddVertexQTC(pos1+dir1*size-dir2*size, weaponDef-&gt;visuals.texture2-&gt;xstart,weaponDef-&gt;visuals.texture2-&gt;yend,col);
-		va-&gt;AddVertexQTC(pos1-dir1*size-dir2*size, weaponDef-&gt;visuals.texture2-&gt;xstart,weaponDef-&gt;visuals.texture2-&gt;ystart,col);
-		va-&gt;AddVertexQTC(pos1-dir1*coresize,midtexx,weaponDef-&gt;visuals.texture2-&gt;ystart,    col2);
-		va-&gt;AddVertexQTC(pos1+dir1*coresize,midtexx,weaponDef-&gt;visuals.texture2-&gt;yend,col2);
-		va-&gt;AddVertexQTC(pos1+dir1*coresize-dir2*coresize,weaponDef-&gt;visuals.texture2-&gt;xstart,weaponDef-&gt;visuals.texture2-&gt;yend,col2);
-		va-&gt;AddVertexQTC(pos1-dir1*coresize-dir2*coresize,weaponDef-&gt;visuals.texture2-&gt;xstart,weaponDef-&gt;visuals.texture2-&gt;ystart,col2);
+		va-&gt;AddVertexQTC(drawPos-dir1*size,	midtexx,weaponDef-&gt;visuals.texture2-&gt;ystart,    col);
+		va-&gt;AddVertexQTC(drawPos+dir1*size,	midtexx,weaponDef-&gt;visuals.texture2-&gt;yend,col);
+		va-&gt;AddVertexQTC(drawPos+dir1*size-dir2*size, weaponDef-&gt;visuals.texture2-&gt;xstart,weaponDef-&gt;visuals.texture2-&gt;yend,col);
+		va-&gt;AddVertexQTC(drawPos-dir1*size-dir2*size, weaponDef-&gt;visuals.texture2-&gt;xstart,weaponDef-&gt;visuals.texture2-&gt;ystart,col);
+		va-&gt;AddVertexQTC(drawPos-dir1*coresize,midtexx,weaponDef-&gt;visuals.texture2-&gt;ystart,    col2);
+		va-&gt;AddVertexQTC(drawPos+dir1*coresize,midtexx,weaponDef-&gt;visuals.texture2-&gt;yend,col2);
+		va-&gt;AddVertexQTC(drawPos+dir1*coresize-dir2*coresize,weaponDef-&gt;visuals.texture2-&gt;xstart,weaponDef-&gt;visuals.texture2-&gt;yend,col2);
+		va-&gt;AddVertexQTC(drawPos-dir1*coresize-dir2*coresize,weaponDef-&gt;visuals.texture2-&gt;xstart,weaponDef-&gt;visuals.texture2-&gt;ystart,col2);
 
-		va-&gt;AddVertexQTC(pos1-dir1*size,weaponDef-&gt;visuals.texture1-&gt;xstart + texStartOffset,weaponDef-&gt;visuals.texture1-&gt;ystart,		col);
-		va-&gt;AddVertexQTC(pos1+dir1*size,weaponDef-&gt;visuals.texture1-&gt;xstart + texStartOffset,weaponDef-&gt;visuals.texture1-&gt;yend,			col);
+		va-&gt;AddVertexQTC(drawPos-dir1*size,weaponDef-&gt;visuals.texture1-&gt;xstart + texStartOffset,weaponDef-&gt;visuals.texture1-&gt;ystart,		col);
+		va-&gt;AddVertexQTC(drawPos+dir1*size,weaponDef-&gt;visuals.texture1-&gt;xstart + texStartOffset,weaponDef-&gt;visuals.texture1-&gt;yend,			col);
 		va-&gt;AddVertexQTC(pos2+dir1*size,weaponDef-&gt;visuals.texture1-&gt;xend + texEndOffset,weaponDef-&gt;visuals.texture1-&gt;yend,			col);
 		va-&gt;AddVertexQTC(pos2-dir1*size,weaponDef-&gt;visuals.texture1-&gt;xend + texEndOffset,weaponDef-&gt;visuals.texture1-&gt;ystart,			col);
-		va-&gt;AddVertexQTC(pos1-dir1*coresize,weaponDef-&gt;visuals.texture1-&gt;xstart + texStartOffset,weaponDef-&gt;visuals.texture1-&gt;ystart,	col2);
-		va-&gt;AddVertexQTC(pos1+dir1*coresize,weaponDef-&gt;visuals.texture1-&gt;xstart + texStartOffset,weaponDef-&gt;visuals.texture1-&gt;yend,	col2);
+		va-&gt;AddVertexQTC(drawPos-dir1*coresize,weaponDef-&gt;visuals.texture1-&gt;xstart + texStartOffset,weaponDef-&gt;visuals.texture1-&gt;ystart,	col2);
+		va-&gt;AddVertexQTC(drawPos+dir1*coresize,weaponDef-&gt;visuals.texture1-&gt;xstart + texStartOffset,weaponDef-&gt;visuals.texture1-&gt;yend,	col2);
 		va-&gt;AddVertexQTC(pos2+dir1*coresize,weaponDef-&gt;visuals.texture1-&gt;xend + texEndOffset,weaponDef-&gt;visuals.texture1-&gt;yend,		col2);
 		va-&gt;AddVertexQTC(pos2-dir1*coresize,weaponDef-&gt;visuals.texture1-&gt;xend + texEndOffset,weaponDef-&gt;visuals.texture1-&gt;ystart,		col2);
 
@@ -271,7 +270,7 @@
 		va-&gt;AddVertexQTC(pos2+dir1*coresize+dir2*coresize,weaponDef-&gt;visuals.texture2-&gt;xend,weaponDef-&gt;visuals.texture2-&gt;yend,col2);
 		va-&gt;AddVertexQTC(pos2-dir1*coresize+dir2*coresize,weaponDef-&gt;visuals.texture2-&gt;xend,weaponDef-&gt;visuals.texture2-&gt;ystart,col2);
 	} else {
-		float3 pos1=pos+speed*gu-&gt;timeOffset+dir*(size*0.5f);
+		float3 pos1=drawPos+dir*(size*0.5f);
 		float3 pos2=pos1-dir*(curLength+size);
 		float texStartOffset;
 		float texEndOffset;

Modified: trunk/rts/Sim/Projectiles/WeaponProjectiles/MissileProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/WeaponProjectiles/MissileProjectile.cpp	2008-10-26 22:03:55 UTC (rev 6908)
+++ trunk/rts/Sim/Projectiles/WeaponProjectiles/MissileProjectile.cpp	2008-10-26 22:11:58 UTC (rev 6909)
@@ -330,7 +330,6 @@
 
 void CMissileProjectile::Draw(void)
 {
-	float3 interPos = pos + speed * gu-&gt;timeOffset;
 	inArray = true;
 	float age2 = (age &amp; 7) + gu-&gt;timeOffset;
 
@@ -341,7 +340,7 @@
 	if (weaponDef-&gt;visuals.smokeTrail) {
 		if (drawTrail) {
 			// draw the trail as a single quad
-			float3 dif(interPos - camera-&gt;pos);
+			float3 dif(drawPos - camera-&gt;pos);
 			dif.ANormalize();
 			float3 dir1(dif.cross(dir));
 			dir1.ANormalize();
@@ -375,8 +374,8 @@
 			float size2 = (1 + (age2 * (1 / Smoke_Time)) * 7);
 			float txs = weaponDef-&gt;visuals.texture2-&gt;xend - (weaponDef-&gt;visuals.texture2-&gt;xend - weaponDef-&gt;visuals.texture2-&gt;xstart) * (age2 / 8.0f);
 
-			va-&gt;AddVertexQTC(interPos - dir1 * size,  txs,                               weaponDef-&gt;visuals.texture2-&gt;ystart, col);
-			va-&gt;AddVertexQTC(interPos + dir1 * size,  txs,                               weaponDef-&gt;visuals.texture2-&gt;yend,   col);
+			va-&gt;AddVertexQTC(drawPos - dir1 * size,  txs,                               weaponDef-&gt;visuals.texture2-&gt;ystart, col);
+			va-&gt;AddVertexQTC(drawPos + dir1 * size,  txs,                               weaponDef-&gt;visuals.texture2-&gt;yend,   col);
 			va-&gt;AddVertexQTC(oldSmoke + dir2 * size2, weaponDef-&gt;visuals.texture2-&gt;xend, weaponDef-&gt;visuals.texture2-&gt;yend,   col2);
 			va-&gt;AddVertexQTC(oldSmoke - dir2 * size2, weaponDef-&gt;visuals.texture2-&gt;xend, weaponDef-&gt;visuals.texture2-&gt;ystart, col2);
 		} else {
@@ -409,10 +408,10 @@
 	col[2] = 180;
 	col[3] = 1;
 	float fsize = radius * 0.4f;
-	va-&gt;AddVertexQTC(interPos - camera-&gt;right * fsize-camera-&gt;up * fsize, weaponDef-&gt;visuals.texture1-&gt;xstart, weaponDef-&gt;visuals.texture1-&gt;ystart, col);
-	va-&gt;AddVertexQTC(interPos + camera-&gt;right * fsize-camera-&gt;up * fsize, weaponDef-&gt;visuals.texture1-&gt;xend,   weaponDef-&gt;visuals.texture1-&gt;ystart, col);
-	va-&gt;AddVertexQTC(interPos + camera-&gt;right * fsize+camera-&gt;up * fsize, weaponDef-&gt;visuals.texture1-&gt;xend,   weaponDef-&gt;visuals.texture1-&gt;yend,   col);
-	va-&gt;AddVertexQTC(interPos - camera-&gt;right * fsize+camera-&gt;up * fsize, weaponDef-&gt;visuals.texture1-&gt;xstart, weaponDef-&gt;visuals.texture1-&gt;yend,   col);
+	va-&gt;AddVertexQTC(drawPos - camera-&gt;right * fsize-camera-&gt;up * fsize, weaponDef-&gt;visuals.texture1-&gt;xstart, weaponDef-&gt;visuals.texture1-&gt;ystart, col);
+	va-&gt;AddVertexQTC(drawPos + camera-&gt;right * fsize-camera-&gt;up * fsize, weaponDef-&gt;visuals.texture1-&gt;xend,   weaponDef-&gt;visuals.texture1-&gt;ystart, col);
+	va-&gt;AddVertexQTC(drawPos + camera-&gt;right * fsize+camera-&gt;up * fsize, weaponDef-&gt;visuals.texture1-&gt;xend,   weaponDef-&gt;visuals.texture1-&gt;yend,   col);
+	va-&gt;AddVertexQTC(drawPos - camera-&gt;right * fsize+camera-&gt;up * fsize, weaponDef-&gt;visuals.texture1-&gt;xstart, weaponDef-&gt;visuals.texture1-&gt;yend,   col);
 
 /*	col[0]=200;
 	col[1]=200;
@@ -434,7 +433,6 @@
 
 void CMissileProjectile::DrawUnitPart(void)
 {
-	float3 interPos = pos + speed * gu-&gt;timeOffset;
 	glPushMatrix();
 	float3 rightdir;
 
@@ -447,7 +445,7 @@
 	rightdir.Normalize();
 	float3 updir = rightdir.cross(dir);
 
-	CMatrix44f transMatrix(interPos + dir * radius * 0.9f,-rightdir,updir,dir);
+	CMatrix44f transMatrix(drawPos + dir * radius * 0.9f,-rightdir,updir,dir);
 
 	glMultMatrixf(&amp;transMatrix[0]);
 	glCallList(s3domodel-&gt;rootobject3do?s3domodel-&gt;rootobject3do-&gt;displist:s3domodel-&gt;rootobjects3o-&gt;displist); // dont cache displists because of delayed loading

Modified: trunk/rts/Sim/Projectiles/WeaponProjectiles/StarburstProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/WeaponProjectiles/StarburstProjectile.cpp	2008-10-26 22:03:55 UTC (rev 6908)
+++ trunk/rts/Sim/Projectiles/WeaponProjectiles/StarburstProjectile.cpp	2008-10-26 22:11:58 UTC (rev 6909)
@@ -260,7 +260,6 @@
 
 void CStarburstProjectile::Draw(void)
 {
-	float3 interPos=pos+speed*gu-&gt;timeOffset;
 	inArray=true;
 	float age2=(age&amp;7)+gu-&gt;timeOffset;
 
@@ -272,7 +271,7 @@
 		va-&gt;EnlargeArrays(4+4*numParts,0,VA_SIZE_TC);
 		if(drawTrail){		//draw the trail as a single quad
 
-			float3 dif(interPos-camera-&gt;pos);
+			float3 dif(drawPos-camera-&gt;pos);
 			dif.Normalize();
 			float3 dir1(dif.cross(dir));
 			dir1.Normalize();
@@ -304,8 +303,8 @@
 			float size2=(1+age2*(1/Smoke_Time)*7);
 
 			float txs=weaponDef-&gt;visuals.texture2-&gt;xend - (weaponDef-&gt;visuals.texture2-&gt;xend-weaponDef-&gt;visuals.texture2-&gt;xstart)*(age2/8.0f);//(1-age2/8.0f);
-			va-&gt;AddVertexQTC(interPos-dir1*size, txs, weaponDef-&gt;visuals.texture2-&gt;ystart, col);
-			va-&gt;AddVertexQTC(interPos+dir1*size, txs, weaponDef-&gt;visuals.texture2-&gt;yend, col);
+			va-&gt;AddVertexQTC(drawPos-dir1*size, txs, weaponDef-&gt;visuals.texture2-&gt;ystart, col);
+			va-&gt;AddVertexQTC(drawPos+dir1*size, txs, weaponDef-&gt;visuals.texture2-&gt;yend, col);
 			va-&gt;AddVertexQTC(oldSmoke+dir2*size2, weaponDef-&gt;visuals.texture2-&gt;xend, weaponDef-&gt;visuals.texture2-&gt;yend, col2);
 			va-&gt;AddVertexQTC(oldSmoke-dir2*size2, weaponDef-&gt;visuals.texture2-&gt;xend, weaponDef-&gt;visuals.texture2-&gt;ystart, col2);
 		} else {	//draw the trail as particles
@@ -336,8 +335,6 @@
 
 void CStarburstProjectile::DrawCallback(void)
 {
-	float3 interPos=pos+speed*gu-&gt;timeOffset;
-
 	(*numCallback)++;
 	if(*numCallback&lt;2)
 		return;
@@ -391,15 +388,14 @@
 	col[2]=180;
 	col[3]=1;
 	float fsize = 25.0f;
-	va-&gt;AddVertexTC(interPos-camera-&gt;right*fsize-camera-&gt;up*fsize,weaponDef-&gt;visuals.texture1-&gt;xstart,weaponDef-&gt;visuals.texture1-&gt;ystart,col);
-	va-&gt;AddVertexTC(interPos+camera-&gt;right*fsize-camera-&gt;up*fsize,weaponDef-&gt;visuals.texture1-&gt;xend,weaponDef-&gt;visuals.texture1-&gt;ystart,col);
-	va-&gt;AddVertexTC(interPos+camera-&gt;right*fsize+camera-&gt;up*fsize,weaponDef-&gt;visuals.texture1-&gt;xend,weaponDef-&gt;visuals.texture1-&gt;yend,col);
-	va-&gt;AddVertexTC(interPos-camera-&gt;right*fsize+camera-&gt;up*fsize,weaponDef-&gt;visuals.texture1-&gt;xstart,weaponDef-&gt;visuals.texture1-&gt;yend,col);
+	va-&gt;AddVertexTC(drawPos-camera-&gt;right*fsize-camera-&gt;up*fsize,weaponDef-&gt;visuals.texture1-&gt;xstart,weaponDef-&gt;visuals.texture1-&gt;ystart,col);
+	va-&gt;AddVertexTC(drawPos+camera-&gt;right*fsize-camera-&gt;up*fsize,weaponDef-&gt;visuals.texture1-&gt;xend,weaponDef-&gt;visuals.texture1-&gt;ystart,col);
+	va-&gt;AddVertexTC(drawPos+camera-&gt;right*fsize+camera-&gt;up*fsize,weaponDef-&gt;visuals.texture1-&gt;xend,weaponDef-&gt;visuals.texture1-&gt;yend,col);
+	va-&gt;AddVertexTC(drawPos-camera-&gt;right*fsize+camera-&gt;up*fsize,weaponDef-&gt;visuals.texture1-&gt;xstart,weaponDef-&gt;visuals.texture1-&gt;yend,col);
 }
 
 void CStarburstProjectile::DrawUnitPart(void)
 {
-	float3 interPos=pos+speed*gu-&gt;timeOffset;
 	glPushMatrix();
 	float3 rightdir;
 	if(dir.y!=1)
@@ -409,7 +405,7 @@
 	rightdir.Normalize();
 	float3 updir=rightdir.cross(dir);
 
-	CMatrix44f transMatrix(interPos,-rightdir,updir,dir);
+	CMatrix44f transMatrix(drawPos,-rightdir,updir,dir);
 	glMultMatrixf(&amp;transMatrix[0]);
 
 	glCallList(s3domodel-&gt;rootobject3do?s3domodel-&gt;rootobject3do-&gt;displist:s3domodel-&gt;rootobjects3o-&gt;displist); // dont cache displists because of delayed loading

Modified: trunk/rts/Sim/Projectiles/WeaponProjectiles/TorpedoProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/WeaponProjectiles/TorpedoProjectile.cpp	2008-10-26 22:03:55 UTC (rev 6908)
+++ trunk/rts/Sim/Projectiles/WeaponProjectiles/TorpedoProjectile.cpp	2008-10-26 22:11:58 UTC (rev 6909)
@@ -173,7 +173,6 @@
 	if(s3domodel)	//dont draw if a 3d model has been defined for us
 		return;
 
-	float3 interPos=pos+speed*gu-&gt;timeOffset;
 	inArray=true;
 
 	unsigned char col[4];
@@ -192,44 +191,44 @@
 
 	va-&gt;EnlargeArrays(32,0,VA_SIZE_TC);
 
-	va-&gt;AddVertexQTC(interPos+r*w, texx,texy,col);
-	va-&gt;AddVertexQTC(interPos+u*w, texx,texy,col);
-	va-&gt;AddVertexQTC(interPos+u*w+dir*h, texx,texy,col);
-	va-&gt;AddVertexQTC(interPos+r*w+dir*h, texx,texy,col);
+	va-&gt;AddVertexQTC(drawPos+r*w, texx,texy,col);
+	va-&gt;AddVertexQTC(drawPos+u*w, texx,texy,col);
+	va-&gt;AddVertexQTC(drawPos+u*w+dir*h, texx,texy,col);
+	va-&gt;AddVertexQTC(drawPos+r*w+dir*h, texx,texy,col);
 
-	va-&gt;AddVertexQTC(interPos+u*w, texx,texy,col);
-	va-&gt;AddVertexQTC(interPos-r*w, texx,texy,col);
-	va-&gt;AddVertexQTC(interPos-r*w+dir*h, texx,texy,col);
-	va-&gt;AddVertexQTC(interPos+u*w+dir*h, texx,texy,col);
+	va-&gt;AddVertexQTC(drawPos+u*w, texx,texy,col);
+	va-&gt;AddVertexQTC(drawPos-r*w, texx,texy,col);
+	va-&gt;AddVertexQTC(drawPos-r*w+dir*h, texx,texy,col);
+	va-&gt;AddVertexQTC(drawPos+u*w+dir*h, texx,texy,col);
 
-	va-&gt;AddVertexQTC(interPos-r*w, texx,texy,col);
-	va-&gt;AddVertexQTC(interPos-u*w, texx,texy,col);
-	va-&gt;AddVertexQTC(interPos-u*w+dir*h, texx,texy,col);
-	va-&gt;AddVertexQTC(interPos-r*w+dir*h, texx,texy,col);
+	va-&gt;AddVertexQTC(drawPos-r*w, texx,texy,col);
+	va-&gt;AddVertexQTC(drawPos-u*w, texx,texy,col);
+	va-&gt;AddVertexQTC(drawPos-u*w+dir*h, texx,texy,col);
+	va-&gt;AddVertexQTC(drawPos-r*w+dir*h, texx,texy,col);
 
-	va-&gt;AddVertexQTC(interPos-u*w, texx,texy,col);
-	va-&gt;AddVertexQTC(interPos+r*w, texx,texy,col);
-	va-&gt;AddVertexQTC(interPos+r*w+dir*h, texx,texy,col);
-	va-&gt;AddVertexQTC(interPos-u*w+dir*h, texx,texy,col);
+	va-&gt;AddVertexQTC(drawPos-u*w, texx,texy,col);
+	va-&gt;AddVertexQTC(drawPos+r*w, texx,texy,col);
+	va-&gt;AddVertexQTC(drawPos+r*w+dir*h, texx,texy,col);
+	va-&gt;AddVertexQTC(drawPos-u*w+dir*h, texx,texy,col);
 
 
-	va-&gt;AddVertexQTC(interPos+r*w+dir*h, texx,texy,col);
-	va-&gt;AddVertexQTC(interPos+u*w+dir*h, texx,texy,col);
-	va-&gt;AddVertexQTC(interPos+dir*h*1.2f, texx,texy,col);
-	va-&gt;AddVertexQTC(interPos+dir*h*1.2f, texx,texy,col);
+	va-&gt;AddVertexQTC(drawPos+r*w+dir*h, texx,texy,col);
+	va-&gt;AddVertexQTC(drawPos+u*w+dir*h, texx,texy,col);
+	va-&gt;AddVertexQTC(drawPos+dir*h*1.2f, texx,texy,col);
+	va-&gt;AddVertexQTC(drawPos+dir*h*1.2f, texx,texy,col);
 
-	va-&gt;AddVertexQTC(interPos+u*w+dir*h, texx,texy,col);
-	va-&gt;AddVertexQTC(interPos-r*w+dir*h, texx,texy,col);
-	va-&gt;AddVertexQTC(interPos+dir*h*1.2f, texx,texy,col);
-	va-&gt;AddVertexQTC(interPos+dir*h*1.2f, texx,texy,col);
+	va-&gt;AddVertexQTC(drawPos+u*w+dir*h, texx,texy,col);
+	va-&gt;AddVertexQTC(drawPos-r*w+dir*h, texx,texy,col);
+	va-&gt;AddVertexQTC(drawPos+dir*h*1.2f, texx,texy,col);
+	va-&gt;AddVertexQTC(drawPos+dir*h*1.2f, texx,texy,col);
 
-	va-&gt;AddVertexQTC(interPos-r*w+dir*h, texx,texy,col);
-	va-&gt;AddVertexQTC(interPos-u*w+dir*h, texx,texy,col);
-	va-&gt;AddVertexQTC(interPos+dir*h*1.2f, texx,texy,col);
-	va-&gt;AddVertexQTC(interPos+dir*h*1.2f, texx,texy,col);
+	va-&gt;AddVertexQTC(drawPos-r*w+dir*h, texx,texy,col);
+	va-&gt;AddVertexQTC(drawPos-u*w+dir*h, texx,texy,col);
+	va-&gt;AddVertexQTC(drawPos+dir*h*1.2f, texx,texy,col);
+	va-&gt;AddVertexQTC(drawPos+dir*h*1.2f, texx,texy,col);
 
-	va-&gt;AddVertexQTC(interPos-u*w+dir*h, texx,texy,col);
-	va-&gt;AddVertexQTC(interPos+r*w+dir*h, texx,texy,col);
-	va-&gt;AddVertexQTC(interPos+dir*h*1.2f, texx,texy,col);
-	va-&gt;AddVertexQTC(interPos+dir*h*1.2f, texx,texy,col);
+	va-&gt;AddVertexQTC(drawPos-u*w+dir*h, texx,texy,col);
+	va-&gt;AddVertexQTC(drawPos+r*w+dir*h, texx,texy,col);
+	va-&gt;AddVertexQTC(drawPos+dir*h*1.2f, texx,texy,col);
+	va-&gt;AddVertexQTC(drawPos+dir*h*1.2f, texx,texy,col);
 }

Modified: trunk/rts/Sim/Projectiles/WeaponProjectiles/WeaponProjectile.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/WeaponProjectiles/WeaponProjectile.cpp	2008-10-26 22:03:55 UTC (rev 6908)
+++ trunk/rts/Sim/Projectiles/WeaponProjectiles/WeaponProjectile.cpp	2008-10-26 22:11:58 UTC (rev 6909)
@@ -291,7 +291,6 @@
 
 void CWeaponProjectile::DrawUnitPart()
 {
-	float3 interPos = pos + speed * gu-&gt;timeOffset;
 	float3 dir(speed);
 	dir.Normalize();
 	glPushMatrix();
@@ -305,7 +304,7 @@
 	rightdir.Normalize();
 	float3 updir(rightdir.cross(dir));
 
-	CMatrix44f transMatrix(interPos,-rightdir,updir,dir);
+	CMatrix44f transMatrix(drawPos,-rightdir,updir,dir);
 
 	glMultMatrixf(&amp;transMatrix[0]);
 //	glCallList(modelDispList);

Modified: trunk/rts/Sim/Units/Unit.cpp
===================================================================
--- trunk/rts/Sim/Units/Unit.cpp	2008-10-26 22:03:55 UTC (rev 6908)
+++ trunk/rts/Sim/Units/Unit.cpp	2008-10-26 22:11:58 UTC (rev 6909)
@@ -237,6 +237,9 @@
 	directControl = NULL;
 #endif
 	activated = false;
+#if defined(USE_GML) &amp;&amp; GML_ENABLE_SIMDRAW
+	lastUnitUpdate=gu-&gt;lastFrameStart;
+#endif
 }
 
 CUnit::~CUnit()
@@ -530,6 +533,9 @@
 	const bool oldInWater = inWater;
 
 	moveType-&gt;Update();
+#if defined(USE_GML) &amp;&amp; GML_ENABLE_SIMDRAW
+	lastUnitUpdate=gu-&gt;lastFrameStart;
+#endif
 
 	inAir   = ((pos.y + height) &gt;= 0.0f);
 	inWater =  (pos.y           &lt;= 0.0f);
@@ -1112,23 +1118,35 @@
 }
 
 
-
+void CUnit::UpdateDrawPos() {
+	CTransportUnit *trans=GetTransporter(); 
+#if defined(USE_GML) &amp;&amp; GML_ENABLE_SIMDRAW
+	if (trans) {
+		drawPos = pos + (trans-&gt;speed * ((float)gu-&gt;lastFrameStart - (float)lastUnitUpdate) * gu-&gt;weightedSpeedFactor);
+	} else {
+		drawPos = pos + (speed * ((float)gu-&gt;lastFrameStart - (float)lastUnitUpdate) * gu-&gt;weightedSpeedFactor);
+	}
+#else
+	if (trans) {
+		drawPos = pos + (trans-&gt;speed * gu-&gt;timeOffset);
+	} else {
+		drawPos = pos + (speed * gu-&gt;timeOffset);
+	}
+#endif
+}
 /******************************************************************************/
 /******************************************************************************/
 
 CMatrix44f CUnit::GetTransformMatrix(const bool synced, const bool error) const
 {
-	float3 interPos;
-	if (!transporter) {
-		interPos = (synced? pos: pos + (speed * gu-&gt;timeOffset));
-	} else {
-		interPos = (synced? pos: pos + (transporter-&gt;speed * gu-&gt;timeOffset));
-	}
+	float3 interPos = synced ? pos : drawPos;
 
 	if (!synced &amp;&amp; error) {
 		interPos += helper-&gt;GetUnitErrorPos(this, gu-&gt;myAllyTeam) - midPos;
 	}
 
+	CTransportUnit *trans;
+
 	if (usingScriptMoveType ||
 	    (!beingBuilt &amp;&amp; (physicalState == Flying) &amp;&amp; unitDef-&gt;canmove)) {
 		// aircraft, skidding ground unit, or active ScriptMoveType
@@ -1136,7 +1154,7 @@
 		// use this matrix, or their nanoframes won't spin on pad
 		return CMatrix44f(interPos, -rightdir, updir, frontdir);
 	}
-	else if (transporter &amp;&amp; transporter-&gt;unitDef-&gt;holdSteady) {
+	else if ((trans=GetTransporter()) &amp;&amp; trans-&gt;unitDef-&gt;holdSteady) {
 		// making local copies of vectors
 		float3 frontDir = GetVectorFromHeading(heading);
 		float3 upDir    = updir;
@@ -2460,6 +2478,8 @@
 
 	CR_MEMBER(inAir),
 	CR_MEMBER(inWater),
+	CR_MEMBER(drawPos),
+	CR_RESERVED(4),
 
 	CR_RESERVED(126),
 

Modified: trunk/rts/Sim/Units/Unit.h
===================================================================
--- trunk/rts/Sim/Units/Unit.h	2008-10-26 22:03:55 UTC (rev 6908)
+++ trunk/rts/Sim/Units/Unit.h	2008-10-26 22:11:58 UTC (rev 6909)
@@ -314,6 +314,19 @@
 
 	bool activated;					//if the unit is in it's 'on'-state
 
+	inline CTransportUnit *GetTransporter() const {
+#if defined(USE_GML) &amp;&amp; GML_ENABLE_SIMDRAW
+		return *(CTransportUnit * volatile *)&transporter; // transporter may suddenly be changed to NULL by sim
+#else
+		return transporter;
+#endif
+	}
+
+	void UpdateDrawPos();
+	float3 drawPos;
+#if defined(USE_GML) &amp;&amp; GML_ENABLE_SIMDRAW
+	unsigned lastUnitUpdate;
+#endif
 	//CUnit3DLoader::UnitModel* model;
 	S3DOModel *model;
 	CCobInstance *cob;

Modified: trunk/rts/Sim/Units/UnitHandler.cpp
===================================================================
--- trunk/rts/Sim/Units/UnitHandler.cpp	2008-10-26 22:03:55 UTC (rev 6908)
+++ trunk/rts/Sim/Units/UnitHandler.cpp	2008-10-26 22:11:58 UTC (rev 6909)
@@ -103,6 +103,9 @@
 	CR_MEMBER(metalMakerEfficiency),
 	CR_MEMBER(toBeRemoved),
 	CR_MEMBER(morphUnitToFeature),
+	CR_MEMBER(toBeRemoved),
+	CR_MEMBER(toBeAdded),
+	CR_MEMBER(renderUnits),
 	CR_MEMBER(builderCAIs),
 	CR_MEMBER(unitsByDefs),
 	CR_POSTLOAD(PostLoad),

Modified: trunk/rts/System/GlobalUnsynced.h
===================================================================
--- trunk/rts/System/GlobalUnsynced.h	2008-10-26 22:03:55 UTC (rev 6908)
+++ trunk/rts/System/GlobalUnsynced.h	2008-10-26 22:11:58 UTC (rev 6909)
@@ -63,6 +63,12 @@
 	 */
 	float lastFrameTime;
 
+	// the starting time in tick for last draw frame
+	unsigned lastFrameStart;
+
+	// 0.001f * GAME_SPEED * gs-&gt;speedFactor, used for rendering
+	float weightedSpeedFactor;
+
 	// the draw frame number (never 0)
 	unsigned int drawFrame;
 


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001677.html">[Taspring-linux-commit] r6908 -	trunk/installer/builddata/springcontent
</A></li>
	<LI>Next message: <A HREF="001679.html">[Taspring-linux-commit] r6910 - trunk/AI/Global/AAI
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1678">[ date ]</a>
              <a href="thread.html#1678">[ thread ]</a>
              <a href="subject.html#1678">[ subject ]</a>
              <a href="author.html#1678">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
