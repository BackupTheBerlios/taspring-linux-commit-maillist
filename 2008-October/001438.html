<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r6669 - in branches/caiinterface:	Documentation game/LuaUI/Widgets installer installer/sections	rts/ExternalAI rts/Game rts/Game/Camera rts/Game/UI rts/Lua	rts/Map rts/Rendering rts/Rendering/Env	rts/Rendering/Textures rts/Rendering/UnitModels	rts/Sim/Features rts/Sim/Misc rts/Sim/MoveTypes rts/Sim/Path	rts/Sim/Projectiles rts/Sim/Projectiles/WeaponProjectiles	rts/Sim/Units rts/Sim/Units/UnitTypes rts/Sim/Weapons	rts/System rts/System/Platform rts/build/vstudio8 rts/lib/gml	tools/springie/Springie/autohost tools/springie/Springie/spring
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-October/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6669%20-%20in%20branches/caiinterface%3A%0A%09Documentation%20game/LuaUI/Widgets%20installer%20installer/sections%0A%09rts/ExternalAI%20rts/Game%20rts/Game/Camera%20rts/Game/UI%20rts/Lua%0A%09rts/Map%20rts/Rendering%20rts/Rendering/Env%0A%09rts/Rendering/Textures%20rts/Rendering/UnitModels%0A%09rts/Sim/Features%20rts/Sim/Misc%20rts/Sim/MoveTypes%20rts/Sim/Path%0A%09rts/Sim/Projectiles%20rts/Sim/Projectiles/WeaponProjectiles%0A%09rts/Sim/Units%20rts/Sim/Units/UnitTypes%20rts/Sim/Weapons%0A%09rts/System%20rts/System/Platform%20rts/build/vstudio8%20rts/lib/gml%0A%09tools/springie/Springie/autohost%20tools/springie/Springie/spring&In-Reply-To=%3C20081011122329.52BE846F0%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001437.html">
   <LINK REL="Next"  HREF="001439.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r6669 - in branches/caiinterface:	Documentation game/LuaUI/Widgets installer installer/sections	rts/ExternalAI rts/Game rts/Game/Camera rts/Game/UI rts/Lua	rts/Map rts/Rendering rts/Rendering/Env	rts/Rendering/Textures rts/Rendering/UnitModels	rts/Sim/Features rts/Sim/Misc rts/Sim/MoveTypes rts/Sim/Path	rts/Sim/Projectiles rts/Sim/Projectiles/WeaponProjectiles	rts/Sim/Units rts/Sim/Units/UnitTypes rts/Sim/Weapons	rts/System rts/System/Platform rts/build/vstudio8 rts/lib/gml	tools/springie/Springie/autohost tools/springie/Springie/spring</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6669%20-%20in%20branches/caiinterface%3A%0A%09Documentation%20game/LuaUI/Widgets%20installer%20installer/sections%0A%09rts/ExternalAI%20rts/Game%20rts/Game/Camera%20rts/Game/UI%20rts/Lua%0A%09rts/Map%20rts/Rendering%20rts/Rendering/Env%0A%09rts/Rendering/Textures%20rts/Rendering/UnitModels%0A%09rts/Sim/Features%20rts/Sim/Misc%20rts/Sim/MoveTypes%20rts/Sim/Path%0A%09rts/Sim/Projectiles%20rts/Sim/Projectiles/WeaponProjectiles%0A%09rts/Sim/Units%20rts/Sim/Units/UnitTypes%20rts/Sim/Weapons%0A%09rts/System%20rts/System/Platform%20rts/build/vstudio8%20rts/lib/gml%0A%09tools/springie/Springie/autohost%20tools/springie/Springie/spring&In-Reply-To=%3C20081011122329.52BE846F0%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r6669 - in branches/caiinterface:	Documentation game/LuaUI/Widgets installer installer/sections	rts/ExternalAI rts/Game rts/Game/Camera rts/Game/UI rts/Lua	rts/Map rts/Rendering rts/Rendering/Env	rts/Rendering/Textures rts/Rendering/UnitModels	rts/Sim/Features rts/Sim/Misc rts/Sim/MoveTypes rts/Sim/Path	rts/Sim/Projectiles rts/Sim/Projectiles/WeaponProjectiles	rts/Sim/Units rts/Sim/Units/UnitTypes rts/Sim/Weapons	rts/System rts/System/Platform rts/build/vstudio8 rts/lib/gml	tools/springie/Springie/autohost tools/springie/Springie/spring">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Sat Oct 11 14:23:29 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001437.html">[Taspring-linux-commit] r6668 - Lobby Lobby/springie trunk/tools
</A></li>
        <LI>Next message: <A HREF="001439.html">[Taspring-linux-commit] r6670 - in	branches/caiinterface/rts/ExternalAI: . Interface
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1438">[ date ]</a>
              <a href="thread.html#1438">[ thread ]</a>
              <a href="subject.html#1438">[ subject ]</a>
              <a href="author.html#1438">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: hoijui
Date: 2008-10-11 14:23:25 +0200 (Sat, 11 Oct 2008)
New Revision: 6669

Removed:
   branches/caiinterface/Documentation/Lobby/
   branches/caiinterface/Documentation/lobbychangelog.txt
Modified:
   branches/caiinterface/Documentation/changelog.txt
   branches/caiinterface/game/LuaUI/Widgets/minimap_startbox.lua
   branches/caiinterface/installer/sections/shortcuts.nsh
   branches/caiinterface/installer/sections/tasclient.nsh
   branches/caiinterface/installer/springsettings.nsh
   branches/caiinterface/rts/ExternalAI/AICallback.cpp
   branches/caiinterface/rts/Game/Camera/OrbitController.cpp
   branches/caiinterface/rts/Game/CameraHandler.cpp
   branches/caiinterface/rts/Game/Game.cpp
   branches/caiinterface/rts/Game/GameServer.cpp
   branches/caiinterface/rts/Game/GameVersion.cpp
   branches/caiinterface/rts/Game/SelectedUnits.cpp
   branches/caiinterface/rts/Game/UI/GuiHandler.cpp
   branches/caiinterface/rts/Game/UI/MiniMap.cpp
   branches/caiinterface/rts/Lua/LuaCallInCheck.h
   branches/caiinterface/rts/Lua/LuaHandle.cpp
   branches/caiinterface/rts/Map/BaseGroundDrawer.cpp
   branches/caiinterface/rts/Rendering/Env/AdvSky.cpp
   branches/caiinterface/rts/Rendering/Env/AdvTreeDrawer.cpp
   branches/caiinterface/rts/Rendering/Env/BasicSky.cpp
   branches/caiinterface/rts/Rendering/Env/BasicTreeDrawer.cpp
   branches/caiinterface/rts/Rendering/Env/GrassDrawer.cpp
   branches/caiinterface/rts/Rendering/GroundDecalHandler.cpp
   branches/caiinterface/rts/Rendering/GroundDecalHandler.h
   branches/caiinterface/rts/Rendering/Textures/ColorMap.cpp
   branches/caiinterface/rts/Rendering/UnitModels/UnitDrawer.cpp
   branches/caiinterface/rts/Sim/Features/FeatureHandler.cpp
   branches/caiinterface/rts/Sim/Features/FeatureHandler.h
   branches/caiinterface/rts/Sim/Misc/QuadField.cpp
   branches/caiinterface/rts/Sim/MoveTypes/GroundMoveType.cpp
   branches/caiinterface/rts/Sim/Path/PathEstimator.cpp
   branches/caiinterface/rts/Sim/Projectiles/ProjectileHandler.cpp
   branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/WeaponProjectile.cpp
   branches/caiinterface/rts/Sim/Units/Unit.h
   branches/caiinterface/rts/Sim/Units/UnitHandler.cpp
   branches/caiinterface/rts/Sim/Units/UnitTypes/TransportUnit.cpp
   branches/caiinterface/rts/Sim/Weapons/WeaponDefHandler.cpp
   branches/caiinterface/rts/System/Platform/ConfigHandler.cpp
   branches/caiinterface/rts/System/SpringApp.cpp
   branches/caiinterface/rts/build/vstudio8/rts.vcproj
   branches/caiinterface/rts/lib/gml/gmlsrv.h
   branches/caiinterface/tools/springie/Springie/autohost/AutoHost_commands.cs
   branches/caiinterface/tools/springie/Springie/spring/Talker.cs
Log:
reintegrating trunk

Modified: branches/caiinterface/Documentation/changelog.txt
===================================================================
--- branches/caiinterface/Documentation/changelog.txt	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/Documentation/changelog.txt	2008-10-11 12:23:25 UTC (rev 6669)
@@ -1,12 +1,17 @@
 Spring change log
 
-0.next
-
+0.77b3:
 User Interface
-  - added a simple Orbit-Camera controller
+ - added a simple Orbit-Camera controller
        META-key + LMB + drag ==&gt; alter elevation, rotation
        META-key + MMB + drag ==&gt; pan up/down/left/right
        META-key + RMB + drag ==&gt; zoom
+ - fix transports not killing their transportees when they should
+ - update installer shortcuts
+ - when kicking a player, kick only the player and don't disconnect everyone
+ - fix invalid command spam
+ - fix some divisions through 0
+ - fix crash for all players when someone gives away all his units
 
 
 

Deleted: branches/caiinterface/Documentation/lobbychangelog.txt
===================================================================
--- branches/caiinterface/Documentation/lobbychangelog.txt	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/Documentation/lobbychangelog.txt	2008-10-11 12:23:25 UTC (rev 6669)
@@ -1,266 +0,0 @@
-  ------ CHANGELOG ------
-  *** 0.35 (??x??x??) ***
-  * added &quot;balance teams&quot; feature for hosts
-
-  *** 0.34 (??x??x??) ***
-  * added &quot;auto setup start rectangles&quot; feature for hosts
-  * fixed /ignore command not working in certain (most) cases. You would always have to restart the client before it worked
-  * added quick searchbar for unknown-files.net
-  * spring version is now read from unitsync.dll instead of spring.exe
-
-  *** 0.33 (21x01x07) ***
-  * fixed bug with nat traversal not working anymore in previous version (hopefully)
-  * added new &quot;Office12&quot; skin
-  * added Wine autodetection to disable SpTBX title bars (this fixes some issues with TASClient running under Wine),
-    alternatively it can be forced by providing a -wine switch to TASClient.exe
-
-  *** 0.32 (29x12x06) ***
-  * fixed an issue with hosts being unable to kick players from their battles in certain situations
-  * fixed drawing &quot;original&quot; clients from a battle replay when hosting one (colors were drawn incorrectly)
-
-  *** 0.31 (27x11x06) ***
-  * fixed crash bug when re-joining battle for which you don't have the right map
-  * workaround for problem with windows disappearing from the screen on program crash and some other occasions
-  * added &quot;bot mode&quot; indicator
-  * /ring can now be used on battle hosts as well
-  * fixed slowdown problem when re-sorting maps
-  * fixed &quot;maximizing&quot; bug when entering full-screen mode
-
-  *** 0.30 (03x10x06) ***
-  * added new map list with some new options (map grading, custom comments, online grades, ...)
-  * last open map is now restored on program start
-  * fixed some graphical glitch on program start (showing distorted main window before initialization is completed)
-  * can't change player settings anymore once you ready up
-  * fixed crash with mods that don't have any sides defined (like AA 2.11 A and H)
-  * added support for 16 teams / 32 players
-  * added option for battle host to force spectator mode on players
-  * temporaly changed map and mod links to unknown-files.net
-  * added option to disable all sounds
-  * skinned most of the components and added some free skins
-
-  *** 0.26 (20x07x06) ***
-  * fixed serious bug with hosting replays not working
-  * players who don't have the map can't ready up anymore
-  * fixed bug with /password command not checking password correctly
-  * added /mutelist command for non-admins
- 
-  *** 0.25 (16x06x06) ***
-  * battle client list now shows player's ingame and away status
-  * team colors can now be customized
-  * fixed some minor graphical glitches and other problems
-
-  *** 0.24 (13x05x06) ***
-  * fixed small bug with &quot;online maps&quot; getting scattered over the window if scrolling the list
-    down before reading of cache has completed
-  * fixed bug with tab style always switching back to 'tabs' option
-  * added &quot;auto switch focus to private messages&quot; option
-  * replaced team/ally comboboxes with dropdown menus
-  * fixed bug with watching replays not working
-  * replaced battle client list with new one and moved &quot;player control&quot; tab
-    and &quot;update bot&quot; dialog to right-click popup menu
-
-  *** 0.23 (30x04x06) ***
-  * you can now host bot vs bot battles while being a spectator
-  * added ignore list manager and /ignore command
-  * added additional battle list sorting modes (click on column header to specify sort criterion)
-  * added new &quot;choose color dropdown&quot;
-  * added warning icon which is displayed right next to each battle in battle list that uses NAT traversing
-  * fixed connection address not switching back bug when using &quot;Connect to backup host if primary fails&quot; option
-
-  *** 0.22 (20x03x06) ***
-  * added keyword highlighting + notifications (options-&gt;program-&gt;highlights)
-  * added /ping command
-  * added ability to lock channels (pass key with join command to join locked channel)
-  * /list command now returns more detailed channel list
-  * limited maximum length of chat messages
-
-  *** 0.21 (27x02x06) ***
-  * fixed splash screen sometimes not dissappearing after program has loaded
-  * increased send/recv buffer sizes (will hopefully fix some of the timeout issues)
-  * fixed auto-complete feature
-
-  *** 0.20 (25x02x06) ***
-  * fixed updating &quot;online maps&quot; for people using a HTTP proxy
-  * added simple auto-complete feature similar to the one used in mIRC (press TAB to auto-complete player's name)
-  * password can now be changed using /password command
-  * use /ingame to find out your in-game time
-  * added option to lock game speed
-  * fixed map info not getting updated on map changing to &quot;none&quot;
-  * added /chanmsg command for moderators
-  * fixed small problem with double-clicking on player not always working
-  * increased program loading speed (replays and &quot;online maps&quot; are now loaded in background threads) 
-
-  *** 0.195 (23x01x06) ***
-  * fixed serious bug with hosting replays (non-host players would always crash with I/O error 103)
-  * &quot;game options&quot; in battle form are now restored on program start
-  * added &quot;load default&quot; and &quot;set as default&quot; buttons to quickly save/load all battle settings when hosting
-  * added HTTP proxy settings to option pages (this will solve problems some people were having downloading maps and updates)
-
-  *** 0.194 (19x01x06) ***
-  * fixed serious bug with disabled units list being loaded causing access violation exceptions
-    on changing map or not launching spring upon starting the game.
-  * host can now select type of NAT traversal method
-  * fixed bug with &quot;online maps&quot; in some rare cases pointing to wrong or invalid address
-  * &quot;online maps&quot; are ordered aphabetically now
-  * added &quot;perform&quot; list (Options-&gt;Server-&gt;Perform)
-  * added option to update mod list from within the lobby (you don't have to restart the lobby anymore when adding new mods)       
-
-  *** 0.193 ***
-  * fixed serious bug with sorting battles as game would not start for all players or would start randomly for some
-  * fixed some freezing bug when auto-updating client 
-
-  *** 0.192 ***
-  * added battle list sorting
-  * fixed serious bug which caused &quot;ambigious commands&quot; popup upon connecting to server in case there were roughly more
-    than 100 people connected
-  * other minor changes and fixes 
-
-  *** 0.19 ***
-  * battle hosts can now use /ring &lt;username&gt; command on players participating in their battles
-  * fixed problem with notification dialog switching focus back to application
-  * added /rename command which will rename your account (so that people who wish to add clan tags in front
-    of their names don't have to reregister and lose their ranks). Player names may now also contain
-    &quot;[&quot; and &quot;]&quot; characters.
-  * fixed small bug in demo script parser
-  * added /mute, /unmute and /mutelist commands for admins/mods
-
-  *** 0.182 ***
-  * fixed serious bug with mod sides not being loaded when user joined battle, if he didn't host the mod before that
-
-  *** 0.181 ***
-  * fixed serious bug with not accepting UPDATEBATTLEDETAILS commands
-
-  *** 0.18 (24x11x05) ***
-  * added &quot;ghosted buildings&quot; option
-  * added multiple mod side support (modders should put side images
-    into lobby/sidepics folder as 24-bit bitmap files)
-  * improved hosting so that now practically anyone can host withouth forwarding
-    any ports on the router. Also removed &quot;custom udp source port&quot; option since
-    it is irrelevant now.
-  * passwords are now sent to server in encoded form (MD5 hash code)
-  * fixed bug in &quot;online maps&quot; when updater stopped responding in certain cases  
-
-  *** 0.17 (08x11x05) ***
-  * fixed network code (multiplayer replays should work now)
-  * &quot;online maps&quot; are now updated only as needed
-  * fixed some minor issues
-
-  *** 0.161 (13x10x05) ***
-  * fixed problem with application not minimizing if taskbar buttons were enabled
-  * fixed problem with saving comments to demo file. Note: comments created with previous version will
-    raise an &quot;error parsing file&quot; error when trying to watch the replay (comments should be saved
-    again with new version to avoid this error).
-  * temporarily disabled multiplayer replay feature due to some issues with it (probably until next update).  
-
-  *** 0.16 (11x10x05) ***
-  * added ability to add comments and grades to replays
-  * added &quot;diminishing metal maker returns&quot; host option
-  * added option for host to lock battle
-  * added logging support
-  * added ability to save and load disabled unit selection
-  * added notifications (desktop alert popup plus sound)
-  * added more advanced exception handling using JclDebug
-  * fixed custom sides for bots
-  * fixed minor problem with focus shifting from forms with taskbar buttons to main form
-  * fixed &quot;dancing options&quot; bug, which happened if user lagged a lot and if he changed various battle
-    parameters very fast.
-  * added support for multiplayer replays
-  * &quot;online maps&quot; are now updated directly from fileuniverse.com  
-
-  *** 0.152 (24x09x05) ***
-  * added option to add taskbar buttons for all forms
-  * changed wsoTCPNoDelay to True. This could resolve some of the timeout issues.
-  * added &quot;Auto scroll&quot; option to rich edit controls (right-click on the rich edit and choose Auto scroll)
-  * fixed problem with DecimalSeparator getting overwritten with WM_WININICHANGE message in some cases.
-  * fixed freezing bug on &quot;loading mod ...&quot;, this time in unitsync.dll
-  * added support for custom sides
-
-  *** 0.151 (12x09x05) ***
-  * fixed crashing bug when using startrects
-  * fixed issue when client crashed upon start if it couldn't read CPU info from registry
-  * fixed bug in detecting CPU speed for some older AMD processors
-  * added popup hints displaying player's full country name
-  * fixed &quot;400 BAD REQUEST&quot; bug when trying to download maps with spaces in the name
-  * reduced starting-up time a bit. Still, having &quot;online maps&quot; cached adds some time to the loading procedure.
-  * fixed problem with launching patch file
-
-  *** 0.15 (11x09x05) ***
-  * program now remembers the last mod used
-  * added IP-to-country support
-  * fixed problem with saving maximized form's width, size, top and left properties to registry
-  * added &quot;sort by name&quot; as secondary sorting criterion (for example, if players are sorted by rank, players with same rank will be sorted by name)
-  * added unlimited command history buffer (edit boxes now remember all commands that you typed)
-  * maps in battle list which you do not have are now colored in red
-  * added popup hints to battle list
-  * added KICK command to battle screen (type /KICK username to kick user)
-  * added hyperlink functionality to chat windows (it detects prefixes such as &quot;http:&quot;, &quot;file:&quot;, &quot;mailto:&quot;, &quot;ftp&quot;, ...)
-  * added CPU tag support (in battle screen only)
-  * added start rectangles support (see HELP for more info)
-  * other minor changes
-
-  *** 0.141 (30x08x05) ***
-  * fixed &quot;more maps&quot; label pointing to wrong web location
-  * added explanation of ranking system to help screen
-  * client now closes itself before updating, so that you don't have to restart windows anymore
-    (for the changes to take effect).
-
-  *** 0.14 (29x08x05) ***
-  * added DELETE button to Replays window
-  * change the way preferences are saved - from now on they are saved to registry (HKEY_CURRENT_USER\Software\TASClient)
-    and no longer to config.dat
-  * added various form info to registry (size, position, splitter state, etc.) so that now program restores previous form's state
-  * added &quot;more mods&quot; label
-  * added &quot;Reload map list&quot; button since noone seem to notice popup menu when clicking with right mouse button on the map list
-  * all forms are now non-scalable, so people using large fonts in windows shouldn't have any more problems (hopefully)
-  * added ability to force change team color
-  * added ability to sort players in channels (by name, status and rank)
-  * fixed bug when client sometimes disconnected from server right after connection was established due to client not remembering
-    correctly when was the last time data has been received from server
-  * added ranking system
-  * fixed issue (again) with client freezing when joining battle in certain cases.
-
-  *** 0.13 (25x08x05) ***
-  * added ability to watch replays within the lobby (&quot;REPLAYS&quot; button)
-  * added custom UDP source port support
-  * added AI support
-  * added &quot;GAME SETTINGS&quot; button in preferences screen (it launches settings.exe)
-  * player list in battle screen is now double-buffered (it no longer &quot;blinks&quot;)
-
-  *** 0.121 (??x??x??) ***
-  * added auto connect on startup option
-  * fixed issue with lobby freezing when joining a battle (in certain cases)
-  * player list box is now double-buffered (no longer blinks)
-  * other minor changes (clear window (popup menu), ...)
-
-  *** 0.12 (14x08x05) ***
-  * fixed away status not being updated to &quot;normal&quot; when participating in a battle (also &quot;away&quot; is not drawn anymore
-    for players who are in-game)
-  * fixed one serious bug: when there were spectators in the battle, the lobby would crash for the host when he pressed
-    START button
-  * added SHIFT+CTRL+H button to open host dialog directly from main screen
-  * game is launched by &quot;OnMessage&quot; event now, no longer directly from GUI
-  * added splitter to battle screen in player list, it can be resized now (so that all players can fit in the list)
-  * added support for commands: SERVERMSG, SERVERMSGBOX
-  * other minor changes
-
-  *** 0.11 (13x08x05) ***
-  * added SHIFT+CTRL+B shortcut to switch to battle screen and back
-  * when joining a channel the name of the channel is changed to lower-case so that players
-    don't go into different channels by entering #xta, #XTA or #Xta, for example (channel
-    names are case-sensitive, as well as player names).
-  * removed EOL type option, from now I manually parse incoming data, so that I can detect any kind of EOL
-  * added HELP screen
-  * added away status
-  * fixed: when client connected to battle with map which he didn't have, it would not switch to &quot;no map&quot; picture
-  * client no longer sends join command if user clicked CANCEL when trying to enter passworded game
-  * client is no longer allowed to join battle if it is in progress
-  * fixed small issue when player joining a full battle as a spectator. Host did not update battle status
-    to match the correct number of spectators (instead the player who just joined was seen as a normal
-    player to outside players, and not as a spectator).
-  * when generating script.txt file, &quot;hostip=&quot; line is now &quot;localhost&quot; if you are hosting a battle. All other
-    players assign your &quot;outside&quot; (internet) IP/address. I am not sure if that is to fix anything or even broke
-    anything?
-  * added &quot;/PART&quot; command
-
-  *** 0.10 (11x08x05) ***
-  * first public release
\ No newline at end of file

Modified: branches/caiinterface/game/LuaUI/Widgets/minimap_startbox.lua
===================================================================
--- branches/caiinterface/game/LuaUI/Widgets/minimap_startbox.lua	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/game/LuaUI/Widgets/minimap_startbox.lua	2008-10-11 12:23:25 UTC (rev 6669)
@@ -37,7 +37,9 @@
 --
 
 -- disable the loathed demo feature
-local drawGroundQuads = false
+local drawGroundQuadsFancy = false
+-- enable simple version by default though
+local drawGroundQuads = true
 
 
 --------------------------------------------------------------------------------
@@ -182,7 +184,7 @@
   local time = Spring.DiffTimers(Spring.GetTimer(), startTimer)
 
   -- show all start boxes
-  if (drawGroundQuads) then
+  if (drawGroundQuadsFancy) then
 
     gl.PolygonOffset(-25, -2)
     gl.Culling(GL.BACK)
@@ -216,6 +218,27 @@
     gl.DepthTest(false)
     gl.Culling(false)
     gl.PolygonOffset(false)
+  elseif (drawGroundQuads) then
+    gl.PolygonOffset(-25, -2)
+    gl.Culling(GL.BACK)
+    gl.DepthTest(true)
+    for _,at in ipairs(Spring.GetAllyTeamList()) do
+      if (true or at ~= gaiaAllyTeamID) then
+        local xn, zn, xp, zp = Spring.GetAllyTeamStartBox(at)
+        if (xn and ((xn ~= 0) or (zn ~= 0) or (xp ~= msx) or (zp ~= msz))) then
+          local alpha = 0.2 + 0.1*math.sin(time/10)
+          local color
+          alpha = 0.25
+          if (at == Spring.GetMyAllyTeamID()) then
+            color = { 0, 1, 0, alpha }  --  green
+          else
+            color = { 1, 0, 0, alpha }  --  red
+          end
+          gl.Color(color)
+          gl.CallList(allyTeamGndLists[at])
+        end
+      end
+    end
   end
 
   -- show the team start positions

Modified: branches/caiinterface/installer/sections/shortcuts.nsh
===================================================================
--- branches/caiinterface/installer/sections/shortcuts.nsh	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/installer/sections/shortcuts.nsh	2008-10-11 12:23:25 UTC (rev 6669)
@@ -3,25 +3,29 @@
   SetOutPath &quot;$INSTDIR&quot;
   ; Main shortcuts
   CreateDirectory &quot;$SMPROGRAMS\${PRODUCT_NAME}&quot;
+  CreateDirectory &quot;$SMPROGRAMS\${PRODUCT_NAME}\Multiplayer&quot;
   ${If} ${SectionIsSelected} ${SEC_TASCLIENT}
-    CreateDirectory &quot;$SMPROGRAMS\${PRODUCT_NAME}\Multiplayer&quot;
     CreateShortCut &quot;$SMPROGRAMS\${PRODUCT_NAME}\Multiplayer\TASClient.lnk&quot; &quot;$INSTDIR\TASClient.exe&quot;
   ${EndIf}
+  ${If} ${SectionIsSelected} ${SEC_SPRINGLOBBY}
+    CreateShortCut &quot;$SMPROGRAMS\${PRODUCT_NAME}\Multiplayer\SpringLobby.lnk&quot; &quot;$INSTDIR\springlobby.exe&quot;
+  ${EndIf}
   ${If} ${SectionIsSelected} ${SEC_CA}
     CreateShortCut &quot;$SMPROGRAMS\${PRODUCT_NAME}\Update CA.lnk&quot; &quot;$INSTDIR\CaDownloader.exe&quot;
   ${EndIf}  
   CreateShortCut &quot;$SMPROGRAMS\${PRODUCT_NAME}\Selectionkeys editor.lnk&quot; &quot;$INSTDIR\SelectionEditor.exe&quot;
-  CreateShortCut &quot;$SMPROGRAMS\${PRODUCT_NAME}\Settings.lnk&quot; &quot;$INSTDIR\Settings.exe&quot;
+  CreateShortCut &quot;$SMPROGRAMS\${PRODUCT_NAME}\Settings.lnk&quot; &quot;$INSTDIR\springsettings.exe&quot;
   CreateShortCut &quot;$SMPROGRAMS\${PRODUCT_NAME}\Test Spring.lnk&quot; &quot;$INSTDIR\spring.exe&quot;
 
   WriteIniStr &quot;$INSTDIR\Spring.url&quot; &quot;InternetShortcut&quot; &quot;URL&quot; &quot;${PRODUCT_WEB_SITE}&quot;
-  WriteIniStr &quot;$INSTDIR\unknown-files.url&quot; &quot;InternetShortcut&quot; &quot;URL&quot; &quot;<A HREF="http://spring.unknown-files.net">http://spring.unknown-files.net</A>&quot;
+  WriteIniStr &quot;$INSTDIR\jobjol.url&quot; &quot;InternetShortcut&quot; &quot;URL&quot; &quot;<A HREF="http://spring.jobjol.nl">http://spring.jobjol.nl</A>&quot;
   CreateShortCut &quot;$SMPROGRAMS\${PRODUCT_NAME}\Spring Website.lnk&quot; &quot;$INSTDIR\Spring.url&quot;
-  CreateShortCut &quot;$SMPROGRAMS\${PRODUCT_NAME}\Download Content.lnk&quot; &quot;$INSTDIR\$$INSTDIR\unknown-files.url&quot;
+  CreateShortCut &quot;$SMPROGRAMS\${PRODUCT_NAME}\Download Content.lnk&quot; &quot;$INSTDIR\$$INSTDIR\jobjol.url&quot;
   CreateShortCut &quot;$SMPROGRAMS\${PRODUCT_NAME}\Uninstall Spring.lnk&quot; &quot;$INSTDIR\uninst.exe&quot;
 !else
   ; Shortcuts
   Delete &quot;$SMPROGRAMS\${PRODUCT_NAME}\Multiplayer\TASClient.lnk&quot;
+  Delete &quot;$SMPROGRAMS\${PRODUCT_NAME}\Multiplayer\SpringLobby.lnk&quot;
   Delete &quot;$SMPROGRAMS\${PRODUCT_NAME}\Selectionkeys editor.lnk&quot;
   Delete &quot;$SMPROGRAMS\${PRODUCT_NAME}\Settings.lnk&quot;
   Delete &quot;$SMPROGRAMS\${PRODUCT_NAME}\Test Spring.lnk&quot;

Modified: branches/caiinterface/installer/sections/tasclient.nsh
===================================================================
--- branches/caiinterface/installer/sections/tasclient.nsh	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/installer/sections/tasclient.nsh	2008-10-11 12:23:25 UTC (rev 6669)
@@ -16,7 +16,7 @@
   CreateDirectory &quot;$INSTDIR\lobby\var&quot;
   CreateDirectory &quot;$INSTDIR\lobby\var\replayFilters&quot;
   CreateDirectory &quot;$INSTDIR\lobby\logs&quot;
-  CreateDirectory &quot;$INSTDIR\lobby\python\&quot;
+  CreateDirectory &quot;$INSTDIR\lobby\python&quot;
 
   SetOutPath &quot;$INSTDIR\lobby\var&quot;
   File &quot;..\external\TASClient\groups.ini&quot;
@@ -48,7 +48,7 @@
   RmDir &quot;$INSTDIR\lobby\cache\online&quot;
   RmDir &quot;$INSTDIR\lobby\cache&quot;
   RmDir &quot;$INSTDIR\lobby\logs&quot;
-  RmDir &quot;$INSTDIR\lobby\python\&quot;
+  RmDir &quot;$INSTDIR\lobby\python&quot;
   RmDir &quot;$INSTDIR\lobby\var\replayFilters&quot;
   RmDir &quot;$INSTDIR\lobby\var&quot;
   RmDir &quot;$INSTDIR\lobby&quot;

Modified: branches/caiinterface/installer/springsettings.nsh
===================================================================
--- branches/caiinterface/installer/springsettings.nsh	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/installer/springsettings.nsh	2008-10-11 12:23:25 UTC (rev 6669)
@@ -1,10 +1,10 @@
 !ifdef TEST_BUILD
  !define PRODUCT_NAME &quot;Spring - Test Build&quot;
- !define PRODUCT_VERSION &quot;0.77b2+svn${REVISION}&quot;
+ !define PRODUCT_VERSION &quot;0.77b3+svn${REVISION}&quot;
  !define SP_BASENAME &quot;spring_${PRODUCT_VERSION}&quot;
 !else
  !define PRODUCT_NAME &quot;Spring&quot;
- !define PRODUCT_VERSION &quot;0.77b2&quot;
+ !define PRODUCT_VERSION &quot;0.77b3&quot;
  !define SP_BASENAME &quot;spring_${PRODUCT_VERSION}&quot;
 !endif
 

Modified: branches/caiinterface/rts/ExternalAI/AICallback.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/AICallback.cpp	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/rts/ExternalAI/AICallback.cpp	2008-10-11 12:23:25 UTC (rev 6669)
@@ -49,6 +49,14 @@
 #include &quot;LogOutput.h&quot;
 #include &quot;mmgr.h&quot;
 
+#ifdef USE_GML
+#include &quot;lib/gml/gmlsrv.h&quot;
+#	if GML_MT_TEST
+#include &lt;boost/thread/recursive_mutex.hpp&gt;
+extern boost::recursive_mutex unitmutex;
+#	endif
+#endif
+
 /* Cast id to unsigned to catch negative ids in the same operations,
 cast MAX_* to unsigned to suppress GCC comparison between signed/unsigned warning. */
 #define CHECK_UNITID(id) ((unsigned)(id) &lt; (unsigned)MAX_UNITS)
@@ -1003,6 +1011,11 @@
 	tdu.drawBorder=drawBorder;
 	tdu.facing=facing;
 	std::pair&lt;int,CUnitDrawer::TempDrawUnit&gt; tp(gs-&gt;frameNum+lifetime,tdu);
+
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::recursive_mutex::scoped_lock unitlock(unitmutex); // maybe superfluous
+#endif
+
 	if(transparent)
 		unitDrawer-&gt;tempTransparentDrawUnits.insert(tp);
 	else

Modified: branches/caiinterface/rts/Game/Camera/OrbitController.cpp
===================================================================
--- branches/caiinterface/rts/Game/Camera/OrbitController.cpp	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/rts/Game/Camera/OrbitController.cpp	2008-10-11 12:23:25 UTC (rev 6669)
@@ -79,6 +79,7 @@
 
 void COrbitController::KeyMove(float3 move)
 {
+	// todo
 }
 
 
@@ -192,14 +193,18 @@
 		return;
 	}
 
-	CCamera* cam = camera;
+	// support minimap position hopping
+	const float dx = newPos.x - camera-&gt;pos.x;
+	const float dz = newPos.z - camera-&gt;pos.z;
 
-	// support minimap position hopping
-	cen = newPos;
+	cen.x += dx;
+	cen.z += dz;
 	cen.y = ground-&gt;GetHeight2(cen.x, cen.z);
-	cam-&gt;pos = cen - (cam-&gt;forward * (cam-&gt;pos - cen).Length());
 
-	Init(cam-&gt;pos, cen);
+	camera-&gt;pos.x += dx;
+	camera-&gt;pos.z += dz;
+
+	Init(camera-&gt;pos, cen);
 }
 
 float3 COrbitController::GetDir()

Modified: branches/caiinterface/rts/Game/CameraHandler.cpp
===================================================================
--- branches/caiinterface/rts/Game/CameraHandler.cpp	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/rts/Game/CameraHandler.cpp	2008-10-11 12:23:25 UTC (rev 6669)
@@ -26,8 +26,8 @@
 
 CCameraHandler::CCameraHandler()
 {
-	cameraTime=0.0f;
-	cameraTimeLeft=0.0f;
+	cameraTime = 0.0f;
+	cameraTimeLeft = 0.0f;
 
 	// FPS camera must always be the first one in the list
 	std::vector&lt;CCameraController*&gt;&amp; camCtrls = camControllers;
@@ -37,8 +37,8 @@
 	camCtrls.push_back(new CRotOverheadController()); // 3
 	camCtrls.push_back(new CFreeController());        // 4
 	camCtrls.push_back(new SmoothController());       // 5
-	camCtrls.push_back(new COverviewController());    // 6
-	camCtrls.push_back(new COrbitController());       // 7
+	camCtrls.push_back(new COrbitController());       // 6
+	camCtrls.push_back(new COverviewController());    // 7, needs to be last (ToggleOverviewCamera())
 
 	for (unsigned int i = 0; i &lt; camCtrls.size(); i++) {
 		nameMap[camCtrls[i]-&gt;GetName()] = i;

Modified: branches/caiinterface/rts/Game/Game.cpp
===================================================================
--- branches/caiinterface/rts/Game/Game.cpp	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/rts/Game/Game.cpp	2008-10-11 12:23:25 UTC (rev 6669)
@@ -2475,6 +2475,7 @@
 	}
 
 	ClientReadNet();
+
 	if (!net-&gt;Active() &amp;&amp; !gameOver) {
 		logOutput.Print(&quot;Lost connection to gameserver&quot;);
 		gameOver = true;
@@ -2511,6 +2512,13 @@
 	return true;
 }
 
+#ifdef USE_GML
+#include &quot;lib/gml/gmlsrv.h&quot;
+#	if GML_MT_TEST
+#include &lt;boost/thread/recursive_mutex.hpp&gt;
+boost::recursive_mutex luamutex;
+#	endif
+#endif
 
 bool CGame::DrawWorld()
 {
@@ -3044,39 +3052,48 @@
 }
 
 
-#if defined(USE_GML) &amp;&amp; GML_MT_TEST
-int oldgsframe;
-#endif
 // This will be run by a separate thread in parallel with the Sim
 // ONLY 100% THREAD SAFE UNSYNCED STUFF HERE PLEASE
 void CGame::UnsyncedStuff() {
 	if (!skipping) {
 		infoConsole-&gt;Update();
 	}
-#if defined(USE_GML) &amp;&amp; GML_MT_TEST
-	while(oldgsframe==*(volatile int *)&amp;(gs-&gt;frameNum)) {
-		gmlProcessor.Pump(1);
-		boost::thread::yield();
-	}
-	gu-&gt;drawFrame++;
-	if (gu-&gt;drawFrame == 0) {
-		gu-&gt;drawFrame++;
-	}
-	Draw();
-#endif
 }
 
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+int numNewFrames=0;
+#endif
 
 #if defined(USE_GML) &amp;&amp; GML_ENABLE_SIM
 void CGame::SimFrame() {
-#		if defined(USE_GML) &amp;&amp; GML_MT_TEST
-	oldgsframe=gs-&gt;frameNum;
-#		endif
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	if(gmlThreadCount&gt;1) { // if there is more than one cpu, run draw in parallel with sim
+		int oldgsframe=gs-&gt;frameNum;
+		gmlProcessor.AuxWork(&amp;CGame::SimFrameMTcb,this); // start sim thread
+		UnsyncedStuff();
+		while(oldgsframe==*(volatile int *)&amp;(gs-&gt;frameNum)) { // wait until GL calls in script.update() have finished (ugly hack)
+			gmlProcessor.PumpAux();
+			boost::thread::yield();
+		}
+		if(--numNewFrames==0) {
+			gu-&gt;drawFrame++;
+			if (gu-&gt;drawFrame == 0)
+				gu-&gt;drawFrame++;
+			Draw(); // GML will use one thread less for this draw because sim is running
+		}
+		while(!gmlProcessor.PumpAux()) {
+			// could possibly make more calls to Draw here
+			boost::thread::yield(); 
+		}
+	}
+	else
+#	endif
 	gmlProcessor.Work(&amp;CGame::SimFrameMTcb,NULL,NULL,this,2,FALSE,NULL,1,2,2,FALSE,&amp;CGame::UnsyncedStuffcb);
 #else
 void CGame::SimFrameMT() {
 #endif
 }
+
 #if defined(USE_GML) &amp;&amp; GML_ENABLE_SIM
 void CGame::SimFrameMT() {
 #else
@@ -3101,10 +3118,10 @@
 	if (luaUI)    { luaUI-&gt;GameFrame(gs-&gt;frameNum); }
 	if (luaGaia)  { luaGaia-&gt;GameFrame(gs-&gt;frameNum); }
 	if (luaRules) { luaRules-&gt;GameFrame(gs-&gt;frameNum); }
-
+/*
 #if defined(USE_GML) &amp;&amp; GML_MT_TEST
 	gmlProcessor.GetQueue();
-#endif
+#endif*/
 	gs-&gt;frameNum++;
 
 	ENTER_UNSYNCED;
@@ -3158,6 +3175,7 @@
 	mapDamage-&gt;Update();
 	pathManager-&gt;Update();
 	uh-&gt;Update();
+	groundDecals-&gt;Update();
 
 	{
 		SCOPED_TIMER(&quot;Collisions&quot;);
@@ -3249,7 +3267,6 @@
 	}
 }
 
-
 void CGame::ClientReadNet()
 {
 	if (gu-&gt;gameTime - lastCpuUsageTime &gt;= 1) {
@@ -3263,6 +3280,9 @@
 	boost::shared_ptr&lt;const netcode::RawPacket&gt; packet;
 
 	// compute new timeLeft to &quot;smooth&quot; out SimFrame() calls
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	numNewFrames=0;
+#endif
 	if(!gameServer){
 		const unsigned int currentFrame = SDL_GetTicks();
 
@@ -3277,8 +3297,11 @@
 		// we still have to process (in variable &quot;que&quot;)
 		int que = 0; // Number of NETMSG_NEWFRAMEs waiting to be processed.
 		unsigned ahead = 0;
-		while ((packet = net-&gt;Peek(ahead)))
-		{
+		while ((packet = net-&gt;Peek(ahead))) {
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+			if (packet-&gt;data[0] == NETMSG_NEWFRAME)
+				++numNewFrames;
+#endif
 			if (packet-&gt;data[0] == NETMSG_NEWFRAME || packet-&gt;data[0] == NETMSG_KEYFRAME)
 				++que;
 			++ahead;
@@ -3289,6 +3312,14 @@
 	}
 	else
 	{
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+		unsigned ahead = 0;
+		while ((packet = net-&gt;Peek(ahead))) {
+			if (packet-&gt;data[0] == NETMSG_NEWFRAME)
+				++numNewFrames;
+			++ahead;
+		}
+#endif
 		// make sure ClientReadNet returns at least every 15 game frames
 		// so CGame can process keyboard input, and render etc.
 		timeLeft = 15.0f;

Modified: branches/caiinterface/rts/Game/GameServer.cpp
===================================================================
--- branches/caiinterface/rts/Game/GameServer.cpp	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/rts/Game/GameServer.cpp	2008-10-11 12:23:25 UTC (rev 6669)
@@ -1390,7 +1390,7 @@
 	if (players[playerNum]) {
 		Message(str(format(PlayerLeft) %playerNum %&quot;kicked&quot;));
 		Broadcast(CBaseNetProtocol::Get().SendPlayerLeft(playerNum, 2));
-		Broadcast(CBaseNetProtocol::Get().SendQuit());
+		players[playerNum]-&gt;link-&gt;SendData(CBaseNetProtocol::Get().SendQuit());
 		if (hostif)
 		{
 			hostif-&gt;SendPlayerLeft(playerNum, 2);

Modified: branches/caiinterface/rts/Game/GameVersion.cpp
===================================================================
--- branches/caiinterface/rts/Game/GameVersion.cpp	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/rts/Game/GameVersion.cpp	2008-10-11 12:23:25 UTC (rev 6669)
@@ -7,4 +7,4 @@
 #include &quot;GameVersion.h&quot;
 
 /** The game version. */
-const char* const VERSION_STRING = &quot;0.77b2+&quot;;
+const char* const VERSION_STRING = &quot;0.77b3+&quot;;

Modified: branches/caiinterface/rts/Game/SelectedUnits.cpp
===================================================================
--- branches/caiinterface/rts/Game/SelectedUnits.cpp	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/rts/Game/SelectedUnits.cpp	2008-10-11 12:23:25 UTC (rev 6669)
@@ -39,6 +39,14 @@
 #include &quot;Sound.h&quot;
 #include &quot;Util.h&quot;
 
+#ifdef USE_GML
+#include &quot;lib/gml/gmlsrv.h&quot;
+#	if GML_MT_TEST
+extern boost::mutex caimutex;
+boost::mutex selmutex;
+#	endif
+#endif
+
 extern Uint8 *keys;
 
 
@@ -367,6 +375,10 @@
 		return;
 	}
 
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::mutex::scoped_lock sellock(selmutex);
+#endif
+
 	selectedUnits.insert(unit);
 	AddDeathDependence(unit);
 	selectionChanged = true;
@@ -384,6 +396,10 @@
 
 void CSelectedUnits::RemoveUnit(CUnit* unit)
 {
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::mutex::scoped_lock sellock(selmutex);
+#endif
+
 	selectedUnits.erase(unit);
 	DeleteDeathDependence(unit);
 	selectionChanged=true;
@@ -398,6 +414,10 @@
 
 void CSelectedUnits::ClearSelected()
 {
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::mutex::scoped_lock sellock(selmutex);
+#endif
+
 	CUnitSet::iterator ui;
 	ENTER_MIXED;
 	for(ui=selectedUnits.begin();ui!=selectedUnits.end();++ui){
@@ -415,6 +435,10 @@
 
 void CSelectedUnits::SelectGroup(int num)
 {
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::mutex::scoped_lock sellock(selmutex);
+#endif
+
 	ClearSelected();
 	selectedGroup=num;
 	CGroup* group=grouphandlers[gu-&gt;myTeam]-&gt;groups[num];
@@ -475,6 +499,9 @@
 				 ((guihandler-&gt;inCommand &gt;= 0) &amp;&amp;
 					(guihandler-&gt;inCommand &lt; guihandler-&gt;commands.size()) &amp;&amp;
 					(guihandler-&gt;commands[guihandler-&gt;inCommand].id &lt; 0)))) {
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+			boost::mutex::scoped_lock cailock(caimutex);
+#endif
 			bool myColor = true;
 			glColor4fv(cmdColors.buildBox);
 			std::list&lt;CBuilderCAI*&gt;::const_iterator bi;
@@ -507,6 +534,10 @@
 
 void CSelectedUnits::DependentDied(CObject *o)
 {
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::mutex::scoped_lock sellock(selmutex);
+#endif
+
 	selectedUnits.erase((CUnit*)o);
 	selectionChanged=true;
 	possibleCommandsChanged=true;
@@ -690,6 +721,9 @@
 			(*ui)-&gt;commandAI-&gt;DrawCommands();
 		}
 	} else {
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+		boost::mutex::scoped_lock sellock(selmutex);
+#endif
 		for(ui = selectedUnits.begin(); ui != selectedUnits.end(); ++ui) {
 			(*ui)-&gt;commandAI-&gt;DrawCommands();
 		}

Modified: branches/caiinterface/rts/Game/UI/GuiHandler.cpp
===================================================================
--- branches/caiinterface/rts/Game/UI/GuiHandler.cpp	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/rts/Game/UI/GuiHandler.cpp	2008-10-11 12:23:25 UTC (rev 6669)
@@ -56,6 +56,16 @@
 #include &quot;System/Platform/ConfigHandler.h&quot;
 #include &quot;System/Util.h&quot;
 
+#ifdef USE_GML
+#include &quot;lib/gml/gmlsrv.h&quot;
+#	if GML_MT_TEST
+#include &lt;boost/thread/recursive_mutex.hpp&gt;
+extern boost::mutex caimutex;
+extern boost::mutex selmutex;
+extern boost::recursive_mutex quadmutex;
+#	endif
+#endif
+
 extern Uint8 *keys;
 
 
@@ -3568,6 +3578,9 @@
 	CUnit* pointedAt = NULL;
 	if (GetQueueKeystate()) {
 		CUnit* unit = NULL;
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+		boost::recursive_mutex::scoped_lock quadlock(quadmutex); // getselectunit, guitraceray accesses quadfield
+#endif
 		if (minimapCoords) {
 			unit = minimap-&gt;GetSelectUnit(camera-&gt;pos);
 		} else {
@@ -3662,7 +3675,9 @@
 	// draw buildings we are about to build
 	if ((inCommand &gt;= 0) &amp;&amp; (inCommand &lt; commands.size()) &amp;&amp;
 	    (commands[inCommand].type == CMDTYPE_ICON_BUILDING)) {
-
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+		boost::mutex::scoped_lock cailock(caimutex);
+#endif
 		// draw build distance for all immobile builders during build commands
 		std::list&lt;CBuilderCAI*&gt;::const_iterator bi;
 		for (bi = uh-&gt;builderCAIs.begin(); bi != uh-&gt;builderCAIs.end(); ++bi) {
@@ -3690,6 +3705,9 @@
 				float3 pos = camera-&gt;pos+mouse-&gt;dir*dist;
 				std::vector&lt;BuildInfo&gt; buildPos;
 				const CMouseHandler::ButtonPress&amp; bp = mouse-&gt;buttons[SDL_BUTTON_LEFT];
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+			boost::recursive_mutex::scoped_lock quadlock(quadmutex); // getbuildpos accesses quadfield
+#endif
 				if (GetQueueKeystate() &amp;&amp; bp.pressed) {
 					const float dist = ground-&gt;LineGroundCol(bp.camPos, bp.camPos + bp.dir * gu-&gt;viewRange * 1.4f);
 					const float3 pos2 = bp.camPos + bp.dir * dist;
@@ -3749,6 +3767,9 @@
 
 					std::vector&lt;Command&gt; cv;
 					if (GetQueueKeystate()) {
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+						boost::mutex::scoped_lock sellock(selmutex);
+#endif
 						Command c;
 						bpi-&gt;FillCmd(c);
 						std::vector&lt;Command&gt; temp;
@@ -3782,6 +3803,9 @@
 	int defcmd = GetDefaultCommand(mouse-&gt;lastx, mouse-&gt;lasty);
 	if ((inCommand&gt;=0 &amp;&amp; inCommand&lt;commands.size() &amp;&amp; commands[inCommand].id==CMD_ATTACK) ||
 	    (inCommand==-1 &amp;&amp; defcmd&gt;0 &amp;&amp; commands[defcmd].id==CMD_ATTACK)){
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+		boost::mutex::scoped_lock sellock(selmutex);
+#endif
 		for(CUnitSet::iterator si=selectedUnits.selectedUnits.begin(); si!=selectedUnits.selectedUnits.end(); ++si) {
 			CUnit* unit = *si;
 			if (unit == pointedAt) {

Modified: branches/caiinterface/rts/Game/UI/MiniMap.cpp
===================================================================
--- branches/caiinterface/rts/Game/UI/MiniMap.cpp	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/rts/Game/UI/MiniMap.cpp	2008-10-11 12:23:25 UTC (rev 6669)
@@ -60,8 +60,17 @@
 #include &quot;TimeProfiler.h&quot;
 #include &quot;TooltipConsole.h&quot;
 
+#ifdef USE_GML
+#include &quot;lib/gml/gmlsrv.h&quot;
+#	if GML_MT_TEST
+#include &lt;boost/thread/recursive_mutex.hpp&gt;
+extern boost::recursive_mutex unitmutex;
+extern boost::recursive_mutex quadmutex;
+extern boost::recursive_mutex projmutex;
+extern boost::mutex selmutex;
+#	endif
+#endif
 
-
 //////////////////////////////////////////////////////////////////////
 // Construction/Destruction
 //////////////////////////////////////////////////////////////////////
@@ -1041,12 +1050,17 @@
 	glEnable(GL_ALPHA_TEST);
 	glAlphaFunc(GL_GREATER, 0.0f);
 
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::recursive_mutex::scoped_lock unitlock(unitmutex);
+#endif
 	// draw the units
 	std::list&lt;CUnit*&gt;::iterator ui;
 	for (ui = uh-&gt;activeUnits.begin(); ui != uh-&gt;activeUnits.end(); ui++) {
 		DrawUnit(*ui);
 	}
-
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+		boost::recursive_mutex::scoped_lock quadlock(quadmutex); // getselectunit accesses quadfield
+#endif
 	// highlight the selected unit
 	CUnit* unit = GetSelectUnit(GetMapPosition(mouse-&gt;lastx, mouse-&gt;lasty));
 	if (unit != NULL) {
@@ -1097,6 +1111,9 @@
 
 	glRotatef(-90.0f, +1.0f, 0.0f, 0.0f); // real 'world' coordinates
 
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::recursive_mutex::scoped_lock projlock(projmutex);
+#endif
 	// draw the projectiles
 	if (drawProjectiles &amp;&amp; ph-&gt;ps.size()&gt;0) {
 		CVertexArray* lines=GetVertexArray();
@@ -1169,6 +1186,9 @@
 		guihandler-&gt;DrawMapStuff(!!drawCommands);
 	}
 
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::mutex::scoped_lock sellock(selmutex);
+#endif
 	// draw unit ranges
 	const float radarSquare = (SQUARE_SIZE * RADAR_SIZE);
 	CUnitSet&amp; selUnits = selectedUnits.selectedUnits;

Modified: branches/caiinterface/rts/Lua/LuaCallInCheck.h
===================================================================
--- branches/caiinterface/rts/Lua/LuaCallInCheck.h	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/rts/Lua/LuaCallInCheck.h	2008-10-11 12:23:25 UTC (rev 6669)
@@ -26,5 +26,15 @@
 #  define LUA_CALL_IN_CHECK(L)
 #endif
 
+#ifdef USE_GML
+#include &quot;Rendering/GL/myGL.h&quot;
+#include &quot;lib/gml/gmlsrv.h&quot;
+#	if GML_MT_TEST
+#include &lt;boost/thread/recursive_mutex.hpp&gt;
+extern boost::recursive_mutex luamutex;
+#undef LUA_CALL_IN_CHECK
+#define LUA_CALL_IN_CHECK(L) boost::recursive_mutex::scoped_lock lualock(luamutex);
+#	endif
+#endif
 
 #endif /* LUA_CALL_IN_CHECK_H */

Modified: branches/caiinterface/rts/Lua/LuaHandle.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaHandle.cpp	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/rts/Lua/LuaHandle.cpp	2008-10-11 12:23:25 UTC (rev 6669)
@@ -169,6 +169,9 @@
 
 void CLuaHandle::CheckStack()
 {
+#if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	LUA_CALL_IN_CHECK(L);
+#endif
 	const int top = lua_gettop(L);
 	if (top != 0) {
 		logOutput.Print(&quot;WARNING: %s stack check: top = %i\n&quot;, GetName().c_str(), top);

Modified: branches/caiinterface/rts/Map/BaseGroundDrawer.cpp
===================================================================
--- branches/caiinterface/rts/Map/BaseGroundDrawer.cpp	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/rts/Map/BaseGroundDrawer.cpp	2008-10-11 12:23:25 UTC (rev 6669)
@@ -21,8 +21,15 @@
 #include &quot;System/Platform/ConfigHandler.h&quot;
 #include &quot;System/FastMath.h&quot;
 
+#ifdef USE_GML
+#include &quot;lib/gml/gmlsrv.h&quot;
+#	if GML_MT_TEST
+#include &lt;boost/thread/recursive_mutex.hpp&gt;
+extern boost::recursive_mutex featmutex;
+extern boost::mutex selmutex;
+#	endif
+#endif
 
-
 CBaseGroundDrawer::CBaseGroundDrawer(void)
 {
 	updateFov = true;
@@ -248,6 +255,9 @@
 							} else {
 								const UnitDef* unitdef = unitDefHandler-&gt;GetUnitByID(-guihandler-&gt;commands[guihandler-&gt;inCommand].id);
 								CFeature* f;
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+								boost::recursive_mutex::scoped_lock featlock(featmutex); // testunitbuildsquare accesses features in the quadfield
+#endif
 								if(uh-&gt;TestUnitBuildSquare(BuildInfo(unitdef, float3(x*16+8, 0, y*16+8), guihandler-&gt;buildFacing), f, gu-&gt;myAllyTeam)) {
 									if (f) {
 										m = 0.5f;
@@ -267,6 +277,9 @@
 				}
 				else {
 					// use the first selected unit
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+					boost::mutex::scoped_lock sellock(selmutex);
+#endif
 					if (selectedUnits.selectedUnits.empty()) {
 						return true;
 					}

Modified: branches/caiinterface/rts/Rendering/Env/AdvSky.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/Env/AdvSky.cpp	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/rts/Rendering/Env/AdvSky.cpp	2008-10-11 12:23:25 UTC (rev 6669)
@@ -339,20 +339,37 @@
 }
 
 inline void CAdvSky::UpdatePart(int ast, int aed, int a3cstart, int a4cstart) {
-	int *rc=*rawClouds+ast;
-	unsigned char *ct=cloudTexMem+4*ast;
+	int* rc = *rawClouds + ast;
+	unsigned char* ct = cloudTexMem + 4 * ast;
 
-	int am2=(ast-2)&amp;CLOUD_MASK, am1=(ast-1)&amp;CLOUD_MASK, aa=(ast)&amp;CLOUD_MASK, ap1=(ast+1)&amp;CLOUD_MASK;
-	int a3c=ast+a3cstart, a4c=ast+a4cstart;
-	for(int a=ast; a&lt;aed; ++rc, ++ct){
-		ydif[ap1]+=(int)cloudThickness[++a3c] - cloudThickness[++a] * 2 + cloudThickness[++a4c];
-		ydif2[ap1]=(ydif1[ap1]=ydif[ap1]&gt;&gt;1)&gt;&gt;1;
-		int dif=(ydif2[am2] + ydif1[am2=am1] + ydif[am1=aa] + ydif1[aa=ap1] + ydif2[++ap1]) / 16;
-		if(ap1&gt;=CLOUD_SIZE)
-			ap1=0;
-		*ct++=128+dif;
-		*ct++=thicknessTransform[(*rc)&gt;&gt;7];
-		*ct++=255;
+	int
+		am2 = (ast - 2) &amp; CLOUD_MASK,
+		am1 = (ast - 1) &amp; CLOUD_MASK,
+		aa  = (ast) &amp; CLOUD_MASK,
+		ap1 = (ast + 1) &amp; CLOUD_MASK,
+		dif = 0;
+
+	int
+		a3c = ast + a3cstart,
+		a4c = ast + a4cstart;
+
+	for (int a = ast; a &lt; aed; ++rc, ++ct) {
+		ydif[ap1] += (int) cloudThickness[++a3c] - cloudThickness[++a] * 2 + cloudThickness[++a4c];
+		ydif2[ap1] = (ydif1[ap1] = ydif[ap1] &gt;&gt; 1) &gt;&gt; 1;
+
+		dif = ydif2[am2];
+		am2 = am1; dif += ydif1[am2];
+		am1 = aa;  dif += ydif[am1];
+		aa = ap1;  dif += ydif1[aa];
+		ap1 += 1;  dif += ydif2[ap1];
+		dif &gt;&gt;= 4;
+
+		if (ap1 &gt;= CLOUD_SIZE)
+			ap1 = 0;
+
+		*ct++ = 128 + dif;
+		*ct++ = thicknessTransform[(*rc) &gt;&gt; 7];
+		*ct++ = 255;
 	}
 }
 

Modified: branches/caiinterface/rts/Rendering/Env/AdvTreeDrawer.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/Env/AdvTreeDrawer.cpp	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/rts/Rendering/Env/AdvTreeDrawer.cpp	2008-10-11 12:23:25 UTC (rev 6669)
@@ -19,6 +19,12 @@
 #include &quot;Matrix44f.h&quot;
 #include &quot;Rendering/ShadowHandler.h&quot;
 
+#ifdef USE_GML
+#include &quot;lib/gml/gmlsrv.h&quot;
+#	if GML_MT_TEST
+boost::mutex treemutex;
+#	endif
+#endif
 //////////////////////////////////////////////////////////////////////
 // Construction/Destruction
 //////////////////////////////////////////////////////////////////////
@@ -79,6 +85,10 @@
 
 void CAdvTreeDrawer::Update()
 {
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::mutex::scoped_lock treelock(treemutex);
+#endif
+
 	for(std::list&lt;FallingTree&gt;::iterator fti=fallingTrees.begin();fti!=fallingTrees.end();){
 		fti-&gt;fallPos+=fti-&gt;speed*0.1f;
 		if(fti-&gt;fallPos&gt;1){		//remove the tree
@@ -334,6 +344,10 @@
 	drawer.treeDistance = treeDistance;
 	drawer.drawDetailed = drawDetailed;
 
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::mutex::scoped_lock treelock(treemutex);
+#endif
+
 	// draw far away trees using the map dependent grid visibility
 	oldTreeDistance=treeDistance;
 	readmap-&gt;GridVisibility (camera, TREE_SQUARE_SIZE, treeDistance*2*SQUARE_SIZE*TREE_SQUARE_SIZE, &amp;drawer);
@@ -640,6 +654,10 @@
 	drawer.td = this;
 	drawer.treeDistance = treeDistance;
 
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::mutex::scoped_lock treelock(treemutex);
+#endif
+
 	// draw with extraSize=1
 	readmap-&gt;GridVisibility (camera, TREE_SQUARE_SIZE, treeDistance*2*SQUARE_SIZE*TREE_SQUARE_SIZE, &amp;drawer, 1);
 
@@ -785,6 +803,10 @@
 
 void CAdvTreeDrawer::AddTree(int type, float3 pos, float size)
 {
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::mutex::scoped_lock treelock(treemutex);
+#endif
+
 	TreeStruct ts;
 	ts.pos=pos;
 	ts.type=type;
@@ -796,6 +818,10 @@
 
 void CAdvTreeDrawer::DeleteTree(float3 pos)
 {
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::mutex::scoped_lock treelock(treemutex);
+#endif
+
 	int hash=(int)pos.x+((int)(pos.z))*20000;
 	int square=((int)pos.x)/(SQUARE_SIZE*TREE_SQUARE_SIZE)+((int)pos.z)/(SQUARE_SIZE*TREE_SQUARE_SIZE)*treesX;
 
@@ -806,6 +832,10 @@
 
 int CAdvTreeDrawer::AddFallingTree(float3 pos, float3 dir, int type)
 {
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::mutex::scoped_lock treelock(treemutex);
+#endif
+
 	FallingTree ft;
 
 	ft.pos=pos;
@@ -824,11 +854,19 @@
 
 void CAdvTreeDrawer::AddGrass(float3 pos)
 {
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::mutex::scoped_lock treelock(treemutex);
+#endif
+
 	grassDrawer-&gt;AddGrass(pos);
 }
 
 void CAdvTreeDrawer::RemoveGrass(int x, int z)
 {
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::mutex::scoped_lock treelock(treemutex);
+#endif
+
 	grassDrawer-&gt;RemoveGrass(x,z);
 }
 

Modified: branches/caiinterface/rts/Rendering/Env/BasicSky.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/Env/BasicSky.cpp	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/rts/Rendering/Env/BasicSky.cpp	2008-10-11 12:23:25 UTC (rev 6669)
@@ -384,29 +384,47 @@
 	glTexParameteri(GL_TEXTURE_2D,GL_TEXTURE_MAG_FILTER,GL_LINEAR);
 	glTexParameteri(GL_TEXTURE_2D,GL_TEXTURE_MIN_FILTER,GL_LINEAR);
 	glTexImage2D(GL_TEXTURE_2D,0,GL_RGBA8, CLOUD_SIZE, CLOUD_SIZE,0,GL_RGBA, GL_UNSIGNED_BYTE, scrap);
-  delete [] scrap;
+	delete [] scrap;
 
 	CreateTransformVectors();
 	Update();
 }
 
 inline void CBasicSky::UpdatePart(int ast, int aed, int a3cstart, int a4cstart) {
-	int *rc=*rawClouds+ast;
-	unsigned char *ct=cloudThickness+4*ast;
+	int* rc = *rawClouds + ast;
+	unsigned char* ct = cloudThickness + 4 * ast;
 
-	int am2=(ast-2)&amp;CLOUD_MASK, am1=(ast-1)&amp;CLOUD_MASK, aa=(ast)&amp;CLOUD_MASK, ap1=(ast+1)&amp;CLOUD_MASK;
-	aed=aed*4+3;
-	ast=ast*4+3;
-	int a3c=ast+a3cstart*4, a4c=ast+a4cstart*4;
-	for(int a=ast; a&lt;aed; ++rc, ++ct){
-		ydif[ap1]+=(int)cloudThickness[a3c+=4] - cloudThickness[a+=4] * 2 + cloudThickness[a4c+=4];
-		ydif2[ap1]=(ydif1[ap1]=ydif[ap1]&gt;&gt;1)&gt;&gt;1;
-		int dif=(ydif2[am2] + ydif1[am2=am1] + ydif[am1=aa] + ydif1[aa=ap1] + ydif2[++ap1]) / 16;
-		if(ap1&gt;=CLOUD_SIZE)
-			ap1=0;
-		*ct++=128+dif;
-		*ct++=thicknessTransform[(*rc)&gt;&gt;7];
-		*ct++=255;
+	int
+		am2 = (ast - 2) &amp; CLOUD_MASK,
+		am1 = (ast - 1) &amp; CLOUD_MASK,
+		aa  = (ast) &amp; CLOUD_MASK,
+		ap1 = (ast + 1) &amp; CLOUD_MASK,
+		dif = 0;
+
+	aed = aed * 4 + 3;
+	ast = ast * 4 + 3;
+
+	int
+		a3c = ast + a3cstart * 4,
+		a4c = ast + a4cstart * 4;
+
+	for (int a = ast; a &lt; aed; ++rc, ++ct) {
+		ydif[ap1] += (int) cloudThickness[a3c += 4] - cloudThickness[a += 4] * 2 + cloudThickness[a4c += 4];
+		ydif2[ap1] = (ydif1[ap1] = ydif[ap1] &gt;&gt; 1) &gt;&gt; 1;
+
+		dif = ydif2[am2];
+		am2 = am1; dif += ydif1[am2];
+		am1 = aa;  dif += ydif[am1];
+		aa = ap1;  dif += ydif1[aa];
+		ap1 += 1;  dif += ydif2[ap1];
+		dif &gt;&gt;= 4;
+
+		if (ap1 &gt;= CLOUD_SIZE)
+			ap1 = 0;
+
+		*ct++ = 128 + dif;
+		*ct++ = thicknessTransform[(*rc) &gt;&gt; 7];
+		*ct++ = 255;
 	}
 }
 

Modified: branches/caiinterface/rts/Rendering/Env/BasicTreeDrawer.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/Env/BasicTreeDrawer.cpp	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/rts/Rendering/Env/BasicTreeDrawer.cpp	2008-10-11 12:23:25 UTC (rev 6669)
@@ -16,6 +16,13 @@
 #include &quot;System/LogOutput.h&quot;
 #include &quot;System/Exceptions.h&quot;
 
+#ifdef USE_GML
+#include &quot;lib/gml/gmlsrv.h&quot;
+#	if GML_MT_TEST
+extern boost::mutex treemutex;
+#	endif
+#endif
+
 //////////////////////////////////////////////////////////////////////
 // Construction/Destruction
 //////////////////////////////////////////////////////////////////////
@@ -390,6 +397,10 @@
 	drawer.cy = cy;
 	drawer.treeDistance = treeDistance;
 
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::mutex::scoped_lock treelock(treemutex);
+#endif
+
 	readmap-&gt;GridVisibility (camera, TREE_SQUARE_SIZE, treeDistance*2*SQUARE_SIZE*TREE_SQUARE_SIZE, &amp;drawer);
 
 	int startClean=lastListClean*20%nTrees;
@@ -435,6 +446,9 @@
 
 void CBasicTreeDrawer::Update()
 {
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::mutex::scoped_lock treelock(treemutex);
+#endif
 
 }
 
@@ -464,6 +478,10 @@
 
 void CBasicTreeDrawer::AddTree(int type, float3 pos, float size)
 {
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::mutex::scoped_lock treelock(treemutex);
+#endif
+
 	TreeStruct ts;
 	ts.pos=pos;
 	ts.type=type;
@@ -475,6 +493,10 @@
 
 void CBasicTreeDrawer::DeleteTree(float3 pos)
 {
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::mutex::scoped_lock treelock(treemutex);
+#endif
+
 	int hash=(int)pos.x+((int)(pos.z))*20000;
 	int square=((int)pos.x)/(SQUARE_SIZE*TREE_SQUARE_SIZE)+((int)pos.z)/(SQUARE_SIZE*TREE_SQUARE_SIZE)*treesX;
 

Modified: branches/caiinterface/rts/Rendering/Env/GrassDrawer.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/Env/GrassDrawer.cpp	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/rts/Rendering/Env/GrassDrawer.cpp	2008-10-11 12:23:25 UTC (rev 6669)
@@ -22,6 +22,14 @@
 #include &quot;System/Exceptions.h&quot;
 //#include &quot;TimeProfiler.h&quot;
 
+#ifdef USE_GML
+#include &quot;lib/gml/gmlsrv.h&quot;
+#	if GML_MT_TEST
+#include &lt;boost/thread/recursive_mutex.hpp&gt;
+boost::recursive_mutex grassmutex;
+#	endif
+#endif
+
 static const float turfSize=20;				//single turf size
 static const float partTurfSize=turfSize*0.6f;				//single turf size
 static const int grassSquareSize=4;		//mapsquares per grass square
@@ -420,6 +428,10 @@
 	drawer.cy=(int)(camera-&gt;pos.z/bMSsq);
 	drawer.gd = this;
 
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::recursive_mutex::scoped_lock grasslock(grassmutex);
+#endif
+
 	readmap-&gt;GridVisibility (camera, blockMapSize, maxGrassDist, &amp;drawer);
 	CVertexArray *va = drawer.va;
 	
@@ -595,6 +607,11 @@
 {
 	if(grassOff)
 		return;
+
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::recursive_mutex::scoped_lock grasslock(grassmutex);
+#endif
+
 	int a=(int(pos.z/bMSsq)&amp;31)*32+(int(pos.x/bMSsq)&amp;31);
 	if(grass[a].va){
 		delete grass[a].va;
@@ -785,6 +802,11 @@
 {
 	if(grassOff)
 		return;
+
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::recursive_mutex::scoped_lock grasslock(grassmutex);
+#endif
+
 	grassMap[(int(pos.z)/SQUARE_SIZE/grassSquareSize)*gs-&gt;mapx/grassSquareSize+int(pos.x)/SQUARE_SIZE/grassSquareSize]=1;
 }
 
@@ -792,6 +814,11 @@
 {
 	if(grassOff)
 		return;
+
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::recursive_mutex::scoped_lock grasslock(grassmutex);
+#endif
+
 	grassMap[(z/grassSquareSize)*gs-&gt;mapx/grassSquareSize+x/grassSquareSize]=0;
 	ResetPos(float3(x*SQUARE_SIZE,0,z*SQUARE_SIZE));
 }

Modified: branches/caiinterface/rts/Rendering/GroundDecalHandler.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/GroundDecalHandler.cpp	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/rts/Rendering/GroundDecalHandler.cpp	2008-10-11 12:23:25 UTC (rev 6669)
@@ -22,6 +22,13 @@
 #include &quot;System/Util.h&quot;
 #include &quot;System/Exceptions.h&quot;
 
+#ifdef USE_GML
+#include &quot;lib/gml/gmlsrv.h&quot;
+#	if GML_MT_TEST
+boost::mutex decalmutex;
+#	endif
+#endif
+
 using std::list;
 using std::min;
 using std::max;
@@ -136,7 +143,7 @@
 	float uv[8] = {0.0f};
 	unsigned char color[4] = {255, 255, 255, int(decal-&gt;alpha * 255)};
 
-	#define HEIGHT(x, z) (hm[((z) * gsmx1) + (x)])
+	#define HEIGHT(z, x) (hm[((z) * gsmx1) + (x)])
 
 	if (!decal-&gt;va) {
 		// NOTE: this really needs CLOD'ing
@@ -408,6 +415,9 @@
 		glMatrixMode(GL_MODELVIEW);
 	}
 
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::mutex::scoped_lock decallock(decalmutex);
+#endif
 
 	// create and draw the quads for each building decal
 	for (std::vector&lt;BuildingDecalType*&gt;::iterator bdi = buildingDecalTypes.begin(); bdi != buildingDecalTypes.end(); ++bdi) {
@@ -554,11 +564,23 @@
 
 void CGroundDecalHandler::Update(void)
 {
+#if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::mutex::scoped_lock decallock(decalmutex);
+#endif
+	for(std::vector&lt;CUnit *&gt;::iterator i=moveUnits.begin(); i!=moveUnits.end(); ++i)
+		UnitMovedNow(*i);
+	moveUnits.clear();
 }
 
 
 void CGroundDecalHandler::UnitMoved(CUnit* unit)
 {
+	moveUnits.push_back(unit);
+}
+
+
+void CGroundDecalHandler::UnitMovedNow(CUnit* unit)
+{
 	if(decalLevel==0)
 		return;
 
@@ -629,6 +651,7 @@
 
 int CGroundDecalHandler::GetTrackType(const std::string&amp; name)
 {
+
 	if (decalLevel == 0) {
 		return 0;
 	}
@@ -644,6 +667,10 @@
 		++a;
 	}
 
+#if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::mutex::scoped_lock decallock(decalmutex);
+#endif
+
 	TrackType* tt = SAFE_NEW TrackType;
 	tt-&gt;name = lowerName;
 	tt-&gt;texture = LoadTexture(lowerName);
@@ -688,6 +715,10 @@
 	if (decalLevel == 0)
 		return;
 
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::mutex::scoped_lock decallock(decalmutex);
+#endif
+
 	float height = pos.y - ground-&gt;GetHeight2(pos.x, pos.z);
 	if (height &gt;= radius)
 		return;
@@ -853,6 +884,10 @@
 	if (decalLevel == 0)
 		return;
 
+#if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::mutex::scoped_lock decallock(decalmutex);
+#endif
+
 	BuildingDecalType* type = buildingDecalTypes[building-&gt;unitDef-&gt;buildingDecalType];
 	BuildingGroundDecal* decal = SAFE_NEW BuildingGroundDecal;
 
@@ -889,6 +924,10 @@
 
 void CGroundDecalHandler::RemoveBuilding(CBuilding* building,CUnitDrawer::GhostBuilding* gb)
 {
+#if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::mutex::scoped_lock decallock(decalmutex);
+#endif
+
 	BuildingGroundDecal* decal = building-&gt;buildingDecal;
 	if (!decal)
 		return;
@@ -916,6 +955,10 @@
 		++a;
 	}
 
+#if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::mutex::scoped_lock decallock(decalmutex);
+#endif
+
 	BuildingDecalType* tt = SAFE_NEW BuildingDecalType;
 	tt-&gt;name = lowerName;
 	const std::string fullName = &quot;unittextures/&quot; + lowerName;

Modified: branches/caiinterface/rts/Rendering/GroundDecalHandler.h
===================================================================
--- branches/caiinterface/rts/Rendering/GroundDecalHandler.h	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/rts/Rendering/GroundDecalHandler.h	2008-10-11 12:23:25 UTC (rev 6669)
@@ -59,6 +59,7 @@
 	void Update(void);
 
 	void UnitMoved(CUnit* unit);
+	void UnitMovedNow(CUnit* unit);
 	void RemoveUnit(CUnit* unit);
 	int GetTrackType(const std::string&amp; name);
 
@@ -112,6 +113,8 @@
 
 	std::list&lt;Scar*&gt; scars;
 
+	std::vector&lt;CUnit *&gt; moveUnits;
+
 	int lastTest;
 	float maxOverlap;
 

Modified: branches/caiinterface/rts/Rendering/Textures/ColorMap.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/Textures/ColorMap.cpp	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/rts/Rendering/Textures/ColorMap.cpp	2008-10-11 12:23:25 UTC (rev 6669)
@@ -101,12 +101,12 @@
 	{
 		map = new CColorMap(filename);
 		colorMapsMap[lowfilename] = map;
+		colorMaps.push_back(map);
 	}
 	else
 	{
 		map = colorMapsMap.find(lowfilename)-&gt;second;
 	}
-	colorMaps.push_back(map);
 	return map;
 }
 

Modified: branches/caiinterface/rts/Rendering/UnitModels/UnitDrawer.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/UnitModels/UnitDrawer.cpp	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/rts/Rendering/UnitModels/UnitDrawer.cpp	2008-10-11 12:23:25 UTC (rev 6669)
@@ -46,6 +46,10 @@
 
 #ifdef USE_GML
 #include &quot;lib/gml/gmlsrv.h&quot;
+#	if GML_MT_TEST
+#include &lt;boost/thread/recursive_mutex.hpp&gt;
+extern boost::recursive_mutex unitmutex;
+#	endif
 extern gmlClientServer&lt;void, int,CUnit*&gt; gmlProcessor;
 #endif
 
@@ -215,6 +219,10 @@
 
 void CUnitDrawer::Update(void)
 {
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::recursive_mutex::scoped_lock unitlock(unitmutex);
+#endif
+
 	while (!tempDrawUnits.empty() &amp;&amp; tempDrawUnits.begin()-&gt;first &lt; gs-&gt;frameNum - 1) {
 		tempDrawUnits.erase(tempDrawUnits.begin());
 	}
@@ -406,6 +414,10 @@
 	CUnit* excludeUnit = drawReflection ? NULL : gu-&gt;directControl;
 #endif
 
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::recursive_mutex::scoped_lock unitlock(unitmutex);
+#endif
+
 #ifdef USE_GML
 	if(multiThreadDrawUnit) {
 		mt_drawReflection=drawReflection; // these member vars will be accessed by DoDrawUnitMT
@@ -679,6 +691,10 @@
 
 	CUnit::SetLODFactor(LODScale * LODScaleShadow);
 
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::recursive_mutex::scoped_lock unitlock(unitmutex);
+#endif
+
 #ifdef USE_GML
 	if(multiThreadDrawUnitShadow) {
 		gmlProcessor.Work(NULL, NULL, &amp;CUnitDrawer::DoDrawUnitShadowMT, this, gmlThreadCount, FALSE,
@@ -849,6 +865,10 @@
 	glColor4f(1, 1, 1, 0.3f);
 	glDepthMask(0);
 
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::recursive_mutex::scoped_lock unitlock(unitmutex);
+#endif
+
 	// units drawn by AI, these aren't really
 	// cloaked but the effect is the same
 	for (std::multimap&lt;int, TempDrawUnit&gt;::iterator ti = tempTransparentDrawUnits.begin(); ti != tempTransparentDrawUnits.end(); ++ti) {

Modified: branches/caiinterface/rts/Sim/Features/FeatureHandler.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Features/FeatureHandler.cpp	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/rts/Sim/Features/FeatureHandler.cpp	2008-10-11 12:23:25 UTC (rev 6669)
@@ -32,6 +32,14 @@
 #include &quot;creg/STL_Set.h&quot;
 #include &quot;System/Exceptions.h&quot;
 
+#ifdef USE_GML
+#include &quot;lib/gml/gmlsrv.h&quot;
+#	if GML_MT_TEST
+#include &lt;boost/thread/recursive_mutex.hpp&gt;
+boost::recursive_mutex featmutex;
+#	endif
+#endif
+
 using namespace std;
 
 
@@ -390,6 +398,10 @@
 
 int CFeatureHandler::AddFeature(CFeature* feature)
 {
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::recursive_mutex::scoped_lock featlock(featmutex);
+#endif
+
 	ASSERT_SYNCED_MODE;
 
 	// FIXME -- randomize me, pretty please
@@ -419,6 +431,10 @@
 
 void CFeatureHandler::DeleteFeature(CFeature* feature)
 {
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::recursive_mutex::scoped_lock featlock(featmutex); // maybe superfluous
+#endif
+
 	ASSERT_SYNCED_MODE;
 	toBeRemoved.push_back(feature-&gt;id);
 
@@ -466,6 +482,10 @@
 
 void CFeatureHandler::Update()
 {
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::recursive_mutex::scoped_lock featlock(featmutex);
+#endif
+
 	ASSERT_SYNCED_MODE;
 	SCOPED_TIMER(&quot;Feature::Update&quot;);
 
@@ -520,6 +540,10 @@
 
 void CFeatureHandler::UpdateDrawQuad(CFeature* feature, const float3&amp; newPos)
 {
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::recursive_mutex::scoped_lock featlock(featmutex);
+#endif
+
 	const int oldDrawQuad = feature-&gt;drawQuad;
 	if (oldDrawQuad &gt;= 0) {
 		const int newDrawQuad =
@@ -578,8 +602,12 @@
 void CFeatureHandler::Draw()
 {
 	ASSERT_UNSYNCED_MODE;
-	vector&lt;CFeature*&gt; drawFar;
+	drawFar.clear();
 
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::recursive_mutex::scoped_lock featlock(featmutex);
+#endif
+
 	unitDrawer-&gt;SetupForUnitDrawing();
 	DrawRaw(0, &amp;drawFar);
 	unitDrawer-&gt;CleanUpUnitDrawing();
@@ -611,6 +639,10 @@
 	glPolygonOffset(1,1);
 	glEnable(GL_POLYGON_OFFSET_FILL);
 
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::recursive_mutex::scoped_lock featlock(featmutex);
+#endif
+
 	unitDrawer-&gt;SetupForUnitDrawing();
 	DrawRaw(1, NULL);
 	unitDrawer-&gt;CleanUpUnitDrawing();

Modified: branches/caiinterface/rts/Sim/Features/FeatureHandler.h
===================================================================
--- branches/caiinterface/rts/Sim/Features/FeatureHandler.h	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/rts/Sim/Features/FeatureHandler.h	2008-10-11 12:23:25 UTC (rev 6669)
@@ -79,6 +79,8 @@
 
 	float farDist;
 
+	std::vector&lt;CFeature*&gt; drawFar;
+
 	void DrawFar(CFeature* feature, CVertexArray* va);
 
 	void Serialize(creg::ISerializer *s);

Modified: branches/caiinterface/rts/Sim/Misc/QuadField.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Misc/QuadField.cpp	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/rts/Sim/Misc/QuadField.cpp	2008-10-11 12:23:25 UTC (rev 6669)
@@ -12,6 +12,14 @@
 #include &quot;LogOutput.h&quot;
 #include &quot;creg/STL_List.h&quot;
 
+#ifdef USE_GML
+#include &quot;lib/gml/gmlsrv.h&quot;
+#	if GML_MT_TEST
+#include &lt;boost/thread/recursive_mutex.hpp&gt;
+extern boost::recursive_mutex featmutex;
+boost::recursive_mutex quadmutex;
+#	endif
+#endif
 
 CR_BIND(CQuadField, );
 CR_REG_METADATA(CQuadField, (
@@ -125,6 +133,11 @@
 		if(qi2==newQuads.end())
 			return;
 	}
+
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::recursive_mutex::scoped_lock quadlock(quadmutex); // possible performance hog
+#endif
+
 	std::vector&lt;int&gt;::iterator qi;
 	for (qi = unit-&gt;quads.begin(); qi != unit-&gt;quads.end(); ++qi) {
 		std::list&lt;CUnit*&gt;::iterator ui;
@@ -361,6 +374,9 @@
 
 void CQuadField::RemoveUnit(CUnit* unit)
 {
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::recursive_mutex::scoped_lock quadlock(quadmutex);
+#endif
 	std::vector&lt;int&gt;::iterator qi;
 	for (qi = unit-&gt;quads.begin(); qi != unit-&gt;quads.end(); ++qi) {
 		std::list&lt;CUnit*&gt;::iterator ui;
@@ -381,6 +397,10 @@
 
 void CQuadField::AddFeature(CFeature* feature)
 {
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::recursive_mutex::scoped_lock featlock(featmutex);
+#endif
+
 	vector&lt;int&gt; newQuads=GetQuads(feature-&gt;pos,feature-&gt;radius);
 
 	vector&lt;int&gt;::iterator qi;
@@ -391,6 +411,10 @@
 
 void CQuadField::RemoveFeature(CFeature* feature)
 {
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::recursive_mutex::scoped_lock featlock(featmutex);
+#endif
+
 	vector&lt;int&gt; quads=GetQuads(feature-&gt;pos,feature-&gt;radius);
 
 	std::vector&lt;int&gt;::iterator qi;

Modified: branches/caiinterface/rts/Sim/MoveTypes/GroundMoveType.cpp
===================================================================
--- branches/caiinterface/rts/Sim/MoveTypes/GroundMoveType.cpp	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/rts/Sim/MoveTypes/GroundMoveType.cpp	2008-10-11 12:23:25 UTC (rev 6669)
@@ -1252,7 +1252,7 @@
 float CGroundMoveType::BreakingDistance(float speed)
 {
 	if (!owner-&gt;mobility-&gt;maxBreaking) {
-		logOutput &lt;&lt; &quot;maxBreaking is zero for unit &quot; &lt;&lt; owner-&gt;unitDef-&gt;name.c_str();
+		// logOutput &lt;&lt; &quot;maxBreaking is zero for unit &quot; &lt;&lt; owner-&gt;unitDef-&gt;name.c_str();
 		return 0.0f;
 	}
 	return fabs(speed * speed / owner-&gt;mobility-&gt;maxBreaking);

Modified: branches/caiinterface/rts/Sim/Path/PathEstimator.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Path/PathEstimator.cpp	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/rts/Sim/Path/PathEstimator.cpp	2008-10-11 12:23:25 UTC (rev 6669)
@@ -20,6 +20,12 @@
 #include &quot;FileSystem/ArchiveZip.h&quot;
 #include &quot;Platform/FileSystem.h&quot;
 
+#ifdef USE_GML
+#include &quot;lib/gml/gmlsrv.h&quot;
+#	if GML_MT_TEST
+extern boost::mutex selmutex;
+#	endif
+#endif
 
 #define PATHDEBUG false
 
@@ -912,6 +918,9 @@
 
 void CPathEstimator::Draw(void)
 {
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+					boost::mutex::scoped_lock sellock(selmutex);
+#endif
 	MoveData* md = moveinfo-&gt;GetMoveDataFromName(&quot;TANKSH2&quot;);
 	if (!selectedUnits.selectedUnits.empty() &amp;&amp; (*selectedUnits.selectedUnits.begin())-&gt;unitDef-&gt;movedata)
 		md = (*selectedUnits.selectedUnits.begin())-&gt;unitDef-&gt;movedata;

Modified: branches/caiinterface/rts/Sim/Projectiles/ProjectileHandler.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/ProjectileHandler.cpp	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/rts/Sim/Projectiles/ProjectileHandler.cpp	2008-10-11 12:23:25 UTC (rev 6669)
@@ -40,6 +40,13 @@
 #include &quot;System/creg/STL_List.h&quot;
 #include &quot;System/Exceptions.h&quot;
 
+#ifdef USE_GML
+#	include &quot;lib/gml/gmlsrv.h&quot;
+#	if GML_MT_TEST
+#include &lt;boost/thread/recursive_mutex.hpp&gt;
+boost::recursive_mutex projmutex;
+#	endif
+#endif
 
 CProjectileHandler* ph;
 
@@ -400,6 +407,10 @@
 
 void CProjectileHandler::Update()
 {
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::recursive_mutex::scoped_lock projlock(projmutex);
+#endif
+
 	SCOPED_TIMER(&quot;Projectile handler&quot;);
 
 	Projectile_List::iterator psi = ps.begin();
@@ -482,6 +493,10 @@
 	/* 3DO */
 	unitDrawer-&gt;SetupForUnitDrawing();
 
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::recursive_mutex::scoped_lock projlock(projmutex);
+#endif
+
 	va-&gt;Initialize();
 	va-&gt;EnlargeArrays(flying3doPieces-&gt;size()*4,0,VA_SIZE_TN);
 	numFlyingPieces += flying3doPieces-&gt;size();
@@ -665,6 +680,10 @@
 	glEnable( GL_VERTEX_PROGRAM_ARB );
 	glDisable(GL_TEXTURE_2D);
 
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::recursive_mutex::scoped_lock projlock(projmutex);
+#endif
+
 	for (psi = ps.begin(); psi != ps.end(); ++psi) {
 		if ((gu-&gt;spectatingFullView || loshandler-&gt;InLos(*psi, gu-&gt;myAllyTeam) ||
 			((*psi)-&gt;owner &amp;&amp; gs-&gt;Ally((*psi)-&gt;owner-&gt;allyteam, gu-&gt;myAllyTeam)))) {
@@ -706,6 +725,10 @@
 
 void CProjectileHandler::AddProjectile(CProjectile* p)
 {
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::recursive_mutex::scoped_lock projlock(projmutex);
+#endif
+
 	ps.push_back(p);
 
 	if (p-&gt;synced &amp;&amp; p-&gt;weapon) {
@@ -780,7 +803,9 @@
 					// volume, so smuggle a bit (&quot;rolling back&quot; its pos in Update()
 					// and waiting for the next-frame CheckUnitCol() is problematic
 					// for noExplode projectiles)
-					p-&gt;pos = (raytraced)? q.p0: p-&gt;pos;
+					const float3&amp; pimp = (q.b0)? q.p0: q.p1;
+
+					p-&gt;pos = (raytraced)? pimp: p-&gt;pos;
 					p-&gt;Collision(unit);
 					p-&gt;pos = (raytraced)? ppos: p-&gt;pos;
 					break;
@@ -880,12 +905,20 @@
 	fp-&gt;rotSpeed=gu-&gt;usRandFloat()*0.1f;
 	fp-&gt;rot=0;
 
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::recursive_mutex::scoped_lock projlock(projmutex);
+#endif
+
 	flying3doPieces-&gt;push_back(fp);
 }
 
 void CProjectileHandler::AddFlyingPiece(int textureType, int team, float3 pos, float3 speed, SS3OVertex * verts){
 	FlyingPiece_List * pieceList = NULL;
 
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::recursive_mutex::scoped_lock projlock(projmutex);
+#endif
+
 	while(flyings3oPieces.size()&lt;=textureType)
 		flyings3oPieces.push_back(vector&lt;FlyingPiece_List*&gt;());
 

Modified: branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/WeaponProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/WeaponProjectile.cpp	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/WeaponProjectile.cpp	2008-10-11 12:23:25 UTC (rev 6669)
@@ -120,8 +120,9 @@
 
 void CWeaponProjectile::Collision()
 {
-	if(!weaponDef-&gt;noExplode || gs-&gt;frameNum&amp;1)
-	{
+	if (/* !weaponDef-&gt;noExplode || gs-&gt;frameNum &amp; 1 */ true) {
+		// don't do damage only on odd-numbered frames
+		// for noExplode projectiles (it breaks coldet)
 		float3 impactDir = speed;
 		impactDir.Normalize();
 
@@ -138,10 +139,11 @@
 		if (weaponDef-&gt;impactOnly) {
 			weaponDef-&gt;explosionGenerator-&gt;Explosion(pos,((weaponDef-&gt;dynDamageExp&gt;0)
 					? dynDamages : weaponDef-&gt;damages)[0],weaponDef-&gt;areaOfEffect,owner,0,NULL,impactDir);
-		}
-		else {
-			helper-&gt;Explosion(pos, (weaponDef-&gt;dynDamageExp&gt;0)
-					? dynDamages : weaponDef-&gt;damages,
+		} else {
+			helper-&gt;Explosion(pos,
+				(weaponDef-&gt;dynDamageExp &gt; 0)?
+					dynDamages:
+					weaponDef-&gt;damages,
 				weaponDef-&gt;areaOfEffect, weaponDef-&gt;edgeEffectiveness,
 				weaponDef-&gt;explosionSpeed, owner, true,
 				weaponDef-&gt;noExplode ? 0.3f : 1,
@@ -152,14 +154,13 @@
 
 	if (weaponDef-&gt;soundhit.getID(0) &gt; 0) {
 		sound-&gt;PlaySample(weaponDef-&gt;soundhit.getID(0), this,
-				weaponDef-&gt;soundhit.getVolume(0));
+			weaponDef-&gt;soundhit.getVolume(0));
 	}
 
 	if (!weaponDef-&gt;noExplode){
 		CProjectile::Collision();
 	} else {
-		if (TraveledRange())
-		{
+		if (TraveledRange()) {
 			CProjectile::Collision();
 		}
 	}
@@ -176,19 +177,20 @@
 
 void CWeaponProjectile::Collision(CUnit* unit)
 {
-	if (!weaponDef-&gt;noExplode || gs-&gt;frameNum &amp; 1) {
+	if (/* !weaponDef-&gt;noExplode || gs-&gt;frameNum &amp; 1 */ true) {
+		// don't do damage only on odd-numbered frames
+		// for noExplode projectiles (it breaks coldet)
 		float3 impactDir = speed;
 		impactDir.Normalize();
 
 		// Dynamic Damage
 		DamageArray damages;
-		if (weaponDef-&gt;dynDamageExp &gt; 0)
-		{
+		if (weaponDef-&gt;dynDamageExp &gt; 0) {
 			damages = weaponDefHandler-&gt;DynamicDamages(weaponDef-&gt;damages,
 					startpos, pos,
-					weaponDef-&gt;dynDamageRange&gt;0 ?
-							weaponDef-&gt;dynDamageRange :
-							weaponDef-&gt;range,
+					weaponDef-&gt;dynDamageRange &gt; 0?
+						weaponDef-&gt;dynDamageRange:
+						weaponDef-&gt;range,
 					weaponDef-&gt;dynDamageExp, weaponDef-&gt;dynDamageMin,
 					weaponDef-&gt;dynDamageInverted);
 		} else {

Modified: branches/caiinterface/rts/Sim/Units/Unit.h
===================================================================
--- branches/caiinterface/rts/Sim/Units/Unit.h	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/rts/Sim/Units/Unit.h	2008-10-11 12:23:25 UTC (rev 6669)
@@ -131,11 +131,11 @@
 
 	void CalculateTerrainType();
 	void UpdateTerrainType();
-	
+
 	void UpdateMidPos();
 
 	bool IsNeutral() const {
-		return ((gs-&gt;useLuaGaia &amp;&amp; team == gs-&gt;gaiaTeamID) || (team == MAX_TEAMS - 1) || neutral);
+		return neutral;
 	}
 
 	void SetLosStatus(int allyTeam, unsigned short newStatus);
@@ -323,7 +323,7 @@
 	bool crashing;
 	bool isDead;    // prevent damage from hitting an already dead unit (causing multi wreck etc)
 	bool	falling;  // for units being dropped from transports (parachute drops)
-	float	fallSpeed; 
+	float	fallSpeed;
 
 	bool inAir;
 	bool inWater;

Modified: branches/caiinterface/rts/Sim/Units/UnitHandler.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/UnitHandler.cpp	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/rts/Sim/Units/UnitHandler.cpp	2008-10-11 12:23:25 UTC (rev 6669)
@@ -41,6 +41,14 @@
 using std::min;
 using std::max;
 
+#ifdef USE_GML
+#	include &quot;lib/gml/gmlsrv.h&quot;
+#	if GML_MT_TEST
+#include &lt;boost/thread/recursive_mutex.hpp&gt;
+boost::recursive_mutex unitmutex;
+boost::mutex caimutex;
+#	endif
+#endif
 
 BuildInfo::BuildInfo(const std::string&amp; name, const float3&amp; p, int facing)
 {
@@ -186,6 +194,9 @@
 
 int CUnitHandler::AddUnit(CUnit *unit)
 {
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::recursive_mutex::scoped_lock unitlock(unitmutex);
+#endif
 	ASSERT_SYNCED_MODE;
 	int num = (int)(gs-&gt;randFloat()) * ((int)activeUnits.size() - 1);
 	std::list&lt;CUnit*&gt;::iterator ui = activeUnits.begin();
@@ -264,6 +275,11 @@
 	ASSERT_SYNCED_MODE;
 	SCOPED_TIMER(&quot;Unit handler&quot;);
 
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	{
+		boost::recursive_mutex::scoped_lock unitlock(unitmutex);
+#endif
+
 	while (!toBeRemoved.empty()) {
 		CUnit* delUnit = toBeRemoved.back();
 		toBeRemoved.pop_back();
@@ -271,6 +287,10 @@
 		DeleteUnitNow(delUnit);
 	}
 
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	}
+#endif
+
 	std::list&lt;CUnit*&gt;::iterator usi;
 	for (usi = activeUnits.begin(); usi != activeUnits.end(); usi++) {
 		(*usi)-&gt;Update();
@@ -586,12 +606,18 @@
 
 void CUnitHandler::AddBuilderCAI(CBuilderCAI* b)
 {
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::mutex::scoped_lock cailock(caimutex);
+#endif
 	builderCAIs.insert(builderCAIs.end(),b);
 }
 
 
 void CUnitHandler::RemoveBuilderCAI(CBuilderCAI* b)
 {
+#	if defined(USE_GML) &amp;&amp; GML_MT_TEST
+	boost::mutex::scoped_lock cailock(caimutex);
+#endif
 	ListErase&lt;CBuilderCAI*&gt;(builderCAIs, b);
 }
 

Modified: branches/caiinterface/rts/Sim/Units/UnitTypes/TransportUnit.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/UnitTypes/TransportUnit.cpp	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/rts/Sim/Units/UnitTypes/TransportUnit.cpp	2008-10-11 12:23:25 UTC (rev 6669)
@@ -112,9 +112,10 @@
 			const float gh = ground-&gt;GetHeight2(u-&gt;pos.x, u-&gt;pos.z);
 
 			if (gh &lt; -u-&gt;unitDef-&gt;maxWaterDepth || gh &gt; -u-&gt;unitDef-&gt;minWaterDepth) {
+				// note: should also check movedef restraints?
 				u-&gt;KillUnit(false, false, 0x0, false);
+				continue;
 			}
-			continue;
 		}
 
 

Modified: branches/caiinterface/rts/Sim/Weapons/WeaponDefHandler.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Weapons/WeaponDefHandler.cpp	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/rts/Sim/Weapons/WeaponDefHandler.cpp	2008-10-11 12:23:25 UTC (rev 6669)
@@ -81,7 +81,7 @@
 
 	wd.avoidFriendly = wdTable.GetBool(&quot;avoidFriendly&quot;, true);
 	wd.avoidFeature  = wdTable.GetBool(&quot;avoidFeature&quot;,  true);
-	wd.avoidNeutral  = wdTable.GetBool(&quot;avoidNeutral&quot;,  true);
+	wd.avoidNeutral  = wdTable.GetBool(&quot;avoidNeutral&quot;,  false);
 
 	wd.collisionFlags = 0;
 	const bool collideFriendly = wdTable.GetBool(&quot;collideFriendly&quot;, true);

Modified: branches/caiinterface/rts/System/Platform/ConfigHandler.cpp
===================================================================
--- branches/caiinterface/rts/System/Platform/ConfigHandler.cpp	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/rts/System/Platform/ConfigHandler.cpp	2008-10-11 12:23:25 UTC (rev 6669)
@@ -42,7 +42,10 @@
 	if (!instance) {
 		if (configSource.empty()) {
 #ifdef _WIN32
-			configSource = &quot;Software\\SJ\\Spring &quot; + std::string(VERSION_STRING);
+			configSource = &quot;Software\\SJ\\Spring&quot;;
+			std::string version(VERSION_STRING);
+			if (version.size()&gt;0 &amp;&amp; version[version.size()-1] == '+')
+				configSource += &quot; SVN&quot;;
 #elif defined(__APPLE__)
 			configSource = &quot;this string is not currently used&quot;;
 #else

Modified: branches/caiinterface/rts/System/SpringApp.cpp
===================================================================
--- branches/caiinterface/rts/System/SpringApp.cpp	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/rts/System/SpringApp.cpp	2008-10-11 12:23:25 UTC (rev 6669)
@@ -876,7 +876,7 @@
 			ret = 0;
 		} else {
 #if defined(USE_GML) &amp;&amp; GML_MT_TEST
-			if(frame==gu-&gt;drawFrame) {
+			if(frame==gu-&gt;drawFrame) { // only draw if it was not done in parallel with sim
 #endif
 				gu-&gt;drawFrame++;
 				if (gu-&gt;drawFrame == 0) {

Modified: branches/caiinterface/rts/build/vstudio8/rts.vcproj
===================================================================
--- branches/caiinterface/rts/build/vstudio8/rts.vcproj	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/rts/build/vstudio8/rts.vcproj	2008-10-11 12:23:25 UTC (rev 6669)
@@ -1,7 +1,7 @@
 &lt;?xml version=&quot;1.0&quot; encoding=&quot;Windows-1252&quot;?&gt;
 &lt;VisualStudioProject
 	ProjectType=&quot;Visual C++&quot;
-	Version=&quot;8.00&quot;
+	Version=&quot;8,00&quot;
 	Name=&quot;rts&quot;
 	ProjectGUID=&quot;{A0F70264-A7B7-4FE7-A5BE-298CD3A0758F}&quot;
 	RootNamespace=&quot;rts&quot;
@@ -1515,6 +1515,14 @@
 					&gt;
 				&lt;/File&gt;
 				&lt;File
+					RelativePath=&quot;..\..\Game\Camera\OrbitController.cpp&quot;
+					&gt;
+				&lt;/File&gt;
+				&lt;File
+					RelativePath=&quot;..\..\Game\Camera\OrbitController.h&quot;
+					&gt;
+				&lt;/File&gt;
+				&lt;File
 					RelativePath=&quot;..\..\Game\Camera\OverheadController.cpp&quot;
 					&gt;
 					&lt;FileConfiguration

Modified: branches/caiinterface/rts/lib/gml/gmlsrv.h
===================================================================
--- branches/caiinterface/rts/lib/gml/gmlsrv.h	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/rts/lib/gml/gmlsrv.h	2008-10-11 12:23:25 UTC (rev 6669)
@@ -10,7 +10,7 @@
 #define GMLSRV_H
 
 #ifdef USE_GML
-#define GML_MT_TEST 0
+#define GML_MT_TEST 0 // run Draw() parallel with SimFrame(). Highly experimental, not fully working yet.
 
 #include &lt;boost/thread/barrier.hpp&gt;
 #include &lt;boost/bind.hpp&gt;
@@ -125,7 +125,15 @@
 	gmlCount ClientsReady;
 	BOOL_ newwork;
 
-	gmlClientServer():threadcnt(0),ClientsReady(0),Barrier(GML_CPU_COUNT),ExecDepth(0),newwork(FALSE),inited(FALSE),dorun(TRUE) {
+	BOOL auxinited;
+	R (*auxworker)(void *);
+	void* auxworkerclass;
+	boost::barrier AuxBarrier; 
+	gmlCount AuxClientsReady;
+
+
+	gmlClientServer():threadcnt(0),ClientsReady(0),Barrier(GML_CPU_COUNT),ExecDepth(0),newwork(FALSE),
+				inited(FALSE),dorun(TRUE),auxinited(FALSE),auxworker(NULL),AuxBarrier(2),AuxClientsReady(0) {
 	}
 
 	~gmlClientServer() {
@@ -139,6 +147,13 @@
 				delete threads[i];
 			}
 		}
+		if(auxinited) {
+			auxworker=NULL;
+			dorun=FALSE;
+			AuxBarrier.wait();
+			threads[gmlThreadCount]-&gt;join();
+			delete threads[gmlThreadCount];
+		}
 	}
 
 	void gmlServer() {
@@ -226,6 +241,8 @@
 	void Work(R (*wrk)(void *),R (*wrka)(void *,A), R (*wrkit)(void *,U),void *cls,int mt,BOOL_ sm, GML_TYPENAME std::list&lt;U&gt; *it,int nu,int l1,int l2,BOOL_ sw,void (*swf)(void *)=NULL) {
 		if(!inited)
 			WorkInit();
+		if(auxworker)
+			--mt;
 		if(gmlThreadNumber!=0) {
 			NewWork(wrk,wrka,wrkit,cls,mt,sm,it,nu,l1,l2,sw,swf);
 			return;
@@ -308,54 +325,99 @@
 
 	void GetQueue() {
 		int thread=gmlThreadNumber;
-		int processed=1;
+//		int processed=1;
 
-		GML_TYPENAME gmlExecState&lt;R,A,U&gt; *ex=ExecState+ExecDepth;
+//		GML_TYPENAME gmlExecState&lt;R,A,U&gt; *ex=ExecState+ExecDepth;
 
 		gmlQueue *qd=&amp;gmlQueues[thread];
 
 		BOOL_ isq1=qd-&gt;Write==qd-&gt;Queue1;
 
-#if GML_ALTERNATE_SYNCMODE
+	qd-&gt;GetWrite(TRUE);
+/*#if GML_ALTERNATE_SYNCMODE
 		if(qd-&gt;WasSynced &amp;&amp; qd-&gt;GetWrite(ex-&gt;syncmode?TRUE:2))
 #else
 		if(qd-&gt;WasSynced &amp;&amp; qd-&gt;GetWrite(TRUE))
 #endif
 			processed=0;
 		if(processed &amp;&amp; qd-&gt;GetWrite(TRUE))
-			processed=0;
+			processed=0;*/
 
 		if(isq1) {
-			while(qd-&gt;Locked1)
+			while(!qd-&gt;Locked1 &amp;&amp; *(BYTE * volatile *)&amp;qd-&gt;Pos1!=qd-&gt;Queue1)
 				boost::thread::yield();
 		}
 		else {
-			while(qd-&gt;Locked2)
+			while(!qd-&gt;Locked2 &amp;&amp; *(BYTE * volatile *)&amp;qd-&gt;Pos2!=qd-&gt;Queue2)
 				boost::thread::yield();
 		}
 	}
 
-	void Pump(int thread) {
-		int updsrv=0;
-		gmlUpdateServers();
-		BOOL_ processed=FALSE;
+	BOOL_ PumpAux() {
+		static int updsrvaux=0;
+		if((updsrvaux++%GML_UPDSRV_INTERVAL)==0 || *(volatile int *)&amp;gmlItemsConsumed&gt;=GML_UPDSRV_INTERVAL)
+			gmlUpdateServers();
 
-//		for(int i=1; i&lt;gmlThreadCount; ++i) {
-			gmlQueue *qd=&amp;gmlQueues[thread];
+		while(AuxClientsReady&lt;=3) {
+			gmlQueue *qd=&amp;gmlQueues[gmlThreadCount];
 			if(qd-&gt;Reloc)
 				qd-&gt;Realloc();
 			if(qd-&gt;GetRead()) {
 				qd-&gt;Execute();
 				qd-&gt;ReleaseRead();
-				processed=TRUE;
 			}
 			if(qd-&gt;Sync) {
 				qd-&gt;ExecuteSynced();
-				processed=TRUE;
 			}
-//		}
+			if(AuxClientsReady==0)
+				return FALSE;
+			else
+				++AuxClientsReady;
+		}
+//		auxworker=NULL; // move to auxsub?
+		return TRUE;
 	}
 
+	void AuxWork(R (*wrk)(void *),void *cls) {
+		auxworker=wrk;
+		auxworkerclass=cls;
+		AuxClientsReady%=0;
+		if(!auxinited) {
+			if(!inited)
+				WorkInit();
+			threads[gmlThreadCount]=new boost::thread(boost::bind&lt;void, gmlClientServer, gmlClientServer*&gt;(&amp;gmlClientServer::gmlClientAux, this));
+			auxinited=TRUE;
+		}
+		AuxBarrier.wait();
+	}
+
+
+	void gmlClientAuxSub() {
+		AuxBarrier.wait();
+
+		if(!auxworker)
+			return;
+		
+		gmlQueue *qd=&amp;gmlQueues[gmlThreadCount];
+
+		qd-&gt;GetWrite(TRUE); 
+
+		(*auxworker)(auxworkerclass);
+
+		qd-&gt;ReleaseWrite();
+
+		++AuxClientsReady;	
+		auxworker=NULL; // move to auxsub?
+	}
+
+	void gmlClientAux() {
+		set_threadnum(gmlThreadCount);
+		streflop_init&lt;streflop::Simple&gt;();
+		while(dorun) {
+			gmlClientAuxSub();
+		}
+	}
+
 };
 
 #endif // USE_GML

Modified: branches/caiinterface/tools/springie/Springie/autohost/AutoHost_commands.cs
===================================================================
--- branches/caiinterface/tools/springie/Springie/autohost/AutoHost_commands.cs	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/tools/springie/Springie/autohost/AutoHost_commands.cs	2008-10-11 12:23:25 UTC (rev 6669)
@@ -1161,9 +1161,10 @@
 				return;
 			}
 			if (words.Length &lt; 2) {
-				Respond(e, &quot;This command needs 2-3 parameters - side and password and optional planet name (you can PM it to me)&quot;);
+				Respond(e, &quot;This command needs 2-3 parameters - side and password and optional planet name (you must PM it to me)&quot;);
 				return;
 			}
+			if (e.Place != TasSayEventArgs.Places.Normal) Respond(e, &quot;Please use a private message (double click my name in channel player list), its not secure to talk about passwords here&quot;);
 
 
 			try {

Modified: branches/caiinterface/tools/springie/Springie/spring/Talker.cs
===================================================================
--- branches/caiinterface/tools/springie/Springie/spring/Talker.cs	2008-10-11 12:08:45 UTC (rev 6668)
+++ branches/caiinterface/tools/springie/Springie/spring/Talker.cs	2008-10-11 12:23:25 UTC (rev 6669)
@@ -108,7 +108,7 @@
 		public void SendText(string text)
 		{
 			var bytes = Encoding.ASCII.GetBytes(text);
-			udp.Send(bytes, bytes.Length, &quot;127.0.0.1&quot;, springTalkPort);
+			if (springTalkPort != 0) udp.Send(bytes, bytes.Length, &quot;127.0.0.1&quot;, springTalkPort);
 		}
 
 


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001437.html">[Taspring-linux-commit] r6668 - Lobby Lobby/springie trunk/tools
</A></li>
	<LI>Next message: <A HREF="001439.html">[Taspring-linux-commit] r6670 - in	branches/caiinterface/rts/ExternalAI: . Interface
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1438">[ date ]</a>
              <a href="thread.html#1438">[ thread ]</a>
              <a href="subject.html#1438">[ subject ]</a>
              <a href="author.html#1438">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
