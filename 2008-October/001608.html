<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r6839 - Lobby/TASClient
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-October/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6839%20-%20Lobby/TASClient&In-Reply-To=%3C20081021173953.3D85646EC%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001607.html">
   <LINK REL="Next"  HREF="001609.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r6839 - Lobby/TASClient</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6839%20-%20Lobby/TASClient&In-Reply-To=%3C20081021173953.3D85646EC%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r6839 - Lobby/TASClient">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Tue Oct 21 19:39:52 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001607.html">[Taspring-linux-commit] r6838 - in tags/spring_0.77b5:	AI/Global/KAIK-0.13 installer/builddata/springcontent rts/Lua	rts/Rendering rts/System rts/build/vstudio8
</A></li>
        <LI>Next message: <A HREF="001609.html">[Taspring-linux-commit] r6840 - trunk/rts/Lua
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1608">[ date ]</a>
              <a href="thread.html#1608">[ thread ]</a>
              <a href="subject.html#1608">[ subject ]</a>
              <a href="author.html#1608">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: satirik
Date: 2008-10-21 19:39:49 +0200 (Tue, 21 Oct 2008)
New Revision: 6839

Added:
   Lobby/TASClient/BattleFormUnit.~ddp
Modified:
   Lobby/TASClient/BattleFormUnit.dfm
   Lobby/TASClient/BattleFormUnit.pas
   Lobby/TASClient/HostBattleFormUnit.pas
   Lobby/TASClient/LobbyScriptUnit.pas
   Lobby/TASClient/MainUnit.dfm
   Lobby/TASClient/MainUnit.pas
   Lobby/TASClient/PreferencesFormUnit.pas
   Lobby/TASClient/ReplaysUnit.dfm
   Lobby/TASClient/ReplaysUnit.pas
   Lobby/TASClient/TASClient.dof
   Lobby/TASClient/TASClient.res
   Lobby/TASClient/Utility.pas
Log:
0.39

* diminish MM, ghosted buildings, game speed lock and dgun limit removed
* modoptions startmetal startenergy maxunits and gamemode are now handled separatly
* lobby won't block joining ingame battles
* games are automaticaly locked when started

Modified: Lobby/TASClient/BattleFormUnit.dfm
===================================================================
--- Lobby/TASClient/BattleFormUnit.dfm	2008-10-21 17:35:46 UTC (rev 6838)
+++ Lobby/TASClient/BattleFormUnit.dfm	2008-10-21 17:39:49 UTC (rev 6839)
@@ -1,6 +1,6 @@
 object BattleForm: TBattleForm
-  Left = 581
-  Top = 122
+  Left = 774
+  Top = 240
   Width = 830
   Height = 586
   Caption = 'Battle window'
@@ -4333,122 +4333,87 @@
             Caption = 'Game options'
             ImageIndex = -1
             TabItem = 'GameOptionsTab'
-            object LimitDGunCheckBox: TSpTBXCheckBox
-              Left = 16
-              Top = 152
-              Width = 128
-              Height = 15
-              Hint = 
-                'If checked, commanders will be able to use D-gun only within a c' +
-                'ertain radius from their start position'
-              Caption = 'Limit D-Gun to start pos'
-              ParentShowHint = False
-              ShowHint = True
-              TabOrder = 0
-              OnClick = LimitDGunCheckBoxClick
-            end
-            object GhostedBuildingsCheckBox: TSpTBXCheckBox
-              Left = 16
-              Top = 168
-              Width = 102
-              Height = 15
-              Hint = 
-                'If checked, players will be able to see &quot;ghosted&quot; buildings once' +
-                ' they get out of LOS'
-              Caption = 'Ghosted buildings'
-              ParentShowHint = False
-              ShowHint = True
-              TabOrder = 1
-              OnClick = GhostedBuildingsCheckBoxClick
-              Checked = True
-              State = cbChecked
-            end
-            object DiminishingMMsCheckBox: TSpTBXCheckBox
-              Left = 16
-              Top = 184
-              Width = 166
-              Height = 15
-              Hint = 
-                'If checked, efficiency of metal makers will decrease when the nu' +
-                'mber of them increases'
-              Caption = 'Diminishing metal maker returns'
-              ParentShowHint = False
-              ShowHint = True
-              TabOrder = 2
-              OnClick = DiminishingMMsCheckBoxClick
-            end
-            object LockGameSpeedCheckBox: TSpTBXCheckBox
-              Left = 16
-              Top = 200
-              Width = 103
-              Height = 15
-              Caption = 'Lock game speed'
-              TabOrder = 3
-              OnClick = LockGameSpeedCheckBoxClick
-            end
             object ResourcesGroupBox: TSpTBXGroupBox
               Left = 248
               Top = 8
-              Width = 137
-              Height = 209
+              Width = 161
+              Height = 225
               Caption = 'Resources'
               Color = clNone
               ParentColor = False
-              TabOrder = 5
-              object Label8: TSpTBXLabel
-                Left = 52
-                Top = 189
-                Width = 33
-                Height = 13
+              TabOrder = 1
+              Visible = False
+              object lblMetal: TSpTBXLabel
+                Left = 8
+                Top = 176
+                Width = 41
+                Height = 41
                 Cursor = crHandPoint
-                Caption = 'Energy'
+                Caption = 'Metal'
+                AutoSize = False
                 Font.Charset = DEFAULT_CHARSET
                 Font.Color = clHotLight
                 Font.Height = -11
                 Font.Name = 'MS Sans Serif'
                 Font.Style = [fsUnderline]
                 ParentFont = False
-                OnClick = Label8Click
+                ParentShowHint = False
+                ShowHint = True
+                Visible = False
+                Wrapping = twWrap
+                OnClick = lblMetalClick
+                Alignment = taCenter
                 LinkFont.Charset = DEFAULT_CHARSET
                 LinkFont.Color = clBlue
                 LinkFont.Height = -11
                 LinkFont.Name = 'MS Sans Serif'
                 LinkFont.Style = [fsUnderline]
               end
-              object Label9: TSpTBXLabel
-                Left = 15
-                Top = 189
-                Width = 26
-                Height = 13
+              object lblEnergy: TSpTBXLabel
+                Left = 56
+                Top = 176
+                Width = 57
+                Height = 41
                 Cursor = crHandPoint
-                Caption = 'Metal'
+                Caption = 'Energy'
+                AutoSize = False
                 Font.Charset = DEFAULT_CHARSET
                 Font.Color = clHotLight
                 Font.Height = -11
                 Font.Name = 'MS Sans Serif'
                 Font.Style = [fsUnderline]
                 ParentFont = False
-                OnClick = Label9Click
+                ParentShowHint = False
+                ShowHint = True
+                Visible = False
+                Wrapping = twWrap
+                OnClick = lblEnergyClick
+                Alignment = taCenter
                 LinkFont.Charset = DEFAULT_CHARSET
                 LinkFont.Color = clBlue
                 LinkFont.Height = -11
                 LinkFont.Name = 'MS Sans Serif'
                 LinkFont.Style = [fsUnderline]
               end
-              object Label10: TSpTBXLabel
-                Left = 96
-                Top = 189
-                Width = 24
-                Height = 13
+              object lblUnits: TSpTBXLabel
+                Left = 112
+                Top = 176
+                Width = 46
+                Height = 41
                 Cursor = crHandPoint
                 Caption = 'Units'
+                AutoSize = False
                 Font.Charset = DEFAULT_CHARSET
                 Font.Color = clHotLight
                 Font.Height = -11
                 Font.Name = 'MS Sans Serif'
                 Font.Style = [fsUnderline]
                 ParentFont = False
-                OnClick = Label10Click
+                ParentShowHint = False
+                ShowHint = True
+                Visible = False
+                OnClick = lblUnitsClick
+                Alignment = taCenter
                 LinkFont.Charset = DEFAULT_CHARSET
                 LinkFont.Color = clBlue
                 LinkFont.Height = -11
@@ -4482,7 +4447,7 @@
                 OnMouseUpAfterChange = MetalTrackerMouseUpAfterChange
               end
               object EnergyTracker: TSpTBXjanTracker
-                Left = 50
+                Left = 66
                 Top = 16
                 Width = 39
                 Height = 171
@@ -4508,7 +4473,7 @@
                 OnMouseUpAfterChange = EnergyTrackerMouseUpAfterChange
               end
               object UnitsTracker: TSpTBXjanTracker
-                Left = 90
+                Left = 114
                 Top = 16
                 Width = 39
                 Height = 171
@@ -4539,22 +4504,14 @@
               Top = 80
               Width = 225
               Height = 65
-              Hint = 
-                'Lineage mode = Every units or building you made will explode if ' +
-                'your commander dies (You can'#39't share your units just before your' +
-                ' commander dies)'
               Caption = 'Game end condition'
               Color = clNone
               ParentColor = False
               ParentShowHint = False
               ShowHint = True
-              TabOrder = 6
+              TabOrder = 2
+              Visible = False
               OnClick = GameEndRadioGroupClick
-              ItemIndex = 0
-              Items.Strings = (
-                'Game continues if commander dies'
-                'Game ends if commander dies'
-                'Lineage mode')
             end
             object StartPosRadioGroup: TSpTBXRadioGroup
               Left = 16
@@ -4564,7 +4521,7 @@
               Caption = 'Start position'
               Color = clNone
               ParentColor = False
-              TabOrder = 7
+              TabOrder = 3
               OnClick = StartPosRadioGroupClick
               ItemIndex = 2
               Items.Strings = (
@@ -4578,7 +4535,7 @@
               Width = 81
               Height = 25
               Caption = 'Load default'
-              TabOrder = 4
+              TabOrder = 0
               OnClick = LoadDefaultButtonClick
               LinkFont.Charset = DEFAULT_CHARSET
               LinkFont.Color = clBlue
@@ -4592,7 +4549,7 @@
               Width = 81
               Height = 25
               Caption = 'Set as default'
-              TabOrder = 8
+              TabOrder = 4
               OnClick = SetDefaultButtonClick
               LinkFont.Charset = DEFAULT_CHARSET
               LinkFont.Color = clBlue

Modified: Lobby/TASClient/BattleFormUnit.pas
===================================================================
--- Lobby/TASClient/BattleFormUnit.pas	2008-10-21 17:35:46 UTC (rev 6838)
+++ Lobby/TASClient/BattleFormUnit.pas	2008-10-21 17:39:49 UTC (rev 6839)
@@ -252,14 +252,10 @@
     UnitsGroupBox: TSpTBXGroupBox;
     AddUnitsSpeedButton: TSpeedButton;
     SpTBXTabSheet2: TSpTBXTabSheet;
-    LimitDGunCheckBox: TSpTBXCheckBox;
-    GhostedBuildingsCheckBox: TSpTBXCheckBox;
-    DiminishingMMsCheckBox: TSpTBXCheckBox;
-    LockGameSpeedCheckBox: TSpTBXCheckBox;
     ResourcesGroupBox: TSpTBXGroupBox;
-    Label8: TSpTBXLabel;
-    Label9: TSpTBXLabel;
-    Label10: TSpTBXLabel;
+    lblEnergy: TSpTBXLabel;
+    lblMetal: TSpTBXLabel;
+    lblUnits: TSpTBXLabel;
     MetalTracker: TSpTBXjanTracker;
     EnergyTracker: TSpTBXjanTracker;
     UnitsTracker: TSpTBXjanTracker;
@@ -402,11 +398,8 @@
       Y: Integer);
     procedure MapImageMouseUp(Sender: TObject; Button: TMouseButton;
       Shift: TShiftState; X, Y: Integer);
-    procedure LimitDGunCheckBoxClick(Sender: TObject);
-    procedure DiminishingMMsCheckBoxClick(Sender: TObject);
     procedure LockedCheckBoxClick(Sender: TObject);
     procedure FormShow(Sender: TObject);
-    procedure GhostedBuildingsCheckBoxClick(Sender: TObject);
     procedure SetDefaultButtonClick(Sender: TObject);
     procedure LoadDefaultButtonClick(Sender: TObject);
     procedure TBXTeamColorSetGetColorInfo(Sender: TTBXCustomColorSet; Col,
@@ -491,9 +484,9 @@
     procedure VDTBattleClientsHeaderClick(Sender: TVTHeader;
       Column: TColumnIndex; Button: TMouseButton; Shift: TShiftState; X,
       Y: Integer);
-    procedure Label9Click(Sender: TObject);
-    procedure Label8Click(Sender: TObject);
-    procedure Label10Click(Sender: TObject);
+    procedure lblMetalClick(Sender: TObject);
+    procedure lblEnergyClick(Sender: TObject);
+    procedure lblUnitsClick(Sender: TObject);
 
     procedure DisplayLuaOptions(luaOptionList: TList; tabSheet: TWinControl);
     function GetLuaOption(optList: TList;key: string): TLuaOption;
@@ -502,7 +495,6 @@
     procedure FormResize(Sender: TObject);
     procedure SpTBXTabControl1ActiveTabChange(Sender: TObject;
       TabIndex: Integer);
-    procedure LockGameSpeedCheckBoxClick(Sender: TObject);
     procedure mnuNewGroupClick(Sender: TObject);
     procedure mnuRemoveFromGroupClick(Sender: TObject);
     procedure btLoadModsDefaultMDOClick(Sender: TObject);
@@ -745,10 +737,6 @@
       GameEndRadioGroup.Enabled := not Status;
       if Status then DisableControlAndChildren(ResourcesGroupBox) else EnableControlAndChildren(ResourcesGroupBox);
       if Status then DisableControlAndChildren(UnitsGroupBox) else EnableControlAndChildren(UnitsGroupBox);
-      LimitDGunCheckBox.Enabled := not Status;
-      DiminishingMMsCheckBox.Enabled := not Status;
-      GhostedBuildingsCheckBox.Enabled := not Status;
-      LockGameSpeedCheckBox.Enabled := not Status;
 
       if BattleState.LadderIndex &gt;= 0 then begin
         LoadDefaultButton.Enabled := False;
@@ -759,13 +747,9 @@
         with TLadder(LadderList[BattleState.LadderIndex]) do begin
           StartPosRadioGroup.Enabled := StartPosRadioGroup.Enabled and (StartPos = 255);
           GameEndRadioGroup.Enabled := GameEndRadioGroup.Enabled and (GameMode = 255);
-          LimitDGunCheckBox.Enabled := LimitDGunCheckBox.Enabled and (DGun = 255);
-          GhostedBuildingsCheckBox.Enabled := GhostedBuildingsCheckBox.Enabled and (Ghost = 255);
-          DiminishingMMsCheckBox.Enabled := DiminishingMMsCheckBox.Enabled and (Diminish = 255);
           MetalTracker.Enabled := MetalTracker.Enabled and ((MetalMin = -1) or (MetalMin &lt;&gt; MetalMax));
           EnergyTracker.Enabled := EnergyTracker.Enabled and ((EnergyMin = -1) or (EnergyMin &lt;&gt; EnergyMax));
           UnitsTracker.Enabled := UnitsTracker.Enabled and ((UnitsMin = -1) or (UnitsMin &lt;&gt; UnitsMax));
-          LockGameSpeedCheckBox.Enabled := False;
           AddUnitsSpeedButton.Enabled := False;
         end;
       end;
@@ -888,12 +872,24 @@
 end;
 
 procedure TBattleForm.SendBattleDetailsToServer; // call it each time you update some of the battle's inside parameters
+var
+  s: string;
 begin
   if not (BattleState.Status = Hosting) then Exit; // this should not happen though
 
   if not AllowBattleDetailsUpdate then Exit;
 
-  MainForm.TryToSendCommand('SETSCRIPTTAGS', 'GAME/StartPosType='+IntToStr(StartPosRadioGroup.ItemIndex)+#9+'GAME/GameMode='+IntToStr(GameEndRadioGroup.ItemIndex)+#9+'GAME/LimitDGun='+BoolToStr(LimitDGunCheckBox.Checked)+#9+'GAME/GhostedBuildings='+BoolToStr(GhostedBuildingsCheckBox.Checked)+#9+'GAME/DiminishingMMs='+BoolToStr(DiminishingMMsCheckBox.Checked)+#9+'GAME/StartMetal='+IntToStr(MetalTracker.Value)+#9+'GAME/StartEnergy='+IntToStr(EnergyTracker.Value)+#9+'GAME/MaxUnits='+IntToStr(UnitsTracker.Value)+#9+'GAME/IsGameSpeedLocked='+IntToStr(BoolToInt(LockGameSpeedCheckBox.Checked)));
+  s := 'GAME/StartPosType='+IntToStr(StartPosRadioGroup.ItemIndex);
+  if GameEndRadioGroup.Visible then
+    s := s + #9+'GAME/modoptions/GameMode='+IntToStr(GameEndRadioGroup.ItemIndex);
+  if MetalTracker.Visible then
+    s := s + #9+'GAME/modoptions/StartMetal='+IntToStr(MetalTracker.Value);
+  if EnergyTracker.Visible then
+    s := s + #9+'GAME/modoptions/StartEnergy='+IntToStr(EnergyTracker.Value);
+  if UnitsTracker.Visible then
+    s := s + #9+'GAME/modoptions/MaxUnits='+IntToStr(UnitsTracker.Value);
+
+  MainForm.TryToSendCommand('SETSCRIPTTAGS', s);
 end;
 
 procedure TBattleForm.SendBattleInfoToServer; // call it each time you update some of the battle's outside parameters
@@ -1344,6 +1340,8 @@
     MainForm.TryToSendCommand('MYSTATUS', '1');
     GameTimer.Enabled := True;
     BattleState.Battle.RefreshRanksNCupsOnSuccessReport := True;
+    if not BattleState.Battle.Locked then
+      LockedCheckBoxClick(nil);  
   end
   else
   begin
@@ -1383,10 +1381,6 @@
   EnableControlAndChildren(MyOptionsGroupBox);
   ReadyButton.Enabled := True;
   AddUnitsSpeedButton.Enabled := False;
-  LimitDGunCheckBox.Enabled := False;
-  DiminishingMMsCheckBox.Enabled := False;
-  GhostedBuildingsCheckBox.Enabled := False;
-  LockGameSpeedCheckBox.Enabled := False;
   LockedCheckBox.Enabled := False;
   AdminButton.Enabled := False;
   LockedCheckBox.Checked := Battle.Locked;
@@ -1501,10 +1495,6 @@
   DisableControlAndChildren(MyOptionsGroupBox);
   ReadyButton.Enabled := True;
   AddUnitsSpeedButton.Enabled := False;
-  LimitDGunCheckBox.Enabled := False;
-  DiminishingMMsCheckBox.Enabled := False;
-  GhostedBuildingsCheckBox.Enabled := False;
-  LockGameSpeedCheckBox.Enabled := False;
   LockedCheckBox.Enabled := False;
   AdminButton.Enabled := False;
   LockedCheckBox.Checked := Battle.Locked;
@@ -1621,10 +1611,6 @@
   EnableControlAndChildren(MyOptionsGroupBox);
   ReadyButton.Enabled := True;
   AddUnitsSpeedButton.Enabled := True;
-  LimitDGunCheckBox.Enabled := True;
-  DiminishingMMsCheckBox.Enabled := True;
-  GhostedBuildingsCheckBox.Enabled := True;
-  LockGameSpeedCheckBox.Enabled := True;
   LockedCheckBox.Enabled := True;
   AdminButton.Enabled := True;
   LockedCheckBox.Checked := False;
@@ -1673,6 +1659,8 @@
   end;
   MapTab.Caption := 'Map options ('+IntToStr(BattleForm.MapOptionsList.Count)+')';
 
+  LoadDefaultButtonClick(nil);
+
   AddTextToChat('Battle opened', Colors.Info, 1);
 
   TipsForm.ShowTips(1);
@@ -1712,10 +1700,6 @@
   DisableControlAndChildren(MyOptionsGroupBox);
   ReadyButton.Enabled := True;
   AddUnitsSpeedButton.Enabled := False;
-  LimitDGunCheckBox.Enabled := False;
-  DiminishingMMsCheckBox.Enabled := False;
-  GhostedBuildingsCheckBox.Enabled := False;
-  LockGameSpeedCheckBox.Enabled := True;
   LockedCheckBox.Enabled := True;
   AdminButton.Enabled := True;
   LockedCheckBox.Checked := False;
@@ -1820,10 +1804,6 @@
   DisableControlAndChildren(MyOptionsGroupBox);
   ReadyButton.Enabled := False;
   AddUnitsSpeedButton.Enabled := False;
-  LimitDGunCheckBox.Enabled := False;
-  DiminishingMMsCheckBox.Enabled := False;
-  GhostedBuildingsCheckBox.Enabled := False;
-  LockGameSpeedCheckBox.Enabled := False;
   LockedCheckBox.Enabled := False;
   AdminButton.Enabled := False;
   LoadDefaultButton.Enabled := False;
@@ -2025,9 +2005,6 @@
     UnitsTracker.Value := units;
     StartPosRadioGroup.ItemIndex := startpos;
     GameEndRadioGroup.ItemIndex := gamemode;
-    LimitDGunCheckBox.Checked := limitdgun;
-    DiminishingMMsCheckBox.Checked := limitdgun;
-    GhostedBuildingsCheckBox.Checked := ghostedbuildings;
     {--&gt;} AllowBattleDetailsUpdate := True;
 
   except
@@ -2150,16 +2127,17 @@
 
   Script.AddOrChangeKeyValue('GAME/Mapname',BattleState.Battle.Map);
   Script.AddOrChangeKeyValue('GAME/Maphash',Utility.MapChecksums[Utility.MapList.indexOf(BattleState.Battle.Map)]);
-  Script.AddOrChangeKeyValue('GAME/StartMetal',IntToStr(MetalTracker.Value));
-  Script.AddOrChangeKeyValue('GAME/StartEnergy',IntToStr(EnergyTracker.Value));
-  Script.AddOrChangeKeyValue('GAME/MaxUnits',IntToStr(UnitsTracker.Value));
+  if MetalTracker.Visible then
+    Script.AddOrChangeKeyValue('GAME/modoptions/StartMetal',IntToStr(MetalTracker.Value));
+  if EnergyTracker.Visible then
+    Script.AddOrChangeKeyValue('GAME/modoptions/StartEnergy',IntToStr(EnergyTracker.Value));
+  if UnitsTracker.Visible then
+    Script.AddOrChangeKeyValue('GAME/modoptions/MaxUnits',IntToStr(UnitsTracker.Value));
   Script.AddOrChangeKeyValue('GAME/StartPosType',IntToStr(StartPosRadioGroup.ItemIndex));
-  Script.AddOrChangeKeyValue('GAME/GameMode',IntToStr(GameEndRadioGroup.ItemIndex));
+  if GameEndRadioGroup.Visible then
+    Script.AddOrChangeKeyValue('GAME/modoptions/GameMode',IntToStr(GameEndRadioGroup.ItemIndex));
   Script.AddOrChangeKeyValue('GAME/GameType',ModFileName);
   Script.AddOrChangeKeyValue('GAME/ModHash',IntToStr(GetModHash(BattleState.Battle.ModName)));
-  Script.AddOrChangeKeyValue('GAME/LimitDGun',IntToStr(BoolToInt(LimitDGunCheckBox.Checked)));
-  Script.AddOrChangeKeyValue('GAME/DiminishingMMs',IntToStr(BoolToInt(DiminishingMMsCheckBox.Checked)));
-  Script.AddOrChangeKeyValue('GAME/GhostedBuildings',IntToStr(BoolToInt(GhostedBuildingsCheckBox.Checked)));
 
   if BattleState.Status = Hosting then
   begin
@@ -2168,10 +2146,6 @@
       Script.AddOrChangeKeyValue('GAME/HostPort',IntToStr(NATTraversal.MyPrivateUDPSourcePort))
     else
       Script.AddOrChangeKeyValue('GAME/HostPort',IntToStr(BattleState.Battle.Port));
-    if LockGameSpeedCheckBox.Checked then
-    begin
-      Script.AddOrChangeKeyValue('GAME/MinSpeed','1');
-    end;
   end
   else
   begin
@@ -2274,11 +2248,13 @@
   
   // mod options:
   for i:=0 to ModOptionsList.Count -1 do
-    Script.AddOrChangeKeyValue(TLuaOption(ModOptionsList[i]).KeyPrefix + TLuaOption(ModOptionsList[i]).Key,TLuaOption(ModOptionsList[i]).toString);
+    if TLuaOption(ModOptionsList[i]).ClassType &lt;&gt; TLuaOptionSection then
+      Script.AddOrChangeKeyValue(TLuaOption(ModOptionsList[i]).KeyPrefix + TLuaOption(ModOptionsList[i]).Key,TLuaOption(ModOptionsList[i]).toString);
 
   // map options:
   for i:=0 to MapOptionsList.Count -1 do
-    Script.AddOrChangeKeyValue(TLuaOption(MapOptionsList[i]).KeyPrefix + TLuaOption(MapOptionsList[i]).Key,TLuaOption(MapOptionsList[i]).toString);
+    if TLuaOption(ModOptionsList[i]).ClassType &lt;&gt; TLuaOptionSection then
+      Script.AddOrChangeKeyValue(TLuaOption(MapOptionsList[i]).KeyPrefix + TLuaOption(MapOptionsList[i]).Key,TLuaOption(MapOptionsList[i]).toString);
 
   // unknown setscripttags
   for i:=0 to UnknownScriptTagList.CompleteKeyList.Count -1 do
@@ -2338,18 +2314,6 @@
       Script.ChangeHostPort(IntToStr(NATTraversal.MyPrivateUDPSourcePort))
     else
       Script.ChangeHostPort(IntToStr(BattleState.Battle.Port));
-
-    if LockGameSpeedCheckBox.Checked then
-    begin
-      Script.AddOrChangeKeyValue('GAME/MinSpeed','1');
-      Script.AddOrChangeKeyValue('GAME/MaxSpeed','1');
-    end
-    else
-    begin
-      Script.RemoveKey('GAME/MinSpeed');
-      Script.RemoveKey('GAME/MaxSpeed');
-    end;
-
   end
   else
   begin
@@ -3080,7 +3044,9 @@
 
   if not AllowBattleDetailsUpdate then Exit;
 
-  MainForm.TryToSendCommand('SETSCRIPTTAGS', 'GAME/StartMetal='+IntToStr(MetalTracker.Value));
+  if not MetalTracker.Visible then Exit;
+
+  MainForm.TryToSendCommand('SETSCRIPTTAGS', 'GAME/modoptions/StartMetal='+IntToStr(MetalTracker.Value));
 end;
 
 procedure TBattleForm.EnergyTrackerMouseUpAfterChange(Sender: TObject);
@@ -3089,7 +3055,9 @@
 
   if not AllowBattleDetailsUpdate then Exit;
 
-  MainForm.TryToSendCommand('SETSCRIPTTAGS', 'GAME/StartEnergy='+IntToStr(EnergyTracker.Value));
+  if not EnergyTracker.Visible then Exit;
+
+  MainForm.TryToSendCommand('SETSCRIPTTAGS', 'GAME/modoptions/StartEnergy='+IntToStr(EnergyTracker.Value));
 end;
 
 procedure TBattleForm.UnitsTrackerMouseUpAfterChange(Sender: TObject);
@@ -3098,9 +3066,11 @@
 
   if not AllowBattleDetailsUpdate then Exit;
 
+  if not UnitsTracker.Visible then Exit;
+
   if UnitsTracker.Value &lt; 10 then UnitsTracker.Value := 10;
 
-  MainForm.TryToSendCommand('SETSCRIPTTAGS', 'GAME/MaxUnits='+IntToStr(UnitsTracker.Value));
+  MainForm.TryToSendCommand('SETSCRIPTTAGS', 'GAME/modoptions/MaxUnits='+IntToStr(UnitsTracker.Value));
 end;
 
 procedure TBattleForm.StartPosRadioGroupClick(Sender: TObject);
@@ -3349,7 +3319,9 @@
 
   if not AllowBattleDetailsUpdate then Exit;
 
-  MainForm.TryToSendCommand('SETSCRIPTTAGS', 'GAME/GameMode='+IntToStr(GameEndRadioGroup.ItemIndex));
+  if not GameEndRadioGroup.Visible then Exit;
+
+  MainForm.TryToSendCommand('SETSCRIPTTAGS', 'GAME/modoptions/GameMode='+IntToStr(GameEndRadioGroup.ItemIndex));
 end;
 
 { if UpdateServer=True, then we notify server about new team color }
@@ -3479,24 +3451,6 @@
   Misc.OpenURLInDefaultBrowser(URL);
 end;
 
-procedure TBattleForm.LimitDGunCheckBoxClick(Sender: TObject);
-begin
-  if not (BattleState.Status = Hosting) then Exit; // this should not happen though
-
-  if not AllowBattleDetailsUpdate then Exit;
-
-  MainForm.TryToSendCommand('SETSCRIPTTAGS', 'GAME/LimitDGun='+IntToStr(BoolToInt(LimitDGunCheckBox.Checked)));
-end;
-
-procedure TBattleForm.DiminishingMMsCheckBoxClick(Sender: TObject);
-begin
-  if not (BattleState.Status = Hosting) then Exit; // this should not happen though
-
-  if not AllowBattleDetailsUpdate then Exit;
-
-  MainForm.TryToSendCommand('SETSCRIPTTAGS', 'GAME/DiminishingMMs='+IntToStr(BoolToInt(DiminishingMMsCheckBox.Checked)));
-end;
-
 procedure TBattleForm.LockedCheckBoxClick(Sender: TObject);
 begin
   if LockedCheckBox.Checked then
@@ -3521,15 +3475,6 @@
   MapPanelResize(nil);
 end;
 
-procedure TBattleForm.GhostedBuildingsCheckBoxClick(Sender: TObject);
-begin
-  if not (BattleState.Status = Hosting) then Exit; // this should not happen though
-
-  if not AllowBattleDetailsUpdate then Exit;
-
-  MainForm.TryToSendCommand('SETSCRIPTTAGS', 'GAME/GhostedBuildings='+IntToStr(BoolToInt(GhostedBuildingsCheckBox.Checked)));
-end;
-
 procedure TBattleForm.SetDefaultButtonClick(Sender: TObject);
 begin
   if MessageDlg('Do you wish to save current battle settings as default?', mtConfirmation, [mbYes, mbNo], 0) = mrNo then Exit;
@@ -5813,21 +5758,21 @@
   VDTBattleClients.Refresh;
 end;
 
-procedure TBattleForm.Label9Click(Sender: TObject);
+procedure TBattleForm.lblMetalClick(Sender: TObject);
 begin
-  MetalTracker.Value := Misc.InputBoxInteger('Custom value','Metal value :',MetalTracker.Value,0,10000);
+  MetalTracker.Value := Misc.InputBoxInteger('Custom value','Enter value :',MetalTracker.Value,MetalTracker.Minimum,MetalTracker.Maximum);
   MetalTrackerMouseUpAfterChange(nil);
 end;
 
-procedure TBattleForm.Label8Click(Sender: TObject);
+procedure TBattleForm.lblEnergyClick(Sender: TObject);
 begin
-  EnergyTracker.Value := Misc.InputBoxInteger('Custom value','Energy value :',EnergyTracker.Value,0,10000);
+  EnergyTracker.Value := Misc.InputBoxInteger('Custom value','Enter value :',EnergyTracker.Value,EnergyTracker.Minimum,EnergyTracker.Maximum);
   EnergyTrackerMouseUpAfterChange(nil);
 end;
 
-procedure TBattleForm.Label10Click(Sender: TObject);
+procedure TBattleForm.lblUnitsClick(Sender: TObject);
 begin
-  UnitsTracker.Value := Misc.InputBoxInteger('Custom value','Max units :',UnitsTracker.Value,10,5000);
+  UnitsTracker.Value := Misc.InputBoxInteger('Custom value','Enter units :',UnitsTracker.Value,UnitsTracker.Minimum,UnitsTracker.Maximum);
   UnitsTrackerMouseUpAfterChange(nil);
 end;
 
@@ -5853,6 +5798,10 @@
     else
       TLuaOption(luaOptionList[i]).Enable;
   end;
+  // hide empty sections
+  for i:=0 to luaOptionList.Count-1 do
+    if TLuaOption(luaOptionList[i]).ClassType = TLuaOptionSection then
+      TLuaOptionSection(luaOptionList[i]).Panel.Visible := TLuaOptionSection(luaOptionList[i]).Panel.ControlCount &gt; 0;
 end;
 
 procedure TLuaOption.MakeDescriptionButton(AOwner: TWinControl);
@@ -6396,10 +6345,12 @@
   if not AllowBattleDetailsUpdate then Exit;
 
   for i:=0 to ModOptionsList.Count -1 do
-    TLuaOption(ModOptionsList[i]).OnChange(nil);
+    if TLuaOption(ModOptionsList[i]).ClassType &lt;&gt; TLuaOptionSection then
+      TLuaOption(ModOptionsList[i]).OnChange(nil);
 
   for i:=0 to MapOptionsList.Count -1 do
-    TLuaOption(MapOptionsList[i]).OnChange(nil);
+    if TLuaOption(ModOptionsList[i]).ClassType &lt;&gt; TLuaOptionSection then
+      TLuaOption(MapOptionsList[i]).OnChange(nil);
 end;
 
 procedure TBattleForm.FormResize(Sender: TObject);
@@ -6413,15 +6364,6 @@
   SpTBXTabControl1.ActivePage.Item.FontSettings.Bold := tsFalse;
 end;
 
-procedure TBattleForm.LockGameSpeedCheckBoxClick(Sender: TObject);
-begin
-  if not (BattleState.Status = Hosting) then Exit; // this should not happen though
-
-  if not AllowBattleDetailsUpdate then Exit;
-
-  MainForm.TryToSendCommand('SETSCRIPTTAGS', 'GAME/IsGameSpeedLocked='+IntToStr(BoolToInt(LockGameSpeedCheckBox.Checked)));
-end;
-
 procedure TBattleForm.mnuNewGroupClick(Sender: TObject);
 begin
   MainForm.mnuNewGroupClick(nil);

Added: Lobby/TASClient/BattleFormUnit.~ddp
===================================================================
(Binary files differ)


Property changes on: Lobby/TASClient/BattleFormUnit.~ddp
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: Lobby/TASClient/HostBattleFormUnit.pas
===================================================================
--- Lobby/TASClient/HostBattleFormUnit.pas	2008-10-21 17:35:46 UTC (rev 6838)
+++ Lobby/TASClient/HostBattleFormUnit.pas	2008-10-21 17:39:49 UTC (rev 6839)
@@ -209,18 +209,11 @@
     UnitsTracker.Maximum := 5000;
     if ladderIndex &gt;= 0 then
     begin
-      LockGameSpeedCheckBox.Checked := True;
       with TLadder(LadderList[LadderComboBox.ItemIndex]) do begin
         if StartPos &lt;&gt; 255 then
           StartPosRadioGroup.ItemIndex := StartPos;
         if GameMode &lt;&gt; 255 then
           GameEndRadioGroup.ItemIndex := GameMode;
-        if DGun &lt;&gt; 255 then
-          LimitDGunCheckBox.Checked := DGun = 1;
-        if Ghost &lt;&gt; 255 then
-          GhostedBuildingsCheckBox.Checked := Ghost = 1;
-        if Diminish &lt;&gt; 255 then
-          DiminishingMMsCheckBox.Checked := Diminish = 1;
         if MetalMin &lt;&gt; -1 then
           if MetalMin = MetalMax then
             MetalTracker.Value := MetalMin

Modified: Lobby/TASClient/LobbyScriptUnit.pas
===================================================================
--- Lobby/TASClient/LobbyScriptUnit.pas	2008-10-21 17:35:46 UTC (rev 6838)
+++ Lobby/TASClient/LobbyScriptUnit.pas	2008-10-21 17:39:49 UTC (rev 6839)
@@ -539,10 +539,6 @@
     PyDict_SetItemStringDecRef(pyCurrentBattle,'StartMetal',BattleForm.MetalTracker.Value);
     PyDict_SetItemStringDecRef(pyCurrentBattle,'StartEnergy',BattleForm.EnergyTracker.Value);
     PyDict_SetItemStringDecRef(pyCurrentBattle,'MaxUnits',BattleForm.UnitsTracker.Value);
-    PyDict_SetItemStringDecRef(pyCurrentBattle,'LimitDGun',BattleForm.LimitDGunCheckBox.Checked);
-    PyDict_SetItemStringDecRef(pyCurrentBattle,'GhostedBuildings',BattleForm.GhostedBuildingsCheckBox.Checked);
-    PyDict_SetItemStringDecRef(pyCurrentBattle,'DiminishingMMs',BattleForm.DiminishingMMsCheckBox.Checked);
-    PyDict_SetItemStringDecRef(pyCurrentBattle,'LockGameSpeed',BattleForm.LockGameSpeedCheckBox.Checked);
 
     pyO := StringsToPyList(BattleState.DisabledUnits);
     PyDict_SetItemString(pyCurrentBattle,'DisabledUnits',pyO);

Modified: Lobby/TASClient/MainUnit.dfm
===================================================================
--- Lobby/TASClient/MainUnit.dfm	2008-10-21 17:35:46 UTC (rev 6838)
+++ Lobby/TASClient/MainUnit.dfm	2008-10-21 17:39:49 UTC (rev 6839)
@@ -1,6 +1,6 @@
 object MainForm: TMainForm
-  Left = 359
-  Top = 88
+  Left = 483
+  Top = 108
   Width = 773
   Height = 535
   Caption = '.'

Modified: Lobby/TASClient/MainUnit.pas
===================================================================
--- Lobby/TASClient/MainUnit.pas	2008-10-21 17:35:46 UTC (rev 6838)
+++ Lobby/TASClient/MainUnit.pas	2008-10-21 17:39:49 UTC (rev 6839)
@@ -522,7 +522,7 @@
   );
 
 const
-  VERSION_NUMBER = '0.38'; // Must be float value! (with a period as a decimal seperator)
+  VERSION_NUMBER = '0.39'; // Must be float value! (with a period as a decimal seperator)
   CHECK_BETA_LOBBY_URL = '<A HREF="http://tasclient.no-ip.org/TASClient_update_v2.txt">http://tasclient.no-ip.org/TASClient_update_v2.txt</A>';
   PROGRAM_VERSION = 'TASClient ' + VERSION_NUMBER;
   KEEP_ALIVE_INTERVAL = 10000; // in milliseconds. Tells us what should be the maximum &quot;silence&quot; time before we send a ping to the server.
@@ -6149,9 +6149,9 @@
       BattleForm.UnitsTracker.Value := k;
       BattleForm.StartPosRadioGroup.ItemIndex := l;
       BattleForm.GameEndRadioGroup.ItemIndex := m;
-      BattleForm.LimitDGunCheckBox.Checked := IntToBool(o);
-      BattleForm.DiminishingMMsCheckBox.Checked := IntToBool(p);
-      BattleForm.GhostedBuildingsCheckBox.Checked := IntToBool(r);
+      //BattleForm.LimitDGunCheckBox.Checked := IntToBool(o);
+      //BattleForm.DiminishingMMsCheckBox.Checked := IntToBool(p);
+      //BattleForm.GhostedBuildingsCheckBox.Checked := IntToBool(r);
       AllowBattleDetailsUpdate := True;
     end
     else if sl[0] = 'REMOVESCRIPTTAGS' then
@@ -6194,60 +6194,58 @@
 
         Misc.ParseDelimited(sl3,tmp,'/','\');
         AllowBattleDetailsUpdate := False;
-        if (sl3.Count = 3) and (sl3[0] = 'game') and ((sl3[1] = 'mapoptions') or (sl3[1] = 'modoptions')) then
-        begin
-          if sl3[1] = 'mapoptions' then
-          begin
-            luaOpt := BattleForm.GetLuaOption(BattleForm.MapOptionsList,sl3[2]);
-            if (BattleForm.SpTBXTabControl1.ActivePage.Item.Name &lt;&gt; 'MapTab') and (BattleState.Status &lt;&gt; Hosting) then
-            begin
-              BattleForm.MapTab.FontSettings.Bold := tsTrue;
-            end;
-          end
-          else
-          begin
-            luaOpt := BattleForm.GetLuaOption(BattleForm.ModOptionsList,sl3[2]);
-            if (BattleForm.SpTBXTabControl1.ActivePage.Item.Name &lt;&gt; 'ModTab') and (BattleState.Status &lt;&gt; Hosting) then
-            begin
-              BattleForm.ModTab.FontSettings.Bold := tsTrue;
-            end;
-          end;
 
-          if luaOpt &lt;&gt; nil then
-            luaOpt.SetValue(tmp2)
-          else
-            BattleForm.ChangeScriptTagValue(Misc.JoinStringList(sl3,'/'),tmp2);
-        end
-        else
+        tmpBool := BattleForm.GameOptionsTab.FontSettings.Bold = tsTrue;
+
         try
-          if (BattleForm.SpTBXTabControl1.ActivePage.Item.Name &lt;&gt; 'GameOptionsTab') and (BattleState.Status &lt;&gt; Hosting) then
-          begin
-            BattleForm.GameOptionsTab.FontSettings.Bold := tsTrue;
-          end;
-          if tmp = LowerCase('GAME/StartMetal') then
+          if tmp = LowerCase('GAME/modoptions/StartMetal') then
             BattleForm.MetalTracker.Value := StrToInt(tmp2)
-          else if tmp = LowerCase('GAME/StartEnergy') then
+          else if tmp = LowerCase('GAME/modoptions/StartEnergy') then
             BattleForm.EnergyTracker.Value := StrToInt(tmp2)
-          else if tmp = LowerCase('GAME/MaxUnits') then
+          else if tmp = LowerCase('GAME/modoptions/MaxUnits') then
             BattleForm.UnitsTracker.Value := StrToInt(tmp2)
           else if tmp = LowerCase('GAME/StartPosType') then
             BattleForm.StartPosRadioGroup.ItemIndex := StrToInt(tmp2)
-          else if tmp = LowerCase('GAME/GameMode') then
+          else if tmp = LowerCase('GAME/modoptions/GameMode') then
             BattleForm.GameEndRadioGroup.ItemIndex := StrToInt(tmp2)
-          else if tmp = LowerCase('GAME/LimitDGun') then
-            BattleForm.LimitDGunCheckBox.Checked := StrToBool(tmp2)
-          else if tmp = LowerCase('GAME/DiminishingMMs') then
-            BattleForm.DiminishingMMsCheckBox.Checked := StrToBool(tmp2)
-          else if tmp = LowerCase('GAME/GhostedBuildings') then
-            BattleForm.GhostedBuildingsCheckBox.Checked := StrToBool(tmp2)
-          else if tmp = LowerCase('GAME/IsGameSpeedLocked') then
-            BattleForm.LockGameSpeedCheckBox.Checked := StrToBool(tmp2)
+          else if (sl3.Count = 3) and (sl3[0] = 'game') and ((sl3[1] = 'mapoptions') or (sl3[1] = 'modoptions')) then
+          begin
+            if sl3[1] = 'mapoptions' then
+            begin
+              luaOpt := BattleForm.GetLuaOption(BattleForm.MapOptionsList,sl3[2]);
+              if (BattleForm.SpTBXTabControl1.ActivePage.Item.Name &lt;&gt; 'MapTab') and (BattleState.Status &lt;&gt; Hosting) then
+              begin
+                BattleForm.MapTab.FontSettings.Bold := tsTrue;
+              end;
+            end
+            else
+            begin
+              luaOpt := BattleForm.GetLuaOption(BattleForm.ModOptionsList,sl3[2]);
+              if (BattleForm.SpTBXTabControl1.ActivePage.Item.Name &lt;&gt; 'ModTab') and (BattleState.Status &lt;&gt; Hosting) then
+              begin
+                BattleForm.ModTab.FontSettings.Bold := tsTrue;
+              end;
+            end;
+
+            if (BattleForm.SpTBXTabControl1.ActivePage.Item.Name &lt;&gt; 'GameOptionsTab') and (BattleState.Status &lt;&gt; Hosting) and not tmpBool then
+            begin
+              BattleForm.GameOptionsTab.FontSettings.Bold := tsFalse;
+            end;
+
+            if luaOpt &lt;&gt; nil then
+              luaOpt.SetValue(tmp2)
+            else
+              BattleForm.ChangeScriptTagValue(Misc.JoinStringList(sl3,'/'),tmp2);
+          end
           else
             BattleForm.ChangeScriptTagValue(Misc.JoinStringList(sl3,'/'),tmp2);
         except
-          AddMainLog('Error: Server sent ambiguous command!', Colors.Error);
-          BattleForm.DisconnectButtonClick(nil);
-          //BattleForm.ChangeScriptTagValue(tmp,tmp2);
+          on E: Exception do
+          begin
+            MessageDlg(E.Message,mtError,[mbOk], E.HelpContext);
+            AddMainLog('Error: Server sent ambiguous command!', Colors.Error);
+            BattleForm.DisconnectButtonClick(nil);
+          end;
         end;
         AllowBattleDetailsUpdate := True;
       end;
@@ -7864,14 +7862,6 @@
     end;
   end;
 
-  // is battle in progress?
-  if Battle.IsBattleInProgress then
-  begin
-    if not LobbyScriptUnit.ScriptJoining then
-      MessageDlg('Can''t join: battle is in progress!', mtInformation, [mbOK], 0);
-    Exit;
-  end;
-
   // is battle locked?
   if Battle.Locked then
   begin

Modified: Lobby/TASClient/PreferencesFormUnit.pas
===================================================================
--- Lobby/TASClient/PreferencesFormUnit.pas	2008-10-21 17:35:46 UTC (rev 6838)
+++ Lobby/TASClient/PreferencesFormUnit.pas	2008-10-21 17:39:49 UTC (rev 6839)
@@ -565,7 +565,6 @@
     //Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'LimitDGun', rdInteger, Misc.BoolToInt(BattleForm.LimitDGunCheckBox.Checked));
     //Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'Side', rdInteger, BattleForm.MySideButton.Tag);
     //Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'Units', rdInteger, BattleForm.UnitsTracker.Value);
-    Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm', 'LockSpeed', rdInteger, Misc.BoolToInt(BattleForm.LockGameSpeedCheckBox.Checked));
 
 
     with BattleForm.VDTBattleClients.Header.Columns do
@@ -708,13 +707,9 @@
   try
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm\Default', 'StartPos', rdInteger, BattleForm.StartPosRadioGroup.ItemIndex);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm\Default', 'GameEnd', rdInteger, BattleForm.GameEndRadioGroup.ItemIndex);
-    Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm\Default', 'LimitDGun', rdInteger, Misc.BoolToInt(BattleForm.LimitDGunCheckBox.Checked));
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm\Default', 'StartMetal', rdInteger, BattleForm.MetalTracker.Value);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm\Default', 'StartEnergy', rdInteger, BattleForm.EnergyTracker.Value);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm\Default', 'MaxUnits', rdInteger, BattleForm.UnitsTracker.Value);
-    Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm\Default', 'GhostedBuildings', rdInteger, BattleForm.GhostedBuildingsCheckBox.Checked);
-    Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm\Default', 'DiminishingMMs', rdInteger, BattleForm.DiminishingMMsCheckBox.Checked);
-    Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm\Default', 'LockGameSpeed', rdInteger, BattleForm.LockGameSpeedCheckBox.Checked);
   except
     MessageDlg('Unable to write preferences to windows registry!', mtError, [mbOK], 0);
   end;
@@ -724,13 +719,9 @@
 begin
   try BattleForm.StartPosRadioGroup.ItemIndex := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm\Default', 'StartPos'); except end;
   try BattleForm.GameEndRadioGroup.ItemIndex := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm\Default', 'GameEnd'); except end;
-  try BattleForm.LimitDGunCheckBox.Checked := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm\Default', 'LimitDGun'); except end;
   try BattleForm.MetalTracker.Value := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm\Default', 'StartMetal'); except end;
   try BattleForm.EnergyTracker.Value := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm\Default', 'StartEnergy'); except end;
   try BattleForm.UnitsTracker.Value := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm\Default', 'MaxUnits'); except end;
-  try BattleForm.GhostedBuildingsCheckBox.Checked := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm\Default', 'GhostedBuildings'); except end;
-  try BattleForm.DiminishingMMsCheckBox.Checked := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm\Default', 'DiminishingMMs'); except end;
-  try BattleForm.LockGameSpeedCheckBox.Checked := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\BattleForm\Default', 'LockGameSpeed'); except end;
 end;
 
 { call this method after all forms have been initialized, just before hiding the splash screen!

Modified: Lobby/TASClient/ReplaysUnit.dfm
===================================================================
--- Lobby/TASClient/ReplaysUnit.dfm	2008-10-21 17:35:46 UTC (rev 6838)
+++ Lobby/TASClient/ReplaysUnit.dfm	2008-10-21 17:39:49 UTC (rev 6839)
@@ -1,6 +1,6 @@
 object ReplaysForm: TReplaysForm
-  Left = 875
-  Top = 194
+  Left = 539
+  Top = 90
   Width = 809
   Height = 640
   Caption = 'Replays'

Modified: Lobby/TASClient/ReplaysUnit.pas
===================================================================
--- Lobby/TASClient/ReplaysUnit.pas	2008-10-21 17:35:46 UTC (rev 6838)
+++ Lobby/TASClient/ReplaysUnit.pas	2008-10-21 17:39:49 UTC (rev 6839)
@@ -984,7 +984,7 @@
     else
       lblStartPos.Caption := 'Start pos : '+BattleForm.StartPosRadioGroup.Items[Replay.Script.ReadStartPosType];
 
-    lblGameEnd.Caption := 'Game end condition: '+BattleForm.GameEndRadioGroup.Items[Replay.Script.ReadGameMode];
+    lblGameEnd.Caption := 'Game end condition: '+IntToStr(Replay.Script.ReadGameMode);
     lblMetal.Caption := 'Start metal : '+IntToStr(Replay.Script.ReadStartMetal);
     lblEnergy.Caption := 'Start energy : '+IntToStr(Replay.Script.ReadStartEnergy);
     lblMaxUnits.Caption := 'Max units : '+IntToStr(Replay.Script.ReadMaxUnits);

Modified: Lobby/TASClient/TASClient.dof
===================================================================
--- Lobby/TASClient/TASClient.dof	2008-10-21 17:35:46 UTC (rev 6838)
+++ Lobby/TASClient/TASClient.dof	2008-10-21 17:39:49 UTC (rev 6839)
@@ -115,7 +115,7 @@
 MajorVer=0
 MinorVer=3
 Release=0
-Build=480
+Build=481
 Debug=0
 PreRelease=0
 Special=0
@@ -126,7 +126,7 @@
 [Version Info Keys]
 CompanyName=
 FileDescription=TA Spring lobby client
-FileVersion=0.3.0.480
+FileVersion=0.3.0.481
 InternalName=
 LegalCopyright=
 LegalTrademarks=

Modified: Lobby/TASClient/TASClient.res
===================================================================
(Binary files differ)

Modified: Lobby/TASClient/Utility.pas
===================================================================
--- Lobby/TASClient/Utility.pas	2008-10-21 17:35:46 UTC (rev 6838)
+++ Lobby/TASClient/Utility.pas	2008-10-21 17:39:49 UTC (rev 6839)
@@ -703,6 +703,8 @@
   i,j:integer;
   o: ^TLuaOption;
   nb: integer;
+  lKey: string;
+  tmp: string;
 begin
   if modOptions then
   begin
@@ -715,8 +717,105 @@
     nb := GetMapOptionCount(PChar(mapName));
   end;
 
+
+  // first we hide the engine options
+  if modOptions then
+  begin
+    with BattleForm do
+    begin
+      lblMetal.Visible := False;
+      lblEnergy.Visible := False;
+      lblUnits.Visible := False;
+      MetalTracker.Visible := False;
+      EnergyTracker.Visible := False;
+      UnitsTracker.Visible := False;
+      ResourcesGroupBox.Visible := False;
+      GameEndRadioGroup.Visible := False;
+    end;
+  end;
+
   for i:=0 to nb-1 do
   begin
+    if modOptions then
+    begin
+      lKey := LowerCase(GetOptionKey(i));
+      if lKey = 'startmetal' then
+      begin
+        if GetOptionType(i) = 3 then
+          with BattleForm do
+          begin
+            lblMetal.Visible := True;
+            MetalTracker.Visible := True;
+            ResourcesGroupBox.Visible := True;
+
+            lblMetal.Caption := GetOptionName(i);
+            lblMetal.Hint := GetOptionDesc(i);
+            MetalTracker.Hint := GetOptionDesc(i);
+            MetalTracker.Minimum := Round(GetOptionNumberMin(i));
+            MetalTracker.Maximum := Round(GetOptionNumberMax(i));
+            //MetalTracker.Value := Round(GetOptionNumberDef(i));
+            Continue;
+          end;
+      end
+      else if lKey = 'startenergy' then
+      begin
+        if GetOptionType(i) = 3 then
+          with BattleForm do
+          begin
+            lblEnergy.Visible := True;
+            EnergyTracker.Visible := True;
+            ResourcesGroupBox.Visible := True;
+
+            lblEnergy.Caption := GetOptionName(i);
+            lblEnergy.Hint := GetOptionDesc(i);
+            EnergyTracker.Hint := GetOptionDesc(i);
+            EnergyTracker.Minimum := Round(GetOptionNumberMin(i));
+            EnergyTracker.Maximum := Round(GetOptionNumberMax(i));
+            //EnergyTracker.Value := Round(GetOptionNumberDef(i));
+            Continue;
+          end;
+      end
+      else if lKey = 'maxunits' then
+      begin
+        if GetOptionType(i) = 3 then
+          with BattleForm do
+          begin
+            lblUnits.Visible := True;
+            UnitsTracker.Visible := True;
+            ResourcesGroupBox.Visible := True;
+
+            lblUnits.Caption := GetOptionName(i);
+            lblUnits.Hint := GetOptionDesc(i);
+            UnitsTracker.Hint := GetOptionDesc(i);
+            UnitsTracker.Minimum := Round(GetOptionNumberMin(i));
+            UnitsTracker.Maximum := Round(GetOptionNumberMax(i));
+            //UnitsTracker.Value := Round(GetOptionNumberDef(i));
+            Continue;
+          end;
+      end
+      else if lKey = 'gamemode' then
+      begin
+        if GetOptionType(i) = 2 then
+          with BattleForm do
+          begin
+            GameEndRadioGroup.Visible := True;
+            GameEndRadioGroup.Height := 17;
+            GameEndRadioGroup.Hint := '';
+            GameEndRadioGroup.Items.Clear;
+
+            for j:= 0 to GetOptionListCount(i)-1 do
+            begin
+              GameEndRadioGroup.Items.Add(GetOptionListItemName(i,j));
+              GameEndRadioGroup.Height := GameEndRadioGroup.Height + 17;
+              GameEndRadioGroup.Hint := GameEndRadioGroup.Hint + GetOptionListItemName(i,j) + ' = ' + GetOptionListItemDesc(i,j) + EOL;
+            end;
+
+            GameEndRadioGroup.ItemIndex := 0;
+
+            Continue;
+          end;
+      end;
+    end;
     Case GetOptionType(i) of
       1: // bool
       begin


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001607.html">[Taspring-linux-commit] r6838 - in tags/spring_0.77b5:	AI/Global/KAIK-0.13 installer/builddata/springcontent rts/Lua	rts/Rendering rts/System rts/build/vstudio8
</A></li>
	<LI>Next message: <A HREF="001609.html">[Taspring-linux-commit] r6840 - trunk/rts/Lua
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1608">[ date ]</a>
              <a href="thread.html#1608">[ thread ]</a>
              <a href="subject.html#1608">[ subject ]</a>
              <a href="author.html#1608">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
