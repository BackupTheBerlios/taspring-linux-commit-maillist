<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r7517 - Lobby/TASClient
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2010-November/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r7517%20-%20Lobby/TASClient&In-Reply-To=%3C20101103173046.9BD7B2AB4E%40it-l.eu%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="002288.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r7517 - Lobby/TASClient</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r7517%20-%20Lobby/TASClient&In-Reply-To=%3C20101103173046.9BD7B2AB4E%40it-l.eu%3E"
       TITLE="[Taspring-linux-commit] r7517 - Lobby/TASClient">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Wed Nov  3 18:30:46 CET 2010</I>
    <P><UL>
        
        <LI>Next message: <A HREF="002288.html">[Taspring-linux-commit] r7518 - in Lobby/TASClient: . Python/scripts
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2287">[ date ]</a>
              <a href="thread.html#2287">[ thread ]</a>
              <a href="subject.html#2287">[ subject ]</a>
              <a href="author.html#2287">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: satirik
Date: 2010-11-03 18:30:45 +0100 (Wed, 03 Nov 2010)
New Revision: 7517

Added:
   Lobby/TASClient/WidgetDBFormUnit.dfm
   Lobby/TASClient/WidgetDBFormUnit.pas
Modified:
   Lobby/TASClient/BattleFormUnit.dfm
   Lobby/TASClient/BattleFormUnit.pas
   Lobby/TASClient/MainUnit.dfm
   Lobby/TASClient/MainUnit.pas
   Lobby/TASClient/Misc.pas
   Lobby/TASClient/PreferencesFormUnit.dfm
   Lobby/TASClient/PreferencesFormUnit.pas
   Lobby/TASClient/ReplaysUnit.dfm
   Lobby/TASClient/SplashScreenUnit.pas
   Lobby/TASClient/SpringDownloaderFormUnit.dfm
   Lobby/TASClient/SpringDownloaderFormUnit.pas
   Lobby/TASClient/TASClient.cfg
   Lobby/TASClient/TASClient.dof
   Lobby/TASClient/TASClient.dpr
   Lobby/TASClient/TASClient.res
   Lobby/TASClient/UploadReplayUnit.dfm
   Lobby/TASClient/UploadReplayUnit.pas
Log:
* lot of small bugs fixed
* integrated downloader supports multiple sources
* spring widget database form added

Modified: Lobby/TASClient/BattleFormUnit.dfm
===================================================================
--- Lobby/TASClient/BattleFormUnit.dfm	2010-09-20 18:08:33 UTC (rev 7516)
+++ Lobby/TASClient/BattleFormUnit.dfm	2010-11-03 17:30:45 UTC (rev 7517)
@@ -1,6 +1,6 @@
 object BattleForm: TBattleForm
-  Left = 851
-  Top = 386
+  Left = 250
+  Top = 299
   Width = 923
   Height = 638
   Caption = 'Battle window'
@@ -12758,11 +12758,10 @@
         Align = alClient
         BiDiMode = bdLeftToRight
         ParentBiDiMode = False
-        ActiveTabIndex = 0
+        ActiveTabIndex = 2
         OnActiveTabChange = SpTBXTabControl1ActiveTabChange
         HiddenItems = &lt;&gt;
         object QuickLookTab: TSpTBXTabItem
-          Checked = True
           ImageIndex = 1
           Images = MainForm.ArrowList
           CustomWidth = 40
@@ -12776,6 +12775,7 @@
         object DisabledUnitsTab: TSpTBXTabItem
           Caption = 'Disabled Units (0)'
           Wrapping = twWrap
+          Checked = True
           CustomWidth = 94
         end
         object MapTab: TSpTBXTabItem
@@ -12922,77 +12922,6 @@
             end
           end
         end
-        object SpTBXTabSheet1: TSpTBXTabSheet
-          Left = 0
-          Top = 39
-          Width = 417
-          Height = 234
-          Caption = 'Disabled Units (0)'
-          ImageIndex = -1
-          DesignSize = (
-            417
-            234)
-          TabItem = 'DisabledUnitsTab'
-          object UnitsGroupBox: TSpTBXGroupBox
-            Left = 8
-            Top = 4
-            Width = 401
-            Height = 227
-            Caption = 'Disabled units'
-            Anchors = [akLeft, akTop, akBottom]
-            TabOrder = 0
-            TBXStyleBackground = True
-            DesignSize = (
-              401
-              227)
-            object VDTDisabledUnits: TVirtualDrawTree
-              Left = 16
-              Top = 32
-              Width = 369
-              Height = 183
-              Anchors = [akLeft, akTop, akRight, akBottom]
-              DefaultNodeHeight = 64
-              Header.AutoSizeIndex = 1
-              Header.DefaultHeight = 17
-              Header.Font.Charset = DEFAULT_CHARSET
-              Header.Font.Color = clWindowText
-              Header.Font.Height = -11
-              Header.Font.Name = 'MS Sans Serif'
-              Header.Font.Style = []
-              Header.Options = [hoAutoResize, hoColumnResize, hoDrag]
-              TabOrder = 0
-              TreeOptions.MiscOptions = [toAcceptOLEDrop, toCheckSupport, toFullRepaintOnResize, toInitOnSave, toToggleOnDblClick, toWheelPanning, toEditOnClick]
-              TreeOptions.PaintOptions = [toHideFocusRect, toHotTrack, toShowButtons, toShowDropmark, toThemeAware, toUseBlendedImages]
-              TreeOptions.SelectionOptions = [toFullRowSelect]
-              OnDrawNode = VDTDisabledUnitsDrawNode
-              Columns = &lt;
-                item
-                  Position = 0
-                  Width = 64
-                  WideText = 'Icon'
-                end
-                item
-                  Position = 1
-                  Width = 201
-                  WideText = 'FullName'
-                end
-                item
-                  Position = 2
-                  Width = 100
-                  WideText = 'Code name'
-                end&gt;
-            end
-            object AddUnitsSpeedButton: TSpTBXButton
-              Left = 232
-              Top = 10
-              Width = 153
-              Height = 22
-              Caption = 'Add more units'
-              TabOrder = 1
-              OnClick = AddUnitsSpeedButtonClick
-            end
-          end
-        end
         object SpTBXTabSheet2: TSpTBXTabSheet
           Left = 0
           Top = 39
@@ -13209,6 +13138,77 @@
             OnMouseMove = QuickLookRichEditMouseMove
           end
         end
+        object SpTBXTabSheet1: TSpTBXTabSheet
+          Left = 0
+          Top = 39
+          Width = 417
+          Height = 234
+          Caption = 'Disabled Units (0)'
+          ImageIndex = -1
+          DesignSize = (
+            417
+            234)
+          TabItem = 'DisabledUnitsTab'
+          object UnitsGroupBox: TSpTBXGroupBox
+            Left = 8
+            Top = 4
+            Width = 401
+            Height = 227
+            Caption = 'Disabled units'
+            Anchors = [akLeft, akTop, akBottom]
+            TabOrder = 0
+            TBXStyleBackground = True
+            DesignSize = (
+              401
+              227)
+            object VDTDisabledUnits: TVirtualDrawTree
+              Left = 16
+              Top = 32
+              Width = 369
+              Height = 183
+              Anchors = [akLeft, akTop, akRight, akBottom]
+              DefaultNodeHeight = 64
+              Header.AutoSizeIndex = 1
+              Header.DefaultHeight = 17
+              Header.Font.Charset = DEFAULT_CHARSET
+              Header.Font.Color = clWindowText
+              Header.Font.Height = -11
+              Header.Font.Name = 'MS Sans Serif'
+              Header.Font.Style = []
+              Header.Options = [hoAutoResize, hoColumnResize, hoDrag]
+              TabOrder = 0
+              TreeOptions.MiscOptions = [toAcceptOLEDrop, toCheckSupport, toFullRepaintOnResize, toInitOnSave, toToggleOnDblClick, toWheelPanning, toEditOnClick]
+              TreeOptions.PaintOptions = [toHideFocusRect, toHotTrack, toShowButtons, toShowDropmark, toThemeAware, toUseBlendedImages]
+              TreeOptions.SelectionOptions = [toFullRowSelect]
+              OnDrawNode = VDTDisabledUnitsDrawNode
+              Columns = &lt;
+                item
+                  Position = 0
+                  Width = 64
+                  WideText = 'Icon'
+                end
+                item
+                  Position = 1
+                  Width = 201
+                  WideText = 'FullName'
+                end
+                item
+                  Position = 2
+                  Width = 100
+                  WideText = 'Code name'
+                end&gt;
+            end
+            object AddUnitsSpeedButton: TSpTBXButton
+              Left = 232
+              Top = 10
+              Width = 153
+              Height = 22
+              Caption = 'Add more units'
+              TabOrder = 1
+              OnClick = AddUnitsSpeedButtonClick
+            end
+          end
+        end
       end
     end
   end

Modified: Lobby/TASClient/BattleFormUnit.pas
===================================================================
--- Lobby/TASClient/BattleFormUnit.pas	2010-09-20 18:08:33 UTC (rev 7516)
+++ Lobby/TASClient/BattleFormUnit.pas	2010-11-03 17:30:45 UTC (rev 7517)
@@ -1577,6 +1577,12 @@
 begin
   if not IsBattleActive then Exit; // this should not happen
 
+  if BattleState.HostSupportsJoinPassword and (BattleState.Status = Joined) then
+  begin
+    JoinButton.Visible := True;
+    StartButton.Visible := False;
+  end;
+
   if Status.AmIInGame then Exit;
 
   if Utility.MapList.indexOf(BattleState.Battle.Map) = -1 then
@@ -1634,6 +1640,9 @@
 
   springDir := ExtractFilePath(Application.ExeName);
 
+  if SpringSettingsProfileForm.cpNames.IndexOf(SpringSettingsProfile) = -1 then
+    SpringSettingsProfile := '';
+
   params := 'script.txt';
   r := SpringSettingsProfileForm.getSettingsFile(Status.Me.GetMode = 0,SpringSettingsProfile &lt;&gt; '',SpringSettingsProfile);
   if r &lt;&gt; '' then
@@ -1677,11 +1686,6 @@
     BattleState.Battle.RefreshRanksNCupsOnSuccessReport := True;
     if (BattleState.Status = Hosting) and not BattleState.Battle.Locked and mnuAutoLockOnStart.Checked then
       LockedCheckBoxClick(nil);
-    if BattleState.HostSupportsJoinPassword and (BattleState.Status = Joined) then
-    begin
-      JoinButton.Visible := True;
-      StartButton.Visible := False;
-    end;
   end
   else
   begin
@@ -4090,6 +4094,8 @@
   // (we could also generate diff list and update it with ENABLEUNITS/DISABLEUNITS commands)
   BattleForm.PopulateDisabledUnitsVDT;
 
+  RefreshQuickLookText;
+
   MainForm.TryToSendCommand('ENABLEALLUNITS');
   if BattleState.DisabledUnits.Count &gt; 0 then
   begin
@@ -6840,7 +6846,7 @@
     if Preferences.DisplayUnitsIconsAndNames then
     begin
       for i:=0 to BattleState.DisabledUnits.Count-1 do
-        tmpStr := tmpStr + EOL + UnitNames[UnitList.IndexOf(BattleState.DisabledUnits[i])];
+        tmpStr := tmpStr + UnitNames[UnitList.IndexOf(BattleState.DisabledUnits[i])] + EOL;
       QuickLookRichEdit.SelText := tmpStr;
     end
     else

Modified: Lobby/TASClient/MainUnit.dfm
===================================================================
--- Lobby/TASClient/MainUnit.dfm	2010-09-20 18:08:33 UTC (rev 7516)
+++ Lobby/TASClient/MainUnit.dfm	2010-11-03 17:30:45 UTC (rev 7517)
@@ -1,6 +1,6 @@
 object MainForm: TMainForm
-  Left = 302
-  Top = 522
+  Left = 238
+  Top = 257
   Width = 883
   Height = 539
   Caption = '.'
@@ -285,7 +285,7 @@
                 22)
               object SpTBXLabel4: TSpTBXLabel
                 Left = 2
-                Top = 0
+                Top = 2
                 Width = 28
                 Height = 13
                 Hint = 
@@ -295,37 +295,22 @@
                 ParentShowHint = False
                 ShowHint = True
               end
-              object PlayerFiltersTextbox: TSpTBXEdit
+              object PlayerFiltersTextbox: TSpTBXButtonEdit
                 Left = 40
                 Top = 0
-                Width = 145
+                Width = 169
                 Height = 21
-                HelpType = htKeyword
                 Anchors = [akLeft, akTop, akRight]
-                ParentShowHint = False
-                ShowHint = False
                 TabOrder = 1
                 OnChange = PlayerFiltersTextboxChange
+                EditButton.Left = 146
+                EditButton.Top = 0
+                EditButton.Width = 19
+                EditButton.Height = 17
+                EditButton.Caption = 'X'
+                EditButton.Align = alRight
+                EditButton.OnClick = ClearPlayersFilterButtonClick
               end
-              object ClearPlayersFilterButton: TSpTBXButton
-                Left = 187
-                Top = 0
-                Width = 21
-                Height = 20
-                Hint = 'Clear the filter'
-                Caption = 'X'
-                Anchors = [akTop, akRight]
-                Font.Charset = DEFAULT_CHARSET
-                Font.Color = clWindowText
-                Font.Height = -11
-                Font.Name = 'MS Sans Serif'
-                Font.Style = [fsBold]
-                ParentFont = False
-                ParentShowHint = False
-                ShowHint = True
-                TabOrder = 2
-                OnClick = ClearPlayersFilterButtonClick
-              end
             end
             object PlayersInfoPanel: TSpTBXPanel
               Left = 2
@@ -5978,6 +5963,10 @@
       Caption = 'Spring options'
       OnClick = mnuSpringOptionsClick
     end
+    object mnuSpringWidgetDatabase: TSpTBXItem
+      Caption = 'Spring Widget database'
+      OnClick = mnuSpringWidgetDatabaseClick
+    end
     object SpTBXSeparatorItem24: TSpTBXSeparatorItem
     end
     object mnuJoinChannel: TSpTBXItem

Modified: Lobby/TASClient/MainUnit.pas
===================================================================
--- Lobby/TASClient/MainUnit.pas	2010-09-20 18:08:33 UTC (rev 7516)
+++ Lobby/TASClient/MainUnit.pas	2010-11-03 17:30:45 UTC (rev 7517)
@@ -1263,8 +1263,6 @@
     ClientListOptionsPanel: TSpTBXPanel;
     PlayerFiltersPanel: TSpTBXPanel;
     SpTBXLabel4: TSpTBXLabel;
-    PlayerFiltersTextbox: TSpTBXEdit;
-    ClearPlayersFilterButton: TSpTBXButton;
     PlayersInfoPanel: TSpTBXPanel;
     PlayersLabel: TSpTBXLabel;
     SortLabel: TSpTBXButton;
@@ -1283,6 +1281,8 @@
     SpacerPanel1: TSpTBXPanel;
     SpacerPanel2: TSpTBXPanel;
     SpringSocket: TWSocket;
+    mnuSpringWidgetDatabase: TSpTBXItem;
+    PlayerFiltersTextbox: TSpTBXButtonEdit;
     procedure mnuOpenPrivateChatClick(Sender: TObject);
     procedure mnuSelectBattleClick(Sender: TObject);
     procedure mnuPlayWithClick(Sender: TObject);
@@ -1472,6 +1472,7 @@
     procedure MaxPlayersValueTextBoxSubEditButton0Click(Sender: TObject);
     procedure RankValueTextBoxSubEditButton0Click(Sender: TObject);
     procedure SpringSocketTimerTimer(Sender: TObject);
+    procedure mnuSpringWidgetDatabaseClick(Sender: TObject);
   published
     MainTitleBar: TSpTBXTitleBar;
     ButtonImageList: TImageList;
@@ -1909,7 +1910,7 @@
   TntWideStrings, SpringSettingsProfileFormUnit, gnugettext,
   AutoJoinFormUnit, AddBotUnit, Minimap3DPreviewUnit,
   MinimapZoomedFormUnit, DisableUnitsFormUnit, SetStringsUnit,
-  ChannelsListFormUnit, Types;
+  ChannelsListFormUnit, Types, WidgetDBFormUnit;
 
 {$R *.dfm}
 
@@ -2140,6 +2141,10 @@
     BattleForm.Top := 50;
     BattleForm.Width := 800;
     BattleForm.Height := 500;
+    WidgetDBForm.Left := 100;
+    WidgetDBForm.Top := 100;
+    WidgetDBForm.Width := 835;
+    WidgetDBForm.Height := 600;
     Exit;
   end;
 
@@ -8199,11 +8204,11 @@
      begin
        OpenPrivateChat(SelectedClient);
      end
-     else if RightStr(LowerCase(SelectedWord),4) = '.smf' then
+     else// if RightStr(LowerCase(SelectedWord),4) = '.smf' then
      begin
         mapIndex := MapList.IndexOf(SelectedWord);
         if mapIndex &gt; -1 then
-          if BattleState.Status &lt;&gt; Joined then
+          if BattleState.Status = Hosting then
           begin
             BattleForm.ChangeMap(mapIndex);
             if BattleState.Status = Hosting then
@@ -12393,7 +12398,7 @@
   f^.filterType := MapName;
   f^.node := nil;
   f^.contains := True;
-  f^.value := Copy(SelectedBattle.Map, 1, Length(SelectedBattle.Map)-4);
+  f^.value := Copy(SelectedBattle.Map, 1, Length(SelectedBattle.Map));
   CurrentFilters.TextFilters.Add(f);
   f^.Node := FilterList.AddChild(FilterList.RootNode);
   f^.Node.CheckType := ctCheckBox;
@@ -12450,7 +12455,7 @@
   f^.filterType := MapName;
   f^.node := nil;
   f^.contains := False;
-  f^.value := Copy(SelectedBattle.Map, 1, Length(SelectedBattle.Map)-4);
+  f^.value := Copy(SelectedBattle.Map, 1, Length(SelectedBattle.Map));
   CurrentFilters.TextFilters.Add(f);
   f^.Node := FilterList.AddChild(FilterList.RootNode);
   f^.Node.CheckType := ctCheckBox;
@@ -14158,6 +14163,7 @@
   sl := GetDownloadLinks('TheRockFinal');
   for i:=0 to sl.count-1 do
     AddMainLog(sl[i],colors.Normal);
+  DownloadMap(0,'TheRockFinal');
 end;
 
 procedure TMainForm.VDTBattlesHeaderDraw(Sender: TVTHeader;
@@ -14308,6 +14314,8 @@
   sl: TStringList;
   i: integer;
 begin
+  if not Debug.Enabled then
+    Exit;
   sl := TStringList.Create;
   GetUnitSyncErrors(sl);
   for i:=0 to sl.Count-1 do
@@ -14365,4 +14373,11 @@
   end;
 end;
 
+procedure TMainForm.mnuSpringWidgetDatabaseClick(Sender: TObject);
+begin
+  WidgetDBForm.Show;
+  if WidgetDBForm.widgetList.Count = 0 then
+    WidgetDBForm.btRefreshClick(nil);
+end;
+
 end.

Modified: Lobby/TASClient/Misc.pas
===================================================================
--- Lobby/TASClient/Misc.pas	2010-09-20 18:08:33 UTC (rev 7516)
+++ Lobby/TASClient/Misc.pas	2010-11-03 17:30:45 UTC (rev 7517)
@@ -81,6 +81,8 @@
 procedure RemoveRegistryKey(RootKey: HKEY; Key: string);
 function FormatFileSize(Size: Integer): string;
 function FormatFileSize2(SizeInBytes: Integer): string;
+// will replace the %s by the corresponding size and all %u by the unit
+function FormatFileSize3(const sizes: array of const;formatStr: string): string;
 function GenerateUniqueID: Integer;
 function GetCPUSpeed: Integer;
 procedure NormalizeRect(var Rect: TRect);
@@ -105,6 +107,7 @@
 function ColorToG(Color: Integer): Byte; // Color is in $00BBGGRR format
 function ColorToB(Color: Integer): Byte; // Color is in $00BBGGRR format
 function ColorToStandardRGB(Color: Integer): Integer;
+function ColorToStandardRGBHex(Color: Integer): string;
 function StandardRGBToColor(Color: Integer): Integer;
 function ColorToScriptString(ColorC: TColor): string;
 function Color16BitsToR(Color: Word): Byte;
@@ -185,7 +188,7 @@
 implementation
 
 uses
-  ShellAPI, Math, RichEdit, Messages, MainUnit, StringParser,
+  ShellAPI, Math, RichEdit, Messages, MainUnit, StringParser,gnugettext,
   StrUtils, uMd5, SZCodeBaseX, HighlightingUnit, DSiWin32, ColorPicker;
 
 const
@@ -667,8 +670,11 @@
   FileStream: TFileStream;
 begin
   FileStream := TFileStream.Create(FileName, fmOpenWrite or fmCreate);
-  FileStream.WriteBuffer(content[1],Length(content));
-  FileStream.Free;
+  try
+    FileStream.WriteBuffer(content[1],Length(content));
+  finally
+    FileStream.Free;
+  end;
 end;
 
 { --------------------------------------------------------------------------- }
@@ -820,10 +826,51 @@
 function FormatFileSize2(SizeInBytes: Integer): string;
 begin
   if SizeInBytes &lt; 1000 then Result := IntToStr(SizeInBytes) + ' bytes'
-  else if SizeInBytes &lt; 1000*1000 then Result := Format('%.2f', [(SizeInBytes / 1024)]) + ' KB'
+  else if SizeInBytes &lt; 1000*1000 then Result := Format('%.2f', [(SizeInBytes / 1024)]) + ' kB'
   else Result := Format('%.2f', [(SizeInBytes / (1024*1024))]) + ' MB'
 end;
 
+function FormatFileSize3(const sizes: array of const;formatStr: string): string;
+var
+  i: integer;
+  maxSize: integer;
+  unitDiv: Extended;
+  unitStr: string;
+begin
+  maxSize := 0;
+  for i:=0 to Length(sizes)-1 do
+  begin
+    if sizes[i].VType &lt;&gt; System.vtInteger then
+      raise Exception.Create('Misc.FormatFileSize3 only supports integer sizes');
+    if sizes[i].VInteger &gt; maxSize then
+      maxSize := sizes[i].VInteger;
+  end;
+
+  i:=0;
+
+  while maxSize / (Power(1024,i+1)) &gt; 2 do
+    Inc(i);
+
+  case i of
+    0: unitStr := _('bytes');
+    1: unitStr := _('kB');
+    2: unitStr := _('MB');
+    3: unitStr := _('GB');
+    4: unitStr := _('TB');
+  else
+    unitStr := 'HELL LOT OF BYTES';
+  end;
+
+  unitDiv := Power(1024,i);
+
+  Result := formatStr;
+  for i:=0 to Length(sizes)-1 do
+  begin
+    Result := StringReplace(Result,'%s',Format('%.2f', [(sizes[i].VInteger / unitDiv)]),[]);
+  end;
+  Result := StringReplace(Result,'%u',unitStr,[rfReplaceAll]);
+end;
+
 { --------------------------------------------------------------------------- }
 
 function GenerateUniqueID: Integer;
@@ -1257,6 +1304,11 @@
   Result := ((ColorToR(Color) shl 16) or ColorToG(Color) shl 8) or ColorToB(Color);
 end;
 
+function ColorToStandardRGBHex(Color: Integer): string;
+begin
+  Result := IntToHex(ColorToStandardRGB(Color),6);
+end;
+
 function StandardRGBToColor(Color: Integer): Integer;
 var
   R,G,B:byte;

Modified: Lobby/TASClient/PreferencesFormUnit.dfm
===================================================================
--- Lobby/TASClient/PreferencesFormUnit.dfm	2010-09-20 18:08:33 UTC (rev 7516)
+++ Lobby/TASClient/PreferencesFormUnit.dfm	2010-11-03 17:30:45 UTC (rev 7517)
@@ -1,6 +1,6 @@
 object PreferencesForm: TPreferencesForm
-  Left = 1338
-  Top = 280
+  Left = 979
+  Top = 271
   Width = 578
   Height = 548
   Caption = 'Preferences'
@@ -90,12 +90,13 @@
       Top = 56
       Width = 553
       Height = 417
-      ActiveTabIndex = 2
+      ActiveTabIndex = 0
       TabAutofit = True
       HiddenItems = &lt;&gt;
       object SpTBXTabItem6: TSpTBXTabItem
         Caption = 'Server'
         Wrapping = twWrap
+        Checked = True
         CustomWidth = 78
         CustomHeight = 40
       end
@@ -107,7 +108,6 @@
       object SpTBXTabItem4: TSpTBXTabItem
         Caption = 'Program'
         Wrapping = twWrap
-        Checked = True
         CustomWidth = 78
       end
       object SpTBXTabItem3: TSpTBXTabItem
@@ -675,94 +675,6 @@
           end
         end
       end
-      object SpTBXTabSheet6: TSpTBXTabSheet
-        Left = 0
-        Top = 44
-        Width = 553
-        Height = 373
-        Caption = 'Server'
-        ImageIndex = -1
-        TabItem = 'SpTBXTabItem6'
-        object GroupBox1: TSpTBXGroupBox
-          Left = 16
-          Top = 8
-          Width = 529
-          Height = 345
-          Caption = 'Server settings'
-          TabOrder = 0
-          object Label1: TSpTBXLabel
-            Left = 16
-            Top = 32
-            Width = 74
-            Height = 13
-            Caption = 'Server address:'
-          end
-          object Label2: TSpTBXLabel
-            Left = 16
-            Top = 56
-            Width = 55
-            Height = 13
-            Caption = 'Server port:'
-          end
-          object ServerPortEdit: TSpTBXEdit
-            Left = 128
-            Top = 56
-            Width = 41
-            Height = 21
-            TabOrder = 1
-            Text = '8200'
-          end
-          object CheckBox10: TSpTBXCheckBox
-            Left = 16
-            Top = 128
-            Width = 197
-            Height = 15
-            Caption = 'Connect to backup host if primary fails'
-            TabOrder = 2
-            Checked = True
-            State = cbChecked
-          end
-          object CheckBox2: TSpTBXCheckBox
-            Left = 16
-            Top = 144
-            Width = 108
-            Height = 15
-            Caption = 'Connect on startup'
-            TabOrder = 3
-          end
-          object CheckBox7: TSpTBXCheckBox
-            Left = 16
-            Top = 160
-            Width = 226
-            Height = 15
-            Caption = 'Join #main once connected (recommended)'
-            TabOrder = 4
-          end
-          object ServerAddressEdit: TSpTBXButtonEdit
-            Left = 128
-            Top = 32
-            Width = 385
-            Height = 21
-            TabOrder = 0
-            EditButton.Left = 361
-            EditButton.Top = 0
-            EditButton.Width = 20
-            EditButton.Height = 17
-            EditButton.Caption = '...'
-            EditButton.Align = alRight
-            EditButton.DropDownArrow = False
-            EditButton.DropDownMenu = AddressPopupMenu
-          end
-          object PerformButton: TSpTBXSpeedButton
-            Left = 400
-            Top = 56
-            Width = 113
-            Height = 21
-            Caption = 'Perform ...'
-            OnClick = PerformButtonClick
-          end
-        end
-      end
       object SpTBXTabSheet4: TSpTBXTabSheet
         Left = 0
         Top = 44
@@ -945,6 +857,94 @@
           end
         end
       end
+      object SpTBXTabSheet6: TSpTBXTabSheet
+        Left = 0
+        Top = 44
+        Width = 553
+        Height = 373
+        Caption = 'Server'
+        ImageIndex = -1
+        TabItem = 'SpTBXTabItem6'
+        object GroupBox1: TSpTBXGroupBox
+          Left = 16
+          Top = 8
+          Width = 529
+          Height = 345
+          Caption = 'Server settings'
+          TabOrder = 0
+          object Label1: TSpTBXLabel
+            Left = 16
+            Top = 32
+            Width = 74
+            Height = 13
+            Caption = 'Server address:'
+          end
+          object Label2: TSpTBXLabel
+            Left = 16
+            Top = 56
+            Width = 55
+            Height = 13
+            Caption = 'Server port:'
+          end
+          object ServerPortEdit: TSpTBXEdit
+            Left = 128
+            Top = 56
+            Width = 41
+            Height = 21
+            TabOrder = 1
+            Text = '8200'
+          end
+          object CheckBox10: TSpTBXCheckBox
+            Left = 16
+            Top = 128
+            Width = 197
+            Height = 15
+            Caption = 'Connect to backup host if primary fails'
+            TabOrder = 2
+            Checked = True
+            State = cbChecked
+          end
+          object CheckBox2: TSpTBXCheckBox
+            Left = 16
+            Top = 144
+            Width = 108
+            Height = 15
+            Caption = 'Connect on startup'
+            TabOrder = 3
+          end
+          object CheckBox7: TSpTBXCheckBox
+            Left = 16
+            Top = 160
+            Width = 226
+            Height = 15
+            Caption = 'Join #main once connected (recommended)'
+            TabOrder = 4
+          end
+          object ServerAddressEdit: TSpTBXButtonEdit
+            Left = 128
+            Top = 32
+            Width = 385
+            Height = 21
+            TabOrder = 0
+            EditButton.Left = 361
+            EditButton.Top = 0
+            EditButton.Width = 20
+            EditButton.Height = 17
+            EditButton.Caption = '...'
+            EditButton.Align = alRight
+            EditButton.DropDownArrow = False
+            EditButton.DropDownMenu = AddressPopupMenu
+          end
+          object PerformButton: TSpTBXSpeedButton
+            Left = 400
+            Top = 56
+            Width = 113
+            Height = 21
+            Caption = 'Perform ...'
+            OnClick = PerformButtonClick
+          end
+        end
+      end
     end
     object ApplyAndCloseButton: TSpTBXButton
       Left = 119

Modified: Lobby/TASClient/PreferencesFormUnit.pas
===================================================================
--- Lobby/TASClient/PreferencesFormUnit.pas	2010-09-20 18:08:33 UTC (rev 7516)
+++ Lobby/TASClient/PreferencesFormUnit.pas	2010-11-03 17:30:45 UTC (rev 7517)
@@ -291,6 +291,7 @@
     LangCodes: TStringList;
     
     procedure PopulateServerListMenu;
+    function isLoggedOnOfficialServer: Boolean;
   end;
 
   TServerListItem =
@@ -301,7 +302,7 @@
   end;
 
 const
-  DEFAULT_PREFERENCES: TPreferences = (ServerIP:'taspringmaster.clan-sy.com'; ServerPort:'8200'; TabStyle:0; TimeStamps: True; Username:''; Password:'';
+  DEFAULT_PREFERENCES: TPreferences = (ServerIP:'springrts.com'; ServerPort:'8200'; TabStyle:0; TimeStamps: True; Username:''; Password:'';
                                         RememberPasswords: False; ConnectOnStartup: False; SortStyle: 1; BattleSortStyle: 1; BattleSortDirection: 0;
                                         BattleClientSortStyle: 2;FilterJoinLeftMessages: False;FilterBattleJoinLeftMessages: False; ShowFlags: True;
                                         MarkUnknownMaps: False; TaskbarButtons: True; JoinMainChannel: True; ReconnectToBackup: True; SaveLogs: True;
@@ -337,7 +338,7 @@
   AutoTeamsUnit, ChannelsListFormUnit, AutoJoinFormUnit, InitWaitFormUnit,
   DisableUnitsFormUnit, MenuFormUnit, AddBotUnit, AwayMessageFormUnit,
   UploadReplayUnit,CustomizeGUIFormUnit, HostInfoUnit, HelpUnit, Types,
-  HttpGetUnit, SplashScreenUnit, DebugUnit;
+  HttpGetUnit, SplashScreenUnit, DebugUnit, WidgetDBFormUnit;
 
 {$R *.dfm}
 
@@ -478,6 +479,23 @@
       end;
     FixFormBounds(MainForm);
 
+    try WidgetDBForm.Left := Misc.GetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\WidgetDBForm', 'Left'); except end;
+    try WidgetDBForm.Top := Misc.GetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\WidgetDBForm', 'Top'); except end;
+    try WidgetDBForm.Width := Misc.GetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\WidgetDBForm', 'Width'); except end;
+    try WidgetDBForm.Height := Misc.GetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\WidgetDBForm', 'Height'); except end;
+    try WidgetDBForm.WindowState := Misc.GetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\WidgetDBForm', 'WindowState'); except end;
+    try WidgetDBForm.pnlWidgetInfo.Height := Misc.GetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\WidgetDBForm', 'PnlWidgetInfoHeight'); except end;
+    try WidgetDBForm.wbScreenShots.Height := Misc.GetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\WidgetDBForm', 'WbScreenShotsHeight'); except end;
+    with WidgetDBForm.vstWidgetList.Header.Columns do
+      for i := 0 to Count-1 do
+      try
+        Items[i].Width := Misc.GetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\WidgetDBForm', 'Column' + IntToStr(i));
+        Items[i].Position := Misc.GetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\WidgetDBForm', 'ColumnPosition' + IntToStr(i));
+      except
+      end;
+    FixFormBounds(WidgetDBForm);
+
+
     try BattleForm.Left := Misc.GetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\BattleForm', 'Left'); except end;
     try BattleForm.Top := Misc.GetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\BattleForm', 'Top'); except end;
     try BattleForm.Width := Misc.GetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\BattleForm', 'Width'); except end;
@@ -614,6 +632,25 @@
       end;
 
     Pl.Length := SizeOf(TWindowPlacement);
+    GetWindowPlacement(WidgetDBForm.Handle, @Pl);
+    R := Pl.rcNormalPosition;
+
+    Misc.SetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\WidgetDBForm', 'Left', rdInteger, R.Left);
+    Misc.SetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\WidgetDBForm', 'Top', rdInteger, R.Top);
+    Misc.SetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\WidgetDBForm', 'Width', rdInteger, R.Right-R.Left);
+    Misc.SetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\WidgetDBForm', 'Height', rdInteger, R.Bottom-R.Top);
+    Misc.SetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\WidgetDBForm', 'WindowState', rdInteger, WidgetDBForm.WindowState);
+    Misc.SetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\WidgetDBForm', 'PnlWidgetInfoHeight', rdInteger, WidgetDBForm.pnlWidgetInfo.Height);
+    Misc.SetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\WidgetDBForm', 'WbScreenShotsHeight', rdInteger, WidgetDBForm.wbScreenShots.Height);
+    with WidgetDBForm.vstWidgetList.Header.Columns do
+      for i := 0 to Count-1 do
+      begin
+        Misc.SetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\WidgetDBForm', 'Column' + IntToStr(i), rdInteger, Items[i].Width);
+        Misc.SetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\WidgetDBForm', 'ColumnPosition' + IntToStr(i), rdInteger, Items[i].Position);
+      end;
+
+
+    Pl.Length := SizeOf(TWindowPlacement);
     GetWindowPlacement(BattleForm.Handle, @Pl);
     R := Pl.rcNormalPosition;
 
@@ -980,8 +1017,6 @@
     ReplaysForm.ScriptRichEdit.BorderStyle := Forms.bsNone;
     BattleForm.AutoHostMsgsRichEdit.Color := IfNotClNone(SkinManager.CurrentSkin.Options(skncTabBackground).Body.Color1,clBtnFace);
     HelpForm.TntScrollBox1.Color := IfNotClNone(SkinManager.CurrentSkin.Options(skncTabBackground).Body.Color1,clWindow);
-    AwayMessageForm.MessageRichEdit.BorderStyle := Forms.bsNone;
-    AwayMessageForm.MessageRichEdit.Color := IfNotClNone(SkinManager.CurrentSkin.Options(skncTabBackground).Body.Color1,clWindow);
     HostInfoForm.Label3.Font.Color := clWhite;
     HostInfoForm.Label5.Font.Color := clWhite;
     BattleForm.lblEnergy.Font.Color := IfNotClNone(SkinManager.CurrentSkin.GetTextColor(skncLabel,sknsNormal),clBlue);
@@ -990,8 +1025,6 @@
     MapListForm.lblLoadMissingMinimaps.Font.Color := IfNotClNone(SkinManager.CurrentSkin.GetTextColor(skncLabel,sknsNormal),clBlue);
     MapListForm.SortLabel.Font.Color := IfNotClNone(SkinManager.CurrentSkin.GetTextColor(skncLabel,sknsNormal),clBlue);
     MainForm.MainDockPanel.Color :=  IfNotClNone(SkinManager.CurrentSkin.Options(skncWindow).Body.Color1,clBtnFace);
-    UploadReplayForm.DescriptionRtBox.Font.Color := SkinManager.CurrentSkin.GetTextColor(skncEditFrame,sknsNormal);
-    UploadReplayForm.DescriptionRtBox.Clear;
     BattleForm.BattleMiddlePanel.Color :=  IfNotClNone(SkinManager.CurrentSkin.Options(skncWindow).Body.Color1,clBtnFace);
     BattleForm.MapPanel.Color :=  IfNotClNone(SkinManager.CurrentSkin.Options(skncWindow).Body.Color1,clBtnFace);
     BattleForm.Repaint;
@@ -1015,8 +1048,6 @@
     ReplaysForm.ScriptRichEdit.BorderStyle :=Forms.bsSingle;
     BattleForm.AutoHostMsgsRichEdit.Color := clBtnFace;
     HelpForm.TntScrollBox1.Color := clWindow;
-    AwayMessageForm.MessageRichEdit.BorderStyle := Forms.bsSingle;
-    AwayMessageForm.MessageRichEdit.Color := clWindow;
     HostInfoForm.Label3.Font.Color := clBlue;
     HostInfoForm.Label5.Font.Color := clBlue;
     BattleForm.lblEnergy.Font.Color := clBlue;
@@ -1026,7 +1057,6 @@
     MapListForm.SortLabel.Font.Color := clBlue;
     MapListForm.ScrollBox1.Color :=  clMedGray;
     MainForm.MainDockPanel.Color :=  clBtnFace;
-    UploadReplayForm.DescriptionRtBox.Font.Color := clWindowText;
     BattleForm.BattleMiddlePanel.Color :=  clBtnFace;
     BattleForm.MapPanel.Color :=  clBtnFace;
     for i := 0 to Screen.FormCount-1 do
@@ -1042,6 +1072,7 @@
   UpdateVirtualTreeSkin(ReplaysForm.VDTPlayers);
   UpdateVirtualTreeSkin(ReplaysForm.FilterList);
   UpdateVirtualTreeSkin(AddBotForm.VSTAIList);
+  UpdateVirtualTreeSkin(WidgetDBForm.vstWidgetList);
   AddBotForm.VSTAIList.Colors.FocusedSelectionColor := clHighlight;
   AddBotForm.VSTAIList.Colors.FocusedSelectionBorderColor := clHighlight;
   UpdateVirtualTreeSkin(AutoJoinForm.VSTAutoplayPresetList);
@@ -1050,9 +1081,14 @@
   UpdateVirtualTreeSkin(AddBotForm.VSTAIList);
   UpdateVirtualTreeSkin(ChannelsListForm.VDTChannels);
 
+  UpdateRichEdit(AwayMessageForm.MessageRichEdit);
   UpdateRichEdit(UploadReplayForm.DescriptionRtBox);
   UpdateExRichEdit(BattleForm.ChatRichEdit);
-  
+
+  UpdateRichEdit(WidgetDBForm.reChangelog);
+  UpdateRichEdit(WidgetDBForm.reComments);
+  UpdateRichEdit(WidgetDBForm.reMyComment);
+
   UpdateTntMemo(BattleForm.InputEdit);
   
   for i:=0 to MainForm.ChatTabs.Count-1 do
@@ -1123,11 +1159,13 @@
 begin
   if (Preferences.ThemeType = sknSkin) and Preferences.AdvancedSkinning  then
   begin
+    RE.Font.Color := SkinManager.CurrentSkin.GetTextColor(skncEditFrame,sknsNormal);
     RE.Color := IfNotClNone(SkinManager.CurrentSkin.Options(skncTabBackground).Body.Color1,clWindow);
     RE.BorderStyle := Forms.bsNone;
   end
   else
   begin
+    RE.Font.Color := clWindowText;
     RE.Color := clWindow;
     RE.BorderStyle := Forms.bsSingle;
   end;
@@ -1432,8 +1470,8 @@
 
   SetLength(ServerList,4);
 
-  ServerList[0].Name := _('Official host (taspringmaster.clan-sy.com)');
-  ServerList[0].Address := 'taspringmaster.clan-sy.com';
+  ServerList[0].Name := _('Official host (springrts.com)');
+  ServerList[0].Address := 'springrts.com';
   ServerList[0].Port := '8200';
 
   ServerList[1].Name := _('Backup server #1 (springbackup1.servegame.com )');
@@ -1848,6 +1886,11 @@
   Misc.OpenURLInDefaultBrowser('<A HREF="http://www.silverpointdevelopment.com/sptbxlib/index.htm">http://www.silverpointdevelopment.com/sptbxlib/index.htm</A>');
 end;
 
+function TPreferencesForm.isLoggedOnOfficialServer: Boolean;
+begin
+  Result := Status.LoggedIn and ((MainForm.Socket.Addr = 'taspringmaster.clan-sy.com') or (MainForm.Socket.Addr = 'springrts.com'));
+end;
+
 initialization
   SkinManager.SkinsList.AddSkin('TASClient', TSpTBXTASClientSkin);
   SkinManager.SkinsList.AddSkin('TASClient Light', TSpTBXTASClientLightSkin);

Modified: Lobby/TASClient/ReplaysUnit.dfm
===================================================================
--- Lobby/TASClient/ReplaysUnit.dfm	2010-09-20 18:08:33 UTC (rev 7516)
+++ Lobby/TASClient/ReplaysUnit.dfm	2010-11-03 17:30:45 UTC (rev 7517)
@@ -1,6 +1,6 @@
 object ReplaysForm: TReplaysForm
-  Left = 503
-  Top = 506
+  Left = 421
+  Top = 265
   Width = 859
   Height = 631
   Caption = 'Replays'
@@ -162,26 +162,6 @@
         object SpTBXTabItem1: TSpTBXTabItem
           Caption = 'Script'
         end
-        object SpTBXTabSheet1: TSpTBXTabSheet
-          Left = 0
-          Top = 23
-          Width = 677
-          Height = 186
-          Caption = 'Script'
-          ImageIndex = -1
-          TabItem = 'SpTBXTabItem1'
-          object ScriptRichEdit: TRichEdit
-            Left = 2
-            Top = 0
-            Width = 673
-            Height = 184
-            Align = alClient
-            ReadOnly = True
-            ScrollBars = ssBoth
-            TabOrder = 0
-            WordWrap = False
-          end
-        end
         object SpTBXTabSheet4: TSpTBXTabSheet
           Left = 0
           Top = 23
@@ -329,6 +309,26 @@
             end
           end
         end
+        object SpTBXTabSheet1: TSpTBXTabSheet
+          Left = 0
+          Top = 23
+          Width = 677
+          Height = 186
+          Caption = 'Script'
+          ImageIndex = -1
+          TabItem = 'SpTBXTabItem1'
+          object ScriptRichEdit: TRichEdit
+            Left = 2
+            Top = 0
+            Width = 673
+            Height = 184
+            Align = alClient
+            ReadOnly = True
+            ScrollBars = ssBoth
+            TabOrder = 0
+            WordWrap = False
+          end
+        end
         object SpTBXTabSheet2: TSpTBXTabSheet
           Left = 0
           Top = 23

Modified: Lobby/TASClient/SplashScreenUnit.pas
===================================================================
--- Lobby/TASClient/SplashScreenUnit.pas	2010-09-20 18:08:33 UTC (rev 7516)
+++ Lobby/TASClient/SplashScreenUnit.pas	2010-11-03 17:30:45 UTC (rev 7517)
@@ -40,11 +40,11 @@
   // detach form from Application and hide Application's taskbar button:
 
   with Params do begin
-    ExStyle := ExStyle or WS_EX_APPWINDOW or CS_DROPSHADOW;
+    ExStyle := ExStyle or WS_EX_APPWINDOW;// or CS_DROPSHADOW;
     WndParent := GetDesktopWindow;
   end;
   if IsWindowsXP or IsWindowsVista then
-    Params.WindowClass.Style := Params.WindowClass.Style or CS_DROPSHADOW;
+    Params.WindowClass.Style := Params.WindowClass.Style;// or CS_DROPSHADOW;
 
   SetWindowLong(Application.Handle, GWL_EXSTYLE, GetWindowLong (Application.Handle, GWL_EXSTYLE) or WS_EX_TOOLWINDOW);
 end;

Modified: Lobby/TASClient/SpringDownloaderFormUnit.dfm
===================================================================
--- Lobby/TASClient/SpringDownloaderFormUnit.dfm	2010-09-20 18:08:33 UTC (rev 7516)
+++ Lobby/TASClient/SpringDownloaderFormUnit.dfm	2010-11-03 17:30:45 UTC (rev 7517)
@@ -1,6 +1,6 @@
 object SpringDownloaderForm: TSpringDownloaderForm
-  Left = 966
-  Top = 171
+  Left = 1236
+  Top = 672
   Width = 463
   Height = 192
   Caption = 'Downloading ...'
@@ -135,4 +135,13 @@
     Left = 296
     Top = 104
   end
+  object MultisourceHttpDownloader1: TMultisourceHttpDownloader
+    PartCount = 0
+    ServerAuth = httpAuthNone
+    ProxyAuth = httpAuthNone
+    OnDisplay = MultisourceHttpDownloader1Display
+    OnRequestDone = MultisourceHttpDownloader1RequestDone
+    Left = 264
+    Top = 104
+  end
 end

Modified: Lobby/TASClient/SpringDownloaderFormUnit.pas
===================================================================
--- Lobby/TASClient/SpringDownloaderFormUnit.pas	2010-09-20 18:08:33 UTC (rev 7516)
+++ Lobby/TASClient/SpringDownloaderFormUnit.pas	2010-11-03 17:30:45 UTC (rev 7517)
@@ -7,7 +7,8 @@
   Dialogs, SpTBXItem, SpTBXControls, JclRegistry, ExtCtrls,ShellAPI,
   LobbyScriptUnit, Math, SpTBXSkins,IdHTTP, InvokeRegistry, Rio,
   SOAPHTTPClient, xmldom, XMLIntf, msxmldom, XMLDoc, OverbyteIcsHttpProt,GpIFF,RegExpr,
-  OverbyteIcsWndControl;
+  OverbyteIcsWndControl, OverbyteIcsMultisourceHttpDownloader,
+  OverbyteIcsMultipartHttpDownloader;
 
 type
   TProgressEvent = procedure(snc: PScriptDownloadCallback;progress: integer) of object;
@@ -24,6 +25,7 @@
     DetailsButton: TSpTBXButton;
     joinBattleCheckBox: TSpTBXCheckBox;
     HttpCli1: THttpCli;
+    MultisourceHttpDownloader1: TMultisourceHttpDownloader;
 
     procedure CreateParams(var Params: TCreateParams); override;
     procedure tmrProgressTimer(Sender: TObject);
@@ -35,6 +37,10 @@
     procedure HttpCli1DocData(Sender: TObject; Buffer: Pointer;
       Len: Integer);
     procedure HttpCli1DocBegin(Sender: TObject);
+    procedure MultisourceHttpDownloader1RequestDone(Sender: TObject;
+      ErrorCode: Integer; const Reason: String);
+    procedure MultisourceHttpDownloader1Display(Sender: TObject;
+      const Msg: String);
   private
     { Private declarations }
   protected
@@ -109,6 +115,9 @@
     Exit;
   end;
 
+  MultisourceHttpDownloader1.URLS.Clear;
+  MultisourceHttpDownloader1.URLS.AddStrings(downloadLinks);
+
   Randomize;
   i := RandomRange(0,downloadLinks.Count-1);
   HttpCli1.URL := downloadLinks[i];
@@ -120,31 +129,22 @@
       RegExpr.Expression := 'Content-Disposition: attachment; filename=&quot;([^&quot;]+)&quot;';
       if RegExpr.Exec(HttpCli1.RcvdHeader.Text) and (RegExpr.SubExprMatchCount = 1) then
       begin
-        fileName := ExtractFilePath(Application.ExeName)+IFF(downloadType='MAP','maps\','mods\')+RegExpr.Match[1];
+        fileName := ExtractFilePath(Application.ExeName)+IFF(downloadType='MAP','maps\','mods\')+URLDecode(RegExpr.Match[1]);
       end
       else
       begin
-        fileName := ExtractFilePath(Application.ExeName)+IFF(downloadType='MAP','maps\','mods\')+HttpCli1.DocName;
+        fileName := ExtractFilePath(Application.ExeName)+IFF(downloadType='MAP','maps\','mods\')+URLDecode(HttpCli1.DocName);
       end;
-      HttpCli1.Get;
+      HttpCli1.Abort;
+
       try
-        HttpCli1.RcvdStream.Destroy;
+        MultisourceHttpDownloader1.FileStream := TFileStream.Create(fileName,fmCreate or fmOpenWrite);
       except
+        lblInfo.Caption := _('Unable to create file: ') + fileName + _('. Download cancelled!');
+        lblInfo.Font.Color := clRed;
+        Exit;
       end;
-      HttpCli1.RcvdStream := nil;
-      lblInfo.Caption := _('Done.');
-      if Assigned(FOnProgress) then
-        FOnProgress(cbInfo,-1);
-      If downloadType = 'MAP' then
-        BattleForm.ReloadMapListButtonClick(nil);
-      if joinBattleCheckBox.Checked then
-      begin
-        battle := MainForm.GetBattle(joinBattleId);
-        if battle &lt;&gt; nil then
-          MainForm.JoinBattle(battle);
-      end;
-      Close;
-      Exit;
+      MultisourceHttpDownloader1.Start;
   except
     TryNextLink;
   end;
@@ -174,6 +174,8 @@
   ShowAndSetFocus(CancelButton);
   downloadLinks := GetDownloadLinks(dlName);
 
+  tmrProgress.Enabled := True;
+
   TryNextLink;
 
   Exit;
@@ -274,9 +276,10 @@
     linksNode := xmlDoc.DocumentElement.ChildNodes.FindNode('soap:Body').ChildNodes.First.ChildNodes.FindNode('links');
     for i:=0 to linksNode.ChildNodes.Count-1 do
     begin
-      result.Add(linksNode.ChildNodes.Nodes[i].Text);
+      result.Add(StringReplace(linksNode.ChildNodes.Nodes[i].Text,' ','%20',[rfReplaceAll]));
     end;
   except
+    MainForm.AddMainLog('SpringDownloader server unavailable.',Colors.Error);
   end;
 end;
 
@@ -319,39 +322,18 @@
 
 procedure TSpringDownloaderForm.tmrProgressTimer(Sender: TObject);
 var
-  sl: TStringList;
-  path : string;
-  battle : TBattle;
+  remainingMS: integer;
 begin
-  path := StringReplace(ExtractFilePath(Application.ExeName),'\','/',[rfReplaceAll]);
-  path := LeftStr(path,Length(path)-1);
-  sl := TStringList.Create;
+  remainingMS := Floor(min(86400,(MultisourceHttpDownloader1.ContentLength-MultisourceHttpDownloader1.TotalCount)/(1024*MultisourceHttpDownloader1.CurSpeed/8)));
+  ProgressBar.Position := Floor(MultisourceHttpDownloader1.PercentDone);
   try
-    RegReadMultiSz(HKCU,'\Software\SpringDownloader\'+path+'\transfer',downloadName,sl);
-    downloading := true;
-    ProgressBar.Position := Round(StrToFloat(StringReplace(sl[3],',','.',[rfReplaceAll])));
-    lblInfo.Caption := Format(_('Downloading %s ...'),[sl[2]]);
-    lblRemainingTime.Caption := _('Remaining time : ')+sl[4];
-    lblProgress.Caption := _('Progress : ')+sl[5];
-    if Assigned(FOnProgress) then
-      FOnProgress(cbInfo,Floor(100*ProgressBar.Position/ProgressBar.Max));
+    lblProgress.Caption := _('Progress : ')+Format(_('Received %s (%d%%)'),[Misc.FormatFileSize3([Integer(MultisourceHttpDownloader1.TotalCount),Integer(MultisourceHttpDownloader1.ContentLength)],'%s/%s %u'),Round(MultisourceHttpDownloader1.PercentDone)])+' '+Format(_(' - %dkB/s'),[Round(MultisourceHttpDownloader1.CurSpeed/8)]);
+    if remainingMS &gt; 60 then
+      lblRemainingTime.Caption := _('Remaining time : ')+Format('%d min %d seconds',[remainingMS div 60,remainingMS mod 60])
+    else
+      lblRemainingTime.Caption := _('Remaining time : ')+Format('%d seconds',[remainingMS]);
   except
-    if downloading then // if download complete
-    begin
-      tmrProgress.Enabled := False;
-      if Assigned(FOnProgress) then
-        FOnProgress(cbInfo,-1);
-      If downloadType = 'MAP' then
-        BattleForm.ReloadMapListButtonClick(nil);
-      if joinBattleCheckBox.Checked then
-      begin
-        battle := MainForm.GetBattle(joinBattleId);
-        if battle &lt;&gt; nil then
-          MainForm.JoinBattle(battle);
-      end;
-      Close;
-      Exit;
-    end;
+    lblProgress.Caption := 'Progress : '+Format('Received %s (%d%%)',[Misc.FormatFileSize3([Integer(MultisourceHttpDownloader1.TotalCount),Integer(MultisourceHttpDownloader1.ContentLength)],'%s/%s %u'),Round(MultisourceHttpDownloader1.PercentDone)])+' '+Format(' - %dkB/s',[Round(MultisourceHttpDownloader1.CurSpeed/8)]);
   end;
 end;
 
@@ -426,6 +408,7 @@
       if HttpCli1.RcvdStream &lt;&gt; nil then
         HttpCli1.RcvdStream.Destroy;
       HttpCli1.RcvdStream := nil;
+      MultisourceHttpDownloader1.FileStream.Destroy;
       if FileExists(fileName) then
         DeleteFile(filename);
     except
@@ -526,4 +509,50 @@
   end;
 end;
 
+procedure TSpringDownloaderForm.MultisourceHttpDownloader1RequestDone(
+  Sender: TObject; ErrorCode: Integer; const Reason: String);
+var
+  battle: TBattle;
+begin
+  tmrProgress.Enabled := False;
+
+  if ErrorCode &lt;&gt; 200 then
+  begin
+    MultisourceHttpDownloader1.FileStream.Destroy;
+    if FileExists(fileName) then
+      DeleteFile(fileName);
+    lblInfo.Caption := _('Download failed (')+downloadName+')';
+    lblInfo.Font.Color := clRed;
+    CancelButton.Caption := _('Exit');
+    if Assigned(FOnProgress) then
+      FOnProgress(cbInfo,-2);
+    Exit;
+  end;
+
+  try
+    MultisourceHttpDownloader1.FileStream.Destroy;
+  except
+  end;
+  MultisourceHttpDownloader1.FileStream := nil;
+  lblInfo.Caption := _('Done.');
+  if Assigned(FOnProgress) then
+    FOnProgress(cbInfo,-1);
+  If downloadType = 'MAP' then
+    BattleForm.ReloadMapListButtonClick(nil);
+  if joinBattleCheckBox.Checked then
+  begin
+    battle := MainForm.GetBattle(joinBattleId);
+    if battle &lt;&gt; nil then
+      MainForm.JoinBattle(battle);
+  end;
+  Close;
+end;
+
+procedure TSpringDownloaderForm.MultisourceHttpDownloader1Display(
+  Sender: TObject; const Msg: String);
+begin
+  if Debug.Enabled then
+    MainForm.AddMainLog(Msg,Colors.Info);
+end;
+
 end.

Modified: Lobby/TASClient/TASClient.cfg
===================================================================
--- Lobby/TASClient/TASClient.cfg	2010-09-20 18:08:33 UTC (rev 7516)
+++ Lobby/TASClient/TASClient.cfg	2010-11-03 17:30:45 UTC (rev 7517)
@@ -1,6 +1,6 @@
 -$A8
 -$B-
--$C-
+-$C+
 -$D+
 -$E-
 -$F-
@@ -22,7 +22,7 @@
 -$V+
 -$W-
 -$X+
--$Y-
+-$YD
 -$Z1
 -GD
 -cg

Modified: Lobby/TASClient/TASClient.dof
===================================================================
--- Lobby/TASClient/TASClient.dof	2010-09-20 18:08:33 UTC (rev 7516)
+++ Lobby/TASClient/TASClient.dof	2010-11-03 17:30:45 UTC (rev 7517)
@@ -3,7 +3,7 @@
 [Compiler]
 A=8
 B=0
-C=0
+C=1
 D=1
 E=0
 F=0
@@ -25,7 +25,7 @@
 V=1
 W=0
 X=1
-Y=0
+Y=1
 Z=1
 ShowHints=0
 ShowWarnings=0
@@ -100,7 +100,7 @@
 DebugSourceDirs=
 UsePackages=0
 [Parameters]
-RunParams=-IGNOREVERSION
+RunParams=
 HostApplication=C:\Program Files\Spring\TASClient.exe
 Launcher=
 UseLauncher=0
@@ -115,7 +115,7 @@
 MajorVer=0
 MinorVer=78
 Release=0
-Build=989
+Build=1012
 Debug=0
 PreRelease=0
 Special=0
@@ -126,7 +126,7 @@
 [Version Info Keys]
 CompanyName=
 FileDescription=Spring RTS Engine lobby client
-FileVersion=0.78.0.989
+FileVersion=0.78.0.1012
 InternalName=
 LegalCopyright=
 LegalTrademarks=
@@ -134,6 +134,15 @@
 ProductName=TASClient
 ProductVersion=1.0.0.0
 Comments=
+[HistoryLists\hlConditionals]
+Count=1
+Item0=SYSTEM_GRADIENT
 [HistoryLists\hlUnitAliases]
 Count=1
 Item0=WinTypes=Windows;WinProcs=Windows;DbiTypes=BDE;DbiProcs=BDE;DbiErrs=BDE;
+[HistoryLists\hlSearchPath]
+Count=1
+Item0=hics32-1_5_1
+[HistoryLists\hlOutputDirectorry]
+Count=1
+Item0=C:\Program Files\Spring

Modified: Lobby/TASClient/TASClient.dpr
===================================================================
--- Lobby/TASClient/TASClient.dpr	2010-09-20 18:08:33 UTC (rev 7516)
+++ Lobby/TASClient/TASClient.dpr	2010-11-03 17:30:45 UTC (rev 7517)
@@ -96,7 +96,8 @@
   ChannelsListFormUnit in 'ChannelsListFormUnit.pas' {ChannelsListForm},
   SpTBXSkins,
   BotOptionsFormUnit in 'BotOptionsFormUnit.pas' {BotOptionsForm},
-  gnugettext in 'C:\Program Files\dxgettext\gnugettext.pas';
+  gnugettext in 'C:\Program Files\dxgettext\gnugettext.pas',
+  WidgetDBFormUnit in 'WidgetDBFormUnit.pas' {WidgetDBForm};
 
 var
   i: Integer;
@@ -376,6 +377,9 @@
   if MainUnit.Debug.Enabled then
     Misc.TryToAddLog(MainUnit.StartDebugLog,'Creating AutoJoinForm ...');
   Application.CreateForm(TAutoJoinForm, AutoJoinForm);
+  if MainUnit.Debug.Enabled then
+    Misc.TryToAddLog(MainUnit.StartDebugLog,'Creating WidgetDBForm ...');
+  Application.CreateForm(TWidgetDBForm, WidgetDBForm);
   if MainUnit.RunningWithMainMenu then
   begin
     if MainUnit.Debug.Enabled then

Modified: Lobby/TASClient/TASClient.res
===================================================================
(Binary files differ)

Modified: Lobby/TASClient/UploadReplayUnit.dfm
===================================================================
--- Lobby/TASClient/UploadReplayUnit.dfm	2010-09-20 18:08:33 UTC (rev 7516)
+++ Lobby/TASClient/UploadReplayUnit.dfm	2010-11-03 17:30:45 UTC (rev 7517)
@@ -1,6 +1,6 @@
 object UploadReplayForm: TUploadReplayForm
-  Left = 1041
-  Top = 285
+  Left = 500
+  Top = 334
   Width = 486
   Height = 354
   Caption = 'Upload replay'
@@ -127,7 +127,7 @@
     Top = 208
   end
   object IdAntiFreeze1: TIdAntiFreeze
-    Left = 24
-    Top = 112
+    Left = 56
+    Top = 120
   end
 end

Modified: Lobby/TASClient/UploadReplayUnit.pas
===================================================================
--- Lobby/TASClient/UploadReplayUnit.pas	2010-09-20 18:08:33 UTC (rev 7516)
+++ Lobby/TASClient/UploadReplayUnit.pas	2010-11-03 17:30:45 UTC (rev 7517)
@@ -70,7 +70,7 @@
 
 procedure TUploadReplayForm.UploadButtonClick(Sender: TObject);
 begin
-  if not (Status.LoggedIn and (MainForm.Socket.Addr = 'taspringmaster.clan-sy.com')) then
+  if not PreferencesForm.isLoggedOnOfficialServer then
   begin
     MessageDlg(_('You need to be logged into the official server to be able to upload replays using the lobby.'),mtWarning,[mbOk],0);
     Exit;

Added: Lobby/TASClient/WidgetDBFormUnit.dfm
===================================================================
--- Lobby/TASClient/WidgetDBFormUnit.dfm	                        (rev 0)
+++ Lobby/TASClient/WidgetDBFormUnit.dfm	2010-11-03 17:30:45 UTC (rev 7517)
@@ -0,0 +1,501 @@
+object WidgetDBForm: TWidgetDBForm
+  Left = 296
+  Top = 537
+  Width = 835
+  Height = 603
+  Caption = 'Widget database'
+  Color = clBtnFace
+  Font.Charset = DEFAULT_CHARSET
+  Font.Color = clWindowText
+  Font.Height = -11
+  Font.Name = 'MS Sans Serif'
+  Font.Style = []
+  OldCreateOrder = False
+  Scaled = False
+  OnCreate = FormCreate
+  OnShow = FormShow
+  PixelsPerInch = 96
+  TextHeight = 13
+  object SpTBXTitleBar1: TSpTBXTitleBar
+    Left = 0
+    Top = 0
+    Width = 827
+    Height = 576
+    Caption = 'Widget database'
+    Active = False
+    object pnlMain: TSpTBXPanel
+      Left = 0
+      Top = 22
+      Width = 827
+      Height = 554
+      Caption = 'pnlMain'
+      Align = alClient
+      TabOrder = 1
+      Borders = False
+      TBXStyleBackground = True
+      object SpTBXSplitter1: TSpTBXSplitter
+        Left = 0
+        Top = 176
+        Width = 827
+        Height = 9
+        Cursor = crSizeNS
+        Align = alBottom
+      end
+      object vstWidgetList: TVirtualStringTree
+        Left = 0
+        Top = 25
+        Width = 827
+        Height = 151
+        Align = alClient
+        CheckImageKind = ckSystemFlat
+        Header.AutoSizeIndex = 0
+        Header.DefaultHeight = 17
+        Header.Font.Charset = DEFAULT_CHARSET
+        Header.Font.Color = clWindowText
+        Header.Font.Height = -11
+        Header.Font.Name = 'MS Sans Serif'
+        Header.Font.Style = []
+        Header.Options = [hoAutoResize, hoColumnResize, hoDrag, hoHotTrack, hoOwnerDraw, hoShowSortGlyphs, hoVisible]
+        Header.SortColumn = 0
+        Header.Style = hsFlatButtons
+        TabOrder = 1
+        TreeOptions.AutoOptions = [toAutoDropExpand, toAutoScrollOnExpand, toAutoSort, toAutoTristateTracking, toAutoDeleteMovedNodes]
+        TreeOptions.PaintOptions = [toHotTrack, toShowButtons, toShowDropmark, toThemeAware, toUseBlendedImages]
+        TreeOptions.SelectionOptions = [toFullRowSelect]
+        OnCompareNodes = vstWidgetListCompareNodes
+        OnDrawText = vstWidgetListDrawText
+        OnFocusChanged = vstWidgetListFocusChanged
+        OnGetText = vstWidgetListGetText
+        OnPaintText = vstWidgetListPaintText
+        OnHeaderClick = vstWidgetListHeaderClick
+        OnHeaderDraw = vstWidgetListHeaderDraw
+        Columns = &lt;
+          item
+            Position = 1
+            Style = vsOwnerDraw
+            Width = 168
+            WideText = 'Name'
+          end
+          item
+            Position = 2
+            Style = vsOwnerDraw
+            Width = 100
+            WideText = 'Category'
+          end
+          item
+            Position = 3
+            Style = vsOwnerDraw
+            WideText = 'DLs'
+          end
+          item
+            Position = 4
+            Style = vsOwnerDraw
+            Width = 100
+            WideText = 'Games'
+          end
+          item
+            Position = 5
+            Style = vsOwnerDraw
+            Width = 45
+            WideText = 'Rating'
+          end
+          item
+            Position = 7
+            Style = vsOwnerDraw
+            WideText = 'Comments'
+          end
+          item
+            Position = 8
+            Style = vsOwnerDraw
+            Width = 125
+            WideText = 'Author'
+          end
+          item
+            Position = 9
+            Style = vsOwnerDraw
+            Width = 120
+            WideText = 'Entry date'
+          end
+          item
+            CheckBox = True
+            MaxWidth = 20
+            MinWidth = 20
+            Position = 0
+            Style = vsOwnerDraw
+            Width = 20
+            WideText = 'Installed'
+          end
+          item
+            Position = 6
+            Width = 45
+            WideText = 'Votes'
+          end&gt;
+      end
+      object pnlWidgetInfo: TSpTBXPanel
+        Left = 0
+        Top = 185
+        Width = 827
+        Height = 369
+        Align = alBottom
+        TabOrder = 2
+        Borders = False
+        TBXStyleBackground = True
+        object pnlMiddle: TSpTBXPanel
+          Left = 0
+          Top = 0
+          Width = 827
+          Height = 38
+          Caption = 'pnlMiddle'
+          Align = alTop
+          TabOrder = 0
+          Borders = False
+          BorderType = pbrFramed
+          TBXStyleBackground = True
+          object lblWidgetName: TSpTBXLabel
+            Left = 0
+            Top = 4
+            Width = 0
+            Height = 0
+            Font.Charset = DEFAULT_CHARSET
+            Font.Color = clWindowText
+            Font.Height = -24
+            Font.Name = 'MS Sans Serif'
+            Font.Style = []
+            ParentFont = False
+          end
+          object btUninstall: TSpTBXButton
+            Left = 485
+            Top = 0
+            Width = 171
+            Height = 38
+            Caption = 'Uninstall'
+            Align = alRight
+            Enabled = False
+            TabOrder = 2
+            OnClick = btUninstallClick
+          end
+          object btInstall: TSpTBXButton
+            Left = 656
+            Top = 0
+            Width = 171
+            Height = 38
+            Caption = 'Install'
+            Align = alRight
+            TabOrder = 1
+            OnClick = btInstallClick
+          end
+          object gbRate: TSpTBXGroupBox
+            Left = 376
+            Top = 0
+            Width = 109
+            Height = 38
+            Caption = 'Rate'
+            Align = alRight
+            TabOrder = 3
+            object btRate5: TSpTBXButton
+              Left = 86
+              Top = 15
+              Width = 21
+              Height = 21
+              Caption = '5'
+              Align = alLeft
+              TabOrder = 0
+              OnClick = btRate5Click
+            end
+            object btRate4: TSpTBXButton
+              Left = 65
+              Top = 15
+              Width = 21
+              Height = 21
+              Caption = '4'
+              Align = alLeft
+              TabOrder = 1
+              OnClick = btRate4Click
+            end
+            object btRate3: TSpTBXButton
+              Left = 44
+              Top = 15
+              Width = 21
+              Height = 21
+              Caption = '3'
+              Align = alLeft
+              TabOrder = 2
+              OnClick = btRate3Click
+            end
+            object btRate2: TSpTBXButton
+              Left = 23
+              Top = 15
+              Width = 21
+              Height = 21
+              Caption = '2'
+              Align = alLeft
+              TabOrder = 3
+              OnClick = btRate2Click
+            end
+            object btRate1: TSpTBXButton
+              Left = 2
+              Top = 15
+              Width = 21
+              Height = 21
+              Caption = '1'
+              Align = alLeft
+              TabOrder = 4
+              OnClick = btRate1Click
+            end
+          end
+        end
+        object SpTBXSplitter2: TSpTBXSplitter
+          Left = 0
+          Top = 38
+          Width = 827
+          Height = 9
+          Cursor = crSizeNS
+          Align = alTop
+          Visible = False
+        end
+        object tcWidgetInfo: TSpTBXTabControl
+          Left = 0
+          Top = 47
+          Width = 827
+          Height = 322
+          Align = alClient
+          ActiveTabIndex = 0
+          HiddenItems = &lt;&gt;
+          object tabWidgetDescription: TSpTBXTabItem
+            Caption = 'Description'
+            Checked = True
+          end
+          object tabWidgetChangelog: TSpTBXTabItem
+            Caption = 'Changelog'
+          end
+          object tabWidgetComments: TSpTBXTabItem
+            Caption = 'Comments'
+          end
+          object tsWidgetChangelog: TSpTBXTabSheet
+            Left = 0
+            Top = 23
+            Width = 827
+            Height = 299
+            Caption = 'Changelog'
+            ImageIndex = -1
+            TabItem = 'tabWidgetChangelog'
+            object reChangelog: TRichEdit
+              Left = 2
+              Top = 0
+              Width = 823
+              Height = 297
+              Align = alClient
+              BevelInner = bvNone
+              BevelOuter = bvNone
+              ReadOnly = True
+              ScrollBars = ssVertical
+              TabOrder = 0
+            end
+          end
+          object tsWidgetComments: TSpTBXTabSheet
+            Left = 0
+            Top = 23
+            Width = 827
+            Height = 299
+            Caption = 'Comments'
+            ImageIndex = -1
+            TabItem = 'tabWidgetComments'
+            object reComments: TRichEdit
+              Left = 2
+              Top = 0
+              Width = 823
+              Height = 258
+              Align = alClient
+              ReadOnly = True
+              ScrollBars = ssVertical
+              TabOrder = 0
+            end
+            object pnlPostComment: TSpTBXPanel
+              Left = 2
+              Top = 258
+              Width = 823
+              Height = 39
+              Align = alBottom
+              TabOrder = 1
+              TBXStyleBackground = True
+              object reMyComment: TRichEdit
+                Left = 2
+                Top = 2
+                Width = 740
+                Height = 35
+                Align = alClient
+                ScrollBars = ssVertical
+                TabOrder = 0
+              end
+              object btSendComment: TSpTBXButton
+                Left = 742
+                Top = 2
+                Width = 79
+                Height = 35
+                Caption = 'Send'
+                Align = alRight
+                TabOrder = 1
+                OnClick = btSendCommentClick
+              end
+            end
+          end
+          object tsWidgetDescription: TSpTBXTabSheet
+            Left = 0
+            Top = 23
+            Width = 827
+            Height = 299
+            Caption = 'Description'
+            ImageIndex = -1
+            TabItem = 'tabWidgetDescription'
+          end
+        end
+      end
+      object mmDescriptionHtml: TMemo
+        Left = 96
+        Top = 272
+        Width = 281
+        Height = 81
+        Lines.Strings = (
+          '&lt;html&gt;'
+          '        &lt;head&gt;'
+          '                &lt;style type=&quot;text/css&quot;&gt;'
+          '                        body {'
+          '                                background-color: $bgcolor;'
+          '                                color: $textcolor;'
+          '                                font-family: Arial;'
+          '                                overflow: auto;'
+          '                        }'
+          '                        a:link {color: $linkcolor;}'
+          '                        a:visited {color: $linkcolor;}'
+          '                        a:hover {color: $linkcolor;}'
+          '                        a:active {color: $linkcolor;}'
+          '                &lt;/style&gt;'
+          '        &lt;/head&gt;'
+          '        &lt;body&gt;'
+          '        $content'
+          '        &lt;/body&gt;'
+          '&lt;/html&gt;')
+        TabOrder = 3
+        Visible = False
+      end
+      object mmScreenshotsHtml: TMemo
+        Left = 384
+        Top = 272
+        Width = 281
+        Height = 81
+        Lines.Strings = (
+          '&lt;html&gt;'
+          '        &lt;head&gt;'
+          '                &lt;style type=&quot;text/css&quot;&gt;'
+          '                        body {'
+          '                                background-color: $bgcolor;'
+          '                                color: $textcolor;'
+          '                                font-family: Arial;'
+          '                                overflow: auto;'
+          '                                margin: 0;'
+          '                        }'
+          '                        a:link {color: $linkcolor;}'
+          '                        a:visited {color: $linkcolor;}'
+          '                        a:hover {color: $linkcolor;}'
+          '                        a:active {color: $linkcolor;}'
+          '                        img.ScreenshotItem {'
+          '                                height: 100%;'
+          '                                width: auto;'
+          '                                margin-right: 4px;'
+          '                                margin-bottom: -4px;'
+          '                        }'
+          '                        a img {'
+          '                                border: 0;'
+          '                        }'
+          '                &lt;/style&gt;'
+          '        &lt;/head&gt;'
+          '        &lt;body&gt;'
+          '        $content'
+          '        &lt;/body&gt;'
+          '&lt;/html&gt;')
+        TabOrder = 4
+        Visible = False
+      end
+      object pnlTop: TSpTBXPanel
+        Left = 0
+        Top = 0
+        Width = 827
+        Height = 25
+        Align = alTop
+        TabOrder = 5
+        BorderType = pbrFramed
+        TBXStyleBackground = True
+        object btRefresh: TSpTBXButton
+          Left = 654
+          Top = 2
+          Width = 171
+          Height = 21
+          Caption = 'Refresh'
+          Align = alRight
+          TabOrder = 0
+          OnClick = btRefreshClick
+        end
+        object lblFilter: TSpTBXLabel
+          Left = 2
+          Top = 2
+          Width = 71
+          Height = 21
+          Caption = 'Filter :'
+          Align = alLeft
+          AutoSize = False
+          Alignment = taRightJustify
+        end
+        object txtFilter: TSpTBXButtonEdit
+          Left = 80
+          Top = 2
+          Width = 225
+          Height = 21
+          TabOrder = 2
+          OnChange = txtFilterChange
+          EditButton.Left = 202
+          EditButton.Top = 0
+          EditButton.Width = 19
+          EditButton.Height = 17
+          EditButton.Caption = 'X'
+          EditButton.Align = alRight
+          EditButton.OnClick = txtFilterSubEditButton0Click
+        end
+      end
+    end
+    object mmScreenshotItemHtml: TMemo
+      Left = 384
+      Top = 384
+      Width = 281
+      Height = 81
+      Lines.Strings = (
+        '&lt;a href=&quot;$url&quot;&gt;&lt;img class=&quot;ScreenshotItem&quot; src=&quot;$url&quot; '
+        'alt=&quot;Screen Shot&quot;/&gt;&lt;/a&gt;')
+      TabOrder = 2
+      Visible = False
+    end
+  end
+  object IdAntiFreeze1: TIdAntiFreeze
+    Left = 56
+    Top = 120
+  end
+  object IdHTTP1: TIdHTTP
+    MaxLineLength = 32768
+    MaxLineAction = maException
+    ReadTimeout = 0
+    RecvBufferSize = 65536
+    SendBufferSize = 65536
+    AllowCookies = True
+    ProxyParams.BasicAuthentication = False
+    ProxyParams.ProxyPort = 0
+    Request.ContentLength = -1
+    Request.ContentRangeEnd = 0
+    Request.ContentRangeStart = 0
+    Request.ContentType = 'text/html'
+    Request.Accept = 'text/html, */*'
+    Request.BasicAuthentication = False
+    Request.UserAgent = 'Mozilla/3.0 (compatible; Indy Library)'
+    HTTPOptions = [hoForceEncodeParams]
+    Left = 344
+    Top = 128
+  end
+end

Added: Lobby/TASClient/WidgetDBFormUnit.pas
===================================================================
--- Lobby/TASClient/WidgetDBFormUnit.pas	                        (rev 0)
+++ Lobby/TASClient/WidgetDBFormUnit.pas	2010-11-03 17:30:45 UTC (rev 7517)
@@ -0,0 +1,1263 @@
+unit WidgetDBFormUnit;
+
+interface
+
+uses
+  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
+  Dialogs, SpTBXItem, gnugettext, SpTBXControls, StdCtrls, TntStdCtrls,
+  SpTBXEditors, SpTBXDkPanels, OleCtrls, SHDocVw, VirtualTrees, xmldom,
+  XMLIntf, msxmldom, XMLDoc, SpTBXSkins, GpIFF, UWebBrowserWrapper,ActiveX,
+  JclUnicode, SpTBXTabs, TB2Item, ComCtrls, OverbyteIcsWndControl,
+  OverbyteIcsHttpProt, IdComponent, IdTCPConnection, IdTCPClient, IdHTTP,
+  IdBaseComponent, IdAntiFreezeBase, IdAntiFreeze, MsMultiPartFormData;
+
+type
+  TWidgetCategory = class
+  protected
+    Id: integer;
+    Name: WideString;
+  end;
+
+  TWidgetItem = class
+  protected
+    Id : integer;
+    Name : WideString;
+    NameId : Integer;
+    Downloads : integer;
+    Games : WideString;
+    Rating : Extended;
+    VoteCount : integer;
+    Comments : integer;
+    Author : WideString;
+    Description: WideString;
+    Category: TWidgetCategory;
+    Entry: WideString;
+    Node: PVirtualNode;
+    NodeAdded: Boolean;
+    Changelog: WideString;
+    Installed: Boolean;
+  end;
+
+  TRefreshWidgetListThread = class(TThread)
+  protected
+    procedure Execute; override;
+    procedure UpdateList;
+
+  public
+    constructor Create(Suspended : Boolean);
+  end;
+
+  TUpdateWidgetInfoThread = class(TThread)
+  protected
+    FWidget: TWidgetItem;
+    FDisplayWB: boolean;
+    FResultHtml: WideString;
+    FComments: WideString;
+    procedure Execute; override;
+    procedure UpdateWBHtml;
+    procedure UpdateComments;
+
+  public
+    constructor Create(Suspended : Boolean; widget : TWidgetItem);
+  end;
+
+  TInstallWidgetThread = class(TThread)
+  protected
+    FWidget: TWidgetItem;
+    FUninstall: Boolean;
+    procedure Execute; override;
+    procedure UpdateGUI;
+
+  public
+    constructor Create(Suspended : Boolean; widget : TWidgetItem; uninstall: boolean);
+  end;
+
+  TSendCommentThread = class(TThread)
+  protected
+    FWidget: TWidgetItem;
+    FComment: WideString;
+    procedure Execute; override;
+    procedure UpdateGUI;
+
+  public
+    constructor Create(Suspended : Boolean; widget : TWidgetItem; comment: WideString);
+  end;
+
+  TRateThread = class(TThread)
+  protected
+    FWidget: TWidgetItem;
+    FRate: Byte;
+    procedure Execute; override;
+    procedure UpdateGUI;
+
+  public
+    constructor Create(Suspended : Boolean; widget : TWidgetItem; rate: Byte);
+  end;
+
+  TWidgetDBForm = class(TForm)
+    SpTBXTitleBar1: TSpTBXTitleBar;
+    pnlMain: TSpTBXPanel;
+    SpTBXSplitter1: TSpTBXSplitter;
+    vstWidgetList: TVirtualStringTree;
+    pnlWidgetInfo: TSpTBXPanel;
+    pnlMiddle: TSpTBXPanel;
+    lblWidgetName: TSpTBXLabel;
+    SpTBXSplitter2: TSpTBXSplitter;
+    mmDescriptionHtml: TMemo;
+    mmScreenshotsHtml: TMemo;
+    mmScreenshotItemHtml: TMemo;
+    pnlTop: TSpTBXPanel;
+    btRefresh: TSpTBXButton;
+    lblFilter: TSpTBXLabel;
+    txtFilter: TSpTBXButtonEdit;
+    tcWidgetInfo: TSpTBXTabControl;
+    tabWidgetDescription: TSpTBXTabItem;
+    tsWidgetDescription: TSpTBXTabSheet;
+    tabWidgetChangelog: TSpTBXTabItem;
+    tsWidgetChangelog: TSpTBXTabSheet;
+    tabWidgetComments: TSpTBXTabItem;
+    tsWidgetComments: TSpTBXTabSheet;
+    reChangelog: TRichEdit;
+    reComments: TRichEdit;
+    btInstall: TSpTBXButton;
+    btUninstall: TSpTBXButton;
+    pnlPostComment: TSpTBXPanel;
+    reMyComment: TRichEdit;
+    btSendComment: TSpTBXButton;
+    IdAntiFreeze1: TIdAntiFreeze;
+    IdHTTP1: TIdHTTP;
+    gbRate: TSpTBXGroupBox;
+    btRate5: TSpTBXButton;
+    btRate4: TSpTBXButton;
+    btRate3: TSpTBXButton;
+    btRate2: TSpTBXButton;
+    btRate1: TSpTBXButton;
+
+    procedure CreateParams(var Params: TCreateParams); override;
+    procedure FormCreate(Sender: TObject);
+    procedure vstWidgetListGetText(Sender: TBaseVirtualTree;
+      Node: PVirtualNode; Column: TColumnIndex; TextType: TVSTTextType;
+      var CellText: WideString);
+    procedure vstWidgetListPaintText(Sender: TBaseVirtualTree;
+      const TargetCanvas: TCanvas; Node: PVirtualNode;
+      Column: TColumnIndex; TextType: TVSTTextType);
+    procedure vstWidgetListDrawText(Sender: TBaseVirtualTree;
+      TargetCanvas: TCanvas; Node: PVirtualNode; Column: TColumnIndex;
+      const Text: WideString; const CellRect: TRect;
+      var DefaultDraw: Boolean);
+    procedure vstWidgetListHeaderClick(Sender: TVTHeader;
+      HitInfo: TVTHeaderHitInfo);
+    procedure vstWidgetListHeaderDraw(Sender: TVTHeader;
+      HeaderCanvas: TCanvas; Column: TVirtualTreeColumn; R: TRect; Hover,
+      Pressed: Boolean; DropMark: TVTDropMarkMode);
+    procedure vstWidgetListCompareNodes(Sender: TBaseVirtualTree; Node1,
+      Node2: PVirtualNode; Column: TColumnIndex; var Result: Integer);
+    procedure FormShow(Sender: TObject);
+    procedure OnWebBrowsersBeforeNavigate2(Sender: TObject;
+      const pDisp: IDispatch; var URL, Flags, TargetFrameName, PostData,
+      Headers: OleVariant; var Cancel: WordBool);
+    procedure OnWebBrowsersNewWindow2(Sender: TObject;
+      var ppDisp: IDispatch; var Cancel: WordBool);
+    procedure txtFilterChange(Sender: TObject);
+    procedure txtFilterSubEditButton0Click(Sender: TObject);
+    procedure btRefreshClick(Sender: TObject);
+    procedure vstWidgetListFocusChanged(Sender: TBaseVirtualTree;
+      Node: PVirtualNode; Column: TColumnIndex);
+    procedure btInstallClick(Sender: TObject);
+    procedure btUninstallClick(Sender: TObject);
+    procedure btSendCommentClick(Sender: TObject);
+    procedure btRate1Click(Sender: TObject);
+    procedure btRate2Click(Sender: TObject);
+    procedure btRate3Click(Sender: TObject);
+    procedure btRate4Click(Sender: TObject);
+    procedure btRate5Click(Sender: TObject);
+  private
+    { Private declarations }
+  public
+    widgetList: TList;
+    widgetCategoryList: TList;
+    noneCategory: TWidgetCategory;
+    wbDescription: TWebBrowserWrapper;
+    wbScreenShots: TWebBrowserWrapper;
+    uwiThread : TUpdateWidgetInfoThread;
+
+    function GetWidgetByNode(Node : PVirtualNode): TWidgetItem;
+    function SelectWidget(Node : PVirtualNode): boolean;
+    function GetSkinnedHtmlDescription(description: WideString): WideString;
+    function ReplaceCommonVars(htmlCode: WideString): WideString;
+    procedure FilterWidgetListDisplay(filter: WideString);
+    function GetCategoryById(id: integer): TWidgetCategory;
+    function GetWidgetById(id: integer): TWidgetItem;
+    procedure RateWidget(rate: Byte);
+  end;
+var
+  WidgetDBForm: TWidgetDBForm;
+
+implementation
+
+uses PreferencesFormUnit, Misc, MainUnit, Math, ComObj, StrUtils;
+
+{$R *.dfm}
+
+procedure TWidgetDBForm.FormCreate(Sender: TObject);
+begin
+  TranslateComponent(self);
+  FixFormSizeConstraints(WidgetDBForm);
+
+  widgetList := TList.Create;
+  widgetCategoryList := TList.Create;
+  noneCategory := TWidgetCategory.Create;
+  noneCategory.Id := -1;
+  noneCategory.Name := ' ';
+  uwiThread := nil;
+
+  wbScreenShots := TWebBrowserWrapper.Create(Self);
+  TWinControl(wbScreenShots).Parent := pnlWidgetInfo;
+  TWinControl(wbScreenShots).Align := alBottom;
+  TWinControl(wbScreenShots).Height := 180;
+  wbScreenShots.Show3DBorder := False;
+  wbScreenShots.OnBeforeNavigate2 := OnWebBrowsersBeforeNavigate2;
+  wbScreenShots.OnNewWindow2 := OnWebBrowsersNewWindow2;
+
+  SpTBXSplitter2.Align := alBottom;
+
+  TWinControl(wbScreenShots).Visible := False;
+  SpTBXSplitter2.Visible := False;
+
+  wbDescription := TWebBrowserWrapper.Create(Self);
+  TWinControl(wbDescription).Parent := tsWidgetDescription;
+  TWinControl(wbDescription).Align := alClient;
+  wbDescription.Show3DBorder := False;
+  wbDescription.OnBeforeNavigate2 := OnWebBrowsersBeforeNavigate2;
+  wbDescription.OnNewWindow2 := OnWebBrowsersNewWindow2;
+end;
+
+procedure TWidgetDBForm.CreateParams(var Params: TCreateParams);
+begin
+  inherited CreateParams(Params);
+
+  if not PreferencesFormUnit.Preferences.TaskbarButtons then Exit;
+
+  with Params do begin
+    ExStyle := ExStyle or WS_EX_APPWINDOW;
+    WndParent := GetDesktopWindow;
+  end;
+end;
+
+function TWidgetDBForm.GetWidgetByNode(Node : PVirtualNode): TWidgetItem;
+var
+  i: Integer;
+begin
+  Result := nil;
+  for i:=0 to widgetList.Count-1 do
+    if (TWidgetItem(widgetList[i]).Node = Node) or TWidgetItem(widgetList[i]).NodeAdded then
+    begin
+      Result := widgetList[i];
+      Exit;
+    end;
+end;
+
+function TWidgetDBForm.GetWidgetById(id: integer): TWidgetItem;
+var
+  i: Integer;
+begin
+  Result := nil;
+  for i:=0 to widgetList.Count-1 do
+    if TWidgetItem(widgetList[i]).Id = id then
+    begin
+      Result := widgetList[i];
+      Exit;
+    end;
+end;
+
+procedure TWidgetDBForm.vstWidgetListGetText(Sender: TBaseVirtualTree;
+  Node: PVirtualNode; Column: TColumnIndex; TextType: TVSTTextType;
+  var CellText: WideString);
+var
+  widget : TWidgetItem;
+  i: integer;
+begin
+  widget := GetWidgetByNode(Node);
+  if widget = nil then
+  begin
+    CellText := '';
+    Exit;
+  end;
+  case Column of
+    0: CellText := widget.Name;
+    1: CellText := widget.Category.Name;
+    2: CellText := IntToStr(widget.Downloads);
+    3: CellText := widget.Games;
+    4: CellText := IFF(widget.Rating&gt;-1,FloatToStrF(widget.Rating,ffGeneral,2,1),' ');
+    5: CellText := IntToStr(widget.Comments);
+    6: CellText := widget.Author;
+    7: CellText := widget.Entry;
+    9: CellText := IntToStr(widget.VoteCount);
+  end;
+end;
+
+procedure TWidgetDBForm.vstWidgetListPaintText(Sender: TBaseVirtualTree;
+  const TargetCanvas: TCanvas; Node: PVirtualNode; Column: TColumnIndex;
+  TextType: TVSTTextType);
+begin
+  if Column = 0 then
+  begin
+    TargetCanvas.Font.Style := [fsBold];
+  end
+  else
+  begin
+    TargetCanvas.Font.Style := [];
+  end;
+  inherited;
+end;
+
+procedure TWidgetDBForm.vstWidgetListDrawText(Sender: TBaseVirtualTree;
+  TargetCanvas: TCanvas; Node: PVirtualNode; Column: TColumnIndex;
+  const Text: WideString; const CellRect: TRect; var DefaultDraw: Boolean);
+var
+  PaintRect: TRect;
+  CheckboxRect: TRect;
+  hot: Boolean;
+  pt: TPoint;
+  hi: THitInfo;
+  itemState: TSpTBXSkinStatesType;
+begin
+  DefaultDraw := True;
+  if (SkinManager.GetSkinType=sknSkin) then
+  begin
+    with (Sender as TVirtualStringTree) do
+    begin
+      GetCursorPos(pt);
+      pt := ScreenToClient(pt);
+      GetHitTestInfoAt(pt.X,pt.Y,True,hi);
+      hot := Misc.GetControlForm(Sender).Active and (hi.HitNode = Node);
+
+      CopyRect(PaintRect,TargetCanvas.ClipRect);
+      {if Header.Columns[Column].Position &lt;&gt; 0 then
+        PaintRect.Left := PaintRect.Left - 3;
+      if Header.Columns[Column].Position &lt;&gt; Header.Columns.Count-1 then
+        PaintRect.Right := PaintRect.Right + 3;}
+
+      if Header.Columns[Column].CheckBox then
+        TargetCanvas.FillRect(TargetCanvas.ClipRect);
+
+      itemState := SkinManager.CurrentSkin.GetState(True,False,hot,Selected[Node]);
+      SkinManager.CurrentSkin.PaintBackground(TargetCanvas,PaintRect,skncListItem,itemState,True,True);
+      TargetCanvas.Font.Color := SkinManager.CurrentSkin.GetTextColor(skncListItem,itemState);
+      if Header.Columns[Column].CheckBox then
+      begin
+        CopyRect(CheckboxRect,TargetCanvas.ClipRect);
+        InflateRect(CheckboxRect,-3,-3);
+        SkinManager.CurrentSkin.PaintBackground(TargetCanvas,CheckboxRect,skncCheckBox,itemState,True,True);
+        if (Node.CheckState = csCheckedNormal) then
+          SkinManager.CurrentSkin.PaintMenuCheckMark(TargetCanvas,CheckboxRect,True,False,False,itemState);
+      end;
+      TargetCanvas.Brush.Style := Graphics.bsClear;
+    end;
+  end;
+end;
+
+procedure TWidgetDBForm.vstWidgetListHeaderClick(Sender: TVTHeader;
+  HitInfo: TVTHeaderHitInfo);
+begin
+  if Sender.SortColumn = HitInfo.Column then
+    if Sender.SortDirection = sdDescending then
+      Sender.SortDirection := sdAscending
+    else
+      Sender.SortDirection := sdDescending
+  else
+  begin
+    Sender.SortColumn := HitInfo.Column;
+    Sender.SortDirection := sdAscending
+  end;
+end;
+
+procedure TWidgetDBForm.vstWidgetListHeaderDraw(Sender: TVTHeader;
+  HeaderCanvas: TCanvas; Column: TVirtualTreeColumn; R: TRect; Hover,
+  Pressed: Boolean; DropMark: TVTDropMarkMode);
+var
+  pressedMargin: integer;
+  s: string;
+begin
+  pressedMargin := 0;
+  if Pressed then
+    pressedMargin := 1;
+  if Hover then
+  begin
+    SkinManager.CurrentSkin.PaintBackground(HeaderCanvas,R,skncHeader,sknsHotTrack,True,True);
+    HeaderCanvas.Font.Color := SkinManager.CurrentSkin.GetTextColor(skncHeader,sknsHotTrack);
+  end
+  else if Pressed then
+  begin
+    SkinManager.CurrentSkin.PaintBackground(HeaderCanvas,R,skncHeader,sknsPushed,True,True);
+    HeaderCanvas.Font.Color := SkinManager.CurrentSkin.GetTextColor(skncHeader,sknsPushed);
+  end
+  else
+  begin
+    SkinManager.CurrentSkin.PaintBackground(HeaderCanvas,R,skncHeader,sknsNormal,True,True);
+    HeaderCanvas.Font.Color := SkinManager.CurrentSkin.GetTextColor(skncHeader,sknsNormal);
+  end;
+  s := Sender.Columns[Column.Index].Text;
+
+  HeaderCanvas.Brush.Style := Graphics.bsClear;
+  if R.Right-R.Left-vstWidgetList.Margin &lt; HeaderCanvas.TextWidth(Sender.Columns[Column.Index].Text) then
+    s := ShortenString(HeaderCanvas.Handle, s, R.Right - R.Left-vstWidgetList.Margin, 0);
+  HeaderCanvas.TextOut(R.Left+vstWidgetList.Margin+pressedMargin,R.Top+2+pressedMargin,s);
+  
+  if Sender.SortColumn = Column.Index then
+  begin
+    MainForm.ArrowList.Draw(HeaderCanvas,R.Left+vstWidgetList.Margin+HeaderCanvas.TextWidth(s)+4,R.Top+1,IFF(Sender.SortDirection = sdAscending,0,1));
+  end;
+end;
+
+procedure TWidgetDBForm.vstWidgetListCompareNodes(Sender: TBaseVirtualTree;
+  Node1, Node2: PVirtualNode; Column: TColumnIndex; var Result: Integer);
+var
+  widget1,widget2: TWidgetItem;
+  i : integer;
+begin
+  widget1 := GetWidgetByNode(Node1);
+  if widget1 = nil then
+  begin
+    Result := 0;
+    Exit;
+  end;
+  widget2 := GetWidgetByNode(Node2);
+  if widget2 = nil then
+  begin
+    Result := 0;
+    Exit;
+  end;
+
+  case Column of
+    0: Result := AnsiCompareStr(widget1.Name,widget2.Name);
+    1: Result := AnsiCompareStr(widget1.Category.Name,widget2.Category.Name);
+    2: Result := CompareValue(widget1.Downloads,widget2.Downloads);
+    3: Result := AnsiCompareStr(widget1.Games,widget2.Games);
+    4: Result := CompareValue(widget1.Rating,widget2.Rating);
+    5: Result := CompareValue(widget1.Comments,widget2.Comments);
+    6: Result := AnsiCompareStr(widget1.Author,widget2.Author);
+    7: Result := AnsiCompareStr(widget1.Entry,widget2.Entry);
+    8: Result := CompareBoolean(widget1.Installed,widget2.Installed);
+    9: Result := CompareValue(widget1.VoteCount,widget2.VoteCount);
+  end;
+end;
+
+function TWidgetDBForm.SelectWidget(Node : PVirtualNode): boolean;
+var
+  widget: TWidgetItem;
+begin
+  widget := GetWidgetByNode(Node);
+  if widget = nil then
+  begin
+    lblWidgetName.Caption := '';
+    wbDescription.LoadFromString(GetSkinnedHtmlDescription(''));
+    reChangelog.Text := '';
+    reComments.Text := '';
+    SpTBXSplitter2.Visible := False;
+    wbScreenShots.Visible := False;
+    result := false;
+    Exit;
+  end;
+  lblWidgetName.Caption := widget.Name;
+  wbDescription.LoadFromString(GetSkinnedHtmlDescription(widget.Description));
+  reChangelog.Text := widget.Changelog;
+
+  btUninstall.Enabled := widget.Installed;
+  if widget.Installed then
+    btInstall.Caption := _('Update')
+  else
+    btInstall.Caption := _('Install');
+
+  if (uwiThread &lt;&gt; nil) and not uwiThread.Terminated then
+    uwiThread.Terminate;
+  uwiThread := TUpdateWidgetInfoThread.Create(false,widget);
+end;
+
+function TWidgetDBForm.GetSkinnedHtmlDescription(description: WideString): WideString;
+begin
+  Result := mmDescriptionHtml.Lines.Text;
+  Result := ReplaceCommonVars(Result);
+  Result := StringReplace(Result,'$content',description,[rfIgnoreCase, rfReplaceAll]);
+end;
+
+procedure TWidgetDBForm.FormShow(Sender: TObject);
+begin
+  tcWidgetInfo.ActivePage := tsWidgetDescription;
+  wbDescription.LoadFromString(GetSkinnedHtmlDescription(''));
+  SelectWidget(vstWidgetList.FocusedNode);
+end;
+
+constructor TUpdateWidgetInfoThread.Create(Suspended : Boolean; widget : TWidgetItem);
+begin
+   FreeOnTerminate := True;
+   inherited Create(Suspended);
+   FWidget := widget;
+end;
+
+procedure TUpdateWidgetInfoThread.Execute;
+var
+  xmlDoc : TXMLDocument;
+  itemHtml: WideString;
+  contentHtml: WideString;
+  commentText: WideString;
+  fileNode: IXMLNode;
+  i: integer;
+begin
+  CoInitialize(nil);
+
+  xmlDoc := TXMLDocument.Create(WidgetDBForm);
+  xmlDoc.FileName := '<A HREF="http://spring.vsync.de/luaManager/lua_manager.php?m=4&amp;id=">http://spring.vsync.de/luaManager/lua_manager.php?m=4&amp;id=</A>'+IntToStr(FWidget.NameId);
+  try
+    xmlDoc.Active := True;
+  except
+    CoUnInitialize;
+    MainForm.AddMainLog(_('Widget database server unavailable.'),Colors.Error);
+    Exit;
+  end;
+  xmlDoc.Resync;
+
+  WidgetDBForm.mmScreenshotItemHtml.Lines.BeginUpdate;
+
+  FDisplayWB := False;
+
+  if xmlDoc.DocumentElement.NodeName = 'root' then
+  begin
+    for i:=0 to xmlDoc.DocumentElement.ChildNodes.Count-1 do
+    begin
+      fileNode := xmlDoc.DocumentElement.ChildNodes.Get(i);
+      if fileNode.NodeName = 'File' then
+      begin
+        itemHtml := WidgetDBForm.mmScreenshotItemHtml.Lines.Text;
+        itemHtml := StringReplace(itemHtml,'$url',fileNode.ChildValues['Url'],[rfIgnoreCase, rfReplaceAll]);
+        contentHtml := contentHtml+itemHtml;
+        FDisplayWB := True;
+      end;
+    end;
+  end;
+
+  WidgetDBForm.mmScreenshotsHtml.Lines.BeginUpdate;
+  FResultHtml := WidgetDBForm.mmScreenshotsHtml.Lines.Text;
+  WidgetDBForm.mmScreenshotsHtml.Lines.EndUpdate;
+  FResultHtml := WidgetDBForm.ReplaceCommonVars(FResultHtml);
+  FResultHtml := StringReplace(FResultHtml,'$content',contentHtml,[rfIgnoreCase, rfReplaceAll]);
+
+  xmlDoc.Destroy;
+  Synchronize(UpdateWBHtml);
+
+  xmlDoc := TXMLDocument.Create(WidgetDBForm);
+  xmlDoc.FileName := '<A HREF="http://spring.vsync.de/luaManager/lua_manager.php?m=16&amp;id=">http://spring.vsync.de/luaManager/lua_manager.php?m=16&amp;id=</A>'+IntToStr(FWidget.NameId);
+  try
+    xmlDoc.Active := True;
+  except
+    CoUnInitialize;
+    MainForm.AddMainLog(_('Widget database server unavailable.'),Colors.Error);
+    Exit;
+  end;
+  xmlDoc.Resync;
+
+  FComments := '';
+
+  if xmlDoc.DocumentElement.NodeName = 'root' then
+  begin
+    for i:=0 to xmlDoc.DocumentElement.ChildNodes.Count-1 do
+    begin
+      fileNode := xmlDoc.DocumentElement.ChildNodes.Get(i);
+      if fileNode.NodeName = 'Comment' then
+      begin
+        try
+          commentText := Format(_('by %s (%s)'),[fileNode.ChildValues['Username'], fileNode.ChildValues['Entry']]);
+        except
+          commentText := Format('by %s (%s)',[fileNode.ChildValues['Username'], fileNode.ChildValues['Entry']]);
+        end;
+        commentText := commentText + EOL + '================'+EOL+fileNode.ChildValues['Comment'];
+        FComments := FComments+commentText+EOL;
+      end;
+    end;
+  end;
+
+  xmlDoc.Destroy;
+  Synchronize(UpdateComments);
+
+  CoUnInitialize;
+end;
+
+procedure TUpdateWidgetInfoThread.UpdateComments;
+begin
+  WidgetDBForm.reComments.Text := FComments;
+end;
+
+procedure TUpdateWidgetInfoThread.UpdateWBHtml;
+begin
+  TWinControl(WidgetDBForm.wbScreenShots).Visible := FDisplayWB;
+  WidgetDBForm.SpTBXSplitter2.Visible := FDisplayWB;
+  if FDisplayWB then
+    WidgetDBForm.wbScreenShots.LoadFromString(FResultHtml);
+end;
+
+procedure TWidgetDBForm.OnWebBrowsersBeforeNavigate2(Sender: TObject;
+  const pDisp: IDispatch; var URL, Flags, TargetFrameName, PostData,
+  Headers: OleVariant; var Cancel: WordBool);
+begin
+  if (LowerCase(URL) = 'about:blank') then Exit;
+  Cancel := True;
+  Misc.OpenURLInDefaultBrowser(URL);
+end;
+
+procedure TWidgetDBForm.OnWebBrowsersNewWindow2(Sender: TObject;
+  var ppDisp: IDispatch; var Cancel: WordBool);
+begin
+  ppDisp := wbScreenShots.DefaultInterface as IDispatch;
+end;
+
+function TWidgetDBForm.ReplaceCommonVars(htmlCode: WideString): WideString;
+begin
+  Result := htmlCode;
+  if Preferences.ThemeType = sknSkin then
+  begin
+    Result := StringReplace(Result,'$bgcolor','#'+Misc.ColorToStandardRGBHex(PreferencesForm.IfNotClNone(SkinManager.CurrentSkin.Options(skncTabBackground).Body.Color1,clWindow)),[rfIgnoreCase, rfReplaceAll]);
+    Result := StringReplace(Result,'$textcolor','#'+Misc.ColorToStandardRGBHex(SkinManager.CurrentSkin.GetTextColor(skncEditFrame,sknsNormal)),[rfIgnoreCase, rfReplaceAll]);
+    Result := StringReplace(Result,'$linkcolor','#'+Misc.ColorToStandardRGBHex(Misc.ComplementaryTextColor(PreferencesForm.IfNotClNone(SkinManager.CurrentSkin.Options(skncTabBackground).Body.Color1,clWindow))),[rfIgnoreCase, rfReplaceAll]);
+  end
+  else
+  begin
+    Result := StringReplace(Result,'$bgcolor','inherit',[rfIgnoreCase, rfReplaceAll]);
+    Result := StringReplace(Result,'$textcolor','inherit',[rfIgnoreCase, rfReplaceAll]);
+    Result := StringReplace(Result,'$linkcolor','inherit',[rfIgnoreCase, rfReplaceAll]);
+  end;
+end;
+
+procedure TWidgetDBForm.txtFilterChange(Sender: TObject);
+begin
+  FilterWidgetListDisplay(txtFilter.Text);
+end;
+
+procedure TWidgetDBForm.FilterWidgetListDisplay(filter: WideString);
+var
+  i,j: integer;
+  sl: TWideStringList;
+  showWidget: boolean;
+begin
+  sl := TWideStringList.Create;
+  ParseDelimited(sl,filter,' ','');
+  vstWidgetList.Clear;
+  for i:=0 to widgetList.Count-1 do
+  begin
+    TWidgetItem(widgetList[i]).Node := nil;
+    if (filter = '') then
+    begin
+      TWidgetItem(widgetList[i]).NodeAdded := True;
+      TWidgetItem(widgetList[i]).Node := vstWidgetList.AddChild(vstWidgetList.RootNode);
+      if TWidgetItem(widgetList[i]).Installed then
+        TWidgetItem(widgetList[i]).Node.CheckState := csCheckedNormal;
+    end
+    else
+    begin
+      showWidget := True;
+      for j:=0 to sl.Count-1 do
+      begin
+        if (sl[j] &lt;&gt; '') and not ((Pos(LowerCase(sl[j]),LowerCase(TWidgetItem(widgetList[i]).Name)) &gt; 0) or
+           (Pos(LowerCase(sl[j]),LowerCase(TWidgetItem(widgetList[i]).Games)) &gt; 0) or
+           (Pos(LowerCase(sl[j]),LowerCase(TWidgetItem(widgetList[i]).Author)) &gt; 0) or
+           (Pos(LowerCase(sl[j]),LowerCase(TWidgetItem(widgetList[i]).Category.Name)) &gt; 0) or
+           (Pos(LowerCase(sl[j]),LowerCase(TWidgetItem(widgetList[i]).Description)) &gt; 0)) then
+        begin
+          showWidget := False;
+          break;
+        end;
+      end;
+      if showWidget then
+      begin
+          TWidgetItem(widgetList[i]).NodeAdded := True;
+          TWidgetItem(widgetList[i]).Node := vstWidgetList.AddChild(vstWidgetList.RootNode);
+          if TWidgetItem(widgetList[i]).Installed then
+            TWidgetItem(widgetList[i]).Node.CheckState := csCheckedNormal;
+      end;
+    end;
+    TWidgetItem(widgetList[i]).NodeAdded := False;
+  end;
+end;
+
+procedure TWidgetDBForm.txtFilterSubEditButton0Click(Sender: TObject);
+begin
+  txtFilter.Text := '';
+end;
+
+function TWidgetDBForm.GetCategoryById(id: integer): TWidgetCategory;
+var
+  i: Integer;
+begin
+  Result := noneCategory;
+  for i:=0 to widgetCategoryList.Count-1 do
+    if TWidgetCategory(widgetCategoryList[i]).Id = id then
+    begin
+      Result := widgetCategoryList[i];
+      Exit;
+    end;
+end;
+
+procedure TRefreshWidgetListThread.Execute;
+var
+  xmlDoc : TXMLDocument;
+  i: integer;
+  widgetNode : IXMLNode;
+  categoryNode : IXMLNode;
+  fileNode: IXMLNode;
+  widgetItem : TWidgetItem;
+  categoryItem : TWidgetCategory;
+  tmpStr: WideString;
+  idStrList: TStringList;
+begin
+  CoInitialize(nil);
+
+  with WidgetDBForm do
+  begin
+
+  vstWidgetList.Clear;
+  widgetList.Clear;
+  widgetCategoryList.Clear;
+  idStrList := TStringList.Create;
+
+  // get widget category list
+  xmlDoc := TXMLDocument.Create(WidgetDBForm);
+  xmlDoc.FileName := '<A HREF="http://spring.vsync.de/luaManager/lua_manager.php?m=20">http://spring.vsync.de/luaManager/lua_manager.php?m=20</A>';
+  try
+    xmlDoc.Active := True;
+  except
+    MainForm.AddMainLog(_('Widget database server unavailable.'),Colors.Error);
+    Exit;
+  end;
+
+  if xmlDoc.DocumentElement.NodeName = 'root' then
+  begin
+    for i:=0 to xmlDoc.DocumentElement.ChildNodes.Count-1 do
+    begin
+      categoryNode := xmlDoc.DocumentElement.ChildNodes.Get(i);
+      if categoryNode.NodeName = 'Category' then
+      begin
+        categoryItem := TWidgetCategory.Create;
+        try
+          categoryItem.Id := categoryNode.Attributes['ID'];
+          categoryItem.Name := categoryNode.ChildValues['Name'];
+          widgetCategoryList.Add(categoryItem);
+        except
+          categoryItem.Destroy;
+        end;
+      end;
+    end;
+  end;
+  xmlDoc.Destroy;
+
+  // get widgets info
+  xmlDoc := TXMLDocument.Create(WidgetDBForm);
+  xmlDoc.FileName := '<A HREF="http://spring.vsync.de/luaManager/lua_manager.php?m=0">http://spring.vsync.de/luaManager/lua_manager.php?m=0</A>';
+  try
+    xmlDoc.Active := True;
+  except
+    MainForm.AddMainLog(_('Widget database server unavailable.'),Colors.Error);
+    Exit;
+  end;
+
+  if xmlDoc.DocumentElement.NodeName = 'root' then
+  begin
+    for i:=0 to xmlDoc.DocumentElement.ChildNodes.Count-1 do
+    begin
+      widgetNode := xmlDoc.DocumentElement.ChildNodes.Get(i);
+      if widgetNode.NodeName = 'Widget' then
+      begin
+        widgetItem := TWidgetItem.Create;
+        try
+          widgetItem.NodeAdded := False;
+          widgetItem.Id := widgetNode.Attributes['ID'];
+          widgetItem.VoteCount := widgetNode.ChildValues['VoteCount'];
+          if widgetItem.VoteCount &gt; 0 then
+            widgetItem.Rating := widgetNode.ChildValues['Rating']
+          else
+            widgetItem.Rating := -1;
+          widgetItem.Name := widgetNode.ChildValues['Name'];
+          widgetItem.NameId := widgetNode.ChildValues['NameId'];
+          widgetItem.Downloads := widgetNode.ChildValues['DownloadCount'];
+          try
+            widgetItem.Games := widgetNode.ChildValues['Mods'];
+          except
+          end;
+          widgetItem.Comments := widgetNode.ChildValues['CommentCount'];
+          widgetItem.Author := widgetNode.ChildValues['Author'];
+          try
+            widgetItem.Description := widgetNode.ChildValues['Description'];
+          except
+          end;
+          widgetItem.Entry := widgetNode.ChildValues['Entry'];
+          try
+            widgetItem.Changelog := widgetNode.ChildValues['Changelog'];
+          except
+          end;
+          try
+            widgetItem.Category := GetCategoryById(widgetNode.ChildValues['CategoryId']);
+          except
+            widgetItem.Category := noneCategory;
+          end;
+          widgetList.Add(widgetItem);
+          idStrList.Add(IntToStr(widgetItem.Id));
+          widgetItem.Node := nil;
+        except
+          widgetItem.Destroy;
+        end;
+      end;
+    end;
+  end;
+  xmlDoc.Destroy;
+
+  // check installed widgets
+  xmlDoc := TXMLDocument.Create(WidgetDBForm);
+  xmlDoc.FileName := '<A HREF="http://spring.vsync.de/luaManager/lua_manager.php?m=17&amp;ids=">http://spring.vsync.de/luaManager/lua_manager.php?m=17&amp;ids=</A>'+idStrList.CommaText;
+  try
+    xmlDoc.Active := True;
+  except
+    MainForm.AddMainLog(_('Widget database server unavailable.'),Colors.Error);
+    Exit;
+  end;
+
+  if xmlDoc.DocumentElement.NodeName = 'root' then
+  begin
+    for i:=0 to xmlDoc.DocumentElement.ChildNodes.Count-1 do
+    begin
+      fileNode := xmlDoc.DocumentElement.ChildNodes.Get(i);
+      if fileNode.NodeName = 'File' then
+      begin
+        try
+          tmpStr := StringReplace(fileNode.ChildValues['LocalPath'],'/','\',[rfReplaceAll]);
+          if tmpStr[1] = '\' then
+            tmpStr := MidStr(tmpStr,2,MaxInt);
+          tmpStr := ExtractFilePath(Application.ExeName)+tmpStr;
+
+          if (LowerCase(ExtractFileExt(tmpStr)) = '.lua') and (LowerCase(ExtractFilePath(tmpStr)) = LowerCase(ExtractFilePath(Application.ExeName)+'LuaUI\Widgets\')) and FileExists(tmpStr) then
+            GetWidgetById(fileNode.ChildValues['LuaId']).Installed := True;
+        except
+        end;
+      end;
+    end;
+  end;
+
+  Synchronize(UpdateList);
+
+  end;
+  CoUnInitialize;
+
+end;
+procedure TRefreshWidgetListThread.UpdateList;
+begin
+  WidgetDBForm.FilterWidgetListDisplay(WidgetDBForm.txtFilter.Text);
+  WidgetDBForm.SelectWidget(WidgetDBForm.vstWidgetList.RootNode.FirstChild);
+  WidgetDBForm.btRefresh.Enabled := True;
+end;
+constructor TRefreshWidgetListThread.Create(Suspended : Boolean);
+begin
+  FreeOnTerminate := True;
+  inherited Create(Suspended);
+end;
+
+procedure TWidgetDBForm.btRefreshClick(Sender: TObject);
+var
+  refreshThread: TRefreshWidgetListThread;
+begin
+  if not btRefresh.Enabled then Exit;
+  SelectWidget(nil);
+  btRefresh.Enabled := False;
+  refreshThread := TRefreshWidgetListThread.Create(False);
+end;
+
+procedure TWidgetDBForm.vstWidgetListFocusChanged(Sender: TBaseVirtualTree;
+  Node: PVirtualNode; Column: TColumnIndex);
+begin
+  SelectWidget(vstWidgetList.FocusedNode);
+end;
+
+procedure TWidgetDBForm.btInstallClick(Sender: TObject);
+var
+  widget: TWidgetItem;
+begin
+  if not btInstall.Enabled then Exit;
+  widget := GetWidgetByNode(vstWidgetList.FocusedNode);
+  if widget &lt;&gt; nil then
+  begin
+    btInstall.Enabled := False;
+    btRefresh.Enabled := False;
+    if widget.Installed then
+      btInstall.Caption := _('Updating ...')
+    else
+      btInstall.Caption := _('Installing ...');
+
+    TInstallWidgetThread.Create(false,widget,false);
+  end;
+end;
+
+procedure TInstallWidgetThread.Execute;
+var
+  xmlDoc : TXMLDocument;
+  i: integer;
+  fileNode : IXMLNode;
+  httpCli: THttpCli;
+  filePath: WideString;
+  dlFailed: Boolean;
+  successfullyInstalledFiles: TWideStringList;
+begin
+  CoInitialize(nil);
+
+  xmlDoc := TXMLDocument.Create(WidgetDBForm);
+  xmlDoc.FileName := '<A HREF="http://spring.vsync.de/luaManager/lua_manager.php?m=1&amp;id=">http://spring.vsync.de/luaManager/lua_manager.php?m=1&amp;id=</A>'+IntToStr(FWidget.Id);
+  try
+    xmlDoc.Active := True;
+  except
+    MainForm.AddMainLog(_('Widget database server unavailable.'),Colors.Error);
+    Exit;
+  end;
+
+  httpCli := THttpCli.Create(WidgetDBForm);
+  dlFailed := False;
+  successfullyInstalledFiles := TWideStringList.Create;
+
+  if xmlDoc.DocumentElement.NodeName = 'root' then
+  begin
+    for i:=0 to xmlDoc.DocumentElement.ChildNodes.Count-1 do
+    begin
+      fileNode := xmlDoc.DocumentElement.ChildNodes.Get(i);
+      if fileNode.NodeName = 'File' then
+      begin
+        try
+          filePath := StringReplace(fileNode.ChildValues['LocalPath'],'/','\',[rfReplaceAll]);
+          if filePath[1] = '\' then
+            filePath := MidStr(filePath,2,MaxInt);
+          filePath := ExtractFilePath(Application.ExeName)+filePath;
+
+          if FUninstall then
+          begin
+            if FileExists(filePath) then
+              DeleteFile(filePath);
+          end
+          else
+          begin
+            httpCli.URL := fileNode.ChildValues['Url'];
+            httpCli.RcvdStream := TFileStream.Create(filePath,fmCreate or fmOpenWrite);
+            try
+              httpCli.Get;
+              httpCli.RcvdStream.Free;
+              successfullyInstalledFiles.Add(filePath);
+            except
+              on E:Exception do
+              begin
+                httpCli.RcvdStream.Free;
+                DeleteFile(filePath);
+                raise E;
+              end;
+            end;
+          end;
+        except
+          on E:Exception do
+          begin
+            if FUninstall then
+              MainForm.AddMainLog('Error: Widget uninstallation failed: '+E.Message,Colors.Error)
+            else
+              MainForm.AddMainLog('Error: Widget installation failed: '+E.Message,Colors.Error);
+            dlFailed := True;
+            break;
+          end;
+        end;
+      end;
+    end;
+    if dlFailed then
+    begin
+      if not FUninstall then
+      begin
+        for i:=0 to successfullyInstalledFiles.Count-1 do
+          try
+            DeleteFile(successfullyInstalledFiles[i]);
+          except
+            on E:Exception do
+            begin
+              MainForm.AddMainLog('Error: '+E.Message,Colors.Error);
+            end;
+          end;
+      end;
+    end
+    else
+    begin
+      if FUninstall then
+      begin
+        FWidget.Installed := False;
+        if FWidget.Node &lt;&gt; nil then
+          FWidget.Node.CheckState := csUncheckedNormal;
+      end
+      else
+      begin
+        FWidget.Installed := True;
+        if FWidget.Node &lt;&gt; nil then
+          FWidget.Node.CheckState := csCheckedNormal;
+      end;
+    end;
+  end;
+
+  httpCli.Destroy;
+  xmlDoc.Destroy;
+
+  Synchronize(UpdateGUI);
+
+  CoUnInitialize;
+end;
+
+procedure TInstallWidgetThread.UpdateGUI;
+var
+  widget: TWidgetItem;
+begin
+  widget := WidgetDBForm.GetWidgetByNode(WidgetDBForm.vstWidgetList.FocusedNode);
+  if widget &lt;&gt; nil then
+  begin
+    if widget.Installed then
+      WidgetDBForm.btInstall.Caption := _('Update')
+    else
+      WidgetDBForm.btInstall.Caption := _('Install');
+  end;
+  WidgetDBForm.btRefresh.Enabled := True;
+  WidgetDBForm.btInstall.Enabled := True;
+  WidgetDBForm.btUninstall.Enabled := widget.Installed;
+  WidgetDBForm.btUninstall.Caption := _('Uninstall');
+  WidgetDBForm.vstWidgetList.Invalidate;
+end;
+
+constructor TInstallWidgetThread.Create(Suspended : Boolean; widget : TWidgetItem; uninstall: boolean);
+begin
+  FreeOnTerminate := True;
+  inherited Create(Suspended);
+  FWidget := widget;
+  FUninstall := uninstall;
+end;
+
+procedure TWidgetDBForm.btUninstallClick(Sender: TObject);
+var
+  widget: TWidgetItem;
+begin
+  if not btUninstall.Enabled then Exit;
+  widget := GetWidgetByNode(vstWidgetList.FocusedNode);
+  if widget &lt;&gt; nil then
+  begin
+    if widget.Installed then
+    begin
+      btUninstall.Enabled := False;
+      btRefresh.Enabled := False;
+      btUninstall.Caption := _('Uninstalling ...');
+      TInstallWidgetThread.Create(false,widget,true);
+    end
+    else
+    begin
+      btUninstall.Caption := _('Uninstall'); // should not happen
+      Raise Exception.Create('Uninstall button enabled on a widget not installed');
+    end;
+  end;
+end;
+
+procedure TSendCommentThread.Execute;
+var
+  ResponseStream: TMemoryStream;
+  ResponseStr : string;
+  MultiPartFormDataStream: TMsMultiPartFormDataStream;
+  idHttp: TIdHTTP;
+  sendFailed: Boolean;
+begin
+  MultiPartFormDataStream := TMsMultiPartFormDataStream.Create;
+  ResponseStream := TMemoryStream.Create;
+  idHttp := TIdHTTP.Create(WidgetDBForm);
+  sendFailed := False;
+  try
+    idHttp.Request.ContentType := MultiPartFormDataStream.RequestContentType;
+
+    MultiPartFormDataStream.AddFormField('c', FComment);
+    { You must make sure you call this method *before* sending the stream }
+    MultiPartFormDataStream.PrepareStreamForDispatch;
+    MultiPartFormDataStream.Position := 0;
+
+    idHttp.Post('<A HREF="http://spring.vsync.de/luaManager/lua_manager.php?m=15&amp;id=">http://spring.vsync.de/luaManager/lua_manager.php?m=15&amp;id=</A>'+IntToStr(FWidget.NameId)+'&amp;uname='+Preferences.Username+'&amp;pw=empty', MultiPartFormDataStream, ResponseStream);
+    ResponseStream.Seek(0,0);
+    SetLength(ResponseStr, ResponseStream.Size);
+    ResponseStream.ReadBuffer(Pointer(ResponseStr)^, ResponseStream.Size);
+  except
+    MainForm.AddMainLog(_('Error: Failed to send the widget comment.'),Colors.Error);
+    sendFailed := True;
+  end;
+  MultiPartFormDataStream.Free;
+  ResponseStream.Free;
+  if not sendFailed then
+  begin
+    if ResponseStr = 'Rejected!' then
+    begin
+      MainForm.AddMainLog(_('Error: Widget comment rejected.'),Colors.Error);
+    end
+    else if ResponseStr = 'Commented!' then
+    begin
+      // nothing
+    end
+    else
+    begin
+      MainForm.AddMainLog(_('Error: ')+ResponseStr,Colors.Error);
+    end;
+  end;
+
+  Synchronize(UpdateGUI);
+end;
+procedure TSendCommentThread.UpdateGUI;
+begin
+  WidgetDBForm.btSendComment.Enabled := True;
+  WidgetDBForm.btSendComment.Caption := _('Send');
+  WidgetDBForm.btRefresh.Enabled := True;
+  WidgetDBForm.reMyComment.Text := '';
+  WidgetDBForm.reMyComment.Enabled := True;
+  WidgetDBForm.SelectWidget(WidgetDBForm.vstWidgetList.FocusedNode);
+end;
+constructor TSendCommentThread.Create(Suspended : Boolean; widget : TWidgetItem; comment: WideString);
+begin
+  FreeOnTerminate := True;
+  inherited Create(Suspended);
+  FWidget := widget;
+  FComment := comment
+end;
+
+procedure TWidgetDBForm.btSendCommentClick(Sender: TObject);
+var
+  widget: TWidgetItem;
+begin
+  if not btSendComment.Enabled then Exit;
+  if not PreferencesForm.isLoggedOnOfficialServer then
+  begin
+    MessageDlg(_('You need to be logged into the official server to be able to post a comment about this widget.'),mtWarning,[mbOk],0);
+    Exit;
+  end;
+
+  widget := GetWidgetByNode(vstWidgetList.FocusedNode);
+  if (widget &lt;&gt; nil) and (reMyComment.Text &lt;&gt; '') then
+  begin
+    btSendComment.Enabled := False;
+    btRefresh.Enabled := False;
+    reMyComment.Enabled := False;
+    btSendComment.Caption := _('Sending ...');
+
+    TSendCommentThread.Create(false,widget,reMyComment.Text);
+  end;
+end;
+
+procedure TRateThread.Execute;
+var
+  ResponseStream: TMemoryStream;
+  ResponseStr : string;
+  MultiPartFormDataStream: TMsMultiPartFormDataStream;
+  idHttp: TIdHTTP;
+  sendFailed: Boolean;
+begin
+  MultiPartFormDataStream := TMsMultiPartFormDataStream.Create;
+  ResponseStream := TMemoryStream.Create;
+  idHttp := TIdHTTP.Create(WidgetDBForm);
+  sendFailed := False;
+  try
+    idHttp.Request.ContentType := MultiPartFormDataStream.RequestContentType;
+    { You must make sure you call this method *before* sending the stream }
+    MultiPartFormDataStream.PrepareStreamForDispatch;
+    MultiPartFormDataStream.Position := 0;
+
+    idHttp.Post('<A HREF="http://spring.vsync.de/luaManager/lua_manager.php?m=14&amp;id=">http://spring.vsync.de/luaManager/lua_manager.php?m=14&amp;id=</A>'+IntToStr(FWidget.NameId)+'&amp;uname='+Preferences.Username+'&amp;pw=empty&amp;r='+IntToStr(FRate), MultiPartFormDataStream, ResponseStream);
+    ResponseStream.Seek(0,0);
+    SetLength(ResponseStr, ResponseStream.Size);
+    ResponseStream.ReadBuffer(Pointer(ResponseStr)^, ResponseStream.Size);
+  except
+    MainForm.AddMainLog(_('Error: Failed to rate the widget.'),Colors.Error);
+    sendFailed := True;
+  end;
+  MultiPartFormDataStream.Free;
+  ResponseStream.Free;
+  if not sendFailed then
+  begin
+    if ResponseStr = 'Rejected!' then
+    begin
+      MainForm.AddMainLog(_('Error: Widget rate rejected.'),Colors.Error);
+    end
+    else if ResponseStr = 'Rated!' then
+    begin
+      // nothing
+    end
+    else
+    begin
+      MainForm.AddMainLog(_('Error: ')+ResponseStr,Colors.Error);
+    end;
+  end;
+
+  Synchronize(UpdateGUI);
+end;
+procedure TRateThread.UpdateGUI;
+begin
+  WidgetDBForm.gbRate.Enabled := True;
+  WidgetDBForm.gbRate.Caption := _('Rate');
+  WidgetDBForm.btRate1.Enabled := True;
+  WidgetDBForm.btRate2.Enabled := True;
+  WidgetDBForm.btRate3.Enabled := True;
+  WidgetDBForm.btRate4.Enabled := True;
+  WidgetDBForm.btRate5.Enabled := True;
+  WidgetDBForm.btRefresh.Enabled := True;
+end;
+constructor TRateThread.Create(Suspended : Boolean; widget : TWidgetItem; rate: Byte);
+begin
+  FreeOnTerminate := True;
+  inherited Create(Suspended);
+  FWidget := widget;
+  FRate := rate;
+end;
+
+procedure TWidgetDBForm.RateWidget(rate: Byte);
+var
+  widget: TWidgetItem;
+begin
+  if not btSendComment.Enabled then Exit;
+  if not PreferencesForm.isLoggedOnOfficialServer then
+  begin
+    MessageDlg(_('You need to be logged into the official server to be able to rate a widget.'),mtWarning,[mbOk],0);
+    Exit;
+  end;
+
+  widget := GetWidgetByNode(vstWidgetList.FocusedNode);
+  if (widget &lt;&gt; nil) and (rate &gt; 0) and (rate &lt; 6) then
+  begin
+    gbRate.Enabled := False;
+    btRate1.Enabled := False;
+    btRate2.Enabled := False;
+    btRate3.Enabled := False;
+    btRate4.Enabled := False;
+    btRate5.Enabled := False;
+    btRefresh.Enabled := False;
+    gbRate.Caption := _('Rating ...');
+
+    TRateThread.Create(false,widget,rate);
+  end;
+end;
+
+procedure TWidgetDBForm.btRate1Click(Sender: TObject);
+begin
+  RateWidget(1);
+end;
+
+procedure TWidgetDBForm.btRate2Click(Sender: TObject);
+begin
+  RateWidget(2);
+end;
+
+procedure TWidgetDBForm.btRate3Click(Sender: TObject);
+begin
+  RateWidget(3);
+end;
+
+procedure TWidgetDBForm.btRate4Click(Sender: TObject);
+begin
+  RateWidget(4);
+end;
+
+procedure TWidgetDBForm.btRate5Click(Sender: TObject);
+begin
+  RateWidget(5);
+end;
+
+end.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message: <A HREF="002288.html">[Taspring-linux-commit] r7518 - in Lobby/TASClient: . Python/scripts
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2287">[ date ]</a>
              <a href="thread.html#2287">[ thread ]</a>
              <a href="subject.html#2287">[ subject ]</a>
              <a href="author.html#2287">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
