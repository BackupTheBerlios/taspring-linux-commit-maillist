<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r6233 - in branches/0.77-branch:	Lobby/TASClient Lobby/TASClient/Python	Lobby/TASClient/Python/scripts rts/Lua	rts/Sim/Units/CommandAI rts/System/Platform/Linux
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-August/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6233%20-%20in%20branches/0.77-branch%3A%0A%09Lobby/TASClient%20Lobby/TASClient/Python%0A%09Lobby/TASClient/Python/scripts%20rts/Lua%0A%09rts/Sim/Units/CommandAI%20rts/System/Platform/Linux&In-Reply-To=%3C20080805123248.14A624960%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001012.html">
   <LINK REL="Next"  HREF="001014.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r6233 - in branches/0.77-branch:	Lobby/TASClient Lobby/TASClient/Python	Lobby/TASClient/Python/scripts rts/Lua	rts/Sim/Units/CommandAI rts/System/Platform/Linux</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6233%20-%20in%20branches/0.77-branch%3A%0A%09Lobby/TASClient%20Lobby/TASClient/Python%0A%09Lobby/TASClient/Python/scripts%20rts/Lua%0A%09rts/Sim/Units/CommandAI%20rts/System/Platform/Linux&In-Reply-To=%3C20080805123248.14A624960%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r6233 - in branches/0.77-branch:	Lobby/TASClient Lobby/TASClient/Python	Lobby/TASClient/Python/scripts rts/Lua	rts/Sim/Units/CommandAI rts/System/Platform/Linux">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Tue Aug  5 14:32:47 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001012.html">[Taspring-linux-commit] r6232 - in trunk/rts: Lua Map Map/SM3	Map/SMF Rendering Rendering/Env Sim/Units Sim/Units/UnitTypes
</A></li>
        <LI>Next message: <A HREF="001014.html">[Taspring-linux-commit] r6234 - trunk/rts/Game
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1013">[ date ]</a>
              <a href="thread.html#1013">[ thread ]</a>
              <a href="subject.html#1013">[ subject ]</a>
              <a href="author.html#1013">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: Auswaschbar
Date: 2008-08-05 14:32:46 +0200 (Tue, 05 Aug 2008)
New Revision: 6233

Modified:
   branches/0.77-branch/Lobby/TASClient/BattleFormUnit.dfm
   branches/0.77-branch/Lobby/TASClient/BattleFormUnit.pas
   branches/0.77-branch/Lobby/TASClient/HostBattleFormUnit.dfm
   branches/0.77-branch/Lobby/TASClient/HostBattleFormUnit.pas
   branches/0.77-branch/Lobby/TASClient/HttpGetUnit.dfm
   branches/0.77-branch/Lobby/TASClient/HttpGetUnit.pas
   branches/0.77-branch/Lobby/TASClient/LobbyScriptUnit.pas
   branches/0.77-branch/Lobby/TASClient/MainUnit.dfm
   branches/0.77-branch/Lobby/TASClient/MainUnit.pas
   branches/0.77-branch/Lobby/TASClient/Misc.pas
   branches/0.77-branch/Lobby/TASClient/PreferencesFormUnit.dfm
   branches/0.77-branch/Lobby/TASClient/PreferencesFormUnit.pas
   branches/0.77-branch/Lobby/TASClient/Python/api.txt
   branches/0.77-branch/Lobby/TASClient/Python/scripts/stick.py
   branches/0.77-branch/Lobby/TASClient/ReplaysUnit.dfm
   branches/0.77-branch/Lobby/TASClient/ReplaysUnit.pas
   branches/0.77-branch/Lobby/TASClient/TASClient.dof
   branches/0.77-branch/Lobby/TASClient/TASClient.dpr
   branches/0.77-branch/Lobby/TASClient/TASClient.res
   branches/0.77-branch/Lobby/TASClient/UploadReplayUnit.pas
   branches/0.77-branch/Lobby/TASClient/Utility.pas
   branches/0.77-branch/Lobby/TASClient/class_TIntegerList.pas
   branches/0.77-branch/rts/Lua/LuaUnitDefs.cpp
   branches/0.77-branch/rts/Sim/Units/CommandAI/TransportCAI.cpp
   branches/0.77-branch/rts/Sim/Units/CommandAI/TransportCAI.h
   branches/0.77-branch/rts/System/Platform/Linux/DataDirLocater.cpp
Log:
* allow whitespaces in /etc/spring/datadir
* #983
* fixed s3o recognition in LuaUnitDefs


Modified: branches/0.77-branch/Lobby/TASClient/BattleFormUnit.dfm
===================================================================
--- branches/0.77-branch/Lobby/TASClient/BattleFormUnit.dfm	2008-08-04 18:19:19 UTC (rev 6232)
+++ branches/0.77-branch/Lobby/TASClient/BattleFormUnit.dfm	2008-08-05 12:32:46 UTC (rev 6233)
@@ -1,6 +1,6 @@
 object BattleForm: TBattleForm
-  Left = 433
-  Top = 342
+  Left = 478
+  Top = 70
   Width = 787
   Height = 586
   Caption = 'Battle window'
@@ -4692,7 +4692,7 @@
           end
           object TidalStrengthLabel: TSpTBXLabel
             Left = 232
-            Top = 123
+            Top = 143
             Width = 76
             Height = 13
             Caption = 'Tidal strength: ?'
@@ -4705,7 +4705,7 @@
           end
           object GravityLabel: TSpTBXLabel
             Left = 232
-            Top = 138
+            Top = 158
             Width = 45
             Height = 13
             Caption = 'Gravity: ?'
@@ -4718,7 +4718,7 @@
           end
           object MaxMetalLabel: TSpTBXLabel
             Left = 232
-            Top = 153
+            Top = 173
             Width = 63
             Height = 13
             Caption = 'Max. metal: ?'
@@ -4731,7 +4731,7 @@
           end
           object ExtRadiusLabel: TSpTBXLabel
             Left = 232
-            Top = 168
+            Top = 188
             Width = 85
             Height = 13
             Caption = 'Extractor radius: ?'
@@ -4744,7 +4744,7 @@
           end
           object WindLabel: TSpTBXLabel
             Left = 232
-            Top = 183
+            Top = 203
             Width = 86
             Height = 13
             Caption = 'Wind (min/max): ?'
@@ -4759,7 +4759,7 @@
             Left = 224
             Top = 4
             Width = 113
-            Height = 97
+            Height = 122
             Caption = 'SpTBXPanel1'
             Anchors = [akTop, akRight]
             Color = clNone
@@ -4797,7 +4797,7 @@
             end
             object TBXButton1: TTBXButton
               Left = 8
-              Top = 54
+              Top = 76
               Width = 97
               Height = 17
               BorderSize = 2
@@ -4807,7 +4807,7 @@
             end
             object TBXButton2: TTBXButton
               Left = 8
-              Top = 74
+              Top = 96
               Width = 97
               Height = 17
               BorderSize = 2
@@ -4815,10 +4815,20 @@
               TabOrder = 3
               OnClick = TBXButton2Click
             end
+            object DownloadMapButton: TTBXButton
+              Left = 8
+              Top = 56
+              Width = 97
+              Height = 17
+              BorderSize = 2
+              Caption = 'Download map ...'
+              TabOrder = 4
+              OnClick = DownloadMapButtonClick
+            end
           end
           object MapSizeLabel: TSpTBXLabel
             Left = 232
-            Top = 108
+            Top = 128
             Width = 54
             Height = 13
             Caption = 'Map size: ?'
@@ -5094,8 +5104,8 @@
     Top = 376
   end
   object ChooseNumberPopupMenu: TSpTBXPopupMenu
-    Left = 480
-    Top = 352
+    Left = 512
+    Top = 328
     object TBXToolPalette1: TTBXToolPalette
       ColCount = 4
       Images = MainForm.NumbersImageList
@@ -5206,6 +5216,8 @@
       Caption = 'Remove from group'
       OnClick = mnuRemoveFromGroupClick
     end
+    object SpTBXSeparatorItem9: TSpTBXSeparatorItem
+    end
   end
   object MapsPopupMenu: TSpTBXPopupMenu
     Left = 184
@@ -5242,6 +5254,8 @@
       Checked = True
       OnClick = KeepRatioItemClick
     end
+    object SpTBXSeparatorItem10: TSpTBXSeparatorItem
+    end
   end
   object AdminPopupMenu: TSpTBXPopupMenu
     Left = 316
@@ -5305,6 +5319,8 @@
       Caption = 'Clear boxes'
       OnClick = mnuClearBoxesClick
     end
+    object SpTBXSeparatorItem11: TSpTBXSeparatorItem
+    end
   end
   object HttpCli1: THttpCli
     LocalAddr = '0.0.0.0'
@@ -5381,5 +5397,7 @@
       Caption = 'Ladder Headquarters'
       OnClick = SpTBXItem12Click
     end
+    object SpTBXSeparatorItem12: TSpTBXSeparatorItem
+    end
   end
 end

Modified: branches/0.77-branch/Lobby/TASClient/BattleFormUnit.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/BattleFormUnit.pas	2008-08-04 18:19:19 UTC (rev 6232)
+++ branches/0.77-branch/Lobby/TASClient/BattleFormUnit.pas	2008-08-05 12:32:46 UTC (rev 6233)
@@ -290,6 +290,11 @@
     SpTBXSeparatorItem8: TSpTBXSeparatorItem;
     VDTDisabledUnits: TVirtualDrawTree;
     ChatRichEdit: TExRichEdit;
+    SpTBXSeparatorItem9: TSpTBXSeparatorItem;
+    SpTBXSeparatorItem10: TSpTBXSeparatorItem;
+    SpTBXSeparatorItem11: TSpTBXSeparatorItem;
+    SpTBXSeparatorItem12: TSpTBXSeparatorItem;
+    DownloadMapButton: TTBXButton;
 
     procedure CreateParams(var Params: TCreateParams); override;
 
@@ -498,6 +503,7 @@
     procedure Button1Click(Sender: TObject);
     procedure ChatRichEditMouseDown(Sender: TObject; Button: TMouseButton;
       Shift: TShiftState; X, Y: Integer);
+    procedure DownloadMapButtonClick(Sender: TObject);
   private
     History: TWideStringList;
     HistoryIndex: Integer;
@@ -556,7 +562,7 @@
     constructor Create(Suspended : Boolean);
   end;
 
-  TLadderMapThread = class(TDialogThread)
+  TLadderMapThread = class(TTASClientThread)
   private
     StatusMsg : string;
     StartButtonEnabled: boolean;
@@ -576,7 +582,7 @@
     constructor Create(Suspended : Boolean);
   end;
 
-  TUploadLadderDataThread = class(TDialogThread)
+  TUploadLadderDataThread = class(TTASClientThread)
   private
     procedure UploadData;
     procedure OnTerminateProcedure(Sender : TObject);
@@ -646,7 +652,7 @@
   InitWaitFormUnit, AddBotUnit, Math, OnlineMapsUnit, ReplaysUnit, StrUtils,
   CustomColorUnit, StringParser, MapListFormUnit, AutoTeamsUnit,
   AutoStartRectsUnit, ColorPicker, UploadReplayUnit, ProgressBarWindow,
-  TntWideStrings, LobbyScriptUnit;
+  TntWideStrings, LobbyScriptUnit, SpringDownloaderFormUnit;
 
 {$R *.dfm}
 
@@ -1315,6 +1321,7 @@
   if CreateProcess(nil, PChar(ExtractFilePath(Application.ExeName) + springexe + ' script.txt'), nil, nil, false, CREATE_DEFAULT_ERROR_MODE + NORMAL_PRIORITY_CLASS,
                    nil, PChar(ExtractFilePath(Application.ExeName)), BattleState.Process.startinfo, BattleState.Process.proc_info) then
   begin
+    
     AddTextToChat('Game launched', Colors.Info, 1);
     Status.AmIInGame := True;
     MainForm.TryToSendCommand('MYSTATUS', '1');
@@ -1436,7 +1443,8 @@
   SpTBXTitleBar1.Caption := 'Battle window (' + BattleState.Battle.ModName + ')';
 
   if Utility.MapList.IndexOf(BattleState.Battle.Map) = -1 then
-    dlMap := TDownloadMapThread.Create(false,BattleState.Battle.MapHash,BattleState.Battle.Map);
+    SpringDownloaderFormUnit.DownloadMap(BattleState.Battle.MapHash,BattleState.Battle.Map);
+    //dlMap := TDownloadMapThread.Create(false,BattleState.Battle.MapHash,BattleState.Battle.Map);
 
   Result := True;
 
@@ -1527,7 +1535,8 @@
   SpTBXTitleBar1.Caption := 'Battle window (' + BattleState.Battle.ModName + ')';
 
   if Utility.MapList.IndexOf(BattleState.Battle.Map) = -1 then
-    dlMap := TDownloadMapThread.Create(false,BattleState.Battle.MapHash,BattleState.Battle.Map);
+    SpringDownloaderFormUnit.DownloadMap(BattleState.Battle.MapHash,BattleState.Battle.Map);
+    //dlMap := TDownloadMapThread.Create(false,BattleState.Battle.MapHash,BattleState.Battle.Map);
     
   Result := True;
 
@@ -1787,6 +1796,8 @@
   BattleState.DisabledUnits.Clear;
   PopulateDisabledUnitsVDT;
 
+  MapsPopupStringList.Enabled := True;
+
   StartPosRadioGroup.Enabled := False;
   GameEndRadioGroup.Enabled := False;
   DisableControlAndChildren(ResourcesGroupBox);
@@ -2538,12 +2549,16 @@
         OnlineMapsForm.ScrollToMap(OnlineMapsForm.DoesOnlineMapExist(BattleState.Battle.Map));
       end
       else
+      begin
+        SpringDownloaderFormUnit.DownloadMap(BattleState.Battle.MapHash,BattleState.Battle.Map);
+        Exit;
         url := StringReplace(BattleState.Battle.Map,'.smf','',[rfReplaceAll, rfIgnoreCase]);
         {url := StringReplace(url,'_',' ',[rfReplaceAll, rfIgnoreCase]);
         url := StringReplace(url,'-',' ',[rfReplaceAll, rfIgnoreCase]);}
         url := '<A HREF="http://spring.jobjol.nl/search_result.php?search=">http://spring.jobjol.nl/search_result.php?search=</A>' + url+'&amp;select=select_all';
         FixURL(url);
         Misc.OpenURLInDefaultBrowser(url);
+      end;
     end;
     Exit;
   end;
@@ -5575,7 +5590,6 @@
 
 procedure TLadderRanksThread.OnTerminateProcedure(Sender: TObject);
 begin
-  // nothing
 end;
 
 constructor TLadderMapThread.Create(Suspended: Boolean);
@@ -5606,7 +5620,10 @@
 
 procedure TLadderMapThread.Finalizer;
 begin
+  if BattleState.Status = Hosting then
     BattleForm.StartButton.Enabled := StartButtonEnabled;
+  BattleForm.MapsPopupStringList.Enabled := True;
+  BattleForm.MapPanelResize(nil);
 end;
 
 procedure TLadderMapThread.ShowMessageStatus;
@@ -5662,6 +5679,7 @@
     if html = '' then
     begin
       UpdateMessageStatus('Error: Empty map list.');
+      Finalize(False);
       Exit;
     end;
 
@@ -5684,7 +5702,7 @@
       begin
         Synchronize(ChangeMapToFirstOne);
         if IsBattleActive and (BattleState.Status = Hosting) then
-          SendBattleInfoToServer;
+          Synchronize(SendBattleInfoToServer);
       end
       else
       begin
@@ -5704,6 +5722,7 @@
           MessageDlgThread('You can''t play this ladder with that mod because no map from the ladder is valid for this mod.', mtWarning, [mbOK], 0)
         else
           MessageDlgThread('To host this ladder battle, you need at least one of the following map :'+EOL+Misc.JoinStringList(sl,' ; '), mtWarning, [mbOK], 0);
+        Finalize(false);
         Exit;
       end;
 
@@ -6600,4 +6619,9 @@
   MainForm.RichEditMouseDown(Sender,Button,Shift,X,Y);
 end;
 
+procedure TBattleForm.DownloadMapButtonClick(Sender: TObject);
+begin
+  SpringDownloaderFormUnit.DownloadMap(BattleState.Battle.MapHash,BattleState.Battle.Map);
+end;
+
 end.

Modified: branches/0.77-branch/Lobby/TASClient/HostBattleFormUnit.dfm
===================================================================
--- branches/0.77-branch/Lobby/TASClient/HostBattleFormUnit.dfm	2008-08-04 18:19:19 UTC (rev 6232)
+++ branches/0.77-branch/Lobby/TASClient/HostBattleFormUnit.dfm	2008-08-05 12:32:46 UTC (rev 6233)
@@ -230,7 +230,7 @@
       AutoSize = False
       Caption = 'Host'
       DropDownCombo = True
-      DropDownMenu = MainForm.ClientPopupMenu
+      DropDownMenu = HostPopupMenu
       SmartFocus = False
       TabOrder = 17
       OnClick = HostButtonClick

Modified: branches/0.77-branch/Lobby/TASClient/HostBattleFormUnit.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/HostBattleFormUnit.pas	2008-08-04 18:19:19 UTC (rev 6232)
+++ branches/0.77-branch/Lobby/TASClient/HostBattleFormUnit.pas	2008-08-05 12:32:46 UTC (rev 6233)
@@ -7,7 +7,8 @@
   Dialogs, StdCtrls, Mask, ComCtrls, janTracker, Buttons, Menus,
   JvExControls, JvComponent, JvArrowButton, ExtCtrls, JvXPCore, JvXPButtons,
   TBXDkPanels, SpTBXControls, TntStdCtrls, SpTBXEditors, SpTBXItem, TBX,
-  TB2Item, TB2ExtItems, TB2Dock, TB2Toolbar, SpTBXjanTracker, HttpProt,MainUnit,StrUtils,JclUnicode;
+  TB2Item, TB2ExtItems, TB2Dock, TB2Toolbar, SpTBXjanTracker, HttpProt,MainUnit,
+  StrUtils,JclUnicode, LobbyScriptUnit;
 
 type
   THostBattleForm = class(TForm)
@@ -65,7 +66,7 @@
   public
     replay: TReplay;
   end;
-  TLadderListThread = class(TDialogThread)
+  TLadderListThread = class(TTASClientThread)
   private
     DownloadLadderDetailsIndex : integer;
     DownloadAllRulesAtOnce : boolean;
@@ -94,7 +95,7 @@
 
 uses WaitForAckUnit, BattleFormUnit, Utility, InitWaitFormUnit,
   DisableUnitsFormUnit, HostInfoUnit, Misc, PreferencesFormUnit,
-  ReplaysUnit, Math, TntWideStrings, LobbyScriptUnit;
+  ReplaysUnit, Math, TntWideStrings;
 
 {$R *.dfm}
 
@@ -513,7 +514,7 @@
   ModsComboBox.Items.Assign(Utility.ModList);
   ModsComboBox.ItemIndex := ModsComboBox.Items.IndexOf(s);
 
-  (Sender as TMenuItem).Checked := True;
+  //(Sender as TMenuItem).Checked := True;
   HostButton.Caption := 'Host';
 end;
 
@@ -581,7 +582,6 @@
 
   BattleReplayInfo.Script.Assign(ReplaysForm.ScriptRichEdit.Lines);
   BattleReplayInfo.ReplayFilename := ReplaysForm.GetReplayFromNode(ReplaysForm.VDTReplays.FocusedNode).FileName;
-
   (Sender as TMenuItem).Checked := True;
   HostButton.Caption := 'Host Replay';
 end;

Modified: branches/0.77-branch/Lobby/TASClient/HttpGetUnit.dfm
===================================================================
--- branches/0.77-branch/Lobby/TASClient/HttpGetUnit.dfm	2008-08-04 18:19:19 UTC (rev 6232)
+++ branches/0.77-branch/Lobby/TASClient/HttpGetUnit.dfm	2008-08-05 12:32:46 UTC (rev 6233)
@@ -1,6 +1,6 @@
 object HttpGetForm: THttpGetForm
-  Left = 1298
-  Top = 727
+  Left = 980
+  Top = 284
   BorderStyle = bsDialog
   Caption = 'File download 4'
   ClientHeight = 178

Modified: branches/0.77-branch/Lobby/TASClient/HttpGetUnit.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/HttpGetUnit.pas	2008-08-04 18:19:19 UTC (rev 6232)
+++ branches/0.77-branch/Lobby/TASClient/HttpGetUnit.pas	2008-08-05 12:32:46 UTC (rev 6233)
@@ -68,7 +68,7 @@
 implementation
 
 uses
-  PreferencesFormUnit, BattleFormUnit;
+  PreferencesFormUnit, BattleFormUnit, SpringDownloaderFormUnit;
 
 {$R *.dfm}
 
@@ -167,20 +167,38 @@
         StatusLabel.Caption := 'Download complete, extracting new files ...';
         ReceivedLabel.Visible := False;
         appExePath := Application.ExeName;
-        if not RenameFile(Application.ExeName,Application.ExeName+'.old') then
-        begin
-          MessageDlg('Error : cannot rename '+Application.ExeName, mtError, [mbOK], 0);
-          Exit;
-        end;
+
         SevenZip1.SZFileName := DownloadFile.FileName;
-        SevenZip1.ExtrBaseDir := ExtractFilePath(appExePath);
+        DelTree(ExtractFilePath(appExePath)+'TASClientUpdateTemp\');
+        SevenZip1.ExtrBaseDir := ExtractFilePath(appExePath)+'TASClientUpdateTemp\';
         e := SevenZip1.Extract(false);
+
         DeleteFile(DownloadFile.FileName);
-        if (e=0) or (e=1) then
+        if e=0 then
         begin
+          // renames tasclient.exe
+          if not RenameFile(Application.ExeName,Application.ExeName+'.old') then
+          begin
+            MessageDlg('Error : cannot rename '+Application.ExeName, mtError, [mbOK], 0);
+            Exit;
+          end;
+
+          // unloads the 7z dll
+          SevenZip1.SZFileName := '';
+          SevenZip1.Destroy;
+
+          // closes springdownloader
+          CloseSpringDownloader;
+
+          // updates files
+          MoveTree(ExtractFilePath(appExePath)+'TASClientUpdateTemp\',ExtractFilePath(appExePath));
+
+          // reconstructs the parameters string
           paramList := TStringList.Create;
           for i:=1 to ParamCount do
             paramList.Add(ParamStr(i));
+
+          // executes the new tasclient.exe
           ShellExecute(0,'open',PChar(appExePath),PChar(JoinStringList(paramList,' ')),PChar(ExtractFilePath(appExePath)), SW_SHOWNORMAL);
           MainForm.Close;
         end
@@ -189,7 +207,7 @@
           if (SevenZip1.LastError &gt;= 0) and (SevenZip1.LastError &lt;= 11) then
             MessageDlg('Error '+IntToStr(e) + ','+IntToStr(SevenZip1.LastError)+' : '+c7zipResMsg[SevenZip1.LastError], mtError, [mbOK], 0)
           else
-            MessageDlg('Error '+IntToStr(e) + ','+IntToStr(SevenZip1.LastError), mtError, [mbOK], 0)
+            MessageDlg('Error '+IntToStr(e) + ','+IntToStr(SevenZip1.LastError), mtError, [mbOK], 0);
         end;
     end
     else if (DownloadFile.ServerOptions and 8) = 8 then

Modified: branches/0.77-branch/Lobby/TASClient/LobbyScriptUnit.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/LobbyScriptUnit.pas	2008-08-04 18:19:19 UTC (rev 6232)
+++ branches/0.77-branch/Lobby/TASClient/LobbyScriptUnit.pas	2008-08-05 12:32:46 UTC (rev 6233)
@@ -6,11 +6,44 @@
   Misc,ExtCtrls, WrapDelphi, WrapDelphiClasses,PythonEngine,
   PythonGUIInputOutput, Forms, StrUtils,Classes, JclDebug,
   WSocket,MainUnit, class_TIntegerList, RichEdit2, ExRichEdit,
-  SyncObjs;
+  SyncObjs,SpTBXItem, TB2Item;
 
 type
+  TScriptMenuItemCallBack = record
+    moduleName : string;
+    functionName : string;
+    menu: TTBCustomItem;
+    args: PPyObject;
+  end;
+  PScriptMenuItemCallBack = ^TScriptMenuItemCallBack;
+
+  TScriptMenuItem = record
+    id : integer;
+    item: TTBCustomItem;
+  end;
+  PScriptMenuItem = ^TScriptMenuItem;
+
   {$METHODINFO ON}
 
+  TGUI = class(TPersistent)
+    private
+      menuIdInc : integer;
+      MenuItemList: TList;
+
+      function GetMenu(name: string): TTBCustomItem;
+      function GetMenuSelectedId(menu: TTBCustomItem): string;
+      procedure MenuItemClick(Sender: TObject);
+      function GetFreeMenuId: integer;
+
+    public
+      constructor Create;
+      function AddItemToMenu(menu: string;itemCaption: string; callInArgs: Variant; callbackModuleName: string; callbackFunctionName: string): integer;
+      function AddSubmenuToMenu(menu: string; itemCaption: string): integer;
+      function AddSeparatorToMenu(menu: string): integer;
+
+      procedure RemoveFromMenu(id: integer);
+  end;
+
   TCallback = class(TPersistent)
     private
       userRefCountList: TIntegerList;
@@ -95,6 +128,16 @@
     class function  DelphiObjectClass : TClass; override;
   end;
 
+  TPyGUI = class(TPyDelphiPersistent)
+    // Constructors &amp; Destructors
+    constructor Create( APythonType : TPythonType ); override;
+    constructor CreateWith( PythonType : TPythonType; args : PPyObject ); override;
+    // Basic services
+    function  Repr : PPyObject; override;
+
+    class function  DelphiObjectClass : TClass; override;
+  end;
+
   TScriptThread = class(TPythonThread)
   private
     functionName: string;
@@ -798,6 +841,7 @@
 procedure JoinBattle;
 begin
   MainForm.JoinBattle(MainForm.GetBattle(JoinBattleId),false,JoinBattlePassword);
+  ScriptJoining := False;
 end;
 
 function TCallback.JoinBattle(battleId: integer; Password: String) : Boolean;
@@ -820,7 +864,6 @@
     JoinBattleId := battleId;
     JoinBattlePassword := Password;
     PostMessage(MainForm.Handle,WM_SCRIPT,2,0);
-    ScriptJoining := False;
     Result := True;
   end
   else
@@ -1000,8 +1043,233 @@
   end;
 end;
 
-{ TPyPoint }
+constructor TGUI.Create;
+begin
+  menuIdInc :=1;
+  MenuItemList := TList.Create;
+end;
 
+function TGUI.GetFreeMenuId: integer;
+begin
+  Result := menuIdInc;
+  Inc(menuIdInc);
+end;
+
+function TGUI.GetMenu(name: string): TTBCustomItem;
+var
+  i: integer;
+  id: integer;
+begin
+  if name = 'HostBattle' then
+    Result := MainForm.HostBattlePopupMenu.Items
+  else if name = 'Help' then
+    Result := MainForm.HelpPopupMenu.Items
+  else if name = 'HelpWiki' then
+    Result := MainForm.SubMenuWiki
+  else if name = 'HelpDownload' then
+    Result := MainForm.SubMenuDownload
+  else if name = 'BattleItem' then
+    Result := MainForm.BattleListPopupMenu.Items
+  else if name = 'PlayerItem' then
+    Result := MainForm.ClientPopupMenu.LinkSubitems
+  else if name = 'PlayerItemModeration' then
+    Result := MainForm.ModerationSubmenuItem
+  else if name = 'BattlePlayerItem' then
+    Result := BattleForm.PlayerControlPopupMenu.Items
+  else if name = 'BattleMinimap' then
+    Result := BattleForm.AutoStartRectsPopupMenu.Items
+  else if name = 'BattleAdmin' then
+    Result := BattleForm.AdminPopupMenu.Items
+  else if name = 'BattleAdminBalance' then
+    Result := BattleForm.mnuBalanceSub
+  else if name = 'BattleAdminRankLimit' then
+    Result := BattleForm.mnuRankLimit
+  else if name = 'BattleLadder' then
+    Result := BattleForm.LadderPopupMenu.Items
+  else if name = 'ReplayItem' then
+    Result := ReplaysForm.ReplayListPopupMenu.Items
+  else
+  begin
+    id := 0;
+    try id := StrToInt(name); except end;
+    if id &lt;&gt; 0 then
+    begin
+      for i:=0 to MenuItemList.Count-1 do
+        if PScriptMenuItem(MenuItemList[i]).id = id then
+        begin
+          Result := PScriptMenuItem(MenuItemList[i]).item;
+          Exit;
+        end;
+    end;
+    Result := nil;
+  end;
+end;
+
+function TGUI.GetMenuSelectedId(menu: TTBCustomItem): string;
+var
+  RealIndex: integer;
+  WhatToDraw: TClientNodeType;
+  i: integer;
+begin
+  if menu = MainForm.BattleListPopupMenu.Items then
+    Result := IntToStr(MainUnit.SelectedBattle.ID)
+  else if (menu = MainForm.ClientPopupMenu.LinkSubitems) or (menu = MainForm.ModerationSubmenuItem) then
+    Result := MainUnit.SelectedUserName
+  else if menu = BattleForm.PlayerControlPopupMenu.Items then
+  begin
+    BattleForm.GetNodeClient(BattleForm.VDTBattleClients.FocusedNode.Index,RealIndex,WhatToDraw);
+    Result := TClient(BattleState.Battle.Clients[RealIndex]).Name
+  end
+  else if menu = ReplaysForm.ReplayListPopupMenu.Items then
+    Result := IntToStr(ReplayList.IndexOf(ReplaysForm.GetReplayFromNode(ReplaysForm.VDTReplays.FocusedNode)))
+  else
+  begin
+    for i:=0 to MenuItemList.Count-1 do
+      if PScriptMenuItem(MenuItemList[i]).item = menu then
+      begin
+        Result := GetMenuSelectedId(PScriptMenuItem(MenuItemList[i]).item.Parent);
+        Exit;
+      end;
+    Result := '';
+  end;
+end;
+
+procedure TGUI.MenuItemClick(Sender: TObject);
+var
+  m : PPyObject;
+  s: string;
+  i: integer;
+  miCb : PScriptMenuItemCallBack;
+begin
+  AcquireMainThread;
+  with GetPythonEngine do
+  begin
+    miCb := PScriptMenuItemCallBack(Pointer((Sender as TSpTBXItem).Tag));
+    m := FindFunction(miCb.moduleName,miCb.functionName);
+
+    PyList_SetItem(miCb.args,0,PyString_FromString(PChar(GetMenuSelectedId(miCb.menu))));
+
+    EvalPyFunction(m,PyList_AsTuple(miCb.args));
+  end;
+  ReleaseMainThread;
+end;
+
+function TGUI.AddItemToMenu(menu: string;itemCaption: string; callInArgs: Variant; callbackModuleName: string; callbackFunctionName: string): integer;
+var
+  m : TTBCustomItem;
+  s: PPyObject;
+  itemCb : PScriptMenuItemCallBack;
+  item: PScriptMenuItem;
+begin
+  Result := 0;
+  m := GetMenu(menu);
+
+  if m = nil then
+  begin
+    PythonScriptDebugFormUnit.printList.BeginUpdate;
+    PythonScriptDebugFormUnit.printList.Add('AddItemToMenu incorrect `menu` for item : '+itemCaption);
+    PythonScriptDebugFormUnit.printList.EndUpdate;
+    PostMessage(PythonScriptDebugForm.Handle, WM_REFRESHOUTPUT, 0, 0);
+    Exit;
+  end;
+
+  with GetPythonEngine do
+  begin
+    if not PyList_Check(VariantAsPyObject(callInArgs)) then
+    begin
+      PythonScriptDebugFormUnit.printList.BeginUpdate;
+      PythonScriptDebugFormUnit.printList.Add('AddItemToMenu incorrect `callInArgs` for item : '+itemCaption);
+      PythonScriptDebugFormUnit.printList.EndUpdate;
+      PostMessage(PythonScriptDebugForm.Handle, WM_REFRESHOUTPUT, 0, 0);
+      Exit;
+    end;
+
+    m.Add(TSpTBXItem.Create(m.ParentComponent));
+    with m.Items[m.Count-1] as TSpTBXItem do
+    begin
+      Caption := itemCaption;
+      OnClick := MenuItemClick;
+      New(itemCb);
+      itemCb.moduleName := callbackModuleName;
+      itemCb.functionName := callbackFunctionName;
+      itemCb.args := VariantAsPyObject(callInArgs);
+      PyList_Insert(itemCb.args,0,PyString_FromString('')); // adding the returning id as first arg
+      itemCb.menu := m;
+      Tag := Longint(itemCb);
+
+      New(item);
+      item.id := GetFreeMenuId;
+      item.item := m.Items[m.Count-1];
+      MenuItemList.Add(item);
+
+      Result := item.id;
+    end;
+  end;
+end;
+
+function TGUI.AddSubmenuToMenu(menu: string; itemCaption: string): integer;
+var
+  m : TTBCustomItem;
+  item: PScriptMenuItem;
+begin
+  Result := 0;
+  m := GetMenu(menu);
+
+  with GetPythonEngine do
+  begin
+
+    m.Add(TSpTBXSubmenuItem.Create(m.ParentComponent));
+    with m.Items[m.Count-1] as TSpTBXSubmenuItem do
+    begin
+      Caption := itemCaption;
+
+      New(item);
+      item.id := GetFreeMenuId;
+      item.item := m.Items[m.Count-1];
+      MenuItemList.Add(item);
+
+      Result := item.id;
+    end;
+  end;
+end;
+
+function TGUI.AddSeparatorToMenu(menu: string): integer;
+var
+  m : TTBCustomItem;
+  item: PScriptMenuItem;
+begin
+  Result := 0;
+  m := GetMenu(menu);
+
+  with GetPythonEngine do
+  begin
+
+    m.Add(TSpTBXSeparatorItem.Create(m.ParentComponent));
+
+    New(item);
+    item.id := GetFreeMenuId;
+    item.item := m.Items[m.Count-1];
+    MenuItemList.Add(item);
+
+    Result := item.id;
+  end;
+end;
+
+procedure TGUI.RemoveFromMenu(id: integer);
+var
+  i: integer;
+begin
+  for i:=0 to MenuItemList.Count-1 do
+    if PScriptMenuItem(MenuItemList[i]).id = id then
+    begin
+      FreeMemory(PScriptMenuItemCallBack(Pointer(PScriptMenuItem(MenuItemList[i]).item.Tag)));
+      PScriptMenuItem(MenuItemList[i]).item.Destroy;
+      FreeMemory(PScriptMenuItem(MenuItemList[i]));
+      MenuItemList.Delete(i);
+      Exit;
+    end;
+end;
+
 // We override the constructors
 
 constructor TPyCallback.Create( APythonType : TPythonType );
@@ -1022,17 +1290,36 @@
   Result := TCallback;
 end;
 
-class procedure RegisterMethods( PythonType : TPythonType );
+function  TPyCallback.Repr : PPyObject;
 begin
+  with GetPythonEngine, DelphiObject as TCallback do
+    Result := VariantAsPyObject('Lobby script API');
+end;
 
+constructor TPyGUI.Create( APythonType : TPythonType );
+begin
+  inherited;
+
+  DelphiObject := TGUI.Create;
+  Owned := True; // We own the objects we create
 end;
 
-function  TPyCallback.Repr : PPyObject;
+constructor TPyGUI.CreateWith( PythonType : TPythonType; args : PPyObject );
 begin
-  with GetPythonEngine, DelphiObject as TCallback do
-    Result := VariantAsPyObject('Lobby script API');
+  inherited;
 end;
 
+class function TPyGUI.DelphiObjectClass: TClass;
+begin
+  Result := TGUI;
+end;
+
+function  TPyGUI.Repr : PPyObject;
+begin
+  with GetPythonEngine, DelphiObject as TGUI do
+    Result := VariantAsPyObject('Lobby GUI API');
+end;
+
 constructor TScriptThread.Create(fName: string; tup: Variant);
 begin
   tuple := TStringList.Create;

Modified: branches/0.77-branch/Lobby/TASClient/MainUnit.dfm
===================================================================
--- branches/0.77-branch/Lobby/TASClient/MainUnit.dfm	2008-08-04 18:19:19 UTC (rev 6232)
+++ branches/0.77-branch/Lobby/TASClient/MainUnit.dfm	2008-08-05 12:32:46 UTC (rev 6233)
@@ -1,6 +1,6 @@
 object MainForm: TMainForm
-  Left = 621
-  Top = 205
+  Left = 813
+  Top = 384
   Width = 808
   Height = 549
   Caption = '.'
@@ -146,6 +146,123 @@
         Align = alTop
         Shape = bsSpacer
       end
+      object BotImage: TImage
+        Left = 160
+        Top = 72
+        Width = 36
+        Height = 16
+        AutoSize = True
+        Transparent = True
+        Visible = False
+      end
+      object DefaultArmImage: TImage
+        Left = 216
+        Top = 72
+        Width = 25
+        Height = 25
+        Picture.Data = {
+          07544269746D617036030000424D360300000000000036000000280000001000
+          000010000000010018000000000000030000120B0000120B0000000000000000
+          0000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
+          FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
+          FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
+          FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
+          FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
+          FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
+          FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFA8460CFFFFFF
+          FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
+          FFFFFFFFFFFFFFA8460CFFFFFFA8460CFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
+          FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFA8460CFFFFFFA8460CFFFFFF
+          A8460CFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFA8460CA846
+          0CA8460CFFFFFFA8460CA8460CA8460CFFFFFFA8460CA8460CA8460CFFFFFFFF
+          FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFA8460CA8460CA8460CA8460C
+          A8460CFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFA8460CA846
+          0CA8460CFFFFFFA8460CA8460CA8460CFFFFFFA8460CA8460CA8460CFFFFFFFF
+          FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFA8460CFFFFFFA8460CFFFFFF
+          A8460CFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
+          FFFFFFFFFFFFFFA8460CFFFFFFA8460CFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
+          FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
+          FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
+          FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
+          FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
+          FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
+          FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
+          FFFF}
+        Transparent = True
+        Visible = False
+      end
+      object DefaultSideImage: TImage
+        Left = 240
+        Top = 72
+        Width = 25
+        Height = 25
+        Picture.Data = {
+          07544269746D617036030000424D360300000000000036000000280000001000
+          0000100000000100180000000000000300000000000000000000000000000000
+          0000C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0
+          C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0
+          C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0
+          C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0
+          C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0
+          C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0
+          C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0
+          C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0
+          C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0
+          C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0
+          C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0
+          C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0
+          C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0
+          C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0
+          C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0
+          C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0
+          C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0
+          C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0
+          C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0
+          C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0
+          C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0
+          C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0
+          C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0
+          C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0C0
+          C0C0}
+        Transparent = True
+        Visible = False
+      end
+      object DefaultCoreImage: TImage
+        Left = 264
+        Top = 72
+        Width = 25
+        Height = 25
+        Picture.Data = {
+          07544269746D617036030000424D360300000000000036000000280000001000
+          000010000000010018000000000000030000120B0000120B0000000000000000
+          0000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
+          FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
+          FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
+          FFFFFFFFFFFFFFFFFFFFFF02EDFDFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
+          FFFFFFFFFFFF02EDFDFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF2A00D902ED
+          FDFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF02EDFD2A00D9FFFFFFFFFFFFFF
+          FFFFFFFFFFFFFFFFFFFFFF2A00D91081F0FFFFFF117CEF2206E02206E0117CEF
+          FFFFFF1081F02A00D9FFFFFFFFFFFFFFFFFFFFFFFFFFFFFF02EDFD2C00D70BA1
+          F5117CEF1B44E62206E02206E01B44E6117CEF0BA1F52C00D702EDFDFFFFFFFF
+          FFFFFFFFFFFFFFFF02EDFD2A00D90D97F305DAFB2110E12400DE2400DE2110E1
+          05DAFB0D97F32A00D902EDFDFFFFFFFFFFFFFFFFFFFFFFFF02EDFD2701DC240B
+          DE09B1F702EDFD2017E22017E202EDFD09B1F7240BDE2702DC02EDFDFFFFFFFF
+          FFFFFFFFFFFFFFFFFFFFFF208DF22502DD2601DD09B3F700F4FF00F4FF09B3F7
+          2601DD2503DD1A87F1FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF1087
+          F12502DD2600DD09B1F709B1F72600DD2502DD0F8BF2FFFFFFFFFFFFFFFFFFFF
+          FFFFFFFFFFFFFFFFFFFFFF05C9FA01F2FE1087F02500DD2600DC2600DC2500DD
+          1087F001F2FE05CAFAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF1560EC1E3B
+          E300FEFF0F8BF12600DD2600DD0F8BF100FEFF1E3BE31560ECFFFFFFFFFFFFFF
+          FFFFFFFFFFFFFFFFFFFFFF0EE6FE2416DF1E2FE401F2FF0F8BF20F8BF201F2FF
+          1E2FE42416DF0EE6FEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF0CE7
+          FE1189F003D9FDFFFFFFFFFFFF03D9FD1189F00CE7FEFFFFFFFFFFFFFFFFFFFF
+          FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
+          FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
+          FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
+          FFFF}
+        Transparent = True
+        Visible = False
+      end
       object Panel3: TPanel
         Left = 2
         Top = 211
@@ -876,181 +993,6 @@
         TabOrder = 1
         BorderType = pbrRaised
         TBXStyleBackground = True
-        object DefaultSideImage: TImage
-          Left = 168
-          Top = 0
-          Width = 25
-          Height = 25
-          Picture.Data = {
-            07544269746D617036030000424D360300000000000036000000280000001000
-            000010000000010018000000000000030000120B0000120B0000000000000000
-            0000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFF000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF000000FFFF00FFFF00000000
-            FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FF000000FFFF00FFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFFFFFFFF000000FFFF00FFFFFF000000000000FFFFFF
-            FFFF00000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF0000
-            00FFFF00FFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFF000000FFFF00FFFFFFFFFFFF000000000000FFFFFF
-            FFFFFFFFFF00000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF000000FFFF
-            00FFFFFFFFFFFFFFFFFF000000000000FFFFFFFFFF00000000FFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFF000000FFFF00FFFFFF000000FFFFFF000000000000
-            FFFFFFFFFF00000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF000000FFFF
-            00FFFF00FFFFFF000000000000FFFFFFFFFF00FFFF00000000FFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFF000000000000000000FFFF00FFFF00FFFF00FFFF00
-            000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFFFFFF000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFF}
-          Transparent = True
-          Visible = False
-        end
-        object DefaultArmImage: TImage
-          Left = 144
-          Top = 0
-          Width = 25
-          Height = 25
-          Picture.Data = {
-            07544269746D617036030000424D360300000000000036000000280000001000
-            000010000000010018000000000000030000120B0000120B0000000000000000
-            0000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFA8460CFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFA8460CFFFFFFA8460CFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFA8460CFFFFFFA8460CFFFFFF
-            A8460CFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFA8460CA846
-            0CA8460CFFFFFFA8460CA8460CA8460CFFFFFFA8460CA8460CA8460CFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFA8460CA8460CA8460CA8460C
-            A8460CFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFA8460CA846
-            0CA8460CFFFFFFA8460CA8460CA8460CFFFFFFA8460CA8460CA8460CFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFA8460CFFFFFFA8460CFFFFFF
-            A8460CFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFA8460CFFFFFFA8460CFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFF}
-          Transparent = True
-          Visible = False
-        end
-        object DefaultCoreImage: TImage
-          Left = 192
-          Top = 0
-          Width = 25
-          Height = 25
-          Picture.Data = {
-            07544269746D617036030000424D360300000000000036000000280000001000
-            000010000000010018000000000000030000120B0000120B0000000000000000
-            0000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFF02EDFDFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFF02EDFDFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF2A00D902ED
-            FDFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF02EDFD2A00D9FFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFF2A00D91081F0FFFFFF117CEF2206E02206E0117CEF
-            FFFFFF1081F02A00D9FFFFFFFFFFFFFFFFFFFFFFFFFFFFFF02EDFD2C00D70BA1
-            F5117CEF1B44E62206E02206E01B44E6117CEF0BA1F52C00D702EDFDFFFFFFFF
-            FFFFFFFFFFFFFFFF02EDFD2A00D90D97F305DAFB2110E12400DE2400DE2110E1
-            05DAFB0D97F32A00D902EDFDFFFFFFFFFFFFFFFFFFFFFFFF02EDFD2701DC240B
-            DE09B1F702EDFD2017E22017E202EDFD09B1F7240BDE2702DC02EDFDFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFF208DF22502DD2601DD09B3F700F4FF00F4FF09B3F7
-            2601DD2503DD1A87F1FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF1087
-            F12502DD2600DD09B1F709B1F72600DD2502DD0F8BF2FFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFF05C9FA01F2FE1087F02500DD2600DC2600DC2500DD
-            1087F001F2FE05CAFAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF1560EC1E3B
-            E300FEFF0F8BF12600DD2600DD0F8BF100FEFF1E3BE31560ECFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFF0EE6FE2416DF1E2FE401F2FF0F8BF20F8BF201F2FF
-            1E2FE42416DF0EE6FEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF0CE7
-            FE1189F003D9FDFFFFFFFFFFFF03D9FD1189F00CE7FEFFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFF}
-          Transparent = True
-          Visible = False
-        end
-        object BotImage: TImage
-          Left = 88
-          Top = 0
-          Width = 36
-          Height = 16
-          AutoSize = True
-          Picture.Data = {
-            07544269746D6170F6060000424DF60600000000000036000000280000002400
-            0000100000000100180000000000C0060000120B0000120B0000000000000000
-            0000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF000000000000000000000000000000
-            0000000000000000000000000000000000000000000000000000000000000000
-            0000000000000000000000000000000000000000000000000000000000000000
-            0000000000000000000000000000000000000000000000FFFFFF0000005C5C5C
-            5C5C5C5C5C5C5C5C5C5C5C5C5C5C5C5C5C5CC9C9C9C9C9C9C9C9C9C9C9C9C9C9
-            C9C9C9C9C9C9C9C9C9C9C9C9C9C9C9C9C9C9C9C9C9C9C9C9C9C9C9C9C9C9C9C9
-            C9C9C9C9C9C9C9C9C9C9C9C9C9C9C9C9C9C9C9C9C9C9C9C9C9C9C9C9C9C9C9C9
-            C9C9C90000000000005C5C5CC1C1C1C1C1C1C1C1C1C1C1C1C1C1C15C5C5C5C5C
-            5CDBDBDBDBDBDBA6A6A68D8D8D8D8D8D8D8D8D8D8D8D8D8D8DA6A6A6B4B4B4C9
-            C9C9A6A6A68D8D8D8D8D8D8D8D8D8D8D8DA6A6A6C9C9C9C9C9C9C9C9C9A5A5A5
-            8A8A8A878787999999ADADAD9D9D9D0000000000005C5C5CC1C1C100FF000000
-            FF00FF00C1C1C15C5C5CC1C1C15C5C5CE9E9E998989800FFFF00FFFF00FFFF00
-            FFFF00FFFF989898A0A0A0B4B4B498989800FFFF00FFFF00FFFF00FFFF989898
-            B4B4B4DBDBDBDBDBDB97979700FFFF00FFFF8E8E8EB9B9B9A5A5A50000000000
-            005C5C5CC1C1C1C1C1C1C1C1C1C1C1C1C1C1C15C5C5CC1C1C15C5C5CEEEEEEA0
-            A0A000FFFF00FFFFA0A0A0A0A0A000FFFF00FFFFA3A3A3A0A0A000FFFF00FFFF
-            A0A0A0A0A0A000FFFF00FFFFA0A0A0E9E9E9E9E9E9A0A0A000FFFF00FFFF9494
-            94BFBFBFADADAD0000000000005C5C5CC1C1C1C1C1C1C1C1C1C1C1C1C1C1C15C
-            5C5CC1C1C15C5C5CEEEEEEA3A3A300FFFF00FFFFA3A3A3A3A3A300FFFF00FFFF
-            A3A3A3A3A3A300FFFF00FFFFA3A3A3A3A3A300FFFF00FFFFA3A3A3EEEEEEEEEE
-            EEA3A3A300FFFF00FFFF979797C8C8C8B6B6B60000000000005C5C5CC1C1C1C1
-            C1C1C1C1C1C1C1C1C1C1C15C5C5CC1C1C15C5C5CEEEEEEA3A3A300FFFF00FFFF
-            A3A3A3A3A3A300FFFFA3A3A3C3C3C3A3A3A300FFFF00FFFFA3A3A3A3A3A300FF
-            FF00FFFFA3A3A3EEEEEEEEEEEEA3A3A300FFFF00FFFF989898CACACAB8B8B800
-            00000000005C5C5CC1C1C17E7E7E7E7E7E7E7E7EC1C1C15C5C5CC1C1C15C5C5C
-            EEEEEEA3A3A300FFFF00FFFF00FFFF00FFFF00FFFF00FFFFA3A3A3A3A3A300FF
-            FF00FFFFA3A3A3A3A3A300FFFF00FFFFA3A3A3EEEEEEEEEEEEA3A3A300FFFF00
-            FFFF9A9A9ACBCBCBB9B9B90000000000005C5C5CC1C1C1C1C1C1C1C1C1C1C1C1
-            C1C1C15C5C5CC1C1C15C5C5CEEEEEEA3A3A300FFFF00FFFFA3A3A3A3A3A300FF
-            FF00FFFFA3A3A3A3A3A300FFFF00FFFFA3A3A3A3A3A300FFFF00FFFFA3A3A3EE
-            EEEEEEEEEEA3A3A300FFFF00FFFF9B9B9BCECECEBCBCBC0000000000005C5C5C
-            C1C1C17E7E7E7E7E7E7E7E7EC1C1C15C5C5CC1C1C15C5C5CEEEEEEA3A3A300FF
-            FF00FFFFA3A3A3A3A3A300FFFF00FFFFA3A3A3A3A3A300FFFF00FFFFA3A3A3A3
-            A3A300FFFF00FFFFA3A3A3C3C3C3A3A3A3A3A3A300FFFF00FFFF9D9D9D939393
-            9F9F9F0000000000005C5C5CC1C1C1C1C1C1C1C1C1C1C1C1C1C1C15C5C5CC1C1
-            C15C5C5CEEEEEEA3A3A300FFFF00FFFF00FFFF00FFFF00FFFFA3A3A3C3C3C3C3
-            C3C3A3A3A300FFFF00FFFF00FFFF00FFFFA3A3A3C3C3C3A3A3A300FFFF00FFFF
-            00FFFF00FFFF00FFFF00FFFF8C8C8C0000000000005C5C5C5C5C5C5C5C5C5C5C
-            5C5C5C5C5C5C5C5C5C5CC1C1C15C5C5CEFEFEFC3C3C3A4A4A4A4A4A4A4A4A4A4
-            A4A4A4A4A4C3C3C3EFEFEFEFEFEFC3C3C3A4A4A4A4A4A4A4A4A4A4A4A4C3C3C3
-            EFEFEFC3C3C3A4A4A4A4A4A4A4A4A4A3A3A3A0A0A09A9A9AABABAB0000000000
-            00F3F3F35C5C5CC1C1C1C1C1C1C1C1C1C1C1C1C1C1C15C5C5C5C5C5CF0F0F0F0
-            F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0
-            F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0EEEEEEEBEB
-            EBE4E4E4D8D8D8000000FFFFFF00000000000000000000000000000000000000
-            0000000000000000000000000000000000000000000000000000000000000000
-            0000000000000000000000000000000000000000000000000000000000000000
-            00000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
-            FFFF}
-          Transparent = True
-          Visible = False
-        end
         object OptionsSpeedButton: TSpTBXSpeedButton
           Left = 328
           Top = 8
@@ -4625,8 +4567,8 @@
       000000000000}
   end
   object SortPopupMenu: TPopupMenu
-    Left = 584
-    Top = 80
+    Left = 728
+    Top = 40
     object Nosorting1: TMenuItem
       Caption = 'Don'#39't sort'
     end
@@ -6481,6 +6423,8 @@
           Caption = 'Get usernames by IP'
           OnClick = mnuFindIPClick
         end
+        object SpTBXSeparatorItem19: TSpTBXSeparatorItem
+        end
       end
       object SpTBXSeparatorItem11: TSpTBXSeparatorItem
       end
@@ -6507,6 +6451,8 @@
         Caption = 'Manage groups'
         OnClick = mnuManageGroupsClick
       end
+      object SpTBXSeparatorItem15: TSpTBXSeparatorItem
+      end
     end
   end
   object SearchFormPopupMenu: TSpTBXFormPopupMenu
@@ -6573,6 +6519,8 @@
       Caption = 'Display filters'
       OnClick = mnuDisplayFiltersClick
     end
+    object SpTBXSeparatorItem18: TSpTBXSeparatorItem
+    end
   end
   object HelpPopupMenu: TSpTBXPopupMenu
     Left = 448
@@ -6606,6 +6554,8 @@
         Caption = 'Glossary'
         OnClick = mnuGlossaryClick
       end
+      object SpTBXSeparatorItem20: TSpTBXSeparatorItem
+      end
     end
     object SpTBXItem6: TSpTBXItem
       Caption = 'Quick start'
@@ -6652,6 +6602,8 @@
         Caption = 'darkstars.co.uk/downloads/'
         OnClick = mnuDarkStarsClick
       end
+      object SpTBXSeparatorItem21: TSpTBXSeparatorItem
+      end
     end
     object mnuSpringReplays: TSpTBXItem
       Caption = 'Spring Replays'
@@ -6669,6 +6621,8 @@
       Caption = 'Beta lobby changelog'
       OnClick = SpTBXItem3Click
     end
+    object SpTBXSeparatorItem17: TSpTBXSeparatorItem
+    end
   end
   object HttpCli1: THttpCli
     LocalAddr = '0.0.0.0'
@@ -6689,7 +6643,7 @@
     Top = 163
   end
   object HostBattlePopupMenu: TSpTBXPopupMenu
-    Left = 100
+    Left = 104
     Top = 86
     object menuHostBattle: TSpTBXItem
       Caption = 'Host battle'
@@ -6710,6 +6664,8 @@
       ShortCut = 113
       OnClick = mnuBattleScreenClick
     end
+    object SpTBXSeparatorItem16: TSpTBXSeparatorItem
+    end
   end
   object ConnectionPopupMenu: TSpTBXPopupMenu
     OnPopup = ConnectionPopupMenuPopup
@@ -7117,13 +7073,6 @@
     Left = 524
     Top = 166
   end
-  object lobbyscriptWrapper: TPyDelphiWrapper
-    Engine = PyEngine
-    OnInitialization = lobbyscriptWrapperInitialization
-    Module = lobbyScriptModule
-    Left = 556
-    Top = 166
-  end
   object PyInOut: TPythonInputOutput
     OnSendData = PyInOutSendData
     UnicodeIO = False
@@ -7131,4 +7080,11 @@
     Left = 492
     Top = 166
   end
+  object lobbyscriptWrapper: TPyDelphiWrapper
+    Engine = PyEngine
+    OnInitialization = lobbyscriptWrapperInitialization
+    Module = lobbyScriptModule
+    Left = 556
+    Top = 166
+  end
 end

Modified: branches/0.77-branch/Lobby/TASClient/MainUnit.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/MainUnit.pas	2008-08-04 18:19:19 UTC (rev 6232)
+++ branches/0.77-branch/Lobby/TASClient/MainUnit.pas	2008-08-05 12:32:46 UTC (rev 6233)
@@ -521,7 +521,7 @@
 
 const
   VERSION_NUMBER = '0.38'; // Must be float value! (with a period as a decimal seperator)
-  CHECK_BETA_LOBBY_URL = '<A HREF="http://tasclient.no-ip.org/TASClient.txt">http://tasclient.no-ip.org/TASClient.txt</A>';
+  CHECK_BETA_LOBBY_URL = '<A HREF="http://tasclient.no-ip.org/TASClient_update_v2.txt">http://tasclient.no-ip.org/TASClient_update_v2.txt</A>';
   PROGRAM_VERSION = 'TASClient ' + VERSION_NUMBER + ' beta';
   KEEP_ALIVE_INTERVAL = 10000; // in milliseconds. Tells us what should be the maximum &quot;silence&quot; time before we send a ping to the server.
   ASSUME_TIMEOUT_INTERVAL = 30000; // in milliseconds. Must be greater than KEEP_ALIVE_INTERVAL! If server hasn't send any data to us within this interval, then we assume timeout occured. It's us who must make sure we get constant replies from server by pinging it.
@@ -707,7 +707,7 @@
 
   end;
 
-  TDialogThread = class(TThread)
+  TTASClientThread = class(TThread) //TDialogThread
   protected
     MsgT : string;
     DlgTypeT: TMsgDlgType;
@@ -722,7 +722,7 @@
     procedure ShowInputBox;
   end;
 
-  TKeepAliveThread = class(TDialogThread)
+  TKeepAliveThread = class(TTASClientThread)
   protected
     procedure Execute; override;
   end;
@@ -755,7 +755,7 @@
     constructor Create(Suspended : Boolean;hash: integer;name: string);
   end;
 
-  TCheckNewBetaLobbyThread = class(TDialogThread)
+  TCheckNewBetaLobbyThread = class(TTASClientThread)
   private
     confirmation: boolean;
 
@@ -1008,10 +1008,6 @@
     Panel1: TSpTBXPanel;
     Panel3: TPanel;
     Panel4: TSpTBXPanel;
-    DefaultSideImage: TImage;
-    DefaultArmImage: TImage;
-    DefaultCoreImage: TImage;
-    BotImage: TImage;
     OptionsSpeedButton: TSpTBXSpeedButton;
     BattleScreenSpeedButton: TSpTBXSpeedButton;
     HelpButton: TSpTBXSpeedButton;
@@ -1124,8 +1120,19 @@
     HttpCli3: THttpCli;
     PyEngine: TAtomPythonEngine;
     lobbyScriptModule: TPythonModule;
+    PyInOut: TPythonInputOutput;
+    SpTBXSeparatorItem15: TSpTBXSeparatorItem;
+    SpTBXSeparatorItem16: TSpTBXSeparatorItem;
+    SpTBXSeparatorItem17: TSpTBXSeparatorItem;
+    SpTBXSeparatorItem18: TSpTBXSeparatorItem;
+    SpTBXSeparatorItem19: TSpTBXSeparatorItem;
+    SpTBXSeparatorItem20: TSpTBXSeparatorItem;
+    SpTBXSeparatorItem21: TSpTBXSeparatorItem;
     lobbyscriptWrapper: TPyDelphiWrapper;
-    PyInOut: TPythonInputOutput;
+    BotImage: TImage;
+    DefaultArmImage: TImage;
+    DefaultSideImage: TImage;
+    DefaultCoreImage: TImage;
     procedure mnuOpenPrivateChatClick(Sender: TObject);
     procedure mnuSelectBattleClick(Sender: TObject);
     procedure SpTBXItem1Click(Sender: TObject);
@@ -1249,10 +1256,10 @@
     procedure btDeletePresetClick(Sender: TObject);
     procedure btClearPresetClick(Sender: TObject);
     procedure SinglePlayerButtonClick(Sender: TObject);
-    procedure lobbyscriptWrapperInitialization(Sender: TObject);
     procedure PyInOutSendData(Sender: TObject;
       const Data: String);
-
+    procedure SpTBXItem5Click(Sender: TObject);
+    procedure lobbyscriptWrapperInitialization(Sender: TObject);
   published
     MainTitleBar: TSpTBXTitleBar;
     Panel2: TSpTBXPanel;
@@ -1634,7 +1641,8 @@
   IgnoreListUnit, MuteListFormUnit, MapListFormUnit, SplashScreenUnit,
   LoginProgressFormUnit, GpIFF, SearchFormUnit, ManageGroups, ColorPicker,
   AwayMessageFormUnit,JclStrings, SearchPlayerFormUnit, MenuFormUnit, Utility,
-  PythonScriptDebugFormUnit,LobbyScriptUnit;
+  PythonScriptDebugFormUnit,LobbyScriptUnit, SpringDownloaderFormUnit,
+  SyncObjs;
 
 {$R *.dfm}
 
@@ -3346,7 +3354,10 @@
 
   try
     if FileExists(Application.ExeName + '.old') then
+    begin
       DeleteFile(Application.ExeName + '.old');
+      DelTree(ExtractFilePath(Application.ExeName)+'TASClientUpdateTemp\');
+    end;
   except
     // nothing
   end;
@@ -3455,6 +3466,8 @@
 
   FindIPQueueList := TStringList.Create;
 
+  SpringDownloaderFormUnit.DownloadList := TStringList.Create;
+
   // we have to set the splash screen title bar back to what it was before (since we changed it in OnFormCreate event):
   SplashScreenForm.UpdateText('creating forms ...'); // main form will change the update text, that is why we change it back again
 
@@ -3645,8 +3658,9 @@
     end;
 
     // check new version
-    if Preferences.CheckForNewVersion then
-      CheckNewVersion;
+    CheckNewVersion;
+
+    StartSpringDownloader;
    end;
 end;
 
@@ -5413,6 +5427,7 @@
       end;
 
       tmpBool := False;
+      BattleForm.Show;
       if Battle.BattleType = 0 then tmpBool := BattleForm.JoinBattle(i) else tmpBool := BattleForm.JoinBattleReplay(i);
       if tmpBool then
       begin
@@ -5476,7 +5491,6 @@
 
         BattleForm.SortBotList(Preferences.BattleClientSortStyle,Preferences.BattleClientSortDirection,True);
         BattleForm.SortClientList(Preferences.BattleClientSortStyle,Preferences.BattleClientSortDirection,True);
-        BattleForm.Show;
       end
       else MainForm.AddMainLog('Error: unable to join battle.', Colors.Error);
 
@@ -7015,6 +7029,7 @@
 var
   s: WideString;
   sUTF8: UTF8String;
+  i: integer;
 begin;
   // assign unique message(command) ID:
   if AssignID then
@@ -7035,6 +7050,11 @@
   AcquireMainThread;
   try
     s := handlers.handleOut(s);
+    i := Pos(#13,s);
+    if i = 0 then
+      i := Pos(#10,s);
+    if i &gt; 0 then
+      s := LeftStr(s,i-1);
     if s = '' then
     begin
       ReleaseMainThread;
@@ -7044,7 +7064,6 @@
   end;
   ReleaseMainThread;
 
-
   try
     sUTF8 := UTF8Encode(s+EOL);
     Socket.Send(PChar(sUTF8),length(sUTF8));
@@ -7676,13 +7695,15 @@
     if ModList.IndexOf(Battle.ModName) = -1 then
     begin
       if not LobbyScriptUnit.ScriptJoining then
-      if MessageDlg('Can''t join: you don''t have the right mod! Do you want to download it now?', mtInformation, [mbYes, mbNo], 0) = mrYes then begin
+      SpringDownloaderFormUnit.DownloadMod(0,Battle.ModName,Battle.ID);
+      Exit;
+      {if MessageDlg('Can''t join: you don''t have the right mod! Do you want to download it now?', mtInformation, [mbYes, mbNo], 0) = mrYes then begin
         //Misc.ParseDelimited(s1,Battle.ModName,' ','.');
         url := '<A HREF="http://spring.jobjol.nl/search_result.php?search=">http://spring.jobjol.nl/search_result.php?search=</A>'+Battle.ModName+'&amp;select=select_all';
         FixURL(url);
         Misc.OpenURLInDefaultBrowser(url);
       end;
-      Exit;
+      Exit;}
     end;
   end;
 
@@ -7760,6 +7781,7 @@
 begin
   AcquireMainThread;
   try handlers.onClose; except end;
+  //ReleaseMainThread;
 
   if Debug.Log then ((PageControl1.Pages[0] as TMyTabSheet).Controls[1] as TExRichEdit).Lines.SaveToFile(ExtractFilePath(Application.ExeName) + LOG_FILENAME);
   if FiltersButton.ImageIndex = 1 then
@@ -7780,6 +7802,8 @@
   if not RunningUnderWine then
     MenuForm.SaveSettings;
   SaveGroups;
+
+  CloseSpringDownloader;
 end;
 
 function TMainForm.LoadImagesDynamically: Boolean; // used for debugging purposes only
@@ -8555,6 +8579,7 @@
   if Button = mbRight then
   begin
     ClientsListBox.ItemIndex := ClientsListBox.ItemAtPos(Point(X, Y), True);
+    RichEditSelectedClient := nil;
     ClientPopupMenuInitPopup(nil,nil);
   end;
 end;
@@ -8918,17 +8943,17 @@
   Self.Maps := TStringList.Create;
 end;
 
-procedure TDialogThread.ShowLastMessage;
+procedure TTASClientThread.ShowLastMessage;
 begin
   MessageDlgReturn := MessageDlg(MsgT,DlgTypeT,ButtonsT,HelpCtxT);
 end;
 
-procedure TDialogThread.ShowInputBox;
+procedure TTASClientThread.ShowInputBox;
 begin
   InputBoxReturn := InputBox(ACaptionT,APromptT,ADefaultT);
 end;
 
-function TDialogThread.MessageDlgThread(const Msg: string; DlgType: TMsgDlgType;Buttons: TMsgDlgButtons; HelpCtx: Longint): Integer;
+function TTASClientThread.MessageDlgThread(const Msg: string; DlgType: TMsgDlgType;Buttons: TMsgDlgButtons; HelpCtx: Longint): Integer;
 begin
   MsgT := Msg;
   DlgTypeT := DlgType;
@@ -8939,7 +8964,7 @@
   Result := MessageDlgReturn;
 end;
 
-function TDialogThread.InputBoxThread(const ACaption, APrompt, ADefault: string): string;
+function TTASClientThread.InputBoxThread(const ACaption, APrompt, ADefault: string): string;
 begin
   ACaptionT := ACaption;
   APromptT := APrompt;
@@ -9739,7 +9764,9 @@
   while true do
   begin
     if Status.LoggedIn then
+    begin
       MainForm.TryToSendCommand('PING');
+    end;
     Sleep(8000);
   end;
 end;
@@ -10182,7 +10209,7 @@
 procedure TCheckNewBetaLobbyThread.Execute;
 var
   html : string;
-  parsedHtml: TStrings;
+  parsedHtml: TStringList;
 begin
   if FileExists(Application.ExeName + '.old') then
     DeleteFile(Application.ExeName + '.old');
@@ -10203,7 +10230,7 @@
     try
       HttpCli1.Get;
     except
-      MainForm.AddMainLog('Warning: Beta lobby version server unavailable.', Colors.Normal);
+      MainForm.AddMainLog('Warning: Lobby auto update server unavailable.', Colors.Normal);
       Exit;
     end;
     try
@@ -10211,10 +10238,19 @@
       SetLength(html, HttpCli1.RcvdStream.Size);
       HttpCli1.RcvdStream.ReadBuffer(Pointer(html)^, HttpCli1.RcvdStream.Size);
 
-      Misc.ParseDelimited(parsedHtml,html,' ','');
+      Misc.ParseDelimited(parsedHtml,html,EOL,#$A);
+
+      if parsedHtml.Count &lt;&gt; 2 then
+        RaiseException(0,0,0,0);
+
+      if Preferences.AutoUpdateToBeta or confirmation  then
+        Misc.ParseDelimited(parsedHtml,parsedHtml[0],' ','')
+      else
+        Misc.ParseDelimited(parsedHtml,parsedHtml[1],' ','');
+
       if StrToInt(parsedHtml[0]) &gt; Misc.GetLobbyRevision then
       begin
-        if not confirmation or (MessageDlgThread('A new beta version of the lobby is available, do you want to download it ?',mtInformation,[mbYes,mbNo],0) = mrYes) then
+        if not confirmation or (MessageDlgThread(StringReplace(MakeSentence(parsedHtml,2),'\n',EOL,[rfReplaceAll]),mtInformation,[mbYes,mbNo],0) = mrYes) then
         begin
           //Misc.OpenURLInDefaultBrowser(parsedHtml[1]);
             DownloadFile.URL := parsedHtml[1];
@@ -10227,6 +10263,7 @@
         if confirmation then
           MessageDlgThread('Your lobby version is up to date.',mtInformation,[mbOk],0);
     except
+      MainForm.AddMainLog('Warning: Auto-update file broken.', Colors.Normal);
       Exit;
     end;
   end;
@@ -10242,13 +10279,19 @@
   dlMap: TDownloadMapThread;
 begin
   if Utility.MapList.IndexOf(SelectedBattle.Map) = -1 then
+  begin
+    SpringDownloaderFormUnit.DownloadMap(SelectedBattle.MapHash,SelectedBattle.Map);
+    Exit;
     dlMap := TDownloadMapThread.Create(false,SelectedBattle.MapHash,SelectedBattle.Map);
+  end;
 end;
 
 procedure TMainForm.mnuBattleDlModClick(Sender: TObject);
 var
   url: string;
 begin
+  SpringDownloaderFormUnit.DownloadMod(SelectedBattle.HashCode,SelectedBattle.ModName);
+  Exit;
   url := '<A HREF="http://spring.jobjol.nl/search_result.php?search=">http://spring.jobjol.nl/search_result.php?search=</A>'+SelectedBattle.ModName+'&amp;select=select_all';
   FixURL(url);
   Misc.OpenURLInDefaultBrowser(url);
@@ -10464,25 +10507,17 @@
   MenuForm.Show;
 end;
 
-procedure TMainForm.lobbyscriptWrapperInitialization(Sender: TObject);
-var
-  p : PPyObject;
-begin
-  lobbyscriptWrapper.RegisterDelphiWrapper(TPyCallback);
-end;
-
 procedure TMainForm.initLobbyScript;
 begin
   if Preferences.DisableScripts then Exit;
   SysModule.path := NewPythonList;
   SysModule.path.append('.\'+SCRIPTS_FOLDER);
 
-  with PyEngine do
+  with GetPythonEngine do
   begin
     try
       handlers := Import('handlers');
 
-
       LobbyScriptUnit.MainInterpreterState := PyThreadState_Get.interp;
       LobbyScriptUnit.MainThreadState := PyThreadState_Get;
       LobbyScriptUnit.ScriptHostingRunning := False;
@@ -10512,4 +10547,19 @@
   PostMessage(PythonScriptDebugForm.Handle, WM_REFRESHOUTPUT, 0, 0);
 end;
 
+procedure TMainForm.SpTBXItem5Click(Sender: TObject);
+begin
+  HostBattlePopupMenu.Items.Add(TSpTBXItem.Create(HostBattlePopupMenu));
+  with HostBattlePopupMenu.Items[HostBattlePopupMenu.Items.Count-1] as TSpTBXItem do
+  begin
+    Caption := 'mega teuf';
+  end;
+end;
+
+procedure TMainForm.lobbyscriptWrapperInitialization(Sender: TObject);
+begin
+  lobbyscriptWrapper.RegisterDelphiWrapper(TPyCallback);
+  lobbyscriptWrapper.RegisterDelphiWrapper(TPyGUI);
+end;
+
 end.

Modified: branches/0.77-branch/Lobby/TASClient/Misc.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/Misc.pas	2008-08-04 18:19:19 UTC (rev 6232)
+++ branches/0.77-branch/Lobby/TASClient/Misc.pas	2008-08-05 12:32:46 UTC (rev 6233)
@@ -10,8 +10,10 @@
 interface
 
 uses
-  SpTBXItem,JvSpin,Dialogs, Classes, ComCtrls, Windows, Graphics, MMSystem, Controls, Registry, SysUtils,RichEdit2, ExRichEdit,
-  WSocket, Winsock, ESBDates, GpTimeZone, JvColorCombo, Forms,StdCtrls,HttpProt,TntComCtrls,JclUnicode,TntSysUtils,PreferencesFormUnit,Variants;
+  SpTBXItem,JvSpin,Dialogs, Classes, ComCtrls, Windows, Graphics, MMSystem,
+  Controls, Registry, SysUtils,RichEdit2, ExRichEdit, WSocket, Winsock,
+  ESBDates, GpTimeZone, JvColorCombo, Forms,StdCtrls,HttpProt,TntComCtrls,
+  JclUnicode,TntSysUtils,PreferencesFormUnit,Variants;
 
 type
   TColorData = Array[0..128000] Of TRGBTriple;
@@ -129,6 +131,8 @@
 function GetLongPathNameA(lpFileName:LPCTSTR;lpBuffer:LPTSTR;nBufferLength:DWORD): integer;stdcall; external 'Kernel32.dll';
 function  GetLongPathName(FileName: string): string;
 Function DelTree(DirName : string): Boolean;
+Function CopyTree(DirFrom : string; DirTo : string): LongInt;
+Function MoveTree(DirFrom : string; DirTo : string): LongInt;
 Function BitmapFlip(Const Vertical : Boolean;Const Horizontal : Boolean;var BitmapIn : TBitmap;out BitmapOut : TBitmap): Boolean;
 function ExtractFileNameFromUrl(url: string): string;
 function GetLobbyRevision: integer;
@@ -1961,17 +1965,14 @@
 Function DelTree(DirName : string): Boolean;
 var
   SHFileOpStruct : TSHFileOpStruct;
-  DirBuf : array [0..255] of char;
 begin
   if RightStr(DirName,1) = '\' then
     DirName := LeftStr(DirName,Length(DirName)-1);
   try
    Fillchar(SHFileOpStruct,Sizeof(SHFileOpStruct),0) ;
-   FillChar(DirBuf, Sizeof(DirBuf), 0 ) ;
-   StrPCopy(DirBuf, DirName) ;
    with SHFileOpStruct do begin
     Wnd := 0;
-    pFrom := @DirBuf;
+    pFrom := PChar(DirName);
     wFunc := FO_DELETE;
     //fFlags := FOF_ALLOWUNDO;  // add to the recycle bin instead of deleting
     fFlags := FOF_NOCONFIRMATION;
@@ -1983,6 +1984,68 @@
   end;
 end;
 
+Function CopyTree(DirFrom : string; DirTo : string): LongInt;
+var
+  SearchRec :TSearchRec;
+begin
+    if RightStr(DirFrom,1) = '\' then
+      DirFrom := LeftStr(DirFrom,Length(DirFrom)-1);
+    if RightStr(DirTo,1) = '\' then
+      DirTo := LeftStr(DirTo,Length(DirTo)-1);
+    Result := FindFirst(DirFrom+'\*.*', faAnyFile , SearchRec);
+    while Result = 0 do
+    begin
+      if not(SearchRec.name[1]='.') then
+      begin
+       if (SearchRec.attr and faDirectory) &lt;&gt; 0 then
+        begin
+            CopyTree(DirFrom +'\' + SearchRec.name,DirTo +'\' + SearchRec.name);
+        end
+        else
+        begin
+          try
+            if FileExists(DirTo+'\'+SearchRec.name) then
+              DeleteFile(DirTo+'\'+SearchRec.name);
+            CopyFile(PChar(DirFrom+'\'+SearchRec.name),PChar(DirTo+'\'+SearchRec.name),False);
+          except
+          end;
+        end;
+      end; //if . ..
+      Result := FindNext(SearchRec);
+    end;
+end;
+
+Function MoveTree(DirFrom : string; DirTo : string): LongInt;
+var
+  SearchRec :TSearchRec;
+begin
+    if RightStr(DirFrom,1) = '\' then
+      DirFrom := LeftStr(DirFrom,Length(DirFrom)-1);
+    if RightStr(DirTo,1) = '\' then
+      DirTo := LeftStr(DirTo,Length(DirTo)-1);
+    Result := FindFirst(DirFrom+'\*.*', faAnyFile , SearchRec);
+    while Result = 0 do
+    begin
+      if not(SearchRec.name[1]='.') then
+      begin
+       if (SearchRec.attr and faDirectory) &lt;&gt; 0 then
+        begin
+            MoveTree(DirFrom +'\' + SearchRec.name,DirTo +'\' + SearchRec.name);
+        end
+        else
+        begin
+          try
+            if FileExists(DirTo+'\'+SearchRec.name) then
+              DeleteFile(DirTo+'\'+SearchRec.name);
+            MoveFile(PChar(DirFrom+'\'+SearchRec.name),PChar(DirTo+'\'+SearchRec.name));
+          except
+          end;
+        end;
+      end; //if . ..
+      Result := FindNext(SearchRec);
+    end;
+end;
+
 Function BitmapFlip(Const Vertical : Boolean;Const Horizontal : Boolean;var BitmapIn : TBitmap;out BitmapOut : TBitmap): Boolean;
 Var
    DataIn : pColorData;

Modified: branches/0.77-branch/Lobby/TASClient/PreferencesFormUnit.dfm
===================================================================
--- branches/0.77-branch/Lobby/TASClient/PreferencesFormUnit.dfm	2008-08-04 18:19:19 UTC (rev 6232)
+++ branches/0.77-branch/Lobby/TASClient/PreferencesFormUnit.dfm	2008-08-05 12:32:46 UTC (rev 6233)
@@ -1,10 +1,10 @@
 object PreferencesForm: TPreferencesForm
-  Left = 415
-  Top = 204
+  Left = 775
+  Top = 122
   BorderStyle = bsDialog
   Caption = 'Preferences'
   ClientHeight = 392
-  ClientWidth = 377
+  ClientWidth = 415
   Color = clBtnFace
   Constraints.MaxHeight = 1000
   Constraints.MaxWidth = 1680
@@ -24,7 +24,7 @@
   object SpTBXTitleBar1: TSpTBXTitleBar
     Left = 0
     Top = 0
-    Width = 377
+    Width = 415
     Height = 392
     Caption = 'Preferences'
     FixedSize = True
@@ -34,243 +34,45 @@
     object SpTBXTabControl1: TSpTBXTabControl
       Left = 8
       Top = 32
-      Width = 361
+      Width = 401
       Height = 305
       Color = clBtnFace
-      ActiveTabIndex = 2
+      ActiveTabIndex = 6
       TabAutofit = True
       HiddenItems = &lt;&gt;
       object SpTBXTabItem6: TSpTBXTabItem
         Caption = 'Server'
-        CustomWidth = 59
+        CustomWidth = 56
       end
       object SpTBXTabItem5: TSpTBXTabItem
         Caption = 'Account'
-        CustomWidth = 59
+        CustomWidth = 56
       end
       object SpTBXTabItem4: TSpTBXTabItem
         Caption = 'Program'
-        Checked = True
-        CustomWidth = 59
+        CustomWidth = 56
       end
       object SpTBXTabItem3: TSpTBXTabItem
         Caption = 'Interface'
-        CustomWidth = 59
+        CustomWidth = 56
       end
       object SpTBXTabItem2: TSpTBXTabItem
         Caption = 'HTTP'
-        CustomWidth = 59
+        CustomWidth = 56
       end
       object SpTBXTabItem1: TSpTBXTabItem
         Caption = 'Skins'
-        CustomWidth = 59
+        CustomWidth = 56
       end
-      object SpTBXTabSheet1: TSpTBXTabSheet
-        Left = 0
-        Top = 23
-        Width = 361
-        Height = 282
-        Caption = 'Skins'
-        ImageIndex = -1
-        TabItem = 'SpTBXTabItem1'
-        object GroupBox5: TSpTBXGroupBox
-          Left = 16
-          Top = 8
-          Width = 329
-          Height = 257
-          Caption = 'Skin manager'
-          Color = clNone
-          ParentColor = False
-          TabOrder = 0
-          object ThemesComboBox: TSpTBXComboBox
-            Left = 48
-            Top = 144
-            Width = 145
-            Height = 21
-            Style = csDropDownList
-            ItemHeight = 13
-            TabOrder = 0
-            OnChange = ThemesComboBoxChange
-          end
-          object SpTBXRadioButton1: TSpTBXRadioButton
-            Left = 48
-            Top = 56
-            Width = 44
-            Height = 15
-            Caption = 'None'
-            TabOrder = 1
-            TabStop = True
-            OnClick = SpTBXRadioButton1Click
-            Checked = True
-          end
-          object SpTBXRadioButton2: TSpTBXRadioButton
-            Left = 48
-            Top = 72
-            Width = 62
-            Height = 15
-            Caption = 'Windows'
-            TabOrder = 2
-            OnClick = SpTBXRadioButton2Click
-          end
-          object Label3: TSpTBXLabel
-            Left = 32
-            Top = 120
-            Width = 85
-            Height = 13
-            Caption = 'Choose TBX skin:'
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
-          object SpTBXRadioButton3: TSpTBXRadioButton
-            Left = 48
-            Top = 88
-            Width = 76
-            Height = 15
-            Caption = 'TBX themes'
-            TabOrder = 4
-            OnClick = SpTBXRadioButton3Click
-          end
-          object Label11: TSpTBXLabel
-            Left = 32
-            Top = 32
-            Width = 60
-            Height = 13
-            Caption = 'Theme style:'
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
-        end
+      object SpTBXTabItem7: TSpTBXTabItem
+        Caption = 'Scripts'
+        Checked = True
+        CustomWidth = 56
       end
-      object SpTBXTabSheet2: TSpTBXTabSheet
-        Left = 0
-        Top = 23
-        Width = 361
-        Height = 282
-        Caption = 'HTTP'
-        ImageIndex = -1
-        TabItem = 'SpTBXTabItem2'
-        object GroupBox6: TSpTBXGroupBox
-          Left = 16
-          Top = 8
-          Width = 329
-          Height = 257
-          Caption = 'Proxy settings'
-          Color = clNone
-          ParentColor = False
-          TabOrder = 0
-          object UseProxyCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 32
-            Width = 65
-            Height = 15
-            Caption = 'Use proxy'
-            TabOrder = 0
-            OnClick = UseProxyCheckBoxClick
-            Checked = True
-            State = cbChecked
-          end
-          object ProxyPanel: TSpTBXPanel
-            Left = 24
-            Top = 56
-            Width = 249
-            Height = 113
-            Caption = 'ProxyPanel'
-            Color = clNone
-            ParentColor = False
-            TabOrder = 1
-            object ProxyEdit: TSpTBXEdit
-              Left = 64
-              Top = 8
-              Width = 177
-              Height = 21
-              TabOrder = 0
-            end
-            object Label7: TSpTBXLabel
-              Left = 8
-              Top = 8
-              Width = 41
-              Height = 13
-              Caption = 'Address:'
-              LinkFont.Charset = DEFAULT_CHARSET
-              LinkFont.Color = clBlue
-              LinkFont.Height = -11
-              LinkFont.Name = 'MS Sans Serif'
-              LinkFont.Style = [fsUnderline]
-            end
-            object Label8: TSpTBXLabel
-              Left = 8
-              Top = 32
-              Width = 22
-              Height = 13
-              Caption = 'Port:'
-              LinkFont.Charset = DEFAULT_CHARSET
-              LinkFont.Color = clBlue
-              LinkFont.Height = -11
-              LinkFont.Name = 'MS Sans Serif'
-              LinkFont.Style = [fsUnderline]
-            end
-            object JvProxyPortEdit: TJvValidateEdit
-              Left = 64
-              Top = 32
-              Width = 49
-              Height = 21
-              Alignment = taLeftJustify
-              CriticalPoints.MaxValueIncluded = False
-              CriticalPoints.MinValueIncluded = False
-              EditText = '0'
-              TabOrder = 3
-            end
-            object ProxyUserEdit: TSpTBXEdit
-              Left = 64
-              Top = 56
-              Width = 89
-              Height = 21
-              TabOrder = 4
-            end
-            object Label9: TSpTBXLabel
-              Left = 8
-              Top = 56
-              Width = 51
-              Height = 13
-              Caption = 'Username:'
-              LinkFont.Charset = DEFAULT_CHARSET
-              LinkFont.Color = clBlue
-              LinkFont.Height = -11
-              LinkFont.Name = 'MS Sans Serif'
-              LinkFont.Style = [fsUnderline]
-            end
-            object Label10: TSpTBXLabel
-              Left = 8
-              Top = 80
-              Width = 49
-              Height = 13
-              Caption = 'Password:'
-              LinkFont.Charset = DEFAULT_CHARSET
-              LinkFont.Color = clBlue
-              LinkFont.Height = -11
-              LinkFont.Name = 'MS Sans Serif'
-              LinkFont.Style = [fsUnderline]
-            end
-            object ProxyPassEdit: TSpTBXEdit
-              Left = 64
-              Top = 80
-              Width = 89
-              Height = 21
-              TabOrder = 7
-            end
-          end
-        end
-      end
       object SpTBXTabSheet6: TSpTBXTabSheet
         Left = 0
         Top = 23
-        Width = 361
+        Width = 401
         Height = 282
         Caption = 'Server'
         ImageIndex = -1
@@ -278,7 +80,7 @@
         object GroupBox1: TSpTBXGroupBox
           Left = 16
           Top = 8
-          Width = 329
+          Width = 369
           Height = 257
           Caption = 'Server settings'
           Color = clNone
@@ -345,10 +147,10 @@
           object ServerAddressEdit: TSpTBXButtonEdit
             Left = 96
             Top = 32
-            Width = 161
+            Width = 249
             Height = 21
             TabOrder = 0
-            EditButton.Left = 137
+            EditButton.Left = 225
             EditButton.Top = 0
             EditButton.Width = 20
             EditButton.Height = 17
@@ -363,7 +165,7 @@
             EditButton.LinkFont.Style = [fsUnderline]
           end
           object JvXPButton1: TSpTBXButton
-            Left = 184
+            Left = 272
             Top = 56
             Width = 73
             Height = 21
@@ -378,165 +180,10 @@
           end
         end
       end
-      object SpTBXTabSheet3: TSpTBXTabSheet
-        Left = 0
-        Top = 23
-        Width = 361
-        Height = 282
-        Caption = 'Interface'
-        ImageIndex = -1
-        TabItem = 'SpTBXTabItem3'
-        object GroupBox4: TSpTBXGroupBox
-          Left = 16
-          Top = 8
-          Width = 329
-          Height = 257
-          Caption = 'Interface preferences'
-          Color = clNone
-          ParentColor = False
-          TabOrder = 0
-          object CheckBox1: TSpTBXCheckBox
-            Left = 24
-            Top = 24
-            Width = 104
-            Height = 15
-            Caption = 'Timestamp events'
-            TabOrder = 0
-            Checked = True
-            State = cbChecked
-          end
-          object CheckBox3: TSpTBXCheckBox
-            Left = 24
-            Top = 40
-            Width = 128
-            Height = 15
-            Caption = 'Filter join/left messages'
-            TabOrder = 1
-          end
-          object CheckBox4: TSpTBXCheckBox
-            Left = 24
-            Top = 72
-            Width = 108
-            Height = 15
-            Caption = 'Show country flags'
-            TabOrder = 2
-            Checked = True
-            State = cbChecked
-          end
-          object CheckBox5: TSpTBXCheckBox
-            Left = 24
-            Top = 88
-            Width = 147
-            Height = 15
-            Caption = 'Mark unknown maps/mods'
-            TabOrder = 3
-            Checked = True
-            State = cbChecked
-          end
-          object CheckBox6: TSpTBXCheckBox
-            Left = 24
-            Top = 104
-            Width = 251
-            Height = 15
-            Caption = 'Use taskbar button for each form (requires restart)'
-            TabOrder = 4
-          end
-          object WarnNATCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 120
-            Width = 271
-            Height = 15
-            Caption = 'Display warning icons on battles using NAT traversing'
-            TabOrder = 5
-            Checked = True
-            State = cbChecked
-          end
-          object AutoFocusOnPMCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 136
-            Width = 262
-            Height = 15
-            Caption = 'Automatically switch focus to new private messages'
-            TabOrder = 6
-            Checked = True
-            State = cbChecked
-          end
-          object DisableAllSoundsCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 152
-            Width = 103
-            Height = 15
-            Caption = 'Disable all sounds'
-            TabOrder = 7
-          end
-          object UploadReplayCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 232
-            Width = 245
-            Height = 15
-            Caption = 'Ask to upload replay after the end of each battle'
-            TabOrder = 8
-            Visible = False
-          end
-          object SortLocalCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 168
-            Width = 132
-            Height = 15
-            Caption = 'Sort the $local player list'
-            TabOrder = 9
-          end
-          object DisplayQuickJoinPanelCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 184
-            Width = 131
-            Height = 15
-            Caption = 'Display Quick join panel'
-            TabOrder = 10
-          end
-          object FilterBattleJoinLeftCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 56
-            Width = 157
-            Height = 15
-            Caption = 'Filter battle join/left messages'
-            TabOrder = 11
-          end
-          object AutoCompletionCurrentChannelCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 200
-            Width = 252
-            Height = 15
-            Caption = 'Auto-completion from current channel'#39's players list'
-            TabOrder = 12
-          end
-          object ChatLogsLimitCheckBox: TSpTBXCheckBox
-            Left = 24
-            Top = 216
-            Width = 145
-            Height = 15
-            Caption = 'Limit chat logs to 800 lines '
-            TabOrder = 13
-          end
-          object ChatLogsLimitTracker: TSpTBXTrackBar
-            Left = 184
-            Top = 216
-            Width = 121
-            Height = 17
-            Max = 3000
-            Min = 50
-            Frequency = 100
-            Position = 800
-            TabOrder = 14
-            ThumbLength = 10
-            OnChange = ChatLogsLimitTrackerChange
-          end
-        end
-      end
       object SpTBXTabSheet5: TSpTBXTabSheet
         Left = 0
         Top = 23
-        Width = 361
+        Width = 401
         Height = 282
         Caption = 'Account'
         ImageIndex = -1
@@ -544,7 +191,7 @@
         object GroupBox2: TSpTBXGroupBox
           Left = 16
           Top = 8
-          Width = 329
+          Width = 369
           Height = 257
           Caption = 'Account details'
           Color = clNone
@@ -658,7 +305,7 @@
       object SpTBXTabSheet4: TSpTBXTabSheet
         Left = 0
         Top = 23
-        Width = 361
+        Width = 401
         Height = 282
         Caption = 'Program'
         ImageIndex = -1
@@ -666,14 +313,14 @@
         object GroupBox3: TSpTBXGroupBox
           Left = 16
           Top = 8
-          Width = 329
+          Width = 369
           Height = 257
           Caption = 'Program settings'
           Color = clNone
           ParentColor = False
           TabOrder = 0
           object ResetRegistryButton: TSpTBXSpeedButton
-            Left = 200
+            Left = 240
             Top = 224
             Width = 113
             Height = 22
@@ -686,7 +333,7 @@
             LinkFont.Style = [fsUnderline]
           end
           object GameSettingsButton: TSpTBXSpeedButton
-            Left = 200
+            Left = 240
             Top = 96
             Width = 113
             Height = 22
@@ -699,7 +346,7 @@
             LinkFont.Style = [fsUnderline]
           end
           object NotificationsButton: TSpTBXSpeedButton
-            Left = 200
+            Left = 240
             Top = 48
             Width = 113
             Height = 22
@@ -712,7 +359,7 @@
             LinkFont.Style = [fsUnderline]
           end
           object HighlightingButton: TSpTBXSpeedButton
-            Left = 200
+            Left = 240
             Top = 24
             Width = 113
             Height = 22
@@ -725,7 +372,7 @@
             LinkFont.Style = [fsUnderline]
           end
           object IgnoreListButton: TSpTBXSpeedButton
-            Left = 200
+            Left = 240
             Top = 72
             Width = 113
             Height = 22
@@ -796,7 +443,7 @@
             State = cbChecked
           end
           object KeyEditorButton: TSpTBXSpeedButton
-            Left = 200
+            Left = 240
             Top = 120
             Width = 113
             Height = 22
@@ -817,7 +464,7 @@
             TabOrder = 12
           end
           object ColorsButton: TSpTBXButton
-            Left = 200
+            Left = 240
             Top = 144
             Width = 113
             Height = 22
@@ -831,7 +478,7 @@
             LinkFont.Style = [fsUnderline]
           end
           object ManageGroupsButton: TSpTBXButton
-            Left = 200
+            Left = 240
             Top = 168
             Width = 113
             Height = 22
@@ -846,9 +493,431 @@
           end
         end
       end
+      object SpTBXTabSheet3: TSpTBXTabSheet
+        Left = 0
+        Top = 23
+        Width = 401
+        Height = 282
+        Caption = 'Interface'
+        ImageIndex = -1
+        TabItem = 'SpTBXTabItem3'
+        object GroupBox4: TSpTBXGroupBox
+          Left = 16
+          Top = 8
+          Width = 369
+          Height = 257
+          Caption = 'Interface preferences'
+          Color = clNone
+          ParentColor = False
+          TabOrder = 0
+          object CheckBox1: TSpTBXCheckBox
+            Left = 24
+            Top = 24
+            Width = 104
+            Height = 15
+            Caption = 'Timestamp events'
+            TabOrder = 0
+            Checked = True
+            State = cbChecked
+          end
+          object CheckBox3: TSpTBXCheckBox
+            Left = 24
+            Top = 40
+            Width = 128
+            Height = 15
+            Caption = 'Filter join/left messages'
+            TabOrder = 1
+          end
+          object CheckBox4: TSpTBXCheckBox
+            Left = 24
+            Top = 72
+            Width = 108
+            Height = 15
+            Caption = 'Show country flags'
+            TabOrder = 2
+            Checked = True
+            State = cbChecked
+          end
+          object CheckBox5: TSpTBXCheckBox
+            Left = 24
+            Top = 88
+            Width = 147
+            Height = 15
+            Caption = 'Mark unknown maps/mods'
+            TabOrder = 3
+            Checked = True
+            State = cbChecked
+          end
+          object CheckBox6: TSpTBXCheckBox
+            Left = 24
+            Top = 104
+            Width = 251
+            Height = 15
+            Caption = 'Use taskbar button for each form (requires restart)'
+            TabOrder = 4
+          end
+          object WarnNATCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 120
+            Width = 271
+            Height = 15
+            Caption = 'Display warning icons on battles using NAT traversing'
+            TabOrder = 5
+            Checked = True
+            State = cbChecked
+          end
+          object AutoFocusOnPMCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 136
+            Width = 262
+            Height = 15
+            Caption = 'Automatically switch focus to new private messages'
+            TabOrder = 6
+            Checked = True
+            State = cbChecked
+          end
+          object DisableAllSoundsCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 152
+            Width = 103
+            Height = 15
+            Caption = 'Disable all sounds'
+            TabOrder = 7
+          end
+          object UploadReplayCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 232
+            Width = 245
+            Height = 15
+            Caption = 'Ask to upload replay after the end of each battle'
+            TabOrder = 8
+            Visible = False
+          end
+          object SortLocalCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 168
+            Width = 132
+            Height = 15
+            Caption = 'Sort the $local player list'
+            TabOrder = 9
+          end
+          object DisplayQuickJoinPanelCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 184
+            Width = 131
+            Height = 15
+            Caption = 'Display Quick join panel'
+            TabOrder = 10
+          end
+          object FilterBattleJoinLeftCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 56
+            Width = 157
+            Height = 15
+            Caption = 'Filter battle join/left messages'
+            TabOrder = 11
+          end
+          object AutoCompletionCurrentChannelCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 200
+            Width = 252
+            Height = 15
+            Caption = 'Auto-completion from current channel'#39's players list'
+            TabOrder = 12
+          end
+          object ChatLogsLimitCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 216
+            Width = 145
+            Height = 15
+            Caption = 'Limit chat logs to 800 lines '
+            TabOrder = 13
+          end
+          object ChatLogsLimitTracker: TSpTBXTrackBar
+            Left = 184
+            Top = 216
+            Width = 121
+            Height = 17
+            Max = 3000
+            Min = 50
+            Frequency = 100
+            Position = 800
+            TabOrder = 14
+            ThumbLength = 10
+            OnChange = ChatLogsLimitTrackerChange
+          end
+        end
+      end
+      object SpTBXTabSheet2: TSpTBXTabSheet
+        Left = 0
+        Top = 23
+        Width = 401
+        Height = 282
+        Caption = 'HTTP'
+        ImageIndex = -1
+        TabItem = 'SpTBXTabItem2'
+        object GroupBox6: TSpTBXGroupBox
+          Left = 16
+          Top = 8
+          Width = 369
+          Height = 257
+          Caption = 'Proxy settings'
+          Color = clNone
+          ParentColor = False
+          TabOrder = 0
+          object UseProxyCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 32
+            Width = 65
+            Height = 15
+            Caption = 'Use proxy'
+            TabOrder = 0
+            OnClick = UseProxyCheckBoxClick
+            Checked = True
+            State = cbChecked
+          end
+          object ProxyPanel: TSpTBXPanel
+            Left = 24
+            Top = 56
+            Width = 321
+            Height = 113
+            Caption = 'ProxyPanel'
+            Color = clNone
+            ParentColor = False
+            TabOrder = 1
+            object ProxyEdit: TSpTBXEdit
+              Left = 64
+              Top = 8
+              Width = 241
+              Height = 21
+              TabOrder = 0
+            end
+            object Label7: TSpTBXLabel
+              Left = 8
+              Top = 8
+              Width = 41
+              Height = 13
+              Caption = 'Address:'
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object Label8: TSpTBXLabel
+              Left = 8
+              Top = 32
+              Width = 22
+              Height = 13
+              Caption = 'Port:'
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object JvProxyPortEdit: TJvValidateEdit
+              Left = 64
+              Top = 32
+              Width = 49
+              Height = 21
+              Alignment = taLeftJustify
+              CriticalPoints.MaxValueIncluded = False
+              CriticalPoints.MinValueIncluded = False
+              EditText = '0'
+              TabOrder = 3
+            end
+            object ProxyUserEdit: TSpTBXEdit
+              Left = 64
+              Top = 56
+              Width = 121
+              Height = 21
+              TabOrder = 4
+            end
+            object Label9: TSpTBXLabel
+              Left = 8
+              Top = 56
+              Width = 51
+              Height = 13
+              Caption = 'Username:'
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object Label10: TSpTBXLabel
+              Left = 8
+              Top = 80
+              Width = 49
+              Height = 13
+              Caption = 'Password:'
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object ProxyPassEdit: TSpTBXEdit
+              Left = 64
+              Top = 80
+              Width = 121
+              Height = 21
+              TabOrder = 7
+            end
+          end
+        end
+      end
+      object SpTBXTabSheet1: TSpTBXTabSheet
+        Left = 0
+        Top = 23
+        Width = 401
+        Height = 282
+        Caption = 'Skins'
+        ImageIndex = -1
+        TabItem = 'SpTBXTabItem1'
+        object GroupBox5: TSpTBXGroupBox
+          Left = 16
+          Top = 8
+          Width = 361
+          Height = 257
+          Caption = 'Skin manager'
+          Color = clNone
+          ParentColor = False
+          TabOrder = 0
+          object ThemesComboBox: TSpTBXComboBox
+            Left = 48
+            Top = 144
+            Width = 177
+            Height = 21
+            Style = csDropDownList
+            ItemHeight = 13
+            TabOrder = 0
+            OnChange = ThemesComboBoxChange
+          end
+          object SpTBXRadioButton1: TSpTBXRadioButton
+            Left = 48
+            Top = 56
+            Width = 44
+            Height = 15
+            Caption = 'None'
+            TabOrder = 1
+            TabStop = True
+            OnClick = SpTBXRadioButton1Click
+            Checked = True
+          end
+          object SpTBXRadioButton2: TSpTBXRadioButton
+            Left = 48
+            Top = 72
+            Width = 62
+            Height = 15
+            Caption = 'Windows'
+            TabOrder = 2
+            OnClick = SpTBXRadioButton2Click
+          end
+          object Label3: TSpTBXLabel
+            Left = 32
+            Top = 120
+            Width = 85
+            Height = 13
+            Caption = 'Choose TBX skin:'
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
+          end
+          object SpTBXRadioButton3: TSpTBXRadioButton
+            Left = 48
+            Top = 88
+            Width = 76
+            Height = 15
+            Caption = 'TBX themes'
+            TabOrder = 4
+            OnClick = SpTBXRadioButton3Click
+          end
+          object Label11: TSpTBXLabel
+            Left = 32
+            Top = 32
+            Width = 60
+            Height = 13
+            Caption = 'Theme style:'
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
+          end
+        end
+      end
+      object SpTBXTabSheet7: TSpTBXTabSheet
+        Left = 0
+        Top = 23
+        Width = 401
+        Height = 282
+        Caption = 'Scripts'
+        ImageIndex = -1
+        TabItem = 'SpTBXTabItem7'
+        object ScriptsDebugWindowBt: TSpTBXButton
+          Left = 136
+          Top = 32
+          Width = 137
+          Height = 25
+          Caption = 'Debug Window'
+          TabOrder = 0
+          OnClick = ScriptsDebugWindowBtClick
+          LinkFont.Charset = DEFAULT_CHARSET
+          LinkFont.Color = clBlue
+          LinkFont.Height = -11
+          LinkFont.Name = 'MS Sans Serif'
+          LinkFont.Style = [fsUnderline]
+        end
+        object ScriptsReloadBt: TSpTBXButton
+          Left = 136
+          Top = 64
+          Width = 137
+          Height = 25
+          Caption = 'Reload scripts'
+          TabOrder = 1
+          OnClick = ScriptsReloadBtClick
+          LinkFont.Charset = DEFAULT_CHARSET
+          LinkFont.Color = clBlue
+          LinkFont.Height = -11
+          LinkFont.Name = 'MS Sans Serif'
+          LinkFont.Style = [fsUnderline]
+        end
+        object ScriptsLoadNewBt: TSpTBXButton
+          Left = 136
+          Top = 96
+          Width = 137
+          Height = 25
+          Caption = 'Load new scripts'
+          TabOrder = 2
+          OnClick = ScriptsLoadNewBtClick
+          LinkFont.Charset = DEFAULT_CHARSET
+          LinkFont.Color = clBlue
+          LinkFont.Height = -11
+          LinkFont.Name = 'MS Sans Serif'
+          LinkFont.Style = [fsUnderline]
+        end
+        object ScriptsAdvancedOptionsBt: TSpTBXButton
+          Left = 136
+          Top = 128
+          Width = 137
+          Height = 25
+          Caption = 'Advanced options'
+          TabOrder = 3
+          OnClick = ScriptsAdvancedOptionsBtClick
+          LinkFont.Charset = DEFAULT_CHARSET
+          LinkFont.Color = clBlue
+          LinkFont.Height = -11
+          LinkFont.Name = 'MS Sans Serif'
+          LinkFont.Style = [fsUnderline]
+        end
+      end
     end
     object ApplyAndCloseButton: TSpTBXButton
-      Left = 24
+      Left = 43
       Top = 352
       Width = 145
       Height = 25
@@ -862,7 +931,7 @@
       LinkFont.Style = [fsUnderline]
     end
     object CancelAndCloseButton: TSpTBXButton
-      Left = 208
+      Left = 227
       Top = 352
       Width = 145
       Height = 25
@@ -879,7 +948,7 @@
   end
   object AddressPopupMenu: TSpTBXPopupMenu
     Left = 340
-    Top = 32
+    Top = 56
   end
   object HttpCli1: THttpCli
     LocalAddr = '0.0.0.0'

Modified: branches/0.77-branch/Lobby/TASClient/PreferencesFormUnit.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/PreferencesFormUnit.pas	2008-08-04 18:19:19 UTC (rev 6232)
+++ branches/0.77-branch/Lobby/TASClient/PreferencesFormUnit.pas	2008-08-05 12:32:46 UTC (rev 6233)
@@ -49,7 +49,7 @@
     SaveLogs: Boolean; // if true, program will automatically save all channel, private chat and battle logs.
     UseSoundNotifications: Boolean;
     AutoCompletionFromCurrentChannel: Boolean;
-    CheckForNewVersion: Boolean;
+    AutoUpdateToBeta: Boolean;
 
     UseProxy: Boolean;
     ProxyAddress: string;
@@ -169,6 +169,12 @@
     AutoCompletionCurrentChannelCheckBox: TSpTBXCheckBox;
     ChatLogsLimitCheckBox: TSpTBXCheckBox;
     ChatLogsLimitTracker: TSpTBXTrackBar;
+    SpTBXTabItem7: TSpTBXTabItem;
+    SpTBXTabSheet7: TSpTBXTabSheet;
+    ScriptsDebugWindowBt: TSpTBXButton;
+    ScriptsReloadBt: TSpTBXButton;
+    ScriptsLoadNewBt: TSpTBXButton;
+    ScriptsAdvancedOptionsBt: TSpTBXButton;
 
     function BattleSortStyleToColumn(SortStyle: Integer): Integer;
     function ColumnToBattleSortStyle(Column: Integer): Integer;
@@ -213,6 +219,10 @@
     procedure ManageGroupsButtonClick(Sender: TObject);
     procedure ChatLogsLimitTrackerChange(Sender: TObject);
     procedure PasswordEditChange(Sender: TObject);
+    procedure ScriptsReloadBtClick(Sender: TObject);
+    procedure ScriptsLoadNewBtClick(Sender: TObject);
+    procedure ScriptsDebugWindowBtClick(Sender: TObject);
+    procedure ScriptsAdvancedOptionsBtClick(Sender: TObject);
   private
     { Private declarations }
   public
@@ -225,7 +235,7 @@
     Address: string;
   end;
 
-  TLadderCheckAccountThread = class(TDialogThread)
+  TLadderCheckAccountThread = class(TTASClientThread)
   private
     password : string;
     isOnTheFlyCheck : boolean; // means it is check the actual saved password
@@ -238,7 +248,7 @@
     constructor Create(Suspended: Boolean;passToCheck: string;onTheFlyCheck : boolean);
   end;
 
-  TLadderCreateAccountThread = class(TDialogThread)
+  TLadderCreateAccountThread = class(TTASClientThread)
   private
     procedure CreateAccount;
     procedure OnTerminateProcedure(Sender : TObject);
@@ -248,7 +258,7 @@
     constructor Create(Suspended : Boolean);
   end;
 
-  TLadderRenameAccountThread = class(TDialogThread)
+  TLadderRenameAccountThread = class(TTASClientThread)
   private
     UserName : string;
     procedure RenameAccount;
@@ -261,7 +271,7 @@
   end;
 
 const
-  DEFAULT_PREFERENCES: TPreferences = (ServerIP:'taspringmaster.clan-sy.com'; ServerPort:'8200'; TabStyle:0; TimeStamps: True; Username:''; Password:''; ConnectOnStartup: False; SortStyle: 1; BattleSortStyle: 1; BattleSortDirection: 0; BattleClientSortStyle: 2;FilterJoinLeftMessages: False;FilterBattleJoinLeftMessages: False; ShowFlags: True; MarkUnknownMaps: True; TaskbarButtons: True; JoinMainChannel: True; ReconnectToBackup: True; SaveLogs: True; UseSoundNotifications: True;AutoCompletionFromCurrentChannel: False; CheckForNewVersion: False; UseProxy: False; HighlightColor: 'Green'; UseNotificationsForHighlights: True; UseIgnoreList: False; WarnIfUsingNATTraversing: True; AutoFocusOnPM: True; MapSortStyle: 1; ThemeType: thtTBX; Theme: 'Miranda'; DisableAllSounds: False; SortLocal: False; DisplayQuickJoinPanel : True; LimitChatLogs: False; ChatLogsLimit: 800; SPSkin: 'default.ssk'; DisableScripts : False);
+  DEFAULT_PREFERENCES: TPreferences = (ServerIP:'taspringmaster.clan-sy.com'; ServerPort:'8200'; TabStyle:0; TimeStamps: True; Username:''; Password:''; ConnectOnStartup: False; SortStyle: 1; BattleSortStyle: 1; BattleSortDirection: 0; BattleClientSortStyle: 2;FilterJoinLeftMessages: False;FilterBattleJoinLeftMessages: False; ShowFlags: True; MarkUnknownMaps: False; TaskbarButtons: True; JoinMainChannel: True; ReconnectToBackup: True; SaveLogs: True; UseSoundNotifications: True;AutoCompletionFromCurrentChannel: False; AutoUpdateToBeta: False; UseProxy: False; HighlightColor: 'Green'; UseNotificationsForHighlights: True; UseIgnoreList: False; WarnIfUsingNATTraversing: True; AutoFocusOnPM: True; MapSortStyle: 1; ThemeType: thtTBX; Theme: 'Miranda'; DisableAllSounds: False; SortLocal: False; DisplayQuickJoinPanel : True; LimitChatLogs: False; ChatLogsLimit: 800; SPSkin: 'default.ssk'; DisableScripts : False);
 
 var
   PreferencesForm: TPreferencesForm;
@@ -296,7 +306,7 @@
 uses Misc, ShellAPI, Registry, BattleFormUnit, HostBattleFormUnit, Math,
   OnlineMapsUnit, NotificationsUnit, PerformFormUnit, HighlightingUnit,
   NewAccountUnit, IgnoreListUnit, MapListFormUnit, ColorsPreferenceUnit,
-  ManageGroups, ReplaysUnit;
+  ManageGroups, ReplaysUnit, PythonScriptDebugFormUnit, LobbyScriptUnit;
 
 {$R *.dfm}
 
@@ -322,7 +332,7 @@
     try Preferences.FilterBattleJoinLeftMessages := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'FilterBattleJoinLeftMessages'); except end;
     try Preferences.AutoCompletionFromCurrentChannel := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'AutoCompletionFromCurrentChannel'); except end;
     try Preferences.ShowFlags := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'ShowFlags'); except end;
-    try Preferences.MarkUnknownMaps := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'MarkUnknownMaps'); except end;
+    try Preferences.MarkUnknownMaps := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'MarkUnknownMapsNMods'); except end;
     try Preferences.TaskbarButtons := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'TaskbarButtons'); except end;
     try Preferences.JoinMainChannel := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'JoinMainChannel'); except end;
     try Preferences.ReconnectToBackup := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'ReconnectToBackup'); except end;
@@ -335,7 +345,7 @@
     try Preferences.ProxyPassword:= Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'ProxyPassword'); except end;
     try Preferences.HighlightColor:= Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'HighlightColor'); except end;
     try Preferences.UseNotificationsForHighlights := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'UseNotificationsForHighlights'); except end;
-    try Preferences.CheckForNewVersion := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'CheckForNewVersion'); except end;
+    try Preferences.AutoUpdateToBeta := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'CheckForNewVersion'); except end;
     try Preferences.UseIgnoreList := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'UseIgnoreList'); except end;
     try Preferences.WarnIfUsingNATTraversing := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'WarnIfUsingNATTraversing'); except end;
     try Preferences.AutoFocusOnPM := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'AutoFocusOnPM'); except end;
@@ -592,7 +602,7 @@
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'FilterBattleJoinLeftMessages', rdInteger, Misc.BoolToInt(Preferences.FilterBattleJoinLeftMessages));
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'AutoCompletionFromCurrentChannel', rdInteger, Misc.BoolToInt(Preferences.AutoCompletionFromCurrentChannel));
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'ShowFlags', rdInteger, Misc.BoolToInt(Preferences.ShowFlags));
-    Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'MarkUnknownMaps', rdInteger, Misc.BoolToInt(Preferences.MarkUnknownMaps));
+    Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'MarkUnknownMapsNMods', rdInteger, Misc.BoolToInt(Preferences.MarkUnknownMaps));
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'TaskbarButtons', rdInteger, Misc.BoolToInt(Preferences.TaskbarButtons));
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'JoinMainChannel', rdInteger, Misc.BoolToInt(Preferences.JoinMainChannel));
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'ReconnectToBackup', rdInteger, Misc.BoolToInt(Preferences.ReconnectToBackup));
@@ -605,7 +615,7 @@
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'ProxyPassword', rdString, Preferences.ProxyPassword);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'HighlightColor', rdString, Preferences.HighlightColor);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'UseNotificationsForHighlights', rdInteger, Preferences.UseNotificationsForHighlights);
-    Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'CheckForNewVersion', rdInteger, Misc.BoolToInt(Preferences.CheckForNewVersion));
+    Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'CheckForNewVersion', rdInteger, Misc.BoolToInt(Preferences.AutoUpdateToBeta));
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'UseIgnoreList', rdInteger, Preferences.UseIgnoreList);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'WarnIfUsingNATTraversing', rdInteger, Preferences.WarnIfUsingNATTraversing);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'AutoFocusOnPM', rdInteger, Preferences.AutoFocusOnPM);
@@ -786,7 +796,7 @@
   p.SaveLogs := CheckBox8.Checked;
   p.UseSoundNotifications := CheckBox9.Checked;
   p.AutoCompletionFromCurrentChannel := AutoCompletionCurrentChannelCheckBox.Checked;
-  p.CheckForNewVersion := CheckForNewVersionCheckBox.Checked;
+  p.AutoUpdateToBeta := CheckForNewVersionCheckBox.Checked;
 
   p.UseProxy := UseProxyCheckBox.Checked;
   p.ProxyAddress := ProxyEdit.Text;
@@ -855,7 +865,7 @@
   CheckBox8.Checked := p.SaveLogs;
   CheckBox9.Checked := p.UseSoundNotifications;
   AutoCompletionCurrentChannelCheckBox.Checked := p.AutoCompletionFromCurrentChannel;
-  CheckForNewVersionCheckBox.Checked := p.CheckForNewVersion;
+  CheckForNewVersionCheckBox.Checked := p.AutoUpdateToBeta;
 
   UseProxyCheckBox.Checked := p.UseProxy;
   ProxyEdit.Text := p.ProxyAddress;
@@ -1409,4 +1419,30 @@
   PasswordChanged := true;
 end;
 
+procedure TPreferencesForm.ScriptsReloadBtClick(Sender: TObject);
+begin
+  AcquireMainThread;
+  try handlers._reloadall; except end;
+  ReleaseMainThread;
+end;
+
+procedure TPreferencesForm.ScriptsLoadNewBtClick(Sender: TObject);
+begin
+  AcquireMainThread;
+  try handlers._load; except end;
+  ReleaseMainThread;
+end;
+
+procedure TPreferencesForm.ScriptsDebugWindowBtClick(Sender: TObject);
+begin
+  PythonScriptDebugForm.Show;
+end;
+
+procedure TPreferencesForm.ScriptsAdvancedOptionsBtClick(Sender: TObject);
+begin
+  AcquireMainThread;
+  try handlers.showOptions; except end;
+  ReleaseMainThread;
+end;
+
 end.

Modified: branches/0.77-branch/Lobby/TASClient/Python/api.txt
===================================================================
--- branches/0.77-branch/Lobby/TASClient/Python/api.txt	2008-08-04 18:19:19 UTC (rev 6232)
+++ branches/0.77-branch/Lobby/TASClient/Python/api.txt	2008-08-05 12:32:46 UTC (rev 6233)
@@ -1,3 +1,6 @@
+Callback class
+--------------
+
 callout :
 
 - Disconnect
@@ -18,7 +21,7 @@
 - ShowDebugWindow
 - SocketConnect(ip,port)
 - HostBattle(nbPlayers, RankLimit, ModName, Description, Password, UDPHostPort, NatTraversal) return true if success
-- JoinBattle(BattleId,PassWord)
+- JoinBattle(BattleId)
 - GetReplays
 - HostReplay(replayFile, nbPlayers, RankLimit, Description, Password, UDPHostPort, NatTraversal) return true if success
 - LeaveBattle
@@ -36,3 +39,45 @@
 - onConnected
 - onClose
 
+
+
+GUI Class
+---------
+
+callout :
+
+menuName = [HostBattle, Help, HelpWiki, HelpDownload, BattleItem (returning the BattleId), PlayerItem (Returning the Player Name), PlayerItemModeration (Returning the Player Name), BattlePlayerItem (Returning the Player Name), BattleMinimap, BattleAdmin, BattleAdminBalance, BattleAdminRankLimit, BattleLadder, ReplayItem (Returning the Replay index)] 
+
+- AddItemToMenu(menuName/SubmenuId,caption,callbackModuleName,callbackFunctionName,argsTuple) return itemId
+	The selected item id is returned as first argument added to the argsTuple.
+- AddSubmenuToMenu(menuName/SubmenuId,caption) return SubmenuId
+- AddSeparatorToMenu(menuName/SubmenuId) return SeparatorId
+- RemoveFromMenu(id)
+	Id can be an itemId or a SubmenuId or a SeparatorId.
+
+
+
+TODO :
+------
+
+callout :
+
+- SetGroups
+- SetServerList
+- SetColors ?
+- GetFilters 
+- GetPresetList
+- GetHightlightList
+- SetHighlightlist
+
+LowPriority
+- SetPerformList
+- GetPerformList
+- GetIgnoreList
+- SetIgnoreList
+- SetSkin
+- GetSkinList
+
+
+
+callin :

Modified: branches/0.77-branch/Lobby/TASClient/Python/scripts/stick.py
===================================================================
--- branches/0.77-branch/Lobby/TASClient/Python/scripts/stick.py	2008-08-04 18:19:19 UTC (rev 6232)
+++ branches/0.77-branch/Lobby/TASClient/Python/scripts/stick.py	2008-08-05 12:32:46 UTC (rev 6233)
@@ -1,15 +1,54 @@
 import time,thread
 import lobbyscript
+import sys
 
 api = lobbyscript.Callback()
+gui = lobbyscript.GUI()
 
 stickingNick = ''
 specMode = 0
 battleJoinedAndStatusChanged = 0
 stickJoin = False
 
+subMenuId = 0
+menuStickSpecId = 0
+menuStickId = 0
+menuUnstickId = 0
+
+
 colors = api.GetColors()
 
+def onUnStickClick(id):
+  global menuUnstickId
+  cmd_unstick()
+  gui.RemoveFromMenu(menuUnstickId)
+  menuUnstickId = 0
+
+def onStickClick(id,spec):
+  global subMenuId
+  global menuStickSpecId
+  global menuStickId
+  global menuUnstickId
+  if spec:
+    cmd_stick(id+' 1')
+  else:
+    cmd_stick(id+' 0')
+  
+  if menuUnstickId == 0:    
+    menuUnstickId = gui.AddItemToMenu(subMenuId,'UnStick',(),'stick','onUnStickClick')
+    
+
+def _init():
+  global subMenuId
+  global menuStickSpecId
+  global menuStickId
+  global menuUnstickId
+  subMenuId = gui.AddSubmenuToMenu('PlayerItem','Stick')
+  menuStickSpecId = gui.AddItemToMenu(subMenuId,'Stick',(False,),'stick','onStickClick')
+  menuStickId = gui.AddItemToMenu(subMenuId,'Stick Spec',(True,),'stick','onStickClick')
+  gui.AddSeparatorToMenu(subMenuId)
+  
+
 # exit stick mode if the sticked user left
 def in_REMOVEUSER(nick):
   global stickingNick
@@ -29,8 +68,9 @@
 
 def in_FORCEQUITBATTLE():
   global stickingNick
-  stickingNick = ''
-  api.AddToTextBox('$current','Exiting stick mode (You were kicked from the battle).',colors['Info'])
+  if stickingNick  != '':
+    stickingNick = ''
+    api.AddToTextBox('$current','Exiting stick mode (You were kicked from the battle).',colors['Info'])
 
 # when joining a battle we wait for the two CLIENTBATTLESTATUS from server 
 # and then we set us to spectator if the option is checked 
@@ -77,7 +117,6 @@
 def cmd_stick(data):
   args = data.split(' ')
 
-
   if len(args) != 2:
       api.AddToTextBox('$current',&quot;Stick usage : /stick user joinAsSpec={0/1} (Ex : '/stick haxor465 1' will join as spectator every battle the player haxor465 joins.&quot;,colors['Error'])
       return 1

Modified: branches/0.77-branch/Lobby/TASClient/ReplaysUnit.dfm
===================================================================
--- branches/0.77-branch/Lobby/TASClient/ReplaysUnit.dfm	2008-08-04 18:19:19 UTC (rev 6232)
+++ branches/0.77-branch/Lobby/TASClient/ReplaysUnit.dfm	2008-08-05 12:32:46 UTC (rev 6233)
@@ -1,6 +1,6 @@
 object ReplaysForm: TReplaysForm
-  Left = 878
-  Top = 152
+  Left = 954
+  Top = 181
   Width = 809
   Height = 640
   Caption = 'Replays'
@@ -51,6 +51,7 @@
       Header.Style = hsFlatButtons
       HintMode = hmHint
       ParentShowHint = False
+      PopupMenu = ReplayListPopupMenu
       ShowHint = True
       TabOrder = 0
       TreeOptions.AutoOptions = [toAutoDropExpand, toAutoScrollOnExpand, toAutoSort, toAutoTristateTracking, toAutoDeleteMovedNodes]
@@ -1276,4 +1277,8 @@
       end
     end
   end
+  object ReplayListPopupMenu: TSpTBXPopupMenu
+    Left = 456
+    Top = 296
+  end
 end

Modified: branches/0.77-branch/Lobby/TASClient/ReplaysUnit.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/ReplaysUnit.pas	2008-08-04 18:19:19 UTC (rev 6232)
+++ branches/0.77-branch/Lobby/TASClient/ReplaysUnit.pas	2008-08-05 12:32:46 UTC (rev 6233)
@@ -22,7 +22,8 @@
   Dialogs, Buttons, StdCtrls, ComCtrls, ExtCtrls, Math, SpTBXControls,
   TntStdCtrls, SpTBXEditors, TBXDkPanels, SpTBXTabs, TB2Item, TBX,
   SpTBXItem, IdBaseComponent, IdComponent, IdTCPConnection, IdTCPClient,
-  IdHTTP,MainUnit,DateUtils, VirtualTrees,Utility, Mask, JvExMask, JvSpin,IniFiles,MapListFormUnit;
+  IdHTTP,MainUnit,DateUtils, VirtualTrees,Utility, Mask, JvExMask, JvSpin,IniFiles,MapListFormUnit,
+  Menus;
 
 type
   TReplaysForm = class(TForm)
@@ -122,6 +123,7 @@
     ClearFilterListButton: TSpTBXButton;
     chkEnableFilters: TSpTBXCheckBox;
     DeleteAllVisibleButton: TSpTBXButton;
+    ReplayListPopupMenu: TSpTBXPopupMenu;
 
     procedure CreateParams(var Params: TCreateParams); override;
 

Modified: branches/0.77-branch/Lobby/TASClient/TASClient.dof
===================================================================
--- branches/0.77-branch/Lobby/TASClient/TASClient.dof	2008-08-04 18:19:19 UTC (rev 6232)
+++ branches/0.77-branch/Lobby/TASClient/TASClient.dof	2008-08-05 12:32:46 UTC (rev 6233)
@@ -115,7 +115,7 @@
 MajorVer=0
 MinorVer=3
 Release=0
-Build=378
+Build=392
 Debug=0
 PreRelease=0
 Special=0
@@ -126,7 +126,7 @@
 [Version Info Keys]
 CompanyName=
 FileDescription=TA Spring lobby client
-FileVersion=0.3.0.378
+FileVersion=0.3.0.392
 InternalName=
 LegalCopyright=
 LegalTrademarks=

Modified: branches/0.77-branch/Lobby/TASClient/TASClient.dpr
===================================================================
--- branches/0.77-branch/Lobby/TASClient/TASClient.dpr	2008-08-04 18:19:19 UTC (rev 6232)
+++ branches/0.77-branch/Lobby/TASClient/TASClient.dpr	2008-08-05 12:32:46 UTC (rev 6233)
@@ -109,7 +109,8 @@
   class_TIntegerList in 'class_TIntegerList.pas',
   OpenIL in 'openil.pas',
   PythonScriptDebugFormUnit in 'PythonScriptDebugFormUnit.pas' {PythonScriptDebugForm},
-  LobbyScriptUnit in 'LobbyScriptUnit.pas';
+  LobbyScriptUnit in 'LobbyScriptUnit.pas',
+  SpringDownloaderFormUnit in 'SpringDownloaderFormUnit.pas' {SpringDownloaderForm};
 
 var
   i: Integer;
@@ -218,6 +219,7 @@
   Application.CreateForm(TColorsPreference, ColorsPreference);
   Application.CreateForm(TSearchPlayerForm, SearchPlayerForm);
   Application.CreateForm(TPythonScriptDebugForm, PythonScriptDebugForm);
+  //Application.CreateForm(TSpringDownloaderForm, SpringDownloaderForm);
   if not MainUnit.RunningUnderWine then
     Application.CreateForm(TMenuForm, MenuForm);
   SplashScreenForm.UpdateText('Initializing ...');

Modified: branches/0.77-branch/Lobby/TASClient/TASClient.res
===================================================================
(Binary files differ)

Modified: branches/0.77-branch/Lobby/TASClient/UploadReplayUnit.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/UploadReplayUnit.pas	2008-08-04 18:19:19 UTC (rev 6232)
+++ branches/0.77-branch/Lobby/TASClient/UploadReplayUnit.pas	2008-08-05 12:32:46 UTC (rev 6233)
@@ -34,7 +34,7 @@
     NbPlayers : string;
     UploadedReplayId : string;
   end;
-  TUploadThread = class(TDialogThread)
+  TUploadThread = class(TTASClientThread)
   private
     procedure UploadReplay;
     procedure OnTerminateProcedure(Sender : TObject);

Modified: branches/0.77-branch/Lobby/TASClient/Utility.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/Utility.pas	2008-08-04 18:19:19 UTC (rev 6232)
+++ branches/0.77-branch/Lobby/TASClient/Utility.pas	2008-08-05 12:32:46 UTC (rev 6233)
@@ -493,6 +493,8 @@
       imgType := IL_PCX
     else if RightStr(LowerCase(Trim(s)),4) = '.jpg' then
       imgType := IL_JPG
+    else if RightStr(LowerCase(Trim(s)),4) = '.tga' then
+      imgType := IL_TGA
     else
       imgType := IL_TYPE_UNKNOWN;
 

Modified: branches/0.77-branch/Lobby/TASClient/class_TIntegerList.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/class_TIntegerList.pas	2008-08-04 18:19:19 UTC (rev 6232)
+++ branches/0.77-branch/Lobby/TASClient/class_TIntegerList.pas	2008-08-05 12:32:46 UTC (rev 6233)
@@ -68,6 +68,11 @@
   
 begin
   try
+    if Self.Count = 0 then
+    begin
+      IndexOf := -1;
+      Exit;
+    end;
     cpt:=0;
     ptr:=  inherited Items[cpt];
     while (Item&lt;&gt;ptr^) AND (cpt&lt;Count-1) do

Modified: branches/0.77-branch/rts/Lua/LuaUnitDefs.cpp
===================================================================
--- branches/0.77-branch/rts/Lua/LuaUnitDefs.cpp	2008-08-04 18:19:19 UTC (rev 6232)
+++ branches/0.77-branch/rts/Lua/LuaUnitDefs.cpp	2008-08-05 12:32:46 UTC (rev 6233)
@@ -473,7 +473,7 @@
 static int ModelDefTable(lua_State* L, const void* data) {
 	const UnitModelDef&amp; md = *((const UnitModelDef*) data);
 	const char* type;
-	if (md.modelpath.find(&quot;.s3o&quot;) != string::npos) {
+	if (StringToLower(md.modelpath).find(&quot;.s3o&quot;) != string::npos) {
 		type = &quot;s3o&quot;;
 	} else {
 		type = &quot;3do&quot;;

Modified: branches/0.77-branch/rts/Sim/Units/CommandAI/TransportCAI.cpp
===================================================================
--- branches/0.77-branch/rts/Sim/Units/CommandAI/TransportCAI.cpp	2008-08-04 18:19:19 UTC (rev 6232)
+++ branches/0.77-branch/rts/Sim/Units/CommandAI/TransportCAI.cpp	2008-08-05 12:32:46 UTC (rev 6233)
@@ -392,6 +392,38 @@
 
 	return true;
 }
+
+/** this is a version of SpotIsClear that ignores the tranport and all
+	units it carries. */
+bool CTransportCAI::SpotIsClearIgnoreSelf(float3 pos,CUnit* unitToUnload) {
+	float unloadPosHeight=ground-&gt;GetApproximateHeight(pos.x,pos.z);
+
+	if(unloadPosHeight&lt;(0-unitToUnload-&gt;unitDef-&gt;maxWaterDepth))
+ 		return false;
+	if(unloadPosHeight&gt;(0-unitToUnload-&gt;unitDef-&gt;minWaterDepth))
+		return false;
+	if(ground-&gt;GetSlope(pos.x,pos.z) &gt; unitToUnload-&gt;unitDef-&gt;movedata-&gt;maxSlope)
+		return false;
+
+	vector&lt;CUnit*&gt; units = qf-&gt;GetUnitsExact(pos,unitToUnload-&gt;radius+8);
+	CTransportUnit* me = (CTransportUnit*)owner;
+	for (vector&lt;CUnit*&gt;::iterator it = units.begin(); it != units.end(); ++it) {
+		// check if the units are in the transport
+		bool found = false;
+		for (std::list&lt;CTransportUnit::TransportedUnit&gt;::iterator it2 = me-&gt;transported.begin();
+				it2 != me-&gt;transported.end(); ++it2) {
+			if (it2-&gt;unit == *it) {
+				found = true;
+				break;
+			}
+		}
+		if (!found &amp;&amp; *it != owner)
+			return false;
+	}
+
+	return true;
+}
+
 bool CTransportCAI::FindEmptyDropSpots(float3 startpos, float3 endpos, std::list&lt;float3&gt;&amp; dropSpots) {
 	//should only be used by air
 
@@ -631,11 +663,25 @@
 				am-&gt;SetWantedAltitude(unit-&gt;model-&gt;height);
 				am-&gt;maxDrift = 1;
 				if ((owner-&gt;pos.distance(wantedPos) &lt; 8) &amp;&amp;
-					(owner-&gt;updir.dot(UpVector) &gt; 0.99f)) {
-					transport-&gt;DetachUnit(unit);
-					if (transport-&gt;transported.empty()) {
-						am-&gt;dontLand = false;
-						owner-&gt;cob-&gt;Call(&quot;EndTransport&quot;);
+						(owner-&gt;updir.dot(UpVector) &gt; 0.99f)) {
+					if (!SpotIsClearIgnoreSelf(wantedPos, unit)) {
+						// chosen spot is no longer clear to land, choose a new one
+						// if a new spot cannot be found, don't unload at all
+						float3 newpos;
+						if (FindEmptySpot(wantedPos, std::max(128.f, unit-&gt;radius*4),
+								unit-&gt;radius, newpos, unit)) {
+							c.params[0] = newpos.x;
+							c.params[1] = newpos.y;
+							c.params[2] = newpos.z;
+							SetGoal(newpos + UpVector * unit-&gt;model-&gt;height, owner-&gt;pos);
+							return;
+						}
+					} else {
+						transport-&gt;DetachUnit(unit);
+						if (transport-&gt;transported.empty()) {
+							am-&gt;dontLand = false;
+							owner-&gt;cob-&gt;Call(&quot;EndTransport&quot;);
+						}
 					}
 					const float3 fix = owner-&gt;pos + owner-&gt;frontdir * 20;
 					SetGoal(fix, owner-&gt;pos);		//move the transport away slightly

Modified: branches/0.77-branch/rts/Sim/Units/CommandAI/TransportCAI.h
===================================================================
--- branches/0.77-branch/rts/Sim/Units/CommandAI/TransportCAI.h	2008-08-04 18:19:19 UTC (rev 6232)
+++ branches/0.77-branch/rts/Sim/Units/CommandAI/TransportCAI.h	2008-08-05 12:32:46 UTC (rev 6233)
@@ -3,7 +3,7 @@
 
 #include &quot;MobileCAI.h&quot;
 #include &quot;Sim/MoveTypes/TAAirMoveType.h&quot;
- 
+
 #define UNLOAD_LAND 0
 #define UNLOAD_DROP 1
 #define UNLOAD_LANDFLOOD 2
@@ -22,7 +22,7 @@
 	void SlowUpdate(void);
 	void ScriptReady(void);
 
-	int unloadType;	
+	int unloadType;
 	bool CanTransport(CUnit* unit);
 	bool FindEmptySpot(float3 center, float radius,float emptyRadius, float3&amp; found, CUnit* unitToUnload);
 	bool FindEmptyDropSpots(float3 startpos, float3 endpos, std::list&lt;float3&gt;&amp; dropSpots);
@@ -41,21 +41,22 @@
 	bool scriptReady;
 	int lastCall;
 
-private:	
+private:
 	void UnloadUnits_Land(Command&amp; c, CTransportUnit* transport);
-	void UnloadUnits_Drop(Command&amp; c, CTransportUnit* transport);	
+	void UnloadUnits_Drop(Command&amp; c, CTransportUnit* transport);
 	void UnloadUnits_LandFlood(Command&amp; c, CTransportUnit* transport);
 	void UnloadUnits_CrashFlood(Command&amp; c, CTransportUnit* transport); //incomplete
-	
+
 	void UnloadNormal(Command&amp; c);
 	void UnloadLand(Command&amp; c);
 	void UnloadDrop(Command&amp; c);	//parachute drop units
 	void UnloadLandFlood(Command&amp; c); //land and dispatch units all at once
 	void UnloadCrashFlood(Command&amp; c); //slam into landscape abruptly and dispatch units all at once (incomplete)
-	
+
 	virtual bool AllowedCommand(const Command&amp; c);
 	bool SpotIsClear(float3 pos, CUnit* u);
-	std::list&lt;float3&gt; dropSpots;		
+	bool SpotIsClearIgnoreSelf(float3 pos,CUnit* unitToUnload);
+	std::list&lt;float3&gt; dropSpots;
 	bool isFirstIteration;
 	float3 startingDropPos;
 	float3 lastDropPos;

Modified: branches/0.77-branch/rts/System/Platform/Linux/DataDirLocater.cpp
===================================================================
--- branches/0.77-branch/rts/System/Platform/Linux/DataDirLocater.cpp	2008-08-04 18:19:19 UTC (rev 6232)
+++ branches/0.77-branch/rts/System/Platform/Linux/DataDirLocater.cpp	2008-08-05 12:32:46 UTC (rev 6233)
@@ -272,7 +272,9 @@
 			char* newl = strchr(buf, '\n');
 			if (newl)
 				*newl = 0;
-			AddDirs(SubstEnvVars(buf));
+			char white[2] = {'\t', ' '};
+			if (strlen(buf) &gt; 0 &amp;&amp; strspn(buf, white) != strlen(buf)) // don't count lines of whitespaces / tabulators
+				AddDirs(SubstEnvVars(buf));
 		}
 		fclose(f);
 	}


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001012.html">[Taspring-linux-commit] r6232 - in trunk/rts: Lua Map Map/SM3	Map/SMF Rendering Rendering/Env Sim/Units Sim/Units/UnitTypes
</A></li>
	<LI>Next message: <A HREF="001014.html">[Taspring-linux-commit] r6234 - trunk/rts/Game
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1013">[ date ]</a>
              <a href="thread.html#1013">[ thread ]</a>
              <a href="subject.html#1013">[ subject ]</a>
              <a href="author.html#1013">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
