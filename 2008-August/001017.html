<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r6237 - in trunk/Lobby/TASClient: . Python	Python/scripts
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-August/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6237%20-%20in%20trunk/Lobby/TASClient%3A%20.%20Python%0A%09Python/scripts&In-Reply-To=%3C20080806113544.5D95B447F%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001016.html">
   <LINK REL="Next"  HREF="001018.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r6237 - in trunk/Lobby/TASClient: . Python	Python/scripts</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6237%20-%20in%20trunk/Lobby/TASClient%3A%20.%20Python%0A%09Python/scripts&In-Reply-To=%3C20080806113544.5D95B447F%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r6237 - in trunk/Lobby/TASClient: . Python	Python/scripts">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Wed Aug  6 13:35:44 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001016.html">[Taspring-linux-commit] r6236 - trunk/rts/Sim/MoveTypes
</A></li>
        <LI>Next message: <A HREF="001018.html">[Taspring-linux-commit] r6238 - in trunk/rts: Lua Rendering/Env
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1017">[ date ]</a>
              <a href="thread.html#1017">[ thread ]</a>
              <a href="subject.html#1017">[ subject ]</a>
              <a href="author.html#1017">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: satirik
Date: 2008-08-06 13:35:43 +0200 (Wed, 06 Aug 2008)
New Revision: 6237

Modified:
   trunk/Lobby/TASClient/AgreementUnit.dfm
   trunk/Lobby/TASClient/AgreementUnit.pas
   trunk/Lobby/TASClient/BattleFormUnit.dfm
   trunk/Lobby/TASClient/HostBattleFormUnit.pas
   trunk/Lobby/TASClient/LobbyScriptUnit.pas
   trunk/Lobby/TASClient/MainUnit.dfm
   trunk/Lobby/TASClient/MainUnit.pas
   trunk/Lobby/TASClient/NotificationsUnit.pas
   trunk/Lobby/TASClient/PreferencesFormUnit.dfm
   trunk/Lobby/TASClient/PreferencesFormUnit.pas
   trunk/Lobby/TASClient/Python/api.txt
   trunk/Lobby/TASClient/Python/scripts/stick.py
   trunk/Lobby/TASClient/TASClient.dof
   trunk/Lobby/TASClient/TASClient.res
   trunk/Lobby/TASClient/Utility.pas
Log:
* agreement fixed
* hosting a replay then hosting a normal game resulting in hosting the same replay again bug fixed
* Display units icons option added to load the mods faster (if disabled)
* DisplayNotification and DisplaySimpleNotification GUI callout added (see api.txt for parameters)

Modified: trunk/Lobby/TASClient/AgreementUnit.dfm
===================================================================
--- trunk/Lobby/TASClient/AgreementUnit.dfm	2008-08-06 11:12:22 UTC (rev 6236)
+++ trunk/Lobby/TASClient/AgreementUnit.dfm	2008-08-06 11:35:43 UTC (rev 6237)
@@ -1,14 +1,14 @@
 object AgreementForm: TAgreementForm
-  Left = 472
-  Top = 303
+  Left = 901
+  Top = 302
   BorderIcons = []
   BorderStyle = bsDialog
   Caption = 'Agreement'
   ClientHeight = 451
   ClientWidth = 584
   Color = clBtnFace
-  Constraints.MaxHeight = 910
-  Constraints.MaxWidth = 1280
+  Constraints.MaxHeight = 1000
+  Constraints.MaxWidth = 1680
   Font.Charset = DEFAULT_CHARSET
   Font.Color = clWindowText
   Font.Height = -11
@@ -34,22 +34,13 @@
     Options.Maximize = False
     Options.SystemMenu = False
     TBXStyleBackground = True
-    object RichEdit1: TRichEdit
-      Left = 8
-      Top = 40
-      Width = 569
-      Height = 297
-      ReadOnly = True
-      ScrollBars = ssBoth
-      TabOrder = 1
-    end
     object RadioButton1: TSpTBXRadioButton
       Left = 16
       Top = 352
       Width = 288
       Height = 15
       Caption = 'I have read the agreement and agree to the above terms.'
-      TabOrder = 2
+      TabOrder = 1
     end
     object RadioButton2: TSpTBXRadioButton
       Left = 16
@@ -57,7 +48,7 @@
       Width = 156
       Height = 15
       Caption = 'I do not agree to these terms.'
-      TabOrder = 3
+      TabOrder = 2
       TabStop = True
       Checked = True
     end
@@ -67,7 +58,7 @@
       Width = 137
       Height = 25
       Caption = 'Continue'
-      TabOrder = 4
+      TabOrder = 3
       OnClick = Button1Click
       LinkFont.Charset = DEFAULT_CHARSET
       LinkFont.Color = clBlue
@@ -75,5 +66,99 @@
       LinkFont.Name = 'MS Sans Serif'
       LinkFont.Style = [fsUnderline]
     end
+    object RichEdit1: TExRichEdit
+      Left = 8
+      Top = 40
+      Width = 569
+      Height = 297
+      AutoURLDetect = adNone
+      CustomURLs = &lt;
+        item
+          Name = 'e-mail'
+          Color = clWindowText
+          Cursor = crDefault
+          Underline = True
+        end
+        item
+          Name = 'http'
+          Color = clWindowText
+          Cursor = crDefault
+          Underline = True
+        end
+        item
+          Name = 'file'
+          Color = clWindowText
+          Cursor = crDefault
+          Underline = True
+        end
+        item
+          Name = 'mailto'
+          Color = clWindowText
+          Cursor = crDefault
+          Underline = True
+        end
+        item
+          Name = 'ftp'
+          Color = clWindowText
+          Cursor = crDefault
+          Underline = True
+        end
+        item
+          Name = 'https'
+          Color = clWindowText
+          Cursor = crDefault
+          Underline = True
+        end
+        item
+          Name = 'gopher'
+          Color = clWindowText
+          Cursor = crDefault
+          Underline = True
+        end
+        item
+          Name = 'nntp'
+          Color = clWindowText
+          Cursor = crDefault
+          Underline = True
+        end
+        item
+          Name = 'prospero'
+          Color = clWindowText
+          Cursor = crDefault
+          Underline = True
+        end
+        item
+          Name = 'telnet'
+          Color = clWindowText
+          Cursor = crDefault
+          Underline = True
+        end
+        item
+          Name = 'news'
+          Color = clWindowText
+          Cursor = crDefault
+          Underline = True
+        end
+        item
+          Name = 'wais'
+          Color = clWindowText
+          Cursor = crDefault
+          Underline = True
+        end&gt;
+      LangOptions = [loAutoFont]
+      Language = 1036
+      ReadOnly = True
+      ScrollBars = ssVertical
+      ShowSelectionBar = False
+      TabOrder = 4
+      URLColor = clBlue
+      URLCursor = crHandPoint
+      InputFormat = ifRTF
+      OutputFormat = ofRTF
+      SelectedInOut = False
+      PlainRTF = True
+      UndoLimit = 0
+      AllowInPlace = False
+    end
   end
 end

Modified: trunk/Lobby/TASClient/AgreementUnit.pas
===================================================================
--- trunk/Lobby/TASClient/AgreementUnit.pas	2008-08-06 11:12:22 UTC (rev 6236)
+++ trunk/Lobby/TASClient/AgreementUnit.pas	2008-08-06 11:35:43 UTC (rev 6237)
@@ -4,15 +4,16 @@
 
 uses
   Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
-  Dialogs, StdCtrls, ComCtrls, SpTBXControls, TBXDkPanels, SpTBXItem,Misc;
+  Dialogs, StdCtrls, ComCtrls, SpTBXControls, TBXDkPanels, SpTBXItem,Misc,
+  TntStdCtrls, RichEdit2, ExRichEdit;
 
 type
   TAgreementForm = class(TForm)
     SpTBXTitleBar1: TSpTBXTitleBar;
-    RichEdit1: TRichEdit;
     RadioButton1: TSpTBXRadioButton;
     RadioButton2: TSpTBXRadioButton;
     Button1: TSpTBXButton;
+    RichEdit1: TExRichEdit;
 
     procedure CreateParams(var Params: TCreateParams); override;
     procedure Button1Click(Sender: TObject);

Modified: trunk/Lobby/TASClient/BattleFormUnit.dfm
===================================================================
--- trunk/Lobby/TASClient/BattleFormUnit.dfm	2008-08-06 11:12:22 UTC (rev 6236)
+++ trunk/Lobby/TASClient/BattleFormUnit.dfm	2008-08-06 11:35:43 UTC (rev 6237)
@@ -1,6 +1,6 @@
 object BattleForm: TBattleForm
-  Left = 478
-  Top = 70
+  Left = 1178
+  Top = 150
   Width = 787
   Height = 586
   Caption = 'Battle window'

Modified: trunk/Lobby/TASClient/HostBattleFormUnit.pas
===================================================================
--- trunk/Lobby/TASClient/HostBattleFormUnit.pas	2008-08-06 11:12:22 UTC (rev 6236)
+++ trunk/Lobby/TASClient/HostBattleFormUnit.pas	2008-08-06 11:35:43 UTC (rev 6237)
@@ -477,9 +477,11 @@
   s := HostBattleForm.ModsComboBox.Text;
   HostBattleForm.ModsComboBox.Items.Assign(Utility.ModList);
   HostBattleForm.ModsComboBox.ItemIndex := Max(0, HostBattleForm.ModsComboBox.Items.IndexOf(s));
-  if HostButtonMenuIndex = 1 then
-    HostLadder1Click(HostLadder1);
-  if HostButtonMenuIndex = 2 then
+  if HostButtonMenuIndex = 0 then
+    Host1Click(Host1)
+  else if HostButtonMenuIndex = 1 then
+    HostLadder1Click(HostLadder1)
+  else if HostButtonMenuIndex = 2 then
     HostReplay1Click(HostReplay1);
   HostButtonMenuIndex := 0;
 end;
@@ -488,6 +490,8 @@
 var
   s : string;
 begin
+  replay := nil;
+
   ModsComboBox.Enabled := True;
   RankComboBox.Enabled := True;
 
@@ -514,7 +518,7 @@
   ModsComboBox.Items.Assign(Utility.ModList);
   ModsComboBox.ItemIndex := ModsComboBox.Items.IndexOf(s);
 
-  //(Sender as TMenuItem).Checked := True;
+  (Sender as TMenuItem).Checked := True;
   HostButton.Caption := 'Host';
 end;
 
@@ -653,6 +657,8 @@
 var
   ThreadLL : TLadderListThread;
 begin
+  replay := nil;
+
   ModsComboBox.Enabled := True;
   RankComboBox.Enabled := True;
 

Modified: trunk/Lobby/TASClient/LobbyScriptUnit.pas
===================================================================
--- trunk/Lobby/TASClient/LobbyScriptUnit.pas	2008-08-06 11:12:22 UTC (rev 6236)
+++ trunk/Lobby/TASClient/LobbyScriptUnit.pas	2008-08-06 11:35:43 UTC (rev 6237)
@@ -6,9 +6,16 @@
   Misc,ExtCtrls, WrapDelphi, WrapDelphiClasses,PythonEngine,
   PythonGUIInputOutput, Forms, StrUtils,Classes, JclDebug,
   WSocket,MainUnit, class_TIntegerList, RichEdit2, ExRichEdit,
-  SyncObjs,SpTBXItem, TB2Item;
+  SyncObjs,SpTBXItem, TB2Item, JvDesktopAlert;
 
 type
+  TScriptNotificationCallback = record
+    moduleName : string;
+    functionName : string;
+    args: PPyObject;
+  end;
+  PScriptNotificationCallback = ^TScriptNotificationCallback;
+
   TScriptMenuItemCallBack = record
     moduleName : string;
     functionName : string;
@@ -26,7 +33,7 @@
   {$METHODINFO ON}
 
   TGUI = class(TPersistent)
-    private
+    protected
       menuIdInc : integer;
       MenuItemList: TList;
 
@@ -34,6 +41,7 @@
       function GetMenuSelectedId(menu: TTBCustomItem): string;
       procedure MenuItemClick(Sender: TObject);
       function GetFreeMenuId: integer;
+      procedure NotificationClick(Sender: TObject);
 
     public
       constructor Create;
@@ -41,6 +49,9 @@
       function AddSubmenuToMenu(menu: string; itemCaption: string): integer;
       function AddSeparatorToMenu(menu: string): integer;
 
+      procedure DisplaySimpleNotification(title: string; msg: string; displayTime: integer);
+      procedure DisplayNotification(title: string; msg: string; callInArgs: Variant; callbackModuleName: string; callbackFunctionName: string; displayTime: integer);
+
       procedure RemoveFromMenu(id: integer);
   end;
 
@@ -170,6 +181,7 @@
   MainThreadFocused: Boolean;
   JoinBattleId: integer;
   JoinBattlePassword: string;
+  NotificationTempList: TList;
 
 implementation
 
@@ -345,6 +357,7 @@
   battleClients: PPyObject;
   groupUsers: PPyObject;
 begin
+  OutputDebugString('------------------------Debut');
   with GetPythonEngine do
   begin
     for i:=0 to pyGroupList.Count-1 do
@@ -440,6 +453,7 @@
         Py_XDECREF(groupUsers);
       end;
   end;
+  OutputDebugString('------------------------Fin');
 end;
 
 function TCallback.GetMyUser: Variant;
@@ -605,7 +619,7 @@
       PyDict_SetItemStringDecRef( Result, 'DiminishingMMs', Script.ReadDiminishingMMs );
       PyDict_SetItemStringDecRef( Result, 'GhostedBuildings', Script.ReadGhostedBuildings );
 
-      scriptPlayer := PyDict_New();
+      {scriptPlayer := PyDict_New();
       for i:=0 to PlayerList.Count-1 do
       begin
         pyO := GetPyReplayPlayer(TReplayPlayer(PlayerList[i]^));
@@ -613,7 +627,7 @@
         Py_XDECREF(pyO);
       end;
       PyDict_SetItemString( Result, 'Users',  scriptPlayer);
-      Py_XDECREF(scriptPlayer);
+      Py_XDECREF(scriptPlayer);}
     end;
   end;
 end;
@@ -669,9 +683,9 @@
   i: integer;
   pyO: PPyObject;
 begin
-  LockCallback;
   if ReplaysForm.LoadingPanel.Visible then Exit;
 
+  LockCallback;
   with GetPythonEngine do
   begin
     ClearRefs;
@@ -681,7 +695,7 @@
     begin
       pyO := GetPyReplay(TReplay(ReplayList[i]));
       PyDict_SetItem(pyReplays,PyInt_FromLong(i),pyO);
-      Py_XDECREF(pyO);
+      Py_DECREF(pyO);
     end;
 
     Result := PyObjectAsVariant(pyReplays);
@@ -711,25 +725,25 @@
 
 procedure TCallback.LockCallback;
 begin
-  CS.Acquire;
+  CS.Enter;
 end;
 procedure TCallback.UnlockCallback;
 begin
-  CS.Release;
+  CS.Leave;
 end;
 
 procedure TCallback.ClearRefs;
 begin
   with GetPythonEngine do
   begin
-    Py_XDECREF(pyGroups);
-    Py_XDECREF(pyBattles);
-    Py_XDECREF(pyUsers);
-    Py_XDECREF(pyMods);
-    Py_XDECREF(pyMaps);
-    Py_XDECREF(pyReplays);
-    Py_XDECREF(pyCurrentBattle);
-    Py_XDECREF(pyTextBoxes);
+    try Py_XDECREF(pyGroups); except end;
+    try Py_XDECREF(pyBattles); except end;
+    try Py_XDECREF(pyUsers); except end;
+    try Py_XDECREF(pyMods); except end;
+    try Py_XDECREF(pyMaps); except end;
+    try Py_XDECREF(pyReplays); except end;
+    try Py_XDECREF(pyCurrentBattle); except end;
+    try Py_XDECREF(pyTextBoxes); except end;
   end;
 end;
 
@@ -744,7 +758,7 @@
     pyGroups := PyDict_New();
 
     RefreshPythonLists;
-
+    
     for i:=0 to pyGroupList.Count-1 do
       PyDict_SetItemString(pyGroups,PChar(TClientGroup(ClientGroups[i]).Name),PPyObject(pyGroupList[i]));
 
@@ -1270,6 +1284,45 @@
     end;
 end;
 
+procedure TGUI.DisplaySimpleNotification(title: string; msg: string; displayTime: integer);
+var
+  N : TJvDesktopAlert;
+begin
+ N := MainForm.MakeNotification(title,msg,displayTime,False);
+ MainForm.ExecuteNotification(N);
+end;
+
+procedure TGUI.DisplayNotification(title: string; msg: string; callInArgs: Variant; callbackModuleName: string; callbackFunctionName: string; displayTime: integer);
+var
+  snc : PScriptNotificationCallback;
+  N : TJvDesktopAlert;
+begin
+  N := MainForm.MakeNotification(title,msg,displayTime,True);
+  N.OnMessageClick := NotificationClick;
+  New(snc);
+  snc.moduleName := callbackModuleName;
+  snc.functionName := callbackFunctionName;
+  snc.args := GetPythonEngine.VariantAsPyObject(callInArgs);
+  N.Tag := Longint(snc);
+  MainForm.ExecuteNotification(N);
+end;
+
+procedure TGUI.NotificationClick(Sender: TObject);
+var
+  m : PPyObject;
+  snc : PScriptNotificationCallback;
+begin
+  AcquireMainThread;
+  with GetPythonEngine do
+  begin
+    snc := PScriptNotificationCallback(Pointer((Sender as TJvDesktopAlert).Tag));
+    m := FindFunction(snc.moduleName,snc.functionName);
+
+    EvalPyFunction(m,PyList_AsTuple(snc.args));
+  end;
+  ReleaseMainThread;
+end;
+
 // We override the constructors
 
 constructor TPyCallback.Create( APythonType : TPythonType );

Modified: trunk/Lobby/TASClient/MainUnit.dfm
===================================================================
--- trunk/Lobby/TASClient/MainUnit.dfm	2008-08-06 11:12:22 UTC (rev 6236)
+++ trunk/Lobby/TASClient/MainUnit.dfm	2008-08-06 11:35:43 UTC (rev 6237)
@@ -1,6 +1,6 @@
 object MainForm: TMainForm
-  Left = 813
-  Top = 384
+  Left = 388
+  Top = 270
   Width = 808
   Height = 549
   Caption = '.'
@@ -7061,6 +7061,8 @@
     Top = 166
   end
   object PyEngine: TAtomPythonEngine
+    FatalAbort = False
+    FatalMsgDlg = False
     InitThreads = True
     IO = PyInOut
     Left = 452

Modified: trunk/Lobby/TASClient/MainUnit.pas
===================================================================
--- trunk/Lobby/TASClient/MainUnit.pas	2008-08-06 11:12:22 UTC (rev 6236)
+++ trunk/Lobby/TASClient/MainUnit.pas	2008-08-06 11:35:43 UTC (rev 6237)
@@ -1384,6 +1384,8 @@
     procedure SortBattleInList(Index: Integer; SortStyle: Byte; Ascending: Boolean);
 
     procedure AddNotification(HeaderText, MessageText: string; DisplayTime: Integer;OnClick: Boolean = false;BattleId: integer = -1);
+    function MakeNotification(HeaderText, MessageText: string; DisplayTime: Integer; canClick: boolean): TJvDesktopAlert;
+    procedure ExecuteNotification(N: TJvDesktopAlert);
     procedure NotificationClick(Sender: TObject);
     procedure NotificationClose(Sender: TObject);
 
@@ -1589,7 +1591,7 @@
   MuteListForms: TList; // list of all open MuteListForm-s. When form is created it will add itself to the list automatically, likewise will remove itself from the list when it gets destroyed
   ReceivingMuteListForChannel: string; // name of the channel for which we are currently receiving the mute list (we've extracted this info form MUTELISTBEGIN command)
 
-  ReceivedAgreement: TStringList; // this is temporary string list to store received lines of an agreement sent by server.
+  ReceivedAgreement: TWideStringList; // this is temporary string list to store received lines of an agreement sent by server.
 
   ProcessingRemoteCommand: Boolean = False; // tells us if we are processing remote command currently. This is important because sometimes Application.ProcessMessages can get called from within ProcessRemoteCommand method, which could led to next command being processed before current one is finished.
 
@@ -3456,7 +3458,7 @@
 
   InitializeFlagBitmaps;
 
-  ReceivedAgreement := TStringList.Create;
+  ReceivedAgreement := TWideStringList.Create;
 
   Pings := TList.Create;
 
@@ -4517,11 +4519,10 @@
     else if sl[0] = 'AGREEMENTEND' then
     begin
       tmp := ReceivedAgreement.Text;
-      ms := TMemoryStream.Create;
-      ms.WriteBuffer(tmp[1], Length(tmp));
-      ms.Position := 0;
-      AgreementForm.RichEdit1.Lines.LoadFromStream(ms);
-      ms.Free;
+      AgreementForm.RichEdit1.BeginUpdate;
+      AgreementForm.RichEdit1.Clear;
+      AgreementForm.RichEdit1.InsertRTF(WideStringToUTF8(tmp));
+      AgreementForm.RichEdit1.EndUpdate;
       AgreementForm.ShowModal;
     end
     else if sl[0] = 'DENIED' then
@@ -8491,33 +8492,45 @@
   (PageControl1.ActivePage as TMyTabSheet).AutoScroll := not (PageControl1.ActivePage as TMyTabSheet).AutoScroll;
 end;
 
-procedure TMainForm.AddNotification(HeaderText, MessageText: string; DisplayTime: Integer;OnClick: Boolean = false;BattleId: integer = -1);
-var
-  DA: TJvDesktopAlert;
+function TMainForm.MakeNotification(HeaderText, MessageText: string; DisplayTime: Integer; canClick: boolean): TJvDesktopAlert;
 begin
+  Result := TJvDesktopAlert.Create(Self);
+  Result.HeaderText := HeaderText;
+  Result.MessageText := MessageText;
+  if canClick then
+    Result.Options := [daoCanClose,daoCanClick]
+  else
+    Result.Options := [daoCanClose];
+  Result.Location.Position := dapBottomRight;
+  Result.StyleHandler.DisplayDuration := DisplayTime;
+  Result.Location.Width := 250;
+  Result.Location.Height := 70;
+  Result.AlertStyle := asFade;
+end;
+
+procedure TMainForm.ExecuteNotification(N: TJvDesktopAlert);
+begin
   if Preferences.UseSoundNotifications then
     if not Preferences.DisableAllSounds then PlayResSound('notify');
   if (BattleState.Status &lt;&gt; None) and (Status.Me.GetInGameStatus) then
     Exit;
-  DA := TJvDesktopAlert.Create(Self);
-  DA.HeaderText := HeaderText;
-  DA.MessageText := MessageText;
-  if OnClick then
-    DA.Options := [daoCanClose,daoCanClick]
-  else
-    DA.Options := [daoCanClose];
+
   if displayingNotificationList.Count &gt;= MAX_POPUP then
     TJvDesktopAlert(displayingNotificationList.First).Close(True);
-  displayingNotificationList.Add(DA);
-  DA.Location.Position := dapBottomRight;
-  DA.StyleHandler.DisplayDuration := DisplayTime;
-  DA.Location.Width := 250;
-  DA.Location.Height := 70;
-  DA.AlertStyle := asFade;
+  displayingNotificationList.Add(N);
+  N.OnClose := NotificationClose; // removes itself from the displayingNotificationList
+
+  N.Execute;
+end;
+
+procedure TMainForm.AddNotification(HeaderText, MessageText: string; DisplayTime: Integer;OnClick: Boolean = false;BattleId: integer = -1);
+var
+  DA: TJvDesktopAlert;
+begin
+  DA := MakeNotification(HeaderText,MessageText,DisplayTime,OnClick);
   DA.OnMessageClick := NotificationClick;
-  DA.OnClose := NotificationClose;
   DA.Tag := BattleId;
-  DA.Execute;
+  ExecuteNotification(DA);
 end;
 
 procedure TMainForm.NotificationClose(Sender: TObject);
@@ -10527,6 +10540,7 @@
       LobbyScriptUnit.MsgList := TStringList.Create;
       LobbyScriptUnit.RichEditList := TList.Create;
       LobbyScriptUnit.MsgColor := TIntegerList.Create;
+      LobbyScriptUnit.NotificationTempList := TList.Create;
 
       handlers._load;
 

Modified: trunk/Lobby/TASClient/NotificationsUnit.pas
===================================================================
--- trunk/Lobby/TASClient/NotificationsUnit.pas	2008-08-06 11:12:22 UTC (rev 6236)
+++ trunk/Lobby/TASClient/NotificationsUnit.pas	2008-08-06 11:35:43 UTC (rev 6237)
@@ -227,7 +227,7 @@
         nfModHosted:
         begin
           if sl.Count &lt;&gt; 1 then Exit;
-          if UpperCase(sl[0]) &lt;&gt; UpperCase(Name1) then Continue;
+          if Pos(UpperCase(sl[0]),UpperCase(Name1)) = 0 then Continue;
           // else:
           Result := True;
           Exit;

Modified: trunk/Lobby/TASClient/PreferencesFormUnit.dfm
===================================================================
--- trunk/Lobby/TASClient/PreferencesFormUnit.dfm	2008-08-06 11:12:22 UTC (rev 6236)
+++ trunk/Lobby/TASClient/PreferencesFormUnit.dfm	2008-08-06 11:35:43 UTC (rev 6237)
@@ -37,7 +37,7 @@
       Width = 401
       Height = 305
       Color = clBtnFace
-      ActiveTabIndex = 6
+      ActiveTabIndex = 3
       TabAutofit = True
       HiddenItems = &lt;&gt;
       object SpTBXTabItem6: TSpTBXTabItem
@@ -54,6 +54,7 @@
       end
       object SpTBXTabItem3: TSpTBXTabItem
         Caption = 'Interface'
+        Checked = True
         CustomWidth = 56
       end
       object SpTBXTabItem2: TSpTBXTabItem
@@ -66,7 +67,6 @@
       end
       object SpTBXTabItem7: TSpTBXTabItem
         Caption = 'Scripts'
-        Checked = True
         CustomWidth = 56
       end
       object SpTBXTabSheet6: TSpTBXTabSheet
@@ -302,6 +302,273 @@
           end
         end
       end
+      object SpTBXTabSheet2: TSpTBXTabSheet
+        Left = 0
+        Top = 23
+        Width = 401
+        Height = 282
+        Caption = 'HTTP'
+        ImageIndex = -1
+        TabItem = 'SpTBXTabItem2'
+        object GroupBox6: TSpTBXGroupBox
+          Left = 16
+          Top = 8
+          Width = 369
+          Height = 257
+          Caption = 'Proxy settings'
+          Color = clNone
+          ParentColor = False
+          TabOrder = 0
+          object UseProxyCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 32
+            Width = 65
+            Height = 15
+            Caption = 'Use proxy'
+            TabOrder = 0
+            OnClick = UseProxyCheckBoxClick
+            Checked = True
+            State = cbChecked
+          end
+          object ProxyPanel: TSpTBXPanel
+            Left = 24
+            Top = 56
+            Width = 321
+            Height = 113
+            Caption = 'ProxyPanel'
+            Color = clNone
+            ParentColor = False
+            TabOrder = 1
+            object ProxyEdit: TSpTBXEdit
+              Left = 64
+              Top = 8
+              Width = 241
+              Height = 21
+              TabOrder = 0
+            end
+            object Label7: TSpTBXLabel
+              Left = 8
+              Top = 8
+              Width = 41
+              Height = 13
+              Caption = 'Address:'
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object Label8: TSpTBXLabel
+              Left = 8
+              Top = 32
+              Width = 22
+              Height = 13
+              Caption = 'Port:'
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object JvProxyPortEdit: TJvValidateEdit
+              Left = 64
+              Top = 32
+              Width = 49
+              Height = 21
+              Alignment = taLeftJustify
+              CriticalPoints.MaxValueIncluded = False
+              CriticalPoints.MinValueIncluded = False
+              EditText = '0'
+              TabOrder = 3
+            end
+            object ProxyUserEdit: TSpTBXEdit
+              Left = 64
+              Top = 56
+              Width = 121
+              Height = 21
+              TabOrder = 4
+            end
+            object Label9: TSpTBXLabel
+              Left = 8
+              Top = 56
+              Width = 51
+              Height = 13
+              Caption = 'Username:'
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object Label10: TSpTBXLabel
+              Left = 8
+              Top = 80
+              Width = 49
+              Height = 13
+              Caption = 'Password:'
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object ProxyPassEdit: TSpTBXEdit
+              Left = 64
+              Top = 80
+              Width = 121
+              Height = 21
+              TabOrder = 7
+            end
+          end
+        end
+      end
+      object SpTBXTabSheet1: TSpTBXTabSheet
+        Left = 0
+        Top = 23
+        Width = 401
+        Height = 282
+        Caption = 'Skins'
+        ImageIndex = -1
+        TabItem = 'SpTBXTabItem1'
+        object GroupBox5: TSpTBXGroupBox
+          Left = 16
+          Top = 8
+          Width = 361
+          Height = 257
+          Caption = 'Skin manager'
+          Color = clNone
+          ParentColor = False
+          TabOrder = 0
+          object ThemesComboBox: TSpTBXComboBox
+            Left = 48
+            Top = 144
+            Width = 177
+            Height = 21
+            Style = csDropDownList
+            ItemHeight = 13
+            TabOrder = 0
+            OnChange = ThemesComboBoxChange
+          end
+          object SpTBXRadioButton1: TSpTBXRadioButton
+            Left = 48
+            Top = 56
+            Width = 44
+            Height = 15
+            Caption = 'None'
+            TabOrder = 1
+            TabStop = True
+            OnClick = SpTBXRadioButton1Click
+            Checked = True
+          end
+          object SpTBXRadioButton2: TSpTBXRadioButton
+            Left = 48
+            Top = 72
+            Width = 62
+            Height = 15
+            Caption = 'Windows'
+            TabOrder = 2
+            OnClick = SpTBXRadioButton2Click
+          end
+          object Label3: TSpTBXLabel
+            Left = 32
+            Top = 120
+            Width = 85
+            Height = 13
+            Caption = 'Choose TBX skin:'
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
+          end
+          object SpTBXRadioButton3: TSpTBXRadioButton
+            Left = 48
+            Top = 88
+            Width = 76
+            Height = 15
+            Caption = 'TBX themes'
+            TabOrder = 4
+            OnClick = SpTBXRadioButton3Click
+          end
+          object Label11: TSpTBXLabel
+            Left = 32
+            Top = 32
+            Width = 60
+            Height = 13
+            Caption = 'Theme style:'
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
+          end
+        end
+      end
+      object SpTBXTabSheet7: TSpTBXTabSheet
+        Left = 0
+        Top = 23
+        Width = 401
+        Height = 282
+        Caption = 'Scripts'
+        ImageIndex = -1
+        TabItem = 'SpTBXTabItem7'
+        object ScriptsDebugWindowBt: TSpTBXButton
+          Left = 136
+          Top = 32
+          Width = 137
+          Height = 25
+          Caption = 'Debug Window'
+          TabOrder = 0
+          OnClick = ScriptsDebugWindowBtClick
+          LinkFont.Charset = DEFAULT_CHARSET
+          LinkFont.Color = clBlue
+          LinkFont.Height = -11
+          LinkFont.Name = 'MS Sans Serif'
+          LinkFont.Style = [fsUnderline]
+        end
+        object ScriptsReloadBt: TSpTBXButton
+          Left = 136
+          Top = 64
+          Width = 137
+          Height = 25
+          Caption = 'Reload scripts'
+          TabOrder = 1
+          OnClick = ScriptsReloadBtClick
+          LinkFont.Charset = DEFAULT_CHARSET
+          LinkFont.Color = clBlue
+          LinkFont.Height = -11
+          LinkFont.Name = 'MS Sans Serif'
+          LinkFont.Style = [fsUnderline]
+        end
+        object ScriptsLoadNewBt: TSpTBXButton
+          Left = 136
+          Top = 96
+          Width = 137
+          Height = 25
+          Caption = 'Load new scripts'
+          TabOrder = 2
+          OnClick = ScriptsLoadNewBtClick
+          LinkFont.Charset = DEFAULT_CHARSET
+          LinkFont.Color = clBlue
+          LinkFont.Height = -11
+          LinkFont.Name = 'MS Sans Serif'
+          LinkFont.Style = [fsUnderline]
+        end
+        object ScriptsAdvancedOptionsBt: TSpTBXButton
+          Left = 136
+          Top = 128
+          Width = 137
+          Height = 25
+          Caption = 'Advanced options'
+          TabOrder = 3
+          OnClick = ScriptsAdvancedOptionsBtClick
+          LinkFont.Charset = DEFAULT_CHARSET
+          LinkFont.Color = clBlue
+          LinkFont.Height = -11
+          LinkFont.Name = 'MS Sans Serif'
+          LinkFont.Style = [fsUnderline]
+        end
+      end
       object SpTBXTabSheet4: TSpTBXTabSheet
         Left = 0
         Top = 23
@@ -585,7 +852,7 @@
             TabOrder = 7
           end
           object UploadReplayCheckBox: TSpTBXCheckBox
-            Left = 24
+            Left = 272
             Top = 232
             Width = 245
             Height = 15
@@ -646,275 +913,16 @@
             ThumbLength = 10
             OnChange = ChatLogsLimitTrackerChange
           end
-        end
-      end
-      object SpTBXTabSheet2: TSpTBXTabSheet
-        Left = 0
-        Top = 23
-        Width = 401
-        Height = 282
-        Caption = 'HTTP'
-        ImageIndex = -1
-        TabItem = 'SpTBXTabItem2'
-        object GroupBox6: TSpTBXGroupBox
-          Left = 16
-          Top = 8
-          Width = 369
-          Height = 257
-          Caption = 'Proxy settings'
-          Color = clNone
-          ParentColor = False
-          TabOrder = 0
-          object UseProxyCheckBox: TSpTBXCheckBox
+          object DisplayUnitsIconsCheckBox: TSpTBXCheckBox
             Left = 24
-            Top = 32
-            Width = 65
+            Top = 232
+            Width = 204
             Height = 15
-            Caption = 'Use proxy'
-            TabOrder = 0
-            OnClick = UseProxyCheckBoxClick
-            Checked = True
-            State = cbChecked
+            Caption = 'Display units icons (slower mod loading)'
+            TabOrder = 15
           end
-          object ProxyPanel: TSpTBXPanel
-            Left = 24
-            Top = 56
-            Width = 321
-            Height = 113
-            Caption = 'ProxyPanel'
-            Color = clNone
-            ParentColor = False
-            TabOrder = 1
-            object ProxyEdit: TSpTBXEdit
-              Left = 64
-              Top = 8
-              Width = 241
-              Height = 21
-              TabOrder = 0
-            end
-            object Label7: TSpTBXLabel
-              Left = 8
-              Top = 8
-              Width = 41
-              Height = 13
-              Caption = 'Address:'
-              LinkFont.Charset = DEFAULT_CHARSET
-              LinkFont.Color = clBlue
-              LinkFont.Height = -11
-              LinkFont.Name = 'MS Sans Serif'
-              LinkFont.Style = [fsUnderline]
-            end
-            object Label8: TSpTBXLabel
-              Left = 8
-              Top = 32
-              Width = 22
-              Height = 13
-              Caption = 'Port:'
-              LinkFont.Charset = DEFAULT_CHARSET
-              LinkFont.Color = clBlue
-              LinkFont.Height = -11
-              LinkFont.Name = 'MS Sans Serif'
-              LinkFont.Style = [fsUnderline]
-            end
-            object JvProxyPortEdit: TJvValidateEdit
-              Left = 64
-              Top = 32
-              Width = 49
-              Height = 21
-              Alignment = taLeftJustify
-              CriticalPoints.MaxValueIncluded = False
-              CriticalPoints.MinValueIncluded = False
-              EditText = '0'
-              TabOrder = 3
-            end
-            object ProxyUserEdit: TSpTBXEdit
-              Left = 64
-              Top = 56
-              Width = 121
-              Height = 21
-              TabOrder = 4
-            end
-            object Label9: TSpTBXLabel
-              Left = 8
-              Top = 56
-              Width = 51
-              Height = 13
-              Caption = 'Username:'
-              LinkFont.Charset = DEFAULT_CHARSET
-              LinkFont.Color = clBlue
-              LinkFont.Height = -11
-              LinkFont.Name = 'MS Sans Serif'
-              LinkFont.Style = [fsUnderline]
-            end
-            object Label10: TSpTBXLabel
-              Left = 8
-              Top = 80
-              Width = 49
-              Height = 13
-              Caption = 'Password:'
-              LinkFont.Charset = DEFAULT_CHARSET
-              LinkFont.Color = clBlue
-              LinkFont.Height = -11
-              LinkFont.Name = 'MS Sans Serif'
-              LinkFont.Style = [fsUnderline]
-            end
-            object ProxyPassEdit: TSpTBXEdit
-              Left = 64
-              Top = 80
-              Width = 121
-              Height = 21
-              TabOrder = 7
-            end
-          end
         end
       end
-      object SpTBXTabSheet1: TSpTBXTabSheet
-        Left = 0
-        Top = 23
-        Width = 401
-        Height = 282
-        Caption = 'Skins'
-        ImageIndex = -1
-        TabItem = 'SpTBXTabItem1'
-        object GroupBox5: TSpTBXGroupBox
-          Left = 16
-          Top = 8
-          Width = 361
-          Height = 257
-          Caption = 'Skin manager'
-          Color = clNone
-          ParentColor = False
-          TabOrder = 0
-          object ThemesComboBox: TSpTBXComboBox
-            Left = 48
-            Top = 144
-            Width = 177
-            Height = 21
-            Style = csDropDownList
-            ItemHeight = 13
-            TabOrder = 0
-            OnChange = ThemesComboBoxChange
-          end
-          object SpTBXRadioButton1: TSpTBXRadioButton
-            Left = 48
-            Top = 56
-            Width = 44
-            Height = 15
-            Caption = 'None'
-            TabOrder = 1
-            TabStop = True
-            OnClick = SpTBXRadioButton1Click
-            Checked = True
-          end
-          object SpTBXRadioButton2: TSpTBXRadioButton
-            Left = 48
-            Top = 72
-            Width = 62
-            Height = 15
-            Caption = 'Windows'
-            TabOrder = 2
-            OnClick = SpTBXRadioButton2Click
-          end
-          object Label3: TSpTBXLabel
-            Left = 32
-            Top = 120
-            Width = 85
-            Height = 13
-            Caption = 'Choose TBX skin:'
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
-          object SpTBXRadioButton3: TSpTBXRadioButton
-            Left = 48
-            Top = 88
-            Width = 76
-            Height = 15
-            Caption = 'TBX themes'
-            TabOrder = 4
-            OnClick = SpTBXRadioButton3Click
-          end
-          object Label11: TSpTBXLabel
-            Left = 32
-            Top = 32
-            Width = 60
-            Height = 13
-            Caption = 'Theme style:'
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
-        end
-      end
-      object SpTBXTabSheet7: TSpTBXTabSheet
-        Left = 0
-        Top = 23
-        Width = 401
-        Height = 282
-        Caption = 'Scripts'
-        ImageIndex = -1
-        TabItem = 'SpTBXTabItem7'
-        object ScriptsDebugWindowBt: TSpTBXButton
-          Left = 136
-          Top = 32
-          Width = 137
-          Height = 25
-          Caption = 'Debug Window'
-          TabOrder = 0
-          OnClick = ScriptsDebugWindowBtClick
-          LinkFont.Charset = DEFAULT_CHARSET
-          LinkFont.Color = clBlue
-          LinkFont.Height = -11
-          LinkFont.Name = 'MS Sans Serif'
-          LinkFont.Style = [fsUnderline]
-        end
-        object ScriptsReloadBt: TSpTBXButton
-          Left = 136
-          Top = 64
-          Width = 137
-          Height = 25
-          Caption = 'Reload scripts'
-          TabOrder = 1
-          OnClick = ScriptsReloadBtClick
-          LinkFont.Charset = DEFAULT_CHARSET
-          LinkFont.Color = clBlue
-          LinkFont.Height = -11
-          LinkFont.Name = 'MS Sans Serif'
-          LinkFont.Style = [fsUnderline]
-        end
-        object ScriptsLoadNewBt: TSpTBXButton
-          Left = 136
-          Top = 96
-          Width = 137
-          Height = 25
-          Caption = 'Load new scripts'
-          TabOrder = 2
-          OnClick = ScriptsLoadNewBtClick
-          LinkFont.Charset = DEFAULT_CHARSET
-          LinkFont.Color = clBlue
-          LinkFont.Height = -11
-          LinkFont.Name = 'MS Sans Serif'
-          LinkFont.Style = [fsUnderline]
-        end
-        object ScriptsAdvancedOptionsBt: TSpTBXButton
-          Left = 136
-          Top = 128
-          Width = 137
-          Height = 25
-          Caption = 'Advanced options'
-          TabOrder = 3
-          OnClick = ScriptsAdvancedOptionsBtClick
-          LinkFont.Charset = DEFAULT_CHARSET
-          LinkFont.Color = clBlue
-          LinkFont.Height = -11
-          LinkFont.Name = 'MS Sans Serif'
-          LinkFont.Style = [fsUnderline]
-        end
-      end
     end
     object ApplyAndCloseButton: TSpTBXButton
       Left = 43

Modified: trunk/Lobby/TASClient/PreferencesFormUnit.pas
===================================================================
--- trunk/Lobby/TASClient/PreferencesFormUnit.pas	2008-08-06 11:12:22 UTC (rev 6236)
+++ trunk/Lobby/TASClient/PreferencesFormUnit.pas	2008-08-06 11:35:43 UTC (rev 6237)
@@ -50,6 +50,7 @@
     UseSoundNotifications: Boolean;
     AutoCompletionFromCurrentChannel: Boolean;
     AutoUpdateToBeta: Boolean;
+    DisplayUnitsIcons: Boolean;
 
     UseProxy: Boolean;
     ProxyAddress: string;
@@ -175,6 +176,7 @@
     ScriptsReloadBt: TSpTBXButton;
     ScriptsLoadNewBt: TSpTBXButton;
     ScriptsAdvancedOptionsBt: TSpTBXButton;
+    DisplayUnitsIconsCheckBox: TSpTBXCheckBox;
 
     function BattleSortStyleToColumn(SortStyle: Integer): Integer;
     function ColumnToBattleSortStyle(Column: Integer): Integer;
@@ -271,7 +273,7 @@
   end;
 
 const
-  DEFAULT_PREFERENCES: TPreferences = (ServerIP:'taspringmaster.clan-sy.com'; ServerPort:'8200'; TabStyle:0; TimeStamps: True; Username:''; Password:''; ConnectOnStartup: False; SortStyle: 1; BattleSortStyle: 1; BattleSortDirection: 0; BattleClientSortStyle: 2;FilterJoinLeftMessages: False;FilterBattleJoinLeftMessages: False; ShowFlags: True; MarkUnknownMaps: False; TaskbarButtons: True; JoinMainChannel: True; ReconnectToBackup: True; SaveLogs: True; UseSoundNotifications: True;AutoCompletionFromCurrentChannel: False; AutoUpdateToBeta: False; UseProxy: False; HighlightColor: 'Green'; UseNotificationsForHighlights: True; UseIgnoreList: False; WarnIfUsingNATTraversing: True; AutoFocusOnPM: True; MapSortStyle: 1; ThemeType: thtTBX; Theme: 'Miranda'; DisableAllSounds: False; SortLocal: False; DisplayQuickJoinPanel : True; LimitChatLogs: False; ChatLogsLimit: 800; SPSkin: 'default.ssk'; DisableScripts : False);
+  DEFAULT_PREFERENCES: TPreferences = (ServerIP:'taspringmaster.clan-sy.com'; ServerPort:'8200'; TabStyle:0; TimeStamps: True; Username:''; Password:''; ConnectOnStartup: False; SortStyle: 1; BattleSortStyle: 1; BattleSortDirection: 0; BattleClientSortStyle: 2;FilterJoinLeftMessages: False;FilterBattleJoinLeftMessages: False; ShowFlags: True; MarkUnknownMaps: False; TaskbarButtons: True; JoinMainChannel: True; ReconnectToBackup: True; SaveLogs: True; UseSoundNotifications: True;AutoCompletionFromCurrentChannel: False; AutoUpdateToBeta: False;DisplayUnitsIcons: True; UseProxy: False; HighlightColor: 'Green'; UseNotificationsForHighlights: True; UseIgnoreList: False; WarnIfUsingNATTraversing: True; AutoFocusOnPM: True; MapSortStyle: 1; ThemeType: thtTBX; Theme: 'Miranda'; DisableAllSounds: False; SortLocal: False; DisplayQuickJoinPanel : True; LimitChatLogs: False; ChatLogsLimit: 800; SPSkin: 'default.ssk'; DisableScripts : False);
 
 var
   PreferencesForm: TPreferencesForm;
@@ -332,6 +334,7 @@
     try Preferences.FilterBattleJoinLeftMessages := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'FilterBattleJoinLeftMessages'); except end;
     try Preferences.AutoCompletionFromCurrentChannel := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'AutoCompletionFromCurrentChannel'); except end;
     try Preferences.ShowFlags := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'ShowFlags'); except end;
+    try Preferences.DisplayUnitsIcons := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'DisplayUnitsIcons'); except end;
     try Preferences.MarkUnknownMaps := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'MarkUnknownMapsNMods'); except end;
     try Preferences.TaskbarButtons := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'TaskbarButtons'); except end;
     try Preferences.JoinMainChannel := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'JoinMainChannel'); except end;
@@ -602,6 +605,7 @@
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'FilterBattleJoinLeftMessages', rdInteger, Misc.BoolToInt(Preferences.FilterBattleJoinLeftMessages));
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'AutoCompletionFromCurrentChannel', rdInteger, Misc.BoolToInt(Preferences.AutoCompletionFromCurrentChannel));
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'ShowFlags', rdInteger, Misc.BoolToInt(Preferences.ShowFlags));
+    Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'DisplayUnitsIcons', rdInteger, Misc.BoolToInt(Preferences.DisplayUnitsIcons));
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'MarkUnknownMapsNMods', rdInteger, Misc.BoolToInt(Preferences.MarkUnknownMaps));
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'TaskbarButtons', rdInteger, Misc.BoolToInt(Preferences.TaskbarButtons));
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'JoinMainChannel', rdInteger, Misc.BoolToInt(Preferences.JoinMainChannel));
@@ -788,6 +792,7 @@
   p.FilterJoinLeftMessages := CheckBox3.Checked;
   p.FilterBattleJoinLeftMessages := FilterBattleJoinLeftCheckBox.Checked;
   p.ShowFlags := CheckBox4.Checked;
+  p.DisplayUnitsIcons := DisplayUnitsIconsCheckBox.Checked;
   p.MarkUnknownMaps := CheckBox5.Checked;
   p.TaskbarButtons := CheckBox6.Checked;
   p.JoinMainChannel := CheckBox7.Checked;
@@ -858,6 +863,7 @@
   CheckBox3.Checked := p.FilterJoinLeftMessages;
   FilterBattleJoinLeftCheckBox.Checked := p.FilterBattleJoinLeftMessages;
   CheckBox4.Checked := p.ShowFlags;
+  DisplayUnitsIconsCheckBox.Checked := p.DisplayUnitsIcons;
   CheckBox5.Checked := p.MarkUnknownMaps;
   CheckBox6.Checked := p.TaskbarButtons;
   CheckBox7.Checked := p.JoinMainChannel;

Modified: trunk/Lobby/TASClient/Python/api.txt
===================================================================
--- trunk/Lobby/TASClient/Python/api.txt	2008-08-06 11:12:22 UTC (rev 6236)
+++ trunk/Lobby/TASClient/Python/api.txt	2008-08-06 11:35:43 UTC (rev 6237)
@@ -54,6 +54,9 @@
 - AddSeparatorToMenu(menuName/SubmenuId) return SeparatorId
 - RemoveFromMenu(id)
 	Id can be an itemId or a SubmenuId or a SeparatorId.
+- DisplayNotification(title, msg, argsTuple, onClickModuleName, onClickFunctionName, displayTime)
+- DisplaySimpleNotification(title, msg, displayTime)
+	displayTime in ms
 
 
 

Modified: trunk/Lobby/TASClient/Python/scripts/stick.py
===================================================================
--- trunk/Lobby/TASClient/Python/scripts/stick.py	2008-08-06 11:12:22 UTC (rev 6236)
+++ trunk/Lobby/TASClient/Python/scripts/stick.py	2008-08-06 11:35:43 UTC (rev 6237)
@@ -52,9 +52,11 @@
 # exit stick mode if the sticked user left
 def in_REMOVEUSER(nick):
   global stickingNick
+  global menuUnstickId
   if nick == stickingNick:
     stickingNick = ''
     api.AddToTextBox('$current','Exiting stick mode ('+nick+' left).',colors['Info'])
+    gui.RemoveFromMenu(menuUnstickId)
 
 
 # we're joining a battle and we start waiting for 2 in_CLIENTBATTLESTATUS 

Modified: trunk/Lobby/TASClient/TASClient.dof
===================================================================
--- trunk/Lobby/TASClient/TASClient.dof	2008-08-06 11:12:22 UTC (rev 6236)
+++ trunk/Lobby/TASClient/TASClient.dof	2008-08-06 11:35:43 UTC (rev 6237)
@@ -115,7 +115,7 @@
 MajorVer=0
 MinorVer=3
 Release=0
-Build=392
+Build=393
 Debug=0
 PreRelease=0
 Special=0
@@ -126,7 +126,7 @@
 [Version Info Keys]
 CompanyName=
 FileDescription=TA Spring lobby client
-FileVersion=0.3.0.392
+FileVersion=0.3.0.393
 InternalName=
 LegalCopyright=
 LegalTrademarks=

Modified: trunk/Lobby/TASClient/TASClient.res
===================================================================
(Binary files differ)

Modified: trunk/Lobby/TASClient/Utility.pas
===================================================================
--- trunk/Lobby/TASClient/Utility.pas	2008-08-06 11:12:22 UTC (rev 6236)
+++ trunk/Lobby/TASClient/Utility.pas	2008-08-06 11:35:43 UTC (rev 6237)
@@ -533,7 +533,10 @@
   begin
     UnitNames.Add(GetFullUnitName(i));
     UnitList.Add(GetUnitName(i));
-    UnitBitmaps.Add(GetUnitBitmap(GetUnitName(i)));
+    if Preferences.DisplayUnitsIcons then
+      UnitBitmaps.Add(GetUnitBitmap(GetUnitName(i)))
+    else
+      UnitBitmaps.Add(TBitmap.Create);
   end;
 end;
 


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001016.html">[Taspring-linux-commit] r6236 - trunk/rts/Sim/MoveTypes
</A></li>
	<LI>Next message: <A HREF="001018.html">[Taspring-linux-commit] r6238 - in trunk/rts: Lua Rendering/Env
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1017">[ date ]</a>
              <a href="thread.html#1017">[ thread ]</a>
              <a href="subject.html#1017">[ subject ]</a>
              <a href="author.html#1017">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
