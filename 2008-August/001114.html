<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r6344 - in branches/0.77-branch: .	Lobby/TASClient installer/freedesktop/applications rts/Game	rts/Lua rts/Rendering rts/Rendering/Env rts/Rendering/GL	rts/Rendering/UnitModels rts/Sim/Projectiles rts/lib/gml	tools tools/ArchiveMoverLinux tools/DemoAnalyser tools/unitsync
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-August/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6344%20-%20in%20branches/0.77-branch%3A%20.%0A%09Lobby/TASClient%20installer/freedesktop/applications%20rts/Game%0A%09rts/Lua%20rts/Rendering%20rts/Rendering/Env%20rts/Rendering/GL%0A%09rts/Rendering/UnitModels%20rts/Sim/Projectiles%20rts/lib/gml%0A%09tools%20tools/ArchiveMoverLinux%20tools/DemoAnalyser%20tools/unitsync&In-Reply-To=%3C20080831205246.48A254A31%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001113.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r6344 - in branches/0.77-branch: .	Lobby/TASClient installer/freedesktop/applications rts/Game	rts/Lua rts/Rendering rts/Rendering/Env rts/Rendering/GL	rts/Rendering/UnitModels rts/Sim/Projectiles rts/lib/gml	tools tools/ArchiveMoverLinux tools/DemoAnalyser tools/unitsync</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6344%20-%20in%20branches/0.77-branch%3A%20.%0A%09Lobby/TASClient%20installer/freedesktop/applications%20rts/Game%0A%09rts/Lua%20rts/Rendering%20rts/Rendering/Env%20rts/Rendering/GL%0A%09rts/Rendering/UnitModels%20rts/Sim/Projectiles%20rts/lib/gml%0A%09tools%20tools/ArchiveMoverLinux%20tools/DemoAnalyser%20tools/unitsync&In-Reply-To=%3C20080831205246.48A254A31%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r6344 - in branches/0.77-branch: .	Lobby/TASClient installer/freedesktop/applications rts/Game	rts/Lua rts/Rendering rts/Rendering/Env rts/Rendering/GL	rts/Rendering/UnitModels rts/Sim/Projectiles rts/lib/gml	tools tools/ArchiveMoverLinux tools/DemoAnalyser tools/unitsync">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Sun Aug 31 22:52:45 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001113.html">[Taspring-linux-commit] r6343 - trunk/rts/Lua
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1114">[ date ]</a>
              <a href="thread.html#1114">[ thread ]</a>
              <a href="subject.html#1114">[ subject ]</a>
              <a href="author.html#1114">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: Auswaschbar
Date: 2008-08-31 22:52:43 +0200 (Sun, 31 Aug 2008)
New Revision: 6344

Added:
   branches/0.77-branch/tools/ArchiveMoverLinux/
   branches/0.77-branch/tools/ArchiveMoverLinux/Makefile
   branches/0.77-branch/tools/ArchiveMoverLinux/mover.ml
Removed:
   branches/0.77-branch/tools/ArchiveMoverLinux/Makefile
   branches/0.77-branch/tools/ArchiveMoverLinux/mover.ml
Modified:
   branches/0.77-branch/CMakeLists.txt
   branches/0.77-branch/Lobby/TASClient/BattleFormUnit.dfm
   branches/0.77-branch/Lobby/TASClient/BattleFormUnit.pas
   branches/0.77-branch/Lobby/TASClient/MainUnit.dfm
   branches/0.77-branch/Lobby/TASClient/MainUnit.pas
   branches/0.77-branch/Lobby/TASClient/TASClient.dof
   branches/0.77-branch/Lobby/TASClient/TASClient.res
   branches/0.77-branch/installer/freedesktop/applications/spring.desktop
   branches/0.77-branch/rts/Game/GameServer.cpp
   branches/0.77-branch/rts/Lua/LuaMaterial.cpp
   branches/0.77-branch/rts/Lua/LuaMaterial.h
   branches/0.77-branch/rts/Lua/LuaUnitRendering.cpp
   branches/0.77-branch/rts/Rendering/Env/AdvWater.cpp
   branches/0.77-branch/rts/Rendering/Env/BumpWater.cpp
   branches/0.77-branch/rts/Rendering/GL/VertexArray.cpp
   branches/0.77-branch/rts/Rendering/GL/VertexArray.h
   branches/0.77-branch/rts/Rendering/GL/myGL.h
   branches/0.77-branch/rts/Rendering/GroundDecalHandler.cpp
   branches/0.77-branch/rts/Rendering/UnitModels/UnitDrawer.cpp
   branches/0.77-branch/rts/Sim/Projectiles/ProjectileHandler.cpp
   branches/0.77-branch/rts/lib/gml/gmlfun.h
   branches/0.77-branch/tools/DemoAnalyser/CMakeLists.txt
   branches/0.77-branch/tools/unitsync/CMakeLists.txt
Log:
* apply latest patches from trunk


Modified: branches/0.77-branch/CMakeLists.txt
===================================================================
--- branches/0.77-branch/CMakeLists.txt	2008-08-31 12:07:07 UTC (rev 6343)
+++ branches/0.77-branch/CMakeLists.txt	2008-08-31 20:52:43 UTC (rev 6344)
@@ -70,9 +70,9 @@
 install (DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/game/ DESTINATION ${DATADIR} PATTERN &quot;.svn&quot; EXCLUDE)
 
 ### Install freedesktop-files, mime-types etc.
-if (UNIX)
+if (UNIX AND NOT MINGW)
 	install (FILES installer/freedesktop/applications/spring.desktop DESTINATION ${APPLICATIONS_DIR})
 	install (FILES installer/freedesktop/mime/spring.xml DESTINATION ${MIME_DIR}/packages)
 	install (FILES installer/freedesktop/pixmaps/spring.png installer/freedesktop/pixmaps/application-x-spring-demo.png DESTINATION ${PIXMAPS_DIR})
-endif (UNIX)
+endif (UNIX AND NOT MINGW)
 

Modified: branches/0.77-branch/Lobby/TASClient/BattleFormUnit.dfm
===================================================================
--- branches/0.77-branch/Lobby/TASClient/BattleFormUnit.dfm	2008-08-31 12:07:07 UTC (rev 6343)
+++ branches/0.77-branch/Lobby/TASClient/BattleFormUnit.dfm	2008-08-31 20:52:43 UTC (rev 6344)
@@ -1,6 +1,6 @@
 object BattleForm: TBattleForm
-  Left = 497
-  Top = 190
+  Left = 168
+  Top = 122
   Width = 787
   Height = 586
   Caption = 'Battle window'

Modified: branches/0.77-branch/Lobby/TASClient/BattleFormUnit.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/BattleFormUnit.pas	2008-08-31 12:07:07 UTC (rev 6343)
+++ branches/0.77-branch/Lobby/TASClient/BattleFormUnit.pas	2008-08-31 20:52:43 UTC (rev 6344)
@@ -4072,7 +4072,7 @@
   if (WhatToDraw = NormalClient) or (WhatToDraw = NormalBot) then
   begin
     // this ensures the correct highlite color is used (if item is not selected, otherwise VDT will paint it correctly anyway):
-    if PaintInfo.Node &lt;&gt; VDTBattleClients.FocusedNode then
+    if not VDTBattleClients.Selected[PaintInfo.Node] then
     begin
       PaintInfo.Canvas.Brush.Color := VDTBattleClients.Color;
       PaintInfo.Canvas.FillRect(PaintInfo.CellRect);
@@ -4497,11 +4497,12 @@
 
   p := (Sender as TControl).ClientToScreen(Point(X, Y));
 
-  if
+  if Button = mbRight
+     {
      // right button and a normal client or your bot
      (Button = mbRight) and (WhatToDraw &lt;&gt; OriginalClient) and
      ((WhatToDraw &lt;&gt; NormalBot) or (TBot(BattleState.Battle.Bots[RealIndex]).OwnerName = Status.Username))
-     {
+
      // battle host may change other player's or bot's properties:
      (
      (BattleState.Status = Hosting) and (Button = mbRight) and (VDTBattleClients.FocusedNode &lt;&gt; nil)
@@ -5245,7 +5246,7 @@
 begin
   GetNodeClient(VDTBattleClients.FocusedNode.Index,RealIndex,WhatToDraw);
 
-  SetTeamItem.Visible := (WhatToDraw &lt;&gt; OriginalClient) and ((BattleState.Status = Hosting) or ((WhatToDraw = NormalBot) and (TBot(BattleState.Battle.Bots[RealIndex]).OwnerName = Status.Username)));
+  SetTeamItem.Visible := ((WhatToDraw &lt;&gt; OriginalClient) and (BattleState.Status = Hosting) ) or ((WhatToDraw = NormalBot) and ((BattleState.Status = Hosting) or (TBot(BattleState.Battle.Bots[RealIndex]).OwnerName = Status.Username)));
   SetAllyItem.Visible := SetTeamItem.Visible;
   SetTeamColorItem.Visible := SetTeamItem.Visible;
   HandicapSpinEditItem.Visible := SetTeamItem.Visible;
@@ -5278,14 +5279,15 @@
   begin
     Client := TClient(BattleState.Battle.Clients[RealIndex]);
     ClientGroup := Client.GetGroup;
+
     if ClientGroup &gt;-1 then begin
-      mnuAddToGroup.Enabled := False;
+      mnuAddToGroup.Caption := 'Move to group';
       mnuRemoveFromGroup.Enabled := True;
     end
     else
     begin
+      mnuAddToGroup.Caption := 'Add to group';
       mnuRemoveFromGroup.Enabled := False;
-      mnuAddToGroup.Enabled := True
     end;
 
     for i:= mnuAddToGroup.Count-1 downto 2 do

Modified: branches/0.77-branch/Lobby/TASClient/MainUnit.dfm
===================================================================
--- branches/0.77-branch/Lobby/TASClient/MainUnit.dfm	2008-08-31 12:07:07 UTC (rev 6343)
+++ branches/0.77-branch/Lobby/TASClient/MainUnit.dfm	2008-08-31 20:52:43 UTC (rev 6344)
@@ -1,6 +1,6 @@
 object MainForm: TMainForm
-  Left = 627
-  Top = 343
+  Left = 480
+  Top = 329
   Width = 729
   Height = 543
   Caption = '.'

Modified: branches/0.77-branch/Lobby/TASClient/MainUnit.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/MainUnit.pas	2008-08-31 12:07:07 UTC (rev 6343)
+++ branches/0.77-branch/Lobby/TASClient/MainUnit.pas	2008-08-31 20:52:43 UTC (rev 6344)
@@ -522,7 +522,7 @@
 const
   VERSION_NUMBER = '0.38'; // Must be float value! (with a period as a decimal seperator)
   CHECK_BETA_LOBBY_URL = '<A HREF="http://tasclient.no-ip.org/TASClient_update_v2.txt">http://tasclient.no-ip.org/TASClient_update_v2.txt</A>';
-  PROGRAM_VERSION = 'TASClient ' + VERSION_NUMBER + ' RC9';
+  PROGRAM_VERSION = 'TASClient ' + VERSION_NUMBER + ' RC10';
   KEEP_ALIVE_INTERVAL = 10000; // in milliseconds. Tells us what should be the maximum &quot;silence&quot; time before we send a ping to the server.
   ASSUME_TIMEOUT_INTERVAL = 30000; // in milliseconds. Must be greater than KEEP_ALIVE_INTERVAL! If server hasn't send any data to us within this interval, then we assume timeout occured. It's us who must make sure we get constant replies from server by pinging it.
   LOCAL_TAB = '$Local'; // caption of main (command) tab window. Must be special so that is different from channel names or user names, that is why there is a &quot;$&quot; in front of it.
@@ -8900,14 +8900,16 @@
 procedure TMainForm.mnuRemoveFromGroupClick(Sender: TObject);
 var
   Client : TClient;
+  g : TClientGroup;
 begin
   //if ClientsListBox.ItemIndex = -1 then Exit; // I don't think this can actually happen, since we must click in ListBox and so select an item
   if GetClientIndexEx(SelectedUserName,AllClients) = -1 then Exit;
   Client := GetClient(SelectedUserName);
-  TClientGroup(ClientGroups[Client.GetGroup]).Clients.Delete(TClientGroup(ClientGroups[Client.GetGroup]).Clients.IndexOf(Client.Name));
+  g := TClientGroup(ClientGroups[Client.GetGroup]);
+  g.Clients.Delete(TClientGroup(ClientGroups[Client.GetGroup]).Clients.IndexOf(Client.Name));
   RefreshClientSort;
   MainForm.ClientsListBox.Refresh;
-  TClientGroup(ClientGroups[Client.GetGroup]).GroupUpdated;
+  g.GroupUpdated;
 end;
 
 procedure TMainForm.SaveGroups;

Modified: branches/0.77-branch/Lobby/TASClient/TASClient.dof
===================================================================
--- branches/0.77-branch/Lobby/TASClient/TASClient.dof	2008-08-31 12:07:07 UTC (rev 6343)
+++ branches/0.77-branch/Lobby/TASClient/TASClient.dof	2008-08-31 20:52:43 UTC (rev 6344)
@@ -115,7 +115,7 @@
 MajorVer=0
 MinorVer=3
 Release=0
-Build=428
+Build=429
 Debug=0
 PreRelease=0
 Special=0
@@ -126,7 +126,7 @@
 [Version Info Keys]
 CompanyName=
 FileDescription=TA Spring lobby client
-FileVersion=0.3.0.428
+FileVersion=0.3.0.429
 InternalName=
 LegalCopyright=
 LegalTrademarks=

Modified: branches/0.77-branch/Lobby/TASClient/TASClient.res
===================================================================
(Binary files differ)

Modified: branches/0.77-branch/installer/freedesktop/applications/spring.desktop
===================================================================
--- branches/0.77-branch/installer/freedesktop/applications/spring.desktop	2008-08-31 12:07:07 UTC (rev 6343)
+++ branches/0.77-branch/installer/freedesktop/applications/spring.desktop	2008-08-31 20:52:43 UTC (rev 6344)
@@ -1,6 +1,6 @@
 [Desktop Entry]
 Name=Spring
-MimeType=application/x-spring-demo;application/x-spring-data-zip;application/x-spring-data-7zip
+MimeType=application/x-spring-demo
 Comment=An open source RTS with similar gameplay to TA
 Comment[de]=Open-Source Multiplayerstrategie
 TryExec=spring

Modified: branches/0.77-branch/rts/Game/GameServer.cpp
===================================================================
--- branches/0.77-branch/rts/Game/GameServer.cpp	2008-08-31 12:07:07 UTC (rev 6343)
+++ branches/0.77-branch/rts/Game/GameServer.cpp	2008-08-31 20:52:43 UTC (rev 6344)
@@ -796,7 +796,11 @@
 					}
 					case TEAMMSG_TEAM_DIED: { // don't send to clients, they don't need it
 						unsigned char team = inbuf[3];
+#ifndef DEDICATED
 						if (teams[team] &amp;&amp; players[player]-&gt;isLocal) // currently only host is allowed
+#else
+						if (teams[team])
+#endif
 						{
 							teams[fromTeam].reset();
 							for (int i = 0; i &lt; MAX_PLAYERS; ++i)
@@ -1196,11 +1200,11 @@
 		return;
 	}
 
-	unsigned numActiveTeams[MAX_TEAMS]; // active teams per ally team
-	memset(numActiveTeams, 0, sizeof(numActiveTeams));
 	unsigned numActiveAllyTeams = 0;
 
 #ifndef DEDICATED
+	unsigned numActiveTeams[MAX_TEAMS]; // active teams per ally team
+	memset(numActiveTeams, 0, sizeof(numActiveTeams));
 	for (unsigned a = 0; (int)a &lt; gs-&gt;activeTeams; ++a)
 	{
 		bool hasPlayer = false;
@@ -1220,16 +1224,19 @@
 		if (numActiveTeams[a] != 0)
 			++numActiveAllyTeams;
 #else
-	int lastAllyTeam = -1;
+	int firstAllyTeam = -1;
 	for (unsigned i = 0; i &lt; MAX_PLAYERS; ++i)
 	{
-		if (players[i])
+		if (players[i] &amp;&amp; !players[i]-&gt;spectator)
 		{
-			if (lastAllyTeam &lt; 0)
-				lastAllyTeam = i;
-			else if (lastAllyTeam != teams[players[i]-&gt;team]-&gt;allyTeam)
+			if (firstAllyTeam &lt; 0)
 			{
+				firstAllyTeam = teams[players[i]-&gt;team]-&gt;allyTeam;
 				numActiveAllyTeams = 1;
+			}
+			else if (firstAllyTeam != teams[players[i]-&gt;team]-&gt;allyTeam)
+			{
+				numActiveAllyTeams = 2;
 				break;
 			}
 		}

Modified: branches/0.77-branch/rts/Lua/LuaMaterial.cpp
===================================================================
--- branches/0.77-branch/rts/Lua/LuaMaterial.cpp	2008-08-31 12:07:07 UTC (rev 6343)
+++ branches/0.77-branch/rts/Lua/LuaMaterial.cpp	2008-08-31 20:52:43 UTC (rev 6344)
@@ -45,7 +45,7 @@
 		return;
 	}
 	if (speedLoc != 0) {
-		glUniform3f(speedLoc, unit-&gt;speed.x, unit-&gt;speed.y, unit-&gt;speed.z);
+		glUniformf3(speedLoc, unit-&gt;speed);
 	}
 	if (healthLoc != 0) {
 		glUniform1f(healthLoc, unit-&gt;health / unit-&gt;maxHealth);
@@ -238,13 +238,10 @@
 }
 
 
-void LuaMatTexture::Execute(const LuaMatTexture&amp; prev) const
+void LuaMatTexture::Bind(const LuaMatTexture&amp; prev) const
 {
 	// blunt force -- poor form
-	if (prev.enable) {
-		glDisable(GL_TEXTURE_2D);
-		glDisable(GL_TEXTURE_CUBE_MAP_ARB);
-	}
+	prev.Unbind();
 
 	if (type == LUATEX_GL) {
 		glBindTexture(GL_TEXTURE_2D, openglID);
@@ -254,6 +251,9 @@
 	}
 	else if (type == LUATEX_SHADOWMAP) {
 		glBindTexture(GL_TEXTURE_2D, shadowHandler-&gt;shadowTexture);
+		glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_COMPARE_MODE_ARB, GL_COMPARE_R_TO_TEXTURE);
+		glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_COMPARE_FUNC_ARB, GL_LEQUAL);
+		glTexParameteri(GL_TEXTURE_2D, GL_DEPTH_TEXTURE_MODE_ARB, GL_LUMINANCE);
 		if (enable) {
 			glEnable(GL_TEXTURE_2D);
 		}
@@ -273,6 +273,28 @@
 }
 
 
+void LuaMatTexture::Unbind() const
+{
+	if (type == LUATEX_NONE || (!enable &amp;&amp; (type != LUATEX_SHADOWMAP)))
+        return;
+
+	if (type == LUATEX_GL) {
+		glDisable(GL_TEXTURE_2D);
+	}
+	else if (type == LUATEX_SHADOWMAP) {
+		glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_COMPARE_MODE_ARB, GL_NONE);
+		glTexParameteri(GL_TEXTURE_2D, GL_DEPTH_TEXTURE_MODE_ARB, GL_LUMINANCE);
+		glDisable(GL_TEXTURE_2D);
+	}
+	else if (type == LUATEX_REFLECTION) {
+		glDisable(GL_TEXTURE_CUBE_MAP_ARB);
+	}
+	else if (type == LUATEX_SPECULAR) {
+		glDisable(GL_TEXTURE_CUBE_MAP_ARB);
+	}
+}
+
+
 void LuaMatTexture::Print(const string&amp; indent) const
 {
 	const char* typeName = &quot;Unknown&quot;;
@@ -323,7 +345,7 @@
 
 	shader.Execute(prev.shader);
 
-	if (cameraLoc) {
+	if (cameraLoc&gt;=0) {
 		// FIXME: this is happening too much, just use floats?
 		GLfloat array[16];
 		const GLdouble* modelview = camera-&gt;GetModelview();
@@ -333,10 +355,22 @@
 		glUniformMatrix4fv(cameraLoc, 1, GL_FALSE, array);
 	}
 
+	if (cameraPosLoc&gt;=0) {
+		glUniformf3(cameraPosLoc, camera-&gt;pos);
+	}
+
+	if (shadowLoc&gt;=0) {
+		glUniformMatrix4fv(shadowLoc, 1, GL_FALSE, shadowHandler-&gt;shadowMatrix.m);
+	}
+
+	if (shadowParamsLoc&gt;=0) {
+		glUniform4f(shadowParamsLoc, shadowHandler-&gt;xmid, shadowHandler-&gt;ymid, shadowHandler-&gt;p17, shadowHandler-&gt;p18);
+	}
+
 	const int maxTex = std::max(texCount, prev.texCount);
 	for (int t = (maxTex - 1); t &gt;= 0; t--) {
 		glActiveTexture(GL_TEXTURE0 + t);
-		textures[t].Execute(prev.textures[t]);
+		textures[t].Bind(prev.textures[t]);
 	}
 
 	if (useCamera != prev.useCamera) {
@@ -347,6 +381,15 @@
 			glLoadIdentity();
 		}
 	}
+
+	if (culling != prev.culling) {
+		if (culling) {
+			glEnable(GL_CULL_FACE);
+			glCullFace(culling);
+		} else {
+			glDisable(GL_CULL_FACE);
+		}
+	}
 }
 
 
@@ -376,7 +419,7 @@
 		}
 	}
 	if (a.texCount != b.texCount) {
-		return (a.texCount &lt; b.texCount) ? -1 : + 1;
+		return (a.texCount &lt; b.texCount) ? -1 : +1;
 	}
 
 	if (a.preList != b.preList) {
@@ -391,10 +434,26 @@
 		return a.useCamera ? -1 : +1;
 	}
 
+	if (a.culling != b.culling) {
+		return (a.culling &lt; b.culling) ? -1 : +1;
+	}
+
 	if (a.cameraLoc != b.cameraLoc) {
-		return (a.cameraLoc &lt; a.cameraLoc) ? -1 : +1;
+		return (a.cameraLoc &lt; b.cameraLoc) ? -1 : +1;
 	}
 
+	if (a.cameraPosLoc != b.cameraPosLoc) {
+		return (a.cameraPosLoc &lt; b.cameraPosLoc) ? -1 : +1;
+	}
+
+	if (a.shadowLoc != b.shadowLoc) {
+		return (a.shadowLoc &lt; b.shadowLoc) ? -1 : +1;
+	}
+
+	if (a.shadowParamsLoc != b.shadowParamsLoc) {
+		return (a.shadowParamsLoc &lt; b.shadowParamsLoc) ? -1 : +1;
+	}
+
 	return 0;
 }
 
@@ -415,6 +474,9 @@
 
 void LuaMaterial::Print(const string&amp; indent) const
 {
+#define CULL_TO_STR(x) \
+	(x==GL_FRONT) ? &quot;front&quot; : (x==GL_BACK) ? &quot;back&quot; : (x!=0) ? &quot;false&quot; : &quot;unknown&quot;
+
 	PRINTF(&quot;%s%s\n&quot;, indent.c_str(), GetMatTypeName(type));
 	PRINTF(&quot;%sorder = %i\n&quot;, indent.c_str(), order);
 	shader.Print(indent);
@@ -427,7 +489,11 @@
 	PRINTF(&quot;%spreList  = %i\n&quot;,  indent.c_str(), preList);
 	PRINTF(&quot;%spostList = %i\n&quot;,  indent.c_str(), postList);
 	PRINTF(&quot;%suseCamera = %s\n&quot;, indent.c_str(), useCamera ? &quot;true&quot; : &quot;false&quot;);
+	PRINTF(&quot;%sculling = %s\n&quot;, indent.c_str(), CULL_TO_STR(culling));
 	PRINTF(&quot;%scameraLoc = %i\n&quot;, indent.c_str(), cameraLoc);
+	PRINTF(&quot;%scameraPosLoc = %i\n&quot;, indent.c_str(), cameraPosLoc);
+	PRINTF(&quot;%sshadowLoc = %i\n&quot;, indent.c_str(), shadowLoc);
+	PRINTF(&quot;%sshadowParamsLoc = %i\n&quot;, indent.c_str(), shadowParamsLoc);
 }
 
 

Modified: branches/0.77-branch/rts/Lua/LuaMaterial.h
===================================================================
--- branches/0.77-branch/rts/Lua/LuaMaterial.h	2008-08-31 12:07:07 UTC (rev 6343)
+++ branches/0.77-branch/rts/Lua/LuaMaterial.h	2008-08-31 20:52:43 UTC (rev 6344)
@@ -80,7 +80,8 @@
 
 		void Finalize();
 
-		void Execute(const LuaMatTexture&amp; prev) const;
+		void Bind(const LuaMatTexture&amp; prev) const;
+		void Unbind() const;
 
 		void Print(const string&amp; indent) const;
 
@@ -128,7 +129,9 @@
 		: type(LuaMatType(-1)), // invalid
 		  order(0), texCount(0),
 		  preList(0), postList(0),
-		  useCamera(true), cameraLoc(0)
+		  useCamera(true), culling(0),
+		  cameraLoc(-1), cameraPosLoc(-1),
+		  shadowLoc(-1), shadowParamsLoc(-1)
 		{}
 
 		void Finalize();
@@ -159,7 +162,11 @@
 		GLuint postList;
 
 		bool useCamera;
+		GLenum culling;
 		GLint cameraLoc;
+		GLint cameraPosLoc;
+		GLint shadowLoc;
+		GLint shadowParamsLoc;
 
 		static const LuaMaterial defMat;
 };
@@ -173,7 +180,9 @@
 		: type(LuaMatType(-1)), // invalid
 		  order(0), texCount(0),
 		  preList(0), postList(0),
-		  useCamera(true), cameraLoc(0)
+		  useCamera(true), culling(0),
+		  cameraLoc(-1), cameraPosLoc(-1),
+		  shadowLoc(-1), shadowParamsLoc(-1)
 		{}
 
 		LuaMatRef GetRef() const;
@@ -189,7 +198,11 @@
 		GLuint postList;
 
 		bool useCamera;
+		GLenum culling;
 		GLint cameraLoc;
+		GLint cameraPosLoc;
+		GLint shadowLoc;
+		GLint shadowParamsLoc;
 };
 
 

Modified: branches/0.77-branch/rts/Lua/LuaUnitRendering.cpp
===================================================================
--- branches/0.77-branch/rts/Lua/LuaUnitRendering.cpp	2008-08-31 12:07:07 UTC (rev 6343)
+++ branches/0.77-branch/rts/Lua/LuaUnitRendering.cpp	2008-08-31 20:52:43 UTC (rev 6344)
@@ -445,11 +445,31 @@
 				mat.useCamera = lua_toboolean(L, -1);
 			}
 		}
+		else if (key == &quot;culling&quot;) {
+			if (lua_isnumber(L, -1)) {
+				mat.culling = (GLenum)lua_tonumber(L, -1);
+			}
+		}
 		else if (key == &quot;cameraloc&quot;) {
 			if (lua_isnumber(L, -1)) {
 				mat.cameraLoc = (GLint)lua_tonumber(L, -1);
 			}
 		}
+		else if (key == &quot;cameraposloc&quot;) {
+			if (lua_isnumber(L, -1)) {
+				mat.cameraPosLoc = (GLint)lua_tonumber(L, -1);
+			}
+		}
+		else if (key == &quot;shadowloc&quot;) {
+			if (lua_isnumber(L, -1)) {
+				mat.shadowLoc = (GLint)lua_tonumber(L, -1);
+			}
+		}
+		else if (key == &quot;shadowparamsloc&quot;) {
+			if (lua_isnumber(L, -1)) {
+				mat.shadowParamsLoc = (GLint)lua_tonumber(L, -1);
+			}
+		}
 	}
 
 	mat.Finalize();

Modified: branches/0.77-branch/rts/Rendering/Env/AdvWater.cpp
===================================================================
--- branches/0.77-branch/rts/Rendering/Env/AdvWater.cpp	2008-08-31 12:07:07 UTC (rev 6343)
+++ branches/0.77-branch/rts/Rendering/Env/AdvWater.cpp	2008-08-31 20:52:43 UTC (rev 6344)
@@ -148,7 +148,6 @@
 		glDisable(GL_BLEND);
 	}
 	glDepthMask(0);
-	glBindTexture(GL_TEXTURE_2D, reflectTexture);
 	glActiveTextureARB(GL_TEXTURE1_ARB);
 		glBindTexture(GL_TEXTURE_2D, bumpTexture);
 		GLfloat plan[]={0.02f,0,0,0};
@@ -161,6 +160,7 @@
 		glTexGenfv(GL_T,GL_EYE_PLANE,plan2);
 		glEnable(GL_TEXTURE_GEN_T);
 	glActiveTextureARB(GL_TEXTURE0_ARB);
+	glBindTexture(GL_TEXTURE_2D, reflectTexture);
 
 	glBindProgramARB( GL_FRAGMENT_PROGRAM_ARB, waterFP );
 	glEnable( GL_FRAGMENT_PROGRAM_ARB );

Modified: branches/0.77-branch/rts/Rendering/Env/BumpWater.cpp
===================================================================
--- branches/0.77-branch/rts/Rendering/Env/BumpWater.cpp	2008-08-31 12:07:07 UTC (rev 6343)
+++ branches/0.77-branch/rts/Rendering/Env/BumpWater.cpp	2008-08-31 20:52:43 UTC (rev 6344)
@@ -186,7 +186,7 @@
 	refraction   = configHandler.GetInt(&quot;BumpWaterRefraction&quot;, 1);  /// 0:=off, 1:=screencopy, 2:=own rendering cycle
 	anisotropy   = atof(configHandler.GetString(&quot;BumpWaterAnisotropy&quot;, &quot;0.0&quot;).c_str());
 	depthCopy    = !!configHandler.GetInt(&quot;BumpWaterUseDepthTexture&quot;, 1);
-	depthBits    = configHandler.GetInt(&quot;BumpWaterDepthBits&quot;, 24);
+	depthBits    = configHandler.GetInt(&quot;BumpWaterDepthBits&quot;, (gu-&gt;atiHacks)?16:24);
 	blurRefl     = !!configHandler.GetInt(&quot;BumpWaterBlurReflection&quot;, 0);
 	shoreWaves   = (!!configHandler.GetInt(&quot;BumpWaterShoreWaves&quot;, 1)) &amp;&amp; mapInfo-&gt;water.shoreWaves;
 	endlessOcean = (!!configHandler.GetInt(&quot;BumpWaterEndlessOcean&quot;, 1)) &amp;&amp; mapInfo-&gt;hasWaterPlane;
@@ -706,13 +706,13 @@
 
 void CBumpWater::UpdateCoastmap(const int x1, const int y1, const int x2, const int y2)
 {
+	glDisable(GL_BLEND);
+	glDepthMask(GL_FALSE);
+	glDisable(GL_DEPTH_TEST);
+
 	glBindFramebufferEXT(GL_FRAMEBUFFER_EXT, coastFBO);
 	GLenum status = glCheckFramebufferStatusEXT(GL_FRAMEBUFFER_EXT);
 	if (status == GL_FRAMEBUFFER_COMPLETE_EXT) {
-		glDisable(GL_DEPTH_TEST);
-		glDepthMask(GL_FALSE);
-		glDisable(GL_BLEND);
-
 		glActiveTexture(GL_TEXTURE1); glBindTexture(GL_TEXTURE_2D, coastTexture[1]);
 		glActiveTexture(GL_TEXTURE0); glBindTexture(GL_TEXTURE_2D, coastTexture[0]);
 		glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_NEAREST);

Modified: branches/0.77-branch/rts/Rendering/GL/VertexArray.cpp
===================================================================
--- branches/0.77-branch/rts/Rendering/GL/VertexArray.cpp	2008-08-31 12:07:07 UTC (rev 6343)
+++ branches/0.77-branch/rts/Rendering/GL/VertexArray.cpp	2008-08-31 20:52:43 UTC (rev 6344)
@@ -49,6 +49,16 @@
 		EnlargeStripArray();
 }
 
+void CVertexArray::DrawArrays(int drawType, int stride) {
+	int newIndex,oldIndex=0;
+	int *stripArrayPtr=stripArray;
+	while(stripArrayPtr&lt;stripArrayPos) {
+		newIndex=(*stripArrayPtr++)/stride;
+		glDrawArrays(drawType,oldIndex,newIndex-oldIndex);
+		oldIndex=newIndex;
+	}
+}
+
 void CVertexArray::DrawArray0(int drawType,int stride) {
 	CheckEndStrip();
 	glEnableClientState(GL_VERTEX_ARRAY);

Modified: branches/0.77-branch/rts/Rendering/GL/VertexArray.h
===================================================================
--- branches/0.77-branch/rts/Rendering/GL/VertexArray.h	2008-08-31 12:07:07 UTC (rev 6343)
+++ branches/0.77-branch/rts/Rendering/GL/VertexArray.h	2008-08-31 20:52:43 UTC (rev 6344)
@@ -1,6 +1,5 @@
 #ifndef VERTEXARRAY_H
 #define VERTEXARRAY_H
-#include &quot;myGL.h&quot;
 // VertexArray.h: interface for the CVertexArray class.
 //
 //////////////////////////////////////////////////////////////////////
@@ -45,7 +44,7 @@
 	int* stripArraySize;
 
 protected:
-	inline void DrawArrays(int drawType, int stride);
+	void DrawArrays(int drawType, int stride);
 	inline void CheckEnlargeDrawArray();
 	void EnlargeStripArray();
 	void EnlargeDrawArray();
@@ -136,14 +135,4 @@
 	*stripArrayPos++=((char *)drawArrayPos-(char *)drawArray);
 }
 
-inline void CVertexArray::DrawArrays(int drawType, int stride) {
-	int newIndex,oldIndex=0;
-	int *stripArrayPtr=stripArray;
-	while(stripArrayPtr&lt;stripArrayPos) {
-		newIndex=(*stripArrayPtr++)/stride;
-		glDrawArrays(drawType,oldIndex,newIndex-oldIndex);
-		oldIndex=newIndex;
-	}
-}
-
 #endif /* VERTEXARRAY_H */

Modified: branches/0.77-branch/rts/Rendering/GL/myGL.h
===================================================================
--- branches/0.77-branch/rts/Rendering/GL/myGL.h	2008-08-31 12:07:07 UTC (rev 6343)
+++ branches/0.77-branch/rts/Rendering/GL/myGL.h	2008-08-31 20:52:43 UTC (rev 6344)
@@ -8,12 +8,11 @@
 
 #include &lt;string&gt;
 #include &lt;GL/glew.h&gt;
+#include &quot;float3.h&quot;
 
 #include &quot;lib/gml/gml.h&quot;
 
-#include &quot;float3.h&quot;
 
-
 inline void glVertexf3(const float3 &amp;v)
 {
 	glVertex3f(v.x,v.y,v.z);

Modified: branches/0.77-branch/rts/Rendering/GroundDecalHandler.cpp
===================================================================
--- branches/0.77-branch/rts/Rendering/GroundDecalHandler.cpp	2008-08-31 12:07:07 UTC (rev 6343)
+++ branches/0.77-branch/rts/Rendering/GroundDecalHandler.cpp	2008-08-31 20:52:43 UTC (rev 6344)
@@ -312,6 +312,8 @@
 		glDisable(GL_FRAGMENT_PROGRAM_ARB);
 		glDisable(GL_VERTEX_PROGRAM_ARB);
 		glActiveTextureARB(GL_TEXTURE2_ARB);
+		glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_COMPARE_MODE_ARB, GL_NONE);
+		glTexParameteri(GL_TEXTURE_2D, GL_DEPTH_TEXTURE_MODE_ARB, GL_LUMINANCE);
 		glDisable(GL_TEXTURE_2D);
 
 		glActiveTextureARB(GL_TEXTURE1_ARB);

Modified: branches/0.77-branch/rts/Rendering/UnitModels/UnitDrawer.cpp
===================================================================
--- branches/0.77-branch/rts/Rendering/UnitModels/UnitDrawer.cpp	2008-08-31 12:07:07 UTC (rev 6343)
+++ branches/0.77-branch/rts/Rendering/UnitModels/UnitDrawer.cpp	2008-08-31 20:52:43 UTC (rev 6344)
@@ -485,7 +485,7 @@
 
 	luaDrawing = true;
 
-	glPushAttrib(GL_TEXTURE_BIT | GL_ENABLE_BIT);
+	glPushAttrib(GL_TEXTURE_BIT | GL_ENABLE_BIT | GL_TRANSFORM_BIT);
 
 	const LuaMaterial* currMat = &amp;LuaMaterial::defMat;
 

Modified: branches/0.77-branch/rts/Sim/Projectiles/ProjectileHandler.cpp
===================================================================
--- branches/0.77-branch/rts/Sim/Projectiles/ProjectileHandler.cpp	2008-08-31 12:07:07 UTC (rev 6343)
+++ branches/0.77-branch/rts/Sim/Projectiles/ProjectileHandler.cpp	2008-08-31 20:52:43 UTC (rev 6344)
@@ -488,26 +488,28 @@
 		m.Rotate((*pi)-&gt;rot,(*pi)-&gt;rotAxis);
 		float3 interPos=(*pi)-&gt;pos+(*pi)-&gt;speed*gu-&gt;timeOffset;
 		CTextureHandler::UnitTexture* tex=(*pi)-&gt;prim-&gt;texture;
+		const std::vector&lt;S3DOVertex&gt;&amp; vertices    = (*pi)-&gt;object-&gt;vertices;
+		const std::vector&lt;int&gt;&amp;        verticesIdx = (*pi)-&gt;prim-&gt;vertices;
 
-		S3DOVertex* v=&amp;(*pi)-&gt;object-&gt;vertices[(*pi)-&gt;prim-&gt;vertices[0]];
+		const S3DOVertex* v=&amp;vertices[verticesIdx[0]];
 		float3 tp=m.Mul(v-&gt;pos);
 		float3 tn=m.Mul(v-&gt;normal);
 		tp+=interPos;
 		va-&gt;AddVertexTN(tp,tex-&gt;xstart,tex-&gt;ystart,tn);
 
-		v=&amp;(*pi)-&gt;object-&gt;vertices[(*pi)-&gt;prim-&gt;vertices[1]];
+		v=&amp;vertices[verticesIdx[1]];
 		tp=m.Mul(v-&gt;pos);
 		tn=m.Mul(v-&gt;normal);
 		tp+=interPos;
 		va-&gt;AddVertexTN(tp,tex-&gt;xend,tex-&gt;ystart,tn);
 
-		v=&amp;(*pi)-&gt;object-&gt;vertices[(*pi)-&gt;prim-&gt;vertices[2]];
+		v=&amp;vertices[verticesIdx[2]];
 		tp=m.Mul(v-&gt;pos);
 		tn=m.Mul(v-&gt;normal);
 		tp+=interPos;
 		va-&gt;AddVertexTN(tp,tex-&gt;xend,tex-&gt;yend,tn);
 
-		v=&amp;(*pi)-&gt;object-&gt;vertices[(*pi)-&gt;prim-&gt;vertices[3]];
+		v=&amp;vertices[verticesIdx[3]];
 		tp=m.Mul(v-&gt;pos);
 		tn=m.Mul(v-&gt;normal);
 		tp+=interPos;
@@ -619,14 +621,14 @@
 
 	sort(distlist.begin(), distlist.end(), CompareProjDist);
 
+	glEnable(GL_BLEND);
 	glBlendFunc(GL_ONE, GL_ONE_MINUS_SRC_ALPHA);
 	glEnable(GL_TEXTURE_2D);
 	textureAtlas-&gt;BindTexture();
-	glEnable(GL_BLEND);
-	glDepthMask(0);
 	glColor4f(1,1,1,0.2f);
 	glAlphaFunc(GL_GREATER,0.0f);
 	glEnable(GL_ALPHA_TEST);
+	glDepthMask(0);
 //	glFogfv(GL_FOG_COLOR,mapInfo-&gt;atmosphere.fogColor);
 	glDisable(GL_FOG);
 
@@ -639,8 +641,13 @@
 	}
 	if(CProjectile::inArray)
 		CProjectile::DrawArray();
-	glDisable(GL_TEXTURE_2D);
+
+	glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
+	//glDisable(GL_TEXTURE_2D);
+	glDisable(GL_ALPHA_TEST);
+	glColor4f(1,1,1,1.0f);
 	glDepthMask(1);
+
 	currentParticles=(int)(ps.size()*0.8f+currentParticles*0.2f);
 	currentParticles+=(int)(0.2f*drawnPieces+0.3f*numFlyingPieces);
 	particleSaturation=(float)currentParticles/(float)maxParticles;
@@ -993,6 +1000,7 @@
 	perlinFB-&gt;deselect();
 	glViewport(gu-&gt;viewPosX,0,gu-&gt;viewSizeX,gu-&gt;viewSizeY);
 
+	glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
 	glEnable(GL_DEPTH_TEST);
 	glDisable(GL_TEXTURE_2D);
 	glDepthMask(1);

Modified: branches/0.77-branch/rts/lib/gml/gmlfun.h
===================================================================
--- branches/0.77-branch/rts/lib/gml/gmlfun.h	2008-08-31 12:07:07 UTC (rev 6343)
+++ branches/0.77-branch/rts/lib/gml/gmlfun.h	2008-08-31 20:52:43 UTC (rev 6344)
@@ -12,27 +12,20 @@
 #include &lt;set&gt;
 #include &lt;map&gt;
 
+#define DEBUG_GML 0 // enable debugging
 
-#define GML_NERROR_FUN(str,val)\
-f=fopen(&quot;C:\\GMLERR.TXT&quot;,&quot;a&quot;);\
-if(f) {\
-	fprintf(f,&quot;%s line %d: %s %d\n&quot;,__FILE__,__LINE__,str,val);\
-	fclose(f);\
-}
-
-#define GML_ERROR_FUN(str,val)\
-FILE *f=fopen(&quot;C:\\GMLERR.TXT&quot;,&quot;a&quot;);\
-if(f) {\
-	fprintf(f,&quot;%s line %d: %s %d\n&quot;,__FILE__,__LINE__,str,val);\
-	fclose(f);\
-}
-
+#if DEBUG_GML
 #define GML_DEBUG_FUN(str,val)\
-FILE *f=fopen(&quot;C:\\GMLDBG.TXT&quot;,&quot;a&quot;);\
-if(f) {\
-	fprintf(f,&quot;%s line %d: %s %d\n&quot;,__FILE__,__LINE__,str,val);\
-	fclose(f);\
+{\
+	FILE *f=fopen(&quot;C:\\GMLDBG.TXT&quot;,&quot;a&quot;);\
+	if(f) {\
+		fprintf(f,&quot;%s line %d: %s %d\n&quot;,__FILE__,__LINE__,str,val);\
+		fclose(f);\
+	}\
 }
+#else
+#define GML_DEBUG_FUN(str,val)
+#endif
 
 extern std::map&lt;GLenum,GLint&gt; gmlGetIntegervCache;
 extern std::map&lt;GLenum,GLfloat&gt; gmlGetFloatvCache;
@@ -43,10 +36,9 @@
 #define GML_DEFAULT_RET(c,r) if(GML_USE_DEFAULT &amp;&amp; (c)) {return r;}
 #define GML_DEFAULT_ERROR() if(GML_USE_NO_ERROR) return GL_NO_ERROR;
 
+//teximage, build2dmip
 EXTERN inline int gmlNumArgsTexImage(int datatype) {
-//	FILE *f;
 	switch(datatype) {
-		//teximage, build2dmip
 		case GL_COLOR_INDEX:
 		case GL_RED:
 		case GL_GREEN:
@@ -64,15 +56,14 @@
 		case GL_BGRA_EXT:
 			return 4;
 		default:
-//			GML_NERROR_FUN(&quot;gmlNumArgsTexImage&quot;, datatype)
+			GML_DEBUG_FUN(&quot;gmlNumArgsTexImage&quot;, datatype)
 			return 0;
 	}
 }
 
+// glLight, glMaterial
 EXTERN inline int gmlNumArgsLightMat(int datatype) {
-//	FILE *f;
 	switch(datatype) {
-// glLight, glMaterial
 		case GL_AMBIENT:
 		case GL_DIFFUSE:
 		case GL_SPECULAR:
@@ -91,15 +82,14 @@
 		case GL_QUADRATIC_ATTENUATION:
 			return 1;
 		default:
-//			GML_NERROR_FUN(&quot;gmlNumArgsLightMat&quot;, datatype)
+			GML_DEBUG_FUN(&quot;gmlNumArgsLightMat&quot;, datatype)
 			return 0;
 	}
 }
 
+//glFog
 EXTERN inline int gmlNumArgsFog(int datatype) {
-//	FILE *f;
 	switch(datatype) {
-//glFog
 		case GL_FOG_MODE:
 		case GL_FOG_DENSITY:
 		case GL_FOG_START:
@@ -109,44 +99,41 @@
 		case GL_FOG_COLOR:
 			return 4;
 		default:
-//			GML_NERROR_FUN(&quot;gmlNumArgsFog&quot;, datatype)
+			GML_DEBUG_FUN(&quot;gmlNumArgsFog&quot;, datatype)
 			return 0;
 	}
 }
 
+//glTexGen
 EXTERN inline int gmlNumArgsTexGen(int datatype) {
-//	FILE *f;
 	switch(datatype) {
-//glTexGen
 		case GL_TEXTURE_GEN_MODE:
 			return 1;
 		case GL_OBJECT_PLANE:
 		case GL_EYE_PLANE:
 			return 4;
 		default:
-//			GML_NERROR_FUN(&quot;gmlNumArgsTexGen&quot;, datatype)
+			GML_DEBUG_FUN(&quot;gmlNumArgsTexGen&quot;, datatype)
 			return 0;
 	}
 }
 
+//glTexEnv
 EXTERN inline int gmlNumArgsTexEnv(int datatype) {
-//	FILE *f;
 	switch(datatype) {
-//glTexEnv
 		case GL_TEXTURE_ENV_MODE:
 			return 1;
 		case GL_TEXTURE_ENV_COLOR:
 			return 4;
 		default:
-//			GML_NERROR_FUN(&quot;gmlNumArgsTexEnv&quot;, datatype)
+			GML_DEBUG_FUN(&quot;gmlNumArgsTexEnv&quot;, datatype)
 			return 0;
 	}
 }
 
+//glPointParametefv
 EXTERN inline int gmlNumArgsPointParam(int datatype) {
-//	FILE *f;
 	switch(datatype) {
-//glPointParametefv
 		case GL_POINT_SIZE_MIN:
 		case GL_POINT_SIZE_MAX:
 		case GL_POINT_FADE_THRESHOLD_SIZE:
@@ -155,15 +142,14 @@
 		case GL_POINT_DISTANCE_ATTENUATION:
 			return 3;
 		default:
-//			GML_NERROR_FUN(&quot;gmlNumArgsPointParam&quot;, datatype)
+			GML_DEBUG_FUN(&quot;gmlNumArgsPointParam&quot;, datatype)
 			return 0;
 	}
 }
 
+//glTexParameterfv
 EXTERN inline int gmlNumArgsTexParam(int datatype) {
-//	FILE *f;
 	switch(datatype) {
-//glTexParameterfv
 		case GL_TEXTURE_MIN_FILTER:
 		case GL_TEXTURE_MAG_FILTER:
 		case GL_TEXTURE_WRAP_S:
@@ -173,28 +159,28 @@
 		case GL_TEXTURE_BORDER_COLOR:
 			return 4;
 		default:
-//			GML_NERROR_FUN(&quot;gmlNumArgsTexParam&quot;, datatype)
+			GML_DEBUG_FUN(&quot;gmlNumArgsTexParam&quot;, datatype)
 			return 0;
 	}
 }
 
+//glLightModelfv
 EXTERN inline int gmlNumArgsLightModel(int datatype) {
-//	FILE *f;
 	switch(datatype) {
-//glLightModelfv
 		case GL_LIGHT_MODEL_LOCAL_VIEWER:
 		case GL_LIGHT_MODEL_TWO_SIDE:
 			return 1;
 		case GL_LIGHT_MODEL_AMBIENT:
 			return 4;
 		default:
-//			GML_NERROR_FUN(&quot;gmlNumArgsLightModel&quot;, datatype)
+			GML_DEBUG_FUN(&quot;gmlNumArgsLightModel&quot;, datatype)
 			return 0;
 	}
 }
 
-EXTERN inline int gmlNumArgsMap1(GLenum type) {
-	switch(type) {
+//glMap1f
+EXTERN inline int gmlNumArgsMap1(int datatype) {
+	switch(datatype) {
 		case GL_MAP1_INDEX:
 		case GL_MAP1_TEXTURE_COORD_1:
 			return 1;
@@ -209,12 +195,14 @@
 		case GL_MAP1_TEXTURE_COORD_4:
 			return 4;
 		default:
+			GML_DEBUG_FUN(&quot;gmlNumArgsMap1&quot;, datatype)
 			return 0;
 	}
 }
 
-EXTERN inline int gmlNumArgsMap2(GLenum type) {
-	switch(type) {
+//glMap2f
+EXTERN inline int gmlNumArgsMap2(int datatype) {
+	switch(datatype) {
 		case GL_MAP2_INDEX:
 		case GL_MAP2_TEXTURE_COORD_1:
 			return 1;
@@ -229,12 +217,12 @@
 		case GL_MAP2_TEXTURE_COORD_4:
 			return 4;
 		default:
+			GML_DEBUG_FUN(&quot;gmlNumArgsMap2&quot;, datatype)
 			return 0;
 	}
 }
 
 EXTERN inline int gmlSizeOf(int datatype) {
-//	FILE *f;
 	switch(datatype) {
 		case GL_UNSIGNED_BYTE:
 			return sizeof(GLubyte);
@@ -255,7 +243,7 @@
 		case GL_DOUBLE:
 			return sizeof(GLdouble);
 		default:
-//			GML_NERROR_FUN(&quot;gmlSizeOf&quot;, datatype)
+			GML_DEBUG_FUN(&quot;gmlSizeOf&quot;, datatype)
 			return 0;
 	}
 }
@@ -721,7 +709,6 @@
 	ftypeX *e=&amp;(p-&gt;F);\
 	ftype6 *v=F;\
 	GML_STDCOPY1(ftype6,count,stride,nargs)\
-/*	memcpy(&amp;(p-&gt;D),D,size+sizeof(ftypeX));*/\
 	GML_UPD_POS()\
 }
 
@@ -749,13 +736,12 @@
 	GML_COND(gl##name(A,B,C,D,E,F,G,H,I,J))\
 	int nargs=numargs;\
 	GML_PREP_VAR_SIZE(name,(nargs*count1*count2-1)*sizeof(ftypeX))\
-	GML_MAKEASS_E()\
+	GML_MAKEASS_I()\
 	p-&gt;stride1=nargs*count2;\
 	p-&gt;stride2=nargs;\
 	ftypeX *e=&amp;(p-&gt;J);\
 	ftype10 *v=J;\
 	GML_STDCOPY2(ftype10,count1,stride1,count2,stride2,nargs)\
-/*	memcpy(&amp;(p-&gt;D),D,size+sizeof(ftypeX));*/\
 	GML_UPD_POS()\
 }
 
@@ -887,28 +873,24 @@
 
 #define GML_MEMCOPY()\
 	for(int i=0; i&lt;C; ++i) {\
-/*		BYTE *e2=e;*/\
 		BYTE *v2=v;\
 		for(int j=0; j&lt;itemsize; ++j) {\
-			*e/*2*/=*v2;\
-			++e/*2*/;\
+			*e=*v2;\
+			++e;\
 			++v2;\
 		}\
-/*		e+=itemsize;*/\
 		v+=itemstride;\
 	}
 
 #define GML_IDXLOOP(ltype)\
 	for(int i=0; i&lt;B; ++i) {\
-/*		BYTE *e2=e;*/\
 		BYTE *v2=v+(*(ltype *)dt)*itemstride;\
 		dt+=sizeof(ltype);\
 		for(int j=0; j&lt;itemsize; ++j) {\
-			*e/*2*/=*v2;\
-			++e/*2*/;\
+			*e=*v2;\
+			++e;\
 			++v2;\
 		}\
-/*		e+=itemsize;*/\
 	}
 
 #define GML_IDXCOPY()\
@@ -974,7 +956,6 @@
 	std::set&lt;GLuint&gt;::iterator si=qd-&gt;VAset.begin();\
 	while(si!=qd-&gt;VAset.end()) {\
 		std::map&lt;GLuint,VAdata&gt;::iterator mi=qd-&gt;VAmap.find(*si);\
-\
 		VAdata *vd=&amp;(mi-&gt;second);\
 		int itemstride=vd-&gt;stride;\
  		int itemsize=vd-&gt;size*gmlSizeOf(vd-&gt;type);\
@@ -986,7 +967,6 @@
 		datasize+=totalsize;\
 		while(qd-&gt;WritePos+datasize&gt;=qd-&gt;WriteSize)\
 			p=(gml##name##Data *)qd-&gt;WaitRealloc(&amp;e);\
-\
 		VAstruct *vs=(VAstruct *)e;\
 		e+=sizeof(VAstruct);\
 		vs-&gt;target=*si;\
@@ -996,12 +976,10 @@
 		vs-&gt;totalsize=totalsize;\
 		vs-&gt;pointer=(GLvoid *)((BYTE *)vd-&gt;pointer+first*itemstride);\
 		vs-&gt;buffer=vd-&gt;buffer;\
-\
 		if(!vd-&gt;buffer) {\
 			BYTE *v=(BYTE *)vs-&gt;pointer;\
 			copyfun\
 		}\
-\
 		++si;\
 	}
 

Copied: branches/0.77-branch/tools/ArchiveMoverLinux (from rev 6333, trunk/tools/ArchiveMoverLinux)

Deleted: branches/0.77-branch/tools/ArchiveMoverLinux/Makefile
===================================================================
--- trunk/tools/ArchiveMoverLinux/Makefile	2008-08-29 14:11:33 UTC (rev 6333)
+++ branches/0.77-branch/tools/ArchiveMoverLinux/Makefile	2008-08-31 20:52:43 UTC (rev 6344)
@@ -1,14 +0,0 @@
-ML_SOURCES = mover.ml
-ML_SEARCH = -I +lablgtk2  -I +zip -I +extlib
-ML_LIBS = lablgtk.cmxa gtkInit.cmx unix.cmxa zip.cmxa extLib.cmxa
-
-all: mover
-
-mover: $(ML_SOURCES)
-	ocamlopt -o mover $(ML_SEARCH) $(ML_LIBS) $(ML_SOURCES)
-
-clean:
-	rm -f *.cmi  *.cmo  *.cmx  *.o mover
-
-
-.PHONY: all clean

Copied: branches/0.77-branch/tools/ArchiveMoverLinux/Makefile (from rev 6333, trunk/tools/ArchiveMoverLinux/Makefile)
===================================================================
--- branches/0.77-branch/tools/ArchiveMoverLinux/Makefile	                        (rev 0)
+++ branches/0.77-branch/tools/ArchiveMoverLinux/Makefile	2008-08-31 20:52:43 UTC (rev 6344)
@@ -0,0 +1,14 @@
+ML_SOURCES = mover.ml
+ML_SEARCH = -I +lablgtk2  -I +zip -I +extlib
+ML_LIBS = lablgtk.cmxa gtkInit.cmx unix.cmxa zip.cmxa extLib.cmxa
+
+all: mover
+
+mover: $(ML_SOURCES)
+	ocamlopt -o mover $(ML_SEARCH) $(ML_LIBS) $(ML_SOURCES)
+
+clean:
+	rm -f *.cmi  *.cmo  *.cmx  *.o mover
+
+
+.PHONY: all clean

Deleted: branches/0.77-branch/tools/ArchiveMoverLinux/mover.ml
===================================================================
--- trunk/tools/ArchiveMoverLinux/mover.ml	2008-08-29 14:11:33 UTC (rev 6333)
+++ branches/0.77-branch/tools/ArchiveMoverLinux/mover.ml	2008-08-31 20:52:43 UTC (rev 6344)
@@ -1,199 +0,0 @@
-open ExtString
-
-module Config = struct
-  let detect_spring_dir () = Filename.concat (Unix.getenv &quot;HOME&quot;) &quot;.spring&quot;
-end
-
-module Archive = struct
-  type t = Mod | Map | Unknown
-
-  let from_int int =
-    match int with
-        0 -&gt; Map
-      | 1 -&gt; Mod
-      | _ -&gt; Unknown
-
-  let to_int t =
-    match t with
-        Map -&gt; 0
-      | Mod -&gt; 1
-      | Unknown -&gt; -1
-
-  let from_zip path =
-    let in_zip = Zip.open_in path in
-    let entries = Zip.entries in_zip in
-    let has_file filename =
-      let lower = String.lowercase filename in
-        List.exists (fun entry -&gt; entry.Zip.filename = lower) entries
-    in
-      Zip.close_in in_zip;
-      if has_file &quot;maps&quot; then Map
-      else if has_file &quot;modinfo.tdf&quot; then Mod
-      else if has_file &quot;modinfo.lua&quot; then Mod
-      else Unknown
-
-  let from_path path  =
-    if String.ends_with path &quot;.sdz&quot; then
-      from_zip path
-    else if String.ends_with path &quot;.sd7&quot; then
-      Unknown
-    else
-      Unknown
-end
-
-module FileSystem = struct
-  let copy src dst =
-    let string = String.create 4096 in
-    let in_chan = open_in_bin src in
-    let out_chan = open_out_bin dst in
-      
-    let rec f () =
-      let n = input in_chan string 0 (String.length string) in
-        if n = 0 then
-          ()
-        else
-          begin
-            output out_chan string 0 n;
-            f ()
-          end in
-      
-      f ();
-      close_in in_chan;
-      close_out out_chan
-        
-  let move src dst =
-    try
-      Unix.rename src dst
-    with Unix.Unix_error (Unix.EXDEV, _, _) -&gt;
-      copy src dst;
-      Unix.unlink src
-end
-
-
-module GUI = struct
-  let install path dest =
-    print_endline dest;
-    let message = Printf.sprintf &quot;%s was successfully installed&quot; dest in
-      FileSystem.move path dest;
-      GToolbox.message_box ~title:&quot;Success&quot; ~ok:&quot;Exit&quot; message;
-      exit 0
-        
-  let install_archive path combo_box springdir_entry basename_entry =
-    let int = combo_box#active in
-    let archive = Archive.from_int int in
-    let springdir = springdir_entry#text in
-    let basename = basename_entry#text in
-    let make dir = Filename.concat (Filename.concat springdir dir) basename in
-      match archive with
-          Archive.Mod -&gt; install path (make &quot;mods&quot;)
-        | Archive.Map -&gt; install path (make &quot;maps&quot;)
-        | Archive.Unknown -&gt;
-            GToolbox.message_box
-              ~title:&quot;Error&quot;
-              &quot;Please select an archive type from the drop down list&quot;
-              
-  let detect_spring_dir springdir_entry =
-    let spring_dir = Config.detect_spring_dir () in
-      springdir_entry#set_text spring_dir
-        
-  let detect_basename path basename_entry =
-    let basename = Filename.basename path in
-      basename_entry#set_text basename
-        
-  let detect_archive_type path combo_box =
-    let archive = Archive.from_path path in
-      combo_box#set_active (Archive.to_int archive)
-
-  let detect_all path combo_box springdir_entry basename_entry =
-    detect_spring_dir springdir_entry;
-    detect_basename path basename_entry;
-    detect_archive_type path combo_box
-        
-  let main path =
-    let window = GWindow.window
-      ~title:&quot;ArchiveMover&quot;
-      ~width:512
-      ~height:192
-      ~position:`CENTER
-      ~type_hint:`DIALOG
-      () in
-      
-    let vbox = GPack.vbox
-      ~packing:window#add
-      () in
-
-    let table = GPack.table
-      ~col_spacings:5
-      ~packing:vbox#add
-      () in
-
-    let _ = GMisc.label
-      ~text:&quot;Spring directory&quot;
-      ~packing:(table#attach ~left:0 ~top:0)
-      () in
-
-    let springdir_entry = GEdit.entry
-      ~packing:(table#attach ~left:1 ~top:0 ~expand:`X)
-      () in
-      
-    let _ = GMisc.label
-      ~text:&quot;Filename&quot;
-      ~packing:(table#attach ~left:0 ~top:1)
-      () in
-
-    let basename_entry = GEdit.entry
-      ~packing:(table#attach ~left:1 ~top:1 ~expand:`X)
-      () in
-      
-    let _ = GMisc.label
-      ~text:&quot;Archive type&quot;
-      ~packing:(table#attach ~left:0 ~top:2)
-      () in
-
-    let (combo_box, _) = GEdit.combo_box_text
-      ~strings:[&quot;Map&quot;; &quot;Mod&quot;]
-      ~packing:(table#attach ~left:1 ~top:2 ~expand:`X)
-      () in
-      
-    let button_box = GPack.button_box `HORIZONTAL
-      ~packing:(vbox#pack ~fill:false ~expand:false)
-      () in
-      
-    let exit_button = GButton.button
-      ~label:&quot;Exit&quot;
-      ~packing:button_box#pack
-      () in
-    
-    let detect_button = GButton.button
-      ~label:&quot;Auto-detect&quot;
-      ~packing:button_box#pack
-      () in
-
-    let install_button = GButton.button
-      ~label:&quot;Install&quot;
-      ~packing:button_box#pack
-      () in
-
-    let destroy () = GMain.Main.quit () in
-    let install () = install_archive path combo_box springdir_entry basename_entry in
-    let detect () = detect_all path combo_box springdir_entry basename_entry in
-    let _ = window#connect#destroy ~callback:destroy in
-    let _ = exit_button#connect#clicked ~callback:destroy in
-    let _ = detect_button#connect#clicked ~callback:detect in
-    let _ = install_button#connect#clicked ~callback:install in
-      window#show ();
-      detect ();
-      GtkMain.Main.main ()
-end
-
-let usage () =
-  ()
-
-let main () =
-  if Array.length (Sys.argv) != 2 then
-    (usage ();
-     exit 1)
-  else
-    GUI.main Sys.argv.(1)
-      
-let _ = main ()

Copied: branches/0.77-branch/tools/ArchiveMoverLinux/mover.ml (from rev 6333, trunk/tools/ArchiveMoverLinux/mover.ml)
===================================================================
--- branches/0.77-branch/tools/ArchiveMoverLinux/mover.ml	                        (rev 0)
+++ branches/0.77-branch/tools/ArchiveMoverLinux/mover.ml	2008-08-31 20:52:43 UTC (rev 6344)
@@ -0,0 +1,283 @@
+open ExtString
+
+module Archive = struct
+  type t = Mod | Map | Unknown
+
+  let from_int int =
+    match int with
+        0 -&gt; Map
+      | 1 -&gt; Mod
+      | _ -&gt; Unknown
+
+  let to_int t =
+    match t with
+        Map -&gt; 0
+      | Mod -&gt; 1
+      | Unknown -&gt; -1
+
+  let from_zip path =
+    try
+      let in_zip = Zip.open_in path in
+      let entries = Zip.entries in_zip in
+      let test_files func =
+        let test entry = func (String.lowercase entry.Zip.filename) in
+          List.exists test entries
+      in
+      let is_map path =
+        let dirname = Filename.dirname path in
+        let basename = Filename.basename path in
+          if dirname = &quot;maps&quot; then
+            if String.ends_with basename &quot;.smf&quot; then
+              true
+            else if String.ends_with basename &quot;.sm3&quot; then
+              true
+            else
+              false
+          else
+            false
+      in
+        Zip.close_in in_zip;
+        if test_files is_map then Map
+        else if test_files (fun filename -&gt; filename = &quot;modinfo.tdf&quot;) then Mod
+        else if test_files (fun filename -&gt; filename = &quot;modinfo.lua&quot;) then Mod
+        else Unknown
+    with Zip.Error _ -&gt; Unknown
+
+  let from_path path  =
+    if String.ends_with path &quot;.sdz&quot; then
+      from_zip path
+    else if String.ends_with path &quot;.sd7&quot; then
+      Unknown
+    else
+      Unknown
+end
+
+module FileSystem = struct
+  let copy src dst =
+    let string = String.create 4096 in
+    let in_chan = open_in_bin src in
+    let out_chan = open_out_bin dst in
+      
+    let rec f () =
+      let n = input in_chan string 0 (String.length string) in
+        if n = 0 then
+          ()
+        else
+          begin
+            output out_chan string 0 n;
+            f ()
+          end in
+      
+      f ();
+      close_in in_chan;
+      close_out out_chan
+        
+  let move src dst =
+    if src != dst then
+      try
+        Sys.rename src dst
+      with Sys_error _ -&gt;
+        copy src dst;
+        Sys.remove src
+    else
+      ()
+end
+
+
+module GUI = struct
+  exception InvalidOption of string
+
+  let install path dest =
+    try
+      let message = Printf.sprintf &quot;%s was successfully installed&quot; dest in
+        FileSystem.move path dest;
+        GToolbox.message_box ~title:&quot;Success&quot; ~ok:&quot;Exit&quot; message
+    with Sys_error (error_string) -&gt;
+      let message = Printf.sprintf &quot;Error: %s&quot; error_string in
+        GToolbox.message_box ~title:&quot;Error&quot; ~ok:&quot;Exit&quot; message
+              
+  let get_archive_dir combo_box =
+    let int = combo_box#active in
+    let archive = Archive.from_int int in
+      match archive with
+          Archive.Mod -&gt; &quot;mods&quot;
+        | Archive.Map -&gt; &quot;maps&quot;
+        | Archive.Unknown -&gt; raise (InvalidOption &quot;Please select an archive type&quot;)
+
+  let get_springdir springdir_entry archive_dir =
+      let springdir = springdir_entry#text in
+      let datadir = Filename.concat springdir archive_dir in
+        if Sys.file_exists datadir then
+          if Sys.is_directory datadir then
+            datadir
+          else
+            raise (InvalidOption (Printf.sprintf &quot;%s isn't a directory&quot; datadir))
+        else
+          raise (InvalidOption (Printf.sprintf &quot;Install directory %s doesn't exist&quot; datadir))
+
+  let get_basename_dir basename_entry =
+    let basename = basename_entry#text in
+      if basename = &quot;&quot; then
+        raise (InvalidOption &quot;Please enter a filename&quot;)
+      else
+        basename
+
+  let install_archive path combo_box springdir_entry basename_entry =
+    try
+      let archive_dir = get_archive_dir combo_box in
+      let datadir = get_springdir springdir_entry archive_dir in
+      let basename = get_basename_dir basename_entry in
+      let dest = (Filename.concat datadir basename) in
+        install path dest;
+        GMain.Main.quit ()
+    with InvalidOption message -&gt; GToolbox.message_box ~title:&quot;Error&quot; message
+              
+  let detect_home_dir () =
+    try
+      let home_dir = Sys.getenv &quot;HOME&quot; in
+        Some home_dir
+    with Not_found -&gt; None
+
+  let detect_springrc home_dir =
+    try
+      let springrc = Filename.concat home_dir &quot;.springrc&quot; in
+      let in_file = open_in springrc in
+      let input = IO.input_channel in_file in
+      let rec loop option =
+        try 
+          let line = IO.read_line input in
+            try
+              let (key, value) = String.split line &quot;=&quot; in
+                if key = &quot;SpringData&quot; then
+                  loop (Some value)
+                else
+                  loop option
+            with Invalid_string -&gt; loop option
+        with IO.No_more_input -&gt; option in
+      let option = loop None in
+        close_in in_file;
+        option
+    with Sys_error _ -&gt; None
+
+  let detect_datadir home_dir =
+    try
+      let in_file = open_in &quot;/etc/spring/datadir&quot; in
+      let input = IO.input_channel in_file in
+      let format = IO.read_line input in
+      let (_, dir) = String.replace format &quot;$HOME&quot; home_dir in
+        close_in in_file;
+        Some dir
+    with Sys_error _ -&gt; None
+
+  let detect_spring_dir springdir_entry =
+    let dir = 
+      match detect_home_dir () with
+          Some home_dir -&gt;
+            (match detect_springrc home_dir with
+                Some springdir -&gt; springdir
+              | None -&gt;
+                  (match detect_datadir home_dir with
+                       Some springdir -&gt; springdir
+                     | None -&gt; Filename.concat home_dir &quot;.spring&quot;))
+        | None -&gt; &quot;&quot; in
+      springdir_entry#set_text dir
+        
+  let detect_basename path basename_entry =
+    let basename = Filename.basename path in
+      basename_entry#set_text basename
+        
+  let detect_archive_type path combo_box =
+    let archive = Archive.from_path path in
+      combo_box#set_active (Archive.to_int archive)
+
+  let detect_all path combo_box springdir_entry basename_entry =
+    detect_spring_dir springdir_entry;
+    detect_basename path basename_entry;
+    detect_archive_type path combo_box
+        
+  let main path =
+    let window = GWindow.window
+      ~title:&quot;ArchiveMover&quot;
+      ~width:512
+      ~height:192
+      ~position:`CENTER
+      () in
+      
+    let vbox = GPack.vbox
+      ~packing:window#add
+      () in
+
+    let table = GPack.table
+      ~col_spacings:5
+      ~packing:vbox#add
+      () in
+
+    let _ = GMisc.label
+      ~text:&quot;Spring directory&quot;
+      ~packing:(table#attach ~left:0 ~top:0)
+      () in
+
+    let springdir_entry = GEdit.entry
+      ~packing:(table#attach ~left:1 ~top:0 ~expand:`X)
+      () in
+      
+    let _ = GMisc.label
+      ~text:&quot;Filename&quot;
+      ~packing:(table#attach ~left:0 ~top:1)
+      () in
+
+    let basename_entry = GEdit.entry
+      ~packing:(table#attach ~left:1 ~top:1 ~expand:`X)
+      () in
+      
+    let _ = GMisc.label
+      ~text:&quot;Archive type&quot;
+      ~packing:(table#attach ~left:0 ~top:2)
+      () in
+
+    let (combo_box, _) = GEdit.combo_box_text
+      ~strings:[&quot;Map&quot;; &quot;Mod&quot;]
+      ~packing:(table#attach ~left:1 ~top:2 ~expand:`X)
+      () in
+      
+    let button_box = GPack.button_box `HORIZONTAL
+      ~packing:(vbox#pack ~fill:false ~expand:false)
+      () in
+      
+    let exit_button = GButton.button
+      ~label:&quot;Exit&quot;
+      ~packing:button_box#pack
+      () in
+    
+    let detect_button = GButton.button
+      ~label:&quot;Defaults&quot;
+      ~packing:button_box#pack
+      () in
+
+    let install_button = GButton.button
+      ~label:&quot;Install&quot;
+      ~packing:button_box#pack
+      () in
+
+    let install () = install_archive path combo_box springdir_entry basename_entry in
+    let detect () = detect_all path combo_box springdir_entry basename_entry in
+    let _ = window#connect#destroy ~callback:GMain.Main.quit in
+    let _ = exit_button#connect#clicked ~callback:GMain.Main.quit in
+    let _ = detect_button#connect#clicked ~callback:detect in
+    let _ = install_button#connect#clicked ~callback:install in
+      window#show ();
+      detect ();
+      GtkMain.Main.main ()
+end
+
+let usage () =
+  Printf.printf &quot;Usage: %s &lt;/path/to/archive.sdz&gt;\n&quot; Sys.argv.(0)
+
+let main () =
+  if Array.length (Sys.argv) != 2 then
+    (usage ();
+     exit 1)
+  else
+    GUI.main Sys.argv.(1)
+      
+let _ = main ()

Modified: branches/0.77-branch/tools/DemoAnalyser/CMakeLists.txt
===================================================================
--- branches/0.77-branch/tools/DemoAnalyser/CMakeLists.txt	2008-08-31 12:07:07 UTC (rev 6343)
+++ branches/0.77-branch/tools/DemoAnalyser/CMakeLists.txt	2008-08-31 20:52:43 UTC (rev 6344)
@@ -4,9 +4,9 @@
 INCLUDE_DIRECTORIES(../../rts/ ../../rts/Game ../../rts/lib/7zip ../../rts/lib/lua/include ../../rts/System)
 
 IF (UNIX)
-	SET(platformfiles ../../rts/System/Platform/Linux/UnixFileSystemHandler ../../rts/System/Platform/Linux/DotfileHandler ../../rts/System/Platform/Linux/DataDirLocater)
+	SET(platformfiles ${CMAKE_SOURCE_DIR}/rts/System/Platform/Linux/UnixFileSystemHandler ${CMAKE_SOURCE_DIR}/rts/System/Platform/Linux/DotfileHandler ${CMAKE_SOURCE_DIR}/rts/System/Platform/Linux/DataDirLocater)
 ELSE (UNIX)
-	SET(platformfiles ../../rts/System/Platform/Windows/WinFileSystemHandler ../../rts/System/Platform/Windows/RegHandler)
+	SET(platformfiles ${CMAKE_SOURCE_DIR}/rts/System/Platform/Win/WinFileSystemHandler ${CMAKE_SOURCE_DIR}/rts/System/Platform/Win/DataDirLocater ${CMAKE_SOURCE_DIR}/rts/System/Platform/Win/RegHandler)
 ENDIF (UNIX)
 
 AUX_SOURCE_DIRECTORY(../../rts/System/FileSystem/ fsfiles)

Modified: branches/0.77-branch/tools/unitsync/CMakeLists.txt
===================================================================
--- branches/0.77-branch/tools/unitsync/CMakeLists.txt	2008-08-31 12:07:07 UTC (rev 6343)
+++ branches/0.77-branch/tools/unitsync/CMakeLists.txt	2008-08-31 20:52:43 UTC (rev 6344)
@@ -1,5 +1,7 @@
 IF (MINGW)
 	set (unitsync_libs glew32 opengl32 glu32 devil ilu)
+	set (PYTHONLIBS_FOUND TRUE) # Python libs are part of the mingwlibs package
+	set (JNI_FOUND TRUE)
 ELSE (MINGW)
 	FIND_PACKAGE(SDL REQUIRED)
 	INCLUDE_DIRECTORIES(${SDL_INCLUDE_DIR})
@@ -16,6 +18,14 @@
 		message (&quot;No python libraries found, python bindings disabled&quot;)
 	endif (PYTHONLIBS_FOUND)
 	
+	FIND_PACKAGE(JNI)
+	if (JAVA_INCLUDE_PATH)
+		include_directories(${JAVA_INCLUDE_PATH} ${JNI_INCLUDE_DIRS})
+		set (JAVA_FOUND TRUE)
+	else (JAVA_INCLUDE_PATH)
+		message (&quot;No Java includes found, java bindings disabled&quot;)
+	endif (JAVA_INCLUDE_PATH)
+	
 	set (unitsync_libs ${GLEW_LIBRARIES} IL openal GL GLU)
 ENDIF (MINGW)
 
@@ -54,7 +64,9 @@
 if (PYTHONLIBS_FOUND)
 	list(APPEND unitsync_files pybind)
 endif (PYTHONLIBS_FOUND)
-
+if (JAVA_FOUND)
+	list(APPEND unitsync_files javabind)
+endif (JAVA_FOUND)
 ADD_LIBRARY(unitsync SHARED ${platformfiles} ${unitsync_files} ${fsfiles} unitsync LuaParserAPI Syncer SyncServer stdafx)
 TARGET_LINK_LIBRARIES(unitsync ${unitsync_libs} hpiutil2 7zip minizip lua boost_regex-mt ILU SDL)
 if (PYTHONLIBS_FOUND)


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001113.html">[Taspring-linux-commit] r6343 - trunk/rts/Lua
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1114">[ date ]</a>
              <a href="thread.html#1114">[ thread ]</a>
              <a href="subject.html#1114">[ subject ]</a>
              <a href="author.html#1114">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
