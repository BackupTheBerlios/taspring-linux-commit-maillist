<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r6278 - in branches/0.77-branch:	Lobby/TASClient Lobby/TASClient/Python	Lobby/TASClient/Python/engine Lobby/TASClient/Python/scripts	installer installer/builddata/bitmaps/bitmaps	installer/builddata/springcontent/shaders rts/Game	rts/Game/UI rts/Lua rts/Map rts/Map/SM3 rts/Map/SM3/terrain	rts/Map/SMF rts/Rendering rts/Rendering/Env rts/Rendering/GL	rts/Rendering/UnitModels rts/Sim/Features rts/Sim/Misc	rts/Sim/MoveTypes rts/Sim/MoveTypes/MoveMath rts/Sim/Objects	rts/Sim/Projectiles rts/Sim/Units rts/Sim/Units/CommandAI	rts/Sim/Units/UnitTypes rts/System rts/System/Script	rts/build/vstudio8 rts/lib/hpiutil2 tools/DedicatedServer
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-August/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6278%20-%20in%20branches/0.77-branch%3A%0A%09Lobby/TASClient%20Lobby/TASClient/Python%0A%09Lobby/TASClient/Python/engine%20Lobby/TASClient/Python/scripts%0A%09installer%20installer/builddata/bitmaps/bitmaps%0A%09installer/builddata/springcontent/shaders%20rts/Game%0A%09rts/Game/UI%20rts/Lua%20rts/Map%20rts/Map/SM3%20rts/Map/SM3/terrain%0A%09rts/Map/SMF%20rts/Rendering%20rts/Rendering/Env%20rts/Rendering/GL%0A%09rts/Rendering/UnitModels%20rts/Sim/Features%20rts/Sim/Misc%0A%09rts/Sim/MoveTypes%20rts/Sim/MoveTypes/MoveMath%20rts/Sim/Objects%0A%09rts/Sim/Projectiles%20rts/Sim/Units%20rts/Sim/Units/CommandAI%0A%09rts/Sim/Units/UnitTypes%20rts/System%20rts/System/Script%0A%09rts/build/vstudio8%20rts/lib/hpiutil2%20tools/DedicatedServer&In-Reply-To=%3C20080820143813.1A1B1498E%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001047.html">
   <LINK REL="Next"  HREF="001049.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r6278 - in branches/0.77-branch:	Lobby/TASClient Lobby/TASClient/Python	Lobby/TASClient/Python/engine Lobby/TASClient/Python/scripts	installer installer/builddata/bitmaps/bitmaps	installer/builddata/springcontent/shaders rts/Game	rts/Game/UI rts/Lua rts/Map rts/Map/SM3 rts/Map/SM3/terrain	rts/Map/SMF rts/Rendering rts/Rendering/Env rts/Rendering/GL	rts/Rendering/UnitModels rts/Sim/Features rts/Sim/Misc	rts/Sim/MoveTypes rts/Sim/MoveTypes/MoveMath rts/Sim/Objects	rts/Sim/Projectiles rts/Sim/Units rts/Sim/Units/CommandAI	rts/Sim/Units/UnitTypes rts/System rts/System/Script	rts/build/vstudio8 rts/lib/hpiutil2 tools/DedicatedServer</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6278%20-%20in%20branches/0.77-branch%3A%0A%09Lobby/TASClient%20Lobby/TASClient/Python%0A%09Lobby/TASClient/Python/engine%20Lobby/TASClient/Python/scripts%0A%09installer%20installer/builddata/bitmaps/bitmaps%0A%09installer/builddata/springcontent/shaders%20rts/Game%0A%09rts/Game/UI%20rts/Lua%20rts/Map%20rts/Map/SM3%20rts/Map/SM3/terrain%0A%09rts/Map/SMF%20rts/Rendering%20rts/Rendering/Env%20rts/Rendering/GL%0A%09rts/Rendering/UnitModels%20rts/Sim/Features%20rts/Sim/Misc%0A%09rts/Sim/MoveTypes%20rts/Sim/MoveTypes/MoveMath%20rts/Sim/Objects%0A%09rts/Sim/Projectiles%20rts/Sim/Units%20rts/Sim/Units/CommandAI%0A%09rts/Sim/Units/UnitTypes%20rts/System%20rts/System/Script%0A%09rts/build/vstudio8%20rts/lib/hpiutil2%20tools/DedicatedServer&In-Reply-To=%3C20080820143813.1A1B1498E%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r6278 - in branches/0.77-branch:	Lobby/TASClient Lobby/TASClient/Python	Lobby/TASClient/Python/engine Lobby/TASClient/Python/scripts	installer installer/builddata/bitmaps/bitmaps	installer/builddata/springcontent/shaders rts/Game	rts/Game/UI rts/Lua rts/Map rts/Map/SM3 rts/Map/SM3/terrain	rts/Map/SMF rts/Rendering rts/Rendering/Env rts/Rendering/GL	rts/Rendering/UnitModels rts/Sim/Features rts/Sim/Misc	rts/Sim/MoveTypes rts/Sim/MoveTypes/MoveMath rts/Sim/Objects	rts/Sim/Projectiles rts/Sim/Units rts/Sim/Units/CommandAI	rts/Sim/Units/UnitTypes rts/System rts/System/Script	rts/build/vstudio8 rts/lib/hpiutil2 tools/DedicatedServer">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Wed Aug 20 16:38:12 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001047.html">[Taspring-linux-commit] r6277 - trunk/Lobby/TASClient
</A></li>
        <LI>Next message: <A HREF="001049.html">[Taspring-linux-commit] r6279 - branches/0.77-branch/rts/Game
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1048">[ date ]</a>
              <a href="thread.html#1048">[ thread ]</a>
              <a href="subject.html#1048">[ subject ]</a>
              <a href="author.html#1048">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: Auswaschbar
Date: 2008-08-20 16:38:09 +0200 (Wed, 20 Aug 2008)
New Revision: 6278

Modified:
   branches/0.77-branch/Lobby/TASClient/! readme !.txt
   branches/0.77-branch/Lobby/TASClient/AgreementUnit.dfm
   branches/0.77-branch/Lobby/TASClient/AgreementUnit.pas
   branches/0.77-branch/Lobby/TASClient/BattleFormUnit.dfm
   branches/0.77-branch/Lobby/TASClient/BattleFormUnit.pas
   branches/0.77-branch/Lobby/TASClient/ColorPicker.pas
   branches/0.77-branch/Lobby/TASClient/HostBattleFormUnit.pas
   branches/0.77-branch/Lobby/TASClient/LobbyScriptUnit.pas
   branches/0.77-branch/Lobby/TASClient/MainUnit.dfm
   branches/0.77-branch/Lobby/TASClient/MainUnit.pas
   branches/0.77-branch/Lobby/TASClient/ManageGroups.dfm
   branches/0.77-branch/Lobby/TASClient/ManageGroups.pas
   branches/0.77-branch/Lobby/TASClient/MenuFormUnit.dfm
   branches/0.77-branch/Lobby/TASClient/MenuFormUnit.pas
   branches/0.77-branch/Lobby/TASClient/Misc.pas
   branches/0.77-branch/Lobby/TASClient/NotificationsUnit.pas
   branches/0.77-branch/Lobby/TASClient/PreferencesFormUnit.dfm
   branches/0.77-branch/Lobby/TASClient/PreferencesFormUnit.pas
   branches/0.77-branch/Lobby/TASClient/Python/api.txt
   branches/0.77-branch/Lobby/TASClient/Python/engine/handlers.py
   branches/0.77-branch/Lobby/TASClient/Python/scripts/stick.py
   branches/0.77-branch/Lobby/TASClient/PythonScriptDebugFormUnit.pas
   branches/0.77-branch/Lobby/TASClient/ReplaysUnit.dfm
   branches/0.77-branch/Lobby/TASClient/ReplaysUnit.pas
   branches/0.77-branch/Lobby/TASClient/TASClient.dof
   branches/0.77-branch/Lobby/TASClient/TASClient.dpr
   branches/0.77-branch/Lobby/TASClient/TASClient.res
   branches/0.77-branch/Lobby/TASClient/UploadReplayUnit.dfm
   branches/0.77-branch/Lobby/TASClient/UploadReplayUnit.pas
   branches/0.77-branch/Lobby/TASClient/Utility.pas
   branches/0.77-branch/installer/builddata/bitmaps/bitmaps/waterbump.png
   branches/0.77-branch/installer/builddata/springcontent/shaders/bumpWaterCoastBlurFS.glsl
   branches/0.77-branch/installer/builddata/springcontent/shaders/bumpWaterFS.glsl
   branches/0.77-branch/installer/builddata/springcontent/shaders/bumpWaterVS.glsl
   branches/0.77-branch/installer/springsettings.nsh
   branches/0.77-branch/rts/Game/CameraHandler.cpp
   branches/0.77-branch/rts/Game/Game.cpp
   branches/0.77-branch/rts/Game/GameServer.cpp
   branches/0.77-branch/rts/Game/GameServer.h
   branches/0.77-branch/rts/Game/GameSetup.cpp
   branches/0.77-branch/rts/Game/GameSetup.h
   branches/0.77-branch/rts/Game/GameVersion.cpp
   branches/0.77-branch/rts/Game/Player.cpp
   branches/0.77-branch/rts/Game/Player.h
   branches/0.77-branch/rts/Game/PlayerRoster.cpp
   branches/0.77-branch/rts/Game/SelectedUnits.cpp
   branches/0.77-branch/rts/Game/Team.cpp
   branches/0.77-branch/rts/Game/UI/EndGameBox.cpp
   branches/0.77-branch/rts/Game/UI/GameSetupDrawer.cpp
   branches/0.77-branch/rts/Game/UI/QuitBox.cpp
   branches/0.77-branch/rts/Game/UI/ShareBox.cpp
   branches/0.77-branch/rts/Game/UI/TooltipConsole.cpp
   branches/0.77-branch/rts/Lua/LuaIO.cpp
   branches/0.77-branch/rts/Lua/LuaSyncedCtrl.cpp
   branches/0.77-branch/rts/Lua/LuaSyncedRead.cpp
   branches/0.77-branch/rts/Lua/LuaUnsyncedCtrl.cpp
   branches/0.77-branch/rts/Lua/LuaUnsyncedRead.cpp
   branches/0.77-branch/rts/Map/BaseGroundDrawer.cpp
   branches/0.77-branch/rts/Map/BaseGroundDrawer.h
   branches/0.77-branch/rts/Map/BasicMapDamage.cpp
   branches/0.77-branch/rts/Map/BasicMapDamage.h
   branches/0.77-branch/rts/Map/Ground.cpp
   branches/0.77-branch/rts/Map/MapInfo.cpp
   branches/0.77-branch/rts/Map/MapInfo.h
   branches/0.77-branch/rts/Map/ReadMap.cpp
   branches/0.77-branch/rts/Map/ReadMap.h
   branches/0.77-branch/rts/Map/SM3/Sm3GroundDrawer.cpp
   branches/0.77-branch/rts/Map/SM3/Sm3Map.cpp
   branches/0.77-branch/rts/Map/SM3/Sm3Map.h
   branches/0.77-branch/rts/Map/SM3/terrain/Terrain.cpp
   branches/0.77-branch/rts/Map/SMF/BFGroundDrawer.cpp
   branches/0.77-branch/rts/Map/SMF/BFGroundDrawer.h
   branches/0.77-branch/rts/Map/SMF/SmfReadMap.h
   branches/0.77-branch/rts/Rendering/Env/AdvWater.cpp
   branches/0.77-branch/rts/Rendering/Env/BaseWater.h
   branches/0.77-branch/rts/Rendering/Env/BasicWater.cpp
   branches/0.77-branch/rts/Rendering/Env/BumpWater.cpp
   branches/0.77-branch/rts/Rendering/Env/BumpWater.h
   branches/0.77-branch/rts/Rendering/Env/DynWater.cpp
   branches/0.77-branch/rts/Rendering/Env/RefractWater.cpp
   branches/0.77-branch/rts/Rendering/GL/VertexArray.h
   branches/0.77-branch/rts/Rendering/GL/myGL.cpp
   branches/0.77-branch/rts/Rendering/GroundDecalHandler.cpp
   branches/0.77-branch/rts/Rendering/InMapDraw.cpp
   branches/0.77-branch/rts/Rendering/UnitModels/3DOParser.cpp
   branches/0.77-branch/rts/Rendering/glFont.cpp
   branches/0.77-branch/rts/Sim/Features/Feature.cpp
   branches/0.77-branch/rts/Sim/Features/Feature.h
   branches/0.77-branch/rts/Sim/Misc/CollisionHandler.cpp
   branches/0.77-branch/rts/Sim/Misc/GroundBlockingObjectMap.cpp
   branches/0.77-branch/rts/Sim/Misc/GroundBlockingObjectMap.h
   branches/0.77-branch/rts/Sim/MoveTypes/GroundMoveType.cpp
   branches/0.77-branch/rts/Sim/MoveTypes/MoveMath/MoveMath.cpp
   branches/0.77-branch/rts/Sim/Objects/SolidObject.cpp
   branches/0.77-branch/rts/Sim/Objects/SolidObject.h
   branches/0.77-branch/rts/Sim/Objects/WorldObject.cpp
   branches/0.77-branch/rts/Sim/Objects/WorldObject.h
   branches/0.77-branch/rts/Sim/Projectiles/Projectile.cpp
   branches/0.77-branch/rts/Sim/Projectiles/Projectile.h
   branches/0.77-branch/rts/Sim/Projectiles/ProjectileHandler.h
   branches/0.77-branch/rts/Sim/Units/CommandAI/BuilderCAI.cpp
   branches/0.77-branch/rts/Sim/Units/CommandAI/BuilderCAI.h
   branches/0.77-branch/rts/Sim/Units/CommandAI/CommandAI.cpp
   branches/0.77-branch/rts/Sim/Units/CommandAI/CommandAI.h
   branches/0.77-branch/rts/Sim/Units/CommandAI/FactoryCAI.cpp
   branches/0.77-branch/rts/Sim/Units/CommandAI/FactoryCAI.h
   branches/0.77-branch/rts/Sim/Units/CommandAI/MobileCAI.cpp
   branches/0.77-branch/rts/Sim/Units/CommandAI/MobileCAI.h
   branches/0.77-branch/rts/Sim/Units/Unit.cpp
   branches/0.77-branch/rts/Sim/Units/Unit.h
   branches/0.77-branch/rts/Sim/Units/UnitDef.h
   branches/0.77-branch/rts/Sim/Units/UnitDefHandler.cpp
   branches/0.77-branch/rts/Sim/Units/UnitHandler.cpp
   branches/0.77-branch/rts/Sim/Units/UnitLoader.cpp
   branches/0.77-branch/rts/Sim/Units/UnitTypes/Builder.cpp
   branches/0.77-branch/rts/System/Demo.cpp
   branches/0.77-branch/rts/System/DemoReader.cpp
   branches/0.77-branch/rts/System/DemoRecorder.cpp
   branches/0.77-branch/rts/System/GlobalStuff.cpp
   branches/0.77-branch/rts/System/Script/LuaBinder.cpp
   branches/0.77-branch/rts/System/StdAfx.h
   branches/0.77-branch/rts/build/vstudio8/rts.vcproj
   branches/0.77-branch/rts/lib/hpiutil2/hpiutil.cpp
   branches/0.77-branch/tools/DedicatedServer/CMakeLists.txt
Log:
* copied trunk over this branch (its now almost identically to rev6277)
  because backporting latest patches is huge PITA and not worth the trouble


Modified: branches/0.77-branch/Lobby/TASClient/! readme !.txt
===================================================================
--- branches/0.77-branch/Lobby/TASClient/! readme !.txt	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/Lobby/TASClient/! readme !.txt	2008-08-20 14:38:09 UTC (rev 6278)
@@ -1,8 +1,8 @@
-UPDATED: 10 Apr 2008
+UPDATED: 12 Aug 2008
 
 *** In order to compile the sources, you'll have to install some free 3rd-party components: ***
 
-*** BETA : This archive should contains everything you need to compile the lobby : <A HREF="http://tasclient.it-l.eu/TASClient_SDK.7z">http://tasclient.it-l.eu/TASClient_SDK.7z</A>
+*** This archive should contains everything you need to compile the lobby : <A HREF="http://tasclient.it-l.eu/TASClient_SDK.7z">http://tasclient.it-l.eu/TASClient_SDK.7z</A>
 
 - TjanTracker (Included with these sources - just install janTracker.pas)
 - Virtual TreeView component: <A HREF="http://www.lischke-online.de/VirtualTreeview/">http://www.lischke-online.de/VirtualTreeview/</A>
@@ -11,6 +11,7 @@
 - RichEditURL (Included with these sources - just install RichEditURL.pas)
 - TExImage (Included with these sources - just install ImageEx.pas)
 - JVCL (<A HREF="http://homepages.borland.com/jedi/jvcl/">http://homepages.borland.com/jedi/jvcl/</A>) - download JVCL+JCL bundle
+- Python For Delphi (<A HREF="http://mmm-experts.com/Products.aspx?ProductID=3">http://mmm-experts.com/Products.aspx?ProductID=3</A>)
 
 Note: All components that are included with the sources are located
 in /LobbyComponents folder and are by default installed in &quot;Spring lobby&quot;

Modified: branches/0.77-branch/Lobby/TASClient/AgreementUnit.dfm
===================================================================
--- branches/0.77-branch/Lobby/TASClient/AgreementUnit.dfm	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/Lobby/TASClient/AgreementUnit.dfm	2008-08-20 14:38:09 UTC (rev 6278)
@@ -1,14 +1,14 @@
 object AgreementForm: TAgreementForm
-  Left = 472
-  Top = 303
+  Left = 901
+  Top = 302
   BorderIcons = []
   BorderStyle = bsDialog
   Caption = 'Agreement'
   ClientHeight = 451
   ClientWidth = 584
   Color = clBtnFace
-  Constraints.MaxHeight = 910
-  Constraints.MaxWidth = 1280
+  Constraints.MaxHeight = 1000
+  Constraints.MaxWidth = 1680
   Font.Charset = DEFAULT_CHARSET
   Font.Color = clWindowText
   Font.Height = -11
@@ -34,22 +34,13 @@
     Options.Maximize = False
     Options.SystemMenu = False
     TBXStyleBackground = True
-    object RichEdit1: TRichEdit
-      Left = 8
-      Top = 40
-      Width = 569
-      Height = 297
-      ReadOnly = True
-      ScrollBars = ssBoth
-      TabOrder = 1
-    end
     object RadioButton1: TSpTBXRadioButton
       Left = 16
       Top = 352
       Width = 288
       Height = 15
       Caption = 'I have read the agreement and agree to the above terms.'
-      TabOrder = 2
+      TabOrder = 1
     end
     object RadioButton2: TSpTBXRadioButton
       Left = 16
@@ -57,7 +48,7 @@
       Width = 156
       Height = 15
       Caption = 'I do not agree to these terms.'
-      TabOrder = 3
+      TabOrder = 2
       TabStop = True
       Checked = True
     end
@@ -67,7 +58,7 @@
       Width = 137
       Height = 25
       Caption = 'Continue'
-      TabOrder = 4
+      TabOrder = 3
       OnClick = Button1Click
       LinkFont.Charset = DEFAULT_CHARSET
       LinkFont.Color = clBlue
@@ -75,5 +66,99 @@
       LinkFont.Name = 'MS Sans Serif'
       LinkFont.Style = [fsUnderline]
     end
+    object RichEdit1: TExRichEdit
+      Left = 8
+      Top = 40
+      Width = 569
+      Height = 297
+      AutoURLDetect = adNone
+      CustomURLs = &lt;
+        item
+          Name = 'e-mail'
+          Color = clWindowText
+          Cursor = crDefault
+          Underline = True
+        end
+        item
+          Name = 'http'
+          Color = clWindowText
+          Cursor = crDefault
+          Underline = True
+        end
+        item
+          Name = 'file'
+          Color = clWindowText
+          Cursor = crDefault
+          Underline = True
+        end
+        item
+          Name = 'mailto'
+          Color = clWindowText
+          Cursor = crDefault
+          Underline = True
+        end
+        item
+          Name = 'ftp'
+          Color = clWindowText
+          Cursor = crDefault
+          Underline = True
+        end
+        item
+          Name = 'https'
+          Color = clWindowText
+          Cursor = crDefault
+          Underline = True
+        end
+        item
+          Name = 'gopher'
+          Color = clWindowText
+          Cursor = crDefault
+          Underline = True
+        end
+        item
+          Name = 'nntp'
+          Color = clWindowText
+          Cursor = crDefault
+          Underline = True
+        end
+        item
+          Name = 'prospero'
+          Color = clWindowText
+          Cursor = crDefault
+          Underline = True
+        end
+        item
+          Name = 'telnet'
+          Color = clWindowText
+          Cursor = crDefault
+          Underline = True
+        end
+        item
+          Name = 'news'
+          Color = clWindowText
+          Cursor = crDefault
+          Underline = True
+        end
+        item
+          Name = 'wais'
+          Color = clWindowText
+          Cursor = crDefault
+          Underline = True
+        end&gt;
+      LangOptions = [loAutoFont]
+      Language = 1036
+      ReadOnly = True
+      ScrollBars = ssVertical
+      ShowSelectionBar = False
+      TabOrder = 4
+      URLColor = clBlue
+      URLCursor = crHandPoint
+      InputFormat = ifRTF
+      OutputFormat = ofRTF
+      SelectedInOut = False
+      PlainRTF = True
+      UndoLimit = 0
+      AllowInPlace = False
+    end
   end
 end

Modified: branches/0.77-branch/Lobby/TASClient/AgreementUnit.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/AgreementUnit.pas	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/Lobby/TASClient/AgreementUnit.pas	2008-08-20 14:38:09 UTC (rev 6278)
@@ -4,15 +4,16 @@
 
 uses
   Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
-  Dialogs, StdCtrls, ComCtrls, SpTBXControls, TBXDkPanels, SpTBXItem,Misc;
+  Dialogs, StdCtrls, ComCtrls, SpTBXControls, TBXDkPanels, SpTBXItem,Misc,
+  TntStdCtrls, RichEdit2, ExRichEdit;
 
 type
   TAgreementForm = class(TForm)
     SpTBXTitleBar1: TSpTBXTitleBar;
-    RichEdit1: TRichEdit;
     RadioButton1: TSpTBXRadioButton;
     RadioButton2: TSpTBXRadioButton;
     Button1: TSpTBXButton;
+    RichEdit1: TExRichEdit;
 
     procedure CreateParams(var Params: TCreateParams); override;
     procedure Button1Click(Sender: TObject);

Modified: branches/0.77-branch/Lobby/TASClient/BattleFormUnit.dfm
===================================================================
--- branches/0.77-branch/Lobby/TASClient/BattleFormUnit.dfm	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/Lobby/TASClient/BattleFormUnit.dfm	2008-08-20 14:38:09 UTC (rev 6278)
@@ -1,6 +1,6 @@
 object BattleForm: TBattleForm
-  Left = 478
-  Top = 70
+  Left = 639
+  Top = 226
   Width = 787
   Height = 586
   Caption = 'Battle window'

Modified: branches/0.77-branch/Lobby/TASClient/BattleFormUnit.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/BattleFormUnit.pas	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/Lobby/TASClient/BattleFormUnit.pas	2008-08-20 14:38:09 UTC (rev 6278)
@@ -25,7 +25,7 @@
   SpTBXLists, ImgList, SpTBXjanTracker, SpTBXFormPopupMenu,IniFiles,
   HttpProt,MsMultiPartFormData, JvComponentBase, JvDSADialogs, Spin, Mask,
   JvExMask, JvSpin, TntStdCtrls, TntForms, TntComCtrls,RichEdit,JclUnicode,
-  RichEdit2, ExRichEdit;
+  RichEdit2, ExRichEdit, class_TIntegerList;
 
 type
 
@@ -849,6 +849,8 @@
 begin
   if not IsBattleActive then Exit; // we are not allowed to call it if we are not participating in a battle
 
+  if not Status.BattleStatusRequestReceived then Exit;
+
   if not AllowBattleStatusUpdate then Exit;
 
   MainForm.TryToSendCommand('MYBATTLESTATUS', IntToStr(GetMyBattleStatus) +  ' ' + IntToStr(TeamColors[MyTeamColorIndex]));
@@ -890,10 +892,14 @@
   these values should be reset. }
 function TBattleForm.FigureOutBestPossibleTeamAllyAndColor(IgnoreMyself: Boolean; var BestTeam, BestAlly, BestColorIndex: Integer): Boolean;
 var
-  i: Integer;
+  i,j: Integer;
   team, ally, color: Integer;
   found: Boolean;
+  usedInt : TIntegerList;
 begin
+  usedInt := TIntegerList.Create;
+
+
   Result := False;
 
   if not IsBattleActive then Exit; // should not happen!
@@ -902,55 +908,48 @@
 
   // find first available team and ally:
   team := 0;
-  found := False;
-  while not Found do
-  begin
-    Found := True;
-    for i := 0 to BattleState.Battle.Clients.Count - 1 do
-      if (not IgnoreMyself) or (TClient(BattleState.Battle.Clients[i]).Name &lt;&gt; Status.Username) then // ignore ourselves only if set so by IgnoreMyself
-        if TClient(BattleState.Battle.Clients[i]).GetMode &lt;&gt; 0 then
-          if TClient(BattleState.Battle.Clients[i]).GetTeamNo = team then
-          begin
-            Inc(team);
-            Found := False;
-            Break;
-          end;
-    for i := 0 to BattleState.Battle.Bots.Count - 1 do
-      if TBot(BattleState.Battle.Bots[i]).GetTeamNo = team then
-      begin
-        Inc(team);
-        Found := False;
-        Break;
-      end;
-  end;
-  ally := team;
+  for i := 0 to BattleState.Battle.Clients.Count - 1 do
+    if (not IgnoreMyself) or (TClient(BattleState.Battle.Clients[i]).Name &lt;&gt; Status.Username) then // ignore ourselves only if set so by IgnoreMyself
+      if TClient(BattleState.Battle.Clients[i]).GetMode &lt;&gt; 0 then
+        usedInt.Add(TClient(BattleState.Battle.Clients[i]).GetTeamNo);
+  for i := 0 to BattleState.Battle.Bots.Count - 1 do
+    usedInt.Add( TBot(BattleState.Battle.Bots[i]).GetTeamNo);
+  for i:=0 to 15 do
+    if usedInt.IndexOf(i) = -1 then
+    begin
+      team := i;
+      ally := team;
+      break;
+    end;
 
   // find first available team color:
-  color := 0; // color index in TeamColors array
-  found := False;
-  while not Found do
+  usedInt.Clear;
+  for i := 0 to BattleState.Battle.Clients.Count - 1 do
+    if (not IgnoreMyself) or (TClient(BattleState.Battle.Clients[i]).Name &lt;&gt; Status.Username) then // ignore ourselves only if set so by IgnoreMyself
+      if TClient(BattleState.Battle.Clients[i]).GetMode &lt;&gt; 0 then
+        usedInt.Add(TClient(BattleState.Battle.Clients[i]).TeamColor);
+  for i := 0 to BattleState.Battle.Bots.Count - 1 do
+    usedInt.Add(TBot(BattleState.Battle.Bots[i]).TeamColor);
+
+  color := -1;
+  i := 0;
+  while (i &lt;= High(TeamColors)) and (color = -1)  do
   begin
-    Found := True;
-    for i := 0 to BattleState.Battle.Clients.Count - 1 do
-      if (not IgnoreMyself) or (TClient(BattleState.Battle.Clients[i]).Name &lt;&gt; Status.Username) then // ignore ourselves only if set so by IgnoreMyself
-        if TClient(BattleState.Battle.Clients[i]).GetMode &lt;&gt; 0 then
-          if TClient(BattleState.Battle.Clients[i]).TeamColor = TeamColors[color] then
-          begin
-            Inc(color);
-            Found := False;
-            Break;
-          end;
-    for i := 0 to BattleState.Battle.Bots.Count - 1 do
-      if TBot(BattleState.Battle.Bots[i]).TeamColor = TeamColors[color] then
+    j := 0;
+    color := i;
+    while (j &lt; usedInt.Count) do
+    begin
+      if ColorDistance(TeamColors[i],usedInt.Items[j]) &lt; 90 then
       begin
-        Inc(color);
-        Found := False;
-        Break;
+        color := -1;
+        break;
       end;
+      Inc(j);
+    end;
+    Inc(i);
   end;
-  if color &gt; 9 then color := 0;
-  if team &gt; MAX_TEAMS-1 then team := 0;
-  if ally &gt; MAX_TEAMS-1 then ally := 0;
+  if color = -1 then
+    color := 0;
 
   BestTeam := team;
   BestAlly := ally;
@@ -1276,6 +1275,12 @@
 
   if Status.AmIInGame then Exit;
 
+  if Utility.MapList.indexOf(BattleState.Battle.Map) = -1 then
+  begin
+    MessageDlg('You don''t have the map and cannot join the game.',mtWarning,[mbOk],0);
+    Exit;
+  end;
+
   if (BattleState.Status = Hosting) then
     case BattleState.Battle.NATType of
     0: ;
@@ -1389,7 +1394,12 @@
   UnitsTracker.Minimum := 0;
   UnitsTracker.Maximum := 5000;
 
+  if Preferences.DisplayUnitsIconsAndNames then
+    VDTDisabledUnits.DefaultNodeHeight := 64
+  else
+    VDTDisabledUnits.DefaultNodeHeight := VDTDisabledUnits.Font.Size*2;
 
+
 //  SetMyBattleStatus(SideComboBox.ItemIndex, False, 0, 0, 1, MyTeamColorIndex); *** we will update it once we receive REQUESTBATTLESTATUS
   // we will send our battle status to server as soon as we receive REQUESTBATTLESTATUS (server should send it after he is finished sending us battle statuses of other players)
 
@@ -2347,7 +2357,10 @@
     2: Script.AddOrChangeKeyValue('GAME/SourcePort',IntToStr(FIRST_UDP_SOURCEPORT + BattleState.Battle.Clients.IndexOf(Status.Me) - 1{skip the host}));
     end; // of case sentence
 
-  for i := 0 to BattleReplayInfo.OriginalClients.Count-1 do Script.AddOrChangeKeyValue('GAME/PLAYER'+IntToStr(i)+'/IsFromDemo','1');
+  for i := 0 to BattleReplayInfo.OriginalClients.Count-1 do
+  begin
+    Script.AddOrChangeKeyValue('GAME/PLAYER'+IntToStr(i)+'/IsFromDemo','1');
+  end;
   for i := 0 to BattleState.Battle.Clients.Count-1 do
   begin
     Script.AddOrChangeKeyValue('GAME/PLAYER'+IntToStr(BattleReplayInfo.OriginalClients.Count+i)+'/NAME',TClient(BattleState.Battle.Clients[i]).Name);
@@ -2550,14 +2563,7 @@
       end
       else
       begin
-        SpringDownloaderFormUnit.DownloadMap(BattleState.Battle.MapHash,BattleState.Battle.Map);
-        Exit;
-        url := StringReplace(BattleState.Battle.Map,'.smf','',[rfReplaceAll, rfIgnoreCase]);
-        {url := StringReplace(url,'_',' ',[rfReplaceAll, rfIgnoreCase]);
-        url := StringReplace(url,'-',' ',[rfReplaceAll, rfIgnoreCase]);}
-        url := '<A HREF="http://spring.jobjol.nl/search_result.php?search=">http://spring.jobjol.nl/search_result.php?search=</A>' + url+'&amp;select=select_all';
-        FixURL(url);
-        Misc.OpenURLInDefaultBrowser(url);
+        DownloadMapButtonClick(nil);
       end;
     end;
     Exit;
@@ -5028,26 +5034,24 @@
 
 procedure TBattleForm.mnuFixColorsClick(Sender: TObject);
 var
-  ColorList : TList;
+  ColorList : TIntegerList;
   i,j,k : integer;
   bestCol,bestVal : integer;
   r,g,b : integer;
   temp:integer;
   minDist : integer;
   cDistance:integer;
-  PColor : ^integer;
+  Color : integer;
 begin
-  ColorList := TList.create;
+  ColorList := TIntegerList.create;
   for i:=0 to BattleState.Battle.Clients.count-1 do
     if TClient(BattleState.Battle.Clients[i]).GetMode &lt;&gt; 0 then begin
-      New(PColor);
-      PColor^:=TClient(BattleState.Battle.Clients[i]).TeamColor;
-      ColorList.Add(PColor);
+      ColorList.Add(TClient(BattleState.Battle.Clients[i]).TeamColor);
     end;
 
   for i:=0 to ColorList.Count -2 do
     for j:=i+1 to ColorList.Count -1 do
-      if Misc.ColorDistance(PInteger(ColorList[i])^,PInteger(ColorList[j])^) &lt; 80 then begin
+      if Misc.ColorDistance(ColorList.Items[i],ColorList.Items[j]) &lt; 80 then begin
         bestVal := Low(Integer);
         r:=0;
         while r &lt;= 255 do begin
@@ -5059,7 +5063,7 @@
               minDist := High(Integer);
               for k:=0 to ColorList.count-1 do
                 if k&lt;&gt;i then begin
-                  cDistance := Misc.ColorDistance2(temp,PInteger(ColorList[k])^);
+                  cDistance := Misc.ColorDistance2(temp,ColorList.Items[k]);
                   if cDistance &lt;= bestVal then begin
                     minDist := Low(Integer);
                     break;
@@ -5077,16 +5081,15 @@
           end;
           r:=r+10;
         end;
-        PColor := ColorList[i];
-        PColor^ := bestCol;
+        ColorList.Items[i] := bestCol;
       end;
 
   MainForm.TryToSendCommand('SAYBATTLEEX', 'is fixing colors ...');
   j:=0;
   for i:=0 to BattleState.Battle.Clients.count-1 do
     if TClient(BattleState.Battle.Clients[i]).GetMode &lt;&gt; 0 then begin
-      if TClient(BattleState.Battle.Clients[i]).TeamColor &lt;&gt; PInteger(ColorList[j])^ then
-        MainForm.TryToSendCommand('FORCETEAMCOLOR', TClient(BattleState.Battle.Clients[i]).Name + ' ' + IntToStr(PInteger(ColorList[j])^));
+      if TClient(BattleState.Battle.Clients[i]).TeamColor &lt;&gt; ColorList.Items[j] then
+        MainForm.TryToSendCommand('FORCETEAMCOLOR', TClient(BattleState.Battle.Clients[i]).Name + ' ' + IntToStr(ColorList.Items[j]));
       j := j+1;
     end;
 end;
@@ -6444,8 +6447,8 @@
   map : TMapItem;
   mapImgSpaceWidth,mapImgSpaceHeight : double;
 begin
-  if not MapsPopupStringList.Enabled then
-    Exit;
+  //if not MapsPopupStringList.Enabled then
+    //Exit;
   mapImgSpaceWidth := MapPanel.Width-134;
   mapImgSpaceHeight := MapPanel.Height-62;
   if CurrentMapIndex = -1 then
@@ -6538,7 +6541,7 @@
     case Column of
       0:
       begin
-        if TBitmap(UnitBitmaps[nodeIndex]).Width &gt; 0 then
+        if Preferences.DisplayUnitsIconsAndNames and (TBitmap(UnitBitmaps[nodeIndex]).Width &gt; 0) then
         begin
           availableWidth := R.Right-R.Left;
           availableHeight := R.Bottom-R.Top;
@@ -6549,11 +6552,14 @@
               Canvas.StretchDraw(Rect(R.Left,R.Top,R.Right,R.Top+Round(availableWidth*TBitmap(UnitBitmaps[nodeIndex]).Height/TBitmap(UnitBitmaps[nodeIndex]).Width)),TBitmap(UnitBitmaps[nodeIndex]))
             else
               Canvas.StretchDraw(Rect(R.Left,R.Top,R.Left+Round(availableHeight*TBitmap(UnitBitmaps[nodeIndex]).Width/TBitmap(UnitBitmaps[nodeIndex]).Height),R.Bottom),TBitmap(UnitBitmaps[nodeIndex]));
-            end;
           end;
+        end;
       end;
-      1: s := UnitNames[nodeIndex]; // unit name
-      2: s := UnitList[nodeIndex]; // unit &quot;code name&quot;
+      1:
+        if Preferences.DisplayUnitsIconsAndNames then
+          s := UnitNames[nodeIndex]; // unit name
+      2:
+        s := BattleState.DisabledUnits[Node.index]; // unit &quot;code name&quot;
     end; // case
 
     if Length(s) &gt; 0 then
@@ -6621,7 +6627,12 @@
 
 procedure TBattleForm.DownloadMapButtonClick(Sender: TObject);
 begin
-  SpringDownloaderFormUnit.DownloadMap(BattleState.Battle.MapHash,BattleState.Battle.Map);
+  if CurrentMapIndex = -1 then
+  begin
+    ReloadMapListButtonClick(nil);
+    if CurrentMapIndex = -1 then
+      SpringDownloaderFormUnit.DownloadMap(BattleState.Battle.MapHash,BattleState.Battle.Map);
+  end;
 end;
 
 end.

Modified: branches/0.77-branch/Lobby/TASClient/ColorPicker.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/ColorPicker.pas	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/Lobby/TASClient/ColorPicker.pas	2008-08-20 14:38:09 UTC (rev 6278)
@@ -172,7 +172,7 @@
     txtG.Refresh;
     txtB.Text := IntToStr(Misc.ColorToB(ColorPanel.Color));
     txtB.Refresh;
-    txtColorHex.Text := IntToHex(ColorPanel.Color,6);
+    txtColorHex.Text := IntToHex(ColorToStandardRGB(ColorPanel.Color),6);
     txtColorHex.Refresh;
   end;
   if FSelectedColorIndex = -1 then Exit; // we haven't selected a color yet

Modified: branches/0.77-branch/Lobby/TASClient/HostBattleFormUnit.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/HostBattleFormUnit.pas	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/Lobby/TASClient/HostBattleFormUnit.pas	2008-08-20 14:38:09 UTC (rev 6278)
@@ -477,9 +477,11 @@
   s := HostBattleForm.ModsComboBox.Text;
   HostBattleForm.ModsComboBox.Items.Assign(Utility.ModList);
   HostBattleForm.ModsComboBox.ItemIndex := Max(0, HostBattleForm.ModsComboBox.Items.IndexOf(s));
-  if HostButtonMenuIndex = 1 then
-    HostLadder1Click(HostLadder1);
-  if HostButtonMenuIndex = 2 then
+  if HostButtonMenuIndex = 0 then
+    Host1Click(Host1)
+  else if HostButtonMenuIndex = 1 then
+    HostLadder1Click(HostLadder1)
+  else if HostButtonMenuIndex = 2 then
     HostReplay1Click(HostReplay1);
   HostButtonMenuIndex := 0;
 end;
@@ -488,6 +490,8 @@
 var
   s : string;
 begin
+  replay := nil;
+
   ModsComboBox.Enabled := True;
   RankComboBox.Enabled := True;
 
@@ -514,7 +518,7 @@
   ModsComboBox.Items.Assign(Utility.ModList);
   ModsComboBox.ItemIndex := ModsComboBox.Items.IndexOf(s);
 
-  //(Sender as TMenuItem).Checked := True;
+  (Sender as TMenuItem).Checked := True;
   HostButton.Caption := 'Host';
 end;
 
@@ -597,6 +601,7 @@
   s: string;
 begin
   Utility.ReInitLibWithDialog;
+
   if HostLadder1.Checked then
     ApplyLadderParams(TLadder(LadderList[LadderComboBox.ItemIndex]))
   else begin
@@ -653,6 +658,8 @@
 var
   ThreadLL : TLadderListThread;
 begin
+  replay := nil;
+
   ModsComboBox.Enabled := True;
   RankComboBox.Enabled := True;
 

Modified: branches/0.77-branch/Lobby/TASClient/LobbyScriptUnit.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/LobbyScriptUnit.pas	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/Lobby/TASClient/LobbyScriptUnit.pas	2008-08-20 14:38:09 UTC (rev 6278)
@@ -6,9 +6,16 @@
   Misc,ExtCtrls, WrapDelphi, WrapDelphiClasses,PythonEngine,
   PythonGUIInputOutput, Forms, StrUtils,Classes, JclDebug,
   WSocket,MainUnit, class_TIntegerList, RichEdit2, ExRichEdit,
-  SyncObjs,SpTBXItem, TB2Item;
+  SyncObjs,SpTBXItem, TB2Item, JvDesktopAlert;
 
 type
+  TScriptNotificationCallback = record
+    moduleName : string;
+    functionName : string;
+    args: PPyObject;
+  end;
+  PScriptNotificationCallback = ^TScriptNotificationCallback;
+
   TScriptMenuItemCallBack = record
     moduleName : string;
     functionName : string;
@@ -26,7 +33,7 @@
   {$METHODINFO ON}
 
   TGUI = class(TPersistent)
-    private
+    protected
       menuIdInc : integer;
       MenuItemList: TList;
 
@@ -34,6 +41,7 @@
       function GetMenuSelectedId(menu: TTBCustomItem): string;
       procedure MenuItemClick(Sender: TObject);
       function GetFreeMenuId: integer;
+      procedure NotificationClick(Sender: TObject);
 
     public
       constructor Create;
@@ -41,6 +49,9 @@
       function AddSubmenuToMenu(menu: string; itemCaption: string): integer;
       function AddSeparatorToMenu(menu: string): integer;
 
+      procedure DisplaySimpleNotification(title: string; msg: string; displayTime: integer);
+      procedure DisplayNotification(title: string; msg: string; callInArgs: Variant; callbackModuleName: string; callbackFunctionName: string; displayTime: integer);
+
       procedure RemoveFromMenu(id: integer);
   end;
 
@@ -59,6 +70,7 @@
       pyTextBoxes: PPyObject;
       pyColors: PPyObject;
       pyCurrentBattle: PPyObject;
+      pyServers: PPyObject;
       textBoxStringList: TStringList;
       textBoxList: TList;
       CS: TCriticalSection;
@@ -74,6 +86,7 @@
       procedure ClearRefs;
       procedure LockCallback;
       procedure UnlockCallback;
+      procedure Print(data : string);
 
     public
       // tasclient special functions
@@ -97,6 +110,7 @@
       function GetBattles: Variant;
       function GetReplays: Variant;
       function GetGroups: Variant;
+      procedure SetGroups(gV : Variant);
       function GetMaps: Variant;
       function GetMods: Variant;
       function GetTextBoxList: Variant;
@@ -110,6 +124,8 @@
       function GetCurrentBattle: Variant;
       function AddToTextBox(textBox : string; msg : string; color : integer): boolean;
       function GetColors: Variant;
+      function GetServers: Variant;
+      procedure SetServers(sV : Variant);
 
       constructor Create;
       destructor Destroy;
@@ -154,6 +170,10 @@
   procedure ReleaseMainThread;
   procedure PyDict_SetItemStringDecRef(dp: PPyObject; Key: PAnsiChar; const V : Variant);
   procedure PyDict_SetItemDecRef(dp: PPyObject; Key: PPyObject; const V : Variant);
+  procedure PyList_AppendDecRef(list: PPyObject; const item : Variant);
+  procedure PyDict_SetItemStringIncRef(dp: PPyObject; Key: PAnsiChar; o : PPyObject);
+  procedure PyDict_SetItemIncRef(dp: PPyObject; Key: PPyObject; o : PPyObject);
+  procedure SafeDecRef(o : PPyObject);
   procedure PostMsgs;
   procedure JoinBattle;
 var
@@ -170,6 +190,8 @@
   MainThreadFocused: Boolean;
   JoinBattleId: integer;
   JoinBattlePassword: string;
+  NotificationTempList: TList;
+  ScriptsInitialized: Boolean = False;
 
 implementation
 
@@ -178,16 +200,26 @@
 
 constructor TCallback.Create;
 begin
-  pyUserList := TList.Create;
-  pyBattleList := TList.Create;
-  pyGroupList := TList.Create;
-  userRefCountList := TIntegerList.Create;
-  textBoxStringList := TStringList.Create;
-  textBoxList := TList.Create;
-  CS := TCriticalSection.Create;
-
   with GetPythonEngine do
   begin
+    pyGroups := Py_None;
+    pyBattles := Py_None;
+    pyUsers := Py_None;
+    pyMods := Py_None;
+    pyMaps := Py_None;
+    pyCurrentBattle := Py_None;
+    pyTextBoxes := Py_None;
+    pyReplays := Py_None;
+    pyServers := Py_None;
+
+    pyUserList := TList.Create;
+    pyBattleList := TList.Create;
+    pyGroupList := TList.Create;
+    userRefCountList := TIntegerList.Create;
+    textBoxStringList := TStringList.Create;
+    textBoxList := TList.Create;
+    CS := TCriticalSection.Create;
+
     pyColors := PyDict_New();
     PyDict_SetItemStringDecRef(pyColors,'Normal',Colors.Normal);
     PyDict_SetItemStringDecRef(pyColors,'Data',Colors.Data);
@@ -241,7 +273,7 @@
 
 procedure TCallback.ExitLobby;
 begin
-  Application.Terminate;
+  MainForm.Close;
 end;
 
 procedure TCallback.Disconnect;
@@ -280,14 +312,13 @@
 procedure TCallback.ReloadScript(name: WideString);
 begin
   AcquireMainThread;
-  try handlers._reload(name); except end;
+  try if not Preferences.DisableScripts then handlers._reload(name); except end;
   ReleaseMainThread;
 end;
 procedure TCallback.SendProtocol(data: WideString);
 var
   i:integer;
 begin
-  Exit;
   i := Pos(data,' ');
   ReleaseMainThread;
   MainForm.TryToSendCommand(LeftStr(data,i-1),MidStr(data,i+1,9999999));
@@ -306,13 +337,13 @@
     TScriptThread.Create(functionName, tuple);
 end;}
 
-{procedure TCallback.Print(data : string);
+procedure TCallback.Print(data : string);
 begin
   PythonScriptDebugFormUnit.printList.BeginUpdate;
   PythonScriptDebugFormUnit.printList.Add(data);
   PythonScriptDebugFormUnit.printList.EndUpdate;
   PostMessage(PythonScriptDebugForm.Handle, WM_REFRESHOUTPUT, 0, 0);
-end;}
+end;
 
 procedure TCallback.RefreshTextBoxesLists;
 var
@@ -475,7 +506,6 @@
   LockCallback;
   with GetPythonEngine do
   begin
-    Result := PyObjectAsVariant(Py_None);
     if BattleState.Status = None then
     begin
       UnlockCallback;
@@ -652,6 +682,7 @@
     begin
       Result := PyDict_New();
 
+      PyDict_SetItemStringDecRef( Result, 'Name', Name );
       PyDict_SetItemStringDecRef( Result, 'Color', Color );
       PyDict_SetItemStringDecRef( Result, 'AutoKick', AutoKick );
       PyDict_SetItemStringDecRef( Result, 'AutoSpec', AutoSpec );
@@ -669,21 +700,19 @@
   i: integer;
   pyO: PPyObject;
 begin
-  LockCallback;
   if ReplaysForm.LoadingPanel.Visible then Exit;
 
+  LockCallback;
   with GetPythonEngine do
   begin
     ClearRefs;
     pyReplays := PyDict_New();
-
     for i:=0 to ReplayList.Count-1 do
     begin
       pyO := GetPyReplay(TReplay(ReplayList[i]));
       PyDict_SetItem(pyReplays,PyInt_FromLong(i),pyO);
       Py_XDECREF(pyO);
     end;
-
     Result := PyObjectAsVariant(pyReplays);
   end;
   UnlockCallback;
@@ -711,26 +740,24 @@
 
 procedure TCallback.LockCallback;
 begin
-  CS.Acquire;
+  CS.Enter;
 end;
 procedure TCallback.UnlockCallback;
 begin
-  CS.Release;
+  CS.Leave;
 end;
 
 procedure TCallback.ClearRefs;
 begin
-  with GetPythonEngine do
-  begin
-    Py_XDECREF(pyGroups);
-    Py_XDECREF(pyBattles);
-    Py_XDECREF(pyUsers);
-    Py_XDECREF(pyMods);
-    Py_XDECREF(pyMaps);
-    Py_XDECREF(pyReplays);
-    Py_XDECREF(pyCurrentBattle);
-    Py_XDECREF(pyTextBoxes);
-  end;
+  SafeDecRef(pyGroups);
+  SafeDecRef(pyBattles);
+  SafeDecRef(pyUsers);
+  SafeDecRef(pyMods);
+  SafeDecRef(pyMaps);
+  SafeDecRef(pyCurrentBattle);
+  SafeDecRef(pyTextBoxes);
+  SafeDecRef(pyReplays);
+  SafeDecRef(pyServers);
 end;
 
 function TCallback.GetGroups: Variant;
@@ -744,7 +771,7 @@
     pyGroups := PyDict_New();
 
     RefreshPythonLists;
-
+    
     for i:=0 to pyGroupList.Count-1 do
       PyDict_SetItemString(pyGroups,PChar(TClientGroup(ClientGroups[i]).Name),PPyObject(pyGroupList[i]));
 
@@ -753,11 +780,151 @@
   UnlockCallback;
 end;
 
+procedure TCallback.SetGroups(gV : Variant);
+var
+  groupsDict : PPyObject;
+  keys : PPyObject;
+  key : PPyObject;
+  groupName : string;
+  i: integer;
+  group : PPyObject;
+  cg : TClientGroup;
+  groupUsers : PPyObject;
+  groupUsersSL : TStringList;
+  tmpCGList : TList;
+begin
+  with GetPythonEngine do
+  begin
+    groupsDict := VariantAsPyObject(gV);
+    if not PyDict_Check(groupsDict) then
+    begin
+      Print('SetGroups error : first parameter is not a valid python dictionary.');
+      Exit;
+    end;
+
+    keys := PyDict_Keys(groupsDict);
+    groupUsersSL := TStringList.Create;
+    tmpCGList := TList.Create;
+
+    for i:=0 to PyDict_Size(groupsDict)-1 do
+    begin
+      key := PyList_GetItem(keys,i);
+      groupName := PyObjectAsString(key);
+      group := PyDict_GetItem(groupsDict,key);
+      cg := TClientGroup.Create(groupName,0);
+
+      cg.Color := PyInt_AsLong(PyDict_GetItem(group,PyString_FromString('Color')));
+      cg.AutoKick := IntToBool(PyInt_AsLong(PyDict_GetItem(group,PyString_FromString('AutoKick'))));
+      cg.AutoSpec := IntToBool(PyInt_AsLong(PyDict_GetItem(group,PyString_FromString('AutoSpec'))));
+      cg.NotifyOnHost := IntToBool(PyInt_AsLong(PyDict_GetItem(group,PyString_FromString('NotifyOnHost'))));
+      cg.NotifyOnJoin := IntToBool(PyInt_AsLong(PyDict_GetItem(group,PyString_FromString('NotifyOnJoin'))));
+      cg.NotifyOnBattleEnd := IntToBool(PyInt_AsLong(PyDict_GetItem(group,PyString_FromString('NotifyOnBattleEnd'))));
+      cg.NotifyOnConnect := IntToBool(PyInt_AsLong(PyDict_GetItem(group,PyString_FromString('NotifyOnConnect'))));
+      cg.HighlightBattles := IntToBool(PyInt_AsLong(PyDict_GetItem(group,PyString_FromString('HighlightBattles'))));
+
+      groupUsers := PyDict_GetItem(group,PyString_FromString('Users'));
+      if not PyDict_Check(groupUsers) and not PyList_Check(groupUsers) then
+      begin
+        Print('SetGroups error : '+groupName+'''s ''Users'' is not a valid python dictionary or list.');
+        Exit;
+      end;
+      if PyDict_Check(groupUsers) then
+        PyListToStrings(PyDict_Keys(groupUsers),groupUsersSL)
+      else
+        PyListToStrings(groupUsers,groupUsersSL);
+      cg.Clients.AddStrings(groupUsersSL);
+
+      tmpCGList.Add(cg);
+    end;
+
+    ClientGroups.Clear;
+    ClientGroups.Assign(tmpCGList);
+    tmpCGList.Clear;
+  end;
+end;
+
 function TCallback.GetColors: Variant;
 begin
   Result := GetPythonEngine.PyObjectAsVariant(pyColors);
 end;
 
+function TCallback.GetServers: Variant;
+var
+  i: integer;
+  pyO: PPyObject;
+begin
+  LockCallback;
+  with GetPythonEngine do
+  begin
+    ClearRefs;
+    pyServers := PyList_New(0);
+
+    for i:=0 to High(ServerList) do
+    begin
+      pyO := PyDict_New();
+      PyDict_SetItemStringDecRef( pyO, 'Name', ServerList[i].Name );
+      PyDict_SetItemStringDecRef( pyO, 'Address', ServerList[i].Address );
+
+      PyList_Append(pyServers,pyO);
+      Py_XDECREF(pyO);
+    end;
+
+    Result := PyObjectAsVariant(pyServers);
+  end;
+  UnlockCallback;
+end;
+procedure TCallback.SetServers(sV : Variant);
+var
+  serversPyList : PPyObject;
+  server: PPyObject;
+  keys : PPyObject;
+  values : PPyObject;
+  addressList : TStringList;
+  nameList : TStringList;
+  i : integer;
+begin
+  with GetPythonEngine do
+  begin
+    serversPyList := VariantAsPyObject(sV);
+    if not PyList_Check(serversPyList) then
+    begin
+      Print('SetServers error : first parameter is not a valid python list.');
+      Exit;
+    end;
+
+    nameList := TStringList.Create;
+    addressList := TStringList.Create;
+
+    for i:=0 to PyList_Size(serversPyList)-1 do
+    begin
+      server := PyList_GetItem(serversPyList,i);
+
+      if not PyDict_Check(server) then
+      begin
+        Print('SetServers error : server '+IntToStr(i)+' is not a valid dictionary.');
+        Exit;
+      end;
+      try
+        nameList.Add(PyString_AsString(PyDict_GetItemString(server,'Name')));
+        addressList.Add(PyString_AsString(PyDict_GetItemString(server,'Address')));
+      except
+        Print('SetServers error : server '+IntToStr(i)+' does not contain all needed informations.');
+        Exit;
+      end;
+    end;
+
+    SetLength(ServerList,nameList.Count);
+
+    for i:=0 to nameList.Count-1 do
+    begin
+      ServerList[i].Name := nameList[i];
+      ServerList[i].Address := addressList[i];
+    end;
+
+    PreferencesForm.PopulateServerListMenu;
+  end;
+end;
+
 function TCallback.GetMaps: Variant;
 var
   pyMap: PPyObject;
@@ -848,11 +1015,13 @@
 var
   b : TBattle;
 begin
+  LockCallback;
   Result := True;
 
   if BattleState.Status &lt;&gt; None then
   begin
     Result := False;
+    UnlockCallback;
     Exit;
   end;
 
@@ -869,6 +1038,7 @@
   else
     Result := False;
   AcquireMainThread;
+  UnlockCallback;
 end;
 
 function TCallback.HostReplay(replayFile: string; nbPlayers: integer; RankLimit: Integer; Description: string; Password: string; UDPHostPort: integer; NatTraversal: integer) : Boolean;
@@ -1270,6 +1440,45 @@
     end;
 end;
 
+procedure TGUI.DisplaySimpleNotification(title: string; msg: string; displayTime: integer);
+var
+  N : TJvDesktopAlert;
+begin
+ N := MainForm.MakeNotification(title,msg,displayTime,False);
+ MainForm.ExecuteNotification(N);
+end;
+
+procedure TGUI.DisplayNotification(title: string; msg: string; callInArgs: Variant; callbackModuleName: string; callbackFunctionName: string; displayTime: integer);
+var
+  snc : PScriptNotificationCallback;
+  N : TJvDesktopAlert;
+begin
+  N := MainForm.MakeNotification(title,msg,displayTime,True);
+  N.OnMessageClick := NotificationClick;
+  New(snc);
+  snc.moduleName := callbackModuleName;
+  snc.functionName := callbackFunctionName;
+  snc.args := GetPythonEngine.VariantAsPyObject(callInArgs);
+  N.Tag := Longint(snc);
+  MainForm.ExecuteNotification(N);
+end;
+
+procedure TGUI.NotificationClick(Sender: TObject);
+var
+  m : PPyObject;
+  snc : PScriptNotificationCallback;
+begin
+  AcquireMainThread;
+  with GetPythonEngine do
+  begin
+    snc := PScriptNotificationCallback(Pointer((Sender as TJvDesktopAlert).Tag));
+    m := FindFunction(snc.moduleName,snc.functionName);
+
+    EvalPyFunction(m,PyList_AsTuple(snc.args));
+  end;
+  ReleaseMainThread;
+end;
+
 // We override the constructors
 
 constructor TPyCallback.Create( APythonType : TPythonType );
@@ -1361,7 +1570,7 @@
 
 procedure AcquireMainThread;
 begin
-  if Preferences.DisableScripts then Exit;
+  if Preferences.DisableScripts or not ScriptsInitialized then Exit;
   if GetCurrentThreadId &lt;&gt; MainThreadID then Exit;
   if MainThreadFocused then Exit;
   GetPythonEngine.PyEval_AcquireThread(MainThreadState);
@@ -1388,7 +1597,7 @@
 
 procedure ReleaseMainThread;
 begin
-  if Preferences.DisableScripts then Exit;
+  if Preferences.DisableScripts or not ScriptsInitialized then Exit;
   if GetCurrentThreadId &lt;&gt; MainThreadID then Exit;
   if not MainThreadFocused then Exit;
   GetPythonEngine.PyEval_ReleaseThread(MainThreadState);
@@ -1398,12 +1607,15 @@
 procedure PyDict_SetItemStringDecRef(dp: PPyObject; Key: PAnsiChar; const V : Variant);
 var
   o: PPyObject;
+  k: PPyObject;
 begin
   with GetPythonEngine do
   begin
     o := VariantAsPyObject(V);
-    PyDict_SetItemString(dp,Key,o);
+    k := PyString_FromString(Key);
+    PyDict_SetItem(dp,k,o);
     Py_XDECREF(o);
+    Py_XDECREF(k);
   end;
 end;
 
@@ -1419,5 +1631,40 @@
   end;
 end;
 
+procedure PyDict_SetItemStringIncRef(dp: PPyObject; Key: PAnsiChar; o : PPyObject);
+begin
+  with GetPythonEngine do
+  begin
+    PyDict_SetItemString(dp,Key,o);
+    Py_XINCREF(o);
+  end;
+end;
 
+procedure PyDict_SetItemIncRef(dp: PPyObject; Key: PPyObject; o : PPyObject);
+begin
+  with GetPythonEngine do
+  begin
+    PyDict_SetItem(dp,Key,o);
+    Py_XINCREF(o);
+  end;
+end;
+
+procedure PyList_AppendDecRef(list: PPyObject; const item : Variant);
+var
+  o: PPyObject;
+begin
+  with GetPythonEngine do
+  begin
+    o := VariantAsPyObject(item);
+    PyList_Append(list,o);
+    Py_XDECREF(o);
+  end;
+end;
+
+procedure SafeDecRef(o : PPyObject);
+begin
+  try if o &lt;&gt; GetPythonEngine.Py_None then GetPythonEngine.Py_XDECREF(o); except end;
+end;
+
+
 end.

Modified: branches/0.77-branch/Lobby/TASClient/MainUnit.dfm
===================================================================
--- branches/0.77-branch/Lobby/TASClient/MainUnit.dfm	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/Lobby/TASClient/MainUnit.dfm	2008-08-20 14:38:09 UTC (rev 6278)
@@ -1,6 +1,6 @@
 object MainForm: TMainForm
-  Left = 813
-  Top = 384
+  Left = 827
+  Top = 110
   Width = 808
   Height = 549
   Caption = '.'
@@ -511,121 +511,21 @@
               Height = 169
               Align = alClient
               Color = clBtnFace
-              ActiveTabIndex = 0
+              ActiveTabIndex = 1
               TabPosition = ttpBottom
               ThemeType = tttNone
               HiddenItems = &lt;&gt;
               object SpTBXTabItem1: TSpTBXTabItem
                 Caption = 'Filters'
-                Checked = True
                 TabPosition = ttpBottom
                 ThemeType = tttNone
               end
               object SpTBXTabItem2: TSpTBXTabItem
                 Caption = 'Presets'
+                Checked = True
                 TabPosition = ttpBottom
                 ThemeType = tttNone
               end
-              object SpTBXTabSheet2: TSpTBXTabSheet
-                Left = 0
-                Top = 0
-                Width = 617
-                Height = 146
-                Caption = 'Presets'
-                ImageIndex = -1
-                DesignSize = (
-                  617
-                  146)
-                TabItem = 'SpTBXTabItem2'
-                object PresetListbox: TSpTBXListBox
-                  Left = 152
-                  Top = 26
-                  Width = 457
-                  Height = 113
-                  Anchors = [akLeft, akTop, akRight]
-                  ItemHeight = 16
-                  Items.Strings = (
-                    'default')
-                  TabOrder = 0
-                  OnClick = PresetListboxClick
-                end
-                object SpTBXLabel3: TSpTBXLabel
-                  Left = 152
-                  Top = 8
-                  Width = 64
-                  Height = 16
-                  Caption = 'Preset list :'
-                  Font.Charset = DEFAULT_CHARSET
-                  Font.Color = clWindowText
-                  Font.Height = -13
-                  Font.Name = 'MS Sans Serif'
-                  Font.Style = []
-                  ParentFont = False
-                  LinkFont.Charset = DEFAULT_CHARSET
-                  LinkFont.Color = clBlue
-                  LinkFont.Height = -11
-                  LinkFont.Name = 'MS Sans Serif'
-                  LinkFont.Style = [fsUnderline]
-                end
-                object SpTBXGroupBox1: TSpTBXGroupBox
-                  Left = 8
-                  Top = 8
-                  Width = 137
-                  Height = 129
-                  Caption = 'Options'
-                  TabOrder = 2
-                  object btDeletePreset: TSpTBXButton
-                    Left = 8
-                    Top = 72
-                    Width = 121
-                    Height = 25
-                    Caption = 'Delete'
-                    TabOrder = 1
-                    OnClick = btDeletePresetClick
-                    LinkFont.Charset = DEFAULT_CHARSET
-                    LinkFont.Color = clBlue
-                    LinkFont.Height = -11
-                    LinkFont.Name = 'MS Sans Serif'
-                    LinkFont.Style = [fsUnderline]
-                  end
-                  object btSavePreset: TSpTBXButton
-                    Left = 8
-                    Top = 40
-                    Width = 121
-                    Height = 25
-                    Caption = 'Save'
-                    TabOrder = 2
-                    OnClick = btSavePresetClick
-                    LinkFont.Charset = DEFAULT_CHARSET
-                    LinkFont.Color = clBlue
-                    LinkFont.Height = -11
-                    LinkFont.Name = 'MS Sans Serif'
-                    LinkFont.Style = [fsUnderline]
-                  end
-                  object PresetNameTextbox: TSpTBXEdit
-                    Left = 8
-                    Top = 18
-                    Width = 121
-                    Height = 21
-                    TabOrder = 3
-                    Text = 'Preset name'
-                  end
-                  object btClearPreset: TSpTBXButton
-                    Left = 8
-                    Top = 96
-                    Width = 121
-                    Height = 25
-                    Caption = 'Clear'
-                    TabOrder = 0
-                    OnClick = btClearPresetClick
-                    LinkFont.Charset = DEFAULT_CHARSET
-                    LinkFont.Color = clBlue
-                    LinkFont.Height = -11
-                    LinkFont.Name = 'MS Sans Serif'
-                    LinkFont.Style = [fsUnderline]
-                  end
-                end
-              end
               object SpTBXTabSheet1: TSpTBXTabSheet
                 Left = 0
                 Top = 0
@@ -946,6 +846,106 @@
                   end
                 end
               end
+              object SpTBXTabSheet2: TSpTBXTabSheet
+                Left = 0
+                Top = 0
+                Width = 617
+                Height = 146
+                Caption = 'Presets'
+                ImageIndex = -1
+                DesignSize = (
+                  617
+                  146)
+                TabItem = 'SpTBXTabItem2'
+                object PresetListbox: TSpTBXListBox
+                  Left = 152
+                  Top = 26
+                  Width = 457
+                  Height = 113
+                  Anchors = [akLeft, akTop, akRight]
+                  ItemHeight = 16
+                  Items.Strings = (
+                    'default')
+                  TabOrder = 0
+                  OnClick = PresetListboxClick
+                end
+                object SpTBXLabel3: TSpTBXLabel
+                  Left = 152
+                  Top = 8
+                  Width = 64
+                  Height = 16
+                  Caption = 'Preset list :'
+                  Font.Charset = DEFAULT_CHARSET
+                  Font.Color = clWindowText
+                  Font.Height = -13
+                  Font.Name = 'MS Sans Serif'
+                  Font.Style = []
+                  ParentFont = False
+                  LinkFont.Charset = DEFAULT_CHARSET
+                  LinkFont.Color = clBlue
+                  LinkFont.Height = -11
+                  LinkFont.Name = 'MS Sans Serif'
+                  LinkFont.Style = [fsUnderline]
+                end
+                object SpTBXGroupBox1: TSpTBXGroupBox
+                  Left = 8
+                  Top = 8
+                  Width = 137
+                  Height = 129
+                  Caption = 'Options'
+                  TabOrder = 2
+                  object btDeletePreset: TSpTBXButton
+                    Left = 8
+                    Top = 72
+                    Width = 121
+                    Height = 25
+                    Caption = 'Delete'
+                    TabOrder = 1
+                    OnClick = btDeletePresetClick
+                    LinkFont.Charset = DEFAULT_CHARSET
+                    LinkFont.Color = clBlue
+                    LinkFont.Height = -11
+                    LinkFont.Name = 'MS Sans Serif'
+                    LinkFont.Style = [fsUnderline]
+                  end
+                  object btSavePreset: TSpTBXButton
+                    Left = 8
+                    Top = 40
+                    Width = 121
+                    Height = 25
+                    Caption = 'Save'
+                    TabOrder = 2
+                    OnClick = btSavePresetClick
+                    LinkFont.Charset = DEFAULT_CHARSET
+                    LinkFont.Color = clBlue
+                    LinkFont.Height = -11
+                    LinkFont.Name = 'MS Sans Serif'
+                    LinkFont.Style = [fsUnderline]
+                  end
+                  object PresetNameTextbox: TSpTBXEdit
+                    Left = 8
+                    Top = 18
+                    Width = 121
+                    Height = 21
+                    TabOrder = 3
+                    Text = 'Preset name'
+                  end
+                  object btClearPreset: TSpTBXButton
+                    Left = 8
+                    Top = 96
+                    Width = 121
+                    Height = 25
+                    Caption = 'Clear'
+                    TabOrder = 0
+                    OnClick = btClearPresetClick
+                    LinkFont.Charset = DEFAULT_CHARSET
+                    LinkFont.Color = clBlue
+                    LinkFont.Height = -11
+                    LinkFont.Name = 'MS Sans Serif'
+                    LinkFont.Style = [fsUnderline]
+                  end
+                end
+              end
             end
             object EnableFilters: TSpTBXCheckBox
               Left = 509
@@ -994,7 +994,7 @@
         BorderType = pbrRaised
         TBXStyleBackground = True
         object OptionsSpeedButton: TSpTBXSpeedButton
-          Left = 328
+          Left = 240
           Top = 8
           Width = 81
           Height = 25
@@ -1021,7 +1021,7 @@
           ThemeType = thtTBX
         end
         object HelpButton: TSpTBXSpeedButton
-          Left = 416
+          Left = 328
           Top = 8
           Width = 81
           Height = 25
@@ -1034,7 +1034,7 @@
           LinkFont.Style = [fsUnderline]
         end
         object ReplaysButton: TSpTBXSpeedButton
-          Left = 240
+          Left = 152
           Top = 8
           Width = 81
           Height = 25
@@ -1052,7 +1052,7 @@
           LinkFont.Style = [fsUnderline]
         end
         object SearchButton: TSpTBXSpeedButton
-          Left = 504
+          Left = 416
           Top = 8
           Width = 81
           Height = 25
@@ -1085,11 +1085,12 @@
         end
         object SinglePlayerButton: TSpTBXButton
           Left = 152
-          Top = 8
+          Top = 32
           Width = 81
           Height = 25
           Caption = 'Single Player'
           TabOrder = 6
+          Visible = False
           OnClick = SinglePlayerButtonClick
           LinkFont.Charset = DEFAULT_CHARSET
           LinkFont.Color = clBlue
@@ -6680,6 +6681,10 @@
       Caption = 'Away'
       OnClick = mnuAwayClick
     end
+    object mnuDisableNotifications: TSpTBXItem
+      Caption = 'Disable notifications'
+      AutoCheck = True
+    end
     object SpTBXSeparatorItem10: TSpTBXSeparatorItem
     end
     object mnuNewAwayMsg: TSpTBXItem
@@ -7061,8 +7066,10 @@
     Top = 166
   end
   object PyEngine: TAtomPythonEngine
-    InitThreads = True
+    FatalAbort = False
+    FatalMsgDlg = False
     IO = PyInOut
+    PyFlags = [pfDebug]
     Left = 452
     Top = 166
   end

Modified: branches/0.77-branch/Lobby/TASClient/MainUnit.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/MainUnit.pas	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/Lobby/TASClient/MainUnit.pas	2008-08-20 14:38:09 UTC (rev 6278)
@@ -506,23 +506,23 @@
   $0000FFFF, // yellow
   $00323232, // black
   $00DCC898, // ltblue
-  $0083ABAB,  // tan
-  $0083ABAB,  // tan
-  $0083ABAB,  // tan
-  $0083ABAB,  // tan
-  $0083ABAB,  // tan
-  $0083ABAB,  // tan
-  $0083ABAB,  // tan
-  $0083ABAB,  // tan
-  $0083ABAB,  // tan
-  $0083ABAB,  // tan
-  $0083ABAB  // tan
+  $00AAAAAA,  // light grey
+  $00666666,  // dark grey
+  $0000FF1A,  // light green
+  $00FFD6F4,  // pink
+  $0000A6FF,  // orange
+  $00FFEE00,
+  $00FF69E3,
+  $0081BD00,
+  $000D0073,
+  $00009191,
+  $000000FF
   );
 
 const
   VERSION_NUMBER = '0.38'; // Must be float value! (with a period as a decimal seperator)
   CHECK_BETA_LOBBY_URL = '<A HREF="http://tasclient.no-ip.org/TASClient_update_v2.txt">http://tasclient.no-ip.org/TASClient_update_v2.txt</A>';
-  PROGRAM_VERSION = 'TASClient ' + VERSION_NUMBER + ' beta';
+  PROGRAM_VERSION = 'TASClient ' + VERSION_NUMBER + ' RC3';
   KEEP_ALIVE_INTERVAL = 10000; // in milliseconds. Tells us what should be the maximum &quot;silence&quot; time before we send a ping to the server.
   ASSUME_TIMEOUT_INTERVAL = 30000; // in milliseconds. Must be greater than KEEP_ALIVE_INTERVAL! If server hasn't send any data to us within this interval, then we assume timeout occured. It's us who must make sure we get constant replies from server by pinging it.
   LOCAL_TAB = '$Local'; // caption of main (command) tab window. Must be special so that is different from channel names or user names, that is why there is a &quot;$&quot; in front of it.
@@ -547,6 +547,7 @@
   LOG_FOLDER = LOBBY_FOLDER + '\' + 'logs'; // this is where we store chat logs
   VAR_FOLDER = LOBBY_FOLDER + '\' + 'var';
   FILTERS_FOLDER = VAR_FOLDER + '\filters';
+  REPLAY_FILTERS_FOLDER = VAR_FOLDER + '\replayFilters';
   SPSKIN_FOLDER = LOBBY_FOLDER + '\SPSkins';
   SCRIPTS_FOLDER = LOBBY_FOLDER + '\Python\engine';
   FIRST_UDP_SOURCEPORT = 8300; // udp source port (used with &quot;fixed source ports&quot; NAT traversal technique) of the second (first one is host) client in clients list of the battle. Third client uses this+1 port, fourth one this+2, etc.
@@ -755,15 +756,17 @@
     constructor Create(Suspended : Boolean;hash: integer;name: string);
   end;
 
-  TCheckNewBetaLobbyThread = class(TTASClientThread)
+  TLobbyUpdateThread = class(TTASClientThread)
   private
-    confirmation: boolean;
+    dlBeta: boolean;
+    autoUpdt: boolean;
+    delay: integer; 
 
   protected
     procedure Execute; override;
 
   public
-    constructor Create(Suspended : Boolean;hasLastVersionConfirmation: boolean);
+    constructor Create(Suspended: Boolean;downloadBeta: boolean; autoUpdate: boolean; delayed : integer = 0);
   end;
 
   TLadder = class
@@ -958,6 +961,8 @@
 
     constructor Create(Name: string; Color: Integer);
     destructor Destroy;
+
+    procedure GroupUpdated;
   end;
 
   TMainForm = class(TForm)
@@ -1133,6 +1138,7 @@
     DefaultArmImage: TImage;
     DefaultSideImage: TImage;
     DefaultCoreImage: TImage;
+    mnuDisableNotifications: TSpTBXItem;
     procedure mnuOpenPrivateChatClick(Sender: TObject);
     procedure mnuSelectBattleClick(Sender: TObject);
     procedure SpTBXItem1Click(Sender: TObject);
@@ -1260,6 +1266,7 @@
       const Data: String);
     procedure SpTBXItem5Click(Sender: TObject);
     procedure lobbyscriptWrapperInitialization(Sender: TObject);
+    procedure Button1Click(Sender: TObject);
   published
     MainTitleBar: TSpTBXTitleBar;
     Panel2: TSpTBXPanel;
@@ -1384,6 +1391,8 @@
     procedure SortBattleInList(Index: Integer; SortStyle: Byte; Ascending: Boolean);
 
     procedure AddNotification(HeaderText, MessageText: string; DisplayTime: Integer;OnClick: Boolean = false;BattleId: integer = -1);
+    function MakeNotification(HeaderText, MessageText: string; DisplayTime: Integer; canClick: boolean): TJvDesktopAlert;
+    procedure ExecuteNotification(N: TJvDesktopAlert);
     procedure NotificationClick(Sender: TObject);
     procedure NotificationClose(Sender: TObject);
 
@@ -1402,6 +1411,7 @@
     procedure ResetAutoSpecMsgSentCounters;
 
     procedure initLobbyScript;
+    procedure initFiltersPresets;
 
   published
     procedure ApplicationEvents1ShortCut(var Msg: TWMKey; var Handled: Boolean);
@@ -1497,8 +1507,6 @@
 
   MainForm: TMainForm;
 
-  KAT:TKeepAliveThread;
-
   { this is a list of all clients on the server. We must maintain this list by reading ADDUSER and REMOVEUSER commands.
     All other clients lists (in channels, battles) contain objects linking to actual objects in this list. Never free
     any clients in any list except in this one, since freeing them in any other list will also free them in this list! }
@@ -1589,7 +1597,7 @@
   MuteListForms: TList; // list of all open MuteListForm-s. When form is created it will add itself to the list automatically, likewise will remove itself from the list when it gets destroyed
   ReceivingMuteListForChannel: string; // name of the channel for which we are currently receiving the mute list (we've extracted this info form MUTELISTBEGIN command)
 
-  ReceivedAgreement: TStringList; // this is temporary string list to store received lines of an agreement sent by server.
+  ReceivedAgreement: TWideStringList; // this is temporary string list to store received lines of an agreement sent by server.
 
   ProcessingRemoteCommand: Boolean = False; // tells us if we are processing remote command currently. This is important because sometimes Application.ProcessMessages can get called from within ProcessRemoteCommand method, which could led to next command being processed before current one is finished.
 
@@ -1628,6 +1636,8 @@
   // script var
   handlers: variant;
 
+  autoUpdateDone: Boolean = False;
+
   function Dequeue: WideString; forward;
   function Enqueue(s: WideString): Integer; forward;
 
@@ -3362,13 +3372,7 @@
     // nothing
   end;
 
-  FiltersTabs.ActiveTabIndex := 0;
-  FilterGroup.Height := 0;
-  Filters.TextFilters := TList.Create;
-  LoadFiltersFromFile(FILTERS_FOLDER + '\default.ini');
-  UpdateFilters;
-  PresetListbox.Selected[0] := true;
-  LoadPresets;
+  initFiltersPresets;
 
   Randomize;
   Application.UpdateFormatSettings := False; // so that DecimalSeparator doesn't get changed by WM_WININICHANGE message. See <A HREF="http://coding.derkeiler.com/Archive/Delphi/borland.public.delphi.language.objectpascal/2003-11/0223.html">http://coding.derkeiler.com/Archive/Delphi/borland.public.delphi.language.objectpascal/2003-11/0223.html</A>
@@ -3396,7 +3400,7 @@
 
   FixFormSizeConstraints(MainForm);
 
-  KAT := TKeepAliveThread.Create(False);
+  TKeepAliveThread.Create(False);
 
   SplashScreenForm.UpdateText('initializing unitsync.dll ...');
   if not Utility.InitLib then
@@ -3456,7 +3460,7 @@
 
   InitializeFlagBitmaps;
 
-  ReceivedAgreement := TStringList.Create;
+  ReceivedAgreement := TWideStringList.Create;
 
   Pings := TList.Create;
 
@@ -3603,6 +3607,17 @@
       end;
     end;
 
+    if not DirectoryExists(ExtractFilePath(Application.ExeName) + REPLAY_FILTERS_FOLDER) then
+    begin
+      MessageDlg('Program has detected that &quot;' + REPLAY_FILTERS_FOLDER + '&quot; folder does not exist. It will be now created.', mtInformation, [mbOK], 0);
+      if not CreateDir(ExtractFilePath(Application.ExeName) + REPLAY_FILTERS_FOLDER) then
+      begin
+        MessageDlg('Unable to create directory. Program will now exit ...', mtError, [mbOK], 0);
+        Application.Terminate;
+        Exit;
+      end;
+    end;
+
     if Preferences.SaveLogs then OpenAllLogs; // do this before all else, so that we don't miss any message
 
     SplashScreenForm.UpdateText('loading maps ...');
@@ -3617,11 +3632,11 @@
     // finally apply post-initialization preferences:
     PreferencesForm.ApplyPostInitializationPreferences;
 
-    if not RunningUnderWine then
+    {if not RunningUnderWine then
     begin
       SplashScreenForm.UpdateText('loading menu ...');
       MenuForm.LoadSkin(Preferences.SPSkin);
-    end;
+    end;}
 
     // hide splash screen:
     SplashScreenForm.Close;
@@ -3645,8 +3660,7 @@
     //SendMessage(((PageControl1.Pages[0] as TMyTabSheet).Controls[1] as TExRichEdit).Handle, EM_SETEVENTMASK, 0, mask or ENM_LINK);
     //SendMessage(((PageControl1.Pages[0] as TMyTabSheet).Controls[1] as TExRichEdit).Handle, EM_AUTOURLDETECT, Integer(True), 0);
 
-    ReplaysForm.LoadReplayFiltersFromFile;
-    ReplaysForm.UpdateReplayFilters;
+    initLobbyScript;
 
     // finally:
     if RunningWithMainMenu then
@@ -3654,13 +3668,10 @@
     else
     begin
       MainForm.Visible := True;
-      initLobbyScript;
     end;
 
-    // check new version
-    CheckNewVersion;
-
-    StartSpringDownloader;
+    if Preferences.EnableSpringDownloader then
+      StartSpringDownloader;
    end;
 end;
 
@@ -3969,7 +3980,7 @@
 
     handleCommandReturn := false;
     AcquireMainThread;
-    try handleCommandReturn := handlers.handleCommand(s); except end;
+    try if not Preferences.DisableScripts then handleCommandReturn := handlers.handleCommand(s); except end;
     ReleaseMainThread;
 
     if handleCommandReturn then Exit
@@ -4432,7 +4443,7 @@
   tmp := s;
 
   AcquireMainThread;
-  try s := handlers.handleIn(s); except end;
+  try if not Preferences.DisableScripts then s := handlers.handleIn(s); except end;
   ReleaseMainThread;
 
   if Debug.Enabled and ((not Debug.FilterPingPong) or (s &lt;&gt; 'PONG')) then
@@ -4466,6 +4477,8 @@
         AddMainLog('Server version (' + IFF(sl.Count &gt; 1, sl[1], '[unknown]') + ') is not supported with this client!', Colors.Info);
         AddMainLog('Requesting update from server ...', Colors.Info);
         TryToSendCommand('REQUESTUPDATEFILE', 'TASClient ' + VERSION_NUMBER); // we ask server if he has an update for us
+        if autoUpdateDone then
+          TLobbyUpdateThread.Create(False,False,True,5000);
         Exit;
       end;
 
@@ -4485,6 +4498,8 @@
         AddMainLog('This server version is not supported with this client!', Colors.Info);
         AddMainLog('Requesting update from server ...', Colors.Info);
         TryToSendCommand('REQUESTUPDATEFILE', 'TASClient ' + VERSION_NUMBER); // we ask server if he has an update for us
+        if autoUpdateDone then
+          TLobbyUpdateThread.Create(False,False,True,5000);
         Exit;
       end;
 
@@ -4517,11 +4532,10 @@
     else if sl[0] = 'AGREEMENTEND' then
     begin
       tmp := ReceivedAgreement.Text;
-      ms := TMemoryStream.Create;
-      ms.WriteBuffer(tmp[1], Length(tmp));
-      ms.Position := 0;
-      AgreementForm.RichEdit1.Lines.LoadFromStream(ms);
-      ms.Free;
+      AgreementForm.RichEdit1.BeginUpdate;
+      AgreementForm.RichEdit1.Clear;
+      AgreementForm.RichEdit1.InsertRTF(WideStringToUTF8(tmp));
+      AgreementForm.RichEdit1.EndUpdate;
       AgreementForm.ShowModal;
     end
     else if sl[0] = 'DENIED' then
@@ -4577,8 +4591,11 @@
             ProcessCommand('JOIN '+PageControl1.Pages[i].Caption,False);
         end;
 
+      // check new version
+      CheckNewVersion;
+
       AcquireMainThread;
-      try s := handlers.onLoggedIn(); except end;
+      try if not Preferences.DisableScripts then handlers.onLoggedIn(); except end;
       ReleaseMainThread;
     end
     else if sl[0] = 'REGISTRATIONACCEPTED' then
@@ -5379,7 +5396,7 @@
       else
       begin
         BattleForm.SetMyBattleStatus(BattleForm.MySideButton.Tag, False, team, ally, BoolToInt(not JoinAsSpectator));
-//        MyTeamColorIndex := color;   -&gt; not needed anymore, we should keep last used color anyway
+        MyTeamColorIndex := color;   //-&gt; not needed anymore, we should keep last used color anyway
       end;
 
       Status.BattleStatusRequestReceived := True;
@@ -5443,17 +5460,19 @@
         InitWaitForm.TakeAction := 0; // change mod
         InitWaitForm.ChangeToMod := Battle.ModName;
         InitWaitForm.ShowModal; // this changes mod (see OnFormActivate event)
+
+        if Preferences.DisplayUnitsIconsAndNames then
+        begin
           // now let's update units:
-        InitWaitForm.ChangeCaption(MSG_GETUNITS);
-        InitWaitForm.TakeAction := 1; // load unit lists
-        InitWaitForm.ShowModal; // this loads unit lists (see OnFormActivate event)
+          InitWaitForm.ChangeCaption(MSG_GETUNITS);
+          InitWaitForm.TakeAction := 1; // load unit lists
+          InitWaitForm.ShowModal; // this loads unit lists (see OnFormActivate event)
+        end;
         
         Status.Synced := GetModHash(Battle.ModName) = Battle.HashCode;
         if not Status.Synced then
           BattleForm.AddTextToChat('Your mod differs from the host''s one.',Colors.Error,1);
 
-        BattleForm.CheckMapSync;
-
         Status.Hashing := False;
 
         if Status.BattleStatusRequestReceived and not Status.BattleStatusRequestSent then
@@ -6908,7 +6927,7 @@
 begin;
   try
     AcquireMainThread;
-    try handlers.onDisconnect; except end;
+    try if not Preferences.DisableScripts then handlers.onDisconnect; except end;
     ReleaseMainThread;
     Socket.CloseDelayed; // we must call CloseDelayed and not just Close, because this method is called from various methods and events like OnDataAvailable!
     MainForm.MainTitleBar.Caption := PROGRAM_VERSION;
@@ -7049,16 +7068,19 @@
 
   AcquireMainThread;
   try
-    s := handlers.handleOut(s);
-    i := Pos(#13,s);
-    if i = 0 then
-      i := Pos(#10,s);
-    if i &gt; 0 then
-      s := LeftStr(s,i-1);
-    if s = '' then
+    if not Preferences.DisableScripts then
     begin
-      ReleaseMainThread;
-      exit;
+      s := handlers.handleOut(s);
+      i := Pos(#13,s);
+      if i = 0 then
+        i := Pos(#10,s);
+      if i &gt; 0 then
+        s := LeftStr(s,i-1);
+      if s = '' then
+      begin
+        ReleaseMainThread;
+        exit;
+      end;
     end;
   except
   end;
@@ -7106,7 +7128,7 @@
   userid: string;
 begin;
   AcquireMainThread;
-  try handlers.onLogin(); except end;
+  try if not Preferences.DisableScripts then handlers.onLogin(); except end;
   ReleaseMainThread;
 
   // let's send the login command:
@@ -7305,7 +7327,7 @@
   Status.CumulativeDataRecv := 0;
 
   AcquireMainThread;
-  try handlers.onConnected(); except end;
+  try if not Preferences.DisableScripts then handlers.onConnected(); except end;
   ReleaseMainThread;
 
   AddMainLog('Connection established to ' + Socket.Addr, Colors.Info);
@@ -7780,7 +7802,7 @@
 procedure TMainForm.FormClose(Sender: TObject; var Action: TCloseAction);
 begin
   AcquireMainThread;
-  try handlers.onClose; except end;
+  try if not Preferences.DisableScripts then handlers.onClose; except end;
   //ReleaseMainThread;
 
   if Debug.Log then ((PageControl1.Pages[0] as TMyTabSheet).Controls[1] as TExRichEdit).Lines.SaveToFile(ExtractFilePath(Application.ExeName) + LOG_FILENAME);
@@ -7798,7 +7820,7 @@
   HighlightingForm.SaveHighlightsToFile(ExtractFilePath(Application.ExeName) + VAR_FOLDER + '\highlights.dat');
   IgnoreListForm.SaveIgnoreListToFile(ExtractFilePath(Application.ExeName) + VAR_FOLDER + '\ignorelist.dat');
   SaveFiltersToFile(FILTERS_FOLDER + '\default.ini');
-  ReplaysForm.SaveReplayFiltersToFile;
+  ReplaysForm.SaveReplayFiltersToFile(REPLAY_FILTERS_FOLDER + '\default.ini');
   if not RunningUnderWine then
     MenuForm.SaveSettings;
   SaveGroups;
@@ -8491,33 +8513,46 @@
   (PageControl1.ActivePage as TMyTabSheet).AutoScroll := not (PageControl1.ActivePage as TMyTabSheet).AutoScroll;
 end;
 
-procedure TMainForm.AddNotification(HeaderText, MessageText: string; DisplayTime: Integer;OnClick: Boolean = false;BattleId: integer = -1);
-var
-  DA: TJvDesktopAlert;
+function TMainForm.MakeNotification(HeaderText, MessageText: string; DisplayTime: Integer; canClick: boolean): TJvDesktopAlert;
 begin
+  Result := TJvDesktopAlert.Create(Self);
+  Result.HeaderText := HeaderText;
+  Result.MessageText := MessageText;
+  if canClick then
+    Result.Options := [daoCanClose,daoCanClick]
+  else
+    Result.Options := [daoCanClose];
+  Result.Location.Position := dapBottomRight;
+  Result.StyleHandler.DisplayDuration := DisplayTime;
+  Result.Location.Width := 250;
+  Result.Location.Height := 70;
+  Result.AlertStyle := asFade;
+end;
+
+procedure TMainForm.ExecuteNotification(N: TJvDesktopAlert);
+begin
+  if mnuDisableNotifications.Checked then Exit;
   if Preferences.UseSoundNotifications then
     if not Preferences.DisableAllSounds then PlayResSound('notify');
   if (BattleState.Status &lt;&gt; None) and (Status.Me.GetInGameStatus) then
     Exit;
-  DA := TJvDesktopAlert.Create(Self);
-  DA.HeaderText := HeaderText;
-  DA.MessageText := MessageText;
-  if OnClick then
-    DA.Options := [daoCanClose,daoCanClick]
-  else
-    DA.Options := [daoCanClose];
+
   if displayingNotificationList.Count &gt;= MAX_POPUP then
     TJvDesktopAlert(displayingNotificationList.First).Close(True);
-  displayingNotificationList.Add(DA);
-  DA.Location.Position := dapBottomRight;
-  DA.StyleHandler.DisplayDuration := DisplayTime;
-  DA.Location.Width := 250;
-  DA.Location.Height := 70;
-  DA.AlertStyle := asFade;
+  displayingNotificationList.Add(N);
+  N.OnClose := NotificationClose; // removes itself from the displayingNotificationList
+
+  N.Execute;
+end;
+
+procedure TMainForm.AddNotification(HeaderText, MessageText: string; DisplayTime: Integer;OnClick: Boolean = false;BattleId: integer = -1);
+var
+  DA: TJvDesktopAlert;
+begin
+  DA := MakeNotification(HeaderText,MessageText,DisplayTime,OnClick);
   DA.OnMessageClick := NotificationClick;
-  DA.OnClose := NotificationClose;
   DA.Tag := BattleId;
-  DA.Execute;
+  ExecuteNotification(DA);
 end;
 
 procedure TMainForm.NotificationClose(Sender: TObject);
@@ -8716,6 +8751,13 @@
   Self.Clients.Destroy;
 end;
 
+procedure TClientGroup.GroupUpdated;
+begin
+  AcquireMainThread;
+  try if not Preferences.DisableScripts then handlers.onGroupsChanged(); except end;
+  ReleaseMainThread;
+end;
+
 procedure TMainForm.mnuManageGroupsClick(Sender: TObject);
 begin
   ManageGroupsForm.ShowModal;
@@ -8741,6 +8783,7 @@
     group.Clients.Add(SelectedUserName);
     ClientGroups.Add(group);
     RefreshClientSort;
+    group.GroupUpdated;
   end;
 end;
 
@@ -8758,6 +8801,7 @@
 
   TClientGroup(ClientGroups[(Sender as TSpTBXItem).Tag]).Clients.Add(SelectedUserName);
   RefreshClientSort;
+  TClientGroup(ClientGroups[(Sender as TSpTBXItem).Tag]).GroupUpdated;
 end;
 
 procedure TMainForm.RefreshClientSort;
@@ -8786,6 +8830,7 @@
   TClientGroup(ClientGroups[Client.GetGroup]).Clients.Delete(TClientGroup(ClientGroups[Client.GetGroup]).Clients.IndexOf(Client.Name));
   RefreshClientSort;
   MainForm.ClientsListBox.Refresh;
+  TClientGroup(ClientGroups[Client.GetGroup]).GroupUpdated;
 end;
 
 procedure TMainForm.SaveGroups;
@@ -8929,10 +8974,8 @@
 end;
 
 procedure TMainForm.CheckNewVersion;
-var
-  checkThread : TCheckNewBetaLobbyThread;
 begin
-  checkThread := TCheckNewBetaLobbyThread.Create(false,false);
+  TLobbyUpdateThread.Create(false,Preferences.AutoUpdateToBeta,True);
 end;
 
 constructor TLadder.Create(id: integer; Name: string);
@@ -9057,7 +9100,7 @@
   i:integer;
 begin
   // delete the custom away messages items
-  for i:= ConnectionPopupMenu.Items.Count -1 downto 6 do
+  for i:= ConnectionPopupMenu.Items.Count -1 downto 7 do
     ConnectionPopupMenu.Items.Delete(i);
 
   ConnectionPopupMenu.Items[0].Checked := Status.CurrentAwayItem = -2;
@@ -10199,18 +10242,22 @@
     BattleListPopupMenuInitPopup(nil,nil);
 end;
 
-constructor TCheckNewBetaLobbyThread.Create(Suspended: Boolean;hasLastVersionConfirmation: boolean);
+constructor TLobbyUpdateThread.Create(Suspended: Boolean;downloadBeta: boolean; autoUpdate: boolean; delayed : integer = 0);
 begin
    FreeOnTerminate := True;
    inherited Create(Suspended);
-   confirmation := hasLastVersionConfirmation;
+   dlBeta := downloadBeta;
+   autoUpdt := autoUpdate;
+   delay := delayed;
 end;
 
-procedure TCheckNewBetaLobbyThread.Execute;
+procedure TLobbyUpdateThread.Execute;
 var
   html : string;
   parsedHtml: TStringList;
 begin
+  Sleep(delay);
+  if HttpGetForm.Visible then Exit;
   if FileExists(Application.ExeName + '.old') then
     DeleteFile(Application.ExeName + '.old');
   with MainForm do
@@ -10230,7 +10277,8 @@
     try
       HttpCli1.Get;
     except
-      MainForm.AddMainLog('Warning: Lobby auto update server unavailable.', Colors.Normal);
+      MainForm.AddMainLog('Warning: Lobby update server unavailable.', Colors.Normal);
+      autoUpdateDone := True;
       Exit;
     end;
     try
@@ -10243,16 +10291,15 @@
       if parsedHtml.Count &lt;&gt; 2 then
         RaiseException(0,0,0,0);
 
-      if Preferences.AutoUpdateToBeta or confirmation  then
+      if dlBeta  then
         Misc.ParseDelimited(parsedHtml,parsedHtml[0],' ','')
       else
         Misc.ParseDelimited(parsedHtml,parsedHtml[1],' ','');
 
       if StrToInt(parsedHtml[0]) &gt; Misc.GetLobbyRevision then
       begin
-        if not confirmation or (MessageDlgThread(StringReplace(MakeSentence(parsedHtml,2),'\n',EOL,[rfReplaceAll]),mtInformation,[mbYes,mbNo],0) = mrYes) then
+        if (autoUpdt and dlBeta) or (MessageDlgThread(StringReplace(MakeSentence(parsedHtml,2),'\n',EOL,[rfReplaceAll]),mtInformation,[mbYes,mbNo],0) = mrYes) then
         begin
-          //Misc.OpenURLInDefaultBrowser(parsedHtml[1]);
             DownloadFile.URL := parsedHtml[1];
             DownloadFile.FileName := '_AutoUpdateTempFile.7z';
             DownloadFile.ServerOptions := 4;
@@ -10260,10 +10307,11 @@
         end;
       end
       else
-        if confirmation then
+        if not autoUpdt then
           MessageDlgThread('Your lobby version is up to date.',mtInformation,[mbOk],0);
     except
       MainForm.AddMainLog('Warning: Auto-update file broken.', Colors.Normal);
+      autoUpdateDone := True;
       Exit;
     end;
   end;
@@ -10298,10 +10346,8 @@
 end;
 
 procedure TMainForm.mnuForceLobbyUpdateCheckClick(Sender: TObject);
-var
-  checkThread: TCheckNewBetaLobbyThread;
 begin
-  checkThread := TCheckNewBetaLobbyThread.Create(false,true);
+  TLobbyUpdateThread.Create(false,True,False);
 end;
 
 procedure TMainForm.ClientsListBoxExit(Sender: TObject);
@@ -10502,6 +10548,11 @@
 
 procedure TMainForm.SinglePlayerButtonClick(Sender: TObject);
 begin
+  //if MessageDlg('Do you want to launch another instance in Single Player mode, otherwise it will disconnect and swi',mtConfirmation,[mbYes,mbNo],0) = mrNo then Exit;
+
+  ShellExecute(0,'open',PChar(Application.ExeName),'-menu',PChar(ExtractFileName(Application.ExeName)),SW_SHOWNORMAL);
+  Exit;
+
   TryToDisconnect;
   MainForm.Hide;
   MenuForm.Show;
@@ -10527,6 +10578,8 @@
       LobbyScriptUnit.MsgList := TStringList.Create;
       LobbyScriptUnit.RichEditList := TList.Create;
       LobbyScriptUnit.MsgColor := TIntegerList.Create;
+      LobbyScriptUnit.NotificationTempList := TList.Create;
+      LobbyScriptUnit.ScriptsInitialized := True;
 
       handlers._load;
 
@@ -10558,8 +10611,25 @@
 
 procedure TMainForm.lobbyscriptWrapperInitialization(Sender: TObject);
 begin
+  if Preferences.DisableScripts then Exit;
   lobbyscriptWrapper.RegisterDelphiWrapper(TPyCallback);
   lobbyscriptWrapper.RegisterDelphiWrapper(TPyGUI);
 end;
 
+procedure TMainForm.initFiltersPresets;
+begin
+  FiltersTabs.ActiveTabIndex := 0;
+  FilterGroup.Height := 0;
+  Filters.TextFilters := TList.Create;
+  LoadFiltersFromFile(FILTERS_FOLDER + '\default.ini');
+  UpdateFilters;
+  PresetListbox.Selected[0] := true;
+  LoadPresets;
+end;
+
+procedure TMainForm.Button1Click(Sender: TObject);
+begin
+  MakePath('c:\test1\test2\test3');
+end;
+
 end.

Modified: branches/0.77-branch/Lobby/TASClient/ManageGroups.dfm
===================================================================
--- branches/0.77-branch/Lobby/TASClient/ManageGroups.dfm	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/Lobby/TASClient/ManageGroups.dfm	2008-08-20 14:38:09 UTC (rev 6278)
@@ -16,6 +16,7 @@
   OldCreateOrder = False
   Position = poScreenCenter
   Scaled = False
+  OnClose = FormClose
   OnCreate = FormCreate
   OnShow = FormShow
   PixelsPerInch = 96

Modified: branches/0.77-branch/Lobby/TASClient/ManageGroups.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/ManageGroups.pas	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/Lobby/TASClient/ManageGroups.pas	2008-08-20 14:38:09 UTC (rev 6278)
@@ -54,6 +54,7 @@
     procedure FormCreate(Sender: TObject);
     procedure HighlightBattlesCheckboxClick(Sender: TObject);
     procedure btAddPlayerClick(Sender: TObject);
+    procedure FormClose(Sender: TObject; var Action: TCloseAction);
   private
     { Private declarations }
   public
@@ -65,7 +66,7 @@
 
 implementation
 
-uses ColorPicker;
+uses ColorPicker, LobbyScriptUnit;
 
 {$R *.dfm}
 
@@ -223,4 +224,12 @@
   end;
 end;
 
+procedure TManageGroupsForm.FormClose(Sender: TObject;
+  var Action: TCloseAction);
+begin
+  AcquireMainThread;
+  try handlers.onGroupsChanged(); except end;
+  ReleaseMainThread;
+end;
+
 end.

Modified: branches/0.77-branch/Lobby/TASClient/MenuFormUnit.dfm
===================================================================
--- branches/0.77-branch/Lobby/TASClient/MenuFormUnit.dfm	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/Lobby/TASClient/MenuFormUnit.dfm	2008-08-20 14:38:09 UTC (rev 6278)
@@ -1,6 +1,6 @@
 object MenuForm: TMenuForm
-  Left = 843
-  Top = 129
+  Left = 987
+  Top = 299
   BorderStyle = bsNone
   Caption = 'MenuForm'
   ClientHeight = 671

Modified: branches/0.77-branch/Lobby/TASClient/MenuFormUnit.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/MenuFormUnit.pas	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/Lobby/TASClient/MenuFormUnit.pas	2008-08-20 14:38:09 UTC (rev 6278)
@@ -127,6 +127,8 @@
       ExitCode: LongWord;
     end;
 
+    MenuLoaded: Boolean;
+
     procedure SaveIERegistry;
     function LoadMapListHtmlCode: string;
     function GetLuaHtmlCode(options: TList): String;
@@ -218,6 +220,7 @@
   CurrentCampaignMission.descriptor := TTDFParser.Create('');
   BrowseHistory := TStack.Create;
   skinList := TStringList.Create;
+  MenuLoaded := False;
 
   GetColorValues(ColorCallBack);
 
@@ -532,6 +535,7 @@
   end;
   if (pageType = Skirmish) then // [AILIST]
   begin
+
     varHtmlCode := '';
     templateStr := ReadFile2(CurrentPath+'aiItem.html');
     for i := 0 to AddBotForm.AIComboBox.Items.Count-1 do
@@ -770,6 +774,13 @@
 
 procedure TMenuForm.FormShow(Sender: TObject);
 begin
+  if not MenuLoaded then
+  begin
+    MessageDlg('An error occured during the Single Player skin loading. Program will now exit ...',mtError,[mbOk],0);
+    Application.Terminate;
+    Exit;
+  end;
+
   tmrMusic.Enabled := true;
   SaveIERegistry;
   springExeVersion := Utility.AcquireSpringVersion;
@@ -1002,7 +1013,10 @@
       end;
 
       TeamAllyCounter.Items[TAIItem(AIPlayerList[i]^).Team] := TeamAllyCounter.Items[TAIItem(AIPlayerList[i]^).Team]+1;
-      script.AddOrChangeKeyValue('GAME/TEAM'+IntToStr(i+1)+'/AIDLL',AIDLL_FOLDER + '/'+ TAIItem(AIPlayerList[i]^).AIType);
+      if (Length(TAIItem(AIPlayerList[i]^).AIType) &gt; 6) and (LeftStr(TAIItem(AIPlayerList[i]^).AIType,6) = 'LuaAI:') then
+        script.AddOrChangeKeyValue('GAME/TEAM'+IntToStr(i+1)+'/AIDLL',TAIItem(AIPlayerList[i]^).AIType)
+      else
+        script.AddOrChangeKeyValue('GAME/TEAM'+IntToStr(i+1)+'/AIDLL',AIDLL_FOLDER + '/'+ TAIItem(AIPlayerList[i]^).AIType);
     end
     else
       script.AddOrChangeKeyValue('GAME/TEAM0/AIDLL',AIDLL_FOLDER + '/'+ TAIItem(AIPlayerList[i]^).AIType);
@@ -1096,6 +1110,8 @@
   // disable the click sound
   Misc.SetRegistryData(HKEY_CURRENT_USER,'AppEvents\Schemes\Apps\Explorer\Navigating\.Current','',rdExpandString,'');
 
+  URL := URLDecode(URL);
+
   if Pos('lobby:',URL) &lt;&gt; 0 then
     command := MidStr(URL,Pos('lobby:',URL)+6,99999);
   if command &lt;&gt; '' then
@@ -1327,6 +1343,9 @@
       BattleForm.ChangeCurrentMod(Utility.ModList[tmp]);
       Utility.ReloadUnitList;
 
+      // reload bot list
+      AddBotForm.ReloadButtonClick(nil);
+
       MePlayer.Side := 0;
       for i:=0 to AIPlayerList.Count-1 do
         TAIItem(AIPlayerList[i]^).Side := 0;
@@ -1945,12 +1964,20 @@
   try MP2.Stop; except end;
   try MP2.Close; except end;
 
+  if not FileExists(SPSKIN_FOLDER + '\' + skinFile) then
+  begin
+    MessageDlg('Single Player skin file '''+SPSKIN_FOLDER + '\' + skinFile+''' not found.',mtWarning,[mbOK],0);
+    MenuLoaded := False;
+    Exit;
+  end;
+
   DelTree(GetEnvironmentVariable('TEMP')+'\tasclientgui\');
   SevenZip1.SZFileName := SPSKIN_FOLDER + '\' + skinFile;
   SevenZip1.ExtrBaseDir := GetEnvironmentVariable('TEMP')+'\tasclientgui';
   SevenZip1.Extract(false);
 
   Preferences.SPSkin := skinFile;
+  MenuLoaded := True;
 end;
 
 end.

Modified: branches/0.77-branch/Lobby/TASClient/Misc.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/Misc.pas	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/Lobby/TASClient/Misc.pas	2008-08-20 14:38:09 UTC (rev 6278)
@@ -130,12 +130,15 @@
 function VariantToString(AVar: OleVariant): string;
 function GetLongPathNameA(lpFileName:LPCTSTR;lpBuffer:LPTSTR;nBufferLength:DWORD): integer;stdcall; external 'Kernel32.dll';
 function  GetLongPathName(FileName: string): string;
-Function DelTree(DirName : string): Boolean;
+Function DelTree(DirName : string): LongInt;
 Function CopyTree(DirFrom : string; DirTo : string): LongInt;
 Function MoveTree(DirFrom : string; DirTo : string): LongInt;
 Function BitmapFlip(Const Vertical : Boolean;Const Horizontal : Boolean;var BitmapIn : TBitmap;out BitmapOut : TBitmap): Boolean;
 function ExtractFileNameFromUrl(url: string): string;
 function GetLobbyRevision: integer;
+procedure MakePath(Path: string);
+function URLDecode(const S: string): string;
+function URLEncode(const S: string; const InQueryString: Boolean): string;
 
 implementation
 
@@ -1962,26 +1965,35 @@
     else showmessage('IncorrectPath');
 end;
 
-Function DelTree(DirName : string): Boolean;
+Function DelTree(DirName : string): LongInt;
 var
-  SHFileOpStruct : TSHFileOpStruct;
+  SearchRec :TSearchRec;
 begin
-  if RightStr(DirName,1) = '\' then
-    DirName := LeftStr(DirName,Length(DirName)-1);
-  try
-   Fillchar(SHFileOpStruct,Sizeof(SHFileOpStruct),0) ;
-   with SHFileOpStruct do begin
-    Wnd := 0;
-    pFrom := PChar(DirName);
-    wFunc := FO_DELETE;
-    //fFlags := FOF_ALLOWUNDO;  // add to the recycle bin instead of deleting
-    fFlags := FOF_NOCONFIRMATION;
-    fFlags := fFlags or FOF_SILENT;
-   end;
-    Result := (SHFileOperation(SHFileOpStruct) = 0) ;
-   except
-    Result := False;
-  end;
+    if RightStr(DirName,1) = '\' then
+      DirName := LeftStr(DirName,Length(DirName)-1);
+
+    Result := FindFirst(DirName+'\*.*', faAnyFile , SearchRec);
+    while Result = 0 do
+    begin
+      if not(SearchRec.name[1]='.') then
+      begin
+       if (SearchRec.attr and faDirectory) &lt;&gt; 0 then
+        begin
+            DelTree(DirName +'\' + SearchRec.name);
+        end
+        else
+        begin
+          try
+            DeleteFile(DirName+'\'+SearchRec.name);
+          except
+          end;
+        end;
+      end; //if . ..
+      Result := FindNext(SearchRec);
+    end;
+    FindClose(SearchRec);
+
+    try RmDir(DirName); except end;
 end;
 
 Function CopyTree(DirFrom : string; DirTo : string): LongInt;
@@ -1992,6 +2004,8 @@
       DirFrom := LeftStr(DirFrom,Length(DirFrom)-1);
     if RightStr(DirTo,1) = '\' then
       DirTo := LeftStr(DirTo,Length(DirTo)-1);
+    MakePath(DirTo);
+
     Result := FindFirst(DirFrom+'\*.*', faAnyFile , SearchRec);
     while Result = 0 do
     begin
@@ -2013,6 +2027,7 @@
       end; //if . ..
       Result := FindNext(SearchRec);
     end;
+    FindClose(SearchRec);
 end;
 
 Function MoveTree(DirFrom : string; DirTo : string): LongInt;
@@ -2023,6 +2038,8 @@
       DirFrom := LeftStr(DirFrom,Length(DirFrom)-1);
     if RightStr(DirTo,1) = '\' then
       DirTo := LeftStr(DirTo,Length(DirTo)-1);
+    MakePath(DirTo);
+    
     Result := FindFirst(DirFrom+'\*.*', faAnyFile , SearchRec);
     while Result = 0 do
     begin
@@ -2044,6 +2061,7 @@
       end; //if . ..
       Result := FindNext(SearchRec);
     end;
+    FindClose(SearchRec);
 end;
 
 Function BitmapFlip(Const Vertical : Boolean;Const Horizontal : Boolean;var BitmapIn : TBitmap;out BitmapOut : TBitmap): Boolean;
@@ -2131,5 +2149,90 @@
   End;
 end;
 
+procedure MakePath(Path: string);
+var
+  dirList: TStringList;
+  dirTemp: string;
+  i: integer;
+begin
+  dirList := TStringList.Create;
 
+  ParseDelimited(dirList,Path,'\','');
+  dirTemp := dirList[0];
+
+  for i:=1 to dirList.Count-1 do
+  begin
+    dirTemp := dirTemp + '\' + dirList[i];
+    if not DirectoryExists(dirTemp) then
+      MkDir(dirTemp);
+  end;
+end;
+
+function URLDecode(const S: string): string;
+var
+  Idx: Integer;   // loops thru chars in string
+  Hex: string;    // string of hex characters
+  Code: Integer;  // hex character code (-1 on error)
+begin
+  // Intialise result and string index
+  Result := '';
+  Idx := 1;
+  // Loop thru string decoding each character
+  while Idx &lt;= Length(S) do
+  begin
+    case S[Idx] of
+      '%':
+      begin
+        // % should be followed by two hex digits - exception otherwise
+        if Idx &lt;= Length(S) - 2 then
+        begin
+          // there are sufficient digits - try to decode hex digits
+          Hex := S[Idx+1] + S[Idx+2];
+          Code := SysUtils.StrToIntDef('$' + Hex, -1);
+          Inc(Idx, 2);
+        end
+        else
+          // insufficient digits - error
+          Code := -1;
+        // check for error and raise exception if found
+        if Code = -1 then
+          raise SysUtils.EConvertError.Create(
+            'Invalid hex digit in URL'
+          );
+        // decoded OK - add character to result
+        Result := Result + Chr(Code);
+      end;
+      '+':
+        // + is decoded as a space
+        Result := Result + ' '
+      else
+        // All other characters pass thru unchanged
+        Result := Result + S[Idx];
+    end;
+    Inc(Idx);
+  end;
+end;
+
+
+function URLEncode(const S: string; const InQueryString: Boolean): string;
+var
+  Idx: Integer; // loops thru characters in string
+begin
+  Result := '';
+  for Idx := 1 to Length(S) do
+  begin
+    case S[Idx] of
+      'A'..'Z', 'a'..'z', '0'..'9', '-', '_', '.':
+        Result := Result + S[Idx];
+      ' ':
+        if InQueryString then
+          Result := Result + '+'
+        else
+          Result := Result + '%20';
+      else
+        Result := Result + '%' + SysUtils.IntToHex(Ord(S[Idx]), 2);
+    end;
+  end;
+end;
+
 end.

Modified: branches/0.77-branch/Lobby/TASClient/NotificationsUnit.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/NotificationsUnit.pas	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/Lobby/TASClient/NotificationsUnit.pas	2008-08-20 14:38:09 UTC (rev 6278)
@@ -227,7 +227,7 @@
         nfModHosted:
         begin
           if sl.Count &lt;&gt; 1 then Exit;
-          if UpperCase(sl[0]) &lt;&gt; UpperCase(Name1) then Continue;
+          if Pos(UpperCase(sl[0]),UpperCase(Name1)) = 0 then Continue;
           // else:
           Result := True;
           Exit;

Modified: branches/0.77-branch/Lobby/TASClient/PreferencesFormUnit.dfm
===================================================================
--- branches/0.77-branch/Lobby/TASClient/PreferencesFormUnit.dfm	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/Lobby/TASClient/PreferencesFormUnit.dfm	2008-08-20 14:38:09 UTC (rev 6278)
@@ -1,6 +1,6 @@
 object PreferencesForm: TPreferencesForm
-  Left = 775
-  Top = 122
+  Left = 1147
+  Top = 228
   BorderStyle = bsDialog
   Caption = 'Preferences'
   ClientHeight = 392
@@ -69,117 +69,6 @@
         Checked = True
         CustomWidth = 56
       end
-      object SpTBXTabSheet6: TSpTBXTabSheet
-        Left = 0
-        Top = 23
-        Width = 401
-        Height = 282
-        Caption = 'Server'
-        ImageIndex = -1
-        TabItem = 'SpTBXTabItem6'
-        object GroupBox1: TSpTBXGroupBox
-          Left = 16
-          Top = 8
-          Width = 369
-          Height = 257
-          Caption = 'Server settings'
-          Color = clNone
-          ParentColor = False
-          TabOrder = 0
-          object Label1: TSpTBXLabel
-            Left = 16
-            Top = 32
-            Width = 74
-            Height = 13
-            Caption = 'Server address:'
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
-          object Label2: TSpTBXLabel
-            Left = 16
-            Top = 56
-            Width = 55
-            Height = 13
-            Caption = 'Server port:'
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
-          object ServerPortEdit: TSpTBXEdit
-            Left = 96
-            Top = 56
-            Width = 41
-            Height = 21
-            TabOrder = 1
-            Text = '8200'
-          end
-          object CheckBox10: TSpTBXCheckBox
-            Left = 16
-            Top = 128
-            Width = 197
-            Height = 15
-            Caption = 'Connect to backup host if primary fails'
-            TabOrder = 2
-            Checked = True
-            State = cbChecked
-          end
-          object CheckBox2: TSpTBXCheckBox
-            Left = 16
-            Top = 144
-            Width = 108
-            Height = 15
-            Caption = 'Connect on startup'
-            TabOrder = 3
-          end
-          object CheckBox7: TSpTBXCheckBox
-            Left = 16
-            Top = 160
-            Width = 226
-            Height = 15
-            Caption = 'Join #main once connected (recommended)'
-            TabOrder = 4
-          end
-          object ServerAddressEdit: TSpTBXButtonEdit
-            Left = 96
-            Top = 32
-            Width = 249
-            Height = 21
-            TabOrder = 0
-            EditButton.Left = 225
-            EditButton.Top = 0
-            EditButton.Width = 20
-            EditButton.Height = 17
-            EditButton.Caption = '...'
-            EditButton.Align = alRight
-            EditButton.DropDownArrow = False
-            EditButton.DropDownMenu = AddressPopupMenu
-            EditButton.LinkFont.Charset = DEFAULT_CHARSET
-            EditButton.LinkFont.Color = clBlue
-            EditButton.LinkFont.Height = -11
-            EditButton.LinkFont.Name = 'MS Sans Serif'
-            EditButton.LinkFont.Style = [fsUnderline]
-          end
-          object JvXPButton1: TSpTBXButton
-            Left = 272
-            Top = 56
-            Width = 73
-            Height = 21
-            Caption = 'Perform ...'
-            TabOrder = 7
-            OnClick = JvXPButton1Click
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
-        end
-      end
       object SpTBXTabSheet5: TSpTBXTabSheet
         Left = 0
         Top = 23
@@ -302,6 +191,208 @@
           end
         end
       end
+      object SpTBXTabSheet2: TSpTBXTabSheet
+        Left = 0
+        Top = 23
+        Width = 401
+        Height = 282
+        Caption = 'HTTP'
+        ImageIndex = -1
+        TabItem = 'SpTBXTabItem2'
+        object GroupBox6: TSpTBXGroupBox
+          Left = 16
+          Top = 8
+          Width = 369
+          Height = 257
+          Caption = 'Proxy settings'
+          Color = clNone
+          ParentColor = False
+          TabOrder = 0
+          object UseProxyCheckBox: TSpTBXCheckBox
+            Left = 24
+            Top = 32
+            Width = 65
+            Height = 15
+            Caption = 'Use proxy'
+            TabOrder = 0
+            OnClick = UseProxyCheckBoxClick
+            Checked = True
+            State = cbChecked
+          end
+          object ProxyPanel: TSpTBXPanel
+            Left = 24
+            Top = 56
+            Width = 321
+            Height = 113
+            Caption = 'ProxyPanel'
+            Color = clNone
+            ParentColor = False
+            TabOrder = 1
+            object ProxyEdit: TSpTBXEdit
+              Left = 64
+              Top = 8
+              Width = 241
+              Height = 21
+              TabOrder = 0
+            end
+            object Label7: TSpTBXLabel
+              Left = 8
+              Top = 8
+              Width = 41
+              Height = 13
+              Caption = 'Address:'
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object Label8: TSpTBXLabel
+              Left = 8
+              Top = 32
+              Width = 22
+              Height = 13
+              Caption = 'Port:'
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object JvProxyPortEdit: TJvValidateEdit
+              Left = 64
+              Top = 32
+              Width = 49
+              Height = 21
+              Alignment = taLeftJustify
+              CriticalPoints.MaxValueIncluded = False
+              CriticalPoints.MinValueIncluded = False
+              EditText = '0'
+              TabOrder = 3
+            end
+            object ProxyUserEdit: TSpTBXEdit
+              Left = 64
+              Top = 56
+              Width = 121
+              Height = 21
+              TabOrder = 4
+            end
+            object Label9: TSpTBXLabel
+              Left = 8
+              Top = 56
+              Width = 51
+              Height = 13
+              Caption = 'Username:'
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object Label10: TSpTBXLabel
+              Left = 8
+              Top = 80
+              Width = 49
+              Height = 13
+              Caption = 'Password:'
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object ProxyPassEdit: TSpTBXEdit
+              Left = 64
+              Top = 80
+              Width = 121
+              Height = 21
+              TabOrder = 7
+            end
+          end
+        end
+      end
+      object SpTBXTabSheet1: TSpTBXTabSheet
+        Left = 0
+        Top = 23
+        Width = 401
+        Height = 282
+        Caption = 'Skins'
+        ImageIndex = -1
+        TabItem = 'SpTBXTabItem1'
+        object GroupBox5: TSpTBXGroupBox
+          Left = 16
+          Top = 8
+          Width = 361
+          Height = 257
+          Caption = 'Skin manager'
+          Color = clNone
+          ParentColor = False
+          TabOrder = 0
+          object ThemesComboBox: TSpTBXComboBox
+            Left = 48
+            Top = 144
+            Width = 177
+            Height = 21
+            Style = csDropDownList
+            ItemHeight = 13
+            TabOrder = 0
+            OnChange = ThemesComboBoxChange
+          end
+          object SpTBXRadioButton1: TSpTBXRadioButton
+            Left = 48
+            Top = 56
+            Width = 44
+            Height = 15
+            Caption = 'None'
+            TabOrder = 1
+            TabStop = True
+            OnClick = SpTBXRadioButton1Click
+            Checked = True
+          end
+          object SpTBXRadioButton2: TSpTBXRadioButton
+            Left = 48
+            Top = 72
+            Width = 62
+            Height = 15
+            Caption = 'Windows'
+            TabOrder = 2
+            OnClick = SpTBXRadioButton2Click
+          end
+          object Label3: TSpTBXLabel
+            Left = 32
+            Top = 120
+            Width = 85
+            Height = 13
+            Caption = 'Choose TBX skin:'
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
+          end
+          object SpTBXRadioButton3: TSpTBXRadioButton
+            Left = 48
+            Top = 88
+            Width = 76
+            Height = 15
+            Caption = 'TBX themes'
+            TabOrder = 4
+            OnClick = SpTBXRadioButton3Click
+          end
+          object Label11: TSpTBXLabel
+            Left = 32
+            Top = 32
+            Width = 60
+            Height = 13
+            Caption = 'Theme style:'
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
+          end
+        end
+      end
       object SpTBXTabSheet4: TSpTBXTabSheet
         Left = 0
         Top = 23
@@ -491,6 +582,14 @@
             LinkFont.Name = 'MS Sans Serif'
             LinkFont.Style = [fsUnderline]
           end
+          object EnableSpringDownloaderCheckBox: TSpTBXCheckBox
+            Left = 16
+            Top = 184
+            Width = 144
+            Height = 15
+            Caption = 'Enable Spring Downloader'
+            TabOrder = 15
+          end
         end
       end
       object SpTBXTabSheet3: TSpTBXTabSheet
@@ -585,7 +684,7 @@
             TabOrder = 7
           end
           object UploadReplayCheckBox: TSpTBXCheckBox
-            Left = 24
+            Left = 312
             Top = 232
             Width = 245
             Height = 15
@@ -646,202 +745,119 @@
             ThumbLength = 10
             OnChange = ChatLogsLimitTrackerChange
           end
-        end
-      end
-      object SpTBXTabSheet2: TSpTBXTabSheet
-        Left = 0
-        Top = 23
-        Width = 401
-        Height = 282
-        Caption = 'HTTP'
-        ImageIndex = -1
-        TabItem = 'SpTBXTabItem2'
-        object GroupBox6: TSpTBXGroupBox
-          Left = 16
-          Top = 8
-          Width = 369
-          Height = 257
-          Caption = 'Proxy settings'
-          Color = clNone
-          ParentColor = False
-          TabOrder = 0
-          object UseProxyCheckBox: TSpTBXCheckBox
+          object DisplayUnitsIconsAndNamesCheckBox: TSpTBXCheckBox
             Left = 24
-            Top = 32
-            Width = 65
+            Top = 232
+            Width = 251
             Height = 15
-            Caption = 'Use proxy'
-            TabOrder = 0
-            OnClick = UseProxyCheckBoxClick
-            Checked = True
-            State = cbChecked
+            Caption = 'Load units icons and names when joining (slower)'
+            TabOrder = 15
           end
-          object ProxyPanel: TSpTBXPanel
-            Left = 24
-            Top = 56
-            Width = 321
-            Height = 113
-            Caption = 'ProxyPanel'
-            Color = clNone
-            ParentColor = False
-            TabOrder = 1
-            object ProxyEdit: TSpTBXEdit
-              Left = 64
-              Top = 8
-              Width = 241
-              Height = 21
-              TabOrder = 0
-            end
-            object Label7: TSpTBXLabel
-              Left = 8
-              Top = 8
-              Width = 41
-              Height = 13
-              Caption = 'Address:'
-              LinkFont.Charset = DEFAULT_CHARSET
-              LinkFont.Color = clBlue
-              LinkFont.Height = -11
-              LinkFont.Name = 'MS Sans Serif'
-              LinkFont.Style = [fsUnderline]
-            end
-            object Label8: TSpTBXLabel
-              Left = 8
-              Top = 32
-              Width = 22
-              Height = 13
-              Caption = 'Port:'
-              LinkFont.Charset = DEFAULT_CHARSET
-              LinkFont.Color = clBlue
-              LinkFont.Height = -11
-              LinkFont.Name = 'MS Sans Serif'
-              LinkFont.Style = [fsUnderline]
-            end
-            object JvProxyPortEdit: TJvValidateEdit
-              Left = 64
-              Top = 32
-              Width = 49
-              Height = 21
-              Alignment = taLeftJustify
-              CriticalPoints.MaxValueIncluded = False
-              CriticalPoints.MinValueIncluded = False
-              EditText = '0'
-              TabOrder = 3
-            end
-            object ProxyUserEdit: TSpTBXEdit
-              Left = 64
-              Top = 56
-              Width = 121
-              Height = 21
-              TabOrder = 4
-            end
-            object Label9: TSpTBXLabel
-              Left = 8
-              Top = 56
-              Width = 51
-              Height = 13
-              Caption = 'Username:'
-              LinkFont.Charset = DEFAULT_CHARSET
-              LinkFont.Color = clBlue
-              LinkFont.Height = -11
-              LinkFont.Name = 'MS Sans Serif'
-              LinkFont.Style = [fsUnderline]
-            end
-            object Label10: TSpTBXLabel
-              Left = 8
-              Top = 80
-              Width = 49
-              Height = 13
-              Caption = 'Password:'
-              LinkFont.Charset = DEFAULT_CHARSET
-              LinkFont.Color = clBlue
-              LinkFont.Height = -11
-              LinkFont.Name = 'MS Sans Serif'
-              LinkFont.Style = [fsUnderline]
-            end
-            object ProxyPassEdit: TSpTBXEdit
-              Left = 64
-              Top = 80
-              Width = 121
-              Height = 21
-              TabOrder = 7
-            end
-          end
         end
       end
-      object SpTBXTabSheet1: TSpTBXTabSheet
+      object SpTBXTabSheet6: TSpTBXTabSheet
         Left = 0
         Top = 23
         Width = 401
         Height = 282
-        Caption = 'Skins'
+        Caption = 'Server'
         ImageIndex = -1
-        TabItem = 'SpTBXTabItem1'
-        object GroupBox5: TSpTBXGroupBox
+        TabItem = 'SpTBXTabItem6'
+        object GroupBox1: TSpTBXGroupBox
           Left = 16
           Top = 8
-          Width = 361
+          Width = 369
           Height = 257
-          Caption = 'Skin manager'
+          Caption = 'Server settings'
           Color = clNone
           ParentColor = False
           TabOrder = 0
-          object ThemesComboBox: TSpTBXComboBox
-            Left = 48
-            Top = 144
-            Width = 177
-            Height = 21
-            Style = csDropDownList
-            ItemHeight = 13
-            TabOrder = 0
-            OnChange = ThemesComboBoxChange
+          object Label1: TSpTBXLabel
+            Left = 16
+            Top = 32
+            Width = 74
+            Height = 13
+            Caption = 'Server address:'
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
           end
-          object SpTBXRadioButton1: TSpTBXRadioButton
-            Left = 48
+          object Label2: TSpTBXLabel
+            Left = 16
             Top = 56
-            Width = 44
-            Height = 15
-            Caption = 'None'
-            TabOrder = 1
-            TabStop = True
-            OnClick = SpTBXRadioButton1Click
-            Checked = True
-          end
-          object SpTBXRadioButton2: TSpTBXRadioButton
-            Left = 48
-            Top = 72
-            Width = 62
-            Height = 15
-            Caption = 'Windows'
-            TabOrder = 2
-            OnClick = SpTBXRadioButton2Click
-          end
-          object Label3: TSpTBXLabel
-            Left = 32
-            Top = 120
-            Width = 85
+            Width = 55
             Height = 13
-            Caption = 'Choose TBX skin:'
+            Caption = 'Server port:'
             LinkFont.Charset = DEFAULT_CHARSET
             LinkFont.Color = clBlue
             LinkFont.Height = -11
             LinkFont.Name = 'MS Sans Serif'
             LinkFont.Style = [fsUnderline]
           end
-          object SpTBXRadioButton3: TSpTBXRadioButton
-            Left = 48
-            Top = 88
-            Width = 76
+          object ServerPortEdit: TSpTBXEdit
+            Left = 96
+            Top = 56
+            Width = 41
+            Height = 21
+            TabOrder = 1
+            Text = '8200'
+          end
+          object CheckBox10: TSpTBXCheckBox
+            Left = 16
+            Top = 128
+            Width = 197
             Height = 15
-            Caption = 'TBX themes'
+            Caption = 'Connect to backup host if primary fails'
+            TabOrder = 2
+            Checked = True
+            State = cbChecked
+          end
+          object CheckBox2: TSpTBXCheckBox
+            Left = 16
+            Top = 144
+            Width = 108
+            Height = 15
+            Caption = 'Connect on startup'
+            TabOrder = 3
+          end
+          object CheckBox7: TSpTBXCheckBox
+            Left = 16
+            Top = 160
+            Width = 226
+            Height = 15
+            Caption = 'Join #main once connected (recommended)'
             TabOrder = 4
-            OnClick = SpTBXRadioButton3Click
           end
-          object Label11: TSpTBXLabel
-            Left = 32
+          object ServerAddressEdit: TSpTBXButtonEdit
+            Left = 96
             Top = 32
-            Width = 60
-            Height = 13
-            Caption = 'Theme style:'
+            Width = 249
+            Height = 21
+            TabOrder = 0
+            EditButton.Left = 225
+            EditButton.Top = 0
+            EditButton.Width = 20
+            EditButton.Height = 17
+            EditButton.Caption = '...'
+            EditButton.Align = alRight
+            EditButton.DropDownArrow = False
+            EditButton.DropDownMenu = AddressPopupMenu
+            EditButton.LinkFont.Charset = DEFAULT_CHARSET
+            EditButton.LinkFont.Color = clBlue
+            EditButton.LinkFont.Height = -11
+            EditButton.LinkFont.Name = 'MS Sans Serif'
+            EditButton.LinkFont.Style = [fsUnderline]
+          end
+          object JvXPButton1: TSpTBXButton
+            Left = 272
+            Top = 56
+            Width = 73
+            Height = 21
+            Caption = 'Perform ...'
+            TabOrder = 7
+            OnClick = JvXPButton1Click
             LinkFont.Charset = DEFAULT_CHARSET
             LinkFont.Color = clBlue
             LinkFont.Height = -11
@@ -859,8 +875,8 @@
         ImageIndex = -1
         TabItem = 'SpTBXTabItem7'
         object ScriptsDebugWindowBt: TSpTBXButton
-          Left = 136
-          Top = 32
+          Left = 132
+          Top = 56
           Width = 137
           Height = 25
           Caption = 'Debug Window'
@@ -873,8 +889,8 @@
           LinkFont.Style = [fsUnderline]
         end
         object ScriptsReloadBt: TSpTBXButton
-          Left = 136
-          Top = 64
+          Left = 132
+          Top = 88
           Width = 137
           Height = 25
           Caption = 'Reload scripts'
@@ -887,8 +903,8 @@
           LinkFont.Style = [fsUnderline]
         end
         object ScriptsLoadNewBt: TSpTBXButton
-          Left = 136
-          Top = 96
+          Left = 132
+          Top = 120
           Width = 137
           Height = 25
           Caption = 'Load new scripts'
@@ -901,12 +917,13 @@
           LinkFont.Style = [fsUnderline]
         end
         object ScriptsAdvancedOptionsBt: TSpTBXButton
-          Left = 136
-          Top = 128
+          Left = 132
+          Top = 152
           Width = 137
           Height = 25
           Caption = 'Advanced options'
           TabOrder = 3
+          Visible = False
           OnClick = ScriptsAdvancedOptionsBtClick
           LinkFont.Charset = DEFAULT_CHARSET
           LinkFont.Color = clBlue
@@ -914,6 +931,14 @@
           LinkFont.Name = 'MS Sans Serif'
           LinkFont.Style = [fsUnderline]
         end
+        object EnableScriptsCheckBox: TSpTBXCheckBox
+          Left = 104
+          Top = 24
+          Width = 193
+          Height = 15
+          Caption = 'Enable scripts BETA (requires restart)'
+          TabOrder = 4
+        end
       end
     end
     object ApplyAndCloseButton: TSpTBXButton
@@ -947,8 +972,8 @@
     end
   end
   object AddressPopupMenu: TSpTBXPopupMenu
-    Left = 340
-    Top = 56
+    Left = 372
+    Top = 88
   end
   object HttpCli1: THttpCli
     LocalAddr = '0.0.0.0'

Modified: branches/0.77-branch/Lobby/TASClient/PreferencesFormUnit.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/PreferencesFormUnit.pas	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/Lobby/TASClient/PreferencesFormUnit.pas	2008-08-20 14:38:09 UTC (rev 6278)
@@ -50,6 +50,7 @@
     UseSoundNotifications: Boolean;
     AutoCompletionFromCurrentChannel: Boolean;
     AutoUpdateToBeta: Boolean;
+    DisplayUnitsIconsAndNames: Boolean;
 
     UseProxy: Boolean;
     ProxyAddress: string;
@@ -78,7 +79,10 @@
 
     SPSkin: string;
 
-    DisableScripts: Boolean;
+    DisableScripts: Boolean; // can only be changed at start
+    EnableScripts: Boolean;
+
+    EnableSpringDownloader: Boolean;
   end;
 
   TPreferencesForm = class(TForm)
@@ -175,6 +179,9 @@
     ScriptsReloadBt: TSpTBXButton;
     ScriptsLoadNewBt: TSpTBXButton;
     ScriptsAdvancedOptionsBt: TSpTBXButton;
+    DisplayUnitsIconsAndNamesCheckBox: TSpTBXCheckBox;
+    EnableScriptsCheckBox: TSpTBXCheckBox;
+    EnableSpringDownloaderCheckBox: TSpTBXCheckBox;
 
     function BattleSortStyleToColumn(SortStyle: Integer): Integer;
     function ColumnToBattleSortStyle(Column: Integer): Integer;
@@ -226,7 +233,7 @@
   private
     { Private declarations }
   public
-    { Public declarations }
+    procedure PopulateServerListMenu;
   end;
 
   TServerListItem =
@@ -271,7 +278,7 @@
   end;
 
 const
-  DEFAULT_PREFERENCES: TPreferences = (ServerIP:'taspringmaster.clan-sy.com'; ServerPort:'8200'; TabStyle:0; TimeStamps: True; Username:''; Password:''; ConnectOnStartup: False; SortStyle: 1; BattleSortStyle: 1; BattleSortDirection: 0; BattleClientSortStyle: 2;FilterJoinLeftMessages: False;FilterBattleJoinLeftMessages: False; ShowFlags: True; MarkUnknownMaps: False; TaskbarButtons: True; JoinMainChannel: True; ReconnectToBackup: True; SaveLogs: True; UseSoundNotifications: True;AutoCompletionFromCurrentChannel: False; AutoUpdateToBeta: False; UseProxy: False; HighlightColor: 'Green'; UseNotificationsForHighlights: True; UseIgnoreList: False; WarnIfUsingNATTraversing: True; AutoFocusOnPM: True; MapSortStyle: 1; ThemeType: thtTBX; Theme: 'Miranda'; DisableAllSounds: False; SortLocal: False; DisplayQuickJoinPanel : True; LimitChatLogs: False; ChatLogsLimit: 800; SPSkin: 'default.ssk'; DisableScripts : False);
+  DEFAULT_PREFERENCES: TPreferences = (ServerIP:'taspringmaster.clan-sy.com'; ServerPort:'8200'; TabStyle:0; TimeStamps: True; Username:''; Password:''; ConnectOnStartup: False; SortStyle: 1; BattleSortStyle: 1; BattleSortDirection: 0; BattleClientSortStyle: 2;FilterJoinLeftMessages: False;FilterBattleJoinLeftMessages: False; ShowFlags: True; MarkUnknownMaps: False; TaskbarButtons: True; JoinMainChannel: True; ReconnectToBackup: True; SaveLogs: True; UseSoundNotifications: True;AutoCompletionFromCurrentChannel: False; AutoUpdateToBeta: False;DisplayUnitsIconsAndNames: False; UseProxy: False; HighlightColor: 'Green'; UseNotificationsForHighlights: True; UseIgnoreList: False; WarnIfUsingNATTraversing: True; AutoFocusOnPM: True; MapSortStyle: 1; ThemeType: thtTBX; Theme: 'Miranda'; DisableAllSounds: False; SortLocal: False; DisplayQuickJoinPanel : True; LimitChatLogs: False; ChatLogsLimit: 800; SPSkin: 'default.ssk'; DisableScripts : True; EnableScripts : False; EnableSpringDow
 nloader : True);
 
 var
   PreferencesForm: TPreferencesForm;
@@ -283,14 +290,7 @@
   SaveToRegOnExit: Boolean = True; // should we save preferences to registry on exit?
   PasswordChanged: Boolean = False; // has the user changed the password ? if yes it must be crypted before being saved
 
-  ServerList: array[0..3] of TServerListItem = (
-    (Name: 'Official host (taspringmaster.clan-sy.com)'; Address: 'taspringmaster.clan-sy.com'),
-//    (Name: 'Backup host (fnord.clan-sy.com)'; Address: 'fnord.clan-sy.com'),
-//    (Name: 'Test/backup server (filehamster.net)'; Address: 'filehamster.net'),
-    (Name: 'Test/Backup server (buildbot.no-ip.org)'; Address: 'buildbot.no-ip.org'),
-    (Name: 'Test/backup server #2 (taspringmaster.servegame.com)'; Address: 'taspringmaster.servegame.com'),
-    (Name: 'Local server (localhost)'; Address: 'localhost')
-  );
+  ServerList: array of TServerListItem;
 
   // note: you shouldn't change order of sort styles or certain parts of code may not work anymore! (e.g.: when we receive MAPGRADES command, we sort map list only if sorting style is set to &quot;sort by global grade&quot;)
   MapSortStyleDescriptions: array[0..4] of string = (
@@ -306,7 +306,8 @@
 uses Misc, ShellAPI, Registry, BattleFormUnit, HostBattleFormUnit, Math,
   OnlineMapsUnit, NotificationsUnit, PerformFormUnit, HighlightingUnit,
   NewAccountUnit, IgnoreListUnit, MapListFormUnit, ColorsPreferenceUnit,
-  ManageGroups, ReplaysUnit, PythonScriptDebugFormUnit, LobbyScriptUnit;
+  ManageGroups, ReplaysUnit, PythonScriptDebugFormUnit, LobbyScriptUnit,
+  SpringDownloaderFormUnit;
 
 {$R *.dfm}
 
@@ -332,6 +333,7 @@
     try Preferences.FilterBattleJoinLeftMessages := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'FilterBattleJoinLeftMessages'); except end;
     try Preferences.AutoCompletionFromCurrentChannel := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'AutoCompletionFromCurrentChannel'); except end;
     try Preferences.ShowFlags := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'ShowFlags'); except end;
+    try Preferences.DisplayUnitsIconsAndNames := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'DisplayUnitsIconsAndNames'); except end;
     try Preferences.MarkUnknownMaps := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'MarkUnknownMapsNMods'); except end;
     try Preferences.TaskbarButtons := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'TaskbarButtons'); except end;
     try Preferences.JoinMainChannel := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'JoinMainChannel'); except end;
@@ -346,6 +348,7 @@
     try Preferences.HighlightColor:= Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'HighlightColor'); except end;
     try Preferences.UseNotificationsForHighlights := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'UseNotificationsForHighlights'); except end;
     try Preferences.AutoUpdateToBeta := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'CheckForNewVersion'); except end;
+    try Preferences.EnableSpringDownloader := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'EnableSpringDownloader'); except end;
     try Preferences.UseIgnoreList := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'UseIgnoreList'); except end;
     try Preferences.WarnIfUsingNATTraversing := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'WarnIfUsingNATTraversing'); except end;
     try Preferences.AutoFocusOnPM := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'AutoFocusOnPM'); except end;
@@ -357,6 +360,10 @@
     try Preferences.SortLocal := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'SortLocal'); except end;
     try Preferences.UploadReplay := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'AskUploadReplay'); except end;
     try Preferences.DisplayQuickJoinPanel := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'DisplayQuickJoinPanel'); except end;
+    try
+      Preferences.EnableScripts := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'EnableScripts');
+      Preferences.DisableScripts := not Preferences.EnableScripts;
+    except end;
     try Preferences.LimitChatLogs := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'LimitChatLogs'); except end;
     try
       Preferences.ChatLogsLimit := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'ChatLogsLimit');
@@ -401,6 +408,7 @@
     try MainForm.PageControl1.Height := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\MainForm', 'Splitter2'); except end;
     try MainForm.EnableFilters.Checked := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\MainForm', 'EnableFilters'); except end;
     try MainForm.FiltersTabs.ActiveTabIndex := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\MainForm', 'FiltersActiveTab'); except end;
+    try ReplaysForm.FiltersTabs.ActiveTabIndex := Misc.GetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\MainForm', 'ReplayFiltersActiveTab'); except end;
 
     with MainForm.VDTBattles.Header.Columns do
       for i := 0 to Count-1 do
@@ -505,6 +513,8 @@
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\MainForm', 'Splitter2', rdInteger, MainForm.PageControl1.Height);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\MainForm', 'EnableFilters', rdInteger, Misc.BoolToInt(MainForm.EnableFilters.Checked));
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\MainForm', 'FiltersActiveTab', rdInteger, MainForm.FiltersTabs.ActiveTabIndex);
+    Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Forms\MainForm', 'ReplayFiltersActiveTab', rdInteger, ReplaysForm.FiltersTabs.ActiveTabIndex);
+
     with MainForm.VDTBattles.Header.Columns do
       for i := 0 to Count-1 do
       begin
@@ -602,6 +612,7 @@
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'FilterBattleJoinLeftMessages', rdInteger, Misc.BoolToInt(Preferences.FilterBattleJoinLeftMessages));
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'AutoCompletionFromCurrentChannel', rdInteger, Misc.BoolToInt(Preferences.AutoCompletionFromCurrentChannel));
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'ShowFlags', rdInteger, Misc.BoolToInt(Preferences.ShowFlags));
+    Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'DisplayUnitsIconsAndNames', rdInteger, Misc.BoolToInt(Preferences.DisplayUnitsIconsAndNames));
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'MarkUnknownMapsNMods', rdInteger, Misc.BoolToInt(Preferences.MarkUnknownMaps));
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'TaskbarButtons', rdInteger, Misc.BoolToInt(Preferences.TaskbarButtons));
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'JoinMainChannel', rdInteger, Misc.BoolToInt(Preferences.JoinMainChannel));
@@ -616,6 +627,7 @@
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'HighlightColor', rdString, Preferences.HighlightColor);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'UseNotificationsForHighlights', rdInteger, Preferences.UseNotificationsForHighlights);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'CheckForNewVersion', rdInteger, Misc.BoolToInt(Preferences.AutoUpdateToBeta));
+    Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'EnableSpringDownloader', rdInteger, Misc.BoolToInt(Preferences.EnableSpringDownloader));
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'UseIgnoreList', rdInteger, Preferences.UseIgnoreList);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'WarnIfUsingNATTraversing', rdInteger, Preferences.WarnIfUsingNATTraversing);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'AutoFocusOnPM', rdInteger, Preferences.AutoFocusOnPM);
@@ -629,6 +641,7 @@
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'FontName', rdString, CommonFont.Name);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'FontSize', rdInteger, CommonFont.Size);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'DisplayQuickJoinPanel', rdInteger, Preferences.DisplayQuickJoinPanel);
+    Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'EnableScripts', rdInteger, Preferences.EnableScripts);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'LimitChatLogs', rdInteger, Preferences.LimitChatLogs);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'ChatLogsLimit', rdInteger, Preferences.ChatLogsLimit);
     Misc.SetRegistryData(HKEY_CURRENT_USER, '\Software\TASClient\Preferences', 'SPSkin', rdString, Preferences.SPSkin);
@@ -788,6 +801,7 @@
   p.FilterJoinLeftMessages := CheckBox3.Checked;
   p.FilterBattleJoinLeftMessages := FilterBattleJoinLeftCheckBox.Checked;
   p.ShowFlags := CheckBox4.Checked;
+  p.DisplayUnitsIconsAndNames := DisplayUnitsIconsAndNamesCheckBox.Checked;
   p.MarkUnknownMaps := CheckBox5.Checked;
   p.TaskbarButtons := CheckBox6.Checked;
   p.JoinMainChannel := CheckBox7.Checked;
@@ -797,6 +811,7 @@
   p.UseSoundNotifications := CheckBox9.Checked;
   p.AutoCompletionFromCurrentChannel := AutoCompletionCurrentChannelCheckBox.Checked;
   p.AutoUpdateToBeta := CheckForNewVersionCheckBox.Checked;
+  p.EnableSpringDownloader := EnableSpringDownloaderCheckBox.Checked;
 
   p.UseProxy := UseProxyCheckBox.Checked;
   p.ProxyAddress := ProxyEdit.Text;
@@ -821,6 +836,8 @@
   p.LimitChatLogs := ChatLogsLimitCheckBox.Checked;
   p.ChatLogsLimit := ChatLogsLimitTracker.Position;
 
+  p.EnableScripts := EnableScriptsCheckBox.Checked;
+
   // there is no need to set p.ThemeType or p.Theme here since those are directly updated to Preferences when we change them in GUI at runtime
 
   // update changes:
@@ -858,6 +875,7 @@
   CheckBox3.Checked := p.FilterJoinLeftMessages;
   FilterBattleJoinLeftCheckBox.Checked := p.FilterBattleJoinLeftMessages;
   CheckBox4.Checked := p.ShowFlags;
+  DisplayUnitsIconsAndNamesCheckBox.Checked := p.DisplayUnitsIconsAndNames;
   CheckBox5.Checked := p.MarkUnknownMaps;
   CheckBox6.Checked := p.TaskbarButtons;
   CheckBox7.Checked := p.JoinMainChannel;
@@ -866,6 +884,7 @@
   CheckBox9.Checked := p.UseSoundNotifications;
   AutoCompletionCurrentChannelCheckBox.Checked := p.AutoCompletionFromCurrentChannel;
   CheckForNewVersionCheckBox.Checked := p.AutoUpdateToBeta;
+  EnableSpringDownloaderCheckBox.Checked := p.EnableSpringDownloader;
 
   UseProxyCheckBox.Checked := p.UseProxy;
   ProxyEdit.Text := p.ProxyAddress;
@@ -888,6 +907,8 @@
   DisplayQuickJoinPanelCheckBox.Checked := p.DisplayQuickJoinPanel;
   MainForm.QuickJoinPanel.Visible := p.DisplayQuickJoinPanel;
 
+  EnableScriptsCheckBox.Checked := p.EnableScripts;
+
   ChatLogsLimitCheckBox.Checked := p.LimitChatLogs;
   ChatLogsLimitTracker.Position := p.ChatLogsLimit;
   ChatLogsLimitTrackerChange(nil);
@@ -903,16 +924,11 @@
   ThemesComboBox.ItemIndex := ThemesComboBox.Items.AnsiStrings.IndexOf(p.Theme);
 end;
 
-procedure TPreferencesForm.FormCreate(Sender: TObject);
+procedure TPreferencesForm.PopulateServerListMenu;
 var
-  i: Integer;
+  i: integer;
 begin
-  if not SpTBXTitleBar1.Active then
-    RemoveSpTBXTitleBarMarges(self);
-
-  SpTBXTabControl1.ActiveTabIndex := 0;
-
-  // let's populate popup menu with server descriptions:
+  AddressPopupMenu.Items.Clear;
   for i := 0 to High(ServerList) do
   begin
     AddressPopupMenu.Items.Add(TSpTBXItem.Create(AddressPopupMenu.Items.Owner));
@@ -923,7 +939,32 @@
       OnClick := AddressPopupMenuItemClick;
     end;
   end;
+end;
 
+procedure TPreferencesForm.FormCreate(Sender: TObject);
+begin
+  if not SpTBXTitleBar1.Active then
+    RemoveSpTBXTitleBarMarges(self);
+
+  SpTBXTabControl1.ActiveTabIndex := 0;
+
+  SetLength(ServerList,4);
+
+  ServerList[0].Name := 'Official host (taspringmaster.clan-sy.com)';
+  ServerList[0].Address := 'taspringmaster.clan-sy.com';
+
+  ServerList[1].Name := 'Test/Backup server (buildbot.no-ip.org)';
+  ServerList[1].Address := 'buildbot.no-ip.org';
+
+  ServerList[2].Name := 'Test/backup server #2 (taspringmaster.servegame.com)';
+  ServerList[2].Address := 'taspringmaster.servegame.com';
+
+  ServerList[3].Name := 'Local server (localhost)';
+  ServerList[3].Address := 'localhost';
+
+
+  PopulateServerListMenu;
+
   // let's populate TBX themes:
   GetAvailableTBXThemes(ThemesComboBox.Items.AnsiStrings);
   // we will change theme and set ThemeType-s after initilization
@@ -942,6 +983,8 @@
 
 procedure TPreferencesForm.FormClose(Sender: TObject;
   var Action: TCloseAction);
+var
+  oldPref : TPreferences;
 begin
   ActiveControl := ApplyAndCloseButton;
   { Wonder why we need ActiveControl := ApplyAndCloseButton ? We need it in this case: if focus was on
@@ -957,10 +1000,19 @@
 
   if SaveOnClose then
   begin
+    oldPref := Preferences;
     UpdatePreferencesTo(Preferences); // save changes to p
     UpdatePreferencesFrom(Preferences); // update changes from p
     if Preferences.SortLocal then
       MainForm.RefreshClientSort;
+    if Preferences.EnableSpringDownloader &lt;&gt; oldPref.EnableSpringDownloader then
+      if Preferences.EnableSpringDownloader then
+        StartSpringDownloader
+      else
+        CloseSpringDownloader;
+    AcquireMainThread;
+    try if not Preferences.DisableScripts then handlers.onSettingsChanged(); except end;
+    ReleaseMainThread;
   end
   else
   begin
@@ -1422,14 +1474,14 @@
 procedure TPreferencesForm.ScriptsReloadBtClick(Sender: TObject);
 begin
   AcquireMainThread;
-  try handlers._reloadall; except end;
+  try if not Preferences.DisableScripts then handlers._reloadall; except end;
   ReleaseMainThread;
 end;
 
 procedure TPreferencesForm.ScriptsLoadNewBtClick(Sender: TObject);
 begin
   AcquireMainThread;
-  try handlers._load; except end;
+  try if not Preferences.DisableScripts then handlers._load; except end;
   ReleaseMainThread;
 end;
 
@@ -1441,7 +1493,7 @@
 procedure TPreferencesForm.ScriptsAdvancedOptionsBtClick(Sender: TObject);
 begin
   AcquireMainThread;
-  try handlers.showOptions; except end;
+  try if not Preferences.DisableScripts then handlers.showOptions; except end;
   ReleaseMainThread;
 end;
 

Modified: branches/0.77-branch/Lobby/TASClient/Python/api.txt
===================================================================
--- branches/0.77-branch/Lobby/TASClient/Python/api.txt	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/Lobby/TASClient/Python/api.txt	2008-08-20 14:38:09 UTC (rev 6278)
@@ -7,6 +7,8 @@
 - ExitLobby
 - GetBattles
 - GetGroups
+- SetGroups(dict)
+	The group 'Users' can be a User dict with user names as keys (like the one returned by GetGroups), or a user name list.
 - GetMaps
 - GetMods
 - GetMyUser
@@ -27,6 +29,8 @@
 - LeaveBattle
 - StartBattle
 - GetCurrentBattle
+- GetServers
+- SetServers(dict)
 
 Callin :
 
@@ -38,12 +42,23 @@
 - onLogin
 - onConnected
 - onClose
+- onSettingsChanged
+- onGroupsChanged
+- onMapsReloaded
+- onReplaysReloaded
+- onModsReloaded
 
 
 
 GUI Class
 ---------
 
+callin :
+
+- onSettingsChanged
+- onGroupsChanged
+- onMenuPopup(menuName)
+
 callout :
 
 menuName = [HostBattle, Help, HelpWiki, HelpDownload, BattleItem (returning the BattleId), PlayerItem (Returning the Player Name), PlayerItemModeration (Returning the Player Name), BattlePlayerItem (Returning the Player Name), BattleMinimap, BattleAdmin, BattleAdminBalance, BattleAdminRankLimit, BattleLadder, ReplayItem (Returning the Replay index)] 
@@ -54,6 +69,9 @@
 - AddSeparatorToMenu(menuName/SubmenuId) return SeparatorId
 - RemoveFromMenu(id)
 	Id can be an itemId or a SubmenuId or a SeparatorId.
+- DisplayNotification(title, msg, argsTuple, onClickModuleName, onClickFunctionName, displayTime)
+- DisplaySimpleNotification(title, msg, displayTime)
+	displayTime in ms
 
 
 
@@ -62,8 +80,6 @@
 
 callout :
 
-- SetGroups
-- SetServerList
 - SetColors ?
 - GetFilters 
 - GetPresetList

Modified: branches/0.77-branch/Lobby/TASClient/Python/engine/handlers.py
===================================================================
--- branches/0.77-branch/Lobby/TASClient/Python/engine/handlers.py	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/Lobby/TASClient/Python/engine/handlers.py	2008-08-20 14:38:09 UTC (rev 6278)
@@ -202,6 +202,21 @@
 def onLoggedIn():
 	_handle_callin('onLoggedIn')
 	
+def onSettingsChanged():
+	_handle_callin('onSettingsChanged')
+	
+def onGroupsChanged():
+	_handle_callin('onGroupsChanged')
+	
+def onMapsReloaded():
+	_handle_callin('onMapsReloaded')
+	
+def onReplaysReloaded():
+	_handle_callin('onReplaysReloaded')
+	
+def onModsReloaded():
+	_handle_callin('onModsReloaded')
+	
 def handleCommand(cmd):
 	spaces = cmd.count(' ')
 	if spaces &gt;= 1:

Modified: branches/0.77-branch/Lobby/TASClient/Python/scripts/stick.py
===================================================================
--- branches/0.77-branch/Lobby/TASClient/Python/scripts/stick.py	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/Lobby/TASClient/Python/scripts/stick.py	2008-08-20 14:38:09 UTC (rev 6278)
@@ -52,9 +52,11 @@
 # exit stick mode if the sticked user left
 def in_REMOVEUSER(nick):
   global stickingNick
+  global menuUnstickId
   if nick == stickingNick:
     stickingNick = ''
     api.AddToTextBox('$current','Exiting stick mode ('+nick+' left).',colors['Info'])
+    gui.RemoveFromMenu(menuUnstickId)
 
 
 # we're joining a battle and we start waiting for 2 in_CLIENTBATTLESTATUS 

Modified: branches/0.77-branch/Lobby/TASClient/PythonScriptDebugFormUnit.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/PythonScriptDebugFormUnit.pas	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/Lobby/TASClient/PythonScriptDebugFormUnit.pas	2008-08-20 14:38:09 UTC (rev 6278)
@@ -32,7 +32,7 @@
 
 implementation
 
-uses LobbyScriptUnit;
+uses LobbyScriptUnit, PreferencesFormUnit;
 
 {$R *.dfm}
 
@@ -62,7 +62,7 @@
 procedure TPythonScriptDebugForm.btLoadNewScriptsClick(Sender: TObject);
 begin
   MainForm.PyEngine.PyEval_AcquireThread(LobbyScriptUnit.MainThreadState);
-  try handlers._load; except end;
+  try if not Preferences.DisableScripts then handlers._load; except end;
   MainForm.PyEngine.PyEval_ReleaseThread(LobbyScriptUnit.MainThreadState);
 end;
 

Modified: branches/0.77-branch/Lobby/TASClient/ReplaysUnit.dfm
===================================================================
--- branches/0.77-branch/Lobby/TASClient/ReplaysUnit.dfm	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/Lobby/TASClient/ReplaysUnit.dfm	2008-08-20 14:38:09 UTC (rev 6278)
@@ -1,6 +1,6 @@
 object ReplaysForm: TReplaysForm
-  Left = 954
-  Top = 181
+  Left = 609
+  Top = 235
   Width = 809
   Height = 640
   Caption = 'Replays'
@@ -32,9 +32,9 @@
       613)
     object VDTReplays: TVirtualDrawTree
       Left = 4
-      Top = 262
+      Top = 270
       Width = 793
-      Height = 106
+      Height = 98
       Align = alClient
       BevelInner = bvNone
       BevelOuter = bvNone
@@ -173,11 +173,10 @@
         Height = 193
         Anchors = [akLeft, akTop, akRight, akBottom]
         Color = clBtnFace
-        ActiveTabIndex = 0
+        ActiveTabIndex = 3
         HiddenItems = &lt;&gt;
         object PlayersTab: TSpTBXTabItem
           Caption = 'Players'
-          Checked = True
         end
         object SpTBXTabItem3: TSpTBXTabItem
           Caption = 'Game settings'
@@ -187,27 +186,8 @@
         end
         object SpTBXTabItem1: TSpTBXTabItem
           Caption = 'Script'
+          Checked = True
         end
-        object SpTBXTabSheet1: TSpTBXTabSheet
-          Left = 0
-          Top = 23
-          Width = 686
-          Height = 170
-          Caption = 'Script'
-          ImageIndex = -1
-          TabItem = 'SpTBXTabItem1'
-          object ScriptRichEdit: TRichEdit
-            Left = 2
-            Top = 0
-            Width = 682
-            Height = 168
-            Align = alClient
-            ReadOnly = True
-            ScrollBars = ssBoth
-            TabOrder = 0
-            WordWrap = False
-          end
-        end
         object SpTBXTabSheet2: TSpTBXTabSheet
           Left = 0
           Top = 23
@@ -493,6 +473,26 @@
               end&gt;
           end
         end
+        object SpTBXTabSheet1: TSpTBXTabSheet
+          Left = 0
+          Top = 23
+          Width = 686
+          Height = 170
+          Caption = 'Script'
+          ImageIndex = -1
+          TabItem = 'SpTBXTabItem1'
+          object ScriptRichEdit: TRichEdit
+            Left = 2
+            Top = 0
+            Width = 682
+            Height = 168
+            Align = alClient
+            ReadOnly = True
+            ScrollBars = ssBoth
+            TabOrder = 0
+            WordWrap = False
+          end
+        end
       end
       object HostReplayButton: TSpTBXButton
         Left = 635
@@ -655,13 +655,16 @@
       Left = 4
       Top = 30
       Width = 793
-      Height = 232
+      Height = 240
       Align = alTop
       BevelOuter = bvNone
       TabOrder = 5
+      DesignSize = (
+        793
+        240)
       object FiltersButton: TSpTBXButton
         Left = 0
-        Top = 220
+        Top = 228
         Width = 793
         Height = 12
         Align = alBottom
@@ -675,576 +678,693 @@
         LinkFont.Name = 'MS Sans Serif'
         LinkFont.Style = [fsUnderline]
       end
-      object frmFilters: TSpTBXGroupBox
+      object FiltersTabs: TSpTBXTabControl
         Left = 0
         Top = 0
         Width = 793
-        Height = 219
-        Caption = 'Filters'
+        Height = 225
         Align = alTop
-        TabOrder = 1
-        OnResize = frmFiltersResize
-        TBXStyleBackground = True
-        object SpTBXGroupBox3: TSpTBXGroupBox
-          Left = 432
-          Top = 16
-          Width = 161
-          Height = 73
-          Caption = 'Start position'
-          TabOrder = 0
-          TBXStyleBackground = True
-          object chkFilterFixed: TSpTBXCheckBox
-            Left = 8
-            Top = 16
-            Width = 43
-            Height = 15
-            Caption = 'Fixed'
-            TabOrder = 0
-            OnClick = chkFilterFixedClick
-            Checked = True
-            State = cbChecked
-          end
-          object chkFilterRandom: TSpTBXCheckBox
-            Left = 8
-            Top = 32
-            Width = 58
-            Height = 15
-            Caption = 'Random'
-            TabOrder = 1
-            OnClick = chkFilterRandomClick
-            Checked = True
-            State = cbChecked
-          end
-          object chkFilterChooseInGame: TSpTBXCheckBox
-            Left = 8
-            Top = 48
-            Width = 94
-            Height = 15
-            Caption = 'Choose in game'
-            TabOrder = 2
-            OnClick = chkFilterChooseInGameClick
-            Checked = True
-            State = cbChecked
-          end
+        Color = clBtnFace
+        ActiveTabIndex = 0
+        HiddenItems = &lt;&gt;
+        object FiltersTab: TSpTBXTabItem
+          Caption = 'Filters'
+          Checked = True
         end
-        object SpTBXGroupBox4: TSpTBXGroupBox
-          Left = 8
-          Top = 16
-          Width = 241
-          Height = 89
-          Caption = 'Game end condition'
-          TabOrder = 1
-          TBXStyleBackground = True
-          object chkFilterGameContinues: TSpTBXCheckBox
+        object PresetsTab: TSpTBXTabItem
+          Caption = 'Presets'
+        end
+        object SpTBXTabSheet6: TSpTBXTabSheet
+          Left = 0
+          Top = 23
+          Width = 793
+          Height = 202
+          Caption = 'Presets'
+          ImageIndex = -1
+          DesignSize = (
+            793
+            202)
+          TabItem = 'PresetsTab'
+          object SpTBXGroupBox2: TSpTBXGroupBox
             Left = 8
-            Top = 24
-            Width = 183
-            Height = 15
-            Caption = 'Game continues if commander dies'
-            TabOrder = 0
-            OnClick = chkFilterGameContinuesClick
-            Checked = True
-            State = cbChecked
-          end
-          object chkFilterComEnd: TSpTBXCheckBox
-            Left = 8
-            Top = 40
-            Width = 160
-            Height = 15
-            Caption = 'Game ends if commander dies'
-            TabOrder = 1
-            OnClick = chkFilterComEndClick
-            Checked = True
-            State = cbChecked
-          end
-          object chkFilterLineage: TSpTBXCheckBox
-            Left = 8
-            Top = 56
-            Width = 85
-            Height = 15
-            Caption = 'Lineage mode'
-            TabOrder = 2
-            OnClick = chkFilterLineageClick
-            Checked = True
-            State = cbChecked
-          end
-        end
-        object SpTBXPanel1: TSpTBXPanel
-          Left = 8
-          Top = 118
-          Width = 241
-          Height = 66
-          Caption = 'SpTBXPanel1'
-          TabOrder = 2
-          TBXStyleBackground = True
-          object chkFilterLimitDGunFilter: TSpTBXCheckBox
-            Left = 11
             Top = 8
-            Width = 46
-            Height = 15
-            Caption = 'Filter :'
+            Width = 137
+            Height = 185
+            Caption = 'Options'
             TabOrder = 0
-            OnClick = chkFilterLimitDGunFilterClick
+            object btDeletePreset: TSpTBXButton
+              Left = 8
+              Top = 72
+              Width = 121
+              Height = 25
+              Caption = 'Delete'
+              TabOrder = 1
+              OnClick = btDeletePresetClick
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object btSavePreset: TSpTBXButton
+              Left = 8
+              Top = 40
+              Width = 121
+              Height = 25
+              Caption = 'Save'
+              TabOrder = 2
+              OnClick = btSavePresetClick
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object PresetNameTextbox: TSpTBXEdit
+              Left = 8
+              Top = 18
+              Width = 121
+              Height = 21
+              TabOrder = 3
+              Text = 'Preset name'
+            end
+            object btClearPreset: TSpTBXButton
+              Left = 8
+              Top = 96
+              Width = 121
+              Height = 25
+              Caption = 'Clear'
+              TabOrder = 0
+              OnClick = btClearPresetClick
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
           end
-          object chkFilterGhostedFilter: TSpTBXCheckBox
-            Left = 11
-            Top = 24
-            Width = 46
-            Height = 15
-            Caption = 'Filter :'
-            TabOrder = 1
-            OnClick = chkFilterGhostedFilterClick
-          end
-          object chkFilterDiminishingFilter: TSpTBXCheckBox
-            Left = 11
-            Top = 40
-            Width = 46
-            Height = 15
-            Caption = 'Filter :'
-            TabOrder = 2
-            OnClick = chkFilterDiminishingFilterClick
-          end
-          object chkFilterGhosted: TSpTBXCheckBox
-            Left = 65
-            Top = 24
-            Width = 102
-            Height = 15
-            Caption = 'Ghosted buildings'
-            TabOrder = 3
-            OnClick = chkFilterGhostedClick
-          end
-          object chkFilterLimitDGun: TSpTBXCheckBox
-            Left = 65
+          object SpTBXLabel5: TSpTBXLabel
+            Left = 152
             Top = 8
-            Width = 128
-            Height = 15
-            Caption = 'Limit D-Gun to start pos'
-            TabOrder = 4
-            OnClick = chkFilterLimitDGunClick
-          end
-          object chkFilterDiminishing: TSpTBXCheckBox
-            Left = 65
-            Top = 40
-            Width = 166
-            Height = 15
-            Caption = 'Diminishing metal maker returns'
-            TabOrder = 5
-            OnClick = chkFilterDiminishingClick
-          end
-        end
-        object SpTBXGroupBox5: TSpTBXGroupBox
-          Left = 256
-          Top = 22
-          Width = 169
-          Height = 187
-          TabOrder = 3
-          TBXStyleBackground = True
-          object chkFilterMetal: TSpTBXCheckBox
-            Left = 8
-            Top = 10
-            Width = 68
-            Height = 15
-            Caption = 'Start metal'
-            TabOrder = 0
-            OnClick = chkFilterMetalClick
-          end
-          object chkFilterEnergy: TSpTBXCheckBox
-            Left = 8
-            Top = 34
-            Width = 75
-            Height = 15
-            Caption = 'Start energy'
-            TabOrder = 1
-            OnClick = chkFilterEnergyClick
-          end
-          object chkFilterUnits: TSpTBXCheckBox
-            Left = 8
-            Top = 58
-            Width = 63
-            Height = 15
-            Caption = 'Max units'
-            TabOrder = 2
-            OnClick = chkFilterUnitsClick
-          end
-          object btFilterUnits: TSpTBXButton
-            Left = 88
-            Top = 56
-            Width = 17
-            Height = 20
-            Caption = '&gt;'
-            TabOrder = 3
-            OnClick = btFilterUnitsClick
+            Width = 64
+            Height = 16
+            Caption = 'Preset list :'
+            Font.Charset = DEFAULT_CHARSET
+            Font.Color = clWindowText
+            Font.Height = -13
+            Font.Name = 'MS Sans Serif'
+            Font.Style = []
+            ParentFont = False
             LinkFont.Charset = DEFAULT_CHARSET
             LinkFont.Color = clBlue
             LinkFont.Height = -11
             LinkFont.Name = 'MS Sans Serif'
             LinkFont.Style = [fsUnderline]
           end
-          object btFilterEnergy: TSpTBXButton
-            Left = 88
-            Top = 32
-            Width = 17
-            Height = 20
-            Caption = '&gt;'
-            TabOrder = 4
-            OnClick = btFilterEnergyClick
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
+          object PresetListbox: TSpTBXListBox
+            Left = 152
+            Top = 26
+            Width = 633
+            Height = 167
+            Anchors = [akLeft, akTop, akRight]
+            ItemHeight = 16
+            Items.Strings = (
+              'default')
+            TabOrder = 2
+            OnClick = PresetListboxClick
           end
-          object btFilterMetal: TSpTBXButton
-            Left = 88
-            Top = 8
-            Width = 17
-            Height = 20
-            Caption = '&gt;'
-            TabOrder = 5
-            OnClick = btFilterMetalClick
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
-          object speFilterMetal: TJvSpinEdit
-            Left = 104
-            Top = 8
-            Width = 57
-            Height = 20
-            ButtonKind = bkStandard
-            MaxValue = 10000.000000000000000000
-            Value = 5000.000000000000000000
-            TabOrder = 6
-            OnChange = speFilterMetalChange
-          end
-          object speFilterEnergy: TJvSpinEdit
-            Left = 104
-            Top = 32
-            Width = 57
-            Height = 20
-            ButtonKind = bkStandard
-            MaxValue = 10000.000000000000000000
-            Value = 5000.000000000000000000
-            TabOrder = 7
-            OnChange = speFilterEnergyChange
-          end
-          object speFilterUnits: TJvSpinEdit
-            Left = 104
-            Top = 56
-            Width = 57
-            Height = 20
-            ButtonKind = bkStandard
-            MaxValue = 10000.000000000000000000
-            Value = 3000.000000000000000000
-            TabOrder = 8
-            OnChange = speFilterUnitsChange
-          end
-          object chkFilterPlayers: TSpTBXCheckBox
+        end
+        object SpTBXTabSheet5: TSpTBXTabSheet
+          Left = 0
+          Top = 23
+          Width = 793
+          Height = 202
+          Caption = 'Filters'
+          ImageIndex = -1
+          TabItem = 'FiltersTab'
+          object SpTBXGroupBox4: TSpTBXGroupBox
             Left = 8
-            Top = 82
-            Width = 52
-            Height = 15
-            Caption = 'Players'
-            TabOrder = 9
-            OnClick = chkFilterPlayersClick
+            Top = 0
+            Width = 241
+            Height = 89
+            Caption = 'Game end condition'
+            TabOrder = 0
+            TBXStyleBackground = True
+            object chkFilterGameContinues: TSpTBXCheckBox
+              Left = 8
+              Top = 24
+              Width = 183
+              Height = 15
+              Caption = 'Game continues if commander dies'
+              TabOrder = 0
+              OnClick = chkFilterGameContinuesClick
+              Checked = True
+              State = cbChecked
+            end
+            object chkFilterComEnd: TSpTBXCheckBox
+              Left = 8
+              Top = 40
+              Width = 160
+              Height = 15
+              Caption = 'Game ends if commander dies'
+              TabOrder = 1
+              OnClick = chkFilterComEndClick
+              Checked = True
+              State = cbChecked
+            end
+            object chkFilterLineage: TSpTBXCheckBox
+              Left = 8
+              Top = 56
+              Width = 85
+              Height = 15
+              Caption = 'Lineage mode'
+              TabOrder = 2
+              OnClick = chkFilterLineageClick
+              Checked = True
+              State = cbChecked
+            end
           end
-          object btFilterPlayers: TSpTBXButton
-            Left = 88
-            Top = 80
-            Width = 17
-            Height = 20
-            Caption = '&gt;'
-            TabOrder = 10
-            OnClick = btFilterPlayersClick
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
-          object speFilterPlayers: TJvSpinEdit
-            Left = 104
-            Top = 80
-            Width = 57
-            Height = 20
-            ButtonKind = bkStandard
-            MaxValue = 16.000000000000000000
-            MinValue = 1.000000000000000000
-            Value = 16.000000000000000000
-            TabOrder = 11
-            OnChange = speFilterPlayersChange
-          end
-          object chkFilterLength: TSpTBXCheckBox
+          object SpTBXPanel1: TSpTBXPanel
             Left = 8
-            Top = 106
-            Width = 76
-            Height = 15
-            Caption = 'Length (min)'
-            TabOrder = 12
-            OnClick = chkFilterLengthClick
+            Top = 94
+            Width = 241
+            Height = 66
+            Caption = 'SpTBXPanel1'
+            TabOrder = 1
+            TBXStyleBackground = True
+            object chkFilterLimitDGunFilter: TSpTBXCheckBox
+              Left = 11
+              Top = 8
+              Width = 46
+              Height = 15
+              Caption = 'Filter :'
+              TabOrder = 0
+              OnClick = chkFilterLimitDGunFilterClick
+            end
+            object chkFilterGhostedFilter: TSpTBXCheckBox
+              Left = 11
+              Top = 24
+              Width = 46
+              Height = 15
+              Caption = 'Filter :'
+              TabOrder = 1
+              OnClick = chkFilterGhostedFilterClick
+            end
+            object chkFilterDiminishingFilter: TSpTBXCheckBox
+              Left = 11
+              Top = 40
+              Width = 46
+              Height = 15
+              Caption = 'Filter :'
+              TabOrder = 2
+              OnClick = chkFilterDiminishingFilterClick
+            end
+            object chkFilterGhosted: TSpTBXCheckBox
+              Left = 65
+              Top = 24
+              Width = 102
+              Height = 15
+              Caption = 'Ghosted buildings'
+              TabOrder = 3
+              OnClick = chkFilterGhostedClick
+            end
+            object chkFilterLimitDGun: TSpTBXCheckBox
+              Left = 65
+              Top = 8
+              Width = 128
+              Height = 15
+              Caption = 'Limit D-Gun to start pos'
+              TabOrder = 4
+              OnClick = chkFilterLimitDGunClick
+            end
+            object chkFilterDiminishing: TSpTBXCheckBox
+              Left = 65
+              Top = 40
+              Width = 166
+              Height = 15
+              Caption = 'Diminishing metal maker returns'
+              TabOrder = 5
+              OnClick = chkFilterDiminishingClick
+            end
           end
-          object btFilterLength: TSpTBXButton
-            Left = 88
-            Top = 104
-            Width = 17
-            Height = 20
-            Caption = '&gt;'
-            TabOrder = 13
-            OnClick = btFilterLengthClick
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
-          object speFilterLength: TJvSpinEdit
-            Left = 104
-            Top = 104
-            Width = 57
-            Height = 20
-            ButtonKind = bkStandard
-            MaxValue = 1440.000000000000000000
-            Value = 1440.000000000000000000
-            TabOrder = 14
-            OnChange = speFilterLengthChange
-          end
-          object speFilterFileSize: TJvSpinEdit
-            Left = 104
-            Top = 128
-            Width = 57
-            Height = 20
-            ButtonKind = bkStandard
-            MaxValue = 10000.000000000000000000
-            Value = 3000.000000000000000000
-            TabOrder = 15
-            OnChange = speFilterFileSizeChange
-          end
-          object btFilterFileSize: TSpTBXButton
-            Left = 88
-            Top = 128
-            Width = 17
-            Height = 20
-            Caption = '&gt;'
-            TabOrder = 16
-            OnClick = btFilterFileSizeClick
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
-          object chkFilterFileSize: TSpTBXCheckBox
-            Left = 8
-            Top = 130
-            Width = 77
-            Height = 15
-            Caption = 'File size (kB)'
-            TabOrder = 17
-            OnClick = chkFilterFileSizeClick
-          end
-          object chkFilterGrade: TSpTBXCheckBox
-            Left = 8
-            Top = 154
-            Width = 47
-            Height = 15
-            Caption = 'Grade'
-            TabOrder = 18
-            OnClick = chkFilterGradeClick
-          end
-          object btFilterGrade: TSpTBXButton
-            Left = 88
-            Top = 152
-            Width = 17
-            Height = 20
-            Caption = '&gt;'
-            TabOrder = 19
-            OnClick = btFilterGradeClick
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
-          object speFilterGrade: TJvSpinEdit
-            Left = 104
-            Top = 152
-            Width = 57
-            Height = 20
-            ButtonKind = bkStandard
-            MaxValue = 10.000000000000000000
-            MinValue = 1.000000000000000000
-            Value = 10.000000000000000000
-            TabOrder = 20
-            OnChange = speFilterGradeChange
-          end
-        end
-        object FilterList: TVirtualStringTree
-          Left = 601
-          Top = 24
-          Width = 184
-          Height = 185
-          Align = alCustom
-          CheckImageKind = ckSystem
-          ClipboardFormats.Strings = (
-            'Unicode text')
-          DragOperations = []
-          Header.AutoSizeIndex = 3
-          Header.Font.Charset = DEFAULT_CHARSET
-          Header.Font.Color = clWindowText
-          Header.Font.Height = -11
-          Header.Font.Name = 'MS Sans Serif'
-          Header.Font.Style = []
-          Header.Options = [hoAutoResize, hoColumnResize, hoDrag, hoShowSortGlyphs, hoVisible]
-          Header.SortColumn = 1
-          Header.Style = hsFlatButtons
-          TabOrder = 4
-          TreeOptions.AutoOptions = [toAutoDropExpand, toAutoScrollOnExpand, toAutoSort, toAutoTristateTracking, toAutoDeleteMovedNodes]
-          TreeOptions.MiscOptions = [toAcceptOLEDrop, toCheckSupport, toFullRepaintOnResize, toInitOnSave, toToggleOnDblClick, toWheelPanning]
-          TreeOptions.PaintOptions = [toShowButtons, toShowDropmark, toThemeAware, toUseBlendedImages]
-          TreeOptions.SelectionOptions = [toFullRowSelect, toMultiSelect]
-          OnChecking = FilterListChecking
-          OnCompareNodes = FilterListCompareNodes
-          OnGetText = FilterListGetText
-          OnHeaderClick = FilterListHeaderClick
-          Columns = &lt;
-            item
-              MaxWidth = 20
-              MinWidth = 20
-              Options = [coAllowClick, coEnabled, coParentBidiMode, coParentColor, coShowDropMark, coVisible, coFixed]
-              Position = 0
-              Width = 20
+          object SpTBXGroupBox5: TSpTBXGroupBox
+            Left = 256
+            Top = 6
+            Width = 169
+            Height = 187
+            TabOrder = 2
+            TBXStyleBackground = True
+            object chkFilterMetal: TSpTBXCheckBox
+              Left = 8
+              Top = 10
+              Width = 68
+              Height = 15
+              Caption = 'Start metal'
+              TabOrder = 0
+              OnClick = chkFilterMetalClick
             end
-            item
-              Options = [coAllowClick, coEnabled, coParentBidiMode, coParentColor, coResizable, coShowDropMark, coVisible]
-              Position = 1
-              Width = 80
-              WideText = 'Type'
+            object chkFilterEnergy: TSpTBXCheckBox
+              Left = 8
+              Top = 34
+              Width = 75
+              Height = 15
+              Caption = 'Start energy'
+              TabOrder = 1
+              OnClick = chkFilterEnergyClick
             end
-            item
-              Options = [coAllowClick, coEnabled, coParentBidiMode, coParentColor, coResizable, coShowDropMark, coVisible]
-              Position = 2
+            object chkFilterUnits: TSpTBXCheckBox
+              Left = 8
+              Top = 58
               Width = 63
-              WideText = ' '
+              Height = 15
+              Caption = 'Max units'
+              TabOrder = 2
+              OnClick = chkFilterUnitsClick
             end
-            item
-              Position = 3
+            object btFilterUnits: TSpTBXButton
+              Left = 88
+              Top = 56
               Width = 17
-              WideText = 'Value'
-            end&gt;
-        end
-        object SpTBXPanel2: TSpTBXPanel
-          Left = 432
-          Top = 104
-          Width = 161
-          Height = 105
-          Caption = 'SpTBXPanel2'
-          TabOrder = 5
-          TBXStyleBackground = True
-          object FilterListCombo: TSpTBXComboBox
-            Left = 8
-            Top = 8
-            Width = 105
-            Height = 19
-            Style = csOwnerDrawFixed
-            ItemHeight = 13
-            ItemIndex = 1
-            TabOrder = 0
-            Text = 'Map'
-            Items.Strings = (
-              'Host'
-              'Map'
-              'Mod'
-              'Disabled units'
-              'Spring Version'
-              'File Name'
-              'Players')
+              Height = 20
+              Caption = '&gt;'
+              TabOrder = 3
+              OnClick = btFilterUnitsClick
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object btFilterEnergy: TSpTBXButton
+              Left = 88
+              Top = 32
+              Width = 17
+              Height = 20
+              Caption = '&gt;'
+              TabOrder = 4
+              OnClick = btFilterEnergyClick
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object btFilterMetal: TSpTBXButton
+              Left = 88
+              Top = 8
+              Width = 17
+              Height = 20
+              Caption = '&gt;'
+              TabOrder = 5
+              OnClick = btFilterMetalClick
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object speFilterMetal: TJvSpinEdit
+              Left = 104
+              Top = 8
+              Width = 57
+              Height = 20
+              ButtonKind = bkStandard
+              MaxValue = 10000.000000000000000000
+              Value = 5000.000000000000000000
+              TabOrder = 6
+              OnChange = speFilterMetalChange
+            end
+            object speFilterEnergy: TJvSpinEdit
+              Left = 104
+              Top = 32
+              Width = 57
+              Height = 20
+              ButtonKind = bkStandard
+              MaxValue = 10000.000000000000000000
+              Value = 5000.000000000000000000
+              TabOrder = 7
+              OnChange = speFilterEnergyChange
+            end
+            object speFilterUnits: TJvSpinEdit
+              Left = 104
+              Top = 56
+              Width = 57
+              Height = 20
+              ButtonKind = bkStandard
+              MaxValue = 10000.000000000000000000
+              Value = 3000.000000000000000000
+              TabOrder = 8
+              OnChange = speFilterUnitsChange
+            end
+            object chkFilterPlayers: TSpTBXCheckBox
+              Left = 8
+              Top = 82
+              Width = 52
+              Height = 15
+              Caption = 'Players'
+              TabOrder = 9
+              OnClick = chkFilterPlayersClick
+            end
+            object btFilterPlayers: TSpTBXButton
+              Left = 88
+              Top = 80
+              Width = 17
+              Height = 20
+              Caption = '&gt;'
+              TabOrder = 10
+              OnClick = btFilterPlayersClick
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object speFilterPlayers: TJvSpinEdit
+              Left = 104
+              Top = 80
+              Width = 57
+              Height = 20
+              ButtonKind = bkStandard
+              MaxValue = 16.000000000000000000
+              MinValue = 1.000000000000000000
+              Value = 16.000000000000000000
+              TabOrder = 11
+              OnChange = speFilterPlayersChange
+            end
+            object chkFilterLength: TSpTBXCheckBox
+              Left = 8
+              Top = 106
+              Width = 76
+              Height = 15
+              Caption = 'Length (min)'
+              TabOrder = 12
+              OnClick = chkFilterLengthClick
+            end
+            object btFilterLength: TSpTBXButton
+              Left = 88
+              Top = 104
+              Width = 17
+              Height = 20
+              Caption = '&gt;'
+              TabOrder = 13
+              OnClick = btFilterLengthClick
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object speFilterLength: TJvSpinEdit
+              Left = 104
+              Top = 104
+              Width = 57
+              Height = 20
+              ButtonKind = bkStandard
+              MaxValue = 1440.000000000000000000
+              Value = 1440.000000000000000000
+              TabOrder = 14
+              OnChange = speFilterLengthChange
+            end
+            object speFilterFileSize: TJvSpinEdit
+              Left = 104
+              Top = 128
+              Width = 57
+              Height = 20
+              ButtonKind = bkStandard
+              MaxValue = 10000.000000000000000000
+              Value = 3000.000000000000000000
+              TabOrder = 15
+              OnChange = speFilterFileSizeChange
+            end
+            object btFilterFileSize: TSpTBXButton
+              Left = 88
+              Top = 128
+              Width = 17
+              Height = 20
+              Caption = '&gt;'
+              TabOrder = 16
+              OnClick = btFilterFileSizeClick
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object chkFilterFileSize: TSpTBXCheckBox
+              Left = 8
+              Top = 130
+              Width = 77
+              Height = 15
+              Caption = 'File size (kB)'
+              TabOrder = 17
+              OnClick = chkFilterFileSizeClick
+            end
+            object chkFilterGrade: TSpTBXCheckBox
+              Left = 8
+              Top = 154
+              Width = 47
+              Height = 15
+              Caption = 'Grade'
+              TabOrder = 18
+              OnClick = chkFilterGradeClick
+            end
+            object btFilterGrade: TSpTBXButton
+              Left = 88
+              Top = 152
+              Width = 17
+              Height = 20
+              Caption = '&gt;'
+              TabOrder = 19
+              OnClick = btFilterGradeClick
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object speFilterGrade: TJvSpinEdit
+              Left = 104
+              Top = 152
+              Width = 57
+              Height = 20
+              ButtonKind = bkStandard
+              MaxValue = 10.000000000000000000
+              MinValue = 1.000000000000000000
+              Value = 10.000000000000000000
+              TabOrder = 20
+              OnChange = speFilterGradeChange
+            end
           end
-          object ContainsRadio: TSpTBXRadioButton
-            Left = 15
-            Top = 36
-            Width = 58
-            Height = 15
-            Caption = 'contains'
-            TabOrder = 1
-          end
-          object DoNotContainsRadio: TSpTBXRadioButton
-            Left = 16
-            Top = 52
-            Width = 97
-            Height = 15
-            Caption = 'does not contain'
-            TabOrder = 2
-            TabStop = True
-            Checked = True
-          end
-          object FilterValueTextBox: TSpTBXEdit
-            Left = 8
-            Top = 72
-            Width = 105
-            Height = 21
+          object SpTBXGroupBox3: TSpTBXGroupBox
+            Left = 432
+            Top = 0
+            Width = 161
+            Height = 73
+            Caption = 'Start position'
             TabOrder = 3
+            TBXStyleBackground = True
+            object chkFilterFixed: TSpTBXCheckBox
+              Left = 8
+              Top = 16
+              Width = 43
+              Height = 15
+              Caption = 'Fixed'
+              TabOrder = 0
+              OnClick = chkFilterFixedClick
+              Checked = True
+              State = cbChecked
+            end
+            object chkFilterRandom: TSpTBXCheckBox
+              Left = 8
+              Top = 32
+              Width = 58
+              Height = 15
+              Caption = 'Random'
+              TabOrder = 1
+              OnClick = chkFilterRandomClick
+              Checked = True
+              State = cbChecked
+            end
+            object chkFilterChooseInGame: TSpTBXCheckBox
+              Left = 8
+              Top = 48
+              Width = 94
+              Height = 15
+              Caption = 'Choose in game'
+              TabOrder = 2
+              OnClick = chkFilterChooseInGameClick
+              Checked = True
+              State = cbChecked
+            end
           end
-          object AddToFilterListButton: TSpTBXButton
-            Left = 120
-            Top = 8
-            Width = 33
-            Height = 25
-            Caption = '-&gt;'
+          object SpTBXPanel2: TSpTBXPanel
+            Left = 432
+            Top = 88
+            Width = 161
+            Height = 105
+            Caption = 'SpTBXPanel2'
             TabOrder = 4
-            OnClick = AddToFilterListButtonClick
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
+            TBXStyleBackground = True
+            object FilterListCombo: TSpTBXComboBox
+              Left = 8
+              Top = 8
+              Width = 105
+              Height = 19
+              Style = csOwnerDrawFixed
+              ItemHeight = 13
+              ItemIndex = 1
+              TabOrder = 0
+              Text = 'Map'
+              Items.Strings = (
+                'Host'
+                'Map'
+                'Mod'
+                'Disabled units'
+                'Spring Version'
+                'File Name'
+                'Players')
+            end
+            object ContainsRadio: TSpTBXRadioButton
+              Left = 15
+              Top = 36
+              Width = 58
+              Height = 15
+              Caption = 'contains'
+              TabOrder = 1
+            end
+            object DoNotContainsRadio: TSpTBXRadioButton
+              Left = 16
+              Top = 52
+              Width = 97
+              Height = 15
+              Caption = 'does not contain'
+              TabOrder = 2
+              TabStop = True
+              Checked = True
+            end
+            object FilterValueTextBox: TSpTBXEdit
+              Left = 8
+              Top = 72
+              Width = 105
+              Height = 21
+              TabOrder = 3
+            end
+            object AddToFilterListButton: TSpTBXButton
+              Left = 120
+              Top = 8
+              Width = 33
+              Height = 25
+              Caption = '-&gt;'
+              TabOrder = 4
+              OnClick = AddToFilterListButtonClick
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object RemoveFromFilterListButton: TSpTBXButton
+              Left = 120
+              Top = 40
+              Width = 33
+              Height = 25
+              Caption = '&lt;-'
+              TabOrder = 5
+              OnClick = RemoveFromFilterListButtonClick
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object ClearFilterListButton: TSpTBXButton
+              Left = 120
+              Top = 72
+              Width = 33
+              Height = 25
+              Caption = 'Clear'
+              TabOrder = 6
+              OnClick = ClearFilterListButtonClick
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
           end
-          object RemoveFromFilterListButton: TSpTBXButton
-            Left = 120
-            Top = 40
-            Width = 33
-            Height = 25
-            Caption = '&lt;-'
+          object FilterList: TVirtualStringTree
+            Left = 601
+            Top = 8
+            Width = 184
+            Height = 185
+            Align = alCustom
+            Anchors = [akLeft, akTop, akRight]
+            CheckImageKind = ckSystem
+            ClipboardFormats.Strings = (
+              'Unicode text')
+            DragOperations = []
+            Header.AutoSizeIndex = 3
+            Header.Font.Charset = DEFAULT_CHARSET
+            Header.Font.Color = clWindowText
+            Header.Font.Height = -11
+            Header.Font.Name = 'MS Sans Serif'
+            Header.Font.Style = []
+            Header.Options = [hoAutoResize, hoColumnResize, hoDrag, hoShowSortGlyphs, hoVisible]
+            Header.SortColumn = 1
+            Header.Style = hsFlatButtons
             TabOrder = 5
-            OnClick = RemoveFromFilterListButtonClick
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
+            TreeOptions.AutoOptions = [toAutoDropExpand, toAutoScrollOnExpand, toAutoSort, toAutoTristateTracking, toAutoDeleteMovedNodes]
+            TreeOptions.MiscOptions = [toAcceptOLEDrop, toCheckSupport, toFullRepaintOnResize, toInitOnSave, toToggleOnDblClick, toWheelPanning]
+            TreeOptions.PaintOptions = [toShowButtons, toShowDropmark, toThemeAware, toUseBlendedImages]
+            TreeOptions.SelectionOptions = [toFullRowSelect, toMultiSelect]
+            OnChecking = FilterListChecking
+            OnCompareNodes = FilterListCompareNodes
+            OnGetText = FilterListGetText
+            OnHeaderClick = FilterListHeaderClick
+            Columns = &lt;
+              item
+                MaxWidth = 20
+                MinWidth = 20
+                Options = [coAllowClick, coEnabled, coParentBidiMode, coParentColor, coShowDropMark, coVisible, coFixed]
+                Position = 0
+                Width = 20
+              end
+              item
+                Options = [coAllowClick, coEnabled, coParentBidiMode, coParentColor, coResizable, coShowDropMark, coVisible]
+                Position = 1
+                Width = 80
+                WideText = 'Type'
+              end
+              item
+                Options = [coAllowClick, coEnabled, coParentBidiMode, coParentColor, coResizable, coShowDropMark, coVisible]
+                Position = 2
+                Width = 63
+                WideText = ' '
+              end
+              item
+                Position = 3
+                Width = 17
+                WideText = 'Value'
+              end&gt;
           end
-          object ClearFilterListButton: TSpTBXButton
-            Left = 120
-            Top = 72
-            Width = 33
-            Height = 25
-            Caption = 'Clear'
-            TabOrder = 6
-            OnClick = ClearFilterListButtonClick
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
         end
-        object chkEnableFilters: TSpTBXCheckBox
-          Left = 8
-          Top = 192
-          Width = 110
-          Height = 18
-          Caption = 'Enable filters'
-          Font.Charset = DEFAULT_CHARSET
-          Font.Color = clWindowText
-          Font.Height = -13
-          Font.Name = 'MS Sans Serif'
-          Font.Style = [fsBold]
-          ParentFont = False
-          TabOrder = 6
-          OnClick = chkEnableFiltersClick
-        end
       end
+      object chkEnableFilters: TSpTBXCheckBox
+        Left = 680
+        Top = 2
+        Width = 110
+        Height = 18
+        Caption = 'Enable filters'
+        Anchors = [akTop, akRight]
+        Font.Charset = DEFAULT_CHARSET
+        Font.Color = clWindowText
+        Font.Height = -13
+        Font.Name = 'MS Sans Serif'
+        Font.Style = [fsBold]
+        ParentFont = False
+        TabOrder = 2
+        OnClick = chkEnableFiltersClick
+      end
     end
     object LoadingPanel: TSpTBXPanel
       Left = 176

Modified: branches/0.77-branch/Lobby/TASClient/ReplaysUnit.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/ReplaysUnit.pas	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/Lobby/TASClient/ReplaysUnit.pas	2008-08-20 14:38:09 UTC (rev 6278)
@@ -22,8 +22,8 @@
   Dialogs, Buttons, StdCtrls, ComCtrls, ExtCtrls, Math, SpTBXControls,
   TntStdCtrls, SpTBXEditors, TBXDkPanels, SpTBXTabs, TB2Item, TBX,
   SpTBXItem, IdBaseComponent, IdComponent, IdTCPConnection, IdTCPClient,
-  IdHTTP,MainUnit,DateUtils, VirtualTrees,Utility, Mask, JvExMask, JvSpin,IniFiles,MapListFormUnit,
-  Menus;
+  IdHTTP,MainUnit,DateUtils, VirtualTrees,Utility, Mask, JvExMask, JvSpin,
+  IniFiles,MapListFormUnit, Menus;
 
 type
   TReplaysForm = class(TForm)
@@ -74,11 +74,14 @@
     SpTBXLabel4: TSpTBXLabel;
     PanelTop: TPanel;
     FiltersButton: TSpTBXButton;
-    frmFilters: TSpTBXGroupBox;
-    SpTBXGroupBox3: TSpTBXGroupBox;
-    chkFilterFixed: TSpTBXCheckBox;
-    chkFilterRandom: TSpTBXCheckBox;
-    chkFilterChooseInGame: TSpTBXCheckBox;
+    DeleteAllVisibleButton: TSpTBXButton;
+    ReplayListPopupMenu: TSpTBXPopupMenu;
+    FiltersTabs: TSpTBXTabControl;
+    FiltersTab: TSpTBXTabItem;
+    SpTBXTabSheet5: TSpTBXTabSheet;
+    PresetsTab: TSpTBXTabItem;
+    SpTBXTabSheet6: TSpTBXTabSheet;
+    chkEnableFilters: TSpTBXCheckBox;
     SpTBXGroupBox4: TSpTBXGroupBox;
     chkFilterGameContinues: TSpTBXCheckBox;
     chkFilterComEnd: TSpTBXCheckBox;
@@ -112,7 +115,10 @@
     chkFilterGrade: TSpTBXCheckBox;
     btFilterGrade: TSpTBXButton;
     speFilterGrade: TJvSpinEdit;
-    FilterList: TVirtualStringTree;
+    SpTBXGroupBox3: TSpTBXGroupBox;
+    chkFilterFixed: TSpTBXCheckBox;
+    chkFilterRandom: TSpTBXCheckBox;
+    chkFilterChooseInGame: TSpTBXCheckBox;
     SpTBXPanel2: TSpTBXPanel;
     FilterListCombo: TSpTBXComboBox;
     ContainsRadio: TSpTBXRadioButton;
@@ -121,9 +127,14 @@
     AddToFilterListButton: TSpTBXButton;
     RemoveFromFilterListButton: TSpTBXButton;
     ClearFilterListButton: TSpTBXButton;
-    chkEnableFilters: TSpTBXCheckBox;
-    DeleteAllVisibleButton: TSpTBXButton;
-    ReplayListPopupMenu: TSpTBXPopupMenu;
+    FilterList: TVirtualStringTree;
+    SpTBXGroupBox2: TSpTBXGroupBox;
+    btDeletePreset: TSpTBXButton;
+    btSavePreset: TSpTBXButton;
+    PresetNameTextbox: TSpTBXEdit;
+    btClearPreset: TSpTBXButton;
+    SpTBXLabel5: TSpTBXLabel;
+    PresetListbox: TSpTBXListBox;
 
     procedure CreateParams(var Params: TCreateParams); override;
 
@@ -219,7 +230,6 @@
     procedure ClearFilterListButtonClick(Sender: TObject);
     procedure FilterListChecking(Sender: TBaseVirtualTree;
       Node: PVirtualNode; var NewState: TCheckState; var Allowed: Boolean);
-    procedure frmFiltersResize(Sender: TObject);
     procedure VDTReplaysColumnDblClick(Sender: TBaseVirtualTree;
       Column: TColumnIndex; Shift: TShiftState);
     procedure VDTReplaysKeyUp(Sender: TObject; var Key: Word;
@@ -235,16 +245,23 @@
       HintCanvas: TCanvas; Node: PVirtualNode; R: TRect;
       Column: TColumnIndex);
     procedure DeleteAllVisibleButtonClick(Sender: TObject);
+    procedure btSavePresetClick(Sender: TObject);
+    procedure btDeletePresetClick(Sender: TObject);
+    procedure btClearPresetClick(Sender: TObject);
+    procedure PresetListboxClick(Sender: TObject);
   private
     { Private declarations }
   public
     procedure VDTReplaysClick;overload;
     function isReplayVisible(Replay: TReplay):boolean;
     procedure FilterReplayList;
-    procedure LoadReplayFiltersFromFile;
+    procedure LoadReplayFiltersFromFile(inputFileName : string);
     procedure UpdateReplayFilters;
-    procedure SaveReplayFiltersToFile;
+    procedure SaveReplayFiltersToFile(outputFileName : string);
     function GetReplayFilterIndexFromNode(Node : PVirtualNode): integer;
+    procedure LoadReplayFiltersPresets;
+    procedure initFiltersPresets;
+    procedure FiltersUpdated;
   end;
 
   // this thread is used to load replays info from disk on application start
@@ -288,7 +305,7 @@
 
 uses  StrUtils, ShellAPI, BattleFormUnit, Misc, PreferencesFormUnit,
   InitWaitFormUnit,MsMultiPartFormData, ProgressBarWindow,
-  UploadReplayUnit;
+  UploadReplayUnit, LobbyScriptUnit;
 
 {$R *.dfm}
 
@@ -903,10 +920,10 @@
   LoadingPanel.Top := PanelTop.Top;
   LoadingPanel.Left := PanelTop.Left;
 
-  Filters.TextFilters := TList.Create;
-
   FixFormSizeConstraints(self);
 
+  initFiltersPresets;
+
   FiltersButtonClick(nil);
 end;
 
@@ -1387,6 +1404,10 @@
   ReplaysForm.VDTReplays.Selected[ReplaysForm.VDTReplays.FocusedNode] := true;
 
   ReplaysForm.VDTReplaysClick;
+
+  AcquireMainThread;
+  try if not Preferences.DisableScripts then handlers.onReplaysReloaded(); except end;
+  ReleaseMainThread;
 end;
 
 procedure TReplaysForm.VDTReplaysClick;
@@ -1729,31 +1750,32 @@
 
 procedure TReplaysForm.FiltersButtonClick(Sender: TObject);
 begin
-  if frmFilters.Height = 0 then
+  if FiltersTabs.Height = 0 then
   begin
-    frmFilters.Height := 219;
-    PanelTop.Height := PanelTop.Height + frmFilters.Height;
+    FiltersTabs.Height := 225;
+    PanelTop.Height := PanelTop.Height + FiltersTabs.Height;
     FiltersButton.ImageIndex := 0;
+    chkEnableFilters.Visible := True;
   end
   else
   begin
+    chkEnableFilters.Visible := False;
     FiltersButton.ImageIndex := 1;
-    PanelTop.Height := PanelTop.Height - frmFilters.Height;
-    frmFilters.Height := 0;
+    PanelTop.Height := PanelTop.Height - FiltersTabs.Height;
+    FiltersTabs.Height := 0;
   end;
 end;
 
 // TODO: recode the load save and update replay filters because it's pretty bad coded
-procedure TReplaysForm.LoadReplayFiltersFromFile;
+procedure TReplaysForm.LoadReplayFiltersFromFile(inputFileName : string);
 var
-  FilenamePath : String;
   Ini : TIniFile;
   i:integer;
   tmpStr: String;
   f: ^TFilterText;
 begin
-  FilenamePath := VAR_FOLDER + '\' + 'replayFilters.ini';
-  Ini := TIniFile.Create(FilenamePath);
+  //FilenamePath := VAR_FOLDER + '\' + 'replayFilters.ini';
+  Ini := TIniFile.Create(inputFileName);
   i := 0;
   Filters.GameContinues := Ini.ReadBool('StaticFilters', 'GameContinues', True);
   Filters.ComEnd := Ini.ReadBool('StaticFilters', 'ComEnd', True);
@@ -1966,17 +1988,16 @@
   end;
 end;
 
-procedure TReplaysForm.SaveReplayFiltersToFile;
+procedure TReplaysForm.SaveReplayFiltersToFile(outputFileName : string);
 var
-  FilenamePath : String;
   Ini : TIniFile;
   i:integer;
 begin
   try
-    FilenamePath := VAR_FOLDER + '\' + 'replayFilters.ini';
-    if FileExists(FilenamePath) then
-      DeleteFile(FilenamePath);
-    Ini := TIniFile.Create(FilenamePath);
+    //FilenamePath := VAR_FOLDER + '\' + 'replayFilters.ini';
+    if FileExists(outputFileName) then
+      DeleteFile(outputFileName);
+    Ini := TIniFile.Create(outputFileName);
     i := 0;
     Ini.WriteBool('StaticFilters','GameContinues',Filters.GameContinues);
     Ini.WriteBool('StaticFilters','ComEnd',Filters.ComEnd);
@@ -2141,135 +2162,135 @@
 
 procedure TReplaysForm.chkFilterGameContinuesClick(Sender: TObject);
 begin
+  if not chkFilterGameContinues.Focused then Exit;
   Filters.GameContinues := (Sender as TSpTBXCheckBox).Checked;
-  if chkEnableFilters.Checked then
-    FilterReplayList;
+  FiltersUpdated;
 end;
 
 procedure TReplaysForm.chkFilterComEndClick(Sender: TObject);
 begin
+  if not chkFilterComEnd.Focused then Exit;
   Filters.ComEnd := (Sender as TSpTBXCheckBox).Checked;
-  if chkEnableFilters.Checked then
-    FilterReplayList;
+  FiltersUpdated;
 end;
 
 procedure TReplaysForm.chkFilterLineageClick(Sender: TObject);
 begin
+  if not chkFilterLineage.Focused then Exit;
   Filters.Lineage := (Sender as TSpTBXCheckBox).Checked;
-  if chkEnableFilters.Checked then
-    FilterReplayList;
+  FiltersUpdated;
 end;
 
 procedure TReplaysForm.chkFilterLimitDGunFilterClick(Sender: TObject);
 begin
+  if not chkFilterLimitDGunFilter.Focused then Exit;
   Filters.FilterLimitDGun := (Sender as TSpTBXCheckBox).Checked;
-  if chkEnableFilters.Checked then
-    FilterReplayList;
+  FiltersUpdated;
 end;
 
 procedure TReplaysForm.chkFilterGhostedFilterClick(Sender: TObject);
 begin
+  if not chkFilterGhostedFilter.Focused then Exit;
   Filters.FilterGhosted := (Sender as TSpTBXCheckBox).Checked;
-  if chkEnableFilters.Checked then
-    FilterReplayList;
+  FiltersUpdated;
 end;
 
 procedure TReplaysForm.chkFilterDiminishingFilterClick(Sender: TObject);
 begin
+  if not chkFilterDiminishingFilter.Focused then Exit;
   Filters.FilterDiminishing := (Sender as TSpTBXCheckBox).Checked;
-  if chkEnableFilters.Checked then
-    FilterReplayList;
+  FiltersUpdated;
 end;
 
 procedure TReplaysForm.chkFilterLimitDGunClick(Sender: TObject);
 begin
+  if not chkFilterLimitDGun.Focused then Exit;
   Filters.LimitDGun := (Sender as TSpTBXCheckBox).Checked;
-  if chkEnableFilters.Checked then
-    FilterReplayList;
+  FiltersUpdated;
 end;
 
 procedure TReplaysForm.chkFilterGhostedClick(Sender: TObject);
 begin
+  if not chkFilterGhosted.Focused then Exit;
   Filters.Ghosted := (Sender as TSpTBXCheckBox).Checked;
-  if chkEnableFilters.Checked then
-    FilterReplayList;
+  FiltersUpdated;
 end;
 
 procedure TReplaysForm.chkFilterDiminishingClick(Sender: TObject);
 begin
+  if not chkFilterDiminishing.Focused then Exit;
   Filters.Diminishing := (Sender as TSpTBXCheckBox).Checked;
-  if chkEnableFilters.Checked then
-    FilterReplayList;
+  FiltersUpdated;
 end;
 
 procedure TReplaysForm.chkFilterMetalClick(Sender: TObject);
 begin
+  if not chkFilterMetal.Focused then Exit;
   Filters.Metal.enabled := (Sender as TSpTBXCheckBox).Checked;
-  if chkEnableFilters.Checked then
-    FilterReplayList;
+  FiltersUpdated;
 end;
 
 procedure TReplaysForm.chkFilterEnergyClick(Sender: TObject);
 begin
+  if not chkFilterEnergy.Focused then Exit;
   Filters.Energy.enabled := (Sender as TSpTBXCheckBox).Checked;
-  if chkEnableFilters.Checked then
-    FilterReplayList;
+  FiltersUpdated;
 end;
 
 procedure TReplaysForm.chkFilterUnitsClick(Sender: TObject);
 begin
+  if not chkFilterUnits.Focused then Exit;
   Filters.Units.enabled := (Sender as TSpTBXCheckBox).Checked;
-  if chkEnableFilters.Checked then
-    FilterReplayList;
+  FiltersUpdated;
 end;
 
 procedure TReplaysForm.chkFilterPlayersClick(Sender: TObject);
 begin
+  if not chkFilterPlayers.Focused then Exit;
   Filters.Players.enabled := (Sender as TSpTBXCheckBox).Checked;
-  if chkEnableFilters.Checked then
-    FilterReplayList;
+  FiltersUpdated;
 end;
 
 procedure TReplaysForm.chkFilterLengthClick(Sender: TObject);
 begin
+  if not chkFilterLength.Focused then Exit;
   Filters.Length.enabled := (Sender as TSpTBXCheckBox).Checked;
-  if chkEnableFilters.Checked then
-    FilterReplayList;
+  FiltersUpdated;
 end;
 
 procedure TReplaysForm.chkFilterFileSizeClick(Sender: TObject);
 begin
+  if not chkFilterFileSize.Focused then Exit;
   Filters.FileSize.enabled := (Sender as TSpTBXCheckBox).Checked;
-  if chkEnableFilters.Checked then
-    FilterReplayList;
+  FiltersUpdated;
 end;
 
 procedure TReplaysForm.chkFilterGradeClick(Sender: TObject);
 begin
+  if not chkFilterGrade.Focused then Exit;
   Filters.Grade.enabled := (Sender as TSpTBXCheckBox).Checked;
-  if chkEnableFilters.Checked then
-    FilterReplayList;
+  FiltersUpdated;
 end;
 
 procedure TReplaysForm.chkFilterFixedClick(Sender: TObject);
 begin
+  if not chkFilterFixed.Focused then Exit;
   Filters.Fixed := (Sender as TSpTBXCheckBox).Checked;
-  if chkEnableFilters.Checked then
-        FilterReplayList;
+  FiltersUpdated;
 end;
 
 procedure TReplaysForm.chkFilterRandomClick(Sender: TObject);
 begin
+  if not chkFilterRandom.Focused then Exit;
   Filters.Random := (Sender as TSpTBXCheckBox).Checked;
-  if chkEnableFilters.Checked then
-        FilterReplayList;
+  FiltersUpdated;
 end;
 
 procedure TReplaysForm.chkFilterChooseInGameClick(Sender: TObject);
 begin
+  if not chkFilterChooseInGame.Focused then Exit;
   Filters.ChooseInGame := (Sender as TSpTBXCheckBox).Checked;
-  if chkEnableFilters.Checked then
-        FilterReplayList;
+  FiltersUpdated;
 end;
 
 procedure TReplaysForm.btFilterMetalClick(Sender: TObject);
@@ -2292,8 +2313,7 @@
       filterType := Sup;
     end;
     if enabled then
-      if chkEnableFilters.Checked then
-        FilterReplayList;
+      FiltersUpdated;
   end;
 end;
 
@@ -2317,8 +2337,7 @@
       filterType := Sup;
     end;
     if enabled then
-      if chkEnableFilters.Checked then
-        FilterReplayList;
+      FiltersUpdated;
   end;
 end;
 
@@ -2342,8 +2361,7 @@
       filterType := Sup;
     end;
     if enabled then
-      if chkEnableFilters.Checked then
-        FilterReplayList;
+      FiltersUpdated;
   end;
 end;
 
@@ -2367,8 +2385,7 @@
       filterType := Sup;
     end;
     if enabled then
-      if chkEnableFilters.Checked then
-        FilterReplayList;
+      FiltersUpdated;
   end;
 end;
 
@@ -2392,8 +2409,7 @@
       filterType := Sup;
     end;
     if enabled then
-      if chkEnableFilters.Checked then
-        FilterReplayList;
+      FiltersUpdated;
   end;
 end;
 
@@ -2417,8 +2433,7 @@
       filterType := Sup;
     end;
     if enabled then
-      if chkEnableFilters.Checked then
-        FilterReplayList;
+      FiltersUpdated;
   end;
 end;
 
@@ -2442,85 +2457,84 @@
       filterType := Sup;
     end;
     if enabled then
-      if chkEnableFilters.Checked then
-        FilterReplayList;
+      FiltersUpdated;
   end;
 end;
 
 procedure TReplaysForm.speFilterMetalChange(Sender: TObject);
 begin
+  if not speFilterMetal.Focused then Exit;
   with Filters.Metal do
   begin
     value := (Sender as TJvSpinEdit).AsInteger;
     if enabled then
-      if chkEnableFilters.Checked then
-        FilterReplayList;
+      FiltersUpdated;
   end;
 end;
 
 procedure TReplaysForm.speFilterEnergyChange(Sender: TObject);
 begin
+  if not speFilterEnergy.Focused then Exit;
   with Filters.Energy do
   begin
     value := (Sender as TJvSpinEdit).AsInteger;
     if enabled then
-      if chkEnableFilters.Checked then
-        FilterReplayList;
+      FiltersUpdated;
   end;
 end;
 
 procedure TReplaysForm.speFilterUnitsChange(Sender: TObject);
 begin
+  if not speFilterUnits.Focused then Exit;
   with Filters.Units do
   begin
     value := (Sender as TJvSpinEdit).AsInteger;
     if enabled then
-      if chkEnableFilters.Checked then
-        FilterReplayList;
+      FiltersUpdated;
   end;
 end;
 
 procedure TReplaysForm.speFilterPlayersChange(Sender: TObject);
 begin
+  if not speFilterPlayers.Focused then Exit;
   with Filters.Players do
   begin
     value := (Sender as TJvSpinEdit).AsInteger;
     if enabled then
-      if chkEnableFilters.Checked then
-        FilterReplayList;
+      FiltersUpdated;
   end;
 end;
 
 procedure TReplaysForm.speFilterLengthChange(Sender: TObject);
 begin
+  if not speFilterLength.Focused then Exit;
   with Filters.Length do
   begin
     value := (Sender as TJvSpinEdit).AsInteger;
     if enabled then
-      if chkEnableFilters.Checked then
-        FilterReplayList;
+      FiltersUpdated;
   end;
 end;
 
 procedure TReplaysForm.speFilterFileSizeChange(Sender: TObject);
 begin
+  if not speFilterFileSize.Focused then Exit;
   with Filters.FileSize do
   begin
     value := (Sender as TJvSpinEdit).AsInteger;
     if enabled then
-      if chkEnableFilters.Checked then
-        FilterReplayList;
+      FiltersUpdated;
   end;
 end;
 
 procedure TReplaysForm.speFilterGradeChange(Sender: TObject);
 begin
+  if not speFilterGrade.Focused then Exit;
   with Filters.Grade do
   begin
     value := (Sender as TJvSpinEdit).AsInteger;
     if enabled then
-      if chkEnableFilters.Checked then
-        FilterReplayList;
+      FiltersUpdated;
   end;
 end;
 
@@ -2550,8 +2564,7 @@
   f^.enabled := True;
   FilterList.Invalidate;
   FilterValueTextBox.Text := '';
-  if chkEnableFilters.Checked then
-        FilterReplayList;
+  FiltersUpdated;
 end;
 
 procedure TReplaysForm.RemoveFromFilterListButtonClick(Sender: TObject);
@@ -2566,31 +2579,24 @@
     n := FilterList.GetNextSelected(n);
   end;
   FilterList.DeleteSelectedNodes;
-  if chkEnableFilters.Checked then
-        FilterReplayList;
+  FiltersUpdated;
 end;
 
 procedure TReplaysForm.ClearFilterListButtonClick(Sender: TObject);
 begin
   Filters.TextFilters.Clear;
   FilterList.Clear;
-  if chkEnableFilters.Checked then
-        FilterReplayList;
+  FiltersUpdated;
 end;
 
 procedure TReplaysForm.FilterListChecking(Sender: TBaseVirtualTree;
   Node: PVirtualNode; var NewState: TCheckState; var Allowed: Boolean);
 begin
+  if not FilterList.Focused then Exit;
   TFilterText(Filters.TextFilters[GetReplayFilterIndexFromNode(Node)]^).enabled := NewState = csCheckedNormal;
-  if chkEnableFilters.Checked then
-        FilterReplayList;
+  FiltersUpdated;
 end;
 
-procedure TReplaysForm.frmFiltersResize(Sender: TObject);
-begin
-  FilterList.Width := frmFilters.Width - 610;
-end;
-
 procedure TReplaysForm.VDTReplaysColumnDblClick(Sender: TBaseVirtualTree;
   Column: TColumnIndex; Shift: TShiftState);
 begin
@@ -2835,4 +2841,78 @@
   ReloadButtonClick(nil);
 end;
 
+procedure TReplaysForm.btSavePresetClick(Sender: TObject);
+begin
+  if PresetListbox.Items.IndexOf(PresetNameTextbox.Text) &gt;= 0 then
+  begin
+    MessageDlg('That preset name already exists. Please choose another name.',mtWarning,[mbOk],0);
+    Exit;
+  end;
+  SaveReplayFiltersToFile(REPLAY_FILTERS_FOLDER + '\'+PresetNameTextbox.Text+'.ini');
+  PresetListbox.Items.Add(PresetNameTextbox.Text);
+  PresetListbox.Selected[PresetListbox.Count-1] := true;
+end;
+
+procedure TReplaysForm.btDeletePresetClick(Sender: TObject);
+begin
+  if PresetListbox.ItemIndex = 0 then Exit;
+  DeleteFile(REPLAY_FILTERS_FOLDER + '\' + PresetListbox.Items[PresetListbox.ItemIndex] + '.ini');
+  PresetListbox.Items.Delete(PresetListbox.ItemIndex);
+  PresetListbox.Selected[0] := true;
+end;
+
+procedure TReplaysForm.btClearPresetClick(Sender: TObject);
+var
+  i: integer;
+begin
+  for i:=PresetListbox.Count-1 downto 1 do
+  begin
+    DeleteFile(REPLAY_FILTERS_FOLDER + '\' + PresetListbox.Items[i] + '.ini');
+    PresetListbox.Items.Delete(i);
+  end;
+  PresetListbox.Selected[0] := true;
+end;
+
+procedure TReplaysForm.PresetListboxClick(Sender: TObject);
+begin
+  if (PresetListbox.ItemIndex = 0) and not FileExists(REPLAY_FILTERS_FOLDER + '\' + PresetListbox.Items[PresetListbox.ItemIndex] + '.ini') then Exit;
+  LoadReplayFiltersFromFile(REPLAY_FILTERS_FOLDER + '\' + PresetListbox.Items[PresetListbox.ItemIndex] + '.ini');
+  UpdateReplayFilters;
+  FilterReplayList;
+end;
+
+procedure TReplaysForm.LoadReplayFiltersPresets;
+var
+  FileAttrs: Integer;
+  sr: TSearchRec;
+begin
+  FileAttrs := faAnyFile;
+  if FindFirst(REPLAY_FILTERS_FOLDER + '\*.ini', FileAttrs, sr) = 0 then
+  begin
+    repeat
+      if (sr.Name &lt;&gt; '.') and (sr.Name &lt;&gt; '..') and (sr.Name &lt;&gt; 'default.ini') then
+      begin
+        PresetListbox.Items.Add(LeftStr(''+sr.Name,Length(''+sr.Name)-4));
+      end;
+    until FindNext(sr) &lt;&gt; 0;
+    FindClose(sr);
+  end;
+end;
+
+procedure TReplaysForm.initFiltersPresets;
+begin
+  FiltersTabs.ActiveTabIndex := 0;
+  Filters.TextFilters := TList.Create;
+  LoadReplayFiltersFromFile(REPLAY_FILTERS_FOLDER + '\default.ini');
+  UpdateReplayFilters;
+  PresetListbox.Selected[0] := true;
+  LoadReplayFiltersPresets;
+end;
+
+procedure TReplaysForm.FiltersUpdated;
+begin
+  PresetListbox.Selected[0] := true;
+  FilterReplayList;
+end;
+
 end.

Modified: branches/0.77-branch/Lobby/TASClient/TASClient.dof
===================================================================
--- branches/0.77-branch/Lobby/TASClient/TASClient.dof	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/Lobby/TASClient/TASClient.dof	2008-08-20 14:38:09 UTC (rev 6278)
@@ -115,7 +115,7 @@
 MajorVer=0
 MinorVer=3
 Release=0
-Build=392
+Build=409
 Debug=0
 PreRelease=0
 Special=0
@@ -126,7 +126,7 @@
 [Version Info Keys]
 CompanyName=
 FileDescription=TA Spring lobby client
-FileVersion=0.3.0.392
+FileVersion=0.3.0.409
 InternalName=
 LegalCopyright=
 LegalTrademarks=

Modified: branches/0.77-branch/Lobby/TASClient/TASClient.dpr
===================================================================
--- branches/0.77-branch/Lobby/TASClient/TASClient.dpr	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/Lobby/TASClient/TASClient.dpr	2008-08-20 14:38:09 UTC (rev 6278)
@@ -128,8 +128,8 @@
   for i := 1 to ParamCount do
   begin
     MainUnit.RunningUnderWine := MainUnit.RunningUnderWine or (UpperCase(ParamStr(i)) = '-WINE');
-    MainUnit.RunningWithMainMenu := MainUnit.RunningWithMainMenu or (UpperCase(ParamStr(i)) = '-MENU');
-    MainUnit.RunningWithMainMenuDev := MainUnit.RunningWithMainMenuDev or (UpperCase(ParamStr(i)) = '-MENUDEV');
+    //MainUnit.RunningWithMainMenu := MainUnit.RunningWithMainMenu or (UpperCase(ParamStr(i)) = '-MENU');
+    //MainUnit.RunningWithMainMenuDev := MainUnit.RunningWithMainMenuDev or (UpperCase(ParamStr(i)) = '-MENUDEV');
 
     if UpperCase(ParamStr(i)) = '-SERVER' then
       if (ParamCount = i) or (Pos(':',ParamStr(i+1)) = 0) then

Modified: branches/0.77-branch/Lobby/TASClient/TASClient.res
===================================================================
(Binary files differ)

Modified: branches/0.77-branch/Lobby/TASClient/UploadReplayUnit.dfm
===================================================================
--- branches/0.77-branch/Lobby/TASClient/UploadReplayUnit.dfm	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/Lobby/TASClient/UploadReplayUnit.dfm	2008-08-20 14:38:09 UTC (rev 6278)
@@ -2,11 +2,11 @@
   Left = 586
   Top = 410
   Width = 410
-  Height = 328
+  Height = 307
   Caption = 'UploadReplayForm'
   Color = clBtnFace
-  Constraints.MaxHeight = 908
-  Constraints.MaxWidth = 1280
+  Constraints.MaxHeight = 1000
+  Constraints.MaxWidth = 1680
   Font.Charset = DEFAULT_CHARSET
   Font.Color = clWindowText
   Font.Height = -11
@@ -22,24 +22,12 @@
     Left = 0
     Top = 0
     Width = 402
-    Height = 301
+    Height = 280
     Caption = 'Upload replay'
     Options.Maximize = False
-    object SpTBXLabel1: TSpTBXLabel
-      Left = 16
-      Top = 32
-      Width = 26
-      Height = 13
-      Caption = 'Title :'
-      LinkFont.Charset = DEFAULT_CHARSET
-      LinkFont.Color = clBlue
-      LinkFont.Height = -11
-      LinkFont.Name = 'MS Sans Serif'
-      LinkFont.Style = [fsUnderline]
-    end
     object SpTBXLabel2: TSpTBXLabel
       Left = 16
-      Top = 64
+      Top = 40
       Width = 59
       Height = 13
       Caption = 'Description :'
@@ -51,11 +39,11 @@
     end
     object CancelButton: TSpTBXButton
       Left = 213
-      Top = 264
+      Top = 240
       Width = 73
       Height = 25
       Caption = 'Cancel'
-      TabOrder = 3
+      TabOrder = 2
       OnClick = CancelButtonClick
       LinkFont.Charset = DEFAULT_CHARSET
       LinkFont.Color = clBlue
@@ -65,11 +53,11 @@
     end
     object UploadButton: TSpTBXButton
       Left = 117
-      Top = 264
+      Top = 240
       Width = 73
       Height = 25
       Caption = 'Upload'
-      TabOrder = 4
+      TabOrder = 3
       OnClick = UploadButtonClick
       LinkFont.Charset = DEFAULT_CHARSET
       LinkFont.Color = clBlue
@@ -79,20 +67,13 @@
     end
     object DescriptionRtBox: TRichEdit
       Left = 88
-      Top = 64
+      Top = 40
       Width = 305
       Height = 193
       Lines.Strings = (
         'DescriptionRtBox')
-      TabOrder = 5
+      TabOrder = 4
     end
-    object TitleEdit: TSpTBXEdit
-      Left = 88
-      Top = 32
-      Width = 305
-      Height = 21
-      TabOrder = 6
-    end
   end
   object IdHTTP1: TIdHTTP
     MaxLineAction = maException

Modified: branches/0.77-branch/Lobby/TASClient/UploadReplayUnit.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/UploadReplayUnit.pas	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/Lobby/TASClient/UploadReplayUnit.pas	2008-08-20 14:38:09 UTC (rev 6278)
@@ -11,14 +11,12 @@
 type
   TUploadReplayForm = class(TForm)
     SpTBXTitleBar1: TSpTBXTitleBar;
-    SpTBXLabel1: TSpTBXLabel;
     SpTBXLabel2: TSpTBXLabel;
     CancelButton: TSpTBXButton;
     UploadButton: TSpTBXButton;
     DescriptionRtBox: TRichEdit;
     IdHTTP1: TIdHTTP;
     IdAntiFreeze1: TIdAntiFreeze;
-    TitleEdit: TSpTBXEdit;
     procedure UploadButtonClick(Sender: TObject);
     procedure IdHTTP1Work(Sender: TObject; AWorkMode: TWorkMode;
       const AWorkCount: Integer);
@@ -27,7 +25,7 @@
   private
     { Private declarations }
   public
-    Title : string;
+    Description : string;
     FileName : string;
     MapName : string;
     ModName : string;
@@ -49,20 +47,12 @@
 
 implementation
 
-uses ProgressBarWindow, ReplaysUnit;
+uses ProgressBarWindow, ReplaysUnit, PreferencesFormUnit;
 
 {$R *.dfm}
 
 procedure TUploadReplayForm.UploadButtonClick(Sender: TObject);
 begin
-  if (TitleEdit.Text = '') then begin
-    MessageDlg('You must enter a title before upload !',mtWarning,[mbOk],0);
-    Exit;
-  end;
-  if Length(TitleEdit.Text) &lt; 8 then begin
-    MessageDlg('Title too short (8char min) !',mtWarning,[mbOk],0);
-    Exit;
-  end;
   ProgressBarForm.TakeAction := 1;
   ProgressBarForm.ShowModal;
 end;
@@ -80,18 +70,18 @@
   ResponseStrList := TStringList.Create;
   try
     IdHttp1.Request.ContentType := MultiPartFormDataStream.RequestContentType;
-    MultiPartFormDataStream.AddFormField('title', TitleEdit.Text);
-    MultiPartFormDataStream.AddFormField('description', DescriptionRtBox.Text);
+    MultiPartFormDataStream.AddFormField('postdata[lobbynick]', Preferences.Username);
+    MultiPartFormDataStream.AddFormField('postdata[description]', DescriptionRtBox.Text);
     MultiPartFormDataStream.AddFormField('submit', 'submit');
     MultiPartFormDataStream.AddFormField('MAX_FILE_SIZE', '2097152');
-    MultiPartFormDataStream.AddFile('replay', FileName , 'application/octet-stream');
+    MultiPartFormDataStream.AddFile('tiedosto', FileName , 'application/octet-stream');
     { You must make sure you call this method *before* sending the stream }
     MultiPartFormDataStream.PrepareStreamForDispatch;
     MultiPartFormDataStream.Position := 0;
     ProgressBarForm.Refresh;
     ProgressBarForm.pb.Max := MultiPartFormDataStream.Size;
     ProgressBarForm.pb.Position := 0;
-    IdHTTP1.Post('<A HREF="http://replays.unknown-files.net/upload_bot.php">http://replays.unknown-files.net/upload_bot.php</A>', MultiPartFormDataStream, ResponseStream);
+    IdHTTP1.Post('<A HREF="http://replays.adune.nl/?act=upload&amp;do=upload&amp;secretzon=lamafaarao">http://replays.adune.nl/?act=upload&amp;do=upload&amp;secretzon=lamafaarao</A>', MultiPartFormDataStream, ResponseStream);
     ResponseStream.Seek(0,0);
     SetLength(ResponseStr, ResponseStream.Size);
     ResponseStream.ReadBuffer(Pointer(ResponseStr)^, ResponseStream.Size);
@@ -109,9 +99,9 @@
   Misc.ParseDelimited(ResponseStrList,ResponseStr,' ','');
   if (ResponseStrList.Count &gt; 0) and (ResponseStrList[0] = 'SUCCESS') then begin
     MessageDlgThread('Your replay has been successfully uploaded. Its link has been added to your clipboard.', mtInformation,[mbOk], 0);
-    Clipboard.Open;
-    Clipboard.SetTextBuf(PChar('<A HREF="http://replays.unknown-files.net/?">http://replays.unknown-files.net/?</A>'+ResponseStrList[1]));
-    Clipboard.Close;
+    //Clipboard.Open;
+    //Clipboard.SetTextBuf(PChar('<A HREF="http://replays.unknown-files.net/?">http://replays.unknown-files.net/?</A>'+ResponseStrList[1]));
+    //Clipboard.Close;
     UploadedReplayId := ResponseStrList[1];
   end
   else
@@ -129,12 +119,8 @@
 
 procedure TUploadReplayForm.FormActivate(Sender: TObject);
 begin
-  DescriptionRtBox.Text := '';
-  if Title &lt;&gt; '' then
-    TitleEdit.Text := Title
-  else
-    TitleEdit.Text := NbPlayers +' @ ' +MapName+' @ '+ModName;
-  Title := '';
+  DescriptionRtBox.Text := Description;
+  Description := '';
 end;
 
 constructor TUploadThread.Create(Suspended: Boolean);

Modified: branches/0.77-branch/Lobby/TASClient/Utility.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/Utility.pas	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/Lobby/TASClient/Utility.pas	2008-08-20 14:38:09 UTC (rev 6278)
@@ -90,7 +90,8 @@
 
 uses
   SysUtils, StrUtils, Dialogs, Forms, Misc, InitWaitFormUnit,
-  MapListFormUnit, SplashScreenUnit, BattleFormUnit, PreferencesFormUnit;
+  MapListFormUnit, SplashScreenUnit, BattleFormUnit, PreferencesFormUnit,
+  LobbyScriptUnit;
 
 
 { I assume bools are 1 byte in size (not 4) in unitsync.dll (from MSDN: &quot;In Visual C++ 4.2,
@@ -340,6 +341,10 @@
   MapListForm.SortStylePopupMenu.Items[Preferences.MapSortStyle].OnClick(MapListForm.SortStylePopupMenu.Items[Preferences.MapSortStyle]); // this will also sort map list
   BattleForm.ChangeMapToNoMap(''); // we have to set CurrentMapIndex to -1 or else ChangeMap method may not change map later on if old map index collides with new one!
   BattleForm.PopulatePopupMenuMapList;
+
+  AcquireMainThread;
+  try if not Preferences.DisableScripts then handlers.onMapsReloaded(); except end;
+  ReleaseMainThread;
 //***  showmessage('time taken: ' + inttostr(gettickcount - time) + ' ms');
 end;
 
@@ -426,6 +431,10 @@
     ModList.Add(GetPrimaryModName(i));
     ModArchiveList.Add(GetPrimaryModArchive(i));
   end;
+
+  AcquireMainThread;
+  try if not Preferences.DisableScripts then handlers.onModsReloaded(); except end;
+  ReleaseMainThread;
 end;
 
 { ------------------------------------------------------------------------ }
@@ -479,6 +488,9 @@
   res := FindFilesVFS(res, PChar(s), 255);
   if res &lt;&gt; 0 then
   begin
+    if RightStr(LowerCase(Trim(s)),4) = '.pcx' then
+      res := FindFilesVFS(res, PChar(s), 255);
+
     res := OpenFileVFS(PChar(s));
     size := FileSizeVFS(res);
     SetLength(picture, size);
@@ -507,9 +519,10 @@
 
       tmp.Width := imgWidth;
       tmp.Height := imgHeight;
+
       tmp.PixelFormat := pf24bit;
 
-      ilCopyPixels(0,0,0,imgWidth,imgHeight,1,IL_BGR,IL_UNSIGNED_BYTE,tmp.ScanLine[imgHeight-1]);
+      ilCopyPixels(0,0,0,imgWidth,imgHeight,1,IL_BGR,IL_BYTE,tmp.ScanLine[imgHeight-1]);
 
       BitmapFlip(True,True,tmp,Result);
     end;
@@ -533,7 +546,7 @@
   begin
     UnitNames.Add(GetFullUnitName(i));
     UnitList.Add(GetUnitName(i));
-    UnitBitmaps.Add(GetUnitBitmap(GetUnitName(i)));
+    UnitBitmaps.Add(GetUnitBitmap(GetUnitName(i)))
   end;
 end;
 

Modified: branches/0.77-branch/installer/builddata/bitmaps/bitmaps/waterbump.png
===================================================================
(Binary files differ)

Modified: branches/0.77-branch/installer/builddata/springcontent/shaders/bumpWaterCoastBlurFS.glsl
===================================================================
--- branches/0.77-branch/installer/builddata/springcontent/shaders/bumpWaterCoastBlurFS.glsl	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/installer/builddata/springcontent/shaders/bumpWaterCoastBlurFS.glsl	2008-08-20 14:38:09 UTC (rev 6278)
@@ -10,73 +10,74 @@
  * GNU GPL, v2 or later.
  */
 
-uniform sampler2D tex0;
+uniform sampler2D texture;
 uniform vec2 blurDir;
+uniform int blurTextureID;
 
 const float kernel = 1.0/10.0;
 
 void main(void) {
+  vec4 blur,blur2,blur3,blur4;
+  float d1=0.0,d2,d3;
+
   vec2 texCoord = gl_TexCoord[0].st;
 
   const vec2 texel = vec2(dFdx(gl_TexCoord[0].s),dFdy(gl_TexCoord[0].t));
 
   // 0 distance
-  gl_FragColor  = texture2D(tex0, texCoord );
+  gl_FragColor  = texture2D(texture, texCoord );
+
   if (gl_FragColor.r&gt;0.0) {
-    vec4 blur;
-    blur.x = texture2D(tex0, texCoord+vec2(texel.x,0.0) ).r;
-    blur.y = texture2D(tex0, texCoord+vec2(0.0,texel.y) ).r;
-    blur.z = texture2D(tex0, texCoord+vec2(-texel.x,0.0) ).r;
-    blur.w = texture2D(tex0, texCoord+vec2(0.0,-texel.y) ).r;
-    gl_FragColor.r = dot(blur,vec4(0.2))+gl_FragColor.r*0.2;
-    return;
+    blur.x = texture2D(texture, texCoord+vec2(texel.x,0.0) ).r;
+    blur.y = texture2D(texture, texCoord+vec2(0.0,texel.y) ).r;
+    blur.z = texture2D(texture, texCoord+vec2(-texel.x,0.0) ).r;
+    blur.w = texture2D(texture, texCoord+vec2(0.0,-texel.y) ).r;
+    d1 = dot(blur,vec4(0.2))+gl_FragColor.r*0.2;
   }
 
   // 1 texel distance
-  vec4 blur;
-  blur.x = texture2D(tex0, texCoord-texel ).r;
-  blur.y = texture2D(tex0, texCoord-vec2(0.0,texel.y) ).r;
-  blur.z = texture2D(tex0, texCoord-vec2(-texel.x,texel.y) ).r;
-  blur.w = texture2D(tex0, texCoord-vec2(texel.x,0.0) ).r;
+  blur.x = texture2D(texture, texCoord-texel ).r;
+  blur.y = texture2D(texture, texCoord-vec2(0.0,texel.y) ).r;
+  blur.z = texture2D(texture, texCoord-vec2(-texel.x,texel.y) ).r;
+  blur.w = texture2D(texture, texCoord-vec2(texel.x,0.0) ).r;
 
-  vec4 blur2;
-  blur2.x = texture2D(tex0, texCoord+texel ).r;
-  blur2.y = texture2D(tex0, texCoord+vec2(0.0,texel.y) ).r;
-  blur2.z = texture2D(tex0, texCoord+vec2(-texel.x,texel.y) ).r;
-  blur2.w = texture2D(tex0, texCoord+vec2(texel.x,0.0) ).r;
+  blur2.x = texture2D(texture, texCoord+texel ).r;
+  blur2.y = texture2D(texture, texCoord+vec2(0.0,texel.y) ).r;
+  blur2.z = texture2D(texture, texCoord+vec2(-texel.x,texel.y) ).r;
+  blur2.w = texture2D(texture, texCoord+vec2(texel.x,0.0) ).r;
 
   blur = max(blur,blur2);
   blur.xy = max(blur.xy,blur.zw);
   blur.x  = max(blur.x,blur.y);
-  if (blur.x&gt;0.0) { gl_FragColor.r=blur.x-kernel; return;}
+  d2 = blur.x-kernel;
 
   // 2 texel distance
-  blur.x = 0.0;// texture2D(tex0, texCoord-2.0*texel ).r;
-  blur.y = texture2D(tex0, texCoord-vec2(texel.x,2.0*texel.y) ).r;
-  blur.z = texture2D(tex0, texCoord-vec2(0.0,2.0*texel.y) ).r;
-  blur.w = texture2D(tex0, texCoord-vec2(-texel.x,2.0*texel.y) ).r;
+  blur.x = 0.0;// texture2D(texture, texCoord-2.0*texel ).r;
+  blur.y = texture2D(texture, texCoord-vec2(texel.x,2.0*texel.y) ).r;
+  blur.z = texture2D(texture, texCoord-vec2(0.0,2.0*texel.y) ).r;
+  blur.w = texture2D(texture, texCoord-vec2(-texel.x,2.0*texel.y) ).r;
 
-  blur2.x = 0.0;// texture2D(tex0, texCoord+vec2(2.0*texel.x,-2.0*texel.y) ).r;
-  blur2.y = texture2D(tex0, texCoord+vec2(2.0*texel.x,-texel.y) ).r;
-  blur2.z = texture2D(tex0, texCoord+vec2(2.0*texel.x,0.0) ).r;
-  blur2.w = texture2D(tex0, texCoord+vec2(2.0*texel.x,texel.y) ).r;
+  blur2.x = 0.0;// texture2D(texture, texCoord+vec2(2.0*texel.x,-2.0*texel.y) ).r;
+  blur2.y = texture2D(texture, texCoord+vec2(2.0*texel.x,-texel.y) ).r;
+  blur2.z = texture2D(texture, texCoord+vec2(2.0*texel.x,0.0) ).r;
+  blur2.w = texture2D(texture, texCoord+vec2(2.0*texel.x,texel.y) ).r;
 
-  vec4 blur3;
-  blur3.x = 0.0;// texture2D(tex0, texCoord+2.0*texel ).r;
-  blur3.y = texture2D(tex0, texCoord+vec2(texel.x,2.0*texel.y) ).r;
-  blur3.z = texture2D(tex0, texCoord+vec2(0.0,2.0*texel.y) ).r;
-  blur3.w = texture2D(tex0, texCoord+vec2(-texel.x,2.0*texel.y) ).r;
+  blur3.x = 0.0;// texture2D(texture, texCoord+2.0*texel ).r;
+  blur3.y = texture2D(texture, texCoord+vec2(texel.x,2.0*texel.y) ).r;
+  blur3.z = texture2D(texture, texCoord+vec2(0.0,2.0*texel.y) ).r;
+  blur3.w = texture2D(texture, texCoord+vec2(-texel.x,2.0*texel.y) ).r;
 
-  vec4 blur4;
-  blur4.x = 0.0;// texture2D(tex0, texCoord-vec2(2.0*texel.x,-2.0*texel.y) ).r;
-  blur4.y = texture2D(tex0, texCoord-vec2(2.0*texel.x,-texel.y) ).r;
-  blur4.z = texture2D(tex0, texCoord-vec2(2.0*texel.x,0.0) ).r;
-  blur4.w = texture2D(tex0, texCoord-vec2(2.0*texel.x,texel.y) ).r;
+  blur4.x = 0.0;// texture2D(texture, texCoord-vec2(2.0*texel.x,-2.0*texel.y) ).r;
+  blur4.y = texture2D(texture, texCoord-vec2(2.0*texel.x,-texel.y) ).r;
+  blur4.z = texture2D(texture, texCoord-vec2(2.0*texel.x,0.0) ).r;
+  blur4.w = texture2D(texture, texCoord-vec2(2.0*texel.x,texel.y) ).r;
 
   blur = max(blur,blur2);
   blur = max(blur,blur3);
   blur = max(blur,blur4);
   blur.xy = max(blur.xy,blur.zw);
   blur.x  = max(blur.x,blur.y);
-  if (blur.x&gt;0.0) { gl_FragColor.r=blur.x-kernel-kernel; return;}
+  d3 = blur.x-kernel-kernel;
+
+  gl_FragColor.r = max(d1,max(d2,d3));
 }

Modified: branches/0.77-branch/installer/builddata/springcontent/shaders/bumpWaterFS.glsl
===================================================================
--- branches/0.77-branch/installer/builddata/springcontent/shaders/bumpWaterFS.glsl	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/installer/builddata/springcontent/shaders/bumpWaterFS.glsl	2008-08-20 14:38:09 UTC (rev 6278)
@@ -8,13 +8,14 @@
  * GNU GPL, v2 or later.
  */
 
+
 //////////////////////////////////////////////////
 // runtime defined constants are:
 // #define SurfaceColor     vec4
 // #define DiffuseColor     vec3
 // #define PlaneColor       vec4  (unused)
 // #define AmbientFactor    float
-// #define DiffuseFactor    float   (note: it is the map defined value multipled with 15x!)
+// #define DiffuseFactor    float (note: it is the map defined value multipled with 15x!)
 // #define SpecularColor    vec3
 // #define SpecularPower    float
 // #define SpecularFactor   float
@@ -36,6 +37,11 @@
 // #define PerlinLacunarity float
 // #define PerlinAmp        float
 
+#define CausticDepth 0.5
+#define CausticRange 0.45
+#define WavesLength  0.15
+
+
 //////////////////////////////////////////////////
 // possible flags are:
 // //#define use_heightmap
@@ -44,12 +50,15 @@
 // #define use_shorewaves
 // #define use_depth
 // #define blur_reflection
+// #define use_texrect
 
-#extension GL_ARB_texture_rectangle : enable
+#ifdef use_texrect
+  #extension GL_ARB_texture_rectangle : enable
+#else
+  #define texture2DRect texture2D
+  #define sampler2DRect sampler2D
+#endif
 
-#define CausticDepth 0.5
-#define CausticRange 0.45
-#define WavesLength  0.15
 
 //////////////////////////////////////////////////
 // Uniforms + Varyings
@@ -69,18 +78,32 @@
   varying vec3 eyeVec;
   varying vec3 ligVec;
 
+
 //////////////////////////////////////////////////
+// Screen Coordinates (normalized and screen dimensions)
+
+#ifdef use_texrect
+  vec2 screencoord = (gl_FragCoord.xy - ViewPos);
+  vec2 reftexcoord = (screencoord*ScreenInverse);
+#else
+  vec2 screencoord = (gl_FragCoord.xy - ViewPos)*ScreenInverse;
+  vec2 reftexcoord = screencoord;
+#endif
+
+
+//////////////////////////////////////////////////
 // Depth conversion
-
+#ifdef use_depth
   float pm15 = gl_ProjectionMatrix[2][3];
   float pm11 = gl_ProjectionMatrix[2][3];
   float convertDepthToZ(float d) {
     return pm15 / (((d * 2.0) - 1.0) + pm11);
   }
+#endif
 
-
 //////////////////////////////////////////////////
 // shorewaves functions
+#ifdef use_shorewaves
 const float InvWavesLength = 1.0/WavesLength;
 
 float smoothlimit(const float x, const float step) {
@@ -100,6 +123,7 @@
   else
     return front;
 }
+#endif
 
 //////////////////////////////////////////////////
 // MAIN()
@@ -110,13 +134,21 @@
     float waterdepth = -texture2D(heightmap,gl_TexCoord[0].st).r;
     if (waterdepth&lt;0.0) discard;
 #else
-    float waterdepth = 1.0-texture2D(heightmap,gl_TexCoord[0].pq).a; //heightmap in alpha channel
-    if (waterdepth==0.0) discard;
-    //float invwaterdepth = 1.0-waterdepth;
+    float waterdepth;
+    if ( any(greaterThanEqual(gl_TexCoord[0].pq,vec2(1.0,1.0))) ||
+         any(lessThanEqual(gl_TexCoord[0].pq,vec2(0.0,0.0)))
+       )
+    {
+      waterdepth = 1.0;
+    }else{
+      waterdepth = 1.0 - texture2D(heightmap,gl_TexCoord[0].pq).a; //heightmap in alpha channel
+      if (waterdepth==0.0) discard;
+    }
+    //float invwaterdepth = 1.0 - waterdepth;
 #endif
 
 #ifdef use_depth
-    float tz = texture2DRect(depthmap, gl_FragCoord.xy-ViewPos ).r;
+    float tz = texture2DRect(depthmap, screencoord ).r;
     float shallowScale = clamp( abs( convertDepthToZ(tz) - convertDepthToZ(gl_FragCoord.z) )/3.0, 0.0,1.0);
 #else
     float shallowScale = waterdepth;
@@ -139,14 +171,14 @@
     vec3 normal = octave1+octave2+octave3+octave4;
     normal = normalize( normal ).xzy;
 
-    vec3 eVec   = normalize(eyeVec); // wait for texture fetches
+    vec3 eVec   = normalize(eyeVec);
     float eyeNormalCos = dot(-eVec, normal);
     float angle = (1.0-abs(eyeNormalCos));
 
 
 // AMBIENT &amp; DIFFUSE
     vec3 reflectDir   = reflect(normalize(-ligVec), normal);
-    float specular    = SpecularFactor * angle * pow( max(dot(reflectDir,eVec), 0.0) , SpecularPower) * shallowScale;
+    float specular    = angle * pow( max(dot(reflectDir,eVec), 0.0) , SpecularPower) * SpecularFactor * shallowScale;
     const vec3 SunLow = SunDir * vec3(1.0,0.1,1.0);
     float diffuse     = pow( max( dot(normal,SunLow) ,0.0 ) ,3.0)*DiffuseFactor;
     float ambient     = smoothstep(-1.3,0.0,eyeNormalCos)*AmbientFactor;
@@ -163,7 +195,7 @@
 
 // REFRACTION
 #ifdef use_refraction
-    vec3 refrColor = texture2DRect(refraction, gl_FragCoord.xy-ViewPos + normal.xz*refractDistortion ).rgb;
+    vec3 refrColor = texture2DRect(refraction, screencoord + normal.xz*refractDistortion ).rgb;
     gl_FragColor.rgb = mix(refrColor,waterSurface, 0.1+surfaceMix);
 #else
     gl_FragColor.rgb = waterSurface;
@@ -196,20 +228,25 @@
     vec3 shorewavesColor = vec3(0.0);
     float inwaterdepth = 1.0-waterdepth;
     //if (waterdepth&lt;1.0) {
-      float coastdist = texture2D(coastmap, gl_TexCoord[0].st ).r;
+      float coastdist = texture2D(coastmap, gl_TexCoord[0].st ).r + octave3.x*0.1; //FIXME
       //if (coastdist&gt;0.0 &amp;&amp; coastdist&lt;0.25) {
         vec3 wavefoam  = texture2D(foam, gl_TexCoord[0].st*160.0+frame ).rgb;
         wavefoam += texture2D(foam, gl_TexCoord[0].st*90.0+frame ).rgb;
         wavefoam *= 0.5;
 
+        vec2 wrcoord = gl_TexCoord[0].st*2.0;
+
         float fframe = fract(frame);
-        for (float i=0.0; i&lt;1.0; i+=1.0) {
-          float frac = fract(i+fframe*40.0)*1.4-0.2;
+        for (float i=0.0; i&lt;1.0; i+=0.25) {
+          float wave  = i+fframe*50.0;
+          float wavef = fract(wave);
+                wave -= wavef;
+          float frac  = wavef*1.4-0.2;
           float f = frac-coastdist;
           if (abs(f)&gt;WavesLength) continue;
-          float rand = texture2D(waverand, gl_TexCoord[0].st*2.0+frame+i ).r;
-          float f2 = waveIntensity( min(1.0,(WavesLength-f)*InvWavesLength) ,0.93);
-          shorewavesColor += wavefoam*f2*rand*rand;
+          float rand = texture2D(waverand, wrcoord+wave*0.37+i ).r;
+          float f2   = waveIntensity( min(1.0,(WavesLength-f)*InvWavesLength) ,0.85);
+          shorewavesColor += wavefoam*f2*rand;
         }
 
         shorewavesColor *= coastdist;
@@ -222,27 +259,34 @@
 
 // REFLECTION
 #ifdef use_reflection
-    float fresnel    = FresnelMin + FresnelMax * pow(angle,FresnelPower);
-    vec2 reftexcoord = vec2(0.0,1.0) - (gl_FragCoord.xy-ViewPos)*ScreenInverse + vec2(0.0,3.0*ScreenInverse.y) + normal.xz*0.09*ReflDistortion;
-    vec3 reflColor   = texture2D(reflection,reftexcoord.st).rgb;
+    //we have to mirror the Y-axis
+    reftexcoord  = vec2(reftexcoord.x,1.0 - reftexcoord.y);
+    reftexcoord += vec2(0.0,3.0*ScreenInverse.y) + normal.xz*0.09*ReflDistortion;
 
+    vec3 reflColor = texture2D(reflection,reftexcoord).rgb;
+
   #ifdef blur_reflection
     const vec2  v = BlurBase;
     const float s = BlurExponent;
-    reflColor   += texture2D(reflection,reftexcoord.st+v).rgb;
-    reflColor   += texture2D(reflection,reftexcoord.st+v*s).rgb;
-    reflColor   += texture2D(reflection,reftexcoord.st+v*s*s).rgb;
-    reflColor   += texture2D(reflection,reftexcoord.st+v*s*s*s).rgb;
-    reflColor   += texture2D(reflection,reftexcoord.st+v*s*s*s*s).rgb;
-    reflColor   += texture2D(reflection,reftexcoord.st+v*s*s*s*s*s).rgb;
-    reflColor   += texture2D(reflection,reftexcoord.st+v*s*s*s*s*s*s).rgb;
-    reflColor   *= 0.125;
+    reflColor += texture2D(reflection,reftexcoord.st+v).rgb;
+    reflColor += texture2D(reflection,reftexcoord.st+v*s).rgb;
+    reflColor += texture2D(reflection,reftexcoord.st+v*s*s).rgb;
+    reflColor += texture2D(reflection,reftexcoord.st+v*s*s*s).rgb;
+    reflColor += texture2D(reflection,reftexcoord.st+v*s*s*s*s).rgb;
+    reflColor += texture2D(reflection,reftexcoord.st+v*s*s*s*s*s).rgb;
+    reflColor += texture2D(reflection,reftexcoord.st+v*s*s*s*s*s*s).rgb;
+    reflColor *= 0.125;
   #endif
 
+    float fresnel    = FresnelMin + FresnelMax * pow(angle,FresnelPower);
     gl_FragColor.rgb = mix(gl_FragColor.rgb, reflColor, fresnel*shallowScale);
 #endif
 
 
 // SPECULAR
     gl_FragColor.rgb += specular*SpecularColor;
+
+// FOG
+    float fog = clamp( (gl_Fog.end - abs(gl_FogFragCoord)) * gl_Fog.scale ,0.0,1.0);
+    gl_FragColor.rgb = mix(gl_Fog.color.rgb, gl_FragColor.rgb, fog );
   }
\ No newline at end of file

Modified: branches/0.77-branch/installer/builddata/springcontent/shaders/bumpWaterVS.glsl
===================================================================
--- branches/0.77-branch/installer/builddata/springcontent/shaders/bumpWaterVS.glsl	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/installer/builddata/springcontent/shaders/bumpWaterVS.glsl	2008-08-20 14:38:09 UTC (rev 6278)
@@ -10,12 +10,42 @@
 
 //////////////////////////////////////////////////
 // runtime defined constants are:
+// #define SurfaceColor     vec4
+// #define DiffuseColor     vec3
+// #define PlaneColor       vec4  (unused)
+// #define AmbientFactor    float
+// #define DiffuseFactor    float   (note: it is the map defined value multipled with 15x!)
+// #define SpecularColor    vec3
+// #define SpecularPower    float
+// #define SpecularFactor   float
+// #define PerlinStartFreq  float
+// #define PerlinFreq       float
+// #define PerlinAmp        float
+// #define Speed            float
+// #define FresnelMin       float
+// #define FresnelMax       float
+// #define FresnelPower     float
+// #define ScreenInverse    vec2
+// #define ViewPos          vec2
 // #define MapMid           vec3
 // #define SunDir           vec3
+// #define ReflDistortion   float
+// #define BlurBase         vec2
+// #define BlurExponent     float
 // #define PerlinStartFreq  float
 // #define PerlinLacunarity float
 // #define PerlinAmp        float
 
+//////////////////////////////////////////////////
+// possible flags are:
+// //#define use_heightmap
+// #define use_reflection
+// #define use_refraction
+// #define use_shorewaves
+// #define use_depth
+// #define blur_reflection
+// #define use_texrect
+
 #define Speed 12.0
 
 uniform float frame;
@@ -27,14 +57,24 @@
 {
 	gl_Position = ftransform();
 
+	// COMPUTE TEXCOORDS
+	vec4 planes        = vec4(gl_ObjectPlaneS[0].x,gl_ObjectPlaneT[0].z,
+	                          gl_ObjectPlaneR[0].x,gl_ObjectPlaneQ[0].z);
+	gl_TexCoord[0]     = planes*gl_Vertex.xzxz;
+
+	// COMPUTE WAVE TEXTURE COORDS
 	const float fstart = PerlinStartFreq;
 	const float f      = PerlinLacunarity;
-	gl_TexCoord[0]     = gl_MultiTexCoord0;
-	gl_TexCoord[1].st = (vec2(-1.0,-1.0)+gl_MultiTexCoord0.st+0.75)*fstart      +frame*Speed;
-	gl_TexCoord[1].pq = (vec2(-1.0, 1.0)+gl_MultiTexCoord0.st+0.50)*fstart*f    -frame*Speed;
-	gl_TexCoord[2].st = (vec2( 1.0,-1.0)+gl_MultiTexCoord0.st+0.25)*fstart*f*f  +frame*Speed*vec2(1.0,-1.0);
-	gl_TexCoord[2].pq = (vec2( 1.0, 1.0)+gl_MultiTexCoord0.st+0.00)*fstart*f*f*f+frame*Speed*vec2(-1.0,1.0);
+	gl_TexCoord[1].st = (vec2(-1.0,-1.0)+gl_TexCoord[0].st+0.75)*fstart      +frame*Speed;
+	gl_TexCoord[1].pq = (vec2(-1.0, 1.0)+gl_TexCoord[0].st+0.50)*fstart*f    -frame*Speed;
+	gl_TexCoord[2].st = (vec2( 1.0,-1.0)+gl_TexCoord[0].st+0.25)*fstart*f*f  +frame*Speed*vec2(1.0,-1.0);
+	gl_TexCoord[2].pq = (vec2( 1.0, 1.0)+gl_TexCoord[0].st+0.00)*fstart*f*f*f+frame*Speed*vec2(-1.0,1.0);
 
+	// COMPUTE LIGHT VECTORS
 	eyeVec = eyePos - gl_Vertex.xyz;
 	ligVec = normalize(SunDir*20000.0 + MapMid - gl_Vertex.xyz);
+
+	// FOG
+	gl_FogFragCoord = (gl_ModelViewMatrix*gl_Vertex).z;
+
 }

Modified: branches/0.77-branch/installer/springsettings.nsh
===================================================================
--- branches/0.77-branch/installer/springsettings.nsh	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/installer/springsettings.nsh	2008-08-20 14:38:09 UTC (rev 6278)
@@ -1,6 +1,6 @@
 !ifdef TEST_BUILD
  !define PRODUCT_NAME &quot;Spring - Test Build&quot;
- !define PRODUCT_VERSION &quot;0.77b1+svn${REVISION}&quot;
+ !define PRODUCT_VERSION &quot;0.77a1+svn${REVISION}&quot;
  !define SP_BASENAME &quot;spring_${PRODUCT_VERSION}&quot;
 !else
  !define PRODUCT_NAME &quot;Spring&quot;

Modified: branches/0.77-branch/rts/Game/CameraHandler.cpp
===================================================================
--- branches/0.77-branch/rts/Game/CameraHandler.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Game/CameraHandler.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -1,6 +1,4 @@
-
 #include &quot;StdAfx.h&quot;
-
 #include &quot;CameraHandler.h&quot;
 
 #include &quot;Game/Action.h&quot;
@@ -25,7 +23,7 @@
 {
 	cameraTime=0.0f;
 	cameraTimeLeft=0.0f;
-	
+
 	// FPS camera must always be the first one in the list
 	std::vector&lt;CCameraController*&gt;&amp; camCtrls = camControllers;
 	camCtrls.push_back(new CFPSController());         // 0
@@ -166,8 +164,8 @@
 		controllerStack.pop();
 	}
 }
-	
 
+
 void CCameraHandler::CameraTransition(float time)
 {
 	time = std::max(time, 0.0f) * cameraTimeFactor;
@@ -242,7 +240,7 @@
 
 	ViewData current;
 	GetState(current);
-	
+
 	if (saved == current) { // load a view twice to return to old settings
 		 if (name != &quot;__old_view&quot;) { // safety: should not happen, but who knows?
 			 return LoadView(&quot;__old_view&quot;);

Modified: branches/0.77-branch/rts/Game/Game.cpp
===================================================================
--- branches/0.77-branch/rts/Game/Game.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Game/Game.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -283,7 +283,7 @@
 	consoleHistory = SAFE_NEW CConsoleHistory;
 	wordCompletion = SAFE_NEW CWordCompletion;
 	for (int pp = 0; pp &lt; MAX_PLAYERS; pp++) {
-	  wordCompletion-&gt;AddWord(gs-&gt;players[pp]-&gt;playerName, false, false, false);
+	  wordCompletion-&gt;AddWord(gs-&gt;players[pp]-&gt;name, false, false, false);
 	}
 
 #ifdef DIRECT_CONTROL_ALLOWED
@@ -435,7 +435,7 @@
 
 	CPlayer* p = gs-&gt;players[gu-&gt;myPlayerNum];
 	if(!gameSetup || net-&gt;localDemoPlayback) {
-		p-&gt;playerName = configHandler.GetString(&quot;name&quot;, &quot;&quot;);
+		p-&gt;name = configHandler.GetString(&quot;name&quot;, &quot;&quot;);
 	} else {
 		GameSetupDrawer::Enable();
 	}
@@ -503,7 +503,7 @@
 	thread.join();
 	logOutput.Print(&quot;Spring %s&quot;,VERSION_STRING);
 	//sending your playername to the server indicates that you are finished loading
-	net-&gt;Send(CBaseNetProtocol::Get().SendPlayerName(gu-&gt;myPlayerNum, p-&gt;playerName));
+	net-&gt;Send(CBaseNetProtocol::Get().SendPlayerName(gu-&gt;myPlayerNum, p-&gt;name));
 
 	if (net-&gt;localDemoPlayback) // auto-start when playing a demo in local mode
 		net-&gt;Send(CBaseNetProtocol::Get().SendStartPlaying(0));
@@ -2731,7 +2731,7 @@
 		}
 	}
 
-	camera-&gt;Update(false);
+	camera-&gt;Update(false); //FIXME: after UpdateWater?
 
 	glClearColor(mapInfo-&gt;atmosphere.fogColor[0], mapInfo-&gt;atmosphere.fogColor[1], mapInfo-&gt;atmosphere.fogColor[2], 0);
 
@@ -2903,7 +2903,7 @@
 			}
 			SNPRINTF(buf, sizeof(buf), &quot;%c%i:%s %s %3.0f%% Ping:%d ms&quot;,
 						(gu-&gt;spectating &amp;&amp; !p-&gt;spectator &amp;&amp; (gu-&gt;myTeam == p-&gt;team)) ? '-' : ' ',
-						p-&gt;team, prefix, p-&gt;playerName.c_str(), p-&gt;cpuUsage * 100.0f,
+						p-&gt;team, prefix, p-&gt;name.c_str(), p-&gt;cpuUsage * 100.0f,
 						(int)(((p-&gt;ping) * 1000) / (GAME_SPEED * gs-&gt;speedFactor)));
 
 			if (!guihandler-&gt;GetOutlineFonts()) {
@@ -3294,20 +3294,20 @@
 					switch (inbuf[2]) {
 						case 1: {
 							if (gs-&gt;players[player]-&gt;spectator) {
-								logOutput.Print(&quot;Spectator %s left&quot;, gs-&gt;players[player]-&gt;playerName.c_str());
+								logOutput.Print(&quot;Spectator %s left&quot;, gs-&gt;players[player]-&gt;name.c_str());
 							} else {
-								logOutput.Print(&quot;Player %s left&quot;, gs-&gt;players[player]-&gt;playerName.c_str());
+								logOutput.Print(&quot;Player %s left&quot;, gs-&gt;players[player]-&gt;name.c_str());
 							}
 							break;
 						}
 						case 2:
-							logOutput.Print(&quot;Player %s has been kicked&quot;, gs-&gt;players[player]-&gt;playerName.c_str());
+							logOutput.Print(&quot;Player %s has been kicked&quot;, gs-&gt;players[player]-&gt;name.c_str());
 							break;
 						case 0:
-							logOutput.Print(&quot;Lost connection to %s&quot;, gs-&gt;players[player]-&gt;playerName.c_str());
+							logOutput.Print(&quot;Lost connection to %s&quot;, gs-&gt;players[player]-&gt;name.c_str());
 							break;
 						default:
-							logOutput.Print(&quot;Player %s left the game (reason unknown: %i)&quot;, gs-&gt;players[player]-&gt;playerName.c_str(), inbuf[2]);
+							logOutput.Print(&quot;Player %s left the game (reason unknown: %i)&quot;, gs-&gt;players[player]-&gt;name.c_str(), inbuf[2]);
 					}
 					gs-&gt;players[player]-&gt;active = false;
 				}
@@ -3386,9 +3386,9 @@
 				else if (!skipping) {
 					gs-&gt;paused=!!inbuf[2];
 					if(gs-&gt;paused){
-						logOutput.Print(&quot;%s paused the game&quot;,gs-&gt;players[player]-&gt;playerName.c_str());
+						logOutput.Print(&quot;%s paused the game&quot;,gs-&gt;players[player]-&gt;name.c_str());
 					} else {
-						logOutput.Print(&quot;%s unpaused the game&quot;,gs-&gt;players[player]-&gt;playerName.c_str());
+						logOutput.Print(&quot;%s unpaused the game&quot;,gs-&gt;players[player]-&gt;name.c_str());
 					}
 					lastframe = SDL_GetTicks();
 				}
@@ -3407,7 +3407,7 @@
 				gs-&gt;userSpeedFactor = *((float*) &amp;inbuf[2]);
 
 				unsigned char pNum = *(unsigned char*) &amp;inbuf[1];
-				const char* pName = (pNum == SERVER_PLAYER)? &quot;server&quot;: gs-&gt;players[pNum]-&gt;playerName.c_str();
+				const char* pName = (pNum == SERVER_PLAYER)? &quot;server&quot;: gs-&gt;players[pNum]-&gt;name.c_str();
 
 				logOutput.Print(&quot;Speed set to %.1f [%s]&quot;, gs-&gt;userSpeedFactor, pName);
 				AddTraffic(pNum, packetCode, dataLength);
@@ -3434,13 +3434,13 @@
 
 			case NETMSG_PLAYERNAME: {
 				int player = inbuf[2];
-				gs-&gt;players[player]-&gt;playerName=(char*)(&amp;inbuf[3]);
+				gs-&gt;players[player]-&gt;name=(char*)(&amp;inbuf[3]);
 				gs-&gt;players[player]-&gt;readyToStart=true;
 				gs-&gt;players[player]-&gt;active=true;
 				if (net-&gt;GetDemoRecorder()) {
 					net-&gt;GetDemoRecorder()-&gt;SetMaxPlayerNum(inbuf[2]);
 				}
-				wordCompletion-&gt;AddWord(gs-&gt;players[player]-&gt;playerName, false, false, false); // required?
+				wordCompletion-&gt;AddWord(gs-&gt;players[player]-&gt;name, false, false, false); // required?
 				AddTraffic(player, packetCode, dataLength);
 				break;
 			}
@@ -3892,7 +3892,7 @@
 				CUnit* ctrlUnit = gs-&gt;players[player]-&gt;playerControlledUnit;
 				if (ctrlUnit) {
 					CUnit* unit=gs-&gt;players[player]-&gt;playerControlledUnit;
-				//logOutput.Print(&quot;Player %s released control over unit %i type %s&quot;,gs-&gt;players[player]-&gt;playerName.c_str(),unit-&gt;id,unit-&gt;unitDef-&gt;humanName.c_str());
+				//logOutput.Print(&quot;Player %s released control over unit %i type %s&quot;,gs-&gt;players[player]-&gt;name.c_str(),unit-&gt;id,unit-&gt;unitDef-&gt;humanName.c_str());
 
 					unit-&gt;directControl=0;
 					unit-&gt;AttackUnit(0,true);
@@ -3901,7 +3901,7 @@
 				else {
 					if(!selectedUnits.netSelected[player].empty() &amp;&amp; uh-&gt;units[selectedUnits.netSelected[player][0]] &amp;&amp; !uh-&gt;units[selectedUnits.netSelected[player][0]]-&gt;weapons.empty()){
 						CUnit* unit = uh-&gt;units[selectedUnits.netSelected[player][0]];
-						//logOutput.Print(&quot;Player %s took control over unit %i type %s&quot;,gs-&gt;players[player]-&gt;playerName.c_str(),unit-&gt;id,unit-&gt;unitDef-&gt;humanName.c_str());
+						//logOutput.Print(&quot;Player %s took control over unit %i type %s&quot;,gs-&gt;players[player]-&gt;name.c_str(),unit-&gt;id,unit-&gt;unitDef-&gt;humanName.c_str());
 						if (unit-&gt;directControl) {
 							if (player == gu-&gt;myPlayerNum) {
 								logOutput.Print(&quot;Sorry someone already controls that unit&quot;);
@@ -4442,9 +4442,9 @@
 		if (!player) {
 			label = &quot;&gt; &quot;;
 		} else if (player-&gt;spectator) {
-			label = &quot;[&quot; + player-&gt;playerName + &quot;] &quot;;
+			label = &quot;[&quot; + player-&gt;name + &quot;] &quot;;
 		} else {
-			label = &quot;&lt;&quot; + player-&gt;playerName + &quot;&gt; &quot;;
+			label = &quot;&lt;&quot; + player-&gt;name + &quot;&gt; &quot;;
 		}
 
 		/*
@@ -4770,7 +4770,7 @@
 	for(int p = 0; p &lt; gs-&gt;activePlayers; ++p) {
 		luaParser.GetTable(p); {
 			const CPlayer* player = gs-&gt;players[p];
-			luaParser.AddString(&quot;name&quot;,     player-&gt;playerName);
+			luaParser.AddString(&quot;name&quot;,     player-&gt;name);
 			luaParser.AddInt(&quot;team&quot;,        player-&gt;team);
 			luaParser.AddBool(&quot;active&quot;,     player-&gt;active);
 			luaParser.AddBool(&quot;spectating&quot;, player-&gt;spectator);

Modified: branches/0.77-branch/rts/Game/GameServer.cpp
===================================================================
--- branches/0.77-branch/rts/Game/GameServer.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Game/GameServer.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -57,11 +57,9 @@
 using boost::format;
 
 GameParticipant::GameParticipant(bool local)
-: name(&quot;unnamed&quot;)
-, readyToStart(false)
+: readyToStart(false)
 , cpuUsage (0.0f)
 , ping (0)
-, team(0)
 , isLocal(local)
 {
 }

Modified: branches/0.77-branch/rts/Game/GameServer.h
===================================================================
--- branches/0.77-branch/rts/Game/GameServer.h	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Game/GameServer.h	2008-08-20 14:38:09 UTC (rev 6278)
@@ -11,6 +11,7 @@
 
 #include &quot;Console.h&quot;
 #include &quot;GameData.h&quot;
+#include &quot;PlayerBase.h&quot;
 #include &quot;System/GlobalStuff.h&quot;
 #include &quot;System/UnsyncedRNG.h&quot;
 #include &quot;SFloat3.h&quot;
@@ -29,20 +30,15 @@
 
 const unsigned SERVER_PLAYER = 255; //server generated message which needs a playernumber
 
-
-//TODO: move to seperate file
-class GameParticipant
+class GameParticipant : public PlayerBase
 {
 public:
 	GameParticipant(bool willHaveRights);
 
-	std::string name;
 	bool readyToStart;
 	float cpuUsage;
 	int ping;
 
-	unsigned team;
-
 	bool isLocal;
 	boost::shared_ptr&lt;netcode::CConnection&gt; link;
 #ifdef SYNCCHECK

Modified: branches/0.77-branch/rts/Game/GameSetup.cpp
===================================================================
--- branches/0.77-branch/rts/Game/GameSetup.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Game/GameSetup.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -2,6 +2,7 @@
 
 #include &lt;algorithm&gt;
 #include &lt;cctype&gt;
+#include &lt;map&gt;
 #include &lt;SDL_timer.h&gt;
 
 #ifndef DEDICATED
@@ -164,36 +165,42 @@
 	int i = 0;
 	for (int a = 0; a &lt; MAX_PLAYERS; ++a) {
 		char section[50];
-		sprintf(section, &quot;GAME\\PLAYER%i\\&quot;, a);
+		sprintf(section, &quot;GAME\\PLAYER%i&quot;, a);
 		string s(section);
 
-		if (!file.SectionExist(s.substr(0, s.length() - 1))) {
+		if (!file.SectionExist(s)) {
 			continue;
 		}
-		PlayerData data;
+		PlayerBase data;
 
 		// expects lines of form team=x rather than team=TEAMx
-		// team field is relocated in RemapTeams		
-		data.team = static_cast&lt;unsigned&gt;(atoi(file.SGetValueDef(&quot;0&quot;,   s + &quot;team&quot;).c_str()));
-		data.rank = atoi(file.SGetValueDef(&quot;-1&quot;,  s + &quot;rank&quot;).c_str());
-		data.name  = file.SGetValueDef(&quot;no name&quot;, s + &quot;name&quot;);
-		data.countryCode = file.SGetValueDef(&quot;&quot;,  s + &quot;countryCode&quot;);
-		data.spectator = static_cast&lt;bool&gt;(atoi(file.SGetValueDef(&quot;0&quot;, s + &quot;spectator&quot;).c_str()));
-		data.isFromDemo = static_cast&lt;bool&gt;(atoi(file.SGetValueDef(&quot;0&quot;,  s + &quot;IsFromDemo&quot;).c_str()));
-		playerStartingData.push_back(data);
+		// team field is relocated in RemapTeams
+		std::map&lt;std::string, std::string&gt; setup = file.GetAllValues(s);
+		std::map&lt;std::string, std::string&gt;::iterator it;
+		if ((it = setup.find(&quot;team&quot;)) != setup.end())
+			data.team = atoi(it-&gt;second.c_str());
+		if ((it = setup.find(&quot;rank&quot;)) != setup.end())
+			data.rank = atoi(it-&gt;second.c_str());
+		if ((it = setup.find(&quot;name&quot;)) != setup.end())
+			data.name = it-&gt;second;
+		if ((it = setup.find(&quot;countryCode&quot;)) != setup.end())
+			data.countryCode = it-&gt;second;
+		if ((it = setup.find(&quot;spectator&quot;)) != setup.end())
+			data.spectator = static_cast&lt;bool&gt;(atoi(it-&gt;second.c_str()));
+		if ((it = setup.find(&quot;IsFromDemo&quot;)) != setup.end())
+			data.isFromDemo = static_cast&lt;bool&gt;(atoi(it-&gt;second.c_str()));
 
-		int fromDemo;
-		file.GetDef(fromDemo, &quot;0&quot;, s + &quot;IsFromDemo&quot;);
-		if (fromDemo)
+		if (data.isFromDemo)
 			numDemoPlayers++;
 
+		playerStartingData.push_back(data);
 		playerRemap[a] = i;
 		++i;
 	}
 
 	int playerCount = -1;
 	file.GetDef(playerCount,   &quot;-1&quot;, &quot;GAME\\NumPlayers&quot;);
-	
+
 	if (playerCount == -1 || playerStartingData.size() == playerCount)
 		numPlayers = playerStartingData.size();
 	else
@@ -248,7 +255,7 @@
 
 	int teamCount = -1;
 	file.GetDef(teamCount, &quot;-1&quot;, &quot;GAME\\NumTeams&quot;);
-	
+
 	if (teamCount == -1 || teamStartingData.size() == teamCount)
 		numTeams = teamStartingData.size();
 	else
@@ -279,8 +286,8 @@
 
 		int numAllies = atoi(file.SGetValueDef(&quot;0&quot;, s + &quot;NumAllies&quot;).c_str());
 
-		for (int i = 0; i &lt; MAX_TEAMS; ++i) {
-			data.allies[i] = (a == i);
+		for (int j = 0; j &lt; MAX_TEAMS; ++j) {
+			data.allies[j] = (a == j);
 		}
 		for (int b = 0; b &lt; numAllies; ++b) {
 			char key[100];
@@ -295,10 +302,10 @@
 		++i;
 	}
 
-	
+
 	int allyCount = -1;
 	file.GetDef(allyCount, &quot;-1&quot;, &quot;GAME\\NumAllyTeams&quot;);
-	
+
 	if (allyCount == -1 || allyStartingData.size() == allyCount)
 		numAllyTeams = allyStartingData.size();
 	else

Modified: branches/0.77-branch/rts/Game/GameSetup.h
===================================================================
--- branches/0.77-branch/rts/Game/GameSetup.h	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Game/GameSetup.h	2008-08-20 14:38:09 UTC (rev 6278)
@@ -7,6 +7,7 @@
 
 #include &quot;SFloat3.h&quot;
 #include &quot;GlobalStuff.h&quot;
+#include &quot;PlayerBase.h&quot;
 
 class TdfParser;
 
@@ -50,19 +51,8 @@
 	
 	StartPosType startPosType;
 	
+	std::vector&lt;PlayerBase&gt; playerStartingData;
 	
-	/// Team the player will start in (read-only)
-	struct PlayerData
-	{
-		unsigned team;
-		int rank;
-		std::string name;
-		std::string countryCode;
-		bool spectator;
-		bool isFromDemo;
-	};
-	std::vector&lt;PlayerData&gt; playerStartingData;
-	
 	struct TeamData
 	{
 		unsigned leader;

Modified: branches/0.77-branch/rts/Game/GameVersion.cpp
===================================================================
--- branches/0.77-branch/rts/Game/GameVersion.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Game/GameVersion.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -7,4 +7,4 @@
 #include &quot;GameVersion.h&quot;
 
 /** The game version. */
-const char* const VERSION_STRING = &quot;0.77a1&quot;;
+const char* const VERSION_STRING = &quot;0.77a1+&quot;;

Modified: branches/0.77-branch/rts/Game/Player.cpp
===================================================================
--- branches/0.77-branch/rts/Game/Player.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Game/Player.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -18,7 +18,7 @@
 
 CR_REG_METADATA(CPlayer, (
 				CR_MEMBER(active),
-				CR_MEMBER(playerName),
+				CR_MEMBER(name),
 				CR_MEMBER(countryCode),
 				CR_MEMBER(rank),
 				CR_MEMBER(spectator),
@@ -56,13 +56,9 @@
 	POP_CODE_MODE;
 
 	active = false;
-	playerName = &quot;Player&quot;;
-	spectator = false;
-	team = 0;
 	readyToStart = false;
 	cpuUsage = 0;
 	ping = 0;
-	rank=-1;
 
 
 #ifdef DIRECT_CONTROL_ALLOWED

Modified: branches/0.77-branch/rts/Game/Player.h
===================================================================
--- branches/0.77-branch/rts/Game/Player.h	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Game/Player.h	2008-08-20 14:38:09 UTC (rev 6278)
@@ -9,6 +9,7 @@
 #include &quot;Platform/byteorder.h&quot;
 #include &quot;float3.h&quot;
 
+#include &quot;PlayerBase.h&quot;
 
 #ifdef DIRECT_CONTROL_ALLOWED
 class CPlayer;
@@ -30,7 +31,7 @@
 #endif
 
 
-class CPlayer  
+class CPlayer : public PlayerBase
 {
 public:
 	CR_DECLARE(CPlayer);
@@ -48,16 +49,10 @@
 	void StartSpectating();
 
 	bool active;
-	std::string playerName;
-	std::string countryCode;
-	int rank;
 
 	int playerNum;
-	bool spectator;
-	int team;
 	bool readyToStart;
 
-
 	float cpuUsage;
 	int ping;
 

Modified: branches/0.77-branch/rts/Game/PlayerRoster.cpp
===================================================================
--- branches/0.77-branch/rts/Game/PlayerRoster.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Game/PlayerRoster.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -238,8 +238,8 @@
 	}
 
 	// sort by player name
-	const std::string aName = StringToLower(aP-&gt;playerName);
-	const std::string bName = StringToLower(bP-&gt;playerName);
+	const std::string aName = StringToLower(aP-&gt;name);
+	const std::string bName = StringToLower(bP-&gt;name);
 	return strcmp(aName.c_str(), bName.c_str());
 }
 

Modified: branches/0.77-branch/rts/Game/SelectedUnits.cpp
===================================================================
--- branches/0.77-branch/rts/Game/SelectedUnits.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Game/SelectedUnits.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -711,7 +711,7 @@
 		// show the player name instead of unit name if it has FBI tag showPlayerName
 		if ((*selectedUnits.begin())-&gt;unitDef-&gt;showPlayerName) {
 			if (gs-&gt;Team((*selectedUnits.begin())-&gt;team)-&gt;leader &gt;= 0)
-				s = gs-&gt;players[gs-&gt;Team((*selectedUnits.begin())-&gt;team)-&gt;leader]-&gt;playerName.c_str();
+				s = gs-&gt;players[gs-&gt;Team((*selectedUnits.begin())-&gt;team)-&gt;leader]-&gt;name.c_str();
 			else
 				s = &quot;Uncontrolled&quot;;
 		} else {

Modified: branches/0.77-branch/rts/Game/Team.cpp
===================================================================
--- branches/0.77-branch/rts/Game/Team.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Game/Team.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -265,7 +265,7 @@
 {
 	if (leader &gt;= 0) {
 		logOutput.Print(CMessages::Tr(&quot;Team%i(%s) is no more&quot;).c_str(),
-		                teamNum, gs-&gt;players[leader]-&gt;playerName.c_str());
+		                teamNum, gs-&gt;players[leader]-&gt;name.c_str());
 	} else {
 		logOutput.Print(CMessages::Tr(&quot;Team%i is no more&quot;).c_str(), teamNum);
 	}

Modified: branches/0.77-branch/rts/Game/UI/EndGameBox.cpp
===================================================================
--- branches/0.77-branch/rts/Game/UI/EndGameBox.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Game/UI/EndGameBox.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -242,7 +242,7 @@
 				continue;
 			char values[6][100];
 
-			sprintf(values[0],&quot;%s&quot;,	gs-&gt;players[a]-&gt;playerName.c_str());
+			sprintf(values[0],&quot;%s&quot;,	gs-&gt;players[a]-&gt;name.c_str());
 			sprintf(values[1],&quot;%i&quot;,(int)(gs-&gt;players[a]-&gt;currentStats-&gt;mouseClicks*60/game-&gt;totalGameTime));
 			sprintf(values[2],&quot;%i&quot;,(int)(gs-&gt;players[a]-&gt;currentStats-&gt;mousePixels*60/game-&gt;totalGameTime));
 			sprintf(values[3],&quot;%i&quot;,(int)(gs-&gt;players[a]-&gt;currentStats-&gt;keyPresses*60/game-&gt;totalGameTime));

Modified: branches/0.77-branch/rts/Game/UI/GameSetupDrawer.cpp
===================================================================
--- branches/0.77-branch/rts/Game/UI/GameSetupDrawer.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Game/UI/GameSetupDrawer.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -144,7 +144,7 @@
 		if (a == gameSetup-&gt;numPlayers) {
 			name = &quot;Players:&quot;;
 		} else {
-			name = gs-&gt;players[a]-&gt;playerName.c_str();
+			name = gs-&gt;players[a]-&gt;name.c_str();
 		}
 		const float fontScale = 1.0f;
 		const float yScale = fontScale * font-&gt;GetHeight();

Modified: branches/0.77-branch/rts/Game/UI/QuitBox.cpp
===================================================================
--- branches/0.77-branch/rts/Game/UI/QuitBox.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Game/UI/QuitBox.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -134,7 +134,7 @@
 
 		std::string teamName;
 		if (gs-&gt;Team(actualTeam)-&gt;leader &gt;= 0)
-			teamName = gs-&gt;players[gs-&gt;Team(actualTeam)-&gt;leader]-&gt;playerName;
+			teamName = gs-&gt;players[gs-&gt;Team(actualTeam)-&gt;leader]-&gt;name;
 		else
 			teamName = &quot;uncontrolled&quot;;
 
@@ -223,8 +223,8 @@
 			// inform other users of the giving away of units
 			char givenAwayMsg[200];
 			sprintf(givenAwayMsg,&quot;%s gave everything to %s.&quot;,
-				gs-&gt;players[gu-&gt;myPlayerNum]-&gt;playerName.c_str(),
-				gs-&gt;players[gs-&gt;Team(shareTeam)-&gt;leader]-&gt;playerName.c_str());
+				gs-&gt;players[gu-&gt;myPlayerNum]-&gt;name.c_str(),
+				gs-&gt;players[gs-&gt;Team(shareTeam)-&gt;leader]-&gt;name.c_str());
 			net-&gt;Send(CBaseNetProtocol::Get().SendSystemMessage(gu-&gt;myPlayerNum, givenAwayMsg));
 		}
 		// resign, so self-d all units

Modified: branches/0.77-branch/rts/Game/UI/ShareBox.cpp
===================================================================
--- branches/0.77-branch/rts/Game/UI/ShareBox.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Game/UI/ShareBox.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -186,7 +186,7 @@
 		std::string teamName;
 
 		if (gs-&gt;Team(actualTeam)-&gt;leader &gt;= 0) {
-			teamName = gs-&gt;players[gs-&gt;Team(actualTeam)-&gt;leader]-&gt;playerName;
+			teamName = gs-&gt;players[gs-&gt;Team(actualTeam)-&gt;leader]-&gt;name;
 		} else {
 			teamName = &quot;Uncontrolled&quot;;
 		}

Modified: branches/0.77-branch/rts/Game/UI/TooltipConsole.cpp
===================================================================
--- branches/0.77-branch/rts/Game/UI/TooltipConsole.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Game/UI/TooltipConsole.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -207,7 +207,7 @@
 	// show the player name instead of unit name if it has FBI tag showPlayerName
 	if (effectiveDef-&gt;showPlayerName) {
 		if (gs-&gt;Team(unit-&gt;team)-&gt;leader &gt;= 0) {
-			s = gs-&gt;players[gs-&gt;Team(unit-&gt;team)-&gt;leader]-&gt;playerName.c_str();
+			s = gs-&gt;players[gs-&gt;Team(unit-&gt;team)-&gt;leader]-&gt;name.c_str();
 		} else {
 			s = &quot;Uncontrolled&quot;;
 		}

Modified: branches/0.77-branch/rts/Lua/LuaIO.cpp
===================================================================
--- branches/0.77-branch/rts/Lua/LuaIO.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Lua/LuaIO.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -1,149 +1,153 @@
-#include &quot;StdAfx.h&quot;
-// LuaIO.cpp: implementation of the LuaIO class.
-//
-//////////////////////////////////////////////////////////////////////
-
-#include &quot;LuaIO.h&quot;
-
-#include &lt;stdio.h&gt;
-#include &lt;errno.h&gt;
-#include &lt;unistd.h&gt;
-#include &lt;string&gt;
-using std::string;
-
-#include &quot;LuaHandle.h&quot;
-#include &quot;LuaInclude.h&quot;
-#include &quot;System/Platform/FileSystem.h&quot;
-
-
-/******************************************************************************/
-/******************************************************************************/
-
-static bool IsSafePath(const string&amp; path)
-{
-	// keep searches within the Spring directory
-	if ((path[0] == '/') || (path[0] == '\\') ||
-	    ((path.size() &gt;= 2) &amp;&amp; (path[1] == ':'))) {
-		return false;
-	}
-	if (path.find(&quot;..&quot;) != string::npos) {
-		return false;
-	}
-	return true;
-}
-
-
-/******************************************************************************/
-/******************************************************************************/
-
-bool LuaIO::IsSimplePath(const string&amp; path)
-{
-	// keep searches within the Spring directory
-	if ((path[0] == '/') || (path[0] == '\\') ||
-	    ((path.size() &gt;= 2) &amp;&amp; (path[1] == ':'))) {
-		return false;
-	}
-	if (path.find(&quot;..&quot;) != string::npos) {
-		return false;
-	}
-	return true;
-}
-
-
-bool LuaIO::SafeExecPath(const string&amp; path)
-{
-	return false; // don't allow execution of external programs, yet
-}
-
-
-bool LuaIO::SafeReadPath(const string&amp; path)
-{
-	return filesystem.InReadDir(path);
-}
-
-
-bool LuaIO::SafeWritePath(const string&amp; path)
-{
-	string prefix = &quot;&quot;; // FIXME
-#if !defined UNITSYNC &amp;&amp; !defined DEDICATED
-	const CLuaHandle* lh = CLuaHandle::GetActiveHandle();
-	if (lh != NULL) {
-		prefix = lh-&gt;GetName() + &quot;/&quot; + &quot;Write&quot;;
-	}
-#endif
-	return filesystem.InWriteDir(path, prefix);
-}
-
-
-/******************************************************************************/
-/******************************************************************************/
-
-FILE* LuaIO::fopen(lua_State* L, const char* path, const char* mode)
-{
-	bool read  = false;
-	bool write = false;
-
-	// check the mode string
-	const string modeStr = StringToLower(mode);
-	if (modeStr.find_first_not_of(&quot;rwabt+&quot;) != string::npos) {
-		errno = EINVAL;
-		return NULL;
-	}
-	if (!IsSafePath(path)) {
-		errno = EPERM; //EACCESS?
-		return NULL;
-	}
-	return ::fopen(path, mode);
-}
-
-
-FILE* LuaIO::popen(lua_State* L, const char* command, const char* type)
-{
-	// check the type string
-	const string typeStr = StringToLower(type);
-	if (typeStr.find_first_not_of(&quot;rw&quot;) != string::npos) {
-		errno = EINVAL;
-		return NULL;
-	}
-	errno = EINVAL;	
-	return NULL;
-}
-
-
-int LuaIO::pclose(lua_State* L, FILE* stream)
-{
-	errno = ECHILD;	
-	return -1;
-}
-
-
-int LuaIO::system(lua_State* L, const char* command)
-{
-	luaL_error(L, &quot;the system() call is not available&quot;);
-	return -1; //
-}
-
-
-int LuaIO::remove(lua_State* L, const char* pathname)
-{
-	if (!SafeWritePath(pathname)) {
-		errno = EPERM; //EACCESS?
-		return -1;
-	}
-	return ::remove(pathname);
-}
-
-
-int LuaIO::rename(lua_State* L, const char* oldpath, const char* newpath)
-{
-	if (!SafeWritePath(oldpath) ||
-			!SafeWritePath(newpath)) {
-		errno = EPERM; //EACCESS?
-		return -1;
-	}
-	return ::rename(oldpath, newpath);
-}
-
-
-/******************************************************************************/
-/******************************************************************************/
+#include &quot;StdAfx.h&quot;
+// LuaIO.cpp: implementation of the LuaIO class.
+//
+//////////////////////////////////////////////////////////////////////
+
+#include &quot;LuaIO.h&quot;
+
+#include &lt;stdio.h&gt;
+#include &lt;errno.h&gt;
+
+#ifndef _MSC_VER	// this header file does not exist for the microsoft compiler
+ #include &lt;unistd.h&gt;
+#endif
+
+#include &lt;string&gt;
+using std::string;
+
+#include &quot;LuaHandle.h&quot;
+#include &quot;LuaInclude.h&quot;
+#include &quot;System/Platform/FileSystem.h&quot;
+
+
+/******************************************************************************/
+/******************************************************************************/
+
+static bool IsSafePath(const string&amp; path)
+{
+	// keep searches within the Spring directory
+	if ((path[0] == '/') || (path[0] == '\\') ||
+	    ((path.size() &gt;= 2) &amp;&amp; (path[1] == ':'))) {
+		return false;
+	}
+	if (path.find(&quot;..&quot;) != string::npos) {
+		return false;
+	}
+	return true;
+}
+
+
+/******************************************************************************/
+/******************************************************************************/
+
+bool LuaIO::IsSimplePath(const string&amp; path)
+{
+	// keep searches within the Spring directory
+	if ((path[0] == '/') || (path[0] == '\\') ||
+	    ((path.size() &gt;= 2) &amp;&amp; (path[1] == ':'))) {
+		return false;
+	}
+	if (path.find(&quot;..&quot;) != string::npos) {
+		return false;
+	}
+	return true;
+}
+
+
+bool LuaIO::SafeExecPath(const string&amp; path)
+{
+	return false; // don't allow execution of external programs, yet
+}
+
+
+bool LuaIO::SafeReadPath(const string&amp; path)
+{
+	return filesystem.InReadDir(path);
+}
+
+
+bool LuaIO::SafeWritePath(const string&amp; path)
+{
+	string prefix = &quot;&quot;; // FIXME
+#if !defined UNITSYNC &amp;&amp; !defined DEDICATED
+	const CLuaHandle* lh = CLuaHandle::GetActiveHandle();
+	if (lh != NULL) {
+		prefix = lh-&gt;GetName() + &quot;/&quot; + &quot;Write&quot;;
+	}
+#endif
+	return filesystem.InWriteDir(path, prefix);
+}
+
+
+/******************************************************************************/
+/******************************************************************************/
+
+FILE* LuaIO::fopen(lua_State* L, const char* path, const char* mode)
+{
+	bool read  = false;
+	bool write = false;
+
+	// check the mode string
+	const string modeStr = StringToLower(mode);
+	if (modeStr.find_first_not_of(&quot;rwabt+&quot;) != string::npos) {
+		errno = EINVAL;
+		return NULL;
+	}
+	if (!IsSafePath(path)) {
+		errno = EPERM; //EACCESS?
+		return NULL;
+	}
+	return ::fopen(path, mode);
+}
+
+
+FILE* LuaIO::popen(lua_State* L, const char* command, const char* type)
+{
+	// check the type string
+	const string typeStr = StringToLower(type);
+	if (typeStr.find_first_not_of(&quot;rw&quot;) != string::npos) {
+		errno = EINVAL;
+		return NULL;
+	}
+	errno = EINVAL;	
+	return NULL;
+}
+
+
+int LuaIO::pclose(lua_State* L, FILE* stream)
+{
+	errno = ECHILD;	
+	return -1;
+}
+
+
+int LuaIO::system(lua_State* L, const char* command)
+{
+	luaL_error(L, &quot;the system() call is not available&quot;);
+	return -1; //
+}
+
+
+int LuaIO::remove(lua_State* L, const char* pathname)
+{
+	if (!SafeWritePath(pathname)) {
+		errno = EPERM; //EACCESS?
+		return -1;
+	}
+	return ::remove(pathname);
+}
+
+
+int LuaIO::rename(lua_State* L, const char* oldpath, const char* newpath)
+{
+	if (!SafeWritePath(oldpath) ||
+			!SafeWritePath(newpath)) {
+		errno = EPERM; //EACCESS?
+		return -1;
+	}
+	return ::rename(oldpath, newpath);
+}
+
+
+/******************************************************************************/
+/******************************************************************************/

Modified: branches/0.77-branch/rts/Lua/LuaSyncedCtrl.cpp
===================================================================
--- branches/0.77-branch/rts/Lua/LuaSyncedCtrl.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Lua/LuaSyncedCtrl.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -2562,13 +2562,13 @@
 	int x1, x2, z1, z2;
 	ParseMapParams(L, __FUNCTION__, height, x1, z1, x2, z2);
 
-	float* heightMap = readmap-&gt;GetHeightmap();
 	for (int z = z1; z &lt;= z2; z++) {
 		for (int x = x1; x &lt;= x2; x++) {
 			const int index = (z * (gs-&gt;mapx + 1)) + x;
-			heightMap[index] = height;
+			readmap-&gt;SetHeight(index, height);
 		}
 	}
+
 	mapDamage-&gt;RecalcArea(x1, x2, z1, z2);
 	return 0;
 }
@@ -2583,13 +2583,13 @@
 	int x1, x2, z1, z2;
 	ParseMapParams(L, __FUNCTION__, height, x1, z1, x2, z2);
 
-	float* heightMap = readmap-&gt;GetHeightmap();
 	for (int z = z1; z &lt;= z2; z++) {
 		for (int x = x1; x &lt;= x2; x++) {
 			const int index = (z * (gs-&gt;mapx + 1)) + x;
-			heightMap[index] += height;
+			readmap-&gt;AddHeight(index, height);
 		}
 	}
+
 	mapDamage-&gt;RecalcArea(x1, x2, z1, z2);
 	return 0;
 }
@@ -2604,13 +2604,15 @@
 	int x1, x2, z1, z2;
 	ParseMapParams(L, __FUNCTION__, origFactor, x1, z1, x2, z2);
 
-	float* origMap = readmap-&gt;orgheightmap;
-	float* currMap = readmap-&gt;GetHeightmap();
+	const float* origMap = readmap-&gt;orgheightmap;
+	const float* currMap = readmap-&gt;GetHeightmap();
+
 	if (origFactor == 1.0f) {
 		for (int z = z1; z &lt;= z2; z++) {
 			for (int x = x1; x &lt;= x2; x++) {
-				const int index = (z * (gs-&gt;mapx + 1)) + x;
-				currMap[index] = origMap[index];
+				const int idx = (z * (gs-&gt;mapx + 1)) + x;
+
+				readmap-&gt;SetHeight(idx, origMap[idx]);
 			}
 		}
 	}
@@ -2619,11 +2621,13 @@
 		for (int z = z1; z &lt;= z2; z++) {
 			for (int x = x1; x &lt;= x2; x++) {
 				const int index = (z * (gs-&gt;mapx + 1)) + x;
-				currMap[index] = (origFactor * origMap[index]) +
-				                 (currFactor * currMap[index]);
+				const float ofh = origFactor * origMap[index];
+				const float cfh = currFactor * currMap[index];
+				readmap-&gt;SetHeight(index, ofh + cfh);
 			}
 		}
 	}
+
 	mapDamage-&gt;RecalcArea(x1, x2, z1, z2);
 	return 0;
 }
@@ -2652,8 +2656,7 @@
 	}
 
 	const int index = (z * (gs-&gt;mapx + 1)) + x;
-	float&amp; heightMap = readmap-&gt;GetHeightmap()[index];
-	heightMap += h;
+	const float oldHeight = readmap-&gt;GetHeightmap()[index];
 	heightMapAmountChanged += streflop::fabsf(h);
 
 	// update RecalcArea()
@@ -2662,7 +2665,9 @@
 	if (z &lt; heightMapz1) { heightMapz1 = z; }
 	if (z &gt; heightMapz2) { heightMapz2 = z; }
 
-	lua_pushnumber(L, heightMap);
+	readmap-&gt;AddHeight(index, h);
+	// push the new height
+	lua_pushnumber(L, oldHeight + h);
 	return 1;
 }
 
@@ -2688,17 +2693,17 @@
 	}
 
 	const int index = (z * (gs-&gt;mapx + 1)) + x;
-	float&amp; heightMap = readmap-&gt;GetHeightmap()[index];
-	const float oldHeight = heightMap;
+	const float oldHeight = readmap-&gt;GetHeightmap()[index];
+	float height = oldHeight;
 
 	if (lua_israwnumber(L, 4)) {
 		const float t = lua_tofloat(L, 4);
-		heightMap += (h - heightMap) * t;
+		height += (h - oldHeight) * t;
 	} else{
-		heightMap = h;
+		height = h;
 	}
 
-	const float heightDiff = (heightMap - oldHeight);
+	const float heightDiff = (height - oldHeight);
 	heightMapAmountChanged += streflop::fabsf(heightDiff);
 
 	// update RecalcArea()
@@ -2707,6 +2712,7 @@
 	if (z &lt; heightMapz1) { heightMapz1 = z; }
 	if (z &gt; heightMapz2) { heightMapz2 = z; }
 
+	readmap-&gt;SetHeight(index, height);
 	lua_pushnumber(L, heightDiff);
 	return 1;
 }

Modified: branches/0.77-branch/rts/Lua/LuaSyncedRead.cpp
===================================================================
--- branches/0.77-branch/rts/Lua/LuaSyncedRead.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Lua/LuaSyncedRead.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -1228,7 +1228,7 @@
 	if (CLuaHandle::GetActiveHandle()-&gt;GetSynced()) {
 		HSTR_PUSH(L, &quot;SYNCED_NONAME&quot;);
 	} else {
-		lua_pushstring(L, player-&gt;playerName.c_str());
+		lua_pushstring(L, player-&gt;name.c_str());
 	}
 	lua_pushboolean(L, player-&gt;active);
 	lua_pushboolean(L, player-&gt;spectator);
@@ -2342,7 +2342,7 @@
 	const UnitDef* decoyDef = IsAllyUnit(unit) ? NULL : unitDef-&gt;decoyDef;
 	const UnitDef* effectiveDef = EffectiveUnitDef(unit);
 	if (effectiveDef-&gt;showPlayerName) {
-		tooltip = gs-&gt;players[gs-&gt;Team(unit-&gt;team)-&gt;leader]-&gt;playerName;
+		tooltip = gs-&gt;players[gs-&gt;Team(unit-&gt;team)-&gt;leader]-&gt;name;
 	} else {
 		if (!decoyDef) {
 			tooltip = unit-&gt;tooltip;
@@ -2576,7 +2576,7 @@
 	lua_newtable(L);            \
 	lua_pushnumber(L, 1); lua_pushnumber(L, unit-&gt; n .x); lua_rawset(L, -3); \
 	lua_pushnumber(L, 2); lua_pushnumber(L, unit-&gt; n .y); lua_rawset(L, -3); \
-	lua_pushnumber(L, 3); lua_pushnumber(L, unit-&gt; n .z); lua_rawset(L, -3);
+	lua_pushnumber(L, 3); lua_pushnumber(L, unit-&gt; n .z); lua_rawset(L, -3)
 
 	PACK_VECTOR(frontdir);
 	PACK_VECTOR(updir);

Modified: branches/0.77-branch/rts/Lua/LuaUnsyncedCtrl.cpp
===================================================================
--- branches/0.77-branch/rts/Lua/LuaUnsyncedCtrl.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Lua/LuaUnsyncedCtrl.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -375,14 +375,14 @@
 		luaL_error(L, &quot;Invalid message playerID: %i&quot;, playerID);
 	}
 	const CPlayer* player = gs-&gt;players[playerID];
-	if ((player == NULL) || !player-&gt;active || player-&gt;playerName.empty()) {
+	if ((player == NULL) || !player-&gt;active || player-&gt;name.empty()) {
 		luaL_error(L, &quot;Invalid message playerID: %i&quot;, playerID);
 	}
 
 	const string head = msg.substr(0, start);
 	const string tail = msg.substr(endPtr - msg.c_str() + 1);
 
-	return head + player-&gt;playerName + ParseMessage(L, tail);
+	return head + player-&gt;name + ParseMessage(L, tail);
 }
 
 

Modified: branches/0.77-branch/rts/Lua/LuaUnsyncedRead.cpp
===================================================================
--- branches/0.77-branch/rts/Lua/LuaUnsyncedRead.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Lua/LuaUnsyncedRead.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -1099,7 +1099,7 @@
 	const CPlayer* p = gs-&gt;players[playerID];
 	int index = 1;
 	lua_newtable(L);
-	PUSH_ROSTER_ENTRY(string, p-&gt;playerName.c_str());
+	PUSH_ROSTER_ENTRY(string, p-&gt;name.c_str());
 	PUSH_ROSTER_ENTRY(number, playerID);
 	PUSH_ROSTER_ENTRY(number, p-&gt;team);
 	PUSH_ROSTER_ENTRY(number, gs-&gt;AllyTeam(p-&gt;team));

Modified: branches/0.77-branch/rts/Map/BaseGroundDrawer.cpp
===================================================================
--- branches/0.77-branch/rts/Map/BaseGroundDrawer.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Map/BaseGroundDrawer.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -18,6 +18,7 @@
 #include &quot;Sim/Units/UnitDefHandler.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
 #include &quot;System/Platform/ConfigHandler.h&quot;
+#include &quot;System/FastMath.h&quot;
 #include &quot;mmgr.h&quot;
 
 
@@ -25,7 +26,9 @@
 {
 	updateFov = true;
 
-	striptype = GL_TRIANGLE_STRIP;
+	LODScaleReflection = configHandler.GetFloat(&quot;GroundLODScaleReflection&quot;, 1.0f);
+	LODScaleRefraction = configHandler.GetFloat(&quot;GroundLODScaleRefraction&quot;, 1.0f);
+	LODScaleUnitReflection = configHandler.GetFloat(&quot;GroundLODScaleUnitReflection&quot;, 1.0f);
 
 	infoTexAlpha = 0.25f;
 	infoTex = 0;
@@ -295,7 +298,7 @@
 						if (myAirLos[alx + (aly * loshandler-&gt;airSizeX)]) {
 							float extractDepth = extractDepthMap[(y * gs-&gt;hmapx) + x];
 							// a single pow(x, 0.25) call would be faster?
-							infoTexMem[a*4]=(unsigned char)std::min(255.0f,(float)sqrt(sqrt(extractDepth))*900);
+							infoTexMem[a*4]=(unsigned char)std::min(255.0f,(float)fastmath::sqrt(fastmath::sqrt(extractDepth))*900);
 						} else {
 							infoTexMem[a*4]=0;
 						}

Modified: branches/0.77-branch/rts/Map/BaseGroundDrawer.h
===================================================================
--- branches/0.77-branch/rts/Map/BaseGroundDrawer.h	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Map/BaseGroundDrawer.h	2008-08-20 14:38:09 UTC (rev 6278)
@@ -53,7 +53,10 @@
 	bool drawLineOfSight;
 	bool wireframe;
 
-	int striptype;
+	float LODScaleReflection;
+	float LODScaleRefraction;
+	float LODScaleUnitReflection;
+
 	GLuint infoTex;
 
 	unsigned char* infoTexMem;
@@ -66,16 +69,16 @@
 
 	int updateTextureState;
 
+	DrawMode drawMode;
+
 	float infoTexAlpha;
 
-	DrawMode drawMode;
-
 	int jamColor[3];
 	int losColor[3];
 	int radarColor[3];
 	int alwaysColor[3];
 	static const int losColorScale = 10000;
-	
+
 	bool highResLosTex;
 // 	bool smoothLosTex;
 

Modified: branches/0.77-branch/rts/Map/BasicMapDamage.cpp
===================================================================
--- branches/0.77-branch/rts/Map/BasicMapDamage.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Map/BasicMapDamage.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -5,6 +5,7 @@
 #include &quot;BaseGroundDrawer.h&quot;
 #include &quot;HeightMapTexture.h&quot;
 #include &quot;Rendering/Env/BaseTreeDrawer.h&quot;
+#include &quot;Rendering/Env/BaseWater.h&quot;
 #include &quot;TimeProfiler.h&quot;
 #include &quot;Sim/Misc/GroundBlockingObjectMap.h&quot;
 #include &quot;Sim/Misc/LosHandler.h&quot;
@@ -18,6 +19,7 @@
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;mmgr.h&quot;
 
+
 CBasicMapDamage::CBasicMapDamage(void)
 {
 	const int numQuads = qf-&gt;GetNumQuadsX() * qf-&gt;GetNumQuadsZ();
@@ -53,95 +55,108 @@
 	delete[] inRelosQue;
 }
 
-void CBasicMapDamage::Explosion(const float3&amp; pos, float strength,float radius)
+void CBasicMapDamage::Explosion(const float3&amp; pos, float strength, float radius)
 {
-	if(pos.x&lt;0 || pos.z&lt;0 || pos.x&gt;gs-&gt;mapx*SQUARE_SIZE || pos.z&gt;gs-&gt;mapy*SQUARE_SIZE){
-//		logOutput.Print(&quot;Map damage explosion outside map %.0f %.0f&quot;,pos.x,pos.z);
+	if (pos.x &lt; 0.0f || pos.z &lt; 0.0f || pos.x &gt; gs-&gt;mapx * SQUARE_SIZE || pos.z &gt; gs-&gt;mapy * SQUARE_SIZE) {
 		return;
 	}
-	if(strength&lt;10 || radius&lt;8)
+
+	if (strength &lt; 10.0f || radius &lt; 8.0f)
 		return;
 
-	radius*=1.5f;
+	radius *= 1.5f;
 
-	Explo* e=SAFE_NEW Explo;
-	e-&gt;pos=pos;
-	e-&gt;strength=strength;
-	e-&gt;ttl=10;
-	e-&gt;x1=std::max((int)(pos.x-radius)/SQUARE_SIZE,2);
-	e-&gt;x2=std::min((int)(pos.x+radius)/SQUARE_SIZE,gs-&gt;mapx-3);
-	e-&gt;y1=std::max((int)(pos.z-radius)/SQUARE_SIZE,2);
-	e-&gt;y2=std::min((int)(pos.z+radius)/SQUARE_SIZE,gs-&gt;mapy-3);
+	Explo* e = SAFE_NEW Explo;
+	e-&gt;pos = pos;
+	e-&gt;strength = strength;
+	e-&gt;ttl = 10;
+	e-&gt;x1 = std::max((int) (pos.x - radius) / SQUARE_SIZE,            2);
+	e-&gt;x2 = std::min((int) (pos.x + radius) / SQUARE_SIZE, gs-&gt;mapx - 3);
+	e-&gt;y1 = std::max((int) (pos.z - radius) / SQUARE_SIZE,            2);
+	e-&gt;y2 = std::min((int) (pos.z + radius) / SQUARE_SIZE, gs-&gt;mapy - 3);
+	e-&gt;squares.reserve((e-&gt;y2 - e-&gt;y1 + 1) * (e-&gt;x2 - e-&gt;x1 + 1));
 
-	float* heightmap = readmap-&gt;GetHeightmap();
-	float baseStrength=-pow(strength,0.6f)*3/mapHardness;
-	float invRadius=1.0f/radius;
-	for(int y=e-&gt;y1;y&lt;=e-&gt;y2;++y){
-		for(int x=e-&gt;x1;x&lt;=e-&gt;x2;++x){
+	const float* heightmap = readmap-&gt;GetHeightmap();
+	float baseStrength = -pow(strength, 0.6f) * 3 / mapHardness;
+	float invRadius = 1.0f / radius;
+
+	for (int y = e-&gt;y1; y &lt;= e-&gt;y2; ++y) {
+		for (int x = e-&gt;x1; x &lt;= e-&gt;x2; ++x) {
 			CSolidObject* so = groundBlockingObjectMap-&gt;GroundBlockedUnsafe(y * gs-&gt;mapx + x);
-			// don't change squares with building on them here
+			// don't change squares with buildings on them here
 			if (so &amp;&amp; so-&gt;blockHeightChanges) {
 				e-&gt;squares.push_back(0);
 				continue;
 			}
-			float dist=pos.distance2D(float3(x*SQUARE_SIZE,0,y*SQUARE_SIZE));							//calculate the distance
-			float relDist=dist*invRadius;																					//normalize distance
-			float dif=baseStrength*craterTable[int(relDist*200)]*invHardness[readmap-&gt;typemap[(y/2)*gs-&gt;hmapx+x/2]];
 
-			float prevDif=heightmap[y*(gs-&gt;mapx+1)+x]-readmap-&gt;orgheightmap[y*(gs-&gt;mapx+1)+x];
+			// calculate the distance and normalize it
+			float dist = pos.distance2D(float3(x * SQUARE_SIZE, 0, y * SQUARE_SIZE));
+			float relDist = dist * invRadius;
+			float dif =
+				baseStrength * craterTable[int(relDist * 200)] *
+				invHardness[readmap-&gt;typemap[(y / 2) * gs-&gt;hmapx + x / 2]];
 
-//			prevDif+=dif*5;
+			float prevDif = heightmap[y * (gs-&gt;mapx + 1) + x] - readmap-&gt;orgheightmap[y * (gs-&gt;mapx + 1) + x];
 
-			if(prevDif*dif&gt;0)
-				dif/=fabs(prevDif)*0.1f+1;
+			if (prevDif * dif &gt; 0)
+				dif /= fabs(prevDif) * 0.1f + 1;
+
 			e-&gt;squares.push_back(dif);
-			if(dif&lt;-0.3f &amp;&amp; strength&gt;200)
-				treeDrawer-&gt;RemoveGrass(x,y);
+
+			if (dif &lt; -0.3f &amp;&amp; strength &gt; 200)
+				treeDrawer-&gt;RemoveGrass(x, y);
 		}
 	}
+
 	// calculate how much to offset the buildings in the explosion radius with
 	// (while still keeping the ground under them flat)
-	std::vector&lt;CUnit*&gt; units=qf-&gt;GetUnitsExact(pos,radius);
-	for(std::vector&lt;CUnit*&gt;::iterator ui=units.begin();ui!=units.end();++ui){
-		if((*ui)-&gt;blockHeightChanges &amp;&amp; (*ui)-&gt;isMarkedOnBlockingMap){
-			CUnit* unit=*ui;
+	std::vector&lt;CUnit*&gt; units = qf-&gt;GetUnitsExact(pos, radius);
+	for (std::vector&lt;CUnit*&gt;::iterator ui = units.begin(); ui != units.end(); ++ui) {
+		if ((*ui)-&gt;blockHeightChanges &amp;&amp; (*ui)-&gt;isMarkedOnBlockingMap) {
+			CUnit* unit = *ui;
+			float totalDif = 0.0f;
 
-			float totalDif=0;
-			for(int z=unit-&gt;mapPos.y; z&lt;unit-&gt;mapPos.y+unit-&gt;ysize; z++){
-				for(int x=unit-&gt;mapPos.x; x&lt;unit-&gt;mapPos.x+unit-&gt;xsize; x++){
-					float dist=pos.distance2D(float3(x*SQUARE_SIZE,0,z*SQUARE_SIZE));							//calculate the distance
-					float relDist=dist*invRadius;																					//normalize distance
-					float dif=baseStrength*craterTable[int(relDist*200)]*invHardness[readmap-&gt;typemap[(z/2)*gs-&gt;hmapx+x/2]];
-					float prevDif=heightmap[z*(gs-&gt;mapx+1)+x]-readmap-&gt;orgheightmap[z*(gs-&gt;mapx+1)+x];
+			for (int z = unit-&gt;mapPos.y; z &lt; unit-&gt;mapPos.y + unit-&gt;ysize; z++) {
+				for (int x = unit-&gt;mapPos.x; x &lt; unit-&gt;mapPos.x + unit-&gt;xsize; x++) {
+					// calculate the distance and normalize it
+					float dist = pos.distance2D(float3(x * SQUARE_SIZE, 0, z * SQUARE_SIZE));
+					float relDist = dist * invRadius;
+					float dif =
+						baseStrength * craterTable[int(relDist * 200)] *
+						invHardness[readmap-&gt;typemap[(z / 2) * gs-&gt;hmapx + x / 2]];
+					float prevDif = heightmap[z * (gs-&gt;mapx + 1) + x] - readmap-&gt;orgheightmap[z * (gs-&gt;mapx + 1) + x];
 
-					if(prevDif*dif&gt;0)
-						dif/=fabs(prevDif)*0.1f+1;
-					totalDif+=dif;
+					if (prevDif * dif &gt; 0)
+						dif /= fabs(prevDif) * 0.1f + 1;
+
+					totalDif += dif;
 				}
 			}
-			totalDif/=unit-&gt;xsize*unit-&gt;ysize;
-			if(totalDif!=0){
+
+			totalDif /= unit-&gt;xsize * unit-&gt;ysize;
+			if (totalDif != 0) {
 				ExploBuilding eb;
-				eb.id=(*ui)-&gt;id;
-				eb.dif=totalDif;
-				eb.tx1=unit-&gt;mapPos.x;
-				eb.tx2=unit-&gt;mapPos.x+unit-&gt;xsize;
-				eb.tz1=unit-&gt;mapPos.y;
-				eb.tz2=unit-&gt;mapPos.y+unit-&gt;ysize;
+				eb.id = (*ui)-&gt;id;
+				eb.dif = totalDif;
+				eb.tx1 = unit-&gt;mapPos.x;
+				eb.tx2 = unit-&gt;mapPos.x + unit-&gt;xsize;
+				eb.tz1 = unit-&gt;mapPos.y;
+				eb.tz2 = unit-&gt;mapPos.y + unit-&gt;ysize;
 				e-&gt;buildings.push_back(eb);
 			}
 		}
 	}
 
 	explosions.push_back(e);
-
-	readmap-&gt;Explosion(pos.x,pos.z,strength);
+	readmap-&gt;Explosion(pos.x, pos.z, strength);
 }
 
 void CBasicMapDamage::RecalcArea(int x1, int x2, int y1, int y2)
 {
-	float* heightmap = readmap-&gt;GetHeightmap();
+	const float* heightmap = readmap-&gt;GetHeightmap();
 	float* centerheightmap = readmap-&gt;centerheightmap;
+
+	// reads from heightmap, writes to centerheightmap
 	for (int y = y1; y &lt; y2; y++) {
 		for (int x = x1; x &lt; x2; x++) {
 			const float height = heightmap[((y)     * (gs-&gt;mapx + 1)) + (x)    ]
@@ -152,96 +167,101 @@
 		}
 	}
 
-	/*int hy2=min(gs-&gt;hmapy-1,y2/2);
-	int hx2=min(gs-&gt;hmapx-1,x2/2);
-	for(int y=y1/2;y&lt;=hy2;y++)
-		for(int x=x1/2;x&lt;=hx2;x++)
-			readmap-&gt;mipHeightmap[1][y*gs-&gt;hmapx+x]=heightmap[(y*2+1)*(gs-&gt;mapx+1)+(x*2+1)];*/
-
 	float numHeightMipMaps = readmap-&gt;numHeightMipMaps - 1;
 	float** mipHeightmap = readmap-&gt;mipHeightmap;
+
+	// reads from mipHeightmap[i], writes to mipHeightmap[i + 1]
 	for (int i = 0; i &lt; numHeightMipMaps; i++) {
 		int hmapx = gs-&gt;mapx &gt;&gt; i;
 		for (int y = ((y1 &gt;&gt; i) &amp; (~1)); y &lt; (y2 &gt;&gt; i); y += 2) {
 			for (int x = ((x1 &gt;&gt; i) &amp; (~1)); x &lt; (x2 &gt;&gt; i); x += 2) {
-				float height = mipHeightmap[i][(x)+(y)*hmapx];
-				height += mipHeightmap[i][(x)  +(y+1)*hmapx];
-				height += mipHeightmap[i][(x+1)+(y)  *hmapx];
-				height += mipHeightmap[i][(x+1)+(y+1)*hmapx];
-				mipHeightmap[i+1][(x/2)+(y/2)*hmapx/2] = height * 0.25f;
+				float height = mipHeightmap[i][(x    ) + (y    ) * hmapx];
+				height +=      mipHeightmap[i][(x    ) + (y + 1) * hmapx];
+				height +=      mipHeightmap[i][(x + 1) + (y    ) * hmapx];
+				height +=      mipHeightmap[i][(x + 1) + (y + 1) * hmapx];
+				mipHeightmap[i + 1][(x + (y * hmapx) / 2) / 2] = height * 0.25f;
 			}
 		}
 	}
 
-	float3 n1,n2,n3,n4;
-	int decy=std::max(0,y1-1);
-	int incy=std::min(gs-&gt;mapy-1,y2+1);
-	int decx=std::max(0,x1-1);
-	int incx=std::min(gs-&gt;mapx-1,x2+1);
+	int decy = std::max(           0, y1 - 1);
+	int incy = std::min(gs-&gt;mapy - 1, y2 + 1);
+	int decx = std::max(           0, x1 - 1);
+	int incx = std::min(gs-&gt;mapx - 1, x2 + 1);
 
 	float3* facenormals = readmap-&gt;facenormals;
+
+	// update the normals
 	for (int y = decy; y &lt;= incy; y++) {
 		for (int x = decx; x &lt;= incx; x++) {
-			float3 e1(-SQUARE_SIZE,heightmap[y*(gs-&gt;mapx+1)+x]-heightmap[y*(gs-&gt;mapx+1)+x+1],0);
-			float3 e2( 0,heightmap[y*(gs-&gt;mapx+1)+x]-heightmap[(y+1)*(gs-&gt;mapx+1)+x],-SQUARE_SIZE);
+			float3 e1(-SQUARE_SIZE, heightmap[y * (gs-&gt;mapx + 1) + x] - heightmap[ y      * (gs-&gt;mapx + 1) + x + 1],            0);
+			float3 e2(           0, heightmap[y * (gs-&gt;mapx + 1) + x] - heightmap[(y + 1) * (gs-&gt;mapx + 1) + x    ], -SQUARE_SIZE);
 
-			float3 n=e2.cross(e1);
+			float3 n = e2.cross(e1);
 			n.Normalize();
 
-			facenormals[(y*gs-&gt;mapx+x)*2] = n;
+			facenormals[(y * gs-&gt;mapx + x) * 2] = n;
 
-			e1 = float3( SQUARE_SIZE,heightmap[(y+1)*(gs-&gt;mapx+1)+x+1]-heightmap[(y+1)*(gs-&gt;mapx+1)+x],0);
-			e2 = float3( 0,heightmap[(y+1)*(gs-&gt;mapx+1)+x+1]-heightmap[(y)*(gs-&gt;mapx+1)+x+1],SQUARE_SIZE);
+			e1 = float3( SQUARE_SIZE, heightmap[(y + 1) * (gs-&gt;mapx + 1) + x + 1] - heightmap[(y + 1) * (gs-&gt;mapx + 1) + x    ],           0);
+			e2 = float3(           0, heightmap[(y + 1) * (gs-&gt;mapx + 1) + x + 1] - heightmap[(y    ) * (gs-&gt;mapx + 1) + x + 1], SQUARE_SIZE);
 
 			n = e2.cross(e1);
 			n.Normalize();
 
-			facenormals[(y*gs-&gt;mapx+x)*2+1] = n;
+			facenormals[(y * gs-&gt;mapx + x) * 2 + 1] = n;
 		}
 	}
 
-	for(int y = std::max(2,(y1&amp;0xfffffe)); y &lt;= std::min(gs-&gt;mapy-3,y2); y += 2) {
-		for(int x = std::max(2,(x1&amp;0xfffffe)); x &lt;= std::min(gs-&gt;mapx-3,x2); x += 2) {
-			float3 e1(-SQUARE_SIZE*4,heightmap[(y-1)*(gs-&gt;mapx+1)+x-1]-heightmap[(y-1)*(gs-&gt;mapx+1)+x+3],0);
-			float3 e2( 0,heightmap[(y-1)*(gs-&gt;mapx+1)+x-1]-heightmap[(y+3)*(gs-&gt;mapx+1)+x-1],-SQUARE_SIZE*4);
+	// update the slopes
+	const int ss4 = SQUARE_SIZE * 4;
+	float* slopemap = readmap-&gt;slopemap;
+	for (int y = std::max(2, (y1 &amp; 0xfffffe)); y &lt;= std::min(gs-&gt;mapy - 3, y2); y += 2) {
+		for (int x = std::max(2, (x1 &amp; 0xfffffe)); x &lt;= std::min(gs-&gt;mapx - 3, x2); x += 2) {
+			float3 e1(-ss4, heightmap[(y - 1) * (gs-&gt;mapx + 1) + x - 1] - heightmap[(y - 1) * (gs-&gt;mapx + 1) + x + 3],    0);
+			float3 e2(   0, heightmap[(y - 1) * (gs-&gt;mapx + 1) + x - 1] - heightmap[(y + 3) * (gs-&gt;mapx + 1) + x - 1], -ss4);
 
 			float3 n = e2.cross(e1);
 			n.Normalize();
 
-			e1 = float3( SQUARE_SIZE*4,heightmap[(y+3)*(gs-&gt;mapx+1)+x+3]-heightmap[(y+3)*(gs-&gt;mapx+1)+x-1],0);
-			e2 = float3( 0,heightmap[(y+3)*(gs-&gt;mapx+1)+x+3]-heightmap[(y-1)*(gs-&gt;mapx+1)+x+3],SQUARE_SIZE*4);
+			e1 = float3(ss4, heightmap[(y + 3) * (gs-&gt;mapx + 1) + x + 3] - heightmap[(y + 3) * (gs-&gt;mapx + 1) + x - 1],   0);
+			e2 = float3(  0, heightmap[(y + 3) * (gs-&gt;mapx + 1) + x + 3] - heightmap[(y - 1) * (gs-&gt;mapx + 1) + x + 3], ss4);
 
 			float3 n2 = e2.cross(e1);
 			n2.Normalize();
 
-			readmap-&gt;slopemap[(y/2)*gs-&gt;hmapx+(x/2)] = 1-(n.y+n2.y)*0.5f;
+			slopemap[(y / 2) * gs-&gt;hmapx + (x / 2)] = 1.0f - (n.y + n2.y) * 0.5f;
 		}
 	}
 
-	pathManager-&gt;TerrainChange(x1, y1, x2, y2);
-	featureHandler-&gt;TerrainChanged(x1, y1, x2, y2);
-	readmap-&gt;HeightmapUpdated(x1, x2, y1, y2);
+	decy = std::max(                     0, (y1 * SQUARE_SIZE - QUAD_SIZE / 2) / QUAD_SIZE);
+	incy = std::min(qf-&gt;GetNumQuadsZ() - 1, (y2 * SQUARE_SIZE + QUAD_SIZE / 2) / QUAD_SIZE);
+	decx = std::max(                     0, (x1 * SQUARE_SIZE - QUAD_SIZE / 2) / QUAD_SIZE);
+	incx = std::min(qf-&gt;GetNumQuadsX() - 1, (x2 * SQUARE_SIZE + QUAD_SIZE / 2) / QUAD_SIZE);
 
-	decy = std::max(0,(y1*SQUARE_SIZE-QUAD_SIZE/2)/QUAD_SIZE);
-	incy = std::min(qf-&gt;GetNumQuadsZ()-1,(y2*SQUARE_SIZE+QUAD_SIZE/2)/QUAD_SIZE);
-	decx = std::max(0,(x1*SQUARE_SIZE-QUAD_SIZE/2)/QUAD_SIZE);
-	incx = std::min(qf-&gt;GetNumQuadsX()-1,(x2*SQUARE_SIZE+QUAD_SIZE/2)/QUAD_SIZE);
+	const int numQuadsX = qf-&gt;GetNumQuadsX();
+	const int frameNum  = gs-&gt;frameNum;
 
 	for (int y = decy; y &lt;= incy; y++) {
 		for (int x = decx; x &lt;= incx; x++) {
-			if (inRelosQue[y*qf-&gt;GetNumQuadsX()+x]) {
+			if (inRelosQue[y * numQuadsX + x]) {
 				continue;
 			}
+
 			RelosSquare rs;
 			rs.x = x;
 			rs.y = y;
-			rs.neededUpdate = gs-&gt;frameNum;
+			rs.neededUpdate = frameNum;
 			rs.numUnits = qf-&gt;GetQuadAt(x, y).units.size();
 			relosSize += rs.numUnits;
-			inRelosQue[y*qf-&gt;GetNumQuadsX()+x] = true;
+			inRelosQue[y * numQuadsX + x] = true;
 			relosQue.push_back(rs);
 		}
 	}
+
+	pathManager-&gt;TerrainChange(x1, y1, x2, y2);
+	featureHandler-&gt;TerrainChanged(x1, y1, x2, y2);
+	readmap-&gt;HeightmapUpdated(x1, x2, y1, y2);
+	water-&gt;HeightmapChanged(x1, y1, x2, y2);
 	heightMapTexture.UpdateArea(x1, y1, x2, y2);
 }
 
@@ -251,129 +271,88 @@
 	SCOPED_TIMER(&quot;Map damage&quot;);
 
 	std::deque&lt;Explo*&gt;::iterator ei;
-	float* heightmap=readmap-&gt;GetHeightmap();
 
-	for(ei=explosions.begin();ei!=explosions.end();++ei){
-		Explo* e=*ei;
-		if (e-&gt;ttl&lt;=0) continue;
+	for (ei = explosions.begin(); ei != explosions.end(); ++ei) {
+		Explo* e = *ei;
+		if (e-&gt;ttl &lt;= 0) continue;
 		--e-&gt;ttl;
 
-		int x1=e-&gt;x1;
-		int x2=e-&gt;x2;
-		int y1=e-&gt;y1;
-		int y2=e-&gt;y2;
-		std::vector&lt;float&gt;::iterator si=e-&gt;squares.begin();
-		for(int y=y1;y&lt;=y2;++y){
-			for(int x=x1;x&lt;=x2;++x){
-				float dif=*(si++);
-				heightmap[y*(gs-&gt;mapx+1)+x]+=dif;
+		int x1 = e-&gt;x1;
+		int x2 = e-&gt;x2;
+		int y1 = e-&gt;y1;
+		int y2 = e-&gt;y2;
+		std::vector&lt;float&gt;::iterator si = e-&gt;squares.begin();
+
+		for (int y = y1; y &lt;= y2; ++y) {
+			for (int x = x1; x&lt;= x2; ++x) {
+				float dif = *(si++);
+
+				readmap-&gt;AddHeight(y * (gs-&gt;mapx + 1) + x, dif);
 			}
 		}
-		for(std::vector&lt;ExploBuilding&gt;::iterator bi=e-&gt;buildings.begin();bi!=e-&gt;buildings.end();++bi){
-			float dif=bi-&gt;dif;
+		for (std::vector&lt;ExploBuilding&gt;::iterator bi = e-&gt;buildings.begin(); bi != e-&gt;buildings.end(); ++bi) {
+			float dif = bi-&gt;dif;
 			int tx1 = bi-&gt;tx1;
 			int tx2 = bi-&gt;tx2;
 			int tz1 = bi-&gt;tz1;
 			int tz2 = bi-&gt;tz2;
 
-			for(int z=tz1; z&lt;tz2; z++){
-				for(int x=tx1; x&lt;tx2; x++){
-					heightmap[z*(gs-&gt;mapx+1)+x]+=dif;
+			for (int z = tz1; z &lt; tz2; z++) {
+				for (int x = tx1; x &lt; tx2; x++) {
+					readmap-&gt;AddHeight(z * (gs-&gt;mapx + 1) + x, dif);
 				}
 			}
-			CUnit* unit=uh-&gt;units[bi-&gt;id];
-			if(unit){
-				unit-&gt;pos.y+=dif;
-				unit-&gt;midPos.y+=dif;
+
+			CUnit* unit = uh-&gt;units[bi-&gt;id];
+			if (unit) {
+				unit-&gt;pos.y += dif;
+				unit-&gt;midPos.y += dif;
 			}
 		}
-		readmap-&gt;ExplosionUpdate(e-&gt;x1,e-&gt;x2,e-&gt;y1,e-&gt;y2);
-		if(e-&gt;ttl==0){
-			float3 pos=e-&gt;pos;
-			RecalcArea(x1-2,x2+2,y1-2,y2+2);
-	/*		for(int y=y1&gt;&gt;3;y&lt;=y2&gt;&gt;3;++y){
-				for(int x=x1&gt;&gt;3;x&lt;=x2&gt;&gt;3;++x){
-					if(!inRejuvQue[y][x]){
-						RejuvSquare rs;
-						rs.x=x;
-						rs.y=y;
-						rejuvQue.push_back(rs);
-						inRejuvQue[y][x]=true;
-					}
-				}
-			}*/
+		if (e-&gt;ttl == 0) {
+			RecalcArea(x1 - 2, x2 + 2, y1 - 2, y2 + 2);
 		}
 	}
-	while(!explosions.empty() &amp;&amp; explosions.front()-&gt;ttl==0){
+
+	while (!explosions.empty() &amp;&amp; explosions.front()-&gt;ttl == 0) {
 		delete explosions.front();
 		explosions.pop_front();
 	}
 
-/*
-	nextRejuv+=rejuvQue.size()/300.0f;
-	while(nextRejuv&gt;0){
-		nextRejuv-=1;
-		int bx=rejuvQue.front().x;
-		int by=rejuvQue.front().y;
-		bool damaged=false;
-
-		for(int y=by*16;y&lt;by*16+16;++y){
-			for(int x=bx*16;x&lt;bx*16+16;++x){
-				if(readmap-&gt;damagemap[y*1024+x]!=0){
-					damaged=true;
-					if(readmap-&gt;damagemap[y*1024+x]&gt;5){
-						int hsquare=((y+1)/2)*(gs-&gt;mapx+1)+(x+1)/2;
-						readmap-&gt;heightmap[hsquare]-=(readmap-&gt;heightmap[hsquare]-readmap-&gt;orgheightmap[hsquare])*0.003f;
-						readmap-&gt;damagemap[y*1024+x]-=4;
-					} else {
-						readmap-&gt;damagemap[y*1024+x]=0;
-						if(readmap-&gt;typemap[(y/2)*512+x/2]&amp;128){
-							readmap-&gt;typemap[(y/2)*512+x/2]&amp;=127;
-							treeDrawer-&gt;ResetPos(float3(x*4,0,y*4));
-						}
-					}
-				}
-			}
-		}
-		if(damaged){
-			rejuvQue.push_back(rejuvQue.front());
-			RecalcArea(bx*8,bx*8+8,by*8,by*8+8);
-			readmap-&gt;RecalcTexture(bx*8,bx*8+8,by*8,by*8+8);
-		} else {
-			inRejuvQue[by][bx]=false;
-		}
-		rejuvQue.pop_front();
-	}*/
 	UpdateLos();
 }
 
 void CBasicMapDamage::UpdateLos(void)
 {
-	int updateSpeed=(int)(relosSize*0.01f)+1;
+	int updateSpeed = (int) (relosSize * 0.01f) + 1;
 
-	if(relosUnits.empty()){
-		if(relosQue.empty())
+	if (relosUnits.empty()) {
+		if (relosQue.empty())
 			return;
-		RelosSquare* rs=&amp;relosQue.front();
 
+		RelosSquare* rs = &amp;relosQue.front();
 		const std::list&lt;CUnit*&gt;&amp; units = qf-&gt;GetQuadAt(rs-&gt;x, rs-&gt;y).units;
+
 		for (std::list&lt;CUnit*&gt;::const_iterator ui = units.begin(); ui != units.end(); ++ui) {
 			relosUnits.push_back((*ui)-&gt;id);
 		}
-		relosSize-=rs-&gt;numUnits;
-		neededLosUpdate=rs-&gt;neededUpdate;
-		inRelosQue[rs-&gt;y*qf-&gt;GetNumQuadsX()+rs-&gt;x]=false;
+		relosSize -= rs-&gt;numUnits;
+		neededLosUpdate = rs-&gt;neededUpdate;
+		inRelosQue[rs-&gt;y * qf-&gt;GetNumQuadsX() + rs-&gt;x] = false;
 		relosQue.pop_front();
 	}
-	for(int a=0;a&lt;updateSpeed;++a){
-		if(relosUnits.empty())
+
+	for (int a = 0; a &lt; updateSpeed; ++a) {
+		if (relosUnits.empty())
 			return;
-		CUnit* u=uh-&gt;units[relosUnits.front()];
+
+		CUnit* u = uh-&gt;units[relosUnits.front()];
 		relosUnits.pop_front();
 
-		if(u==0 || u-&gt;lastLosUpdate&gt;=neededLosUpdate){
+		if (u == 0 || u-&gt;lastLosUpdate &gt;= neededLosUpdate) {
 			continue;
 		}
-		loshandler-&gt;MoveUnit(u,true);
+
+		loshandler-&gt;MoveUnit(u, true);
 	}
 }

Modified: branches/0.77-branch/rts/Map/BasicMapDamage.h
===================================================================
--- branches/0.77-branch/rts/Map/BasicMapDamage.h	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Map/BasicMapDamage.h	2008-08-20 14:38:09 UTC (rev 6278)
@@ -40,7 +40,7 @@
 	};
 	std::deque&lt;RelosSquare&gt; relosQue;
 
-	bool* inRelosQue;//todo supposes 512*512 map
+	bool* inRelosQue;
 	int relosSize;
 	int neededLosUpdate;
 	std::deque&lt;int&gt; relosUnits;

Modified: branches/0.77-branch/rts/Map/Ground.cpp
===================================================================
--- branches/0.77-branch/rts/Map/Ground.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Map/Ground.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -29,69 +29,88 @@
 void CGround::CheckCol(CProjectileHandler* ph)
 {
 	Projectile_List::iterator psi;
-//	int x,y;
-	for(psi=ph-&gt;ps.begin();psi != ph-&gt;ps.end();++psi){
-		CProjectile* p=*psi;
-		if(p-&gt;checkCol){
-			if(GetHeight(p-&gt;pos.x,p-&gt;pos.z) &gt; p-&gt;pos.y/*-p-&gt;radius*/)		//too many projectiles seems to hit the ground before hitting so remove the radius till a better fix is done
+
+	for (psi = ph-&gt;ps.begin(); psi != ph-&gt;ps.end(); ++psi) {
+		CProjectile* p = *psi;
+		if (p-&gt;checkCol) {
+			if (GetHeight(p-&gt;pos.x, p-&gt;pos.z) &gt; p-&gt;pos.y /* - p-&gt;radius*/) {
+				// too many projectiles seem to hit the ground before hitting
+				// so remove the radius till a better fix is done
 				p-&gt;Collision();
-/*			x=(int)floor((*psi)-&gt;pos.x*1.0f/SQUARE_SIZE);
-			y=(int)floor((*psi)-&gt;pos.z*1.0f/SQUARE_SIZE);
-			CheckColSquare(*psi,x,y);
-*/		}
+			}
+		}
 	}
 }
 
-void CGround::CheckColSquare(CProjectile* p,int x,int y)
+void CGround::CheckColSquare(CProjectile* p, int x, int y)
 {
-	if(!(x&gt;=0 &amp;&amp; y&gt;=0 &amp;&amp; x&lt;gs-&gt;mapx &amp;&amp; y&lt;gs-&gt;mapy))
+	if (!(x &gt;= 0 &amp;&amp; y &gt;= 0 &amp;&amp; x &lt; gs-&gt;mapx &amp;&amp; y &lt; gs-&gt;mapy))
 		return;
-	float xp=p-&gt;pos.x;
-	float yp=p-&gt;pos.y;
-	float zp=p-&gt;pos.z;
 
-	float* hm = readmap-&gt;GetHeightmap();
-	float xt=x*SQUARE_SIZE;
-	float yt=y*SQUARE_SIZE;
-	if (((xp-xt)*readmap-&gt;facenormals[(y*gs-&gt;mapx+x)*2].x+(yp-hm[y*(gs-&gt;mapx+1)+x])*readmap-&gt;facenormals[(y*gs-&gt;mapx+x)*2].y+(zp-yt)*readmap-&gt;facenormals[(y*gs-&gt;mapx+x)*2].z&lt;=p-&gt;radius) &amp;&amp;
-		/*(xp-xt+p-&gt;radius&gt;0) &amp;&amp; (zp-yt+p-&gt;radius&gt;0) &amp;&amp;*/ (xp+zp-xt-yt-p-&gt;radius&lt;SQUARE_SIZE)){
+	float xp = p-&gt;pos.x;
+	float yp = p-&gt;pos.y;
+	float zp = p-&gt;pos.z;
+
+	const float* hm = readmap-&gt;GetHeightmap();
+	const float3* fn = readmap-&gt;facenormals;
+	const int hmIdx = (y * gs-&gt;mapx + x);
+	const float xt = x * SQUARE_SIZE;
+	const float yt0 = hm[ y      * (gs-&gt;mapx + 1) + x    ];
+	const float yt1 = hm[(y + 1) * (gs-&gt;mapx + 1) + x + 1];
+	const float zt = y * SQUARE_SIZE;
+
+	const float dx0 = (xp -  xt     ), fnx0 = fn[hmIdx * 2    ].x;
+	const float dy0 = (yp -  yt0    ), fny0 = fn[hmIdx * 2    ].y;
+	const float dz0 = (zp -  zt     ), fnz0 = fn[hmIdx * 2    ].z;
+	const float dx1 = (xp - (xt + 2)), fnx1 = fn[hmIdx * 2 + 1].x;
+	const float dy1 = (yp -  yt1    ), fny1 = fn[hmIdx * 2 + 1].y;
+	const float dz1 = (zp - (zt + 2)), fnz1 = fn[hmIdx * 2 + 1].z;
+	const float d0 = dx0 * fnx0 + dy0 * fny0 + dz0 * fnz0;
+	const float d1 = dx1 * fnx1 + dy1 * fny1 + dz1 * fnz1;
+	const float s0 = xp + zp - xt - zt - p-&gt;radius;
+	const float s1 = xp + zp - xt - zt - SQUARE_SIZE * 2 + p-&gt;radius;
+
+	if ((d0 &lt;= p-&gt;radius) &amp;&amp; (s0 &lt; SQUARE_SIZE)) {
 		p-&gt;Collision();
 	}
-	if (((xp-(xt+2))*readmap-&gt;facenormals[(y*gs-&gt;mapx+x)*2+1].x+(yp-hm[(y+1)*(gs-&gt;mapx+1)+x+1])*readmap-&gt;facenormals[(y*gs-&gt;mapx+x)*2+1].y+(zp-(yt+2))*readmap-&gt;facenormals[(y*gs-&gt;mapx+x)*2+1].z&lt;=p-&gt;radius) &amp;&amp;
-		/*(xp-(xt+2)-p-&gt;radius&lt;0) &amp;&amp; (zp-(yt+2)-p-&gt;radius&lt;0) &amp;&amp;*/ (xp+zp-xt-yt-SQUARE_SIZE*2+p-&gt;radius&gt;-SQUARE_SIZE)){
+	if ((d1 &lt;= p-&gt;radius) &amp;&amp; (s1 &gt; -SQUARE_SIZE)) {
 		p-&gt;Collision();
 	}
+
 	return;
 }
+
 float CGround::LineGroundCol(float3 from, float3 to)
 {
-	float savedLength=0;
-	if(from.z&gt;float3::maxzpos &amp;&amp; to.z&lt;float3::maxzpos){		//a special case since the camera in overhead mode can often do this
-		float3 dir=to-from;
-		float maxLength=dir.Length();
-		dir/=maxLength;
+	float savedLength = 0.0f;
 
-		savedLength=-(from.z-float3::maxzpos)/dir.z;
+	if (from.z &gt; float3::maxzpos &amp;&amp; to.z &lt; float3::maxzpos) {
+		// a special case since the camera in overhead mode can often do this
+		float3 dir = to - from;
+		float maxLength = dir.Length();
+		dir /= maxLength;
 
-		from+=dir*savedLength;
+		savedLength = -(from.z - float3::maxzpos) / dir.z;
+		from += dir * savedLength;
 	}
+
 	from.CheckInBounds();
 
-	float3 dir=to-from;
-	float maxLength=dir.Length();
-	dir/=maxLength;
+	float3 dir = to - from;
+	float maxLength = dir.Length();
+	dir /= maxLength;
 
-	if(from.x+dir.x*maxLength&lt;1)
-		maxLength=(1-from.x)/dir.x;
-	else if(from.x+dir.x*maxLength&gt;float3::maxxpos)
-		maxLength=(float3::maxxpos-from.x)/dir.x;
+	if (from.x + dir.x * maxLength &lt; 1.0f)
+		maxLength = (1.0f - from.x) / dir.x;
+	else if (from.x + dir.x * maxLength &gt; float3::maxxpos)
+		maxLength = (float3::maxxpos - from.x) / dir.x;
 
-	if(from.z+dir.z*maxLength&lt;1)
-		maxLength=(1-from.z)/dir.z;
-	else if(from.z+dir.z*maxLength&gt;float3::maxzpos)
-		maxLength=(float3::maxzpos-from.z)/dir.z;
+	if (from.z + dir.z * maxLength &lt; 1.0f)
+		maxLength = (1.0f - from.z) / dir.z;
+	else if (from.z + dir.z * maxLength &gt; float3::maxzpos)
+		maxLength = (float3::maxzpos - from.z) / dir.z;
 
-	to=from+dir*maxLength;
+	to = from + dir * maxLength;
 
 	const float dx=to.x-from.x;
 	const float dz=to.z-from.z;
@@ -184,50 +203,56 @@
 	return -1;
 }
 
-float CGround::LineGroundSquareCol(const float3 &amp;from,const float3 &amp;to,int xs,int ys)
+float CGround::LineGroundSquareCol(const float3&amp; from, const float3&amp; to, int xs, int ys)
 {
-	if((xs&lt;0) || (ys&lt;0) || (xs&gt;=gs-&gt;mapx-1) || (ys&gt;=gs-&gt;mapy-1))
+	if ((xs &lt; 0) || (ys &lt; 0) || (xs &gt;= gs-&gt;mapx - 1) || (ys &gt;= gs-&gt;mapy - 1))
 		return -1;
 
-	float3 dir=to-from;
+	float3 dir = to - from;
 	float3 tri;
-	//triangel 1
-	tri.x=xs*SQUARE_SIZE;
-	tri.z=ys*SQUARE_SIZE;
-	float* heightmap=readmap-&gt;GetHeightmap();
-	tri.y=heightmap[ys*(gs-&gt;mapx+1)+xs];
 
-	float3 norm=readmap-&gt;facenormals[(ys*gs-&gt;mapx+xs)*2];
-	float side1=(from-tri).dot(norm);
-	float side2=(to-tri).dot(norm);
+	// triangle 1
+	tri.x = xs * SQUARE_SIZE;
+	tri.z = ys * SQUARE_SIZE;
+	const float* heightmap = readmap-&gt;GetHeightmap();
+	tri.y = heightmap[ys * (gs-&gt;mapx + 1) + xs];
 
-	if(side2&lt;=0){				//linjen passerar triangelns plan?
-		float dif=side1-side2;
-		if(dif!=0){
-			float frontpart=side1/dif;
-			float3 col=from+(dir*frontpart);
+	float3 norm = readmap-&gt;facenormals[(ys * gs-&gt;mapx + xs) * 2];
+	float side1 = (from - tri).dot(norm);
+	float side2 = (to - tri).dot(norm);
 
-			if((col.x&gt;=tri.x) &amp;&amp; (col.z&gt;=tri.z) &amp;&amp; (col.x+col.z&lt;=tri.x+tri.z+SQUARE_SIZE)){	//kollision inuti triangeln (utnyttja trianglarnas &quot;2d aktighet&quot;)
+	if (side2 &lt;= 0) {
+		// linjen passerar triangelns plan?
+		float dif = side1 - side2;
+		if (dif != 0) {
+			float frontpart = side1 / dif;
+			float3 col = from + (dir * frontpart);
+
+			if ((col.x &gt;= tri.x) &amp;&amp; (col.z &gt;= tri.z) &amp;&amp; (col.x + col.z &lt;= tri.x + tri.z + SQUARE_SIZE)) {
+				// kollision inuti triangeln (utnyttja trianglarnas &quot;2d aktighet&quot;)
 				return col.distance(from);
 			}
 		}
 	}
-	//triangel 2
-	tri.x=(xs+1)*SQUARE_SIZE;
-	tri.z=(ys+1)*SQUARE_SIZE;
-	tri.y=heightmap[(ys+1)*(gs-&gt;mapx+1)+xs+1];
 
-	norm=readmap-&gt;facenormals[(ys*gs-&gt;mapx+xs)*2+1];
-	side1=(from-tri).dot(norm);
-	side2=(to-tri).dot(norm);
+	// triangle 2
+	tri.x = (xs + 1) * SQUARE_SIZE;
+	tri.z = (ys + 1) * SQUARE_SIZE;
+	tri.y = heightmap[(ys + 1) * (gs-&gt;mapx + 1) + xs + 1];
 
-	if(side2&lt;=0){				//linjen passerar triangelns plan?
-		float dif=side1-side2;
-		if(dif!=0){
-			float frontpart=side1/dif;
-			float3 col=from+(dir*frontpart);
+	norm = readmap-&gt;facenormals[(ys * gs-&gt;mapx + xs) * 2 + 1];
+	side1 = (from - tri).dot(norm);
+	side2 = (to - tri).dot(norm);
 
-			if((col.x&lt;=tri.x) &amp;&amp; (col.z&lt;=tri.z) &amp;&amp; (col.x+col.z&gt;=tri.x+tri.z-SQUARE_SIZE)){	//kollision inuti triangeln (utntri.ytja trianglarnas &quot;2d aktighet&quot;)
+	if (side2 &lt;= 0) {
+		// linjen passerar triangelns plan?
+		float dif = side1 - side2;
+		if (dif != 0) {
+			float frontpart = side1 / dif;
+			float3 col = from + (dir * frontpart);
+
+			if ((col.x &lt;= tri.x) &amp;&amp; (col.z &lt;= tri.z) &amp;&amp; (col.x + col.z &gt;= tri.x + tri.z - SQUARE_SIZE)) {
+				// kollision inuti triangeln (utntri.ytja trianglarnas &quot;2d aktighet&quot;)
 				return col.distance(from);
 			}
 		}
@@ -235,104 +260,106 @@
 	return -2;
 }
 
-float CGround::GetApproximateHeight(float x,float y)
+float CGround::GetApproximateHeight(float x, float y)
 {
-	int xsquare=int(x)/SQUARE_SIZE;
-	int ysquare=int(y)/SQUARE_SIZE;
-	if(xsquare&lt;0)
-		xsquare=0;
-	else if(xsquare&gt;gs-&gt;mapx-1)
-		xsquare=gs-&gt;mapx-1;
-	if(ysquare&lt;0)
-		ysquare=0;
-	else if(ysquare&gt;gs-&gt;mapy-1)
-		ysquare=gs-&gt;mapy-1;
-	return readmap-&gt;centerheightmap[xsquare+ysquare*gs-&gt;mapx];
+	int xsquare = int(x) / SQUARE_SIZE;
+	int ysquare = int(y) / SQUARE_SIZE;
+
+	if (xsquare &lt; 0)
+		xsquare = 0;
+	else if (xsquare &gt; gs-&gt;mapx - 1)
+		xsquare = gs-&gt;mapx - 1;
+	if (ysquare &lt; 0)
+		ysquare = 0;
+	else if (ysquare &gt; gs-&gt;mapy - 1)
+		ysquare = gs-&gt;mapy - 1;
+
+	return readmap-&gt;centerheightmap[xsquare + ysquare * gs-&gt;mapx];
 }
 
 float CGround::GetHeight(float x, float y)
 {
 	float r = GetHeight2(x, y);
-	if(r&lt;0)
-		r=0;
-	return r;
+	return (r &lt; 0.0f? 0.0f: r);
 }
 
 float CGround::GetHeight2(float x, float y)
 {
-	if(x&lt;1)
-		x=1;
-	else if(x&gt;float3::maxxpos)
-		x=float3::maxxpos;
+	if (x &lt; 1)
+		x = 1;
+	else if (x &gt; float3::maxxpos)
+		x = float3::maxxpos;
 
-	if(y&lt;1)
-		y=1;
-	else if(y&gt;float3::maxzpos)
-		y=float3::maxzpos;
+	if (y &lt; 1)
+		y = 1;
+	else if (y &gt; float3::maxzpos)
+		y = float3::maxzpos;
 
-	float r;
-	int sx=(int) (x/SQUARE_SIZE);
-	int sy=(int) (y/SQUARE_SIZE);
-	float dx=(x-sx*SQUARE_SIZE)*(1.0f/SQUARE_SIZE);
-	float dy=(y-sy*SQUARE_SIZE)*(1.0f/SQUARE_SIZE);
-	int hs=sx+sy*(gs-&gt;mapx+1);
-	float* heightmap = readmap-&gt;GetHeightmap();
-	if(dx+dy&lt;1){
-		float xdif=(dx)*(heightmap[hs+1]-heightmap[hs]);
-		float ydif=(dy)*(heightmap[hs+gs-&gt;mapx+1]-heightmap[hs]);
-		r=heightmap[hs]+xdif+ydif;
+	float r = 0.0f;
+	int sx = (int) (x / SQUARE_SIZE);
+	int sy = (int) (y / SQUARE_SIZE);
+	float dx = (x - sx * SQUARE_SIZE) * (1.0f / SQUARE_SIZE);
+	float dy = (y - sy * SQUARE_SIZE) * (1.0f / SQUARE_SIZE);
+	int hs = sx + sy * (gs-&gt;mapx + 1);
+	const float* heightmap = readmap-&gt;GetHeightmap();
+
+	if (dx + dy &lt; 1) {
+		float xdif = (dx) * (heightmap[hs +            1] - heightmap[hs]);
+		float ydif = (dy) * (heightmap[hs + gs-&gt;mapx + 1] - heightmap[hs]);
+		r = heightmap[hs] + xdif + ydif;
 	} else {
-		float xdif=(1-dx)*(heightmap[hs+gs-&gt;mapx+1]-heightmap[hs+1+1+gs-&gt;mapx]);
-		float ydif=(1-dy)*(heightmap[hs+1]-heightmap[hs+1+1+gs-&gt;mapx]);
-		r=heightmap[hs+1+1+gs-&gt;mapx]+xdif+ydif;
+		float xdif = (1.0f - dx) * (heightmap[hs + gs-&gt;mapx + 1] - heightmap[hs + 1 + 1 + gs-&gt;mapx]);
+		float ydif = (1.0f - dy) * (heightmap[hs            + 1] - heightmap[hs + 1 + 1 + gs-&gt;mapx]);
+		r = heightmap[hs + 1 + 1 + gs-&gt;mapx] + xdif + ydif;
 	}
 	return r;
 }
 
 float CGround::GetOrigHeight(float x, float y)
 {
-	if(x&lt;1)
-		x=1;
-	else if(x&gt;float3::maxxpos)
-		x=float3::maxxpos;
+	if (x &lt; 1)
+		x = 1;
+	else if (x &gt; float3::maxxpos)
+		x = float3::maxxpos;
 
-	if(y&lt;1)
-		y=1;
-	else if(y&gt;float3::maxzpos)
-		y=float3::maxzpos;
+	if (y &lt; 1)
+		y = 1;
+	else if (y &gt; float3::maxzpos)
+		y = float3::maxzpos;
 
-	float r;
-	int sx=(int) (x/SQUARE_SIZE);
-	int sy=(int) (y/SQUARE_SIZE);
-	float dx=(x-sx*SQUARE_SIZE)*(1.0f/SQUARE_SIZE);
-	float dy=(y-sy*SQUARE_SIZE)*(1.0f/SQUARE_SIZE);
-	int hs=sx+sy*(gs-&gt;mapx+1);
-	float* heightmap = readmap-&gt;orgheightmap;
-	if(dx+dy&lt;1){
-		float xdif=(dx)*(heightmap[hs+1]-heightmap[hs]);
-		float ydif=(dy)*(heightmap[hs+gs-&gt;mapx+1]-heightmap[hs]);
-		r=heightmap[hs]+xdif+ydif;
+	float r = 0.0f;
+	int sx = (int) (x / SQUARE_SIZE);
+	int sy = (int) (y / SQUARE_SIZE);
+	float dx = (x - sx * SQUARE_SIZE) * (1.0f / SQUARE_SIZE);
+	float dy = (y - sy * SQUARE_SIZE) * (1.0f / SQUARE_SIZE);
+	int hs = sx + sy * (gs-&gt;mapx + 1);
+	const float* orgheightmap = readmap-&gt;orgheightmap;
+
+	if (dx + dy &lt; 1) {
+		float xdif = (dx) * (orgheightmap[hs +            1] - orgheightmap[hs]);
+		float ydif = (dy) * (orgheightmap[hs + gs-&gt;mapx + 1] - orgheightmap[hs]);
+		r = orgheightmap[hs] + xdif + ydif;
 	} else {
-		float xdif=(1-dx)*(heightmap[hs+gs-&gt;mapx+1]-heightmap[hs+1+1+gs-&gt;mapx]);
-		float ydif=(1-dy)*(heightmap[hs+1]-heightmap[hs+1+1+gs-&gt;mapx]);
-		r=heightmap[hs+1+1+gs-&gt;mapx]+xdif+ydif;
+		float xdif = (1 - dx) * (orgheightmap[hs + gs-&gt;mapx + 1] - orgheightmap[hs + 1 + 1 + gs-&gt;mapx]);
+		float ydif = (1 - dy) * (orgheightmap[hs +            1] - orgheightmap[hs + 1 + 1 + gs-&gt;mapx]);
+		r = orgheightmap[hs + 1 + 1 + gs-&gt;mapx] + xdif + ydif;
 	}
 	return r;
 }
 
 float3&amp; CGround::GetNormal(float x, float y)
 {
-	if(x&lt;1)
-		x=1;
-	else if(x&gt;float3::maxxpos)
-		x=float3::maxxpos;
+	if (x &lt; 1.0f)
+		x = 1.0f;
+	else if (x &gt; float3::maxxpos)
+		x = float3::maxxpos;
 
-	if(y&lt;1)
-		y=1;
-	else if(y&gt;float3::maxzpos)
-		y=float3::maxzpos;
+	if (y &lt; 1.0f)
+		y = 1.0f;
+	else if (y &gt; float3::maxzpos)
+		y = float3::maxzpos;
 
-	return readmap-&gt;facenormals[(int(x)/SQUARE_SIZE+int(y)/SQUARE_SIZE*gs-&gt;mapx)*2];
+	return readmap-&gt;facenormals[(int(x) / SQUARE_SIZE + int(y) / SQUARE_SIZE * gs-&gt;mapx) * 2];
 }
 /*
 float CGround::GetApproximateHeight(float x, float y)
@@ -344,65 +371,68 @@
 */
 float CGround::GetSlope(float x, float y)
 {
-	if(x&lt;1)
-		x=1;
-	else if(x&gt;float3::maxxpos)
-		x=float3::maxxpos;
+	if (x &lt; 1.0f)
+		x = 1.0f;
+	else if (x &gt; float3::maxxpos)
+		x = float3::maxxpos;
 
-	if(y&lt;1)
-		y=1;
-	else if(y&gt;float3::maxzpos)
-		y=float3::maxzpos;
+	if (y &lt; 1.0f)
+		y = 1.0f;
+	else if (y &gt; float3::maxzpos)
+		y = float3::maxzpos;
 
-	return 1-readmap-&gt;facenormals[(int(x)/SQUARE_SIZE+int(y)/SQUARE_SIZE*gs-&gt;mapx)*2].y;
+	return (1.0f - readmap-&gt;facenormals[(int(x) / SQUARE_SIZE + int(y) / SQUARE_SIZE * gs-&gt;mapx) * 2].y);
 }
 
 
 float3 CGround::GetSmoothNormal(float x, float y)
 {
-	int sx=(int)floor(x/SQUARE_SIZE);
-	int sy=(int)floor(y/SQUARE_SIZE);
+	int sx = (int) floor(x / SQUARE_SIZE);
+	int sy = (int) floor(y / SQUARE_SIZE);
 
-	if(sy&lt;1)
-		sy=1;
-	if(sx&lt;1)
-		sx=1;
-	if(sy&gt;=gs-&gt;mapy-1)
-		sy=gs-&gt;mapy-2;
-	if(sx&gt;=gs-&gt;mapx-1)
-		sx=gs-&gt;mapx-2;
+	if (sy &lt; 1)
+		sy = 1;
+	if (sx &lt; 1)
+		sx = 1;
+	if (sy &gt;= gs-&gt;mapy - 1)
+		sy = gs-&gt;mapy - 2;
+	if (sx &gt;= gs-&gt;mapx - 1)
+		sx = gs-&gt;mapx - 2;
 
-	float dx=(x-sx*SQUARE_SIZE)/SQUARE_SIZE;
-	float dy=(y-sy*SQUARE_SIZE)/SQUARE_SIZE;
+	float dx = (x - sx * SQUARE_SIZE) / SQUARE_SIZE;
+	float dy = (y - sy * SQUARE_SIZE) / SQUARE_SIZE;
 
 	int sy2;
 	float fy;
-	if(dy&gt;0.5f){
-		sy2=sy+1;
-		fy=dy-0.5f;
+
+	if (dy &gt; 0.5f) {
+		sy2 = sy + 1;
+		fy = dy - 0.5f;
 	} else {
-		sy2=sy-1;
-		fy=0.5f-dy;
+		sy2 = sy - 1;
+		fy = 0.5f - dy;
 	}
+
 	int sx2;
 	float fx;
-	if(dx&gt;0.5f){
-		sx2=sx+1;
-		fx=dx-0.5f;
+
+	if (dx &gt; 0.5f) {
+		sx2 = sx + 1;
+		fx = dx - 0.5f;
 	} else {
-		sx2=sx-1;
-		fx=0.5f-dx;
+		sx2 = sx - 1;
+		fx = 0.5f - dx;
 	}
 
-	float ify=1-fy;
-	float ifx=1-fx;
+	float ify = 1.0f - fy;
+	float ifx = 1.0f - fx;
 
-	float3 n1=(readmap-&gt;facenormals[(sy*gs-&gt;mapx+sx)*2]+readmap-&gt;facenormals[(sy*gs-&gt;mapx+sx)*2+1])*ifx*ify;
-	float3 n2=(readmap-&gt;facenormals[(sy*gs-&gt;mapx+sx2)*2]+readmap-&gt;facenormals[(sy*gs-&gt;mapx+sx2)*2+1])*fx*ify;
-	float3 n3=(readmap-&gt;facenormals[((sy2)*gs-&gt;mapx+sx)*2]+readmap-&gt;facenormals[((sy2)*gs-&gt;mapx+sx)*2+1])*ifx*fy;
-	float3 n4=(readmap-&gt;facenormals[((sy2)*gs-&gt;mapx+sx2)*2]+readmap-&gt;facenormals[((sy2)*gs-&gt;mapx+sx2)*2+1])*fx*fy;
+	float3 n1 = (readmap-&gt;facenormals[ (sy   * gs-&gt;mapx + sx ) * 2] + readmap-&gt;facenormals[( sy   * gs-&gt;mapx + sx ) * 2 + 1]) * ifx * ify;
+	float3 n2 = (readmap-&gt;facenormals[ (sy   * gs-&gt;mapx + sx2) * 2] + readmap-&gt;facenormals[( sy   * gs-&gt;mapx + sx2) * 2 + 1]) *  fx * ify;
+	float3 n3 = (readmap-&gt;facenormals[((sy2) * gs-&gt;mapx + sx ) * 2] + readmap-&gt;facenormals[((sy2) * gs-&gt;mapx + sx ) * 2 + 1]) * ifx * fy;
+	float3 n4 = (readmap-&gt;facenormals[((sy2) * gs-&gt;mapx + sx2) * 2] + readmap-&gt;facenormals[((sy2) * gs-&gt;mapx + sx2) * 2 + 1]) *  fx * fy;
 
-	float3 norm1=n1+n2+n3+n4;
+	float3 norm1 = n1 + n2 + n3 + n4;
 	norm1.Normalize();
 
 	return norm1;
@@ -412,16 +442,15 @@
 {
 	from.CheckInBounds();
 
-	float3 dir(flatdir.x,linear,flatdir.z);
-//	float3 oldpos=from;
-	for(float l=0;l&lt;length;l+=8){
-		float3 pos(from+dir*l);
-		pos.y+=quadratic*l*l;
-		if(GetApproximateHeight(pos.x,pos.z)&gt;pos.y){
+	float3 dir(flatdir.x, linear, flatdir.z);
+
+	for (float l = 0.0f; l &lt; length; l += 8.0f) {
+		float3 pos(from + dir * l);
+		pos.y += quadratic * l * l;
+
+		if (GetApproximateHeight(pos.x, pos.z) &gt; pos.y) {
 			return l;
 		}
-//		geometricObjects-&gt;AddLine(pos,oldpos,3,0,16);
-//		oldpos=pos;
 	}
 	return -1;
 }

Modified: branches/0.77-branch/rts/Map/MapInfo.cpp
===================================================================
--- branches/0.77-branch/rts/Map/MapInfo.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Map/MapInfo.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -150,7 +150,7 @@
 	                                                float3(0.4f, 0.4f, 0.4f));
 	light.unitSunColor      = lightTable.GetFloat3(&quot;unitDiffuseColor&quot;,
 	                                                float3(0.7f, 0.7f, 0.7f));
-	light.specularSunColor = lightTable.GetFloat3(&quot;unitSpecularColor&quot;,
+	light.specularSunColor  = lightTable.GetFloat3(&quot;unitSpecularColor&quot;,
 	                                               light.unitSunColor);
 	light.unitShadowDensity = lightTable.GetFloat(&quot;unitShadowDensity&quot;, 0.8f);
 }
@@ -182,7 +182,7 @@
 	water.specularColor = wt.GetFloat3(&quot;specularColor&quot;, light.groundSunColor);
 
 	water.fresnelMin   = wt.GetFloat(&quot;fresnelMin&quot;,   0.2f);
-	water.fresnelMax   = wt.GetFloat(&quot;fresnelMax&quot;,   0.7f);
+	water.fresnelMax   = wt.GetFloat(&quot;fresnelMax&quot;,   0.8f);
 	water.fresnelPower = wt.GetFloat(&quot;fresnelPower&quot;, 4.0f);
 
 	water.reflDistortion = wt.GetFloat(&quot;reflectionDistortion&quot;, 1.0f);
@@ -198,6 +198,8 @@
 	water.foamTexture   = wt.GetString(&quot;foamTexture&quot;,   &quot;&quot;);
 	water.normalTexture = wt.GetString(&quot;normalTexture&quot;, &quot;&quot;);
 
+	water.shoreWaves = wt.GetBool(&quot;shoreWaves&quot;, true);
+
 	// use 'resources.lua' for missing fields  (our the engine defaults)
 	const LuaTable resGfxMaps = resRoot-&gt;SubTable(&quot;graphics&quot;).SubTable(&quot;maps&quot;);
 
@@ -215,8 +217,16 @@
 
 	if (!water.normalTexture.empty()) {
 		water.normalTexture = &quot;maps/&quot; + water.normalTexture;
+		water.numTiles    = std::min(16,std::max(1,wt.GetInt(&quot;numTiles&quot;,1)));
 	} else {
 		water.normalTexture = &quot;bitmaps/&quot; + resGfxMaps.GetString(&quot;waternormaltex&quot;, &quot;waterbump.png&quot;);
+		if (resGfxMaps.KeyExists(&quot;waternormaltex&quot;)) {
+			water.numTiles = std::min(16,std::max(1,resGfxMaps.GetInt(&quot;numTiles&quot;,1)));
+		}else{
+			// default texture is a TileSet of 3x3
+			// user-defined textures are expected to be 1x1 (no DynWaves possible)
+			water.numTiles = 3;
+		}
 	}
 
 	// water caustic textures

Modified: branches/0.77-branch/rts/Map/MapInfo.h
===================================================================
--- branches/0.77-branch/rts/Map/MapInfo.h	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Map/MapInfo.h	2008-08-20 14:38:09 UTC (rev 6278)
@@ -116,7 +116,7 @@
 		float3 minColor;
 		float3 surfaceColor;
 		float  surfaceAlpha;
-		float3 planeColor;
+		float4 planeColor;
 		float3 diffuseColor;
 		float3 specularColor;
 		float  ambientFactor;
@@ -132,6 +132,8 @@
 		float  perlinStartFreq;
 		float  perlinLacunarity;
 		float  perlinAmplitude;
+		bool   shoreWaves;
+		unsigned char numTiles;
 		std::string texture;
 		std::string foamTexture;
 		std::string normalTexture;

Modified: branches/0.77-branch/rts/Map/ReadMap.cpp
===================================================================
--- branches/0.77-branch/rts/Map/ReadMap.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Map/ReadMap.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -115,11 +115,12 @@
 
 void CReadMap::Serialize(creg::ISerializer&amp; s)
 {
-	float *hm = GetHeightmap();
-	s.Serialize(hm, 4 * (gs-&gt;mapx+1) * (gs-&gt;mapy+1));
+	// remove the const
+	float* hm = (float*) GetHeightmap();
+	s.Serialize(hm, 4 * (gs-&gt;mapx + 1) * (gs-&gt;mapy + 1));
 
 	if (!s.IsWriting())
-		mapDamage-&gt;RecalcArea(2,gs-&gt;mapx-3,2,gs-&gt;mapy-3);
+		mapDamage-&gt;RecalcArea(2, gs-&gt;mapx - 3, 2, gs-&gt;mapy - 3);
 }
 
 void CReadMap::Initialize()
@@ -143,7 +144,7 @@
 
 void CReadMap::CalcHeightfieldData()
 {
-	float* heightmap = GetHeightmap();
+	const float* heightmap = GetHeightmap();
 
 	minheight = +123456.0f;
 	maxheight = -123456.0f;
@@ -153,78 +154,87 @@
 		orgheightmap[y] = heightmap[y];
 		if (heightmap[y] &lt; minheight) { minheight = heightmap[y]; }
 		if (heightmap[y] &gt; maxheight) { maxheight = heightmap[y]; }
-		mapChecksum +=  (unsigned int)(heightmap[y] * 100);
-		mapChecksum ^= *(unsigned int*)&amp;heightmap[y];
+		mapChecksum +=  (unsigned int) (heightmap[y] * 100);
+		mapChecksum ^= *(unsigned int*) &amp;heightmap[y];
 	}
 
-//	PrintLoadMsg(&quot;Creating surface normals&quot;);
+	currMinHeight = minheight;
+	currMaxHeight = maxheight;
 
-	for(int y=0;y&lt;(gs-&gt;mapy);y++){
-		for(int x=0;x&lt;(gs-&gt;mapx);x++){
-			float height=heightmap[(y)*(gs-&gt;mapx+1)+x];
-			height+=heightmap[(y)*(gs-&gt;mapx+1)+x+1];
-			height+=heightmap[(y+1)*(gs-&gt;mapx+1)+x];
-			height+=heightmap[(y+1)*(gs-&gt;mapx+1)+x+1];
-			centerheightmap[y*gs-&gt;mapx+x]=height/4;
+	for (int y = 0; y &lt; (gs-&gt;mapy); y++) {
+		for (int x = 0; x &lt; (gs-&gt;mapx); x++) {
+			float height = heightmap[(y) * (gs-&gt;mapx + 1) + x];
+			height += heightmap[(y    ) * (gs-&gt;mapx + 1) + x + 1];
+			height += heightmap[(y + 1) * (gs-&gt;mapx + 1) + x    ];
+			height += heightmap[(y + 1) * (gs-&gt;mapx + 1) + x + 1];
+			centerheightmap[y * gs-&gt;mapx + x] = height * 0.25f;
 		}
 	}
 
-	for(int i=0; i&lt;numHeightMipMaps-1; i++){
-		int hmapx = gs-&gt;mapx&gt;&gt;i;
-		int hmapy = gs-&gt;mapy&gt;&gt;i;
-		for(int y=0;y&lt;hmapy;y+=2){
-			for(int x=0;x&lt;hmapx;x+=2){
-				float height = mipHeightmap[i][(x)+(y)*hmapx];
-				height += mipHeightmap[i][(x)+(y+1)*hmapx];
-				height += mipHeightmap[i][(x+1)+(y)*hmapx];
-				height += mipHeightmap[i][(x+1)+(y+1)*hmapx];
-				mipHeightmap[i+1][(x/2)+(y/2)*hmapx/2] = height/4.0f;
+	for (int i = 0; i &lt; numHeightMipMaps - 1; i++) {
+		int hmapx = gs-&gt;mapx &gt;&gt; i;
+		int hmapy = gs-&gt;mapy &gt;&gt; i;
+
+		for (int y = 0; y &lt; hmapy; y += 2) {
+			for (int x = 0; x &lt; hmapx; x += 2) {
+				float height = mipHeightmap[i][(x) + (y) * hmapx];
+				height += mipHeightmap[i][(x    ) + (y + 1) * hmapx];
+				height += mipHeightmap[i][(x + 1) + (y    ) * hmapx];
+				height += mipHeightmap[i][(x + 1) + (y + 1) * hmapx];
+				mipHeightmap[i + 1][(x / 2) + (y / 2) * hmapx / 2] = height * 0.25f;
 			}
 		}
 	}
 
-	for(int y=0;y&lt;gs-&gt;mapy;y++){
-		for(int x=0;x&lt;gs-&gt;mapx;x++){
+	// create the surface normals
+	for (int y = 0; y &lt; gs-&gt;mapy; y++) {
+		for (int x = 0; x &lt; gs-&gt;mapx; x++) {
+			int idx0 = (y    ) * (gs-&gt;mapx + 1) + x;
+			int idx1 = (y + 1) * (gs-&gt;mapx + 1) + x;
 
-			float3 e1(-SQUARE_SIZE,heightmap[y*(gs-&gt;mapx+1)+x]-heightmap[y*(gs-&gt;mapx+1)+x+1],0);
-			float3 e2( 0,heightmap[y*(gs-&gt;mapx+1)+x]-heightmap[(y+1)*(gs-&gt;mapx+1)+x],-SQUARE_SIZE);
+			float3 e1(-SQUARE_SIZE, heightmap[idx0] - heightmap[idx0 + 1],            0);
+			float3 e2(           0, heightmap[idx0] - heightmap[idx1    ], -SQUARE_SIZE);
 
-			float3 n=e2.cross(e1);
+			float3 n = e2.cross(e1);
 			n.Normalize();
 
-			facenormals[(y*gs-&gt;mapx+x)*2]=n;
+			facenormals[(y * gs-&gt;mapx + x) * 2] = n;
 
-			e1=float3( SQUARE_SIZE,heightmap[(y+1)*(gs-&gt;mapx+1)+x+1]-heightmap[(y+1)*(gs-&gt;mapx+1)+x],0);
-			e2=float3( 0,heightmap[(y+1)*(gs-&gt;mapx+1)+x+1]-heightmap[(y)*(gs-&gt;mapx+1)+x+1],SQUARE_SIZE);
+			e1 = float3( SQUARE_SIZE, heightmap[idx1 + 1] - heightmap[idx1    ],           0);
+			e2 = float3(           0, heightmap[idx1 + 1] - heightmap[idx0 + 1], SQUARE_SIZE);
 
-			n=e2.cross(e1);
+			n = e2.cross(e1);
 			n.Normalize();
 
-			facenormals[(y*gs-&gt;mapx+x)*2+1]=n;
+			facenormals[(y * gs-&gt;mapx + x) * 2 + 1] = n;
 		}
 	}
 
-	for(int y=0;y&lt;gs-&gt;hmapy;y++){
-		for(int x=0;x&lt;gs-&gt;hmapx;x++){
-			slopemap[y*gs-&gt;hmapx+x]=1;
+	for (int y = 0; y &lt; gs-&gt;hmapy; y++) {
+		for (int x = 0; x &lt; gs-&gt;hmapx; x++) {
+			slopemap[y * gs-&gt;hmapx + x] = 1;
 		}
 	}
 
-	for(int y=2;y&lt;gs-&gt;mapy-2;y+=2){
-		for(int x=2;x&lt;gs-&gt;mapx-2;x+=2){
-			float3 e1(-SQUARE_SIZE*4,heightmap[(y-1)*(gs-&gt;mapx+1)+(x-1)]-heightmap[(y-1)*(gs-&gt;mapx+1)+x+3],0);
-			float3 e2( 0,heightmap[(y-1)*(gs-&gt;mapx+1)+(x-1)]-heightmap[(y+3)*(gs-&gt;mapx+1)+(x-1)],-SQUARE_SIZE*4);
+	const int ss4 = SQUARE_SIZE * 4;
+	for (int y = 2; y &lt; gs-&gt;mapy - 2; y += 2) {
+		for (int x = 2; x &lt; gs-&gt;mapx - 2; x += 2) {
+			int idx0 = (y - 1) * (gs-&gt;mapx + 1);
+			int idx1 = (y + 3) * (gs-&gt;mapx + 1);
 
-			float3 n=e2.cross(e1);
+			float3 e1(-ss4, heightmap[idx0 + (x - 1)] - heightmap[idx0 +  x + 3 ],    0);
+			float3 e2(   0, heightmap[idx0 + (x - 1)] - heightmap[idx1 + (x - 1)], -ss4);
+
+			float3 n = e2.cross(e1);
 			n.Normalize();
 
-			e1=float3( SQUARE_SIZE*4,heightmap[(y+3)*(gs-&gt;mapx+1)+x+3]-heightmap[(y+3)*(gs-&gt;mapx+1)+x-1],0);
-			e2=float3( 0,heightmap[(y+3)*(gs-&gt;mapx+1)+x+3]-heightmap[(y-1)*(gs-&gt;mapx+1)+x+3],SQUARE_SIZE*4);
+			e1 = float3(ss4, heightmap[idx1 + x + 3] - heightmap[idx1 + (x - 1)],   0);
+			e2 = float3(  0, heightmap[idx1 + x + 3] - heightmap[idx0 +  x + 3 ], ss4);
 
-			float3 n2=e2.cross(e1);
+			float3 n2 = e2.cross(e1);
 			n2.Normalize();
 
-			slopemap[(y/2)*gs-&gt;hmapx+(x/2)]=1-(n.y+n2.y)*0.5f;
+			slopemap[(y / 2) * gs-&gt;hmapx + (x / 2)] = 1.0f - (n.y + n2.y) * 0.5f;
 		}
 	}
 }

Modified: branches/0.77-branch/rts/Map/ReadMap.h
===================================================================
--- branches/0.77-branch/rts/Map/ReadMap.h	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Map/ReadMap.h	2008-08-20 14:38:09 UTC (rev 6278)
@@ -44,9 +44,14 @@
 protected:
 	void Initialize(); // called by implementations of CReadMap
 public:
-	void CalcHeightfieldData(); /// Calculates derived heightmap information such as normals, centerheightmap and slopemap
+	// calculates derived heightmap information such as normals, centerheightmap and slopemap
+	void CalcHeightfieldData();
 
-	virtual float* GetHeightmap() = 0; // if you modify the heightmap, call HeightmapUpdated
+	virtual const float* GetHeightmap() = 0;
+	// if you modify the heightmap, call HeightmapUpdated
+	virtual void SetHeight(int idx, float h) = 0;
+	virtual void AddHeight(int idx, float a) = 0;
+
 	float* orgheightmap;
 	float* centerheightmap;
 	static const int numHeightMipMaps = 7;	//number of heightmap mipmaps, including full resolution
@@ -67,7 +72,6 @@
 	virtual void HeightmapUpdated(int x1, int x2, int y1, int y2)=0;
 	virtual void Update(){};
 	virtual void Explosion(float x,float y,float strength){};
-	virtual void ExplosionUpdate(int x1,int x2,int y1,int y2){};
 	virtual GLuint GetShadingTexture () = 0; // a texture with RGB for shading and A for height
 	static inline unsigned char EncodeHeight(float h) { return std::max(0, (int)(255+10.0f*h)); }
 
@@ -97,6 +101,7 @@
 	virtual void GridVisibility(CCamera *cam, int quadSize, float maxdist, IQuadDrawer *cb, int extraSize=0) = 0;
 
 	float minheight, maxheight;
+	float currMinHeight, currMaxHeight;
 };
 
 extern CReadMap* readmap;

Modified: branches/0.77-branch/rts/Map/SM3/Sm3GroundDrawer.cpp
===================================================================
--- branches/0.77-branch/rts/Map/SM3/Sm3GroundDrawer.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Map/SM3/Sm3GroundDrawer.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -69,8 +69,9 @@
 
 void CSm3GroundDrawer::Draw(bool drawWaterReflection,bool drawUnitReflection,unsigned int overrideVP)
 {
-	if(drawUnitReflection || drawWaterReflection)
-		return;
+	if (wireframe) {
+		glPolygonMode(GL_FRONT_AND_BACK, GL_LINE);
+	}
 
 	terrain::RenderContext *currc = rc;
 
@@ -136,6 +137,9 @@
 	glDisable(GL_LIGHT0);
 	glDisable(GL_LIGHTING);
 
+	if (wireframe) {
+		glPolygonMode(GL_FRONT_AND_BACK, GL_FILL);
+	}
 
 	if (drawMode != drawNormal)
 	{

Modified: branches/0.77-branch/rts/Map/SM3/Sm3Map.cpp
===================================================================
--- branches/0.77-branch/rts/Map/SM3/Sm3Map.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Map/SM3/Sm3Map.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -173,15 +173,8 @@
 	renderer-&gt;HeightmapUpdated(x1,y1,x2-x1,y2-y1);
 }
 
-float* CSm3ReadMap::GetHeightmap()
-{
-	return renderer-&gt;GetHeightmap();
-}
-
-
 void CSm3ReadMap::Update() {}
 void CSm3ReadMap::Explosion(float x,float y,float strength) {}
-void CSm3ReadMap::ExplosionUpdate(int x1,int x2,int y1,int y2) {}
 GLuint CSm3ReadMap::GetShadingTexture () { return 0; } // a texture with RGB for shading and A for height
 void CSm3ReadMap::DrawMinimap ()
 {

Modified: branches/0.77-branch/rts/Map/SM3/Sm3Map.h
===================================================================
--- branches/0.77-branch/rts/Map/SM3/Sm3Map.h	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Map/SM3/Sm3Map.h	2008-08-20 14:38:09 UTC (rev 6278)
@@ -18,22 +18,33 @@
 
 	CSm3ReadMap();
 	~CSm3ReadMap();
-	void Initialize (const char *mapname); // throws std::runtime_exception on errors
+	void Initialize(const char* mapname); // throws std::runtime_exception on errors
 
-	CBaseGroundDrawer *GetGroundDrawer ();
+	CBaseGroundDrawer* GetGroundDrawer();
 	void HeightmapUpdated(int x1, int x2, int y1, int y2);
-	float* GetHeightmap();
+	const float* GetHeightmap() { return renderer-&gt;GetHeightmap(); }
+
+	inline void SetHeight(int idx, float h) {
+		renderer-&gt;GetHeightmap()[idx] = h;
+		currMinHeight = std::min(h, currMinHeight);
+		currMaxHeight = std::max(h, currMaxHeight);
+	}
+	inline void AddHeight(int idx, float a) {
+		renderer-&gt;GetHeightmap()[idx] += a;
+		currMinHeight = std::min(renderer-&gt;GetHeightmap()[idx], currMinHeight);
+		currMaxHeight = std::max(renderer-&gt;GetHeightmap()[idx], currMaxHeight);
+	}
+
 	void Update();
-	void Explosion(float x,float y,float strength);
-	void ExplosionUpdate(int x1,int x2,int y1,int y2);
-	GLuint GetShadingTexture (); // a texture with RGB for shading and A for height
-	void DrawMinimap (); // draw the minimap in a quad (with extends: (0,0)-(1,1))
+	void Explosion(float x, float y, float strength);
+	GLuint GetShadingTexture(); // a texture with RGB for shading and A for height
+	void DrawMinimap(); // draw the minimap in a quad (with extends: (0,0)-(1,1))
 
 	// Feature creation
-	int GetNumFeatures ();
-	int GetNumFeatureTypes ();
-	void GetFeatureInfo (MapFeatureInfo* f); // returns MapFeatureInfo[GetNumFeatures()]
-	const char *GetFeatureType (int typeID);
+	int GetNumFeatures();
+	int GetNumFeatureTypes();
+	void GetFeatureInfo(MapFeatureInfo* f); // returns MapFeatureInfo[GetNumFeatures()]
+	const char* GetFeatureType(int typeID);
 
 	// Bitmaps (such as metal map, grass map, ...), handling them with a string as type seems flexible...
 	// Some map types:

Modified: branches/0.77-branch/rts/Map/SM3/terrain/Terrain.cpp
===================================================================
--- branches/0.77-branch/rts/Map/SM3/terrain/Terrain.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Map/SM3/terrain/Terrain.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -51,9 +51,6 @@
 
 	using namespace std;
 
-	// debug stuff
-	bool fill=true;
-
 	Config::Config()
 	{
 		cacheTextures=false;
@@ -592,14 +589,9 @@
 
 	void Terrain::Draw ()
 	{
-		if (!fill)
-			glPolygonMode (GL_FRONT_AND_BACK,GL_LINE);
-		else {
-			glPolygonMode (GL_FRONT_AND_BACK,GL_FILL);
+		const float diffuse[] = { 1.0f, 1.0f, 1.0f, 1.0f };
+		glMaterialfv (GL_FRONT_AND_BACK, GL_AMBIENT_AND_DIFFUSE, diffuse);
 
-			const float diffuse[] = { 1.0f, 1.0f, 1.0f, 1.0f };
-			glMaterialfv (GL_FRONT_AND_BACK, GL_AMBIENT_AND_DIFFUSE, diffuse);
-		}
 		glEnable(GL_CULL_FACE);
 		glColor3f(1.0f,1.0f,1.0f);
 
@@ -647,23 +639,21 @@
 
 			glEnable(GL_DEPTH_TEST);
 
-			if (fill) texturing-&gt;BeginTexturing();
+			texturing-&gt;BeginTexturing();
 
-			if (!fill) numPasses=1;
+			numPasses=1;
 			for (int pass=0;pass&lt;numPasses;pass++)
 			{
 				bool skipNodes=false;
 
-				if (fill)
-					texturing-&gt;BeginPass(pass);
+				texturing-&gt;BeginPass(pass);
 
 				for (int a=0;a&lt;activeRC-&gt;quads.size();a++)
 				{
 					TQuad *q = activeRC-&gt;quads[a].quad;
 
 					// Setup node texturing
-					if (fill)
-						skipNodes = !texturing-&gt;SetupNode (q, pass);
+					skipNodes = !texturing-&gt;SetupNode (q, pass);
 
 					assert (q-&gt;renderData);
 
@@ -673,20 +663,17 @@
 					}
 				}
 
-				if (fill) texturing-&gt;EndPass();
+				texturing-&gt;EndPass();
 			}
 
 			glDisable (GL_BLEND);
 			glDepthMask (GL_TRUE);
 
-			if (fill)
-				texturing-&gt;EndTexturing ();
+			texturing-&gt;EndTexturing ();
 		}
 
 		if (debugQuad)
 			DrawNormals (debugQuad, lowdetailhm-&gt;GetLevel (debugQuad-&gt;depth));
-
-		glPolygonMode (GL_FRONT_AND_BACK,GL_FILL);
 	}
 
 	void Terrain::CalcRenderStats (RenderStats&amp; stats, RenderContext *ctx)
@@ -840,10 +827,6 @@
 
 	void Terrain::DebugEvent (const std::string&amp; event)
 	{
-		if (event == &quot;t_toggle_fill&quot;) {
-			fill=!fill;
-			return;
-		}
 		if (event == &quot;t_detail_inc&quot;)
 			config.detailMod *= 1.2f;
 		if (event == &quot;t_detail_dec&quot;)

Modified: branches/0.77-branch/rts/Map/SMF/BFGroundDrawer.cpp
===================================================================
--- branches/0.77-branch/rts/Map/SMF/BFGroundDrawer.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Map/SMF/BFGroundDrawer.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -12,6 +12,7 @@
 #include &quot;Rendering/ShadowHandler.h&quot;
 #include &quot;Rendering/GroundDecalHandler.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
+#include &quot;System/FastMath.h&quot;
 #include &quot;mmgr.h&quot;
 
 #ifdef USE_GML
@@ -26,7 +27,8 @@
 	bigSquareSize(128),
 	numBigTexX(gs-&gt;mapx / bigSquareSize),
 	numBigTexY(gs-&gt;mapy / bigSquareSize),
-	heightDataX(gs-&gt;mapx + 1)
+	heightDataX(gs-&gt;mapx + 1),
+	maxIdx(((gs-&gt;mapx + 1) * (gs-&gt;mapy + 1)) - 1)
 {
 	map = rm;
 
@@ -66,31 +68,61 @@
 }
 
 
+inline void CBFGroundDrawer::DrawWaterPlane(bool drawWaterReflection) {
+	if (!drawWaterReflection) {
+		glDisable(GL_TEXTURE_2D);
 
-inline void CBFGroundDrawer::DrawVertexA(int x, int y)
-{
-	float height = heightData[y * heightDataX + x];
-	if (waterDrawn &amp;&amp; height &lt; 0) {
-		height *= 2;
-	}
+		const float xsize = (gs-&gt;mapx * SQUARE_SIZE) &gt;&gt; 2;
+		const float ysize = (gs-&gt;mapy * SQUARE_SIZE) &gt;&gt; 2;
+		const bool  camOutMap = (camera-&gt;pos.x &lt; 0 || camera-&gt;pos.z &lt; 0 || camera-&gt;pos.x &gt; float3::maxxpos || camera-&gt;pos.z &gt; float3::maxzpos);
 
-	va-&gt;AddVertex0(float3(x * SQUARE_SIZE, height, y * SQUARE_SIZE));
-}
+		CVertexArray *va = GetVertexArray();
+		va-&gt;Initialize();
 
-inline void CBFGroundDrawer::DrawVertexA(int x, int y, float height)
-{
-	if (waterDrawn &amp;&amp; height &lt; 0) {
-		height *= 2;
+		unsigned char fogColor[4] = {
+		  (unsigned char)(255 * mapInfo-&gt;atmosphere.fogColor[0]),
+		  (unsigned char)(255 * mapInfo-&gt;atmosphere.fogColor[1]),
+		  (unsigned char)(255 * mapInfo-&gt;atmosphere.fogColor[2]),
+		  255
+		};
+
+		unsigned char planeColor[4] = {
+		  (unsigned char)(255 * mapInfo-&gt;water.planeColor[0]),
+		  (unsigned char)(255 * mapInfo-&gt;water.planeColor[1]),
+		  (unsigned char)(255 * mapInfo-&gt;water.planeColor[2]),
+		   255
+		};
+
+		const float alphainc = fastmath::PI2 / 32;
+		float alpha,r1,r2;
+		float3 p(0.0f,-200.0f,0.0f);
+		const float size = std::min(xsize,ysize);
+		for (int n = (camOutMap) ? 0 : 1; n &lt; 4 ; ++n) {
+			if ((n==1) &amp;&amp; !camOutMap) {
+				r1 = 2 * size;
+			}else{
+				r1 = n*n * size;
+			}
+			if (n==3) {
+				r2 = (n+0.5)*(n+0.5) * size;
+			}else{
+				r2 = (n+1)*(n+1) * size;
+			}
+			for (alpha = 0.0f; (alpha - fastmath::PI2) &lt; alphainc ; alpha+=alphainc) {
+				p.x = r1 * fastmath::sin(alpha) + 2 * xsize;
+				p.z = r1 * fastmath::cos(alpha) + 2 * ysize;
+				va-&gt;AddVertexC(p, planeColor );
+				p.x = r2 * fastmath::sin(alpha) + 2 * xsize;
+				p.z = r2 * fastmath::cos(alpha) + 2 * ysize;
+				va-&gt;AddVertexC(p, (n==3) ? fogColor : planeColor);
+			}
+		}
+
+		va-&gt;DrawArrayC(GL_TRIANGLE_STRIP);
 	}
-	va-&gt;AddVertex0(float3(x * SQUARE_SIZE, height, y * SQUARE_SIZE));
 }
 
-inline void CBFGroundDrawer::EndStrip()
-{
-	va-&gt;EndStrip();
-}
 
-
 inline void CBFGroundDrawer::DrawVertexAQ(CVertexArray *ma, int x, int y)
 {
 	float height = heightData[y * heightDataX + x];
@@ -114,12 +146,13 @@
 	ma-&gt;EndStripQ();
 }
 
+
 inline bool CBFGroundDrawer::BigTexSquareRowVisible(int bty) {
 	static int mapWidth = (gs-&gt;mapx &lt;&lt; 3);
 	static int bigTexH = (gs-&gt;mapy &lt;&lt; 3) / numBigTexY;
 
-	const int minx =                   0;
-	const int maxx =            mapWidth;
+	const int minx =             0;
+	const int maxx =      mapWidth;
 	const int minz = bty * bigTexH;
 	const int maxz = minz + bigTexH;
 	const float miny = readmap-&gt;minheight;
@@ -132,68 +165,30 @@
 }
 
 
-
-inline void CBFGroundDrawer::DrawWaterPlane(bool drawWaterReflection) {
-	if (!drawWaterReflection) {
-		glDisable(GL_TEXTURE_2D);
-		glColor3f(mapInfo-&gt;water.planeColor.x, mapInfo-&gt;water.planeColor.y, mapInfo-&gt;water.planeColor.z);
-		glBegin(GL_QUADS);
-
-		static const float xsize = (gs-&gt;mapx * SQUARE_SIZE) &gt;&gt; 2;
-		static const float ysize = (gs-&gt;mapy * SQUARE_SIZE) &gt;&gt; 2;
-		const bool camOutMap = (camera-&gt;pos.x &lt; 0 || camera-&gt;pos.z &lt; 0 || camera-&gt;pos.x &gt; float3::maxxpos || camera-&gt;pos.z &gt; float3::maxzpos);
-
-		for (int y = -4; y &lt; 8; ++y) {
-			for (int x = -4; x &lt; 8; ++x) {
-				if (x &gt; 3 || x &lt; 0 || y &gt; 3 || y &lt; 0 || camOutMap) {
-					glVertex3f( x      * xsize, -200,  y      * ysize);
-					glVertex3f((x + 1) * xsize, -200,  y      * ysize);
-					glVertex3f((x + 1) * xsize, -200, (y + 1) * ysize);
-					glVertex3f( x      * xsize, -200, (y + 1) * ysize);
-				}
-			}
-		}
-		glEnd();
-	}
-}
-
-inline void CBFGroundDrawer::DrawGroundVertexArray()
-{
-	va-&gt;DrawArray0(GL_TRIANGLE_STRIP);
-	va = GetVertexArray();
-	va-&gt;Initialize();
-}
-
-
 inline void CBFGroundDrawer::DrawGroundVertexArrayQ(CVertexArray * &amp;ma)
 {
 	ma-&gt;DrawArray0(GL_TRIANGLE_STRIP);
 	ma = GetVertexArray();
-	ma-&gt;Initialize();
 }
 
-int neededLod=0;
-int maxIdx=0;
+#define CLAMP(i) std::max(0, std::min((i), maxIdx))
 
 inline void CBFGroundDrawer::DoDrawGroundRow(int bty, unsigned int overrideVP) {
-#define CLAMP(i) std::max(0, std::min((i), maxIdx))
 	if (!BigTexSquareRowVisible(bty)) {
 		// skip this entire row of squares if we can't see it
 		return;
 	}
 
 	CVertexArray *ma = GetVertexArray();
-	ma-&gt;Initialize();
 
 	bool inStrip = false;
+	float x0, x1;
 	int x,y;
-	// only process the necessary big squares in the x direction
 	int sx = 0;
 	int ex = numBigTexX;
-	float x0, x1;
 	std::vector&lt;fline&gt;::iterator fli;
 
-
+	// only process the necessary big squares in the x direction
 	for (fli = left.begin(); fli != left.end(); fli++) {
 		x0 = ((fli-&gt;base / SQUARE_SIZE + fli-&gt;dir *  (bty * bigSquareSize)                 ));
 		x1 = ((fli-&gt;base / SQUARE_SIZE + fli-&gt;dir * ((bty * bigSquareSize) + bigSquareSize)));
@@ -234,6 +229,8 @@
 			glProgramEnvParameter4fARB(GL_VERTEX_PROGRAM_ARB, 11, -btx, -bty, 0, 0);
 		}
 
+		ma-&gt;Initialize();
+
 		for (int lod = 1; lod &lt; neededLod; lod &lt;&lt;= 1) {
 			float cx2 = (cam2-&gt;pos.x / (SQUARE_SIZE));
 			float cy2 = (cam2-&gt;pos.z / (SQUARE_SIZE));
@@ -318,7 +315,7 @@
 							DrawVertexAQ(ma, x + lod, y      );
 							DrawVertexAQ(ma, x + lod, y + lod);
 					} else {
-						// inre begr&#65533;sning mot f&#65533;eg&#65533;nde lod
+						// inre begr?sning mot f?eg?nde lod
 						if ((x &gt;= (cx) + viewRadius * hlod)) {
 							int idx1 = CLAMP((y       ) * heightDataX + x), idx1LOD = CLAMP(idx1 + lod), idx1HLOD = CLAMP(idx1 + hlod);
 							int idx2 = CLAMP((y +  lod) * heightDataX + x), idx2LOD = CLAMP(idx2 + lod), idx2HLOD = CLAMP(idx2 + hlod);
@@ -451,7 +448,7 @@
 			int nloop=(yed-yst)/lod+1;
 			ma-&gt;EnlargeArrays(8*nloop, 2*nloop);
 
-			// rita yttre begr&#65533;snings yta mot n&#65533;ta lod
+			// rita yttre begr?snings yta mot n?ta lod
 			if (maxlx &lt; maxtx &amp;&amp; maxlx &gt;= mintx) {
 				x = maxlx;
 				for (y = yst; y &lt; yed; y += lod) {
@@ -653,18 +650,20 @@
 	int baseViewRadius = max(4, viewRadius);
 
 	if (drawUnitReflection) {
-		viewRadius = (viewRadius &gt;&gt; 1) &amp; 0xfffffe;
+		viewRadius = ((int)(viewRadius * LODScaleUnitReflection)) &amp; 0xfffffe;
 	}
+	if (drawWaterReflection) {
+		viewRadius = ((int)(viewRadius * LODScaleReflection)) &amp; 0xfffffe;
+	}
+	//if (drawWaterRefraction) {
+	//	viewRadius = ((int)(viewRadius * LODScaleRefraction)) &amp; 0xfffffe;
+	//}
 
 	float zoom = 45.0f / camera-&gt;GetFov();
 	viewRadius = (int) (viewRadius * sqrt(zoom));
 	viewRadius += (viewRadius &amp; 1);
 
-	va = GetVertexArray();
-	va-&gt;Initialize();
-
 	neededLod = int((gu-&gt;viewRange * 0.125f) / viewRadius) &lt;&lt; 1;
-	maxIdx = ((gs-&gt;mapx + 1) * (gs-&gt;mapy + 1)) - 1;
 
 	UpdateCamRestraints();
 
@@ -828,7 +827,7 @@
 					}
 					DrawVertexAQ(ma, x + lod, y      );
 					DrawVertexAQ(ma, x + lod, y + lod);
-			} else {  //inre begr&#65533;sning mot f&#65533;eg&#65533;nde lod
+			} else {  //inre begr?sning mot f?eg?nde lod
 				if((x&gt;=(cx)+viewRadius*hlod)){
 					float h1=(heightData[(y)*heightDataX+x]+heightData[(y+lod)*heightDataX+x])*0.5f*(1-oldcamxpart)+heightData[(y+hlod)*heightDataX+x]*(oldcamxpart);
 					float h2=(heightData[(y)*heightDataX+x]+heightData[(y)*heightDataX+x+lod])*0.5f*(1-oldcamxpart)+heightData[(y)*heightDataX+x+hlod]*(oldcamxpart);
@@ -943,7 +942,7 @@
 	int yed=min(yend + lod, maxty);
 	int nloop=(yed-yst)/lod+1;
 	ma-&gt;EnlargeArrays(8*nloop, 2*nloop);
-	//rita yttre begr&#65533;snings yta mot n&#65533;ta lod
+	//rita yttre begr?snings yta mot n?ta lod
 	if(maxlx&lt;maxtx &amp;&amp; maxlx&gt;=mintx){
 		x=maxlx;
 		for(y=yst;y&lt;yed;y+=lod){
@@ -1043,20 +1042,12 @@
 
 void CBFGroundDrawer::DrawShadowPass(void)
 {
-	va = GetVertexArray();
-	va-&gt;Initialize();
-
 //	glEnable(GL_CULL_FACE);
-	bool inStrip = false;
 	const int NUM_LODS = 4;
 
 	glPolygonOffset(1, 1);
 	glEnable(GL_POLYGON_OFFSET_FILL);
 
-	int x,y;
-	float camxpart = 0.0f, oldcamxpart;
-	float camypart = 0.0f, oldcamypart;
-
 	glBindProgramARB(GL_VERTEX_PROGRAM_ARB, groundShadowVP);
 	glEnable(GL_VERTEX_PROGRAM_ARB);
 
@@ -1256,9 +1247,9 @@
 		b.z = 0.0001f;
 
 	{
-		temp.dir = b.x / b.z;				// set direction to that
-		float3 c = b.cross(side);			// get vector from camera to collision line
-		float3 colpoint;					// a point on the collision line
+		temp.dir = b.x / b.z;      // set direction to that
+		float3 c = b.cross(side);  // get vector from camera to collision line
+		float3 colpoint;           // a point on the collision line
 
 		if (side.y &gt; 0)
 			colpoint = cam2-&gt;pos - c * ((cam2-&gt;pos.y - (readmap-&gt;minheight - 100)) / c.y);
@@ -1298,9 +1289,9 @@
 	float3 b = up.cross(camHorizontal);
 
 	if (fabs(b.z) &gt; 0.0001f) {
-		temp.dir = b.x / b.z;					// set direction to that
-		float3 c = b.cross(camHorizontal);		// get vector from camera to collision line
-		float3 colpoint;						// a point on the collision line
+		temp.dir = b.x / b.z;               // set direction to that
+		float3 c = b.cross(camHorizontal);  // get vector from camera to collision line
+		float3 colpoint;                    // a point on the collision line
 
 		if (side.y &gt; 0)
 			colpoint = cam2-&gt;pos + camHorizontal * gu-&gt;viewRange * 1.05f - c * (cam2-&gt;pos.y / c.y);

Modified: branches/0.77-branch/rts/Map/SMF/BFGroundDrawer.h
===================================================================
--- branches/0.77-branch/rts/Map/SMF/BFGroundDrawer.h	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Map/SMF/BFGroundDrawer.h	2008-08-20 14:38:09 UTC (rev 6278)
@@ -36,12 +36,13 @@
 	const int bigSquareSize;
 	const int numBigTexX;
 	const int numBigTexY;
+	const int maxIdx;
 
+	int neededLod;
+
 	float* heightData;
 	const int heightDataX;
 
-	CVertexArray* va;
-
 	struct fline {
 		float base;
 		float dir;
@@ -66,12 +67,8 @@
 	void DoDrawGroundShadowLOD(int nlod);
 	static void DoDrawGroundShadowLODMT(void *c,int nlod) {((CBFGroundDrawer *)c)-&gt;DoDrawGroundShadowLOD(nlod);}
 
-	inline void DrawVertexA(int x, int y);
-	inline void DrawVertexA(int x, int y, float height);
-	inline void EndStrip();
 	inline void DrawWaterPlane(bool);
 	inline bool BigTexSquareRowVisible(int);
-	inline void DrawGroundVertexArray();
 	void SetupTextureUnits(bool drawReflection, unsigned int overrideVP);
 	void ResetTextureUnits(bool drawReflection, unsigned int overrideVP);
 
@@ -80,3 +77,4 @@
 };
 
 #endif // __BF_GROUND_DRAWER_H__
+

Modified: branches/0.77-branch/rts/Map/SMF/SmfReadMap.h
===================================================================
--- branches/0.77-branch/rts/Map/SMF/SmfReadMap.h	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Map/SMF/SmfReadMap.h	2008-08-20 14:38:09 UTC (rev 6278)
@@ -21,8 +21,19 @@
 	void DrawMinimap ();
 	void GridVisibility(CCamera *cam, int quadSize, float maxdist, IQuadDrawer *cb, int extraSize);
 	CBaseGroundDrawer* GetGroundDrawer();
-	float* GetHeightmap() { return heightmap; }
-	
+	const float* GetHeightmap() { return heightmap; }
+
+	inline void SetHeight(int idx, float h) {
+		heightmap[idx] = h;
+		currMinHeight = std::min(h, currMinHeight);
+		currMaxHeight = std::max(h, currMaxHeight);
+	}
+	inline void AddHeight(int idx, float a) {
+		heightmap[idx] += a;
+		currMinHeight = std::min(heightmap[idx], currMinHeight);
+		currMaxHeight = std::max(heightmap[idx], currMaxHeight);
+	}
+
 	int GetNumFeatureTypes ();
 	int GetNumFeatures ();
 	void GetFeatureInfo (MapFeatureInfo* f);// returns all feature info in MapFeatureInfo[NumFeatures]

Modified: branches/0.77-branch/rts/Rendering/Env/AdvWater.cpp
===================================================================
--- branches/0.77-branch/rts/Rendering/Env/AdvWater.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Rendering/Env/AdvWater.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -119,8 +119,9 @@
 
 void CAdvWater::Draw(bool useBlending)
 {
-	if(readmap-&gt;minheight&gt;10)
+	if (readmap-&gt;currMinHeight &gt; 1.0f)
 		return;
+
 	float3 dir,zpos;
 	float3 base=camera-&gt;CalcPixelDir(gu-&gt;viewPosX,gu-&gt;viewSizeY);
 	float3 dv=camera-&gt;CalcPixelDir(gu-&gt;viewPosX,0)-camera-&gt;CalcPixelDir(gu-&gt;viewPosX,gu-&gt;viewSizeY);
@@ -226,7 +227,7 @@
 
 void CAdvWater::UpdateWater(CGame* game)
 {
-	if (readmap-&gt;minheight &gt; 10 || mapInfo-&gt;map.voidWater)
+	if (readmap-&gt;currMinHeight &gt; 1.0f || mapInfo-&gt;map.voidWater)
 		return;
 
 	glViewport(0,0,128,128);

Modified: branches/0.77-branch/rts/Rendering/Env/BaseWater.h
===================================================================
--- branches/0.77-branch/rts/Rendering/Env/BaseWater.h	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Rendering/Env/BaseWater.h	2008-08-20 14:38:09 UTC (rev 6278)
@@ -12,6 +12,7 @@
 	virtual void Draw()=0;
 	virtual void Update(){};
 	virtual void UpdateWater(CGame* game)=0;
+	virtual void HeightmapChanged(const int x1, const int y1, const int x2, const int y2){};
 	virtual void AddExplosion(const float3&amp; pos, float strength, float size){};
 	virtual int  GetID() const { return -1; }
 

Modified: branches/0.77-branch/rts/Rendering/Env/BasicWater.cpp
===================================================================
--- branches/0.77-branch/rts/Rendering/Env/BasicWater.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Rendering/Env/BasicWater.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -41,7 +41,7 @@
 
 void CBasicWater::Draw()
 {
-	if(readmap-&gt;minheight &gt; 10)
+	if (readmap-&gt;currMinHeight &gt; 1.0f)
 		return;
 
 	if(displist == 0) {

Modified: branches/0.77-branch/rts/Rendering/Env/BumpWater.cpp
===================================================================
--- branches/0.77-branch/rts/Rendering/Env/BumpWater.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Rendering/Env/BumpWater.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -9,45 +9,49 @@
 
 #include &quot;StdAfx.h&quot;
 #include &quot;bitops.h&quot;
-#include &quot;FileSystem/FileHandler.h&quot;
 #include &quot;BumpWater.h&quot;
+#include &quot;BaseSky.h&quot;
 #include &quot;Game/Game.h&quot;
+#include &quot;Game/Camera.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
-#include &quot;Rendering/GL/IFramebuffer.h&quot;
+#include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Rendering/Textures/Bitmap.h&quot;
-#include &quot;Game/Camera.h&quot;
+#include &quot;Rendering/UnitModels/UnitDrawer.h&quot;
 #include &quot;Map/MapInfo.h&quot;
 #include &quot;Map/ReadMap.h&quot;
-#include &quot;LogOutput.h&quot;
 #include &quot;Map/BaseGroundDrawer.h&quot;
-#include &quot;BaseSky.h&quot;
-#include &quot;Rendering/UnitModels/UnitDrawer.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;Sim/Features/FeatureHandler.h&quot;
 #include &quot;Sim/Misc/Wind.h&quot;
+#include &quot;FileSystem/FileHandler.h&quot;
+#include &quot;System/FastMath.h&quot;
 #include &quot;System/EventHandler.h&quot;
 #include &quot;System/Platform/ConfigHandler.h&quot;
+#include &quot;TimeProfiler.h&quot;
+#include &quot;LogOutput.h&quot;
 #include &lt;boost/format.hpp&gt;
 
 using std::string;
 using std::vector;
+using std::min;
+using std::max;
 
-//////////////////////////////////////////////////////////////////////
-// Construction/Destruction
-//////////////////////////////////////////////////////////////////////
+///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
+/// HELPER FUNCTIONS
+///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
 
 static void PrintShaderLog(GLuint obj, const string&amp; type)
 {
-	// WAS COMPILATION SUCCESSFUL ?
+	/** WAS COMPILATION SUCCESSFUL ? **/
 	GLint compiled;
 	if(glIsShader(obj))
 		glGetShaderiv(obj,GL_COMPILE_STATUS,&amp;compiled);
 	else
-		glGetProgramiv(obj,GL_COMPILE_STATUS,&amp;compiled);
+		glGetProgramiv(obj,GL_LINK_STATUS,&amp;compiled);
 
 	if (compiled) return;
 
-	// GET INFOLOG
+	/** GET INFOLOG **/
 	int infologLength = 0;
 	int maxLength;
 
@@ -66,7 +70,7 @@
 	if (infologLength &gt; 0) {
 		string str(infoLog, infologLength);
 		delete[] infoLog;
-		// string size is limited with content_error()
+		//! string size is limited with content_error()
 		logOutput.Print(&quot;BumpWater shader error (&quot; + type  + &quot;): &quot; + str);
 		throw content_error(string(&quot;BumpWater shader error!&quot;));
 	}
@@ -106,6 +110,7 @@
 	}
 }
 
+
 static string LoadShaderSource(const string&amp; file)
 {
 	CFileHandler fh(file);
@@ -117,27 +122,32 @@
 	return text;
 }
 
+
 static void GLSLDefineConstf4(string&amp; str, const string&amp; name, const float3&amp; v, const float&amp; alpha)
 {
 	str += boost::str(boost::format(string(&quot;#define &quot;)+name+&quot; vec4(%1$.12f,%2$.12f,%3$.12f,%4$.12f)\n&quot;) % (v.x) % (v.y) % (v.z) % (alpha));
 }
 
+
 static void GLSLDefineConstf3(string&amp; str, const string&amp; name, const float3&amp; v)
 {
 	str += boost::str(boost::format(string(&quot;#define &quot;)+name+&quot; vec3(%1$.12f,%2$.12f,%3$.12f)\n&quot;) % (v.x) % (v.y) % (v.z));
 }
 
+
 static void GLSLDefineConstf2(string&amp; str, const string&amp; name, const float&amp; x, const float&amp; y)
 {
 	str += boost::str(boost::format(string(&quot;#define &quot;)+name+&quot; vec2(%1$.12f,%2$.12f)\n&quot;) % x % y);
 }
 
+
 static void GLSLDefineConstf1(string&amp; str, const string&amp; name, const float&amp; x)
 {
 	str += boost::str(boost::format(string(&quot;#define &quot;)+name+&quot; %1$.12f\n&quot;) % x);
 }
 
-static GLuint LoadTexture(const string&amp; filename, const float anisotropy = 0.0f)
+
+static GLuint LoadTexture(const string&amp; filename, const float anisotropy = 0.0f, int* sizeX = NULL, int* sizeY = NULL)
 {
 	GLuint texID;
 	CBitmap bm;
@@ -146,25 +156,39 @@
 
 	glGenTextures(1, &amp;texID);
 	glBindTexture(GL_TEXTURE_2D, texID);
+	glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_REPEAT);
+	glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_REPEAT);
 	glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
 	glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR_MIPMAP_LINEAR);
 	if (anisotropy &gt; 0.0f)
 		glTexParameterf(GL_TEXTURE_2D, GL_TEXTURE_MAX_ANISOTROPY_EXT, anisotropy);
-	glBuildMipmaps(GL_TEXTURE_2D, GLEW_ARB_texture_compression?GL_COMPRESSED_RGBA_ARB:GL_RGBA8, bm.xsize, bm.ysize, GL_RGBA, GL_UNSIGNED_BYTE, bm.mem);
+	glBuildMipmaps(GL_TEXTURE_2D, GL_RGBA8, bm.xsize, bm.ysize, GL_RGBA, GL_UNSIGNED_BYTE, bm.mem);
+
+	if (sizeY != NULL) {
+		*sizeX = bm.xsize;
+		*sizeY = bm.ysize;
+	}
+
 	return texID;
 }
 
+///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
+/// (DE-)CONSTRUCTOR
+///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
+
 CBumpWater::CBumpWater()
 {
 	/** LOAD USER CONFIGS **/
-	reflTexSize = next_power_of_2(configHandler.GetInt(&quot;BumpWaterTexSizeReflection&quot;, 256));
-	reflection  = !!configHandler.GetInt(&quot;BumpWaterReflection&quot;, 1);
-	refraction  = configHandler.GetInt(&quot;BumpWaterRefraction&quot;, 1);  //0:=off, 1:=screencopy, 2:=own rendering cycle
-	shorewaves  = !!configHandler.GetInt(&quot;BumpWaterShoreWaves&quot;, 0);
-	anisotropy  = atof(configHandler.GetString(&quot;BumpWaterAnisotropy&quot;, &quot;0.0&quot;).c_str());
-	depthCopy   = !!configHandler.GetInt(&quot;BumpWaterUseDepthTexture&quot;, 1);
-	depthBits   = configHandler.GetInt(&quot;BumpWaterDepthBits&quot;, 24);
-	blurRefl    = !!configHandler.GetInt(&quot;BumpWaterBlurReflection&quot;, 0);
+	reflTexSize  = next_power_of_2(configHandler.GetInt(&quot;BumpWaterTexSizeReflection&quot;, 512));
+	reflection   = !!configHandler.GetInt(&quot;BumpWaterReflection&quot;, 1);
+	refraction   = configHandler.GetInt(&quot;BumpWaterRefraction&quot;, 1);  /// 0:=off, 1:=screencopy, 2:=own rendering cycle
+	anisotropy   = atof(configHandler.GetString(&quot;BumpWaterAnisotropy&quot;, &quot;0.0&quot;).c_str());
+	depthCopy    = !!configHandler.GetInt(&quot;BumpWaterUseDepthTexture&quot;, 1);
+	depthBits    = configHandler.GetInt(&quot;BumpWaterDepthBits&quot;, 24);
+	blurRefl     = !!configHandler.GetInt(&quot;BumpWaterBlurReflection&quot;, 0);
+	shoreWaves   = (!!configHandler.GetInt(&quot;BumpWaterShoreWaves&quot;, 1)) &amp;&amp; mapInfo-&gt;water.shoreWaves;
+	endlessOcean = (!!configHandler.GetInt(&quot;BumpWaterEndlessOcean&quot;, 1)) &amp;&amp; mapInfo-&gt;hasWaterPlane;
+	dynWaves     = (!!configHandler.GetInt(&quot;BumpWaterDynamicWaves&quot;, 1)) &amp;&amp; (mapInfo-&gt;water.numTiles&gt;1);
 
 	if (refraction&gt;1)
 		drawSolid = true;
@@ -174,15 +198,86 @@
 	if (!GL_ARB_shading_language_100)
 		throw content_error(&quot;BumpWater: your hardware/driver setup does not support GLSL.&quot;);
 
-	if (!(GLEW_ARB_texture_rectangle || GLEW_EXT_texture_rectangle))
-		refraction = 0;
+	shoreWaves = shoreWaves &amp;&amp; (GLEW_EXT_framebuffer_object);
+	dynWaves   = dynWaves &amp;&amp; (GLEW_EXT_framebuffer_object &amp;&amp; GLEW_ARB_imaging);
 
-	shorewaves = shorewaves &amp;&amp; (GLEW_EXT_framebuffer_object);
 
+	/** LOAD TEXTURES **/
+	foamTexture     = LoadTexture( mapInfo-&gt;water.foamTexture );
+	normalTexture   = LoadTexture( mapInfo-&gt;water.normalTexture , anisotropy , &amp;normalTextureX, &amp;normalTextureY);
 
+	//! caustic textures
+	const vector&lt;string&gt;&amp; causticNames = mapInfo-&gt;water.causticTextures;
+	if (causticNames.size() &lt;= 0) {
+		throw content_error(&quot;no caustic textures&quot;);
+	}
+	for (int i = 0; i &lt; (int)causticNames.size(); ++i) {
+		caustTextures.push_back(LoadTexture(causticNames[i]));
+	}
+
+
+	/** SHOREWAVES **/
+	if (shoreWaves) {
+		pboID = 0;
+		if (GLEW_EXT_pixel_buffer_object) {
+			glGenBuffers(1, &amp;pboID);
+		}
+
+		coastmapNeedUpload=false;
+		coastmapNeedUpdate=false;
+		coastUploadX1 = (int)1e9;
+		coastUploadX2 = -1;
+		coastUploadZ1 = (int)1e9;
+		coastUploadZ2 = -1;
+
+		waveRandTexture = LoadTexture( &quot;bitmaps/shorewaverand.bmp&quot; );
+
+		glGenTextures(2, coastTexture);
+		glBindTexture(GL_TEXTURE_2D, coastTexture[0]);
+		glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_CLAMP);
+		glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_CLAMP);
+		glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
+		glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR_MIPMAP_LINEAR);
+		glTexImage2D(GL_TEXTURE_2D, 0, GL_RGBA16F_ARB, gs-&gt;mapx, gs-&gt;mapy, 0, GL_RGBA, GL_FLOAT, NULL);
+		glGenerateMipmapEXT(GL_TEXTURE_2D);
+
+		glBindTexture(GL_TEXTURE_2D, coastTexture[1]);
+		glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_CLAMP);
+		glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_CLAMP);
+		glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_NEAREST);
+		glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_NEAREST);
+		glTexImage2D(GL_TEXTURE_2D, 0, GL_RGBA16F_ARB, gs-&gt;mapx, gs-&gt;mapy, 0, GL_RGBA, GL_FLOAT, NULL);
+
+		const string fsSource = LoadShaderSource(&quot;shaders/bumpWaterCoastBlurFS.glsl&quot;);
+		const GLchar* fsSourceStr = fsSource.c_str();
+		blurFP = glCreateShader(GL_FRAGMENT_SHADER);
+		glShaderSource(blurFP, 1, &amp;fsSourceStr, NULL);
+		glCompileShader(blurFP);
+		PrintShaderLog(blurFP, &quot;blurFP&quot;);
+
+		blurShader = glCreateProgram();
+		glAttachShader(blurShader, blurFP);
+		glLinkProgram(blurShader);
+		PrintShaderLog(blurShader, &quot;blurShader&quot;);
+		blurDirLoc = glGetUniformLocation(blurShader, &quot;blurDir&quot;);
+		blurTexLoc = glGetUniformLocation(blurShader, &quot;texture&quot;);
+
+		glGenFramebuffersEXT(1,&amp;coastFBO);
+		glBindFramebufferEXT(GL_FRAMEBUFFER_EXT, coastFBO);
+		glFramebufferTexture2DEXT(GL_FRAMEBUFFER_EXT, GL_COLOR_ATTACHMENT0_EXT, GL_TEXTURE_2D, coastTexture[0], 0);
+		glFramebufferTexture2DEXT(GL_FRAMEBUFFER_EXT, GL_COLOR_ATTACHMENT1_EXT, GL_TEXTURE_2D, coastTexture[1], 0);
+		glBindFramebufferEXT(GL_FRAMEBUFFER_EXT, 0);
+
+		//! initialize
+		UploadCoastline(0, 0, gs-&gt;mapx, gs-&gt;mapy);
+		UpdateCoastmap(0, 0, gs-&gt;mapx, gs-&gt;mapy);
+	}
+
+
 	/** CREATE TEXTURES **/
-	if (refraction&gt;0 || depthCopy) {
-		if(GLEW_ARB_texture_rectangle || GLEW_EXT_texture_rectangle) {
+	if ((refraction&gt;0) || depthCopy) {
+		//! ati's don't have glsl support for texrects
+		if (GLEW_ARB_texture_rectangle &amp;&amp; !GLEW_ATI_envmap_bumpmap) {
 			target = GL_TEXTURE_RECTANGLE_ARB;
 			screenTextureX = gu-&gt;viewSizeX;
 			screenTextureY = gu-&gt;viewSizeY;
@@ -194,23 +289,23 @@
 	}
 
 	if (refraction&gt;0) {
-		// CREATE REFRACTION TEXTURE
+		//! CREATE REFRACTION TEXTURE
 		glGenTextures(1, &amp;refractTexture);
 		glBindTexture(target, refractTexture);
 		glTexParameteri(target,GL_TEXTURE_MAG_FILTER,GL_NEAREST);
 		glTexParameteri(target,GL_TEXTURE_MIN_FILTER,GL_NEAREST);
 		if (GLEW_EXT_texture_edge_clamp) {
-			glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE);
-			glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE);
+			glTexParameteri(target, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE);
+			glTexParameteri(target, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE);
 		} else {
-			glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_CLAMP);
-			glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_CLAMP);
+			glTexParameteri(target, GL_TEXTURE_WRAP_S, GL_CLAMP);
+			glTexParameteri(target, GL_TEXTURE_WRAP_T, GL_CLAMP);
 		}
 		glTexImage2D(target, 0, GL_RGBA8, screenTextureX, screenTextureY, 0, GL_RGBA, GL_UNSIGNED_BYTE, NULL);
 	}
 
 	if (reflection) {
-		// CREATE REFLECTION TEXTURE
+		//! CREATE REFLECTION TEXTURE
 		glGenTextures(1, &amp;reflectTexture);
 		glBindTexture(GL_TEXTURE_2D, reflectTexture);
 		glTexParameteri(GL_TEXTURE_2D,GL_TEXTURE_MAG_FILTER,GL_LINEAR);
@@ -226,12 +321,13 @@
 	}
 
 	if (depthCopy) {
+		//! CREATE DEPTH TEXTURE
 		glGenTextures(1, &amp;depthTexture);
 		glBindTexture(target, depthTexture);
 		glTexParameteri(target,GL_TEXTURE_MAG_FILTER,GL_NEAREST);
 		glTexParameteri(target,GL_TEXTURE_MIN_FILTER,GL_NEAREST);
-		GLuint depthFormat = GL_DEPTH_COMPONENT;
-		switch (gu-&gt;depthBufferBits) {
+		GLuint depthFormat = GL_DEPTH_COMPONENT; 
+		switch (gu-&gt;depthBufferBits) { /// use same depth as screen framebuffer
 			case 16: depthFormat = GL_DEPTH_COMPONENT16; break;
 			case 24: depthFormat = GL_DEPTH_COMPONENT24; break;
 			case 32: depthFormat = GL_DEPTH_COMPONENT32; break;
@@ -239,7 +335,26 @@
 		glTexImage2D(target, 0, depthFormat, screenTextureX, screenTextureY, 0, GL_DEPTH_COMPONENT, GL_FLOAT, NULL);
 	}
 
+	if (dynWaves) {
+		//! SETUP DYNAMIC WAVES
+		tileOffsets = SAFE_NEW unsigned char[mapInfo-&gt;water.numTiles * mapInfo-&gt;water.numTiles];
 
+		normalTexture2 = normalTexture;
+		glBindTexture(GL_TEXTURE_2D, normalTexture2);
+		glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_NEAREST);
+		glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_NEAREST);
+		glTexParameterf(GL_TEXTURE_2D, GL_TEXTURE_MAX_ANISOTROPY_EXT, 0.0);
+
+		glGenTextures(1, &amp;normalTexture);
+		glBindTexture(GL_TEXTURE_2D, normalTexture);
+		glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
+		glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR_MIPMAP_LINEAR);
+		if (anisotropy&gt;0.0f)
+			glTexParameterf(GL_TEXTURE_2D, GL_TEXTURE_MAX_ANISOTROPY_EXT, anisotropy);
+		glTexImage2D(GL_TEXTURE_2D, 0, GL_RGBA8, normalTextureX, normalTextureY, 0, GL_RGBA, GL_UNSIGNED_BYTE, NULL);
+		glGenerateMipmapEXT(GL_TEXTURE_2D);
+	}
+
 	/** CREATE FBOs **/
 	if (GLEW_EXT_framebuffer_object) {
 		GLuint depthRBOFormat = GL_DEPTH_COMPONENT;
@@ -287,52 +402,32 @@
 			}
 		}
 
-	}
+		if (dynWaves) {
+			glGenFramebuffersEXT(1,&amp;dynWavesFBO);
+			glBindFramebufferEXT(GL_FRAMEBUFFER_EXT, dynWavesFBO);
+			glFramebufferTexture2DEXT(GL_FRAMEBUFFER_EXT, GL_COLOR_ATTACHMENT0_EXT, GL_TEXTURE_2D, normalTexture, 0);
+			GLenum status = glCheckFramebufferStatusEXT(GL_FRAMEBUFFER_EXT);
+			glBindFramebufferEXT(GL_FRAMEBUFFER_EXT, 0);
+			if (status != GL_FRAMEBUFFER_COMPLETE_EXT) {
+				PrintFboError(&quot;dynamicWaves&quot;,status);
+				glDeleteFramebuffersEXT(1,  &amp;dynWavesFBO);
+				dynWavesFBO = 0;
+			}else{
+				UpdateDynWaves(true); //! initialize
+			}
+		}
 
-
-	/** LOAD TEXTURES **/
-	foamTexture     = LoadTexture( mapInfo-&gt;water.foamTexture );
-	normalTexture   = LoadTexture( mapInfo-&gt;water.normalTexture , anisotropy );
-
-	// caustic textures
-	const vector&lt;string&gt;&amp; causticNames = mapInfo-&gt;water.causticTextures;
-	if (causticNames.size() &lt;= 0) {
-		throw content_error(&quot;no caustic textures&quot;);
 	}
-	for (int i = 0; i &lt; (int)causticNames.size(); i++) {
-		caustTextures.push_back(LoadTexture(causticNames[i]));
-	}
 
-	if (shorewaves) {
-		waveRandTexture = LoadTexture( &quot;bitmaps/shorewaverand.bmp&quot; );
 
-		const string fsSource = LoadShaderSource(&quot;shaders/bumpWaterCoastBlurFS.glsl&quot;);
-		const GLchar* fsSourceStr = fsSource.c_str();
-		blurFP = glCreateShader(GL_FRAGMENT_SHADER);
-		glShaderSource(blurFP, 1, &amp;fsSourceStr, NULL);
-		glCompileShader(blurFP);
-		PrintShaderLog(blurFP, &quot;blurFP&quot;);
-
-		blurShader = glCreateProgram();
-		glAttachShader(blurShader, blurFP);
-		glLinkProgram(blurShader);
-		PrintShaderLog(blurShader, &quot;blurShader&quot;);
-		blurDirLoc    = glGetUniformLocation(blurShader, &quot;blurDir&quot;);
-		GLuint texLoc = glGetUniformLocation(blurShader, &quot;tex0&quot;);
-		glUniform1i(texLoc, 0);
-
-		glGenFramebuffersEXT(1,&amp;coastFBO);
-		GenerateCoastMap();
-	}
-
-
 	/** DEFINE SOME SHADER RUNTIME CONSTANTS (I don't use Uniforms for that, because the glsl compiler can't optimize those!) **/
 	string definitions;
 	if (reflection)   definitions += &quot;#define use_reflection\n&quot;;
 	if (refraction&gt;0) definitions += &quot;#define use_refraction\n&quot;;
-	if (shorewaves)   definitions += &quot;#define use_shorewaves\n&quot;;
+	if (shoreWaves)   definitions += &quot;#define use_shorewaves\n&quot;;
 	if (depthCopy)    definitions += &quot;#define use_depth\n&quot;;
 	if (blurRefl)     definitions += &quot;#define blur_reflection\n&quot;;
+	if (target==GL_TEXTURE_RECTANGLE_ARB) definitions += &quot;#define use_texrect\n&quot;;
 	GLSLDefineConstf4(definitions, &quot;SurfaceColor&quot;,   mapInfo-&gt;water.surfaceColor*0.4, mapInfo-&gt;water.surfaceAlpha );
 	GLSLDefineConstf4(definitions, &quot;PlaneColor&quot;,     mapInfo-&gt;water.planeColor*0.4, mapInfo-&gt;water.surfaceAlpha );
 	GLSLDefineConstf3(definitions, &quot;DiffuseColor&quot;,   mapInfo-&gt;water.diffuseColor );
@@ -343,7 +438,7 @@
 	GLSLDefineConstf1(definitions, &quot;DiffuseFactor&quot;,  mapInfo-&gt;water.diffuseFactor*15.0f );
 	GLSLDefineConstf3(definitions, &quot;SunDir&quot;,         mapInfo-&gt;light.sunDir );
 	GLSLDefineConstf3(definitions, &quot;MapMid&quot;,         float3(readmap-&gt;width*SQUARE_SIZE*0.5f,0.0f,readmap-&gt;height*SQUARE_SIZE*0.5f) );
-	GLSLDefineConstf2(definitions, &quot;ScreenInverse&quot;,  -1.0f/gu-&gt;viewSizeX, 1.0f/gu-&gt;viewSizeY );
+	GLSLDefineConstf2(definitions, &quot;ScreenInverse&quot;,  1.0f/gu-&gt;viewSizeX, 1.0f/gu-&gt;viewSizeY );
 	GLSLDefineConstf2(definitions, &quot;ViewPos&quot;,        gu-&gt;viewPosX,gu-&gt;viewPosY );
 	GLSLDefineConstf1(definitions, &quot;FresnelMin&quot;,     mapInfo-&gt;water.fresnelMin);
 	GLSLDefineConstf1(definitions, &quot;FresnelMax&quot;,     mapInfo-&gt;water.fresnelMax);
@@ -412,6 +507,7 @@
 	glUseProgram(0);
 }
 
+
 CBumpWater::~CBumpWater()
 {
 	if (reflection)
@@ -433,7 +529,7 @@
 
 	glDeleteTextures(1, &amp;foamTexture);
 	glDeleteTextures(1, &amp;normalTexture);
-	for (int i = 0; i &lt; (int)caustTextures.size(); i++) {
+	for (int i = 0; i &lt; (int)caustTextures.size(); ++i) {
 		glDeleteTextures(1, &amp;caustTextures[i]);
 	}
 
@@ -441,23 +537,124 @@
 	glDeleteShader(waterFP);
 	glDeleteProgram(waterShader);
 
-	if (shorewaves) {
-		glDeleteTextures(1, &amp;coastTexture);
+	if (shoreWaves) {
+		glDeleteTextures(2, coastTexture);
 		glDeleteTextures(1, &amp;waveRandTexture);
 
+		if (pboID)
+			glDeleteBuffers(1, &amp;pboID);
+
 		if (coastFBO)
-			glDeleteFramebuffersEXT(1,  &amp;coastFBO);
+			glDeleteFramebuffersEXT(1, &amp;coastFBO);
 
 		glDeleteShader(blurFP);
 		glDeleteProgram(blurShader);
 	}
+
+	if (dynWaves) {
+		glDeleteTextures(1, &amp;normalTexture2);
+
+		delete[] tileOffsets;
+
+		if (dynWavesFBO)
+			glDeleteFramebuffersEXT(1, &amp;dynWavesFBO);
+	}
 }
 
 
-void CBumpWater::GenerateCoastMap()
+///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
+///  UPDATE
+///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
+
+void CBumpWater::Update()
 {
-	/*GLfloat* normalmap = SAFE_NEW GLfloat[gs-&gt;mapx*gs-&gt;mapy*4];
-	for (int y = 0; y &lt; gs-&gt;mapy; y++) {
+	if (readmap-&gt;currMinHeight &gt; 1.0f || mapInfo-&gt;map.voidWater)
+		return;
+
+	float3 w = wind.GetCurrentWind();
+	texcoord1.x += w.x*0.001f;
+	texcoord1.y += w.z*0.001f;
+
+	if (dynWaves)
+		UpdateDynWaves();
+
+	if (!shoreWaves)
+		return;
+
+	SCOPED_TIMER(&quot;Coastmap&quot;);
+
+	if (coastmapNeedUpload &amp;&amp; ((gs-&gt;frameNum + 1) % 15)==0)
+	{
+		UploadCoastline(coastUploadX1, coastUploadZ1, coastUploadX2, coastUploadZ2);
+
+		coastUpdateX1 = coastUploadX1;
+		coastUpdateX2 = coastUploadX2;
+		coastUpdateZ1 = coastUploadZ1;
+		coastUpdateZ2 = coastUploadZ2;
+		coastmapNeedUpdate = true;
+
+		coastUploadX1 = gs-&gt;mapx+1;
+		coastUploadX2 = -1;
+		coastUploadZ1 = gs-&gt;mapy+1;
+		coastUploadZ2 = -1;
+		coastmapNeedUpload = false;
+
+	}
+
+	if (coastmapNeedUpdate &amp;&amp; ((gs-&gt;frameNum + 14) % 15)==0)
+	{
+		UpdateCoastmap(coastUpdateX1, coastUpdateZ1, coastUpdateX2, coastUpdateZ2);
+		coastmapNeedUpdate = false;
+	}
+}
+
+
+void CBumpWater::UpdateWater(CGame* game)
+{
+	if (readmap-&gt;currMinHeight &gt; 1.0f || mapInfo-&gt;map.voidWater)
+		return;
+
+	if (refraction&gt;1) DrawRefraction(game);
+	if (reflection)   DrawReflection(game);
+}
+
+
+///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
+///  SHOREWAVES/COASTMAP
+///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
+
+void CBumpWater::HeightmapChanged(const int x1, const int y1, const int x2, const int y2)
+{
+	if (!shoreWaves)
+		return;
+
+	if (x1&lt;coastUploadX1) coastUploadX1=x1;
+	if (x2&gt;coastUploadX2) coastUploadX2=x2;
+	if (y1&lt;coastUploadZ1) coastUploadZ1=y1;
+	if (y2&gt;coastUploadZ2) coastUploadZ2=y2;
+
+	coastmapNeedUpload = true;
+}
+
+
+void CBumpWater::UploadCoastline(const int x1, const int y1, const int x2, const int y2)
+{
+	GLfloat* coastmap=NULL;
+	bool usedPBO = false;
+
+	if (pboID) {
+		glBindBuffer(GL_PIXEL_UNPACK_BUFFER, pboID);
+		glBufferData(GL_PIXEL_UNPACK_BUFFER, gs-&gt;mapx*gs-&gt;mapy*4*4, 0, GL_STREAM_DRAW);
+		coastmap = (GLfloat*)glMapBuffer(GL_PIXEL_UNPACK_BUFFER, GL_WRITE_ONLY);
+		usedPBO = true;
+	}
+
+	if(coastmap == NULL) {
+		coastmap = SAFE_NEW GLfloat[gs-&gt;mapx*gs-&gt;mapy*4];
+		usedPBO = false;
+	}
+
+	/*for (int y = 0; y &lt; gs-&gt;mapy; y++) {
 		for (int x = 0; x &lt; gs-&gt;mapx; x++) {
 			float3&amp; normal = readmap-&gt;facenormals[(y*gs-&gt;mapx+x)*2];
 			normalmap[(y*gs-&gt;mapx+x)*4]   = normal.x;
@@ -467,101 +664,251 @@
 		}
 	}*/
 
+	int xmin = max(x1 - 10*2,0);
+	int xmax = min(x2 + 10*2,gs-&gt;mapx);
+	int ymin = max(y1 - 10*2,0);
+	int ymax = min(y2 + 10*2,gs-&gt;mapy);
+	int xsize = xmax - xmin;
+	int ysize = ymax - ymin;
+
 	const float* heightMap = readmap-&gt;GetHeightmap();
-	GLfloat* coastmap = SAFE_NEW GLfloat[gs-&gt;mapx*gs-&gt;mapy*4];
-	for (int y = 0; y &lt; gs-&gt;mapy; y++) {
-		for (int x = 0; x &lt; gs-&gt;mapx; x++) {
-			const float&amp; height = heightMap[(y*(gs-&gt;mapx+1)+x)];
-			coastmap[(y*gs-&gt;mapx+x)*4]   = (height&gt;0.0f)?1:0;
-			coastmap[(y*gs-&gt;mapx+x)*4+1] = (height&gt;0.0f)?1:0;
-			coastmap[(y*gs-&gt;mapx+x)*4+2] = (height&gt;0.0f)?1:0;
-			coastmap[(y*gs-&gt;mapx+x)*4+3] = height;
+	for (int y = ymin; y &lt; ymax; ++y) {
+		int yindex  = y*(gs-&gt;mapx + 1);
+		int yindex2 = (y-ymin)*xsize;
+		for (int x = xmin; x &lt; xmax; ++x) {
+			int index  = yindex + x;
+			int index2 = (yindex2 + (x-xmin)) &lt;&lt; 2;
+			const float&amp; height = heightMap[index];
+			coastmap[index2]   = (height&gt;0.0f)?1:0;
+			coastmap[index2+1] = (height&gt;0.0f)?1:0;
+			coastmap[index2+2] = (height&gt;0.0f)?1:0;
+			coastmap[index2+3] = height;
 		}
 	}
-	
-	glGenTextures(1, &amp;coastTexture);
-	glBindTexture(GL_TEXTURE_2D, coastTexture);
-	glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_CLAMP);
-	glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_CLAMP);
-	glTexParameteri(GL_TEXTURE_2D,GL_TEXTURE_MAG_FILTER,GL_NEAREST);
-	glTexParameteri(GL_TEXTURE_2D,GL_TEXTURE_MIN_FILTER,GL_NEAREST);
-	glTexImage2D(GL_TEXTURE_2D, 0, GL_RGBA16F_ARB, gs-&gt;mapx, gs-&gt;mapy, 0, GL_RGBA, GL_FLOAT, coastmap);
-	glGenerateMipmapEXT(GL_TEXTURE_2D);
-	delete[] coastmap;
 
-	GLuint coast2Texture;
-	glGenTextures(1, &amp;coast2Texture);
-	glBindTexture(GL_TEXTURE_2D, coast2Texture);
-	glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_CLAMP);
-	glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_CLAMP);
-	glTexParameteri(GL_TEXTURE_2D,GL_TEXTURE_MAG_FILTER,GL_NEAREST);
-	glTexParameteri(GL_TEXTURE_2D,GL_TEXTURE_MIN_FILTER,GL_NEAREST);
-	glTexImage2D(GL_TEXTURE_2D, 0, GL_RGBA16F_ARB, gs-&gt;mapx, gs-&gt;mapy, 0, GL_RGBA, GL_FLOAT, NULL);
 
+	if (usedPBO) {
+		glUnmapBuffer(GL_PIXEL_UNPACK_BUFFER);
+		glBindTexture(GL_TEXTURE_2D, coastTexture[1]);
+		glTexSubImage2D(GL_TEXTURE_2D, 0, xmin, ymin, xsize,ysize, GL_RGBA, GL_FLOAT, 0);
+		glBufferData(GL_PIXEL_UNPACK_BUFFER, 0, 0, GL_STREAM_DRAW); //free it
+		glBindBuffer(GL_PIXEL_UNPACK_BUFFER, 0);
+	}else{
+		glBindTexture(GL_TEXTURE_2D, coastTexture[1]);
+		glTexSubImage2D(GL_TEXTURE_2D, 0, xmin, ymin, xsize,ysize, GL_RGBA, GL_FLOAT, coastmap);
+		delete[] coastmap;
+	}
+}
+
+
+void CBumpWater::UpdateCoastmap(const int x1, const int y1, const int x2, const int y2)
+{
 	glBindFramebufferEXT(GL_FRAMEBUFFER_EXT, coastFBO);
-	glFramebufferTexture2DEXT(GL_FRAMEBUFFER_EXT, GL_COLOR_ATTACHMENT0_EXT, GL_TEXTURE_2D, coast2Texture, 0);
 	GLenum status = glCheckFramebufferStatusEXT(GL_FRAMEBUFFER_EXT);
-		
 	if (status == GL_FRAMEBUFFER_COMPLETE_EXT) {
-		glActiveTexture(GL_TEXTURE0);
 		glDisable(GL_DEPTH_TEST);
 		glDepthMask(GL_FALSE);
 		glDisable(GL_BLEND);
 
+		glActiveTexture(GL_TEXTURE1); glBindTexture(GL_TEXTURE_2D, coastTexture[1]);
+		glActiveTexture(GL_TEXTURE0); glBindTexture(GL_TEXTURE_2D, coastTexture[0]);
+		glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_NEAREST);
+		glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_NEAREST);
+		glMatrixMode(GL_TEXTURE);
+			glPushMatrix();
+			glLoadIdentity();
+			glScalef(1.0f/gs-&gt;mapx, 1.0f/gs-&gt;mapy, 1);
 		glMatrixMode(GL_PROJECTION);
-		glLoadIdentity();
-		glOrtho(0,1,0,1,-1,1);
+			glPushMatrix();
+			glLoadIdentity();
+			glOrtho(0,1,0,1,-1,1);
 		glMatrixMode(GL_MODELVIEW);
-		glLoadIdentity();
+			glPushMatrix();
+			glLoadIdentity();
+			glScalef(1.0f/gs-&gt;mapx, 1.0f/gs-&gt;mapy, 1);
 
 		glViewport(0,0,gs-&gt;mapx, gs-&gt;mapy);
 		glUseProgram(blurShader);
 
-		for (int i=0; i&lt;10; ++i){
-			glUniform2f(blurDirLoc,1.0f/gs-&gt;mapx,0.0f);
-			glFramebufferTexture2DEXT(GL_FRAMEBUFFER_EXT, GL_COLOR_ATTACHMENT0_EXT, GL_TEXTURE_2D, coast2Texture, 0);
+		int xmin = max(x1 - 10*2,0);
+		int xmax = min(x2 + 10*2,gs-&gt;mapx);
+		int ymin = max(y1 - 10*2,0);
+		int ymax = min(y2 + 10*2,gs-&gt;mapy);
+		int xsize = xmax - xmin;
+		int ysize = ymax - ymin;
 
-			glBindTexture(GL_TEXTURE_2D, coastTexture);
+		glUniform2f(blurDirLoc,1.0f/gs-&gt;mapx,0.0f);
+		glDrawBuffer(GL_COLOR_ATTACHMENT0_EXT);
+		glUniform1i(blurTexLoc,1);
+
+		glBegin(GL_QUADS);
+			glTexCoord2f(xmin,ymin); glVertex2f(xmin,ymin);
+			glTexCoord2f(xmin,ymax); glVertex2f(xmin,ymax);
+			glTexCoord2f(xmax,ymax); glVertex2f(xmax,ymax);
+			glTexCoord2f(xmax,ymin); glVertex2f(xmax,ymin);
+		glEnd();
+
+		for (int i=0; i&lt;5; ++i){
+			glUniform2f(blurDirLoc,0.0f,1.0f/gs-&gt;mapy);
+			glDrawBuffer(GL_COLOR_ATTACHMENT1_EXT);
+			glUniform1i(blurTexLoc,0);
+
 			glBegin(GL_QUADS);
-			glTexCoord2f(0,0); glVertex2f(0,0);
-			glTexCoord2f(0,1); glVertex2f(0,1);
-			glTexCoord2f(1,1); glVertex2f(1,1);
-			glTexCoord2f(1,0); glVertex2f(1,0);
+				glTexCoord2f(xmin,ymin); glVertex2f(xmin,ymin);
+				glTexCoord2f(xmin,ymax); glVertex2f(xmin,ymax);
+				glTexCoord2f(xmax,ymax); glVertex2f(xmax,ymax);
+				glTexCoord2f(xmax,ymin); glVertex2f(xmax,ymin);
 			glEnd();
 
-			glUniform2f(blurDirLoc,0.0f,1.0f/gs-&gt;mapy);
-			glFramebufferTexture2DEXT(GL_FRAMEBUFFER_EXT, GL_COLOR_ATTACHMENT0_EXT, GL_TEXTURE_2D, coastTexture, 0);
+			glUniform2f(blurDirLoc,1.0f/gs-&gt;mapx,0.0f);
+			glDrawBuffer(GL_COLOR_ATTACHMENT0_EXT);
+			glUniform1i(blurTexLoc,1);
 
-			glBindTexture(GL_TEXTURE_2D, coast2Texture);
 			glBegin(GL_QUADS);
-			glTexCoord2f(0,0); glVertex2f(0,0);
-			glTexCoord2f(0,1); glVertex2f(0,1);
-			glTexCoord2f(1,1); glVertex2f(1,1);
-			glTexCoord2f(1,0); glVertex2f(1,0);
+				glTexCoord2f(xmin,ymin); glVertex2f(xmin,ymin);
+				glTexCoord2f(xmin,ymax); glVertex2f(xmin,ymax);
+				glTexCoord2f(xmax,ymax); glVertex2f(xmax,ymax);
+				glTexCoord2f(xmax,ymin); glVertex2f(xmax,ymin);
 			glEnd();
 		}
 
+		glMatrixMode(GL_TEXTURE);
+			glPopMatrix();
+		glMatrixMode(GL_PROJECTION);
+			glPopMatrix();
+		glMatrixMode(GL_MODELVIEW);
+			glPopMatrix();
+
+		//glActiveTexture(GL_TEXTURE0);
+		//glBindTexture(GL_TEXTURE_2D, coastTexture[0]);
+		glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
+		glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR_MIPMAP_LINEAR);
+		glGenerateMipmapEXT(GL_TEXTURE_2D);
+
 		glUseProgram(0);
 		glViewport(gu-&gt;viewPosX,0,gu-&gt;viewSizeX,gu-&gt;viewSizeY);
 	}else PrintFboError(&quot;coast&quot;,status);
 
 	glBindFramebufferEXT(GL_FRAMEBUFFER_EXT, 0);
-	glDeleteTextures(1, &amp;coast2Texture);
+}
 
-	glBindTexture(GL_TEXTURE_2D, coastTexture);
-	glTexParameteri(GL_TEXTURE_2D,GL_TEXTURE_MAG_FILTER,GL_LINEAR);
-	glTexParameteri(GL_TEXTURE_2D,GL_TEXTURE_MIN_FILTER,GL_LINEAR_MIPMAP_LINEAR);
+
+///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
+///  DYNAMIC WAVES
+///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
+
+void CBumpWater::UpdateDynWaves(const bool initialize)
+{
+	if (!dynWaves || !dynWavesFBO)
+		return;
+
+	static const unsigned char tiles  = mapInfo-&gt;water.numTiles; //! (numTiles &lt;= 16)
+	static const unsigned char ntiles = mapInfo-&gt;water.numTiles * mapInfo-&gt;water.numTiles;
+	static const float tilesize = 1.0f/mapInfo-&gt;water.numTiles;
+
+	const int f = (gs-&gt;frameNum+1) % 60;
+
+	if ( f == 0) {
+		for (unsigned char i=0; i&lt;ntiles; ++i) {
+			do {
+				tileOffsets[i] = (unsigned char)(gu-&gt;usRandFloat()*ntiles);
+			} while(tileOffsets[i] == i);
+		}
+	}
+
+	glBindFramebufferEXT(GL_FRAMEBUFFER_EXT, dynWavesFBO);
+	glBindTexture(GL_TEXTURE_2D, normalTexture2);
+	glBlendFunc(GL_CONSTANT_ALPHA, GL_ONE_MINUS_CONSTANT_ALPHA);
+	glBlendColor(1.0f,1.0f,1.0f, (initialize) ? 1.0f : (f + 1)/600.0f );
+	glColor4f(1.0f,1.0f,1.0f,1.0f);
+
+	glViewport(0,0, normalTextureX, normalTextureY);
+	glMatrixMode(GL_MODELVIEW);
+		glPushMatrix();
+		glLoadIdentity();
+	glMatrixMode(GL_PROJECTION);
+		glPushMatrix();
+		glLoadIdentity();
+		glOrtho(0,1,0,1,-1,1);
+	glMatrixMode(GL_TEXTURE);
+		glPushMatrix();
+		glLoadIdentity();
+
+	glBegin(GL_QUADS);
+		unsigned char offset,tx,ty;
+		for (unsigned char y=0; y&lt;tiles; ++y) {
+			for (unsigned char x=0; x&lt;tiles; ++x) {
+				offset = tileOffsets[y * tiles + x];
+				tx = offset % tiles;
+				ty = (offset - tx)/tiles;
+				glTexCoord2f(     tx * tilesize,     ty * tilesize ); glVertex2f(     x * tilesize,     y * tilesize );
+				glTexCoord2f(     tx * tilesize, (ty+1) * tilesize ); glVertex2f(     x * tilesize, (y+1) * tilesize );
+				glTexCoord2f( (tx+1) * tilesize, (ty+1) * tilesize ); glVertex2f( (x+1) * tilesize, (y+1) * tilesize );
+				glTexCoord2f( (tx+1) * tilesize,     ty * tilesize ); glVertex2f( (x+1) * tilesize,     y * tilesize );
+			}
+		}
+	glEnd();
+
+	glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
+
+		glPopMatrix();
+	glMatrixMode(GL_PROJECTION);
+		glPopMatrix();
+	glMatrixMode(GL_MODELVIEW);
+		glPopMatrix();
+	glViewport(gu-&gt;viewPosX,0,gu-&gt;viewSizeX,gu-&gt;viewSizeY);
+
+	glBindFramebufferEXT(GL_FRAMEBUFFER_EXT, 0);
+
+	glBindTexture(GL_TEXTURE_2D, normalTexture);
 	glGenerateMipmapEXT(GL_TEXTURE_2D);
 }
 
 
+///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
+///  DRAW FUNCTIONS
+///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
+
+static void DrawRadialDisc()
+{
+	//! SAME ALGORITHM AS FOR WATERPLANE IN BFGroundDrawer.cpp!
+	const float xsize = (gs-&gt;mapx * SQUARE_SIZE) &gt;&gt; 2;
+	const float ysize = (gs-&gt;mapy * SQUARE_SIZE) &gt;&gt; 2;
+
+	CVertexArray *va = GetVertexArray();
+	va-&gt;Initialize();
+
+	const float alphainc = fastmath::PI2 / 32;
+	float alpha,r1,r2;
+	float3 p(0.0f,0.0f,0.0f);
+	const float size = std::min(xsize,ysize);
+	for (int n = 0; n &lt; 4 ; ++n) {
+		r1 = n*n * size;
+		if (n==3) {
+			r2 = (n+0.5)*(n+0.5) * size;
+		}else{
+			r2 = (n+1)*(n+1) * size;
+		}
+		for (alpha = 0.0f; (alpha - fastmath::PI2) &lt; alphainc ; alpha+=alphainc) {
+			p.x = r1 * fastmath::sin(alpha) + 2 * xsize;
+			p.z = r1 * fastmath::cos(alpha) + 2 * ysize;
+			va-&gt;AddVertex0(p);
+			p.x = r2 * fastmath::sin(alpha) + 2 * xsize;
+			p.z = r2 * fastmath::cos(alpha) + 2 * ysize;
+			va-&gt;AddVertex0(p);
+		}
+	}
+
+	va-&gt;DrawArray0(GL_TRIANGLE_STRIP);
+}
+
 void CBumpWater::Draw()
 {
-	if(readmap-&gt;minheight&gt;1)
+	if (readmap-&gt;currMinHeight &gt; 1.0f)
 		return;
 
 	if (refraction == 1) {
-		// _SCREENCOPY_ REFRACT TEXTURE
+		//! _SCREENCOPY_ REFRACT TEXTURE
 		glBindTexture(target, refractTexture);
 		glEnable(target);
 		glCopyTexSubImage2D(target, 0, 0, 0, gu-&gt;viewPosX, 0, gu-&gt;viewSizeX, gu-&gt;viewSizeY);
@@ -569,7 +916,7 @@
 	}
 
 	if (depthCopy) {
-		// _SCREENCOPY_ DEPTH TEXTURE
+		//! _SCREENCOPY_ DEPTH TEXTURE
 		glBindTexture(target, depthTexture);
 		glEnable(target);
 		glCopyTexSubImage2D(target, 0, 0, 0, gu-&gt;viewPosX, 0, gu-&gt;viewSizeX, gu-&gt;viewSizeY);
@@ -588,7 +935,7 @@
 	glActiveTexture(GL_TEXTURE3); glBindTexture(GL_TEXTURE_2D, foamTexture);
 	glActiveTexture(GL_TEXTURE4); glBindTexture(GL_TEXTURE_2D, reflectTexture);
 	glActiveTexture(GL_TEXTURE5); glBindTexture(target,        refractTexture);
-	glActiveTexture(GL_TEXTURE6); glBindTexture(GL_TEXTURE_2D, coastTexture);
+	glActiveTexture(GL_TEXTURE6); glBindTexture(GL_TEXTURE_2D, coastTexture[0]);
 	glActiveTexture(GL_TEXTURE7); glBindTexture(target,        depthTexture);
 	glActiveTexture(GL_TEXTURE8); glBindTexture(GL_TEXTURE_2D, waveRandTexture);
 	glActiveTexture(GL_TEXTURE0); glBindTexture(GL_TEXTURE_2D, normalTexture);
@@ -597,17 +944,33 @@
 	glUniform1f(frameLoc, gs-&gt;frameNum / 15000.0f);
 	glUniformf3(eyePosLoc, camera-&gt;pos);
 
-	glBegin(GL_QUADS);
-		glTexCoord4f(0.0f,0.0f,0.0f,0.0f);
-			glVertex3i(0,0,0);
-		glTexCoord4f(0.0f,1.0f,0.0f,(float)gs-&gt;mapy/gs-&gt;pwr2mapy);
-			glVertex3i(0,0,readmap-&gt;height*SQUARE_SIZE);
-		glTexCoord4f(1.0f,1.0f,(float)gs-&gt;mapx/gs-&gt;pwr2mapx,(float)gs-&gt;mapy/gs-&gt;pwr2mapy);
-			glVertex3i(readmap-&gt;width*SQUARE_SIZE,0,readmap-&gt;height*SQUARE_SIZE);
-		glTexCoord4f(1.0f,0.0f,(float)gs-&gt;mapx/gs-&gt;pwr2mapx,0.0f);
-			glVertex3i(readmap-&gt;width*SQUARE_SIZE,0,0);
-	glEnd();
 
+	const int mapX = readmap-&gt;width *SQUARE_SIZE;
+	const int mapZ = readmap-&gt;height*SQUARE_SIZE;
+	const float shadingX = (float)gs-&gt;mapx/gs-&gt;pwr2mapx;
+	const float shadingZ = (float)gs-&gt;mapy/gs-&gt;pwr2mapy;
+
+	const GLfloat planeS[4] = {1.0f/mapX,0,0,0};
+	const GLfloat planeT[4] = {0,0,1.0f/mapZ,0};
+	const GLfloat planeR[4] = {shadingX/mapX,0,0,0};
+	const GLfloat planeQ[4] = {0,0,shadingZ/mapZ,0};
+	glTexGenfv(GL_S,GL_OBJECT_PLANE,planeS);
+	glTexGenfv(GL_T,GL_OBJECT_PLANE,planeT);
+	glTexGenfv(GL_R,GL_OBJECT_PLANE,planeR);
+	glTexGenfv(GL_Q,GL_OBJECT_PLANE,planeQ);
+
+	
+	if (endlessOcean) {
+		DrawRadialDisc();
+	}else{
+		glBegin(GL_QUADS);
+		glVertex3i(   0, 0, 0);
+		glVertex3i(   0, 0, mapZ);
+		glVertex3i(mapX, 0, mapZ);
+		glVertex3i(mapX, 0, 0);
+		glEnd();
+	}
+
 	glUseProgram(0);
 
 	if (refraction&lt;2)
@@ -616,38 +979,10 @@
 		glEnable(GL_BLEND);
 }
 
-void CBumpWater::Update()
-{
-	if (readmap-&gt;minheight&gt;1 || mapInfo-&gt;map.voidWater)
-		return;
 
-	float3 w = wind.GetCurrentWind();
-	texcoord1.x += w.x*0.001f;
-	texcoord1.y += w.z*0.001f;
-/*
-	texcoord1.x += (gu-&gt;usRandFloat()-0.5f)*0.0002f;
-	texcoord2.x += (gu-&gt;usRandFloat()-0.5f)*0.0002f;
-	texcoord3.x += (gu-&gt;usRandFloat()-0.5f)*0.0002f;
-	texcoord4.x += (gu-&gt;usRandFloat()-0.5f)*0.0002f;
-	texcoord1.y += (gu-&gt;usRandFloat()-0.5f)*0.0002f;
-	texcoord2.y += (gu-&gt;usRandFloat()-0.5f)*0.0002f;
-	texcoord3.y += (gu-&gt;usRandFloat()-0.5f)*0.0002f;
-	texcoord4.y += (gu-&gt;usRandFloat()-0.5f)*0.0002f;
-*/
-}
-
-void CBumpWater::UpdateWater(CGame* game)
-{
-	if (readmap-&gt;minheight&gt;1 || mapInfo-&gt;map.voidWater)
-		return;
-
-	if (refraction&gt;1) DrawRefraction(game);
-	if (reflection)   DrawReflection(game);
-}
-
 void CBumpWater::DrawRefraction(CGame* game)
 {
-	// _RENDER_ REFRACTION TEXTURE
+	//! _RENDER_ REFRACTION TEXTURE
 	if (refractFBO)
 		glBindFramebufferEXT(GL_FRAMEBUFFER_EXT, refractFBO);
 
@@ -667,13 +1002,13 @@
 	drawRefraction=true;
 
 	glEnable(GL_CLIP_PLANE2);
-	static double plane[4]={0,-1,0,5};
+	const double plane[4]={0,-1,0,5};
 	glClipPlane(GL_CLIP_PLANE2 ,plane);
 
 	readmap-&gt;GetGroundDrawer()-&gt;Draw();
 	unitDrawer-&gt;Draw(false,true);
 	featureHandler-&gt;Draw();
-	drawReflection=false;
+	unitDrawer-&gt;DrawCloakedUnits();
 	ph-&gt;Draw(false,true);
 	eventHandler.DrawWorldRefraction();
 
@@ -697,9 +1032,10 @@
 	unitDrawer-&gt;unitAmbientColor=oldambient;
 }
 
+
 void CBumpWater::DrawReflection(CGame* game)
 {
-	// CREATE REFLECTION TEXTURE
+	//! CREATE REFLECTION TEXTURE
 	if (reflectFBO)
 		glBindFramebufferEXT(GL_FRAMEBUFFER_EXT, reflectFBO);
 
@@ -719,7 +1055,7 @@
 	sky-&gt;Draw();
 
 	glEnable(GL_CLIP_PLANE2);
-	static double plane[4]={0,1,0,1};
+	const double plane[4]={0,1,0,1};
 	glClipPlane(GL_CLIP_PLANE2 ,plane);
 	drawReflection=true;
 

Modified: branches/0.77-branch/rts/Rendering/Env/BumpWater.h
===================================================================
--- branches/0.77-branch/rts/Rendering/Env/BumpWater.h	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Rendering/Env/BumpWater.h	2008-08-20 14:38:09 UTC (rev 6278)
@@ -13,63 +13,77 @@
 public:
 	void Update();
 	void UpdateWater(CGame* game);
+	void HeightmapChanged(const int x1, const int y1, const int x2, const int y2);
 	void DrawReflection(CGame* game);
 	void DrawRefraction(CGame* game);
 	void Draw();
 	CBumpWater();
-	virtual ~CBumpWater();
-	virtual int GetID() const { return 4; }
+	~CBumpWater();
+	int GetID() const { return 4; }
 
 private:
-	void GenerateCoastMap();
-	
-	// user options
+	void UploadCoastline(const int x1, const int y1, const int x2, const int y2);
+	void UpdateCoastmap(const int x1, const int y1, const int x2, const int y2);
+	void UpdateDynWaves(const bool initialize = false);
+
+	//! user options
 	bool  reflection;
-	char  refraction; // 0:=off, 1:=screencopy, 2:=own rendering cycle
+	char  refraction;   //! 0:=off, 1:=screencopy, 2:=own rendering cycle
 	int   reflTexSize;
-	bool  shorewaves;
-	bool  depthCopy;  // uses a screen depth copy, which allows a nicer interpolation between deep sea and shallow water
+	bool  depthCopy;    //! uses a screen depth copy, which allows a nicer interpolation between deep sea and shallow water
 	float anisotropy;
-	char  depthBits;  // depthBits for reflection/refraction RBO
+	char  depthBits;    //! depthBits for reflection/refraction RBO
 	bool  blurRefl;
+	bool  shoreWaves;
+	bool  endlessOcean; //! render the water around the whole map
+	bool  dynWaves;     //! only usable if bumpmap/normal texture is a TileSet
 
-	
-	unsigned int target; // for screen copies (color/depth)
+	unsigned char* tileOffsets; //! used to randomize the wave/bumpmap/normal texture
+	int  normalTextureX; //! needed for dynamic waves
+	int  normalTextureY;
+
+	unsigned int target; //! for screen copies (color/depth), can be GL_TEXTURE_RECTANGLE (nvidia) or GL_TEXTURE_2D (others)
 	int  screenTextureX;
 	int  screenTextureY;
-	
-	GLuint refractTexture;
-	GLuint reflectTexture;
+
 	GLuint reflectRBO;
 	GLuint refractRBO;
 	GLuint reflectFBO;
 	GLuint refractFBO;
 	GLuint coastFBO;
-	
-	GLuint  waveRandTexture;
-	GLuint  foamTexture;
-	GLuint  normalTexture;
-	GLuint  coastTexture;
-	GLuint  depthTexture; // screen depth copy
-	GLuint* heightTexture;
+	GLuint dynWavesFBO;
+
+	//! coastmap
+	bool coastmapNeedUpload;
+	bool coastmapNeedUpdate;
+	int  coastUploadX1,coastUploadX2,coastUploadZ1,coastUploadZ2;
+	int  coastUpdateX1,coastUpdateX2,coastUpdateZ1,coastUpdateZ2;
+	GLuint pboID;
+
+	GLuint refractTexture;
+	GLuint reflectTexture;
+	GLuint depthTexture;   //! screen depth copy
+	GLuint waveRandTexture;
+	GLuint foamTexture;
+	GLuint normalTexture;  //! final used
+	GLuint normalTexture2; //! updates normalTexture with dynamic waves turned on
+	GLuint coastTexture[2];
 	std::vector&lt;GLuint&gt; caustTextures;
 
 	GLuint waterFP;
 	GLuint waterVP;
 	GLuint waterShader;
-	
+
 	GLuint blurFP;
 	GLuint blurShader;
 	GLuint blurDirLoc;
+	GLuint blurTexLoc;
 
 	GLuint frameLoc;
 	GLuint midPosLoc;
 	GLuint eyePosLoc;
 
 	float3 texcoord1;
-	float3 texcoord2;
-	float3 texcoord3;
-	float3 texcoord4;
 };
 
 #endif // __BUMP_WATER_H__

Modified: branches/0.77-branch/rts/Rendering/Env/DynWater.cpp
===================================================================
--- branches/0.77-branch/rts/Rendering/Env/DynWater.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Rendering/Env/DynWater.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -264,7 +264,7 @@
 
 void CDynWater::Draw()
 {
-	if(readmap-&gt;minheight&gt;10)
+	if (readmap-&gt;currMinHeight &gt; 1.0f)
 		return;
 
 	glDisable(GL_BLEND);
@@ -354,7 +354,7 @@
 
 void CDynWater::UpdateWater(CGame* game)
 {
-	if (readmap-&gt;minheight &gt; 10 || mapInfo-&gt;map.voidWater)
+	if (readmap-&gt;currMinHeight &gt; 1.0f || mapInfo-&gt;map.voidWater)
 		return;
 
 	glDisable(GL_DEPTH_TEST);
@@ -377,7 +377,7 @@
 
 void CDynWater::Update()
 {
-	if(readmap-&gt;minheight&gt;10)
+	if (readmap-&gt;currMinHeight &gt; 1.0f)
 		return;
 
 	oldCamPosBig=camPosBig;

Modified: branches/0.77-branch/rts/Rendering/Env/RefractWater.cpp
===================================================================
--- branches/0.77-branch/rts/Rendering/Env/RefractWater.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Rendering/Env/RefractWater.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -40,7 +40,7 @@
 
 void CRefractWater::Draw()
 {
-	if(readmap-&gt;minheight&gt;10)
+	if (readmap-&gt;currMinHeight &gt; 1.0f)
 		return;
 
 	glActiveTextureARB(GL_TEXTURE2_ARB);
@@ -67,6 +67,8 @@
 
 	glActiveTextureARB(GL_TEXTURE3_ARB);
 	glDisable(GL_TEXTURE_2D);
+	glDisable(GL_TEXTURE_GEN_S);
+	glDisable(GL_TEXTURE_GEN_T);
 
 	glActiveTextureARB(GL_TEXTURE2_ARB);
 	glDisable(target);

Modified: branches/0.77-branch/rts/Rendering/GL/VertexArray.h
===================================================================
--- branches/0.77-branch/rts/Rendering/GL/VertexArray.h	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Rendering/GL/VertexArray.h	2008-08-20 14:38:09 UTC (rev 6278)
@@ -23,18 +23,17 @@
 	void DrawArray0(int drawType,int stride=12);
 	inline void AddVertexC(const float3&amp; pos,unsigned char* color);
 	void DrawArrayC(int drawType,int stride=16);
-	void EnlargeStripArray();
-	void EnlargeDrawArray();
-	void EndStrip();
-	bool IsReady();
-  inline void CheckEnlargeDrawArray();
-	void CheckEndStrip();
-  void DrawArrays(int drawType, int stride);
-  void EnlargeArrays(int vertexes, int strips, int stripsize=3);
-	void EndStripQ();
+
+	//! same as AddVertex0, but without autmated CheckEnlargeDrawArray
 	inline void AddVertexQ0(float x, float y, float z);
 
+	//! same as EndStrip, but without autmated EnlargeStripArray
+	void EndStripQ();
+
+	bool IsReady();
 	int drawIndex();
+	void EndStrip();
+	void EnlargeArrays(int vertexes, int strips, int stripsize=3);
 
 	float* drawArray;
 	float* drawArrayPos;
@@ -43,6 +42,13 @@
 	int* stripArray;
 	int* stripArrayPos;
 	int* stripArraySize;
+
+protected:
+	void DrawArrays(int drawType, int stride);
+	inline void CheckEnlargeDrawArray();
+	void EnlargeStripArray();
+	void EnlargeDrawArray();
+	void CheckEndStrip();
 };
 
 inline void CVertexArray::CheckEnlargeDrawArray() {

Modified: branches/0.77-branch/rts/Rendering/GL/myGL.cpp
===================================================================
--- branches/0.77-branch/rts/Rendering/GL/myGL.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Rendering/GL/myGL.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -9,12 +9,14 @@
 #include &quot;Game/GameVersion.h&quot;
 #include &quot;Rendering/Textures/Bitmap.h&quot;
 #include &quot;Platform/errorhandler.h&quot;
+#include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;FPUCheck.h&quot;
 #include &lt;SDL.h&gt;
 #include &quot;mmgr.h&quot;
 #include &quot;System/GlobalStuff.h&quot;
 
+
 #include &quot;IFramebuffer.h&quot;
 
 using namespace std;
@@ -132,17 +134,17 @@
 			case 3:
 			case GL_RGB8 :
 			case GL_RGB :   internalFormat = GL_COMPRESSED_RGB_ARB; break;
-			
+
 			case 4:
 			case GL_RGBA8 :
 			case GL_RGBA : internalFormat = GL_COMPRESSED_RGBA_ARB; break;
-			
+
 			case GL_LUMINANCE: internalFormat = GL_COMPRESSED_LUMINANCE_ARB; break;
 		}
 	}
-	
+
 	// create mipmapped texture
-	if (glGenerateMipmapEXT) {
+	if (configHandler.GetInt(&quot;AtiHacks&quot;, 0) == 0 &amp;&amp; glGenerateMipmapEXT) {
 		// newest method
 		glTexImage2D(target, 0, internalFormat, width, height, 0, format, type, data);
 		glGenerateMipmapEXT(target);
@@ -188,7 +190,7 @@
 
 void LoadStartPicture(const std::string&amp; sidePref)
 {
-	if (startupTexture) 
+	if (startupTexture)
 		return;
 	const string picDir = &quot;bitmaps/loadpictures/&quot;;
 

Modified: branches/0.77-branch/rts/Rendering/GroundDecalHandler.cpp
===================================================================
--- branches/0.77-branch/rts/Rendering/GroundDecalHandler.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Rendering/GroundDecalHandler.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -194,7 +194,7 @@
 				if (camera-&gt;InView(decal-&gt;pos, decal-&gt;radius) &amp;&amp;
 					(!decal-&gt;owner || (decal-&gt;owner-&gt;losStatus[gu-&gt;myAllyTeam] &amp; (LOS_INLOS | LOS_PREVLOS)) || gu-&gt;spectatingFullView)) {
 					color[3] = int(decal-&gt;alpha * 255);
-					float* heightmap = readmap-&gt;GetHeightmap();
+					const float* heightmap = readmap-&gt;GetHeightmap();
 					float xts = 1.0f / decal-&gt;xsize;
 					float yts = 1.0f / decal-&gt;ysize;
 
@@ -400,7 +400,7 @@
 				int ex = (int) min(float(gs-&gt;hmapx - 1), (pos.x + radius) / 16.0f);
 				int sz = (int) max(0.f,                  (pos.z - radius) / 16.0f);
 				int ez = (int) min(float(gs-&gt;hmapy - 1), (pos.z + radius) / 16.0f);
-				float* heightmap = readmap-&gt;GetHeightmap();
+				const float* heightmap = readmap-&gt;GetHeightmap();
 
 				// create the scar texture-quads
 				for (int x = sx; x &lt;= ex; ++x) {

Modified: branches/0.77-branch/rts/Rendering/InMapDraw.cpp
===================================================================
--- branches/0.77-branch/rts/Rendering/InMapDraw.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Rendering/InMapDraw.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -89,15 +89,29 @@
 			tex[y][x][3] = 0;
 		}
 	}
+
+	#define SMOOTHSTEP(x,y,a) (unsigned char)(x * (1.0f - a) + y * a)
+
 	for (int y = 0; y &lt; 64; y++) {
 		// circular thingy
 		for (int x = 0; x &lt; 64; x++) {
 			float dist = sqrt((float)(x - 32) * (x - 32) + (y - 32) * (y - 32));
-			if (dist &gt; 31.875f) {
+			if (dist &gt; 31.0f) {
 				// do nothing - leave transparent
-			} else if (dist &gt; 24.5f) {
+			} else if (dist &gt; 30.0f) {
+				// interpolate (outline -&gt; nothing)
+				float a = (dist - 30.0f);
+				tex[y][x][3] = SMOOTHSTEP(255,0,a);
+			} else if (dist &gt; 24.0f) {
 				// black outline
 				tex[y][x][3] = 255;
+			} else if (dist &gt; 23.0f) {
+				// interpolate (inner -&gt; outline)
+				float a = (dist - 23.0f);
+				tex[y][x][0] = SMOOTHSTEP(255,0,a);
+				tex[y][x][1] = SMOOTHSTEP(255,0,a);
+				tex[y][x][2] = SMOOTHSTEP(255,0,a);
+				tex[y][x][3] = SMOOTHSTEP(200,255,a);
 			} else {
 				tex[y][x][0] = 255;
 				tex[y][x][1] = 255;
@@ -108,16 +122,29 @@
 	}
 	for (int y = 0; y &lt; 64; y++) {
 		// linear falloff
-		for (int x = 0; x &lt; 64; x++) {
+		for (int x = 64; x &lt; 128; x++) {
 			float dist = abs(y - 32);
-			if (dist &gt; 24.5f) {
+			if (dist &gt; 31.0f) {
+				// do nothing - leave transparent
+			} else if (dist &gt; 30.0f) {
+				// interpolate (outline -&gt; nothing)
+				float a = (dist - 30.0f);
+				tex[y][x][3] = SMOOTHSTEP(255,0,a);
+			} else if (dist &gt; 24.0f) {
 				// black outline
-				tex[y][x + 64][3] = 255;
+				tex[y][x][3] = 255;
+			} else if (dist &gt; 23.0f) {
+				// interpolate (inner -&gt; outline)
+				float a = (dist - 23.0f);
+				tex[y][x][0] = SMOOTHSTEP(255,0,a);
+				tex[y][x][1] = SMOOTHSTEP(255,0,a);
+				tex[y][x][2] = SMOOTHSTEP(255,0,a);
+				tex[y][x][3] = SMOOTHSTEP(200,255,a);
 			} else {
-				tex[y][x + 64][0] = 255;
-				tex[y][x + 64][1] = 255;
-				tex[y][x + 64][2] = 255;
-				tex[y][x + 64][3] = 200;
+				tex[y][x][0] = 255;
+				tex[y][x][1] = 255;
+				tex[y][x][2] = 255;
+				tex[y][x][3] = 200;
 			}
 		}
 	}
@@ -126,6 +153,8 @@
 	glBindTexture(GL_TEXTURE_2D, texture);
 	glTexParameteri(GL_TEXTURE_2D,GL_TEXTURE_MAG_FILTER,GL_LINEAR);
 	glTexParameteri(GL_TEXTURE_2D,GL_TEXTURE_MIN_FILTER,GL_LINEAR_MIPMAP_NEAREST);
+	glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE);
+	glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE);
 	glBuildMipmaps(GL_TEXTURE_2D, GL_RGBA8, 128, 64, GL_RGBA, GL_UNSIGNED_BYTE, tex[0]);
 
 	blippSound=sound-&gt;GetWaveId(&quot;sounds/beep6.wav&quot;);
@@ -253,7 +282,6 @@
 				glColor4ub(pi-&gt;color[0], pi-&gt;color[1], pi-&gt;color[2], 250);
 				font-&gt;glWorldPrint(pi-&gt;label.c_str());
 				glPopMatrix();
-				glBindTexture(GL_TEXTURE_2D, texture);
 			}
 		}
 	}
@@ -266,8 +294,8 @@
 		const bool maySee = (gu-&gt;spectating || (!spec &amp;&amp; allied) || imd-&gt;drawAll);
 
 		if (maySee) {
-			lineva-&gt;AddVertexC(li-&gt;pos - (li-&gt;pos - camera-&gt;pos).Normalize() * 26, li-&gt;color);
-			lineva-&gt;AddVertexC(li-&gt;pos2 - (li-&gt;pos2 - camera-&gt;pos).Normalize() * 26, li-&gt;color);
+			lineva-&gt;AddVertexC(li-&gt;pos - (li-&gt;pos - camera-&gt;pos).ANormalize() * 26, li-&gt;color);
+			lineva-&gt;AddVertexC(li-&gt;pos2 - (li-&gt;pos2 - camera-&gt;pos).ANormalize() * 26, li-&gt;color);
 		}
 	}
 }
@@ -284,10 +312,9 @@
 	CVertexArray* lineva = GetVertexArray();
 	lineva-&gt;Initialize();
 
+	glEnable(GL_TEXTURE_2D);
 	glBlendFunc(GL_SRC_ALPHA,GL_ONE_MINUS_SRC_ALPHA);
-	glEnable(GL_TEXTURE_2D);
 	glEnable(GL_BLEND);
-	glBindTexture(GL_TEXTURE_2D, texture);
 
 	InMapDraw_QuadDrawer drawer;
 	drawer.imd = this;
@@ -302,7 +329,9 @@
 	lineva-&gt;DrawArrayC(GL_LINES);
 	glLineWidth(1);
 	glEnable(GL_TEXTURE_2D);
+	glBindTexture(GL_TEXTURE_2D, texture);
 	va-&gt;DrawArrayTC(GL_QUADS);
+
 	glDepthMask(1);
 }
 
@@ -444,7 +473,7 @@
 		// if we happen to be in drawAll mode, notify us now
 		// even if this message is not intented for our ears
 		logOutput.Print(&quot;%s added point: %s&quot;,
-		                sender-&gt;playerName.c_str(), point.label.c_str());
+		                sender-&gt;name.c_str(), point.label.c_str());
 		logOutput.SetLastMsgPos(pos);
 		sound-&gt;PlaySample(blippSound);
 		minimap-&gt;AddNotification(pos, float3(1.0f, 1.0f, 1.0f), 1.0f);

Modified: branches/0.77-branch/rts/Rendering/UnitModels/3DOParser.cpp
===================================================================
--- branches/0.77-branch/rts/Rendering/UnitModels/3DOParser.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Rendering/UnitModels/3DOParser.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -173,7 +173,7 @@
 	}
 
 //	if(sideName.find(&quot;armstump.3do&quot;)!=std::string.npos){
-//		logOutput.Print(&quot;New type %s %i %s %s&quot;,name.c_str(),team,sideName.c_str(),gs-&gt;players[gs-&gt;Team(team)-&gt;leader]-&gt;playerName.c_str());
+//		logOutput.Print(&quot;New type %s %i %s %s&quot;,name.c_str(),team,sideName.c_str(),gs-&gt;players[gs-&gt;Team(team)-&gt;leader]-&gt;name.c_str());
 //	}
 	PUSH_CODE_MODE;
 	ENTER_SYNCED;

Modified: branches/0.77-branch/rts/Rendering/glFont.cpp
===================================================================
--- branches/0.77-branch/rts/Rendering/glFont.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Rendering/glFont.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -62,7 +62,7 @@
 CFontTextureRenderer::~CFontTextureRenderer()
 {
 	if (buffer)
-		delete buffer;
+		delete [] buffer;
 }
 
 void CFontTextureRenderer::AddGlyph(FT_GlyphSlot slot, int &amp;outX, int &amp;outY)
@@ -118,7 +118,7 @@
 		glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_CLAMP);
 		glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_CLAMP);
 	}
-	glTexImage2D(GL_TEXTURE_2D, 0, GL_LUMINANCE_ALPHA, 
+	glTexImage2D(GL_TEXTURE_2D, 0, GL_LUMINANCE_ALPHA,
 		width, height, 0, GL_LUMINANCE_ALPHA, GL_UNSIGNED_BYTE, buffer);
 	delete [] buffer;
 	buffer = 0;
@@ -153,7 +153,7 @@
 
 	// clamp the char range
 	end = min(254, end);
-	start = max(32, start);	
+	start = max(32, start);
 
 	chars = (end - start) + 1;
 
@@ -161,10 +161,10 @@
 	charstart = start;
 
 	glyphs = SAFE_NEW GlyphInfo[chars];
-	
+
 	const float toX = gu-&gt;pixelX;
 	const float toY = gu-&gt;pixelY;
-		
+
 	float descender = FT_MulFix(face-&gt;descender, face-&gt;size-&gt;metrics.y_scale) / 64.0f;	// max font descender in pixels
 	fontHeight = FT_MulFix(face-&gt;height, face-&gt;size-&gt;metrics.y_scale) / 64.0f * toY;	// distance between baselines in screen units
 
@@ -175,7 +175,7 @@
 
 		// retrieve glyph index from character code
 		FT_UInt glyph_index = FT_Get_Char_Index(face, i);
-		
+
 		error = FT_Load_Glyph(face, glyph_index, FT_LOAD_DEFAULT);
 		if ( error ) {
 			string msg = &quot;FT_Load_Glyph failed:&quot;;
@@ -200,7 +200,7 @@
 			delete [] glyphs;
 			throw;
 		}
-		
+
 		int bitmap_width = slot-&gt;bitmap.width;
 		int bitmap_rows = slot-&gt;bitmap.rows;
 		int bitmap_pitch = slot-&gt;bitmap.pitch;
@@ -222,7 +222,7 @@
 		g-&gt;x1 = (xbearing + bitmap_width) * toX;
 		g-&gt;y1 = g-&gt;y0 - (slot-&gt;metrics.height / 64.0f) * toY;
 	}
-	
+
 	FT_Done_Face(face);
 	FT_Done_FreeType(library);
 
@@ -335,7 +335,7 @@
 
 float CglFont::RenderString(float x, float y, float s, const unsigned char *text) const
 {
-//	glPushAttrib(GL_LIST_BIT | GL_CURRENT_BIT  | GL_ENABLE_BIT | GL_TRANSFORM_BIT);	
+//	glPushAttrib(GL_LIST_BIT | GL_CURRENT_BIT  | GL_ENABLE_BIT | GL_TRANSFORM_BIT);
 	glPushAttrib(GL_ENABLE_BIT | GL_CURRENT_BIT);
 	glDisable(GL_LIGHTING);
 	glEnable(GL_TEXTURE_2D);
@@ -438,7 +438,7 @@
 	glEnd();
 
 	glPopAttrib();
-	
+
 	outline = false;		// outlining is valid only for one drawing operation
 	return x;
 }
@@ -600,7 +600,7 @@
 	const float luminance = (textColor[0] * 0.299f) +
 	                        (textColor[1] * 0.587f) +
 	                        (textColor[2] * 0.114f);
-	                        
+
 	if (luminance &gt; 0.25f) {
 		return darkOutline;
 	} else {

Modified: branches/0.77-branch/rts/Sim/Features/Feature.cpp
===================================================================
--- branches/0.77-branch/rts/Sim/Features/Feature.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Sim/Features/Feature.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -33,7 +33,6 @@
 				CR_MEMBER(resurrectProgress),
 				CR_MEMBER(health),
 				CR_MEMBER(reclaimLeft),
-				CR_MEMBER(id),
 				CR_MEMBER(allyteam),
 				CR_MEMBER(team),
 				CR_MEMBER(noSelect),
@@ -70,7 +69,6 @@
 	isRepairingBeforeResurrect(false),
 	resurrectProgress(0),
 	health(0),
-	id(0),
 	finalHeight(0),
 	reachedFinalPos(false),
 	solidOnTop(0),
@@ -80,7 +78,6 @@
 	physicalState = OnGround;
 }
 
-
 CFeature::~CFeature(void)
 {
 	if (blocking) {
@@ -112,19 +109,19 @@
 		height = model-&gt;height;
 		SetRadius(model-&gt;radius);
 		midPos = pos + model-&gt;relMidPos;
-	}
-	else if (def-&gt;drawType == DRAWTYPE_TREE){
+	} else if (def-&gt;drawType == DRAWTYPE_TREE) {
 		midPos = pos + (UpVector * TREE_RADIUS);
 		height = 2 * TREE_RADIUS;
-	}
-	else {
+	} else {
 		midPos = pos;
 	}
+
 	if (def-&gt;drawType == DRAWTYPE_TREE) {
 		treeDrawer-&gt;AddTree(def-&gt;modelType, pos, 1);
 	}
 }
 
+
 void CFeature::ChangeTeam(int newTeam)
 {
 	if (newTeam &lt; 0) {

Modified: branches/0.77-branch/rts/Sim/Features/Feature.h
===================================================================
--- branches/0.77-branch/rts/Sim/Features/Feature.h	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Sim/Features/Feature.h	2008-08-20 14:38:09 UTC (rev 6278)
@@ -17,6 +17,8 @@
 class CFireProjectile;
 struct CollisionVolume;
 
+
+
 class CFeature: public CSolidObject, public boost::noncopyable
 {
 	CR_DECLARE(CFeature);
@@ -28,6 +30,7 @@
 	/** Pos of quad must not change after this. */
 	void Initialize(const float3&amp; pos, const FeatureDef* def, short int heading, int facing,
 		int allyteam, std::string fromUnit, const float3&amp; speed = ZeroVector);
+	int GetBlockingMapID() const { return id + (10 * /*MAX_UNITS*/ 10000); }
 
 	/** Negative amount = reclaim
 	    @return true if reclaimed */
@@ -62,7 +65,6 @@
 
 	float health;
 	float reclaimLeft;
-	int id;
 	int allyteam;
 	int team;
 

Modified: branches/0.77-branch/rts/Sim/Misc/CollisionHandler.cpp
===================================================================
--- branches/0.77-branch/rts/Sim/Misc/CollisionHandler.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Sim/Misc/CollisionHandler.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -1,3 +1,4 @@
+#include &quot;StdAfx.h&quot;
 #include &quot;System/FastMath.h&quot;
 #include &quot;System/float3.h&quot;
 #include &quot;System/Matrix44f.h&quot;

Modified: branches/0.77-branch/rts/Sim/Misc/GroundBlockingObjectMap.cpp
===================================================================
--- branches/0.77-branch/rts/Sim/Misc/GroundBlockingObjectMap.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Sim/Misc/GroundBlockingObjectMap.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -1,4 +1,6 @@
 #include &quot;StdAfx.h&quot;
+#include &lt;assert.h&gt;
+
 #include &quot;GroundBlockingObjectMap.h&quot;
 #include &quot;Sim/Objects/SolidObject.h&quot;
 #include &quot;Sim/Path/PathManager.h&quot;
@@ -12,13 +14,20 @@
 
 
 
-CGroundBlockingObjectMap::CGroundBlockingObjectMap(int numSquares)
+inline static const int GetObjectID(CSolidObject* obj)
 {
-	groundBlockingMap.resize(numSquares);
+	const int id = obj-&gt;GetBlockingMapID();
+	// object should always be a derived type
+	assert(id != -1);
+	return id;
 }
 
+
+
 void CGroundBlockingObjectMap::AddGroundBlockingObject(CSolidObject* object)
 {
+	const int objID = GetObjectID(object);
+
 	object-&gt;isMarkedOnBlockingMap = true;
 	object-&gt;mapPos = object-&gt;GetMapPos();
 
@@ -27,19 +36,22 @@
 		object-&gt;mapPos.y &amp;= 0xfffffe;
 	}
 
-	int bx = object-&gt;mapPos.x;
-	int bz = object-&gt;mapPos.y;
-	int minXSqr = bx;
-	int minZSqr = bz;
-	int maxXSqr = bx + object-&gt;xsize;
-	int maxZSqr = bz + object-&gt;ysize;
+	const int bx = object-&gt;mapPos.x;
+	const int bz = object-&gt;mapPos.y;
+	const int minXSqr = bx;
+	const int minZSqr = bz;
+	const int maxXSqr = bx + object-&gt;xsize;
+	const int maxZSqr = bz + object-&gt;ysize;
 
 	for (int zSqr = minZSqr; zSqr &lt; maxZSqr; zSqr++) {
 		for (int xSqr = minXSqr; xSqr &lt; maxXSqr; xSqr++) {
 			const int idx = xSqr + zSqr * gs-&gt;mapx;
 			BlockingMapCell&amp; cell = groundBlockingMap[idx];
+			BlockingMapCellIt it = cell.find(objID);
 
-			cell.insert(object);
+			if (it == cell.end()) {
+				cell[objID] = object;
+			}
 		}
 	}
 
@@ -52,6 +64,8 @@
 
 void CGroundBlockingObjectMap::AddGroundBlockingObject(CSolidObject* object, unsigned char* yardMap, unsigned char mask)
 {
+	const int objID = GetObjectID(object);
+
 	object-&gt;isMarkedOnBlockingMap = true;
 	object-&gt;mapPos = object-&gt;GetMapPos();
 
@@ -60,21 +74,22 @@
 		object-&gt;mapPos.y &amp;= 0xfffffe;
 	}
 
-	int bx = object-&gt;mapPos.x;
-	int bz = object-&gt;mapPos.y;
-	int minXSqr = bx;
-	int minZSqr = bz;
-	int maxXSqr = bx + object-&gt;xsize;
-	int maxZSqr = bz + object-&gt;ysize;
+	const int bx = object-&gt;mapPos.x;
+	const int bz = object-&gt;mapPos.y;
+	const int minXSqr = bx;
+	const int minZSqr = bz;
+	const int maxXSqr = bx + object-&gt;xsize;
+	const int maxZSqr = bz + object-&gt;ysize;
 
 	for (int z = 0; minZSqr + z &lt; maxZSqr; z++) {
 		for (int x = 0; minXSqr + x &lt; maxXSqr; x++) {
 			const int idx = minXSqr + x + (minZSqr + z) * gs-&gt;mapx;
 			const int off = x + z * object-&gt;xsize;
 			BlockingMapCell&amp; cell = groundBlockingMap[idx];
+			BlockingMapCellIt it = cell.find(objID);
 
-			if ((yardMap[off] &amp; mask)) {
-				cell.insert(object);
+			if ((it == cell.end()) &amp;&amp; (yardMap[off] &amp; mask)) {
+				cell[objID] = object;
 			}
 		}
 	}
@@ -88,20 +103,22 @@
 
 void CGroundBlockingObjectMap::RemoveGroundBlockingObject(CSolidObject* object)
 {
+	const int objID = GetObjectID(object);
+
 	object-&gt;isMarkedOnBlockingMap = false;
-	int bx = object-&gt;mapPos.x;
-	int bz = object-&gt;mapPos.y;
-	int sx = object-&gt;xsize;
-	int sz = object-&gt;ysize;
+	const int bx = object-&gt;mapPos.x;
+	const int bz = object-&gt;mapPos.y;
+	const int sx = object-&gt;xsize;
+	const int sz = object-&gt;ysize;
 
 	for (int z = bz; z &lt; bz + sz; ++z) {
 		for (int x = bx; x &lt; bx + sx; ++x) {
 			int idx = x + z * gs-&gt;mapx;
 			BlockingMapCell&amp; cell = groundBlockingMap[idx];
-			BlockingMapCellIt it = cell.find(object);
+			BlockingMapCellIt it = cell.find(objID);
 
 			if (it != cell.end()) {
-				cell.erase(it);
+				cell.erase(objID);
 			}
 		}
 	}
@@ -114,70 +131,71 @@
 
 
 /**
-Moves a ground blocking object from old position to the current on map.
-*/
+  * Moves a ground blocking object from old position to the current on map.
+  * No longer used, functionality is handled by CSolidObject::{Un}Block()
+  */
+/*
 void CGroundBlockingObjectMap::MoveGroundBlockingObject(CSolidObject* object, float3 oldPos) {
 	RemoveGroundBlockingObject(object);
 	AddGroundBlockingObject(object);
 }
+*/
 
 
 
 /**
-Checks if a ground-square is blocked.
-If it's not blocked, then NULL is returned.
-If it's blocked, then a pointer to the blocking object is returned.
-*/
+  * Checks if a ground-square is blocked.
+  * If it's not blocked (empty), then NULL is returned. Otherwise, a
+  * pointer to the top-most / bottom-most blocking object is returned.
+  */
 CSolidObject* CGroundBlockingObjectMap::GroundBlockedUnsafe(int mapSquare, bool topMost) {
 	if (groundBlockingMap[mapSquare].empty()) {
 		return 0x0;
 	}
 
-	BlockingMapCellIt it = groundBlockingMap[mapSquare].begin();
-	CSolidObject* p = *it;
-	CSolidObject* q = *it;
+	const BlockingMapCell&amp; cell = groundBlockingMap[mapSquare];
+	BlockingMapCellIt it = cell.begin();
+	CSolidObject* p = it-&gt;second;
+	CSolidObject* q = it-&gt;second;
 	it++;
 
-	// todo: accessors to get the block count, etc
-	for (; it != groundBlockingMap[mapSquare].end(); it++) {
-		if ((*it)-&gt;pos.y &gt; p-&gt;pos.y) { p = *it; }
-		if ((*it)-&gt;pos.y &lt; q-&gt;pos.y) { q = *it; }
+	for (; it != cell.end(); it++) {
+		CSolidObject* obj = it-&gt;second;
+		if (obj-&gt;pos.y &gt; p-&gt;pos.y) { p = obj; }
+		if (obj-&gt;pos.y &lt; q-&gt;pos.y) { q = obj; }
 	}
 
-	// return the top-most blocking object
-	// (rather than objects.begin(), since
-	// we cannot rely on pointer order)
 	return ((topMost)? p: q);
 }
 
 CSolidObject* CGroundBlockingObjectMap::GroundBlocked(int mapSquare, bool topMost) {
 	if (mapSquare &lt; 0 || mapSquare &gt;= gs-&gt;mapSquares) {
-		return NULL;
+		return 0x0;
 	}
 
 	return GroundBlockedUnsafe(mapSquare);
 }
 
 CSolidObject* CGroundBlockingObjectMap::GroundBlocked(float3 pos, bool topMost) {
-	int xSqr = int(pos.x / SQUARE_SIZE) % gs-&gt;mapx;
-	int zSqr = int(pos.z / SQUARE_SIZE) / gs-&gt;mapx;
+	const int xSqr = int(pos.x / SQUARE_SIZE) % gs-&gt;mapx;
+	const int zSqr = int(pos.z / SQUARE_SIZE) / gs-&gt;mapx;
 	return GroundBlocked(xSqr + zSqr * gs-&gt;mapx, topMost);
 }
 
 
 /**
-Opens up a yard in a blocked area.
-When a factory opens up, for example.
-*/
+  * Opens up a yard in a blocked area.
+  * When a factory opens up, for example.
+  */
 void CGroundBlockingObjectMap::OpenBlockingYard(CSolidObject* yard, unsigned char* yardMap) {
 	RemoveGroundBlockingObject(yard);
 	AddGroundBlockingObject(yard, yardMap, 2);
 }
 
 /**
-Closes a yard, blocking the area.
-When a factory closes, for example.
-*/
+  * Closes a yard, blocking the area.
+  * When a factory closes, for example.
+  */
 void CGroundBlockingObjectMap::CloseBlockingYard(CSolidObject* yard, unsigned char* yardMap) {
 	RemoveGroundBlockingObject(yard);
 	AddGroundBlockingObject(yard, yardMap, 1);
@@ -185,11 +203,13 @@
 
 bool CGroundBlockingObjectMap::CanCloseYard(CSolidObject* yard)
 {
+	const int objID = GetObjectID(yard);
+
 	for (int z = yard-&gt;mapPos.y; z &lt; yard-&gt;mapPos.y + yard-&gt;ysize; ++z) {
 		for (int x = yard-&gt;mapPos.x; x &lt; yard-&gt;mapPos.x + yard-&gt;xsize; ++x) {
 			const int idx = z * gs-&gt;mapx + x;
 			BlockingMapCell&amp; cell = groundBlockingMap[idx];
-			BlockingMapCellIt it = cell.find(yard);
+			BlockingMapCellIt it = cell.find(objID);
 
 			if (it != cell.end() &amp;&amp; cell.size() &gt;= 2) {
 				// something else besides us present
@@ -198,5 +218,6 @@
 			}
 		}
 	}
+
 	return true;
 }

Modified: branches/0.77-branch/rts/Sim/Misc/GroundBlockingObjectMap.h
===================================================================
--- branches/0.77-branch/rts/Sim/Misc/GroundBlockingObjectMap.h	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Sim/Misc/GroundBlockingObjectMap.h	2008-08-20 14:38:09 UTC (rev 6278)
@@ -2,11 +2,11 @@
 #define GROUNDBLOCKINGOBJECTMAP_H
 
 #include &quot;creg/creg.h&quot;
-#include &quot;creg/STL_Set.h&quot;
+#include &quot;creg/STL_Map.h&quot;
 #include &quot;float3.h&quot;
 
 class CSolidObject;
-typedef std::set&lt;CSolidObject*&gt; BlockingMapCell;
+typedef std::map&lt;int, CSolidObject*&gt; BlockingMapCell;
 typedef BlockingMapCell::const_iterator BlockingMapCellIt;
 typedef std::vector&lt;BlockingMapCell&gt; BlockingMap;
 
@@ -15,12 +15,12 @@
 	CR_DECLARE(CGroundBlockingObjectMap);
 
 public:
-	CGroundBlockingObjectMap(int numSquares);
+	CGroundBlockingObjectMap(int numSquares) { groundBlockingMap.resize(numSquares); }
 
 	void AddGroundBlockingObject(CSolidObject* object);
 	void AddGroundBlockingObject(CSolidObject* object, unsigned char* yardMap, unsigned char mask = 255);
 	void RemoveGroundBlockingObject(CSolidObject* object);
-	void MoveGroundBlockingObject(CSolidObject* object, float3 oldPos);
+	// void MoveGroundBlockingObject(CSolidObject* object, float3 oldPos);
 
 	void OpenBlockingYard(CSolidObject* yard, unsigned char* yardMap);
 	void CloseBlockingYard(CSolidObject* yard, unsigned char* yardMap);

Modified: branches/0.77-branch/rts/Sim/MoveTypes/GroundMoveType.cpp
===================================================================
--- branches/0.77-branch/rts/Sim/MoveTypes/GroundMoveType.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Sim/MoveTypes/GroundMoveType.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -31,6 +31,7 @@
 #include &quot;System/EventHandler.h&quot;
 #include &quot;System/LogOutput.h&quot;
 #include &quot;System/Sound.h&quot;
+#include &quot;System/FastMath.h&quot;
 #include &quot;myMath.h&quot;
 #include &quot;mmgr.h&quot;
 
@@ -106,13 +107,13 @@
 		));
 
 
-const unsigned int MAX_REPATH_FREQUENCY = 30;		//The minimum of frames between two full path-requests.
+const unsigned int MAX_REPATH_FREQUENCY = 30;		// The minimum of frames between two full path-requests.
 
-const float ETA_ESTIMATION = 1.5f;					//How much time the unit are given to reach the waypoint.
-const float MAX_WAYPOINT_DISTANCE_FACTOR = 2.0f;		//Used to tune how often new waypoints are requested. Multiplied with MinDistanceToWaypoint().
-const float MAX_OFF_PATH_FACTOR = 20;				//How far away from a waypoint a unit could be before a new path is requested.
+const float ETA_ESTIMATION = 1.5f;					// How much time the unit are given to reach the waypoint.
+const float MAX_WAYPOINT_DISTANCE_FACTOR = 2.0f;	// Used to tune how often new waypoints are requested. Multiplied with MinDistanceToWaypoint().
+const float MAX_OFF_PATH_FACTOR = 20;				// How far away from a waypoint a unit could be before a new path is requested.
 
-const float MINIMUM_SPEED = 0.01f;					//Minimum speed a unit may move in.
+const float MINIMUM_SPEED = 0.01f;					// Minimum speed a unit may move in.
 
 static const bool DEBUG_CONTROLLER=false;
 std::vector&lt;int2&gt; (*CGroundMoveType::lineTable)[11] = 0;
@@ -303,13 +304,18 @@
 			}
 
 			if (nextDeltaSpeedUpdate &lt;= gs-&gt;frameNum) {
-				wantedSpeed = pathId? requestedSpeed: 0;
+				wantedSpeed = pathId? requestedSpeed: 0.0f;
+				bool moreCommands = owner-&gt;commandAI-&gt;HasMoreMoveCommands();
+
 				// If arriving at waypoint, then need to slow down, or may pass it.
-				if (!owner-&gt;commandAI-&gt;HasMoreMoveCommands() &amp;&amp;
-					currentDistanceToWaypoint &lt; BreakingDistance(currentSpeed) + SQUARE_SIZE) {
-					wantedSpeed = std::min((float) wantedSpeed, (float) (sqrt(currentDistanceToWaypoint * -owner-&gt;mobility-&gt;maxBreaking)));
+				if (!moreCommands &amp;&amp; currentDistanceToWaypoint &lt; BreakingDistance(currentSpeed) + SQUARE_SIZE) {
+					wantedSpeed = std::min(wantedSpeed, fastmath::sqrt(currentDistanceToWaypoint * -owner-&gt;mobility-&gt;maxBreaking));
 				}
-				wantedSpeed *= std::max(0.0f, std::min(1.0f, desiredVelocity.dot(owner-&gt;frontdir) + 0.1f));
+
+				if (owner-&gt;unitDef-&gt;turnInPlace) {
+					wantedSpeed *= std::max(0.0f, std::min(1.0f, desiredVelocity.dot(owner-&gt;frontdir) + 0.1f));
+				}
+
 				SetDeltaSpeed();
 			}
 		} else {
@@ -382,12 +388,13 @@
 	if (progressState == Active &amp;&amp; etaFailures &gt; 8) {
 		if (owner-&gt;pos.distance2D(goalPos) &gt; 200 || CheckGoalFeasability()) {
 			if (DEBUG_CONTROLLER)
-				logOutput.Print(&quot;Unit eta failure %i&quot;, owner-&gt;id);
+				logOutput.Print(&quot;ETA failure for unit %i&quot;, owner-&gt;id);
+
 			StopEngine();
 			StartEngine();
 		} else {
 			if (DEBUG_CONTROLLER)
-				logOutput.Print(&quot;Goal clogged up %i&quot;, owner-&gt;id);
+				logOutput.Print(&quot;Goal clogged up for unit %i&quot;, owner-&gt;id);
 			Fail();
 		}
 	}
@@ -433,8 +440,6 @@
 			if (owner-&gt;hasRadarCapacity)
 				radarhandler-&gt;MoveUnit(owner);
 
-			// owner-&gt;UnBlock();
-			// owner-&gt;Block();
 		}
 		qf-&gt;MovedUnit(owner);
 
@@ -469,20 +474,19 @@
 		StopEngine();
 	}
 
-	//Sets the new goal.
+	// set the new goal
 	goalPos = moveGoalPos;
 	goalRadius = goalRadius;
-	requestedSpeed = std::min(speed, maxSpeed * 2);
+	requestedSpeed = std::min(speed, maxSpeed * 2.0f);
 	requestedTurnRate = owner-&gt;mobility-&gt;maxTurnRate;
 	atGoal = false;
 	useMainHeading = false;
-
 	progressState = Active;
 
-	//Starts the engine.
 	if (DEBUG_CONTROLLER) {
-		logOutput &lt;&lt; owner-&gt;id &lt;&lt; &quot;: StartMoving() starting engine.\n&quot;;
+		logOutput &lt;&lt; int(owner-&gt;id) &lt;&lt; &quot;: StartMoving() starting engine.\n&quot;;
 	}
+
 	StartEngine();
 
 	ENTER_UNSYNCED;
@@ -504,79 +508,94 @@
 	tracefile &lt;&lt; owner-&gt;pos.x &lt;&lt; &quot; &quot; &lt;&lt; owner-&gt;pos.y &lt;&lt; &quot; &quot; &lt;&lt; owner-&gt;pos.z &lt;&lt; &quot; &quot; &lt;&lt; owner-&gt;id &lt;&lt; &quot;\n&quot;;
 #endif
 	if(DEBUG_CONTROLLER)
-		logOutput &lt;&lt; &quot;SMove: Action stopped.&quot; &lt;&lt; &quot; &quot; &lt;&lt; owner-&gt;id &lt;&lt; &quot;\n&quot;;
+		logOutput &lt;&lt; &quot;SMove: Action stopped.&quot; &lt;&lt; &quot; &quot; &lt;&lt; int(owner-&gt;id) &lt;&lt; &quot;\n&quot;;
 
 	StopEngine();
 
 	useMainHeading = false;
-	if(progressState != Done)
+	if (progressState != Done)
 		progressState = Done;
 }
 
 void CGroundMoveType::SetDeltaSpeed(void)
 {
-	//Rounding of low speed.
-	if(wantedSpeed == 0 &amp;&amp; currentSpeed &lt; 0.01f){
-		currentSpeed=0;
-		deltaSpeed=0;
-//		nextDeltaSpeedUpdate=gs-&gt;frameNum+8;
+	// round low speeds to zero
+	if (wantedSpeed == 0.0f &amp;&amp; currentSpeed &lt; 0.01f) {
+		currentSpeed = 0.0f;
+		deltaSpeed = 0.0f;
 		return;
 	}
 
-	//Wanted speed and acceleration.
+	// wanted speed and acceleration
 	float wSpeed = maxSpeed;
 
-	//Limiting speed and acceleration.
-	if(wantedSpeed &gt; 0) {
-		float groundMod = owner-&gt;unitDef-&gt;movedata-&gt;moveMath-&gt;SpeedMod(*owner-&gt;unitDef-&gt;movedata, owner-&gt;pos,flatFrontDir);
+	// limit speed and acceleration
+	if (wantedSpeed &gt; 0.0f) {
+		float groundMod = owner-&gt;unitDef-&gt;movedata-&gt;moveMath-&gt;SpeedMod(*owner-&gt;unitDef-&gt;movedata, owner-&gt;pos, flatFrontDir);
 		wSpeed *= groundMod;
 
-		float3 goalDif=waypoint-owner-&gt;pos;
-		short turn=owner-&gt;heading-GetHeadingFromVector(goalDif.x,goalDif.z);
-		if(turn!=0){
-			float goalLength=goalDif.Length();
+		float3 goalDif = waypoint - owner-&gt;pos;
+		short turn = owner-&gt;heading - GetHeadingFromVector(goalDif.x, goalDif.z);
 
-			float turnSpeed=(goalLength+8)/(abs(turn)/turnRate)*0.5f;
-			if(turnSpeed&lt;wSpeed)		//make sure we can turn fast enought to get hit the goal
-				wSpeed=turnSpeed;
-	}
-	if(wSpeed&gt;wantedSpeed)
-		wSpeed=wantedSpeed;
+		if (turn != 0) {
+			float goalLength = goalDif.Length();
+			float turnSpeed = (goalLength + 8.0f) / (abs(turn) / turnRate) * 0.5f;
+
+			if (turnSpeed &lt; wSpeed) {
+				// make sure we can turn fast enough to hit the goal
+				// (but don't slow us down to a complete crawl either)
+				//
+				// NOTE: can cause units with large turning circles to
+				// circle around close waypoints indefinitely, but one
+				// GetNextWaypoint() often is sufficient prevention
+				if (owner-&gt;unitDef-&gt;turnInPlace || currentSpeed &lt; 1.5f) {
+					// keep the turn mostly in-place
+					wSpeed = turnSpeed;
+				} else {
+					GetNextWaypoint();
+					wSpeed = (turnSpeed + wSpeed) * 0.625f;
+				}
+			}
+		}
+
+		if (wSpeed &gt; wantedSpeed) {
+			wSpeed = wantedSpeed;
+		}
 	} else {
-		wSpeed=0;
+		wSpeed = 0.0f;
 	}
-	//Limit change according to acceleration.
+
+	// limit speed change according to acceleration
 	float dif = wSpeed - currentSpeed;
 
 	if (!accRate) {
-		logOutput.Print(&quot;Acceleration is zero on unit %s\n&quot;,owner-&gt;unitDef-&gt;name.c_str());
-		accRate=0.01f;
+		logOutput.Print(&quot;Acceleration is zero for unit %s\n&quot;, owner-&gt;unitDef-&gt;name.c_str());
+		accRate = 0.01f;
 	}
-	if(fabs(dif) &lt; 0.05f) {		//good speed
-		deltaSpeed = dif / 8;
+
+	if (fabs(dif) &lt; 0.05f) {
+		// we are already going (mostly) how fast we want to go
+		deltaSpeed = dif * 0.125f;
 		nextDeltaSpeedUpdate = gs-&gt;frameNum + 8;
-	}
-	else if(dif &gt; 0) {				//accelerate
-		if(dif &lt; accRate) {
+	} else if (dif &gt; 0.0f) {
+		// we want to accelerate
+		if (dif &lt; accRate) {
 			deltaSpeed = dif;
 			nextDeltaSpeedUpdate = gs-&gt;frameNum;
 		} else {
 			deltaSpeed = accRate;
-			nextDeltaSpeedUpdate = (int)(gs-&gt;frameNum + std::min((float) 8, dif / accRate));
+			nextDeltaSpeedUpdate = (int) (gs-&gt;frameNum + std::min(8.0f, dif / accRate));
 		}
-	}
-	else {	// decRate = 0.1*brakeRate, I guess this is for aircraft
-		if(dif &gt; -10*decRate){
+	} else {
+		// we want to decelerate
+		if (dif &gt; -10.0f * decRate) {
 			deltaSpeed = dif;
 			nextDeltaSpeedUpdate = gs-&gt;frameNum + 1;
+		} else {
+			deltaSpeed = -10.0f * decRate;
+			nextDeltaSpeedUpdate = (int) (gs-&gt;frameNum + std::min(8.0f, dif / deltaSpeed));
 		}
-		else {
-			deltaSpeed = -10*decRate;
-			nextDeltaSpeedUpdate = (int)(gs-&gt;frameNum + std::min((float) 8, dif / (-10*decRate)));
-		}
 	}
-	//float3 temp=UpVector*wSpeed;
-	//temp.CheckInBounds();
 
 #ifdef TRACE_SYNC
 	tracefile &lt;&lt; &quot;Unit delta speed: &quot;;
@@ -799,9 +818,6 @@
 			midPos.y = wh + owner-&gt;relMidPos.y - speed.y*0.8;
 			owner-&gt;cob-&gt;Call(&quot;Landed&quot;); //stop parachute animation
 		}
-
-
-
 	}
 }
 
@@ -952,13 +968,11 @@
 }
 
 
-const float AVOIDANCE_DISTANCE = 1.0f;				// How far away a unit should start avoiding an obstacle. Multiplied with distance to waypoint.
-const float AVOIDANCE_STRENGTH = 2.0f;				// How strongly an object should be avoided. Raise this value to give some more marginal.
-const float FORCE_FIELD_DISTANCE = 50;				// How faar away a unit may be affected by the force-field. Multiplied with speed of the unit.
-const float FORCE_FIELD_STRENGTH = 0.4f;			// Maximum strenght of the force-field.
+// const float AVOIDANCE_DISTANCE = 1.0f;			// How far away a unit should start avoiding an obstacle. Multiplied with distance to waypoint.
+const float AVOIDANCE_STRENGTH = 2.0f;				// How strongly an object should be avoided. Raise this value to give some more margin.
+// const float FORCE_FIELD_DISTANCE = 50;			// How far away a unit may be affected by the force-field. Multiplied with speed of the unit.
+// const float FORCE_FIELD_STRENGTH = 0.4f;			// Maximum strenght of the force-field.
 
-
-
 /*
  * Dynamic obstacle avoidance, helps the unit to
  * follow the path even when it's not perfect.
@@ -1139,7 +1153,7 @@
 			pathId = 0;
 			return;
 		}
-	}else {
+	} else {
 		lastGetPathPos = owner-&gt;pos;
 		nonMovingFailures = 0;
 	}
@@ -1147,8 +1161,9 @@
 	pathManager-&gt;DeletePath(pathId);
 	pathId = pathManager-&gt;RequestPath(owner-&gt;mobility, owner-&gt;pos, goalPos, goalRadius, owner);
 	nextWaypoint = owner-&gt;pos;
-	// new path received, can't be at waypoint.
-	if (pathId){
+
+	// if new path received, can't be at waypoint
+	if (pathId) {
 		atGoal = false;
 		haveFinalWaypoint = false;
 		GetNextWaypoint();
@@ -1175,7 +1190,7 @@
 			atGoal = false;
 		} else {
 			if (DEBUG_CONTROLLER)
-				logOutput.Print(&quot;Path failure %i %i&quot;, owner-&gt;id, pathFailures);
+				logOutput.Print(&quot;Path-failure count for unit %i: %i&quot;, owner-&gt;id, pathFailures);
 			pathFailures++;
 			if (pathFailures &gt; 0) {
 				pathFailures = 0;
@@ -1194,6 +1209,8 @@
 }
 
 
+
+
 /*
 The distance the unit will move at max breaking before stopping,
 starting from given speed.
@@ -1207,7 +1224,6 @@
 	return fabs(speed * speed / owner-&gt;mobility-&gt;maxBreaking);
 }
 
-
 /*
 Gives the position this unit will end up at with full breaking
 from current velocity.
@@ -1215,7 +1231,7 @@
 float3 CGroundMoveType::Here()
 {
 	float3 motionDir = owner-&gt;speed;
-	if(motionDir.SqLength2D() == 0) {
+	if (motionDir.SqLength2D() == 0) {
 		return owner-&gt;midPos;
 	} else {
 		motionDir.Normalize();
@@ -1233,7 +1249,6 @@
 	return BreakingDistance(owner-&gt;speed.Length2D()) + CPathManager::PATH_RESOLUTION;
 }
 
-
 /*
 Gives the maximum distance from it's waypoint a unit could be
 before a new path is requested.
@@ -1243,9 +1258,10 @@
 	return MinDistanceToWaypoint() * MAX_OFF_PATH_FACTOR;
 }
 
-/*
-Initializes motion.
-*/
+
+
+
+/* Initializes motion. */
 void CGroundMoveType::StartEngine() {
 	// ran only if the unit has no path and is not already at goal
 	if (!pathId &amp;&amp; !atGoal) {
@@ -1259,11 +1275,11 @@
 			owner-&gt;cob-&gt;Call(COBFN_StartMoving);
 
 			if (DEBUG_CONTROLLER) {
-				logOutput &lt;&lt; &quot;Engine started&quot; &lt;&lt; &quot; &quot; &lt;&lt; owner-&gt;id &lt;&lt; &quot;\n&quot;;
+				logOutput &lt;&lt; &quot;Engine started&quot; &lt;&lt; &quot; &quot; &lt;&lt; int(owner-&gt;id) &lt;&lt; &quot;\n&quot;;
 			}
 		} else {
 			if (DEBUG_CONTROLLER) {
-				logOutput &lt;&lt; &quot;Engine start failed: &quot; &lt;&lt; owner-&gt;id &lt;&lt; &quot;\n&quot;;
+				logOutput &lt;&lt; &quot;Engine start failed: &quot; &lt;&lt; int(owner-&gt;id) &lt;&lt; &quot;\n&quot;;
 			}
 
 			Fail();
@@ -1271,12 +1287,9 @@
 	}
 
 	nextObstacleAvoidanceUpdate = gs-&gt;frameNum;
-	//SetDeltaSpeed();
 }
 
-/*
-Stops motion.
-*/
+/* Stops motion. */
 void CGroundMoveType::StopEngine() {
 	// ran only if engine is active
 	if (pathId) {
@@ -1291,28 +1304,25 @@
 		owner-&gt;cob-&gt;Call(COBFN_StopMoving);
 
 		if (DEBUG_CONTROLLER) {
-			logOutput &lt;&lt; &quot;Engine stopped.&quot; &lt;&lt; &quot; &quot; &lt;&lt; owner-&gt;id &lt;&lt; &quot;\n&quot;;
+			logOutput &lt;&lt; &quot;Engine stopped. &quot; &lt;&lt; int(owner-&gt;id) &lt;&lt; &quot;\n&quot;;
 		}
 	}
+
 	owner-&gt;isMoving = false;
 	wantedSpeed = 0;
-	// SetDeltaSpeed();
 }
 
 
-/*
-Called when the unit arrives at it's waypoint.
-*/
+/* Called when the unit arrives at its waypoint. */
 void CGroundMoveType::Arrived()
 {
-	//Can only &quot;arrive&quot; if the engine is active.
-	if(progressState == Active) {
-		//Have reached waypoint.
+	// can only &quot;arrive&quot; if the engine is active
+	if (progressState == Active) {
+		// we have reached our waypoint
 		atGoal = true;
 
 		StopEngine();
 
-		// Play &quot;arrived&quot; sound.
 		ENTER_UNSYNCED;
 		if (owner-&gt;team == gu-&gt;myTeam) {
 			int soundIdx = owner-&gt;unitDef-&gt;sounds.arrived.getRandomIdx();
@@ -1324,11 +1334,11 @@
 		}
 		ENTER_SYNCED;
 
-		//And the action is done.
+		// and the action is done
 		progressState = Done;
 		owner-&gt;commandAI-&gt;SlowUpdate();
 
-		if(DEBUG_CONTROLLER)
+		if (DEBUG_CONTROLLER)
 			logOutput &lt;&lt; &quot;Unit arrived!\n&quot;;
 	}
 }
@@ -1339,7 +1349,7 @@
 */
 void CGroundMoveType::Fail()
 {
-	if(DEBUG_CONTROLLER)
+	if (DEBUG_CONTROLLER)
 		logOutput.Print(&quot;Unit failed! %i&quot;,owner-&gt;id);
 
 	StopEngine();
@@ -1441,15 +1451,12 @@
 		BlockingMapCellIt it;
 		float3 posDelta = ZeroVector;
 
-		if (!d.empty() &amp;&amp; d.find(owner) == d.end()) {
+		if (!d.empty() &amp;&amp; d.find(owner-&gt;id) == d.end()) {
 			continue;
 		}
 
-		// NOTE: clients may have different iteration orders,
-		// but the cumulative change to owner-&gt;pos is synced
-		// (all clients process the same objects)
 		for (it = c.begin(); it != c.end(); it++) {
-			CSolidObject* obj = *it;
+			CSolidObject* obj = it-&gt;second;
 
 			if (m-&gt;moveMath-&gt;IsNonBlocking(*m, obj)) {
 				// no collision possible
@@ -1529,15 +1536,12 @@
 		BlockingMapCellIt it;
 		float3 posDelta = ZeroVector;
 
-		if (!d.empty() &amp;&amp; d.find(owner) == d.end()) {
+		if (!d.empty() &amp;&amp; d.find(owner-&gt;id) == d.end()) {
 			continue;
 		}
 
-		// NOTE: clients may have different iteration orders,
-		// but the cumulative change to owner-&gt;pos is synced
-		// (all clients process the same objects)
 		for (it = c.begin(); it != c.end(); it++) {
-			CSolidObject* obj = *it;
+			CSolidObject* obj = it-&gt;second;
 
 			if (m-&gt;moveMath-&gt;IsNonBlocking(*m, obj)) {
 				// no collision possible
@@ -1842,22 +1846,26 @@
 void CGroundMoveType::KeepPointingTo(float3 pos, float distance, bool aggressive){
 	mainHeadingPos = pos;
 	useMainHeading = aggressive;
-	if(useMainHeading &amp;&amp; !owner-&gt;weapons.empty()){
-		if(!owner-&gt;weapons[0]-&gt;weaponDef-&gt;waterweapon &amp;&amp; mainHeadingPos.y &lt;= 1){
+
+	if (useMainHeading &amp;&amp; !owner-&gt;weapons.empty()) {
+		if (!owner-&gt;weapons[0]-&gt;weaponDef-&gt;waterweapon &amp;&amp; mainHeadingPos.y &lt;= 1) {
 			mainHeadingPos.y = 1;
 		}
+
 		float3 dir1 = owner-&gt;weapons.front()-&gt;mainDir;
 		dir1.y = 0;
 		dir1.Normalize();
-		float3 dir2 = mainHeadingPos-owner-&gt;pos;
+		float3 dir2 = mainHeadingPos - owner-&gt;pos;
 		dir2.y = 0;
 		dir2.Normalize();
-		if(dir2 != ZeroVector){
-			short heading = GetHeadingFromVector(dir2.x,dir2.z)
-				- GetHeadingFromVector(dir1.x,dir1.z);
-			if(owner-&gt;heading != heading
+
+		if (dir2 != ZeroVector) {
+			short heading =
+				GetHeadingFromVector(dir2.x, dir2.z) -
+				GetHeadingFromVector(dir1.x,dir1.z);
+			if (owner-&gt;heading != heading
 					&amp;&amp; !(owner-&gt;weapons.front()-&gt;TryTarget(
-					mainHeadingPos, true, 0))){
+					mainHeadingPos, true, 0))) {
 				progressState = Active;
 			}
 		}
@@ -1867,22 +1875,27 @@
 void CGroundMoveType::KeepPointingTo(CUnit* unit, float distance, bool aggressive){
 	mainHeadingPos = unit-&gt;pos;
 	useMainHeading = aggressive;
-	if(useMainHeading
+
+	if (useMainHeading
 			&amp;&amp; !owner-&gt;weapons.empty()
 			&amp;&amp; (this-owner-&gt;weapons[0]-&gt;weaponDef-&gt;waterweapon
-			|| mainHeadingPos.y &gt;= 0)){
+			|| mainHeadingPos.y &gt;= 0)) {
+
 		float3 dir1 = owner-&gt;weapons.front()-&gt;mainDir;
 		dir1.y = 0;
 		dir1.Normalize();
-		float3 dir2 = mainHeadingPos-owner-&gt;pos;
+		float3 dir2 = mainHeadingPos - owner-&gt;pos;
 		dir2.y = 0;
 		dir2.Normalize();
-		if(dir2 != ZeroVector){
-			short heading = GetHeadingFromVector(dir2.x,dir2.z)
-				- GetHeadingFromVector(dir1.x,dir1.z);
-			if(owner-&gt;heading != heading
+
+		if (dir2 != ZeroVector) {
+			short heading =
+				GetHeadingFromVector(dir2.x, dir2.z) -
+				GetHeadingFromVector(dir1.x, dir1.z);
+
+			if (owner-&gt;heading != heading
 					&amp;&amp; !(owner-&gt;weapons.front()-&gt;TryTarget(
-					mainHeadingPos, true, 0))){
+					mainHeadingPos, true, 0))) {
 				progressState = Active;
 			}
 		}

Modified: branches/0.77-branch/rts/Sim/MoveTypes/MoveMath/MoveMath.cpp
===================================================================
--- branches/0.77-branch/rts/Sim/MoveTypes/MoveMath/MoveMath.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Sim/MoveTypes/MoveMath/MoveMath.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -221,13 +221,14 @@
 	BlockingMapCellIt it;
 
 	for (it = c.begin(); it != c.end(); it++) {
-		CSolidObject* obstacle = *it;
+		CSolidObject* obstacle = it-&gt;second;
 
 		if (IsNonBlocking(moveData, obstacle)) {
 			continue;
 		}
 
-		if (obstacle-&gt;mobility) {
+		// mobility implies canmove, but not (speed &gt; 0.0f)
+		if (obstacle-&gt;mobility &amp;&amp; !obstacle-&gt;immobile) {
 			// mobile obstacle
 			if (obstacle-&gt;isMoving) {
 				r |= BLOCK_MOVING;

Modified: branches/0.77-branch/rts/Sim/Objects/SolidObject.cpp
===================================================================
--- branches/0.77-branch/rts/Sim/Objects/SolidObject.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Sim/Objects/SolidObject.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -7,8 +7,7 @@
 #include &quot;myMath.h&quot;
 
 CR_BIND_DERIVED(CSolidObject, CWorldObject, );
-
-CR_REG_METADATA(CSolidObject, 
+CR_REG_METADATA(CSolidObject,
 (
 	CR_MEMBER(mass),
 	CR_MEMBER(blocking),
@@ -32,7 +31,8 @@
 	CR_RESERVED(16))
 );
 
-CSolidObject::CSolidObject() :
+
+CSolidObject::CSolidObject():
 	mass(100000),
 	blocking(false),
 	blockHeightChanges(false),
@@ -60,39 +60,25 @@
 	mapPos = GetMapPos();
 }
 
-
-/*
-Destructor
-*/
 CSolidObject::~CSolidObject() {
-	UnBlock();
-
-	if (mobility)
+	if (mobility) {
 		delete mobility;
+		mobility = 0x0;
+	}
 }
 
 
 
-/////////////////////
-// Useful fuctions //
-/////////////////////
-
-/*
-Removes this object from GroundBlockingMap.
-*/
+/* Removes this object from the GroundBlockingMap. */
 void CSolidObject::UnBlock() {
 	if (isMarkedOnBlockingMap) {
 		groundBlockingObjectMap-&gt;RemoveGroundBlockingObject(this);
 	}
 }
 
-
-/*
-Adds this object to the GroundBlockingMap.
-*/
+/* Adds this object to the GroundBlockingMap. */
 void CSolidObject::Block() {
-	if (isMarkedOnBlockingMap)
-		UnBlock();
+	UnBlock();
 
 	if (blocking &amp;&amp; (physicalState == OnGround ||
 	                 physicalState == Floating ||

Modified: branches/0.77-branch/rts/Sim/Objects/SolidObject.h
===================================================================
--- branches/0.77-branch/rts/Sim/Objects/SolidObject.h	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Sim/Objects/SolidObject.h	2008-08-20 14:38:09 UTC (rev 6278)
@@ -30,11 +30,11 @@
 
 	virtual void DoDamage(const DamageArray&amp; damages, CUnit* attacker, const float3&amp; impulse) {};
 	virtual void Kill(float3&amp; impulse) {};
+	virtual int GetBlockingMapID() const { return -1; }
 
 	void Block();
 	void UnBlock();
 
-
 	// Static properties.
 	float mass;									// The physical mass of this object.
 	bool blocking;								// If this object is blocking/collidable. (NOTE: Some objects could be flat =&gt; not collidable.)
@@ -64,7 +64,7 @@
 	int2 mapPos;								// Current position on GroundBlockingMap.
 	unsigned char* yardMap;						// Current active yardmap of this object. 0 means no active yardmap =&gt; all blocked.
 	int buildFacing;							// Orientation of footprint, 4 different states
-	bool isMarkedOnBlockingMap;					// Tells if this object are marked on the GroundBlockingMap.
+	bool isMarkedOnBlockingMap;					// true if this object is currently marked on the GroundBlockingMap
 
 	// Old stuff. Used for back-compability. NOTE: Don't use these!
 	float3 speed;

Modified: branches/0.77-branch/rts/Sim/Objects/WorldObject.cpp
===================================================================
--- branches/0.77-branch/rts/Sim/Objects/WorldObject.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Sim/Objects/WorldObject.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -8,6 +8,7 @@
 
 CR_BIND_DERIVED(CWorldObject, CObject, )
 CR_REG_METADATA(CWorldObject, (
+	CR_MEMBER(id),
 	CR_MEMBER(radius),
 	CR_MEMBER_BEGINFLAG(CM_Config), // the projectile system needs to know that 'pos' is accessible by script
 		CR_MEMBER(pos),

Modified: branches/0.77-branch/rts/Sim/Objects/WorldObject.h
===================================================================
--- branches/0.77-branch/rts/Sim/Objects/WorldObject.h	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Sim/Objects/WorldObject.h	2008-08-20 14:38:09 UTC (rev 6278)
@@ -7,20 +7,22 @@
 #include &quot;Object.h&quot;
 #include &quot;float3.h&quot;
 
-class CWorldObject : public CObject  
+class CWorldObject: public CObject
 {
 public:
 	CR_DECLARE(CWorldObject);
 
-	CWorldObject() :
-		useAirLos(false), alwaysVisible(false) {}
-	CWorldObject(const float3&amp; pos) :
-		pos(pos), useAirLos(false), alwaysVisible(false) {}
+	CWorldObject():
+		id(0), useAirLos(false), alwaysVisible(false) {}
+	CWorldObject(const float3&amp; pos):
+		id(0), pos(pos), useAirLos(false), alwaysVisible(false) {}
 
 	void SetRadius(float r);
 	virtual ~CWorldObject();
 	virtual void DrawS3O();
 
+	int id;
+
 	float3 pos;
 	float radius;     //used for collisions
 	float sqRadius;

Modified: branches/0.77-branch/rts/Sim/Projectiles/Projectile.cpp
===================================================================
--- branches/0.77-branch/rts/Sim/Projectiles/Projectile.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Sim/Projectiles/Projectile.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -41,8 +41,7 @@
 	deleteMe(false),
 	castShadow(false),
 	s3domodel(0),
-	collisionFlags(0),
-	id(0)
+	collisionFlags(0)
 {}
 
 
@@ -133,10 +132,10 @@
 }
 
 
-void CProjectile::DependentDied(CObject *o)
+void CProjectile::DependentDied(CObject* o)
 {
-	if(o==owner)
-		owner=0;
+	if (o == owner)
+		owner = 0;
 }
 
 void CProjectile::DrawCallback(void)

Modified: branches/0.77-branch/rts/Sim/Projectiles/Projectile.h
===================================================================
--- branches/0.77-branch/rts/Sim/Projectiles/Projectile.h	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Sim/Projectiles/Projectile.h	2008-08-20 14:38:09 UTC (rev 6278)
@@ -55,7 +55,6 @@
 	virtual void DrawS3O() { DrawUnitPart(); }
 
 	S3DOModel* s3domodel;
-	unsigned int id;
 };
 
 #endif /* PROJECTILE_H */

Modified: branches/0.77-branch/rts/Sim/Projectiles/ProjectileHandler.h
===================================================================
--- branches/0.77-branch/rts/Sim/Projectiles/ProjectileHandler.h	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Sim/Projectiles/ProjectileHandler.h	2008-08-20 14:38:09 UTC (rev 6278)
@@ -26,7 +26,7 @@
 
 typedef std::list&lt;CProjectile*&gt; Projectile_List;
 typedef std::pair&lt;CProjectile*, int&gt; ProjectileMapPair;
-typedef std::map&lt;unsigned int, ProjectileMapPair&gt; ProjectileMap;
+typedef std::map&lt;int, ProjectileMapPair&gt; ProjectileMap;
 
 
 class CProjectileHandler

Modified: branches/0.77-branch/rts/Sim/Units/CommandAI/BuilderCAI.cpp
===================================================================
--- branches/0.77-branch/rts/Sim/Units/CommandAI/BuilderCAI.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Sim/Units/CommandAI/BuilderCAI.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -278,7 +278,7 @@
 }
 
 
-void CBuilderCAI::GiveCommandReal(const Command&amp; c)
+void CBuilderCAI::GiveCommandReal(const Command&amp; c, bool fromSynced)
 {
 	if (!AllowedCommand(c))
 		return;

Modified: branches/0.77-branch/rts/Sim/Units/CommandAI/BuilderCAI.h
===================================================================
--- branches/0.77-branch/rts/Sim/Units/CommandAI/BuilderCAI.h	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Sim/Units/CommandAI/BuilderCAI.h	2008-08-20 14:38:09 UTC (rev 6278)
@@ -21,7 +21,7 @@
 	void SlowUpdate();
 
 	void DrawCommands(void);
-	void GiveCommandReal(const Command&amp; c);
+	void GiveCommandReal(const Command&amp; c, bool fromSynced = true);
 	void DrawQuedBuildingSquares(void);
 
 	bool FindReclaimableFeatureAndReclaim(const float3&amp; pos, float radius,

Modified: branches/0.77-branch/rts/Sim/Units/CommandAI/CommandAI.cpp
===================================================================
--- branches/0.77-branch/rts/Sim/Units/CommandAI/CommandAI.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Sim/Units/CommandAI/CommandAI.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -338,7 +338,7 @@
 	return true;
 }
 
-bool CCommandAI::AllowedCommand(const Command&amp; c)
+bool CCommandAI::AllowedCommand(const Command&amp; c, bool fromSynced)
 {
 	// check if the command is in the map first
 	switch (c.id) {
@@ -374,7 +374,7 @@
 
 			if (c.params.size() == 3) {
 				// check if attack ground is really attack ground
-				if (fabs(c.params[1] - ground-&gt;GetHeight2(c.params[0], c.params[2])) &gt;
+				if (!fromSynced &amp;&amp; fabs(c.params[1] - ground-&gt;GetHeight2(c.params[0], c.params[2])) &gt;
 					maxHeightDiff) {
 					return false;
 				}
@@ -458,17 +458,17 @@
 		return;
 	}
 	eventHandler.UnitCommand(owner, c);
-	this-&gt;GiveCommandReal(c); // send to the sub-classes
+	this-&gt;GiveCommandReal(c, fromSynced); // send to the sub-classes
 }
 
 
-void CCommandAI::GiveCommandReal(const Command&amp; c)
+void CCommandAI::GiveCommandReal(const Command&amp; c, bool fromSynced)
 {
-	if (!AllowedCommand(c)) {
+	if (!AllowedCommand(c, fromSynced)) {
 		return;
 	}
 
-	GiveAllowedCommand(c);
+	GiveAllowedCommand(c, fromSynced);
 }
 
 
@@ -551,7 +551,7 @@
 }
 
 
-void CCommandAI::GiveAllowedCommand(const Command&amp; c)
+void CCommandAI::GiveAllowedCommand(const Command&amp; c, bool fromSynced)
 {
 	if (ExecuteStateCommand(c)) {
 		return;
@@ -594,7 +594,7 @@
 			return;
 		}
 		case CMD_INSERT: {
-			ExecuteInsert(c);
+			ExecuteInsert(c, fromSynced);
 			return;
 		}
 		case CMD_REMOVE: {
@@ -738,7 +738,7 @@
 }
 
 
-void CCommandAI::ExecuteInsert(const Command&amp; c)
+void CCommandAI::ExecuteInsert(const Command&amp; c, bool fromSynced)
 {
 	if (c.params.size() &lt; 3) {
 		return;
@@ -753,7 +753,7 @@
 	}
 
 	// validate the command
-	if (!AllowedCommand(newCmd)) {
+	if (!AllowedCommand(newCmd, fromSynced)) {
 		return;
 	}
 

Modified: branches/0.77-branch/rts/Sim/Units/CommandAI/CommandAI.h
===================================================================
--- branches/0.77-branch/rts/Sim/Units/CommandAI/CommandAI.h	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Sim/Units/CommandAI/CommandAI.h	2008-08-20 14:38:09 UTC (rev 6278)
@@ -27,7 +27,7 @@
 	void GiveCommand(const Command&amp; c, bool fromSynced = true); // feeds into GiveCommandReal()
 	virtual int GetDefaultCmd(CUnit* pointed,CFeature* feature);
 	virtual void SlowUpdate();
-	virtual void GiveCommandReal(const Command&amp; c);
+	virtual void GiveCommandReal(const Command&amp; c, bool fromSynced = true);
 	virtual std::vector&lt;CommandDescription&gt;&amp; GetPossibleCommands();
 	virtual void DrawCommands(void);
 	virtual void FinishCommand(void);
@@ -53,7 +53,7 @@
 	void SetCommandDescParam0(const Command&amp; c);
 	bool ExecuteStateCommand(const Command&amp; c);
 
-	void ExecuteInsert(const Command&amp; c);
+	void ExecuteInsert(const Command&amp; c, bool fromSynced = true);
 	void ExecuteRemove(const Command&amp; c);
 
 	void AddStockpileWeapon(CWeapon* weapon);
@@ -82,9 +82,9 @@
 protected:
 	bool isTrackable(const CUnit* unit) const;
 	bool isAttackCapable() const;
-	virtual bool AllowedCommand(const Command &amp;c);
+	virtual bool AllowedCommand(const Command &amp;c, bool fromSynced = true);
 	bool SkipParalyzeTarget(const CUnit* target);
-	void GiveAllowedCommand(const Command&amp; c);
+	void GiveAllowedCommand(const Command&amp; c, bool fromSynced = true);
 	void GiveWaitCommand(const Command&amp; c);
 	void PushOrUpdateReturnFight(const float3&amp; cmdPos1, const float3&amp; cmdPos2);
 	int UpdateTargetLostTimer(int unitid);

Modified: branches/0.77-branch/rts/Sim/Units/CommandAI/FactoryCAI.cpp
===================================================================
--- branches/0.77-branch/rts/Sim/Units/CommandAI/FactoryCAI.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Sim/Units/CommandAI/FactoryCAI.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -150,7 +150,7 @@
 }
 
 
-void CFactoryCAI::GiveCommandReal(const Command&amp; c)
+void CFactoryCAI::GiveCommandReal(const Command&amp; c, bool fromSynced)
 {
 	// move is always allowed for factories (passed to units it produces)
 	if ((c.id == CMD_SET_WANTED_MAX_SPEED) ||

Modified: branches/0.77-branch/rts/Sim/Units/CommandAI/FactoryCAI.h
===================================================================
--- branches/0.77-branch/rts/Sim/Units/CommandAI/FactoryCAI.h	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Sim/Units/CommandAI/FactoryCAI.h	2008-08-20 14:38:09 UTC (rev 6278)
@@ -26,7 +26,7 @@
 	int GetDefaultCmd(CUnit* pointed,CFeature* feature);
 	void SlowUpdate();
 
-	void GiveCommandReal(const Command&amp; c);
+	void GiveCommandReal(const Command&amp; c, bool fromSynced = true);
 
 	void InsertBuildCommand(CCommandQueue::iterator&amp; it, const Command&amp; c);
 	void RemoveBuildCommand(CCommandQueue::iterator&amp; it);

Modified: branches/0.77-branch/rts/Sim/Units/CommandAI/MobileCAI.cpp
===================================================================
--- branches/0.77-branch/rts/Sim/Units/CommandAI/MobileCAI.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Sim/Units/CommandAI/MobileCAI.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -186,7 +186,7 @@
 
 }
 
-void CMobileCAI::GiveCommandReal(const Command &amp;c)
+void CMobileCAI::GiveCommandReal(const Command &amp;c, bool fromSynced)
 {
 	if (!AllowedCommand(c))
 		return;
@@ -1022,7 +1022,7 @@
 			&amp;&amp; !owner-&gt;weapons.empty() &amp;&amp; owner-&gt;haveTarget) {
 		if(!owner-&gt;userTarget) {
 			owner-&gt;haveTarget = false;
-		} else if(owner-&gt;pos.distance2D(owner-&gt;userTarget-&gt;pos) &lt; 
+		} else if(owner-&gt;pos.distance2D(owner-&gt;userTarget-&gt;pos) &lt;
 				owner-&gt;maxRange + 200*owner-&gt;moveState*owner-&gt;moveState) {
 			Command c;
 			c.id = CMD_ATTACK;

Modified: branches/0.77-branch/rts/Sim/Units/CommandAI/MobileCAI.h
===================================================================
--- branches/0.77-branch/rts/Sim/Units/CommandAI/MobileCAI.h	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Sim/Units/CommandAI/MobileCAI.h	2008-08-20 14:38:09 UTC (rev 6278)
@@ -18,7 +18,7 @@
 	virtual void SetGoal(const float3&amp; pos, const float3&amp; curPos, float goalRadius, float speed);
 	int GetDefaultCmd(CUnit* pointed,CFeature* feature);
 	void SlowUpdate();
-	void GiveCommandReal(const Command &amp;c);
+	void GiveCommandReal(const Command &amp;c, bool fromSynced = true);
 	void DrawCommands(void);
 	void BuggerOff(float3 pos, float radius);
 	void NonMoving(void);
@@ -30,7 +30,7 @@
 	void ExecuteAttack(Command &amp;c);
 	void ExecuteDGun(Command &amp;c);
 	void ExecuteStop(Command &amp;c);
-	
+
 	void RefuelIfNeeded();
 
 	virtual void Execute();
@@ -66,11 +66,11 @@
 	int lastCloseInTry;
 	bool slowGuard;
 	bool moveDir;
-	
+
 	void PushOrUpdateReturnFight() {
 		CCommandAI::PushOrUpdateReturnFight(commandPos1, commandPos2);
 	}
-	
+
 	virtual bool IsValidTarget(const CUnit* enemy) const;
 };
 

Modified: branches/0.77-branch/rts/Sim/Units/Unit.cpp
===================================================================
--- branches/0.77-branch/rts/Sim/Units/Unit.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Sim/Units/Unit.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -239,12 +239,16 @@
 
 CUnit::~CUnit()
 {
+	// not all unit deletions run through KillUnit(),
+	// but we always want to call this for ourselves
+	UnBlock();
+
 	if (delayedWreckLevel &gt;= 0) {
 		// note: could also do this in Update() or even in CUnitKilledCB()
 		// where we wouldn't need deathSpeed, but not in KillUnit() since
 		// we have to wait for deathScriptFinished (but we want the delay
 		// in frames between CUnitKilledCB() and the CreateWreckage() call
-		// to be as short as possible to prevent visual position jumps)
+		// to be as short as possible to prevent position jumps)
 		featureHandler-&gt;CreateWreckage(pos, wreckName, heading, buildFacing,
 		                               delayedWreckLevel, team, -1, true,
 		                               unitDef-&gt;name, deathSpeed);
@@ -1519,7 +1523,7 @@
 	//       or UnitLoader! // why this is always called in unitloader
 	currentFuel = unitDef-&gt;maxFuel;
 
-	// all ships starts on water, all other on ground.
+	// all ships starts on water, all others on ground.
 	// TODO: Improve this. There might be cases when this is not correct.
 	if (unitDef-&gt;movedata &amp;&amp;
 	    (unitDef-&gt;movedata-&gt;moveType == MoveData::Hover_Move)) {
@@ -1530,8 +1534,12 @@
 		physicalState = OnGround;
 	}
 
-	// all units are set as ground-blocking.
+	// all units are set as ground-blocking by default,
+	// units that pretend to be &quot;pseudo-buildings&quot; (ie.
+	// hubs, etc) are flagged as immobile so that their
+	// positions are not considered valid for building
 	blocking = true;
+	immobile = (unitDef-&gt;speed &lt; 0.001f || !unitDef-&gt;canmove);
 
 	// some torp launchers etc are exactly in the surface and should be considered uw anyway
 	if ((pos.y + model-&gt;height) &lt; 0.0f) {
@@ -1550,7 +1558,7 @@
 	Command c;
 	if (unitDef-&gt;canmove || unitDef-&gt;builder) {
 		if (unitDef-&gt;moveState &lt; 0) {
-			if (builder!=NULL) {
+			if (builder != NULL) {
 				moveState = builder-&gt;moveState;
 			} else {
 				moveState = 1;
@@ -1900,10 +1908,8 @@
 		// start running the unit's kill-script
 		cob-&gt;Call(COBFN_Killed, args, &amp;CUnitKilledCB, this, NULL);
 
-		UnBlock();
 		delayedWreckLevel = args[1];
-	}
-	else {
+	} else {
 		deathScriptFinished = true;
 	}
 
@@ -2236,212 +2242,211 @@
 
 // Member bindings
 CR_REG_METADATA(CUnit, (
-				//CR_MEMBER(unitDef),
-				CR_MEMBER(unitDefName),
-				CR_MEMBER(id),
-				CR_MEMBER(team),
-				CR_MEMBER(allyteam),
-				CR_MEMBER(lineage),
-				CR_MEMBER(aihint),
-				CR_MEMBER(frontdir),
-				CR_MEMBER(rightdir),
-				CR_MEMBER(updir),
-				CR_MEMBER(upright),
-				CR_MEMBER(relMidPos),
-				CR_MEMBER(power),
-				CR_MEMBER(luaDraw),
-				CR_MEMBER(noDraw),
-				CR_MEMBER(noSelect),
-				CR_MEMBER(noMinimap),
-				CR_MEMBER(travel),
-				CR_MEMBER(travelPeriod),
-				CR_RESERVED(8),
+	//CR_MEMBER(unitDef),
+	CR_MEMBER(unitDefName),
+	CR_MEMBER(team),
+	CR_MEMBER(allyteam),
+	CR_MEMBER(lineage),
+	CR_MEMBER(aihint),
+	CR_MEMBER(frontdir),
+	CR_MEMBER(rightdir),
+	CR_MEMBER(updir),
+	CR_MEMBER(upright),
+	CR_MEMBER(relMidPos),
+	CR_MEMBER(power),
+	CR_MEMBER(luaDraw),
+	CR_MEMBER(noDraw),
+	CR_MEMBER(noSelect),
+	CR_MEMBER(noMinimap),
+	CR_MEMBER(travel),
+	CR_MEMBER(travelPeriod),
+	CR_RESERVED(8),
 
-				CR_MEMBER(maxHealth),
-				CR_MEMBER(health),
-				CR_MEMBER(paralyzeDamage),
-				CR_MEMBER(captureProgress),
-				CR_MEMBER(experience),
-				CR_MEMBER(limExperience),
-				CR_MEMBER(neutral),
-				CR_MEMBER(soloBuilder),
-				CR_MEMBER(beingBuilt),
-				CR_MEMBER(lastNanoAdd),
-				CR_MEMBER(repairAmount),
-				CR_MEMBER(transporter),
-				CR_MEMBER(toBeTransported),
-				CR_MEMBER(buildProgress),
-				CR_MEMBER(realLosRadius),
-				CR_MEMBER(realAirLosRadius),
-				CR_MEMBER(losStatus),
-				CR_MEMBER(inBuildStance),
-				CR_MEMBER(stunned),
-				CR_MEMBER(useHighTrajectory),
-				CR_MEMBER(groundLevelled),
-				CR_MEMBER(terraformLeft),
-				CR_RESERVED(11),
+	CR_MEMBER(maxHealth),
+	CR_MEMBER(health),
+	CR_MEMBER(paralyzeDamage),
+	CR_MEMBER(captureProgress),
+	CR_MEMBER(experience),
+	CR_MEMBER(limExperience),
+	CR_MEMBER(neutral),
+	CR_MEMBER(soloBuilder),
+	CR_MEMBER(beingBuilt),
+	CR_MEMBER(lastNanoAdd),
+	CR_MEMBER(repairAmount),
+	CR_MEMBER(transporter),
+	CR_MEMBER(toBeTransported),
+	CR_MEMBER(buildProgress),
+	CR_MEMBER(realLosRadius),
+	CR_MEMBER(realAirLosRadius),
+	CR_MEMBER(losStatus),
+	CR_MEMBER(inBuildStance),
+	CR_MEMBER(stunned),
+	CR_MEMBER(useHighTrajectory),
+	CR_MEMBER(groundLevelled),
+	CR_MEMBER(terraformLeft),
+	CR_RESERVED(11),
 
-				CR_MEMBER(deathCountdown),
-				CR_MEMBER(delayedWreckLevel),
-				CR_MEMBER(restTime),
+	CR_MEMBER(deathCountdown),
+	CR_MEMBER(delayedWreckLevel),
+	CR_MEMBER(restTime),
 
-				CR_MEMBER(weapons),
-				CR_MEMBER(shieldWeapon),
-				CR_MEMBER(stockpileWeapon),
-				CR_MEMBER(reloadSpeed),
-				CR_MEMBER(maxRange),
-				CR_MEMBER(haveTarget),
-				CR_MEMBER(haveUserTarget),
-				CR_MEMBER(haveDGunRequest),
-				CR_MEMBER(lastMuzzleFlameSize),
-				CR_MEMBER(lastMuzzleFlameDir),
-				CR_RESERVED(16),
+	CR_MEMBER(weapons),
+	CR_MEMBER(shieldWeapon),
+	CR_MEMBER(stockpileWeapon),
+	CR_MEMBER(reloadSpeed),
+	CR_MEMBER(maxRange),
+	CR_MEMBER(haveTarget),
+	CR_MEMBER(haveUserTarget),
+	CR_MEMBER(haveDGunRequest),
+	CR_MEMBER(lastMuzzleFlameSize),
+	CR_MEMBER(lastMuzzleFlameDir),
+	CR_RESERVED(16),
 
-				CR_MEMBER(armorType),
-				CR_MEMBER(category),
+	CR_MEMBER(armorType),
+	CR_MEMBER(category),
 
-				CR_MEMBER(quads),
-				CR_MEMBER(los),
-				CR_MEMBER(tempNum),
-				CR_MEMBER(lastSlowUpdate),
-				CR_MEMBER(mapSquare),
+	CR_MEMBER(quads),
+	CR_MEMBER(los),
+	CR_MEMBER(tempNum),
+	CR_MEMBER(lastSlowUpdate),
+	CR_MEMBER(mapSquare),
 
-				CR_MEMBER(controlRadius),
-				CR_MEMBER(losRadius),
-				CR_MEMBER(airLosRadius),
-				CR_MEMBER(losHeight),
-				CR_MEMBER(lastLosUpdate),
-				CR_RESERVED(16),
+	CR_MEMBER(controlRadius),
+	CR_MEMBER(losRadius),
+	CR_MEMBER(airLosRadius),
+	CR_MEMBER(losHeight),
+	CR_MEMBER(lastLosUpdate),
+	CR_RESERVED(16),
 
-				CR_MEMBER(radarRadius),
-				CR_MEMBER(sonarRadius),
-				CR_MEMBER(jammerRadius),
-				CR_MEMBER(sonarJamRadius),
-				CR_MEMBER(hasRadarCapacity),
-				CR_MEMBER(radarSquares),
-				CR_MEMBER(oldRadarPos),
-				CR_MEMBER(stealth),
-				CR_MEMBER(sonarStealth),
-				CR_RESERVED(15),
+	CR_MEMBER(radarRadius),
+	CR_MEMBER(sonarRadius),
+	CR_MEMBER(jammerRadius),
+	CR_MEMBER(sonarJamRadius),
+	CR_MEMBER(hasRadarCapacity),
+	CR_MEMBER(radarSquares),
+	CR_MEMBER(oldRadarPos),
+	CR_MEMBER(stealth),
+	CR_MEMBER(sonarStealth),
+	CR_RESERVED(15),
 
-				CR_MEMBER(commandAI),
-				CR_MEMBER(moveType),
-				CR_MEMBER(prevMoveType),
-				CR_MEMBER(usingScriptMoveType),
-				CR_MEMBER(group),
-				CR_RESERVED(16),
+	CR_MEMBER(commandAI),
+	CR_MEMBER(moveType),
+	CR_MEMBER(prevMoveType),
+	CR_MEMBER(usingScriptMoveType),
+	CR_MEMBER(group),
+	CR_RESERVED(16),
 
-				CR_MEMBER(condUseMetal),
-				CR_MEMBER(condUseEnergy),
-				CR_MEMBER(condMakeMetal),
-				CR_MEMBER(condMakeEnergy),
-				CR_MEMBER(uncondUseMetal),
-				CR_MEMBER(uncondUseEnergy),
-				CR_MEMBER(uncondMakeMetal),
-				CR_MEMBER(uncondMakeEnergy),
+	CR_MEMBER(condUseMetal),
+	CR_MEMBER(condUseEnergy),
+	CR_MEMBER(condMakeMetal),
+	CR_MEMBER(condMakeEnergy),
+	CR_MEMBER(uncondUseMetal),
+	CR_MEMBER(uncondUseEnergy),
+	CR_MEMBER(uncondMakeMetal),
+	CR_MEMBER(uncondMakeEnergy),
 
-				CR_MEMBER(metalUse),
-				CR_MEMBER(energyUse),
-				CR_MEMBER(metalMake),
-				CR_MEMBER(energyMake),
+	CR_MEMBER(metalUse),
+	CR_MEMBER(energyUse),
+	CR_MEMBER(metalMake),
+	CR_MEMBER(energyMake),
 
-				CR_MEMBER(metalUseI),
-				CR_MEMBER(energyUseI),
-				CR_MEMBER(metalMakeI),
-				CR_MEMBER(energyMakeI),
+	CR_MEMBER(metalUseI),
+	CR_MEMBER(energyUseI),
+	CR_MEMBER(metalMakeI),
+	CR_MEMBER(energyMakeI),
 
-				CR_MEMBER(metalUseold),
-				CR_MEMBER(energyUseold),
-				CR_MEMBER(metalMakeold),
-				CR_MEMBER(energyMakeold),
-				CR_MEMBER(energyTickMake),
+	CR_MEMBER(metalUseold),
+	CR_MEMBER(energyUseold),
+	CR_MEMBER(metalMakeold),
+	CR_MEMBER(energyMakeold),
+	CR_MEMBER(energyTickMake),
 
-				CR_MEMBER(metalExtract),
-				CR_MEMBER(metalCost),
-				CR_MEMBER(energyCost),
-				CR_MEMBER(buildTime),
-				CR_RESERVED(16),
+	CR_MEMBER(metalExtract),
+	CR_MEMBER(metalCost),
+	CR_MEMBER(energyCost),
+	CR_MEMBER(buildTime),
+	CR_RESERVED(16),
 
-				CR_MEMBER(metalStorage),
-				CR_MEMBER(energyStorage),
+	CR_MEMBER(metalStorage),
+	CR_MEMBER(energyStorage),
 
-				CR_MEMBER(lastAttacker),
-				CR_MEMBER(lastAttack),
-				CR_MEMBER(lastDamage),
-				CR_MEMBER(lastFireWeapon),
-				CR_MEMBER(recentDamage),
-				CR_MEMBER(userTarget),
-				CR_MEMBER(userAttackPos),
+	CR_MEMBER(lastAttacker),
+	CR_MEMBER(lastAttack),
+	CR_MEMBER(lastDamage),
+	CR_MEMBER(lastFireWeapon),
+	CR_MEMBER(recentDamage),
+	CR_MEMBER(userTarget),
+	CR_MEMBER(userAttackPos),
 
-				CR_MEMBER(userAttackGround),
-				CR_MEMBER(commandShotCount),
-				CR_MEMBER(fireState),
-				CR_MEMBER(dontFire),
-				CR_MEMBER(moveState),
+	CR_MEMBER(userAttackGround),
+	CR_MEMBER(commandShotCount),
+	CR_MEMBER(fireState),
+	CR_MEMBER(dontFire),
+	CR_MEMBER(moveState),
 
-				CR_MEMBER(activated),
+	CR_MEMBER(activated),
 
-				CR_RESERVED(32),
-				//CR_MEMBER(model),
-				//CR_MEMBER(cob),
-				//CR_MEMBER(script),
-				//CR_MEMBER(localmodel),
+	CR_RESERVED(32),
+	//CR_MEMBER(model),
+	//CR_MEMBER(cob),
+	//CR_MEMBER(script),
+	//CR_MEMBER(localmodel),
 
-				CR_MEMBER(tooltip),
-				CR_MEMBER(crashing),
-				CR_MEMBER(isDead),
-				CR_MEMBER(falling),
-				CR_MEMBER(fallSpeed),
-				CR_MEMBER(fallSpeed),
-				CR_MEMBER(fallSpeed),
+	CR_MEMBER(tooltip),
+	CR_MEMBER(crashing),
+	CR_MEMBER(isDead),
+	CR_MEMBER(falling),
+	CR_MEMBER(fallSpeed),
+	CR_MEMBER(fallSpeed),
+	CR_MEMBER(fallSpeed),
 
-				CR_MEMBER(flankingBonusMode),
-				CR_MEMBER(flankingBonusDir),
-				CR_MEMBER(flankingBonusAvgDamage),
-				CR_MEMBER(flankingBonusDifDamage),
-				CR_MEMBER(flankingBonusMobility),
-				CR_MEMBER(flankingBonusMobilityAdd),
+	CR_MEMBER(flankingBonusMode),
+	CR_MEMBER(flankingBonusDir),
+	CR_MEMBER(flankingBonusAvgDamage),
+	CR_MEMBER(flankingBonusDifDamage),
+	CR_MEMBER(flankingBonusMobility),
+	CR_MEMBER(flankingBonusMobilityAdd),
 
-				CR_MEMBER(armoredState),
-				CR_MEMBER(armoredMultiple),
-				CR_MEMBER(curArmorMultiple),
-				CR_RESERVED(16),
+	CR_MEMBER(armoredState),
+	CR_MEMBER(armoredMultiple),
+	CR_MEMBER(curArmorMultiple),
+	CR_RESERVED(16),
 
-				CR_MEMBER(wreckName),
-				CR_MEMBER(posErrorVector),
-				CR_MEMBER(posErrorDelta),
-				CR_MEMBER(nextPosErrorUpdate),
+	CR_MEMBER(wreckName),
+	CR_MEMBER(posErrorVector),
+	CR_MEMBER(posErrorDelta),
+	CR_MEMBER(nextPosErrorUpdate),
 
-				CR_MEMBER(hasUWWeapons),
+	CR_MEMBER(hasUWWeapons),
 
-				CR_MEMBER(wantCloak),
-				CR_MEMBER(scriptCloak),
-				CR_MEMBER(cloakTimeout),
-				CR_MEMBER(curCloakTimeout),
-				CR_MEMBER(isCloaked),
-				CR_MEMBER(decloakDistance),
+	CR_MEMBER(wantCloak),
+	CR_MEMBER(scriptCloak),
+	CR_MEMBER(cloakTimeout),
+	CR_MEMBER(curCloakTimeout),
+	CR_MEMBER(isCloaked),
+	CR_MEMBER(decloakDistance),
 
-				CR_MEMBER(lastTerrainType),
-				CR_MEMBER(curTerrainType),
+	CR_MEMBER(lastTerrainType),
+	CR_MEMBER(curTerrainType),
 
-				CR_MEMBER(alphaThreshold),
+	CR_MEMBER(alphaThreshold),
 
-				CR_MEMBER(selfDCountdown),
-				CR_RESERVED(16),
+	CR_MEMBER(selfDCountdown),
+	CR_RESERVED(16),
 
-				//CR_MEMBER(directControl),
-				//CR_MEMBER(myTrack),       //unused
-				CR_MEMBER(incomingMissiles),
-				CR_MEMBER(lastFlareDrop),
-				CR_MEMBER(seismicRadius),
-				CR_MEMBER(seismicSignature),
-				CR_MEMBER(maxSpeed),
-				CR_MEMBER(weaponHitMod),
+	//CR_MEMBER(directControl),
+	//CR_MEMBER(myTrack),       //unused
+	CR_MEMBER(incomingMissiles),
+	CR_MEMBER(lastFlareDrop),
+	CR_MEMBER(seismicRadius),
+	CR_MEMBER(seismicSignature),
+	CR_MEMBER(maxSpeed),
+	CR_MEMBER(weaponHitMod),
 
-				CR_MEMBER(inAir),
-				CR_MEMBER(inWater),
+	CR_MEMBER(inAir),
+	CR_MEMBER(inWater),
 
-				CR_RESERVED(126),
+	CR_RESERVED(126),
 
-				CR_POSTLOAD(PostLoad)
-				));
+	CR_POSTLOAD(PostLoad)
+	));

Modified: branches/0.77-branch/rts/Sim/Units/Unit.h
===================================================================
--- branches/0.77-branch/rts/Sim/Units/Unit.h	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Sim/Units/Unit.h	2008-08-20 14:38:09 UTC (rev 6278)
@@ -74,7 +74,7 @@
 	CUnit();
 	virtual ~CUnit();
 
-	virtual void UnitInit (const UnitDef* def, int team, const float3&amp; position);
+	virtual void UnitInit(const UnitDef* def, int team, const float3&amp; position);
 
 	bool AttackGround(const float3&amp;pos,bool dgun);
 	bool AttackUnit(CUnit* unit,bool dgun);
@@ -83,6 +83,9 @@
 	                      const float3&amp; impulse, int weaponId = -1);
 	virtual void Kill(float3&amp; impulse);
 	virtual void FinishedBuilding(void);
+
+	int GetBlockingMapID() const { return id; }
+
 	void ChangeLos(int l, int airlos);
 	void ChangeSensorRadius(int* valuePtr, int newValue);
 	bool AddBuildPower(float amount,CUnit* builder);		//negative amount=reclaim, return= true -&gt; build power was succesfully applied
@@ -154,7 +157,6 @@
 	std::vector&lt;float&gt;         modParams;    // mod controlled parameters
 	std::map&lt;std::string, int&gt; modParamsMap; // name map for mod parameters
 
-	int id;
 	int team;
 	int allyteam;
 	int lineage;    // the unit's origin lies in this team

Modified: branches/0.77-branch/rts/Sim/Units/UnitDef.h
===================================================================
--- branches/0.77-branch/rts/Sim/Units/UnitDef.h	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Sim/Units/UnitDef.h	2008-08-20 14:38:09 UTC (rev 6278)
@@ -136,6 +136,7 @@
 
 	float speed;
 	float turnRate;
+	bool turnInPlace;
 	int moveType;
 	bool upright;
 	bool collide;

Modified: branches/0.77-branch/rts/Sim/Units/UnitDefHandler.cpp
===================================================================
--- branches/0.77-branch/rts/Sim/Units/UnitDefHandler.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Sim/Units/UnitDefHandler.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -374,9 +374,11 @@
 
 	ud.speed    = udTable.GetFloat(&quot;maxVelocity&quot;,  0.0f) * 30.0f;
 	ud.maxAcc   = fabs(udTable.GetFloat(&quot;acceleration&quot;, 0.5f)); // no negative values
-	ud.maxDec   = fabs(udTable.GetFloat(&quot;brakeRate&quot;,    3.0f*ud.maxAcc)) * (ud.canfly ? 0.1f : 1.f); // no negative values
-	ud.turnRate = udTable.GetFloat(&quot;turnRate&quot;,     0.0f);
+	ud.maxDec   = fabs(udTable.GetFloat(&quot;brakeRate&quot;,    3.0f * ud.maxAcc)) * (ud.canfly? 0.1f: 1.0f); // no negative values
 
+	ud.turnRate    = udTable.GetFloat(&quot;turnRate&quot;,     0.0f);
+	ud.turnInPlace = udTable.GetBool( &quot;turnInPlace&quot;,  true);
+
 	bool noAutoFire  = udTable.GetBool(&quot;noAutoFire&quot;,  false);
 	ud.canFireControl = udTable.GetBool(&quot;canFireControl&quot;, !noAutoFire);
 	ud.fireState = udTable.GetInt(&quot;fireState&quot;, ud.canFireControl ? -1 : 2);

Modified: branches/0.77-branch/rts/Sim/Units/UnitHandler.cpp
===================================================================
--- branches/0.77-branch/rts/Sim/Units/UnitHandler.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Sim/Units/UnitHandler.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -302,7 +302,7 @@
 	float maxh=5000;
 	int numBorder=0;
 	float borderh=0;
-	float* heightmap=readmap-&gt;GetHeightmap();
+	const float* heightmap=readmap-&gt;GetHeightmap();
 
 	int xsize=1;
 	int ysize=1;
@@ -412,7 +412,7 @@
 	}
 
 	if (!unitdef-&gt;floater) {
-		float* heightmap = readmap-&gt;GetHeightmap();
+		const float* heightmap = readmap-&gt;GetHeightmap();
 		int x = (int) (pos.x / SQUARE_SIZE);
 		int z = (int) (pos.z / SQUARE_SIZE);
 		float orgh = readmap-&gt;orgheightmap[z * (gs-&gt;mapx + 1) + x];

Modified: branches/0.77-branch/rts/Sim/Units/UnitLoader.cpp
===================================================================
--- branches/0.77-branch/rts/Sim/Units/UnitLoader.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Sim/Units/UnitLoader.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -302,6 +302,8 @@
 		unit-&gt;energyTickMake += ud-&gt;tidalGenerator * mapInfo-&gt;map.tidalStrength;
 
 
+
+
 	unit-&gt;model = ud-&gt;LoadModel(team);
 	unit-&gt;SetRadius(unit-&gt;model-&gt;radius);
 
@@ -327,9 +329,11 @@
 		unit-&gt;pos.y = ground-&gt;GetHeight2(unit-&gt;pos.x, unit-&gt;pos.z);
 	}
 
+
 	unit-&gt;cob = SAFE_NEW CCobInstance(GCobEngine.GetCobFile(&quot;scripts/&quot; + name + &quot;.cob&quot;), unit);
 	unit-&gt;localmodel = modelParser-&gt;CreateLocalModel(unit-&gt;model, &amp;unit-&gt;cob-&gt;pieces);
 
+
 	for (unsigned int i = 0; i &lt; ud-&gt;weapons.size(); i++) {
 		unit-&gt;weapons.push_back(LoadWeapon(ud-&gt;weapons[i].def, unit, &amp;ud-&gt;weapons[i]));
 	}
@@ -507,12 +511,13 @@
 		const int tz1 = (int) std::max(0.0f ,(bi.pos.z - (bi.GetYSize() * hss)) / SQUARE_SIZE);
 		const int tx2 = std::min(gs-&gt;mapx, tx1 + bi.GetXSize());
 		const int tz2 = std::min(gs-&gt;mapy, tz1 + bi.GetYSize());
-		float* heightmap = readmap-&gt;GetHeightmap();
-		for(int z = tz1; z &lt;= tz2; z++){
-			for(int x = tx1; x &lt;= tx2; x++){
-				heightmap[z * (gs-&gt;mapx + 1) + x] = bi.pos.y;
+
+		for (int z = tz1; z &lt;= tz2; z++) {
+			for (int x = tx1; x &lt;= tx2; x++) {
+				readmap-&gt;SetHeight(z * (gs-&gt;mapx + 1) + x, bi.pos.y);
 			}
 		}
+
 		mapDamage-&gt;RecalcArea(tx1, tx2, tz1, tz2);
 	}
 }

Modified: branches/0.77-branch/rts/Sim/Units/UnitTypes/Builder.cpp
===================================================================
--- branches/0.77-branch/rts/Sim/Units/UnitTypes/Builder.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/Sim/Units/UnitTypes/Builder.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -126,7 +126,7 @@
 	captureSpeed   = scale * def-&gt;captureSpeed;
 	terraformSpeed = scale * def-&gt;terraformSpeed;
 
-	CUnit::UnitInit (def, team, position);
+	CUnit::UnitInit(def, team, position);
 }
 
 
@@ -136,221 +136,248 @@
 		return;
 	}
 
-	if(terraforming &amp;&amp; inBuildStance){
-		float* heightmap = readmap-&gt;GetHeightmap();
-		assert(!mapDamage-&gt;disabled); // The map should not be deformed in the first place.
-		float terraformScale = 0.1;
-		switch(terraformType) {
-		    case Terraform_Building:
-				if(curBuild) {
-					terraformScale = (terraformSpeed + terraformHelp) / curBuild-&gt;terraformLeft;
-					curBuild-&gt;terraformLeft -= (terraformSpeed + terraformHelp);
+	if (!stunned) {
+		if (terraforming &amp;&amp; inBuildStance) {
+			const float* heightmap = readmap-&gt;GetHeightmap();
+			assert(!mapDamage-&gt;disabled); // The map should not be deformed in the first place.
+			float terraformScale = 0.1;
+
+			switch (terraformType) {
+				case Terraform_Building:
+					if (curBuild) {
+						terraformScale = (terraformSpeed + terraformHelp) / curBuild-&gt;terraformLeft;
+						curBuild-&gt;terraformLeft -= (terraformSpeed + terraformHelp);
+						terraformHelp = 0;
+
+						if (terraformScale &gt; 1.0f) {
+							terraformScale = 1.0f;
+						}
+
+						// prevent building from timing out while terraforming for it
+						curBuild-&gt;AddBuildPower(0.0f, this);
+						for (int z = tz1; z &lt;= tz2; z++) {
+							for (int x = tx1; x &lt;= tx2; x++) {
+								int idx = z * (gs-&gt;mapx + 1) + x;
+								float ch = heightmap[idx];
+
+								readmap-&gt;AddHeight(idx, (curBuild-&gt;pos.y - ch) * terraformScale);
+							}
+						}
+
+						if(curBuild-&gt;terraformLeft&lt;=0){
+							terraforming=false;
+							mapDamage-&gt;RecalcArea(tx1,tx2,tz1,tz2);
+							curBuild-&gt;groundLevelled = true;
+							if (luaRules &amp;&amp; luaRules-&gt;TerraformComplete(this, curBuild)) {
+								StopBuild();
+							}
+						}
+					}
+					break;
+				case Terraform_Restore:
+					terraformScale = (terraformSpeed + terraformHelp) / myTerraformLeft;
+					myTerraformLeft -= (terraformSpeed + terraformHelp);
 					terraformHelp = 0;
+
 					if (terraformScale &gt; 1.0f) {
 						terraformScale = 1.0f;
 					}
-					curBuild-&gt;AddBuildPower(0.0f,this); //prevent building from timing out while terraforming for it
-					for(int z=tz1; z&lt;=tz2; z++){
-						for(int x=tx1; x&lt;=tx2; x++){
-							float ch=heightmap[z*(gs-&gt;mapx+1)+x];
-							heightmap[z*(gs-&gt;mapx+1)+x] += (curBuild-&gt;pos.y - ch) * terraformScale;
+
+					for (int z = tz1; z &lt;= tz2; z++) {
+						for (int x = tx1; x &lt;= tx2; x++) {
+							int idx = z * (gs-&gt;mapx + 1) + x;
+							float ch = heightmap[idx];
+							float oh = readmap-&gt;orgheightmap[idx];
+
+							readmap-&gt;AddHeight(idx, (oh - ch) * terraformScale);
 						}
 					}
-					if(curBuild-&gt;terraformLeft&lt;=0){
+
+					if (myTerraformLeft &lt;= 0) {
 						terraforming=false;
 						mapDamage-&gt;RecalcArea(tx1,tx2,tz1,tz2);
-						curBuild-&gt;groundLevelled = true;
-						if (luaRules &amp;&amp; luaRules-&gt;TerraformComplete(this, curBuild)) {
-							StopBuild();
-						}
+						StopBuild();
 					}
+					break;
+			}
+
+			CreateNanoParticle(terraformCenter,terraformRadius*0.5f,false);
+
+			for (int z = tz1; z &lt;= tz2; z++) {
+				// smooth the borders x
+				for (int x = 1; x &lt;= 3; x++) {
+					if (tx1 - 3 &gt;= 0) {
+						float ch3 = heightmap[z * (gs-&gt;mapx + 1) + tx1    ];
+						float ch  = heightmap[z * (gs-&gt;mapx + 1) + tx1 - x];
+						float ch2 = heightmap[z * (gs-&gt;mapx + 1) + tx1 - 3];
+						float amount = ((ch3 * (3 - x) + ch2 * x) / 3 - ch) * terraformScale;
+
+						readmap-&gt;AddHeight(z * (gs-&gt;mapx + 1) + tx1 - x, amount);
+					}
+					if (tx2 + 3 &lt; gs-&gt;mapx) {
+						float ch3 = heightmap[z * (gs-&gt;mapx + 1) + tx2    ];
+						float ch  = heightmap[z * (gs-&gt;mapx + 1) + tx2 + x];
+						float ch2 = heightmap[z * (gs-&gt;mapx + 1) + tx2 + 3];
+						float amount = ((ch3 * (3 - x) + ch2 * x) / 3 - ch) * terraformScale;
+
+						readmap-&gt;AddHeight(z * (gs-&gt;mapx + 1) + tx2 + x, amount);
+					}
 				}
-				break;
-			case Terraform_Restore:
-				terraformScale = (terraformSpeed + terraformHelp) / myTerraformLeft;
-				myTerraformLeft -= (terraformSpeed + terraformHelp);
-				terraformHelp = 0;
-				if (terraformScale &gt; 1.0f) {
-					terraformScale = 1.0f;
-				}
-				for(int z=tz1; z&lt;=tz2; z++){
-					for(int x=tx1; x&lt;=tx2; x++){
-						float ch=heightmap[z*(gs-&gt;mapx+1)+x];
-						float oh=readmap-&gt;orgheightmap[z*(gs-&gt;mapx+1)+x];
-						heightmap[z*(gs-&gt;mapx+1)+x] += (oh-ch) * terraformScale;
+			}
+			for (int z = 1; z &lt;= 3; z++) {
+				// smooth the borders z
+				for (int x = tx1; x &lt;= tx2; x++) {
+					if (tz1 - 3 &gt;= 0) {
+						float ch3 = heightmap[(tz1    ) * (gs-&gt;mapx + 1) + x];
+						float ch  = heightmap[(tz1 - z) * (gs-&gt;mapx + 1) + x];
+						float ch2 = heightmap[(tz1 - 3) * (gs-&gt;mapx + 1) + x];
+						float adjust = ((ch3 * (3 - z) + ch2 * z) / 3 - ch) * terraformScale;
+
+						readmap-&gt;AddHeight((tz1 - z) * (gs-&gt;mapx + 1) + x, adjust);
 					}
+					if (tz2 + 3 &lt; gs-&gt;mapy) {
+						float ch3 = heightmap[(tz2    ) * (gs-&gt;mapx + 1) + x];
+						float ch  = heightmap[(tz2 + z) * (gs-&gt;mapx + 1) + x];
+						float ch2 = heightmap[(tz2 + 3) * (gs-&gt;mapx + 1) + x];
+						float adjust = ((ch3 * (3 - z) + ch2 * z) / 3 - ch) * terraformScale;
+	
+						readmap-&gt;AddHeight((tz2 + z) * (gs-&gt;mapx + 1) + x, adjust);
+					}
 				}
-				if(myTerraformLeft&lt;=0){
-					terraforming=false;
-					mapDamage-&gt;RecalcArea(tx1,tx2,tz1,tz2);
-					StopBuild();
-				}
-				break;
-		}
-		CreateNanoParticle(terraformCenter,terraformRadius*0.5f,false);
-		for(int z=tz1; z&lt;=tz2; z++){		//smooth the borders x
-			for(int x=1; x&lt;=3; x++){
-				if(tx1-3&gt;=0){
-					float ch3=heightmap[z*(gs-&gt;mapx+1)+tx1];
-					float ch=heightmap[z*(gs-&gt;mapx+1)+tx1-x];
-					float ch2=heightmap[z*(gs-&gt;mapx+1)+tx1-3];
-					heightmap[z*(gs-&gt;mapx+1)+tx1-x] += ((ch3*(3-x)+ch2*x)/3-ch) * terraformScale;
-				}
-				if(tx2+3&lt;gs-&gt;mapx){
-					float ch3=heightmap[z*(gs-&gt;mapx+1)+tx2];
-					float ch=heightmap[z*(gs-&gt;mapx+1)+tx2+x];
-					float ch2=heightmap[z*(gs-&gt;mapx+1)+tx2+3];
-					heightmap[z*(gs-&gt;mapx+1)+tx2+x] += ((ch3*(3-x)+ch2*x)/3-ch) * terraformScale;
-				}
 			}
 		}
-		for(int z=1; z&lt;=3; z++){		//smooth the borders z
-			for(int x=tx1; x&lt;=tx2; x++){
-				if(tz1-3&gt;=0){
-					float ch3=heightmap[(tz1)*(gs-&gt;mapx+1)+x];
-					float ch=heightmap[(tz1-z)*(gs-&gt;mapx+1)+x];
-					float ch2=heightmap[(tz1-3)*(gs-&gt;mapx+1)+x];
-					heightmap[(tz1-z)*(gs-&gt;mapx+1)+x] += ((ch3*(3-z)+ch2*z)/3-ch) * terraformScale;
-				}
-				if(tz2+3&lt;gs-&gt;mapy){
-					float ch3=heightmap[(tz2)*(gs-&gt;mapx+1)+x];
-					float ch=heightmap[(tz2+z)*(gs-&gt;mapx+1)+x];
-					float ch2=heightmap[(tz2+3)*(gs-&gt;mapx+1)+x];
-					heightmap[(tz2+z)*(gs-&gt;mapx+1)+x] += ((ch3*(3-z)+ch2*z)/3-ch) * terraformScale;
-				}
+		else if (helpTerraform &amp;&amp; inBuildStance) {
+			if (helpTerraform-&gt;terraforming) {
+				helpTerraform-&gt;terraformHelp += terraformSpeed;
+				CreateNanoParticle(helpTerraform-&gt;terraformCenter,helpTerraform-&gt;terraformRadius*0.5f,false);
+			} else {
+				DeleteDeathDependence(helpTerraform);
+				helpTerraform=0;
+				StopBuild(true);
 			}
 		}
-	}
-	else if (helpTerraform &amp;&amp; inBuildStance) {
-		if (helpTerraform-&gt;terraforming) {
-			helpTerraform-&gt;terraformHelp += terraformSpeed;
-			CreateNanoParticle(helpTerraform-&gt;terraformCenter,helpTerraform-&gt;terraformRadius*0.5f,false);
-		} else {
-			DeleteDeathDependence(helpTerraform);
-			helpTerraform=0;
-			StopBuild(true);
-		}
-	}
-	else if (curBuild &amp;&amp; f3Dist(curBuild-&gt;pos, pos) &lt; buildDistance + curBuild-&gt;radius) {
-		if (curBuild-&gt;soloBuilder &amp;&amp; (curBuild-&gt;soloBuilder != this)) {
-			StopBuild();
-		} else {
-			if (!inBuildStance) {
-				curBuild-&gt;AddBuildPower(0.0f, this); //prevent building timing out
+		else if (curBuild &amp;&amp; f3Dist(curBuild-&gt;pos, pos) &lt; buildDistance + curBuild-&gt;radius) {
+			if (curBuild-&gt;soloBuilder &amp;&amp; (curBuild-&gt;soloBuilder != this)) {
+				StopBuild();
 			} else {
-				if (scriptCloak &lt;= 2) {
-					if (isCloaked) {
-						isCloaked = false;
-						eventHandler.UnitDecloaked(this);
+				if (!inBuildStance) {
+					curBuild-&gt;AddBuildPower(0.0f, this); //prevent building timing out
+				} else {
+					if (scriptCloak &lt;= 2) {
+						if (isCloaked) {
+							isCloaked = false;
+							eventHandler.UnitDecloaked(this);
+						}
+						curCloakTimeout = gs-&gt;frameNum + cloakTimeout;
 					}
-					curCloakTimeout = gs-&gt;frameNum + cloakTimeout;
-				}
 
-	  			float adjBuildSpeed; // adjusted build speed
-	  			if (curBuild-&gt;buildProgress &lt; 1.0f) {
-	  				adjBuildSpeed = buildSpeed;  // new build
-	  			} else {
-  					adjBuildSpeed = min(unitDef-&gt;maxRepairSpeed / 2.0f - curBuild-&gt;repairAmount, repairSpeed); // repair
-				}
+					float adjBuildSpeed; // adjusted build speed
+					if (curBuild-&gt;buildProgress &lt; 1.0f) {
+						adjBuildSpeed = buildSpeed;  // new build
+					} else {
+						adjBuildSpeed = min(unitDef-&gt;maxRepairSpeed / 2.0f - curBuild-&gt;repairAmount, repairSpeed); // repair
+					}
 
-	  			if(adjBuildSpeed &gt; 0 &amp;&amp; !commandAI-&gt;commandQue.empty()
-	  					&amp;&amp; commandAI-&gt;commandQue.front().id == CMD_WAIT) {
-	  				curBuild-&gt;AddBuildPower(0, this);
-	  			} else if (adjBuildSpeed &gt; 0 &amp;&amp; curBuild-&gt;AddBuildPower(adjBuildSpeed, this)) {
-					CreateNanoParticle(curBuild-&gt;midPos, curBuild-&gt;radius * 0.5f, false);
-				} else {
-					if(!curBuild-&gt;beingBuilt &amp;&amp; curBuild-&gt;health &gt;= curBuild-&gt;maxHealth) {
-						StopBuild();
+					if(adjBuildSpeed &gt; 0 &amp;&amp; !commandAI-&gt;commandQue.empty()
+							&amp;&amp; commandAI-&gt;commandQue.front().id == CMD_WAIT) {
+						curBuild-&gt;AddBuildPower(0, this);
+					} else if (adjBuildSpeed &gt; 0 &amp;&amp; curBuild-&gt;AddBuildPower(adjBuildSpeed, this)) {
+						CreateNanoParticle(curBuild-&gt;midPos, curBuild-&gt;radius * 0.5f, false);
+					} else {
+						if(!curBuild-&gt;beingBuilt &amp;&amp; curBuild-&gt;health &gt;= curBuild-&gt;maxHealth) {
+							StopBuild();
+						}
 					}
 				}
 			}
 		}
-	}
-	else if(curReclaim &amp;&amp; f3Dist(curReclaim-&gt;pos, pos)&lt;buildDistance+curReclaim-&gt;radius &amp;&amp; inBuildStance){
-		if (scriptCloak &lt;= 2) {
-			if (isCloaked) {
-				isCloaked = false;
-				eventHandler.UnitDecloaked(this);
+		else if(curReclaim &amp;&amp; f3Dist(curReclaim-&gt;pos, pos)&lt;buildDistance+curReclaim-&gt;radius &amp;&amp; inBuildStance){
+			if (scriptCloak &lt;= 2) {
+				if (isCloaked) {
+					isCloaked = false;
+					eventHandler.UnitDecloaked(this);
+				}
+				curCloakTimeout = gs-&gt;frameNum + cloakTimeout;
 			}
-			curCloakTimeout = gs-&gt;frameNum + cloakTimeout;
+			if (curReclaim-&gt;AddBuildPower(-reclaimSpeed, this)) {
+				CreateNanoParticle(curReclaim-&gt;midPos, curReclaim-&gt;radius * 0.7f, true);
+			}
 		}
-		if (curReclaim-&gt;AddBuildPower(-reclaimSpeed, this)) {
-			CreateNanoParticle(curReclaim-&gt;midPos, curReclaim-&gt;radius * 0.7f, true);
-		}
-	}
-	else if(curResurrect &amp;&amp; f3Dist(curResurrect-&gt;pos, pos)&lt;buildDistance+curResurrect-&gt;radius &amp;&amp; inBuildStance){
-		const UnitDef* ud=unitDefHandler-&gt;GetUnitByName(curResurrect-&gt;createdFromUnit);
-		if(ud){
-			if ((modInfo.reclaimMethod != 1) &amp;&amp; (curResurrect-&gt;reclaimLeft &lt; 1)) {
-				// This corpse has been reclaimed a little, need to restore the resources
-				// before we can let the player resurrect it.
-				curResurrect-&gt;AddBuildPower(repairSpeed, this);
-			}
-			else {
-				// Corpse has been restored, begin resurrection
-				if (UseEnergy(ud-&gt;energyCost * resurrectSpeed / ud-&gt;buildTime * modInfo.resurrectEnergyCostFactor)) {
-					curResurrect-&gt;resurrectProgress+=resurrectSpeed/ud-&gt;buildTime;
-					CreateNanoParticle(curResurrect-&gt;midPos,curResurrect-&gt;radius*0.7f,gs-&gt;randInt()&amp;1);
+		else if(curResurrect &amp;&amp; f3Dist(curResurrect-&gt;pos, pos)&lt;buildDistance+curResurrect-&gt;radius &amp;&amp; inBuildStance){
+			const UnitDef* ud=unitDefHandler-&gt;GetUnitByName(curResurrect-&gt;createdFromUnit);
+			if(ud){
+				if ((modInfo.reclaimMethod != 1) &amp;&amp; (curResurrect-&gt;reclaimLeft &lt; 1)) {
+					// This corpse has been reclaimed a little, need to restore the resources
+					// before we can let the player resurrect it.
+					curResurrect-&gt;AddBuildPower(repairSpeed, this);
 				}
-				if(curResurrect-&gt;resurrectProgress&gt;1){		//resurrect finished
-					curResurrect-&gt;UnBlock();
-					CUnit* u = unitLoader.LoadUnit(curResurrect-&gt;createdFromUnit, curResurrect-&gt;pos,
-					                               team, false, curResurrect-&gt;buildFacing, this);
-					if (!this-&gt;unitDef-&gt;canBeAssisted) {
-						u-&gt;soloBuilder = this;
-						u-&gt;AddDeathDependence(this);
+				else {
+					// Corpse has been restored, begin resurrection
+					if (UseEnergy(ud-&gt;energyCost * resurrectSpeed / ud-&gt;buildTime * modInfo.resurrectEnergyCostFactor)) {
+						curResurrect-&gt;resurrectProgress+=resurrectSpeed/ud-&gt;buildTime;
+						CreateNanoParticle(curResurrect-&gt;midPos,curResurrect-&gt;radius*0.7f,gs-&gt;randInt()&amp;1);
 					}
-					u-&gt;health*=0.05f;
-					u-&gt;lineage = this-&gt;lineage;
-					lastResurrected=u-&gt;id;
-					curResurrect-&gt;resurrectProgress=0;
-					featureHandler-&gt;DeleteFeature(curResurrect);
-					StopBuild(true);
+					if(curResurrect-&gt;resurrectProgress&gt;1){		//resurrect finished
+						curResurrect-&gt;UnBlock();
+						CUnit* u = unitLoader.LoadUnit(curResurrect-&gt;createdFromUnit, curResurrect-&gt;pos,
+													team, false, curResurrect-&gt;buildFacing, this);
+						if (!this-&gt;unitDef-&gt;canBeAssisted) {
+							u-&gt;soloBuilder = this;
+							u-&gt;AddDeathDependence(this);
+						}
+						u-&gt;health*=0.05f;
+						u-&gt;lineage = this-&gt;lineage;
+						lastResurrected=u-&gt;id;
+						curResurrect-&gt;resurrectProgress=0;
+						featureHandler-&gt;DeleteFeature(curResurrect);
+						StopBuild(true);
+					}
 				}
+			} else {
+				StopBuild(true);
 			}
-		} else {
-			StopBuild(true);
 		}
-	}
-	else if(curCapture &amp;&amp; f3Dist(curCapture-&gt;pos, pos)&lt;buildDistance+curCapture-&gt;radius &amp;&amp; inBuildStance){
-		if(curCapture-&gt;team!=team){
+		else if(curCapture &amp;&amp; f3Dist(curCapture-&gt;pos, pos)&lt;buildDistance+curCapture-&gt;radius &amp;&amp; inBuildStance){
+			if(curCapture-&gt;team!=team){
 
-			float captureProgressTemp = curCapture-&gt;captureProgress + 1.0f/(150+curCapture-&gt;buildTime/captureSpeed*(curCapture-&gt;health+curCapture-&gt;maxHealth)/curCapture-&gt;maxHealth*0.4f);
-			if (captureProgressTemp &gt;= 1.0f) {
-				captureProgressTemp = 1.0f;
-			}
-	
-			const float captureFraction = captureProgressTemp - curCapture-&gt;captureProgress;
-			const float energyUseScaled = curCapture-&gt;energyCost * captureFraction * modInfo.captureEnergyCostFactor;
+				float captureProgressTemp = curCapture-&gt;captureProgress + 1.0f/(150+curCapture-&gt;buildTime/captureSpeed*(curCapture-&gt;health+curCapture-&gt;maxHealth)/curCapture-&gt;maxHealth*0.4f);
+				if (captureProgressTemp &gt;= 1.0f) {
+					captureProgressTemp = 1.0f;
+				}
 
-			if (!UseEnergy(energyUseScaled)) {
-				gs-&gt;Team(team)-&gt;energyPull += energyUseScaled;
-			} else {
-				curCapture-&gt;captureProgress = captureProgressTemp;
-				CreateNanoParticle(curCapture-&gt;midPos,curCapture-&gt;radius*0.7f,false);
-				if(curCapture-&gt;captureProgress &gt;= 1.0f){
-					if (!curCapture-&gt;ChangeTeam(team, CUnit::ChangeCaptured)) {
-						// capture failed
-						ENTER_MIXED;
-						if (team == gu-&gt;myTeam) {
-							logOutput.Print(&quot;%s: Capture failed, unit type limit reached&quot;, unitDef-&gt;humanName.c_str());
-							logOutput.SetLastMsgPos(pos);
+				const float captureFraction = captureProgressTemp - curCapture-&gt;captureProgress;
+				const float energyUseScaled = curCapture-&gt;energyCost * captureFraction * modInfo.captureEnergyCostFactor;
+
+				if (!UseEnergy(energyUseScaled)) {
+					gs-&gt;Team(team)-&gt;energyPull += energyUseScaled;
+				} else {
+					curCapture-&gt;captureProgress = captureProgressTemp;
+					CreateNanoParticle(curCapture-&gt;midPos,curCapture-&gt;radius*0.7f,false);
+					if(curCapture-&gt;captureProgress &gt;= 1.0f){
+						if (!curCapture-&gt;ChangeTeam(team, CUnit::ChangeCaptured)) {
+							// capture failed
+							ENTER_MIXED;
+							if (team == gu-&gt;myTeam) {
+								logOutput.Print(&quot;%s: Capture failed, unit type limit reached&quot;, unitDef-&gt;humanName.c_str());
+								logOutput.SetLastMsgPos(pos);
+							}
+							ENTER_SYNCED;
+						} else {
+							// capture succesful
+							int oldLineage = curCapture-&gt;lineage;
+							curCapture-&gt;lineage = this-&gt;lineage;
+							gs-&gt;Team(oldLineage)-&gt;LeftLineage(curCapture);
 						}
-						ENTER_SYNCED;
-					} else {
-						// capture succesful
-						int oldLineage = curCapture-&gt;lineage;
-						curCapture-&gt;lineage = this-&gt;lineage;
-						gs-&gt;Team(oldLineage)-&gt;LeftLineage(curCapture);
+						curCapture-&gt;captureProgress=0.0f;
+						StopBuild(true);
 					}
-					curCapture-&gt;captureProgress=0.0f;
-					StopBuild(true);
 				}
+			} else {
+				StopBuild(true);
 			}
-		} else {
-			StopBuild(true);
 		}
 	}
+
 	CUnit::Update();
 }
 
@@ -460,12 +487,13 @@
 	tz1 = (int)max((float)0,(centerPos.z-radius)/SQUARE_SIZE);
 	tz2 = (int)min((float)gs-&gt;mapy,(centerPos.z+radius)/SQUARE_SIZE);
 
-	float tcost=0;
-	float* heightmap = readmap-&gt;GetHeightmap();
-	for(int z=tz1; z&lt;=tz2; z++){
-		for(int x=tx1; x&lt;=tx2; x++){
-			float delta=readmap-&gt;orgheightmap[z*(gs-&gt;mapx+1)+x]-heightmap[z*(gs-&gt;mapx+1)+x];
-			tcost+=fabs(delta);
+	float tcost = 0.0f;
+	const float* heightmap = readmap-&gt;GetHeightmap();
+
+	for (int z = tz1; z &lt;= tz2; z++) {
+		for (int x = tx1; x &lt;= tx2; x++) {
+			float delta = readmap-&gt;orgheightmap[z * (gs-&gt;mapx + 1) + x] - heightmap[z * (gs-&gt;mapx + 1) + x];
+			tcost += fabs(delta);
 		}
 	}
 	myTerraformLeft=tcost;
@@ -589,18 +617,20 @@
 {
 	float3&amp; buildPos=buildInfo.pos;
 
-	float tcost=0;
-	float* heightmap = readmap-&gt;GetHeightmap();
-	for(int z=tz1; z&lt;=tz2; z++){
-		for(int x=tx1; x&lt;=tx2; x++){
-			float delta=buildPos.y-heightmap[z*(gs-&gt;mapx+1)+x];
+	float tcost = 0.0f;
+	const float* heightmap = readmap-&gt;GetHeightmap();
+
+	for (int z = tz1; z &lt;= tz2; z++) {
+		for (int x = tx1; x &lt;= tx2; x++) {
+			int idx = z * (gs-&gt;mapx + 1) + x;
+			float delta = buildPos.y - heightmap[idx];
 			float cost;
-			if(delta&gt;0){
-				cost=max(3.f,heightmap[z*(gs-&gt;mapx+1)+x]-readmap-&gt;orgheightmap[z*(gs-&gt;mapx+1)+x]+delta*0.5f);
+			if (delta &gt; 0) {
+				cost = max(3.0f, heightmap[idx]-readmap-&gt;orgheightmap[idx] + delta * 0.5f);
 			} else {
-				cost=max(3.f,readmap-&gt;orgheightmap[z*(gs-&gt;mapx+1)+x]-heightmap[z*(gs-&gt;mapx+1)+x]-delta*0.5f);
+				cost = max(3.0f, readmap-&gt;orgheightmap[idx] - heightmap[idx] - delta * 0.5f);
 			}
-			tcost+=fabs(delta)*cost;
+			tcost += fabs(delta) * cost;
 		}
 	}
 

Modified: branches/0.77-branch/rts/System/Demo.cpp
===================================================================
--- branches/0.77-branch/rts/System/Demo.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/System/Demo.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -1,3 +1,4 @@
+#include &quot;StdAfx.h&quot;
 #include &quot;Demo.h&quot;
 
 CDemo::CDemo()

Modified: branches/0.77-branch/rts/System/DemoReader.cpp
===================================================================
--- branches/0.77-branch/rts/System/DemoReader.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/System/DemoReader.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -1,3 +1,4 @@
+#include &quot;StdAfx.h&quot;
 #include &quot;DemoReader.h&quot;
 
 #include &lt;limits.h&gt;

Modified: branches/0.77-branch/rts/System/DemoRecorder.cpp
===================================================================
--- branches/0.77-branch/rts/System/DemoRecorder.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/System/DemoRecorder.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -1,3 +1,4 @@
+#include &quot;StdAfx.h&quot;
 #include &quot;DemoRecorder.h&quot;
 
 #include &lt;assert.h&gt;

Modified: branches/0.77-branch/rts/System/GlobalStuff.cpp
===================================================================
--- branches/0.77-branch/rts/System/GlobalStuff.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/System/GlobalStuff.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -125,7 +125,6 @@
 	for(int a = 0; a &lt; MAX_PLAYERS; ++a) {
 		players[a] = SAFE_NEW CPlayer();
 		players[a]-&gt;playerNum = a;
-		players[a]-&gt;team = 0;
 	}
 
 	for (int a = 0; a &lt; MAX_TEAMS; ++a) {
@@ -169,11 +168,7 @@
 	
 	for (unsigned i = 0; i &lt; static_cast&lt;unsigned&gt;(setup-&gt;numPlayers); ++i)
 	{
-		gs-&gt;players[i]-&gt;team = setup-&gt;playerStartingData[i].team;
-		gs-&gt;players[i]-&gt;rank = setup-&gt;playerStartingData[i].rank;
-		gs-&gt;players[i]-&gt;playerName  = setup-&gt;playerStartingData[i].name;
-		gs-&gt;players[i]-&gt;countryCode = setup-&gt;playerStartingData[i].countryCode;
-		gs-&gt;players[i]-&gt;spectator = setup-&gt;playerStartingData[i].spectator;
+		static_cast&lt;PlayerBase&gt;(*players[i]) = setup-&gt;playerStartingData[i];
 	}
 	
 	for (unsigned i = 0; i &lt; static_cast&lt;unsigned&gt;(activeTeams); ++i)
@@ -273,7 +268,7 @@
 int CGlobalSyncedStuff::Player(const std::string&amp; name)
 {
 	for (int i = 0; i &lt; MAX_PLAYERS; ++i) {
-		if (players[i] &amp;&amp; players[i]-&gt;playerName == name) {
+		if (players[i] &amp;&amp; players[i]-&gt;name == name) {
 			return i;
 		}
 	}

Modified: branches/0.77-branch/rts/System/Script/LuaBinder.cpp
===================================================================
--- branches/0.77-branch/rts/System/Script/LuaBinder.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/System/Script/LuaBinder.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -204,7 +204,9 @@
 		class_&lt;float3, SFloat3&gt;(&quot;float3&quot;)
 			.def(constructor&lt;const float, const float, const float&gt;()),
 
+
 		class_&lt;CWorldObject&gt;(&quot;WorldObject&quot;)
+			.def_readonly(&quot;id&quot;, &amp;CWorldObject::id)
 			.def_readonly(&quot;pos&quot;, &amp;CWorldObject::pos),
 
 		class_&lt;CUnit, bases&lt;CWorldObject&gt;, CObject_pointer&lt;CUnit&gt; &gt;(&quot;Unit&quot;)
@@ -213,7 +215,6 @@
 				value(&quot;GIVEN&quot;, CUnit::ChangeGiven),
 				value(&quot;CAPTURED&quot;, CUnit::ChangeCaptured)
 			]
-			.def_readonly(&quot;id&quot;, &amp;CUnit::id)
 			.def_readonly(&quot;health&quot;, &amp;CUnit::health)
 			.property(&quot;transporter&quot;, &amp;UnitGetTransporter)
 			.def_readonly(&quot;definition&quot;, &amp;CUnit::unitDef)
@@ -230,7 +231,6 @@
 			.def_readonly(&quot;energystorage&quot;, &amp;CTeam::energyStorage),
 
 		class_&lt;CFeature, bases&lt;CWorldObject&gt;, CObject_pointer&lt;CFeature&gt; &gt;(&quot;Feature&quot;)
-		    .def_readonly(&quot;id&quot;, &amp;CFeature::id )
 		    .def_readonly(&quot;definition&quot;, &amp;CFeature::def )
 			.def(&quot;remainingmetal&quot;, &amp;CFeature::RemainingMetal )
 			.def(&quot;remainingenergy&quot;, &amp;CFeature::RemainingEnergy )

Modified: branches/0.77-branch/rts/System/StdAfx.h
===================================================================
--- branches/0.77-branch/rts/System/StdAfx.h	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/System/StdAfx.h	2008-08-20 14:38:09 UTC (rev 6278)
@@ -72,6 +72,9 @@
 #include &lt;stdexcept&gt;
 #include &lt;string&gt;
 #include &lt;cctype&gt;
+#include &lt;string&gt;
+#include &lt;cstring&gt;
+#include &lt;cctype&gt;
 
 /**
  * content_error

Modified: branches/0.77-branch/rts/build/vstudio8/rts.vcproj
===================================================================
--- branches/0.77-branch/rts/build/vstudio8/rts.vcproj	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/build/vstudio8/rts.vcproj	2008-08-20 14:38:09 UTC (rev 6278)
@@ -1,7 +1,7 @@
 &lt;?xml version=&quot;1.0&quot; encoding=&quot;Windows-1252&quot;?&gt;
 &lt;VisualStudioProject
 	ProjectType=&quot;Visual C++&quot;
-	Version=&quot;8.00&quot;
+	Version=&quot;8,00&quot;
 	Name=&quot;rts&quot;
 	ProjectGUID=&quot;{A0F70264-A7B7-4FE7-A5BE-298CD3A0758F}&quot;
 	RootNamespace=&quot;rts&quot;
@@ -596,16 +596,12 @@
 			&lt;File
 				RelativePath=&quot;..\..\Game\Action.cpp&quot;
 				&gt;
-				&lt;FileConfiguration
-					Name=&quot;Debug|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
 			&lt;/File&gt;
 			&lt;File
+				RelativePath=&quot;..\..\Game\Action.h&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
 				RelativePath=&quot;..\..\Game\Camera.cpp&quot;
 				&gt;
 			&lt;/File&gt;
@@ -616,46 +612,6 @@
 			&lt;File
 				RelativePath=&quot;..\..\Game\CameraHandler.cpp&quot;
 				&gt;
-				&lt;FileConfiguration
-					Name=&quot;Debug|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
-				&lt;FileConfiguration
-					Name=&quot;No debug|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
-				&lt;FileConfiguration
-					Name=&quot;Release with error catching|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
-				&lt;FileConfiguration
-					Name=&quot;Syncdebug|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
-				&lt;FileConfiguration
-					Name=&quot;Release+MT with error catching|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
 			&lt;/File&gt;
 			&lt;File
 				RelativePath=&quot;..\..\Game\CameraHandler.h&quot;
@@ -664,26 +620,14 @@
 			&lt;File
 				RelativePath=&quot;..\..\Game\ChatMessage.cpp&quot;
 				&gt;
-				&lt;FileConfiguration
-					Name=&quot;Debug|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
 			&lt;/File&gt;
 			&lt;File
+				RelativePath=&quot;..\..\Game\ChatMessage.h&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
 				RelativePath=&quot;..\..\Game\CommandMessage.cpp&quot;
 				&gt;
-				&lt;FileConfiguration
-					Name=&quot;Debug|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
 			&lt;/File&gt;
 			&lt;File
 				RelativePath=&quot;..\..\Game\CommandMessage.h&quot;
@@ -692,16 +636,12 @@
 			&lt;File
 				RelativePath=&quot;..\..\Game\Console.cpp&quot;
 				&gt;
-				&lt;FileConfiguration
-					Name=&quot;Debug|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
 			&lt;/File&gt;
 			&lt;File
+				RelativePath=&quot;..\..\Game\Console.h&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
 				RelativePath=&quot;..\..\Game\ConsoleHistory.cpp&quot;
 				&gt;
 			&lt;/File&gt;
@@ -728,46 +668,6 @@
 			&lt;File
 				RelativePath=&quot;..\..\Game\GameData.cpp&quot;
 				&gt;
-				&lt;FileConfiguration
-					Name=&quot;Debug|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
-				&lt;FileConfiguration
-					Name=&quot;No debug|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
-				&lt;FileConfiguration
-					Name=&quot;Release with error catching|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
-				&lt;FileConfiguration
-					Name=&quot;Syncdebug|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
-				&lt;FileConfiguration
-					Name=&quot;Release+MT with error catching|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
 			&lt;/File&gt;
 			&lt;File
 				RelativePath=&quot;..\..\Game\GameData.h&quot;
@@ -784,46 +684,6 @@
 			&lt;File
 				RelativePath=&quot;..\..\Game\GameServer.cpp&quot;
 				&gt;
-				&lt;FileConfiguration
-					Name=&quot;Debug|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
-				&lt;FileConfiguration
-					Name=&quot;No debug|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
-				&lt;FileConfiguration
-					Name=&quot;Release with error catching|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
-				&lt;FileConfiguration
-					Name=&quot;Syncdebug|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
-				&lt;FileConfiguration
-					Name=&quot;Release+MT with error catching|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
 			&lt;/File&gt;
 			&lt;File
 				RelativePath=&quot;..\..\Game\GameServer.h&quot;
@@ -838,107 +698,27 @@
 				&gt;
 			&lt;/File&gt;
 			&lt;File
-				RelativePath=&quot;..\..\Game\GameSetupData.cpp&quot;
+				RelativePath=&quot;..\..\Game\GameVersion.cpp&quot;
 				&gt;
-				&lt;FileConfiguration
-					Name=&quot;Debug|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
-				&lt;FileConfiguration
-					Name=&quot;No debug|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
-				&lt;FileConfiguration
-					Name=&quot;Release with error catching|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
-				&lt;FileConfiguration
-					Name=&quot;Syncdebug|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
-				&lt;FileConfiguration
-					Name=&quot;Release+MT with error catching|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
 			&lt;/File&gt;
 			&lt;File
-				RelativePath=&quot;..\..\Game\GameSetupData.h&quot;
+				RelativePath=&quot;..\..\Game\GameVersion.h&quot;
 				&gt;
 			&lt;/File&gt;
 			&lt;File
-				RelativePath=&quot;..\..\Game\GameVersion.cpp&quot;
+				RelativePath=&quot;..\..\Game\Player.cpp&quot;
 				&gt;
-				&lt;FileConfiguration
-					Name=&quot;Debug|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
-				&lt;FileConfiguration
-					Name=&quot;No debug|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
-				&lt;FileConfiguration
-					Name=&quot;Release with error catching|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
-				&lt;FileConfiguration
-					Name=&quot;Syncdebug|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
-				&lt;FileConfiguration
-					Name=&quot;Release+MT with error catching|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
 			&lt;/File&gt;
 			&lt;File
-				RelativePath=&quot;..\..\Game\GameVersion.h&quot;
+				RelativePath=&quot;..\..\Game\Player.h&quot;
 				&gt;
 			&lt;/File&gt;
 			&lt;File
-				RelativePath=&quot;..\..\Game\Player.cpp&quot;
+				RelativePath=&quot;..\..\Game\PlayerBase.cpp&quot;
 				&gt;
 			&lt;/File&gt;
 			&lt;File
-				RelativePath=&quot;..\..\Game\Player.h&quot;
+				RelativePath=&quot;..\..\Game\PlayerBase.h&quot;
 				&gt;
 			&lt;/File&gt;
 			&lt;File
@@ -2313,6 +2093,14 @@
 				RelativePath=&quot;..\..\Sim\ModInfo.h&quot;
 				&gt;
 			&lt;/File&gt;
+			&lt;File
+				RelativePath=&quot;..\..\Sim\SideParser.cpp&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
+				RelativePath=&quot;..\..\Sim\SideParser.h&quot;
+				&gt;
+			&lt;/File&gt;
 			&lt;Filter
 				Name=&quot;Units&quot;
 				&gt;
@@ -3578,6 +3366,22 @@
 				&gt;
 			&lt;/File&gt;
 			&lt;File
+				RelativePath=&quot;..\..\System\EventClient.cpp&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
+				RelativePath=&quot;..\..\System\EventClient.h&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
+				RelativePath=&quot;..\..\System\EventHandler.cpp&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
+				RelativePath=&quot;..\..\System\EventHandler.h&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
 				RelativePath=&quot;..\..\System\FastMath.h&quot;
 				&gt;
 			&lt;/File&gt;
@@ -4956,38 +4760,6 @@
 				&lt;File
 					RelativePath=&quot;..\..\System\Platform\BaseCmd.cpp&quot;
 					&gt;
-					&lt;FileConfiguration
-						Name=&quot;No debug|Win32&quot;
-						&gt;
-						&lt;Tool
-							Name=&quot;VCCLCompilerTool&quot;
-							UsePrecompiledHeader=&quot;0&quot;
-						/&gt;
-					&lt;/FileConfiguration&gt;
-					&lt;FileConfiguration
-						Name=&quot;Release with error catching|Win32&quot;
-						&gt;
-						&lt;Tool
-							Name=&quot;VCCLCompilerTool&quot;
-							UsePrecompiledHeader=&quot;0&quot;
-						/&gt;
-					&lt;/FileConfiguration&gt;
-					&lt;FileConfiguration
-						Name=&quot;Syncdebug|Win32&quot;
-						&gt;
-						&lt;Tool
-							Name=&quot;VCCLCompilerTool&quot;
-							UsePrecompiledHeader=&quot;0&quot;
-						/&gt;
-					&lt;/FileConfiguration&gt;
-					&lt;FileConfiguration
-						Name=&quot;Release+MT with error catching|Win32&quot;
-						&gt;
-						&lt;Tool
-							Name=&quot;VCCLCompilerTool&quot;
-							UsePrecompiledHeader=&quot;0&quot;
-						/&gt;
-					&lt;/FileConfiguration&gt;
 				&lt;/File&gt;
 				&lt;File
 					RelativePath=&quot;..\..\System\Platform\BaseCmd.h&quot;
@@ -5002,52 +4774,12 @@
 					&gt;
 				&lt;/File&gt;
 				&lt;File
-					RelativePath=&quot;..\..\System\Platform\Clipboard.cpp&quot;
-					&gt;
-				&lt;/File&gt;
-				&lt;File
 					RelativePath=&quot;..\..\System\Platform\Clipboard.h&quot;
 					&gt;
 				&lt;/File&gt;
 				&lt;File
-					RelativePath=&quot;..\..\System\Platform\Clipboard.h&quot;
-					&gt;
-				&lt;/File&gt;
-				&lt;File
 					RelativePath=&quot;..\..\System\Platform\ConfigHandler.cpp&quot;
 					&gt;
-					&lt;FileConfiguration
-						Name=&quot;No debug|Win32&quot;
-						&gt;
-						&lt;Tool
-							Name=&quot;VCCLCompilerTool&quot;
-							UsePrecompiledHeader=&quot;0&quot;
-						/&gt;
-					&lt;/FileConfiguration&gt;
-					&lt;FileConfiguration
-						Name=&quot;Release with error catching|Win32&quot;
-						&gt;
-						&lt;Tool
-							Name=&quot;VCCLCompilerTool&quot;
-							UsePrecompiledHeader=&quot;0&quot;
-						/&gt;
-					&lt;/FileConfiguration&gt;
-					&lt;FileConfiguration
-						Name=&quot;Syncdebug|Win32&quot;
-						&gt;
-						&lt;Tool
-							Name=&quot;VCCLCompilerTool&quot;
-							UsePrecompiledHeader=&quot;0&quot;
-						/&gt;
-					&lt;/FileConfiguration&gt;
-					&lt;FileConfiguration
-						Name=&quot;Release+MT with error catching|Win32&quot;
-						&gt;
-						&lt;Tool
-							Name=&quot;VCCLCompilerTool&quot;
-							UsePrecompiledHeader=&quot;0&quot;
-						/&gt;
-					&lt;/FileConfiguration&gt;
 				&lt;/File&gt;
 				&lt;File
 					RelativePath=&quot;..\..\System\Platform\ConfigHandler.h&quot;
@@ -5070,6 +4802,10 @@
 					&gt;
 				&lt;/File&gt;
 				&lt;File
+					RelativePath=&quot;..\..\System\Platform\NullSound.h&quot;
+					&gt;
+				&lt;/File&gt;
+				&lt;File
 					RelativePath=&quot;..\..\System\Platform\SharedLib.cpp&quot;
 					&gt;
 				&lt;/File&gt;
@@ -6648,11 +6384,11 @@
 				&gt;
 			&lt;/File&gt;
 			&lt;File
-				RelativePath=&quot;..\..\Lua\LuaCallInHandler.cpp&quot;
+				RelativePath=&quot;..\..\Lua\LuaCallInCheck.cpp&quot;
 				&gt;
 			&lt;/File&gt;
 			&lt;File
-				RelativePath=&quot;..\..\Lua\LuaCallInHandler.h&quot;
+				RelativePath=&quot;..\..\Lua\LuaCallInCheck.h&quot;
 				&gt;
 			&lt;/File&gt;
 			&lt;File
@@ -6698,46 +6434,6 @@
 			&lt;File
 				RelativePath=&quot;..\..\Lua\LuaFBOs.cpp&quot;
 				&gt;
-				&lt;FileConfiguration
-					Name=&quot;Debug|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
-				&lt;FileConfiguration
-					Name=&quot;No debug|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
-				&lt;FileConfiguration
-					Name=&quot;Release with error catching|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
-				&lt;FileConfiguration
-					Name=&quot;Syncdebug|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
-				&lt;FileConfiguration
-					Name=&quot;Release+MT with error catching|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
 			&lt;/File&gt;
 			&lt;File
 				RelativePath=&quot;..\..\Lua\LuaFBOs.h&quot;
@@ -6780,6 +6476,22 @@
 				&gt;
 			&lt;/File&gt;
 			&lt;File
+				RelativePath=&quot;..\..\Lua\LuaInputReceiver.cpp&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
+				RelativePath=&quot;..\..\Lua\LuaInputReceiver.h&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
+				RelativePath=&quot;..\..\Lua\LuaIO.cpp&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
+				RelativePath=&quot;..\..\Lua\LuaIO.h&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
 				RelativePath=&quot;..\..\Lua\LuaMaterial.cpp&quot;
 				&gt;
 			&lt;/File&gt;
@@ -6814,46 +6526,6 @@
 			&lt;File
 				RelativePath=&quot;..\..\Lua\LuaRBOs.cpp&quot;
 				&gt;
-				&lt;FileConfiguration
-					Name=&quot;Debug|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
-				&lt;FileConfiguration
-					Name=&quot;No debug|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
-				&lt;FileConfiguration
-					Name=&quot;Release with error catching|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
-				&lt;FileConfiguration
-					Name=&quot;Syncdebug|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
-				&lt;FileConfiguration
-					Name=&quot;Release+MT with error catching|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
 			&lt;/File&gt;
 			&lt;File
 				RelativePath=&quot;..\..\Lua\LuaRBOs.h&quot;
@@ -6870,46 +6542,6 @@
 			&lt;File
 				RelativePath=&quot;..\..\Lua\LuaScream.cpp&quot;
 				&gt;
-				&lt;FileConfiguration
-					Name=&quot;Debug|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
-				&lt;FileConfiguration
-					Name=&quot;No debug|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
-				&lt;FileConfiguration
-					Name=&quot;Release with error catching|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
-				&lt;FileConfiguration
-					Name=&quot;Syncdebug|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
-				&lt;FileConfiguration
-					Name=&quot;Release+MT with error catching|Win32&quot;
-					&gt;
-					&lt;Tool
-						Name=&quot;VCCLCompilerTool&quot;
-						UsePrecompiledHeader=&quot;0&quot;
-					/&gt;
-				&lt;/FileConfiguration&gt;
 			&lt;/File&gt;
 			&lt;File
 				RelativePath=&quot;..\..\Lua\LuaScream.h&quot;

Modified: branches/0.77-branch/rts/lib/hpiutil2/hpiutil.cpp
===================================================================
--- branches/0.77-branch/rts/lib/hpiutil2/hpiutil.cpp	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/rts/lib/hpiutil2/hpiutil.cpp	2008-08-20 14:38:09 UTC (rev 6278)
@@ -22,6 +22,8 @@
 
 #include &quot;hpiutil.h&quot;
 
+#include &lt;string.h&gt;
+
 #ifdef _MSC_VER
 #define STRCASECMP stricmp
 #else

Modified: branches/0.77-branch/tools/DedicatedServer/CMakeLists.txt
===================================================================
--- branches/0.77-branch/tools/DedicatedServer/CMakeLists.txt	2008-08-20 13:20:29 UTC (rev 6277)
+++ branches/0.77-branch/tools/DedicatedServer/CMakeLists.txt	2008-08-20 14:38:09 UTC (rev 6278)
@@ -46,6 +46,7 @@
 	../../rts/Game/GameServer
 	../../rts/Game/GameSetup
 	../../rts/Game/GameData
+	../../rts/Game/PlayerBase
 	../../rts/Game/GameVersion
 	../../rts/Game/CommandMessage
 	../../rts/Game/ChatMessage


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001047.html">[Taspring-linux-commit] r6277 - trunk/Lobby/TASClient
</A></li>
	<LI>Next message: <A HREF="001049.html">[Taspring-linux-commit] r6279 - branches/0.77-branch/rts/Game
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1048">[ date ]</a>
              <a href="thread.html#1048">[ thread ]</a>
              <a href="subject.html#1048">[ subject ]</a>
              <a href="author.html#1048">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
