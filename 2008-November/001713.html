<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r6944 - in trunk: Documentation	rts/ExternalAI rts/Game rts/Rendering/GL rts/System	tools/DedicatedServer
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-November/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6944%20-%20in%20trunk%3A%20Documentation%0A%09rts/ExternalAI%20rts/Game%20rts/Rendering/GL%20rts/System%0A%09tools/DedicatedServer&In-Reply-To=%3C20081101142000.3ADAA4743%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001712.html">
   <LINK REL="Next"  HREF="001714.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r6944 - in trunk: Documentation	rts/ExternalAI rts/Game rts/Rendering/GL rts/System	tools/DedicatedServer</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6944%20-%20in%20trunk%3A%20Documentation%0A%09rts/ExternalAI%20rts/Game%20rts/Rendering/GL%20rts/System%0A%09tools/DedicatedServer&In-Reply-To=%3C20081101142000.3ADAA4743%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r6944 - in trunk: Documentation	rts/ExternalAI rts/Game rts/Rendering/GL rts/System	tools/DedicatedServer">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Sat Nov  1 15:19:59 CET 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001712.html">[Taspring-linux-commit] r6943 - in branches/gmltest/rts: System	lib/gml
</A></li>
        <LI>Next message: <A HREF="001714.html">[Taspring-linux-commit] r6945 - trunk/tools/DedicatedServer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1713">[ date ]</a>
              <a href="thread.html#1713">[ thread ]</a>
              <a href="subject.html#1713">[ subject ]</a>
              <a href="author.html#1713">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: Auswaschbar
Date: 2008-11-01 15:19:58 +0100 (Sat, 01 Nov 2008)
New Revision: 6944

Modified:
   trunk/Documentation/Spring start.txt
   trunk/rts/ExternalAI/AICallback.cpp
   trunk/rts/ExternalAI/GlobalAIHandler.cpp
   trunk/rts/Game/Game.cpp
   trunk/rts/Game/GameData.cpp
   trunk/rts/Game/GameData.h
   trunk/rts/Game/GameServer.cpp
   trunk/rts/Game/GameServer.h
   trunk/rts/Game/GameSetup.cpp
   trunk/rts/Game/GameSetup.h
   trunk/rts/Game/PreGame.cpp
   trunk/rts/Game/PreGame.h
   trunk/rts/Game/SelectMenu.cpp
   trunk/rts/Game/SelectMenu.h
   trunk/rts/Rendering/GL/glList.h
   trunk/rts/System/DemoReader.cpp
   trunk/rts/System/DemoRecorder.cpp
   trunk/rts/System/DemoRecorder.h
   trunk/rts/System/NetProtocol.cpp
   trunk/rts/System/NetProtocol.h
   trunk/rts/System/SpringApp.cpp
   trunk/tools/DedicatedServer/main.cpp
Log:
* create a default, 2-player setupscript when starting from commandline
* create a default 1-player setupscript when giving a demofile on commandline
* send the gamesetup to each client once they join the server
* boost::bind-ified glList to work on non-static member functions
* updated springstart.txt


Modified: trunk/Documentation/Spring start.txt
===================================================================
--- trunk/Documentation/Spring start.txt	2008-11-01 13:46:27 UTC (rev 6943)
+++ trunk/Documentation/Spring start.txt	2008-11-01 14:19:58 UTC (rev 6944)
@@ -1,26 +1,19 @@
-// Send a file formated like this as the only command line argument to the
-// spring executable.  All players must get the exact same file except
-// MyPlayerNum, HostIP, SourcePort, PLAYER\CountryCode, PLAYER\Rank,
-// and possibly TEAM\AIDLL.
+// A clients example
+// If spring is started as client, it needs the following information to work properly
 
-// Since december 2007 the restrictions on player/team/allyteam numbering are
-// loosened:
+[GAME]
+{
+	HostIP=xxx.xxx.xxx.xxx;
+	HostPort=xxx;       // standard is 8452
+	SourcePort=0;       // set this if you want a different source port (as client), 0 means OS-select
 
-// Players and teams must be in the same order on each client, but the
-// numbering does not need to be consecutive, or even identical on each client:
-// the sequences of players/teams/allyteams may contain gaps.
+	MyPlayerNum=x;      //only variable that should vary between different players, (deprecated, if you want to use this you need the full script, even as client)
+	MyPlayerName=somename; //can be used instead of MyPlayerNum
+	IsHost=x;			// 0 - no server will be started in this instance, 1 - start a server (if you don't set this, you need the full script and myPlayerNum to work)
+}
 
-// For example, one may define NumPlayers=2 and add a PLAYER10 and PLAYER14
-// section to the script, and Spring will automatically compress this
-// internally to PLAYER0 and PLAYER1. Same applies to teams and allyteams.
-
-// The used numbers must be lower than the maximum number of those sections.
-// At the time of this writing this is: 32/17/17 for players/teams/allyteams
-// respectively.
-
-// From now on, the Gametype, Mapname and the Scriptname-tags are only needed for the gamehost
-// a client will ignore these tags because he recieves everything from the server
-
+// A host example
+// note that the same values for clients also need to set here
 [GAME]
 {
 	Mapname=;           //with .smf extension
@@ -31,19 +24,20 @@
 	Demofile=demo.sdf;  // if set this game is a multiplayer demo replay
 	Savefile=save.ssf;  // if set this game is a continuation of a saved game
 
-	HostIP=xxx.xxx.xxx.xxx;
+	HostIP=xxx.xxx.xxx.xxx; // you normally won't set this as host
 	HostPort=xxx;       // usually 8452
 	SourcePort=0;       // set this if you want a different source port (as client)
 	AutohostPort=X;     // communicate with spring, specify the port you are listening (as host)
 
-	MyPlayerNum=x;      //only variable that should vary between different players
+	MyPlayerNum=x;      //only variable that should vary between different players, deprecated
 	MyPlayerName=somename; //can be used instead of MyPlayerNum (will overwrite it in fact)
 
+	IsHost=x;			// 0 - no server will be started in this instance, 1 - start a server
 	NumPlayers=x;       // not mandatory, but can be used for debugging purposes
 	NumTeams=y;         // same here, set this to check if the script is right
 	NumAllyTeams=z;     // see above
 
-	// a player (player 0 is the host)
+	// a player (player 0 is the host only if IsHost is not set)
 	[PLAYER0]
 	{
 		Name=name;

Modified: trunk/rts/ExternalAI/AICallback.cpp
===================================================================
--- trunk/rts/ExternalAI/AICallback.cpp	2008-11-01 13:46:27 UTC (rev 6943)
+++ trunk/rts/ExternalAI/AICallback.cpp	2008-11-01 14:19:58 UTC (rev 6944)
@@ -1344,7 +1344,7 @@
 			return true;
 		}
 		case AIVAL_SCRIPT: {
-			*(const char**) data = gameSetup ? gameSetup-&gt;gameSetupText : &quot;&quot;;
+			*(const char**) data = gameSetup ? gameSetup-&gt;gameSetupText.c_str() : &quot;&quot;;
 			return true;
 		}
 		default:

Modified: trunk/rts/ExternalAI/GlobalAIHandler.cpp
===================================================================
--- trunk/rts/ExternalAI/GlobalAIHandler.cpp	2008-11-01 13:46:27 UTC (rev 6943)
+++ trunk/rts/ExternalAI/GlobalAIHandler.cpp	2008-11-01 14:19:58 UTC (rev 6944)
@@ -223,10 +223,6 @@
 		return false;
 	}
 
-	if (net-&gt;localDemoPlayback) {
-		return false;
-	}
-
 	if (strncmp(dll, &quot;LuaAI:&quot;, 6) == 0) {
 		CTeam* team = gs-&gt;Team(teamID);
 		if (team != NULL) {

Modified: trunk/rts/Game/Game.cpp
===================================================================
--- trunk/rts/Game/Game.cpp	2008-11-01 13:46:27 UTC (rev 6943)
+++ trunk/rts/Game/Game.cpp	2008-11-01 14:19:58 UTC (rev 6944)
@@ -446,11 +446,7 @@
 	globalAI = SAFE_NEW CGlobalAIHandler();
 
 	CPlayer* p = gs-&gt;players[gu-&gt;myPlayerNum];
-	if(!gameSetup || net-&gt;localDemoPlayback) {
-		p-&gt;name = configHandler.GetString(&quot;name&quot;, &quot;&quot;);
-	} else {
-		GameSetupDrawer::Enable();
-	}
+	GameSetupDrawer::Enable();
 
 	if (gs-&gt;useLuaRules) {
 		PrintLoadMsg(&quot;Loading LuaRules&quot;);
@@ -522,9 +518,6 @@
 	//sending your playername to the server indicates that you are finished loading
 	net-&gt;Send(CBaseNetProtocol::Get().SendPlayerName(gu-&gt;myPlayerNum, p-&gt;name));
 
-	if (net-&gt;localDemoPlayback) // auto-start when playing a demo in local mode
-		net-&gt;Send(CBaseNetProtocol::Get().SendStartPlaying(0));
-
 	lastCpuUsageTime = gu-&gt;gameTime + 10;
 
 	mouse-&gt;ShowMouse();
@@ -1077,7 +1070,7 @@
 		camMove[7]=true;
 	}
 	else if (cmd == &quot;team&quot;){
-		if (gs-&gt;cheatEnabled || net-&gt;localDemoPlayback)
+		if (gs-&gt;cheatEnabled)
 		{
 			int team=atoi(action.extra.c_str());
 			if ((team &gt;= 0) &amp;&amp; (team &lt;gs-&gt;activeTeams)) {
@@ -1110,7 +1103,7 @@
 	else if (cmd == &quot;ally&quot;){
 		if (action.extra.size() &gt; 0)
 		{
-			if (gameSetup &amp;&amp; !gameSetup-&gt;fixedAllies)
+			if (!gameSetup-&gt;fixedAllies)
 			{
 				std::istringstream is(action.extra);
 				int otherAllyTeam = -1;
@@ -1784,7 +1777,7 @@
 		}
 	}
 	else if (cmd == &quot;allmapmarks&quot;) {
-		if (gs-&gt;cheatEnabled &amp;&amp; !net-&gt;localDemoPlayback) {
+		if (gs-&gt;cheatEnabled) {
 			if (action.extra.empty()) {
 				inMapDrawer-&gt;ToggleAllVisible();
 			} else {
@@ -2540,22 +2533,6 @@
 		}
 	}
 
-	if (gameServer &amp;&amp; !gameServer-&gt;GameHasStarted() &amp;&amp; !gameSetup) {
-		bool allReady = true;
-		for (int a = 0; a &lt; gs-&gt;activePlayers; a++) {
-			if(gs-&gt;players[a]-&gt;active &amp;&amp; !gs-&gt;players[a]-&gt;readyToStart) {
-				allReady = false;
-				break;
-			}
-		}
-		if (allReady &amp;&amp; (keys[SDLK_RETURN] || script-&gt;onlySinglePlayer)) {
-			chatting = false;
-			userWriting = false;
-			writingPos = 0;
-			net-&gt;Send(CBaseNetProtocol::Get().SendStartPlaying(0));
-		}
-	}
-
 	return true;
 }
 
@@ -2902,11 +2879,6 @@
 		}
 	}
 
-	if (gameServer &amp;&amp; gameServer-&gt;WaitsOnCon() &amp;&amp; !gameSetup) {
-		glColor3f(1.0f, 1.0f, 1.0f);
-		font-&gt;glPrintCentered (0.5f, 0.5f, 1.5f, &quot;Waiting for connections. Press return to start&quot;);
-	}
-
 	if (userWriting) {
 		DrawInputText();
 	}
@@ -3583,7 +3555,7 @@
 			case NETMSG_STARTPOS:{
 				unsigned player = inbuf[1];
 				int team = inbuf[2];
-				if ((team &gt;= gs-&gt;activeTeams) || (team &lt; 0) || !gameSetup) {
+				if ((team &gt;= gs-&gt;activeTeams) || (team &lt; 0)) {
 					logOutput.Print(&quot;Got invalid team num %i in startpos msg&quot;,team);
 				} else {
 					float3 pos(*(float*)&amp;inbuf[4],
@@ -3651,7 +3623,7 @@
 #endif
 				AddTraffic(-1, packetCode, dataLength);
 
-				if (creatingVideo &amp;&amp; net-&gt;localDemoPlayback) {
+				if (creatingVideo) {
 					POP_CODE_MODE;
 					return;
 				}
@@ -4501,13 +4473,8 @@
 		// Write CPlayer::Statistics and CTeam::Statistics to demo
 		int numPlayers;
 		// FIXME: ugh, there should be a better way to figure out number of players ...
-		if (gameSetup != NULL) {
-			numPlayers = gameSetup-&gt;numPlayers;
-		} else {
-			numPlayers = 0;
-			while (gs-&gt;players[numPlayers]-&gt;currentStats-&gt;mousePixels != 0)
-				++numPlayers;
-		}
+		numPlayers = gameSetup-&gt;numPlayers;
+
 		int numTeams = gs-&gt;activeAllyTeams;
 		if (gs-&gt;useLuaGaia) {
 			--numTeams;

Modified: trunk/rts/Game/GameData.cpp
===================================================================
--- trunk/rts/Game/GameData.cpp	2008-11-01 13:46:27 UTC (rev 6943)
+++ trunk/rts/Game/GameData.cpp	2008-11-01 14:19:58 UTC (rev 6944)
@@ -21,6 +21,7 @@
 {
 	assert(pckt-&gt;data[0] == NETMSG_GAMEDATA);
 	UnpackPacket packet(pckt, 3);
+	packet &gt;&gt; setupText;
 	packet &gt;&gt; script;
 	packet &gt;&gt; map;
 	packet &gt;&gt; mapChecksum;
@@ -31,9 +32,10 @@
 
 const netcode::RawPacket* GameData::Pack() const
 {
-	unsigned short size = 3 + 2*sizeof(unsigned) + map.size() + mod.size() + script.size() + 4 + 3;
+	unsigned short size = 3 + 2*sizeof(unsigned) + setupText.size()+1 + map.size() + mod.size() + script.size() + 4 + 3;
 	PackPacket* buffer = new PackPacket(size, NETMSG_GAMEDATA);
 	*buffer &lt;&lt; size;
+	*buffer &lt;&lt; setupText;
 	*buffer &lt;&lt; script;
 	*buffer &lt;&lt; map;
 	*buffer &lt;&lt; mapChecksum;
@@ -43,6 +45,11 @@
 	return buffer;
 }
 
+void GameData::SetSetup(const std::string&amp; newSetup)
+{
+	setupText = newSetup;
+}
+
 void GameData::SetScript(const std::string&amp; newScript)
 {
 	script = newScript;

Modified: trunk/rts/Game/GameData.h
===================================================================
--- trunk/rts/Game/GameData.h	2008-11-01 13:46:27 UTC (rev 6943)
+++ trunk/rts/Game/GameData.h	2008-11-01 14:19:58 UTC (rev 6944)
@@ -16,11 +16,13 @@
 	
 	const netcode::RawPacket* Pack() const;
 	
+	void SetSetup(const std::string&amp; newSetup);
 	void SetScript(const std::string&amp; newScript);
 	void SetMap(const std::string&amp; newMap, const unsigned checksum);
 	void SetMod(const std::string&amp; newMod, const unsigned checksum);
 	void SetRandomSeed(const unsigned seed);
 	
+	const std::string&amp; GetSetup() const {return setupText;};
 	const std::string&amp; GetScript() const {return script;};
 	const std::string&amp; GetMap() const {return map;};
 	unsigned GetMapChecksum() const {return mapChecksum;};
@@ -29,6 +31,8 @@
 	unsigned GetRandomSeed() const {return randomSeed;};
 
 private:
+	std::string setupText;
+
 	std::string script;
 	std::string map;
 	unsigned mapChecksum;

Modified: trunk/rts/Game/GameServer.cpp
===================================================================
--- trunk/rts/Game/GameServer.cpp	2008-11-01 13:46:27 UTC (rev 6943)
+++ trunk/rts/Game/GameServer.cpp	2008-11-01 14:19:58 UTC (rev 6944)
@@ -97,9 +97,10 @@
 
 CGameServer* gameServer=0;
 
-CGameServer::CGameServer(int port, bool onlyLocal, const GameData* const newGameData, const CGameSetup* const mysetup = 0, const std::string&amp; demoName)
+CGameServer::CGameServer(int port, bool onlyLocal, const GameData* const newGameData, const CGameSetup* const mysetup)
 : setup(mysetup)
 {
+	assert(setup);
 	serverStartTime = SDL_GetTicks();
 	delayedSyncResponseFrame = 0;
 	syncErrorFrame=0;
@@ -134,22 +135,15 @@
 
 	lastTick = SDL_GetTicks();
 
-	if (setup) {
-		maxUserSpeed = setup-&gt;maxSpeed;
-		minUserSpeed = setup-&gt;minSpeed;
-		noHelperAIs = (bool)setup-&gt;noHelperAIs;
-	}
-	else
-	{
-		maxUserSpeed=5;
-		minUserSpeed=0.3f;
-	}
+	maxUserSpeed = setup-&gt;maxSpeed;
+	minUserSpeed = setup-&gt;minSpeed;
+	noHelperAIs = (bool)setup-&gt;noHelperAIs;
 
 	gameData.reset(newGameData);
-	if (!demoName.empty())
+	if (setup-&gt;hostDemo)
 	{
-		Message(str( format(PlayingDemo) %demoName ));
-		demoReader.reset(new CDemoReader(demoName, modGameTime+0.1f));
+		Message(str( format(PlayingDemo) %setup-&gt;demoName ));
+		demoReader.reset(new CDemoReader(setup-&gt;demoName, modGameTime+0.1f));
 	}
 
 	RestrictedAction(&quot;kick&quot;);			RestrictedAction(&quot;kickbynum&quot;);
@@ -577,7 +571,7 @@
 			if(inbuf[1] != a){
 				Warning(str(format(WrongPlayer) %(unsigned)inbuf[0] %a %(unsigned)inbuf[1]));
 			}
-			else if (setup &amp;&amp; setup-&gt;startPosType == CGameSetup::StartPos_ChooseInGame)
+			else if (setup-&gt;startPosType == CGameSetup::StartPos_ChooseInGame)
 			{
 				unsigned team = (unsigned)inbuf[2];
 				if (teams[team])
@@ -814,7 +808,7 @@
 			const unsigned char player = inbuf[1];
 			const unsigned char whichAllyTeam = inbuf[2];
 			const unsigned char allied = inbuf[3];
-			if (setup &amp;&amp; !setup-&gt;fixedAllies)
+			if (!setup-&gt;fixedAllies)
 			{
 				Broadcast(CBaseNetProtocol::Get().SendSetAllied(player, whichAllyTeam, allied));
 			}
@@ -948,11 +942,9 @@
 
 	// Third dword is CRC of setupText (if there is a setup)
 	// or pseudo random bytes (if there is no setup)
-	if (setup != NULL) {
-		CRC crc;
-		crc.Update(setup-&gt;gameSetupText, setup-&gt;gameSetupTextLength);
-		gameID.intArray[2] = crc.GetDigest();
-	}
+	CRC crc;
+	crc.Update(setup-&gt;gameSetupText.c_str(), setup-&gt;gameSetupText.length());
+	gameID.intArray[2] = crc.GetDigest();
 
 	CRC entropy;
 	entropy.Update(lastTick);
@@ -966,42 +958,27 @@
 	assert(!gameStartTime);
 	bool allReady = true;
 	
-	if (setup)
-	{
-		unsigned numDemoPlayers = demoReader ? demoReader-&gt;GetFileHeader().maxPlayerNum+1 : 0;
-		unsigned start = numDemoPlayers;
+	unsigned numDemoPlayers = demoReader ? demoReader-&gt;GetFileHeader().maxPlayerNum+1 : 0;
+	unsigned start = numDemoPlayers;
 #ifdef DEDICATED
-		// Lobby-protocol doesn't support creating games without players inside
-		// so in dedicated mode there will always be the host-player in the script
-		// which doesn't exist and will never join, so skip it in this case
-		if (setup &amp;&amp; 0 == start)
-			start++;
+	// Lobby-protocol doesn't support creating games without players inside
+	// so in dedicated mode there will always be the host-player in the script
+	// which doesn't exist and will never join, so skip it in this case
+	if (setup &amp;&amp; 0 == start)
+		start++;
 #endif
-		for (int a = start; a &lt; setup-&gt;numPlayers; a++) {
-			if (!players[a] || !players[a]-&gt;readyToStart) {
-				allReady = false;
-				break;
-			} else if (teams[players[a]-&gt;team] &amp;&amp; !teams[players[a]-&gt;team]-&gt;readyToStart &amp;&amp; !demoReader)
-			{
-				allReady = false;
-				break;
-			}
-		}
-	}
-	else
-	{
-		allReady = false;
-		// no setup, wait for host to send NETMSG_STARTPLAYING
-		// if this is the case, forced is true...
-		if (forced)
+	for (int a = setup-&gt;numDemoPlayers; a &lt; setup-&gt;numPlayers; a++) {
+		if (!players[a] || !players[a]-&gt;readyToStart) {
+			allReady = false;
+			break;
+		} else if (teams[players[a]-&gt;team] &amp;&amp; !teams[players[a]-&gt;team]-&gt;readyToStart &amp;&amp; !demoReader)
 		{
-			// immediately start
-			readyTime = SDL_GetTicks();
-			rng.Seed(readyTime);
-			StartGame();
+			allReady = false;
+			break;
 		}
 	}
 
+
 	if (allReady || forced)
 	{
 		if (readyTime == 0) {
@@ -1039,14 +1016,12 @@
 	}
 
 	GenerateAndSendGameID();
-	if (setup) {
-		for (int a = 0; a &lt; setup-&gt;numTeams; ++a)
-		{
-			if (teams[a]) // its a player
-				Broadcast(CBaseNetProtocol::Get().SendStartPos(SERVER_PLAYER, a, 1, teams[a]-&gt;startpos.x, teams[a]-&gt;startpos.y, teams[a]-&gt;startpos.z));
-			else // maybe an AI?
-				Broadcast(CBaseNetProtocol::Get().SendStartPos(SERVER_PLAYER, a, 1, setup-&gt;teamStartingData[a].startPos.x, setup-&gt;teamStartingData[a].startPos.y, setup-&gt;teamStartingData[a].startPos.z));
-		}
+	for (int a = 0; a &lt; setup-&gt;numTeams; ++a)
+	{
+		if (teams[a]) // its a player
+			Broadcast(CBaseNetProtocol::Get().SendStartPos(SERVER_PLAYER, a, 1, teams[a]-&gt;startpos.x, teams[a]-&gt;startpos.y, teams[a]-&gt;startpos.z));
+		else // maybe an AI?
+			Broadcast(CBaseNetProtocol::Get().SendStartPos(SERVER_PLAYER, a, 1, setup-&gt;teamStartingData[a].startPos.x, setup-&gt;teamStartingData[a].startPos.y, setup-&gt;teamStartingData[a].startPos.z));
 	}
 
 	Broadcast(CBaseNetProtocol::Get().SendRandSeed(rng()));
@@ -1200,7 +1175,7 @@
 				hasPlayer = true;
 			}
 		}
-		if (!setup || gs-&gt;Team(a)-&gt;isAI)
+		if (gs-&gt;Team(a)-&gt;isAI)
 			hasPlayer = true;
 
 		if (!gs-&gt;Team(a)-&gt;isDead &amp;&amp; !gs-&gt;Team(a)-&gt;gaia &amp;&amp; hasPlayer)
@@ -1358,16 +1333,13 @@
 	unsigned hisNewNumber = 0;
 	bool found = false;
 
-	if (setup)
+	for (unsigned i = setup-&gt;numDemoPlayers; i &lt; setup-&gt;numPlayers; ++i)
 	{
-		for (unsigned i = 0; i &lt; setup-&gt;numPlayers; ++i)
+		if (name == setup-&gt;playerStartingData[i].name)
 		{
-			if (name == setup-&gt;playerStartingData[i].name)
-			{
-				hisNewNumber = i;
-				found = true;
-				break;
-			}
+			hisNewNumber = i;
+			found = true;
+			break;
 		}
 	}
 
@@ -1386,7 +1358,7 @@
 		}
 	}
 
-	if (setup &amp;&amp; (hisNewNumber &gt;= static_cast&lt;unsigned&gt;(setup-&gt;numPlayers) || !found) &amp;&amp; !demoReader)
+	if ((hisNewNumber &gt;= static_cast&lt;unsigned&gt;(setup-&gt;numPlayers) || !found) &amp;&amp; !demoReader)
 	{
 		// player not found
 		Message(str(format(&quot;Player %s not found, rejecting connection attempt&quot;) %name));
@@ -1395,18 +1367,18 @@
 	
 	players[hisNewNumber].reset(new GameParticipant(isLocal)); // give him rights to change speed, kick players etc
 	players[hisNewNumber]-&gt;link = link;
-	if (setup &amp;&amp; hisNewNumber &lt; setup-&gt;playerStartingData.size()) {
+	if (hisNewNumber &lt; setup-&gt;playerStartingData.size()) {
 		*static_cast&lt;PlayerBase*&gt;(players[hisNewNumber].get()) = setup-&gt;playerStartingData[hisNewNumber];
 	}
-	link-&gt;SendData(CBaseNetProtocol::Get().SendSetPlayerNum((unsigned char)hisNewNumber));
 	link-&gt;SendData(boost::shared_ptr&lt;const RawPacket&gt;(gameData-&gt;Pack()));
+	link-&gt;SendData(CBaseNetProtocol::Get().SendSetPlayerNum((unsigned char)hisNewNumber));
 
 	for (int a = 0; a &lt; MAX_PLAYERS; ++a) {
 		if(players[a] &amp;&amp; players[a]-&gt;readyToStart)
 			Broadcast(CBaseNetProtocol::Get().SendPlayerName(a, players[a]-&gt;name));
 	}
 
-	if (setup &amp;&amp; (!demoReader || setup-&gt;demoName.empty()) /* gamesetup from demo? */)
+	if (!demoReader || setup-&gt;demoName.empty()) // gamesetup from demo?
 	{
 		unsigned hisTeam = setup-&gt;playerStartingData[hisNewNumber].team;
 		if (!teams[hisTeam]) // create new team
@@ -1425,21 +1397,7 @@
 				Broadcast(CBaseNetProtocol::Get().SendStartPos(SERVER_PLAYER, a, teams[a]-&gt;readyToStart, teams[a]-&gt;startpos.x, teams[a]-&gt;startpos.y, teams[a]-&gt;startpos.z));
 		}
 	}
-	else
-	{
-		unsigned hisTeam = hisNewNumber;
-		if (!demoReader)
-		{
-			teams[hisTeam].reset(new GameTeam());
-			players[hisNewNumber]-&gt;team = hisTeam;
-			Broadcast(CBaseNetProtocol::Get().SendJoinTeam(hisNewNumber, hisTeam));
-			for (int a = 0; a &lt; MAX_TEAMS; ++a)
-			{
-				if (teams[a] &amp;&amp; a != (int)hisNewNumber)
-					Broadcast(CBaseNetProtocol::Get().SendJoinTeam(a, players[a]-&gt;team));
-			}
-		}
-	}
+	
 	Message(str(format(NewConnection) %name %hisNewNumber %version));
 
 	link-&gt;Flush(true);

Modified: trunk/rts/Game/GameServer.h
===================================================================
--- trunk/rts/Game/GameServer.h	2008-11-01 13:46:27 UTC (rev 6943)
+++ trunk/rts/Game/GameServer.h	2008-11-01 14:19:58 UTC (rev 6944)
@@ -63,7 +63,7 @@
 {
 	friend class CLoadSaveHandler;     //For initialize server state after load
 public:
-	CGameServer(int port, bool onlyLocal, const GameData* const gameData, const CGameSetup* const setup, const std::string&amp; demoName = &quot;&quot;);
+	CGameServer(int port, bool onlyLocal, const GameData* const gameData, const CGameSetup* const setup);
 	virtual ~CGameServer();
 
 	void AddLocalClient(const std::string&amp; myName, const std::string&amp; myVersion);
@@ -160,7 +160,7 @@
 	boost::scoped_ptr&lt;GameTeam&gt; teams[MAX_TEAMS];
 
 	/////////////////// game settings ///////////////////
-	const CGameSetup* const setup;
+	boost::scoped_ptr&lt;const CGameSetup&gt; setup;
 	boost::scoped_ptr&lt;const GameData&gt; gameData;
 	/// Wheter the game is pausable for others than the host
 	bool gamePausable;

Modified: trunk/rts/Game/GameSetup.cpp
===================================================================
--- trunk/rts/Game/GameSetup.cpp	2008-11-01 13:46:27 UTC (rev 6943)
+++ trunk/rts/Game/GameSetup.cpp	2008-11-01 14:19:58 UTC (rev 6944)
@@ -11,12 +11,7 @@
 #include &quot;GameSetup.h&quot;
 #include &quot;TdfParser.h&quot;
 #include &quot;FileSystem/ArchiveScanner.h&quot;
-#include &quot;FileSystem/FileHandler.h&quot;
-#include &quot;FileSystem/VFSHandler.h&quot;
-#include &quot;TdfParser.h&quot;
-#include &quot;Lua/LuaParser.h&quot;
 #include &quot;Map/MapParser.h&quot;
-#include &quot;Map/ReadMap.h&quot;
 #include &quot;Rendering/Textures/TAPalette.h&quot;
 #include &quot;System/UnsyncedRNG.h&quot;
 #include &quot;System/Exceptions.h&quot;
@@ -29,10 +24,10 @@
 const CGameSetup* gameSetup = NULL;
 
 LocalSetup::LocalSetup() :
-		autohostport(0),
-		hostport(8452),
 		myPlayerNum(0),
+		hostport(8452),
 		sourceport(0),
+		autohostport(0),
 		isHost(true)
 {
 }
@@ -106,7 +101,6 @@
 
 CGameSetup::CGameSetup()
 {
-	gameSetupText=0;
 	startPosType=StartPos_Fixed;
 	numDemoPlayers=0;
 	hostDemo=false;
@@ -114,25 +108,11 @@
 
 CGameSetup::~CGameSetup()
 {
-	if (gameSetupText)
-		delete[] gameSetupText;
 }
 
-bool CGameSetup::Init(std::string setupFile)
+bool CGameSetup::Init(std::string script)
 {
-	if(setupFile.empty())
-		return false;
-	CFileHandler fh(setupFile);
-	if (!fh.FileExists())
-		return false;
-	char* c=SAFE_NEW char[fh.FileSize()];
-	fh.Read(c,fh.FileSize());
-
-	bool ret=Init(c,fh.FileSize());
-
-	delete[] c;
-
-	return ret;
+	Init(script.c_str(), script.size());
 }
 
 /**
@@ -182,12 +162,12 @@
 void CGameSetup::LoadStartPositions()
 {
 	TdfParser file;
-	file.LoadBuffer(gameSetupText, gameSetupTextLength-1);
+	file.LoadBuffer(gameSetupText.c_str(), gameSetupText.length());
 
 	if (startPosType == StartPos_Random) {
 		// Server syncs these later, so we can use unsynced rng
 		UnsyncedRNG rng;
-		rng.Seed(gameSetupTextLength ^ SDL_GetTicks());
+		rng.Seed(gameSetupText.length()^ SDL_GetTicks());
 		int teamStartNum[MAX_TEAMS];
 		for (int i = 0; i &lt; MAX_TEAMS; ++i)
 			teamStartNum[i] = i;
@@ -304,7 +284,8 @@
 		}
 
 		// Get default color from palette (based on &quot;color&quot; tag)
-		int colorNum = atoi(file.SGetValueDef(&quot;0&quot;, s + &quot;color&quot;).c_str());
+		int colorNum = atoi(file.SGetValueDef(&quot;-1&quot;, s + &quot;color&quot;).c_str());
+		if (colorNum == -1) colorNum = a;
 		colorNum %= palette.NumTeamColors();
 		float3 defaultCol(palette.teamColor[colorNum][0] / 255.0f, palette.teamColor[colorNum][1] / 255.0f, palette.teamColor[colorNum][2] / 255.0f);
 
@@ -438,10 +419,7 @@
 bool CGameSetup::Init(const char* buf, int size)
 {
 	// Copy buffer contents
-	gameSetupText = SAFE_NEW char[size+1];
-	memcpy(gameSetupText, buf, size);
-	gameSetupText[size] = 0;
-	gameSetupTextLength = size;
+	gameSetupText.assign(buf,size);
 
 	// Parse
 	TdfParser file;

Modified: trunk/rts/Game/GameSetup.h
===================================================================
--- trunk/rts/Game/GameSetup.h	2008-11-01 13:46:27 UTC (rev 6943)
+++ trunk/rts/Game/GameSetup.h	2008-11-01 14:19:58 UTC (rev 6944)
@@ -34,7 +34,7 @@
 public:
 	CGameSetup();
 	~CGameSetup();
-	bool Init(std::string setupFile);
+	bool Init(std::string script);
 	bool Init(const char* buf, int size);
 	void LoadStartPositions();
 	
@@ -60,8 +60,7 @@
 	std::string luaGaiaStr;
 	std::string luaRulesStr;
 	
-	char* gameSetupText;
-	int gameSetupTextLength;
+	std::string gameSetupText;
 	
 	StartPosType startPosType;
 	

Modified: trunk/rts/Game/PreGame.cpp
===================================================================
--- trunk/rts/Game/PreGame.cpp	2008-11-01 13:46:27 UTC (rev 6943)
+++ trunk/rts/Game/PreGame.cpp	2008-11-01 14:19:58 UTC (rev 6944)
@@ -29,26 +29,14 @@
 #include &quot;Lua/LuaRules.h&quot;
 #include &quot;Lua/LuaParser.h&quot;
 #include &quot;Map/MapParser.h&quot;
-#include &quot;Platform/Clipboard.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;Platform/FileSystem.h&quot;
-#include &quot;Rendering/glFont.h&quot;
-#include &quot;Rendering/GL/glList.h&quot;
 #include &quot;Rendering/Textures/TAPalette.h&quot;
 #include &quot;StartScripts/ScriptHandler.h&quot;
 #include &quot;UI/InfoConsole.h&quot;
-#include &quot;UI/MouseHandler.h&quot;
 #include &quot;Exceptions.h&quot;
 
-// msvc behaves really strange
-#if _MSC_VER
-namespace std {
-	using ::sin;
-}
-#endif
 
-const int springDefaultPort = 8452;
-
 CPreGame* pregame = NULL;
 using netcode::RawPacket;
 
@@ -56,90 +44,30 @@
 extern bool globalQuit;
 std::string stupidGlobalMapname;
 
-CglList* CPreGame::showList = NULL;
-std::string CPreGame::userScript;
-std::string CPreGame::userMap;
-std::string CPreGame::userMod;
 
-
-CPreGame::CPreGame(const LocalSetup* setup, const string&amp; demo, const std::string&amp; save)
-: settings(setup),
-  state(UNKNOWN),
-  hasDemo(!demo.empty()),
-  hasSave(!save.empty()),
+CPreGame::CPreGame(const LocalSetup* setup)
+: state(UNKNOWN),
+  settings(setup),
   gameData(0),
   savefile(NULL)
 {
-	demoFile = gameSetup? gameSetup-&gt;demoName : demo;
-
-	if (!gameSetup &amp;&amp; demoFile.empty()) {
-		gs-&gt;noHelperAIs = !!configHandler.GetInt(&quot;NoHelperAIs&quot;, 0);
-		LoadLua();
-	}
-
+	localDemoHack = false;
 	infoConsole = SAFE_NEW CInfoConsole;
 
-	pregame = this; // prevent crashes if Select* is called from ctor
 	net = SAFE_NEW CNetProtocol();
 
-	//vfsHandler=SAFE_NEW CHpiHandler();
-
 	activeController=this;
 
-	if(!gameSetup){
-		for(int a=0;a&lt;gs-&gt;activeTeams;a++){
-			for(int b=0;b&lt;4;++b){
-				gs-&gt;Team(a)-&gt;color[b]=palette.teamColor[a][b];
-			}
-		}
+	if(!settings-&gt;isHost)
+	{
+		PrintLoadMsg(&quot;Connecting to server&quot;);
+		net-&gt;InitClient(settings-&gt;hostip.c_str(), settings-&gt;hostport, settings-&gt;sourceport, settings-&gt;myPlayerName, std::string(VERSION_STRING_DETAILED));
 	}
-
-	if(settings-&gt;isHost){
+	else
+	{
 		net-&gt;InitLocalClient();
-		if (!demoFile.empty())
-		{
-			ReadDataFromDemo(demoFile);
-			state = WAIT_CONNECTING;
-		}
-		else if(gameSetup){
-			StartServer(gameSetup-&gt;mapName, gameSetup-&gt;baseMod, gameSetup-&gt;scriptName);
-			state = WAIT_CONNECTING;
-		} else if (hasSave) {
-			savefile = new CLoadSaveHandler();
-			savefile-&gt;LoadGameStartInfo(savefile-&gt;FindSaveFile(save.c_str()));
-			StartServer(gameSetup-&gt;mapName, gameSetup-&gt;baseMod, gameSetup-&gt;scriptName);
-			state = WAIT_CONNECTING;
-		} else {
-			ShowModList();
-			state = WAIT_ON_USERINPUT;
-		}
-	} else {
-		if(gameSetup){
-			PrintLoadMsg(&quot;Connecting to server&quot;);
-			net-&gt;InitClient(settings-&gt;hostip.c_str(), settings-&gt;hostport, settings-&gt;sourceport, settings-&gt;myPlayerName, std::string(VERSION_STRING_DETAILED));
-			state = WAIT_CONNECTING;
-		} else {
-			if (hasDemo) {
-				net-&gt;localDemoPlayback = true;
-				state = WAIT_CONNECTING;
-				ReadDataFromDemo(demoFile); // scan for GameData
-				net-&gt;InitLocalClient();
-				if (gameSetup) {	// we read a gameSetup from the demofiles
-					logOutput.Print(&quot;Read GameSetup from Demofile&quot;);
-				}
-				else { // we dont read a GameSetup from demofile (this code was copied from CDemoReader)
-					logOutput.Print(&quot;Demo file does not contain a setupscript&quot;);
-					LoadLua();
-				}
-			}
-			else {
-				PrintLoadMsg(&quot;Connecting to server&quot;);
-				net-&gt;InitClient(settings-&gt;hostip.c_str(), settings-&gt;hostport, settings-&gt;sourceport, settings-&gt;myPlayerName, std::string(VERSION_STRING_DETAILED));
-				state = WAIT_CONNECTING;
-			}
-		}
 	}
-	assert(state != UNKNOWN);
+	state = WAIT_CONNECTING;
 }
 
 
@@ -150,7 +78,23 @@
 	infoConsole = 0;
 }
 
+void CPreGame::LoadSetupscript(const std::string&amp; script)
+{
+	StartServer(script);
+}
 
+void CPreGame::LoadDemo(const std::string&amp; demo)
+{
+	ReadDataFromDemo(demo);
+}
+
+void CPreGame::LoadSavefile(const std::string&amp; save)
+{
+	savefile = new CLoadSaveHandler();
+	savefile-&gt;LoadGameStartInfo(savefile-&gt;FindSaveFile(save.c_str()));
+	StartServer(savefile-&gt;scriptText);
+}
+
 int CPreGame::KeyPressed(unsigned short k,bool isRepeat)
 {
 	if (k == SDLK_ESCAPE){
@@ -160,11 +104,6 @@
 		} else
 			logOutput.Print(&quot;Use shift-esc to quit&quot;);
 	}
-	if (showList) { //are we currently showing a list?
-		showList-&gt;KeyPressed(k, isRepeat);
-		return 0;
-	}
-
 	return 0;
 }
 
@@ -172,39 +111,26 @@
 bool CPreGame::Draw()
 {
 	SDL_Delay(10); // milliseconds
-	if (!gu-&gt;active) {
-		return true;
+	
+	switch (state) {
+		case WAIT_ON_GAMEDATA:
+			PrintLoadMsg(&quot;Waiting on game data&quot;, false);
+			break;
+		case WAIT_CONNECTING:
+			if ( ((SDL_GetTicks()/1000) % 2) == 0 )
+				PrintLoadMsg(&quot;Connecting to server .&quot;, false);
+			else
+				PrintLoadMsg(&quot;Connecting to server  &quot;, false);
+			break;
+		case UNKNOWN:
+		case ALL_READY:
+		default:
+			PrintLoadMsg(&quot;&quot;, false); // just clear screen and set up matrices etc.
+			break;
 	}
 
-	if (showList) {
-		PrintLoadMsg(&quot;&quot;, false); // just clear screen and set up matrices etc.
-	}
-	else {
-		switch (state) {
-			case WAIT_ON_GAMEDATA:
-				PrintLoadMsg(&quot;Waiting on game data&quot;, false);
-				break;
-			case WAIT_CONNECTING:
-				if ( ((SDL_GetTicks()/1000) % 2) == 0 )
-					PrintLoadMsg(&quot;Connecting to server .&quot;, false);
-				else
-					PrintLoadMsg(&quot;Connecting to server  &quot;, false);
-				break;
-			case UNKNOWN:
-			case WAIT_ON_USERINPUT:
-			case ALL_READY:
-			default:
-				PrintLoadMsg(&quot;&quot;, false); // just clear screen and set up matrices etc.
-				break;
-		}
-	}
-
 	infoConsole-&gt;Draw();
 
-	if (showList) {
-		showList-&gt;Draw();
-	}
-
 	return true;
 }
 
@@ -219,10 +145,6 @@
 			logOutput.Print(&quot;Internal error in CPreGame&quot;);
 			return false;
 
-		case WAIT_ON_USERINPUT: {
-			break;
-		}
-
 		case WAIT_CONNECTING:
 			if (net-&gt;Connected())
 				state = WAIT_ON_GAMEDATA; // fall through
@@ -230,10 +152,7 @@
 				break; // abort
 
 		case WAIT_ON_GAMEDATA: {
-			if (gameData) // we recieved tha gameData
-				state = ALL_READY;
-			else
-				break;
+			break;
 		}
 
 		case ALL_READY: {
@@ -241,9 +160,6 @@
 			const int teamID = gs-&gt;players[gu-&gt;myPlayerNum]-&gt;team;
 			const CTeam* team = gs-&gt;Team(teamID);
 			assert(team);
-			if (net-&gt;localDemoPlayback) {
-				gs-&gt;players[gu-&gt;myPlayerNum]-&gt;StartSpectating();
-			}
 			LoadStartPicture(team-&gt;side);
 
 			game = SAFE_NEW CGame(gameData-&gt;GetMap(), modArchive, infoConsole, savefile);
@@ -273,10 +189,16 @@
 }
 
 
-void CPreGame::StartServer(std::string map, std::string mod, std::string script)
+void CPreGame::StartServer(const std::string&amp; setupscript)
 {
 	assert(!gameServer);
 	GameData* startupData = new GameData();
+	CGameSetup* setup = new CGameSetup();
+	setup-&gt;Init(setupscript);
+	std::string map = setup-&gt;mapName;
+	std::string mod = setup-&gt;baseMod;
+	std::string script = setup-&gt;scriptName;
+	
 	startupData-&gt;SetRandomSeed(static_cast&lt;unsigned&gt;(gu-&gt;usRandInt()));
 	bool mapHasStartscript = false;
 	if (!map.empty())
@@ -341,7 +263,8 @@
 	
 	good_fpu_control_registers(&quot;before CGameServer creation&quot;);
 	int myPort = settings-&gt;hostport;
-	gameServer = new CGameServer(myPort, false, startupData, gameSetup, demoFile);
+	startupData-&gt;SetSetup(setup-&gt;gameSetupText);
+	gameServer = new CGameServer(myPort, false, startupData, setup);
 	if (settings-&gt;autohostport &gt; 0) {
 		gameServer-&gt;AddAutohostInterface(settings-&gt;autohostport);
 	}
@@ -352,11 +275,6 @@
 
 void CPreGame::UpdateClientNet()
 {
-	if (gameData)
-	{
-		logOutput.Print(&quot;Warning: game should have started before&quot;);
-		return;
-	}
 	if (!net-&gt;Active())
 	{
 		logOutput.Print(&quot;Server not reachable&quot;);
@@ -370,12 +288,14 @@
 		const unsigned char* inbuf = packet-&gt;data;
 		switch (inbuf[0]) {
 			case NETMSG_SETPLAYERNUM: {
+				state = ALL_READY;
 				gu-&gt;SetMyPlayer(packet-&gt;data[1]);
 				logOutput.Print(&quot;Became player %i&quot;, gu-&gt;myPlayerNum);
-			} break;
+				return;
+			}
 			case NETMSG_GAMEDATA: {
 				GameDataReceived(packet);
-				return;
+				break;
 			}
 			default: {
 				logOutput.Print(&quot;Unknown net-msg recieved from CPreGame: %i&quot;, int(packet-&gt;data[0]));
@@ -390,27 +310,43 @@
 {
 	assert(!gameServer);
 	logOutput.Print(&quot;Pre-scanning demo file for game data...&quot;);
-	bool hasSetup = static_cast&lt;bool&gt;(gameSetup);
 	CDemoReader scanner(demoName, 0);
-	bool demoSetup = static_cast&lt;bool&gt;(gameSetup);
-	if (demoSetup &amp;&amp; ! hasSetup)
-	{
-		//HACK: make gs read the setup if we just read it out of the demofile
-		gs-&gt;LoadFromSetup(gameSetup);
-		gu-&gt;SetMyPlayer(0); //HACK load data for player 0
-	}
 
-	if (!hasSetup)
-		gu-&gt;SetMyPlayer(scanner.GetFileHeader().maxPlayerNum + 1); //HACK pt. #2: set real player num
-
 	boost::shared_ptr&lt;const RawPacket&gt; buf(scanner.GetData(static_cast&lt;float&gt;(INT_MAX)));
 	while ( buf )
 	{
 		if (buf-&gt;data[0] == NETMSG_GAMEDATA)
 		{
 			GameData *data = new GameData(boost::shared_ptr&lt;const RawPacket&gt;(buf));
+			CGameSetup* tempSetup = new CGameSetup();
+			if (tempSetup-&gt;Init(data-&gt;GetSetup()))
+			{
+				tempSetup-&gt;scriptName = data-&gt;GetScript();
+				tempSetup-&gt;mapName = data-&gt;GetMap();
+				tempSetup-&gt;baseMod = data-&gt;GetMod();
+				tempSetup-&gt;hostDemo = true;
+				tempSetup-&gt;demoName = demoName;
+				
+				// all players in the setupscript are from demo
+				for (std::vector&lt;PlayerBase&gt;::iterator it = tempSetup-&gt;playerStartingData.begin(); it != tempSetup-&gt;playerStartingData.end(); ++it)
+					it-&gt;isFromDemo = true;
+				
+				// add myself to the script
+				PlayerBase myPlayer;
+				myPlayer.name = settings-&gt;myPlayerName;
+				myPlayer.spectator = true;
+				tempSetup-&gt;playerStartingData.push_back(myPlayer);
+				tempSetup-&gt;numDemoPlayers = std::max(scanner.GetFileHeader().maxPlayerNum+1, tempSetup-&gt;numPlayers);
+				tempSetup-&gt;numPlayers = tempSetup-&gt;numDemoPlayers+1;
+				tempSetup-&gt;maxSpeed = 10;
+				localDemoHack = true;
+			}
+			else
+			{
+				throw content_error(&quot;Server sent us incorrect script&quot;);
+			}
 			good_fpu_control_registers(&quot;before CGameServer creation&quot;);
-			gameServer = new CGameServer(settings-&gt;hostport, false, data, gameSetup, demoName);
+			gameServer = new CGameServer(settings-&gt;hostport, false, data, tempSetup);
 			gameServer-&gt;AddLocalClient(settings-&gt;myPlayerName, std::string(VERSION_STRING_DETAILED));
 			good_fpu_control_registers(&quot;after CGameServer creation&quot;);
 			break;
@@ -422,110 +358,10 @@
 		}
 		buf.reset(scanner.GetData(static_cast&lt;float&gt;(INT_MAX)));
 	}
+
 	assert(gameServer);
 }
 
-
-/** Create a CglList for selecting the map. */
-void CPreGame::ShowMapList()
-{
-	CglList* list = SAFE_NEW CglList(&quot;Select map&quot;, SelectMap, 2);
-	std::vector&lt;std::string&gt; found = filesystem.FindFiles(&quot;maps/&quot;,&quot;{*.sm3,*.smf}&quot;);
-	std::vector&lt;std::string&gt; arFound = archiveScanner-&gt;GetMaps();
-	if (found.begin() == found.end() &amp;&amp; arFound.begin() == arFound.end()) {
-		throw content_error(&quot;PreGame couldn't find any map files&quot;);
-		return;
-	}
-
-	std::set&lt;std::string&gt; mapSet; // use a set to sort them
-	for (std::vector&lt;std::string&gt;::iterator it = found.begin(); it != found.end(); it++) {
-		std::string fn(filesystem.GetFilename(*it));
-		mapSet.insert(fn.c_str());
-	}
-	for (std::vector&lt;std::string&gt;::iterator it = arFound.begin(); it != arFound.end(); it++) {
-		mapSet.insert((*it).c_str());
-	}
-
-	list-&gt;AddItem(&quot;Random map&quot;, &quot;Random map&quot;); // always first
-	for (std::set&lt;std::string&gt;::iterator sit = mapSet.begin(); sit != mapSet.end(); ++sit) {
-		list-&gt;AddItem(sit-&gt;c_str(), sit-&gt;c_str());
-	}
-	showList = list;
-}
-
-
-/** Create a CglList for selecting the script. */
-void CPreGame::ShowScriptList()
-{
-	CglList* list = CScriptHandler::Instance().GenList(SelectScript);
-	showList = list;
-}
-
-
-/** Create a CglList for selecting the mod. */
-void CPreGame::ShowModList()
-{
-	CglList* list = SAFE_NEW CglList(&quot;Select mod&quot;, SelectMod, 3);
-	std::vector&lt;CArchiveScanner::ModData&gt; found = archiveScanner-&gt;GetPrimaryMods();
-	if (found.empty()) {
-		throw content_error(&quot;PreGame couldn't find any mod files&quot;);
-		return;
-	}
-
-	std::map&lt;std::string, std::string&gt; modMap; // name, desc  (using a map to sort)
-	for (std::vector&lt;CArchiveScanner::ModData&gt;::iterator it = found.begin(); it != found.end(); ++it) {
-		modMap[it-&gt;name] = it-&gt;description;
-	}
-
-	list-&gt;AddItem(&quot;Random mod&quot;, &quot;Random mod&quot;); // always first
-	std::map&lt;std::string, std::string&gt;::iterator mit;
-	for (mit = modMap.begin(); mit != modMap.end(); ++mit) {
-		list-&gt;AddItem(mit-&gt;first.c_str(), mit-&gt;second.c_str());
-	}
-	showList = list;
-}
-
-
-void CPreGame::SelectMap(std::string s)
-{
-	if (s == &quot;Random map&quot;) {
-		s = pregame-&gt;showList-&gt;items[1 + gu-&gt;usRandInt() % (showList-&gt;items.size() - 1)];
-	}
-
-	delete showList;
-	showList = NULL;
-
-	userMap = s;
-	pregame-&gt;StartServer(userMap, userMod, userScript);
-	pregame-&gt;state = WAIT_CONNECTING;
-}
-
-
-void CPreGame::SelectScript(std::string s)
-{
-	delete showList;
-	showList = NULL;
-
-	userScript = s;
-	pregame-&gt;ShowMapList();
-}
-
-
-void CPreGame::SelectMod(std::string s)
-{
-	if (s == &quot;Random mod&quot;) {
-		const int index = 1 + (gu-&gt;usRandInt() % (showList-&gt;items.size() - 1));
-		s = showList-&gt;items[index];
-	}
-
-	delete showList;
-	showList = NULL;
-
-	userMod = s;
-	pregame-&gt;ShowScriptList();
-}
-
-
 void CPreGame::LoadMap(const std::string&amp; mapName, const bool forceReload)
 {
 	static bool alreadyLoaded = false;
@@ -596,6 +432,39 @@
 {
 	gameData = new GameData(packet);
 	
+	CGameSetup* temp = new CGameSetup();
+	if (temp-&gt;Init(gameData-&gt;GetSetup()))
+	{
+		temp-&gt;scriptName = gameData-&gt;GetScript();
+		temp-&gt;mapName = gameData-&gt;GetMap();
+		temp-&gt;baseMod = gameData-&gt;GetMod();
+		
+		if (localDemoHack)
+		{
+			temp-&gt;hostDemo = true;
+				
+				// all players in the setupscript are from demo
+			for (std::vector&lt;PlayerBase&gt;::iterator it = temp-&gt;playerStartingData.begin(); it != temp-&gt;playerStartingData.end(); ++it)
+				it-&gt;isFromDemo = true;
+				
+			// add myself to the script
+			PlayerBase myPlayer;
+			myPlayer.name = settings-&gt;myPlayerName;
+			myPlayer.spectator = true;
+			temp-&gt;playerStartingData.push_back(myPlayer);
+			temp-&gt;numDemoPlayers = temp-&gt;numPlayers;
+			temp-&gt;numPlayers = temp-&gt;numDemoPlayers+1;
+			temp-&gt;maxSpeed = 10;
+		}
+		gameSetup = const_cast&lt;const CGameSetup*&gt;(temp);
+		gs-&gt;LoadFromSetup(gameSetup);
+		LoadLua();
+	}
+	else
+	{
+		throw content_error(&quot;Server sent us incorrect script&quot;);
+	}
+	
 	gs-&gt;SetRandSeed(gameData-&gt;GetRandomSeed(), true);
 	logOutput &lt;&lt; &quot;Using map &quot; &lt;&lt; gameData-&gt;GetMap() &lt;&lt; &quot;\n&quot;;
 	stupidGlobalMapname = gameData-&gt;GetMap();
@@ -615,9 +484,4 @@
 	modArchive = archiveScanner-&gt;ModNameToModArchive(gameData-&gt;GetMod());
 	archiveScanner-&gt;CheckMod(modArchive, gameData-&gt;GetModChecksum());
 	
-	if (gameSetup) {
-		const_cast&lt;CGameSetup*&gt;(gameSetup)-&gt;scriptName = gameData-&gt;GetScript();
-		const_cast&lt;CGameSetup*&gt;(gameSetup)-&gt;mapName = gameData-&gt;GetMap();
-		const_cast&lt;CGameSetup*&gt;(gameSetup)-&gt;baseMod = gameData-&gt;GetMod();
-	}
 }

Modified: trunk/rts/Game/PreGame.h
===================================================================
--- trunk/rts/Game/PreGame.h	2008-11-01 13:46:27 UTC (rev 6943)
+++ trunk/rts/Game/PreGame.h	2008-11-01 14:19:58 UTC (rev 6944)
@@ -7,7 +7,6 @@
 
 #include &quot;GameController.h&quot;
 
-class CglList;
 class CInfoConsole;
 class CLoadSaveHandler;
 class GameData;
@@ -34,15 +33,19 @@
 class CPreGame : public CGameController
 {
 public:
-	CPreGame(const LocalSetup* setup, const std::string&amp; demo, const std::string&amp; save);
+	CPreGame(const LocalSetup* setup);
 	virtual ~CPreGame();
+	
+	void LoadSetupscript(const std::string&amp; script);
+	void LoadDemo(const std::string&amp; demo);
+	void LoadSavefile(const std::string&amp; save);
 
 	bool Draw();
 	int KeyPressed(unsigned short k, bool isRepeat);
 	bool Update();
 
 private:
-	void StartServer(std::string map, std::string mod, std::string script);
+	void StartServer(const std::string&amp; setupscript);
 	
 	/// reads out map, mod and script from demos (with or without a gameSetupScript)
 	void ReadDataFromDemo(const std::string&amp; demoName);
@@ -52,24 +55,11 @@
 
 	CInfoConsole* infoConsole;
 
-	void ShowMapList();
-	void ShowScriptList();
-	void ShowModList();
-	static CglList* showList;
-	
-	/// Choose the script we will tell the server to start with
-	static void SelectScript(std::string s);
-	static void SelectMap(std::string s);
-	static void SelectMod(std::string s);
-	static std::string userScript;
-	static std::string userMap;
-	static std::string userMod;
-
 	/// Load map and dependend archives into archive scanner
-	static void LoadMap(const std::string&amp; mapName, const bool forceReload = false);
+	void LoadMap(const std::string&amp; mapName, const bool forceReload = false);
 	
 	/// Map all required archives depending on selected mod(s)
-	static void LoadMod(const std::string&amp; modName);
+	void LoadMod(const std::string&amp; modName);
 	
 	void LoadLua();
 
@@ -77,15 +67,12 @@
 	
 	enum State {
 		UNKNOWN,
-		WAIT_ON_USERINPUT, // wait for user to set script, map, mod
 		WAIT_CONNECTING, // connecting to server
 		WAIT_ON_GAMEDATA, // wait for the server to send us the GameData
 		ALL_READY, // ready to start
 	};
 	State state;
 
-	const bool hasDemo,hasSave;
-
 	/**
 	@brief GameData we recieved from server
 	
@@ -94,8 +81,9 @@
 	const GameData* gameData;
 	boost::scoped_ptr&lt;const LocalSetup&gt; settings;
 	std::string modArchive;
-	std::string demoFile;
 	CLoadSaveHandler *savefile;
+	
+	bool localDemoHack;
 };
 
 extern CPreGame* pregame;

Modified: trunk/rts/Game/SelectMenu.cpp
===================================================================
--- trunk/rts/Game/SelectMenu.cpp	2008-11-01 13:46:27 UTC (rev 6943)
+++ trunk/rts/Game/SelectMenu.cpp	2008-11-01 14:19:58 UTC (rev 6944)
@@ -3,15 +3,25 @@
 #include &lt;SDL_keysym.h&gt;
 #include &lt;SDL_timer.h&gt;
 #include &lt;SDL_types.h&gt;
+#include &lt;boost/bind.hpp&gt;
+#include &lt;sstream&gt;
+#include &lt;stack&gt;
 
 #include &quot;GameSetup.h&quot;
 #include &quot;PreGame.h&quot;
-#include &quot;Platform/Clipboard.h&quot;
-#include &quot;Platform/ConfigHandler.h&quot;
-#include &quot;LogOutput.h&quot;
-#include &quot;Util.h&quot;
+#include &quot;Rendering/glFont.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
-#include &quot;Rendering/glFont.h&quot;
+#include &quot;Rendering/GL/glList.h&quot;
+#include &quot;System/LogOutput.h&quot;
+#include &quot;System/Util.h&quot;
+#include &quot;System/Exceptions.h&quot;
+#include &quot;System/FileSystem/ArchiveScanner.h&quot;
+#include &quot;System/FileSystem/FileHandler.h&quot;
+#include &quot;System/FileSystem/VFSHandler.h&quot;
+#include &quot;System/Platform/FileSystem.h&quot;
+#include &quot;System/Platform/Clipboard.h&quot;
+#include &quot;System/Platform/ConfigHandler.h&quot;
+#include &quot;StartScripts/ScriptHandler.h&quot;
 
 using std::string;
 
@@ -19,15 +29,106 @@
 extern bool globalQuit;
 
 
-SelectMenu::SelectMenu(bool server) : isServer(server)
+class TdfWriter
 {
-	if (!isServer)
+public:
+	void PushSection(const std::string&amp; section)
 	{
+		Indent();
+		str &lt;&lt; &quot;[&quot;&lt;&lt;section&lt;&lt;&quot;]\n{\n&quot;;
+		sections.push(section);
+	};
+	void PopSection()
+	{
+		assert(!sections.empty());
+		Indent();
+		str &lt;&lt; &quot;} //&quot;&lt;&lt; sections.top() &lt;&lt; &quot;\n&quot;;
+		sections.pop();
+	};
+	
+	template&lt;typename T&gt;
+	void AddPair(const std::string&amp; key, const T&amp; value)
+	{
+		Indent();
+		str &lt;&lt; key &lt;&lt; &quot;=&quot; &lt;&lt; value &lt;&lt; &quot;;\n&quot;;
+	};
+	
+	std::string Get() const
+	{
+		return str.str();
+	};
+	
+private:
+	void Indent()
+	{
+		for (unsigned i = 0; i &lt; sections.size(); ++i)
+		str &lt;&lt; &quot;    &quot;;
+	};
+
+	std::ostringstream str;
+	std::stack&lt;std::string&gt; sections;
+};
+
+std::string CreateDefaultSetup(const std::string&amp; map, const std::string&amp; mod, const std::string&amp; script, const std::string&amp; playername)
+{
+	TdfWriter setup;
+	setup.PushSection(&quot;GAME&quot;);
+	setup.AddPair(&quot;Mapname&quot;, map);
+	setup.AddPair(&quot;Gametype&quot;, mod);
+	setup.AddPair(&quot;Scriptname&quot;, script);
+	
+	setup.AddPair(&quot;IsHost&quot;, 1);
+	setup.AddPair(&quot;MyPlayerName&quot;, playername);
+	
+	setup.AddPair(&quot;NoHelperAIs&quot;, configHandler.GetInt(&quot;NoHelperAIs&quot;, 0));
+	
+	setup.PushSection(&quot;PLAYER0&quot;);
+	setup.AddPair(&quot;Name&quot;, playername);
+	setup.AddPair(&quot;Team&quot;, 0);
+	setup.PopSection();
+	
+	setup.PushSection(&quot;PLAYER1&quot;);
+	setup.AddPair(&quot;Name&quot;, &quot;Enemy&quot;);
+	setup.AddPair(&quot;Team&quot;, 1);
+	setup.PopSection();
+	
+	setup.PushSection(&quot;TEAM0&quot;);
+	setup.AddPair(&quot;Leader&quot;, 0);
+	setup.AddPair(&quot;AllyTeam&quot;, 0);
+	setup.PopSection();
+	
+	setup.PushSection(&quot;TEAM1&quot;);
+	setup.AddPair(&quot;AllyTeam&quot;, 1);
+	setup.PopSection();
+	
+	setup.PushSection(&quot;ALLYTEAM0&quot;);
+	setup.AddPair(&quot;NumAllies&quot;, 0);
+	setup.PopSection();
+	
+	setup.PushSection(&quot;ALLYTEAM1&quot;);
+	setup.AddPair(&quot;NumAllies&quot;, 0);
+	setup.PopSection();
+	setup.PopSection();
+	
+	return setup.Get();
+}
+
+SelectMenu::SelectMenu(bool server)
+{
+	mySettings = new LocalSetup();
+	mySettings-&gt;isHost = server;
+	mySettings-&gt;myPlayerName = configHandler.GetString(&quot;name&quot;, &quot;unnamed&quot;);
+	if (!mySettings-&gt;isHost)
+	{
 		userInput=configHandler.GetString(&quot;address&quot;,&quot;&quot;);
 		writingPos = userInput.length();
 		userPrompt = &quot;Enter server address: &quot;;
 		userWriting = true;
 	}
+	else
+	{
+		ShowModList();
+	}
 }
 
 
@@ -41,6 +142,11 @@
 			logOutput.Print(&quot;Use shift-esc to quit&quot;);
 	}
 
+	if (showList) { //are we currently showing a list?
+		showList-&gt;KeyPressed(k, isRepeat);
+		return 0;
+	}
+
 	if (userWriting) {
 		keys[k] = true;
 		if (k == SDLK_v &amp;&amp; keys[SDLK_LCTRL]){
@@ -115,35 +221,132 @@
 		glColor4f(1.0f, 1.0f, 1.0f, 1.0f);
 		font-&gt;glPrintAt(xStart, yStart, fontScale, tempstring.c_str());
 	}
+	
+	if (showList) {
+		showList-&gt;Draw();
+	}
 
 	return true;
 }
 
 bool SelectMenu::Update()
 {
-	if (isServer)
+	if (!mySettings-&gt;isHost)
 	{
-		LocalSetup* mySettings = new LocalSetup();
-		mySettings-&gt;myPlayerName = configHandler.GetString(&quot;name&quot;, &quot;unnamed&quot;);
-		mySettings-&gt;isHost = true;
-		pregame = new CPreGame(mySettings, &quot;&quot;, &quot;&quot;);
-		delete this;
-	}
-	else
-	{
 		// we are a client, wait for user to type address
 		if (!userWriting)
 		{
 			configHandler.SetString(&quot;address&quot;,userInput);
-			LocalSetup* mySettings = new LocalSetup();
-			mySettings-&gt;myPlayerName = configHandler.GetString(&quot;name&quot;, &quot;unnamed&quot;);
+			mySettings = new LocalSetup();
 			mySettings-&gt;hostip = userInput;
-			mySettings-&gt;isHost = false;
-			pregame = new CPreGame(mySettings, &quot;&quot;, &quot;&quot;);
+			pregame = new CPreGame(mySettings);
 			delete this;
 		}
 	}
 
-
 	return true;
 }
+
+/** Create a CglList for selecting the map. */
+void SelectMenu::ShowMapList()
+{
+	CglList* list = new CglList(&quot;Select map&quot;, boost::bind(&amp;SelectMenu::SelectMap, this, _1), 2);
+	std::vector&lt;std::string&gt; found = filesystem.FindFiles(&quot;maps/&quot;,&quot;{*.sm3,*.smf}&quot;);
+	std::vector&lt;std::string&gt; arFound = archiveScanner-&gt;GetMaps();
+	if (found.begin() == found.end() &amp;&amp; arFound.begin() == arFound.end()) {
+		throw content_error(&quot;PreGame couldn't find any map files&quot;);
+		return;
+	}
+
+	std::set&lt;std::string&gt; mapSet; // use a set to sort them
+	for (std::vector&lt;std::string&gt;::iterator it = found.begin(); it != found.end(); it++) {
+		std::string fn(filesystem.GetFilename(*it));
+		mapSet.insert(fn.c_str());
+	}
+	for (std::vector&lt;std::string&gt;::iterator it = arFound.begin(); it != arFound.end(); it++) {
+		mapSet.insert((*it).c_str());
+	}
+
+	list-&gt;AddItem(&quot;Random map&quot;, &quot;Random map&quot;); // always first
+	for (std::set&lt;std::string&gt;::iterator sit = mapSet.begin(); sit != mapSet.end(); ++sit) {
+		list-&gt;AddItem(sit-&gt;c_str(), sit-&gt;c_str());
+	}
+	showList = list;
+}
+
+
+/** Create a CglList for selecting the script. */
+void SelectMenu::ShowScriptList()
+{
+	CglList* list = CScriptHandler::Instance().GenList(boost::bind(&amp;SelectMenu::SelectScript, this, _1));
+	showList = list;
+}
+
+
+/** Create a CglList for selecting the mod. */
+void SelectMenu::ShowModList()
+{
+	CglList* list = new CglList(&quot;Select mod&quot;, boost::bind(&amp;SelectMenu::SelectMod, this, _1), 3);
+	std::vector&lt;CArchiveScanner::ModData&gt; found = archiveScanner-&gt;GetPrimaryMods();
+	if (found.empty()) {
+		throw content_error(&quot;PreGame couldn't find any mod files&quot;);
+		return;
+	}
+
+	std::map&lt;std::string, std::string&gt; modMap; // name, desc  (using a map to sort)
+	for (std::vector&lt;CArchiveScanner::ModData&gt;::iterator it = found.begin(); it != found.end(); ++it) {
+		modMap[it-&gt;name] = it-&gt;description;
+	}
+
+	list-&gt;AddItem(&quot;Random mod&quot;, &quot;Random mod&quot;); // always first
+	std::map&lt;std::string, std::string&gt;::iterator mit;
+	for (mit = modMap.begin(); mit != modMap.end(); ++mit) {
+		list-&gt;AddItem(mit-&gt;first.c_str(), mit-&gt;second.c_str());
+	}
+	showList = list;
+}
+
+
+void SelectMenu::SelectMap(const std::string&amp; s)
+{
+	if (s == &quot;Random map&quot;) {
+		userMap = showList-&gt;items[1 + gu-&gt;usRandInt() % (showList-&gt;items.size() - 1)];
+	}
+	else
+		userMap = s;
+
+	delete showList;
+	showList = NULL;
+	
+	pregame = new CPreGame(mySettings);
+	pregame-&gt;LoadSetupscript(CreateDefaultSetup(userMap, userMod, userScript, mySettings-&gt;myPlayerName));
+	delete this;
+}
+
+
+void SelectMenu::SelectScript(const std::string&amp; s)
+{
+	userScript = s;
+
+	delete showList;
+	showList = NULL;
+
+	ShowMapList();
+}
+
+
+void SelectMenu::SelectMod(const std::string&amp; s)
+{
+	if (s == &quot;Random mod&quot;) {
+		const int index = 1 + (gu-&gt;usRandInt() % (showList-&gt;items.size() - 1));
+		userMod = showList-&gt;items[index];
+	}
+	else
+		userMod = s;
+
+	delete showList;
+	showList = NULL;
+
+	ShowScriptList();
+}
+

Modified: trunk/rts/Game/SelectMenu.h
===================================================================
--- trunk/rts/Game/SelectMenu.h	2008-11-01 13:46:27 UTC (rev 6943)
+++ trunk/rts/Game/SelectMenu.h	2008-11-01 14:19:58 UTC (rev 6944)
@@ -3,6 +3,9 @@
 
 #include &quot;GameController.h&quot;
 
+class LocalSetup;
+class CglList;
+
 class SelectMenu : public CGameController
 {
 public:
@@ -12,8 +15,23 @@
 	int KeyPressed(unsigned short k, bool isRepeat);
 	bool Update();
 	
+	void ShowMapList();
+	void ShowScriptList();
+	void ShowModList();
+	CglList* showList;
+	
+	/// Choose the script we will tell the server to start with
+	void SelectScript(const std::string&amp; s);
+	void SelectMap(const std::string&amp; s);
+	void SelectMod(const std::string&amp; s);
+	
 private:
-	bool isServer;
+	std::string userScript;
+	std::string userMap;
+	std::string userMod;
+	
+	bool addressKnown;
+	LocalSetup* mySettings;
 };
 
 #endif
\ No newline at end of file

Modified: trunk/rts/Rendering/GL/glList.h
===================================================================
--- trunk/rts/Rendering/GL/glList.h	2008-11-01 13:46:27 UTC (rev 6943)
+++ trunk/rts/Rendering/GL/glList.h	2008-11-01 14:19:58 UTC (rev 6944)
@@ -4,12 +4,14 @@
 //
 //////////////////////////////////////////////////////////////////////
 
-#include &quot;Game/UI/InputReceiver.h&quot;
 #include &lt;string&gt;
 #include &lt;vector&gt;
+#include &lt;boost/function.hpp&gt;
 
-typedef void (* ListSelectCallback) (std::string selected);
+#include &quot;Game/UI/InputReceiver.h&quot;
 
+typedef boost::function&lt;void(const std::string&amp;)&gt; ListSelectCallback;
+
 class CglList : public CInputReceiver
 {
 public:

Modified: trunk/rts/System/DemoReader.cpp
===================================================================
--- trunk/rts/System/DemoReader.cpp	2008-11-01 13:46:27 UTC (rev 6943)
+++ trunk/rts/System/DemoReader.cpp	2008-11-01 14:19:58 UTC (rev 6944)
@@ -2,6 +2,7 @@
 
 #include &lt;limits.h&gt;
 #include &lt;stdexcept&gt;
+#include &lt;assert.h&gt;
 #include &quot;mmgr.h&quot;
 
 #include &quot;DemoReader.h&quot;
@@ -53,20 +54,6 @@
 		throw std::runtime_error(std::string(&quot;Demofile corrupt or created by a different version of Spring: &quot;)+filename);
 	}
 
-	if (fileHeader.scriptSize != 0) {
-		char* buf = new char[fileHeader.scriptSize];
-		playbackDemo-&gt;Read(buf, fileHeader.scriptSize);
-		if (!gameSetup) { // dont overwrite existing gamesetup (when hosting a demo)
-			CGameSetup* temp = new CGameSetup();
-			temp-&gt;Init(buf, fileHeader.scriptSize);
-			temp-&gt;demoName = filename;
-			temp-&gt;numDemoPlayers = GetFileHeader().maxPlayerNum+1;
-			temp-&gt;maxSpeed = 10;
-			gameSetup = temp;
-		}
-		delete[] buf;
-	}
-
 	playbackDemo-&gt;Read((void*)&amp;chunkHeader, sizeof(chunkHeader));
 	chunkHeader.swab();
 

Modified: trunk/rts/System/DemoRecorder.cpp
===================================================================
--- trunk/rts/System/DemoRecorder.cpp	2008-11-01 13:46:27 UTC (rev 6943)
+++ trunk/rts/System/DemoRecorder.cpp	2008-11-01 14:19:58 UTC (rev 6944)
@@ -47,16 +47,6 @@
 
 	recordDemo.write((char*)&amp;fileHeader, sizeof(fileHeader));
 
-	if (gameSetup) {
-		// strip trailing null termination characters
-		int length = gameSetup-&gt;gameSetupTextLength;
-		while (gameSetup-&gt;gameSetupText[length - 1] == '\0')
-			--length;
-
-		fileHeader.scriptSize = length;
-		recordDemo.write(gameSetup-&gt;gameSetupText, length);
-	}
-
 	fileHeader.playerStatElemSize = sizeof(CPlayer::Statistics);
 	fileHeader.teamStatElemSize = sizeof(CTeam::Statistics);
 	fileHeader.teamStatPeriod = CTeam::statsPeriod;
@@ -85,6 +75,16 @@
 	}
 }
 
+void CDemoRecorder::WriteSetupText(const std::string&amp; text)
+{
+	int length = gameSetup-&gt;gameSetupText.length();
+	while (gameSetup-&gt;gameSetupText.c_str()[length - 1] == '\0')
+		--length;
+
+	fileHeader.scriptSize = length;
+	recordDemo.write(gameSetup-&gt;gameSetupText.c_str(), length);
+}
+
 void CDemoRecorder::SaveToDemo(const unsigned char* buf, const unsigned length)
 {
 	DemoStreamChunkHeader chunkHeader;

Modified: trunk/rts/System/DemoRecorder.h
===================================================================
--- trunk/rts/System/DemoRecorder.h	2008-11-01 13:46:27 UTC (rev 6943)
+++ trunk/rts/System/DemoRecorder.h	2008-11-01 14:19:58 UTC (rev 6944)
@@ -17,6 +17,7 @@
 	CDemoRecorder();
 	~CDemoRecorder();
 
+	void WriteSetupText(const std::string&amp; text);
 	void SaveToDemo(const unsigned char* buf,const unsigned length);
 	
 	/**

Modified: trunk/rts/System/NetProtocol.cpp
===================================================================
--- trunk/rts/System/NetProtocol.cpp	2008-11-01 13:46:27 UTC (rev 6943)
+++ trunk/rts/System/NetProtocol.cpp	2008-11-01 14:19:58 UTC (rev 6944)
@@ -23,7 +23,6 @@
 
 CNetProtocol::CNetProtocol()
 {
-	localDemoPlayback = false;
 }
 
 CNetProtocol::~CNetProtocol()
@@ -54,10 +53,7 @@
 {
 	server.reset(new netcode::CLocalConnection);
 	server-&gt;Flush();
-	if (!localDemoPlayback)
-	{
-		record.reset(new CDemoRecorder());
-	}
+	record.reset(new CDemoRecorder()); //TODO don't record a new demo when already watching one
 	
 	logOutput.Print(&quot;Connecting to local server&quot;);
 }

Modified: trunk/rts/System/NetProtocol.h
===================================================================
--- trunk/rts/System/NetProtocol.h	2008-11-01 13:46:27 UTC (rev 6943)
+++ trunk/rts/System/NetProtocol.h	2008-11-01 14:19:58 UTC (rev 6944)
@@ -41,12 +41,6 @@
 	bool Connected() const;
 
 	/**
-	@brief Wheter a demo is played local
-	@todo remove
-	*/
-	bool localDemoPlayback;
-
-	/**
 	@brief Take a look at the messages in the recieve buffer (read-only)
 	@return A RawPacket holding the data, or 0 if no data
 	@param ahead How many packets to look ahead. A typical usage would be:

Modified: trunk/rts/System/SpringApp.cpp
===================================================================
--- trunk/rts/System/SpringApp.cpp	2008-11-01 13:46:27 UTC (rev 6943)
+++ trunk/rts/System/SpringApp.cpp	2008-11-01 14:19:58 UTC (rev 6944)
@@ -821,36 +821,31 @@
 		else if (cmdline-&gt;result(&quot;server&quot;))
 			startsetup-&gt;isHost = true;
 
-		CGameSetup* temp = SAFE_NEW CGameSetup();
-		if (temp-&gt;Init(startscript))
-		{
-			gameSetup = const_cast&lt;const CGameSetup*&gt;(temp);
-			gs-&gt;LoadFromSetup(gameSetup);
-		}
-		else
-		{
-			throw content_error(&quot;Setupscript parse error: &quot;+startscript);
-		}
 #ifdef SYNCDEBUG
 		CSyncDebugger::GetInstance()-&gt;Initialize(startsetup-&gt;isHost);
 #endif
-		pregame = SAFE_NEW CPreGame(startsetup, &quot;&quot;, &quot;&quot;);
+		pregame = SAFE_NEW CPreGame(startsetup);
+		if (startsetup-&gt;isHost)
+			pregame-&gt;LoadSetupscript(buf);
 	}
 	else if (!demofile.empty())
 	{
-		startsetup-&gt;isHost = false;
+		startsetup-&gt;isHost = true; // local demo play
+		startsetup-&gt;myPlayerName = configHandler.GetString(&quot;name&quot;, &quot;unnamed&quot;);
 #ifdef SYNCDEBUG
-		CSyncDebugger::GetInstance()-&gt;Initialize(false);
+		CSyncDebugger::GetInstance()-&gt;Initialize(true);
 #endif
-		pregame = SAFE_NEW CPreGame(startsetup, demofile, &quot;&quot;);
+		pregame = SAFE_NEW CPreGame(startsetup);
+		pregame-&gt;LoadDemo(demofile);
 	}
 	else if (!savefile.empty())
 	{
-		startsetup-&gt;isHost = false;
+		startsetup-&gt;isHost = true;
 #ifdef SYNCDEBUG
-		CSyncDebugger::GetInstance()-&gt;Initialize(false);
+		CSyncDebugger::GetInstance()-&gt;Initialize(true);
 #endif
-		pregame = SAFE_NEW CPreGame(startsetup, &quot;&quot;, savefile);
+		pregame = SAFE_NEW CPreGame(startsetup);
+		pregame-&gt;LoadSavefile(savefile);
 	}
 	else
 	{

Modified: trunk/tools/DedicatedServer/main.cpp
===================================================================
--- trunk/tools/DedicatedServer/main.cpp	2008-11-01 13:46:27 UTC (rev 6943)
+++ trunk/tools/DedicatedServer/main.cpp	2008-11-01 14:19:58 UTC (rev 6944)
@@ -104,7 +104,6 @@
 			sleep(1);	// if so, wait 1  second
 #endif
 		delete server;	// delete the server after usage
-		delete gameSetup;
 	}
 	else
 	{


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001712.html">[Taspring-linux-commit] r6943 - in branches/gmltest/rts: System	lib/gml
</A></li>
	<LI>Next message: <A HREF="001714.html">[Taspring-linux-commit] r6945 - trunk/tools/DedicatedServer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1713">[ date ]</a>
              <a href="thread.html#1713">[ thread ]</a>
              <a href="subject.html#1713">[ subject ]</a>
              <a href="author.html#1713">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
