<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r7028 - in branches/caiinterface: .	AI/Group/MexUpgraderAI AI/Skirmish/AAI AI/Skirmish/JCAI	AI/Skirmish/KAI AI/Skirmish/KAIK AI/Skirmish/NTai/AI/NTai/SDK	AI/Skirmish/RAI Documentation rts rts/ExternalAI	rts/ExternalAI/Interface rts/Game rts/Game/Camera	rts/Game/StartScripts rts/Game/UI rts/Lua rts/Map rts/Map/SM3	rts/Map/SM3/terrain rts/Map/SMF rts/Rendering	rts/Rendering/Env rts/Rendering/GL rts/Rendering/Textures	rts/Rendering/UnitModels rts/Sim rts/Sim/Features	rts/Sim/Misc rts/Sim/MoveTypes rts/Sim/Path	rts/Sim/Projectiles rts/Sim/Projectiles/Unsynced	rts/Sim/Projectiles/WeaponProjectiles rts/Sim/Units	rts/Sim/Units/COB rts/Sim/Units/CommandAI	rts/Sim/Units/UnitTypes rts/Sim/Weapons rts/System	rts/System/FileSystem rts/System/Platform	rts/System/Platform/Linux rts/System/Platform/Mac	rts/System/Platform/Win rts/System/Script rts/System/Sync	rts/System/creg rts/build/scons rts/build/vstudio8	rts/lib/gml tools/DedicatedServer tools/unitsync
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-November/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r7028%20-%20in%20branches/caiinterface%3A%20.%0A%09AI/Group/MexUpgraderAI%20AI/Skirmish/AAI%20AI/Skirmish/JCAI%0A%09AI/Skirmish/KAI%20AI/Skirmish/KAIK%20AI/Skirmish/NTai/AI/NTai/SDK%0A%09AI/Skirmish/RAI%20Documentation%20rts%20rts/ExternalAI%0A%09rts/ExternalAI/Interface%20rts/Game%20rts/Game/Camera%0A%09rts/Game/StartScripts%20rts/Game/UI%20rts/Lua%20rts/Map%20rts/Map/SM3%0A%09rts/Map/SM3/terrain%20rts/Map/SMF%20rts/Rendering%0A%09rts/Rendering/Env%20rts/Rendering/GL%20rts/Rendering/Textures%0A%09rts/Rendering/UnitModels%20rts/Sim%20rts/Sim/Features%0A%09rts/Sim/Misc%20rts/Sim/MoveTypes%20rts/Sim/Path%0A%09rts/Sim/Projectiles%20rts/Sim/Projectiles/Unsynced%0A%09rts/Sim/Projectiles/WeaponProjectiles%20rts/Sim/Units%0A%09rts/Sim/Units/COB%20rts/Sim/Units/CommandAI%0A%09rts/Sim/Units/UnitTypes%20rts/Sim/Weapons%20rts/System%0A%09rts/System/FileSystem%20rts/System/Platform%0A%09rts/System/Platform/Linux%20rts/System/Platform/Mac%0A%09rts/System/Platform/Win%20rts/System/Script%20rts/System/Sync%0A%09rts/System/creg%20rts/build/scons%20rts/build/vstudio8%0A%09rts/lib/gml%20tools/DedicatedServer%20tools/unitsync&In-Reply-To=%3C20081113001045.8A93A46E9%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001796.html">
   <LINK REL="Next"  HREF="001798.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r7028 - in branches/caiinterface: .	AI/Group/MexUpgraderAI AI/Skirmish/AAI AI/Skirmish/JCAI	AI/Skirmish/KAI AI/Skirmish/KAIK AI/Skirmish/NTai/AI/NTai/SDK	AI/Skirmish/RAI Documentation rts rts/ExternalAI	rts/ExternalAI/Interface rts/Game rts/Game/Camera	rts/Game/StartScripts rts/Game/UI rts/Lua rts/Map rts/Map/SM3	rts/Map/SM3/terrain rts/Map/SMF rts/Rendering	rts/Rendering/Env rts/Rendering/GL rts/Rendering/Textures	rts/Rendering/UnitModels rts/Sim rts/Sim/Features	rts/Sim/Misc rts/Sim/MoveTypes rts/Sim/Path	rts/Sim/Projectiles rts/Sim/Projectiles/Unsynced	rts/Sim/Projectiles/WeaponProjectiles rts/Sim/Units	rts/Sim/Units/COB rts/Sim/Units/CommandAI	rts/Sim/Units/UnitTypes rts/Sim/Weapons rts/System	rts/System/FileSystem rts/System/Platform	rts/System/Platform/Linux rts/System/Platform/Mac	rts/System/Platform/Win rts/System/Script rts/System/Sync	rts/System/creg rts/build/scons rts/build/vstudio8	rts/lib/gml tools/DedicatedServer tools/unitsync</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r7028%20-%20in%20branches/caiinterface%3A%20.%0A%09AI/Group/MexUpgraderAI%20AI/Skirmish/AAI%20AI/Skirmish/JCAI%0A%09AI/Skirmish/KAI%20AI/Skirmish/KAIK%20AI/Skirmish/NTai/AI/NTai/SDK%0A%09AI/Skirmish/RAI%20Documentation%20rts%20rts/ExternalAI%0A%09rts/ExternalAI/Interface%20rts/Game%20rts/Game/Camera%0A%09rts/Game/StartScripts%20rts/Game/UI%20rts/Lua%20rts/Map%20rts/Map/SM3%0A%09rts/Map/SM3/terrain%20rts/Map/SMF%20rts/Rendering%0A%09rts/Rendering/Env%20rts/Rendering/GL%20rts/Rendering/Textures%0A%09rts/Rendering/UnitModels%20rts/Sim%20rts/Sim/Features%0A%09rts/Sim/Misc%20rts/Sim/MoveTypes%20rts/Sim/Path%0A%09rts/Sim/Projectiles%20rts/Sim/Projectiles/Unsynced%0A%09rts/Sim/Projectiles/WeaponProjectiles%20rts/Sim/Units%0A%09rts/Sim/Units/COB%20rts/Sim/Units/CommandAI%0A%09rts/Sim/Units/UnitTypes%20rts/Sim/Weapons%20rts/System%0A%09rts/System/FileSystem%20rts/System/Platform%0A%09rts/System/Platform/Linux%20rts/System/Platform/Mac%0A%09rts/System/Platform/Win%20rts/System/Script%20rts/System/Sync%0A%09rts/System/creg%20rts/build/scons%20rts/build/vstudio8%0A%09rts/lib/gml%20tools/DedicatedServer%20tools/unitsync&In-Reply-To=%3C20081113001045.8A93A46E9%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r7028 - in branches/caiinterface: .	AI/Group/MexUpgraderAI AI/Skirmish/AAI AI/Skirmish/JCAI	AI/Skirmish/KAI AI/Skirmish/KAIK AI/Skirmish/NTai/AI/NTai/SDK	AI/Skirmish/RAI Documentation rts rts/ExternalAI	rts/ExternalAI/Interface rts/Game rts/Game/Camera	rts/Game/StartScripts rts/Game/UI rts/Lua rts/Map rts/Map/SM3	rts/Map/SM3/terrain rts/Map/SMF rts/Rendering	rts/Rendering/Env rts/Rendering/GL rts/Rendering/Textures	rts/Rendering/UnitModels rts/Sim rts/Sim/Features	rts/Sim/Misc rts/Sim/MoveTypes rts/Sim/Path	rts/Sim/Projectiles rts/Sim/Projectiles/Unsynced	rts/Sim/Projectiles/WeaponProjectiles rts/Sim/Units	rts/Sim/Units/COB rts/Sim/Units/CommandAI	rts/Sim/Units/UnitTypes rts/Sim/Weapons rts/System	rts/System/FileSystem rts/System/Platform	rts/System/Platform/Linux rts/System/Platform/Mac	rts/System/Platform/Win rts/System/Script rts/System/Sync	rts/System/creg rts/build/scons rts/build/vstudio8	rts/lib/gml tools/DedicatedServer tools/unitsync">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Thu Nov 13 01:10:44 CET 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001796.html">[Taspring-linux-commit] r7027 - trunk
</A></li>
        <LI>Next message: <A HREF="001798.html">[Taspring-linux-commit] r7029 - trunk/rts/System/Platform/Win
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1797">[ date ]</a>
              <a href="thread.html#1797">[ thread ]</a>
              <a href="subject.html#1797">[ subject ]</a>
              <a href="author.html#1797">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: hoijui
Date: 2008-11-13 01:10:39 +0100 (Thu, 13 Nov 2008)
New Revision: 7028

Added:
   branches/caiinterface/rts/Game/PlayerHandler.cpp
   branches/caiinterface/rts/Game/PlayerHandler.h
   branches/caiinterface/rts/Sim/Misc/GlobalConstants.h
   branches/caiinterface/rts/Sim/Misc/GlobalSynced.cpp
   branches/caiinterface/rts/Sim/Misc/GlobalSynced.h
   branches/caiinterface/rts/Sim/Misc/ModInfo.cpp
   branches/caiinterface/rts/Sim/Misc/ModInfo.h
   branches/caiinterface/rts/Sim/Misc/SideParser.cpp
   branches/caiinterface/rts/Sim/Misc/SideParser.h
   branches/caiinterface/rts/Sim/Misc/Team.cpp
   branches/caiinterface/rts/Sim/Misc/Team.h
   branches/caiinterface/rts/Sim/Misc/TeamHandler.cpp
   branches/caiinterface/rts/Sim/Misc/TeamHandler.h
   branches/caiinterface/rts/System/FileSystem/DataDirLocater.cpp
   branches/caiinterface/rts/System/FileSystem/DataDirLocater.h
   branches/caiinterface/rts/System/FileSystem/FileSystem.cpp
   branches/caiinterface/rts/System/FileSystem/FileSystem.h
   branches/caiinterface/rts/System/FileSystem/UnixFileSystemHandler.cpp
   branches/caiinterface/rts/System/FileSystem/UnixFileSystemHandler.h
   branches/caiinterface/tools/unitsync/Doxyfile
Removed:
   branches/caiinterface/rts/Game/GlobalConstants.h
   branches/caiinterface/rts/Game/GlobalSynced.cpp
   branches/caiinterface/rts/Game/GlobalSynced.h
   branches/caiinterface/rts/Game/Team.cpp
   branches/caiinterface/rts/Game/Team.h
   branches/caiinterface/rts/Sim/ModInfo.cpp
   branches/caiinterface/rts/Sim/ModInfo.h
   branches/caiinterface/rts/Sim/SideParser.cpp
   branches/caiinterface/rts/Sim/SideParser.h
   branches/caiinterface/rts/System/Platform/FileSystem.cpp
   branches/caiinterface/rts/System/Platform/FileSystem.h
   branches/caiinterface/rts/System/Platform/Linux/DataDirLocater.cpp
   branches/caiinterface/rts/System/Platform/Linux/DataDirLocater.h
   branches/caiinterface/rts/System/Platform/Linux/UnixFileSystemHandler.cpp
   branches/caiinterface/rts/System/Platform/Linux/UnixFileSystemHandler.h
   branches/caiinterface/rts/System/Platform/Mac/MacFileSystemHandler.cpp
   branches/caiinterface/rts/System/Platform/Mac/MacFileSystemHandler.h
   branches/caiinterface/rts/System/Platform/Win/DataDirLocater.cpp
   branches/caiinterface/rts/System/Platform/Win/DataDirLocater.h
   branches/caiinterface/rts/System/Platform/Win/WinFileSystemHandler.cpp
   branches/caiinterface/rts/System/Platform/Win/WinFileSystemHandler.h
Modified:
   branches/caiinterface/AI/Group/MexUpgraderAI/GroupAI.cpp
   branches/caiinterface/AI/Skirmish/AAI/aidef.h
   branches/caiinterface/AI/Skirmish/JCAI/BaseAIDef.h
   branches/caiinterface/AI/Skirmish/KAI/DamageControl.cpp
   branches/caiinterface/AI/Skirmish/KAIK/AIExport.cpp
   branches/caiinterface/AI/Skirmish/KAIK/Unit.cpp
   branches/caiinterface/AI/Skirmish/KAIK/UnitTable.cpp
   branches/caiinterface/AI/Skirmish/NTai/AI/NTai/SDK/AI.h
   branches/caiinterface/AI/Skirmish/RAI/AIExport.cpp
   branches/caiinterface/CMakeLists.txt
   branches/caiinterface/Documentation/Spring start.txt
   branches/caiinterface/Documentation/changelog.txt
   branches/caiinterface/SConstruct
   branches/caiinterface/rts/CMakeLists.txt
   branches/caiinterface/rts/ExternalAI/AICallback.cpp
   branches/caiinterface/rts/ExternalAI/AICheats.cpp
   branches/caiinterface/rts/ExternalAI/AILibrary.cpp
   branches/caiinterface/rts/ExternalAI/AILibrary.h
   branches/caiinterface/rts/ExternalAI/AILibraryManager.cpp
   branches/caiinterface/rts/ExternalAI/EngineOutHandler.cpp
   branches/caiinterface/rts/ExternalAI/EngineOutHandler.h
   branches/caiinterface/rts/ExternalAI/Group.cpp
   branches/caiinterface/rts/ExternalAI/Group.h
   branches/caiinterface/rts/ExternalAI/GroupHandler.cpp
   branches/caiinterface/rts/ExternalAI/GroupHandler.h
   branches/caiinterface/rts/ExternalAI/Interface/aidefines.h
   branches/caiinterface/rts/ExternalAI/SStaticGlobalData.cpp
   branches/caiinterface/rts/ExternalAI/SkirmishAIWrapper.cpp
   branches/caiinterface/rts/Game/Action.cpp
   branches/caiinterface/rts/Game/Camera.cpp
   branches/caiinterface/rts/Game/Camera/FPSController.cpp
   branches/caiinterface/rts/Game/Camera/FreeController.cpp
   branches/caiinterface/rts/Game/Camera/OrbitController.cpp
   branches/caiinterface/rts/Game/Camera/OverheadController.cpp
   branches/caiinterface/rts/Game/Camera/SmoothController.cpp
   branches/caiinterface/rts/Game/Camera/TWController.cpp
   branches/caiinterface/rts/Game/CameraHandler.cpp
   branches/caiinterface/rts/Game/Game.cpp
   branches/caiinterface/rts/Game/Game.h
   branches/caiinterface/rts/Game/GameController.cpp
   branches/caiinterface/rts/Game/GameHelper.cpp
   branches/caiinterface/rts/Game/GameServer.cpp
   branches/caiinterface/rts/Game/GameServer.h
   branches/caiinterface/rts/Game/GameSetup.cpp
   branches/caiinterface/rts/Game/GameSetup.h
   branches/caiinterface/rts/Game/GameVersion.cpp
   branches/caiinterface/rts/Game/GameVersion.h
   branches/caiinterface/rts/Game/Player.cpp
   branches/caiinterface/rts/Game/Player.h
   branches/caiinterface/rts/Game/PlayerRoster.cpp
   branches/caiinterface/rts/Game/PreGame.cpp
   branches/caiinterface/rts/Game/PreGame.h
   branches/caiinterface/rts/Game/SelectMenu.cpp
   branches/caiinterface/rts/Game/SelectMenu.h
   branches/caiinterface/rts/Game/SelectedUnits.cpp
   branches/caiinterface/rts/Game/SelectedUnitsAI.cpp
   branches/caiinterface/rts/Game/StartScripts/AirScript.cpp
   branches/caiinterface/rts/Game/StartScripts/CommanderScript.cpp
   branches/caiinterface/rts/Game/StartScripts/CommanderScript2.cpp
   branches/caiinterface/rts/Game/StartScripts/LoadScript.cpp
   branches/caiinterface/rts/Game/StartScripts/Script.h
   branches/caiinterface/rts/Game/StartScripts/ScriptHandler.h
   branches/caiinterface/rts/Game/StartScripts/SkirmishAITestScript.cpp
   branches/caiinterface/rts/Game/StartScripts/SpawnScript.cpp
   branches/caiinterface/rts/Game/StartScripts/TestScript.cpp
   branches/caiinterface/rts/Game/UI/CommandColors.cpp
   branches/caiinterface/rts/Game/UI/EndGameBox.cpp
   branches/caiinterface/rts/Game/UI/EndGameBox.h
   branches/caiinterface/rts/Game/UI/GameInfo.cpp
   branches/caiinterface/rts/Game/UI/GameSetupDrawer.cpp
   branches/caiinterface/rts/Game/UI/GuiHandler.cpp
   branches/caiinterface/rts/Game/UI/GuiHandler.h
   branches/caiinterface/rts/Game/UI/HwMouseCursor.cpp
   branches/caiinterface/rts/Game/UI/HwMouseCursor.h
   branches/caiinterface/rts/Game/UI/InfoConsole.h
   branches/caiinterface/rts/Game/UI/InputReceiver.cpp
   branches/caiinterface/rts/Game/UI/InputReceiver.h
   branches/caiinterface/rts/Game/UI/KeyAutoBinder.cpp
   branches/caiinterface/rts/Game/UI/KeyBindings.cpp
   branches/caiinterface/rts/Game/UI/KeyCodes.cpp
   branches/caiinterface/rts/Game/UI/KeySet.cpp
   branches/caiinterface/rts/Game/UI/LuaUI.cpp
   branches/caiinterface/rts/Game/UI/MiniMap.cpp
   branches/caiinterface/rts/Game/UI/MiniMap.h
   branches/caiinterface/rts/Game/UI/MouseCursor.cpp
   branches/caiinterface/rts/Game/UI/MouseHandler.cpp
   branches/caiinterface/rts/Game/UI/QuitBox.cpp
   branches/caiinterface/rts/Game/UI/ResourceBar.cpp
   branches/caiinterface/rts/Game/UI/SelectionKeyHandler.cpp
   branches/caiinterface/rts/Game/UI/ShareBox.cpp
   branches/caiinterface/rts/Game/UI/StartPosSelecter.cpp
   branches/caiinterface/rts/Game/UI/TooltipConsole.cpp
   branches/caiinterface/rts/Game/WaitCommandsAI.cpp
   branches/caiinterface/rts/Game/WaitCommandsAI.h
   branches/caiinterface/rts/Lua/LuaCallInCheck.cpp
   branches/caiinterface/rts/Lua/LuaConstGame.cpp
   branches/caiinterface/rts/Lua/LuaFBOs.cpp
   branches/caiinterface/rts/Lua/LuaFeatureDefs.cpp
   branches/caiinterface/rts/Lua/LuaGaia.cpp
   branches/caiinterface/rts/Lua/LuaHandle.cpp
   branches/caiinterface/rts/Lua/LuaHandle.h
   branches/caiinterface/rts/Lua/LuaHandleSynced.cpp
   branches/caiinterface/rts/Lua/LuaIO.cpp
   branches/caiinterface/rts/Lua/LuaInputReceiver.cpp
   branches/caiinterface/rts/Lua/LuaMaterial.cpp
   branches/caiinterface/rts/Lua/LuaOpenGL.cpp
   branches/caiinterface/rts/Lua/LuaParser.cpp
   branches/caiinterface/rts/Lua/LuaParser.h
   branches/caiinterface/rts/Lua/LuaRBOs.cpp
   branches/caiinterface/rts/Lua/LuaRules.cpp
   branches/caiinterface/rts/Lua/LuaScream.cpp
   branches/caiinterface/rts/Lua/LuaShaders.cpp
   branches/caiinterface/rts/Lua/LuaSyncedCall.cpp
   branches/caiinterface/rts/Lua/LuaSyncedCtrl.cpp
   branches/caiinterface/rts/Lua/LuaSyncedMoveCtrl.cpp
   branches/caiinterface/rts/Lua/LuaSyncedRead.cpp
   branches/caiinterface/rts/Lua/LuaTextures.cpp
   branches/caiinterface/rts/Lua/LuaUnitDefs.cpp
   branches/caiinterface/rts/Lua/LuaUnitRendering.cpp
   branches/caiinterface/rts/Lua/LuaUnsyncedCall.cpp
   branches/caiinterface/rts/Lua/LuaUnsyncedCtrl.cpp
   branches/caiinterface/rts/Lua/LuaUnsyncedCtrl.h
   branches/caiinterface/rts/Lua/LuaUnsyncedRead.cpp
   branches/caiinterface/rts/Lua/LuaUnsyncedRead.h
   branches/caiinterface/rts/Lua/LuaUtils.cpp
   branches/caiinterface/rts/Lua/LuaVFS.cpp
   branches/caiinterface/rts/Lua/LuaWeaponDefs.cpp
   branches/caiinterface/rts/Map/BaseGroundDrawer.cpp
   branches/caiinterface/rts/Map/Ground.h
   branches/caiinterface/rts/Map/HeightMapTexture.cpp
   branches/caiinterface/rts/Map/MapInfo.cpp
   branches/caiinterface/rts/Map/MapParser.cpp
   branches/caiinterface/rts/Map/MetalMap.h
   branches/caiinterface/rts/Map/ReadMap.cpp
   branches/caiinterface/rts/Map/ReadMap.h
   branches/caiinterface/rts/Map/SM3/Sm3GroundDrawer.cpp
   branches/caiinterface/rts/Map/SM3/Sm3Map.cpp
   branches/caiinterface/rts/Map/SM3/terrain/Lightcalc.cpp
   branches/caiinterface/rts/Map/SM3/terrain/Terrain.cpp
   branches/caiinterface/rts/Map/SM3/terrain/TerrainBase.h
   branches/caiinterface/rts/Map/SM3/terrain/TerrainTexture.cpp
   branches/caiinterface/rts/Map/SM3/terrain/TerrainTextureGLSL.cpp
   branches/caiinterface/rts/Map/SM3/terrain/Textures.cpp
   branches/caiinterface/rts/Map/SMF/BFGroundDrawer.cpp
   branches/caiinterface/rts/Map/SMF/SmfMapFile.cpp
   branches/caiinterface/rts/Map/SMF/SmfReadMap.cpp
   branches/caiinterface/rts/Rendering/Env/AdvSky.cpp
   branches/caiinterface/rts/Rendering/Env/AdvTreeGenerator.cpp
   branches/caiinterface/rts/Rendering/Env/AdvWater.cpp
   branches/caiinterface/rts/Rendering/Env/BaseTreeDrawer.cpp
   branches/caiinterface/rts/Rendering/Env/BaseWater.cpp
   branches/caiinterface/rts/Rendering/Env/BasicSky.cpp
   branches/caiinterface/rts/Rendering/Env/BasicTreeDrawer.cpp
   branches/caiinterface/rts/Rendering/Env/BasicWater.cpp
   branches/caiinterface/rts/Rendering/Env/BumpWater.cpp
   branches/caiinterface/rts/Rendering/Env/DynWater.cpp
   branches/caiinterface/rts/Rendering/Env/GrassDrawer.cpp
   branches/caiinterface/rts/Rendering/Env/RefractWater.cpp
   branches/caiinterface/rts/Rendering/Env/SkyBox.cpp
   branches/caiinterface/rts/Rendering/FartextureHandler.cpp
   branches/caiinterface/rts/Rendering/FartextureHandler.h
   branches/caiinterface/rts/Rendering/GL/FBO.h
   branches/caiinterface/rts/Rendering/GL/IFramebuffer.h
   branches/caiinterface/rts/Rendering/GL/VertexArray.h
   branches/caiinterface/rts/Rendering/GL/glList.cpp
   branches/caiinterface/rts/Rendering/GL/myGL.cpp
   branches/caiinterface/rts/Rendering/GL/myGL.h
   branches/caiinterface/rts/Rendering/GroundDecalHandler.cpp
   branches/caiinterface/rts/Rendering/GroundDecalHandler.h
   branches/caiinterface/rts/Rendering/GroundFlash.cpp
   branches/caiinterface/rts/Rendering/GroundFlash.h
   branches/caiinterface/rts/Rendering/IconHandler.cpp
   branches/caiinterface/rts/Rendering/InMapDraw.cpp
   branches/caiinterface/rts/Rendering/InMapDraw.h
   branches/caiinterface/rts/Rendering/ShadowHandler.cpp
   branches/caiinterface/rts/Rendering/Textures/Bitmap.cpp
   branches/caiinterface/rts/Rendering/Textures/Bitmap.h
   branches/caiinterface/rts/Rendering/Textures/ColorMap.cpp
   branches/caiinterface/rts/Rendering/Textures/NamedTextures.cpp
   branches/caiinterface/rts/Rendering/Textures/TextureAtlas.cpp
   branches/caiinterface/rts/Rendering/Textures/TextureHandler.cpp
   branches/caiinterface/rts/Rendering/UnitModels/3DModelParser.cpp
   branches/caiinterface/rts/Rendering/UnitModels/3DOParser.cpp
   branches/caiinterface/rts/Rendering/UnitModels/UnitDrawer.cpp
   branches/caiinterface/rts/Rendering/UnitModels/s3oParser.cpp
   branches/caiinterface/rts/Rendering/VerticalSync.cpp
   branches/caiinterface/rts/Rendering/glFont.cpp
   branches/caiinterface/rts/Rendering/glFont.h
   branches/caiinterface/rts/Sim/Features/Feature.cpp
   branches/caiinterface/rts/Sim/Features/FeatureHandler.cpp
   branches/caiinterface/rts/Sim/Features/FeatureHandler.h
   branches/caiinterface/rts/Sim/Misc/AirBaseHandler.cpp
   branches/caiinterface/rts/Sim/Misc/AirBaseHandler.h
   branches/caiinterface/rts/Sim/Misc/CategoryHandler.cpp
   branches/caiinterface/rts/Sim/Misc/CollisionHandler.cpp
   branches/caiinterface/rts/Sim/Misc/CollisionHandler.h
   branches/caiinterface/rts/Sim/Misc/DamageArrayHandler.cpp
   branches/caiinterface/rts/Sim/Misc/GroundBlockingObjectMap.cpp
   branches/caiinterface/rts/Sim/Misc/InterceptHandler.cpp
   branches/caiinterface/rts/Sim/Misc/LosHandler.cpp
   branches/caiinterface/rts/Sim/Misc/QuadField.cpp
   branches/caiinterface/rts/Sim/Misc/QuadField.h
   branches/caiinterface/rts/Sim/Misc/RadarHandler.cpp
   branches/caiinterface/rts/Sim/Misc/Wind.cpp
   branches/caiinterface/rts/Sim/MoveTypes/GroundMoveType.cpp
   branches/caiinterface/rts/Sim/MoveTypes/MoveInfo.cpp
   branches/caiinterface/rts/Sim/MoveTypes/MoveType.h
   branches/caiinterface/rts/Sim/MoveTypes/ScriptMoveType.cpp
   branches/caiinterface/rts/Sim/MoveTypes/TAAirMoveType.cpp
   branches/caiinterface/rts/Sim/Path/PathCache.cpp
   branches/caiinterface/rts/Sim/Path/PathCache.h
   branches/caiinterface/rts/Sim/Path/PathEstimator.cpp
   branches/caiinterface/rts/Sim/Path/PathManager.cpp
   branches/caiinterface/rts/Sim/Projectiles/ExpGenSpawner.cpp
   branches/caiinterface/rts/Sim/Projectiles/ExplosionGenerator.cpp
   branches/caiinterface/rts/Sim/Projectiles/FireProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/FlareProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/PieceProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/Projectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/ProjectileHandler.cpp
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/BitmapMuzzleFlame.cpp
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/BubbleProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/DirtProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/ExploSpikeProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/GenericParticleProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/GeoSquareProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/GfxProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/HeatCloudProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/MuzzleFlame.cpp
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/RepulseGfx.cpp
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/ShieldPartProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/SimpleParticleSystem.cpp
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/SmokeProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/SmokeProjectile2.cpp
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/SmokeTrailProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/SpherePartProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/TracerProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/WakeProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/Unsynced/WreckProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/EmgProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/ExplosiveProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/FireBallProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/FlameProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/LargeBeamLaserProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/LaserProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/LightningProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/MissileProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/StarburstProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/TorpedoProjectile.cpp
   branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/WeaponProjectile.cpp
   branches/caiinterface/rts/Sim/Units/COB/CobFile.cpp
   branches/caiinterface/rts/Sim/Units/COB/CobInstance.cpp
   branches/caiinterface/rts/Sim/Units/COB/CobInstance.h
   branches/caiinterface/rts/Sim/Units/COB/CobThread.cpp
   branches/caiinterface/rts/Sim/Units/CommandAI/AirCAI.cpp
   branches/caiinterface/rts/Sim/Units/CommandAI/BuilderCAI.cpp
   branches/caiinterface/rts/Sim/Units/CommandAI/BuilderCAI.h
   branches/caiinterface/rts/Sim/Units/CommandAI/CommandAI.cpp
   branches/caiinterface/rts/Sim/Units/CommandAI/CommandAI.h
   branches/caiinterface/rts/Sim/Units/CommandAI/CommandQueue.h
   branches/caiinterface/rts/Sim/Units/CommandAI/FactoryCAI.cpp
   branches/caiinterface/rts/Sim/Units/CommandAI/MobileCAI.cpp
   branches/caiinterface/rts/Sim/Units/CommandAI/TransportCAI.cpp
   branches/caiinterface/rts/Sim/Units/Unit.cpp
   branches/caiinterface/rts/Sim/Units/Unit.h
   branches/caiinterface/rts/Sim/Units/UnitDef.h
   branches/caiinterface/rts/Sim/Units/UnitDefHandler.cpp
   branches/caiinterface/rts/Sim/Units/UnitHandler.cpp
   branches/caiinterface/rts/Sim/Units/UnitHandler.h
   branches/caiinterface/rts/Sim/Units/UnitLoader.cpp
   branches/caiinterface/rts/Sim/Units/UnitTracker.cpp
   branches/caiinterface/rts/Sim/Units/UnitTypes/Builder.cpp
   branches/caiinterface/rts/Sim/Units/UnitTypes/Building.cpp
   branches/caiinterface/rts/Sim/Units/UnitTypes/ExtractorBuilding.cpp
   branches/caiinterface/rts/Sim/Units/UnitTypes/Factory.cpp
   branches/caiinterface/rts/Sim/Units/UnitTypes/TransportUnit.cpp
   branches/caiinterface/rts/Sim/Weapons/BeamLaser.cpp
   branches/caiinterface/rts/Sim/Weapons/DGunWeapon.cpp
   branches/caiinterface/rts/Sim/Weapons/EmgCannon.cpp
   branches/caiinterface/rts/Sim/Weapons/MeleeWeapon.cpp
   branches/caiinterface/rts/Sim/Weapons/PlasmaRepulser.cpp
   branches/caiinterface/rts/Sim/Weapons/Rifle.cpp
   branches/caiinterface/rts/Sim/Weapons/Weapon.cpp
   branches/caiinterface/rts/Sim/Weapons/WeaponDefHandler.cpp
   branches/caiinterface/rts/Sim/Weapons/bombdropper.cpp
   branches/caiinterface/rts/System/DemoReader.cpp
   branches/caiinterface/rts/System/DemoRecorder.cpp
   branches/caiinterface/rts/System/DemoRecorder.h
   branches/caiinterface/rts/System/FileSystem/ArchiveDir.cpp
   branches/caiinterface/rts/System/FileSystem/ArchiveFactory.cpp
   branches/caiinterface/rts/System/FileSystem/ArchiveScanner.cpp
   branches/caiinterface/rts/System/FileSystem/FileHandler.cpp
   branches/caiinterface/rts/System/FileSystem/SimpleParser.h
   branches/caiinterface/rts/System/FileSystem/VFSHandler.cpp
   branches/caiinterface/rts/System/GlobalUnsynced.cpp
   branches/caiinterface/rts/System/LoadSaveHandler.cpp
   branches/caiinterface/rts/System/LogOutput.cpp
   branches/caiinterface/rts/System/Messages.cpp
   branches/caiinterface/rts/System/MouseInput.cpp
   branches/caiinterface/rts/System/Platform/ConfigHandler.cpp
   branches/caiinterface/rts/System/Platform/ConfigHandler.h
   branches/caiinterface/rts/System/Platform/Linux/DotfileHandler.cpp
   branches/caiinterface/rts/System/Platform/Linux/OggStream.cpp
   branches/caiinterface/rts/System/Platform/Linux/OggStream.h
   branches/caiinterface/rts/System/Platform/Linux/OpenALSound.cpp
   branches/caiinterface/rts/System/Platform/Linux/OpenALSound.h
   branches/caiinterface/rts/System/Platform/NullSound.h
   branches/caiinterface/rts/System/Platform/Win/AVIGenerator.cpp
   branches/caiinterface/rts/System/Platform/Win/CrashHandler.cpp
   branches/caiinterface/rts/System/Platform/Win/DxSound.cpp
   branches/caiinterface/rts/System/Platform/Win/DxSound.h
   branches/caiinterface/rts/System/Platform/Win/OggStream.cpp
   branches/caiinterface/rts/System/Platform/Win/OggStream.h
   branches/caiinterface/rts/System/Platform/byteorder.h
   branches/caiinterface/rts/System/Platform/errorhandler.cpp
   branches/caiinterface/rts/System/Script/LuaBinder.cpp
   branches/caiinterface/rts/System/Script/LuaFunctions.cpp
   branches/caiinterface/rts/System/Sound.cpp
   branches/caiinterface/rts/System/Sound.h
   branches/caiinterface/rts/System/SpringApp.cpp
   branches/caiinterface/rts/System/StdAfx.h
   branches/caiinterface/rts/System/Sync/SyncChecker.h
   branches/caiinterface/rts/System/Sync/SyncDebugger.cpp
   branches/caiinterface/rts/System/Sync/SyncDebugger.h
   branches/caiinterface/rts/System/Sync/SyncTracer.cpp
   branches/caiinterface/rts/System/TdfParser.cpp
   branches/caiinterface/rts/System/TdfParser.h
   branches/caiinterface/rts/System/creg/STL_Map.h
   branches/caiinterface/rts/System/creg/STL_Set.h
   branches/caiinterface/rts/System/creg/creg.cpp
   branches/caiinterface/rts/System/myMath.h
   branches/caiinterface/rts/build/scons/filelist.py
   branches/caiinterface/rts/build/scons/rts.py
   branches/caiinterface/rts/build/vstudio8/rts.vcproj
   branches/caiinterface/rts/lib/gml/gml.cpp
   branches/caiinterface/tools/DedicatedServer/CMakeLists.txt
   branches/caiinterface/tools/DedicatedServer/main.cpp
   branches/caiinterface/tools/unitsync/CMakeLists.txt
   branches/caiinterface/tools/unitsync/javabind.cpp
   branches/caiinterface/tools/unitsync/pybind.cpp
   branches/caiinterface/tools/unitsync/unitsync.cpp
   branches/caiinterface/tools/unitsync/unitsync.h
Log:
reintegrated trunk up to 7027

Modified: branches/caiinterface/AI/Group/MexUpgraderAI/GroupAI.cpp
===================================================================
--- branches/caiinterface/AI/Group/MexUpgraderAI/GroupAI.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/AI/Group/MexUpgraderAI/GroupAI.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -13,7 +13,7 @@
 #include &quot;creg/STL_Set.h&quot;
 #include &quot;creg/Serializer.h&quot;
 #include &quot;creg/cregex.h&quot;
-#include &quot;Game/GlobalConstants.h&quot;
+#include &quot;Sim/Misc/GlobalConstants.h&quot;
 
 #define CMD_CHANGE_MODE 	160
 #define CMD_AREA_UPGRADE 	165

Modified: branches/caiinterface/AI/Skirmish/AAI/aidef.h
===================================================================
--- branches/caiinterface/AI/Skirmish/AAI/aidef.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/AI/Skirmish/AAI/aidef.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -21,7 +21,7 @@
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;Sim/MoveTypes/MoveInfo.h&quot;
 #include &quot;System/Vec2.h&quot;
-#include &quot;Game/GlobalConstants.h&quot;
+#include &quot;Sim/Misc/GlobalConstants.h&quot;
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
 #include &quot;Sim/Units/CommandAI/CommandQueue.h&quot;
 #include &quot;AAIConfig.h&quot;

Modified: branches/caiinterface/AI/Skirmish/JCAI/BaseAIDef.h
===================================================================
--- branches/caiinterface/AI/Skirmish/JCAI/BaseAIDef.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/AI/Skirmish/JCAI/BaseAIDef.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -3,20 +3,20 @@
 //
 // A skirmish AI for the TA Spring engine.
 // Copyright Jelmer Cnossen
-// 
+//
 // Released under GPL license: see LICENSE.html for more information.
 //-------------------------------------------------------------------------
 #ifndef JC_BASE_AI_DEF_H
 #define JC_BASE_AI_DEF_H
 
 #include &quot;System/Vec2.h&quot;
-#include &quot;Game/GlobalConstants.h&quot;
+#include &quot;Sim/Misc/GlobalConstants.h&quot;
 #include &quot;ExternalAI/IGlobalAI.h&quot;
 #include &quot;ExternalAI/IGlobalAICallback.h&quot;
 #include &quot;ExternalAI/IAICallback.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;Sim/MoveTypes/MoveInfo.h&quot;
-#include &lt;assert.h&gt; 
+#include &lt;assert.h&gt;
 #include &lt;algorithm&gt;
 #include &lt;map&gt;
 #include &lt;set&gt;
@@ -30,7 +30,7 @@
 
 #ifdef _MSC_VER
 #pragma warning(disable: 4244 4018) // signed/unsigned and loss of precision...
-#endif 
+#endif
 
 typedef unsigned char uchar;
 typedef unsigned long ulong;
@@ -63,9 +63,9 @@
 #define AI_PATH &quot;aidll/globalai/jcai/&quot;
 
 
-struct ResourceInfo 
+struct ResourceInfo
 {
-	ResourceInfo() { energy=metal=0.0f; } 
+	ResourceInfo() { energy=metal=0.0f; }
 	ResourceInfo(float e,float m) : energy(e),metal(m) {}
 	ResourceInfo&amp; operator+=(const ResourceInfo &amp;x) { energy+=x.energy; metal+=x.metal; return *this; }
 	ResourceInfo&amp; operator-=(const ResourceInfo &amp;x) { energy-=x.energy; metal-=x.metal; return *this; }

Modified: branches/caiinterface/AI/Skirmish/KAI/DamageControl.cpp
===================================================================
--- branches/caiinterface/AI/Skirmish/KAI/DamageControl.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/AI/Skirmish/KAI/DamageControl.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,6 +1,6 @@
 #include &quot;DamageControl.h&quot;
 
-#include &quot;Game/GlobalConstants.h&quot;
+#include &quot;Sim/Misc/GlobalConstants.h&quot;
 
 CDamageControl::CDamageControl(AIClasses* ai)
 {
@@ -21,14 +21,14 @@
 }
 
 void CDamageControl::GenerateDPSTables()
-{	
+{
 	L(&quot;Generating DPS tables....&quot;);
 	//L(&quot;&quot;);
 	for(int i= 1; i &lt;= NumOfUnitTypes; i++){
 		//L(&quot;*****************************UNIT: &quot; &lt;&lt; ai-&gt;ut-&gt;unittypearray[i].def-&gt;humanName);
 		ai-&gt;ut-&gt;unittypearray[i].DPSvsUnit.resize(NumOfUnitTypes+1);
 		ai-&gt;ut-&gt;unittypearray[i].AverageDPS = 0;
-		for(int v = 1; v &lt;= NumOfUnitTypes; v++){			
+		for(int v = 1; v &lt;= NumOfUnitTypes; v++){
 			float dps = GetDPSvsUnit(ai-&gt;ut-&gt;unittypearray[i].def,ai-&gt;ut-&gt;unittypearray[v].def);
 			ai-&gt;ut-&gt;unittypearray[i].DPSvsUnit[v] = dps;
 			ai-&gt;ut-&gt;unittypearray[i].AverageDPS += dps;
@@ -56,12 +56,12 @@
 		if(enemiesCount[i] &gt; 0)
 		{
 			//int id = ai-&gt;cheat-&gt;GetUnitDef(enemies[i])-&gt;id;
-			UnitType* unitType = &amp;unittypearray[i];			
+			UnitType* unitType = &amp;unittypearray[i];
 			float enemycost = unitType-&gt;Cost * enemiesCount[i];
 			TheirTotalCost += enemycost;
 			if(unitType-&gt;def-&gt;isCommander)
 				enemycost = 100; // Ignore the commander (hack mostly)
-			TheirUnitsAll[i].Cost = enemycost;			
+			TheirUnitsAll[i].Cost = enemycost;
 			TheirUnitsAll[i].Hitpoints = unitType-&gt;def-&gt;health * enemiesCount[i];
 			if(ai-&gt;ut-&gt;GetCategory(unitType-&gt;def) == CAT_DEFENCE){
 				TheirDefences[i].Cost = enemycost;
@@ -99,7 +99,7 @@
 void CDamageControl::UpdateMyDistribution()
 {
 	//L(&quot;UpdateMyDistribution&quot;);
-	MyTotalCost = 0.0001; // Safety if I have 0 units.	
+	MyTotalCost = 0.0001; // Safety if I have 0 units.
 	//ai-&gt;math-&gt;TimerStart();
 	for(int i= 1; i &lt;= NumOfUnitTypes; i++){
 		MyUnitsAll[i].Clear();
@@ -155,7 +155,7 @@
 {
 	//L(&quot;Getting CombatScore for : &quot; &lt;&lt; unit-&gt;humanName &lt;&lt; &quot; number of units: &quot; &lt;&lt; NumOfUnitTypes);
 	float score = 0;
-	int category = GCAT(unit); 
+	int category = GCAT(unit);
 	bool foundaunit = false;
 	if(category == CAT_ATTACK || category == CAT_ARTILLERY || category == CAT_ASSAULT){
 		for(int i = 1; i &lt;= NumOfUnitTypes; i++){
@@ -192,7 +192,7 @@
 				score+= ai-&gt;ut-&gt;unittypearray[unit-&gt;id].DPSvsUnit[i] * TheirArmy[i].Cost / TheirArmy[i].Hitpoints / (MyDefences[i].Damage + 1); // kill the stuff with the best value
 				//L(&quot;Score:&quot; &lt;&lt; score);
 				//score+= 0; // This was for making a debug brakepoint
-				foundaunit = true;				
+				foundaunit = true;
 			}
 		}
 		if(!foundaunit){ // if nothing found try to kill his movable units (comm and builders)
@@ -236,7 +236,7 @@
 		float dps = 0;
 		bool canhit = false;
 		bool underwater = false;
-		//string targetcat;	
+		//string targetcat;
 		int armortype = victim-&gt;armorType;
 		int numberofdamages;
 		ai-&gt;cb-&gt;GetValue(AIVAL_NUMDAMAGETYPES,&amp;numberofdamages);
@@ -252,7 +252,7 @@
 				//L(unit-&gt;weapons[i].name &lt;&lt; &quot; Targcat: &quot; &lt;&lt;  targetcat);
 				//L(&quot;unit-&gt;categoryString &quot; &lt;&lt;  unit-&gt;categoryString);
 				//L(&quot;victim-&gt;categoryString &quot; &lt;&lt;  victim-&gt;categoryString);
-				
+
 				unsigned int a = victim-&gt;category;
 				unsigned int b = unit-&gt;weapons[i].def-&gt;onlyTargetCategory; // This is what the weapon can target
 				unsigned int c = unit-&gt;weapons[i].onlyTargetCat; // This is what the unit accepts as this weapons target
@@ -277,12 +277,12 @@
 					if(victim-&gt;canfly &amp;&amp; unit-&gt;wantedHeight &lt;= victim-&gt;wantedHeight)
 						canhit = false; // If the target can fly and it flyes below the victim its useless
 				}
-				
+
 				if(canhit){
 					//L(unit-&gt;weapons[i].name &lt;&lt; &quot; a: &quot; &lt;&lt;  a &lt;&lt; &quot;, b: &quot; &lt;&lt; b &lt;&lt; &quot;, c: &quot; &lt;&lt; c &lt;&lt; &quot;, d: &quot; &lt;&lt; d);
 					//L(&quot;unit-&gt;categoryString &quot; &lt;&lt;  unit-&gt;categoryString);
 					//L(&quot;victim-&gt;categoryString &quot; &lt;&lt;  victim-&gt;categoryString);
-				
+
 				}
 				//unit-&gt;weapons[i].def-&gt;turnrate
 				if(canhit){
@@ -319,7 +319,7 @@
 						distancetravelled = 2*sqrt(halfd*halfd+heightreached*heightreached) * 1.1;
 						//L(&quot;Height reached: &quot; &lt;&lt; heightreached &lt;&lt; &quot; distance travelled &quot; &lt;&lt; distancetravelled);
 					}
-					
+
 					//L(&quot;Name: &quot; &lt;&lt; unit-&gt;weapons[i].name &lt;&lt; &quot; AOE: &quot; &lt;&lt; AOE &lt;&lt; &quot; Accuracy: &quot; &lt;&lt; unit-&gt;weapons[i].def-&gt;accuracy &lt;&lt; &quot; range: &quot; &lt;&lt; unit-&gt;weapons[i].def-&gt;range);
 					if((victim-&gt;canfly &amp;&amp; unit-&gt;weapons[i].def-&gt;selfExplode) || !victim-&gt;canfly){
 						impactarea = pow((accuracy*distancetravelled)+AOE,2);
@@ -365,7 +365,7 @@
 					assert(tohitprobability &gt;= 0);
 					dps += basedamage * tohitprobability;
 				}
-			}	
+			}
 		}
 		//if(unit-&gt;weapons.size() &gt; 0)
 		//L(&quot;DPS: &quot; &lt;&lt; dps);

Modified: branches/caiinterface/AI/Skirmish/KAIK/AIExport.cpp
===================================================================
--- branches/caiinterface/AI/Skirmish/KAIK/AIExport.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/AI/Skirmish/KAIK/AIExport.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -26,6 +26,7 @@
 #include &quot;ExternalAI/Interface/SSAILibrary.h&quot;
 #include &quot;LegacyCpp/AI.h&quot;
 #include &quot;LegacyCpp/AIGlobalAI.h&quot;
+#include &quot;Game/GameVersion.h&quot;
 
 // KAIK stuff
 #include &quot;GlobalAI.h&quot;
@@ -65,7 +66,7 @@
 		const char* engineVersionString, int engineVersionNumber,
 		const char* aiInterfaceShortName, const char* aiInterfaceVersion) {
 
-	if (strcmp(engineVersionString, ENGINE_VERSION_STRING) == 0 &amp;&amp;
+	if (strcmp(engineVersionString, SpringVersion::GetFull().c_str()) == 0 &amp;&amp;
 			engineVersionNumber &lt;= ENGINE_VERSION_NUMBER) {
 		return LOS_Working;
 	}

Modified: branches/caiinterface/AI/Skirmish/KAIK/Unit.cpp
===================================================================
--- branches/caiinterface/AI/Skirmish/KAIK/Unit.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/AI/Skirmish/KAIK/Unit.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,7 +1,7 @@
 #include &quot;Unit.h&quot;
 #include &quot;GlobalAI.h&quot;
 
-#include &quot;Game/GlobalConstants.h&quot;
+#include &quot;Sim/Misc/GlobalConstants.h&quot;
 
 CR_BIND(CUNIT, )
 CR_REG_METADATA(CUNIT, (

Modified: branches/caiinterface/AI/Skirmish/KAIK/UnitTable.cpp
===================================================================
--- branches/caiinterface/AI/Skirmish/KAIK/UnitTable.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/AI/Skirmish/KAIK/UnitTable.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -2,7 +2,7 @@
 
 #include &quot;UnitTable.h&quot;
 
-#include &quot;Game/GlobalConstants.h&quot;
+#include &quot;Sim/Misc/GlobalConstants.h&quot;
 #include &quot;System/Util.h&quot;
 
 /// CR_BIND(CUnitTable, );
@@ -18,12 +18,12 @@
 /// 	CR_MEMBER(metal_storages),
 /// 	CR_MEMBER(energy_storages),
 /// 	CR_MEMBER(nuke_silos),
-/// 
+///
 /// 	CR_MEMBER(numOfSides),
 /// 	CR_MEMBER(sideNames),
 /// 	CR_MEMBER(modSideMap),
 /// 	CR_MEMBER(teamSides),
-/// 
+///
 /// 	CR_MEMBER(unitTypes)
 /// ));
 

Modified: branches/caiinterface/AI/Skirmish/NTai/AI/NTai/SDK/AI.h
===================================================================
--- branches/caiinterface/AI/Skirmish/NTai/AI/NTai/SDK/AI.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/AI/Skirmish/NTai/AI/NTai/SDK/AI.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -28,7 +28,7 @@
 #include &quot;ExternalAI/IAICallback.h&quot; // AI Callback
 #include &quot;ExternalAI/IGlobalAICallback.h&quot; //GlobalAI callback
 #include &quot;ExternalAI/IAICheats.h&quot; // Cheat Interface
-#include &quot;Game/GlobalConstants.h&quot; // Common definitions in spring
+#include &quot;Sim/Misc/GlobalConstants.h&quot; // Common definitions in spring
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot; // Needed for WeaponDef
 #include &quot;Sim/Misc/DamageArray.h&quot; // Needed for WeaponDef
 #include &quot;Sim/MoveTypes/MoveInfo.h&quot;

Modified: branches/caiinterface/AI/Skirmish/RAI/AIExport.cpp
===================================================================
--- branches/caiinterface/AI/Skirmish/RAI/AIExport.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/AI/Skirmish/RAI/AIExport.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -26,6 +26,7 @@
 #include &quot;ExternalAI/Interface/SSAILibrary.h&quot;
 #include &quot;LegacyCpp/AI.h&quot;
 #include &quot;LegacyCpp/AIGlobalAI.h&quot;
+#include &quot;Game/GameVersion.h&quot;
 
 // RAI stuff
 #include &quot;RAI.h&quot;
@@ -79,7 +80,7 @@
 		const char* engineVersionString, int engineVersionNumber,
 		const char* aiInterfaceShortName, const char* aiInterfaceVersion) {
 
-	if (strcmp(engineVersionString, ENGINE_VERSION_STRING) == 0 &amp;&amp;
+	if (strcmp(engineVersionString, SpringVersion::GetFull().c_str()) == 0 &amp;&amp;
 			engineVersionNumber &lt;= ENGINE_VERSION_NUMBER) {
 		return LOS_Working;
 	}

Modified: branches/caiinterface/CMakeLists.txt
===================================================================
--- branches/caiinterface/CMakeLists.txt	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/CMakeLists.txt	2008-11-13 00:10:39 UTC (rev 7028)
@@ -70,7 +70,7 @@
 INCLUDE(TestCXXAcceptsVisibilityFlag)
 set (MARCH_FLAG native CACHE STRING &quot;CPU optimization (use i686 for generic optimization)&quot;)
 if (MARCH_FLAG)
-	set (CMAKE_CXX_FLAGS &quot;-march=${MARCH_FLAG} -mfpmath=387&quot;)
+	set (CMAKE_CXX_FLAGS &quot;-march=${MARCH_FLAG} -msse -mfpmath=sse&quot;)
 endif (MARCH_FLAG)
 
 # intel C compiler fix (does not support these flags: -march -mfpmath -ggdb)

Modified: branches/caiinterface/Documentation/Spring start.txt
===================================================================
--- branches/caiinterface/Documentation/Spring start.txt	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/Documentation/Spring start.txt	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,4 +1,4 @@
-// A clients example
+// A clients example using the new syntax
 // If spring is started as client, it needs the following information to work properly
 
 [GAME]
@@ -7,12 +7,11 @@
 	HostPort=xxx;       // standard is 8452
 	SourcePort=0;       // set this if you want a different source port (as client), 0 means OS-select
 
-	MyPlayerNum=x;      //only variable that should vary between different players, (deprecated, if you want to use this you need the full script, even as client)
-	MyPlayerName=somename; //can be used instead of MyPlayerNum
-	IsHost=x;			// 0 - no server will be started in this instance, 1 - start a server (if you don't set this, you need the full script and myPlayerNum to work)
+	MyPlayerName=somename;
+	IsHost=x;			// 0 - no server will be started in this instance, 1 - start a server
 }
 
-// A host example
+// A host example (or client using the old syntax)
 // note that the same values for clients also need to be set here
 [GAME]
 {
@@ -29,10 +28,10 @@
 	SourcePort=0;       // set this if you want a different source port (as client)
 	AutohostPort=X;     // communicate with spring, specify the port you are listening (as host)
 
-	MyPlayerNum=x;      //only variable that should vary between different players, deprecated
+	MyPlayerNum=x;      // deprecated, better use myPlayerName
 	MyPlayerName=somename; //can be used instead of MyPlayerNum (will overwrite it in fact)
 
-	IsHost=x;			// 0 - no server will be started in this instance, 1 - start a server
+	IsHost=x;			// 0 - no server will be started in this instance, 1 - start a server (if not set, you need myPlayerNum)
 	NumPlayers=x;       // not mandatory, but can be used for debugging purposes
 	NumTeams=y;         // same here, set this to check if the script is right
 	NumAllyTeams=z;     // see above

Modified: branches/caiinterface/Documentation/changelog.txt
===================================================================
--- branches/caiinterface/Documentation/changelog.txt	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/Documentation/changelog.txt	2008-11-13 00:10:39 UTC (rev 7028)
@@ -23,6 +23,8 @@
 Lua:
  - added Spring.GetLastMessagePositions() (returns the 10 last message positions)
  - moved Spring.GetDrawSelectionInfo() LuaUnsyncedCtrl -&gt; LuaUnsyncedRead
+ - moved Spring.GetSoundStreamTime() LuaUnsyncedCtrl -&gt; LuaUnsyncedRead
+ - added a 2nd return value to Spring.GetSoundStreamTime() (total sound stream length in seconds)
 
 Unitsync:
  - Don't crash/abort() on invalid handles, but throw exception instead

Modified: branches/caiinterface/SConstruct
===================================================================
--- branches/caiinterface/SConstruct	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/SConstruct	2008-11-13 00:10:39 UTC (rev 7028)
@@ -70,7 +70,7 @@
 # the entire source if one wants to change just the install installprefix (and hence the datadir).
 
 if env['platform'] != 'windows':
-	ddlcpp = env.Object(os.path.join(env['builddir'], 'rts/System/Platform/Linux/DataDirLocater.cpp'), CPPDEFINES = env['CPPDEFINES']+env['spring_defines']+datadir)
+	ddlcpp = env.Object(os.path.join(env['builddir'], 'rts/System/FileSystem/DataDirLocater.cpp'), CPPDEFINES = env['CPPDEFINES']+env['spring_defines']+datadir)
 	spring_files += [ddlcpp]
 	spring = env.Program('game/spring', spring_files, CPPDEFINES=env['CPPDEFINES']+env['spring_defines'])
 else: # create import library and .def file on Windows
@@ -102,7 +102,7 @@
 
 uenv.BuildDir(os.path.join(uenv['builddir'], 'tools/unitsync'), 'tools/unitsync', duplicate = False)
 unitsync_files          = filelist.get_source(uenv, 'tools/unitsync');
-unitsync_fs_files       = filelist.get_source(uenv, 'rts/System/FileSystem/');
+unitsync_fs_files       = filelist.get_source(uenv, 'rts/System/FileSystem/', exclude_list=('rts/System/FileSystem/DataDirLocater.cpp'));
 unitsync_lua_files      = filelist.get_source(uenv, 'rts/lib/lua/src');
 unitsync_7zip_files     = filelist.get_source(uenv, 'rts/lib/7zip');
 unitsync_minizip_files  = filelist.get_source(uenv, 'rts/lib/minizip', 'rts/lib/minizip/iowin32.c');
@@ -116,9 +116,9 @@
 	'rts/Map/SMF/SmfMapFile.cpp',
 	'rts/Rendering/Textures/Bitmap.cpp',
 	'rts/Rendering/Textures/nv_dds.cpp',
-	'rts/Sim/SideParser.cpp',
+	'rts/Sim/Misc/SideParser.cpp',
 	'rts/System/Platform/ConfigHandler.cpp',
-	'rts/System/Platform/FileSystem.cpp',
+	'rts/System/FileSystem/FileSystem.cpp',
 	'rts/System/LogOutput.cpp',
 ]
 for f in unitsync_fs_files:       unitsync_files += f
@@ -133,12 +133,12 @@
 	# during linking
 	if os.name != 'nt':
 		unitsync_files.append('rts/lib/minizip/iowin32.c')
-	for f in ['rts/System/Platform/Win/WinFileSystemHandler.cpp', 'rts/System/Platform/Win/DataDirLocater.cpp', 'rts/System/Platform/Win/RegHandler.cpp']:
+	for f in ['rts/System/Platform/Win/WinFileSystemHandler.cpp', 'rts/System/FileSystem/DataDirLocater.cpp', 'rts/System/Platform/Win/RegHandler.cpp']:
 		unitsync_files += [os.path.join(uenv['builddir'], f)]
 	# Need the -Wl,--kill-at --add-stdcall-alias because TASClient expects undecorated stdcall functions.
 	unitsync = uenv.SharedLibrary('game/unitsync', unitsync_files, LINKFLAGS=env['LINKFLAGS'] + ['-Wl,--kill-at', '--add-stdcall-alias'])
 else:
-	ddlcpp = uenv.SharedObject(os.path.join(uenv['builddir'], 'rts/System/Platform/Linux/DataDirLocater.cpp'), CPPDEFINES = uenv['CPPDEFINES']+datadir)
+	ddlcpp = uenv.SharedObject(os.path.join(uenv['builddir'], 'rts/System/FileSystem/DataDirLocater.cpp'), CPPDEFINES = uenv['CPPDEFINES']+datadir)
 	unitsync_files += [ ddlcpp,
 		os.path.join(uenv['builddir'], 'rts/System/Platform/Linux/DotfileHandler.cpp'),
 		os.path.join(uenv['builddir'], 'rts/System/Platform/Linux/UnixFileSystemHandler.cpp')

Modified: branches/caiinterface/rts/CMakeLists.txt
===================================================================
--- branches/caiinterface/rts/CMakeLists.txt	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/CMakeLists.txt	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,4 +1,4 @@
-ADD_DEFINITIONS(-DSTREFLOP_X87) # should be in ../CMakeLists.txt
+ADD_DEFINITIONS(-DSTREFLOP_SSE) # should be in ../CMakeLists.txt
 
 INCLUDE_DIRECTORIES(${CMAKE_CURRENT_SOURCE_DIR}/ System)
 

Modified: branches/caiinterface/rts/ExternalAI/AICallback.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/AICallback.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/ExternalAI/AICallback.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -7,9 +7,9 @@
 #include &quot;Game/CameraHandler.h&quot;
 #include &quot;Game/GameHelper.h&quot;
 #include &quot;Game/GameSetup.h&quot;
-#include &quot;Game/Player.h&quot;
+#include &quot;Game/PlayerHandler.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
-#include &quot;Game/Team.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Game/UI/MiniMap.h&quot;
 #include &quot;Game/UI/MouseHandler.h&quot;
 #include &quot;Lua/LuaRules.h&quot;
@@ -19,7 +19,7 @@
 #include &quot;NetProtocol.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;Platform/errorhandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;Rendering/InMapDraw.h&quot;
 #include &quot;Rendering/UnitModels/3DModelParser.h&quot;
 #include &quot;Rendering/UnitModels/UnitDrawer.h&quot;
@@ -30,7 +30,7 @@
 #include &quot;Sim/Misc/GeometricObjects.h&quot;
 #include &quot;Sim/Misc/LosHandler.h&quot;
 #include &quot;Sim/Misc/QuadField.h&quot;
-#include &quot;Sim/ModInfo.h&quot;
+#include &quot;Sim/Misc/ModInfo.h&quot;
 #include &quot;Sim/Path/PathManager.h&quot;
 #include &quot;Sim/Units/CommandAI/CommandAI.h&quot;
 #include &quot;Sim/Units/CommandAI/LineDrawer.h&quot;
@@ -111,8 +111,8 @@
 
 	if (team != receivingTeamId) {
 		if (receivingTeamId &gt;= 0 &amp;&amp; receivingTeamId &lt; (MAX_TEAMS - 1)) {
-			if (gs-&gt;Team(receivingTeamId) &amp;&amp; gs-&gt;Team(team)) {
-				if (!gs-&gt;Team(receivingTeamId)-&gt;isDead &amp;&amp; !gs-&gt;Team(team)-&gt;isDead) {
+			if (teamHandler-&gt;Team(receivingTeamId) &amp;&amp; teamHandler-&gt;Team(team)) {
+				if (!teamHandler-&gt;Team(receivingTeamId)-&gt;isDead &amp;&amp; !teamHandler-&gt;Team(team)-&gt;isDead) {
 					// note: we can't use the existing SendShare()
 					// since its handler in CGame uses myPlayerNum
 					// (NETMSG_SHARE param) to determine which team
@@ -141,8 +141,8 @@
 
 	if (team != receivingTeamId) {
 		if (receivingTeamId &gt;= 0 &amp;&amp; receivingTeamId &lt; (MAX_TEAMS - 1)) {
-			if (gs-&gt;Team(receivingTeamId) &amp;&amp; gs-&gt;Team(team)) {
-				if (!gs-&gt;Team(receivingTeamId)-&gt;isDead &amp;&amp; !gs-&gt;Team(team)-&gt;isDead) {
+			if (teamHandler-&gt;Team(receivingTeamId) &amp;&amp; teamHandler-&gt;Team(team)) {
+				if (!teamHandler-&gt;Team(receivingTeamId)-&gt;isDead &amp;&amp; !teamHandler-&gt;Team(team)-&gt;isDead) {
 					// we must iterate over the ID's to check if
 					// all of them really belong to the AI's team
 					for (std::vector&lt;int&gt;::const_iterator it = unitIds.begin(); it != unitIds.end(); it++ ) {
@@ -217,12 +217,12 @@
 
 int CAICallback::GetMyAllyTeam()
 {
-	return gs-&gt;AllyTeam(team);
+	return teamHandler-&gt;AllyTeam(team);
 }
 
 int CAICallback::GetPlayerTeam(int playerId)
 {
-	CPlayer *pl = gs-&gt;players [playerId];
+	CPlayer* pl = playerHandler-&gt;Player(playerId);
 	if (pl-&gt;spectator)
 		return -1;
 	return pl-&gt;team;
@@ -230,8 +230,8 @@
 
 const char* CAICallback::GetTeamSide(int teamId)
 {
-	if (teamId &lt; gs-&gt;activeTeams &amp;&amp; gameSetup) {
-		return gs-&gt;Team(teamId)-&gt;side.c_str();
+	if (teamId &lt; teamHandler-&gt;ActiveTeams() &amp;&amp; gameSetup) {
+		return teamHandler-&gt;Team(teamId)-&gt;side.c_str();
 	} else {
 		// if this is not a GameSetup-type game but a
 		// SkirmishAI-test one, the side-strings for all
@@ -380,8 +380,8 @@
 	if (CHECK_UNITID(unitId)) {
 		CUnit* unit = uh-&gt;units[unitId];
 		if (unit) {
-			const int allyTeam = gs-&gt;AllyTeam(team);
-			if (gs-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
+			const int allyTeam = teamHandler-&gt;AllyTeam(team);
+			if (teamHandler-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
 				return unit-&gt;aihint;
 			}
 			else if (unit-&gt;losStatus[allyTeam] &amp; LOS_INLOS) {
@@ -403,7 +403,7 @@
 	verify ();
 	if (CHECK_UNITID(unitId)) {
 		CUnit* unit=uh-&gt;units[unitId];
-		if(unit &amp;&amp; (unit-&gt;losStatus[gs-&gt;AllyTeam(team)] &amp; LOS_INLOS)){
+		if(unit &amp;&amp; (unit-&gt;losStatus[teamHandler-&gt;AllyTeam(team)] &amp; LOS_INLOS)){
 			return unit-&gt;team;
 		}
 	}
@@ -415,7 +415,7 @@
 	verify ();
 	if (CHECK_UNITID(unitId)) {
 		CUnit* unit=uh-&gt;units[unitId];
-		if(unit &amp;&amp; (unit-&gt;losStatus[gs-&gt;AllyTeam(team)] &amp; LOS_INLOS)){
+		if(unit &amp;&amp; (unit-&gt;losStatus[teamHandler-&gt;AllyTeam(team)] &amp; LOS_INLOS)){
 			return unit-&gt;allyteam;
 		}
 	}
@@ -429,9 +429,9 @@
 		CUnit* unit = uh-&gt;units[unitId];
 
 		if (unit) {
-			const int allyTeam = gs-&gt;AllyTeam(team);
+			const int allyTeam = teamHandler-&gt;AllyTeam(team);
 
-			if (gs-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
+			if (teamHandler-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
 				return unit-&gt;health;
 			}
 			else if (unit-&gt;losStatus[allyTeam] &amp; LOS_INLOS) {
@@ -457,8 +457,8 @@
 	if (CHECK_UNITID(unitId)) {
 		CUnit* unit = uh-&gt;units[unitId];
 		if (unit) {
-			const int allyTeam = gs-&gt;AllyTeam(team);
-			if (gs-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
+			const int allyTeam = teamHandler-&gt;AllyTeam(team);
+			if (teamHandler-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
 				return unit-&gt;maxHealth;
 			}
 			else if (unit-&gt;losStatus[allyTeam] &amp; LOS_INLOS) {
@@ -482,8 +482,8 @@
 	if (CHECK_UNITID(unitId)) {
 		CUnit* unit = uh-&gt;units[unitId];
 		if (unit) {
-			const int allyTeam = gs-&gt;AllyTeam(team);
-			if (gs-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
+			const int allyTeam = teamHandler-&gt;AllyTeam(team);
+			if (teamHandler-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
 				return unit-&gt;maxSpeed;
 			}
 			else if (unit-&gt;losStatus[allyTeam] &amp; LOS_INLOS) {
@@ -506,8 +506,8 @@
 	if (CHECK_UNITID(unitId)) {
 		CUnit* unit = uh-&gt;units[unitId];
 		if (unit) {
-			const int allyTeam = gs-&gt;AllyTeam(team);
-			if (gs-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
+			const int allyTeam = teamHandler-&gt;AllyTeam(team);
+			if (teamHandler-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
 				return unit-&gt;power;
 			}
 			else if (unit-&gt;losStatus[allyTeam] &amp; LOS_INLOS) {
@@ -530,7 +530,7 @@
 	verify ();
 	if (CHECK_UNITID(unitId)) {
 		CUnit* unit=uh-&gt;units[unitId];
-		if (unit &amp;&amp; (unit-&gt;losStatus[gs-&gt;AllyTeam(team)] &amp; LOS_INLOS)) {
+		if (unit &amp;&amp; (unit-&gt;losStatus[teamHandler-&gt;AllyTeam(team)] &amp; LOS_INLOS)) {
 			return unit-&gt;experience;
 		}
 	}
@@ -543,8 +543,8 @@
 	if (CHECK_UNITID(unitId)) {
 		CUnit* unit = uh-&gt;units[unitId];
 		if (unit) {
-			const int allyTeam = gs-&gt;AllyTeam(team);
-			if (gs-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
+			const int allyTeam = teamHandler-&gt;AllyTeam(team);
+			if (teamHandler-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
 				return unit-&gt;maxRange;
 			}
 			else if (unit-&gt;losStatus[allyTeam] &amp; LOS_INLOS) {
@@ -568,8 +568,8 @@
 		CUnit* unit = uh-&gt;units[unitId];
 		if (unit) {
 			const UnitDef* unitDef = unit-&gt;unitDef;
-			const int allyTeam = gs-&gt;AllyTeam(team);
-			if (gs-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
+			const int allyTeam = teamHandler-&gt;AllyTeam(team);
+			if (teamHandler-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
 				return unitDef;
 			}
 			const unsigned short losStatus = unit-&gt;losStatus[allyTeam];
@@ -602,8 +602,8 @@
 	verify ();
 	if (CHECK_UNITID(unitId)) {
 		CUnit* unit=uh-&gt;units[unitId];
-		if(unit &amp;&amp; (unit-&gt;losStatus[gs-&gt;AllyTeam(team)] &amp; (LOS_INLOS|LOS_INRADAR))){
-			return helper-&gt;GetUnitErrorPos(unit,gs-&gt;AllyTeam(team));
+		if(unit &amp;&amp; (unit-&gt;losStatus[teamHandler-&gt;AllyTeam(team)] &amp; (LOS_INLOS|LOS_INRADAR))){
+			return helper-&gt;GetUnitErrorPos(unit,teamHandler-&gt;AllyTeam(team));
 		}
 	}
 	return ZeroVector;
@@ -613,7 +613,7 @@
 	verify ();
 	if (CHECK_UNITID(unitId)) {
 		CUnit* unit=uh-&gt;units[unitId];
-		if(unit &amp;&amp; (unit-&gt;losStatus[gs-&gt;AllyTeam(team)] &amp; LOS_INLOS)){
+		if(unit &amp;&amp; (unit-&gt;losStatus[teamHandler-&gt;AllyTeam(team)] &amp; LOS_INLOS)){
 			return unit-&gt;buildFacing;
 		}
 	}
@@ -624,7 +624,7 @@
 	verify ();
 	if (CHECK_UNITID(unitId)) {
 		CUnit* unit=uh-&gt;units[unitId];
-		if(unit &amp;&amp; (unit-&gt;losStatus[gs-&gt;AllyTeam(team)] &amp; LOS_INLOS)){
+		if(unit &amp;&amp; (unit-&gt;losStatus[teamHandler-&gt;AllyTeam(team)] &amp; LOS_INLOS)){
 			return unit-&gt;isCloaked;
 		}
 	}
@@ -636,7 +636,7 @@
 
 	if (CHECK_UNITID(unitId)) {
 		CUnit* unit = uh-&gt;units[unitId];
-		if (unit &amp;&amp; (unit-&gt;losStatus[gs-&gt;AllyTeam(team)] &amp; LOS_INLOS)) {
+		if (unit &amp;&amp; (unit-&gt;losStatus[teamHandler-&gt;AllyTeam(team)] &amp; LOS_INLOS)) {
 			return unit-&gt;stunned;
 		}
 	}
@@ -650,7 +650,7 @@
 	if (CHECK_UNITID(unitId)) {
 		CUnit* unit = uh-&gt;units[unitId];
 
-		if (unit &amp;&amp; (unit-&gt;losStatus[gs-&gt;AllyTeam(team)] &amp; LOS_INLOS)) {
+		if (unit &amp;&amp; (unit-&gt;losStatus[teamHandler-&gt;AllyTeam(team)] &amp; LOS_INLOS)) {
 			if (unit-&gt;IsNeutral())
 				return true;
 		}
@@ -692,8 +692,8 @@
 	for (std::list&lt;CUnit*&gt;::iterator ui = uh-&gt;activeUnits.begin(); ui != uh-&gt;activeUnits.end(); ++ui) {
 		CUnit* u = *ui;
 
-		if (!gs-&gt;Ally(u-&gt;allyteam, gs-&gt;AllyTeam(team)) &amp;&amp;
-		    (u-&gt;losStatus[gs-&gt;AllyTeam(team)] &amp; LOS_INLOS)) {
+		if (!teamHandler-&gt;Ally(u-&gt;allyteam, teamHandler-&gt;AllyTeam(team)) &amp;&amp;
+		    (u-&gt;losStatus[teamHandler-&gt;AllyTeam(team)] &amp; LOS_INLOS)) {
 			if (!IsUnitNeutral(u-&gt;id)) {
 				unitIds[a++] = u-&gt;id;
 			}
@@ -712,7 +712,7 @@
 	for (std::list&lt;CUnit*&gt;::iterator ui = uh-&gt;activeUnits.begin(); ui != uh-&gt;activeUnits.end(); ++ui) {
 		CUnit* u = *ui;
 
-		if (!gs-&gt;Ally(u-&gt;allyteam, gs-&gt;AllyTeam(team)) &amp;&amp; (u-&gt;losStatus[gs-&gt;AllyTeam(team)] &amp; (LOS_INLOS | LOS_INRADAR))) {
+		if (!teamHandler-&gt;Ally(u-&gt;allyteam, teamHandler-&gt;AllyTeam(team)) &amp;&amp; (u-&gt;losStatus[teamHandler-&gt;AllyTeam(team)] &amp; (LOS_INLOS | LOS_INRADAR))) {
 			if (!IsUnitNeutral(u-&gt;id)) {
 				unitIds[a++] = u-&gt;id;
 			}
@@ -732,7 +732,7 @@
 	for (ui = unit.begin(); ui != unit.end(); ++ui) {
 		CUnit* u = *ui;
 
-		if (!gs-&gt;Ally(u-&gt;allyteam, gs-&gt;AllyTeam(team)) &amp;&amp; (u-&gt;losStatus[gs-&gt;AllyTeam(team)] &amp; LOS_INLOS)) {
+		if (!teamHandler-&gt;Ally(u-&gt;allyteam, teamHandler-&gt;AllyTeam(team)) &amp;&amp; (u-&gt;losStatus[teamHandler-&gt;AllyTeam(team)] &amp; LOS_INLOS)) {
 			if (!IsUnitNeutral(u-&gt;id)) {
 				unitIds[a] = u-&gt;id;
 				++a;
@@ -752,7 +752,7 @@
 	for (std::list&lt;CUnit*&gt;::iterator ui = uh-&gt;activeUnits.begin(); ui != uh-&gt;activeUnits.end(); ++ui) {
 		CUnit* u = *ui;
 
-		if (gs-&gt;Ally(u-&gt;allyteam, gs-&gt;AllyTeam(team))) {
+		if (teamHandler-&gt;Ally(u-&gt;allyteam, teamHandler-&gt;AllyTeam(team))) {
 			// IsUnitNeutral does a LOS check, but inconsequential
 			// since we can always see friendly units anyway
 			if (!IsUnitNeutral(u-&gt;id)) {
@@ -774,7 +774,7 @@
 	for (ui = unit.begin(); ui != unit.end(); ++ui) {
 		CUnit* u = *ui;
 
-		if (gs-&gt;Ally(u-&gt;allyteam, gs-&gt;AllyTeam(team))) {
+		if (teamHandler-&gt;Ally(u-&gt;allyteam, teamHandler-&gt;AllyTeam(team))) {
 			// IsUnitNeutral does a LOS check, but inconsequential
 			// since we can always see friendly units anyway
 			if (!IsUnitNeutral(u-&gt;id)) {
@@ -911,17 +911,17 @@
 
 const unsigned short* CAICallback::GetLosMap()
 {
-	return &amp;loshandler-&gt;losMap[gs-&gt;AllyTeam(team)].front();
+	return &amp;loshandler-&gt;losMap[teamHandler-&gt;AllyTeam(team)].front();
 }
 
 const unsigned short* CAICallback::GetRadarMap()
 {
-	return &amp;radarhandler-&gt;radarMaps[gs-&gt;AllyTeam(team)].front();
+	return &amp;radarhandler-&gt;radarMaps[teamHandler-&gt;AllyTeam(team)].front();
 }
 
 const unsigned short* CAICallback::GetJammerMap()
 {
-	return &amp;radarhandler-&gt;jammerMaps[gs-&gt;AllyTeam(team)].front();
+	return &amp;radarhandler-&gt;jammerMaps[teamHandler-&gt;AllyTeam(team)].front();
 }
 
 const unsigned char* CAICallback::GetMetalMap()
@@ -1022,7 +1022,7 @@
 	CFeature* f;
 	BuildInfo bi(unitDef, pos, facing);
 	bi.pos=helper-&gt;Pos2BuildPos (bi);
-	return !!uh-&gt;TestUnitBuildSquare(bi,f,gs-&gt;AllyTeam(team));
+	return !!uh-&gt;TestUnitBuildSquare(bi,f,teamHandler-&gt;AllyTeam(team));
 }
 
 
@@ -1064,7 +1064,7 @@
 {
 	if (!unitdef) return float3(-1.0f,0.0f,0.0f);
 	CFeature* feature;
-	int allyteam=gs-&gt;AllyTeam(team);
+	int allyteam=teamHandler-&gt;AllyTeam(team);
 
 	int endr = (int)(searchRadius / (SQUARE_SIZE*2));
 	const vector&lt;SearchOffset&gt;&amp; ofs = GetSearchOffsetTable (endr);
@@ -1111,49 +1111,49 @@
 
 float CAICallback::GetMetal()
 {
-	return gs-&gt;Team(team)-&gt;metal;
+	return teamHandler-&gt;Team(team)-&gt;metal;
 }
 
 float CAICallback::GetMetalIncome()
 {
-	return gs-&gt;Team(team)-&gt;prevMetalIncome;
+	return teamHandler-&gt;Team(team)-&gt;prevMetalIncome;
 }
 
 float CAICallback::GetMetalUsage()
 {
-	return gs-&gt;Team(team)-&gt;prevMetalExpense;
+	return teamHandler-&gt;Team(team)-&gt;prevMetalExpense;
 }
 
 float CAICallback::GetMetalStorage()
 {
-	return gs-&gt;Team(team)-&gt;metalStorage;
+	return teamHandler-&gt;Team(team)-&gt;metalStorage;
 }
 
 float CAICallback::GetEnergy()
 {
-	return gs-&gt;Team(team)-&gt;energy;
+	return teamHandler-&gt;Team(team)-&gt;energy;
 }
 
 float CAICallback::GetEnergyIncome()
 {
-	return gs-&gt;Team(team)-&gt;prevEnergyIncome;
+	return teamHandler-&gt;Team(team)-&gt;prevEnergyIncome;
 }
 
 float CAICallback::GetEnergyUsage()
 {
-	return gs-&gt;Team(team)-&gt;prevEnergyExpense;
+	return teamHandler-&gt;Team(team)-&gt;prevEnergyExpense;
 }
 
 float CAICallback::GetEnergyStorage()
 {
-	return gs-&gt;Team(team)-&gt;energyStorage;
+	return teamHandler-&gt;Team(team)-&gt;energyStorage;
 }
 
 bool CAICallback::GetUnitResourceInfo (int unitId, UnitResourceInfo *i)
 {
 	if (CHECK_UNITID(unitId)) {
 		CUnit* unit=uh-&gt;units[unitId];
-		if(unit &amp;&amp; (unit-&gt;losStatus[gs-&gt;AllyTeam(team)] &amp; LOS_INLOS))
+		if(unit &amp;&amp; (unit-&gt;losStatus[teamHandler-&gt;AllyTeam(team)] &amp; LOS_INLOS))
 		{
 			i-&gt;energyMake = unit-&gt;energyMake;
 			i-&gt;energyUse = unit-&gt;energyUse;
@@ -1170,7 +1170,7 @@
 	verify ();
 	if (CHECK_UNITID(unitId)) {
 		CUnit* unit=uh-&gt;units[unitId];
-		if(unit &amp;&amp; (unit-&gt;losStatus[gs-&gt;AllyTeam(team)] &amp; LOS_INLOS))
+		if(unit &amp;&amp; (unit-&gt;losStatus[teamHandler-&gt;AllyTeam(team)] &amp; LOS_INLOS))
 			return unit-&gt;activated;
 	}
 	return false;
@@ -1181,7 +1181,7 @@
 	verify ();
 	if (CHECK_UNITID(unitId)) {
 		CUnit* unit=uh-&gt;units[unitId];
-		if(unit &amp;&amp; (unit-&gt;losStatus[gs-&gt;AllyTeam(team)] &amp; LOS_INLOS))
+		if(unit &amp;&amp; (unit-&gt;losStatus[teamHandler-&gt;AllyTeam(team)] &amp; LOS_INLOS))
 			return unit-&gt;beingBuilt;
 	}
 	return false;
@@ -1191,7 +1191,7 @@
 {
 	verify ();
 	int i = 0;
-	int allyteam = gs-&gt;AllyTeam(team);
+	int allyteam = teamHandler-&gt;AllyTeam(team);
 
 	const CFeatureSet&amp; fset = featureHandler-&gt;GetActiveFeatures();
 	for (CFeatureSet::const_iterator it = fset.begin(); it != fset.end(); ++i) {
@@ -1212,7 +1212,7 @@
 {
 	verify ();
 	vector&lt;CFeature*&gt; ft = qf-&gt;GetFeaturesExact (pos, radius);
-	int allyteam = gs-&gt;AllyTeam(team);
+	int allyteam = teamHandler-&gt;AllyTeam(team);
 	int n = 0;
 
 	for (unsigned int a=0;a&lt;ft.size();a++)
@@ -1239,7 +1239,7 @@
 
 	if (it != fset.end()) {
 		const CFeature *f = *it;
-		int allyteam = gs-&gt;AllyTeam(team);
+		int allyteam = teamHandler-&gt;AllyTeam(team);
 		if (f-&gt;allyteam &lt; 0 || f-&gt;allyteam == allyteam || loshandler-&gt;InLos(f-&gt;pos,allyteam))
 			return f-&gt;def;
 	}
@@ -1260,7 +1260,7 @@
 
 	if (it != fset.end()) {
 		const CFeature *f = *it;
-		int allyteam = gs-&gt;AllyTeam(team);
+		int allyteam = teamHandler-&gt;AllyTeam(team);
 		if (f-&gt;allyteam &lt; 0 || f-&gt;allyteam == allyteam || loshandler-&gt;InLos(f-&gt;pos,allyteam))
 			return f-&gt;health;
 	}
@@ -1276,7 +1276,7 @@
 
 	if (it != fset.end()) {
 		const CFeature *f = *it;
-		int allyteam = gs-&gt;AllyTeam(team);
+		int allyteam = teamHandler-&gt;AllyTeam(team);
 		if (f-&gt;allyteam &lt; 0 || f-&gt;allyteam == allyteam || loshandler-&gt;InLos(f-&gt;pos,allyteam))
 			return f-&gt;reclaimLeft;
 	}
@@ -1292,7 +1292,7 @@
 
 	if (it != fset.end()) {
 		const CFeature *f = *it;
-		int allyteam = gs-&gt;AllyTeam(team);
+		int allyteam = teamHandler-&gt;AllyTeam(team);
 		if (f-&gt;allyteam &lt; 0 || f-&gt;allyteam == allyteam || loshandler-&gt;InLos(f-&gt;pos,allyteam))
 			return f-&gt;pos;
 	}
@@ -1436,14 +1436,14 @@
 	verify ();
 	if (CHECK_UNITID(unitId)) {
 		CUnit* unit = uh-&gt;units[unitId];
-		const int allyTeam = gs-&gt;AllyTeam(team);
+		const int allyTeam = teamHandler-&gt;AllyTeam(team);
 		if (!(unit &amp;&amp; (unit-&gt;losStatus[allyTeam] &amp; LOS_INLOS))) {
 			return false;  //return if the unit doesn't exist or cant be seen
 		}
 
 		switch (property) {
 			case AIVAL_UNITDEF: {
-				if (gs-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
+				if (teamHandler-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
 					(*(const UnitDef**)data) = unit-&gt;unitDef;
 				} else {
 					const UnitDef* unitDef = unit-&gt;unitDef;
@@ -1461,14 +1461,14 @@
 				return true;
 			}
 			case AIVAL_STOCKPILED: {
-				if (!unit-&gt;stockpileWeapon || !gs-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
+				if (!unit-&gt;stockpileWeapon || !teamHandler-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
 					return false;
 				}
 				(*(int*)data) = unit-&gt;stockpileWeapon-&gt;numStockpiled;
 				return true;
 			}
 			case AIVAL_STOCKPILE_QUED: {
-				if (!unit-&gt;stockpileWeapon || !gs-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
+				if (!unit-&gt;stockpileWeapon || !teamHandler-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
 					return false;
 				}
 				(*(int*)data) = unit-&gt;stockpileWeapon-&gt;numStockpileQued;
@@ -1542,7 +1542,7 @@
 	GML_RECMUTEX_LOCK(sel); // GetSelectedUnit
 	// check if the allyteam of the player running
 	// the AI lib matches the AI's actual allyteam
-	if (gu-&gt;myAllyTeam == gs-&gt;AllyTeam(team)) {
+	if (gu-&gt;myAllyTeam == teamHandler-&gt;AllyTeam(team)) {
 		for (CUnitSet::iterator ui = selectedUnits.selectedUnits.begin(); ui != selectedUnits.selectedUnits.end(); ++ui)
 			unitIds[a++] = (*ui)-&gt;id;
 	}
@@ -1552,7 +1552,7 @@
 
 float3 CAICallback::GetMousePos() {
 	verify ();
-	if (gu-&gt;myAllyTeam == gs-&gt;AllyTeam(team))
+	if (gu-&gt;myAllyTeam == teamHandler-&gt;AllyTeam(team))
 		return inMapDrawer-&gt;GetMouseMapPos();
 	else
 		return ZeroVector;
@@ -1564,13 +1564,13 @@
 	int a=0;
 	verify ();
 
-	if (gu-&gt;myAllyTeam != gs-&gt;AllyTeam(team))
+	if (gu-&gt;myAllyTeam != teamHandler-&gt;AllyTeam(team))
 		return 0;
 
 	for (int i=0;i&lt;inMapDrawer-&gt;numQuads;i++){
 		if(!inMapDrawer-&gt;drawQuads[i].points.empty()){
 			for(std::list&lt;CInMapDraw::MapPoint&gt;::iterator mp=inMapDrawer-&gt;drawQuads[i].points.begin();mp!=inMapDrawer-&gt;drawQuads[i].points.end();++mp){
-				if(mp-&gt;color==gs-&gt;Team(team)-&gt;color) { //Maybe add so that markers of your ally team would be also found?
+				if(mp-&gt;color==teamHandler-&gt;Team(team)-&gt;color) { //Maybe add so that markers of your ally team would be also found?
 					pm[a].pos=mp-&gt;pos;
 					pm[a].color=mp-&gt;color;
 					pm[a].label=mp-&gt;label.c_str();
@@ -1588,13 +1588,13 @@
 	int a=0;
 	verify ();
 
-	if (gu-&gt;myAllyTeam != gs-&gt;AllyTeam(team))
+	if (gu-&gt;myAllyTeam != teamHandler-&gt;AllyTeam(team))
 		return 0;
 
 	for (int i=0;i&lt;inMapDrawer-&gt;numQuads;i++){
 		if(!inMapDrawer-&gt;drawQuads[i].points.empty()){
 			for(std::list&lt;CInMapDraw::MapLine&gt;::iterator ml=inMapDrawer-&gt;drawQuads[i].lines.begin();ml!=inMapDrawer-&gt;drawQuads[i].lines.end();++ml){
-				if(ml-&gt;color==gs-&gt;Team(team)-&gt;color){ //Maybe add so that markers of your ally team would be also found?
+				if(ml-&gt;color==teamHandler-&gt;Team(team)-&gt;color){ //Maybe add so that markers of your ally team would be also found?
 					lm[a].pos=ml-&gt;pos;
 					lm[a].color=ml-&gt;color;
 					lm[a].pos2=ml-&gt;pos2;
@@ -1630,7 +1630,7 @@
 
 const float3 *CAICallback::GetStartPos()
 {
-	return &amp;gs-&gt;Team(team)-&gt;startPos;
+	return &amp;teamHandler-&gt;Team(team)-&gt;startPos;
 }
 
 

Modified: branches/caiinterface/rts/ExternalAI/AICheats.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/AICheats.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/ExternalAI/AICheats.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -8,8 +8,8 @@
 #include &quot;Sim/Units/UnitHandler.h&quot;
 #include &quot;Sim/Units/UnitLoader.h&quot;
 #include &quot;NetProtocol.h&quot;
-#include &quot;Game/GlobalSynced.h&quot;
-#include &quot;Game/Team.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Game/GameServer.h&quot;
 #include &quot;Game/GameSetup.h&quot;
 #include &quot;mmgr.h&quot;
@@ -50,20 +50,20 @@
 void CAICheats::SetMyHandicap(float handicap)
 {
 	if (!OnlyPassiveCheats()) {
-		gs-&gt;Team(ai-&gt;GetTeamId())-&gt;handicap = 1 + handicap / 100;
+		teamHandler-&gt;Team(ai-&gt;GetTeamId())-&gt;handicap = 1 + handicap / 100;
 	}
 }
 
 void CAICheats::GiveMeMetal(float amount)
 {
 	if (!OnlyPassiveCheats())
-		gs-&gt;Team(ai-&gt;GetTeamId())-&gt;metal += amount;
+		teamHandler-&gt;Team(ai-&gt;GetTeamId())-&gt;metal += amount;
 }
 
 void CAICheats::GiveMeEnergy(float amount)
 {
 	if (!OnlyPassiveCheats())
-		gs-&gt;Team(ai-&gt;GetTeamId())-&gt;energy += amount;
+		teamHandler-&gt;Team(ai-&gt;GetTeamId())-&gt;energy += amount;
 }
 
 int CAICheats::CreateUnit(const char* name, float3 pos)
@@ -106,7 +106,7 @@
 	for (list&lt;CUnit*&gt;::iterator ui = uh-&gt;activeUnits.begin(); ui != uh-&gt;activeUnits.end(); ++ui) {
 		CUnit* u = *ui;
 
-		if (!gs-&gt;Ally(u-&gt;allyteam, gs-&gt;AllyTeam(ai-&gt;GetTeamId()))) {
+		if (!teamHandler-&gt;Ally(u-&gt;allyteam, teamHandler-&gt;AllyTeam(ai-&gt;GetTeamId()))) {
 			if (!IsUnitNeutral(u-&gt;id)) {
 				units[a++] = u-&gt;id;
 			}
@@ -125,7 +125,7 @@
 	for (ui = unit.begin(); ui != unit.end(); ++ui) {
 		CUnit* u = *ui;
 
-		if (!gs-&gt;Ally(u-&gt;allyteam, gs-&gt;AllyTeam(ai-&gt;GetTeamId()))) {
+		if (!teamHandler-&gt;Ally(u-&gt;allyteam, teamHandler-&gt;AllyTeam(ai-&gt;GetTeamId()))) {
 			if (!IsUnitNeutral(u-&gt;id)) {
 				units[a] = u-&gt;id;
 				++a;

Modified: branches/caiinterface/rts/ExternalAI/AILibrary.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/AILibrary.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/ExternalAI/AILibrary.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -15,6 +15,7 @@
  along with this program.  If not, see &lt;<A HREF="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</A>&gt;.
  */
 
+/*
 #include &quot;AILibrary.h&quot;
 #include &lt;string&gt;
 #include &lt;iostream&gt;
@@ -75,4 +76,5 @@
 int CAILibrary::handleEvent(int topic, void* data) {
 	return _handleEvent(team, topic, data);
 }
+*/
 

Modified: branches/caiinterface/rts/ExternalAI/AILibrary.h
===================================================================
--- branches/caiinterface/rts/ExternalAI/AILibrary.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/ExternalAI/AILibrary.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -15,49 +15,47 @@
     along with this program.  If not, see &lt;<A HREF="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</A>&gt;.
 */
 
-#ifndef AILIBRARY_H
-#define AILIBRARY_H
-
-#include &lt;string&gt;
-#include &quot;Object.h&quot;
-#include &quot;Platform/SharedLib.h&quot;
-
-// This class is responsable for loading a particular AI library, and 
-// handling handleEvent() messages intended for that member.
-
-class CAILibrary {
-public:
-    
-    CAILibrary(const char* libName, int team);
-    ~CAILibrary();
-    
-    void init();
-    
-	/**
-	 * Through this function, the AI receives events from the engine.
-	 * For details about events that may arrive here, see file AISEvents.h.
-	 *
-	 * @param	topic	unique identifyer of a message
-	 *					(see EVENT_* defines in AISEvents.h)
-	 * @param	data	an topic specific struct, which contains the data
-	 *					associatedwith the event
-	 *					(see S*Event structs in AISEvents.h)
-	 * @return	ok: 0, error: != 0
-	 */
-    int handleEvent(int topic, void* data);
-    
-    typedef void (*AI_INIT)(int);
-    AI_INIT _init;
-    
-    typedef int (*AI_HANDLEEVENT)(int, int, void*);
-    AI_HANDLEEVENT _handleEvent;
-    
-    int team;
-private: 
-    const char* libName;
-    SharedLib* lib;
-    
-
-};
-
-#endif /*AILIBRARY_H*/
+//#ifndef AILIBRARY_H
+//#define AILIBRARY_H
+//
+//#include &lt;string&gt;
+//#include &quot;Object.h&quot;
+//#include &quot;Platform/SharedLib.h&quot;
+//
+//// This class is responsable for loading a particular AI library, and 
+//// handling handleEvent() messages intended for that member.
+//
+//class CAILibrary {
+//public:
+//    
+//    CAILibrary(const char* libName, int team);
+//    ~CAILibrary();
+//    
+//    void init();
+//    
+//	/**
+//	 * Through this function, the AI receives events from the engine.
+//	 * For details about events that may arrive here, see file AISEvents.h.
+//	 *
+//	 * @param	topic	unique identifyer of a message
+//	 *					(see EVENT_* defines in AISEvents.h)
+//	 * @param	data	an topic specific struct, which contains the data
+//	 *					associatedwith the event
+//	 *					(see S*Event structs in AISEvents.h)
+//	 * @return	ok: 0, error: != 0
+//	 */
+//    int handleEvent(int topic, void* data);
+//    
+//    typedef void (*AI_INIT)(int);
+//    AI_INIT _init;
+//    
+//    typedef int (*AI_HANDLEEVENT)(int, int, void*);
+//    AI_HANDLEEVENT _handleEvent;
+//    
+//    int team;
+//private: 
+//    const char* libName;
+//    SharedLib* lib;
+//};
+//
+//#endif // AILIBRARY_H

Modified: branches/caiinterface/rts/ExternalAI/AILibraryManager.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/AILibraryManager.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/ExternalAI/AILibraryManager.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -28,9 +28,11 @@
 #include &quot;Platform/errorhandler.h&quot;
 #include &quot;Platform/SharedLib.h&quot;
 #include &quot;FileSystem/FileHandler.h&quot;
-#include &quot;Game/GlobalSynced.h&quot;
+//#include &quot;Game/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/GlobalConstants.h&quot;
+#include &quot;Sim/Misc/Team.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;LogOutput.h&quot;
-#include &quot;Game/Team.h&quot;
 
 #include &lt;string&gt;
 #include &lt;set&gt;
@@ -486,7 +488,7 @@
 	if (!usedSkirmishAIInfos_initialized) {
 		const CTeam* team = NULL;
 		for (unsigned int t = 0; t &lt; (unsigned int)MAX_TEAMS; ++t) {
-			team = gs-&gt;Team(t);
+			team = teamHandler-&gt;Team(t);
 			if (team != NULL &amp;&amp; team-&gt;isAI) {
 				IAILibraryManager::T_skirmishAIInfos::const_iterator aiInfo;
 				const char * tmpStr = team-&gt;skirmishAISpecifier.ai.shortName;

Modified: branches/caiinterface/rts/ExternalAI/EngineOutHandler.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/EngineOutHandler.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/ExternalAI/EngineOutHandler.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -20,10 +20,12 @@
 #include &quot;GroupHandler.h&quot;
 #include &quot;SkirmishAIWrapper.h&quot;
 //#include &quot;GroupAIWrapper.h&quot;
-#include &quot;Game/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
 #include &quot;Game/GameHelper.h&quot;
 #include &quot;Game/Player.h&quot;
+#include &quot;Game/PlayerHandler.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Util.h&quot;
@@ -112,7 +114,7 @@
 	}
 }
 
-CEngineOutHandler::CEngineOutHandler() : activeTeams(gs-&gt;activeTeams) {
+CEngineOutHandler::CEngineOutHandler() : activeTeams(teamHandler-&gt;ActiveTeams()) {
 
 	for (int t=0; t &lt; MAX_TEAMS; ++t) {
 		skirmishAIs[t] = NULL;
@@ -216,9 +218,9 @@
 
 
 #define DO_FOR_ALLIED_SKIRMISH_AIS(FUNC, ALLY_TEAM_ID, UNIT_ALLY_TEAM_ID)	\
-	if (hasSkirmishAIs &amp;&amp; !gs-&gt;Ally(ALLY_TEAM_ID, UNIT_ALLY_TEAM_ID)) {		\
+	if (hasSkirmishAIs &amp;&amp; !teamHandler-&gt;Ally(ALLY_TEAM_ID, UNIT_ALLY_TEAM_ID)) {		\
 		for (unsigned int t=0; t &lt; activeTeams; ++t) {						\
-			if (skirmishAIs[t] &amp;&amp; gs-&gt;AllyTeam(t) == ALLY_TEAM_ID) {		\
+			if (skirmishAIs[t] &amp;&amp; teamHandler-&gt;AllyTeam(t) == ALLY_TEAM_ID) {		\
 				try {														\
 					skirmishAIs[t]-&gt;FUNC;									\
 				} HANDLE_EXCEPTION;											\
@@ -228,9 +230,9 @@
 
 /*
 #define DO_FOR_ALLIED_GROUP_AIS(FUNC, ALLY_TEAM_ID, UNIT_ALLY_TEAM_ID)		\
-	if (hasGroupAIs &amp;&amp; !gs-&gt;Ally(ALLY_TEAM_ID, UNIT_ALLY_TEAM_ID)) {		\
+	if (hasGroupAIs &amp;&amp; !teamHandler-&gt;Ally(ALLY_TEAM_ID, UNIT_ALLY_TEAM_ID)) {		\
 		for (unsigned int t=0; t &lt; activeTeams; ++t) {						\
-			if (hasTeamGroupAIs[t] &amp;&amp; gs-&gt;AllyTeam(t) == ALLY_TEAM_ID) {	\
+			if (hasTeamGroupAIs[t] &amp;&amp; teamHandler-&gt;AllyTeam(t) == ALLY_TEAM_ID) {	\
 				for (unsigned int g=0; g &lt; MAX_GROUPS; ++g) {				\
 					if (groupAIs[t][g]) {									\
 						try {												\
@@ -258,7 +260,7 @@
 /*
 	if (hasSkirmishAIs) {
 		for (unsigned int t=0; t &lt; activeTeams; ++t) {
-			if (skirmishAIs[t] &amp;&amp; gs-&gt;AllyTeam(t) == allyTeamId &amp;&amp; !gs-&gt;Ally(allyTeamId, unit-&gt;allyteam)) {
+			if (skirmishAIs[t] &amp;&amp; teamHandler-&gt;AllyTeam(t) == allyTeamId &amp;&amp; !teamHandler-&gt;Ally(allyTeamId, unit-&gt;allyteam)) {
 				try {
 					skirmishAIs[t]-&gt;EnemyEnterLOS(unitId);
 				} HANDLE_EXCEPTION;
@@ -268,7 +270,7 @@
 	
 	if (hasGroupAIs) {
 		for (unsigned int t=0; t &lt; activeTeams; ++t) {
-			if (hasTeamGroupAIs[t] &amp;&amp; gs-&gt;AllyTeam(t) == allyTeamId &amp;&amp; !gs-&gt;Ally(allyTeamId, unit-&gt;allyteam)) {
+			if (hasTeamGroupAIs[t] &amp;&amp; teamHandler-&gt;AllyTeam(t) == allyTeamId &amp;&amp; !teamHandler-&gt;Ally(allyTeamId, unit-&gt;allyteam)) {
 				for (unsigned int g=0; g &lt; MAX_GROUPS; ++g) {
 					if (groupAIs[t][g]) {
 						try {
@@ -393,7 +395,7 @@
 		try {
 			for (unsigned int t=0; t &lt; activeTeams; ++t) {
 				if (skirmishAIs[t]
-						&amp;&amp; !gs-&gt;Ally(gs-&gt;AllyTeam(t), destroyed.allyteam)
+						&amp;&amp; !teamHandler-&gt;Ally(teamHandler-&gt;AllyTeam(t), destroyed.allyteam)
 						&amp;&amp; (skirmishAIs[t]-&gt;IsCheatEventsEnabled()
 							|| (destroyed.losStatus[t] &amp; (LOS_INLOS | LOS_INRADAR)))) {
 					skirmishAIs[t]-&gt;EnemyDestroyed(destroyedId, attackerId);
@@ -409,7 +411,7 @@
 	if (hasGroupAIs) {
 		for (unsigned int t=0; t &lt; activeTeams; ++t) {
 			if (hasTeamGroupAIs[t]
-						&amp;&amp; !gs-&gt;Ally(gs-&gt;AllyTeam(t), destroyed.allyteam)) {
+						&amp;&amp; !teamHandler-&gt;Ally(teamHandler-&gt;AllyTeam(t), destroyed.allyteam)) {
 				bool isVisible =
 						destroyed.losStatus[t] &amp; (LOS_INLOS | LOS_INRADAR);
 				for (unsigned int g=0; g &lt; MAX_GROUPS; ++g) {
@@ -469,7 +471,7 @@
 
 			if (attacker) {
 				if (skirmishAIs[at]
-						&amp;&amp; !gs-&gt;Ally(gs-&gt;AllyTeam(at), damaged.allyteam)
+						&amp;&amp; !teamHandler-&gt;Ally(teamHandler-&gt;AllyTeam(at), damaged.allyteam)
 						&amp;&amp; (skirmishAIs[at]-&gt;IsCheatEventsEnabled()
 							|| (damaged.losStatus[at] &amp; (LOS_INLOS | LOS_INRADAR)))) {
 					skirmishAIs[at]-&gt;EnemyDamaged(damagedUnitId, attackerUnitId,
@@ -491,7 +493,7 @@
 		}
 	}
 	if (hasTeamGroupAIs[at]
-			&amp;&amp; !gs-&gt;Ally(gs-&gt;AllyTeam(at), attacked-&gt;allyteam)) {
+			&amp;&amp; !teamHandler-&gt;Ally(teamHandler-&gt;AllyTeam(at), attacked-&gt;allyteam)) {
 		bool isVisible = attacked-&gt;losStatus[at] &amp; (LOS_INLOS | LOS_INRADAR);
 		for (unsigned int g=0; g &lt; MAX_GROUPS; ++g) {
 			if (groupAIs[at][g]
@@ -532,7 +534,7 @@
 		const std::vector&lt;int&gt;&amp; selectedUnitIds, const Command&amp; c, int playerId)
 {
 
-	int teamId = gs-&gt;players[playerId]-&gt;team;
+	int teamId = playerHandler-&gt;Player(playerId)-&gt;team;
 	
 	DO_FOR_TEAM_SKIRMISH_AND_GROUP_AIS(PlayerCommandGiven(selectedUnitIds, c, playerId), teamId);
 }
@@ -557,7 +559,7 @@
 bool CEngineOutHandler::CreateSkirmishAI(int teamId, const SSAIKey&amp; key,
 		const std::map&lt;std::string, std::string&gt;&amp; options) {
 
-	if ((teamId &lt; 0) || (teamId &gt;= gs-&gt;activeTeams)) {
+	if ((teamId &lt; 0) || (teamId &gt;= (int)activeTeams)) {
 		return false;
 	}
 

Modified: branches/caiinterface/rts/ExternalAI/EngineOutHandler.h
===================================================================
--- branches/caiinterface/rts/ExternalAI/EngineOutHandler.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/ExternalAI/EngineOutHandler.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -19,7 +19,7 @@
 #define _ENGINEOUTHANDLER_H
 
 #include &quot;Object.h&quot;
-#include &quot;Game/GlobalConstants.h&quot;
+#include &quot;Sim/Misc/GlobalConstants.h&quot;
 
 #include &lt;map&gt;
 #include &lt;string&gt;

Modified: branches/caiinterface/rts/ExternalAI/Group.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/Group.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/ExternalAI/Group.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -9,8 +9,8 @@
 #include &quot;GroupHandler.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
-#include &quot;System/EventHandler.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
+#include &quot;EventHandler.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Platform/errorhandler.h&quot;
 #include &quot;mmgr.h&quot;

Modified: branches/caiinterface/rts/ExternalAI/Group.h
===================================================================
--- branches/caiinterface/rts/ExternalAI/Group.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/ExternalAI/Group.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -11,7 +11,7 @@
 #include &quot;Platform/SharedLib.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;Sim/Units/UnitSet.h&quot;
-#include &quot;ExternalAI/aikey.h&quot;
+#include &quot;aikey.h&quot;
 class IGroupAI;
 class CUnit;
 class CFeature;

Modified: branches/caiinterface/rts/ExternalAI/GroupHandler.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/GroupHandler.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/ExternalAI/GroupHandler.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -15,7 +15,7 @@
 #include &quot;Game/CameraHandler.h&quot;
 #include &quot;Platform/SharedLib.h&quot;
 #include &quot;Platform/errorhandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;SDL_types.h&quot;
 #include &quot;SDL_keysym.h&quot;
 #include &quot;mmgr.h&quot;

Modified: branches/caiinterface/rts/ExternalAI/GroupHandler.h
===================================================================
--- branches/caiinterface/rts/ExternalAI/GroupHandler.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/ExternalAI/GroupHandler.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -10,8 +10,8 @@
 #include &lt;string&gt;
 #include &lt;vector&gt;
 #include &lt;set&gt;
-#include &quot;ExternalAI/aikey.h&quot;
-#include &quot;Game/GlobalConstants.h&quot;
+#include &quot;aikey.h&quot;
+#include &quot;Sim/Misc/GlobalConstants.h&quot;
 
 class CGroup;
 class CUnitSet;

Modified: branches/caiinterface/rts/ExternalAI/Interface/aidefines.h
===================================================================
--- branches/caiinterface/rts/ExternalAI/Interface/aidefines.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/ExternalAI/Interface/aidefines.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -26,7 +26,7 @@
 
 #include &quot;SAIFloat3.h&quot;
 
-#include &quot;Game/GameVersion.h&quot;
+//#include &quot;Game/GameVersion.h&quot;
 
 #define ENGINE_VERSION_STRING VERSION_STRING
 #define ENGINE_VERSION_NUMBER 1000

Modified: branches/caiinterface/rts/ExternalAI/SStaticGlobalData.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/SStaticGlobalData.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/ExternalAI/SStaticGlobalData.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -21,10 +21,10 @@
 #include &lt;string.h&gt;	// strcpy
 
 #if defined	__cplusplus &amp;&amp; !defined BUILDING_AI &amp;&amp; !defined BUILDING_AI_INTERFACE
-#include &quot;Game/GlobalConstants.h&quot;			// for MAX_TEAMS
+#include &quot;Sim/Misc/GlobalConstants.h&quot;			// for MAX_TEAMS
 #define MAX_GROUPS	10	// 0..9
 #include &quot;Game/GameVersion.h&quot;			// for VERSION_STRING
-#include &quot;System/Platform/FileSystem.h&quot;	// for data directories
+#include &quot;FileSystem/FileSystem.h&quot;	// for data directories
 #include &quot;ExternalAI/IAILibraryManager.h&quot;
 #include &quot;IAILibraryManager.h&quot;	// for AI info
 
@@ -95,7 +95,7 @@
 	const SStaticGlobalData sgd = {
 		MAX_TEAMS,
 		MAX_GROUPS,
-		VERSION_STRING,	// spring version string
+		SpringVersion::GetFull().c_str(),	// spring version string
 		numDataDirs,
 		(const char**) dataDirs,
 		numSkirmishAIs,

Modified: branches/caiinterface/rts/ExternalAI/SkirmishAIWrapper.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/SkirmishAIWrapper.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/ExternalAI/SkirmishAIWrapper.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -18,19 +18,17 @@
 #include &quot;SkirmishAIWrapper.h&quot;
 
 #include &quot;StdAfx.h&quot;
-#include &quot;Game/GlobalSynced.h&quot;
 #include &quot;IGlobalAI.h&quot;
 #include &quot;SkirmishAI.h&quot;
 #include &quot;GlobalAICallback.h&quot;
 #include &quot;EngineOutHandler.h&quot;
 #include &quot;IAILibraryManager.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
 #include &quot;Platform/errorhandler.h&quot;
-#include &quot;Platform/SharedLib.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;mmgr.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Interface/AISEvents.h&quot;
 #include &quot;Interface/AISCommands.h&quot;
 #include &quot;Interface/SSAILibrary.h&quot;
@@ -140,16 +138,16 @@
 						UnitFinished(a);
 					} HANDLE_EXCEPTION;
 			} else {
-				if ((uh-&gt;units[a]-&gt;allyteam == gs-&gt;AllyTeam(teamId))
-						|| gs-&gt;Ally(gs-&gt;AllyTeam(teamId), uh-&gt;units[a]-&gt;allyteam)) {
+				if ((uh-&gt;units[a]-&gt;allyteam == teamHandler-&gt;AllyTeam(teamId))
+						|| teamHandler-&gt;Ally(teamHandler-&gt;AllyTeam(teamId), uh-&gt;units[a]-&gt;allyteam)) {
 					// do nothing
 				} else {
-					if (uh-&gt;units[a]-&gt;losStatus[gs-&gt;AllyTeam(teamId)] &amp; (LOS_INRADAR | LOS_INLOS)) {
+					if (uh-&gt;units[a]-&gt;losStatus[teamHandler-&gt;AllyTeam(teamId)] &amp; (LOS_INRADAR | LOS_INLOS)) {
 						try {
 							EnemyEnterRadar(a);
 						} HANDLE_EXCEPTION;
 					}
-					if (uh-&gt;units[a]-&gt;losStatus[gs-&gt;AllyTeam(teamId)] &amp; LOS_INLOS) {
+					if (uh-&gt;units[a]-&gt;losStatus[teamHandler-&gt;AllyTeam(teamId)] &amp; LOS_INLOS) {
 						try {
 							EnemyEnterLOS(a);
 						} HANDLE_EXCEPTION;

Modified: branches/caiinterface/rts/Game/Action.cpp
===================================================================
--- branches/caiinterface/rts/Game/Action.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/Action.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -5,7 +5,7 @@
 #include &quot;mmgr.h&quot;
 
 #include &quot;Action.h&quot;
-#include &quot;System/FileSystem/SimpleParser.h&quot;
+#include &quot;FileSystem/SimpleParser.h&quot;
 
 Action::Action(const std::string&amp; line)
 {

Modified: branches/caiinterface/rts/Game/Camera/FPSController.cpp
===================================================================
--- branches/caiinterface/rts/Game/Camera/FPSController.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/Camera/FPSController.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -7,7 +7,7 @@
 #include &quot;Game/Camera.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Map/Ground.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 using std::min;
 using std::max;

Modified: branches/caiinterface/rts/Game/Camera/FreeController.cpp
===================================================================
--- branches/caiinterface/rts/Game/Camera/FreeController.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/Camera/FreeController.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -10,7 +10,7 @@
 #include &quot;Game/Camera.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Map/Ground.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 using std::max;
 using std::min;

Modified: branches/caiinterface/rts/Game/Camera/OrbitController.cpp
===================================================================
--- branches/caiinterface/rts/Game/Camera/OrbitController.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/Camera/OrbitController.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -7,7 +7,7 @@
 #include &quot;Game/Camera.h&quot;
 #include &quot;Game/UI/MouseHandler.h&quot;
 #include &quot;Map/Ground.h&quot;
-#include &quot;System/LogOutput.h&quot;
+#include &quot;LogOutput.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
 
 extern Uint8* keys;

Modified: branches/caiinterface/rts/Game/Camera/OverheadController.cpp
===================================================================
--- branches/caiinterface/rts/Game/Camera/OverheadController.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/Camera/OverheadController.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -12,7 +12,7 @@
 #include &quot;Game/UI/MouseHandler.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Map/Ground.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 
 

Modified: branches/caiinterface/rts/Game/Camera/SmoothController.cpp
===================================================================
--- branches/caiinterface/rts/Game/Camera/SmoothController.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/Camera/SmoothController.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -14,7 +14,7 @@
 #include &quot;Game/UI/MouseHandler.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Map/Ground.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 
 

Modified: branches/caiinterface/rts/Game/Camera/TWController.cpp
===================================================================
--- branches/caiinterface/rts/Game/Camera/TWController.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/Camera/TWController.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -12,7 +12,7 @@
 #include &quot;LogOutput.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Game/UI/MouseHandler.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 extern Uint8 *keys;
 

Modified: branches/caiinterface/rts/Game/Camera.cpp
===================================================================
--- branches/caiinterface/rts/Game/Camera.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/Camera.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -5,8 +5,8 @@
 
 #include &quot;mmgr.h&quot;
 
-#include &quot;System/myMath.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;myMath.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 #include &quot;Camera.h&quot;
 #include &quot;Map/Ground.h&quot;
 

Modified: branches/caiinterface/rts/Game/CameraHandler.cpp
===================================================================
--- branches/caiinterface/rts/Game/CameraHandler.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/CameraHandler.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -5,17 +5,17 @@
 
 #include &quot;CameraHandler.h&quot;
 
-#include &quot;Game/Action.h&quot;
-#include &quot;Game/Camera.h&quot;
-#include &quot;Game/Camera/CameraController.h&quot;
-#include &quot;Game/Camera/FPSController.h&quot;
-#include &quot;Game/Camera/OverheadController.h&quot;
-#include &quot;Game/Camera/SmoothController.h&quot;
-#include &quot;Game/Camera/RotOverheadController.h&quot;
-#include &quot;Game/Camera/FreeController.h&quot;
-#include &quot;Game/Camera/OverviewController.h&quot;
-#include &quot;Game/Camera/TWController.h&quot;
-#include &quot;Game/Camera/OrbitController.h&quot;
+#include &quot;Action.h&quot;
+#include &quot;Camera.h&quot;
+#include &quot;Camera/CameraController.h&quot;
+#include &quot;Camera/FPSController.h&quot;
+#include &quot;Camera/OverheadController.h&quot;
+#include &quot;Camera/SmoothController.h&quot;
+#include &quot;Camera/RotOverheadController.h&quot;
+#include &quot;Camera/FreeController.h&quot;
+#include &quot;Camera/OverviewController.h&quot;
+#include &quot;Camera/TWController.h&quot;
+#include &quot;Camera/OrbitController.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;GlobalUnsynced.h&quot;

Modified: branches/caiinterface/rts/Game/Game.cpp
===================================================================
--- branches/caiinterface/rts/Game/Game.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/Game.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -42,9 +42,9 @@
 #include &quot;GameVersion.h&quot;
 #include &quot;LoadSaveHandler.h&quot;
 #include &quot;SelectedUnits.h&quot;
+#include &quot;PlayerHandler.h&quot;
 #include &quot;PlayerRoster.h&quot;
 #include &quot;Sync/SyncTracer.h&quot;
-#include &quot;Team.h&quot;
 #include &quot;ChatMessage.h&quot;
 #include &quot;TimeProfiler.h&quot;
 #include &quot;WaitCommandsAI.h&quot;
@@ -69,7 +69,7 @@
 #include &quot;NetProtocol.h&quot;
 #include &quot;DemoRecorder.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;Rendering/Env/BaseSky.h&quot;
 #include &quot;Rendering/Env/BaseTreeDrawer.h&quot;
 #include &quot;Rendering/Env/BaseWater.h&quot;
@@ -92,16 +92,17 @@
 #include &quot;Lua/LuaParser.h&quot;
 #include &quot;Lua/LuaSyncedRead.h&quot;
 #include &quot;Lua/LuaUnsyncedCtrl.h&quot;
-#include &quot;Sim/ModInfo.h&quot;
-#include &quot;Sim/SideParser.h&quot;
 #include &quot;Sim/Misc/CategoryHandler.h&quot;
 #include &quot;Sim/Misc/DamageArrayHandler.h&quot;
 #include &quot;Sim/Features/FeatureHandler.h&quot;
 #include &quot;Sim/Misc/GeometricObjects.h&quot;
 #include &quot;Sim/Misc/GroundBlockingObjectMap.h&quot;
 #include &quot;Sim/Misc/LosHandler.h&quot;
+#include &quot;Sim/Misc/ModInfo.h&quot;
 #include &quot;Sim/Misc/QuadField.h&quot;
 #include &quot;Sim/Misc/RadarHandler.h&quot;
+#include &quot;Sim/Misc/SideParser.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Misc/Wind.h&quot;
 #include &quot;Sim/MoveTypes/MoveInfo.h&quot;
 #include &quot;Sim/Path/PathManager.h&quot;
@@ -118,13 +119,13 @@
 #include &quot;StartScripts/Script.h&quot;
 #include &quot;StartScripts/ScriptHandler.h&quot;
 #include &quot;Sync/SyncedPrimitiveIO.h&quot;
-#include &quot;System/Util.h&quot;
-#include &quot;System/Exceptions.h&quot;
-#include &quot;System/EventHandler.h&quot;
-#include &quot;System/Sound.h&quot;
-#include &quot;System/FileSystem/SimpleParser.h&quot;
-#include &quot;System/Platform/NullSound.h&quot;
-#include &quot;System/Net/RawPacket.h&quot;
+#include &quot;Util.h&quot;
+#include &quot;Exceptions.h&quot;
+#include &quot;EventHandler.h&quot;
+#include &quot;Sound.h&quot;
+#include &quot;FileSystem/SimpleParser.h&quot;
+#include &quot;Platform/NullSound.h&quot;
+#include &quot;Net/RawPacket.h&quot;
 #include &quot;UI/CommandColors.h&quot;
 #include &quot;UI/CursorIcons.h&quot;
 #include &quot;UI/EndGameBox.h&quot;
@@ -171,7 +172,7 @@
 CGame* game = NULL;
 
 
-CR_BIND(CGame, (std::string(&quot;&quot;), std::string(&quot;&quot;), NULL, NULL));
+CR_BIND(CGame, (std::string(&quot;&quot;), std::string(&quot;&quot;), NULL));
 
 CR_REG_METADATA(CGame,(
 	CR_RESERVED(4),//r3927
@@ -212,7 +213,7 @@
 ));
 
 
-CGame::CGame(std::string mapname, std::string modName, CInfoConsole *ic, CLoadSaveHandler *saveFile)
+CGame::CGame(std::string mapname, std::string modName, CLoadSaveHandler *saveFile)
 : lastFrameTime(0),
   drawMode(notDrawing),
   drawSky(true),
@@ -230,7 +231,7 @@
 
 	memset(gameID, 0, sizeof(gameID));
 
-	infoConsole = ic;
+	infoConsole = new CInfoConsole();
 
 	script = NULL;
 
@@ -291,7 +292,7 @@
 	consoleHistory = SAFE_NEW CConsoleHistory;
 	wordCompletion = SAFE_NEW CWordCompletion;
 	for (int pp = 0; pp &lt; MAX_PLAYERS; pp++) {
-	  wordCompletion-&gt;AddWord(gs-&gt;players[pp]-&gt;name, false, false, false);
+	  wordCompletion-&gt;AddWord(playerHandler-&gt;Player(pp)-&gt;name, false, false, false);
 	}
 
 #ifdef DIRECT_CONTROL_ALLOWED
@@ -446,7 +447,7 @@
 //	globalAI = SAFE_NEW CGlobalAIHandler();
 	CEngineOutHandler::Initialize();
 
-	CPlayer* p = gs-&gt;players[gu-&gt;myPlayerNum];
+	CPlayer* p = playerHandler-&gt;Player(gu-&gt;myPlayerNum);
 	GameSetupDrawer::Enable();
 
 	if (gs-&gt;useLuaRules) {
@@ -511,11 +512,11 @@
 	net-&gt;loading = false;
 	thread.join();
 #ifdef USE_GML
-	logOutput.Print(&quot;Spring %s MT (%d threads)&quot;,VERSION_STRING_DETAILED, gmlThreadCount);
+	logOutput.Print(&quot;Spring %s MT (%d threads)&quot;,SpringVersion::GetFull().c_str(), gmlThreadCount);
 #else
-	logOutput.Print(&quot;Spring %s&quot;,VERSION_STRING_DETAILED);
+	logOutput.Print(&quot;Spring %s&quot;,SpringVersion::GetFull().c_str());
 #endif
-	logOutput.Print(&quot;Build date/time: %s&quot;, BUILD_DATETIME);
+	logOutput.Print(&quot;Build date/time: %s&quot;, SpringVersion::BuildTime);
 	//sending your playername to the server indicates that you are finished loading
 	net-&gt;Send(CBaseNetProtocol::Get().SendPlayerName(gu-&gt;myPlayerNum, p-&gt;name));
 
@@ -644,7 +645,7 @@
 int CGame::KeyPressed(unsigned short k, bool isRepeat)
 {
 	if (!gameOver &amp;&amp; !isRepeat) {
-		gs-&gt;players[gu-&gt;myPlayerNum]-&gt;currentStats-&gt;keyPresses++;
+		playerHandler-&gt;Player(gu-&gt;myPlayerNum)-&gt;currentStats-&gt;keyPresses++;
 	}
 
 	if (!hotBinding.empty()) {
@@ -669,7 +670,7 @@
 
 	if (userWriting) {
 		unsigned int actionIndex;
-		for (actionIndex = 0; actionIndex &lt; (int)actionList.size(); actionIndex++) {
+		for (actionIndex = 0; actionIndex &lt; actionList.size(); actionIndex++) {
 			const Action&amp; action = actionList[actionIndex];
 
 			if (action.command == &quot;edit_return&quot;) {
@@ -970,7 +971,7 @@
 	else if (cmd == &quot;w&quot;) {
 		const std::string::size_type pos = action.extra.find_first_of(&quot; &quot;);
 		if (pos != std::string::npos) {
-			const int playernum = gs-&gt;Player(action.extra.substr(0, pos));
+			const int playernum = playerHandler-&gt;Player(action.extra.substr(0, pos));
 			if (playernum &gt;= 0) {
 				SendNetChat(action.extra.substr(pos+1), playernum);
 			} else {
@@ -1073,7 +1074,7 @@
 		if (gs-&gt;cheatEnabled)
 		{
 			int team=atoi(action.extra.c_str());
-			if ((team &gt;= 0) &amp;&amp; (team &lt;gs-&gt;activeTeams)) {
+			if ((team &gt;= 0) &amp;&amp; (team &lt; teamHandler-&gt;ActiveTeams())) {
 				net-&gt;Send(CBaseNetProtocol::Get().SendJoinTeam(gu-&gt;myPlayerNum, team));
 			}
 		}
@@ -1083,9 +1084,9 @@
 	}
 	else if ((cmd == &quot;specteam&quot;) &amp;&amp; gu-&gt;spectating) {
 		const int team = atoi(action.extra.c_str());
-		if ((team &gt;= 0) &amp;&amp; (team &lt; gs-&gt;activeTeams)) {
+		if ((team &gt;= 0) &amp;&amp; (team &lt; teamHandler-&gt;ActiveTeams())) {
 			gu-&gt;myTeam = team;
-			gu-&gt;myAllyTeam = gs-&gt;AllyTeam(team);
+			gu-&gt;myAllyTeam = teamHandler-&gt;AllyTeam(team);
 		}
 		CLuaUI::UpdateTeams();
 	}
@@ -1328,6 +1329,7 @@
 		} else {
 			gd-&gt;multiThreadDrawGround = !!atoi(action.extra.c_str());
 		}
+		logOutput.Print(&quot;Multithreaded ground rendering is %s&quot;, gd-&gt;multiThreadDrawGround?&quot;enabled&quot;:&quot;disabled&quot;);
 	}
 	else if (cmd == &quot;multithreaddrawgroundshadow&quot;) {
 		if (action.extra.empty()) {
@@ -1335,6 +1337,7 @@
 		} else {
 			gd-&gt;multiThreadDrawGroundShadow = !!atoi(action.extra.c_str());
 		}
+		logOutput.Print(&quot;Multithreaded ground shadow rendering is %s&quot;, gd-&gt;multiThreadDrawGroundShadow?&quot;enabled&quot;:&quot;disabled&quot;);
 	}
 	else if (cmd == &quot;multithreaddrawunit&quot;) {
 		if (action.extra.empty()) {
@@ -1342,6 +1345,7 @@
 		} else {
 			unitDrawer-&gt;multiThreadDrawUnit = !!atoi(action.extra.c_str());
 		}
+		logOutput.Print(&quot;Multithreaded unit rendering is %s&quot;, unitDrawer-&gt;multiThreadDrawUnit?&quot;enabled&quot;:&quot;disabled&quot;);
 	}
 	else if (cmd == &quot;multithreaddrawunitshadow&quot;) {
 		if (action.extra.empty()) {
@@ -1349,30 +1353,37 @@
 		} else {
 			unitDrawer-&gt;multiThreadDrawUnitShadow = !!atoi(action.extra.c_str());
 		}
+		logOutput.Print(&quot;Multithreaded unit shadow rendering is %s&quot;, unitDrawer-&gt;multiThreadDrawUnitShadow?&quot;enabled&quot;:&quot;disabled&quot;);
 	}
-	else if (cmd == &quot;multithread&quot;) {
-		if (action.extra.empty()) {
-			int mtenabled=gd-&gt;multiThreadDrawGround + unitDrawer-&gt;multiThreadDrawUnit + unitDrawer-&gt;multiThreadDrawUnitShadow &gt; 1;
-			gd-&gt;multiThreadDrawGround = !mtenabled;
-			unitDrawer-&gt;multiThreadDrawUnit = !mtenabled;
-			unitDrawer-&gt;multiThreadDrawUnitShadow = !mtenabled;
-		} else {
-			gd-&gt;multiThreadDrawGround = !!atoi(action.extra.c_str());
-			unitDrawer-&gt;multiThreadDrawUnit = !!atoi(action.extra.c_str());
-			unitDrawer-&gt;multiThreadDrawUnitShadow = !!atoi(action.extra.c_str());
+	else if (cmd == &quot;multithread&quot; || cmd == &quot;multithreaddraw&quot; || cmd == &quot;multithreadsim&quot;) {
+		int mtenabled=gd-&gt;multiThreadDrawGround + unitDrawer-&gt;multiThreadDrawUnit + unitDrawer-&gt;multiThreadDrawUnitShadow &gt; 1;
+		if (cmd == &quot;multithread&quot; || cmd == &quot;multithreaddraw&quot;) {
+			if (action.extra.empty()) {
+				gd-&gt;multiThreadDrawGround = !mtenabled;
+				unitDrawer-&gt;multiThreadDrawUnit = !mtenabled;
+				unitDrawer-&gt;multiThreadDrawUnitShadow = !mtenabled;
+			} else {
+				gd-&gt;multiThreadDrawGround = !!atoi(action.extra.c_str());
+				unitDrawer-&gt;multiThreadDrawUnit = !!atoi(action.extra.c_str());
+				unitDrawer-&gt;multiThreadDrawUnitShadow = !!atoi(action.extra.c_str());
+			}
+			if(!gd-&gt;multiThreadDrawGround)
+				gd-&gt;multiThreadDrawGroundShadow=0;
+			logOutput.Print(&quot;Multithreaded rendering is %s&quot;, gd-&gt;multiThreadDrawGround?&quot;enabled&quot;:&quot;disabled&quot;);
 		}
-	}
-#endif
-#if defined(USE_GML) &amp;&amp; GML_ENABLE_SIMLOOP
-	else if (cmd == &quot;multithreadsim&quot;) {
-		extern volatile int multiThreadSim;
-		extern volatile int startsim;
-		if (action.extra.empty()) {
-			multiThreadSim = !multiThreadSim;
-		} else {
-			multiThreadSim = !!atoi(action.extra.c_str());
+#	if GML_ENABLE_SIMLOOP
+		if (cmd == &quot;multithread&quot; || cmd == &quot;multithreadsim&quot;) {
+			extern volatile int multiThreadSim;
+			extern volatile int startsim;
+			if (action.extra.empty()) {
+				multiThreadSim = (cmd == &quot;multithread&quot;) ? !mtenabled : !multiThreadSim;
+			} else {
+				multiThreadSim = !!atoi(action.extra.c_str());
+			}
+			startsim=1;
+			logOutput.Print(&quot;Simulation threading is %s&quot;, multiThreadSim?&quot;enabled&quot;:&quot;disabled&quot;);
 		}
-		startsim=1;
+#	endif
 	}
 #endif
 	else if (!isRepeat &amp;&amp; (cmd == &quot;gameinfo&quot;)) {
@@ -1513,7 +1524,7 @@
 		//  * If he's a spectator.
 		//  * If there are other active players on his team.
 		//  * If there are no other players
-		if (!playing || gameOver || gs-&gt;Team(gu-&gt;myTeam)-&gt;isDead || gu-&gt;spectating) {
+		if (!playing || gameOver || teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;isDead || gu-&gt;spectating) {
 			userMayQuit = true;
 		}
 		else {
@@ -1521,9 +1532,9 @@
 			bool onlyActive = true;
 			for (int a = 0;a &lt; MAX_PLAYERS; ++a) {
 				if (a != gu-&gt;myPlayerNum) {
-					if (gs-&gt;players[a]-&gt;active) {
+					if (playerHandler-&gt;Player(a)-&gt;active) {
 						onlyActive = false;
-						if (gs-&gt;players[a]-&gt;team == gu-&gt;myTeam) {
+						if (playerHandler-&gt;Player(a)-&gt;team == gu-&gt;myTeam) {
 							userMayQuit = true;
 							break;
 						}
@@ -2083,7 +2094,7 @@
 		selectedUnits.PossibleCommandChange(NULL);
 		if (gs-&gt;noHelperAIs) {
 			// remove any current GroupAIs
-			CUnitSet&amp; teamUnits = gs-&gt;Team(gu-&gt;myTeam)-&gt;units;
+			CUnitSet&amp; teamUnits = teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;units;
 			CUnitSet::iterator it;
 			for(it = teamUnits.begin(); it != teamUnits.end(); ++it)
 			{
@@ -2122,15 +2133,14 @@
 		}
 	}
 	else if (action.command == &quot;nocost&quot; &amp;&amp; gs-&gt;cheatEnabled) {
-		for(unsigned i=0; i&lt;unitDefHandler-&gt;numUnitDefs; i++)
-		{
+		for(int i = 0; i &lt; unitDefHandler-&gt;numUnitDefs; ++i) {
 			unitDefHandler-&gt;unitDefs[i].metalCost = 1;
 			unitDefHandler-&gt;unitDefs[i].energyCost = 1;
 			unitDefHandler-&gt;unitDefs[i].buildTime = 10;
 			unitDefHandler-&gt;unitDefs[i].metalUpkeep = 0;
 			unitDefHandler-&gt;unitDefs[i].energyUpkeep = 0;
 		}
-		unitDefHandler-&gt;noCost=true;
+		unitDefHandler-&gt;noCost = true;
 		logOutput.Print(&quot;Everything is for free!&quot;);
 	}
 	else if (action.command == &quot;give&quot; &amp;&amp; gs-&gt;cheatEnabled) {
@@ -2152,7 +2162,7 @@
 		}
 
 		int amount = 1;
-		int team = gs-&gt;players[playernum]-&gt;team;
+		int team = playerHandler-&gt;Player(playernum)-&gt;team;
 
 		int amountArg = -1;
 		int teamArg = -1;
@@ -2181,7 +2191,7 @@
 		if (teamArg &gt;= 0) {
 			const string&amp; teamStr = args[teamArg];
 			team = atoi(teamStr.c_str());
-			if ((team &lt; 0) || (team &gt;= gs-&gt;activeTeams) || (teamStr.find_first_not_of(&quot;0123456789&quot;) != string::npos)) {
+			if ((team &lt; 0) || (team &gt;= teamHandler-&gt;ActiveTeams()) || (teamStr.find_first_not_of(&quot;0123456789&quot;) != string::npos)) {
 				logOutput.Print(&quot;Bad give team: %s&quot;, teamStr.c_str());
 				return;
 			}
@@ -2192,7 +2202,7 @@
 		if (unitName == &quot;all&quot;) {
 			// player entered &quot;.give all&quot;
 			int sqSize = (int) streflop::ceil(streflop::sqrt((float) unitDefHandler-&gt;numUnitDefs));
-			int currentNumUnits = gs-&gt;Team(team)-&gt;units.size();
+			int currentNumUnits = teamHandler-&gt;Team(team)-&gt;units.size();
 			int numRequestedUnits = unitDefHandler-&gt;numUnitDefs;
 
 			// make sure team unit-limit not exceeded
@@ -2221,7 +2231,7 @@
 		}
 		else if (!unitName.empty()) {
 			int numRequestedUnits = amount;
-			int currentNumUnits = gs-&gt;Team(team)-&gt;units.size();
+			int currentNumUnits = teamHandler-&gt;Team(team)-&gt;units.size();
 
 			if (currentNumUnits &gt;= uh-&gt;maxUnits) {
 				logOutput.Print(&quot;Unable to give any more units to team %i&quot;, team);
@@ -2408,22 +2418,22 @@
 	}
 #endif
 	else if (action.command == &quot;atm&quot; &amp;&amp; gs-&gt;cheatEnabled) {
-		int team = gs-&gt;players[playernum]-&gt;team;
-		gs-&gt;Team(team)-&gt;AddMetal(1000);
-		gs-&gt;Team(team)-&gt;AddEnergy(1000);
+		int team = playerHandler-&gt;Player(playernum)-&gt;team;
+		teamHandler-&gt;Team(team)-&gt;AddMetal(1000);
+		teamHandler-&gt;Team(team)-&gt;AddEnergy(1000);
 	}
-	else if (action.command == &quot;take&quot; &amp;&amp; (!gs-&gt;players[playernum]-&gt;spectator || gs-&gt;cheatEnabled)) {
-		int sendTeam = gs-&gt;players[playernum]-&gt;team;
-		for (int a = 0; a &lt; gs-&gt;activeTeams; ++a) {
-			if (gs-&gt;AlliedTeams(a, sendTeam)) {
+	else if (action.command == &quot;take&quot; &amp;&amp; (!playerHandler-&gt;Player(playernum)-&gt;spectator || gs-&gt;cheatEnabled)) {
+		int sendTeam = playerHandler-&gt;Player(playernum)-&gt;team;
+		for (int a = 0; a &lt; teamHandler-&gt;ActiveTeams(); ++a) {
+			if (teamHandler-&gt;AlliedTeams(a, sendTeam)) {
 				bool hasPlayer = false;
-				for (int b = 0; b &lt; gs-&gt;activePlayers; ++b) {
-					if (gs-&gt;players[b]-&gt;active &amp;&amp; gs-&gt;players[b]-&gt;team==a &amp;&amp; !gs-&gt;players[b]-&gt;spectator) {
+				for (int b = 0; b &lt; playerHandler-&gt;ActivePlayers(); ++b) {
+					if (playerHandler-&gt;Player(b)-&gt;active &amp;&amp; playerHandler-&gt;Player(b)-&gt;team==a &amp;&amp; !playerHandler-&gt;Player(b)-&gt;spectator) {
 						hasPlayer = true;
 					}
 				}
 				if (!hasPlayer) {
-					gs-&gt;Team(a)-&gt;GiveEverythingTo(sendTeam);
+					teamHandler-&gt;Team(a)-&gt;GiveEverythingTo(sendTeam);
 				}
 			}
 		}
@@ -2926,7 +2936,7 @@
 		const int* indices = playerRoster.GetIndices(&amp;count);
 
 		for (int a = 0; a &lt; count; ++a) {
-			const CPlayer* p = gs-&gt;players[indices[a]];
+			const CPlayer* p = playerHandler-&gt;Player(indices[a]);
 			float color[4];
 			const char* prefix;
 			if (p-&gt;spectator) {
@@ -2936,14 +2946,14 @@
 				color[3] = 1.0f;
 				prefix = &quot;S|&quot;;
 			} else {
-				const unsigned char* bColor = gs-&gt;Team(p-&gt;team)-&gt;color;
+				const unsigned char* bColor = teamHandler-&gt;Team(p-&gt;team)-&gt;color;
 				color[0] = (float)bColor[0] / 255.0f;
 				color[1] = (float)bColor[1] / 255.0f;
 				color[2] = (float)bColor[2] / 255.0f;
 				color[3] = (float)bColor[3] / 255.0f;
-				if (gu-&gt;myAllyTeam == gs-&gt;AllyTeam(p-&gt;team))
+				if (gu-&gt;myAllyTeam ==teamHandler-&gt;AllyTeam(p-&gt;team))
 					prefix = &quot;A|&quot;;	// same AllyTeam
-				else if (gs-&gt;AlliedTeams(gu-&gt;myTeam, p-&gt;team))
+				else if (teamHandler-&gt;AlliedTeams(gu-&gt;myTeam, p-&gt;team))
 					prefix = &quot;E+|&quot;;	// different AllyTeams, but are allied
 				else
 					prefix = &quot;E|&quot;;	//no alliance at all
@@ -3066,8 +3076,8 @@
 	lastframe = SDL_GetTicks();
 
 	ENTER_MIXED;
-	gu-&gt;myTeam = gs-&gt;players[gu-&gt;myPlayerNum]-&gt;team;
-	gu-&gt;myAllyTeam = gs-&gt;AllyTeam(gu-&gt;myTeam);
+	gu-&gt;myTeam = playerHandler-&gt;Player(gu-&gt;myPlayerNum)-&gt;team;
+	gu-&gt;myAllyTeam = teamHandler-&gt;AllyTeam(gu-&gt;myTeam);
 //	grouphandler-&gt;team = gu-&gt;myTeam;
 	CLuaUI::UpdateTeams();
 
@@ -3212,23 +3222,24 @@
 	loshandler-&gt;Update();
 
 	if (!(gs-&gt;frameNum &amp; 31)) {
-		for (int a = 0; a &lt; gs-&gt;activeTeams; ++a) {
-			gs-&gt;Team(a)-&gt;ResetFrameVariables();
+		// TODO: move to CTeamHandler
+		for (int a = 0; a &lt; teamHandler-&gt;ActiveTeams(); ++a) {
+			teamHandler-&gt;Team(a)-&gt;ResetFrameVariables();
 		}
-		for (int a = 0; a &lt; gs-&gt;activeTeams; ++a) {
-			gs-&gt;Team(a)-&gt;SlowUpdate();
+		for (int a = 0; a &lt; teamHandler-&gt;ActiveTeams(); ++a) {
+			teamHandler-&gt;Team(a)-&gt;SlowUpdate();
 		}
 	}
 
 	lastUpdate = SDL_GetTicks();
 
 #ifdef DIRECT_CONTROL_ALLOWED
-	for(int a=0;a&lt;gs-&gt;activePlayers;++a){
-		if(!gs-&gt;players[a]-&gt;active || !gs-&gt;players[a]-&gt;playerControlledUnit)
+	for(int a=0;a&lt;playerHandler-&gt;ActivePlayers();++a){
+		if(!playerHandler-&gt;Player(a)-&gt;active || !playerHandler-&gt;Player(a)-&gt;playerControlledUnit)
 			continue;
 
-		CUnit* unit=gs-&gt;players[a]-&gt;playerControlledUnit;
-		DirectControlStruct* dc=&amp;gs-&gt;players[a]-&gt;myControl;
+		CUnit* unit=playerHandler-&gt;Player(a)-&gt;playerControlledUnit;
+		DirectControlStruct* dc=&amp;playerHandler-&gt;Player(a)-&gt;myControl;
 
 		std::vector&lt;int&gt; args;
 		args.push_back(0);
@@ -3238,7 +3249,7 @@
 		pos+=UpVector*7;
 
 		CUnit* hit;
-		float dist=helper-&gt;TraceRayTeam(pos,dc-&gt;viewDir,unit-&gt;maxRange,hit,1,unit,gs-&gt;AllyTeam(gs-&gt;players[a]-&gt;team));
+		float dist=helper-&gt;TraceRayTeam(pos,dc-&gt;viewDir,unit-&gt;maxRange,hit,1,unit,teamHandler-&gt;AllyTeam(playerHandler-&gt;Player(a)-&gt;team));
 		dc-&gt;target=hit;
 
 		if(hit){
@@ -3378,23 +3389,23 @@
 				} else {
 					switch (inbuf[2]) {
 						case 1: {
-							if (gs-&gt;players[player]-&gt;spectator) {
-								logOutput.Print(&quot;Spectator %s left&quot;, gs-&gt;players[player]-&gt;name.c_str());
+							if (playerHandler-&gt;Player(player)-&gt;spectator) {
+								logOutput.Print(&quot;Spectator %s left&quot;, playerHandler-&gt;Player(player)-&gt;name.c_str());
 							} else {
-								logOutput.Print(&quot;Player %s left&quot;, gs-&gt;players[player]-&gt;name.c_str());
+								logOutput.Print(&quot;Player %s left&quot;, playerHandler-&gt;Player(player)-&gt;name.c_str());
 							}
 							break;
 						}
 						case 2:
-							logOutput.Print(&quot;Player %s has been kicked&quot;, gs-&gt;players[player]-&gt;name.c_str());
+							logOutput.Print(&quot;Player %s has been kicked&quot;, playerHandler-&gt;Player(player)-&gt;name.c_str());
 							break;
 						case 0:
-							logOutput.Print(&quot;Lost connection to %s&quot;, gs-&gt;players[player]-&gt;name.c_str());
+							logOutput.Print(&quot;Lost connection to %s&quot;, playerHandler-&gt;Player(player)-&gt;name.c_str());
 							break;
 						default:
-							logOutput.Print(&quot;Player %s left the game (reason unknown: %i)&quot;, gs-&gt;players[player]-&gt;name.c_str(), inbuf[2]);
+							logOutput.Print(&quot;Player %s left the game (reason unknown: %i)&quot;, playerHandler-&gt;Player(player)-&gt;name.c_str(), inbuf[2]);
 					}
-					gs-&gt;players[player]-&gt;active = false;
+					playerHandler-&gt;Player(player)-&gt;active = false;
 				}
 				AddTraffic(player, packetCode, dataLength);
 				break;
@@ -3440,7 +3451,7 @@
 				logOutput.Print(&quot;Game over&quot;);
 			// Warning: using CPlayer::Statistics here may cause endianness problems
 			// once net-&gt;SendData is endian aware!
-				net-&gt;Send(CBaseNetProtocol::Get().SendPlayerStat(gu-&gt;myPlayerNum, *gs-&gt;players[gu-&gt;myPlayerNum]-&gt;currentStats));
+				net-&gt;Send(CBaseNetProtocol::Get().SendPlayerStat(gu-&gt;myPlayerNum, *playerHandler-&gt;Player(gu-&gt;myPlayerNum)-&gt;currentStats));
 				ENTER_SYNCED;
 				AddTraffic(-1, packetCode, dataLength);
 				break;
@@ -3452,11 +3463,11 @@
 					logOutput.Print(&quot;Got invalid player num %i in playerstat msg&quot;,player);
 					break;
 				}
-				*gs-&gt;players[player]-&gt;currentStats = *(CPlayer::Statistics*)&amp;inbuf[2];
+				*playerHandler-&gt;Player(player)-&gt;currentStats = *(CPlayer::Statistics*)&amp;inbuf[2];
 				if (gameOver) {
 					CDemoRecorder* record = net-&gt;GetDemoRecorder();
 					if (record != NULL) {
-						record-&gt;SetPlayerStats(player, *gs-&gt;players[player]-&gt;currentStats);
+						record-&gt;SetPlayerStats(player, *playerHandler-&gt;Player(player)-&gt;currentStats);
 					}
 				}
 				AddTraffic(player, packetCode, dataLength);
@@ -3471,9 +3482,9 @@
 				else if (!skipping) {
 					gs-&gt;paused=!!inbuf[2];
 					if(gs-&gt;paused){
-						logOutput.Print(&quot;%s paused the game&quot;,gs-&gt;players[player]-&gt;name.c_str());
+						logOutput.Print(&quot;%s paused the game&quot;,playerHandler-&gt;Player(player)-&gt;name.c_str());
 					} else {
-						logOutput.Print(&quot;%s unpaused the game&quot;,gs-&gt;players[player]-&gt;name.c_str());
+						logOutput.Print(&quot;%s unpaused the game&quot;,playerHandler-&gt;Player(player)-&gt;name.c_str());
 					}
 					lastframe = SDL_GetTicks();
 				}
@@ -3492,7 +3503,7 @@
 				gs-&gt;userSpeedFactor = *((float*) &amp;inbuf[2]);
 
 				unsigned char pNum = *(unsigned char*) &amp;inbuf[1];
-				const char* pName = (pNum == SERVER_PLAYER)? &quot;server&quot;: gs-&gt;players[pNum]-&gt;name.c_str();
+				const char* pName = (pNum == SERVER_PLAYER)? &quot;server&quot;: playerHandler-&gt;Player(pNum)-&gt;name.c_str();
 
 				logOutput.Print(&quot;Speed set to %.1f [%s]&quot;, gs-&gt;userSpeedFactor, pName);
 				AddTraffic(pNum, packetCode, dataLength);
@@ -3510,8 +3521,8 @@
 				if (player &gt;= MAX_PLAYERS || player &lt; 0) {
 					logOutput.Print(&quot;Got invalid player num %i in playerinfo msg&quot;, player);
 				} else {
-					gs-&gt;players[player]-&gt;cpuUsage = *(float*) &amp;inbuf[2];
-					gs-&gt;players[player]-&gt;ping = *(int*) &amp;inbuf[6];
+					playerHandler-&gt;Player(player)-&gt;cpuUsage = *(float*) &amp;inbuf[2];
+					playerHandler-&gt;Player(player)-&gt;ping = *(int*) &amp;inbuf[6];
 				}
 				AddTraffic(player, packetCode, dataLength);
 				break;
@@ -3519,13 +3530,13 @@
 
 			case NETMSG_PLAYERNAME: {
 				int player = inbuf[2];
-				gs-&gt;players[player]-&gt;name=(char*)(&amp;inbuf[3]);
-				gs-&gt;players[player]-&gt;readyToStart=true;
-				gs-&gt;players[player]-&gt;active=true;
+				playerHandler-&gt;Player(player)-&gt;name=(char*)(&amp;inbuf[3]);
+				playerHandler-&gt;Player(player)-&gt;readyToStart=true;
+				playerHandler-&gt;Player(player)-&gt;active=true;
 				if (net-&gt;GetDemoRecorder()) {
 					net-&gt;GetDemoRecorder()-&gt;SetMaxPlayerNum(inbuf[2]);
 				}
-				wordCompletion-&gt;AddWord(gs-&gt;players[player]-&gt;name, false, false, false); // required?
+				wordCompletion-&gt;AddWord(playerHandler-&gt;Player(player)-&gt;name, false, false, false); // required?
 				AddTraffic(player, packetCode, dataLength);
 				break;
 			}
@@ -3547,7 +3558,7 @@
 			case NETMSG_STARTPOS:{
 				unsigned player = inbuf[1];
 				int team = inbuf[2];
-				if ((team &gt;= gs-&gt;activeTeams) || (team &lt; 0)) {
+				if ((team &gt;= teamHandler-&gt;ActiveTeams()) || (team &lt; 0)) {
 					logOutput.Print(&quot;Got invalid team num %i in startpos msg&quot;,team);
 				} else {
 					float3 pos(*(float*)&amp;inbuf[4],
@@ -3555,10 +3566,10 @@
 					           *(float*)&amp;inbuf[12]);
 					if (!luaRules || luaRules-&gt;AllowStartPosition(player, pos)) {
 						if (inbuf[3] != 2) {
-							gs-&gt;Team(team)-&gt;StartposMessage(pos, !!inbuf[3]);
+							teamHandler-&gt;Team(team)-&gt;StartposMessage(pos, !!inbuf[3]);
 						}
 						else
-							gs-&gt;Team(team)-&gt;StartposMessage(pos);
+							teamHandler-&gt;Team(team)-&gt;StartposMessage(pos);
 						char label[128];
 						SNPRINTF(label, sizeof(label), &quot;Start %i&quot;, team);
 						inMapDrawer-&gt;LocalPoint(pos, label, player);
@@ -3652,7 +3663,7 @@
 							break;
 						}
 						if ((uh-&gt;units[unitid] &amp;&amp;
-						    (uh-&gt;units[unitid]-&gt;team == gs-&gt;players[player]-&gt;team)) ||
+						    (uh-&gt;units[unitid]-&gt;team == playerHandler-&gt;Player(player)-&gt;team)) ||
 						    gs-&gt;godMode) {
 							selected.push_back(unitid);
 						}
@@ -3753,14 +3764,14 @@
 
 				if (metalShare &gt; 0.0f) {
 					if (!luaRules || luaRules-&gt;AllowResourceTransfer(srcTeam, dstTeam, &quot;m&quot;, metalShare)) {
-						gs-&gt;Team(srcTeam)-&gt;metal -= metalShare;
-						gs-&gt;Team(dstTeam)-&gt;metal += metalShare;
+						teamHandler-&gt;Team(srcTeam)-&gt;metal -= metalShare;
+						teamHandler-&gt;Team(dstTeam)-&gt;metal += metalShare;
 					}
 				}
 				if (energyShare &gt; 0.0f) {
 					if (!luaRules || luaRules-&gt;AllowResourceTransfer(srcTeam, dstTeam, &quot;e&quot;, energyShare)) {
-						gs-&gt;Team(srcTeam)-&gt;energy -= energyShare;
-						gs-&gt;Team(dstTeam)-&gt;energy += energyShare;
+						teamHandler-&gt;Team(srcTeam)-&gt;energy -= energyShare;
+						teamHandler-&gt;Team(dstTeam)-&gt;energy += energyShare;
 					}
 				}
 
@@ -3809,22 +3820,22 @@
 					logOutput.Print(&quot;Got invalid player num %i in share msg&quot;,player);
 					break;
 				}
-				int team1 = gs-&gt;players[player]-&gt;team;
+				int team1 = playerHandler-&gt;Player(player)-&gt;team;
 				int team2 = inbuf[2];
 				bool shareUnits = !!inbuf[3];
-				float metalShare = std::min(*(float*)&amp;inbuf[4], (float)gs-&gt;Team(team1)-&gt;metal);
-				float energyShare = std::min(*(float*)&amp;inbuf[8], (float)gs-&gt;Team(team1)-&gt;energy);
+				float metalShare = std::min(*(float*)&amp;inbuf[4], (float)teamHandler-&gt;Team(team1)-&gt;metal);
+				float energyShare = std::min(*(float*)&amp;inbuf[8], (float)teamHandler-&gt;Team(team1)-&gt;energy);
 
 				if (metalShare != 0.0f) {
 					if (!luaRules || luaRules-&gt;AllowResourceTransfer(team1, team2, &quot;m&quot;, metalShare)) {
-						gs-&gt;Team(team1)-&gt;metal -= metalShare;
-						gs-&gt;Team(team2)-&gt;metal += metalShare;
+						teamHandler-&gt;Team(team1)-&gt;metal -= metalShare;
+						teamHandler-&gt;Team(team2)-&gt;metal += metalShare;
 					}
 				}
 				if (energyShare != 0.0f) {
 					if (!luaRules || luaRules-&gt;AllowResourceTransfer(team1, team2, &quot;e&quot;, energyShare)) {
-						gs-&gt;Team(team1)-&gt;energy -= energyShare;
-						gs-&gt;Team(team2)-&gt;energy += energyShare;
+						teamHandler-&gt;Team(team1)-&gt;energy -= energyShare;
+						teamHandler-&gt;Team(team2)-&gt;energy += energyShare;
 					}
 				}
 
@@ -3849,17 +3860,17 @@
 			case NETMSG_SETSHARE: {
 				int player=inbuf[1];
 				int team=inbuf[2];
-				if ((team &gt;= gs-&gt;activeTeams) || (team &lt; 0)) {
+				if ((team &gt;= teamHandler-&gt;ActiveTeams()) || (team &lt; 0)) {
 					logOutput.Print(&quot;Got invalid team num %i in setshare msg&quot;,team);
 				} else {
 					float metalShare=*(float*)&amp;inbuf[3];
 					float energyShare=*(float*)&amp;inbuf[7];
 
 					if (!luaRules || luaRules-&gt;AllowResourceLevel(team, &quot;m&quot;, metalShare)) {
-						gs-&gt;Team(team)-&gt;metalShare = metalShare;
+						teamHandler-&gt;Team(team)-&gt;metalShare = metalShare;
 					}
 					if (!luaRules || luaRules-&gt;AllowResourceLevel(team, &quot;e&quot;, energyShare)) {
-						gs-&gt;Team(team)-&gt;energyShare = energyShare;
+						teamHandler-&gt;Team(team)-&gt;energyShare = energyShare;
 					}
 				}
 				AddTraffic(player, packetCode, dataLength);
@@ -3873,11 +3884,11 @@
 			case NETMSG_TEAM: {
 				const int player = (int)inbuf[1];
 				const unsigned char action = inbuf[2];
-				const int fromTeam = gs-&gt;players[player]-&gt;team;
+				const int fromTeam = playerHandler-&gt;Player(player)-&gt;team;
 
 				unsigned numPlayersInTeam = 0;
 				for (int a = 0; a &lt; MAX_PLAYERS; ++a) {
-					if (gs-&gt;players[a]-&gt;active &amp;&amp; (gs-&gt;players[a]-&gt;team == fromTeam)) {
+					if (playerHandler-&gt;Player(a)-&gt;active &amp;&amp; (playerHandler-&gt;Player(a)-&gt;team == fromTeam)) {
 						++numPlayersInTeam;
 					}
 				}
@@ -3887,23 +3898,23 @@
 					case TEAMMSG_GIVEAWAY: {
 						const int toTeam = inbuf[3];
 						if (numPlayersInTeam == 1) {
-							gs-&gt;Team(fromTeam)-&gt;GiveEverythingTo(toTeam);
-							gs-&gt;Team(fromTeam)-&gt;leader = -1;
+							teamHandler-&gt;Team(fromTeam)-&gt;GiveEverythingTo(toTeam);
+							teamHandler-&gt;Team(fromTeam)-&gt;leader = -1;
 						} else {
-							gs-&gt;players[player]-&gt;StartSpectating();
+							playerHandler-&gt;Player(player)-&gt;StartSpectating();
 						}
 						CPlayer::UpdateControlledTeams();
 						break;
 					}
 					case TEAMMSG_RESIGN: {
-						gs-&gt;players[player]-&gt;StartSpectating();
+						playerHandler-&gt;Player(player)-&gt;StartSpectating();
 						if (player == gu-&gt;myPlayerNum) {
 							selectedUnits.ClearSelected();
 							unitTracker.Disable();
 							CLuaUI::UpdateTeams();
 						}
 						if (numPlayersInTeam == 1) {
-							gs-&gt;Team(fromTeam)-&gt;leader = -1;
+							teamHandler-&gt;Team(fromTeam)-&gt;leader = -1;
 						}
 						logOutput.Print(&quot;Player %i resigned and is now spectating!&quot;, player);
 						CPlayer::UpdateControlledTeams();
@@ -3911,11 +3922,11 @@
 					}
 					case TEAMMSG_JOIN_TEAM: {
 						int newTeam = int(inbuf[3]);
-						gs-&gt;players[player]-&gt;team = newTeam;
-						gs-&gt;players[player]-&gt;spectator = false;
+						playerHandler-&gt;Player(player)-&gt;team = newTeam;
+						playerHandler-&gt;Player(player)-&gt;spectator = false;
 						if (player == gu-&gt;myPlayerNum) {
 							gu-&gt;myTeam = newTeam;
-							gu-&gt;myAllyTeam = gs-&gt;AllyTeam(gu-&gt;myTeam);
+							gu-&gt;myAllyTeam = teamHandler-&gt;AllyTeam(gu-&gt;myTeam);
 							gu-&gt;spectating           = false;
 							gu-&gt;spectatingFullView   = false;
 							gu-&gt;spectatingFullSelect = false;
@@ -3923,8 +3934,8 @@
 							unitTracker.Disable();
 							CLuaUI::UpdateTeams();
 						}
-						if (gs-&gt;Team(newTeam)-&gt;leader == -1) {
-							gs-&gt;Team(newTeam)-&gt;leader = player;
+						if (teamHandler-&gt;Team(newTeam)-&gt;leader == -1) {
+							teamHandler-&gt;Team(newTeam)-&gt;leader = player;
 						}
 						CPlayer::UpdateControlledTeams();
 						eventHandler.PlayerChanged(player);
@@ -3945,11 +3956,11 @@
 					// FIXME - need to reset unit allyTeams
 					//       - need to reset unit texture for 3do
 					//       - need a call-in for AIs
-					gs-&gt;SetAlly(gs-&gt;AllyTeam(gs-&gt;players[player]-&gt;team), whichAllyTeam, allied);
+					teamHandler-&gt;SetAlly(teamHandler-&gt;AllyTeam(playerHandler-&gt;Player(player)-&gt;team), whichAllyTeam, allied);
 				} else {
 					logOutput.Print(&quot;Player %i sent out wrong allyTeam index in alliance message&quot;, player);
 				}
-				eventHandler.TeamChanged(gs-&gt;players[player]-&gt;team);
+				eventHandler.TeamChanged(playerHandler-&gt;Player(player)-&gt;team);
 				break;
 			}
 			case NETMSG_CCOMMAND: {
@@ -3967,27 +3978,27 @@
 					break;
 				}
 
-				CUnit* ctrlUnit = gs-&gt;players[player]-&gt;playerControlledUnit;
+				CUnit* ctrlUnit = playerHandler-&gt;Player(player)-&gt;playerControlledUnit;
 				if (ctrlUnit) {
-					CUnit* unit=gs-&gt;players[player]-&gt;playerControlledUnit;
-				//logOutput.Print(&quot;Player %s released control over unit %i type %s&quot;,gs-&gt;players[player]-&gt;name.c_str(),unit-&gt;id,unit-&gt;unitDef-&gt;humanName.c_str());
+					CUnit* unit=playerHandler-&gt;Player(player)-&gt;playerControlledUnit;
+				//logOutput.Print(&quot;Player %s released control over unit %i type %s&quot;,playerHandler-&gt;Player(player)-&gt;name.c_str(),unit-&gt;id,unit-&gt;unitDef-&gt;humanName.c_str());
 
 					unit-&gt;directControl=0;
 					unit-&gt;AttackUnit(0,true);
-					gs-&gt;players[player]-&gt;StopControllingUnit();
+					playerHandler-&gt;Player(player)-&gt;StopControllingUnit();
 				}
 				else {
 					if(!selectedUnits.netSelected[player].empty() &amp;&amp; uh-&gt;units[selectedUnits.netSelected[player][0]] &amp;&amp; !uh-&gt;units[selectedUnits.netSelected[player][0]]-&gt;weapons.empty()){
 						CUnit* unit = uh-&gt;units[selectedUnits.netSelected[player][0]];
-						//logOutput.Print(&quot;Player %s took control over unit %i type %s&quot;,gs-&gt;players[player]-&gt;name.c_str(),unit-&gt;id,unit-&gt;unitDef-&gt;humanName.c_str());
+						//logOutput.Print(&quot;Player %s took control over unit %i type %s&quot;,playerHandler-&gt;Player(player)-&gt;name.c_str(),unit-&gt;id,unit-&gt;unitDef-&gt;humanName.c_str());
 						if (unit-&gt;directControl) {
 							if (player == gu-&gt;myPlayerNum) {
 								logOutput.Print(&quot;Sorry someone already controls that unit&quot;);
 							}
 						}
 						else if (!luaRules || luaRules-&gt;AllowDirectUnitControl(player, unit)) {
-							unit-&gt;directControl=&amp;gs-&gt;players[player]-&gt;myControl;
-							gs-&gt;players[player]-&gt;playerControlledUnit=unit;
+							unit-&gt;directControl=&amp;playerHandler-&gt;Player(player)-&gt;myControl;
+							playerHandler-&gt;Player(player)-&gt;playerControlledUnit=unit;
 							ENTER_UNSYNCED;
 							if (player == gu-&gt;myPlayerNum) {
 								gu-&gt;directControl = unit;
@@ -4015,8 +4026,8 @@
 					logOutput.Print(&quot;Got invalid player num %i in dc update msg&quot;,player);
 					break;
 				}
-				DirectControlStruct* dc = &amp;gs-&gt;players[player]-&gt;myControl;
-				CUnit* unit = gs-&gt;players[player]-&gt;playerControlledUnit;
+				DirectControlStruct* dc = &amp;playerHandler-&gt;Player(player)-&gt;myControl;
+				CUnit* unit = playerHandler-&gt;Player(player)-&gt;playerControlledUnit;
 
 				dc-&gt;forward    = !!(inbuf[2] &amp; (1 &lt;&lt; 0));
 				dc-&gt;back       = !!(inbuf[2] &amp; (1 &lt;&lt; 1));
@@ -4170,7 +4181,7 @@
 	if(cam)
 		camHandler-&gt;GetCurrentController().Update();
 
-	if(!cam) {
+	if(cam) {
 		if (chatting &amp;&amp; !userWriting) {
 			consoleHistory-&gt;AddLine(userInput);
 			string msg = userInput;
@@ -4228,7 +4239,7 @@
 		file &lt;&lt; &quot;  xpos &quot; &lt;&lt; p-&gt;pos.x &lt;&lt; &quot; ypos &quot; &lt;&lt; p-&gt;pos.y &lt;&lt; &quot; zpos &quot; &lt;&lt; p-&gt;pos.z &lt;&lt; &quot;\n&quot;;
 		file &lt;&lt; &quot;  xspeed &quot; &lt;&lt; p-&gt;speed.x &lt;&lt; &quot; yspeed &quot; &lt;&lt; p-&gt;speed.y &lt;&lt; &quot; zspeed &quot; &lt;&lt; p-&gt;speed.z &lt;&lt; &quot;\n&quot;;
 	}
-	for(int a=0;a&lt;gs-&gt;activeTeams;++a){
+	for(int a=0;a&lt;teamHandler-&gt;ActiveTeams();++a){
 		file &lt;&lt; &quot;Losmap for team &quot; &lt;&lt; a &lt;&lt; &quot;\n&quot;;
 		for(int y=0;y&lt;gs-&gt;mapy&gt;&gt;modInfo.losMipLevel;++y){
 			file &lt;&lt; &quot; &quot;;
@@ -4322,7 +4333,7 @@
 		glColor4f(0.2f, 0.8f, 0.2f, 0.8f);
 		font-&gt;glFormatAt(0.02f, 0.65f, 1.0f, &quot;Health %.0f / %.0f&quot;, (float)unit-&gt;health, (float)unit-&gt;maxHealth);
 
-		if(gs-&gt;players[gu-&gt;myPlayerNum]-&gt;myControl.mouse2){
+		if(playerHandler-&gt;Player(gu-&gt;myPlayerNum)-&gt;myControl.mouse2){
 			font-&gt;glPrintAt(0.02f, 0.7f, 1.0f, &quot;Free fire mode&quot;);
 		}
 
@@ -4467,15 +4478,16 @@
 		// FIXME: ugh, there should be a better way to figure out number of players ...
 		numPlayers = gameSetup-&gt;numPlayers;
 
-		int numTeams = gs-&gt;activeAllyTeams;
+		// TODO: move this to a method in CTeamHandler
+		// Figure out who won the game.
+		int numTeams = teamHandler-&gt;ActiveAllyTeams();
 		if (gs-&gt;useLuaGaia) {
 			--numTeams;
 		}
-		// Figure out who won the game.
 		int winner = -1;
 		for (int i = 0; i &lt; numTeams; ++i) {
-			if (!gs-&gt;Team(i)-&gt;isDead) {
-				winner = gs-&gt;AllyTeam(i);
+			if (!teamHandler-&gt;Team(i)-&gt;isDead) {
+				winner = teamHandler-&gt;AllyTeam(i);
 				break;
 			}
 		}
@@ -4483,10 +4495,10 @@
 		record-&gt;SetTime(gs-&gt;frameNum / 30, (int)gu-&gt;gameTime);
 		record-&gt;InitializeStats(numPlayers, numTeams, winner);
 		for (int i = 0; i &lt; numPlayers; ++i) {
-			record-&gt;SetPlayerStats(i, *gs-&gt;players[i]-&gt;currentStats);
+			record-&gt;SetPlayerStats(i, *playerHandler-&gt;Player(i)-&gt;currentStats);
 		}
 		for (int i = 0; i &lt; numTeams; ++i) {
-			record-&gt;SetTeamStats(i, gs-&gt;Team(i)-&gt;statHistory);
+			record-&gt;SetTeamStats(i, teamHandler-&gt;Team(i)-&gt;statHistory);
 		}
 	}
 }
@@ -4530,7 +4542,7 @@
 	string s = msg.msg;
 
 	if (!s.empty()) {
-		CPlayer* player = (msg.fromPlayer == SERVER_PLAYER) ? 0 : gs-&gt;players[msg.fromPlayer];
+		CPlayer* player = (msg.fromPlayer == SERVER_PLAYER) ? 0 : playerHandler-&gt;Player(msg.fromPlayer);
 		const bool myMsg = (msg.fromPlayer == gu-&gt;myPlayerNum);
 
 		string label;
@@ -4559,8 +4571,8 @@
 		*/
 
 		if (msg.destination == ChatMessage::TO_ALLIES &amp;&amp; player) {
-			const int msgAllyTeam = gs-&gt;AllyTeam(player-&gt;team);
-			const bool allied = gs-&gt;Ally(msgAllyTeam, gu-&gt;myAllyTeam);
+			const int msgAllyTeam = teamHandler-&gt;AllyTeam(player-&gt;team);
+			const bool allied = teamHandler-&gt;Ally(msgAllyTeam, gu-&gt;myAllyTeam);
 			if (gu-&gt;spectating || (allied &amp;&amp; !player-&gt;spectator)) {
 				logOutput.Print(label + &quot;Allies: &quot; + s);
 				sound-&gt;PlaySample(chatSound, 5);
@@ -4677,13 +4689,18 @@
 		logOutput.Print(&quot;Missing unit name&quot;);
 		return;
 	}
-	const string name = &quot;scripts/&quot; + unitName + &quot;.cob&quot;;
-	const CCobFile* oldScript = GCobEngine.GetScriptAddr(name);
+	const UnitDef* unitDef = unitDefHandler-&gt;GetUnitByName(unitName);
+	if (unitDef == NULL) {
+		logOutput.Print(&quot;Unknown unit name&quot;);
+		return;
+	}
+	const string scriptPath = unitDef-&gt;scriptPath;
+	const CCobFile* oldScript = GCobEngine.GetScriptAddr(scriptPath);
 	if (oldScript == NULL) {
-		logOutput.Print(&quot;Unknown cob script: %s&quot;, name.c_str());
+		logOutput.Print(&quot;Unknown cob script: %s&quot;, scriptPath.c_str());
 		return;
 	}
-	CCobFile* newScript = &amp;GCobEngine.ReloadCobFile(name);
+	CCobFile* newScript = &amp;GCobEngine.ReloadCobFile(scriptPath);
 	int count = 0;
 	for (int i = 0; i &lt; MAX_UNITS; i++) {
 		CUnit* unit = uh-&gt;units[i];
@@ -4725,7 +4742,7 @@
 				continue; // bad pointer
 			}
 			if (!gu-&gt;spectatingFullSelect) {
-				const CUnitSet&amp; teamUnits = gs-&gt;Team(gu-&gt;myTeam)-&gt;units;
+				const CUnitSet&amp; teamUnits = teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;units;
 				if (teamUnits.find(unit) == teamUnits.end()) {
 					continue; // not mine to select
 				}
@@ -4820,7 +4837,7 @@
 void CGame::ReColorTeams()
 {
 	for (int t = 0; t &lt; MAX_TEAMS; t++) {
-		CTeam* team = gs-&gt;Team(t);
+		CTeam* team = teamHandler-&gt;Team(t);
 		team-&gt;origColor[0] = team-&gt;color[0];
 		team-&gt;origColor[1] = team-&gt;color[1];
 		team-&gt;origColor[2] = team-&gt;color[2];
@@ -4849,11 +4866,11 @@
 	luaParser.AddInt(&quot;gameMode&quot;, gs-&gt;gameMode);
 
 	luaParser.GetTable(&quot;teams&quot;);
-	for(int t = 0; t &lt; gs-&gt;activeTeams; ++t) {
+	for(int t = 0; t &lt; teamHandler-&gt;ActiveTeams(); ++t) {
 		luaParser.GetTable(t); {
-			const CTeam* team = gs-&gt;Team(t);
-			const unsigned char* color = gs-&gt;Team(t)-&gt;color;
-			luaParser.AddInt(&quot;allyTeam&quot;, gs-&gt;AllyTeam(t));
+			const CTeam* team = teamHandler-&gt;Team(t);
+			const unsigned char* color = teamHandler-&gt;Team(t)-&gt;color;
+			luaParser.AddInt(&quot;allyTeam&quot;, teamHandler-&gt;AllyTeam(t));
 			luaParser.AddBool(&quot;gaia&quot;,    team-&gt;gaia);
 			luaParser.AddInt(&quot;leader&quot;,   team-&gt;leader);
 			luaParser.AddString(&quot;side&quot;,  team-&gt;side);
@@ -4870,9 +4887,9 @@
 	luaParser.EndTable(); // teams
 
 	luaParser.GetTable(&quot;players&quot;);
-	for(int p = 0; p &lt; gs-&gt;activePlayers; ++p) {
+	for(int p = 0; p &lt; playerHandler-&gt;ActivePlayers(); ++p) {
 		luaParser.GetTable(p); {
-			const CPlayer* player = gs-&gt;players[p];
+			const CPlayer* player = playerHandler-&gt;Player(p);
 			luaParser.AddString(&quot;name&quot;,     player-&gt;name);
 			luaParser.AddInt(&quot;team&quot;,        player-&gt;team);
 			luaParser.AddBool(&quot;active&quot;,     player-&gt;active);
@@ -4891,10 +4908,10 @@
 		logOutput.Print(&quot;teamcolors.lua: root table is not valid\n&quot;);
 	}
 
-	for (int t = 0; t &lt; gs-&gt;activeTeams; ++t) {
+	for (int t = 0; t &lt; teamHandler-&gt;ActiveTeams(); ++t) {
 		LuaTable teamTable = root.SubTable(t);
 		if (teamTable.IsValid()) {
-			unsigned char* color = gs-&gt;Team(t)-&gt;color;
+			unsigned char* color = teamHandler-&gt;Team(t)-&gt;color;
 			color[0] = GetLuaColor(teamTable, 1, color[0]);
 			color[1] = GetLuaColor(teamTable, 2, color[1]);
 			color[2] = GetLuaColor(teamTable, 3, color[2]);

Modified: branches/caiinterface/rts/Game/Game.h
===================================================================
--- branches/caiinterface/rts/Game/Game.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/Game.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -44,7 +44,7 @@
 	bool Update();
 	int KeyReleased(unsigned short k);
 	int KeyPressed(unsigned short k,bool isRepeat);
-	CGame(std::string mapname, std::string modName, CInfoConsole *infoConsole, CLoadSaveHandler *saveFile);
+	CGame(std::string mapname, std::string modName, CLoadSaveHandler *saveFile);
 	void ResizeEvent();
 	virtual ~CGame();
 

Modified: branches/caiinterface/rts/Game/GameController.cpp
===================================================================
--- branches/caiinterface/rts/Game/GameController.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/GameController.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -3,7 +3,7 @@
 #include &quot;mmgr.h&quot;
 
 #include &quot;GameController.h&quot;
-#include &quot;System/Platform/Clipboard.h&quot;
+#include &quot;Platform/Clipboard.h&quot;
 
 
 CGameController::CGameController(void)

Modified: branches/caiinterface/rts/Game/GameHelper.cpp
===================================================================
--- branches/caiinterface/rts/Game/GameHelper.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/GameHelper.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -6,12 +6,12 @@
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;mmgr.h&quot;
 
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 #include &quot;Camera.h&quot;
-#include &quot;Game/GameSetup.h&quot;
+#include &quot;GameSetup.h&quot;
 #include &quot;Game.h&quot;
 #include &quot;GameHelper.h&quot;
-#include &quot;Game/UI/LuaUI.h&quot;
+#include &quot;UI/LuaUI.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Map/MapDamage.h&quot;
@@ -25,8 +25,9 @@
 #include &quot;Sim/Misc/GeometricObjects.h&quot;
 #include &quot;Sim/Misc/LosHandler.h&quot;
 #include &quot;Sim/Misc/QuadField.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Misc/RadarHandler.h&quot;
-#include &quot;Sim/ModInfo.h&quot;
+#include &quot;Sim/Misc/ModInfo.h&quot;
 #include &quot;Sim/Projectiles/ExplosionGenerator.h&quot;
 #include &quot;Sim/Projectiles/Projectile.h&quot;
 #include &quot;Sim/Units/CommandAI/CommandAI.h&quot;
@@ -37,8 +38,8 @@
 #include &quot;Sim/Weapons/Weapon.h&quot;
 #include &quot;Sound.h&quot;
 #include &quot;Sync/SyncTracer.h&quot;
-#include &quot;System/EventHandler.h&quot;
-#include &quot;System/myMath.h&quot;
+#include &quot;EventHandler.h&quot;
+#include &quot;myMath.h&quot;
 
 //////////////////////////////////////////////////////////////////////
 // Construction/Destruction
@@ -331,7 +332,7 @@
 	float groundLen   = ground-&gt;LineGroundCol(start, start + dir * length);
 	float returnLenSq = Square( (groundLen &gt; 0.0f)? groundLen + 200.0f: length );
 
-	hit = 0x0;
+	hit = NULL;
 	CollisionQuery cq;
 
 	GML_RECMUTEX_LOCK(quad); // GuiTraceRay
@@ -382,6 +383,8 @@
 	return ((hit)? math::sqrt(returnLenSq): (math::sqrt(returnLenSq) - 200.0f));
 }
 
+
+#ifdef DIRECT_CONTROL_ALLOWED
 float CGameHelper::TraceRayTeam(const float3&amp; start, const float3&amp; dir, float length, CUnit*&amp; hit, bool useRadar, CUnit* exclude, int allyteam)
 {
 	float groundLength = ground-&gt;LineGroundCol(start, start + dir * length);
@@ -408,7 +411,7 @@
 
 			const CollisionVolume* cv = u-&gt;collisionVolume;
 
-			if (gs-&gt;Ally(u-&gt;allyteam, allyteam) || (u-&gt;losStatus[allyteam] &amp; LOS_INLOS)) {
+			if (teamHandler-&gt;Ally(u-&gt;allyteam, allyteam) || (u-&gt;losStatus[allyteam] &amp; LOS_INLOS)) {
 				float3 dif = (u-&gt;midPos + cv-&gt;GetOffsets()) - start;
 				float closeLength = dif.dot(dir);
 
@@ -447,7 +450,9 @@
 
 	return length;
 }
+#endif
 
+
 void CGameHelper::GenerateTargets(const CWeapon *weapon, CUnit* lastTarget,
                                   std::map&lt;float,CUnit*&gt; &amp;targets)
 {
@@ -467,8 +472,8 @@
 	int tempNum = gs-&gt;tempNum++;
 	std::vector&lt;int&gt;::iterator qi;
 	for (qi = quads.begin(); qi != quads.end(); ++qi) {
-		for (int t = 0; t &lt; gs-&gt;activeAllyTeams; ++t) {
-			if (gs-&gt;Ally(attacker-&gt;allyteam, t)) {
+		for (int t = 0; t &lt; teamHandler-&gt;ActiveAllyTeams(); ++t) {
+			if (teamHandler-&gt;Ally(attacker-&gt;allyteam, t)) {
 				continue;
 			}
 			std::list&lt;CUnit*&gt;::const_iterator ui;
@@ -598,7 +603,7 @@
 		std::list&lt;CUnit*&gt;::const_iterator ui;
 
 		for (ui = quad.units.begin(); ui != quad.units.end(); ++ui) {
-			if ((*ui)-&gt;tempNum != tempNum &amp;&amp; !gs-&gt;Ally(searchAllyteam, (*ui)-&gt;allyteam) &amp;&amp;
+			if ((*ui)-&gt;tempNum != tempNum &amp;&amp; !teamHandler-&gt;Ally(searchAllyteam, (*ui)-&gt;allyteam) &amp;&amp;
 				(((*ui)-&gt;losStatus[searchAllyteam] &amp; (LOS_INLOS | LOS_INRADAR)))) {
 
 				(*ui)-&gt;tempNum = tempNum;
@@ -636,7 +641,7 @@
 				CUnit* unit = *ui;
 
 				if (unit-&gt;tempNum != tempNum &amp;&amp;
-				    !gs-&gt;Ally(searchAllyteam, unit-&gt;allyteam)) {
+				    !teamHandler-&gt;Ally(searchAllyteam, unit-&gt;allyteam)) {
 					unit-&gt;tempNum = tempNum;
 
 					// FIXME: use volumeBoundingRadius?
@@ -666,7 +671,7 @@
 				CUnit* unit = *ui;
 
 				if (unit-&gt;tempNum != tempNum &amp;&amp;
-				    !gs-&gt;Ally(searchAllyteam, unit-&gt;allyteam)) {
+				    !teamHandler-&gt;Ally(searchAllyteam, unit-&gt;allyteam)) {
 					unit-&gt;tempNum = tempNum;
 					const float sqDist = (pos - unit-&gt;midPos).SqLength2D();
 
@@ -696,7 +701,7 @@
 		const CQuadField::Quad&amp; quad = qf-&gt;GetQuad(*qi);
 		std::list&lt;CUnit*&gt;::const_iterator ui;
 		for (ui = quad.units.begin(); ui != quad.units.end(); ++ui) {
-			if((*ui)-&gt;tempNum!=tempNum &amp;&amp; gs-&gt;Ally(searchAllyteam,(*ui)-&gt;allyteam)){
+			if((*ui)-&gt;tempNum!=tempNum &amp;&amp; teamHandler-&gt;Ally(searchAllyteam,(*ui)-&gt;allyteam)){
 				(*ui)-&gt;tempNum=tempNum;
 				float sqDist=(pos-(*ui)-&gt;midPos).SqLength2D();
 				if(sqDist &lt;= closeDist){
@@ -723,7 +728,7 @@
 		const CQuadField::Quad&amp; quad = qf-&gt;GetQuad(*qi);
 		std::list&lt;CUnit*&gt;::const_iterator ui;
 		for (ui = quad.units.begin(); ui != quad.units.end(); ++ui) {
-			if((*ui)-&gt;unitDef-&gt;canfly &amp;&amp; (*ui)-&gt;tempNum!=tempNum &amp;&amp; !gs-&gt;Ally(searchAllyteam,(*ui)-&gt;allyteam) &amp;&amp; !(*ui)-&gt;crashing &amp;&amp; (((*ui)-&gt;losStatus[searchAllyteam] &amp; (LOS_INLOS | LOS_INRADAR)))){
+			if((*ui)-&gt;unitDef-&gt;canfly &amp;&amp; (*ui)-&gt;tempNum!=tempNum &amp;&amp; !teamHandler-&gt;Ally(searchAllyteam,(*ui)-&gt;allyteam) &amp;&amp; !(*ui)-&gt;crashing &amp;&amp; (((*ui)-&gt;losStatus[searchAllyteam] &amp; (LOS_INLOS | LOS_INRADAR)))){
 				(*ui)-&gt;tempNum=tempNum;
 				float sqDist=(pos-(*ui)-&gt;midPos).SqLength2D();
 				if(sqDist &lt;= closeDist){
@@ -753,7 +758,7 @@
 		for (ui = quad.units.begin(); ui != quad.units.end(); ++ui) {
 			CUnit* u = *ui;
 
-			if (u-&gt;tempNum != tempNum &amp;&amp; !gs-&gt;Ally(searchAllyteam, u-&gt;allyteam) &amp;&amp;
+			if (u-&gt;tempNum != tempNum &amp;&amp; !teamHandler-&gt;Ally(searchAllyteam, u-&gt;allyteam) &amp;&amp;
 				((u-&gt;losStatus[searchAllyteam] &amp; (LOS_INLOS | LOS_INRADAR)))) {
 
 				u-&gt;tempNum = tempNum;
@@ -848,7 +853,7 @@
 float3 CGameHelper::GetUnitErrorPos(const CUnit* unit, int allyteam)
 {
 	float3 pos = unit-&gt;midPos;
-	if (gs-&gt;Ally(allyteam,unit-&gt;allyteam) || (unit-&gt;losStatus[allyteam] &amp; LOS_INLOS)) {
+	if (teamHandler-&gt;Ally(allyteam,unit-&gt;allyteam) || (unit-&gt;losStatus[allyteam] &amp; LOS_INLOS)) {
 		// ^ it's one of our own, or it's in LOS, so don't add an error ^
 	} else if ((!gameSetup || gameSetup-&gt;ghostedBuildings) &amp;&amp; (unit-&gt;losStatus[allyteam] &amp; LOS_PREVLOS) &amp;&amp; (unit-&gt;losStatus[allyteam] &amp; LOS_CONTRADAR) &amp;&amp; !unit-&gt;mobility) {
 		// ^ this is a ghosted building, so don't add an error ^
@@ -872,7 +877,7 @@
 		if (exclude) {
 			const int eAllyTeam = exclude-&gt;allyteam;
 			const int uAllyTeam = u-&gt;allyteam;
-			allied = (gs-&gt;Ally(uAllyTeam, eAllyTeam) || gs-&gt;Ally(eAllyTeam, uAllyTeam));
+			allied = (teamHandler-&gt;Ally(uAllyTeam, eAllyTeam) || teamHandler-&gt;Ally(eAllyTeam, uAllyTeam));
 		}
 
 		if (u != exclude &amp;&amp; allied &amp;&amp; !u-&gt;unitDef-&gt;pushResistant &amp;&amp; !u-&gt;usingScriptMoveType) {

Modified: branches/caiinterface/rts/Game/GameServer.cpp
===================================================================
--- branches/caiinterface/rts/Game/GameServer.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/GameServer.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -27,21 +27,20 @@
 
 #include &quot;LogOutput.h&quot;
 #include &quot;GameSetup.h&quot;
-#include &quot;GlobalSynced.h&quot;
 #include &quot;Action.h&quot;
 #include &quot;ChatMessage.h&quot;
 #include &quot;CommandMessage.h&quot;
-#include &quot;System/StdAfx.h&quot;
-#include &quot;System/BaseNetProtocol.h&quot;
-#include &quot;System/Net/UDPListener.h&quot;
-#include &quot;System/Net/Connection.h&quot;
-#include &quot;System/Net/UDPConnection.h&quot;
-#include &quot;System/Net/LocalConnection.h&quot;
-#include &quot;System/Net/UnpackPacket.h&quot;
-#include &quot;System/DemoReader.h&quot;
-#include &quot;System/AutohostInterface.h&quot;
-#include &quot;System/Util.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot; // for syncdebug
+#include &quot;BaseNetProtocol.h&quot;
+#include &quot;PlayerHandler.h&quot;
+#include &quot;Net/UDPListener.h&quot;
+#include &quot;Net/Connection.h&quot;
+#include &quot;Net/UDPConnection.h&quot;
+#include &quot;Net/LocalConnection.h&quot;
+#include &quot;Net/UnpackPacket.h&quot;
+#include &quot;DemoReader.h&quot;
+#include &quot;AutohostInterface.h&quot;
+#include &quot;Util.h&quot;
+#include &quot;GlobalUnsynced.h&quot; // for syncdebug
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;FileSystem/CRC.h&quot;
 #include &quot;Player.h&quot;
@@ -51,7 +50,8 @@
 #ifdef interface
 	#undef interface
 #endif
-#include &quot;Team.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Server/MsgStrings.h&quot;
 
 
@@ -132,10 +132,10 @@
 	noHelperAIs = false;
 	cheating = false;
 	sentGameOverMsg = false;
-	
+
 	if (!onlyLocal)
 		UDPNet.reset(new netcode::UDPListener(settings-&gt;hostport));
-	
+
 	if (settings-&gt;autohostport &gt; 0) {
 		AddAutohostInterface(settings-&gt;autohostport);
 	}
@@ -232,7 +232,7 @@
 		}
 		CommandMessage msg2(&quot;skip end&quot;, SERVER_PLAYER);
 		Broadcast(boost::shared_ptr&lt;const netcode::RawPacket&gt;(msg2.Pack()));
-		
+
 		if (UDPNet)
 			UDPNet-&gt;Update();
 		lastUpdate = SDL_GetTicks();
@@ -476,7 +476,7 @@
 			}
 		}
 	}
-	
+
 	if ((SDL_GetTicks() - serverStartTime) &gt; serverTimeout)
 	{
 		bool hasPlayers = false;
@@ -485,7 +485,7 @@
 			if (players[i])
 				hasPlayers = true;
 		}
-		
+
 		if (!hasPlayers)
 		{
 			Message(NoClientsExit);
@@ -751,7 +751,7 @@
 				for (int a = 0; a &lt; MAX_PLAYERS; ++a)
 					if (players[a] &amp;&amp; players[a]-&gt;team == fromTeam)
 						++numPlayersInTeam;
-							
+
 				switch (action)
 				{
 					case TEAMMSG_GIVEAWAY: {
@@ -885,7 +885,7 @@
 	{
 		boost::shared_ptr&lt;netcode::UDPConnection&gt; prev = UDPNet-&gt;PreviewConnection().lock();
 		boost::shared_ptr&lt;const RawPacket&gt; packet = prev-&gt;GetData();
-		
+
 		if (packet &amp;&amp; packet-&gt;length &gt;= 3 &amp;&amp; packet-&gt;data[0] == NETMSG_ATTEMPTCONNECT)
 		{
 			netcode::UnpackPacket msg(packet, 3);
@@ -921,7 +921,7 @@
 				}
 				continue;
 			}
-			
+
 			boost::shared_ptr&lt;const RawPacket&gt; packet;
 			while (players[a] &amp;&amp; (packet = players[a]-&gt;link-&gt;GetData()))
 			{
@@ -1003,7 +1003,7 @@
 void CGameServer::StartGame()
 {
 	gameStartTime = SDL_GetTicks();
-	
+
 	if (UDPNet)
 		UDPNet-&gt;Listen(false); // don't accept new connections
 
@@ -1014,7 +1014,7 @@
 
 	// make sure initial game speed is within allowed range and sent a new speed if not
 	UserSpeedChange(userSpeedFactor, SERVER_PLAYER);
-	
+
 	if (demoReader) {
 		// the client told us to start a demo
 		// no need to send startpos and startplaying since its in the demo
@@ -1174,22 +1174,22 @@
 #ifndef DEDICATED
 	int numActiveTeams[MAX_TEAMS]; // active teams per ally team
 	memset(numActiveTeams, 0, sizeof(numActiveTeams));
-	for (int a = 0; a &lt; gs-&gt;activeTeams; ++a)
+	for (int a = 0; a &lt; teamHandler-&gt;ActiveTeams(); ++a)
 	{
 		bool hasPlayer = false;
-		for (int b = 0; b &lt; gs-&gt;activePlayers; ++b) {
-			if (gs-&gt;players[b]-&gt;active &amp;&amp; gs-&gt;players[b]-&gt;team == static_cast&lt;int&gt;(a) &amp;&amp; !gs-&gt;players[b]-&gt;spectator) {
+		for (int b = 0; b &lt; playerHandler-&gt;ActivePlayers(); ++b) {
+			if (playerHandler-&gt;Player(b)-&gt;active &amp;&amp; playerHandler-&gt;Player(b)-&gt;team == static_cast&lt;int&gt;(a) &amp;&amp; !playerHandler-&gt;Player(b)-&gt;spectator) {
 				hasPlayer = true;
 			}
 		}
-		if (!SSAIKey_Comparator::IsEmpty(gs-&gt;Team(a)-&gt;skirmishAISpecifier)) // is not empty?
+		if (!SSAIKey_Comparator::IsEmpty(teamHandler-&gt;Team(a)-&gt;skirmishAISpecifier)) // is not empty?
 			hasPlayer = true;
 
-		if (!gs-&gt;Team(a)-&gt;isDead &amp;&amp; !gs-&gt;Team(a)-&gt;gaia &amp;&amp; hasPlayer)
-			++numActiveTeams[gs-&gt;AllyTeam(a)];
+		if (!teamHandler-&gt;Team(a)-&gt;isDead &amp;&amp; !teamHandler-&gt;Team(a)-&gt;gaia &amp;&amp; hasPlayer)
+			++numActiveTeams[teamHandler-&gt;AllyTeam(a)];
 	}
 
-	for (int a = 0; a &lt; gs-&gt;activeAllyTeams; ++a)
+	for (int a = 0; a &lt; teamHandler-&gt;ActiveAllyTeams(); ++a)
 		if (numActiveTeams[a] != 0)
 			++numActiveAllyTeams;
 #else
@@ -1232,7 +1232,7 @@
 #endif
 		CheckSync();
 		int newFrames = 1;
-	
+
 		if(!fixedFrameTime){
 			unsigned currentTick = SDL_GetTicks();
 			unsigned timeElapsed = currentTick - lastTick;
@@ -1251,7 +1251,7 @@
 			newFrames = (timeLeft &gt; 0)? int(streflop::ceil(timeLeft)): 0;
 			timeLeft -= newFrames;
 		}
-	
+
 		bool rec = false;
 #ifndef NO_AVI
 		rec = game &amp;&amp; game-&gt;creatingVideo;
@@ -1259,7 +1259,7 @@
 		bool normalFrame = !isPaused &amp;&amp; !rec;
 		bool videoFrame = !isPaused &amp;&amp; fixedFrameTime;
 		bool singleStep = fixedFrameTime &amp;&amp; !rec;
-	
+
 		if(normalFrame || videoFrame || singleStep){
 			for(int i=0; i &lt; newFrames; ++i){
 				assert(!demoReader);
@@ -1297,10 +1297,10 @@
 			assert(UDPNet);
 			hasData = UDPNet-&gt;HasIncomingData(10); // may block up to 10 ms if there is no data (don't need a lock)
 		}
-		
+
 		if (UDPNet)
 			UDPNet-&gt;Update();
-		
+
 		boost::recursive_mutex::scoped_lock scoped_lock(gameServerMutex);
 		if (hasData)
 			ServerReadNet(); // new data arrived, we may have new packets
@@ -1371,7 +1371,7 @@
 		Message(str(format(&quot;Player %s not found, rejecting connection attempt&quot;) %name));
 		return 0;
 	}
-	
+
 	players[hisNewNumber].reset(new GameParticipant(isLocal)); // give him rights to change speed, kick players etc
 	players[hisNewNumber]-&gt;link = link;
 	if (hisNewNumber &lt; setup-&gt;playerStartingData.size()) {
@@ -1404,7 +1404,7 @@
 				Broadcast(CBaseNetProtocol::Get().SendStartPos(SERVER_PLAYER, a, teams[a]-&gt;readyToStart, teams[a]-&gt;startpos.x, teams[a]-&gt;startpos.y, teams[a]-&gt;startpos.z));
 		}
 	}
-	
+
 	Message(str(format(NewConnection) %name %hisNewNumber %version));
 
 	link-&gt;Flush(true);
@@ -1431,7 +1431,7 @@
 void CGameServer::UserSpeedChange(float newSpeed, int player)
 {
 	newSpeed = std::min(maxUserSpeed, std::max(newSpeed, minUserSpeed));
-	
+
 	if (userSpeedFactor != newSpeed)
 	{
 		if (internalSpeed &gt; newSpeed || internalSpeed == userSpeedFactor) // insta-raise speed when not slowed down

Modified: branches/caiinterface/rts/Game/GameServer.h
===================================================================
--- branches/caiinterface/rts/Game/GameServer.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/GameServer.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -13,8 +13,8 @@
 #include &quot;Console.h&quot;
 #include &quot;GameData.h&quot;
 #include &quot;PlayerBase.h&quot;
-#include &quot;Game/GlobalConstants.h&quot;
-#include &quot;System/UnsyncedRNG.h&quot;
+#include &quot;Sim/Misc/GlobalConstants.h&quot;
+#include &quot;UnsyncedRNG.h&quot;
 #include &quot;SFloat3.h&quot;
 
 class CBaseNetProtocol;

Modified: branches/caiinterface/rts/Game/GameSetup.cpp
===================================================================
--- branches/caiinterface/rts/Game/GameSetup.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/GameSetup.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -13,9 +13,9 @@
 #include &quot;FileSystem/ArchiveScanner.h&quot;
 #include &quot;Map/MapParser.h&quot;
 #include &quot;Rendering/Textures/TAPalette.h&quot;
-#include &quot;System/UnsyncedRNG.h&quot;
-#include &quot;System/Exceptions.h&quot;
-#include &quot;System/Util.h&quot;
+#include &quot;UnsyncedRNG.h&quot;
+#include &quot;Exceptions.h&quot;
+#include &quot;Util.h&quot;
 
 
 using namespace std;
@@ -34,15 +34,14 @@
 
 void LocalSetup::Init(const std::string&amp; setup)
 {
-	TdfParser file;
-	file.LoadBuffer(setup.c_str(), setup.length());
+	TdfParser file(setup.c_str(), setup.length());
 	
 	if(!file.SectionExist(&quot;GAME&quot;))
 		throw content_error(&quot;GAME-section didn't exist in setupscript&quot;);
 
 	// Technical parameters
-	file.GetDef(hostip,     &quot;0&quot;, &quot;GAME\\HostIP&quot;);
-	file.GetDef(hostport,   &quot;0&quot;, &quot;GAME\\HostPort&quot;);
+	file.GetDef(hostip,     &quot;localhost&quot;, &quot;GAME\\HostIP&quot;);
+	file.GetDef(hostport,   &quot;8452&quot;, &quot;GAME\\HostPort&quot;);
 	file.GetDef(sourceport, &quot;0&quot;, &quot;GAME\\SourcePort&quot;);
 	file.GetDef(autohostport, &quot;0&quot;, &quot;GAME\\AutohostPort&quot;);
 	
@@ -64,16 +63,14 @@
 		else
 			throw content_error(&quot;Player doesn't have a name&quot;);
 	}
-	
-	int tmp_isHost;
-	file.GetDef(tmp_isHost,  &quot;-1&quot;, &quot;GAME\\IsHost&quot;);
-	if (tmp_isHost == 1)
-		isHost = true;
-	else if (tmp_isHost == 0)
-		isHost = false;
+
+	int tmp_isHost = 0;
+	if (file.GetValue(tmp_isHost, &quot;GAME\\IsHost&quot;))
+		isHost = static_cast&lt;bool&gt;(tmp_isHost);
 	else
 	{
 		for (int a = 0; a &lt; MAX_PLAYERS; ++a) {
+			// search for the first player not from the demo, if it is ourself, we are the host
 			char section[50];
 			sprintf(section, &quot;GAME\\PLAYER%i&quot;, a);
 			string s(section);
@@ -81,7 +78,7 @@
 			if (!file.SectionExist(s)) {
 				continue;
 			}
-			bool fromdemo;
+			bool fromdemo = false;
 			std::string name;
 			std::map&lt;std::string, std::string&gt; setup = file.GetAllValues(s);
 			std::map&lt;std::string, std::string&gt;::iterator it;
@@ -110,11 +107,6 @@
 {
 }
 
-bool CGameSetup::Init(std::string script)
-{
-	return Init(script.c_str(), script.size());
-}
-
 /**
 @brief Load unit restrictions
 @post restrictedUnits initialized
@@ -161,8 +153,7 @@
  */
 void CGameSetup::LoadStartPositions()
 {
-	TdfParser file;
-	file.LoadBuffer(gameSetupText.c_str(), gameSetupText.length());
+	TdfParser file(gameSetupText.c_str(), gameSetupText.length());
 
 	if (startPosType == StartPos_Random) {
 		// Server syncs these later, so we can use unsynced rng
@@ -256,10 +247,8 @@
 		++i;
 	}
 
-	int playerCount = -1;
-	file.GetDef(playerCount,   &quot;-1&quot;, &quot;GAME\\NumPlayers&quot;);
-
-	if (playerCount == -1 || (int)playerStartingData.size() == playerCount)
+	unsigned playerCount = 0;
+	if (!file.GetValue(playerCount, &quot;GAME\\NumPlayers&quot;) || playerStartingData.size() == playerCount)
 		numPlayers = playerStartingData.size();
 	else
 		throw content_error(&quot;incorrect number of players in GameSetup script&quot;);
@@ -325,10 +314,8 @@
 		++i;
 	}
 
-	int teamCount = -1;
-	file.GetDef(teamCount, &quot;-1&quot;, &quot;GAME\\NumTeams&quot;);
-
-	if (teamCount == -1 || (int)teamStartingData.size() == teamCount)
+	unsigned teamCount = 0;
+	if (!file.GetValue(teamCount, &quot;Game\\NumTeams&quot;) || teamStartingData.size() == teamCount)
 		numTeams = teamStartingData.size();
 	else
 		throw content_error(&quot;incorrect number of teams in GameSetup script&quot;);
@@ -375,10 +362,8 @@
 	}
 
 
-	int allyCount = -1;
-	file.GetDef(allyCount, &quot;-1&quot;, &quot;GAME\\NumAllyTeams&quot;);
-
-	if (allyCount == -1 || (int)allyStartingData.size() == allyCount)
+	unsigned allyCount = 0;
+	if (!file.GetValue(allyCount, &quot;GAME\\NumAllyTeams&quot;) || allyStartingData.size() == allyCount)
 		numAllyTeams = allyStartingData.size();
 	else
 		throw content_error(&quot;incorrect number of teams in GameSetup script&quot;);
@@ -429,14 +414,13 @@
 	}
 }
 
-bool CGameSetup::Init(const char* buf, int size)
+bool CGameSetup::Init(const std::string&amp; buf)
 {
 	// Copy buffer contents
-	gameSetupText.assign(buf,size);
+	gameSetupText = buf;
 
 	// Parse
-	TdfParser file;
-	file.LoadBuffer(buf, size);
+	TdfParser file(buf.c_str(),buf.size());
 
 	if(!file.SectionExist(&quot;GAME&quot;))
 		return false;

Modified: branches/caiinterface/rts/Game/GameSetup.h
===================================================================
--- branches/caiinterface/rts/Game/GameSetup.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/GameSetup.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -6,7 +6,7 @@
 #include &lt;vector&gt;
 
 #include &quot;SFloat3.h&quot;
-#include &quot;GlobalConstants.h&quot;
+#include &quot;Sim/Misc/GlobalConstants.h&quot;
 #include &quot;PlayerBase.h&quot;
 
 class TdfParser;
@@ -34,8 +34,7 @@
 public:
 	CGameSetup();
 	~CGameSetup();
-	bool Init(std::string script);
-	bool Init(const char* buf, int size);
+	bool Init(const std::string&amp; script);
 	void LoadStartPositions();
 	
 	enum StartPosType

Modified: branches/caiinterface/rts/Game/GameVersion.cpp
===================================================================
--- branches/caiinterface/rts/Game/GameVersion.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/GameVersion.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -3,18 +3,31 @@
 	Take special care when moving this file, the Spring buildbot refers to this
 	file to append the version string with the SVN revision number.
 */
-
+#include &quot;StdAfx.h&quot;
 #include &quot;GameVersion.h&quot;
 
 // IMPORTANT NOTE: external systems sed -i this file so DO NOT CHANGE without
 // major thought in advance, and deliberation with bibim and tvo/Tobi!
 
-/** The game version as it's returned by unitsync and Spring on commandline.
-This version string is the one that's used to check sync. */
-const char* const VERSION_STRING = &quot;0.77b5&quot;;
+namespace SpringVersion
+{
+	
+const char* const Major = &quot;0.77&quot;;
+const char* const Minor = &quot;5+&quot;;
+const char* const Patchset = &quot;0&quot;;
+const char* const Additional = &quot;&quot;;
 
-/** The game version as it's printed to infolog, for e.g. stacktrace translator. */
-const char* const VERSION_STRING_DETAILED = &quot;0.77b5&quot;;
+/** Build date and time. */
+const char* const BuildTime = __DATE__ &quot; &quot; __TIME__;
 
-/** Build date and time. */
-const char* const BUILD_DATETIME = __DATE__ &quot; &quot; __TIME__;
+std::string Get()
+{
+	return std::string(Major) + &quot;.&quot; + Minor;
+}
+
+std::string GetFull()
+{
+	return Get() + &quot;.&quot; + Patchset + &quot; (&quot; + Additional + &quot;)&quot;;
+}
+
+}

Modified: branches/caiinterface/rts/Game/GameVersion.h
===================================================================
--- branches/caiinterface/rts/Game/GameVersion.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/GameVersion.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,8 +1,33 @@
 #ifndef GAMEVERSION_H
 #define GAMEVERSION_H
 
-extern const char* const VERSION_STRING;
-extern const char* const VERSION_STRING_DETAILED;
-extern const char* const BUILD_DATETIME;
+#include &lt;string&gt;
 
+namespace SpringVersion
+{
+	/// major revision number (e.g. 0.77)
+	extern const char* const Major;
+	
+	/// minor revision / bugfix which breaks sync between clients
+	extern const char* const Minor;
+	
+	/** @brief bugfix which keeps sync between clients using the same MAJOR.MINOR version
+	
+	Client with same Major.Minor can still play together. Also demos should be compatible between patchsets.
+	*/
+	extern const char* const Patchset;
+	
+	/// additional information (compiler flags, svn revision etc.)
+	extern const char* const Additional;
+	
+	/// time of build
+	extern const char* const BuildTime;
+	
+	/// Major.Minor
+	extern std::string Get();
+	
+	/// Major.Minor.Patchset (Additional)
+	extern std::string GetFull();
+};	
+
 #endif

Deleted: branches/caiinterface/rts/Game/GlobalConstants.h
===================================================================
--- branches/caiinterface/rts/Game/GlobalConstants.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/GlobalConstants.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,62 +0,0 @@
-#ifndef GLOBAL_CONSTANTS_H
-#define GLOBAL_CONSTANTS_H
-
-/**
- * @brief maximum world size
- *
- * Defines the maximum world size as 1000000
- */
-const int MAX_WORLD_SIZE = 1000000;
-
-/**
- * @brief square size
- *
- * Defines the size of 1 square as 8
- */
-const int  SQUARE_SIZE = 8;
-
-/**
- * @brief game speed
- *
- * Defines the game speed as 30
- */
-const int GAME_SPEED = 30;
-
-/**
- * @brief max view range
- *
- * Defines the maximum view range as 8000
- */
-const int MAX_VIEW_RANGE = 8000;
-
-/**
- * @brief max teams
- *
- * Defines the maximum number of teams
- * as 17 (16 real teams, and an extra slot for the GAIA team)
- */
-const int MAX_TEAMS = 17;
-
-/**
- * @brief max players
- *
- * Defines the maximum number of players as 32
- */
-const int MAX_PLAYERS = 32;
-
-/**
- * @brief near plane
- *
- * Defines the near plane as 2.8f
- */
-const float NEAR_PLANE = 2.8f;
-
-/**
- * @brief randint max
- *
- * Defines the maximum random integer as 0x7fff
- */
-const int RANDINT_MAX = 0x7fff;
-
-
-#endif

Deleted: branches/caiinterface/rts/Game/GlobalSynced.cpp
===================================================================
--- branches/caiinterface/rts/Game/GlobalSynced.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/GlobalSynced.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,258 +0,0 @@
-#include &quot;StdAfx.h&quot;
-#include &quot;GlobalSynced.h&quot;
-
-#include &lt;assert.h&gt;
-#include &lt;cstring&gt;
-
-#include &quot;GameSetup.h&quot;
-#include &quot;Team.h&quot;
-#include &quot;Player.h&quot;
-#include &quot;Lua/LuaGaia.h&quot;
-#include &quot;Lua/LuaRules.h&quot;
-#include &quot;Util.h&quot;
-#include &quot;Platform/errorhandler.h&quot;
-#include &quot;ExternalAI/IAILibraryManager.h&quot;
-
-/**
- * @brief global synced
- *
- * Global instance of CGlobalSyncedStuff
- */
-CGlobalSyncedStuff* gs;
-
-
-
-CR_BIND(CGlobalSyncedStuff,);
-
-CR_REG_METADATA(CGlobalSyncedStuff, (
-	CR_MEMBER(randSeed),
-	CR_MEMBER(initRandSeed),
-	CR_MEMBER(frameNum),
-	CR_MEMBER(speedFactor),
-	CR_MEMBER(userSpeedFactor),
-	CR_MEMBER(paused),
-	CR_MEMBER(tempNum),
-	CR_MEMBER(godMode),
-	CR_MEMBER(globalLOS),
-	CR_MEMBER(cheatEnabled),
-	CR_MEMBER(noHelperAIs),
-	CR_MEMBER(editDefsEnabled),
-	CR_MEMBER(useLuaRules),
-	CR_MEMBER(useLuaGaia),
-	CR_MEMBER(gaiaTeamID),
-	CR_MEMBER(gaiaAllyTeamID),
-	CR_MEMBER(gameMode),
-	CR_MEMBER(players),
-	CR_MEMBER(activeTeams),
-	CR_MEMBER(activeAllyTeams),
-	CR_MEMBER(activePlayers),
-	CR_MEMBER(allies),
-	CR_MEMBER(team2allyteam),
-	CR_MEMBER(teams),
-	CR_RESERVED(64)
-));
-
-
-/**
- * Initializes variables in CGlobalSyncedStuff
- */
-CGlobalSyncedStuff::CGlobalSyncedStuff()
-{
-	hmapx = 256;
-	hmapy = 256;
-	randSeed = 18655;
-	initRandSeed = randSeed;
-	frameNum = 0;
-	speedFactor = 1;
-	userSpeedFactor = 1;
-	paused = false;
-	godMode = false;
-	globalLOS = false;
-	cheatEnabled = false;
-	noHelperAIs = false;
-	editDefsEnabled = false;
-	tempNum = 2;
-	gameMode = 0;
-	useLuaGaia = true;
-	gaiaTeamID = -1;
-	gaiaAllyTeamID = -1;
-	useLuaRules = true;
-	
-	for(int a = 0; a &lt; MAX_TEAMS; ++a) {
-		teams[a] = SAFE_NEW CTeam();
-		teams[a]-&gt;teamNum = a;
-		team2allyteam[a] = a;
-	}
-	for(int a = 0; a &lt; MAX_PLAYERS; ++a) {
-		players[a] = SAFE_NEW CPlayer();
-		players[a]-&gt;playerNum = a;
-	}
-
-	for (int a = 0; a &lt; MAX_TEAMS; ++a) {
-		for (int b = 0; b &lt; MAX_TEAMS; ++b) {
-			allies[a][b] = false;
-		}
-		allies[a][a] = true;
-	}
-
-	activeTeams = 2;
-	activeAllyTeams = 2;
-	activePlayers = MAX_PLAYERS;
-}
-
-/**
- * Destroys data inside CGlobalSyncedStuff
- */
-CGlobalSyncedStuff::~CGlobalSyncedStuff()
-{
-	for(int a = 0; a &lt; MAX_TEAMS; a++) {
-		delete teams[a];
-	}
-	for(int a = 0; a &lt; MAX_PLAYERS; a++) {
-		delete players[a];
-	}
-}
-
-void CGlobalSyncedStuff::LoadFromSetup(const CGameSetup* setup)
-{
-	gameMode = setup-&gt;gameMode;
-	noHelperAIs = !!setup-&gt;noHelperAIs;
-
-	useLuaGaia  = CLuaGaia::SetConfigString(setup-&gt;luaGaiaStr);
-	useLuaRules = CLuaRules::SetConfigString(setup-&gt;luaRulesStr);
-
-	activePlayers = setup-&gt;numPlayers;
-	activeTeams = setup-&gt;numTeams;
-	activeAllyTeams = setup-&gt;numAllyTeams;
-	
-	assert(activeTeams &lt;= MAX_TEAMS);
-	assert(activeAllyTeams &lt;= MAX_TEAMS);
-
-	for (int i = 0; i &lt; activePlayers; ++i)
-	{
-		// TODO: refactor
-		*static_cast&lt;PlayerBase*&gt;(players[i]) = setup-&gt;playerStartingData[i];
-	}
-
-	for (int i = 0; i &lt; activeTeams; ++i)
-	{
-		teams[i]-&gt;metal = setup-&gt;startMetal;
-		teams[i]-&gt;metalIncome = setup-&gt;startMetal; // for the endgame statistics
-
-		teams[i]-&gt;energy = setup-&gt;startEnergy;
-		teams[i]-&gt;energyIncome = setup-&gt;startEnergy;
-
-		float3 start(setup-&gt;teamStartingData[i].startPos.x,
-				setup-&gt;teamStartingData[i].startPos.y,
-				setup-&gt;teamStartingData[i].startPos.z);
-		teams[i]-&gt;StartposMessage(start, (setup-&gt;startPosType != CGameSetup::StartPos_ChooseInGame));
-		std::memcpy(teams[i]-&gt;color, setup-&gt;teamStartingData[i].color, 4);
-		teams[i]-&gt;handicap = setup-&gt;teamStartingData[i].handicap;
-		teams[i]-&gt;leader = setup-&gt;teamStartingData[i].leader;
-		teams[i]-&gt;side = setup-&gt;teamStartingData[i].side;
-		SetAllyTeam(i, setup-&gt;teamStartingData[i].teamAllyteam);
-		if (!(setup-&gt;teamStartingData[i].luaAI.empty())) {
-			teams[i]-&gt;luaAI = setup-&gt;teamStartingData[i].luaAI;
-			teams[i]-&gt;isAI = true;
-		} else if (!(setup-&gt;teamStartingData[i].skirmishAIShortName.empty())) {
-			if (setup-&gt;hostDemo) {
-				SSAIKey key = {{NULL, NULL}, {NULL, NULL}};
-				teams[i]-&gt;skirmishAISpecifier = key;
-			} else {
-				const char* sn = setup-&gt;teamStartingData[i].skirmishAIShortName.c_str();
-				const char* v = setup-&gt;teamStartingData[i].skirmishAIVersion.empty()
-						? NULL : setup-&gt;teamStartingData[i].skirmishAIVersion.c_str();
-				SSAISpecifier spec = {sn, v};
-				std::vector&lt;SSAIKey&gt; fittingKeys =
-						IAILibraryManager::GetInstance()-&gt;ResolveSkirmishAIKey(spec);
-				if (fittingKeys.size() &gt; 0) {
-					teams[i]-&gt;skirmishAISpecifier = fittingKeys[0];
-					teams[i]-&gt;skirmishAIOptions = setup-&gt;teamStartingData[i].skirmishAIOptions;
-					teams[i]-&gt;isAI = true;
-				} else {
-					const int MAX_MSG_LENGTH = 511;
-					char s_msg[MAX_MSG_LENGTH + 1];
-					SNPRINTF(s_msg, MAX_MSG_LENGTH,
-							&quot;Specifyed Skirmish AI could not be found: %s (version: %s)&quot;,
-							spec.shortName, spec.version != NULL ? spec.version : &quot;&lt;not specifyed&gt;&quot;);
-					handleerror(NULL, s_msg, &quot;Game Script Error&quot;, MBF_OK | MBF_EXCL);
-				}
-			}
-		}
-	}
-
-	for (int allyTeam1 = 0; allyTeam1 &lt; activeAllyTeams; ++allyTeam1)
-	{
-		for (int allyTeam2 = 0; allyTeam2 &lt; activeAllyTeams; ++allyTeam2)
-			allies[allyTeam1][allyTeam2] = setup-&gt;allyStartingData[allyTeam1].allies[allyTeam2];
-	}
-
-	if (useLuaGaia) {
-		//TODO duplicated in SpringApp::Startup()
-		// Gaia adjustments
-		gaiaTeamID = activeTeams;
-		gaiaAllyTeamID = activeAllyTeams;
-		activeTeams++;
-		activeAllyTeams++;
-
-		// Setup the gaia team
-		CTeam* team = gs-&gt;Team(gs-&gt;gaiaTeamID);
-		team-&gt;color[0] = 255;
-		team-&gt;color[1] = 255;
-		team-&gt;color[2] = 255;
-		team-&gt;color[3] = 255;
-		team-&gt;gaia = true;
-		team-&gt;StartposMessage(float3(0.0, 0.0, 0.0), true);
-		//players[setup-&gt;numPlayers]-&gt;team = gaiaTeamID;
-		SetAllyTeam(gaiaTeamID, gaiaAllyTeamID);
-	}
-}
-
-/**
- * @return synced random integer
- *
- * returns a synced random integer
- */
-int CGlobalSyncedStuff::randInt()
-{
-	randSeed = (randSeed * 214013L + 2531011L);
-	return randSeed &amp; RANDINT_MAX;
-}
-
-/**
- * @return synced random float
- *
- * returns a synced random float
- */
-float CGlobalSyncedStuff::randFloat()
-{
-	randSeed = (randSeed * 214013L + 2531011L);
-	return float(randSeed &amp; RANDINT_MAX)/RANDINT_MAX;
-}
-
-/**
- * @return synced random vector
- *
- * returns a synced random vector
- */
-float3 CGlobalSyncedStuff::randVector()
-{
-	float3 ret;
-	do {
-		ret.x = randFloat()*2-1;
-		ret.y = randFloat()*2-1;
-		ret.z = randFloat()*2-1;
-	} while(ret.SqLength()&gt;1);
-
-	return ret;
-}
-
-int CGlobalSyncedStuff::Player(const std::string&amp; name)
-{
-	for (int i = 0; i &lt; MAX_PLAYERS; ++i) {
-		if (players[i] &amp;&amp; players[i]-&gt;name == name) {
-			return i;
-		}
-	}
-	return -1;
-}

Deleted: branches/caiinterface/rts/Game/GlobalSynced.h
===================================================================
--- branches/caiinterface/rts/Game/GlobalSynced.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/GlobalSynced.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,341 +0,0 @@
-#ifndef GLOBAL_UNSYNCED_H
-#define GLOBAL_UNSYNCED_H
-
-#include &lt;string&gt;
-
-#include &quot;float3.h&quot;
-#include &quot;GlobalConstants.h&quot;
-#include &quot;creg/creg.h&quot;
-
-
-class CGameSetup;
-class CTeam;
-class CPlayer;
-
-/**
- * @brief Global synced stuff
- *
- * Class contains globally accessible
- * stuff that remains synced.
- */
-class CGlobalSyncedStuff
-{
-public:
-	CR_DECLARE(CGlobalSyncedStuff);
-	CGlobalSyncedStuff();  //!&lt; Constructor
-	~CGlobalSyncedStuff(); //!&lt; Destructor
-	void LoadFromSetup(const CGameSetup*);
-
-	int    randInt();    //!&lt; synced random int
-	float  randFloat();  //!&lt; synced random float
-	float3 randVector(); //!&lt; synced random vector
-
-	void SetRandSeed(unsigned int seed, bool init = false) {
-		randSeed = seed;
-		if (init) { initRandSeed = randSeed; }
-	}
-	unsigned int GetRandSeed()     const { return randSeed; }
-	unsigned int GetInitRandSeed() const { return initRandSeed; }
-
-	/**
-	* @brief frame number
-	*
-	* Stores the current frame number
-	*/
-	int frameNum;
-
-	/**
-	* @brief speed factor
-	*
-	* Contains the actual gamespeed used by the game
-	*/
-	float speedFactor;
-
-	/**
-	* @brief user speed factor
-	*
-	* Contains the user's speed factor.
-	* The real gamespeed can be up to this
-	* but is lowered if a computer can't keep up
-	*/
-	float userSpeedFactor;
-
-	/**
-	* @brief paused
-	*
-	* Holds whether the game is paused
-	*/
-	bool paused;
-
-	/**
-	* @brief map x
-	*
-	* The map's number of squares in the x direction
-	* (note that the number of vertices is one more)
-	*/
-	int mapx;
-
-	/**
-	* @brief map y
-	*
-	* The map's number of squares in the y direction
-	*/
-	int mapy;
-
-	/**
-	* @brief map squares
-	*
-	* Total number of squares on the map
-	*/
-	int mapSquares;
-
-	/**
-	* @brief half map x
-	*
-	* Contains half of the number of squares in the x direction
-	*/
-	int hmapx;
-
-	/**
-	* @brief half map y
-	*
-	* Contains half of the number of squares in the y direction
-	*/
-	int hmapy;
-
-	/**
-	* @brief map x power of 2
-	*
-	* Map's size in the x direction rounded
-	* up to the next power of 2
-	*/
-	int pwr2mapx;
-
-	/**
-	* @brief map y power of 2
-	*
-	* Map's size in the y direction rounded
-	* up to the next power of 2
-	*/
-	int pwr2mapy;
-
-	/**
-	* @brief temp num
-	*
-	* Used for getting temporary but unique numbers
-	* (increase after each use)
-	*/
-	int tempNum;
-
-	/**
-	* @brief god mode
-	*
-	* Whether god mode is enabled, allows all players to control all units (even specs)
-	*/
-	bool godMode;
-
-	/**
-	* @brief global line-of-sight
-	*
-	* Whether everything on the map is visible at all times
-	*/
-	bool globalLOS;
-
-	/**
-	* @brief cheat enabled
-	*
-	* Whether cheating is enabled
-	*/
-	bool cheatEnabled;
-
-	/**
-	* @brief disable helper AIs
-	*
-	* Whether helper AIs are allowed, including GroupAI and LuaUI control widgets
-	*/
-	bool noHelperAIs;
-
-	/**
-	* @brief definition editing enabled
-	*
-	* Whether definition editing is enabled
-	*/
-	bool editDefsEnabled;
-
-	/**
-	* @brief LuaRules control
-	*
-	* Whether or not LuaRules is enabled
-	*/
-	bool useLuaRules;
-
-	/**
-	* @brief LuaGaia control
-	*
-	* Whether or not LuaGaia is enabled
-	*/
-	bool useLuaGaia;
-
-	/**
-	* @brief gaia team
-	*
-	* gaia's team id
-	*/
-	int gaiaTeamID;
-
-	/**
-	* @brief gaia team
-	*
-	* gaia's team id
-	*/
-	int gaiaAllyTeamID;
-
-	/**
-	* @brief game mode
-	*
-	* Determines the commander mode of this game
-	*   0: game continues after commander dies
-	*   1: game ends when commander dies
-	*   2: lineage mode (all descendants die when a commander dies)
-	*/
-	int gameMode;
-
-	/**
-	* @brief players
-	*
-	* Array of CPlayer pointers, for all the
-	* players in the game
-	* (size MAX_PLAYERS)
-	*/
-	CPlayer* players[MAX_PLAYERS];
-
-	/**
-	* @brief active teams
-	*
-	* The number of active teams
-	* (don't change during play)
-	*/
-	int activeTeams;
-
-	/**
-	* @brief active ally teams
-	*
-	* The number of active ally teams
-	*/
-	int activeAllyTeams;
-
-	/**
-	* @brief active players
-	*
-	* The number of active players
-	*/
-	int activePlayers;
-
-	/**
-	* @brief Player
-	* @param name name of the player
-	* @return his playernumber of -1 if not found
-	*
-	* Search a player by name.
-	*/
-	int Player(const std::string&amp; name);
-
-	/**
-	* @brief Team
-	* @param i index to fetch
-	* @return CTeam pointer
-	*
-	* Accesses a CTeam pointer at a given index
-	*/
-	CTeam *Team(int i) { return teams[i]; }
-
-	/**
-	* @brief ally
-	* @param a first index
-	* @param b second index
-	* @return allies[a][b]
-	*
-	* Returns ally at [a][b]
-	*/
-	bool Ally(int a,int b) { return allies[a][b]; }
-
-	/**
-	* @brief ally team
-	* @param team team to find
-	* @return the ally team
-	*
-	* returns the team2ally at given index
-	*/
-	int AllyTeam(int team) { return team2allyteam[team]; }
-
-	/**
-	* @brief allied teams
-	* @param a first team
-	* @param b second team
-	* @return whether teams are allied
-	*
-	* Tests whether teams are allied
-	*/
-	bool AlliedTeams(int a,int b) { return allies[team2allyteam[a]][team2allyteam[b]]; }
-
-	/**
-	* @brief set ally team
-	* @param team team to set
-	* @param allyteam allyteam to set
-	*
-	* Sets team's ally team
-	*/
-	void SetAllyTeam(int team, int allyteam) { team2allyteam[team]=allyteam; }
-
-	/**
-	* @brief set ally
-	* @param allyteamA first allyteam
-	* @param allyteamB second allyteam
-	* @param allied whether or not these two teams are allied
-	*
-	* Sets two allyteams to be allied or not
-	*/
-	void SetAlly(int allyteamA,int allyteamB, bool allied) { allies[allyteamA][allyteamB]=allied; }
-
-private:
-	/**
-	* @brief random seed
-	*
-	* Holds the synced random seed
-	*/
-	int randSeed;
-
-	/**
-	* @brief initial random seed
-	*
-	* Holds the synced initial random seed
-	*/
-	int initRandSeed;
-
-	/**
-	* @brief allies array
-	*
-	* Array indicates whether teams are allied,
-	* allies[a][b] means allyteam a is allied with
-	* allyteam b, NOT the other way around
-	*/
-	bool allies[MAX_TEAMS][MAX_TEAMS];
-
-	/**
-	* @brief team to ally team
-	*
-	* Array stores what ally team a specific team is part of
-	*/
-	int team2allyteam[MAX_TEAMS];
-
-	/**
-	* @brief teams
-	*
-	* Array of CTeam pointers for teams in game
-	*/
-	CTeam* teams[MAX_TEAMS];
-};
-
-extern CGlobalSyncedStuff* gs;
-
-#endif //GLOBAL_UNSYNCED_H

Modified: branches/caiinterface/rts/Game/Player.cpp
===================================================================
--- branches/caiinterface/rts/Game/Player.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/Player.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -7,15 +7,17 @@
 #include &quot;mmgr.h&quot;
 
 #include &quot;Player.h&quot;
-#include &quot;Team.h&quot;
-#include &quot;GlobalSynced.h&quot;
+#include &quot;PlayerHandler.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
+#include &quot;ExternalAI/Interface/SAIInterfaceLibrary.h&quot;
 #ifdef DIRECT_CONTROL_ALLOWED
 #  include &quot;UI/MouseHandler.h&quot;
 #  include &quot;CameraHandler.h&quot;
 #  include &quot;Camera.h&quot;
 #endif
-#include &quot;System/EventHandler.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;EventHandler.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 CR_BIND(CPlayer,);
 
@@ -106,11 +108,11 @@
 	}
 
 	// AI teams
-	for (int t = 0; t &lt; gs-&gt;activeTeams; t++) {
-		const CTeam* team = gs-&gt;Team(t);
+	for (int t = 0; t &lt; teamHandler-&gt;ActiveTeams(); t++) {
+		const CTeam* team = teamHandler-&gt;Team(t);
 		if (team &amp;&amp; team-&gt;isAI &amp;&amp;
-		    !SSAIKey_Comparator::IsEmpty(team-&gt;skirmishAISpecifier) &amp;&amp; // is not empty? -&gt; luaAI does not require client control
-		    (team-&gt;leader == playerNum)) {
+			!SSAIKey_Comparator::IsEmpty(team-&gt;skirmishAISpecifier) &amp;&amp; // is not empty? -&gt; luaAI does not require client control
+			(team-&gt;leader == playerNum)) {
 			controlledTeams.insert(t);
 		}
 	}
@@ -119,8 +121,8 @@
 
 void CPlayer::UpdateControlledTeams()
 {
-	for (int p = 0; p &lt; gs-&gt;activePlayers; p++) {
-		CPlayer* player = gs-&gt;players[p];
+	for (int p = 0; p &lt; playerHandler-&gt;ActivePlayers(); p++) {
+		CPlayer* player = playerHandler-&gt;Player(p);
 		if (player) {
 			player-&gt;SetControlledTeams();
 		}
@@ -131,7 +133,7 @@
 void CPlayer::StartSpectating()
 {
 	spectator = true;
-	if (gs-&gt;players[gu-&gt;myPlayerNum] == this) { //TODO bad hack
+	if (playerHandler-&gt;Player(gu-&gt;myPlayerNum) == this) { //TODO bad hack
 		gu-&gt;spectating           = true;
 		gu-&gt;spectatingFullView   = true;
 		gu-&gt;spectatingFullSelect = true;
@@ -145,12 +147,12 @@
 {
 	ENTER_UNSYNCED;
 	if (gu-&gt;directControl == playerControlledUnit) {
-		assert(gs-&gt;players[gu-&gt;myPlayerNum] == this);
+		assert(playerHandler-&gt;Player(gu-&gt;myPlayerNum) == this);
 		gu-&gt;directControl = 0;
 
 		/* Switch back to the camera we were using before. */
 		camHandler-&gt;PopMode();
-		
+
 		if (mouse-&gt;locked &amp;&amp; !mouse-&gt;wasLocked){
 			mouse-&gt;locked = false;
 			mouse-&gt;ShowMouse();

Modified: branches/caiinterface/rts/Game/Player.h
===================================================================
--- branches/caiinterface/rts/Game/Player.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/Player.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -38,7 +38,7 @@
 	CR_DECLARE_SUB(Statistics);
 	CPlayer();
 	~CPlayer();
-	
+
 	std::set&lt;int&gt; controlledTeams;
 	bool CanControlTeam(int teamID) const {
 		return (controlledTeams.find(teamID) != controlledTeams.end());
@@ -84,7 +84,7 @@
 	DirectControlStruct myControl;
 
 	CUnit* playerControlledUnit;
-	
+
 	void StopControllingUnit();
 #endif
 

Copied: branches/caiinterface/rts/Game/PlayerHandler.cpp (from rev 7026, trunk/rts/Game/PlayerHandler.cpp)
===================================================================
--- branches/caiinterface/rts/Game/PlayerHandler.cpp	                        (rev 0)
+++ branches/caiinterface/rts/Game/PlayerHandler.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -0,0 +1,58 @@
+/* Author: Tobi Vollebregt */
+
+/* based on code from GlobalSynced.{cpp,h} */
+
+#include &quot;StdAfx.h&quot;
+#include &quot;PlayerHandler.h&quot;
+#include &quot;Game/GameSetup.h&quot;
+#include &quot;mmgr.h&quot;
+
+CR_BIND(CPlayerHandler,);
+
+CR_REG_METADATA(CPlayerHandler, (
+	CR_MEMBER(players),
+	CR_MEMBER(activePlayers),
+	CR_RESERVED(64)
+));
+
+
+CPlayerHandler* playerHandler;
+
+
+CPlayerHandler::CPlayerHandler()
+{
+	for(int i = 0; i &lt; MAX_PLAYERS; ++i) {
+		players[i].playerNum = i;
+	}
+
+	activePlayers = MAX_PLAYERS;
+}
+
+
+CPlayerHandler::~CPlayerHandler()
+{
+}
+
+
+void CPlayerHandler::LoadFromSetup(const CGameSetup* setup)
+{
+	activePlayers = setup-&gt;numPlayers;
+
+	for (int i = 0; i &lt; activePlayers; ++i)
+	{
+		// TODO: refactor
+		// NOTE: this seems slightly better already then the static_cast
+		Player(i)-&gt;PlayerBase::operator=(setup-&gt;playerStartingData[i]);
+	}
+}
+
+
+int CPlayerHandler::Player(const std::string&amp; name)
+{
+	for (int i = 0; i &lt; MAX_PLAYERS; ++i) {
+		if (Player(i)-&gt;name == name) {
+			return i;
+		}
+	}
+	return -1;
+}

Copied: branches/caiinterface/rts/Game/PlayerHandler.h (from rev 7026, trunk/rts/Game/PlayerHandler.h)
===================================================================
--- branches/caiinterface/rts/Game/PlayerHandler.h	                        (rev 0)
+++ branches/caiinterface/rts/Game/PlayerHandler.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -0,0 +1,65 @@
+/* Author: Tobi Vollebregt */
+
+/* based on code from GlobalSynced.{cpp,h} */
+
+#ifndef PLAYERHANDLER_H
+#define PLAYERHANDLER_H
+
+#include &quot;creg/creg.h&quot;
+#include &quot;Sim/Misc/GlobalConstants.h&quot;
+#include &quot;Player.h&quot;
+
+class CGameSetup;
+
+
+class CPlayerHandler
+{
+public:
+	CR_DECLARE(CPlayerHandler);
+
+	CPlayerHandler();
+	~CPlayerHandler();
+
+	void LoadFromSetup(const CGameSetup* setup);
+
+	/**
+	 * @brief Player
+	 * @param i index to fetch
+	 * @return CPlayer pointer
+	 *
+	 * Accesses a CPlayer instance at a given index
+	 */
+	CPlayer* Player(int i) { return &amp;players[i]; }
+
+	/**
+	 * @brief Player
+	 * @param name name of the player
+	 * @return his playernumber of -1 if not found
+	 *
+	 * Search a player by name.
+	 */
+	int Player(const std::string&amp; name);
+
+	int ActivePlayers() const { return activePlayers; }
+
+private:
+
+	/**
+	 * @brief active players
+	 *
+	 * The number of active players
+	 */
+	int activePlayers;
+
+	/**
+	 * @brief players
+	 *
+	 * Array of CPlayer instances, for all the
+	 * players in the game (size MAX_PLAYERS)
+	 */
+	CPlayer players[MAX_PLAYERS];
+};
+
+extern CPlayerHandler* playerHandler;
+
+#endif // !PLAYERHANDLER_H

Modified: branches/caiinterface/rts/Game/PlayerRoster.cpp
===================================================================
--- branches/caiinterface/rts/Game/PlayerRoster.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/PlayerRoster.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -8,10 +8,10 @@
 #include &lt;assert.h&gt;
 
 #include &quot;PlayerRoster.h&quot;
-#include &quot;Player.h&quot;
-#include &quot;Team.h&quot;
+#include &quot;PlayerHandler.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Util.h&quot;
-#include &quot;GlobalSynced.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
 #include &quot;GlobalUnsynced.h&quot;
 
 static int CompareAllies     (const void* a, const void* b);
@@ -110,20 +110,21 @@
 	static int players[MAX_PLAYERS];
 	static int knownPlayers = 0;
 
-	if (gs-&gt;activePlayers &gt; knownPlayers) {
-		for (int i = 0; i &lt; gs-&gt;activePlayers; i++) {
+	if (playerHandler-&gt;ActivePlayers() &gt; knownPlayers) {
+		for (int i = 0; i &lt; playerHandler-&gt;ActivePlayers(); i++) {
 			players[i] = i;
 		}
-		knownPlayers = gs-&gt;activePlayers;
+		knownPlayers = playerHandler-&gt;ActivePlayers();
 	}
 
-	qsort(players, gs-&gt;activePlayers, sizeof(int), compareFunc);
+	// TODO: use std::sort
+	qsort(players, playerHandler-&gt;ActivePlayers(), sizeof(int), compareFunc);
 
 	if (count != NULL) {
 		// set the count
 		int&amp; c = *count;
-		for (c = 0; c &lt; gs-&gt;activePlayers; c++) {
-			const CPlayer* p = gs-&gt;players[players[c]];
+		for (c = 0; c &lt; playerHandler-&gt;ActivePlayers(); c++) {
+			const CPlayer* p = playerHandler-&gt;Player(players[c]);
 			if ((p == NULL) || !p-&gt;active) {
 				break;
 			}
@@ -157,8 +158,8 @@
 {
 	const int aID = *((const int*)a);
 	const int bID = *((const int*)b);
-	const CPlayer* aP = gs-&gt;players[aID];
-	const CPlayer* bP = gs-&gt;players[bID];
+	const CPlayer* aP = playerHandler-&gt;Player(aID);
+	const CPlayer* bP = playerHandler-&gt;Player(bID);
 
 	const int basic = CompareBasics(aP, bP);
 	if (basic != 0) {
@@ -182,8 +183,8 @@
 	if ((aTeam != myTeam) &amp;&amp; (bTeam == myTeam)) { return +1; }
 
 	// my allies first
-	const int aAlly = gs-&gt;AllyTeam(aTeam);
-	const int bAlly = gs-&gt;AllyTeam(bTeam);
+	const int aAlly = teamHandler-&gt;AllyTeam(aTeam);
+	const int bAlly = teamHandler-&gt;AllyTeam(bTeam);
 	const int myATeam = gu-&gt;myAllyTeam;
 	if ((aAlly == myATeam) &amp;&amp; (bAlly != myATeam)) { return -1; }
 	if ((aAlly != myATeam) &amp;&amp; (bAlly == myATeam)) { return +1; }
@@ -210,8 +211,8 @@
 {
 	const int aID = *((const int*)a);
 	const int bID = *((const int*)b);
-	const CPlayer* aP = gs-&gt;players[aID];
-	const CPlayer* bP = gs-&gt;players[bID];
+	const CPlayer* aP = playerHandler-&gt;Player(aID);
+	const CPlayer* bP = playerHandler-&gt;Player(bID);
 
 	const int basic = CompareBasics(aP, bP);
 	if (basic != 0) {
@@ -236,8 +237,8 @@
 {
 	const int aID = *((const int*)a);
 	const int bID = *((const int*)b);
-	const CPlayer* aP = gs-&gt;players[aID];
-	const CPlayer* bP = gs-&gt;players[bID];
+	const CPlayer* aP = playerHandler-&gt;Player(aID);
+	const CPlayer* bP = playerHandler-&gt;Player(bID);
 
 	const int basic = CompareBasics(aP, bP);
 	if (basic != 0) {
@@ -257,8 +258,8 @@
 {
 	const int aID = *((const int*)a);
 	const int bID = *((const int*)b);
-	const CPlayer* aP = gs-&gt;players[aID];
-	const CPlayer* bP = gs-&gt;players[bID];
+	const CPlayer* aP = playerHandler-&gt;Player(aID);
+	const CPlayer* bP = playerHandler-&gt;Player(bID);
 
 	const int basic = CompareBasics(aP, bP);
 	if (basic != 0) {
@@ -279,8 +280,8 @@
 {
 	const int aID = *((const int*)a);
 	const int bID = *((const int*)b);
-	const CPlayer* aP = gs-&gt;players[aID];
-	const CPlayer* bP = gs-&gt;players[bID];
+	const CPlayer* aP = playerHandler-&gt;Player(aID);
+	const CPlayer* bP = playerHandler-&gt;Player(bID);
 
 	const int basic = CompareBasics(aP, bP);
 	if (basic != 0) {

Modified: branches/caiinterface/rts/Game/PreGame.cpp
===================================================================
--- branches/caiinterface/rts/Game/PreGame.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/PreGame.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -12,17 +12,18 @@
 #include &quot;PreGame.h&quot;
 #include &quot;Game.h&quot;
 #include &quot;GameVersion.h&quot;
-#include &quot;Team.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;FPUCheck.h&quot;
 #include &quot;GameServer.h&quot;
 #include &quot;GameSetup.h&quot;
 #include &quot;GameData.h&quot;
-#include &quot;GlobalSynced.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
 #include &quot;NetProtocol.h&quot;
 #include &quot;Net/RawPacket.h&quot;
 #include &quot;DemoRecorder.h&quot;
 #include &quot;DemoReader.h&quot;
 #include &quot;LoadSaveHandler.h&quot;
+#include &quot;TdfParser.h&quot;
 #include &quot;FileSystem/ArchiveScanner.h&quot;
 #include &quot;FileSystem/FileHandler.h&quot;
 #include &quot;FileSystem/VFSHandler.h&quot;
@@ -31,7 +32,8 @@
 #include &quot;Lua/LuaParser.h&quot;
 #include &quot;Map/MapParser.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
+#include &quot;Rendering/glFont.h&quot;
 #include &quot;Rendering/Textures/TAPalette.h&quot;
 #include &quot;StartScripts/ScriptHandler.h&quot;
 #include &quot;UI/InfoConsole.h&quot;
@@ -50,16 +52,13 @@
 		settings(setup),
 		savefile(NULL)
 {
-	localDemoHack = false;
-	infoConsole = SAFE_NEW CInfoConsole;
-
 	net = SAFE_NEW CNetProtocol();
-
 	activeController=this;
 
 	if(!settings-&gt;isHost)
 	{
-		net-&gt;InitClient(settings-&gt;hostip.c_str(), settings-&gt;hostport, settings-&gt;sourceport, settings-&gt;myPlayerName, std::string(VERSION_STRING_DETAILED));
+		net-&gt;InitClient(settings-&gt;hostip.c_str(), settings-&gt;hostport, settings-&gt;sourceport, settings-&gt;myPlayerName, SpringVersion::GetFull());
+		timer = SDL_GetTicks();
 	}
 	else
 	{
@@ -109,21 +108,34 @@
 bool CPreGame::Draw()
 {
 	SDL_Delay(10); // milliseconds
-	
+	ClearScreen();
+
 	if (!net-&gt;Connected())
 	{
-		if ( ((SDL_GetTicks()/1000) % 2) == 0 )
-			PrintLoadMsg(&quot;Connecting to server .&quot;, false);
+		if (settings-&gt;isHost)
+			font-&gt;glPrintCentered (0.5f,0.48f, 2.0f, &quot;Waiting for server to start&quot;);
 		else
-			PrintLoadMsg(&quot;Connecting to server  &quot;, false);
+		{
+			font-&gt;glPrintCentered (0.5f,0.48f, 2.0f, &quot;Connecting to server (%d s)&quot;, (SDL_GetTicks()-timer)/1000);
+		}
 	}
 	else
 	{
-		PrintLoadMsg(&quot;Awaiting server response&quot;, false);
+		font-&gt;glPrintCentered (0.5f,0.48f, 2.0f, &quot;Waiting for server response&quot;);
 	}
 
-	infoConsole-&gt;Draw();
+	font-&gt;glFormatAt(0.60f,0.40f, 1.0f, &quot;Server: %s:%d&quot;, settings-&gt;hostip.c_str(), settings-&gt;hostport);
+	if (!settings-&gt;isHost)
+		font-&gt;glFormatAt(0.60f,0.35f, 1.0f, &quot;Local endpoint: port %d UDP%s&quot;, settings-&gt;sourceport, (settings-&gt;sourceport == 0) ? &quot; (autoselect)&quot; : &quot;&quot;);
+	else
+		font-&gt;glFormatAt (0.60f,0.35f, 1.0f, &quot;Local endpoint: shared memory&quot;);
 
+	font-&gt;glFormatAt (0.60f,0.30f, 1.0f, &quot;Using playername: %s&quot;, settings-&gt;myPlayerName.c_str());
+
+	// credits
+	font-&gt;glPrintCentered(0.5f,0.06f,1.0f,&quot;Spring %s&quot;, SpringVersion::GetFull().c_str());
+	font-&gt;glPrintCentered(0.5f,0.02f,0.6f,&quot;This program is distributed under the GNU General Public License, see license.html for more info&quot;);
+
 	return true;
 }
 
@@ -147,7 +159,7 @@
 	std::string map = setup-&gt;mapName;
 	std::string mod = setup-&gt;baseMod;
 	std::string script = setup-&gt;scriptName;
-	
+
 	startupData-&gt;SetRandomSeed(static_cast&lt;unsigned&gt;(gu-&gt;usRandInt()));
 	bool mapHasStartscript = false;
 	if (!map.empty())
@@ -178,7 +190,7 @@
 	startupData-&gt;SetScript(script);
 	// here we now the name of the script to use
 
-	try { // to load the script 
+	try { // to load the script
 		CScriptHandler::SelectScript(script);
 		std::string scriptWantedMod;
 		scriptWantedMod = CScriptHandler::Instance().chosenScript-&gt;GetModName();
@@ -195,7 +207,7 @@
 	mod = archiveScanner-&gt;ModArchiveToModName(mod);
 	std::string modArchive = archiveScanner-&gt;ModNameToModArchive(mod);
 	startupData-&gt;SetMod(mod, archiveScanner-&gt;GetModChecksum(modArchive));
-	
+
 	if (!mapHasStartscript) {
 		std::string mapFromScript = CScriptHandler::Instance().chosenScript-&gt;GetMapName();
 		if (!mapFromScript.empty() &amp;&amp; map != mapFromScript) {
@@ -209,7 +221,7 @@
 	good_fpu_control_registers(&quot;before CGameServer creation&quot;);
 	startupData-&gt;SetSetup(setup-&gt;gameSetupText);
 	gameServer = new CGameServer(settings.get(), false, startupData, setup);
-	gameServer-&gt;AddLocalClient(settings-&gt;myPlayerName, std::string(VERSION_STRING_DETAILED));
+	gameServer-&gt;AddLocalClient(settings-&gt;myPlayerName, SpringVersion::GetFull());
 	good_fpu_control_registers(&quot;after CGameServer creation&quot;);
 }
 
@@ -234,14 +246,13 @@
 			}
 			case NETMSG_SETPLAYERNUM: { // this is sent afterwards to let us know which playernum we have
 				gu-&gt;SetMyPlayer(packet-&gt;data[1]);
-				logOutput.Print(&quot;Became player %i&quot;, gu-&gt;myPlayerNum);
-				
-				const int teamID = gs-&gt;players[gu-&gt;myPlayerNum]-&gt;team;
-				const CTeam* team = gs-&gt;Team(teamID);
+				logOutput.Print(&quot;Became player %i (team %i, allyteam %i)&quot;, gu-&gt;myPlayerNum, gu-&gt;myTeam, gu-&gt;myAllyTeam);
+
+				const CTeam* team = teamHandler-&gt;Team(gu-&gt;myTeam);
 				assert(team);
 				LoadStartPicture(team-&gt;side);
 
-				game = SAFE_NEW CGame(gameData-&gt;GetMap(), modArchive, infoConsole, savefile);
+				game = SAFE_NEW CGame(gameData-&gt;GetMap(), modArchive, savefile);
 
 				if (savefile) {
 					savefile-&gt;LoadGame();
@@ -259,7 +270,6 @@
 	}
 }
 
-
 void CPreGame::ReadDataFromDemo(const std::string&amp; demoName)
 {
 	assert(!gameServer);
@@ -272,40 +282,50 @@
 		if (buf-&gt;data[0] == NETMSG_GAMEDATA)
 		{
 			GameData *data = new GameData(boost::shared_ptr&lt;const RawPacket&gt;(buf));
+
+			// modify the startscriptscript so it can be used to watch the demo
+			TdfParser script(data-&gt;GetSetup().c_str(), data-&gt;GetSetup().size());
+			TdfParser::TdfSection* tgame = script.GetRootSection()-&gt;sections[&quot;game&quot;];
+
+			tgame-&gt;AddPair(&quot;ScriptName&quot;, data-&gt;GetScript());
+			tgame-&gt;AddPair(&quot;MapName&quot;, data-&gt;GetMap());
+			tgame-&gt;AddPair(&quot;Gametype&quot;, data-&gt;GetMod());
+
+			tgame-&gt;AddPair(&quot;Demofile&quot;, demoName);
+
+			unsigned numPlayers = 0;
+			for (std::map&lt;std::string, TdfParser::TdfSection*&gt;::iterator it = tgame-&gt;sections.begin(); it != tgame-&gt;sections.end(); ++it) {
+				if (it-&gt;first.substr(0, 6) == &quot;player&quot;)
+				{
+					it-&gt;second-&gt;AddPair(&quot;isfromdemo&quot;, 1);
+					++numPlayers;
+				}
+			}
+
+			// add local spectator (and assert we didn't already have MAX_PLAYERS players)
+			char section[50];
+			sprintf(section, &quot;PLAYER%i&quot;, numPlayers);
+			string s(section);
+			TdfParser::TdfSection* me = tgame-&gt;construct_subsection(s);
+			me-&gt;AddPair(&quot;name&quot;, settings-&gt;myPlayerName);
+			me-&gt;AddPair(&quot;spectator&quot;, 1);
+
+			std::ostringstream buf;
+			script.print(buf);
+			data-&gt;SetSetup(buf.str());
 			CGameSetup* tempSetup = new CGameSetup();
-			if (tempSetup-&gt;Init(data-&gt;GetSetup()))
+
+			if (!tempSetup-&gt;Init(buf.str()))
 			{
-				tempSetup-&gt;scriptName = data-&gt;GetScript();
-				tempSetup-&gt;mapName = data-&gt;GetMap();
-				tempSetup-&gt;baseMod = data-&gt;GetMod();
-				tempSetup-&gt;hostDemo = true;
-				tempSetup-&gt;demoName = demoName;
-				
-				// all players in the setupscript are from demo
-				for (std::vector&lt;PlayerBase&gt;::iterator it = tempSetup-&gt;playerStartingData.begin(); it != tempSetup-&gt;playerStartingData.end(); ++it)
-					it-&gt;isFromDemo = true;
-				
-				// add myself to the script
-				PlayerBase myPlayer;
-				myPlayer.name = settings-&gt;myPlayerName;
-				myPlayer.spectator = true;
-				tempSetup-&gt;playerStartingData.push_back(myPlayer);
-				tempSetup-&gt;numDemoPlayers = std::max(scanner.GetFileHeader().maxPlayerNum+1, tempSetup-&gt;numPlayers);
-				tempSetup-&gt;numPlayers = tempSetup-&gt;numDemoPlayers+1;
-				tempSetup-&gt;maxSpeed = 10;
-				localDemoHack = true;
+				throw content_error(&quot;Demo contains incorrect script&quot;);
 			}
-			else
-			{
-				throw content_error(&quot;Server sent us incorrect script&quot;);
-			}
 			good_fpu_control_registers(&quot;before CGameServer creation&quot;);
 			gameServer = new CGameServer(settings.get(), true, data, tempSetup);
-			gameServer-&gt;AddLocalClient(settings-&gt;myPlayerName, std::string(VERSION_STRING_DETAILED));
+			gameServer-&gt;AddLocalClient(settings-&gt;myPlayerName, SpringVersion::GetFull());
 			good_fpu_control_registers(&quot;after CGameServer creation&quot;);
 			break;
 		}
-		
+
 		if (scanner.ReachedEnd())
 		{
 			throw content_error(&quot;End of demo reached and no game data found&quot;);
@@ -319,7 +339,7 @@
 void CPreGame::LoadMap(const std::string&amp; mapName, const bool forceReload)
 {
 	static bool alreadyLoaded = false;
-	
+
 	if (!alreadyLoaded || forceReload)
 	{
 		CFileHandler* f = SAFE_NEW CFileHandler(&quot;maps/&quot; + mapName);
@@ -343,7 +363,7 @@
 void CPreGame::LoadMod(const std::string&amp; modName)
 {
 	static bool alreadyLoaded = false;
-	
+
 	if (!alreadyLoaded) {
 		// Map all required archives depending on selected mod(s)
 		std::string modArchive = archiveScanner-&gt;ModNameToModArchive(modName);
@@ -364,43 +384,27 @@
 void CPreGame::GameDataReceived(boost::shared_ptr&lt;const netcode::RawPacket&gt; packet)
 {
 	gameData.reset(new GameData(packet));
-	
+
 	CGameSetup* temp = new CGameSetup();
 	if (temp-&gt;Init(gameData-&gt;GetSetup()))
 	{
 		temp-&gt;scriptName = gameData-&gt;GetScript();
 		temp-&gt;mapName = gameData-&gt;GetMap();
 		temp-&gt;baseMod = gameData-&gt;GetMod();
-		
-		if (localDemoHack)
-		{
-			temp-&gt;hostDemo = true;
-				
-				// all players in the setupscript are from demo
-			for (std::vector&lt;PlayerBase&gt;::iterator it = temp-&gt;playerStartingData.begin(); it != temp-&gt;playerStartingData.end(); ++it)
-				it-&gt;isFromDemo = true;
-				
-			// add myself to the script
-			PlayerBase myPlayer;
-			myPlayer.name = settings-&gt;myPlayerName;
-			myPlayer.spectator = true;
-			temp-&gt;playerStartingData.push_back(myPlayer);
-			temp-&gt;numDemoPlayers = temp-&gt;numPlayers;
-			temp-&gt;numPlayers = temp-&gt;numDemoPlayers+1;
-			temp-&gt;maxSpeed = 10;
-		}
+
 		gameSetup = const_cast&lt;const CGameSetup*&gt;(temp);
+		std::cout &lt;&lt; gameSetup &lt;&lt; std::endl;
 		gs-&gt;LoadFromSetup(gameSetup);
 	}
 	else
 	{
 		throw content_error(&quot;Server sent us incorrect script&quot;);
 	}
-	
+
 	gs-&gt;SetRandSeed(gameData-&gt;GetRandomSeed(), true);
 	logOutput &lt;&lt; &quot;Using map &quot; &lt;&lt; gameData-&gt;GetMap() &lt;&lt; &quot;\n&quot;;
 	stupidGlobalMapname = gameData-&gt;GetMap();
-	
+
 	if (net &amp;&amp; net-&gt;GetDemoRecorder()) {
 		net-&gt;GetDemoRecorder()-&gt;SetName(gameData-&gt;GetMap());
 		logOutput &lt;&lt; &quot;Recording demo &quot; &lt;&lt; net-&gt;GetDemoRecorder()-&gt;GetName() &lt;&lt; &quot;\n&quot;;
@@ -410,10 +414,11 @@
 
 	logOutput &lt;&lt; &quot;Using script &quot; &lt;&lt; gameData-&gt;GetScript() &lt;&lt; &quot;\n&quot;;
 	CScriptHandler::SelectScript(gameData-&gt;GetScript());
-	
+
 	logOutput &lt;&lt; &quot;Using mod &quot; &lt;&lt; gameData-&gt;GetMod() &lt;&lt; &quot;\n&quot;;
 	LoadMod(gameData-&gt;GetMod());
 	modArchive = archiveScanner-&gt;ModNameToModArchive(gameData-&gt;GetMod());
+	logOutput &lt;&lt; &quot;Using mod archive &quot; &lt;&lt; modArchive &lt;&lt; &quot;\n&quot;;
 	archiveScanner-&gt;CheckMod(modArchive, gameData-&gt;GetModChecksum());
-	
+
 }

Modified: branches/caiinterface/rts/Game/PreGame.h
===================================================================
--- branches/caiinterface/rts/Game/PreGame.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/PreGame.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -53,8 +53,6 @@
 	/// receive network traffic
 	void UpdateClientNet();
 
-	CInfoConsole* infoConsole;
-
 	/// Load map and dependend archives into archive scanner
 	void LoadMap(const std::string&amp; mapName, const bool forceReload = false);
 	
@@ -73,7 +71,7 @@
 	std::string modArchive;
 	CLoadSaveHandler *savefile;
 	
-	bool localDemoHack;
+	unsigned timer;
 };
 
 extern CPreGame* pregame;

Modified: branches/caiinterface/rts/Game/SelectMenu.cpp
===================================================================
--- branches/caiinterface/rts/Game/SelectMenu.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/SelectMenu.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -12,13 +12,14 @@
 #include &quot;PreGame.h&quot;
 #include &quot;Rendering/glFont.h&quot;
 #include &quot;Rendering/GL/glList.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/Exceptions.h&quot;
-#include &quot;System/FileSystem/ArchiveScanner.h&quot;
-#include &quot;System/FileSystem/FileHandler.h&quot;
-#include &quot;System/FileSystem/VFSHandler.h&quot;
-#include &quot;System/Platform/FileSystem.h&quot;
-#include &quot;System/Platform/ConfigHandler.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;Exceptions.h&quot;
+#include &quot;TdfParser.h&quot;
+#include &quot;FileSystem/ArchiveScanner.h&quot;
+#include &quot;FileSystem/FileHandler.h&quot;
+#include &quot;FileSystem/VFSHandler.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
+#include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;StartScripts/ScriptHandler.h&quot;
 
 using std::string;
@@ -26,89 +27,44 @@
 extern Uint8* keys;
 extern bool globalQuit;
 
-
-class TdfWriter
-{
-public:
-	void PushSection(const std::string&amp; section)
-	{
-		Indent();
-		str &lt;&lt; &quot;[&quot;&lt;&lt;section&lt;&lt;&quot;]\n{\n&quot;;
-		sections.push(section);
-	};
-	void PopSection()
-	{
-		assert(!sections.empty());
-		Indent();
-		str &lt;&lt; &quot;} //&quot;&lt;&lt; sections.top() &lt;&lt; &quot;\n&quot;;
-		sections.pop();
-	};
-	
-	template&lt;typename T&gt;
-	void AddPair(const std::string&amp; key, const T&amp; value)
-	{
-		Indent();
-		str &lt;&lt; key &lt;&lt; &quot;=&quot; &lt;&lt; value &lt;&lt; &quot;;\n&quot;;
-	};
-	
-	std::string Get() const
-	{
-		return str.str();
-	};
-	
-private:
-	void Indent()
-	{
-		for (unsigned i = 0; i &lt; sections.size(); ++i)
-		str &lt;&lt; &quot;    &quot;;
-	};
-
-	std::ostringstream str;
-	std::stack&lt;std::string&gt; sections;
-};
-
 std::string CreateDefaultSetup(const std::string&amp; map, const std::string&amp; mod, const std::string&amp; script, const std::string&amp; playername)
 {
-	TdfWriter setup;
-	setup.PushSection(&quot;GAME&quot;);
-	setup.AddPair(&quot;Mapname&quot;, map);
-	setup.AddPair(&quot;Gametype&quot;, mod);
-	setup.AddPair(&quot;Scriptname&quot;, script);
+	TdfParser::TdfSection setup;
+	TdfParser::TdfSection* game = setup.construct_subsection(&quot;GAME&quot;);
+	game-&gt;add_name_value(&quot;Mapname&quot;, map);
+	game-&gt;add_name_value(&quot;Gametype&quot;, mod);
+	game-&gt;add_name_value(&quot;Scriptname&quot;, script);
 	
-	setup.AddPair(&quot;IsHost&quot;, 1);
-	setup.AddPair(&quot;MyPlayerName&quot;, playername);
+	game-&gt;AddPair(&quot;IsHost&quot;, 1);
+	game-&gt;add_name_value(&quot;MyPlayerName&quot;, playername);
 	
-	setup.AddPair(&quot;NoHelperAIs&quot;, configHandler.GetInt(&quot;NoHelperAIs&quot;, 0));
+	game-&gt;AddPair(&quot;NoHelperAIs&quot;, configHandler.GetInt(&quot;NoHelperAIs&quot;, 0));
 	
-	setup.PushSection(&quot;PLAYER0&quot;);
-	setup.AddPair(&quot;Name&quot;, playername);
-	setup.AddPair(&quot;Team&quot;, 0);
-	setup.PopSection();
+	TdfParser::TdfSection* player0 = game-&gt;construct_subsection(&quot;PLAYER0&quot;);
+	player0-&gt;add_name_value(&quot;Name&quot;, playername);
+	player0-&gt;AddPair(&quot;Team&quot;, 0);
 	
-	setup.PushSection(&quot;PLAYER1&quot;);
-	setup.AddPair(&quot;Name&quot;, &quot;Enemy&quot;);
-	setup.AddPair(&quot;Team&quot;, 1);
-	setup.PopSection();
+	TdfParser::TdfSection* player1 = game-&gt;construct_subsection(&quot;PLAYER1&quot;);
+	player1-&gt;add_name_value(&quot;Name&quot;, &quot;Enemy&quot;);
+	player1-&gt;AddPair(&quot;Team&quot;, 1);
 	
-	setup.PushSection(&quot;TEAM0&quot;);
-	setup.AddPair(&quot;Leader&quot;, 0);
-	setup.AddPair(&quot;AllyTeam&quot;, 0);
-	setup.PopSection();
+	TdfParser::TdfSection* team0 = game-&gt;construct_subsection(&quot;TEAM0&quot;);
+	team0-&gt;AddPair(&quot;Leader&quot;, 0);
+	team0-&gt;AddPair(&quot;AllyTeam&quot;, 0);
 	
-	setup.PushSection(&quot;TEAM1&quot;);
-	setup.AddPair(&quot;AllyTeam&quot;, 1);
-	setup.PopSection();
+	TdfParser::TdfSection* team1 = game-&gt;construct_subsection(&quot;TEAM1&quot;);
+	team1-&gt;AddPair(&quot;AllyTeam&quot;, 1);
 	
-	setup.PushSection(&quot;ALLYTEAM0&quot;);
-	setup.AddPair(&quot;NumAllies&quot;, 0);
-	setup.PopSection();
+	TdfParser::TdfSection* ally0 = game-&gt;construct_subsection(&quot;ALLYTEAM0&quot;);
+	ally0-&gt;AddPair(&quot;NumAllies&quot;, 0);
 	
-	setup.PushSection(&quot;ALLYTEAM1&quot;);
-	setup.AddPair(&quot;NumAllies&quot;, 0);
-	setup.PopSection();
-	setup.PopSection();
+	TdfParser::TdfSection* ally1 = game-&gt;construct_subsection(&quot;ALLYTEAM1&quot;);
+	ally1-&gt;AddPair(&quot;NumAllies&quot;, 0);
 	
-	return setup.Get();
+	std::ostringstream str;
+	setup.print(str);
+	
+	return str.str();
 }
 
 SelectMenu::SelectMenu(bool server) :
@@ -190,7 +146,7 @@
 bool SelectMenu::Draw()
 {
 	SDL_Delay(10); // milliseconds
-	PrintLoadMsg(&quot;&quot;, false); // just clear screen and set up matrices etc.
+	ClearScreen();
 
 	if (userWriting) {
 		const std::string tempstring = userPrompt + userInput;

Modified: branches/caiinterface/rts/Game/SelectMenu.h
===================================================================
--- branches/caiinterface/rts/Game/SelectMenu.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/SelectMenu.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -17,28 +17,28 @@
 {
 public:
 	SelectMenu(bool server);
-	
+
 	bool Draw();
 	int KeyPressed(unsigned short k, bool isRepeat);
 	bool Update();
-	
+
 	void ShowMapList();
 	void ShowScriptList();
 	void ShowModList();
-	
+
 	/// Callback functions for CglList
 	void SelectScript(const std::string&amp; s);
 	void SelectMap(const std::string&amp; s);
 	void SelectMod(const std::string&amp; s);
-	
+
 private:
 	std::string userScript;
 	std::string userMap;
 	std::string userMod;
-	
+
 	bool addressKnown;
 	LocalSetup* mySettings;
 	CglList* showList;
 };
 
-#endif
\ No newline at end of file
+#endif

Modified: branches/caiinterface/rts/Game/SelectedUnits.cpp
===================================================================
--- branches/caiinterface/rts/Game/SelectedUnits.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/SelectedUnits.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -9,8 +9,8 @@
 
 #include &quot;mmgr.h&quot;
 
-#include &quot;Game/Team.h&quot;
-#include &quot;Game/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
 #include &quot;SelectedUnits.h&quot;
 #include &quot;WaitCommandsAI.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
@@ -33,9 +33,9 @@
 #include &quot;Sim/Units/CommandAI/CommandAI.h&quot;
 #include &quot;Sim/Units/CommandAI/LineDrawer.h&quot;
 #include &quot;Sim/Units/UnitTypes/TransportUnit.h&quot;
-#include &quot;System/EventHandler.h&quot;
-#include &quot;System/Platform/ConfigHandler.h&quot;
-#include &quot;Player.h&quot;
+#include &quot;EventHandler.h&quot;
+#include &quot;Platform/ConfigHandler.h&quot;
+#include &quot;PlayerHandler.h&quot;
 #include &quot;Camera.h&quot;
 #include &quot;Sound.h&quot;
 #include &quot;Util.h&quot;
@@ -260,11 +260,11 @@
 	}
 
 	if (fromUser) {		//add some statistics
-		gs-&gt;players[gu-&gt;myPlayerNum]-&gt;currentStats-&gt;numCommands++;
+		playerHandler-&gt;Player(gu-&gt;myPlayerNum)-&gt;currentStats-&gt;numCommands++;
 		if (selectedGroup!=-1) {
-			gs-&gt;players[gu-&gt;myPlayerNum]-&gt;currentStats-&gt;unitCommands+=grouphandlers[gu-&gt;myTeam]-&gt;groups[selectedGroup]-&gt;units.size();
+			playerHandler-&gt;Player(gu-&gt;myPlayerNum)-&gt;currentStats-&gt;unitCommands+=grouphandlers[gu-&gt;myTeam]-&gt;groups[selectedGroup]-&gt;units.size();
 		} else {
-			gs-&gt;players[gu-&gt;myPlayerNum]-&gt;currentStats-&gt;unitCommands+=selectedUnits.size();
+			playerHandler-&gt;Player(gu-&gt;myPlayerNum)-&gt;currentStats-&gt;unitCommands+=selectedUnits.size();
 		}
 	}
 
@@ -324,7 +324,7 @@
 		return;
 	}
 	else if (c.id == CMD_DEATHWAIT) {
-		if (gs-&gt;activeAllyTeams &lt;= 2) {
+		if (teamHandler-&gt;ActiveAllyTeams() &lt;= 2) {
 			waitCommandsAI.AddDeathWait(c);
 		} else {
 			logOutput.Print(&quot;DeathWait can only be used when there are 2 Ally Teams&quot;);
@@ -496,7 +496,7 @@
 		if (!selectedUnits.empty() &amp;&amp;
 				((cmdColors.BuildBoxesOnShift() &amp;&amp; keys[SDLK_LSHIFT]) ||
 				 ((guihandler-&gt;inCommand &gt;= 0) &amp;&amp;
-					(guihandler-&gt;inCommand &lt; guihandler-&gt;commands.size()) &amp;&amp;
+					(guihandler-&gt;inCommand &lt; int(guihandler-&gt;commands.size())) &amp;&amp;
 					(guihandler-&gt;commands[guihandler-&gt;inCommand].id &lt; 0)))) {
 			GML_STDMUTEX_LOCK(cai); // Draw
 			bool myColor = true;
@@ -511,7 +511,7 @@
 					}
 					builder-&gt;DrawQuedBuildingSquares();
 				}
-				else if (gs-&gt;AlliedTeams(builder-&gt;owner-&gt;team, gu-&gt;myTeam)) {
+				else if (teamHandler-&gt;AlliedTeams(builder-&gt;owner-&gt;team, gu-&gt;myTeam)) {
 					if (myColor) {
 						glColor4fv(cmdColors.allyBuildBox);
 						myColor = false;
@@ -564,7 +564,7 @@
 		return;
 	}
 
-	const CPlayer* player = gs-&gt;players[playerID];
+	const CPlayer* player = playerHandler-&gt;Player(playerID);
 	if (player == NULL) {
 		return;
 	}
@@ -573,7 +573,7 @@
 		                playerID, unitid, unit-&gt;team);
 		return;
 	}
-	
+
 	unit-&gt;commandAI-&gt;GiveCommand(c, false);
 }
 
@@ -642,7 +642,7 @@
 }
 
 
-// CALLINFO: 
+// CALLINFO:
 // DrawMapStuff --&gt; CGuiHandler::GetDefaultCommand --&gt; GetDefaultCmd
 // CMouseHandler::DrawCursor --&gt; DrawCentroidCursor --&gt; CGuiHandler::GetDefaultCommand --&gt; GetDefaultCmd
 // LuaUnsyncedRead::GetDefaultCommand --&gt; CGuiHandler::GetDefaultCommand --&gt; GetDefaultCmd
@@ -670,7 +670,7 @@
 	targetUnit = unit;
 	targetFeature = feature;
 	if (targetUnit) {
-		targetIsEnemy = !gs-&gt;Ally(gu-&gt;myAllyTeam, targetUnit-&gt;allyteam);
+		targetIsEnemy = !teamHandler-&gt;Ally(gu-&gt;myAllyTeam, targetUnit-&gt;allyteam);
 	}
 
 	// find the best leader to pick the command
@@ -701,7 +701,7 @@
 		possibleCommandsChanged = true;
 }
 
-// CALLINFO: 
+// CALLINFO:
 // CGame::Draw --&gt; DrawCommands
 // CMiniMap::DrawForReal --&gt; DrawCommands
 void CSelectedUnits::DrawCommands()
@@ -763,8 +763,8 @@
 	} else if (!selectedUnits.empty()) {
 		// show the player name instead of unit name if it has FBI tag showPlayerName
 		if ((*selectedUnits.begin())-&gt;unitDef-&gt;showPlayerName) {
-			if (gs-&gt;Team((*selectedUnits.begin())-&gt;team)-&gt;leader &gt;= 0)
-				s = gs-&gt;players[gs-&gt;Team((*selectedUnits.begin())-&gt;team)-&gt;leader]-&gt;name.c_str();
+			if (teamHandler-&gt;Team((*selectedUnits.begin())-&gt;team)-&gt;leader &gt;= 0)
+				s = playerHandler-&gt;Player(teamHandler-&gt;Team((*selectedUnits.begin())-&gt;team)-&gt;leader)-&gt;name.c_str();
 			else
 				s = &quot;Uncontrolled&quot;;
 		} else {
@@ -906,7 +906,7 @@
 	*packet &lt;&lt; static_cast&lt;unsigned char&gt;(NETMSG_AICOMMANDS)
 	        &lt;&lt; static_cast&lt;unsigned short&gt;(msgLen)
 	        &lt;&lt; static_cast&lt;unsigned char&gt;(gu-&gt;myPlayerNum);
-	
+
 	*packet &lt;&lt; static_cast&lt;unsigned short&gt;(unitIDCount);
 	for (std::vector&lt;int&gt;::const_iterator it = unitIDs.begin(); it != unitIDs.end(); ++it)
 	{

Modified: branches/caiinterface/rts/Game/SelectedUnitsAI.cpp
===================================================================
--- branches/caiinterface/rts/Game/SelectedUnitsAI.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/SelectedUnitsAI.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -13,17 +13,18 @@
 #include &quot;SelectedUnits.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;NetProtocol.h&quot;
-#include &quot;GlobalSynced.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
 #include &quot;GlobalUnsynced.h&quot;
-#include &quot;Player.h&quot;
+#include &quot;PlayerHandler.h&quot;
 #include &quot;WaitCommandsAI.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Sim/Misc/QuadField.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/MoveTypes/MoveType.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
 #include &quot;Sim/Units/CommandAI/CommandAI.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
-//#include &quot;GroundMoveType.h&quot;
+//#include &quot;Sim/MoveTypes/GroundMoveType.h&quot;
 
 const int CMDPARAM_MOVE_X = 0;
 const int CMDPARAM_MOVE_Y = 1;
@@ -514,11 +515,11 @@
 	if ((player &lt; 0) || (player &gt;= MAX_PLAYERS)) {
 		return;
 	}
-	const CPlayer* p = gs-&gt;players[player];
+	const CPlayer* p = playerHandler-&gt;Player(player);
 	if (p == NULL) {
 		return;
 	}
-	const int allyTeam = gs-&gt;AllyTeam(p-&gt;team);
+	const int allyTeam = teamHandler-&gt;AllyTeam(p-&gt;team);
 
 	vector&lt;CUnit*&gt; tmpUnits = qf-&gt;GetUnits(pos, radius);
 
@@ -548,11 +549,11 @@
 	if ((player &lt; 0) || (player &gt;= MAX_PLAYERS)) {
 		return;
 	}
-	const CPlayer* p = gs-&gt;players[player];
+	const CPlayer* p = playerHandler-&gt;Player(player);
 	if (p == NULL) {
 		return;
 	}
-	const int allyTeam = gs-&gt;AllyTeam(p-&gt;team);
+	const int allyTeam = teamHandler-&gt;AllyTeam(p-&gt;team);
 
 	const float3 mins(std::min(pos0.x, pos1.x), 0.0f, std::min(pos0.z, pos1.z));
 	const float3 maxs(std::max(pos0.x, pos1.x), 0.0f, std::max(pos0.z, pos1.z));

Modified: branches/caiinterface/rts/Game/StartScripts/AirScript.cpp
===================================================================
--- branches/caiinterface/rts/Game/StartScripts/AirScript.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/StartScripts/AirScript.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -13,7 +13,7 @@
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Map/Ground.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 
 

Modified: branches/caiinterface/rts/Game/StartScripts/CommanderScript.cpp
===================================================================
--- branches/caiinterface/rts/Game/StartScripts/CommanderScript.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/StartScripts/CommanderScript.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -10,17 +10,17 @@
 #include &quot;ExternalAI/Interface/SAIInterfaceLibrary.h&quot;
 #include &quot;Game/Game.h&quot;
 #include &quot;Game/GameSetup.h&quot;
-#include &quot;Game/Team.h&quot;
 #include &quot;Game/UI/MiniMap.h&quot;
 #include &quot;Game/UI/InfoConsole.h&quot;
 #include &quot;Lua/LuaParser.h&quot;
 #include &quot;Map/MapParser.h&quot;
 #include &quot;Map/ReadMap.h&quot;
-#include &quot;Sim/SideParser.h&quot;
+#include &quot;Sim/Misc/SideParser.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitDefHandler.h&quot;
 #include &quot;Sim/Units/UnitLoader.h&quot;
-#include &quot;System/LogOutput.h&quot;
+#include &quot;LogOutput.h&quot;
 #include &quot;Exceptions.h&quot;
 
 
@@ -42,14 +42,14 @@
 void CCommanderScript::GameStart()
 {
 	// setup the teams
-	for (int a = 0; a &lt; gs-&gt;activeTeams; ++a) {
+	for (int a = 0; a &lt; teamHandler-&gt;ActiveTeams(); ++a) {
 
 		// don't spawn a commander for the gaia team
-		if (gs-&gt;useLuaGaia &amp;&amp; (a == gs-&gt;gaiaTeamID)) {
+		if (gs-&gt;useLuaGaia &amp;&amp; (a == teamHandler-&gt;GaiaTeamID())) {
 			continue;
 		}
 
-		CTeam* team = gs-&gt;Team(a);
+		CTeam* team = teamHandler-&gt;Team(a);
 
 		if (team-&gt;gaia) continue;
 

Modified: branches/caiinterface/rts/Game/StartScripts/CommanderScript2.cpp
===================================================================
--- branches/caiinterface/rts/Game/StartScripts/CommanderScript2.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/StartScripts/CommanderScript2.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -2,13 +2,13 @@
 #include &quot;mmgr.h&quot;
 
 #include &quot;CommanderScript2.h&quot;
-#include &quot;Game/Team.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Lua/LuaParser.h&quot;
 #include &quot;Map/MapParser.h&quot;
 #include &quot;Map/ReadMap.h&quot;
-#include &quot;Sim/SideParser.h&quot;
+#include &quot;Sim/Misc/SideParser.h&quot;
 #include &quot;Sim/Units/UnitLoader.h&quot;
-#include &quot;System/LogOutput.h&quot;
+#include &quot;LogOutput.h&quot;
 #include &quot;Exceptions.h&quot;
 
 
@@ -28,19 +28,19 @@
 
 void CCommanderScript2::GameStart()
 {
-	gs-&gt;Team(0)-&gt;energy=1000;
-	gs-&gt;Team(0)-&gt;energyIncome=1000;	//for the endgame statistics
-	gs-&gt;Team(0)-&gt;energyStorage=1000;
-	gs-&gt;Team(0)-&gt;metal=1000;
-	gs-&gt;Team(0)-&gt;metalIncome=1000;
-	gs-&gt;Team(0)-&gt;metalStorage=1000;
+	teamHandler-&gt;Team(0)-&gt;energy=1000;
+	teamHandler-&gt;Team(0)-&gt;energyIncome=1000;	//for the endgame statistics
+	teamHandler-&gt;Team(0)-&gt;energyStorage=1000;
+	teamHandler-&gt;Team(0)-&gt;metal=1000;
+	teamHandler-&gt;Team(0)-&gt;metalIncome=1000;
+	teamHandler-&gt;Team(0)-&gt;metalStorage=1000;
 
-	gs-&gt;Team(1)-&gt;energy=1000;
-	gs-&gt;Team(1)-&gt;energyIncome=1000;
-	gs-&gt;Team(1)-&gt;energyStorage=1000;
-	gs-&gt;Team(1)-&gt;metal=1000;
-	gs-&gt;Team(1)-&gt;metalIncome=1000;
-	gs-&gt;Team(1)-&gt;metalStorage=1000;
+	teamHandler-&gt;Team(1)-&gt;energy=1000;
+	teamHandler-&gt;Team(1)-&gt;energyIncome=1000;
+	teamHandler-&gt;Team(1)-&gt;energyStorage=1000;
+	teamHandler-&gt;Team(1)-&gt;metal=1000;
+	teamHandler-&gt;Team(1)-&gt;metalIncome=1000;
+	teamHandler-&gt;Team(1)-&gt;metalStorage=1000;
 
 	const std::string startUnit0 = sideParser.GetStartUnit(0, &quot;&quot;);
 	const std::string startUnit1 = sideParser.GetStartUnit(1, startUnit0);

Modified: branches/caiinterface/rts/Game/StartScripts/LoadScript.cpp
===================================================================
--- branches/caiinterface/rts/Game/StartScripts/LoadScript.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/StartScripts/LoadScript.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -7,11 +7,11 @@
 #include &quot;LoadScript.h&quot;
 #include &quot;ExternalAI/GlobalAIHandler.h&quot;
 #include &quot;Game/GameSetup.h&quot;
-#include &quot;Game/Team.h&quot;
+#include &quot;Sim/Misc/Team.h&quot;
 #include &quot;Sim/Units/UnitDefHandler.h&quot;
-#include &quot;System/LoadSaveHandler.h&quot;
-#include &quot;System/FileSystem/FileHandler.h&quot;
-#include &quot;System/Platform/FileSystem.h&quot;
+#include &quot;LoadSaveHandler.h&quot;
+#include &quot;FileSystem/FileHandler.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 
 extern std::string stupidGlobalMapname;
 

Modified: branches/caiinterface/rts/Game/StartScripts/Script.h
===================================================================
--- branches/caiinterface/rts/Game/StartScripts/Script.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/StartScripts/Script.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -4,10 +4,9 @@
 //
 //////////////////////////////////////////////////////////////////////
 
-#include &quot;Object.h&quot;
 #include &lt;string&gt;
 
-class CScript : public CObject  
+class CScript
 {
 public:
 	virtual void SetCamera();

Modified: branches/caiinterface/rts/Game/StartScripts/ScriptHandler.h
===================================================================
--- branches/caiinterface/rts/Game/StartScripts/ScriptHandler.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/StartScripts/ScriptHandler.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -39,7 +39,7 @@
 	CScriptHandler(CScriptHandler const&amp;);
 	CScriptHandler&amp; operator=(CScriptHandler const&amp;);
 	void LoadScripts();
-	virtual ~CScriptHandler();
+	~CScriptHandler();
 };
 
 #endif /* SCRIPTHANDLER_H */

Modified: branches/caiinterface/rts/Game/StartScripts/SkirmishAITestScript.cpp
===================================================================
--- branches/caiinterface/rts/Game/StartScripts/SkirmishAITestScript.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/StartScripts/SkirmishAITestScript.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -3,17 +3,17 @@
 
 #include &lt;algorithm&gt;
 #include &lt;cctype&gt;
-#include &quot;System/StdAfx.h&quot;
+#include &quot;StdAfx.h&quot;
 #include &quot;ExternalAI/EngineOutHandler.h&quot;
-#include &quot;Game/Team.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Lua/LuaParser.h&quot;
 #include &quot;Map/MapParser.h&quot;
 #include &quot;Map/ReadMap.h&quot;
-#include &quot;Sim/SideParser.h&quot;
+#include &quot;Sim/Misc/SideParser.h&quot;
 #include &quot;Sim/Units/UnitDefHandler.h&quot;
 #include &quot;Sim/Units/UnitLoader.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/Platform/FileSystem.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;Game/GameSetup.h&quot;
 #include &quot;mmgr.h&quot;
 #include &quot;Exceptions.h&quot;
@@ -31,10 +31,10 @@
 {
 	// make sure CSelectedUnits::AiOrder()
 	// still works without a setup script
-	gs-&gt;Team(1)-&gt;isAI = true;
-	gs-&gt;Team(1)-&gt;skirmishAISpecifier = key;
-	gs-&gt;Team(1)-&gt;skirmishAIOptions = options;
-	gs-&gt;Team(1)-&gt;leader = 0;
+	teamHandler-&gt;Team(1)-&gt;isAI = true;
+	teamHandler-&gt;Team(1)-&gt;skirmishAISpecifier = key;
+	teamHandler-&gt;Team(1)-&gt;skirmishAIOptions = options;
+	teamHandler-&gt;Team(1)-&gt;leader = 0;
 }
 
 
@@ -44,15 +44,15 @@
 {
 	eoh-&gt;CreateSkirmishAI(1, key, options);
 
-	gs-&gt;Team(0)-&gt;energy        = 1000;
-	gs-&gt;Team(0)-&gt;energyStorage = 1000;
-	gs-&gt;Team(0)-&gt;metal         = 1000;
-	gs-&gt;Team(0)-&gt;metalStorage  = 1000;
+	teamHandler-&gt;Team(0)-&gt;energy        = 1000;
+	teamHandler-&gt;Team(0)-&gt;energyStorage = 1000;
+	teamHandler-&gt;Team(0)-&gt;metal         = 1000;
+	teamHandler-&gt;Team(0)-&gt;metalStorage  = 1000;
 
-	gs-&gt;Team(1)-&gt;energy        = 1000;
-	gs-&gt;Team(1)-&gt;energyStorage = 1000;
-	gs-&gt;Team(1)-&gt;metal         = 1000;
-	gs-&gt;Team(1)-&gt;metalStorage  = 1000;
+	teamHandler-&gt;Team(1)-&gt;energy        = 1000;
+	teamHandler-&gt;Team(1)-&gt;energyStorage = 1000;
+	teamHandler-&gt;Team(1)-&gt;metal         = 1000;
+	teamHandler-&gt;Team(1)-&gt;metalStorage  = 1000;
 
 	const std::string startUnit0 = sideParser.GetStartUnit(0, &quot;&quot;);
 	const std::string startUnit1 = sideParser.GetStartUnit(1, startUnit0);

Modified: branches/caiinterface/rts/Game/StartScripts/SpawnScript.cpp
===================================================================
--- branches/caiinterface/rts/Game/StartScripts/SpawnScript.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/StartScripts/SpawnScript.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -5,18 +5,18 @@
 #include &quot;mmgr.h&quot;
 
 #include &quot;SpawnScript.h&quot;
-#include &quot;Game/Team.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Lua/LuaParser.h&quot;
 #include &quot;Map/MapParser.h&quot;
 #include &quot;Map/ReadMap.h&quot;
-#include &quot;Sim/SideParser.h&quot;
+#include &quot;Sim/Misc/SideParser.h&quot;
 #include &quot;Sim/Units/UnitLoader.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
 #include &quot;Sim/Units/CommandAI/Command.h&quot;
 #include &quot;Sim/Units/CommandAI/CommandAI.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/FileSystem/FileHandler.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;FileSystem/FileHandler.h&quot;
 
 
 extern std::string stupidGlobalMapname;
@@ -101,16 +101,16 @@
 		}
 	}
 
-	if(!myUnits.empty() &amp;&amp; !gs-&gt;Team(1 - curUnit-&gt;team)-&gt;units.empty()) {
+	if(!myUnits.empty() &amp;&amp; !teamHandler-&gt;Team(1 - curUnit-&gt;team)-&gt;units.empty()) {
 		if(uh-&gt;units[curUnit-&gt;id]){
 			if(curUnit-&gt;target&lt;0 || uh-&gt;units[curUnit-&gt;target]==0){
 				// We can't rely on the ordering of units in a std::set&lt;CUnit*&gt;,
 				// because they're sorted on memory address. Hence we must first
 				// build a set of IDs and then pick an unit from that.
 				// This guarantees the script doesn't desync in multiplayer games.
-				int num = gs-&gt;randInt() % gs-&gt;Team(1 - curUnit-&gt;team)-&gt;units.size();
+				int num = gs-&gt;randInt() % teamHandler-&gt;Team(1 - curUnit-&gt;team)-&gt;units.size();
 				std::set&lt;int&gt; unitids;
-				CUnitSet* tu = &amp;gs-&gt;Team(1 - curUnit-&gt;team)-&gt;units;
+				CUnitSet* tu = &amp;teamHandler-&gt;Team(1 - curUnit-&gt;team)-&gt;units;
 				for (CUnitSet::iterator u = tu-&gt;begin(); u != tu-&gt;end(); ++u)
 					unitids.insert((*u)-&gt;id);
 				std::set&lt;int&gt;::iterator ui = unitids.begin();

Modified: branches/caiinterface/rts/Game/StartScripts/TestScript.cpp
===================================================================
--- branches/caiinterface/rts/Game/StartScripts/TestScript.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/StartScripts/TestScript.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -12,7 +12,7 @@
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Sim/Features/FeatureHandler.h&quot;
-#include &quot;Game/Team.h&quot;
+#include &quot;Sim/Misc/Team.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
 

Deleted: branches/caiinterface/rts/Game/Team.cpp
===================================================================
--- branches/caiinterface/rts/Game/Team.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/Team.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,467 +0,0 @@
-// Team.cpp: implementation of the CTeam class.
-//
-//////////////////////////////////////////////////////////////////////
-
-#include &quot;StdAfx.h&quot;
-#include &quot;mmgr.h&quot;
-
-#include &quot;Team.h&quot;
-
-#include &quot;Messages.h&quot;
-#include &quot;GlobalSynced.h&quot;
-#include &quot;LogOutput.h&quot;
-#include &quot;Player.h&quot;
-#include &quot;GlobalUnsynced.h&quot;
-#include &quot;Game/UI/LuaUI.h&quot;
-#include &quot;Lua/LuaRules.h&quot;
-#include &quot;Sim/Units/Unit.h&quot;
-#include &quot;Sim/Units/UnitHandler.h&quot;
-#include &quot;Sim/Units/UnitDef.h&quot;
-#include &quot;ExternalAI/EngineOutHandler.h&quot;
-#include &quot;System/EventHandler.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
-#include &quot;creg/STL_List.h&quot;
-#include &quot;creg/STL_Map.h&quot;
-#include &quot;creg/STL_Set.h&quot;
-#include &quot;NetProtocol.h&quot;
-
-CR_BIND(CTeam,);
-
-CR_REG_METADATA(CTeam, (
-				CR_MEMBER(teamNum),
-				CR_RESERVED(1),
-				CR_MEMBER(isDead),
-				CR_MEMBER(gaia),
-				CR_MEMBER(color),
-				CR_MEMBER(leader),
-				CR_MEMBER(lineageRoot),
-				CR_MEMBER(handicap),
-				CR_MEMBER(side),
-				CR_MEMBER(isAI),
-				CR_MEMBER(luaAI),
-				CR_MEMBER(skirmishAISpecifier),
-				CR_MEMBER(skirmishAIOptions),
-				CR_MEMBER(units),
-				CR_MEMBER(startPos),
-				CR_MEMBER(metal),
-				CR_MEMBER(energy),
-				CR_MEMBER(metalPull),
-				CR_MEMBER(prevMetalPull),
-				CR_MEMBER(metalIncome),
-				CR_MEMBER(prevMetalIncome),
-				CR_MEMBER(metalExpense),
-				CR_MEMBER(prevMetalExpense),
-				CR_MEMBER(metalUpkeep),
-				CR_MEMBER(prevMetalUpkeep),
-				CR_MEMBER(energyPull),
-				CR_MEMBER(prevEnergyPull),
-				CR_MEMBER(energyIncome),
-				CR_MEMBER(prevEnergyIncome),
-				CR_MEMBER(energyExpense),
-				CR_MEMBER(prevEnergyExpense),
-				CR_MEMBER(energyUpkeep),
-				CR_MEMBER(prevEnergyUpkeep),
-				CR_MEMBER(metalStorage),
-				CR_MEMBER(energyStorage),
-				CR_MEMBER(metalShare),
-				CR_MEMBER(energyShare),
-				CR_MEMBER(delayedMetalShare),
-				CR_MEMBER(delayedEnergyShare),
-				CR_MEMBER(metalSent),
-				CR_MEMBER(metalReceived),
-				CR_MEMBER(energySent),
-				CR_MEMBER(energyReceived),
-				CR_MEMBER(currentStats),
-				CR_MEMBER(lastStatSave),
-				CR_MEMBER(numCommanders),
-				CR_MEMBER(statHistory),
-				CR_MEMBER(modParams),
-				CR_MEMBER(modParamsMap),
-				CR_RESERVED(64)
-				));
-
-CR_BIND(CTeam::Statistics,);
-
-CR_REG_METADATA_SUB(CTeam, Statistics, (
-					CR_MEMBER(metalUsed),
-					CR_MEMBER(energyUsed),
-					CR_MEMBER(metalProduced),
-					CR_MEMBER(energyProduced),
-					CR_MEMBER(metalExcess),
-					CR_MEMBER(energyExcess),
-					CR_MEMBER(metalReceived),
-					CR_MEMBER(energyReceived),
-					CR_MEMBER(metalSent),
-					CR_MEMBER(energySent),
-					CR_MEMBER(damageDealt),
-					CR_MEMBER(damageReceived),
-					CR_MEMBER(unitsProduced),
-					CR_MEMBER(unitsDied),
-					CR_MEMBER(unitsReceived),
-					CR_MEMBER(unitsSent),
-					CR_MEMBER(unitsCaptured),
-					CR_MEMBER(unitsOutCaptured),
-					CR_MEMBER(unitsKilled),
-					CR_RESERVED(16)
-					));
-
-//////////////////////////////////////////////////////////////////////
-// Construction/Destruction
-//////////////////////////////////////////////////////////////////////
-
-CTeam::CTeam()
-: gaia(false),
-  metal(200000),
-  energy(900000),
-  metalPull(0),     prevMetalPull(0),
-  metalIncome(0),   prevMetalIncome(0),
-  metalExpense(0),  prevMetalExpense(0),
-  metalUpkeep(0),   prevMetalUpkeep(0),
-  energyPull(0),    prevEnergyPull(0),
-  energyIncome(0),  prevEnergyIncome(0),
-  energyExpense(0), prevEnergyExpense(0),
-  energyUpkeep(0),  prevEnergyUpkeep(0),
-  metalStorage(1000000),
-  energyStorage(1000000),
-  metalShare(0.99f),
-  energyShare(0.95f),
-  delayedMetalShare(0),
-  delayedEnergyShare(0),
-  metalSent(0),
-  metalReceived(0),
-  energySent(0),
-  energyReceived(0),
-  side(&quot;arm&quot;),
-  isAI(false),
-  luaAI(&quot;&quot;),
-//  skirmishAISpecifier(SSAIKey()),
-  startPos(100,100,100),
-  handicap(1),
-  leader(-1),
-  lineageRoot(-1),
-  isDead(false),
-  lastStatSave(0),
-  numCommanders(0)
-{
-	memset(&amp;currentStats,0,sizeof(currentStats));
-	statHistory.push_back(currentStats);
-}
-
-
-CTeam::~CTeam()
-{
-}
-
-
-bool CTeam::UseMetal(float amount)
-{
-	if ((metal - (prevMetalUpkeep * 10)) &gt;= amount) {
-		metal -= amount;
-		metalExpense += amount;
-		return true;
-	}
-	return false;
-}
-
-
-bool CTeam::UseEnergy(float amount)
-{
-	if ((energy - (prevEnergyUpkeep * 10)) &gt;= amount) {
-		energy -= amount;
-		energyExpense += amount;
-		return true;
-	}
-	return false;
-}
-
-
-bool CTeam::UseMetalUpkeep(float amount)
-{
-	if (metal &gt;= amount) {
-		metal -= amount;
-		metalExpense += amount;
-		metalUpkeep += amount;
-		return true;
-	}
-	return false;
-}
-
-
-bool CTeam::UseEnergyUpkeep(float amount)
-{
-	if (energy &gt;= amount) {
-		energy -= amount;
-		energyExpense += amount;
-		energyUpkeep += amount;
-		return true;
-	}
-	return false;
-}
-
-
-void CTeam::AddMetal(float amount, bool hc)
-{
-	if (hc) { amount *= handicap; }
-	metal += amount;
-	metalIncome += amount;
-	if (metal &gt; metalStorage) {
-		delayedMetalShare += metal - metalStorage;
-		metal = metalStorage;
-	}
-}
-
-
-void CTeam::AddEnergy(float amount, bool hc)
-{
-	if (hc) { amount *= handicap; }
-	energy += amount;
-	energyIncome += amount;
-	if (energy &gt; energyStorage) {
-		delayedEnergyShare += energy - energyStorage;
-		energy = energyStorage;
-	}
-}
-
-void CTeam::GiveEverythingTo(const unsigned toTeam)
-{
-	CTeam* target = gs-&gt;Team(toTeam);
-
-	if (!target) {
-		logOutput.Print(&quot;Team %i didn't exists, can't give units&quot;, toTeam);
-		return;
-	}
-
-	if (!luaRules || luaRules-&gt;AllowResourceTransfer(teamNum, toTeam, &quot;m&quot;, metal)) {
-		target-&gt;metal += metal;
-		metal = 0;
-	}
-	if (!luaRules || luaRules-&gt;AllowResourceTransfer(teamNum, toTeam, &quot;e&quot;, energy)) {
-		target-&gt;energy += energy;
-		energy = 0;
-	}
-
-	for (CUnitSet::iterator ui = units.begin(); ui != units.end(); ) {
-		// must pass the normal checks, isDead, unit count restrictions, luaRules, etc...
-		CUnitSet::iterator next = ui; ++next;
-		(*ui)-&gt;ChangeTeam(toTeam, CUnit::ChangeGiven);
-		ui = next;
-	}
-
-	Died();
-}
-
-
-void CTeam::Died()
-{
-	if (leader &gt;= 0) {
-		logOutput.Print(CMessages::Tr(&quot;Team%i(%s) is no more&quot;).c_str(),
-		                teamNum, gs-&gt;players[leader]-&gt;name.c_str());
-	} else {
-		logOutput.Print(CMessages::Tr(&quot;Team%i is no more&quot;).c_str(), teamNum);
-	}
-	isDead = true;
-
-	// this message is not relayed to clients, it's only for the server
-	net-&gt;Send(CBaseNetProtocol::Get().SendTeamDied(gu-&gt;myPlayerNum, teamNum));
-
-	for (int a = 0; a &lt; MAX_PLAYERS; ++a) {
-		if (gs-&gt;players[a]-&gt;active &amp;&amp; (gs-&gt;players[a]-&gt;team == teamNum)) {
-			gs-&gt;players[a]-&gt;StartSpectating();
-		}
-	}
-	if (eoh-&gt;IsSkirmishAI(teamNum)) {
-		eoh-&gt;DestroySkirmishAI(teamNum);
-	}
-
-	CLuaUI::UpdateTeams();
-  CPlayer::UpdateControlledTeams();
-	eventHandler.TeamDied(teamNum);
-}
-
-void CTeam::StartposMessage(const float3&amp; pos, const bool isReady)
-{
-	readyToStart = isReady;
-	startPos = pos;
-}
-
-void CTeam::StartposMessage(const float3&amp; pos)
-{
-	startPos = pos;
-}
-
-/** This has to be called for every team before SlowUpdates start,
-	otherwise values get overwritten. */
-void CTeam::ResetFrameVariables()
-{
-	prevMetalPull     = metalPull;
-	prevMetalIncome   = metalIncome;
-	prevMetalExpense  = metalExpense;
-	prevMetalUpkeep   = metalUpkeep;
-	prevEnergyPull    = energyPull;
-	prevEnergyIncome  = energyIncome;
-	prevEnergyExpense = energyExpense;
-	prevEnergyUpkeep  = energyUpkeep;
-
-	metalPull = 0;
-	metalIncome = 0;
-	metalExpense = 0;
-	metalUpkeep = 0;
-	energyPull = 0;
-	energyIncome = 0;
-	energyExpense = 0;
-	energyUpkeep = 0;
-
-	metalSent = 0;
-	energySent = 0;
-	metalReceived = 0;
-	energyReceived = 0;
-}
-
-void CTeam::SlowUpdate()
-{
-	currentStats.metalProduced  += prevMetalIncome;
-	currentStats.energyProduced += prevEnergyIncome;
-	currentStats.metalUsed  += prevMetalUpkeep + prevMetalExpense;
-	currentStats.energyUsed += prevEnergyUpkeep + prevEnergyExpense;
-
-	float eShare = 0.0f, mShare = 0.0f;
-	for (int a = 0; a &lt; gs-&gt;activeTeams; ++a) {
-		if ((a != teamNum) &amp;&amp; (gs-&gt;AllyTeam(teamNum) == gs-&gt;AllyTeam(a))) {
-			CTeam* team = gs-&gt;Team(a);
-			eShare += std::max(0.0f, (team-&gt;energyStorage * 0.99f) - team-&gt;energy);
-			mShare += std::max(0.0f, (team-&gt;metalStorage  * 0.99f) - team-&gt;metal);
-		}
-	}
-
-	metal += delayedMetalShare;
-	energy += delayedEnergyShare;
-	delayedMetalShare = 0;
-	delayedEnergyShare = 0;
-
-	const float eExcess = std::max(0.0f, energy - (energyStorage * energyShare));
-	const float mExcess = std::max(0.0f, metal  - (metalStorage  * metalShare));
-
-	float de = 0.0f, dm = 0.0f;
-	if (eShare &gt; 0.0f) {
-		de = std::min(1.0f, eExcess/eShare);
-	}
-	if (mShare &gt; 0.0f) {
-		dm = std::min(1.0f, mExcess/mShare);
-	}
-	for (int a = 0; a &lt; gs-&gt;activeTeams; ++a) {
-		if ((a != teamNum) &amp;&amp; (gs-&gt;AllyTeam(teamNum) == gs-&gt;AllyTeam(a))) {
-			CTeam* team = gs-&gt;Team(a);
-
-			const float edif = std::max(0.0f, (team-&gt;energyStorage * 0.99f) - team-&gt;energy) * de;
-			energy -= edif;
-			energySent += edif;
-			currentStats.energySent += edif;
-			team-&gt;energy += edif;
-			team-&gt;energyReceived += edif;
-			team-&gt;currentStats.energyReceived += edif;
-
-			const float mdif = std::max(0.0f, (team-&gt;metalStorage * 0.99f) - team-&gt;metal) * dm;
-			metal -= mdif;
-			metalSent += mdif;
-			currentStats.metalSent += mdif;
-			team-&gt;metal += mdif;
-			team-&gt;metalReceived += mdif;
-			team-&gt;currentStats.metalReceived += mdif;
-		}
-	}
-
-	if (metal &gt; metalStorage) {
-		currentStats.metalExcess += (metal - metalStorage);
-		metal = metalStorage;
-	}
-	if (energy &gt; energyStorage) {
-		currentStats.energyExcess += (energy - energyStorage);
-		energy = energyStorage;
-	}
-
-	const int statsFrames = (statsPeriod * GAME_SPEED);
-	if ((lastStatSave + statsFrames) &lt; gs-&gt;frameNum) {
-		lastStatSave += statsFrames;
-		statHistory.push_back(currentStats);
-	}
-
-	/* Kill the player on 'com dies = game ends' games.  This can't be done in
-	CTeam::CommanderDied anymore, because that function is called in
-	CUnit::ChangeTeam(), hence it'd cause a random amount of the shared units
-	to be killed if the commander is among them. Also, &quot;.take&quot; would kill all
-	units once it transfered the commander. */
-	if (gs-&gt;gameMode==1 &amp;&amp; numCommanders&lt;=0 &amp;&amp; !gaia){
-		for(std::list&lt;CUnit*&gt;::iterator ui=uh-&gt;activeUnits.begin();ui!=uh-&gt;activeUnits.end();++ui){
-			if ((*ui)-&gt;team==teamNum &amp;&amp; !(*ui)-&gt;unitDef-&gt;isCommander)
-				(*ui)-&gt;KillUnit(true,false,0);
-		}
-		// Set to 1 to prevent above loop from being done every update.
-		numCommanders = 1;
-	}
-}
-
-
-void CTeam::AddUnit(CUnit* unit,AddType type)
-{
-	units.insert(unit);
-	switch (type) {
-		case AddBuilt: {
-			currentStats.unitsProduced++;
-			break;
-		}
-		case AddGiven: {
-			currentStats.unitsReceived++;
-			break;
-		}
-		case AddCaptured: {
-			currentStats.unitsCaptured++;
-			break;
-		}
-	}
-	if (unit-&gt;unitDef-&gt;isCommander) {
-		numCommanders++;
-	}
-}
-
-
-void CTeam::RemoveUnit(CUnit* unit,RemoveType type)
-{
-	units.erase(unit);
-	switch (type) {
-		case RemoveDied: {
-			currentStats.unitsDied++;
-			break;
-		}
-		case RemoveGiven: {
-			currentStats.unitsSent++;
-			break;
-		}
-		case RemoveCaptured: {
-			currentStats.unitsOutCaptured++;
-			break;
-		}
-	}
-
-	if (units.empty() &amp;&amp; !gaia) {
-		Died();
-	}
-}
-
-
-void CTeam::CommanderDied(CUnit* commander)
-{
-	assert(commander-&gt;unitDef-&gt;isCommander);
-	--numCommanders;
-}
-
-
-void CTeam::LeftLineage(CUnit* unit)
-{
-	if (gs-&gt;gameMode == 2 &amp;&amp; unit-&gt;id == this-&gt;lineageRoot) {
-		for (std::list&lt;CUnit*&gt;::iterator ui = uh-&gt;activeUnits.begin(); ui != uh-&gt;activeUnits.end(); ++ui) {
-			if ((*ui)-&gt;lineage == this-&gt;teamNum)
-				(*ui)-&gt;KillUnit(true, false, 0);
-		}
-	}
-}
-

Deleted: branches/caiinterface/rts/Game/Team.h
===================================================================
--- branches/caiinterface/rts/Game/Team.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/Team.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,162 +0,0 @@
-#ifndef TEAM_H
-#define TEAM_H
-// Team.h: interface for the CTeam class.
-//
-//////////////////////////////////////////////////////////////////////
-
-#include &lt;string&gt;
-#include &lt;vector&gt;
-#include &lt;map&gt;
-#include &lt;list&gt;
-#include &quot;Platform/byteorder.h&quot;
-#include &quot;Sim/Units/UnitSet.h&quot;
-#include &quot;ExternalAI/Interface/SAIInterfaceLibrary.h&quot;
-
-class CTeam
-{
-public:
-	CR_DECLARE(CTeam);
-	CR_DECLARE_SUB(Statistics);
-	CTeam();
-	~CTeam();
-	void ResetFrameVariables();
-	void SlowUpdate();
-
-
-	void AddMetal(float amount, bool handicap = true);
-	void AddEnergy(float amount, bool handicap = true);
-	bool UseEnergy(float amount);
-	bool UseMetal(float amount);
-	bool UseEnergyUpkeep(float amount);
-	bool UseMetalUpkeep(float amount);
-
-	void SetBaseMetalStorage(float storage) {metalStorage = storage;};
-	void SetBaseEnergyStorage(float storage) {energyStorage = storage;};
-
-	void GiveEverythingTo(const unsigned toTeam);
-
-	void Died();
-
-	void StartposMessage(const float3&amp; pos, const bool isReady);
-	void StartposMessage(const float3&amp; pos);
-
-	inline bool IsReadyToStart() const {return readyToStart;};
-	enum AddType{
-		AddBuilt,
-		AddCaptured,
-		AddGiven
-	};
-
-	enum RemoveType{
-		RemoveDied,
-		RemoveCaptured,
-		RemoveGiven
-	};
-
-	void AddUnit(CUnit* unit,AddType type);
-	void RemoveUnit(CUnit* unit,RemoveType type);
-
-	int teamNum;
-	bool isDead;
-	bool gaia;
-	int leader;
-	int lineageRoot;
-
-	float handicap;
-	std::string side;
-
-	bool isAI;
-	std::string luaAI;
-	SSAIKey skirmishAISpecifier;
-	std::map&lt;std::string, std::string&gt; skirmishAIOptions;
-
-	// color info is unsynced
-	unsigned char color[4];
-	unsigned char origColor[4];
-
-	CUnitSet units;
-
-	float3 startPos;
-
-	SyncedFloat metal;
-	SyncedFloat energy;
-
-	float metalPull,    prevMetalPull;
-	float metalIncome,  prevMetalIncome;
-	float metalExpense, prevMetalExpense;
-	float metalUpkeep,  prevMetalUpkeep;
-
-	float energyPull,    prevEnergyPull;
-	float energyIncome,  prevEnergyIncome;
-	float energyExpense, prevEnergyExpense;
-	float energyUpkeep,  prevEnergyUpkeep;
-
-	SyncedFloat metalStorage, energyStorage;
-
-	float metalShare, energyShare;
-	SyncedFloat delayedMetalShare, delayedEnergyShare; //excess that might be shared next SlowUpdate
-
-	float metalSent;
-	float metalReceived;
-	float energySent;
-	float energyReceived;
-
-
-	struct Statistics {
-		CR_DECLARE_STRUCT(Statistics);
-		float metalUsed,     energyUsed;
-		float metalProduced, energyProduced;
-		float metalExcess,   energyExcess;
-		float metalReceived, energyReceived; //received from allies
-		float metalSent,     energySent;     //sent to allies
-
-		float damageDealt,   damageReceived; // Damage taken and dealt to enemy units
-
-		int unitsProduced;
-		int unitsDied;
-		int unitsReceived;
-		int unitsSent;
-		int unitsCaptured;				//units captured from enemy by us
-		int unitsOutCaptured;			//units captured from us by enemy
-		int unitsKilled;	//how many enemy units have been killed by this teams units
-
-		/// Change structure from host endian to little endian or vice versa.
-		void swab() {
-			metalUsed        = swabfloat(metalUsed);
-			energyUsed       = swabfloat(energyUsed);
-			metalProduced    = swabfloat(metalProduced);
-			energyProduced   = swabfloat(energyProduced);
-			metalExcess      = swabfloat(metalExcess);
-			energyExcess     = swabfloat(energyExcess);
-			metalReceived    = swabfloat(metalReceived);
-			energyReceived   = swabfloat(energyReceived);
-			metalSent        = swabfloat(metalSent);
-			energySent       = swabfloat(energySent);
-			damageDealt      = swabfloat(damageDealt);
-			damageReceived   = swabfloat(damageReceived);
-			unitsProduced    = swabdword(unitsProduced);
-			unitsDied        = swabdword(unitsDied);
-			unitsReceived    = swabdword(unitsReceived);
-			unitsSent        = swabdword(unitsSent);
-			unitsCaptured    = swabdword(unitsCaptured);
-			unitsOutCaptured = swabdword(unitsOutCaptured);
-			unitsKilled      = swabdword(unitsKilled);
-		}
-	};
-	Statistics currentStats;
-	static const int statsPeriod = 15; // every 15th second
-
-	int lastStatSave;
-	int numCommanders;		//number of units with commander tag in team, if it reaches zero with cmd ends the team dies
-	std::list&lt;Statistics&gt; statHistory;
-	void CommanderDied(CUnit* commander);
-	void LeftLineage(CUnit* unit);
-
-	std::vector&lt;float&gt;         modParams;    // mod controlled parameters
-	std::map&lt;std::string, int&gt; modParamsMap; // name map for mod parameters
-
-private:
-	bool readyToStart;
-};
-
-#endif /* TEAM_H */

Modified: branches/caiinterface/rts/Game/UI/CommandColors.cpp
===================================================================
--- branches/caiinterface/rts/Game/UI/CommandColors.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/UI/CommandColors.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -12,9 +12,9 @@
 #include &quot;mmgr.h&quot;
 
 #include &quot;Rendering/GL/myGL.h&quot;
-#include &quot;System/FileSystem/FileHandler.h&quot;
-#include &quot;System/FileSystem/SimpleParser.h&quot;
-#include &quot;System/Util.h&quot;
+#include &quot;FileSystem/FileHandler.h&quot;
+#include &quot;FileSystem/SimpleParser.h&quot;
+#include &quot;Util.h&quot;
 
 using namespace std;
 

Modified: branches/caiinterface/rts/Game/UI/EndGameBox.cpp
===================================================================
--- branches/caiinterface/rts/Game/UI/EndGameBox.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/UI/EndGameBox.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -5,17 +5,16 @@
 #include &quot;EndGameBox.h&quot;
 #include &quot;MouseHandler.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
-#include &quot;Game/Team.h&quot;
-#include &quot;Game/Player.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
+#include &quot;Game/PlayerHandler.h&quot;
 #include &quot;Rendering/glFont.h&quot;
 #include &quot;NetProtocol.h&quot;
 #include &quot;Game/Game.h&quot;
-#include &quot;Game/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
-#include &quot;Rendering/Textures/Bitmap.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;LogOutput.h&quot;
-#include &quot;System/Exceptions.h&quot;
+#include &quot;Exceptions.h&quot;
 
 
 extern bool globalQuit;
@@ -73,22 +72,21 @@
 	stat1=1;
 	stat2=-1;
 
-	CBitmap bm;
 	if (!bm.Load(&quot;bitmaps/graphPaper.bmp&quot;))
 		throw content_error(&quot;Could not load bitmaps/graphPaper.bmp&quot;);
-	graphTex=bm.CreateTexture();
+	graphTex=0;
 }
 
 CEndGameBox::~CEndGameBox(void)
 {
-	glDeleteTextures(1,&amp;graphTex);
+	if(graphTex)
+		glDeleteTextures(1,&amp;graphTex);
 }
 
 bool CEndGameBox::MousePress(int x, int y, int button)
 {
-	if (disabled) {
+	if (disabled)
 		return false;
-	}
 
 	float mx=MouseX(x);
 	float my=MouseY(y);
@@ -111,9 +109,8 @@
 
 void CEndGameBox::MouseMove(int x, int y, int dx,int dy, int button)
 {
-	if (disabled) {
+	if (disabled)
 		return;
-	}
 
 	if(moveBox){
 		box.x1+=MouseMoveX(dx);
@@ -164,9 +161,8 @@
 
 bool CEndGameBox::IsAbove(int x, int y)
 {
-	if (disabled) {
+	if (disabled)
 		return false;
-	}
 
 	float mx=MouseX(x);
 	float my=MouseY(y);
@@ -177,9 +173,11 @@
 
 void CEndGameBox::Draw()
 {
-	if (disabled) {
+	if(!graphTex)
+		graphTex=bm.CreateTexture();
+
+	if (disabled)
 		return;
-	}
 
 	float mx=MouseX(mouse-&gt;lastx);
 	float my=MouseY(mouse-&gt;lasty);
@@ -225,7 +223,7 @@
 	font-&gt;glPrintAt(box.x1+sumBox.x1+0.015f,box.y1+sumBox.y1+0.005f,0.7f,&quot;Team stats&quot;);
 	font-&gt;glPrintAt(box.x1+difBox.x1+0.015f,box.y1+difBox.y1+0.005f,0.7f,&quot;Team delta stats&quot;);
 
-	if(gs-&gt;Team(gu-&gt;myTeam)-&gt;isDead){
+	if(teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;isDead){
 		font-&gt;glPrintAt(box.x1+0.25f,box.y1+0.65f,1,&quot;You lost the game&quot;);
 	} else {
 		font-&gt;glPrintAt(box.x1+0.25f,box.y1+0.65f,1,&quot;You won the game&quot;);
@@ -242,19 +240,19 @@
 		}
 
 		float ypos=0.5f;
-		for(int a=0;a&lt;gs-&gt;activePlayers;++a){
-			if(gs-&gt;players[a]-&gt;currentStats-&gt;mousePixels==0)
+		for(int a=0;a&lt;playerHandler-&gt;ActivePlayers();++a){
+			if(playerHandler-&gt;Player(a)-&gt;currentStats-&gt;mousePixels==0)
 				continue;
 			char values[6][100];
 
-			sprintf(values[0],&quot;%s&quot;,	gs-&gt;players[a]-&gt;name.c_str());
-			sprintf(values[1],&quot;%i&quot;,(int)(gs-&gt;players[a]-&gt;currentStats-&gt;mouseClicks*60/game-&gt;totalGameTime));
-			sprintf(values[2],&quot;%i&quot;,(int)(gs-&gt;players[a]-&gt;currentStats-&gt;mousePixels*60/game-&gt;totalGameTime));
-			sprintf(values[3],&quot;%i&quot;,(int)(gs-&gt;players[a]-&gt;currentStats-&gt;keyPresses*60/game-&gt;totalGameTime));
-			sprintf(values[4],&quot;%i&quot;,(int)(gs-&gt;players[a]-&gt;currentStats-&gt;numCommands*60/game-&gt;totalGameTime));
+			sprintf(values[0],&quot;%s&quot;,	playerHandler-&gt;Player(a)-&gt;name.c_str());
+			sprintf(values[1],&quot;%i&quot;,(int)(playerHandler-&gt;Player(a)-&gt;currentStats-&gt;mouseClicks*60/game-&gt;totalGameTime));
+			sprintf(values[2],&quot;%i&quot;,(int)(playerHandler-&gt;Player(a)-&gt;currentStats-&gt;mousePixels*60/game-&gt;totalGameTime));
+			sprintf(values[3],&quot;%i&quot;,(int)(playerHandler-&gt;Player(a)-&gt;currentStats-&gt;keyPresses*60/game-&gt;totalGameTime));
+			sprintf(values[4],&quot;%i&quot;,(int)(playerHandler-&gt;Player(a)-&gt;currentStats-&gt;numCommands*60/game-&gt;totalGameTime));
 			sprintf(values[5],&quot;%i&quot;,(int)
-				( gs-&gt;players[a]-&gt;currentStats-&gt;numCommands != 0 ) ?
-				( gs-&gt;players[a]-&gt;currentStats-&gt;unitCommands/gs-&gt;players[a]-&gt;currentStats-&gt;numCommands) :
+				( playerHandler-&gt;Player(a)-&gt;currentStats-&gt;numCommands != 0 ) ?
+				( playerHandler-&gt;Player(a)-&gt;currentStats-&gt;unitCommands/playerHandler-&gt;Player(a)-&gt;currentStats-&gt;numCommands) :
 				( 0 ));
 
 			float xpos=0.01f;
@@ -339,9 +337,9 @@
 		glEnd();
 		glDisable(GL_LINE_STIPPLE);
 
-		for(int team=0; team&lt;gs-&gt;activeTeams; team++){
-			if (gs-&gt;Team(team)-&gt;gaia) continue;
-			glColor4ubv(gs-&gt;Team(team)-&gt;color);
+		for(int team=0; team&lt;teamHandler-&gt;ActiveTeams(); team++){
+			if (teamHandler-&gt;Team(team)-&gt;gaia) continue;
+			glColor4ubv(teamHandler-&gt;Team(team)-&gt;color);
 
 			glBegin(GL_LINE_STRIP);
 			for(int a=0;a&lt;numPoints;++a){
@@ -379,9 +377,8 @@
 
 std::string CEndGameBox::GetTooltip(int x, int y)
 {
-	if (disabled) {
+	if (disabled)
 		return &quot;&quot;;
-	}
 
 	float mx=MouseX(x);
 
@@ -430,9 +427,9 @@
 	stats.push_back(Stat(&quot;Damage Dealt&quot;));
 	stats.push_back(Stat(&quot;Damage Received&quot;));
 
-	for(int team=0; team&lt;gs-&gt;activeTeams; team++){
-		if (gs-&gt;Team(team)-&gt;gaia) continue;
-		for(std::list&lt;CTeam::Statistics&gt;::iterator si=gs-&gt;Team(team)-&gt;statHistory.begin(); si!=gs-&gt;Team(team)-&gt;statHistory.end(); si++){
+	for(int team=0; team&lt;teamHandler-&gt;ActiveTeams(); team++){
+		if (teamHandler-&gt;Team(team)-&gt;gaia) continue;
+		for(std::list&lt;CTeam::Statistics&gt;::iterator si=teamHandler-&gt;Team(team)-&gt;statHistory.begin(); si!=teamHandler-&gt;Team(team)-&gt;statHistory.end(); si++){
 			stats[0].AddStat(team,0);
 
 			stats[1].AddStat(team, si-&gt;metalUsed);

Modified: branches/caiinterface/rts/Game/UI/EndGameBox.h
===================================================================
--- branches/caiinterface/rts/Game/UI/EndGameBox.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/UI/EndGameBox.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -5,7 +5,8 @@
 #include &lt;list&gt;
 #include &lt;vector&gt;
 #include &quot;Rendering/GL/myGL.h&quot;
-#include &quot;Game/GlobalConstants.h&quot;
+#include &quot;Sim/Misc/GlobalConstants.h&quot;
+#include &quot;Rendering/Textures/Bitmap.h&quot;
 
 
 // msvc behaves really strange
@@ -72,6 +73,7 @@
 
 	std::vector&lt;Stat&gt; stats;
 	GLuint graphTex;
+	CBitmap bm;
 };
 
 #endif // __END_GAME_BOX_H__

Modified: branches/caiinterface/rts/Game/UI/GameInfo.cpp
===================================================================
--- branches/caiinterface/rts/Game/UI/GameInfo.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/UI/GameInfo.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -11,11 +11,11 @@
 #include &quot;Rendering/glFont.h&quot;
 #include &quot;Game/GameSetup.h&quot;
 #include &quot;Game/GameVersion.h&quot;
-#include &quot;Game/Team.h&quot;
+#include &quot;Sim/Misc/Team.h&quot;
 #include &quot;Map/MapInfo.h&quot;
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;Sim/Misc/Wind.h&quot;
-#include &quot;Sim/ModInfo.h&quot;
+#include &quot;Sim/Misc/ModInfo.h&quot;
 
 
 using namespace std;
@@ -167,10 +167,10 @@
 	labels.push_back(&quot;Game Version:&quot;);
 #ifdef USE_GML
 	char ver[64];
-	sprintf(ver, &quot;%s MT (%d threads)&quot;, VERSION_STRING_DETAILED, gmlThreadCount);
+	sprintf(ver, &quot;%s MT (%d threads)&quot;, SpringVersion::GetFull().c_str(), gmlThreadCount);
 	values.push_back(ver);
 #else
-	values.push_back(VERSION_STRING_DETAILED);
+	values.push_back(SpringVersion::GetFull());
 #endif
 	labels.push_back(&quot;Game Speed:&quot;);
 	values.push_back(gs-&gt;speedFactor);

Modified: branches/caiinterface/rts/Game/UI/GameSetupDrawer.cpp
===================================================================
--- branches/caiinterface/rts/Game/UI/GameSetupDrawer.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/UI/GameSetupDrawer.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -12,14 +12,14 @@
 
 #include &quot;NetProtocol.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
-#include &quot;../CameraHandler.h&quot;
-#include &quot;../Player.h&quot;
-#include &quot;../Team.h&quot;
-#include &quot;../GameSetup.h&quot;
-#include &quot;Game/GlobalSynced.h&quot;
+#include &quot;Game/CameraHandler.h&quot;
+#include &quot;Game/PlayerHandler.h&quot;
+#include &quot;Game/GameSetup.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;StartPosSelecter.h&quot;
 #include &quot;Rendering/glFont.h&quot;
-#include &quot;System/EventHandler.h&quot;
+#include &quot;EventHandler.h&quot;
 
 extern Uint8 *keys;
 
@@ -91,7 +91,7 @@
 		char buf[64];
 		sprintf(buf, &quot;Starting in %i&quot;, readyCountdown / 1000);
 		state = buf;
-	} else if (!gs-&gt;Team(gu-&gt;myTeam)-&gt;IsReadyToStart()) {
+	} else if (!teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;IsReadyToStart()) {
 		state = &quot;Choose start pos&quot;;
 	} else if (gu-&gt;myPlayerNum==0) {
 		state = &quot;Waiting for players, Ctrl+Return to force start&quot;;
@@ -102,9 +102,9 @@
 	// not the most efficent way to do this, but who cares?
 	std::map&lt;int, std::string&gt; playerStates;
 	for (int a = 0; a &lt; gameSetup-&gt;numPlayers; a++) {
-		if (!gs-&gt;players[a]-&gt;readyToStart) {
+		if (!playerHandler-&gt;Player(a)-&gt;readyToStart) {
 			playerStates[a] = &quot;missing&quot;;
-		} else if (!gs-&gt;Team(gs-&gt;players[a]-&gt;team)-&gt;IsReadyToStart()) {
+		} else if (!teamHandler-&gt;Team(playerHandler-&gt;Player(a)-&gt;team)-&gt;IsReadyToStart()) {
 			playerStates[a] = &quot;notready&quot;;
 		} else {
 			playerStates[a] = &quot;ready&quot;;
@@ -137,9 +137,9 @@
 		const float  white[4] = { 1.0f, 1.0f, 1.0f, 1.0f };
 		if (a == gameSetup-&gt;numPlayers) {
 			color = white; //blue;
-		} else if (!gs-&gt;players[a]-&gt;readyToStart) {
+		} else if (!playerHandler-&gt;Player(a)-&gt;readyToStart) {
 			color = red;
-		} else if (!gs-&gt;Team(gs-&gt;players[a]-&gt;team)-&gt;IsReadyToStart()) {
+		} else if (!teamHandler-&gt;Team(playerHandler-&gt;Player(a)-&gt;team)-&gt;IsReadyToStart()) {
 			color = yellow;
 		} else {
 			color = green;
@@ -149,7 +149,7 @@
 		if (a == gameSetup-&gt;numPlayers) {
 			name = &quot;Players:&quot;;
 		} else {
-			name = gs-&gt;players[a]-&gt;name.c_str();
+			name = playerHandler-&gt;Player(a)-&gt;name.c_str();
 		}
 		const float fontScale = 1.0f;
 		const float yScale = fontScale * font-&gt;GetHeight();

Modified: branches/caiinterface/rts/Game/UI/GuiHandler.cpp
===================================================================
--- branches/caiinterface/rts/Game/UI/GuiHandler.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/UI/GuiHandler.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -50,12 +50,12 @@
 #include &quot;Sim/Units/UnitLoader.h&quot;
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
 #include &quot;Sim/Weapons/Weapon.h&quot;
-#include &quot;System/EventHandler.h&quot;
-#include &quot;System/FileSystem/SimpleParser.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/Platform/ConfigHandler.h&quot;
-#include &quot;System/Util.h&quot;
-#include &quot;System/myMath.h&quot;
+#include &quot;EventHandler.h&quot;
+#include &quot;FileSystem/SimpleParser.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;Platform/ConfigHandler.h&quot;
+#include &quot;Util.h&quot;
+#include &quot;myMath.h&quot;
 
 extern Uint8 *keys;
 

Modified: branches/caiinterface/rts/Game/UI/GuiHandler.h
===================================================================
--- branches/caiinterface/rts/Game/UI/GuiHandler.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/UI/GuiHandler.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -12,7 +12,7 @@
 #include &quot;KeyBindings.h&quot;
 #include &quot;InputReceiver.h&quot;
 #include &quot;Game/Camera.h&quot;
-#include &quot;Game/UI/MouseHandler.h&quot;
+#include &quot;MouseHandler.h&quot;
 
 class CUnit;
 class CglList;

Modified: branches/caiinterface/rts/Game/UI/HwMouseCursor.cpp
===================================================================
--- branches/caiinterface/rts/Game/UI/HwMouseCursor.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/UI/HwMouseCursor.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -42,7 +42,7 @@
 		void PushFrame(int index, float delay){};
 		void Finish(){};
 
-		bool needsYFlip() {return false;};
+		bool NeedsYFlip() {return false;};
 
 		bool IsValid(){return false;};
 		void Bind(){};
@@ -58,7 +58,7 @@
 		void PushFrame(int index, float delay);
 		void Finish();
 
-		bool needsYFlip() {return true;};
+		bool NeedsYFlip() {return true;};
 
 		void Bind();
 
@@ -111,7 +111,7 @@
 		void PushFrame(int index, float delay);
 		void Finish();
 
-		bool needsYFlip() {return false;};
+		bool NeedsYFlip() {return false;};
 
 		bool IsValid() {return (cursor!=0);};
 		void Bind();
@@ -142,7 +142,7 @@
 
 
 //////////////////////////////////////////////////////////////////////
-// Implementation 
+// Implementation
 //////////////////////////////////////////////////////////////////////
 
 
@@ -415,7 +415,7 @@
 
 void CHwX11Cursor::resizeImage(XcursorImage*&amp; image, const int new_x, const int new_y)
 {
-	if (image-&gt;width==new_x &amp;&amp; image-&gt;height==new_y)
+	if (int(image-&gt;width) == new_x &amp;&amp; int(image-&gt;height) == new_y)
 		return;
 
 	const int old_x = image-&gt;width;
@@ -424,7 +424,7 @@
 	XcursorImage* new_image = XcursorImageCreate(new_x, new_y);
 	new_image-&gt;delay = image-&gt;delay;
 
-	unsigned char* src = (unsigned char*)image-&gt;pixels;
+	const unsigned char* src = (unsigned char*)image-&gt;pixels;
 	unsigned char* dst = (unsigned char*)new_image-&gt;pixels;
 	memset(dst, 0, new_x*new_y*4);
 
@@ -466,15 +466,15 @@
 
 void CHwX11Cursor::PushFrame(int index, float delay)
 {
-	if (index&gt;=cimages.size())
+	if (index &gt;= int(cimages.size()))
 		return;
 
-	if (cimages[index]-&gt;delay!=delay) {
+	if (cimages[index]-&gt;delay != delay) {
 		// make a copy of the existing one
 		XcursorImage* ci = cimages[index];
 		PushImage( ci-&gt;width, ci-&gt;height, ci-&gt;pixels );
 		SetDelay(delay);
-	}else{
+	} else {
 		cimages.push_back( cimages[index] );
 	}
 }
@@ -485,12 +485,12 @@
 		return;
 
 	//resize images
-	for (std::vector&lt;XcursorImage*&gt;::iterator it=cimages.begin(); it&lt;cimages.end(); it++)
-		resizeImage(*it,xmaxsize,ymaxsize);
+	for (std::vector&lt;XcursorImage*&gt;::iterator it = cimages.begin(); it &lt; cimages.end(); ++it)
+		resizeImage(*it, xmaxsize, ymaxsize);
 
 	XcursorImages *cis = XcursorImagesCreate(cimages.size());
 	cis-&gt;nimage = cimages.size();
-	for (int i=0; i &lt; cimages.size(); i++ ) {
+	for (int i = 0; i &lt; int(cimages.size()); ++i) {
 		XcursorImage* ci = cimages[i];
 		ci-&gt;xhot = (hotSpot==CMouseCursor::TopLeft) ? 0 : ci-&gt;width/2;
 		ci-&gt;yhot = (hotSpot==CMouseCursor::TopLeft) ? 0 : ci-&gt;height/2;

Modified: branches/caiinterface/rts/Game/UI/HwMouseCursor.h
===================================================================
--- branches/caiinterface/rts/Game/UI/HwMouseCursor.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/UI/HwMouseCursor.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -14,7 +14,7 @@
 		virtual void PushFrame(int index, float delay) = 0;
 		virtual void Finish() = 0;
 
-		virtual bool needsYFlip() = 0; //windows needs flipped Y axis
+		virtual bool NeedsYFlip() = 0; //windows needs flipped Y axis
 
 		virtual bool IsValid() = 0;
 		virtual void Bind() = 0;

Modified: branches/caiinterface/rts/Game/UI/InfoConsole.h
===================================================================
--- branches/caiinterface/rts/Game/UI/InfoConsole.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/UI/InfoConsole.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -7,6 +7,7 @@
 #include &lt;deque&gt;
 #include &lt;vector&gt;
 #include &lt;string&gt;
+#include &lt;list&gt;
 #include &lt;boost/thread/recursive_mutex.hpp&gt;
 #include &lt;SDL_types.h&gt;
 #include &quot;float3.h&quot;

Modified: branches/caiinterface/rts/Game/UI/InputReceiver.cpp
===================================================================
--- branches/caiinterface/rts/Game/UI/InputReceiver.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/UI/InputReceiver.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -90,8 +90,8 @@
 
 CInputReceiver::ContainerBox::ContainerBox()
 : x1(0),
+	y1(0),
 	x2(0),
-	y1(0),
 	y2(0)
 {
 }

Modified: branches/caiinterface/rts/Game/UI/InputReceiver.h
===================================================================
--- branches/caiinterface/rts/Game/UI/InputReceiver.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/UI/InputReceiver.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -4,11 +4,9 @@
 #include &lt;deque&gt;
 #include &lt;string&gt;
 
-#include &quot;Object.h&quot;
 #include &quot;GlobalUnsynced.h&quot;
 
-class CInputReceiver :
-	public CObject
+class CInputReceiver
 {
 protected:
 	enum Where {

Modified: branches/caiinterface/rts/Game/UI/KeyAutoBinder.cpp
===================================================================
--- branches/caiinterface/rts/Game/UI/KeyAutoBinder.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/UI/KeyAutoBinder.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -11,7 +11,7 @@
 
 #include &quot;KeyBindings.h&quot;
 #include &quot;Game/GameSetup.h&quot;
-#include &quot;Game/Team.h&quot;
+#include &quot;Sim/Misc/Team.h&quot;
 #include &quot;Lua/LuaConstGame.h&quot;
 #include &quot;Lua/LuaUnitDefs.h&quot;
 #include &quot;Lua/LuaWeaponDefs.h&quot;
@@ -19,14 +19,14 @@
 #include &quot;Sim/Misc/CategoryHandler.h&quot;
 #include &quot;Sim/Misc/DamageArrayHandler.h&quot;
 #include &quot;Sim/Misc/Wind.h&quot;
-#include &quot;Sim/ModInfo.h&quot;
+#include &quot;Sim/Misc/ModInfo.h&quot;
 #include &quot;Sim/Projectiles/Projectile.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;Sim/Units/UnitDefHandler.h&quot;
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
-#include &quot;System/FileSystem/SimpleParser.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/Util.h&quot;
+#include &quot;FileSystem/SimpleParser.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;Util.h&quot;
 
 
 #if (LUA_VERSION_NUM &lt; 500)

Modified: branches/caiinterface/rts/Game/UI/KeyBindings.cpp
===================================================================
--- branches/caiinterface/rts/Game/UI/KeyBindings.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/UI/KeyBindings.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -16,11 +16,11 @@
 #include &quot;KeyAutoBinder.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;Sim/Units/UnitDefHandler.h&quot;
-#include &quot;System/Platform/errorhandler.h&quot;
-#include &quot;System/FileSystem/FileHandler.h&quot;
-#include &quot;System/FileSystem/SimpleParser.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/Util.h&quot;
+#include &quot;Platform/errorhandler.h&quot;
+#include &quot;FileSystem/FileHandler.h&quot;
+#include &quot;FileSystem/SimpleParser.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;Util.h&quot;
 
 
 CKeyBindings* keyBindings = NULL;

Modified: branches/caiinterface/rts/Game/UI/KeyCodes.cpp
===================================================================
--- branches/caiinterface/rts/Game/UI/KeyCodes.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/UI/KeyCodes.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -8,8 +8,8 @@
 
 #include &quot;KeyCodes.h&quot;
 #include &quot;SDL_keysym.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/Util.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;Util.h&quot;
 
 
 CKeyCodes* keyCodes = NULL;

Modified: branches/caiinterface/rts/Game/UI/KeySet.cpp
===================================================================
--- branches/caiinterface/rts/Game/UI/KeySet.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/UI/KeySet.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -11,8 +11,8 @@
 #include &quot;SDL_keysym.h&quot;
 #include &quot;SDL_types.h&quot;
 
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/Util.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;Util.h&quot;
 
 extern Uint8* keys; // from System/Main.cpp
 

Modified: branches/caiinterface/rts/Game/UI/LuaUI.cpp
===================================================================
--- branches/caiinterface/rts/Game/UI/LuaUI.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/UI/LuaUI.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -46,16 +46,16 @@
 #include &quot;Game/GameHelper.h&quot;
 #include &quot;Game/PlayerRoster.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
-#include &quot;Game/Team.h&quot;
-#include &quot;Game/UI/CommandColors.h&quot;
-#include &quot;Game/UI/CursorIcons.h&quot;
-#include &quot;Game/UI/GuiHandler.h&quot;
-#include &quot;Game/UI/InfoConsole.h&quot;
-#include &quot;Game/UI/KeyCodes.h&quot;
-#include &quot;Game/UI/KeySet.h&quot;
-#include &quot;Game/UI/KeyBindings.h&quot;
-#include &quot;Game/UI/MiniMap.h&quot;
-#include &quot;Game/UI/MouseHandler.h&quot;
+#include &quot;Sim/Misc/Team.h&quot;
+#include &quot;CommandColors.h&quot;
+#include &quot;CursorIcons.h&quot;
+#include &quot;GuiHandler.h&quot;
+#include &quot;InfoConsole.h&quot;
+#include &quot;KeyCodes.h&quot;
+#include &quot;KeySet.h&quot;
+#include &quot;KeyBindings.h&quot;
+#include &quot;MiniMap.h&quot;
+#include &quot;MouseHandler.h&quot;
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;Map/BaseGroundDrawer.h&quot;
 #include &quot;Rendering/IconHandler.h&quot;
@@ -66,15 +66,15 @@
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
 #include &quot;Sim/Units/UnitDefHandler.h&quot;
-#include &quot;System/EventHandler.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/NetProtocol.h&quot;
-#include &quot;System/SpringApp.h&quot;
-#include &quot;System/FileSystem/FileHandler.h&quot;
-#include &quot;System/FileSystem/VFSHandler.h&quot;
-#include &quot;System/Platform/ConfigHandler.h&quot;
-#include &quot;System/Platform/FileSystem.h&quot;
-#include &quot;System/Util.h&quot;
+#include &quot;EventHandler.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;NetProtocol.h&quot;
+#include &quot;SpringApp.h&quot;
+#include &quot;FileSystem/FileHandler.h&quot;
+#include &quot;FileSystem/VFSHandler.h&quot;
+#include &quot;Platform/ConfigHandler.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
+#include &quot;Util.h&quot;
 
 
 #if (LUA_VERSION_NUM &lt; 500)
@@ -507,10 +507,10 @@
 	buttonList.clear();
 	menuName = &quot;&quot;;
 
+	LUA_CALL_IN_CHECK(L);
+	lua_checkstack(L, 6);
 	const int top = lua_gettop(L);
 
-	LUA_CALL_IN_CHECK(L);
-	lua_checkstack(L, 6);
 	static const LuaHashString cmdStr(&quot;LayoutButtons&quot;);
 	if (!cmdStr.GetGlobalFunc(L)) {
 		return false;

Modified: branches/caiinterface/rts/Game/UI/MiniMap.cpp
===================================================================
--- branches/caiinterface/rts/Game/UI/MiniMap.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/UI/MiniMap.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -18,7 +18,7 @@
 #include &quot;Game/GameHelper.h&quot;
 #include &quot;Game/Player.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
-#include &quot;Game/Team.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;GuiHandler.h&quot;
 #include &quot;Lua/LuaUnsyncedCtrl.h&quot;
 #include &quot;Map/BaseGroundDrawer.h&quot;
@@ -53,10 +53,10 @@
 #include &quot;Sim/Units/UnitTracker.h&quot;
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
 #include &quot;Sim/Weapons/Weapon.h&quot;
-#include &quot;System/EventHandler.h&quot;
-#include &quot;System/Sound.h&quot;
-#include &quot;System/FileSystem/SimpleParser.h&quot;
-#include &quot;System/Util.h&quot;
+#include &quot;EventHandler.h&quot;
+#include &quot;Sound.h&quot;
+#include &quot;FileSystem/SimpleParser.h&quot;
+#include &quot;Util.h&quot;
 #include &quot;TimeProfiler.h&quot;
 #include &quot;TooltipConsole.h&quot;
 
@@ -688,13 +688,13 @@
 
 		if (gu-&gt;spectatingFullSelect) {
 			team = 0;
-			lastTeam = gs-&gt;activeTeams - 1;
+			lastTeam = teamHandler-&gt;ActiveTeams() - 1;
 		} else {
 			team = gu-&gt;myTeam;
 			lastTeam = gu-&gt;myTeam;
 		}
 		for (; team &lt;= lastTeam; team++) {
-			CUnitSet&amp; teamUnits = gs-&gt;Team(team)-&gt;units;
+			CUnitSet&amp; teamUnits = teamHandler-&gt;Team(team)-&gt;units;
 			for (ui = teamUnits.begin(); ui != teamUnits.end(); ++ui) {
 				const float3&amp; midPos = (*ui)-&gt;midPos;
 
@@ -756,13 +756,13 @@
 					int team, lastTeam;
 					if (gu-&gt;spectatingFullSelect) {
 						team = 0;
-						lastTeam = gs-&gt;activeTeams - 1;
+						lastTeam = teamHandler-&gt;ActiveTeams() - 1;
 					} else {
 						team = gu-&gt;myTeam;
 						lastTeam = gu-&gt;myTeam;
 					}
 					for (; team &lt;= lastTeam; team++) {
-						CUnitSet&amp; myUnits = gs-&gt;Team(team)-&gt;units;
+						CUnitSet&amp; myUnits = teamHandler-&gt;Team(team)-&gt;units;
 						for (ui = myUnits.begin(); ui != myUnits.end(); ++ui) {
 							if ((*ui)-&gt;aihint == unit-&gt;aihint) {
 								selectedUnits.AddUnit(*ui);
@@ -839,7 +839,7 @@
 //	CCamera *c = camera;
 //	camera = new CCamera(*c);
 
-//	const float3 tmpMouseDir = mouse-&gt;dir; 
+//	const float3 tmpMouseDir = mouse-&gt;dir;
 
 	float3 mapPos = GetMapPosition(x, y);
 	const CUnit* unit = GetSelectUnit(mapPos);
@@ -1488,13 +1488,13 @@
 		if (simpleColors) {
 			if (unit-&gt;team == gu-&gt;myTeam) {
 				glColor3ubv(myColor);
-			} else if (gs-&gt;Ally(gu-&gt;myAllyTeam, unit-&gt;allyteam)) {
+			} else if (teamHandler-&gt;Ally(gu-&gt;myAllyTeam, unit-&gt;allyteam)) {
 				glColor3ubv(allyColor);
 			} else {
 				glColor3ubv(enemyColor);
 			}
 		} else {
-			glColor3ubv(gs-&gt;Team(unit-&gt;team)-&gt;color);
+			glColor3ubv(teamHandler-&gt;Team(unit-&gt;team)-&gt;color);
 		}
 	}
 

Modified: branches/caiinterface/rts/Game/UI/MiniMap.h
===================================================================
--- branches/caiinterface/rts/Game/UI/MiniMap.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/UI/MiniMap.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -6,6 +6,7 @@
 
 #include &lt;vector&gt;
 #include &lt;string&gt;
+#include &lt;list&gt;
 #include &quot;InputReceiver.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
 

Modified: branches/caiinterface/rts/Game/UI/MouseCursor.cpp
===================================================================
--- branches/caiinterface/rts/Game/UI/MouseCursor.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/UI/MouseCursor.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -6,8 +6,8 @@
 #include &quot;FileSystem/FileHandler.h&quot;
 #include &quot;FileSystem/SimpleParser.h&quot;
 #include &quot;LogOutput.h&quot;
-#include &quot;System/Util.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;Util.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 #include &quot;MouseCursor.h&quot;
 #include &quot;HwMouseCursor.h&quot;
 #include &quot;myMath.h&quot;
@@ -176,7 +176,7 @@
 		delete f;
 	}
 
-	while (frames.size() &lt; lastFrame) {
+	while (int(frames.size()) &lt; lastFrame) {
 		SNPRINTF(namebuf, sizeof(namebuf), &quot;anims/%s_%d.%s&quot;,
 		         name.c_str(), frames.size(), ext);
 		ImageData image;
@@ -212,7 +212,7 @@
 		setBitmapTransparency(b, 84, 84, 252);
 	}
 
-	if (hwCursor-&gt;needsYFlip()) {
+	if (hwCursor-&gt;NeedsYFlip()) {
 		//WINDOWS
 		b.ReverseYAxis();
 		hwCursor-&gt;PushImage(b.xsize,b.ysize,b.mem);
@@ -357,7 +357,7 @@
 
 	while (animTime &gt; frames[currentFrame].endTime) {
 		currentFrame++;
-		if (currentFrame &gt;= frames.size()) {
+		if (currentFrame &gt;= int(frames.size())) {
 			currentFrame = 0;
 		}
 	}
@@ -372,5 +372,5 @@
 
 void CMouseCursor::BindHwCursor()
 {
-	hwCursor-&gt;Bind();	
+	hwCursor-&gt;Bind();
 }

Modified: branches/caiinterface/rts/Game/UI/MouseHandler.cpp
===================================================================
--- branches/caiinterface/rts/Game/UI/MouseHandler.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/UI/MouseHandler.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -20,8 +20,7 @@
 #include &quot;Game/Game.h&quot;
 #include &quot;Game/GameHelper.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
-#include &quot;Game/Team.h&quot;
-#include &quot;Game/Player.h&quot;
+#include &quot;Game/PlayerHandler.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Map/MapDamage.h&quot;
 #include &quot;Lua/LuaInputReceiver.h&quot;
@@ -34,11 +33,12 @@
 #include &quot;Sim/Features/FeatureDef.h&quot;
 #include &quot;Sim/Features/Feature.h&quot;
 #include &quot;Sim/Misc/LosHandler.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
 #include &quot;Sim/Units/UnitTracker.h&quot;
-#include &quot;System/EventHandler.h&quot;
+#include &quot;EventHandler.h&quot;
 #include &quot;Sound.h&quot;
 
 // can't be up there since those contain conflicting definitions
@@ -181,7 +181,7 @@
 	buttons[SDL_BUTTON_RIGHT].movement += abs(dx) + abs(dy);
 
 	if (!game-&gt;gameOver) {
-		gs-&gt;players[gu-&gt;myPlayerNum]-&gt;currentStats-&gt;mousePixels+=abs(dx)+abs(dy);
+		playerHandler-&gt;Player(gu-&gt;myPlayerNum)-&gt;currentStats-&gt;mousePixels+=abs(dx)+abs(dy);
 	}
 
 	if(activeReceiver){
@@ -210,7 +210,7 @@
 	dir = hide? camera-&gt;forward: camera-&gt;CalcPixelDir(x, y);
 
 	if (!game-&gt;gameOver)
-		gs-&gt;players[gu-&gt;myPlayerNum]-&gt;currentStats-&gt;mouseClicks++;
+		playerHandler-&gt;Player(gu-&gt;myPlayerNum)-&gt;currentStats-&gt;mouseClicks++;
 
 	if (button == 4) {
 		if (guihandler-&gt;buildSpacing &gt; 0)
@@ -409,13 +409,13 @@
 			int team, lastTeam;
 			if (gu-&gt;spectatingFullSelect) {
 				team = 0;
-				lastTeam = gs-&gt;activeTeams - 1;
+				lastTeam = teamHandler-&gt;ActiveTeams() - 1;
 			} else {
 				team = gu-&gt;myTeam;
 				lastTeam = gu-&gt;myTeam;
 			}
 			for (; team &lt;= lastTeam; team++) {
-				for(ui=gs-&gt;Team(team)-&gt;units.begin();ui!=gs-&gt;Team(team)-&gt;units.end();++ui){
+				for(ui=teamHandler-&gt;Team(team)-&gt;units.begin();ui!=teamHandler-&gt;Team(team)-&gt;units.end();++ui){
 					float3 vec=(*ui)-&gt;midPos-camera-&gt;pos;
 					if(vec.dot(norm1)&lt;0 &amp;&amp; vec.dot(norm2)&lt;0 &amp;&amp; vec.dot(norm3)&lt;0 &amp;&amp; vec.dot(norm4)&lt;0){
 						if (keys[SDLK_LCTRL] &amp;&amp; selectedUnits.selectedUnits.find(*ui) != selectedUnits.selectedUnits.end()) {
@@ -459,14 +459,14 @@
 						int team, lastTeam;
 						if (gu-&gt;spectatingFullSelect) {
 							team = 0;
-							lastTeam = gs-&gt;activeTeams - 1;
+							lastTeam = teamHandler-&gt;ActiveTeams() - 1;
 						} else {
 							team = gu-&gt;myTeam;
 							lastTeam = gu-&gt;myTeam;
 						}
 						for (; team &lt;= lastTeam; team++) {
 							CUnitSet::iterator ui;
-							CUnitSet&amp; teamUnits = gs-&gt;Team(team)-&gt;units;
+							CUnitSet&amp; teamUnits = teamHandler-&gt;Team(team)-&gt;units;
 							for (ui = teamUnits.begin(); ui != teamUnits.end(); ++ui) {
 								if (((*ui)-&gt;aihint == unit-&gt;aihint) &amp;&amp;
 										(camera-&gt;InView((*ui)-&gt;midPos) || keys[SDLK_LCTRL])) {

Modified: branches/caiinterface/rts/Game/UI/QuitBox.cpp
===================================================================
--- branches/caiinterface/rts/Game/UI/QuitBox.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/UI/QuitBox.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -2,12 +2,13 @@
 #include &lt;SDL_keysym.h&gt;
 #include &quot;mmgr.h&quot;
 
-#include &quot;Game/Team.h&quot;
-#include &quot;Game/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;MouseHandler.h&quot;
 #include &quot;NetProtocol.h&quot;
 #include &quot;QuitBox.h&quot;
+#include &quot;Game/PlayerHandler.h&quot;
 #include &quot;Rendering/glFont.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
 
@@ -50,13 +51,13 @@
 	noAlliesLeft=true;
 	shareTeam=0;
 	// if we have alive allies left, set the shareteam to an undead ally.
-	for(int team=0;team&lt;gs-&gt;activeTeams;++team){
-		if (gs-&gt;Team(team)-&gt;gaia) continue;
-		if(team!=gu-&gt;myTeam &amp;&amp; !gs-&gt;Team(team)-&gt;isDead)
+	for(int team=0;team&lt;teamHandler-&gt;ActiveTeams();++team){
+		if (teamHandler-&gt;Team(team)-&gt;gaia) continue;
+		if(team!=gu-&gt;myTeam &amp;&amp; !teamHandler-&gt;Team(team)-&gt;isDead)
 		{
-			if(shareTeam==gu-&gt;myTeam || gs-&gt;Team(shareTeam)-&gt;isDead)
+			if(shareTeam==gu-&gt;myTeam || teamHandler-&gt;Team(shareTeam)-&gt;isDead)
 				shareTeam=team;
-			if(gs-&gt;Ally(gu-&gt;myAllyTeam, gs-&gt;AllyTeam(team))){
+			if(teamHandler-&gt;Ally(gu-&gt;myAllyTeam, teamHandler-&gt;AllyTeam(team))){
 				noAlliesLeft=false;
 				shareTeam=team;
 				break;
@@ -122,12 +123,12 @@
 	font-&gt;glPrintAt(box.x1 + quitBox.x1       + 0.025f,
 	                box.y1 + quitBox.y1       + 0.005f, 1, &quot;Quit&quot;);
 
-	for(int team=0;team&lt;gs-&gt;activeTeams-1;++team){
+	for(int team=0;team&lt;teamHandler-&gt;ActiveTeams()-1;++team){
 		int actualTeam=team;
 		if (team &gt;= gu-&gt;myTeam) {
 			actualTeam++;
 		}
-		if (gs-&gt;Team(actualTeam)-&gt;gaia) continue;
+		if (teamHandler-&gt;Team(actualTeam)-&gt;gaia) continue;
 
 		if (shareTeam == actualTeam) {
 			glColor4f(1,1,1,0.8f);
@@ -136,21 +137,21 @@
 		}
 
 		std::string teamName;
-		if (gs-&gt;Team(actualTeam)-&gt;leader &gt;= 0)
-			teamName = gs-&gt;players[gs-&gt;Team(actualTeam)-&gt;leader]-&gt;name;
+		if (teamHandler-&gt;Team(actualTeam)-&gt;leader &gt;= 0)
+			teamName = playerHandler-&gt;Player(teamHandler-&gt;Team(actualTeam)-&gt;leader)-&gt;name;
 		else
 			teamName = &quot;uncontrolled&quot;;
 
 		std::string ally, dead;
-		if (gs-&gt;Ally(gu-&gt;myAllyTeam, gs-&gt;AllyTeam(actualTeam))) {
+		if (teamHandler-&gt;Ally(gu-&gt;myAllyTeam, teamHandler-&gt;AllyTeam(actualTeam))) {
 			ally = &quot; &lt;Ally&gt;)&quot;;
 		} else {
 			ally = &quot; &lt;Enemy&gt;&quot;;
 		}
-		if(gs-&gt;Team(actualTeam)-&gt;isDead) {
+		if(teamHandler-&gt;Team(actualTeam)-&gt;isDead) {
 			dead = &quot; &lt;Dead&gt;&quot;;
 		}
-		if (actualTeam == gs-&gt;gaiaTeamID) {
+		if (actualTeam == teamHandler-&gt;GaiaTeamID()) {
 			teamName = &quot;Gaia&quot;;
 			ally   = &quot; &lt;Gaia&gt;&quot;;
 		}
@@ -202,9 +203,9 @@
 			int team=(int)((box.y1+teamBox.y2-my)/0.025f);
 			if(team&gt;=gu-&gt;myTeam)
 				team++;
-			if(team&lt;gs-&gt;activeTeams &amp;&amp; !gs-&gt;Team(team)-&gt;isDead){
+			if(team&lt;teamHandler-&gt;ActiveTeams() &amp;&amp; !teamHandler-&gt;Team(team)-&gt;isDead){
 				// we don't want to give everything to the enemy if there are allies left
-				if(noAlliesLeft || (!noAlliesLeft &amp;&amp; gs-&gt;Ally(gu-&gt;myAllyTeam, gs-&gt;AllyTeam(team)))){
+				if(noAlliesLeft || (!noAlliesLeft &amp;&amp; teamHandler-&gt;Ally(gu-&gt;myAllyTeam, teamHandler-&gt;AllyTeam(team)))){
 					shareTeam=team;
 				}
 			}
@@ -219,15 +220,15 @@
 	float mx=MouseX(x);
 	float my=MouseY(y);
 
-	if(InBox(mx,my,box+resignBox) || InBox(mx,my,box+giveAwayBox) &amp;&amp; !gs-&gt;Team(shareTeam)-&gt;isDead &amp;&amp; !gs-&gt;Team(gu-&gt;myTeam)-&gt;isDead){
+	if(InBox(mx,my,box+resignBox) || InBox(mx,my,box+giveAwayBox) &amp;&amp; !teamHandler-&gt;Team(shareTeam)-&gt;isDead &amp;&amp; !teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;isDead){
 		// give away all units (and resources)
 		if(InBox(mx,my,box+giveAwayBox)) {
 			net-&gt;Send(CBaseNetProtocol::Get().SendGiveAwayEverything(gu-&gt;myPlayerNum, shareTeam));
 			// inform other users of the giving away of units
 			char givenAwayMsg[200];
 			sprintf(givenAwayMsg,&quot;%s gave everything to %s.&quot;,
-				gs-&gt;players[gu-&gt;myPlayerNum]-&gt;name.c_str(),
-				gs-&gt;players[gs-&gt;Team(shareTeam)-&gt;leader]-&gt;name.c_str());
+				playerHandler-&gt;Player(gu-&gt;myPlayerNum)-&gt;name.c_str(),
+				playerHandler-&gt;Player(teamHandler-&gt;Team(shareTeam)-&gt;leader)-&gt;name.c_str());
 			net-&gt;Send(CBaseNetProtocol::Get().SendSystemMessage(gu-&gt;myPlayerNum, givenAwayMsg));
 		}
 		// resign, so self-d all units
@@ -262,9 +263,9 @@
 		int team=(int)((box.y1+teamBox.y2-my)/0.025f);
 		if(team&gt;=gu-&gt;myTeam)
 			team++;
-		if(team&lt;gs-&gt;activeTeams &amp;&amp; !gs-&gt;Team(team)-&gt;isDead){
+		if(team&lt;teamHandler-&gt;ActiveTeams() &amp;&amp; !teamHandler-&gt;Team(team)-&gt;isDead){
 			// we don't want to give everything to the enemy if there are allies left
-			if(noAlliesLeft || (!noAlliesLeft &amp;&amp; gs-&gt;Ally(gu-&gt;myAllyTeam, gs-&gt;AllyTeam(team)))){
+			if(noAlliesLeft || (!noAlliesLeft &amp;&amp; teamHandler-&gt;Ally(gu-&gt;myAllyTeam, teamHandler-&gt;AllyTeam(team)))){
 				shareTeam=team;
 			}
 		}

Modified: branches/caiinterface/rts/Game/UI/ResourceBar.cpp
===================================================================
--- branches/caiinterface/rts/Game/UI/ResourceBar.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/UI/ResourceBar.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -4,8 +4,8 @@
 #include &quot;ResourceBar.h&quot;
 #include &quot;MouseHandler.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
-#include &quot;Game/Team.h&quot;
-#include &quot;Game/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
 #include &quot;Rendering/glFont.h&quot;
 #include &quot;NetProtocol.h&quot;
 #include &quot;TimeProfiler.h&quot;
@@ -61,7 +61,7 @@
 		return;
 	}
 
-	const CTeam* myTeam = gs-&gt;Team(gu-&gt;myTeam);
+	const CTeam* myTeam = teamHandler-&gt;Team(gu-&gt;myTeam);
 
 	GLfloat x1,y1,x2,y2,x;
 
@@ -246,12 +246,12 @@
 			if(InBox(mx,my,box+metalBox)){
 				moveBox = false;
 				float metalShare = std::max(0.f, std::min(1.f,(mx-(box.x1+metalBox.x1))/(metalBox.x2-metalBox.x1)));
-				net-&gt;Send(CBaseNetProtocol::Get().SendSetShare(gu-&gt;myPlayerNum, gu-&gt;myTeam, metalShare, gs-&gt;Team(gu-&gt;myTeam)-&gt;energyShare));
+				net-&gt;Send(CBaseNetProtocol::Get().SendSetShare(gu-&gt;myPlayerNum, gu-&gt;myTeam, metalShare, teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;energyShare));
 			}
 			if(InBox(mx,my,box+energyBox)){
 				moveBox = false;
 				float energyShare = std::max(0.f, std::min(1.f,(mx-(box.x1+energyBox.x1))/(energyBox.x2-energyBox.x1)));
-				net-&gt;Send(CBaseNetProtocol::Get().SendSetShare(gu-&gt;myPlayerNum, gu-&gt;myTeam, gs-&gt;Team(gu-&gt;myTeam)-&gt;metalShare, energyShare));
+				net-&gt;Send(CBaseNetProtocol::Get().SendSetShare(gu-&gt;myPlayerNum, gu-&gt;myTeam, teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;metalShare, energyShare));
 			}
 		}
 		return true;

Modified: branches/caiinterface/rts/Game/UI/SelectionKeyHandler.cpp
===================================================================
--- branches/caiinterface/rts/Game/UI/SelectionKeyHandler.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/UI/SelectionKeyHandler.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -8,11 +8,11 @@
 #include &quot;Game/Camera.h&quot;
 #include &quot;Game/CameraHandler.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
-#include &quot;Game/Team.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;MouseHandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;SelectionKeyHandler.h&quot;
 #include &quot;Sim/Misc/CategoryHandler.h&quot;
 #include &quot;Sim/Units/CommandAI/CommandAI.h&quot;
@@ -20,7 +20,7 @@
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
 #include &quot;Sim/Units/UnitTypes/Building.h&quot;
-#include &quot;System/myMath.h&quot;
+#include &quot;myMath.h&quot;
 
 CSelectionKeyHandler *selectionKeys;
 
@@ -151,7 +151,7 @@
 	if(s==&quot;AllMap&quot;){
 		if (!gu-&gt;spectatingFullSelect) {
 			// team units
-			CUnitSet* tu=&amp;gs-&gt;Team(gu-&gt;myTeam)-&gt;units;
+			CUnitSet* tu=&amp;teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;units;
 			for(CUnitSet::iterator ui=tu-&gt;begin();ui!=tu-&gt;end();++ui){
 				selection.push_back(*ui);
 			}
@@ -165,7 +165,7 @@
 	} else if(s==&quot;Visible&quot;){
 		if (!gu-&gt;spectatingFullSelect) {
 			// team units in viewport
-			CUnitSet* tu=&amp;gs-&gt;Team(gu-&gt;myTeam)-&gt;units;
+			CUnitSet* tu=&amp;teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;units;
 			for (CUnitSet::iterator ui=tu-&gt;begin();ui!=tu-&gt;end();++ui){
 				if (camera-&gt;InView((*ui)-&gt;midPos,(*ui)-&gt;radius)){
 					selection.push_back(*ui);
@@ -189,7 +189,7 @@
 
 		if (!gu-&gt;spectatingFullSelect) {
 		  // team units in mouse range
-			CUnitSet* tu=&amp;gs-&gt;Team(gu-&gt;myTeam)-&gt;units;
+			CUnitSet* tu=&amp;teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;units;
 			for(CUnitSet::iterator ui=tu-&gt;begin();ui!=tu-&gt;end();++ui){
 				if(mp.SqDistance((*ui)-&gt;pos)&lt;Square(maxDist)){
 					selection.push_back(*ui);

Modified: branches/caiinterface/rts/Game/UI/ShareBox.cpp
===================================================================
--- branches/caiinterface/rts/Game/UI/ShareBox.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/UI/ShareBox.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -5,9 +5,9 @@
 #include &quot;ShareBox.h&quot;
 #include &quot;MouseHandler.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
-#include &quot;Game/Team.h&quot;
-#include &quot;Game/Player.h&quot;
-#include &quot;Game/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
+#include &quot;Game/PlayerHandler.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
 #include &quot;Rendering/glFont.h&quot;
 #include &quot;NetProtocol.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
@@ -65,11 +65,11 @@
 	// find a default team to share to that is not gu-&gt;myTeam and is not dead.
 	shareTeam = lastShareTeam;
 
-	while (shareTeam == gu-&gt;myTeam || gs-&gt;Team(shareTeam)-&gt;isDead) {
+	while (shareTeam == gu-&gt;myTeam || teamHandler-&gt;Team(shareTeam)-&gt;isDead) {
 		++shareTeam;
 
 		// wrap around
-		if (shareTeam &gt;= gs-&gt;activeTeams)
+		if (shareTeam &gt;= teamHandler-&gt;ActiveTeams())
 			shareTeam = 0;
 
 		// we're back at the start, so there are no teams alive...
@@ -170,17 +170,17 @@
 	font-&gt;glPrintAt(box.x1+0.01f,box.y1+0.16f,0.7f,&quot;Share Energy&quot;);
 
 	glColor4f(1,1,1,0.8f);
-	font-&gt;glFormatAt(box.x1+0.25f,box.y1+0.12f,0.7f,&quot;%.0f&quot;,float(gs-&gt;Team(gu-&gt;myTeam)-&gt;energy));
-	font-&gt;glFormatAt(box.x1+0.14f,box.y1+0.12f,0.7f,&quot;%.0f&quot;,gs-&gt;Team(gu-&gt;myTeam)-&gt;energy*energyShare);
+	font-&gt;glFormatAt(box.x1+0.25f,box.y1+0.12f,0.7f,&quot;%.0f&quot;,float(teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;energy));
+	font-&gt;glFormatAt(box.x1+0.14f,box.y1+0.12f,0.7f,&quot;%.0f&quot;,teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;energy*energyShare);
 
 	glColor4f(0.8f,0.8f,0.9f,0.8f);
 	font-&gt;glPrintAt(box.x1+0.01f,box.y1+0.22f,0.7f,&quot;Share Metal&quot;);
 
 	glColor4f(1,1,1,0.8f);
-	font-&gt;glFormatAt(box.x1+0.25f,box.y1+0.18f,0.7f,&quot;%.0f&quot;,float(gs-&gt;Team(gu-&gt;myTeam)-&gt;metal));
-	font-&gt;glFormatAt(box.x1+0.14f,box.y1+0.18f,0.7f,&quot;%.0f&quot;,gs-&gt;Team(gu-&gt;myTeam)-&gt;metal*metalShare);
+	font-&gt;glFormatAt(box.x1+0.25f,box.y1+0.18f,0.7f,&quot;%.0f&quot;,float(teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;metal));
+	font-&gt;glFormatAt(box.x1+0.14f,box.y1+0.18f,0.7f,&quot;%.0f&quot;,teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;metal*metalShare);
 
-	for(int team=0;team&lt;gs-&gt;activeTeams-1;++team){
+	for(int team=0;team&lt;teamHandler-&gt;ActiveTeams()-1;++team){
 		int actualTeam=team;
 		if (team &gt;= gu-&gt;myTeam) {
 			actualTeam++;
@@ -189,25 +189,25 @@
 		const float alpha = (shareTeam == actualTeam) ? 0.8f : 0.4f;
 		std::string teamName;
 
-		if (gs-&gt;Team(actualTeam)-&gt;leader &gt;= 0) {
-			teamName = gs-&gt;players[gs-&gt;Team(actualTeam)-&gt;leader]-&gt;name;
+		if (teamHandler-&gt;Team(actualTeam)-&gt;leader &gt;= 0) {
+			teamName = playerHandler-&gt;Player(teamHandler-&gt;Team(actualTeam)-&gt;leader)-&gt;name;
 		} else {
 			teamName = &quot;Uncontrolled&quot;;
 		}
 
 		std::string ally, dead;
-		if (gs-&gt;Ally(gu-&gt;myAllyTeam, gs-&gt;AllyTeam(actualTeam))) {
+		if (teamHandler-&gt;Ally(gu-&gt;myAllyTeam, teamHandler-&gt;AllyTeam(actualTeam))) {
 			glColor4f(0.5f, 1.0f, 0.5f, alpha);
 			ally = &quot; &lt;Ally&gt;&quot;;
 		} else {
 			glColor4f(1.0f, 0.5f, 0.5f, alpha);
 			ally = &quot; &lt;Enemy&gt;&quot;;
 		}
-		if (gs-&gt;Team(actualTeam)-&gt;isDead) {
+		if (teamHandler-&gt;Team(actualTeam)-&gt;isDead) {
 			glColor4f(0.5f, 0.5f, 1.0f, alpha);
 			dead = &quot; &lt;Dead&gt;&quot;;
 		}
-		if (actualTeam == gs-&gt;gaiaTeamID) {
+		if (actualTeam == teamHandler-&gt;GaiaTeamID()) {
 			glColor4f(0.8f, 0.8f, 0.8f, alpha);
 			teamName = &quot;Gaia&quot;;
 			ally   = &quot; &lt;Gaia&gt;&quot;;
@@ -273,7 +273,7 @@
 			int team=(int)((box.y1+teamBox.y2-my)/0.025f);
 			if(team&gt;=gu-&gt;myTeam)
 				team++;
-			if(team&lt;gs-&gt;activeTeams &amp;&amp; !gs-&gt;Team(team)-&gt;isDead)
+			if(team&lt;teamHandler-&gt;ActiveTeams() &amp;&amp; !teamHandler-&gt;Team(team)-&gt;isDead)
 				shareTeam=team;
 		}
 		return true;
@@ -290,14 +290,14 @@
 		shareUnits = !shareUnits;
 	}
 	if ((InBox(mx, my, box + okBox) || InBox(mx, my, box + applyBox)) &amp;&amp;
-			 shareTeam != -1 &amp;&amp; !gs-&gt;Team(shareTeam)-&gt;isDead &amp;&amp; !gs-&gt;Team(gu-&gt;myTeam)-&gt;isDead) {
+			 shareTeam != -1 &amp;&amp; !teamHandler-&gt;Team(shareTeam)-&gt;isDead &amp;&amp; !teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;isDead) {
 		if (shareUnits) {
 			Command c;
 			c.id = CMD_STOP;
 			// make sure the units are stopped and that the selection is transmitted
 			selectedUnits.GiveCommand(c, false);
 		}
-		net-&gt;Send(CBaseNetProtocol::Get().SendShare(gu-&gt;myPlayerNum, shareTeam, shareUnits, metalShare * gs-&gt;Team(gu-&gt;myTeam)-&gt;metal, energyShare * gs-&gt;Team(gu-&gt;myTeam)-&gt;energy));
+		net-&gt;Send(CBaseNetProtocol::Get().SendShare(gu-&gt;myPlayerNum, shareTeam, shareUnits, metalShare * teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;metal, energyShare * teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;energy));
 		if (shareUnits)
 			selectedUnits.ClearSelected();
 		lastShareTeam = shareTeam;
@@ -331,7 +331,7 @@
 		int team=(int)((box.y1+teamBox.y2-my)/0.025f);
 		if(team&gt;=gu-&gt;myTeam)
 			team++;
-		if(team&lt;gs-&gt;activeTeams &amp;&amp; !gs-&gt;Team(team)-&gt;isDead)
+		if(team&lt;teamHandler-&gt;ActiveTeams() &amp;&amp; !teamHandler-&gt;Team(team)-&gt;isDead)
 			shareTeam=team;
 	}
 }

Modified: branches/caiinterface/rts/Game/UI/StartPosSelecter.cpp
===================================================================
--- branches/caiinterface/rts/Game/UI/StartPosSelecter.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/UI/StartPosSelecter.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -6,7 +6,7 @@
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Rendering/glFont.h&quot;
 #include &quot;Game/GameSetup.h&quot;
-#include &quot;Game/Team.h&quot;
+#include &quot;Sim/Misc/Team.h&quot;
 #include &quot;NetProtocol.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Game/Camera.h&quot;

Modified: branches/caiinterface/rts/Game/UI/TooltipConsole.cpp
===================================================================
--- branches/caiinterface/rts/Game/UI/TooltipConsole.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/UI/TooltipConsole.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -5,8 +5,8 @@
 #include &quot;MouseHandler.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Rendering/glFont.h&quot;
-#include &quot;Game/Player.h&quot;
-#include &quot;Game/Team.h&quot;
+#include &quot;Game/PlayerHandler.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Map/MapDamage.h&quot;
 #include &quot;Map/MapInfo.h&quot;
@@ -18,9 +18,9 @@
 #include &quot;Sim/Misc/Wind.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
-#include &quot;System/EventHandler.h&quot;
-#include &quot;System/Platform/ConfigHandler.h&quot;
-#include &quot;System/Util.h&quot;
+#include &quot;EventHandler.h&quot;
+#include &quot;Platform/ConfigHandler.h&quot;
+#include &quot;Util.h&quot;
 
 CTooltipConsole* tooltip = 0;
 
@@ -190,7 +190,7 @@
 
 	std::string s;
 
-	const bool enemyUnit = (gs-&gt;AllyTeam(unit-&gt;team) != gu-&gt;myAllyTeam) &amp;&amp;
+	const bool enemyUnit = (teamHandler-&gt;AllyTeam(unit-&gt;team) != gu-&gt;myAllyTeam) &amp;&amp;
 	                       !gu-&gt;spectatingFullView;
 
 	const UnitDef* unitDef = unit-&gt;unitDef;
@@ -209,8 +209,8 @@
 
 	// show the player name instead of unit name if it has FBI tag showPlayerName
 	if (effectiveDef-&gt;showPlayerName) {
-		if (gs-&gt;Team(unit-&gt;team)-&gt;leader &gt;= 0) {
-			s = gs-&gt;players[gs-&gt;Team(unit-&gt;team)-&gt;leader]-&gt;name.c_str();
+		if (teamHandler-&gt;Team(unit-&gt;team)-&gt;leader &gt;= 0) {
+			s = playerHandler-&gt;Player(teamHandler-&gt;Team(unit-&gt;team)-&gt;leader)-&gt;name.c_str();
 		} else {
 			s = &quot;Uncontrolled&quot;;
 		}

Modified: branches/caiinterface/rts/Game/WaitCommandsAI.cpp
===================================================================
--- branches/caiinterface/rts/Game/WaitCommandsAI.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/WaitCommandsAI.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -8,8 +8,8 @@
 #include &lt;SDL_timer.h&gt;
 #include &quot;WaitCommandsAI.h&quot;
 #include &quot;SelectedUnits.h&quot;
-#include &quot;Team.h&quot;
-#include &quot;Game/GameHelper.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
+#include &quot;GameHelper.h&quot;
 #include &quot;Sim/Misc/QuadField.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
@@ -18,9 +18,9 @@
 #include &quot;Sim/Units/CommandAI/FactoryCAI.h&quot;
 #include &quot;Sim/Units/CommandAI/LineDrawer.h&quot;
 #include &quot;Sim/Units/UnitTypes/Factory.h&quot;
-#include &quot;Game/GlobalSynced.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
-#include &quot;System/Object.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
+#include &quot;Object.h&quot;
 #include &quot;UI/CommandColors.h&quot;
 #include &quot;UI/CursorIcons.h&quot;
 #include &quot;creg/STL_Map.h&quot;
@@ -897,7 +897,7 @@
 	const int count = (int)tmpUnits.size();
 	for (int i = 0; i &lt; count; i++) {
 		CUnit* unit = tmpUnits[i];
-		if (enemies &amp;&amp; gs-&gt;Ally(unit-&gt;allyteam, gu-&gt;myAllyTeam)) {
+		if (enemies &amp;&amp; teamHandler-&gt;Ally(unit-&gt;allyteam, gu-&gt;myAllyTeam)) {
 			continue;
 		}
 		if (!(unit-&gt;losStatus[gu-&gt;myAllyTeam] &amp; (LOS_INLOS | LOS_INRADAR))) {

Modified: branches/caiinterface/rts/Game/WaitCommandsAI.h
===================================================================
--- branches/caiinterface/rts/Game/WaitCommandsAI.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Game/WaitCommandsAI.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -9,7 +9,7 @@
 #include &lt;set&gt;
 #include &lt;deque&gt;
 #include &lt;string&gt;
-#include &quot;System/Object.h&quot;
+#include &quot;Object.h&quot;
 #include &quot;Sim/Units/UnitSet.h&quot;
 
 class float3;

Modified: branches/caiinterface/rts/Lua/LuaCallInCheck.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaCallInCheck.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Lua/LuaCallInCheck.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -6,7 +6,7 @@
 
 #include &quot;LuaCallInCheck.h&quot;
 #include &quot;LuaInclude.h&quot;
-#include &quot;System/LogOutput.h&quot;
+#include &quot;LogOutput.h&quot;
 
 
 /******************************************************************************/

Modified: branches/caiinterface/rts/Lua/LuaConstGame.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaConstGame.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Lua/LuaConstGame.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -16,14 +16,14 @@
 #include &quot;Map/MapInfo.h&quot;
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
-#include &quot;Sim/ModInfo.h&quot;
+#include &quot;Sim/Misc/ModInfo.h&quot;
 #include &quot;Sim/Misc/CategoryHandler.h&quot;
 #include &quot;Sim/Misc/DamageArrayHandler.h&quot;
 #include &quot;Sim/Misc/Wind.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot; // MAX_UNITS
 #include &quot;Sim/Units/CommandAI/Command.h&quot;
-#include &quot;System/FileSystem/ArchiveScanner.h&quot;
-#include &quot;System/Util.h&quot;
+#include &quot;FileSystem/ArchiveScanner.h&quot;
+#include &quot;Util.h&quot;
 
 
 /******************************************************************************/
@@ -57,7 +57,7 @@
 	lua_pushlstring(L, (const char*)game-&gt;gameID, sizeof(game-&gt;gameID));
 	lua_rawset(L, -3);
 
-	LuaPushNamedString(L, &quot;version&quot;,       VERSION_STRING_DETAILED);
+	LuaPushNamedString(L, &quot;version&quot;,       SpringVersion::GetFull());
 
 	LuaPushNamedNumber(L, &quot;maxUnits&quot;,      MAX_UNITS);
 	LuaPushNamedNumber(L, &quot;maxTeams&quot;,      MAX_TEAMS);

Modified: branches/caiinterface/rts/Lua/LuaFBOs.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaFBOs.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Lua/LuaFBOs.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -20,7 +20,7 @@
 #include &quot;LuaTextures.h&quot;
 
 #include &quot;Rendering/GL/myGL.h&quot;
-#include &quot;System/LogOutput.h&quot;
+#include &quot;LogOutput.h&quot;
 
 
 /******************************************************************************/

Modified: branches/caiinterface/rts/Lua/LuaFeatureDefs.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaFeatureDefs.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Lua/LuaFeatureDefs.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -16,15 +16,15 @@
 
 #include &quot;LuaInclude.h&quot;
 
-#include &quot;Game/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
 #include &quot;LuaDefs.h&quot;
 #include &quot;LuaHandle.h&quot;
 #include &quot;LuaUtils.h&quot;
 #include &quot;Sim/Features/Feature.h&quot;
 #include &quot;Sim/Features/FeatureHandler.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/FileSystem/FileHandler.h&quot;
-#include &quot;System/Platform/FileSystem.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;FileSystem/FileHandler.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 
 using namespace std;
 

Modified: branches/caiinterface/rts/Lua/LuaGaia.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaGaia.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Lua/LuaGaia.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -19,16 +19,17 @@
 #include &quot;LuaWeaponDefs.h&quot;
 #include &quot;LuaOpenGL.h&quot;
 
-#include &quot;Game/GlobalSynced.h&quot;
-#include &quot;Sim/Units/CommandAI/Command.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Rendering/UnitModels/UnitDrawer.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/FileSystem/FileHandler.h&quot;
-#include &quot;System/Platform/FileSystem.h&quot;
-#include &quot;System/Util.h&quot;
+#include &quot;Sim/Units/CommandAI/Command.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;FileSystem/FileHandler.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
+#include &quot;Util.h&quot;
 
 
 CLuaGaia* luaGaia = NULL;
@@ -88,10 +89,10 @@
 
 	fullCtrl = false;
 	fullRead = false;
-	ctrlTeam = gs-&gt;gaiaTeamID;
-	readTeam = gs-&gt;gaiaTeamID;
-	readAllyTeam = gs-&gt;gaiaAllyTeamID;
-	selectTeam = gs-&gt;gaiaTeamID;
+	ctrlTeam = teamHandler-&gt;GaiaTeamID();
+	readTeam = teamHandler-&gt;GaiaTeamID();
+	readAllyTeam = teamHandler-&gt;GaiaAllyTeamID();
+	selectTeam = teamHandler-&gt;GaiaTeamID();
 
 	Init(LuaGaiaSyncedFilename, LuaGaiaUnsyncedFilename, SPRING_VFS_MAP);
 }

Modified: branches/caiinterface/rts/Lua/LuaHandle.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaHandle.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Lua/LuaHandle.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -13,31 +13,32 @@
 #include &quot;LuaHandle.h&quot;
 
 #include &quot;Game/UI/LuaUI.h&quot;
-#include &quot;Lua/LuaGaia.h&quot;
-#include &quot;Lua/LuaRules.h&quot;
+#include &quot;LuaGaia.h&quot;
+#include &quot;LuaRules.h&quot;
 
 #include &quot;LuaCallInCheck.h&quot;
 #include &quot;LuaHashString.h&quot;
 #include &quot;LuaOpenGL.h&quot;
 #include &quot;LuaBitOps.h&quot;
 #include &quot;LuaUtils.h&quot;
-#include &quot;Game/Player.h&quot;
+#include &quot;Game/PlayerHandler.h&quot;
 #include &quot;Game/UI/KeyCodes.h&quot;
 #include &quot;Game/UI/KeySet.h&quot;
 #include &quot;Game/UI/KeyBindings.h&quot;
 #include &quot;Game/UI/MiniMap.h&quot;
-#include &quot;Game/GlobalSynced.h&quot;
 #include &quot;Rendering/InMapDraw.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Rendering/UnitModels/UnitDrawer.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Projectiles/Projectile.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;Sim/Weapons/Weapon.h&quot;
-#include &quot;System/EventHandler.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/SpringApp.h&quot;
-#include &quot;System/FileSystem/FileHandler.h&quot;
+#include &quot;EventHandler.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;SpringApp.h&quot;
+#include &quot;FileSystem/FileHandler.h&quot;
 
 #include &quot;LuaInclude.h&quot;
 
@@ -176,9 +177,8 @@
 
 void CLuaHandle::CheckStack()
 {
-#if defined(USE_GML) &amp;&amp; GML_ENABLE_SIMDRAW // Add mutex to avoid bogus errors due to concurrency
-	LUA_CALL_IN_CHECK(L);
-#endif
+	GML_RECMUTEX_LOCK(lua); // Add mutex to avoid bogus errors due to concurrency
+
 	const int top = lua_gettop(L);
 	if (top != 0) {
 		logOutput.Print(&quot;WARNING: %s stack check: top = %i\n&quot;, GetName().c_str(), top);
@@ -1079,7 +1079,7 @@
 				sendMsg = gu-&gt;spectating;
 			}
 			else if (mode == 'a') {
-				const CPlayer* player = gs-&gt;players[playerID];
+				const CPlayer* player = playerHandler-&gt;Player(playerID);
 				if (player == NULL) {
 					return;
 				}
@@ -1089,8 +1089,8 @@
 				else if (player-&gt;spectator) {
 					sendMsg = gu-&gt;spectating;
 				} else {
-					const int msgAllyTeam = gs-&gt;AllyTeam(player-&gt;team);
-					sendMsg = gs-&gt;Ally(msgAllyTeam, gu-&gt;myAllyTeam);
+					const int msgAllyTeam = teamHandler-&gt;AllyTeam(player-&gt;team);
+					sendMsg = teamHandler-&gt;Ally(msgAllyTeam, gu-&gt;myAllyTeam);
 				}
 			}
 			if (sendMsg) {

Modified: branches/caiinterface/rts/Lua/LuaHandle.h
===================================================================
--- branches/caiinterface/rts/Lua/LuaHandle.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Lua/LuaHandle.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -11,7 +11,7 @@
 using std::vector;
 using std::set;
 
-#include &quot;System/EventClient.h&quot;
+#include &quot;EventClient.h&quot;
 //FIXME#include &quot;LuaArrays.h&quot;
 #include &quot;LuaShaders.h&quot;
 #include &quot;LuaTextures.h&quot;

Modified: branches/caiinterface/rts/Lua/LuaHandleSynced.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaHandleSynced.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Lua/LuaHandleSynced.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -32,18 +32,19 @@
 #include &quot;LuaOpenGL.h&quot;
 #include &quot;LuaVFS.h&quot;
 
-#include &quot;Sim/Units/CommandAI/Command.h&quot;
 #include &quot;Game/Game.h&quot;
 #include &quot;Game/WordCompletion.h&quot;
-#include &quot;Game/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
+#include &quot;Sim/Units/CommandAI/Command.h&quot;
 #include &quot;Sim/Units/COB/CobInstance.h&quot;
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
-#include &quot;System/EventHandler.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/FileSystem/FileHandler.h&quot;
-#include &quot;System/Platform/FileSystem.h&quot;
+#include &quot;EventHandler.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;FileSystem/FileHandler.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 
 
 static const LuaHashString unsyncedStr(&quot;UNSYNCED&quot;);
@@ -1014,7 +1015,7 @@
 	// parse the new access
 	if (lua_isnumber(L, 1)) {
 		const int teamID = lua_toint(L, 1);
-		if ((teamID &lt; MinSpecialTeam) || (teamID &gt;= gs-&gt;activeTeams)) {
+		if ((teamID &lt; MinSpecialTeam) || (teamID &gt;= teamHandler-&gt;ActiveTeams())) {
 			luaL_error(L, &quot;Bad teamID in SetCtrlTeam&quot;);
 		}
 		// ctrl
@@ -1022,7 +1023,7 @@
 		lhs-&gt;fullCtrl = (lhs-&gt;ctrlTeam == CEventClient::AllAccessTeam);
 		// read
 		lhs-&gt;readTeam = teamID;
-		lhs-&gt;readAllyTeam = (teamID &lt; 0) ? teamID : gs-&gt;AllyTeam(teamID);
+		lhs-&gt;readAllyTeam = (teamID &lt; 0) ? teamID : teamHandler-&gt;AllyTeam(teamID);
 		lhs-&gt;fullRead = (lhs-&gt;readAllyTeam == CEventClient::AllAccessTeam);
 		activeFullRead     = lhs-&gt;fullRead;
 		activeReadAllyTeam = lhs-&gt;readAllyTeam;
@@ -1037,7 +1038,7 @@
 			}
 			const string key = lua_tostring(L, -2);
 			const int teamID = lua_toint(L, -1);
-			if ((teamID &lt; MinSpecialTeam) || (teamID &gt;= gs-&gt;activeTeams)) {
+			if ((teamID &lt; MinSpecialTeam) || (teamID &gt;= teamHandler-&gt;ActiveTeams())) {
 				luaL_error(L, &quot;Bad teamID in SetCtrlTeam&quot;);
 			}
 
@@ -1047,7 +1048,7 @@
 			}
 			else if (key == &quot;read&quot;) {
 				lhs-&gt;readTeam = teamID;
-				lhs-&gt;readAllyTeam = (teamID &lt; 0) ? teamID : gs-&gt;AllyTeam(teamID);
+				lhs-&gt;readAllyTeam = (teamID &lt; 0) ? teamID : teamHandler-&gt;AllyTeam(teamID);
 				lhs-&gt;fullRead = (lhs-&gt;readAllyTeam == CEventClient::AllAccessTeam);
 				activeFullRead     = lhs-&gt;fullRead;
 				activeReadAllyTeam = lhs-&gt;readAllyTeam;

Modified: branches/caiinterface/rts/Lua/LuaIO.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaIO.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Lua/LuaIO.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -21,8 +21,8 @@
 #include &quot;LuaHandle.h&quot;
 #endif
 #include &quot;LuaInclude.h&quot;
-#include &quot;System/Platform/FileSystem.h&quot;
-#include &quot;System/Util.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
+#include &quot;Util.h&quot;
 
 
 /******************************************************************************/
@@ -89,9 +89,6 @@
 
 FILE* LuaIO::fopen(lua_State* L, const char* path, const char* mode)
 {
-	bool read  = false;
-	bool write = false;
-
 	// check the mode string
 	const string modeStr = StringToLower(mode);
 	if (modeStr.find_first_not_of(&quot;rwabt+&quot;) != string::npos) {
@@ -114,14 +111,14 @@
 		errno = EINVAL;
 		return NULL;
 	}
-	errno = EINVAL;	
+	errno = EINVAL;
 	return NULL;
 }
 
 
 int LuaIO::pclose(lua_State* L, FILE* stream)
 {
-	errno = ECHILD;	
+	errno = ECHILD;
 	return -1;
 }
 

Modified: branches/caiinterface/rts/Lua/LuaInputReceiver.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaInputReceiver.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Lua/LuaInputReceiver.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -8,7 +8,7 @@
 #include &quot;mmgr.h&quot;
 
 #include &quot;LuaInputReceiver.h&quot;
-#include &quot;System/EventHandler.h&quot;
+#include &quot;EventHandler.h&quot;
 
 
 LuaInputReceiver* luaInputReceiver = NULL;

Modified: branches/caiinterface/rts/Lua/LuaMaterial.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaMaterial.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Lua/LuaMaterial.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -23,8 +23,8 @@
 #include &quot;Rendering/ShadowHandler.h&quot;
 #include &quot;Rendering/UnitModels/UnitDrawer.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/Util.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;Util.h&quot;
 
 
 LuaMatHandler LuaMatHandler::handler;

Modified: branches/caiinterface/rts/Lua/LuaOpenGL.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaOpenGL.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Lua/LuaOpenGL.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -53,6 +53,7 @@
 #include &quot;Sim/Features/Feature.h&quot;
 #include &quot;Sim/Features/FeatureHandler.h&quot;
 #include &quot;Sim/Misc/LosHandler.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;Sim/Units/UnitDefHandler.h&quot;
@@ -60,9 +61,9 @@
 #include &quot;Sim/Units/UnitHandler.h&quot;
 #include &quot;Sim/Units/UnitTypes/TransportUnit.h&quot;
 #include &quot;Sim/Units/CommandAI/LineDrawer.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/Matrix44f.h&quot;
-#include &quot;System/Platform/ConfigHandler.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;Matrix44f.h&quot;
+#include &quot;Platform/ConfigHandler.h&quot;
 
 using std::max;
 using std::string;
@@ -1407,7 +1408,7 @@
 	const int fullSize = (order * dataSize);
 	float* points = SAFE_NEW float[fullSize];
 	if (ParseFloatArray(L, points, fullSize) == fullSize) {
-		glMap1f(target, u1, u2, stride, order, points);	
+		glMap1f(target, u1, u2, stride, order, points);
 	}
 	delete[] points;
 	return 0;
@@ -1441,9 +1442,9 @@
 	}
 	const int fullSize = (uorder * vorder * dataSize);
 	float* points = SAFE_NEW float[fullSize];
-	if (ParseFloatArray(L, points, fullSize) == fullSize) {			
+	if (ParseFloatArray(L, points, fullSize) == fullSize) {
 		glMap2f(target, u1, u2, ustride, uorder,
-										v1, v2, vstride, vorder, points);	
+										v1, v2, vstride, vorder, points);
 	}
 	delete[] points;
 	return 0;
@@ -1565,7 +1566,7 @@
 			return NULL;
 		}
 	} else {
-		if (!gs-&gt;Ally(readAllyTeam, unit-&gt;allyteam) &amp;&amp;
+		if (!teamHandler-&gt;Ally(readAllyTeam, unit-&gt;allyteam) &amp;&amp;
 		    !(unit-&gt;losStatus[readAllyTeam] &amp; LOS_INLOS)) {
 			return NULL;
 		}
@@ -4499,7 +4500,7 @@
 		array[0] = (GLfloat)luaL_checknumber(L, 3);
 		array[1] = (GLfloat)luaL_checknumber(L, 4);
 		array[2] = (GLfloat)luaL_checknumber(L, 5);
-		array[3] = (GLfloat)luaL_checknumber(L, 5);
+		array[3] = (GLfloat)luaL_checknumber(L, 6);
 		glLightfv(light, pname, array);
 	}
 	else {
@@ -5080,7 +5081,7 @@
 	if ((xsize &lt;= 0) || (ysize &lt;= 0)) {
 		return 0;
 	}
-	const int memsize = xsize * ysize * 4;	
+	const int memsize = xsize * ysize * 4;
 
 	unsigned char* img = SAFE_NEW unsigned char[memsize];
 	memset(img, 0, memsize);

Modified: branches/caiinterface/rts/Lua/LuaParser.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaParser.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Lua/LuaParser.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -19,12 +19,12 @@
 
 #include &quot;Game/GameSetup.h&quot;
 
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/FileSystem/FileHandler.h&quot;
-#include &quot;System/FileSystem/VFSHandler.h&quot;
-#include &quot;System/Platform/FileSystem.h&quot;
-#include &quot;System/Platform/errorhandler.h&quot;
-#include &quot;System/Util.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;FileSystem/FileHandler.h&quot;
+#include &quot;FileSystem/VFSHandler.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
+#include &quot;Platform/errorhandler.h&quot;
+#include &quot;Util.h&quot;
 
 
 #if (LUA_VERSION_NUM &lt; 500)

Modified: branches/caiinterface/rts/Lua/LuaParser.h
===================================================================
--- branches/caiinterface/rts/Lua/LuaParser.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Lua/LuaParser.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -13,8 +13,8 @@
 using std::map;
 using std::set;
 
-#include &quot;System/float3.h&quot;
-#include &quot;System/FileSystem/VFSModes.h&quot;
+#include &quot;float3.h&quot;
+#include &quot;FileSystem/VFSModes.h&quot;
 
 
 class LuaTable;

Modified: branches/caiinterface/rts/Lua/LuaRBOs.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaRBOs.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Lua/LuaRBOs.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -14,7 +14,7 @@
 #include &quot;LuaUtils.h&quot;
 
 #include &quot;Rendering/GL/myGL.h&quot;
-#include &quot;System/LogOutput.h&quot;
+#include &quot;LogOutput.h&quot;
 
 
 /******************************************************************************/

Modified: branches/caiinterface/rts/Lua/LuaRules.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaRules.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Lua/LuaRules.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -24,8 +24,6 @@
 
 #include &quot;Sim/Units/CommandAI/Command.h&quot;
 #include &quot;Game/Game.h&quot;
-#include &quot;Game/Team.h&quot;
-#include &quot;Game/GlobalSynced.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Rendering/UnitModels/UnitDrawer.h&quot;
 #include &quot;Rendering/UnitModels/3DModelParser.h&quot;
@@ -33,13 +31,15 @@
 #include &quot;Rendering/UnitModels/s3oParser.h&quot;
 #include &quot;Sim/Features/Feature.h&quot;
 #include &quot;Sim/Features/FeatureDef.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
 #include &quot;Sim/Units/COB/CobInstance.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/FileSystem/FileHandler.h&quot;
-#include &quot;System/Platform/FileSystem.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;FileSystem/FileHandler.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &lt;assert.h&gt;
 
 CLuaRules* luaRules = NULL;
@@ -138,7 +138,7 @@
 {
 	if (L != NULL) {
 		Shutdown();
-		KillLua();		
+		KillLua();
 	}
 	luaRules = NULL;
 
@@ -849,8 +849,8 @@
 	lua_pop(L, 1);
 	return retval;
 }
-	
 
+
 const char* CLuaRules::AICallIn(const char* data, int inSize, int* outSize)
 {
 	if (!haveAICallIn) {
@@ -889,8 +889,8 @@
 	}
 
 	lua_pop(L, 1);
-	
-	return outData;	
+
+	return outData;
 }
 
 
@@ -1166,7 +1166,7 @@
 	if ((teamID &lt; 0) || (teamID &gt;= MAX_TEAMS)) {
 		luaL_error(L, &quot;%s(): Bad teamID: %i\n&quot;, teamID);
 	}
-	CTeam* team = gs-&gt;Team(teamID);
+	CTeam* team = teamHandler-&gt;Team(teamID);
 	if (team == NULL) {
 		return NULL;
 	}

Modified: branches/caiinterface/rts/Lua/LuaScream.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaScream.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Lua/LuaScream.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -11,7 +11,7 @@
 
 #include &quot;LuaHashString.h&quot;
 
-#include &quot;System/LogOutput.h&quot;
+#include &quot;LogOutput.h&quot;
 
 
 /******************************************************************************/

Modified: branches/caiinterface/rts/Lua/LuaShaders.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaShaders.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Lua/LuaShaders.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -21,8 +21,8 @@
 #include &quot;Game/Camera.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Rendering/ShadowHandler.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/Util.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;Util.h&quot;
 
 
 int LuaShaders::activeShaderDepth = 0;

Modified: branches/caiinterface/rts/Lua/LuaSyncedCall.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaSyncedCall.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Lua/LuaSyncedCall.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -20,7 +20,7 @@
 #include &quot;LuaRules.h&quot;
 #include &quot;LuaHashString.h&quot;
 #include &quot;LuaUtils.h&quot;
-#include &quot;System/LogOutput.h&quot;
+#include &quot;LogOutput.h&quot;
 
 
 /******************************************************************************/

Modified: branches/caiinterface/rts/Lua/LuaSyncedCtrl.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaSyncedCtrl.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Lua/LuaSyncedCtrl.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -19,13 +19,13 @@
 #include &quot;LuaSyncedMoveCtrl.h&quot;
 #include &quot;LuaUtils.h&quot;
 #include &quot;ExternalAI/GlobalAIHandler.h&quot;
-#include &quot;Sim/Units/CommandAI/Command.h&quot;
 #include &quot;Game/Game.h&quot;
 #include &quot;Game/GameServer.h&quot;
 #include &quot;Game/Camera.h&quot;
 #include &quot;Game/GameHelper.h&quot;
+#include &quot;Game/PlayerHandler.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
-#include &quot;Game/Team.h&quot;
+#include &quot;Sim/Misc/Team.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Map/MapDamage.h&quot;
 #include &quot;Map/ReadMap.h&quot;
@@ -37,6 +37,7 @@
 #include &quot;Sim/Misc/CollisionVolume.h&quot;
 #include &quot;Sim/Misc/DamageArray.h&quot;
 #include &quot;Sim/Misc/LosHandler.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Misc/QuadField.h&quot;
 #include &quot;Sim/MoveTypes/AirMoveType.h&quot;
 #include &quot;Sim/MoveTypes/TAAirMoveType.h&quot;
@@ -52,6 +53,7 @@
 #include &quot;Sim/Units/UnitTypes/Builder.h&quot;
 #include &quot;Sim/Units/UnitTypes/Factory.h&quot;
 #include &quot;Sim/Units/UnitTypes/TransportUnit.h&quot;
+#include &quot;Sim/Units/CommandAI/Command.h&quot;
 #include &quot;Sim/Units/CommandAI/CommandAI.h&quot;
 #include &quot;Sim/Units/CommandAI/FactoryCAI.h&quot;
 #include &quot;Sim/Units/CommandAI/LineDrawer.h&quot;
@@ -59,8 +61,8 @@
 #include &quot;Sim/Weapons/PlasmaRepulser.h&quot;
 #include &quot;Sim/Weapons/Weapon.h&quot;
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
-#include &quot;System/myMath.h&quot;
-#include &quot;System/LogOutput.h&quot;
+#include &quot;myMath.h&quot;
+#include &quot;LogOutput.h&quot;
 
 using namespace std;
 
@@ -239,7 +241,7 @@
 	if (ctrlTeam &lt; 0) {
 		return ctrlTeam;
 	}
-	return gs-&gt;AllyTeam(ctrlTeam);
+	return teamHandler-&gt;AllyTeam(ctrlTeam);
 }
 
 
@@ -259,7 +261,7 @@
 	if (ctrlTeam &lt; 0) {
 		return (ctrlTeam == CEventClient::AllAccessTeam) ? true : false;
 	}
-	return (gs-&gt;AllyTeam(ctrlTeam) == allyTeamID);
+	return (teamHandler-&gt;AllyTeam(ctrlTeam) == allyTeamID);
 }
 
 
@@ -280,9 +282,9 @@
 		return (ctrlTeam == CEventClient::AllAccessTeam) ? true : false;
 	}
 	if (allyTeamID &lt; 0) {
-		return (ctrlTeam == gs-&gt;gaiaTeamID);
+		return (ctrlTeam == teamHandler-&gt;GaiaTeamID());
 	}
-	return (gs-&gt;AllyTeam(ctrlTeam) == allyTeamID);
+	return (teamHandler-&gt;AllyTeam(ctrlTeam) == allyTeamID);
 }
 
 
@@ -301,7 +303,7 @@
 	if (allyTeamID &lt; 0) {
 		return false;
 	}
-	return (gs-&gt;AllyTeam(ctrlTeam) == allyTeamID);
+	return (teamHandler-&gt;AllyTeam(ctrlTeam) == allyTeamID);
 }
 
 
@@ -385,10 +387,10 @@
 		return NULL;
 	}
 	const int teamID = lua_toint(L, index);
-	if ((teamID &lt; 0) || (teamID &gt;= gs-&gt;activeTeams)) {
+	if ((teamID &lt; 0) || (teamID &gt;= teamHandler-&gt;ActiveTeams())) {
 		luaL_error(L, &quot;%s(): Bad teamID: %d&quot;, caller, teamID);
 	}
-	CTeam* team = gs-&gt;Team(teamID);
+	CTeam* team = teamHandler-&gt;Team(teamID);
 	if (team == NULL) {
 		return NULL;
 	}
@@ -418,7 +420,7 @@
 	if ((playerID &lt; 0) || (playerID &gt;= MAX_PLAYERS)) {
 		luaL_error(L, &quot;Bad playerID: %d\n&quot;, playerID);
 	}
-	CPlayer* player = gs-&gt;players[playerID];
+	CPlayer* player = playerHandler-&gt;Player(playerID);
 	if (player == NULL) {
 		luaL_error(L, &quot;Bad playerID: %d\n&quot;, playerID);
 	}
@@ -479,13 +481,13 @@
 int LuaSyncedCtrl::AddTeamResource(lua_State* L)
 {
 	const int teamID = luaL_checkint(L, 1);
-	if ((teamID &lt; 0) || (teamID &gt;= gs-&gt;activeTeams)) {
+	if ((teamID &lt; 0) || (teamID &gt;= teamHandler-&gt;ActiveTeams())) {
 		return 0;
 	}
 	if (!CanControlTeam(teamID)) {
 		return 0;
 	}
-	CTeam* team = gs-&gt;Team(teamID);
+	CTeam* team = teamHandler-&gt;Team(teamID);
 	if (team == NULL) {
 		return 0;
 	}
@@ -507,13 +509,13 @@
 int LuaSyncedCtrl::UseTeamResource(lua_State* L)
 {
 	const int teamID = luaL_checkint(L, 1);
-	if ((teamID &lt; 0) || (teamID &gt;= gs-&gt;activeTeams)) {
+	if ((teamID &lt; 0) || (teamID &gt;= teamHandler-&gt;ActiveTeams())) {
 		return 0;
 	}
 	if (!CanControlTeam(teamID)) {
 		return 0;
 	}
-	CTeam* team = gs-&gt;Team(teamID);
+	CTeam* team = teamHandler-&gt;Team(teamID);
 	if (team == NULL) {
 		return 0;
 	}
@@ -570,13 +572,13 @@
 int LuaSyncedCtrl::SetTeamResource(lua_State* L)
 {
 	const int teamID = luaL_checkint(L, 1);
-	if ((teamID &lt; 0) || (teamID &gt;= gs-&gt;activeTeams)) {
+	if ((teamID &lt; 0) || (teamID &gt;= teamHandler-&gt;ActiveTeams())) {
 		return 0;
 	}
 	if (!CanControlTeam(teamID)) {
 		return 0;
 	}
-	CTeam* team = gs-&gt;Team(teamID);
+	CTeam* team = teamHandler-&gt;Team(teamID);
 	if (team == NULL) {
 		return 0;
 	}
@@ -606,13 +608,13 @@
 int LuaSyncedCtrl::SetTeamShareLevel(lua_State* L)
 {
 	const int teamID = luaL_checkint(L, 1);
-	if ((teamID &lt; 0) || (teamID &gt;= gs-&gt;activeTeams)) {
+	if ((teamID &lt; 0) || (teamID &gt;= teamHandler-&gt;ActiveTeams())) {
 		return 0;
 	}
 	if (!CanControlTeam(teamID)) {
 		return 0;
 	}
-	CTeam* team = gs-&gt;Team(teamID);
+	CTeam* team = teamHandler-&gt;Team(teamID);
 	if (team == NULL) {
 		return 0;
 	}
@@ -892,7 +894,7 @@
 		luaL_error(L, &quot;CreateUnit(): bad team number: %d&quot;, teamID);
 	}
 
-	if (gs-&gt;AllyTeam(teamID) &gt;= gs-&gt;activeAllyTeams) {
+	if (teamHandler-&gt;AllyTeam(teamID) &gt;= teamHandler-&gt;ActiveAllyTeams()) {
 		// FIXME: there's a segv in CLosHandler::LosAddAir,
 		//        this is a dirty hack to avoid it
 		luaL_error(L, &quot;CreateUnit(): inactive team: %d&quot;, teamID);
@@ -974,10 +976,10 @@
 	}
 
 	const int newTeam = luaL_checkint(L, 2);
-	if ((newTeam &lt; 0) || (newTeam &gt;= gs-&gt;activeTeams)) {
+	if ((newTeam &lt; 0) || (newTeam &gt;= teamHandler-&gt;ActiveTeams())) {
 		return 0;
 	}
-	const CTeam* team = gs-&gt;Team(newTeam);
+	const CTeam* team = teamHandler-&gt;Team(newTeam);
 	if (team == NULL) {
 		return 0;
 	}
@@ -2008,7 +2010,7 @@
 				}
 			}
 		}
-		CTeam* team = gs-&gt;Team(unit-&gt;team);
+		CTeam* team = teamHandler-&gt;Team(unit-&gt;team);
 		if ((team-&gt;metal &gt;= metal) &amp;&amp; (team-&gt;energy &gt;= energy)) {
 			unit-&gt;UseMetal(metal);
 			unit-&gt;UseEnergy(energy);
@@ -2083,7 +2085,7 @@
 		}
 	}
 
-	const int allyTeam = (team &lt; 0) ? -1 : gs-&gt;AllyTeam(team);
+	const int allyTeam = (team &lt; 0) ? -1 : teamHandler-&gt;AllyTeam(team);
 	if (!CanControlFeatureAllyTeam(allyTeam)) {
 		luaL_error(L, &quot;CreateFeature() bad team permission %d&quot;, team);
 	}

Modified: branches/caiinterface/rts/Lua/LuaSyncedMoveCtrl.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaSyncedMoveCtrl.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Lua/LuaSyncedMoveCtrl.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -19,8 +19,8 @@
 #include &quot;Sim/MoveTypes/ScriptMoveType.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
-#include &quot;System/myMath.h&quot;
-#include &quot;System/LogOutput.h&quot;
+#include &quot;myMath.h&quot;
+#include &quot;LogOutput.h&quot;
 
 using namespace std;
 

Modified: branches/caiinterface/rts/Lua/LuaSyncedRead.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaSyncedRead.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Lua/LuaSyncedRead.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -20,13 +20,11 @@
 #include &quot;LuaRules.h&quot;
 #include &quot;LuaUtils.h&quot;
 #include &quot;ExternalAI/EngineOutHandler.h&quot;
-#include &quot;Sim/Units/CommandAI/Command.h&quot;
 #include &quot;Game/Game.h&quot;
 #include &quot;Game/GameSetup.h&quot;
 #include &quot;Game/Camera.h&quot;
 #include &quot;Game/GameHelper.h&quot;
-#include &quot;Game/Team.h&quot;
-#include &quot;Game/Player.h&quot;
+#include &quot;Game/PlayerHandler.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Map/MapDamage.h&quot;
 #include &quot;Map/MapInfo.h&quot;
@@ -35,12 +33,13 @@
 #include &quot;Rendering/UnitModels/3DModelParser.h&quot;
 #include &quot;Rendering/UnitModels/3DOParser.h&quot;
 #include &quot;Rendering/UnitModels/s3oParser.h&quot;
-#include &quot;Sim/SideParser.h&quot;
+#include &quot;Sim/Misc/SideParser.h&quot;
 #include &quot;Sim/Features/Feature.h&quot;
 #include &quot;Sim/Features/FeatureHandler.h&quot;
 #include &quot;Sim/Misc/GroundBlockingObjectMap.h&quot;
 #include &quot;Sim/Misc/LosHandler.h&quot;
 #include &quot;Sim/Misc/QuadField.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Misc/Wind.h&quot;
 #include &quot;Sim/MoveTypes/AirMoveType.h&quot;
 #include &quot;Sim/MoveTypes/GroundMoveType.h&quot;
@@ -57,18 +56,19 @@
 #include &quot;Sim/Units/UnitTypes/Builder.h&quot;
 #include &quot;Sim/Units/UnitTypes/Factory.h&quot;
 #include &quot;Sim/Units/UnitTypes/TransportUnit.h&quot;
+#include &quot;Sim/Units/CommandAI/Command.h&quot;
 #include &quot;Sim/Units/CommandAI/CommandAI.h&quot;
 #include &quot;Sim/Units/CommandAI/FactoryCAI.h&quot;
 #include &quot;Sim/Units/CommandAI/LineDrawer.h&quot;
 #include &quot;Sim/Weapons/PlasmaRepulser.h&quot;
 #include &quot;Sim/Weapons/Weapon.h&quot;
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
-#include &quot;System/myMath.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/FileSystem/FileHandler.h&quot;
-#include &quot;System/FileSystem/VFSHandler.h&quot;
-#include &quot;System/Platform/FileSystem.h&quot;
-#include &quot;System/Util.h&quot;
+#include &quot;myMath.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;FileSystem/FileHandler.h&quot;
+#include &quot;FileSystem/VFSHandler.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
+#include &quot;Util.h&quot;
 
 using namespace std;
 
@@ -304,7 +304,7 @@
 	if (readAllyTeam &lt; 0) {
 		return fullRead;
 	}
-	return (gs-&gt;AllyTeam(team) == readAllyTeam);
+	return (teamHandler-&gt;AllyTeam(team) == readAllyTeam);
 }
 
 
@@ -463,7 +463,7 @@
 	if ((playerID &lt; 0) || (playerID &gt;= MAX_PLAYERS)) {
 		luaL_error(L, &quot;Bad playerID in %s\n&quot;, caller);
 	}
-	CPlayer* player = gs-&gt;players[playerID];
+	CPlayer* player = playerHandler-&gt;Player(playerID);
 	if (player == NULL) {
 		luaL_error(L, &quot;Bad player in %s\n&quot;, caller);
 	}
@@ -480,7 +480,7 @@
 	if ((teamID &lt; 0) || (teamID &gt;= MAX_TEAMS)) {
 		luaL_error(L, &quot;Bad teamID in %s\n&quot;, caller);
 	}
-	return gs-&gt;Team(teamID);
+	return teamHandler-&gt;Team(teamID);
 }
 
 
@@ -493,7 +493,7 @@
 	if ((teamID &lt; 0) || (teamID &gt;= MAX_TEAMS)) {
 		luaL_error(L, &quot;Bad teamID in %s\n&quot;, caller);
 	}
-	CTeam* team = gs-&gt;Team(teamID);
+	CTeam* team = teamHandler-&gt;Team(teamID);
 	if (team == NULL) {
 		luaL_error(L, &quot;Bad teamID in %s\n&quot;, caller);
 	}
@@ -661,7 +661,7 @@
 	if (!gs-&gt;useLuaGaia) {
 		return 0;
 	}
-	lua_pushnumber(L, gs-&gt;gaiaTeamID);
+	lua_pushnumber(L, teamHandler-&gt;GaiaTeamID());
 	return 1;
 }
 
@@ -911,7 +911,7 @@
 	CheckNoArgs(L, __FUNCTION__);
 	lua_newtable(L);
 	int count = 0;
-	for (int at = 0; at &lt; gs-&gt;activeAllyTeams; at++) {
+	for (int at = 0; at &lt; teamHandler-&gt;ActiveAllyTeams(); at++) {
 		count++;
 		lua_pushnumber(L, count);
 		lua_pushnumber(L, at);
@@ -932,18 +932,18 @@
 	int allyTeamID = -1;
 	if (args == 1) {
 		allyTeamID = lua_toint(L, 1);
-		if ((allyTeamID &lt; 0) || (allyTeamID &gt;= gs-&gt;activeAllyTeams)) {
+		if ((allyTeamID &lt; 0) || (allyTeamID &gt;= teamHandler-&gt;ActiveAllyTeams())) {
 			return 0;
 		}
 	}
 
 	lua_newtable(L);
 	int count = 0;
-	for (int t = 0; t &lt; gs-&gt;activeTeams; t++) {
-		if (gs-&gt;Team(t) == NULL) {
+	for (int t = 0; t &lt; teamHandler-&gt;ActiveTeams(); t++) {
+		if (teamHandler-&gt;Team(t) == NULL) {
 			continue;
 		}
-		if ((allyTeamID &lt; 0) || (allyTeamID == gs-&gt;AllyTeam(t))) {
+		if ((allyTeamID &lt; 0) || (allyTeamID == teamHandler-&gt;AllyTeam(t))) {
 			count++;
 			lua_pushnumber(L, count);
 			lua_pushnumber(L, t);
@@ -974,14 +974,14 @@
 		}
 	}
 
-	if (teamID &gt;= gs-&gt;activeTeams) {
+	if (teamID &gt;= teamHandler-&gt;ActiveTeams()) {
 		return 0;
 	}
 
 	lua_newtable(L);
 	int count = 0;
-	for (int p = 0; p &lt; gs-&gt;activePlayers; p++) {
-		const CPlayer* player = gs-&gt;players[p];
+	for (int p = 0; p &lt; playerHandler-&gt;ActivePlayers(); p++) {
+		const CPlayer* player = playerHandler-&gt;Player(p);
 		if (player == NULL) {
 			continue;
 		}
@@ -1006,10 +1006,10 @@
 int LuaSyncedRead::GetTeamInfo(lua_State* L)
 {
 	const int teamID = luaL_checkint(L, 1);
-	if ((teamID &lt; 0) || (teamID &gt;= gs-&gt;activeTeams)) {
+	if ((teamID &lt; 0) || (teamID &gt;= teamHandler-&gt;ActiveTeams())) {
 		return 0;
 	}
-	const CTeam* team = gs-&gt;Team(teamID);
+	const CTeam* team = teamHandler-&gt;Team(teamID);
 	if (team == NULL) {
 		return 0;
 	}
@@ -1025,7 +1025,7 @@
 	lua_pushboolean(L, team-&gt;isDead);
 	lua_pushboolean(L, isAiTeam);
 	lua_pushstring(L,  team-&gt;side.c_str());
-	lua_pushnumber(L,  gs-&gt;AllyTeam(team-&gt;teamNum));
+	lua_pushnumber(L,  teamHandler-&gt;AllyTeam(team-&gt;teamNum));
 
 	return 6;
 }
@@ -1223,7 +1223,7 @@
 		return 0;
 	}
 
-	const CPlayer* player = gs-&gt;players[playerID];
+	const CPlayer* player = playerHandler-&gt;Player(playerID);
 	if (player == NULL) {
 		return 0;
 	}
@@ -1237,7 +1237,7 @@
 	lua_pushboolean(L, player-&gt;active);
 	lua_pushboolean(L, player-&gt;spectator);
 	lua_pushnumber(L, player-&gt;team);
-	lua_pushnumber(L, gs-&gt;AllyTeam(player-&gt;team));
+	lua_pushnumber(L, teamHandler-&gt;AllyTeam(player-&gt;team));
 	const float pingScale = (GAME_SPEED * gs-&gt;speedFactor);
 	const float pingSecs = float(player-&gt;ping - 1) / pingScale;
 	lua_pushnumber(L, pingSecs);
@@ -1259,7 +1259,7 @@
 		return 0;
 	}
 
-	const CPlayer* player = gs-&gt;players[playerID];
+	const CPlayer* player = playerHandler-&gt;Player(playerID);
 	if (player == NULL) {
 		return 0;
 	}
@@ -1270,7 +1270,7 @@
 	}
 
 	if ((readAllyTeam == CEventClient::NoAccessTeam) ||
-	    ((readAllyTeam &gt;= 0) &amp;&amp; !gs-&gt;Ally(unit-&gt;allyteam, readAllyTeam))) {
+	    ((readAllyTeam &gt;= 0) &amp;&amp; !teamHandler-&gt;Ally(unit-&gt;allyteam, readAllyTeam))) {
 		return 0;
 	}
 
@@ -1284,11 +1284,11 @@
 {
 	const int team1 = (int)luaL_checkint(L, -1);
 	const int team2 = (int)luaL_checkint(L, -2);
-	if ((team1 &lt; 0) || (team1 &gt;= gs-&gt;activeTeams) ||
-	    (team2 &lt; 0) || (team2 &gt;= gs-&gt;activeTeams)) {
+	if ((team1 &lt; 0) || (team1 &gt;= teamHandler-&gt;ActiveTeams()) ||
+	    (team2 &lt; 0) || (team2 &gt;= teamHandler-&gt;ActiveTeams())) {
 		return 0;
 	}
-	lua_pushboolean(L, gs-&gt;AlliedTeams(team1, team2));
+	lua_pushboolean(L, teamHandler-&gt;AlliedTeams(team1, team2));
 	return 1;
 }
 
@@ -1301,12 +1301,12 @@
 	    (player2 &lt; 0) || (player2 &gt;= MAX_PLAYERS)) {
 		return 0;
 	}
-	const CPlayer* p1 = gs-&gt;players[player1];
-	const CPlayer* p2 = gs-&gt;players[player2];
+	const CPlayer* p1 = playerHandler-&gt;Player(player1);
+	const CPlayer* p2 = playerHandler-&gt;Player(player2);
 	if ((p1 == NULL) || (p2 == NULL)) {
 		return 0;
 	}
-	lua_pushboolean(L, gs-&gt;AlliedTeams(p1-&gt;team, p2-&gt;team));
+	lua_pushboolean(L, teamHandler-&gt;AlliedTeams(p1-&gt;team, p2-&gt;team));
 	return 1;
 }
 
@@ -1776,7 +1776,7 @@
 	}
 	if (teamID &lt; EnemyUnits) {
 		luaL_error(L, &quot;Bad teamID in %s (%i)&quot;, caller, teamID);
-	} else if (teamID &gt;= gs-&gt;activeTeams) {
+	} else if (teamID &gt;= teamHandler-&gt;ActiveTeams()) {
 		luaL_error(L, &quot;Bad teamID in %s (%i)&quot;, caller, teamID);
 	}
 	return teamID;
@@ -2048,7 +2048,7 @@
 	}
 	else {
 		startTeam = 0;
-		endTeam = gs-&gt;activeTeams - 1;
+		endTeam = teamHandler-&gt;ActiveTeams() - 1;
 	}
 
 #define PLANES_TEST                  \
@@ -2062,7 +2062,7 @@
 	const int readTeam = CLuaHandle::GetActiveHandle()-&gt;GetReadTeam();
 
 	for (int team = startTeam; team &lt;= endTeam; team++) {
-		const CUnitSet&amp; units = gs-&gt;Team(team)-&gt;units;
+		const CUnitSet&amp; units = teamHandler-&gt;Team(team)-&gt;units;
 		CUnitSet::const_iterator it;
 
 		if (allegiance &gt;= 0) {
@@ -2080,12 +2080,12 @@
 			}
 		}
 		else if (allegiance == AllyUnits) {
-			if (readAllyTeam == gs-&gt;AllyTeam(team)) {
+			if (readAllyTeam == teamHandler-&gt;AllyTeam(team)) {
 				LOOP_UNIT_CONTAINER(NULL_TEST, PLANES_TEST);
 			}
 		}
 		else if (allegiance == EnemyUnits) {
-			if (readAllyTeam != gs-&gt;AllyTeam(team)) {
+			if (readAllyTeam != teamHandler-&gt;AllyTeam(team)) {
 				LOOP_UNIT_CONTAINER(VISIBLE_TEST, PLANES_TEST);
 			}
 		}
@@ -2346,7 +2346,7 @@
 	const UnitDef* decoyDef = IsAllyUnit(unit) ? NULL : unitDef-&gt;decoyDef;
 	const UnitDef* effectiveDef = EffectiveUnitDef(unit);
 	if (effectiveDef-&gt;showPlayerName) {
-		tooltip = gs-&gt;players[gs-&gt;Team(unit-&gt;team)-&gt;leader]-&gt;name;
+		tooltip = playerHandler-&gt;Player(teamHandler-&gt;Team(unit-&gt;team)-&gt;leader)-&gt;name;
 	} else {
 		if (!decoyDef) {
 			tooltip = unit-&gt;tooltip;
@@ -2413,7 +2413,7 @@
 	if (IsEnemyUnit(unit)) {
 		return 1;
 	}
-	const CTeam* team = gs-&gt;Team(unit-&gt;team);
+	const CTeam* team = teamHandler-&gt;Team(unit-&gt;team);
 	if (team == NULL) {
 		return 1;
 	}
@@ -2955,7 +2955,7 @@
 		}
 		allyTeam = luaL_checkint(L, 2);
 	}
-	if ((allyTeam &lt; 0) || (allyTeam &gt;= gs-&gt;activeAllyTeams)) {
+	if ((allyTeam &lt; 0) || (allyTeam &gt;= teamHandler-&gt;ActiveAllyTeams())) {
 		return 0;
 	}
 	const unsigned short losStatus = unit-&gt;losStatus[allyTeam];
@@ -4074,13 +4074,13 @@
 	if (lua_isnoneornil(L, arg)) {
 		return readAllyTeam;
 	}
-	const bool isGaia = (readAllyTeam == gs-&gt;gaiaAllyTeamID);
+	const bool isGaia = (readAllyTeam == teamHandler-&gt;GaiaAllyTeamID());
 	if (fullRead || isGaia) {
 		const int at = luaL_checkint(L, arg);
-		if (at &gt;= gs-&gt;activeAllyTeams) {
+		if (at &gt;= teamHandler-&gt;ActiveAllyTeams()) {
 			luaL_error(L, &quot;Invalid allyTeam&quot;);
 		}
-		if (isGaia &amp;&amp; (at &gt;= 0) &amp;&amp; (at != gs-&gt;gaiaAllyTeamID)) {
+		if (isGaia &amp;&amp; (at &gt;= 0) &amp;&amp; (at != teamHandler-&gt;GaiaAllyTeamID())) {
 			luaL_error(L, &quot;Invalid gaia access&quot;);
 		}
 		return at;
@@ -4108,13 +4108,13 @@
 		inRadar = radarhandler-&gt;InRadar(pos, allyTeamID);
 	}
 	else {
-		for (int at = 0; at &lt; gs-&gt;activeAllyTeams; at++) {
+		for (int at = 0; at &lt; teamHandler-&gt;ActiveAllyTeams(); at++) {
 			if (loshandler-&gt;InLos(pos, at)) {
 				inLos = true;
 				break;
 			}
 		}
-		for (int at = 0; at &lt; gs-&gt;activeAllyTeams; at++) {
+		for (int at = 0; at &lt; teamHandler-&gt;ActiveAllyTeams(); at++) {
 			if (radarhandler-&gt;InRadar(pos, at)) {
 				inRadar = true;
 				break;
@@ -4142,7 +4142,7 @@
 		state = loshandler-&gt;InLos(pos, allyTeamID);
 	}
 	else {
-		for (int at = 0; at &lt; gs-&gt;activeAllyTeams; at++) {
+		for (int at = 0; at &lt; teamHandler-&gt;ActiveAllyTeams(); at++) {
 			if (loshandler-&gt;InLos(pos, at)) {
 				state = true;
 				break;
@@ -4168,7 +4168,7 @@
 		state = radarhandler-&gt;InRadar(pos, allyTeamID);
 	}
 	else {
-		for (int at = 0; at &lt; gs-&gt;activeAllyTeams; at++) {
+		for (int at = 0; at &lt; teamHandler-&gt;ActiveAllyTeams(); at++) {
 			if (radarhandler-&gt;InRadar(pos, at)) {
 				state = true;
 				break;
@@ -4194,7 +4194,7 @@
 		state = loshandler-&gt;InAirLos(pos, allyTeamID);
 	}
 	else {
-		for (int at = 0; at &lt; gs-&gt;activeAllyTeams; at++) {
+		for (int at = 0; at &lt; teamHandler-&gt;ActiveAllyTeams(); at++) {
 			if (loshandler-&gt;InAirLos(pos, at)) {
 				state = true;
 				break;

Modified: branches/caiinterface/rts/Lua/LuaTextures.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaTextures.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Lua/LuaTextures.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -8,7 +8,7 @@
 #include &quot;LuaTextures.h&quot;
 
 #include &quot;Rendering/GL/myGL.h&quot;
-#include &quot;System/Util.h&quot;
+#include &quot;Util.h&quot;
 
 
 /******************************************************************************/

Modified: branches/caiinterface/rts/Lua/LuaUnitDefs.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaUnitDefs.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Lua/LuaUnitDefs.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -21,7 +21,7 @@
 #include &quot;LuaUtils.h&quot;
 #include &quot;Game/Game.h&quot;
 #include &quot;Game/GameHelper.h&quot;
-#include &quot;Game/Team.h&quot;
+#include &quot;Sim/Misc/Team.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Map/MapDamage.h&quot;
 #include &quot;Map/MapInfo.h&quot;
@@ -48,11 +48,11 @@
 #include &quot;Sim/Units/CommandAI/LineDrawer.h&quot;
 #include &quot;Sim/Weapons/Weapon.h&quot;
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/FileSystem/FileHandler.h&quot;
-#include &quot;System/FileSystem/SimpleParser.h&quot;
-#include &quot;System/Platform/FileSystem.h&quot;
-#include &quot;System/Util.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;FileSystem/FileHandler.h&quot;
+#include &quot;FileSystem/SimpleParser.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
+#include &quot;Util.h&quot;
 
 using namespace std;
 
@@ -921,6 +921,9 @@
 	ADD_STRING(&quot;pieceTrailCEGTag&quot;,   ud.pieceTrailCEGTag);
 	ADD_INT(   &quot;pieceTrailCEGRange&quot;, ud.pieceTrailCEGRange);
 
+	ADD_STRING(&quot;scriptName&quot;, ud.scriptName);
+	ADD_STRING(&quot;scriptPath&quot;, ud.scriptPath);
+
 	return true;
 }
 

Modified: branches/caiinterface/rts/Lua/LuaUnitRendering.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaUnitRendering.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Lua/LuaUnitRendering.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -25,7 +25,7 @@
 #include &quot;Sim/Units/UnitHandler.h&quot;
 #include &quot;Sim/Units/UnitDefHandler.h&quot;
 #include &quot;LogOutput.h&quot;
-#include &quot;System/Util.h&quot;
+#include &quot;Util.h&quot;
 
 
 using std::min;

Modified: branches/caiinterface/rts/Lua/LuaUnsyncedCall.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaUnsyncedCall.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Lua/LuaUnsyncedCall.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -20,7 +20,7 @@
 #include &quot;LuaRules.h&quot;
 #include &quot;LuaHashString.h&quot;
 #include &quot;LuaUtils.h&quot;
-#include &quot;System/LogOutput.h&quot;
+#include &quot;LogOutput.h&quot;
 
 
 /******************************************************************************/

Modified: branches/caiinterface/rts/Lua/LuaUnsyncedCtrl.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaUnsyncedCtrl.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Lua/LuaUnsyncedCtrl.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -31,8 +31,7 @@
 #include &quot;Game/Camera/CameraController.h&quot;
 #include &quot;Game/Game.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
-#include &quot;Game/Team.h&quot;
-#include &quot;Game/Player.h&quot;
+#include &quot;Game/PlayerHandler.h&quot;
 #include &quot;Game/UI/CommandColors.h&quot;
 #include &quot;Game/UI/CursorIcons.h&quot;
 #include &quot;Game/UI/GuiHandler.h&quot;
@@ -48,17 +47,18 @@
 #include &quot;Rendering/FontTexture.h&quot;
 #include &quot;Rendering/IconHandler.h&quot;
 #include &quot;Rendering/InMapDraw.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitDefHandler.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
 #include &quot;Sim/Units/CommandAI/CommandAI.h&quot;
 #include &quot;Sim/Units/CommandAI/LineDrawer.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/NetProtocol.h&quot;
-#include &quot;System/Sound.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;NetProtocol.h&quot;
+#include &quot;Sound.h&quot;
 
-#include &quot;System/FileSystem/FileHandler.h&quot;
-#include &quot;System/Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileHandler.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;System/Platform/ConfigHandler.h&quot;
 
 using namespace std;
@@ -101,7 +101,6 @@
 	REGISTER_LUA_CFUNC(PlaySoundStream);
 	REGISTER_LUA_CFUNC(StopSoundStream);
 	REGISTER_LUA_CFUNC(PauseSoundStream);
-	REGISTER_LUA_CFUNC(GetSoundStreamTime);
 	REGISTER_LUA_CFUNC(SetSoundStreamVolume);
 
 	REGISTER_LUA_CFUNC(SetCameraState);
@@ -215,7 +214,7 @@
 	if (ctrlTeam &lt; 0) {
 		return ctrlTeam;
 	}
-	return gs-&gt;AllyTeam(ctrlTeam);
+	return teamHandler-&gt;AllyTeam(ctrlTeam);
 }
 
 
@@ -235,7 +234,7 @@
 	if (ctrlTeam &lt; 0) {
 		return (ctrlTeam == CEventClient::AllAccessTeam) ? true : false;
 	}
-	return (gs-&gt;AllyTeam(ctrlTeam) == allyteam);
+	return (teamHandler-&gt;AllyTeam(ctrlTeam) == allyteam);
 }
 
 
@@ -384,7 +383,7 @@
 	if ((playerID &lt; 0) || (playerID &gt;= MAX_PLAYERS)) {
 		luaL_error(L, &quot;Invalid message playerID: %i&quot;, playerID);
 	}
-	const CPlayer* player = gs-&gt;players[playerID];
+	const CPlayer* player = playerHandler-&gt;Player(playerID);
 	if ((player == NULL) || !player-&gt;active || player-&gt;name.empty()) {
 		luaL_error(L, &quot;Invalid message playerID: %i&quot;, playerID);
 	}
@@ -542,11 +541,6 @@
 	sound-&gt;PauseStream();
 	return 0;
 }
-int LuaUnsyncedCtrl::GetSoundStreamTime(lua_State* L)
-{
-	lua_pushnumber(L, sound-&gt;GetStreamTime());
-	return 1;
-}
 int LuaUnsyncedCtrl::SetSoundStreamVolume(lua_State* L)
 {
 	const int args = lua_gettop(L);
@@ -614,7 +608,7 @@
 	                 lua_tofloat(L, 3),
 	                 lua_tofloat(L, 4));
 	const int team = lua_toint(L, 5);
-	if ((team &lt; 0) || (team &gt;= gs-&gt;activeTeams)) {
+	if ((team &lt; 0) || (team &gt;= teamHandler-&gt;ActiveTeams())) {
 		return 0;
 	}
 	const int facing = lua_toint(L, 6);
@@ -781,7 +775,7 @@
 	if ((teamID &lt; 0) || (teamID &gt;= MAX_TEAMS)) {
 		return 0;
 	}
-	CTeam* team = gs-&gt;Team(teamID);
+	CTeam* team = teamHandler-&gt;Team(teamID);
 	if (team == NULL) {
 		return 0;
 	}
@@ -1940,10 +1934,10 @@
 	const float shareLevel = max(0.0f, min(1.0f, lua_tofloat(L, 2)));
 
 	if (shareType == &quot;metal&quot;) {
-		net-&gt;Send(CBaseNetProtocol::Get().SendSetShare(gu-&gt;myPlayerNum, gu-&gt;myTeam, shareLevel, gs-&gt;Team(gu-&gt;myTeam)-&gt;energyShare));
+		net-&gt;Send(CBaseNetProtocol::Get().SendSetShare(gu-&gt;myPlayerNum, gu-&gt;myTeam, shareLevel, teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;energyShare));
 	}
 	else if (shareType == &quot;energy&quot;) {
-		net-&gt;Send(CBaseNetProtocol::Get().SendSetShare(gu-&gt;myPlayerNum, gu-&gt;myTeam,	gs-&gt;Team(gu-&gt;myTeam)-&gt;metalShare, shareLevel));
+		net-&gt;Send(CBaseNetProtocol::Get().SendSetShare(gu-&gt;myPlayerNum, gu-&gt;myTeam,	teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;metalShare, shareLevel));
 	}
 	else {
 		logOutput.Print(&quot;SetShareLevel() unknown resource: %s&quot;, shareType.c_str());
@@ -1967,10 +1961,10 @@
 		luaL_error(L, &quot;Incorrect arguments to ShareResources()&quot;);
 	}
 	const int teamID = lua_toint(L, 1);
-	if ((teamID &lt; 0) || (teamID &gt;= gs-&gt;activeTeams)) {
+	if ((teamID &lt; 0) || (teamID &gt;= teamHandler-&gt;ActiveTeams())) {
 		return 0;
 	}
-	const CTeam* team = gs-&gt;Team(teamID);
+	const CTeam* team = teamHandler-&gt;Team(teamID);
 	if ((team == NULL) || team-&gt;isDead) {
 		return 0;
 	}

Modified: branches/caiinterface/rts/Lua/LuaUnsyncedCtrl.h
===================================================================
--- branches/caiinterface/rts/Lua/LuaUnsyncedCtrl.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Lua/LuaUnsyncedCtrl.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -34,7 +34,6 @@
 		static int PlaySoundStream(lua_State* L);
 		static int StopSoundStream(lua_State* L);
 		static int PauseSoundStream(lua_State* L);
-		static int GetSoundStreamTime(lua_State* L);
 		static int SetSoundStreamVolume(lua_State* L);
 
 		static int SetCameraState(lua_State* L);

Modified: branches/caiinterface/rts/Lua/LuaUnsyncedRead.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaUnsyncedRead.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Lua/LuaUnsyncedRead.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -29,11 +29,10 @@
 #include &quot;Game/Game.h&quot;
 #include &quot;Game/GameHelper.h&quot;
 #include &quot;Game/GameSetup.h&quot;
-#include &quot;Game/Player.h&quot;
+#include &quot;Game/PlayerHandler.h&quot;
 #include &quot;Game/PlayerRoster.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
 #include &quot;Game/CameraHandler.h&quot;
-#include &quot;Game/Team.h&quot;
 #include &quot;Game/UI/GuiHandler.h&quot;
 #include &quot;Game/UI/InfoConsole.h&quot;
 #include &quot;Game/UI/KeyCodes.h&quot;
@@ -49,13 +48,15 @@
 #include &quot;Rendering/Env/BaseWater.h&quot;
 #include &quot;Rendering/UnitModels/UnitDrawer.h&quot;
 #include &quot;Sim/Features/Feature.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
 #include &quot;Sim/Units/UnitTypes/TransportUnit.h&quot;
-#include &quot;System/NetProtocol.h&quot;
-#include &quot;System/FileSystem/FileHandler.h&quot;
-#include &quot;System/FileSystem/VFSHandler.h&quot;
-#include &quot;System/Platform/FileSystem.h&quot;
+#include &quot;NetProtocol.h&quot;
+#include &quot;FileSystem/FileHandler.h&quot;
+#include &quot;FileSystem/VFSHandler.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
+#include &quot;Sound.h&quot;
 
 
 extern Uint8 *keys;
@@ -146,6 +147,8 @@
 	REGISTER_LUA_CFUNC(GetTimer);
 	REGISTER_LUA_CFUNC(DiffTimers);
 
+	REGISTER_LUA_CFUNC(GetSoundStreamTime);
+
 	// moved from LuaUI
 
 	REGISTER_LUA_CFUNC(GetFPS);
@@ -608,7 +611,7 @@
 	}
 	int allyTeamID = readAllyTeam;
 	if (teamID &gt;= 0) {
-		allyTeamID = gs-&gt;AllyTeam(teamID);
+		allyTeamID = teamHandler-&gt;AllyTeam(teamID);
 	}
 	if (allyTeamID &lt; 0) {
 		if (!fullRead) {
@@ -633,14 +636,14 @@
 	// setup the list of unit sets
 	vector&lt;const CUnitSet*&gt; unitSets;
 	if (teamID &gt;= 0) {
-		unitSets.push_back(&amp;gs-&gt;Team(teamID)-&gt;units);
+		unitSets.push_back(&amp;teamHandler-&gt;Team(teamID)-&gt;units);
 	}
 	else {
-		for (int t = 0; t &lt; gs-&gt;activeTeams; t++) {
+		for (int t = 0; t &lt; teamHandler-&gt;ActiveTeams(); t++) {
 			if ((teamID == AllUnits) ||
-			    ((teamID == AllyUnits)  &amp;&amp; (allyTeamID == gs-&gt;AllyTeam(t))) ||
-			    ((teamID == EnemyUnits) &amp;&amp; (allyTeamID != gs-&gt;AllyTeam(t)))) {
-				unitSets.push_back(&amp;gs-&gt;Team(t)-&gt;units);
+			    ((teamID == AllyUnits)  &amp;&amp; (allyTeamID == teamHandler-&gt;AllyTeam(t))) ||
+			    ((teamID == EnemyUnits) &amp;&amp; (allyTeamID != teamHandler-&gt;AllyTeam(t)))) {
+				unitSets.push_back(&amp;teamHandler-&gt;Team(t)-&gt;units);
 			}
 		}
 	}
@@ -1109,13 +1112,13 @@
 	lua_pushnumber(L, index); index++; \
 	lua_push ## type(L, val); lua_rawset(L, -3);
 
-	const CPlayer* p = gs-&gt;players[playerID];
+	const CPlayer* p = playerHandler-&gt;Player(playerID);
 	int index = 1;
 	lua_newtable(L);
 	PUSH_ROSTER_ENTRY(string, p-&gt;name.c_str());
 	PUSH_ROSTER_ENTRY(number, playerID);
 	PUSH_ROSTER_ENTRY(number, p-&gt;team);
-	PUSH_ROSTER_ENTRY(number, gs-&gt;AllyTeam(p-&gt;team));
+	PUSH_ROSTER_ENTRY(number, teamHandler-&gt;AllyTeam(p-&gt;team));
 	PUSH_ROSTER_ENTRY(number, p-&gt;spectator);
 	PUSH_ROSTER_ENTRY(number, p-&gt;cpuUsage);
 	const float pingScale = (GAME_SPEED * gs-&gt;speedFactor);
@@ -1160,10 +1163,10 @@
 int LuaUnsyncedRead::GetTeamColor(lua_State* L)
 {
 	const int teamID = luaL_checkint(L, 1);
-	if ((teamID &lt; 0) || (teamID &gt;= gs-&gt;activeTeams)) {
+	if ((teamID &lt; 0) || (teamID &gt;= teamHandler-&gt;ActiveTeams())) {
 		return 0;
 	}
-	const CTeam* team = gs-&gt;Team(teamID);
+	const CTeam* team = teamHandler-&gt;Team(teamID);
 	if (team == NULL) {
 		return 0;
 	}
@@ -1180,10 +1183,10 @@
 int LuaUnsyncedRead::GetTeamOrigColor(lua_State* L)
 {
 	const int teamID = luaL_checkint(L, 1);
-	if ((teamID &lt; 0) || (teamID &gt;= gs-&gt;activeTeams)) {
+	if ((teamID &lt; 0) || (teamID &gt;= teamHandler-&gt;ActiveTeams())) {
 		return 0;
 	}
-	const CTeam* team = gs-&gt;Team(teamID);
+	const CTeam* team = teamHandler-&gt;Team(teamID);
 	if (team == NULL) {
 		return 0;
 	}
@@ -1226,6 +1229,17 @@
 
 /******************************************************************************/
 /******************************************************************************/
+
+int LuaUnsyncedRead::GetSoundStreamTime(lua_State* L)
+{
+	lua_pushnumber(L, sound-&gt;GetStreamPlayTime());
+	lua_pushnumber(L, sound-&gt;GetStreamTime());
+	return 2;
+}
+
+
+/******************************************************************************/
+/******************************************************************************/
 //
 // moved from LuaUI
 //

Modified: branches/caiinterface/rts/Lua/LuaUnsyncedRead.h
===================================================================
--- branches/caiinterface/rts/Lua/LuaUnsyncedRead.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Lua/LuaUnsyncedRead.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -78,6 +78,8 @@
 		static int GetTimer(lua_State* L);
 		static int DiffTimers(lua_State* L);
 
+		static int GetSoundStreamTime(lua_State* L);
+
 		// moved from LuaUI
 		static int GetFPS(lua_State* L);
 

Modified: branches/caiinterface/rts/Lua/LuaUtils.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaUtils.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Lua/LuaUtils.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -11,7 +11,7 @@
 #include &quot;LuaUtils.h&quot;
 
 #include &quot;LogOutput.h&quot;
-#include &quot;System/Util.h&quot;
+#include &quot;Util.h&quot;
 
 
 static       int depth = 0;

Modified: branches/caiinterface/rts/Lua/LuaVFS.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaVFS.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Lua/LuaVFS.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -21,11 +21,11 @@
 #include &quot;LuaHashString.h&quot;
 #include &quot;LuaIO.h&quot;
 #include &quot;LuaUtils.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/FileSystem/FileHandler.h&quot;
-#include &quot;System/FileSystem/VFSHandler.h&quot;
-#include &quot;System/Platform/FileSystem.h&quot;
-#include &quot;System/Util.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;FileSystem/FileHandler.h&quot;
+#include &quot;FileSystem/VFSHandler.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
+#include &quot;Util.h&quot;
 
 
 /******************************************************************************/

Modified: branches/caiinterface/rts/Lua/LuaWeaponDefs.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaWeaponDefs.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Lua/LuaWeaponDefs.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -24,10 +24,10 @@
 #include &quot;Sim/Projectiles/Projectile.h&quot;
 #include &quot;Sim/Weapons/Weapon.h&quot;
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
-#include &quot;System/FileSystem/SimpleParser.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/Util.h&quot;
-#include &quot;Game/GlobalSynced.h&quot;
+#include &quot;FileSystem/SimpleParser.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;Util.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
 
 using namespace std;
 

Modified: branches/caiinterface/rts/Map/BaseGroundDrawer.cpp
===================================================================
--- branches/caiinterface/rts/Map/BaseGroundDrawer.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Map/BaseGroundDrawer.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -6,9 +6,9 @@
 #include &quot;Game/Camera.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
 #include &quot;Game/UI/GuiHandler.h&quot;
-#include &quot;Map/Ground.h&quot;
-#include &quot;Map/HeightLinePalette.h&quot;
-#include &quot;Map/ReadMap.h&quot;
+#include &quot;Ground.h&quot;
+#include &quot;HeightLinePalette.h&quot;
+#include &quot;ReadMap.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Rendering/GroundDecalHandler.h&quot;
 #include &quot;Sim/Misc/LosHandler.h&quot;
@@ -18,8 +18,8 @@
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;Sim/Units/UnitDefHandler.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
-#include &quot;System/Platform/ConfigHandler.h&quot;
-#include &quot;System/FastMath.h&quot;
+#include &quot;Platform/ConfigHandler.h&quot;
+#include &quot;FastMath.h&quot;
 
 CBaseGroundDrawer::CBaseGroundDrawer(void)
 {

Modified: branches/caiinterface/rts/Map/Ground.h
===================================================================
--- branches/caiinterface/rts/Map/Ground.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Map/Ground.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -5,8 +5,8 @@
 //////////////////////////////////////////////////////////////////////
 
 #include &quot;float3.h&quot;
-#include &quot;Game/GlobalConstants.h&quot;
-#include &quot;Game/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/GlobalConstants.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
 
 class CProjectileHandler;
 class CProjectile;

Modified: branches/caiinterface/rts/Map/HeightMapTexture.cpp
===================================================================
--- branches/caiinterface/rts/Map/HeightMapTexture.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Map/HeightMapTexture.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -6,9 +6,9 @@
 
 #include &quot;HeightMapTexture.h&quot;
 
-#include &quot;Map/ReadMap.h&quot;
+#include &quot;ReadMap.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
-#include &quot;System/Platform/ConfigHandler.h&quot;
+#include &quot;Platform/ConfigHandler.h&quot;
 
 /******************************************************************************/
 /******************************************************************************/

Modified: branches/caiinterface/rts/Map/MapInfo.cpp
===================================================================
--- branches/caiinterface/rts/Map/MapInfo.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Map/MapInfo.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -4,12 +4,12 @@
 
 #include &quot;MapInfo.h&quot;
 
-#include &quot;Game/GlobalConstants.h&quot;
+#include &quot;Sim/Misc/GlobalConstants.h&quot;
 #include &quot;MapParser.h&quot;
 #include &quot;Lua/LuaParser.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/FileSystem/FileHandler.h&quot;
-#include &quot;System/Exceptions.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;FileSystem/FileHandler.h&quot;
+#include &quot;Exceptions.h&quot;
 
 
 using namespace std;

Modified: branches/caiinterface/rts/Map/MapParser.cpp
===================================================================
--- branches/caiinterface/rts/Map/MapParser.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Map/MapParser.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -8,7 +8,7 @@
 
 #include &quot;MapParser.h&quot;
 #include &quot;Lua/LuaSyncedRead.h&quot;
-#include &quot;System/FileSystem/FileHandler.h&quot;
+#include &quot;FileSystem/FileHandler.h&quot;
 
 
 string MapParser::GetMapConfigName(const string&amp; mapName)

Modified: branches/caiinterface/rts/Map/MetalMap.h
===================================================================
--- branches/caiinterface/rts/Map/MetalMap.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Map/MetalMap.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -4,7 +4,7 @@
 #include &lt;vector&gt;
 
 #include &quot;creg/creg.h&quot;
-#include &quot;Game/GlobalConstants.h&quot;
+#include &quot;Sim/Misc/GlobalConstants.h&quot;
 
 // Each square on metalmap is a 2x2 square on normal map.
 const float METAL_MAP_SQUARE_SIZE = SQUARE_SIZE * 2;

Modified: branches/caiinterface/rts/Map/ReadMap.cpp
===================================================================
--- branches/caiinterface/rts/Map/ReadMap.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Map/ReadMap.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -20,12 +20,12 @@
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;SM3/Sm3Map.h&quot;
 #include &quot;SMF/SmfReadMap.h&quot;
-#include &quot;System/FileSystem/FileHandler.h&quot;
-#include &quot;System/FileSystem/ArchiveScanner.h&quot;
-#include &quot;System/LoadSaveInterface.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/Platform/errorhandler.h&quot;
-#include &quot;System/Exceptions.h&quot;
+#include &quot;FileSystem/FileHandler.h&quot;
+#include &quot;FileSystem/ArchiveScanner.h&quot;
+#include &quot;LoadSaveInterface.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;Platform/errorhandler.h&quot;
+#include &quot;Exceptions.h&quot;
 
 using namespace std;
 

Modified: branches/caiinterface/rts/Map/ReadMap.h
===================================================================
--- branches/caiinterface/rts/Map/ReadMap.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Map/ReadMap.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -7,8 +7,8 @@
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;creg/creg.h&quot;
 #include &quot;float3.h&quot;
-#include &quot;Game/GlobalConstants.h&quot;
-#include &quot;Game/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/GlobalConstants.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
 
 class CMetalMap;
 class CCamera;

Modified: branches/caiinterface/rts/Map/SM3/Sm3GroundDrawer.cpp
===================================================================
--- branches/caiinterface/rts/Map/SM3/Sm3GroundDrawer.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Map/SM3/Sm3GroundDrawer.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -10,7 +10,7 @@
 #include &quot;Rendering/GroundDecalHandler.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Map/MapInfo.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
 
 #include &lt;SDL_keysym.h&gt;

Modified: branches/caiinterface/rts/Map/SM3/Sm3Map.cpp
===================================================================
--- branches/caiinterface/rts/Map/SM3/Sm3Map.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Map/SM3/Sm3Map.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -15,7 +15,7 @@
 #include &quot;Platform/byteorder.h&quot;
 #include &quot;FileSystem/FileHandler.h&quot;
 #include &quot;TdfParser.h&quot;
-#include &quot;System/Util.h&quot;
+#include &quot;Util.h&quot;
 
 #include &quot;terrain/TerrainNode.h&quot;
 #include &quot;Game/Camera.h&quot;

Modified: branches/caiinterface/rts/Map/SM3/terrain/Lightcalc.cpp
===================================================================
--- branches/caiinterface/rts/Map/SM3/terrain/Lightcalc.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Map/SM3/terrain/Lightcalc.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -35,7 +35,7 @@
 #include &quot;Lightcalc.h&quot;
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
-#include &quot;System/Util.h&quot;
+#include &quot;Util.h&quot;
 
 #include &lt;SDL.h&gt;
 #include &lt;IL/il.h&gt;

Modified: branches/caiinterface/rts/Map/SM3/terrain/Terrain.cpp
===================================================================
--- branches/caiinterface/rts/Map/SM3/terrain/Terrain.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Map/SM3/terrain/Terrain.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -44,7 +44,7 @@
 #include &quot;TerrainTexture.h&quot;
 #include &quot;TerrainNode.h&quot;
 #include &quot;FileSystem/FileHandler.h&quot;
-#include &quot;System/Util.h&quot;
+#include &quot;Util.h&quot;
 #include &lt;assert.h&gt;
 
 // define this for big endian machines

Modified: branches/caiinterface/rts/Map/SM3/terrain/TerrainBase.h
===================================================================
--- branches/caiinterface/rts/Map/SM3/terrain/TerrainBase.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Map/SM3/terrain/TerrainBase.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -31,7 +31,7 @@
 
 #include &quot;Rendering/GL/myGL.h&quot;
 
-#include &quot;../Frustum.h&quot;
+#include &quot;Map/SM3/Frustum.h&quot;
 #include &quot;Matrix44f.h&quot;
 
 #include &quot;LogOutput.h&quot;

Modified: branches/caiinterface/rts/Map/SM3/terrain/TerrainTexture.cpp
===================================================================
--- branches/caiinterface/rts/Map/SM3/terrain/TerrainTexture.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Map/SM3/terrain/TerrainTexture.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -42,7 +42,7 @@
 #include &quot;TerrainTexEnvCombine.h&quot;
 #include &quot;TerrainTextureGLSL.h&quot;
 #include &quot;Lightcalc.h&quot;
-#include &quot;System/Util.h&quot;
+#include &quot;Util.h&quot;
 
 #include &lt;SDL_keysym.h&gt;
 extern unsigned char *keys;

Modified: branches/caiinterface/rts/Map/SM3/terrain/TerrainTextureGLSL.cpp
===================================================================
--- branches/caiinterface/rts/Map/SM3/terrain/TerrainTextureGLSL.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Map/SM3/terrain/TerrainTextureGLSL.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -35,11 +35,11 @@
 #include &quot;TerrainTextureGLSL.h&quot;
 #include &quot;Rendering/GL/IFramebuffer.h&quot;
 #include &quot;FileSystem/FileHandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;bitops.h&quot;
-#include &quot;System/Util.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
-#include &quot;System/Exceptions.h&quot;
+#include &quot;Util.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
+#include &quot;Exceptions.h&quot;
 
 #include &lt;fstream&gt;
 #include &lt;list&gt;

Modified: branches/caiinterface/rts/Map/SM3/terrain/Textures.cpp
===================================================================
--- branches/caiinterface/rts/Map/SM3/terrain/Textures.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Map/SM3/terrain/Textures.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -38,8 +38,8 @@
 #include &quot;TerrainNode.h&quot;
 #include &quot;Textures.h&quot;
 #include &quot;Rendering/Textures/Bitmap.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
-#include &quot;System/float3.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
+#include &quot;float3.h&quot;
 
 
 namespace terrain {

Modified: branches/caiinterface/rts/Map/SMF/BFGroundDrawer.cpp
===================================================================
--- branches/caiinterface/rts/Map/SMF/BFGroundDrawer.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Map/SMF/BFGroundDrawer.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -12,8 +12,8 @@
 #include &quot;Rendering/ShadowHandler.h&quot;
 #include &quot;Rendering/GroundDecalHandler.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
-#include &quot;System/FastMath.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;FastMath.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 #include &quot;mmgr.h&quot;
 
 #ifdef USE_GML

Modified: branches/caiinterface/rts/Map/SMF/SmfMapFile.cpp
===================================================================
--- branches/caiinterface/rts/Map/SMF/SmfMapFile.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Map/SMF/SmfMapFile.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -5,7 +5,7 @@
 #include &quot;SmfMapFile.h&quot;
 #include &quot;mapfile.h&quot;
 #include &quot;mmgr.h&quot;
-#include &quot;System/Exceptions.h&quot;
+#include &quot;Exceptions.h&quot;
 
 using std::string;
 

Modified: branches/caiinterface/rts/Map/SMF/SmfReadMap.cpp
===================================================================
--- branches/caiinterface/rts/Map/SMF/SmfReadMap.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Map/SMF/SmfReadMap.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -15,8 +15,8 @@
 #include &quot;Game/Camera.h&quot;
 #include &quot;bitops.h&quot;
 #include &quot;mmgr.h&quot;
-#include &quot;System/Util.h&quot;
-#include &quot;System/Exceptions.h&quot;
+#include &quot;Util.h&quot;
+#include &quot;Exceptions.h&quot;
 
 using namespace std;
 

Modified: branches/caiinterface/rts/Rendering/Env/AdvSky.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/Env/AdvSky.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/Env/AdvSky.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -17,7 +17,7 @@
 #include &quot;TimeProfiler.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;Matrix44f.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 #define Y_PART 10.0
 #define X_PART 10.0

Modified: branches/caiinterface/rts/Rendering/Env/AdvTreeGenerator.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/Env/AdvTreeGenerator.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/Env/AdvTreeGenerator.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -14,9 +14,9 @@
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Rendering/Textures/Bitmap.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/Exceptions.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;Exceptions.h&quot;
 
 using std::max;
 using std::min;

Modified: branches/caiinterface/rts/Rendering/Env/AdvWater.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/Env/AdvWater.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/Env/AdvWater.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -17,8 +17,8 @@
 #include &quot;Rendering/UnitModels/UnitDrawer.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;Sim/Features/FeatureHandler.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
-#include &quot;System/EventHandler.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
+#include &quot;EventHandler.h&quot;
 #include &quot;Map/MapInfo.h&quot;
 
 //////////////////////////////////////////////////////////////////////

Modified: branches/caiinterface/rts/Rendering/Env/BaseTreeDrawer.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/Env/BaseTreeDrawer.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/Env/BaseTreeDrawer.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -7,7 +7,7 @@
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;Game/Camera.h&quot;
-#include &quot;Game/GlobalConstants.h&quot;
+#include &quot;Sim/Misc/GlobalConstants.h&quot;
 
 CBaseTreeDrawer* treeDrawer=0;
 

Modified: branches/caiinterface/rts/Rendering/Env/BaseWater.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/Env/BaseWater.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/Env/BaseWater.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -10,7 +10,7 @@
 #include &quot;LogOutput.h&quot;
 #include &quot;DynWater.h&quot;
 #include &quot;RefractWater.h&quot;
-#include &quot;System/Exceptions.h&quot;
+#include &quot;Exceptions.h&quot;
 
 CBaseWater* water=0;
 

Modified: branches/caiinterface/rts/Rendering/Env/BasicSky.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/Env/BasicSky.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/Env/BasicSky.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -18,7 +18,7 @@
 #include &quot;Rendering/Textures/Bitmap.h&quot;
 #include &quot;TimeProfiler.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 #include &quot;Matrix44f.h&quot;
 #include &quot;LogOutput.h&quot;
 

Modified: branches/caiinterface/rts/Rendering/Env/BasicTreeDrawer.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/Env/BasicTreeDrawer.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/Env/BasicTreeDrawer.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -13,8 +13,8 @@
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Rendering/Textures/Bitmap.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/Exceptions.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;Exceptions.h&quot;
 
 //////////////////////////////////////////////////////////////////////
 // Construction/Destruction

Modified: branches/caiinterface/rts/Rendering/Env/BasicWater.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/Env/BasicWater.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/Env/BasicWater.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -10,7 +10,7 @@
 #include &quot;Rendering/Textures/Bitmap.h&quot;
 #include &quot;Map/MapInfo.h&quot;
 #include &quot;Map/ReadMap.h&quot;
-#include &quot;System/Exceptions.h&quot;
+#include &quot;Exceptions.h&quot;
 
 //////////////////////////////////////////////////////////////////////
 // Construction/Destruction

Modified: branches/caiinterface/rts/Rendering/Env/BumpWater.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/Env/BumpWater.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/Env/BumpWater.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -27,13 +27,13 @@
 #include &quot;Sim/Features/FeatureHandler.h&quot;
 #include &quot;Sim/Misc/Wind.h&quot;
 #include &quot;FileSystem/FileHandler.h&quot;
-#include &quot;System/FastMath.h&quot;
-#include &quot;System/EventHandler.h&quot;
-#include &quot;System/Platform/ConfigHandler.h&quot;
+#include &quot;FastMath.h&quot;
+#include &quot;EventHandler.h&quot;
+#include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;TimeProfiler.h&quot;
 #include &quot;LogOutput.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
-#include &quot;System/Exceptions.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
+#include &quot;Exceptions.h&quot;
 
 using std::string;
 using std::vector;

Modified: branches/caiinterface/rts/Rendering/Env/DynWater.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/Env/DynWater.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/Env/DynWater.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -11,7 +11,7 @@
 #include &quot;LogOutput.h&quot;
 #include &quot;bitops.h&quot;
 #include &quot;Map/BaseGroundDrawer.h&quot;
-#include &quot;Rendering/Env/BaseSky.h&quot;
+#include &quot;BaseSky.h&quot;
 #include &quot;Rendering/UnitModels/UnitDrawer.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;Sim/Features/FeatureHandler.h&quot;
@@ -22,9 +22,9 @@
 #include &quot;Sim/Units/UnitHandler.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
-#include &quot;System/EventHandler.h&quot;
-#include &quot;System/Exceptions.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
+#include &quot;EventHandler.h&quot;
+#include &quot;Exceptions.h&quot;
 
 #define W_SIZE 5
 #define WF_SIZE 5120

Modified: branches/caiinterface/rts/Rendering/Env/GrassDrawer.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/Env/GrassDrawer.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/Env/GrassDrawer.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -18,9 +18,9 @@
 #include &quot;Map/MapInfo.h&quot;
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;Rendering/ShadowHandler.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
-#include &quot;System/Util.h&quot;
-#include &quot;System/Exceptions.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
+#include &quot;Util.h&quot;
+#include &quot;Exceptions.h&quot;
 //#include &quot;TimeProfiler.h&quot;
 
 static const float turfSize=20;				//single turf size

Modified: branches/caiinterface/rts/Rendering/Env/RefractWater.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/Env/RefractWater.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/Env/RefractWater.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -7,7 +7,7 @@
 #include &quot;LogOutput.h&quot;
 #include &quot;Map/MapInfo.h&quot;
 #include &quot;Map/ReadMap.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 #include &quot;bitops.h&quot;
 
 CRefractWater::CRefractWater() : CAdvWater(false)

Modified: branches/caiinterface/rts/Rendering/Env/SkyBox.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/Env/SkyBox.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/Env/SkyBox.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -6,11 +6,11 @@
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Rendering/Textures/Bitmap.h&quot;
 #include &quot;Game/Camera.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 #include &quot;Map/MapInfo.h&quot;
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;Rendering/UnitModels/UnitDrawer.h&quot;
-#include &quot;System/Exceptions.h&quot;
+#include &quot;Exceptions.h&quot;
 
 CSkyBox::CSkyBox(std::string texture)
 {

Modified: branches/caiinterface/rts/Rendering/FartextureHandler.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/FartextureHandler.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/FartextureHandler.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,5 +1,5 @@
 #include &quot;StdAfx.h&quot;
-#include &quot;Rendering/GL/myGL.h&quot;
+#include &quot;GL/myGL.h&quot;
 #include &quot;mmgr.h&quot;
 
 #include &quot;FartextureHandler.h&quot;
@@ -7,7 +7,7 @@
 #include &quot;GL/myGL.h&quot;
 #include &quot;GlobalUnsynced.h&quot;
 #include &quot;UnitModels/UnitDrawer.h&quot;
-#include &quot;Rendering/Textures/Bitmap.h&quot;
+#include &quot;Textures/Bitmap.h&quot;
 #include &quot;Map/MapInfo.h&quot;
 
 CFartextureHandler* fartextureHandler = NULL;

Modified: branches/caiinterface/rts/Rendering/FartextureHandler.h
===================================================================
--- branches/caiinterface/rts/Rendering/FartextureHandler.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/FartextureHandler.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -2,7 +2,7 @@
 #define __FARTEXTURE_HANDLER_H__
 
 #include &lt;vector&gt;
-#include &quot;Rendering/GL/myGL.h&quot;
+#include &quot;GL/myGL.h&quot;
 
 struct S3DOModel;
 

Modified: branches/caiinterface/rts/Rendering/GL/FBO.h
===================================================================
--- branches/caiinterface/rts/Rendering/GL/FBO.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/GL/FBO.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -12,7 +12,7 @@
 #ifndef FBO_H
 #define FBO_H
 
-#include &quot;Rendering/GL/myGL.h&quot;
+#include &quot;myGL.h&quot;
 
 /**
  * @brief FBO

Modified: branches/caiinterface/rts/Rendering/GL/IFramebuffer.h
===================================================================
--- branches/caiinterface/rts/Rendering/GL/IFramebuffer.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/GL/IFramebuffer.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -6,7 +6,7 @@
 #ifndef _IFRAMEBUFFER_H
 #define _IFRAMEBUFFER_H
 
-#include &quot;Rendering/GL/myGL.h&quot;
+#include &quot;myGL.h&quot;
 
 enum FramebufferAttachType
 {

Modified: branches/caiinterface/rts/Rendering/GL/VertexArray.h
===================================================================
--- branches/caiinterface/rts/Rendering/GL/VertexArray.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/GL/VertexArray.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,7 +1,7 @@
 #ifndef VERTEXARRAY_H
 #define VERTEXARRAY_H
 #include &quot;myGL.h&quot;
-#include &quot;System/Platform/errorhandler.h&quot;
+#include &quot;Platform/errorhandler.h&quot;
 // VertexArray.h: interface for the CVertexArray class.
 //
 //////////////////////////////////////////////////////////////////////

Modified: branches/caiinterface/rts/Rendering/GL/glList.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/GL/glList.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/GL/glList.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -12,7 +12,7 @@
 #include &quot;Game/UI/MouseHandler.h&quot;
 #include &quot;Rendering/glFont.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
-#include &quot;System/Util.h&quot;
+#include &quot;Util.h&quot;
 
 const float itemFontScale = 1.5f;
 const float itemXMargin = 0.02f;

Modified: branches/caiinterface/rts/Rendering/GL/myGL.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/GL/myGL.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/GL/myGL.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -15,9 +15,9 @@
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;FPUCheck.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
-#include &quot;System/Util.h&quot;
-#include &quot;System/Exceptions.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
+#include &quot;Util.h&quot;
+#include &quot;Exceptions.h&quot;
 
 #include &quot;IFramebuffer.h&quot;
 
@@ -232,6 +232,23 @@
 
 /******************************************************************************/
 
+void ClearScreen()
+{
+	glClearColor(0,0,0,1);
+	glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
+
+	glMatrixMode(GL_PROJECTION);						// Select The Projection Matrix
+	glLoadIdentity();									// Reset The Projection Matrix
+	gluOrtho2D(0,1,0,1);
+	glMatrixMode(GL_MODELVIEW);							// Select The Modelview Matrix
+
+	glLoadIdentity();
+	glEnable(GL_BLEND);
+	glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
+	glEnable(GL_TEXTURE_2D);
+	glColor3f(1,1,1);
+}
+
 void PrintLoadMsg(const char* text, bool swapbuffers)
 {
 	static char prevText[100];
@@ -254,21 +271,7 @@
 
 	// Draw loading screen &amp; print load msg.
 	ENTER_UNSYNCED;
-
-	glClearColor(0,0,0,1);
-	glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
-
-	glMatrixMode(GL_PROJECTION);						// Select The Projection Matrix
-	glLoadIdentity();									// Reset The Projection Matrix
-	gluOrtho2D(0,1,0,1);
-	glMatrixMode(GL_MODELVIEW);							// Select The Modelview Matrix
-
-	glLoadIdentity();
-	glEnable(GL_BLEND);
-	glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
-	glEnable(GL_TEXTURE_2D);
-	glColor3f(1,1,1);
-
+	ClearScreen();
 	if (startupTexture) {
 		glBindTexture(GL_TEXTURE_2D,startupTexture);
 		glBegin(GL_QUADS);
@@ -280,9 +283,9 @@
 	}
 	font-&gt;glPrintCentered (0.5f,0.48f, 2.0f, text);
 #ifdef USE_GML
-	font-&gt;glPrintCentered(0.5f,0.06f,1.0f,&quot;Spring %s MT (%d threads)&quot;, VERSION_STRING_DETAILED, gmlThreadCount);
+	font-&gt;glPrintCentered(0.5f,0.06f,1.0f,&quot;Spring %s MT (%d threads)&quot;, SpringVersion::GetFull().c_str(), gmlThreadCount);
 #else
-	font-&gt;glPrintCentered(0.5f,0.06f,1.0f,&quot;Spring %s&quot;, VERSION_STRING_DETAILED);
+	font-&gt;glPrintCentered(0.5f,0.06f,1.0f,&quot;Spring %s&quot;, SpringVersion::GetFull().c_str());
 #endif
 	font-&gt;glPrintCentered(0.5f,0.02f,0.6f,&quot;This program is distributed under the GNU General Public License, see license.html for more info&quot;);
 	if (swapbuffers) {

Modified: branches/caiinterface/rts/Rendering/GL/myGL.h
===================================================================
--- branches/caiinterface/rts/Rendering/GL/myGL.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/GL/myGL.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -53,6 +53,7 @@
 void glBuildMipmaps(const GLenum target,GLint internalFormat,const GLsizei width,const GLsizei height,const GLenum format,const GLenum type,const void *data);
 
 void LoadStartPicture(const std::string&amp; sidePref);
+void ClearScreen();
 void PrintLoadMsg(const char* text, bool swapbuffers = true);
 void UnloadStartPicture();
 

Modified: branches/caiinterface/rts/Rendering/GroundDecalHandler.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/GroundDecalHandler.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/GroundDecalHandler.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -11,17 +11,17 @@
 #include &quot;Map/MapInfo.h&quot;
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
-#include &quot;Rendering/ShadowHandler.h&quot;
-#include &quot;Rendering/GL/myGL.h&quot;
-#include &quot;Rendering/GL/VertexArray.h&quot;
-#include &quot;Rendering/Textures/Bitmap.h&quot;
+#include &quot;ShadowHandler.h&quot;
+#include &quot;GL/myGL.h&quot;
+#include &quot;GL/VertexArray.h&quot;
+#include &quot;Textures/Bitmap.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;Sim/Units/UnitTypes/Building.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/Util.h&quot;
-#include &quot;System/Exceptions.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;Util.h&quot;
+#include &quot;Exceptions.h&quot;
 
 using std::list;
 using std::min;

Modified: branches/caiinterface/rts/Rendering/GroundDecalHandler.h
===================================================================
--- branches/caiinterface/rts/Rendering/GroundDecalHandler.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/GroundDecalHandler.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,14 +1,13 @@
 #ifndef GROUNDDECALHANDLER_H
 #define GROUNDDECALHANDLER_H
 
-#include &quot;Object.h&quot;
 #include &lt;set&gt;
 #include &lt;list&gt;
 #include &lt;vector&gt;
 #include &lt;string&gt;
-#include &quot;Rendering/UnitModels/UnitDrawer.h&quot;
-#include &quot;Rendering/GL/myGL.h&quot;
-#include &quot;Rendering/GL/VertexArray.h&quot;
+#include &quot;UnitModels/UnitDrawer.h&quot;
+#include &quot;GL/myGL.h&quot;
+#include &quot;GL/VertexArray.h&quot;
 #include &quot;Util.h&quot;
 
 class CUnit;
@@ -50,8 +49,7 @@
 };
 
 
-class CGroundDecalHandler:
-	public CObject
+class CGroundDecalHandler
 {
 public:
 	CGroundDecalHandler(void);

Modified: branches/caiinterface/rts/Rendering/GroundFlash.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/GroundFlash.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/GroundFlash.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -7,8 +7,8 @@
 #include &quot;Game/Camera.h&quot;
 #include &quot;GL/VertexArray.h&quot;
 #include &quot;LogOutput.h&quot;
-#include &quot;Rendering/Textures/ColorMap.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;Textures/ColorMap.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CGroundFlash, CExpGenSpawnable, );
 

Modified: branches/caiinterface/rts/Rendering/GroundFlash.h
===================================================================
--- branches/caiinterface/rts/Rendering/GroundFlash.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/GroundFlash.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,7 +1,7 @@
 #ifndef GROUNDFLASH_H
 #define GROUNDFLASH_H
 
-#include &quot;Rendering/Textures/TextureAtlas.h&quot;
+#include &quot;Textures/TextureAtlas.h&quot;
 #include &quot;Sim/Projectiles/ExplosionGenerator.h&quot;
 
 class CVertexArray;

Modified: branches/caiinterface/rts/Rendering/IconHandler.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/IconHandler.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/IconHandler.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -12,8 +12,8 @@
 #include &quot;LogOutput.h&quot;
 #include &quot;IconHandler.h&quot;
 #include &quot;Lua/LuaParser.h&quot;
-#include &quot;Rendering/Textures/Bitmap.h&quot;
-#include &quot;System/Exceptions.h&quot;
+#include &quot;Textures/Bitmap.h&quot;
+#include &quot;Exceptions.h&quot;
 
 using std::string;
 

Modified: branches/caiinterface/rts/Rendering/InMapDraw.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/InMapDraw.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/InMapDraw.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -6,20 +6,20 @@
 #include &quot;InMapDraw.h&quot;
 #include &quot;Game/Camera.h&quot;
 #include &quot;Game/Game.h&quot;
-#include &quot;Game/Player.h&quot;
-#include &quot;Game/Team.h&quot;
+#include &quot;Game/PlayerHandler.h&quot;
 #include &quot;Game/UI/MiniMap.h&quot;
 #include &quot;Game/UI/MouseHandler.h&quot;
 #include &quot;Map/BaseGroundDrawer.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Map/ReadMap.h&quot;
-#include &quot;Rendering/glFont.h&quot;
-#include &quot;Rendering/GL/myGL.h&quot;
-#include &quot;Rendering/GL/VertexArray.h&quot;
-#include &quot;System/EventHandler.h&quot;
-#include &quot;System/NetProtocol.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/Sound.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
+#include &quot;glFont.h&quot;
+#include &quot;GL/myGL.h&quot;
+#include &quot;GL/VertexArray.h&quot;
+#include &quot;EventHandler.h&quot;
+#include &quot;NetProtocol.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;Sound.h&quot;
 #include &quot;creg/STL_List.h&quot;
 
 
@@ -183,8 +183,8 @@
 	if (s.IsWriting()) {
 		char ColorType = 0;
 		char ColorId = 0;
-		if (!ColorType) for (int a=0;a&lt;MAX_TEAMS;a++) 
-			if (*color==gs-&gt;Team(a)-&gt;color) {
+		if (!ColorType) for (int a=0;a&lt;MAX_TEAMS;a++)
+			if (*color==teamHandler-&gt;Team(a)-&gt;color) {
 				ColorType = 1;
 				ColorId = a;
 				break;
@@ -202,7 +202,7 @@
 				break;
 			}
 			case 1:{
-				*color = gs-&gt;Team(ColorId)-&gt;color;
+				*color = teamHandler-&gt;Team(ColorId)-&gt;color;
 				break;
 			}
 		}
@@ -240,7 +240,7 @@
 	for (std::list&lt;CInMapDraw::MapPoint&gt;::iterator pi = dq-&gt;points.begin(); pi != dq-&gt;points.end(); ++pi) {
 		const int allyteam = pi-&gt;senderAllyTeam;
 		const bool spec = pi-&gt;senderSpectator;
-		const bool allied = (gs-&gt;Ally(gu-&gt;myAllyTeam, allyteam) &amp;&amp; gs-&gt;Ally(allyteam, gu-&gt;myAllyTeam));
+		const bool allied = (teamHandler-&gt;Ally(gu-&gt;myAllyTeam, allyteam) &amp;&amp; teamHandler-&gt;Ally(allyteam, gu-&gt;myAllyTeam));
 		const bool maySee = (gu-&gt;spectating || (!spec &amp;&amp; allied) || imd-&gt;drawAll);
 
 		if (maySee) {
@@ -293,7 +293,7 @@
 	for (std::list&lt;CInMapDraw::MapLine&gt;::iterator li = dq-&gt;lines.begin(); li != dq-&gt;lines.end(); ++li) {
 		const int allyteam = li-&gt;senderAllyTeam;
 		const bool spec = li-&gt;senderSpectator;
-		const bool allied = (gs-&gt;Ally(gu-&gt;myAllyTeam, allyteam) &amp;&amp; gs-&gt;Ally(allyteam, gu-&gt;myAllyTeam));
+		const bool allied = (teamHandler-&gt;Ally(gu-&gt;myAllyTeam, allyteam) &amp;&amp; teamHandler-&gt;Ally(allyteam, gu-&gt;myAllyTeam));
 		const bool maySee = (gu-&gt;spectating || (!spec &amp;&amp; allied) || imd-&gt;drawAll);
 
 		if (maySee) {
@@ -439,14 +439,14 @@
 	if ((playerID &lt; 0) || (playerID &gt;= MAX_PLAYERS)) {
 		return;
 	}
-	const CPlayer* sender = gs-&gt;players[playerID];
+	const CPlayer* sender = playerHandler-&gt;Player(playerID);
 	if (sender == NULL) {
 		return;
 	}
 	const int  team      = sender-&gt;team;
-	const int  allyteam  = gs-&gt;AllyTeam(team);
-	const bool alliedMsg = (gs-&gt;Ally(gu-&gt;myAllyTeam, allyteam) &amp;&amp;
-	                        gs-&gt;Ally(allyteam, gu-&gt;myAllyTeam));
+	const int  allyteam  = teamHandler-&gt;AllyTeam(team);
+	const bool alliedMsg = (teamHandler-&gt;Ally(gu-&gt;myAllyTeam, allyteam) &amp;&amp;
+	                        teamHandler-&gt;Ally(allyteam, gu-&gt;myAllyTeam));
 	bool allowed = true;
 
 	if (!gu-&gt;spectating &amp;&amp; (sender-&gt;spectator || !alliedMsg)) {
@@ -467,7 +467,7 @@
 
 	MapPoint point;
 	point.pos = pos;
-	point.color = gs-&gt;Team(team)-&gt;color;
+	point.color = teamHandler-&gt;Team(team)-&gt;color;
 	point.label = label;
 	point.senderAllyTeam = allyteam;
 	point.senderSpectator = sender-&gt;spectator;
@@ -496,14 +496,14 @@
 	if ((playerID &lt; 0) || (playerID &gt;= MAX_PLAYERS)) {
 		return;
 	}
-	const CPlayer* sender = gs-&gt;players[playerID];
+	const CPlayer* sender = playerHandler-&gt;Player(playerID);
 	if (sender == NULL) {
 		return;
 	}
 	const int  team      = sender-&gt;team;
-	const int  allyteam  = gs-&gt;AllyTeam(team);
-	const bool alliedMsg = (gs-&gt;Ally(gu-&gt;myAllyTeam, allyteam) &amp;&amp;
-	                        gs-&gt;Ally(allyteam, gu-&gt;myAllyTeam));
+	const int  allyteam  = teamHandler-&gt;AllyTeam(team);
+	const bool alliedMsg = (teamHandler-&gt;Ally(gu-&gt;myAllyTeam, allyteam) &amp;&amp;
+	                        teamHandler-&gt;Ally(allyteam, gu-&gt;myAllyTeam));
 
 	float3 pos1 = constPos1;
 	float3 pos2 = constPos2;
@@ -519,7 +519,7 @@
 	MapLine line;
 	line.pos  = pos1;
 	line.pos2 = pos2;
-	line.color = gs-&gt;Team(team)-&gt;color;
+	line.color = teamHandler-&gt;Team(team)-&gt;color;
 	line.senderAllyTeam = allyteam;
 	line.senderSpectator = sender-&gt;spectator;
 
@@ -536,14 +536,14 @@
 	if ((playerID &lt; 0) || (playerID &gt;= MAX_PLAYERS)) {
 		return;
 	}
-	const CPlayer* sender = gs-&gt;players[playerID];
+	const CPlayer* sender = playerHandler-&gt;Player(playerID);
 	if (sender == NULL) {
 		return;
 	}
 	const int  team      = sender-&gt;team;
-	const int  allyteam  = gs-&gt;AllyTeam(team);
-	const bool alliedMsg = (gs-&gt;Ally(gu-&gt;myAllyTeam, allyteam) &amp;&amp;
-	                        gs-&gt;Ally(allyteam, gu-&gt;myAllyTeam));
+	const int  allyteam  = teamHandler-&gt;AllyTeam(team);
+	const bool alliedMsg = (teamHandler-&gt;Ally(gu-&gt;myAllyTeam, allyteam) &amp;&amp;
+	                        teamHandler-&gt;Ally(allyteam, gu-&gt;myAllyTeam));
 
 	float3 pos = constPos;
 	pos.CheckInBounds();

Modified: branches/caiinterface/rts/Rendering/InMapDraw.h
===================================================================
--- branches/caiinterface/rts/Rendering/InMapDraw.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/InMapDraw.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -3,7 +3,7 @@
 
 #include &lt;string&gt;
 #include &lt;list&gt;
-#include &quot;Rendering/GL/myGL.h&quot;
+#include &quot;GL/myGL.h&quot;
 
 
 class CInMapDraw

Modified: branches/caiinterface/rts/Rendering/ShadowHandler.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/ShadowHandler.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/ShadowHandler.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -13,10 +13,10 @@
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;Game/UI/MiniMap.h&quot;
 #include &quot;LogOutput.h&quot;
-#include &quot;Rendering/GL/myGL.h&quot;
-#include &quot;Rendering/GL/IFramebuffer.h&quot;
+#include &quot;GL/myGL.h&quot;
+#include &quot;GL/IFramebuffer.h&quot;
 #include &quot;Sim/Features/FeatureHandler.h&quot;
-#include &quot;System/EventHandler.h&quot;
+#include &quot;EventHandler.h&quot;
 
 CShadowHandler* shadowHandler=0;
 

Modified: branches/caiinterface/rts/Rendering/Textures/Bitmap.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/Textures/Bitmap.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/Textures/Bitmap.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -24,8 +24,8 @@
 
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;FileSystem/FileHandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
-#include &quot;Rendering/Textures/Bitmap.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
+#include &quot;Bitmap.h&quot;
 #include &quot;bitops.h&quot;
 
 //////////////////////////////////////////////////////////////////////

Modified: branches/caiinterface/rts/Rendering/Textures/Bitmap.h
===================================================================
--- branches/caiinterface/rts/Rendering/Textures/Bitmap.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/Textures/Bitmap.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -8,7 +8,7 @@
 #include &lt;string&gt;
 
 #include &quot;Platform/Win/win32.h&quot;
-#include &quot;Rendering/Textures/nv_dds.h&quot;
+#include &quot;nv_dds.h&quot;
 
 using std::string;
 

Modified: branches/caiinterface/rts/Rendering/Textures/ColorMap.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/Textures/ColorMap.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/Textures/ColorMap.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -4,10 +4,10 @@
 
 #include &quot;ColorMap.h&quot;
 #include &quot;Bitmap.h&quot;
-#include &quot;Rendering/Textures/Bitmap.h&quot;
+#include &quot;Bitmap.h&quot;
 #include &quot;FileSystem/FileHandler.h&quot;
-#include &quot;System/Util.h&quot;
-#include &quot;System/Exceptions.h&quot;
+#include &quot;Util.h&quot;
+#include &quot;Exceptions.h&quot;
 
 std::vector&lt;CColorMap *&gt; CColorMap::colorMaps;
 std::map&lt;std::string, CColorMap *&gt; CColorMap::colorMapsMap;

Modified: branches/caiinterface/rts/Rendering/Textures/NamedTextures.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/Textures/NamedTextures.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/Textures/NamedTextures.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -8,8 +8,8 @@
 #include &quot;bitops.h&quot;
 #include &quot;NamedTextures.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
-#include &quot;Rendering/Textures/Bitmap.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;Bitmap.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 
 map&lt;string, CNamedTextures::TexInfo&gt; CNamedTextures::texMap;

Modified: branches/caiinterface/rts/Rendering/Textures/TextureAtlas.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/Textures/TextureAtlas.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/Textures/TextureAtlas.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -3,13 +3,13 @@
 #include &quot;mmgr.h&quot;
 
 #include &quot;TextureAtlas.h&quot;
-#include &quot;Rendering/Textures/Bitmap.h&quot;
+#include &quot;Bitmap.h&quot;
 #include &quot;FileSystem/FileHandler.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
-#include &quot;System/Util.h&quot;
-#include &quot;System/Exceptions.h&quot;
-#include &quot;System/Vec2.h&quot;
+#include &quot;Util.h&quot;
+#include &quot;Exceptions.h&quot;
+#include &quot;Vec2.h&quot;
 
 CR_BIND(AtlasedTexture, );
 CR_BIND_DERIVED(GroundFXTexture, AtlasedTexture, );

Modified: branches/caiinterface/rts/Rendering/Textures/TextureHandler.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/Textures/TextureHandler.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/Textures/TextureHandler.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -13,18 +13,18 @@
 #include &quot;TextureHandler.h&quot;
 #include &quot;FileSystem/FileHandler.h&quot;
 #include &quot;FileSystem/SimpleParser.h&quot;
-#include &quot;Game/GlobalSynced.h&quot;
-#include &quot;Game/Team.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;Platform/errorhandler.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Rendering/ShadowHandler.h&quot;
-#include &quot;Rendering/Textures/Bitmap.h&quot;
+#include &quot;Bitmap.h&quot;
 #include &quot;Rendering/UnitModels/UnitDrawer.h&quot;
 #include &quot;TAPalette.h&quot;
-#include &quot;System/Util.h&quot;
-#include &quot;System/Exceptions.h&quot;
+#include &quot;Util.h&quot;
+#include &quot;Exceptions.h&quot;
 
 //////////////////////////////////////////////////////////////////////
 // Construction/Destruction
@@ -87,7 +87,7 @@
 			texfiles[numfiles++] = tex;
 			totalSize += tex-&gt;tex.xsize * tex-&gt;tex.ysize;
 		} else {
-			for(int a = 0; a &lt; gs-&gt;activeTeams; ++a){
+			for(int a = 0; a &lt; teamHandler-&gt;ActiveTeams(); ++a){
 				TexFile* tex = CreateTeamTex(s, s2, a);
 				texfiles[numfiles++] = tex;
 				totalSize += tex-&gt;tex.xsize * tex-&gt;tex.ysize;
@@ -360,7 +360,7 @@
 	sprintf(tmp,&quot;%s%02i&quot;,name2.c_str(),team);
 	tex-&gt;name=tmp;
 
-	unsigned char* teamCol=gs-&gt;Team(team)-&gt;color;
+	unsigned char* teamCol=teamHandler-&gt;Team(team)-&gt;color;
 	CBitmap* bm=&amp;tex-&gt;tex;
 	for(int a=0;a&lt;bm-&gt;ysize*bm-&gt;xsize;++a){
 		if(bm-&gt;mem[a*4]==bm-&gt;mem[a*4+2] &amp;&amp; bm-&gt;mem[a*4+1]==0){

Modified: branches/caiinterface/rts/Rendering/UnitModels/3DModelParser.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/UnitModels/3DModelParser.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/UnitModels/3DModelParser.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -8,7 +8,7 @@
 #include &quot;3DOParser.h&quot;
 #include &quot;s3oParser.h&quot;
 #include &quot;Sim/Units/COB/CobInstance.h&quot;
-#include &quot;System/Util.h&quot;
+#include &quot;Util.h&quot;
 
 C3DModelParser* modelParser=0;
 

Modified: branches/caiinterface/rts/Rendering/UnitModels/3DOParser.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/UnitModels/3DOParser.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/UnitModels/3DOParser.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -22,14 +22,14 @@
 #include &quot;Sim/Units/COB/CobInstance.h&quot;
 #include &quot;Rendering/Textures/TAPalette.h&quot;
 #include &quot;Matrix44f.h&quot;
-#include &quot;Game/Team.h&quot;
+#include &quot;Sim/Misc/Team.h&quot;
 #include &quot;Game/Player.h&quot;
 #include &quot;Platform/errorhandler.h&quot;
 #include &quot;Platform/byteorder.h&quot;
 #include &quot;SDL_types.h&quot;
 #include &quot;s3oParser.h&quot;
-#include &quot;System/Util.h&quot;
-#include &quot;System/Exceptions.h&quot;
+#include &quot;Util.h&quot;
+#include &quot;Exceptions.h&quot;
 
 using namespace std;
 
@@ -177,7 +177,7 @@
 	}
 
 //	if(sideName.find(&quot;armstump.3do&quot;)!=std::string.npos){
-//		logOutput.Print(&quot;New type %s %i %s %s&quot;,name.c_str(),team,sideName.c_str(),gs-&gt;players[gs-&gt;Team(team)-&gt;leader]-&gt;name.c_str());
+//		logOutput.Print(&quot;New type %s %i %s %s&quot;,name.c_str(),team,sideName.c_str(),playerHandler-&gt;Player(teamHandler-&gt;Team(team)-&gt;leader)-&gt;name.c_str());
 //	}
 	PUSH_CODE_MODE;
 	ENTER_SYNCED;

Modified: branches/caiinterface/rts/Rendering/UnitModels/UnitDrawer.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/UnitModels/UnitDrawer.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/UnitModels/UnitDrawer.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -9,7 +9,6 @@
 #include &quot;Game/GameHelper.h&quot;
 #include &quot;Game/GameSetup.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
-#include &quot;Game/Team.h&quot;
 #include &quot;Lua/LuaMaterial.h&quot;
 #include &quot;Lua/LuaUnitMaterial.h&quot;
 #include &quot;Lua/LuaRules.h&quot;
@@ -35,6 +34,7 @@
 #include &quot;Sim/Misc/CollisionVolume.h&quot;
 #include &quot;Sim/Misc/LosHandler.h&quot;
 #include &quot;Sim/Misc/RadarHandler.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Units/CommandAI/BuilderCAI.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;Sim/Units/UnitDefHandler.h&quot;
@@ -42,7 +42,7 @@
 #include &quot;Sim/Units/UnitHandler.h&quot;
 #include &quot;Sim/Units/UnitTypes/TransportUnit.h&quot;
 #include &quot;Sim/Weapons/Weapon.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 #include &quot;mmgr.h&quot;
 
 #ifdef USE_GML
@@ -782,7 +782,7 @@
 	if (unit-&gt;commandAI-&gt;selected) {
 		glColor3ub(255, 255, 255);
 	} else {
-		glColor3ubv(gs-&gt;Team(unit-&gt;team)-&gt;color);
+		glColor3ubv(teamHandler-&gt;Team(unit-&gt;team)-&gt;color);
 	}
 
 	// If the icon is partly under the ground, move it up.
@@ -1112,7 +1112,7 @@
 void CUnitDrawer::SetS3OTeamColour(int team)
 {
 	if (advShading) {
-		unsigned char* col = gs-&gt;Team(team)-&gt;color;
+		unsigned char* col = teamHandler-&gt;Team(team)-&gt;color;
 		glProgramEnvParameter4fARB(GL_FRAGMENT_PROGRAM_ARB, 14, col[0] / 255.f, col[1] / 255.f, col[2] / 255.f, 1);
 		if (luaDrawing) { // FIXME?
 			SetBasicS3OTeamColour(team);
@@ -1125,7 +1125,7 @@
 
 void CUnitDrawer::SetBasicS3OTeamColour(int team)
 {
-	unsigned char* col = gs-&gt;Team(team)-&gt;color;
+	unsigned char* col = teamHandler-&gt;Team(team)-&gt;color;
 	float texConstant[] = {col[0] / 255.f, col[1] / 255.f, col[2] / 255.f, 1};
 	glTexEnvfv(GL_TEXTURE_ENV, GL_TEXTURE_ENV_COLOR, texConstant);
 }
@@ -1885,7 +1885,7 @@
 		fc = unit-&gt;unitDef-&gt;nanoColor;
 	}
 	else {
-		const unsigned char* tcol = gs-&gt;Team(unit-&gt;team)-&gt;color;
+		const unsigned char* tcol = teamHandler-&gt;Team(unit-&gt;team)-&gt;color;
 		fc = float3(tcol[0] * (1.0f / 255.0f),
 								tcol[1] * (1.0f / 255.0f),
 								tcol[2] * (1.0f / 255.0f));

Modified: branches/caiinterface/rts/Rendering/UnitModels/s3oParser.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/UnitModels/s3oParser.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/UnitModels/s3oParser.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -18,8 +18,8 @@
 #include &quot;Rendering/Textures/TextureHandler.h&quot;
 #include &quot;Platform/byteorder.h&quot;
 #include &quot;Platform/errorhandler.h&quot;
-#include &quot;System/Util.h&quot;
-#include &quot;System/Exceptions.h&quot;
+#include &quot;Util.h&quot;
+#include &quot;Exceptions.h&quot;
 
 void SS3O::DrawStatic()
 {

Modified: branches/caiinterface/rts/Rendering/VerticalSync.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/VerticalSync.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/VerticalSync.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -11,9 +11,9 @@
 #include &quot;mmgr.h&quot;
 
 #include &quot;VerticalSync.h&quot;
-#include &quot;Rendering/GL/myGL.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/Platform/ConfigHandler.h&quot;
+#include &quot;GL/myGL.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;Platform/ConfigHandler.h&quot;
 
 
 CVerticalSync VSync;

Modified: branches/caiinterface/rts/Rendering/glFont.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/glFont.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/glFont.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -7,29 +7,67 @@
 #include &lt;stdio.h&gt;
 #include &lt;stdarg.h&gt;
 #include &lt;stdexcept&gt;
-#include &quot;mmgr.h&quot;
+#include &lt;ft2build.h&gt;
+#include FT_FREETYPE_H
 
 #include &quot;LogOutput.h&quot;
 #include &quot;Game/Camera.h&quot;
 #include &quot;myMath.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
-#include &quot;System/Util.h&quot;
-#include &quot;System/Exceptions.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
+#include &quot;Util.h&quot;
+#include &quot;Exceptions.h&quot;
+#include &quot;mmgr.h&quot;
 
-using namespace std;
+using std::string;
 
 /*******************************************************************************/
 /*******************************************************************************/
 
-CglFont *font, *smallFont;
+CglFont* font;
+CglFont* smallFont;
 
+
 #define GLYPH_MARGIN 3 // margin between glyphs in texture-atlas
 
+
 class texture_size_exception : public std::exception
 {
 };
 
+
+struct GlyphInfo
+{
+	float u0, v0;
+	float u1, v1;
+	float x0, y0;
+	float x1, y1;
+	float advance, height;
+};
+
+
+#undef __FTERRORS_H__
+#define FT_ERRORDEF( e, v, s )  { e, s },
+#define FT_ERROR_START_LIST     {
+#define FT_ERROR_END_LIST       { 0, 0 } };
+  struct ErrorString
+  {
+	int          err_code;
+	const char*  err_msg;
+  } static errorTable[] =
+#include FT_ERRORS_H
+
+
+static const char* GetFTError (FT_Error e)
+{
+	for (int a = 0; errorTable[a].err_msg; ++a) {
+		if (errorTable[a].err_code == e)
+			return errorTable[a].err_msg;
+	}
+	return &quot;Unknown error&quot;;
+}
+
+
 /*******************************************************************************/
 /*******************************************************************************/
 
@@ -46,13 +84,15 @@
 	GLuint CreateTexture();
 private:
 	int width, height;
-	unsigned char *buffer, *cur;
+	unsigned char* buffer;
+	unsigned char* cur;
 	int curX, curY;
-	int curHeight;		// height of highest glyph in current line
+	int curHeight;               // height of highest glyph in current line
 
 	void BreakLine();
 };
 
+
 CFontTextureRenderer::CFontTextureRenderer(int width, int height)
 : width(width), height(height), buffer(NULL), cur(NULL), curX(0), curY(0), curHeight(0)
 {
@@ -61,11 +101,13 @@
 	cur = buffer;
 }
 
+
 CFontTextureRenderer::~CFontTextureRenderer()
 {
 	delete [] buffer;
 }
 
+
 void CFontTextureRenderer::AddGlyph(FT_GlyphSlot slot, int &amp;outX, int &amp;outY)
 {
 	FT_Bitmap &amp;bmp = slot-&gt;bitmap;
@@ -78,8 +120,8 @@
 
 	// blit the bitmap into our buffer (row by row to avoid pitch issues)
 	for (int y = 0; y &lt; bmp.rows; y++) {
-		unsigned char *src = bmp.buffer + y * bmp.pitch;
-		unsigned char *dst = cur + 2 * y * width;
+		const unsigned char* src = bmp.buffer + y * bmp.pitch;
+		unsigned char* dst = cur + 2 * y * width;
 		for (int x = 0; x &lt; bmp.width; x++) {
 			*dst++ = 255;		// luminance
 			*dst++ = *src++;	// alpha
@@ -89,9 +131,10 @@
 
 	curX += bmp.width + GLYPH_MARGIN;	// leave one pixel space between each glyph
 	cur  += 2*(bmp.width + GLYPH_MARGIN); 	// 2channels (luminance and alpha))
-	curHeight = max(curHeight, bmp.rows);
+	curHeight = std::max(curHeight, bmp.rows);
 }
 
+
 void CFontTextureRenderer::BreakLine()
 {
 	curX = 0;
@@ -104,6 +147,7 @@
 	cur = buffer + curY * 2*width;
 }
 
+
 GLuint CFontTextureRenderer::CreateTexture()
 {
 	glGetError();
@@ -127,8 +171,9 @@
 	return tex;
 }
 
+/*******************************************************************************/
+/*******************************************************************************/
 
-
 CglFont::CglFont(int start, int end, const char* fontfile, float size, int texWidth, int texHeight)
 : color(NULL), outlineColor(NULL), glyphs(NULL)
 {
@@ -153,8 +198,8 @@
 	FT_Set_Char_Size(face, (int)(height * gu-&gt;aspectRatio / (4.0f/3.0f)), (int)height, 72, 72);
 
 	// clamp the char range
-	end = min(254, end);
-	start = max(32, start);
+	end = std::min(254, end);
+	start = std::max(32, start);
 
 	chars = (end - start) + 1;
 
@@ -208,12 +253,11 @@
 			throw;
 		}
 
-		int bitmap_width = slot-&gt;bitmap.width;
-		int bitmap_rows = slot-&gt;bitmap.rows;
-		int bitmap_pitch = slot-&gt;bitmap.pitch;
+		const int bitmap_width = slot-&gt;bitmap.width;
+		const int bitmap_rows = slot-&gt;bitmap.rows;
 		// Keep sign!
-		float ybearing = slot-&gt;metrics.horiBearingY / 64.0f;
-		float xbearing = slot-&gt;metrics.horiBearingX / 64.0f;
+		const float ybearing = slot-&gt;metrics.horiBearingY / 64.0f;
+		const float xbearing = slot-&gt;metrics.horiBearingX / 64.0f;
 
 		g-&gt;advance = slot-&gt;advance.x / 64.0f * toX;
 		g-&gt;height = slot-&gt;metrics.height / 64.0f * toY;
@@ -264,6 +308,7 @@
 	}
 }
 
+
 CglFont::~CglFont()
 {
 	glDeleteTextures(1, &amp;fontTexture);
@@ -282,24 +327,25 @@
 	return c;
 }
 
-float CglFont::CalcCharWidth (char c) const
+
+float CglFont::CalcCharWidth (int c) const
 {
-	const unsigned int ch = (unsigned int)c;
 	if ((c &gt;= charstart) &amp;&amp; (c &lt;= charend)) {
-		return glyphs[ch - charstart].advance;
+		return glyphs[c - charstart].advance;
 	} else
 		return 0.0f;
 }
 
-float CglFont::CalcTextWidth(const char *text) const
+
+float CglFont::CalcTextWidth(const char* text) const
 {
-	float w=0.0f;
+	float w = 0.0f;
 	for (int a = 0; text[a]; a++)  {
 		a = SkipColorCodes(text, a);
 		if (a &lt; 0) {
 			break;
 		}
-		const unsigned int c = (unsigned int)text[a];
+		const int c = text[a];
 		if ((c &gt;= charstart) &amp;&amp; (c &lt;= charend)) {
 			const float charpart = glyphs[c - charstart].advance;
 			w += charpart;// + 0.02f;
@@ -308,15 +354,16 @@
 	return w;
 }
 
-float CglFont::CalcTextHeight(const char *text) const
+
+float CglFont::CalcTextHeight(const char* text) const
 {
-	float h=0.0f;
+	float h = 0.0f;
 	for (int a = 0; text[a]; a++)  {
 		a = SkipColorCodes(text, a);
 		if (a &lt; 0) {
 			break;
 		}
-		const unsigned int c = (unsigned int)text[a];
+		const int c = text[a];
 		if ((c &gt;= charstart) &amp;&amp; (c &lt;= charend)) {
 			float charpart = glyphs[c - charstart].height;
 			if (charpart &gt; h) {
@@ -330,25 +377,27 @@
 
 void CglFont::Outline(bool enable, const float* col, const float* outlineCol)
 {
-	this-&gt;outline = enable;
+	outline = enable;
 	if (enable) {
 		if (col) {
 			// if color is null, we keep the old settings (which should better not be null)
-			this-&gt;color = col;
-			this-&gt;outlineColor = outlineCol? outlineCol: ChooseOutlineColor(col);
+			color = col;
+			outlineColor = outlineCol? outlineCol: ChooseOutlineColor(col);
 		}
 	}
 }
 
+
 void CglFont::OutlineS(bool enable, const float* outlineCol)
 {
-	this-&gt;outline = enable;
-	if (enable) {;
-		this-&gt;outlineColor = outlineCol? outlineCol: ChooseOutlineColor(color);
+	outline = enable;
+	if (enable) {
+		outlineColor = outlineCol? outlineCol: ChooseOutlineColor(color);
 	}
 }
 
-float CglFont::RenderString(float x, float y, float s, const unsigned char *text) const
+
+float CglFont::RenderString(float x, float y, float s, const char* text) const
 {
 //	glPushAttrib(GL_LIST_BIT | GL_CURRENT_BIT  | GL_ENABLE_BIT | GL_TRANSFORM_BIT);
 	glPushAttrib(GL_ENABLE_BIT | GL_CURRENT_BIT);
@@ -374,10 +423,10 @@
 	 */
 
 	glBegin(GL_QUADS);
-	for (int i = 0; i &lt; strlen((const char*)text); i++) {
-		const unsigned int ch = (unsigned char)text[i];
+	for (int i = 0; text[i]; ++i) {
+		const int ch = text[i];
 		if ((ch &gt;= charstart) &amp;&amp; (ch &lt;= charend)) {
-			GlyphInfo *g = &amp;glyphs[ch - charstart];
+			GlyphInfo* g = &amp;glyphs[ch - charstart];
 
 			glTexCoord2f(g-&gt;u0, g-&gt;v1); glVertex2f(x+s*g-&gt;x0, y+s*g-&gt;y1);
 			glTexCoord2f(g-&gt;u0, g-&gt;v0); glVertex2f(x+s*g-&gt;x0, y+s*g-&gt;y0);
@@ -394,7 +443,8 @@
 	return x;
 }
 
-float CglFont::RenderStringOutlined(float x, float y, float s, const unsigned char *text)
+
+float CglFont::RenderStringOutlined(float x, float y, float s, const char* text)
 {
 	const float shiftX = gu-&gt;pixelX, shiftY = gu-&gt;pixelY;
 
@@ -406,18 +456,19 @@
 	glEnable(GL_BLEND);
 	glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
 
-	if (       color == 0x0) {        color = &amp;defaultColor[0]; }
-	if (outlineColor == 0x0) { outlineColor = &amp;defaultColor[0]; }
+	if (       color == NULL) {        color = &amp;defaultColor[0]; }
+	if (outlineColor == NULL) { outlineColor = &amp;defaultColor[0]; }
 
 	glBegin(GL_QUADS);
-	for (int i = 0; i &lt; strlen((const char*)text); i++) {
-		const unsigned int ch = (unsigned char)text[i];
+
+	for (int i = 0; text[i]; ++i) {
+		const int ch = text[i];
 		if ((ch &gt;= charstart) &amp;&amp; (ch &lt;= charend)) {
 
-			GlyphInfo *g = &amp;glyphs[ch - charstart];
+			GlyphInfo* g = &amp;glyphs[ch - charstart];
 
-			float dx0 = x + s * g-&gt;x0, dy0 = y + s * g-&gt;y0;
-			float dx1 = x + s * g-&gt;x1, dy1 = y + s * g-&gt;y1;
+			const float dx0 = x + s * g-&gt;x0, dy0 = y + s * g-&gt;y0;
+			const float dx1 = x + s * g-&gt;x1, dy1 = y + s * g-&gt;y1;
 
 			glColor4fv(outlineColor);
 
@@ -468,18 +519,21 @@
 	glPrintAt(x, y, scale, text);
 }
 
+
 void CglFont::glPrintOutlinedRight(float x, float y, float scale, const char* text, const float* normalColor)
 {
 	Outline(true, normalColor);
 	glPrintRight(x, y, scale, text);
 }
 
+
 void CglFont::glPrintOutlinedCentered(float x, float y, float scale, const char* text, const float* normalColor)
 {
 	Outline(true, normalColor);
 	glPrintCentered(x, y, scale, text);
 }
 
+
 // macro for formatting printf-style
 #define FORMAT_STRING(fmt,out)					\
 		char out[512];							\
@@ -491,24 +545,25 @@
 		va_end(ap);
 
 
-void CglFont::glWorldPrint(const char *str) const
+void CglFont::glWorldPrint(const char* str) const
 {
-	float w=gu-&gt;aspectRatio * CalcTextWidth(str);
+	const float w = gu-&gt;aspectRatio * CalcTextWidth(str);
 	/* Center (screen-wise) the text above the current position. */
 	glTranslatef(-0.5f*w*camera-&gt;right.x,
 	             -0.5f*w*camera-&gt;right.y,
 	             -0.5f*w*camera-&gt;right.z);
 	glBindTexture(GL_TEXTURE_2D, fontTexture);
 	for (int a = 0; str[a]; a++) {
-		unsigned int ch = (unsigned char)str[a];
+		const int ch = str[a];
 		if (ch &gt;= charstart &amp;&amp; ch &lt;= charend)
 			WorldChar(ch);
 	}
 }
 
-void CglFont::WorldChar(unsigned int ch) const
+
+void CglFont::WorldChar(int ch) const
 {
-	GlyphInfo *g = &amp;glyphs[ch - charstart];
+	GlyphInfo* g = &amp;glyphs[ch - charstart];
 
 	glBegin(GL_QUADS);
 
@@ -532,53 +587,55 @@
 
 	glEnd();
 
-	float advance = g-&gt;advance;
+	const float advance = g-&gt;advance;
 	glTranslatef(advance*rx, advance*ry, advance*rz);
 }
 
 
-
 // centered version of glPrintAt
-void CglFont::glPrintCentered (float x, float y, float s, const char *fmt, ...)
+void CglFont::glPrintCentered (float x, float y, float s, const char* fmt, ...)
 {
 	FORMAT_STRING(fmt,text);
 
 	x -= s * 0.5f * CalcTextWidth(text);
 
 	if (outline)
-		RenderStringOutlined(x, y, s, (const unsigned char*)text);
+		RenderStringOutlined(x, y, s, text);
 	else
-		RenderString(x, y, s, (const unsigned char*)text);
+		RenderString(x, y, s, text);
 }
 
-void CglFont::glPrintAt(GLfloat x, GLfloat y, float s, const char *str)
+
+void CglFont::glPrintAt(GLfloat x, GLfloat y, float s, const char* str)
 {
 	if (outline)
-		RenderStringOutlined(x, y, s, (const unsigned char*)str);
+		RenderStringOutlined(x, y, s, str);
 	else
-		RenderString(x, y, s, (const unsigned char*)str);
+		RenderString(x, y, s, str);
 }
 
+
 // right justified version of glPrintAt
-void CglFont::glPrintRight (float x, float y, float s, const char *fmt, ...)
+void CglFont::glPrintRight (float x, float y, float s, const char* fmt, ...)
 {
 	FORMAT_STRING(fmt,text);
 
 	x -= s * CalcTextWidth(text);
 
 	if (outline)
-		RenderStringOutlined(x, y, s, (const unsigned char*)text);
+		RenderStringOutlined(x, y, s, text);
 	else
-		RenderString(x, y, s, (const unsigned char*)text);
+		RenderString(x, y, s, text);
 }
 
-void CglFont::glPrintColorAt(GLfloat x, GLfloat y, float s, const char *str)
+
+void CglFont::glPrintColorAt(GLfloat x, GLfloat y, float s, const char* str)
 {
 	// TODO both glColor and float* color set, make RenderString respect the float *color
 	const float* oldColor = color;
 	float newColor[4] = {1.0f, 1.0f, 1.0f, 1.0f};
 
-	color = const_cast&lt;const float*&gt;(newColor);
+	color = newColor;
 	glColor4fv(color);
 
 	size_t lf;
@@ -586,10 +643,10 @@
 
 	while ((lf = temp.find(&quot;\xff&quot;)) != string::npos) {
 		if (outline) {
-			x = RenderStringOutlined(x, y, s, (const unsigned char*) temp.substr(0, lf).c_str());
+			x = RenderStringOutlined(x, y, s, temp.substr(0, lf).c_str());
 			outline = true; //HACK RenderStringOutlined resets outline
 		} else {
-			x = RenderString(x, y, s, (const unsigned char*) temp.substr(0, lf).c_str());
+			x = RenderString(x, y, s, temp.substr(0, lf).c_str());
 		}
 
 		temp = temp.substr(lf, string::npos);
@@ -601,22 +658,23 @@
 	}
 
 	if (outline) {
-		RenderStringOutlined(x, y, s, (const unsigned char*) temp.c_str());
+		RenderStringOutlined(x, y, s, temp.c_str());
 	} else {
-		RenderString(x, y, s, (const unsigned char*) temp.c_str());
+		RenderString(x, y, s, temp.c_str());
 	}
 
 	color = oldColor;
 }
 
-void CglFont::glFormatAt(GLfloat x, GLfloat y, float s, const char *fmt, ...)
+
+void CglFont::glFormatAt(GLfloat x, GLfloat y, float s, const char* fmt, ...)
 {
 	FORMAT_STRING(fmt,text);
 	glPrintAt(x, y, s, text);
 }
 
 
-const float* CglFont::ChooseOutlineColor(const float *textColor)
+const float* CglFont::ChooseOutlineColor(const float* textColor)
 {
 	static const GLfloat darkOutline[4]  = { 0.25f, 0.25f, 0.25f, 0.8f };
 	static const GLfloat lightOutline[4] = { 0.85f, 0.85f, 0.85f, 0.8f };
@@ -631,25 +689,3 @@
 		return lightOutline;
 	}
 }
-
-
-#undef __FTERRORS_H__
-#define FT_ERRORDEF( e, v, s )  { e, s },
-#define FT_ERROR_START_LIST     {
-#define FT_ERROR_END_LIST       { 0, 0 } };
-  struct ErrorString
-  {
-	int          err_code;
-	const char*  err_msg;
-  } static errorTable[] =
-#include FT_ERRORS_H
-
-
-const char* CglFont::GetFTError (FT_Error e) const
-{
-	for (int a=0;errorTable[a].err_msg;a++) {
-		if (errorTable[a].err_code == e)
-			return errorTable[a].err_msg;
-	}
-	return &quot;Unknown error&quot;;
-}

Modified: branches/caiinterface/rts/Rendering/glFont.h
===================================================================
--- branches/caiinterface/rts/Rendering/glFont.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Rendering/glFont.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,68 +1,61 @@
 #ifndef _GLFONT_H
 #define _GLFONT_H
 
-#include &lt;ft2build.h&gt;
-#include FT_FREETYPE_H
 #include &quot;GL/myGL.h&quot;
 #include &lt;string&gt;
 
-struct GlyphInfo
-{
-	float u0, v0;
-	float u1, v1;
-	float x0, y0;
-	float x1, y1;
-	float advance, height;
-};
+struct GlyphInfo;
 
 class CglFont
 {
 public:
-	static CglFont *TryConstructFont(std::string fontFile, int start, int end, float size);
+	static CglFont* TryConstructFont(std::string fontFile, int start, int end, float size);
 
 	void glWorldPrint(const char* str) const;
 	void glPrintAt(GLfloat x, GLfloat y, float s, const char* str);
 	void glPrintColorAt(GLfloat x, GLfloat y, float s, const char* str);
 	void glFormatAt(GLfloat x, GLfloat y, float s, const char* fmt, ...);
-	void glPrintRight (float x,float y, float s, const char *fmt,...);
-	void glPrintCentered (float x,float y, float s, const char *fmt,...);
-	void Outline(bool enable, const float *color, const float *outlineColor = 0);		/// Enable outlining for the next drawing operation.
-	void OutlineS(bool enable, const float *outlineColor = 0);		/// Enable outlining for the next drawing operation.
+	void glPrintRight (float x,float y, float s, const char* fmt,...);
+	void glPrintCentered (float x,float y, float s, const char* fmt,...);
+	void Outline(bool enable, const float* color, const float* outlineColor = NULL); ///&lt; Enable outlining for the next drawing operation.
+	void OutlineS(bool enable, const float* outlineColor = NULL); ///&lt; Enable outlining for the next drawing operation.
 
 	// The &quot;outlined&quot; functions are for convenience; their functionality may be obtained by calling Outline() before rendering text.
 	void glPrintOutlinedAt(float x, float y, float scale, const char* text, const float* normalColor);
 	void glPrintOutlinedRight(float x, float y, float scale, const char* text, const float* normalColor);
 	void glPrintOutlinedCentered(float x, float y, float scale, const char* text, const float* normalColor);
 
-	float CalcTextWidth (const char *txt) const;
-	float CalcCharWidth (char c) const;
-	float CalcTextHeight(const char *text) const;
+	float CalcTextWidth (const char* txt) const;
+	float CalcCharWidth (int c) const;
+	float CalcTextHeight(const char* text) const;
 	inline float GetHeight() const { return fontHeight; }
 
 	CglFont(int start, int end, const char* fontfile, float size, int texWidth, int texHeight);
 	~CglFont();
-	
+
 	int GetCharStart() const { return charstart; }
 	int GetCharEnd()   const { return charend; }
 
-
 private:
-	float RenderString(float x, float y, float s, const unsigned char *text) const;
-	float RenderStringOutlined(float x, float y, float s, const unsigned char *text);
-	void WorldChar(unsigned int ch) const;
-	const char* GetFTError (FT_Error e) const;
+	float RenderString(float x, float y, float s, const char* text) const;
+	float RenderStringOutlined(float x, float y, float s, const char* text);
+	void WorldChar(int ch) const;
+
 	int chars;
 	int charstart;
 	int charend;
 	GLuint fontTexture;
 	float fontHeight;
 	bool outline;
-	const float *color, *outlineColor;
+	const float* color;
+	const float* outlineColor;
 	float defaultColor[4];
-	GlyphInfo *glyphs;
+	GlyphInfo* glyphs;
 
-	static const float* ChooseOutlineColor(const float *textColor);
+	static const float* ChooseOutlineColor(const float* textColor);
 };
-extern CglFont *font, *smallFont;
 
+extern CglFont* font;
+extern CglFont* smallFont;
+
 #endif /* _GLFONT_H */

Modified: branches/caiinterface/rts/Sim/Features/Feature.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Features/Feature.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Features/Feature.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -3,7 +3,6 @@
 
 #include &quot;Feature.h&quot;
 #include &quot;FeatureHandler.h&quot;
-#include &quot;Game/Team.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Lua/LuaRules.h&quot;
 #include &quot;Map/Ground.h&quot;
@@ -16,15 +15,16 @@
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Rendering/UnitModels/3DOParser.h&quot;
 #include &quot;Rendering/UnitModels/UnitDrawer.h&quot;
-#include &quot;Sim/ModInfo.h&quot;
 #include &quot;Sim/Misc/CollisionVolume.h&quot;
+#include &quot;Sim/Misc/ModInfo.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Projectiles/FireProjectile.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;Sim/Projectiles/Unsynced/GeoThermSmokeProjectile.h&quot;
 #include &quot;Sim/Projectiles/Unsynced/SmokeProjectile.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 #include &lt;assert.h&gt;
 
 CR_BIND_DERIVED(CFeature, CSolidObject, )
@@ -132,7 +132,7 @@
 		allyteam = -1;
 	} else {
 		team = newTeam;
-		allyteam = gs-&gt;AllyTeam(newTeam);
+		allyteam = teamHandler-&gt;AllyTeam(newTeam);
 	}
 
 	if (def-&gt;drawType == DRAWTYPE_3DO){
@@ -265,8 +265,8 @@
 		// Work out how much that will cost
 		const float metalUse  = part * def-&gt;metal;
 		const float energyUse = part * def-&gt;energy;
-		if ((gs-&gt;Team(builder-&gt;team)-&gt;metal  &gt;= metalUse)  &amp;&amp;
-		    (gs-&gt;Team(builder-&gt;team)-&gt;energy &gt;= energyUse) &amp;&amp;
+		if ((teamHandler-&gt;Team(builder-&gt;team)-&gt;metal  &gt;= metalUse)  &amp;&amp;
+		    (teamHandler-&gt;Team(builder-&gt;team)-&gt;energy &gt;= energyUse) &amp;&amp;
 				(!luaRules || luaRules-&gt;AllowFeatureBuildStep(builder, this, part))) {
 			builder-&gt;UseMetal(metalUse);
 			builder-&gt;UseEnergy(energyUse);
@@ -279,8 +279,8 @@
 		}
 		else {
 			// update the energy and metal required counts
-			gs-&gt;Team(builder-&gt;team)-&gt;energyPull += energyUse;
-			gs-&gt;Team(builder-&gt;team)-&gt;metalPull  += metalUse;
+			teamHandler-&gt;Team(builder-&gt;team)-&gt;energyPull += energyUse;
+			teamHandler-&gt;Team(builder-&gt;team)-&gt;metalPull  += metalUse;
 		}
 		return false;
 	}
@@ -318,7 +318,7 @@
 		const float energyUseScaled = metalFraction * modInfo.reclaimFeatureEnergyCostFactor;
 
 		if (!builder-&gt;UseEnergy(energyUseScaled)) {
-			gs-&gt;Team(builder-&gt;team)-&gt;energyPull += energyUseScaled;
+			teamHandler-&gt;Team(builder-&gt;team)-&gt;energyPull += energyUseScaled;
 			return false;
 		}
 

Modified: branches/caiinterface/rts/Sim/Features/FeatureHandler.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Features/FeatureHandler.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Features/FeatureHandler.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -25,13 +25,13 @@
 #include &quot;Sim/Misc/CollisionVolume.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
 #include &quot;Sim/Units/CommandAI/BuilderCAI.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
-#include &quot;System/EventHandler.h&quot;
-#include &quot;System/TimeProfiler.h&quot;
-#include &quot;System/Platform/ConfigHandler.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
+#include &quot;EventHandler.h&quot;
+#include &quot;TimeProfiler.h&quot;
+#include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;creg/STL_List.h&quot;
 #include &quot;creg/STL_Set.h&quot;
-#include &quot;System/Exceptions.h&quot;
+#include &quot;Exceptions.h&quot;
 
 using namespace std;
 

Modified: branches/caiinterface/rts/Sim/Features/FeatureHandler.h
===================================================================
--- branches/caiinterface/rts/Sim/Features/FeatureHandler.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Features/FeatureHandler.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,7 +1,6 @@
 #ifndef __FEATURE_HANDLER_H__
 #define __FEATURE_HANDLER_H__
 
-#include &quot;Object.h&quot;
 #include &lt;string&gt;
 #include &lt;list&gt;
 #include &lt;vector&gt;
@@ -18,7 +17,7 @@
 
 #define DRAW_QUAD_SIZE 32
 
-class CFeatureHandler : public CObject, public boost::noncopyable
+class CFeatureHandler : public boost::noncopyable
 {
 	CR_DECLARE(CFeatureHandler);
 	CR_DECLARE_SUB(DrawQuad);

Modified: branches/caiinterface/rts/Sim/Misc/AirBaseHandler.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Misc/AirBaseHandler.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Misc/AirBaseHandler.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -2,7 +2,8 @@
 #include &quot;mmgr.h&quot;
 #include &quot;AirBaseHandler.h&quot;
 
-#include &quot;Game/GlobalSynced.h&quot;
+#include &quot;GlobalSynced.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/COB/CobInstance.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
@@ -14,7 +15,7 @@
 CR_REG_METADATA(CAirBaseHandler,(
 	CR_MEMBER(freeBases),
 	CR_MEMBER(bases),
-	CR_RESERVED(16)	
+	CR_RESERVED(16)
 	));
 
 CR_BIND_DERIVED(CAirBaseHandler::LandingPad, CObject, (NULL, 0, NULL));
@@ -42,7 +43,7 @@
 CAirBaseHandler::~CAirBaseHandler(void)
 {
 	//shouldnt be any bases left here...
-	for (int a = 0; a &lt; gs-&gt;activeAllyTeams; ++a) {
+	for (int a = 0; a &lt; teamHandler-&gt;ActiveAllyTeams(); ++a) {
 		for (airBaseLstIt bi = bases[a].begin(); bi != bases[a].end(); ++bi) {
 			for (padLstIt pi = (*bi)-&gt;pads.begin(); pi !=(*bi)-&gt;pads.end(); ++pi) {
 				delete *pi;

Modified: branches/caiinterface/rts/Sim/Misc/AirBaseHandler.h
===================================================================
--- branches/caiinterface/rts/Sim/Misc/AirBaseHandler.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Misc/AirBaseHandler.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -5,8 +5,8 @@
 #include &lt;boost/noncopyable.hpp&gt;
 
 #include &quot;Object.h&quot;
-#include &quot;System/float3.h&quot;
-#include &quot;Game/GlobalConstants.h&quot;
+#include &quot;float3.h&quot;
+#include &quot;GlobalConstants.h&quot;
 
 class CUnit;
 

Modified: branches/caiinterface/rts/Sim/Misc/CategoryHandler.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Misc/CategoryHandler.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Misc/CategoryHandler.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -6,7 +6,7 @@
 #include &quot;CategoryHandler.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;creg/STL_Map.h&quot;
-#include &quot;System/Util.h&quot;
+#include &quot;Util.h&quot;
 
 CR_BIND(CCategoryHandler, );
 

Modified: branches/caiinterface/rts/Sim/Misc/CollisionHandler.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Misc/CollisionHandler.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Misc/CollisionHandler.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,15 +1,15 @@
 #include &quot;StdAfx.h&quot;
 #include &quot;mmgr.h&quot;
 
-#include &quot;System/FastMath.h&quot;
-#include &quot;System/float3.h&quot;
-#include &quot;System/Matrix44f.h&quot;
+#include &quot;FastMath.h&quot;
+#include &quot;float3.h&quot;
+#include &quot;Matrix44f.h&quot;
 
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Features/Feature.h&quot;
 #include &quot;GroundBlockingObjectMap.h&quot;
 
-#include &quot;Game/GlobalSynced.h&quot;
+#include &quot;GlobalSynced.h&quot;
 
 #include &quot;CollisionHandler.h&quot;
 #include &quot;CollisionVolume.h&quot;

Modified: branches/caiinterface/rts/Sim/Misc/CollisionHandler.h
===================================================================
--- branches/caiinterface/rts/Sim/Misc/CollisionHandler.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Misc/CollisionHandler.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -31,8 +31,8 @@
 		CCollisionHandler() {}
 		~CCollisionHandler() {}
 
-		static bool DetectHit(const CUnit*, const float3&amp;, const float3&amp;, CollisionQuery* q = 0x0);
-		static bool DetectHit(const CFeature*, const float3&amp;, const float3&amp;, CollisionQuery* q = 0x0);
+		static bool DetectHit(const CUnit*, const float3&amp;, const float3&amp;, CollisionQuery* q = NULL);
+		static bool DetectHit(const CFeature*, const float3&amp;, const float3&amp;, CollisionQuery* q = NULL);
 		static bool MouseHit(const CUnit*, const float3&amp; p0, const float3&amp; p1, const CollisionVolume*, CollisionQuery* q);
 
 	private:

Modified: branches/caiinterface/rts/Sim/Misc/DamageArrayHandler.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Misc/DamageArrayHandler.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Misc/DamageArrayHandler.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -10,8 +10,8 @@
 #include &quot;Game/Game.h&quot;
 #include &quot;Lua/LuaParser.h&quot;
 #include &quot;creg/STL_Map.h&quot;
-#include &quot;System/Util.h&quot;
-#include &quot;System/Exceptions.h&quot;
+#include &quot;Util.h&quot;
+#include &quot;Exceptions.h&quot;
 
 using namespace std;
 

Copied: branches/caiinterface/rts/Sim/Misc/GlobalConstants.h (from rev 7023, trunk/rts/Sim/Misc/GlobalConstants.h)
===================================================================
--- branches/caiinterface/rts/Sim/Misc/GlobalConstants.h	                        (rev 0)
+++ branches/caiinterface/rts/Sim/Misc/GlobalConstants.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -0,0 +1,62 @@
+#ifndef GLOBAL_CONSTANTS_H
+#define GLOBAL_CONSTANTS_H
+
+/**
+ * @brief maximum world size
+ *
+ * Defines the maximum world size as 1000000
+ */
+const int MAX_WORLD_SIZE = 1000000;
+
+/**
+ * @brief square size
+ *
+ * Defines the size of 1 square as 8
+ */
+const int  SQUARE_SIZE = 8;
+
+/**
+ * @brief game speed
+ *
+ * Defines the game speed as 30
+ */
+const int GAME_SPEED = 30;
+
+/**
+ * @brief max view range
+ *
+ * Defines the maximum view range as 8000
+ */
+const int MAX_VIEW_RANGE = 8000;
+
+/**
+ * @brief max teams
+ *
+ * Defines the maximum number of teams
+ * as 17 (16 real teams, and an extra slot for the GAIA team)
+ */
+const int MAX_TEAMS = 17;
+
+/**
+ * @brief max players
+ *
+ * Defines the maximum number of players as 32
+ */
+const int MAX_PLAYERS = 32;
+
+/**
+ * @brief near plane
+ *
+ * Defines the near plane as 2.8f
+ */
+const float NEAR_PLANE = 2.8f;
+
+/**
+ * @brief randint max
+ *
+ * Defines the maximum random integer as 0x7fff
+ */
+const int RANDINT_MAX = 0x7fff;
+
+
+#endif

Copied: branches/caiinterface/rts/Sim/Misc/GlobalSynced.cpp (from rev 7023, trunk/rts/Sim/Misc/GlobalSynced.cpp)
===================================================================
--- branches/caiinterface/rts/Sim/Misc/GlobalSynced.cpp	                        (rev 0)
+++ branches/caiinterface/rts/Sim/Misc/GlobalSynced.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -0,0 +1,138 @@
+#include &quot;StdAfx.h&quot;
+#include &quot;GlobalSynced.h&quot;
+
+#include &lt;assert.h&gt;
+#include &lt;cstring&gt;
+
+#include &quot;Game/GameSetup.h&quot;
+#include &quot;Game/PlayerHandler.h&quot;
+#include &quot;Lua/LuaGaia.h&quot;
+#include &quot;Lua/LuaRules.h&quot;
+#include &quot;Team.h&quot;
+#include &quot;TeamHandler.h&quot;
+#include &quot;Util.h&quot;
+
+
+/**
+ * @brief global synced
+ *
+ * Global instance of CGlobalSyncedStuff
+ */
+CGlobalSyncedStuff* gs;
+
+
+
+CR_BIND(CGlobalSyncedStuff,);
+
+CR_REG_METADATA(CGlobalSyncedStuff, (
+	CR_MEMBER(randSeed),
+	CR_MEMBER(initRandSeed),
+	CR_MEMBER(frameNum),
+	CR_MEMBER(speedFactor),
+	CR_MEMBER(userSpeedFactor),
+	CR_MEMBER(paused),
+	CR_MEMBER(tempNum),
+	CR_MEMBER(godMode),
+	CR_MEMBER(globalLOS),
+	CR_MEMBER(cheatEnabled),
+	CR_MEMBER(noHelperAIs),
+	CR_MEMBER(editDefsEnabled),
+	CR_MEMBER(useLuaRules),
+	CR_MEMBER(useLuaGaia),
+	CR_MEMBER(gameMode),
+	CR_MEMBER(activeTeamsBackwardCompatForLuaBinder),
+	CR_RESERVED(64)
+));
+
+
+/**
+ * Initializes variables in CGlobalSyncedStuff
+ */
+CGlobalSyncedStuff::CGlobalSyncedStuff()
+{
+	hmapx = 256;
+	hmapy = 256;
+	randSeed = 18655;
+	initRandSeed = randSeed;
+	frameNum = 0;
+	speedFactor = 1;
+	userSpeedFactor = 1;
+	paused = false;
+	godMode = false;
+	globalLOS = false;
+	cheatEnabled = false;
+	noHelperAIs = false;
+	editDefsEnabled = false;
+	tempNum = 2;
+	gameMode = 0;
+	useLuaGaia = true;
+	useLuaRules = true;
+
+	// TODO: put this somewhere else (playerHandler is unsynced, even)
+	playerHandler = new CPlayerHandler();
+	teamHandler = new CTeamHandler();
+}
+
+
+CGlobalSyncedStuff::~CGlobalSyncedStuff()
+{
+	// TODO: put this somewhere else (playerHandler is unsynced, even)
+	SafeDelete(playerHandler);
+	SafeDelete(teamHandler);
+}
+
+
+void CGlobalSyncedStuff::LoadFromSetup(const CGameSetup* setup)
+{
+	gameMode = setup-&gt;gameMode;
+	noHelperAIs = !!setup-&gt;noHelperAIs;
+
+	useLuaGaia  = CLuaGaia::SetConfigString(setup-&gt;luaGaiaStr);
+	useLuaRules = CLuaRules::SetConfigString(setup-&gt;luaRulesStr);
+
+	// TODO: this call is unsynced, technically
+	playerHandler-&gt;LoadFromSetup(setup);
+
+	teamHandler-&gt;LoadFromSetup(setup);
+
+	activeTeamsBackwardCompatForLuaBinder = teamHandler-&gt;ActiveTeams();
+}
+
+/**
+ * @return synced random integer
+ *
+ * returns a synced random integer
+ */
+int CGlobalSyncedStuff::randInt()
+{
+	randSeed = (randSeed * 214013L + 2531011L);
+	return randSeed &amp; RANDINT_MAX;
+}
+
+/**
+ * @return synced random float
+ *
+ * returns a synced random float
+ */
+float CGlobalSyncedStuff::randFloat()
+{
+	randSeed = (randSeed * 214013L + 2531011L);
+	return float(randSeed &amp; RANDINT_MAX)/RANDINT_MAX;
+}
+
+/**
+ * @return synced random vector
+ *
+ * returns a synced random vector
+ */
+float3 CGlobalSyncedStuff::randVector()
+{
+	float3 ret;
+	do {
+		ret.x = randFloat()*2-1;
+		ret.y = randFloat()*2-1;
+		ret.z = randFloat()*2-1;
+	} while(ret.SqLength()&gt;1);
+
+	return ret;
+}

Copied: branches/caiinterface/rts/Sim/Misc/GlobalSynced.h (from rev 7023, trunk/rts/Sim/Misc/GlobalSynced.h)
===================================================================
--- branches/caiinterface/rts/Sim/Misc/GlobalSynced.h	                        (rev 0)
+++ branches/caiinterface/rts/Sim/Misc/GlobalSynced.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -0,0 +1,210 @@
+#ifndef GLOBAL_UNSYNCED_H
+#define GLOBAL_UNSYNCED_H
+
+#include &lt;string&gt;
+
+#include &quot;float3.h&quot;
+#include &quot;GlobalConstants.h&quot;
+#include &quot;creg/creg.h&quot;
+
+
+class CGameSetup;
+class CTeam;
+class CPlayer;
+
+/**
+ * @brief Global synced stuff
+ *
+ * Class contains globally accessible
+ * stuff that remains synced.
+ */
+class CGlobalSyncedStuff
+{
+public:
+	CR_DECLARE(CGlobalSyncedStuff);
+	CGlobalSyncedStuff();  //!&lt; Constructor
+	~CGlobalSyncedStuff(); //!&lt; Destructor
+	void LoadFromSetup(const CGameSetup*);
+
+	int    randInt();    //!&lt; synced random int
+	float  randFloat();  //!&lt; synced random float
+	float3 randVector(); //!&lt; synced random vector
+
+	void SetRandSeed(unsigned int seed, bool init = false) {
+		randSeed = seed;
+		if (init) { initRandSeed = randSeed; }
+	}
+	unsigned int GetRandSeed()     const { return randSeed; }
+	unsigned int GetInitRandSeed() const { return initRandSeed; }
+
+	/**
+	* @brief frame number
+	*
+	* Stores the current frame number
+	*/
+	int frameNum;
+
+	/**
+	* @brief speed factor
+	*
+	* Contains the actual gamespeed used by the game
+	*/
+	float speedFactor;
+
+	/**
+	* @brief user speed factor
+	*
+	* Contains the user's speed factor.
+	* The real gamespeed can be up to this
+	* but is lowered if a computer can't keep up
+	*/
+	float userSpeedFactor;
+
+	/**
+	* @brief paused
+	*
+	* Holds whether the game is paused
+	*/
+	bool paused;
+
+	/**
+	* @brief map x
+	*
+	* The map's number of squares in the x direction
+	* (note that the number of vertices is one more)
+	*/
+	int mapx;
+
+	/**
+	* @brief map y
+	*
+	* The map's number of squares in the y direction
+	*/
+	int mapy;
+
+	/**
+	* @brief map squares
+	*
+	* Total number of squares on the map
+	*/
+	int mapSquares;
+
+	/**
+	* @brief half map x
+	*
+	* Contains half of the number of squares in the x direction
+	*/
+	int hmapx;
+
+	/**
+	* @brief half map y
+	*
+	* Contains half of the number of squares in the y direction
+	*/
+	int hmapy;
+
+	/**
+	* @brief map x power of 2
+	*
+	* Map's size in the x direction rounded
+	* up to the next power of 2
+	*/
+	int pwr2mapx;
+
+	/**
+	* @brief map y power of 2
+	*
+	* Map's size in the y direction rounded
+	* up to the next power of 2
+	*/
+	int pwr2mapy;
+
+	/**
+	* @brief temp num
+	*
+	* Used for getting temporary but unique numbers
+	* (increase after each use)
+	*/
+	int tempNum;
+
+	/**
+	* @brief god mode
+	*
+	* Whether god mode is enabled, allows all players to control all units (even specs)
+	*/
+	bool godMode;
+
+	/**
+	* @brief global line-of-sight
+	*
+	* Whether everything on the map is visible at all times
+	*/
+	bool globalLOS;
+
+	/**
+	* @brief cheat enabled
+	*
+	* Whether cheating is enabled
+	*/
+	bool cheatEnabled;
+
+	/**
+	* @brief disable helper AIs
+	*
+	* Whether helper AIs are allowed, including GroupAI and LuaUI control widgets
+	*/
+	bool noHelperAIs;
+
+	/**
+	* @brief definition editing enabled
+	*
+	* Whether definition editing is enabled
+	*/
+	bool editDefsEnabled;
+
+	/**
+	* @brief LuaRules control
+	*
+	* Whether or not LuaRules is enabled
+	*/
+	bool useLuaRules;
+
+	/**
+	* @brief LuaGaia control
+	*
+	* Whether or not LuaGaia is enabled
+	*/
+	bool useLuaGaia;
+
+	/**
+	* @brief game mode
+	*
+	* Determines the commander mode of this game
+	*   0: game continues after commander dies
+	*   1: game ends when commander dies
+	*   2: lineage mode (all descendants die when a commander dies)
+	*/
+	int gameMode;
+
+	// do not use, backward compatibility
+	int activeTeamsBackwardCompatForLuaBinder;
+
+private:
+	/**
+	* @brief random seed
+	*
+	* Holds the synced random seed
+	*/
+	int randSeed;
+
+	/**
+	* @brief initial random seed
+	*
+	* Holds the synced initial random seed
+	*/
+	int initRandSeed;
+};
+
+extern CGlobalSyncedStuff* gs;
+
+#endif //GLOBAL_UNSYNCED_H

Modified: branches/caiinterface/rts/Sim/Misc/GroundBlockingObjectMap.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Misc/GroundBlockingObjectMap.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Misc/GroundBlockingObjectMap.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -4,7 +4,7 @@
 
 #include &quot;GroundBlockingObjectMap.h&quot;
 
-#include &quot;Game/GlobalSynced.h&quot;
+#include &quot;GlobalSynced.h&quot;
 #include &quot;Sim/Objects/SolidObject.h&quot;
 #include &quot;Sim/Path/PathManager.h&quot;
 #include &quot;creg/STL_Map.h&quot;

Modified: branches/caiinterface/rts/Sim/Misc/InterceptHandler.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Misc/InterceptHandler.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Misc/InterceptHandler.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -3,14 +3,15 @@
 
 #include &quot;InterceptHandler.h&quot;
 
-#include &quot;Game/GlobalSynced.h&quot;
+#include &quot;GlobalSynced.h&quot;
 #include &quot;Sim/Weapons/Weapon.h&quot;
 #include &quot;Sim/Projectiles/WeaponProjectiles/WeaponProjectile.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
 #include &quot;Sim/Weapons/PlasmaRepulser.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;LogOutput.h&quot;
-#include &quot;System/myMath.h&quot;
+#include &quot;myMath.h&quot;
 #include &quot;creg/STL_List.h&quot;
 
 CR_BIND(CInterceptHandler, )
@@ -54,7 +55,7 @@
 
 	for(std::list&lt;CWeapon*&gt;::iterator wi=interceptors.begin();wi!=interceptors.end();++wi){
 		CWeapon* w=*wi;
-		if ((targTeam==-1 || !gs-&gt;Ally(w-&gt;owner-&gt;allyteam,targTeam)) &amp;&amp; (target-&gt;weaponDef-&gt;targetable &amp; w-&gt;weaponDef-&gt;interceptor) &amp;&amp; w-&gt;weaponPos.SqDistance2D(destination) &lt; Square(w-&gt;weaponDef-&gt;coverageRange)){
+		if ((targTeam==-1 || !teamHandler-&gt;Ally(w-&gt;owner-&gt;allyteam,targTeam)) &amp;&amp; (target-&gt;weaponDef-&gt;targetable &amp; w-&gt;weaponDef-&gt;interceptor) &amp;&amp; w-&gt;weaponPos.SqDistance2D(destination) &lt; Square(w-&gt;weaponDef-&gt;coverageRange)){
 			w-&gt;incoming.push_back(target);
 			w-&gt;AddDeathDependence(target);
 		}

Modified: branches/caiinterface/rts/Sim/Misc/LosHandler.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Misc/LosHandler.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Misc/LosHandler.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -9,8 +9,9 @@
 
 #include &quot;LosHandler.h&quot;
 
-#include &quot;Sim/ModInfo.h&quot;
+#include &quot;ModInfo.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;TimeProfiler.h&quot;
 #include &quot;LogOutput.h&quot;
@@ -96,7 +97,7 @@
 	losSizeY(std::max(1, gs-&gt;mapy &gt;&gt; losMipLevel)),
 	requireSonarUnderWater(modInfo.requireSonarUnderWater)
 {
-	for (int a = 0; a &lt; gs-&gt;activeAllyTeams; ++a) {
+	for (int a = 0; a &lt; teamHandler-&gt;ActiveAllyTeams(); ++a) {
 		losMap[a].resize(losSizeX * losSizeY, 0);
 		airLosMap[a].resize(airSizeX * airSizeY, 0);
 	}
@@ -203,7 +204,7 @@
 void CLosHandler::LosAdd(LosInstance* instance)
 {
 	assert(instance);
-	assert(instance-&gt;allyteam &lt; gs-&gt;activeAllyTeams);
+	assert(instance-&gt;allyteam &lt; teamHandler-&gt;ActiveAllyTeams());
 	assert(instance-&gt;allyteam &gt;= 0);
 
 	const int allyteam  = instance-&gt;allyteam;

Copied: branches/caiinterface/rts/Sim/Misc/ModInfo.cpp (from rev 7023, trunk/rts/Sim/Misc/ModInfo.cpp)
===================================================================
--- branches/caiinterface/rts/Sim/Misc/ModInfo.cpp	                        (rev 0)
+++ branches/caiinterface/rts/Sim/Misc/ModInfo.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -0,0 +1,129 @@
+
+#include &quot;StdAfx.h&quot;
+#include &quot;mmgr.h&quot;
+
+#include &quot;GlobalUnsynced.h&quot;
+#include &quot;ModInfo.h&quot;
+#include &quot;Game/GameSetup.h&quot;
+#include &quot;Lua/LuaParser.h&quot;
+#include &quot;Lua/LuaSyncedRead.h&quot;
+#include &quot;Sim/Units/Unit.h&quot;
+#include &quot;Sim/Units/UnitTypes/Builder.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;Platform/ConfigHandler.h&quot;
+#include &quot;FileSystem/ArchiveScanner.h&quot;
+#include &quot;Exceptions.h&quot;
+
+
+CModInfo modInfo;
+
+
+void CModInfo::Init(const char* modname)
+{
+	filename = modname;
+
+	humanName = archiveScanner-&gt;ModArchiveToModName(modname);
+
+	const CArchiveScanner::ModData md = archiveScanner-&gt;ModArchiveToModData(modname);
+
+	shortName   = md.shortName;
+	version     = md.version;
+	mutator     = md.mutator;
+	description = md.description;
+
+	// initialize the parser
+	LuaParser parser(&quot;gamedata/modrules.lua&quot;,
+	                 SPRING_VFS_MOD_BASE, SPRING_VFS_ZIP);
+	// customize the defs environment
+	parser.GetTable(&quot;Spring&quot;);
+	parser.AddFunc(&quot;GetModOptions&quot;, LuaSyncedRead::GetModOptions);
+	parser.EndTable();
+	parser.Execute();
+	if (!parser.IsValid()) {
+		logOutput.Print(&quot;Error loading modrules, using defaults&quot;);
+		logOutput.Print(parser.GetErrorLog());
+	}
+	const LuaTable root = parser.GetRoot();
+
+	// determine whether the modder allows the user to use team coloured nanospray
+	const LuaTable nanosprayTbl = root.SubTable(&quot;nanospray&quot;);
+	allowTeamColors = nanosprayTbl.GetBool(&quot;allow_team_colors&quot;, true);
+	if (allowTeamColors) {
+		// Load the users preference for team coloured nanospray
+		gu-&gt;teamNanospray = !!configHandler.GetInt(&quot;TeamNanoSpray&quot;, 0);
+	}
+
+	// constructions
+	const LuaTable constructionTbl = root.SubTable(&quot;construction&quot;);
+	constructionDecay = constructionTbl.GetBool(&quot;constructionDecay&quot;, true);
+	constructionDecayTime = (int)(constructionTbl.GetFloat(&quot;constructionDecayTime&quot;, 6.66) * 30);
+	constructionDecaySpeed = constructionTbl.GetFloat(&quot;constructionDecaySpeed&quot;, 0.03);
+
+	// reclaim
+	const LuaTable reclaimTbl = root.SubTable(&quot;reclaim&quot;);
+	multiReclaim  = reclaimTbl.GetInt(&quot;multiReclaim&quot;,  0);
+	reclaimMethod = reclaimTbl.GetInt(&quot;reclaimMethod&quot;, 1);
+	reclaimUnitMethod = reclaimTbl.GetInt(&quot;unitMethod&quot;, 1);
+	reclaimUnitEnergyCostFactor = reclaimTbl.GetFloat(&quot;unitEnergyCostFactor&quot;, 0.0);
+	reclaimUnitEfficiency = reclaimTbl.GetFloat(&quot;unitEfficiency&quot;, 1.0);
+	reclaimFeatureEnergyCostFactor = reclaimTbl.GetFloat(&quot;featureEnergyCostFactor&quot;, 0.0);
+	reclaimAllowEnemies = reclaimTbl.GetBool(&quot;allowEnemies&quot;, true);
+	reclaimAllowAllies = reclaimTbl.GetBool(&quot;allowAllies&quot;, true);
+
+	// repair
+	const LuaTable repairTbl = root.SubTable(&quot;repair&quot;);
+	repairEnergyCostFactor = repairTbl.GetFloat(&quot;energyCostFactor&quot;, 0.0);
+
+	// resurrect
+	const LuaTable resurrectTbl = root.SubTable(&quot;resurrect&quot;);
+	resurrectEnergyCostFactor  = resurrectTbl.GetFloat(&quot;energyCostFactor&quot;,  0.5);
+
+	// capture
+	const LuaTable captureTbl = root.SubTable(&quot;capture&quot;);
+	captureEnergyCostFactor = captureTbl.GetFloat(&quot;energyCostFactor&quot;, 0.0);
+
+	// fire-at-dead-units
+	const LuaTable fireAtDeadTbl = root.SubTable(&quot;fireAtDead&quot;);
+	fireAtKilled   = fireAtDeadTbl.GetBool(&quot;fireAtKilled&quot;, false);
+	fireAtCrashing = fireAtDeadTbl.GetBool(&quot;fireAtCrashing&quot;, false);
+
+	// transportability
+	const LuaTable transportTbl = root.SubTable(&quot;transportability&quot;);
+	transportAir    = transportTbl.GetInt(&quot;transportAir&quot;,   false);
+	transportShip   = transportTbl.GetInt(&quot;transportShip&quot;,  false);
+	transportHover  = transportTbl.GetInt(&quot;transportHover&quot;, false);
+	transportGround = transportTbl.GetInt(&quot;transportGround&quot;, true);
+
+	// experience
+	const LuaTable experienceTbl = root.SubTable(&quot;experience&quot;);
+	CUnit::SetExpMultiplier (experienceTbl.GetFloat(&quot;experienceMult&quot;, 1.0f));
+	CUnit::SetExpPowerScale (experienceTbl.GetFloat(&quot;powerScale&quot;,  1.0f));		
+	CUnit::SetExpHealthScale(experienceTbl.GetFloat(&quot;healthScale&quot;, 0.7f));		
+	CUnit::SetExpReloadScale(experienceTbl.GetFloat(&quot;reloadScale&quot;, 0.4f));
+
+	// flanking bonus
+	const LuaTable flankingBonusTbl = root.SubTable(&quot;flankingBonus&quot;);
+	flankingBonusModeDefault = flankingBonusTbl.GetInt(&quot;defaultMode&quot;, 1);
+	
+	// sensors
+	const LuaTable sensors = root.SubTable(&quot;sensors&quot;);
+	requireSonarUnderWater = sensors.GetBool(&quot;requireSonarUnderWater&quot;, true);
+	/// LoS
+	const LuaTable los = sensors.SubTable(&quot;los&quot;);
+	// losMipLevel is used as index to readmap-&gt;mipHeightmap,
+	// so the max value is CReadMap::numHeightMipMaps - 1
+	losMipLevel = los.GetInt(&quot;losMipLevel&quot;, 1);
+	losMul = los.GetFloat(&quot;losMul&quot;, 1.0f);
+	if ((losMipLevel &lt; 0) || (losMipLevel &gt; 6)) {
+		throw content_error(&quot;Sensors\\Los\\LosMipLevel out of bounds. &quot;
+		                    &quot;The minimum value is 0. The maximum value is 6.&quot;);
+	}
+	// airLosMipLevel doesn't have such restrictions, it's just used in various
+	// bitshifts with signed integers
+	airMipLevel = los.GetInt(&quot;airMipLevel&quot;, 2);
+	if ((airMipLevel &lt; 0) || (airMipLevel &gt; 30)) {
+		throw content_error(&quot;Sensors\\Los\\AirLosMipLevel out of bounds. &quot;
+		                    &quot;The minimum value is 0. The maximum value is 30.&quot;);
+	}
+	airLosMul = los.GetFloat(&quot;airLosMul&quot;, 1.0f);
+}

Copied: branches/caiinterface/rts/Sim/Misc/ModInfo.h (from rev 7023, trunk/rts/Sim/Misc/ModInfo.h)
===================================================================
--- branches/caiinterface/rts/Sim/Misc/ModInfo.h	                        (rev 0)
+++ branches/caiinterface/rts/Sim/Misc/ModInfo.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -0,0 +1,75 @@
+
+#ifndef MOD_INFO_H
+#define MOD_INFO_H
+
+class CModInfo
+{
+public:
+	CModInfo() {};
+	~CModInfo() {};
+
+	void Init(const char* modname);
+
+	std::string filename; // archive filename
+
+	std::string humanName;
+	std::string shortName;
+	std::string version;
+	std::string mutator;
+	std::string description;
+
+	bool allowTeamColors;
+	
+	// Build behaviour
+	bool constructionDecay;               // Should constructions without builders decay?
+	int constructionDecayTime;            // How long until they start decaying?
+	float constructionDecaySpeed;         // How fast do they decay?
+
+	// Reclaim behaviour
+	int multiReclaim;	                  // 0 = 1 reclaimer per feature max, otherwise unlimited
+	int reclaimMethod;	                  // 0 = gradual reclaim, 1 = all reclaimed at end, otherwise reclaim in reclaimMethod chunks
+	int reclaimUnitMethod;                // 0 = Revert to wireframe, gradual reclaim, 1 = Subtract HP, give full metal at end, default 1
+	float reclaimUnitEnergyCostFactor;    // How much energy should reclaiming a unit cost, default 0.0
+	float reclaimUnitEfficiency;          // How much metal should reclaim return, default 1.0
+	float reclaimFeatureEnergyCostFactor; // How much should energy should reclaiming a feature cost, default 0.0
+	bool reclaimAllowEnemies;             // Allow reclaiming enemies? default true
+	bool reclaimAllowAllies;              // Allow reclaiming allies? default true
+
+	// Repair behaviour
+	float repairEnergyCostFactor;         // How much should energy should repair cost, default 0.0
+
+	// Resurrect behaviour
+	float resurrectEnergyCostFactor;      // How much should energy should resurrect cost, default 0.5
+
+	// Capture behaviour
+	float captureEnergyCostFactor;        // How much should energy should capture cost, default 0.0
+
+	// Transportation behaviour
+	int transportGround;                  // 0 = all ground units cannot be transported, 1 = all ground units can be transported (mass and size restrictions still apply). Defaults to 1.
+	int transportHover;                   // 0 = all hover units cannot be transported, 1 = all hover units can be transported (mass and size restrictions still apply). Defaults to 0.
+	int transportShip;                    // 0 = all naval units cannot be transported, 1 = all naval units can be transported (mass and size restrictions still apply). Defaults to 0.
+	int transportAir;                     // 0 = all air units cannot be transported, 1 = all air units can be transported (mass and size restrictions still apply). Defaults to 0.
+
+	// Fire-on-dying-units behaviour
+	int fireAtKilled;                     // 1 = units fire at enemies running Killed() script, 0 = units ignore such enemies
+	int fireAtCrashing;                   // 1 = units fire at crashing aircrafts, 0 = units ignore crashing aircrafts
+
+	int flankingBonusModeDefault;         // 0=no flanking bonus;  1=global coords, mobile;  2=unit coords, mobile;  3=unit coords, locked
+	
+	// Sensor behaviour
+	/// miplevel for los
+	int losMipLevel;
+	/// miplevel to use for airlos
+	int airMipLevel;
+	/// units sightdistance will be multiplied with this, for testing purposes
+	float losMul;
+	/// units airsightdistance will be multiplied with this, for testing purposes
+	float airLosMul;
+	/// when underwater, units are not in LOS unless also in sonar
+	bool requireSonarUnderWater;
+};
+
+extern CModInfo modInfo;
+
+
+#endif

Modified: branches/caiinterface/rts/Sim/Misc/QuadField.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Misc/QuadField.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Misc/QuadField.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -8,7 +8,7 @@
 
 #include &quot;QuadField.h&quot;
 
-#include &quot;Game/GlobalSynced.h&quot;
+#include &quot;GlobalSynced.h&quot;
 #include &quot;Sim/Features/Feature.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;LogOutput.h&quot;

Modified: branches/caiinterface/rts/Sim/Misc/QuadField.h
===================================================================
--- branches/caiinterface/rts/Sim/Misc/QuadField.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Misc/QuadField.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -11,7 +11,7 @@
 
 #include &quot;creg/creg.h&quot;
 #include &quot;float3.h&quot;
-#include &quot;Game/GlobalConstants.h&quot;
+#include &quot;GlobalConstants.h&quot;
 
 class CUnit;
 class CWorldObject;

Modified: branches/caiinterface/rts/Sim/Misc/RadarHandler.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Misc/RadarHandler.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Misc/RadarHandler.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -6,6 +6,7 @@
 #include &quot;LosHandler.h&quot;
 #include &quot;Rendering/UnitModels/3DOParser.h&quot;
 #include &quot;Map/ReadMap.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 
 
 CR_BIND(CRadarHandler, (false));
@@ -32,7 +33,7 @@
 	const int size = xsize*ysize*2;
 
 	// NOTE This could be tricky if gs is serialized after radarHandler.
-	for (int a = 0; a &lt; gs-&gt;activeAllyTeams; ++a) {
+	for (int a = 0; a &lt; teamHandler-&gt;ActiveAllyTeams(); ++a) {
 		s.Serialize(&amp;radarMaps[a].front(), size);
 		if (!circularRadar) {
 			s.Serialize(&amp;airRadarMaps[a].front(), size);
@@ -61,7 +62,7 @@
 	commonJammerMap.resize(size, 0);
 	commonSonarJammerMap.resize(size, 0);
 
-	for (int a = 0; a &lt; gs-&gt;activeAllyTeams; ++a) {
+	for (int a = 0; a &lt; teamHandler-&gt;ActiveAllyTeams(); ++a) {
 		radarMaps[a].resize(size, 0);
 		sonarMaps[a].resize(size, 0);
 		seismicMaps[a].resize(size, 0);

Copied: branches/caiinterface/rts/Sim/Misc/SideParser.cpp (from rev 7023, trunk/rts/Sim/Misc/SideParser.cpp)
===================================================================
--- branches/caiinterface/rts/Sim/Misc/SideParser.cpp	                        (rev 0)
+++ branches/caiinterface/rts/Sim/Misc/SideParser.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -0,0 +1,155 @@
+
+#include &quot;StdAfx.h&quot;
+
+#include &lt;string&gt;
+#include &lt;set&gt;
+using std::string;
+using std::set;
+
+#include &quot;mmgr.h&quot;
+
+#include &quot;SideParser.h&quot;
+#include &quot;Lua/LuaParser.h&quot;
+#include &quot;Lua/LuaSyncedRead.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;Util.h&quot;
+
+
+SideParser sideParser;
+
+
+/******************************************************************************/
+
+SideParser::SideParser()
+{
+}
+
+
+SideParser::~SideParser()
+{
+}
+
+
+bool SideParser::Load()
+{
+	dataVec.clear();
+	errorLog.clear();
+
+	LuaParser parser(&quot;gamedata/sidedata.lua&quot;,
+	                 SPRING_VFS_MOD_BASE, SPRING_VFS_MOD_BASE);
+#if !defined UNITSYNC &amp;&amp; !defined DEDICATED
+	// this should not be included with unitsync:
+	// 1. avoids linkage with LuaSyncedRead
+	// 2. ModOptions are not valid during unitsync mod parsing
+	parser.GetTable(&quot;Spring&quot;);
+	parser.AddFunc(&quot;GetModOptions&quot;, LuaSyncedRead::GetModOptions);
+	parser.EndTable();
+#endif
+	if (!parser.Execute()) {
+		errorLog = parser.GetErrorLog();
+		return false;
+	}
+
+	set&lt;string&gt; sideSet;
+
+	const LuaTable root = parser.GetRoot();
+	for (int i = 1; /* no-op */; i++) {
+		const LuaTable sideTable = root.SubTable(i);
+		if (!sideTable.IsValid()) {
+			break;
+		}
+
+		Data data;
+		data.caseName  = sideTable.GetString(&quot;name&quot;, &quot;&quot;);
+		data.sideName  = StringToLower(data.caseName);
+		data.startUnit = sideTable.GetString(&quot;startUnit&quot;, &quot;&quot;);
+		data.startUnit = StringToLower(data.startUnit);
+
+		if (data.sideName.empty()) {
+			logOutput.Print(&quot;Missing side name: %i&quot;, i);
+		}
+		else if (data.startUnit.empty()) {
+			logOutput.Print(&quot;Missing side start unit: &quot; + data.sideName);
+		}
+		else {
+			if (sideSet.find(data.sideName) != sideSet.end()) {
+				logOutput.Print(&quot;Duplicate side name: &quot; + data.sideName);
+			}
+			else {
+				sideSet.insert(data.sideName);
+				dataVec.push_back(data);
+			}
+		}
+	}
+	return true;
+}
+
+ 
+/******************************************************************************/
+
+const SideParser::Data* SideParser::FindSide(const string&amp; sideName) const
+{
+	const string name = StringToLower(sideName);
+	for (unsigned int i = 0; i &lt; dataVec.size(); i++) {
+		const Data&amp; data = dataVec[i];
+		if (name == data.sideName) {
+			return &data;
+		}
+	}
+	return NULL;
+}
+
+
+const string&amp; SideParser::GetSideName(unsigned int index,
+                                      const string&amp; def) const
+{
+	if (!ValidSide(index)) {
+		return def;
+	}
+	return dataVec[index].sideName;
+}
+
+
+const string&amp; SideParser::GetCaseName(unsigned int index,
+                                      const string&amp; def) const
+{
+	if (!ValidSide(index)) {
+		return def;
+	}
+	return dataVec[index].caseName;
+}
+
+
+const string&amp; SideParser::GetCaseName(const string&amp; name,
+                                      const string&amp; def) const
+{
+	const Data* data = FindSide(name);
+	if (data == NULL) {
+		return def;
+	}
+	return data-&gt;caseName;
+}
+
+
+const string&amp; SideParser::GetStartUnit(unsigned int index,
+                                       const string&amp; def) const
+{
+	if (!ValidSide(index)) {
+		return def;
+	}
+	return dataVec[index].startUnit;
+}
+
+
+const string&amp; SideParser::GetStartUnit(const string&amp; name,
+                                       const string&amp; def) const
+{
+	const Data* data = FindSide(name);
+	if (data == NULL) {
+		return def;
+	}
+	return data-&gt;startUnit;
+}
+
+
+/******************************************************************************/

Copied: branches/caiinterface/rts/Sim/Misc/SideParser.h (from rev 7023, trunk/rts/Sim/Misc/SideParser.h)
===================================================================
--- branches/caiinterface/rts/Sim/Misc/SideParser.h	                        (rev 0)
+++ branches/caiinterface/rts/Sim/Misc/SideParser.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -0,0 +1,54 @@
+
+#ifndef SIDE_PARSER_H
+#define SIDE_PARSER_H
+
+#include &lt;string&gt;
+#include &lt;vector&gt;
+
+
+class SideParser
+{
+	public:
+		SideParser();
+		~SideParser();
+
+		bool Load();
+		const std::string&amp; GetErrorLog() const { return errorLog; }
+
+		const unsigned int GetCount() const { return dataVec.size(); }
+
+		const std::string&amp; GetSideName(unsigned int index,
+		                               const std::string&amp; def = &quot;&quot;) const;
+		const std::string&amp; GetCaseName(unsigned int index,
+		                               const std::string&amp; def = &quot;&quot;) const;
+		const std::string&amp; GetCaseName(const std::string&amp; name,
+		                               const std::string&amp; def = &quot;&quot;) const;
+		const std::string&amp; GetStartUnit(unsigned int index,
+		                                const std::string&amp; def = &quot;&quot;) const;
+		const std::string&amp; GetStartUnit(const std::string&amp; name,
+		                                const std::string&amp; def = &quot;&quot;) const;
+
+		bool ValidSide(unsigned int index) const {
+			return (index &lt; dataVec.size());
+		}
+
+	private:
+		struct Data {
+			std::string caseName;  // full  case
+			std::string sideName;  // lower case
+			std::string startUnit; // lower case
+		};
+		typedef std::vector&lt;Data&gt; DataVec;
+
+		const Data* FindSide(const std::string&amp; sideName) const;
+
+	private:
+		DataVec dataVec;
+		std::string errorLog;
+};
+
+
+extern SideParser sideParser;
+
+
+#endif // SIDE_PARSER_H

Copied: branches/caiinterface/rts/Sim/Misc/Team.cpp (from rev 7023, trunk/rts/Sim/Misc/Team.cpp)
===================================================================
--- branches/caiinterface/rts/Sim/Misc/Team.cpp	                        (rev 0)
+++ branches/caiinterface/rts/Sim/Misc/Team.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -0,0 +1,469 @@
+// Team.cpp: implementation of the CTeam class.
+//
+//////////////////////////////////////////////////////////////////////
+
+#include &quot;StdAfx.h&quot;
+#include &quot;mmgr.h&quot;
+
+#include &quot;Team.h&quot;
+#include &quot;TeamHandler.h&quot;
+
+#include &quot;Messages.h&quot;
+#include &quot;GlobalSynced.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;Game/PlayerHandler.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
+#include &quot;Game/UI/LuaUI.h&quot;
+#include &quot;Lua/LuaRules.h&quot;
+#include &quot;Sim/Units/Unit.h&quot;
+#include &quot;Sim/Units/UnitHandler.h&quot;
+#include &quot;Sim/Units/UnitDef.h&quot;
+#include &quot;ExternalAI/EngineOutHandler.h&quot;
+#include &quot;EventHandler.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
+#include &quot;creg/STL_List.h&quot;
+#include &quot;creg/STL_Map.h&quot;
+#include &quot;creg/STL_Set.h&quot;
+#include &quot;NetProtocol.h&quot;
+
+CR_BIND(CTeam,);
+
+CR_REG_METADATA(CTeam, (
+				CR_MEMBER(teamNum),
+				CR_RESERVED(1),
+				CR_MEMBER(isDead),
+				CR_MEMBER(gaia),
+				CR_MEMBER(color),
+				CR_MEMBER(leader),
+				CR_MEMBER(lineageRoot),
+				CR_MEMBER(handicap),
+				CR_MEMBER(side),
+				CR_MEMBER(isAI),
+				CR_MEMBER(luaAI),
+				CR_MEMBER(skirmishAISpecifier),
+				CR_MEMBER(skirmishAIOptions),
+				CR_MEMBER(units),
+				CR_MEMBER(startPos),
+				CR_MEMBER(metal),
+				CR_MEMBER(energy),
+				CR_MEMBER(metalPull),
+				CR_MEMBER(prevMetalPull),
+				CR_MEMBER(metalIncome),
+				CR_MEMBER(prevMetalIncome),
+				CR_MEMBER(metalExpense),
+				CR_MEMBER(prevMetalExpense),
+				CR_MEMBER(metalUpkeep),
+				CR_MEMBER(prevMetalUpkeep),
+				CR_MEMBER(energyPull),
+				CR_MEMBER(prevEnergyPull),
+				CR_MEMBER(energyIncome),
+				CR_MEMBER(prevEnergyIncome),
+				CR_MEMBER(energyExpense),
+				CR_MEMBER(prevEnergyExpense),
+				CR_MEMBER(energyUpkeep),
+				CR_MEMBER(prevEnergyUpkeep),
+				CR_MEMBER(metalStorage),
+				CR_MEMBER(energyStorage),
+				CR_MEMBER(metalShare),
+				CR_MEMBER(energyShare),
+				CR_MEMBER(delayedMetalShare),
+				CR_MEMBER(delayedEnergyShare),
+				CR_MEMBER(metalSent),
+				CR_MEMBER(metalReceived),
+				CR_MEMBER(energySent),
+				CR_MEMBER(energyReceived),
+				CR_MEMBER(currentStats),
+				CR_MEMBER(lastStatSave),
+				CR_MEMBER(numCommanders),
+				CR_MEMBER(statHistory),
+				CR_MEMBER(modParams),
+				CR_MEMBER(modParamsMap),
+				CR_RESERVED(64)
+				));
+
+CR_BIND(CTeam::Statistics,);
+
+CR_REG_METADATA_SUB(CTeam, Statistics, (
+					CR_MEMBER(metalUsed),
+					CR_MEMBER(energyUsed),
+					CR_MEMBER(metalProduced),
+					CR_MEMBER(energyProduced),
+					CR_MEMBER(metalExcess),
+					CR_MEMBER(energyExcess),
+					CR_MEMBER(metalReceived),
+					CR_MEMBER(energyReceived),
+					CR_MEMBER(metalSent),
+					CR_MEMBER(energySent),
+					CR_MEMBER(damageDealt),
+					CR_MEMBER(damageReceived),
+					CR_MEMBER(unitsProduced),
+					CR_MEMBER(unitsDied),
+					CR_MEMBER(unitsReceived),
+					CR_MEMBER(unitsSent),
+					CR_MEMBER(unitsCaptured),
+					CR_MEMBER(unitsOutCaptured),
+					CR_MEMBER(unitsKilled),
+					CR_RESERVED(16)
+					));
+
+//////////////////////////////////////////////////////////////////////
+// Construction/Destruction
+//////////////////////////////////////////////////////////////////////
+
+CTeam::CTeam()
+: gaia(false),
+  metal(200000),
+  energy(900000),
+  metalPull(0),     prevMetalPull(0),
+  metalIncome(0),   prevMetalIncome(0),
+  metalExpense(0),  prevMetalExpense(0),
+  metalUpkeep(0),   prevMetalUpkeep(0),
+  energyPull(0),    prevEnergyPull(0),
+  energyIncome(0),  prevEnergyIncome(0),
+  energyExpense(0), prevEnergyExpense(0),
+  energyUpkeep(0),  prevEnergyUpkeep(0),
+  metalStorage(1000000),
+  energyStorage(1000000),
+  metalShare(0.99f),
+  energyShare(0.95f),
+  delayedMetalShare(0),
+  delayedEnergyShare(0),
+  metalSent(0),
+  metalReceived(0),
+  energySent(0),
+  energyReceived(0),
+  side(&quot;arm&quot;),
+  isAI(false),
+  luaAI(&quot;&quot;),
+//  skirmishAISpecifier(SSAIKey()),
+  startPos(100,100,100),
+  handicap(1),
+  leader(-1),
+  lineageRoot(-1),
+  isDead(false),
+  lastStatSave(0),
+  numCommanders(0)
+{
+	memset(&amp;currentStats,0,sizeof(currentStats));
+	statHistory.push_back(currentStats);
+}
+
+
+CTeam::~CTeam()
+{
+}
+
+
+bool CTeam::UseMetal(float amount)
+{
+	if ((metal - (prevMetalUpkeep * 10)) &gt;= amount) {
+		metal -= amount;
+		metalExpense += amount;
+		return true;
+	}
+	return false;
+}
+
+
+bool CTeam::UseEnergy(float amount)
+{
+	if ((energy - (prevEnergyUpkeep * 10)) &gt;= amount) {
+		energy -= amount;
+		energyExpense += amount;
+		return true;
+	}
+	return false;
+}
+
+
+bool CTeam::UseMetalUpkeep(float amount)
+{
+	if (metal &gt;= amount) {
+		metal -= amount;
+		metalExpense += amount;
+		metalUpkeep += amount;
+		return true;
+	}
+	return false;
+}
+
+
+bool CTeam::UseEnergyUpkeep(float amount)
+{
+	if (energy &gt;= amount) {
+		energy -= amount;
+		energyExpense += amount;
+		energyUpkeep += amount;
+		return true;
+	}
+	return false;
+}
+
+
+void CTeam::AddMetal(float amount, bool hc)
+{
+	if (hc) { amount *= handicap; }
+	metal += amount;
+	metalIncome += amount;
+	if (metal &gt; metalStorage) {
+		delayedMetalShare += metal - metalStorage;
+		metal = metalStorage;
+	}
+}
+
+
+void CTeam::AddEnergy(float amount, bool hc)
+{
+	if (hc) { amount *= handicap; }
+	energy += amount;
+	energyIncome += amount;
+	if (energy &gt; energyStorage) {
+		delayedEnergyShare += energy - energyStorage;
+		energy = energyStorage;
+	}
+}
+
+void CTeam::GiveEverythingTo(const unsigned toTeam)
+{
+	CTeam* target = teamHandler-&gt;Team(toTeam);
+
+	if (!target) {
+		logOutput.Print(&quot;Team %i didn't exists, can't give units&quot;, toTeam);
+		return;
+	}
+
+	if (!luaRules || luaRules-&gt;AllowResourceTransfer(teamNum, toTeam, &quot;m&quot;, metal)) {
+		target-&gt;metal += metal;
+		metal = 0;
+	}
+	if (!luaRules || luaRules-&gt;AllowResourceTransfer(teamNum, toTeam, &quot;e&quot;, energy)) {
+		target-&gt;energy += energy;
+		energy = 0;
+	}
+
+	for (CUnitSet::iterator ui = units.begin(); ui != units.end(); ) {
+		// must pass the normal checks, isDead, unit count restrictions, luaRules, etc...
+		CUnitSet::iterator next = ui; ++next;
+		(*ui)-&gt;ChangeTeam(toTeam, CUnit::ChangeGiven);
+		ui = next;
+	}
+
+	Died();
+}
+
+
+void CTeam::Died()
+{
+	// TODO: event based
+	if (leader &gt;= 0) {
+		logOutput.Print(CMessages::Tr(&quot;Team%i(%s) is no more&quot;).c_str(),
+		                teamNum, playerHandler-&gt;Player(leader)-&gt;name.c_str());
+	} else {
+		logOutput.Print(CMessages::Tr(&quot;Team%i is no more&quot;).c_str(), teamNum);
+	}
+	isDead = true;
+
+	// this message is not relayed to clients, it's only for the server
+	net-&gt;Send(CBaseNetProtocol::Get().SendTeamDied(gu-&gt;myPlayerNum, teamNum));
+
+	for (int a = 0; a &lt; MAX_PLAYERS; ++a) {
+		if (playerHandler-&gt;Player(a)-&gt;active &amp;&amp; (playerHandler-&gt;Player(a)-&gt;team == teamNum)) {
+			playerHandler-&gt;Player(a)-&gt;StartSpectating();
+		}
+	}
+	if (eoh-&gt;IsSkirmishAI(teamNum)) {
+		eoh-&gt;DestroySkirmishAI(teamNum);
+	}
+
+	CLuaUI::UpdateTeams();
+	CPlayer::UpdateControlledTeams();
+	eventHandler.TeamDied(teamNum);
+}
+
+void CTeam::StartposMessage(const float3&amp; pos, const bool isReady)
+{
+	readyToStart = isReady;
+	startPos = pos;
+}
+
+void CTeam::StartposMessage(const float3&amp; pos)
+{
+	startPos = pos;
+}
+
+/** This has to be called for every team before SlowUpdates start,
+	otherwise values get overwritten. */
+void CTeam::ResetFrameVariables()
+{
+	prevMetalPull     = metalPull;
+	prevMetalIncome   = metalIncome;
+	prevMetalExpense  = metalExpense;
+	prevMetalUpkeep   = metalUpkeep;
+	prevEnergyPull    = energyPull;
+	prevEnergyIncome  = energyIncome;
+	prevEnergyExpense = energyExpense;
+	prevEnergyUpkeep  = energyUpkeep;
+
+	metalPull = 0;
+	metalIncome = 0;
+	metalExpense = 0;
+	metalUpkeep = 0;
+	energyPull = 0;
+	energyIncome = 0;
+	energyExpense = 0;
+	energyUpkeep = 0;
+
+	metalSent = 0;
+	energySent = 0;
+	metalReceived = 0;
+	energyReceived = 0;
+}
+
+void CTeam::SlowUpdate()
+{
+	currentStats.metalProduced  += prevMetalIncome;
+	currentStats.energyProduced += prevEnergyIncome;
+	currentStats.metalUsed  += prevMetalUpkeep + prevMetalExpense;
+	currentStats.energyUsed += prevEnergyUpkeep + prevEnergyExpense;
+
+	float eShare = 0.0f, mShare = 0.0f;
+	for (int a = 0; a &lt; teamHandler-&gt;ActiveTeams(); ++a) {
+		if ((a != teamNum) &amp;&amp; (teamHandler-&gt;AllyTeam(teamNum) == teamHandler-&gt;AllyTeam(a))) {
+			CTeam* team = teamHandler-&gt;Team(a);
+			eShare += std::max(0.0f, (team-&gt;energyStorage * 0.99f) - team-&gt;energy);
+			mShare += std::max(0.0f, (team-&gt;metalStorage  * 0.99f) - team-&gt;metal);
+		}
+	}
+
+	metal += delayedMetalShare;
+	energy += delayedEnergyShare;
+	delayedMetalShare = 0;
+	delayedEnergyShare = 0;
+
+	const float eExcess = std::max(0.0f, energy - (energyStorage * energyShare));
+	const float mExcess = std::max(0.0f, metal  - (metalStorage  * metalShare));
+
+	float de = 0.0f, dm = 0.0f;
+	if (eShare &gt; 0.0f) {
+		de = std::min(1.0f, eExcess/eShare);
+	}
+	if (mShare &gt; 0.0f) {
+		dm = std::min(1.0f, mExcess/mShare);
+	}
+	for (int a = 0; a &lt; teamHandler-&gt;ActiveTeams(); ++a) {
+		if ((a != teamNum) &amp;&amp; (teamHandler-&gt;AllyTeam(teamNum) == teamHandler-&gt;AllyTeam(a))) {
+			CTeam* team = teamHandler-&gt;Team(a);
+
+			const float edif = std::max(0.0f, (team-&gt;energyStorage * 0.99f) - team-&gt;energy) * de;
+			energy -= edif;
+			energySent += edif;
+			currentStats.energySent += edif;
+			team-&gt;energy += edif;
+			team-&gt;energyReceived += edif;
+			team-&gt;currentStats.energyReceived += edif;
+
+			const float mdif = std::max(0.0f, (team-&gt;metalStorage * 0.99f) - team-&gt;metal) * dm;
+			metal -= mdif;
+			metalSent += mdif;
+			currentStats.metalSent += mdif;
+			team-&gt;metal += mdif;
+			team-&gt;metalReceived += mdif;
+			team-&gt;currentStats.metalReceived += mdif;
+		}
+	}
+
+	if (metal &gt; metalStorage) {
+		currentStats.metalExcess += (metal - metalStorage);
+		metal = metalStorage;
+	}
+	if (energy &gt; energyStorage) {
+		currentStats.energyExcess += (energy - energyStorage);
+		energy = energyStorage;
+	}
+
+	const int statsFrames = (statsPeriod * GAME_SPEED);
+	if ((lastStatSave + statsFrames) &lt; gs-&gt;frameNum) {
+		lastStatSave += statsFrames;
+		statHistory.push_back(currentStats);
+	}
+
+	/* Kill the player on 'com dies = game ends' games.  This can't be done in
+	CTeam::CommanderDied anymore, because that function is called in
+	CUnit::ChangeTeam(), hence it'd cause a random amount of the shared units
+	to be killed if the commander is among them. Also, &quot;.take&quot; would kill all
+	units once it transfered the commander. */
+	if (gs-&gt;gameMode==1 &amp;&amp; numCommanders&lt;=0 &amp;&amp; !gaia){
+		for(std::list&lt;CUnit*&gt;::iterator ui=uh-&gt;activeUnits.begin();ui!=uh-&gt;activeUnits.end();++ui){
+			if ((*ui)-&gt;team==teamNum &amp;&amp; !(*ui)-&gt;unitDef-&gt;isCommander)
+				(*ui)-&gt;KillUnit(true,false,0);
+		}
+		// Set to 1 to prevent above loop from being done every update.
+		numCommanders = 1;
+	}
+}
+
+
+void CTeam::AddUnit(CUnit* unit,AddType type)
+{
+	units.insert(unit);
+	switch (type) {
+		case AddBuilt: {
+			currentStats.unitsProduced++;
+			break;
+		}
+		case AddGiven: {
+			currentStats.unitsReceived++;
+			break;
+		}
+		case AddCaptured: {
+			currentStats.unitsCaptured++;
+			break;
+		}
+	}
+	if (unit-&gt;unitDef-&gt;isCommander) {
+		numCommanders++;
+	}
+}
+
+
+void CTeam::RemoveUnit(CUnit* unit,RemoveType type)
+{
+	units.erase(unit);
+	switch (type) {
+		case RemoveDied: {
+			currentStats.unitsDied++;
+			break;
+		}
+		case RemoveGiven: {
+			currentStats.unitsSent++;
+			break;
+		}
+		case RemoveCaptured: {
+			currentStats.unitsOutCaptured++;
+			break;
+		}
+	}
+
+	if (units.empty() &amp;&amp; !gaia) {
+		Died();
+	}
+}
+
+
+void CTeam::CommanderDied(CUnit* commander)
+{
+	assert(commander-&gt;unitDef-&gt;isCommander);
+	--numCommanders;
+}
+
+
+void CTeam::LeftLineage(CUnit* unit)
+{
+	if (gs-&gt;gameMode == 2 &amp;&amp; unit-&gt;id == this-&gt;lineageRoot) {
+		for (std::list&lt;CUnit*&gt;::iterator ui = uh-&gt;activeUnits.begin(); ui != uh-&gt;activeUnits.end(); ++ui) {
+			if ((*ui)-&gt;lineage == this-&gt;teamNum)
+				(*ui)-&gt;KillUnit(true, false, 0);
+		}
+	}
+}
+

Copied: branches/caiinterface/rts/Sim/Misc/Team.h (from rev 7023, trunk/rts/Sim/Misc/Team.h)
===================================================================
--- branches/caiinterface/rts/Sim/Misc/Team.h	                        (rev 0)
+++ branches/caiinterface/rts/Sim/Misc/Team.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -0,0 +1,162 @@
+#ifndef TEAM_H
+#define TEAM_H
+// Team.h: interface for the CTeam class.
+//
+//////////////////////////////////////////////////////////////////////
+
+#include &lt;string&gt;
+#include &lt;vector&gt;
+#include &lt;map&gt;
+#include &lt;list&gt;
+#include &quot;Platform/byteorder.h&quot;
+#include &quot;Sim/Units/UnitSet.h&quot;
+#include &quot;ExternalAI/Interface/SAIInterfaceLibrary.h&quot;
+
+class CTeam
+{
+public:
+	CR_DECLARE(CTeam);
+	CR_DECLARE_SUB(Statistics);
+	CTeam();
+	~CTeam();
+	void ResetFrameVariables();
+	void SlowUpdate();
+
+
+	void AddMetal(float amount, bool handicap = true);
+	void AddEnergy(float amount, bool handicap = true);
+	bool UseEnergy(float amount);
+	bool UseMetal(float amount);
+	bool UseEnergyUpkeep(float amount);
+	bool UseMetalUpkeep(float amount);
+
+	void SetBaseMetalStorage(float storage) {metalStorage = storage;};
+	void SetBaseEnergyStorage(float storage) {energyStorage = storage;};
+
+	void GiveEverythingTo(const unsigned toTeam);
+
+	void Died();
+
+	void StartposMessage(const float3&amp; pos, const bool isReady);
+	void StartposMessage(const float3&amp; pos);
+
+	inline bool IsReadyToStart() const {return readyToStart;};
+	enum AddType{
+		AddBuilt,
+		AddCaptured,
+		AddGiven
+	};
+
+	enum RemoveType{
+		RemoveDied,
+		RemoveCaptured,
+		RemoveGiven
+	};
+
+	void AddUnit(CUnit* unit,AddType type);
+	void RemoveUnit(CUnit* unit,RemoveType type);
+
+	int teamNum;
+	bool isDead;
+	bool gaia;
+	int leader;
+	int lineageRoot;
+
+	float handicap;
+	std::string side;
+
+	bool isAI;
+	std::string luaAI;
+	SSAIKey skirmishAISpecifier;
+	std::map&lt;std::string, std::string&gt; skirmishAIOptions;
+
+	// color info is unsynced
+	unsigned char color[4];
+	unsigned char origColor[4];
+
+	CUnitSet units;
+
+	float3 startPos;
+
+	SyncedFloat metal;
+	SyncedFloat energy;
+
+	float metalPull,    prevMetalPull;
+	float metalIncome,  prevMetalIncome;
+	float metalExpense, prevMetalExpense;
+	float metalUpkeep,  prevMetalUpkeep;
+
+	float energyPull,    prevEnergyPull;
+	float energyIncome,  prevEnergyIncome;
+	float energyExpense, prevEnergyExpense;
+	float energyUpkeep,  prevEnergyUpkeep;
+
+	SyncedFloat metalStorage, energyStorage;
+
+	float metalShare, energyShare;
+	SyncedFloat delayedMetalShare, delayedEnergyShare; //excess that might be shared next SlowUpdate
+
+	float metalSent;
+	float metalReceived;
+	float energySent;
+	float energyReceived;
+
+
+	struct Statistics {
+		CR_DECLARE_STRUCT(Statistics);
+		float metalUsed,     energyUsed;
+		float metalProduced, energyProduced;
+		float metalExcess,   energyExcess;
+		float metalReceived, energyReceived; //received from allies
+		float metalSent,     energySent;     //sent to allies
+
+		float damageDealt,   damageReceived; // Damage taken and dealt to enemy units
+
+		int unitsProduced;
+		int unitsDied;
+		int unitsReceived;
+		int unitsSent;
+		int unitsCaptured;				//units captured from enemy by us
+		int unitsOutCaptured;			//units captured from us by enemy
+		int unitsKilled;	//how many enemy units have been killed by this teams units
+
+		/// Change structure from host endian to little endian or vice versa.
+		void swab() {
+			metalUsed        = swabfloat(metalUsed);
+			energyUsed       = swabfloat(energyUsed);
+			metalProduced    = swabfloat(metalProduced);
+			energyProduced   = swabfloat(energyProduced);
+			metalExcess      = swabfloat(metalExcess);
+			energyExcess     = swabfloat(energyExcess);
+			metalReceived    = swabfloat(metalReceived);
+			energyReceived   = swabfloat(energyReceived);
+			metalSent        = swabfloat(metalSent);
+			energySent       = swabfloat(energySent);
+			damageDealt      = swabfloat(damageDealt);
+			damageReceived   = swabfloat(damageReceived);
+			unitsProduced    = swabdword(unitsProduced);
+			unitsDied        = swabdword(unitsDied);
+			unitsReceived    = swabdword(unitsReceived);
+			unitsSent        = swabdword(unitsSent);
+			unitsCaptured    = swabdword(unitsCaptured);
+			unitsOutCaptured = swabdword(unitsOutCaptured);
+			unitsKilled      = swabdword(unitsKilled);
+		}
+	};
+	Statistics currentStats;
+	static const int statsPeriod = 15; // every 15th second
+
+	int lastStatSave;
+	int numCommanders;		//number of units with commander tag in team, if it reaches zero with cmd ends the team dies
+	std::list&lt;Statistics&gt; statHistory;
+	void CommanderDied(CUnit* commander);
+	void LeftLineage(CUnit* unit);
+
+	std::vector&lt;float&gt;         modParams;    // mod controlled parameters
+	std::map&lt;std::string, int&gt; modParamsMap; // name map for mod parameters
+
+private:
+	bool readyToStart;
+};
+
+#endif /* TEAM_H */

Copied: branches/caiinterface/rts/Sim/Misc/TeamHandler.cpp (from rev 7026, trunk/rts/Sim/Misc/TeamHandler.cpp)
===================================================================
--- branches/caiinterface/rts/Sim/Misc/TeamHandler.cpp	                        (rev 0)
+++ branches/caiinterface/rts/Sim/Misc/TeamHandler.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -0,0 +1,142 @@
+/* Author: Tobi Vollebregt */
+
+/* based on code from GlobalSynced.{cpp,h} */
+
+#include &quot;StdAfx.h&quot;
+#include &quot;TeamHandler.h&quot;
+#include &quot;Game/GameSetup.h&quot;
+#include &quot;Lua/LuaGaia.h&quot;
+#include &quot;mmgr.h&quot;
+#include &quot;Util.h&quot;
+#include &quot;Platform/errorhandler.h&quot;
+#include &quot;ExternalAI/IAILibraryManager.h&quot;
+
+CR_BIND(CTeamHandler,);
+
+CR_REG_METADATA(CTeamHandler, (
+	CR_MEMBER(gaiaTeamID),
+	CR_MEMBER(gaiaAllyTeamID),
+	CR_MEMBER(activeTeams),
+	CR_MEMBER(activeAllyTeams),
+	CR_MEMBER(allies),
+	CR_MEMBER(team2allyteam),
+	CR_MEMBER(teams),
+	CR_RESERVED(64)
+));
+
+
+CTeamHandler* teamHandler;
+
+
+CTeamHandler::CTeamHandler()
+{
+	gaiaTeamID = -1;
+	gaiaAllyTeamID = -1;
+
+	for(int a = 0; a &lt; MAX_TEAMS; ++a) {
+		teams[a].teamNum = a;
+		team2allyteam[a] = a;
+	}
+
+	for (int a = 0; a &lt; MAX_TEAMS; ++a) {
+		for (int b = 0; b &lt; MAX_TEAMS; ++b) {
+			allies[a][b] = false;
+		}
+		allies[a][a] = true;
+	}
+
+	activeTeams = 2;
+	activeAllyTeams = 2;
+}
+
+
+CTeamHandler::~CTeamHandler()
+{
+}
+
+
+void CTeamHandler::LoadFromSetup(const CGameSetup* setup)
+{
+	const bool useLuaGaia  = CLuaGaia::SetConfigString(setup-&gt;luaGaiaStr);
+
+	activeTeams = setup-&gt;numTeams;
+	activeAllyTeams = setup-&gt;numAllyTeams;
+
+	assert(activeTeams &lt;= MAX_TEAMS);
+	assert(activeAllyTeams &lt;= MAX_TEAMS);
+
+	for (int i = 0; i &lt; activeTeams; ++i) {
+		// TODO: this loop body could use some more refactoring
+		CTeam* team = Team(i);
+		const CGameSetup::TeamData&amp; teamStartingData = setup-&gt;teamStartingData[i];
+
+		team-&gt;metal = setup-&gt;startMetal;
+		team-&gt;metalIncome = setup-&gt;startMetal; // for the endgame statistics
+
+		team-&gt;energy = setup-&gt;startEnergy;
+		team-&gt;energyIncome = setup-&gt;startEnergy;
+
+		float3 start(teamStartingData.startPos.x, teamStartingData.startPos.y, teamStartingData.startPos.z);
+		team-&gt;StartposMessage(start, (setup-&gt;startPosType != CGameSetup::StartPos_ChooseInGame));
+		std::memcpy(team-&gt;color, teamStartingData.color, 4);
+		team-&gt;handicap = teamStartingData.handicap;
+		team-&gt;leader = teamStartingData.leader;
+		team-&gt;side = teamStartingData.side;
+		SetAllyTeam(i, teamStartingData.teamAllyteam);
+
+		if (!teamStartingData.luaAI.empty()) {
+			team-&gt;luaAI = teamStartingData.luaAI;
+			team-&gt;isAI = true;
+		} else if (!(teamStartingData.skirmishAIShortName.empty())) {
+			if (setup-&gt;hostDemo) {
+				SSAIKey key = {{NULL, NULL}, {NULL, NULL}};
+				team-&gt;skirmishAISpecifier = key;
+			} else {
+				const char* sn = teamStartingData.skirmishAIShortName.c_str();
+				const char* v = teamStartingData.skirmishAIVersion.empty()
+						? NULL : teamStartingData.skirmishAIVersion.c_str();
+				SSAISpecifier spec = {sn, v};
+				std::vector&lt;SSAIKey&gt; fittingKeys =
+						IAILibraryManager::GetInstance()-&gt;ResolveSkirmishAIKey(spec);
+				if (fittingKeys.size() &gt; 0) {
+					team-&gt;skirmishAISpecifier = fittingKeys[0];
+					team-&gt;skirmishAIOptions = teamStartingData.skirmishAIOptions;
+					team-&gt;isAI = true;
+				} else {
+					const int MAX_MSG_LENGTH = 511;
+					char s_msg[MAX_MSG_LENGTH + 1];
+					SNPRINTF(s_msg, MAX_MSG_LENGTH,
+							&quot;Specifyed Skirmish AI could not be found: %s (version: %s)&quot;,
+							spec.shortName, spec.version != NULL ? spec.version : &quot;&lt;not specifyed&gt;&quot;);
+					handleerror(NULL, s_msg, &quot;Team Handler Error&quot;, MBF_OK | MBF_EXCL);
+				}
+			}
+		}
+	}
+
+	for (int allyTeam1 = 0; allyTeam1 &lt; activeAllyTeams; ++allyTeam1)
+	{
+		for (int allyTeam2 = 0; allyTeam2 &lt; activeAllyTeams; ++allyTeam2)
+			allies[allyTeam1][allyTeam2] = setup-&gt;allyStartingData[allyTeam1].allies[allyTeam2];
+	}
+
+	if (useLuaGaia) {
+		// Gaia adjustments
+		gaiaTeamID = activeTeams;
+		gaiaAllyTeamID = activeAllyTeams;
+		activeTeams++;
+		activeAllyTeams++;
+
+		// Setup the gaia team
+		CTeam* team = Team(gaiaTeamID);
+		team-&gt;color[0] = 255;
+		team-&gt;color[1] = 255;
+		team-&gt;color[2] = 255;
+		team-&gt;color[3] = 255;
+		team-&gt;gaia = true;
+		team-&gt;StartposMessage(float3(0.0, 0.0, 0.0), true);
+		//players[setup-&gt;numPlayers]-&gt;team = gaiaTeamID;
+		SetAllyTeam(gaiaTeamID, gaiaAllyTeamID);
+	}
+}
+

Copied: branches/caiinterface/rts/Sim/Misc/TeamHandler.h (from rev 7026, trunk/rts/Sim/Misc/TeamHandler.h)
===================================================================
--- branches/caiinterface/rts/Sim/Misc/TeamHandler.h	                        (rev 0)
+++ branches/caiinterface/rts/Sim/Misc/TeamHandler.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -0,0 +1,149 @@
+/* Author: Tobi Vollebregt */
+
+/* based on code from GlobalSynced.{cpp,h} */
+
+#ifndef TEAMHANDLER_H
+#define TEAMHANDLER_H
+
+#include &quot;creg/creg.h&quot;
+#include &quot;Team.h&quot;
+
+class CGameSetup;
+
+
+/** @brief Handles teams and allyteams */
+class CTeamHandler
+{
+public:
+	CR_DECLARE(CTeamHandler);
+
+	CTeamHandler();
+	~CTeamHandler();
+
+	void LoadFromSetup(const CGameSetup* setup);
+
+	// from CGlobalSynced:
+
+	/**
+	 * @brief Team
+	 * @param i index to fetch
+	 * @return CTeam pointer
+	 *
+	 * Accesses a CTeam instance at a given index
+	 */
+	CTeam* Team(int i) { return &amp;teams[i]; }
+
+	/**
+	 * @brief ally
+	 * @param a first allyteam
+	 * @param b second allyteam
+	 * @return allies[a][b]
+	 *
+	 * Returns ally at [a][b]
+	 */
+	bool Ally(int a, int b) { return allies[a][b]; }
+
+	/**
+	 * @brief ally team
+	 * @param team team to find
+	 * @return the ally team
+	 *
+	 * returns the team2ally at given index
+	 */
+	int AllyTeam(int team) { return team2allyteam[team]; }
+
+	/**
+	 * @brief allied teams
+	 * @param a first team
+	 * @param b second team
+	 * @return whether teams are allied
+	 *
+	 * Tests whether teams are allied
+	 */
+	bool AlliedTeams(int a, int b) { return allies[team2allyteam[a]][team2allyteam[b]]; }
+
+	/**
+	 * @brief set ally team
+	 * @param team team to set
+	 * @param allyteam allyteam to set
+	 *
+	 * Sets team's ally team
+	 */
+	void SetAllyTeam(int team, int allyteam) { team2allyteam[team] = allyteam; }
+
+	/**
+	 * @brief set ally
+	 * @param allyteamA first allyteam
+	 * @param allyteamB second allyteam
+	 * @param allied whether or not these two teams are allied
+	 *
+	 * Sets two allyteams to be allied or not
+	 */
+	void SetAlly(int allyteamA, int allyteamB, bool allied) { allies[allyteamA][allyteamB] = allied; }
+
+	// accessors
+
+	int GaiaTeamID() const { return gaiaTeamID; }
+	int GaiaAllyTeamID() const { return gaiaAllyTeamID; }
+
+	int ActiveTeams() const { return activeTeams; }
+	int ActiveAllyTeams() const { return activeAllyTeams; }
+
+private:
+
+	/**
+	 * @brief gaia team
+	 *
+	 * gaia's team id
+	 */
+	int gaiaTeamID;
+
+	/**
+	 * @brief gaia team
+	 *
+	 * gaia's team id
+	 */
+	int gaiaAllyTeamID;
+
+	/**
+	 * @brief active teams
+	 *
+	 * The number of active teams
+	 * (don't change during play)
+	 */
+	int activeTeams;
+
+	/**
+	 * @brief active ally teams
+	 *
+	 * The number of active ally teams
+	 */
+	int activeAllyTeams;
+
+	/**
+	 * @brief allies array
+	 *
+	 * Array indicates whether teams are allied,
+	 * allies[a][b] means allyteam a is allied with
+	 * allyteam b, NOT the other way around
+	 */
+	bool allies[MAX_TEAMS][MAX_TEAMS];
+
+	/**
+	 * @brief team to ally team
+	 *
+	 * Array stores what ally team a specific team is part of
+	 */
+	int team2allyteam[MAX_TEAMS];
+
+	/**
+	 * @brief teams
+	 *
+	 * Array of CTeam instances for teams in game
+	 */
+	CTeam teams[MAX_TEAMS];
+};
+
+extern CTeamHandler* teamHandler;
+
+#endif // !TEAMHANDLER_H

Modified: branches/caiinterface/rts/Sim/Misc/Wind.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Misc/Wind.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Misc/Wind.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -2,7 +2,7 @@
 #include &quot;mmgr.h&quot;
 
 #include &quot;Wind.h&quot;
-#include &quot;Game/GlobalSynced.h&quot;
+#include &quot;GlobalSynced.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
 #include &quot;Map/MapInfo.h&quot;
 

Deleted: branches/caiinterface/rts/Sim/ModInfo.cpp
===================================================================
--- branches/caiinterface/rts/Sim/ModInfo.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/ModInfo.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,129 +0,0 @@
-
-#include &quot;StdAfx.h&quot;
-#include &quot;mmgr.h&quot;
-
-#include &quot;GlobalUnsynced.h&quot;
-#include &quot;ModInfo.h&quot;
-#include &quot;Game/GameSetup.h&quot;
-#include &quot;Lua/LuaParser.h&quot;
-#include &quot;Lua/LuaSyncedRead.h&quot;
-#include &quot;Sim/Units/Unit.h&quot;
-#include &quot;Sim/Units/UnitTypes/Builder.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/Platform/ConfigHandler.h&quot;
-#include &quot;System/FileSystem/ArchiveScanner.h&quot;
-#include &quot;System/Exceptions.h&quot;
-
-
-CModInfo modInfo;
-
-
-void CModInfo::Init(const char* modname)
-{
-	filename = modname;
-
-	humanName = archiveScanner-&gt;ModArchiveToModName(modname);
-
-	const CArchiveScanner::ModData md = archiveScanner-&gt;ModArchiveToModData(modname);
-
-	shortName   = md.shortName;
-	version     = md.version;
-	mutator     = md.mutator;
-	description = md.description;
-
-	// initialize the parser
-	LuaParser parser(&quot;gamedata/modrules.lua&quot;,
-	                 SPRING_VFS_MOD_BASE, SPRING_VFS_ZIP);
-	// customize the defs environment
-	parser.GetTable(&quot;Spring&quot;);
-	parser.AddFunc(&quot;GetModOptions&quot;, LuaSyncedRead::GetModOptions);
-	parser.EndTable();
-	parser.Execute();
-	if (!parser.IsValid()) {
-		logOutput.Print(&quot;Error loading modrules, using defaults&quot;);
-		logOutput.Print(parser.GetErrorLog());
-	}
-	const LuaTable root = parser.GetRoot();
-
-	// determine whether the modder allows the user to use team coloured nanospray
-	const LuaTable nanosprayTbl = root.SubTable(&quot;nanospray&quot;);
-	allowTeamColors = nanosprayTbl.GetBool(&quot;allow_team_colors&quot;, true);
-	if (allowTeamColors) {
-		// Load the users preference for team coloured nanospray
-		gu-&gt;teamNanospray = !!configHandler.GetInt(&quot;TeamNanoSpray&quot;, 0);
-	}
-
-	// constructions
-	const LuaTable constructionTbl = root.SubTable(&quot;construction&quot;);
-	constructionDecay = constructionTbl.GetBool(&quot;constructionDecay&quot;, true);
-	constructionDecayTime = (int)(constructionTbl.GetFloat(&quot;constructionDecayTime&quot;, 6.66) * 30);
-	constructionDecaySpeed = constructionTbl.GetFloat(&quot;constructionDecaySpeed&quot;, 0.03);
-
-	// reclaim
-	const LuaTable reclaimTbl = root.SubTable(&quot;reclaim&quot;);
-	multiReclaim  = reclaimTbl.GetInt(&quot;multiReclaim&quot;,  0);
-	reclaimMethod = reclaimTbl.GetInt(&quot;reclaimMethod&quot;, 1);
-	reclaimUnitMethod = reclaimTbl.GetInt(&quot;unitMethod&quot;, 1);
-	reclaimUnitEnergyCostFactor = reclaimTbl.GetFloat(&quot;unitEnergyCostFactor&quot;, 0.0);
-	reclaimUnitEfficiency = reclaimTbl.GetFloat(&quot;unitEfficiency&quot;, 1.0);
-	reclaimFeatureEnergyCostFactor = reclaimTbl.GetFloat(&quot;featureEnergyCostFactor&quot;, 0.0);
-	reclaimAllowEnemies = reclaimTbl.GetBool(&quot;allowEnemies&quot;, true);
-	reclaimAllowAllies = reclaimTbl.GetBool(&quot;allowAllies&quot;, true);
-
-	// repair
-	const LuaTable repairTbl = root.SubTable(&quot;repair&quot;);
-	repairEnergyCostFactor = repairTbl.GetFloat(&quot;energyCostFactor&quot;, 0.0);
-
-	// resurrect
-	const LuaTable resurrectTbl = root.SubTable(&quot;resurrect&quot;);
-	resurrectEnergyCostFactor  = resurrectTbl.GetFloat(&quot;energyCostFactor&quot;,  0.5);
-
-	// capture
-	const LuaTable captureTbl = root.SubTable(&quot;capture&quot;);
-	captureEnergyCostFactor = captureTbl.GetFloat(&quot;energyCostFactor&quot;, 0.0);
-
-	// fire-at-dead-units
-	const LuaTable fireAtDeadTbl = root.SubTable(&quot;fireAtDead&quot;);
-	fireAtKilled   = fireAtDeadTbl.GetBool(&quot;fireAtKilled&quot;, false);
-	fireAtCrashing = fireAtDeadTbl.GetBool(&quot;fireAtCrashing&quot;, false);
-
-	// transportability
-	const LuaTable transportTbl = root.SubTable(&quot;transportability&quot;);
-	transportAir    = transportTbl.GetInt(&quot;transportAir&quot;,   false);
-	transportShip   = transportTbl.GetInt(&quot;transportShip&quot;,  false);
-	transportHover  = transportTbl.GetInt(&quot;transportHover&quot;, false);
-	transportGround = transportTbl.GetInt(&quot;transportGround&quot;, true);
-
-	// experience
-	const LuaTable experienceTbl = root.SubTable(&quot;experience&quot;);
-	CUnit::SetExpMultiplier (experienceTbl.GetFloat(&quot;experienceMult&quot;, 1.0f));
-	CUnit::SetExpPowerScale (experienceTbl.GetFloat(&quot;powerScale&quot;,  1.0f));		
-	CUnit::SetExpHealthScale(experienceTbl.GetFloat(&quot;healthScale&quot;, 0.7f));		
-	CUnit::SetExpReloadScale(experienceTbl.GetFloat(&quot;reloadScale&quot;, 0.4f));
-
-	// flanking bonus
-	const LuaTable flankingBonusTbl = root.SubTable(&quot;flankingBonus&quot;);
-	flankingBonusModeDefault = flankingBonusTbl.GetInt(&quot;defaultMode&quot;, 1);
-	
-	// sensors
-	const LuaTable sensors = root.SubTable(&quot;sensors&quot;);
-	requireSonarUnderWater = sensors.GetBool(&quot;requireSonarUnderWater&quot;, true);
-	/// LoS
-	const LuaTable los = sensors.SubTable(&quot;los&quot;);
-	// losMipLevel is used as index to readmap-&gt;mipHeightmap,
-	// so the max value is CReadMap::numHeightMipMaps - 1
-	losMipLevel = los.GetInt(&quot;losMipLevel&quot;, 1);
-	losMul = los.GetFloat(&quot;losMul&quot;, 1.0f);
-	if ((losMipLevel &lt; 0) || (losMipLevel &gt; 6)) {
-		throw content_error(&quot;Sensors\\Los\\LosMipLevel out of bounds. &quot;
-		                    &quot;The minimum value is 0. The maximum value is 6.&quot;);
-	}
-	// airLosMipLevel doesn't have such restrictions, it's just used in various
-	// bitshifts with signed integers
-	airMipLevel = los.GetInt(&quot;airMipLevel&quot;, 2);
-	if ((airMipLevel &lt; 0) || (airMipLevel &gt; 30)) {
-		throw content_error(&quot;Sensors\\Los\\AirLosMipLevel out of bounds. &quot;
-		                    &quot;The minimum value is 0. The maximum value is 30.&quot;);
-	}
-	airLosMul = los.GetFloat(&quot;airLosMul&quot;, 1.0f);
-}

Deleted: branches/caiinterface/rts/Sim/ModInfo.h
===================================================================
--- branches/caiinterface/rts/Sim/ModInfo.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/ModInfo.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,75 +0,0 @@
-
-#ifndef MOD_INFO_H
-#define MOD_INFO_H
-
-class CModInfo
-{
-public:
-	CModInfo() {};
-	~CModInfo() {};
-
-	void Init(const char* modname);
-
-	std::string filename; // archive filename
-
-	std::string humanName;
-	std::string shortName;
-	std::string version;
-	std::string mutator;
-	std::string description;
-
-	bool allowTeamColors;
-	
-	// Build behaviour
-	bool constructionDecay;               // Should constructions without builders decay?
-	int constructionDecayTime;            // How long until they start decaying?
-	float constructionDecaySpeed;         // How fast do they decay?
-
-	// Reclaim behaviour
-	int multiReclaim;	                  // 0 = 1 reclaimer per feature max, otherwise unlimited
-	int reclaimMethod;	                  // 0 = gradual reclaim, 1 = all reclaimed at end, otherwise reclaim in reclaimMethod chunks
-	int reclaimUnitMethod;                // 0 = Revert to wireframe, gradual reclaim, 1 = Subtract HP, give full metal at end, default 1
-	float reclaimUnitEnergyCostFactor;    // How much energy should reclaiming a unit cost, default 0.0
-	float reclaimUnitEfficiency;          // How much metal should reclaim return, default 1.0
-	float reclaimFeatureEnergyCostFactor; // How much should energy should reclaiming a feature cost, default 0.0
-	bool reclaimAllowEnemies;             // Allow reclaiming enemies? default true
-	bool reclaimAllowAllies;              // Allow reclaiming allies? default true
-
-	// Repair behaviour
-	float repairEnergyCostFactor;         // How much should energy should repair cost, default 0.0
-
-	// Resurrect behaviour
-	float resurrectEnergyCostFactor;      // How much should energy should resurrect cost, default 0.5
-
-	// Capture behaviour
-	float captureEnergyCostFactor;        // How much should energy should capture cost, default 0.0
-
-	// Transportation behaviour
-	int transportGround;                  // 0 = all ground units cannot be transported, 1 = all ground units can be transported (mass and size restrictions still apply). Defaults to 1.
-	int transportHover;                   // 0 = all hover units cannot be transported, 1 = all hover units can be transported (mass and size restrictions still apply). Defaults to 0.
-	int transportShip;                    // 0 = all naval units cannot be transported, 1 = all naval units can be transported (mass and size restrictions still apply). Defaults to 0.
-	int transportAir;                     // 0 = all air units cannot be transported, 1 = all air units can be transported (mass and size restrictions still apply). Defaults to 0.
-
-	// Fire-on-dying-units behaviour
-	int fireAtKilled;                     // 1 = units fire at enemies running Killed() script, 0 = units ignore such enemies
-	int fireAtCrashing;                   // 1 = units fire at crashing aircrafts, 0 = units ignore crashing aircrafts
-
-	int flankingBonusModeDefault;         // 0=no flanking bonus;  1=global coords, mobile;  2=unit coords, mobile;  3=unit coords, locked
-	
-	// Sensor behaviour
-	/// miplevel for los
-	int losMipLevel;
-	/// miplevel to use for airlos
-	int airMipLevel;
-	/// units sightdistance will be multiplied with this, for testing purposes
-	float losMul;
-	/// units airsightdistance will be multiplied with this, for testing purposes
-	float airLosMul;
-	/// when underwater, units are not in LOS unless also in sonar
-	bool requireSonarUnderWater;
-};
-
-extern CModInfo modInfo;
-
-
-#endif

Modified: branches/caiinterface/rts/Sim/MoveTypes/GroundMoveType.cpp
===================================================================
--- branches/caiinterface/rts/Sim/MoveTypes/GroundMoveType.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/MoveTypes/GroundMoveType.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -21,6 +21,7 @@
 #include &quot;Sim/Misc/LosHandler.h&quot;
 #include &quot;Sim/Misc/QuadField.h&quot;
 #include &quot;Sim/Misc/RadarHandler.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Path/PathManager.h&quot;
 #include &quot;Sim/Units/COB/CobFile.h&quot;
 #include &quot;Sim/Units/COB/CobInstance.h&quot;
@@ -30,11 +31,11 @@
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
 #include &quot;Sim/Weapons/Weapon.h&quot;
 #include &quot;Sync/SyncTracer.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
-#include &quot;System/EventHandler.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/Sound.h&quot;
-#include &quot;System/FastMath.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
+#include &quot;EventHandler.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;Sound.h&quot;
+#include &quot;FastMath.h&quot;
 #include &quot;myMath.h&quot;
 
 CR_BIND_DERIVED(CGroundMoveType, AMoveType, (NULL));
@@ -1523,7 +1524,7 @@
 
 					const int uAllyTeam = u-&gt;allyteam;
 					const int oAllyTeam = owner-&gt;allyteam;
-					const bool allied = (gs-&gt;Ally(uAllyTeam, oAllyTeam) || gs-&gt;Ally(oAllyTeam, uAllyTeam));
+					const bool allied = (teamHandler-&gt;Ally(uAllyTeam, oAllyTeam) || teamHandler-&gt;Ally(oAllyTeam, uAllyTeam));
 
 					if (!u-&gt;unitDef-&gt;pushResistant &amp;&amp; !u-&gt;usingScriptMoveType &amp;&amp; allied) {
 						// push the blocking unit out of the way
@@ -1608,7 +1609,7 @@
 
 					const int uAllyTeam = u-&gt;allyteam;
 					const int oAllyTeam = owner-&gt;allyteam;
-					const bool allied = (gs-&gt;Ally(uAllyTeam, oAllyTeam) || gs-&gt;Ally(oAllyTeam, uAllyTeam));
+					const bool allied = (teamHandler-&gt;Ally(uAllyTeam, oAllyTeam) || teamHandler-&gt;Ally(oAllyTeam, uAllyTeam));
 
 					if (!u-&gt;unitDef-&gt;pushResistant &amp;&amp; !u-&gt;usingScriptMoveType &amp;&amp; allied) {
 						// push the blocking unit out of the way

Modified: branches/caiinterface/rts/Sim/MoveTypes/MoveInfo.cpp
===================================================================
--- branches/caiinterface/rts/Sim/MoveTypes/MoveInfo.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/MoveTypes/MoveInfo.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -12,7 +12,7 @@
 #include &quot;MoveMath/MoveMath.h&quot;
 #include &quot;creg/STL_Deque.h&quot;
 #include &quot;creg/STL_Map.h&quot;
-#include &quot;System/Exceptions.h&quot;
+#include &quot;Exceptions.h&quot;
 
 using std::min;
 using std::max;

Modified: branches/caiinterface/rts/Sim/MoveTypes/MoveType.h
===================================================================
--- branches/caiinterface/rts/Sim/MoveTypes/MoveType.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/MoveTypes/MoveType.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -4,7 +4,7 @@
 #include &quot;creg/creg.h&quot;
 #include &quot;Object.h&quot;
 #include &quot;Sim/Misc/AirBaseHandler.h&quot;
-#include &quot;System/float3.h&quot;
+#include &quot;float3.h&quot;
 
 class CUnit;
 

Modified: branches/caiinterface/rts/Sim/MoveTypes/ScriptMoveType.cpp
===================================================================
--- branches/caiinterface/rts/Sim/MoveTypes/ScriptMoveType.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/MoveTypes/ScriptMoveType.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,5 +1,5 @@
 #include &quot;StdAfx.h&quot;
-#include &quot;System/mmgr.h&quot;
+#include &quot;mmgr.h&quot;
 
 #include &quot;ScriptMoveType.h&quot;
 
@@ -15,9 +15,9 @@
 #include &quot;Sim/Misc/RadarHandler.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;Sim/Units/UnitTypes/Building.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
-#include &quot;System/Matrix44f.h&quot;
-#include &quot;System/myMath.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
+#include &quot;Matrix44f.h&quot;
+#include &quot;myMath.h&quot;
 
 CR_BIND_DERIVED(CScriptMoveType, AMoveType, (NULL));
 

Modified: branches/caiinterface/rts/Sim/MoveTypes/TAAirMoveType.cpp
===================================================================
--- branches/caiinterface/rts/Sim/MoveTypes/TAAirMoveType.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/MoveTypes/TAAirMoveType.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -16,9 +16,9 @@
 #include &quot;Sim/Units/CommandAI/CommandAI.h&quot;
 #include &quot;Sim/Units/COB/CobFile.h&quot;
 #include &quot;Sim/Units/COB/CobInstance.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/myMath.h&quot;
-#include &quot;System/Matrix44f.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;myMath.h&quot;
+#include &quot;Matrix44f.h&quot;
 
 
 CR_BIND_DERIVED(CTAAirMoveType, AAirMoveType, (NULL));

Modified: branches/caiinterface/rts/Sim/Path/PathCache.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Path/PathCache.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Path/PathCache.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -4,7 +4,7 @@
 
 #include &quot;PathCache.h&quot;
 
-#include &quot;Game/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
 #include &quot;LogOutput.h&quot;
 
 using namespace std;

Modified: branches/caiinterface/rts/Sim/Path/PathCache.h
===================================================================
--- branches/caiinterface/rts/Sim/Path/PathCache.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Path/PathCache.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -5,7 +5,7 @@
 #include &lt;list&gt;
 
 #include &quot;IPath.h&quot;
-#include &quot;System/Vec2.h&quot;
+#include &quot;Vec2.h&quot;
 
 class CPathCache
 {

Modified: branches/caiinterface/rts/Sim/Path/PathEstimator.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Path/PathEstimator.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Path/PathEstimator.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -18,7 +18,7 @@
 #include &quot;Sim/Units/UnitDef.h&quot;
 
 #include &quot;FileSystem/ArchiveZip.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 
 #define PATHDEBUG false
 

Modified: branches/caiinterface/rts/Sim/Path/PathManager.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Path/PathManager.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Path/PathManager.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -6,7 +6,7 @@
 
 #include &quot;PathManager.h&quot;
 #include &quot;LogOutput.h&quot;
-#include &quot;System/myMath.h&quot;
+#include &quot;myMath.h&quot;
 #include &quot;Sim/MoveTypes/MoveInfo.h&quot;
 #include &quot;Sim/MoveTypes/MoveMath/GroundMoveMath.h&quot;
 #include &quot;Sim/MoveTypes/MoveMath/HoverMoveMath.h&quot;

Modified: branches/caiinterface/rts/Sim/Projectiles/ExpGenSpawner.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/ExpGenSpawner.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Projectiles/ExpGenSpawner.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,6 +1,6 @@
 #include &quot;StdAfx.h&quot;
 #include &quot;ExpGenSpawner.h&quot;
-#include &quot;Sim/Projectiles/ExplosionGenerator.h&quot;
+#include &quot;ExplosionGenerator.h&quot;
 
 CR_BIND_DERIVED(CExpGenSpawner, CProjectile, );
 

Modified: branches/caiinterface/rts/Sim/Projectiles/ExplosionGenerator.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/ExplosionGenerator.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Projectiles/ExplosionGenerator.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -14,18 +14,18 @@
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Rendering/GroundFlash.h&quot;
 #include &quot;Rendering/Textures/ColorMap.h&quot;
-#include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
-#include &quot;Sim/Projectiles/Unsynced/BubbleProjectile.h&quot;
-#include &quot;Sim/Projectiles/Unsynced/DirtProjectile.h&quot;
-#include &quot;Sim/Projectiles/Unsynced/ExploSpikeProjectile.h&quot;
-#include &quot;Sim/Projectiles/Unsynced/HeatCloudProjectile.h&quot;
-#include &quot;Sim/Projectiles/Unsynced/SmokeProjectile2.h&quot;
-#include &quot;Sim/Projectiles/Unsynced/SpherePartProjectile.h&quot;
-#include &quot;Sim/Projectiles/Unsynced/WakeProjectile.h&quot;
-#include &quot;Sim/Projectiles/Unsynced/WreckProjectile.h&quot;
+#include &quot;ProjectileHandler.h&quot;
+#include &quot;Unsynced/BubbleProjectile.h&quot;
+#include &quot;Unsynced/DirtProjectile.h&quot;
+#include &quot;Unsynced/ExploSpikeProjectile.h&quot;
+#include &quot;Unsynced/HeatCloudProjectile.h&quot;
+#include &quot;Unsynced/SmokeProjectile2.h&quot;
+#include &quot;Unsynced/SpherePartProjectile.h&quot;
+#include &quot;Unsynced/WakeProjectile.h&quot;
+#include &quot;Unsynced/WreckProjectile.h&quot;
 #include &lt;assert.h&gt;
-#include &quot;System/GlobalUnsynced.h&quot;
-#include &quot;System/Exceptions.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
+#include &quot;Exceptions.h&quot;
 
 using std::min;
 using std::max;

Modified: branches/caiinterface/rts/Sim/Projectiles/FireProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/FireProjectile.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Projectiles/FireProjectile.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -5,12 +5,12 @@
 #include &quot;Sim/Misc/Wind.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Game/Camera.h&quot;
-#include &quot;Game/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
 #include &quot;Sim/Misc/QuadField.h&quot;
 #include &quot;Sim/Features/Feature.h&quot;
 #include &quot;ProjectileHandler.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 #include &quot;creg/STL_List.h&quot;
 
 CR_BIND_DERIVED(CFireProjectile, CProjectile, (float3(0,0,0),float3(0,0,0),NULL,0,0,0,0));

Modified: branches/caiinterface/rts/Sim/Projectiles/FlareProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/FlareProjectile.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Projectiles/FlareProjectile.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -2,7 +2,7 @@
 #include &quot;mmgr.h&quot;
 
 #include &quot;FlareProjectile.h&quot;
-#include &quot;Game/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
 #include &quot;Game/Camera.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Map/MapInfo.h&quot;
@@ -12,7 +12,7 @@
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;WeaponProjectiles/MissileProjectile.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CFlareProjectile, CProjectile, (float3(0,0,0),float3(0,0,0),0,0));
 

Modified: branches/caiinterface/rts/Sim/Projectiles/PieceProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/PieceProjectile.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Projectiles/PieceProjectile.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -4,7 +4,7 @@
 #include &quot;Game/Camera.h&quot;
 #include &quot;Game/GameHelper.h&quot;
 #include &quot;GlobalUnsynced.h&quot;
-#include &quot;Game/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Map/MapInfo.h&quot;
@@ -22,7 +22,7 @@
 #include &quot;Sync/SyncTracer.h&quot;
 #include &quot;Unsynced/SmokeProjectile.h&quot;
 #include &quot;Unsynced/SmokeTrailProjectile.h&quot;
-#include &quot;System/Util.h&quot;
+#include &quot;Util.h&quot;
 
 static const float Smoke_Time = 40;
 

Modified: branches/caiinterface/rts/Sim/Projectiles/Projectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Projectile.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Projectiles/Projectile.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -13,7 +13,7 @@
 #include &quot;LogOutput.h&quot;
 #include &quot;Rendering/UnitModels/3DModelParser.h&quot;
 #include &quot;Map/MapInfo.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CProjectile, CExpGenSpawnable, );
 

Modified: branches/caiinterface/rts/Sim/Projectiles/ProjectileHandler.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/ProjectileHandler.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Projectiles/ProjectileHandler.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -30,16 +30,17 @@
 #include &quot;Sim/Misc/CollisionVolume.h&quot;
 #include &quot;Sim/Misc/LosHandler.h&quot;
 #include &quot;Sim/Misc/QuadField.h&quot;
-#include &quot;Sim/Projectiles/Unsynced/ShieldPartProjectile.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
+#include &quot;Unsynced/ShieldPartProjectile.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
-#include &quot;System/EventHandler.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/TimeProfiler.h&quot;
-#include &quot;System/creg/STL_Map.h&quot;
-#include &quot;System/creg/STL_List.h&quot;
-#include &quot;System/Exceptions.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
+#include &quot;EventHandler.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;TimeProfiler.h&quot;
+#include &quot;creg/STL_Map.h&quot;
+#include &quot;creg/STL_List.h&quot;
+#include &quot;Exceptions.h&quot;
 
 CProjectileHandler* ph;
 
@@ -586,7 +587,7 @@
 		pro-&gt;UpdateDrawPos();
 
 		if (camera-&gt;InView(pro-&gt;pos, pro-&gt;drawRadius) &amp;&amp; (gu-&gt;spectatingFullView || loshandler-&gt;InLos(pro, gu-&gt;myAllyTeam) ||
-			(pro-&gt;owner &amp;&amp; gs-&gt;Ally(pro-&gt;owner-&gt;allyteam, gu-&gt;myAllyTeam)))) {
+			(pro-&gt;owner &amp;&amp; teamHandler-&gt;Ally(pro-&gt;owner-&gt;allyteam, gu-&gt;myAllyTeam)))) {
 
 			CUnit* owner = pro-&gt;owner;
 			CUnit* trans = owner? (CUnit*) owner-&gt;GetTransporter(): 0;
@@ -680,7 +681,7 @@
 
 	for (psi = ps.begin(); psi != ps.end(); ++psi) {
 		if ((gu-&gt;spectatingFullView || loshandler-&gt;InLos(*psi, gu-&gt;myAllyTeam) ||
-			((*psi)-&gt;owner &amp;&amp; gs-&gt;Ally((*psi)-&gt;owner-&gt;allyteam, gu-&gt;myAllyTeam)))) {
+			((*psi)-&gt;owner &amp;&amp; teamHandler-&gt;Ally((*psi)-&gt;owner-&gt;allyteam, gu-&gt;myAllyTeam)))) {
 
 			if ((*psi)-&gt;s3domodel)
 				(*psi)-&gt;DrawUnitPart();

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/BitmapMuzzleFlame.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/BitmapMuzzleFlame.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/BitmapMuzzleFlame.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -2,12 +2,12 @@
 #include &quot;mmgr.h&quot;
 
 #include &quot;BitmapMuzzleFlame.h&quot;
-#include &quot;Game/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Rendering/Textures/ColorMap.h&quot;
 #include &quot;Rendering/Textures/TextureAtlas.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CBitmapMuzzleFlame, CProjectile, );
 

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/BubbleProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/BubbleProjectile.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/BubbleProjectile.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -5,7 +5,7 @@
 #include &quot;Game/Camera.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CBubbleProjectile, CProjectile, (float3(0,0,0),float3(0,0,0),0,0,0,NULL,0));
 

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/DirtProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/DirtProjectile.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/DirtProjectile.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -10,7 +10,7 @@
 #include &quot;Map/MapInfo.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CDirtProjectile, CProjectile, );
 

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/ExploSpikeProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/ExploSpikeProjectile.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/ExploSpikeProjectile.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -5,7 +5,7 @@
 #include &quot;Game/Camera.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CExploSpikeProjectile, CProjectile, );
 

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/GenericParticleProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/GenericParticleProjectile.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/GenericParticleProjectile.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -3,7 +3,7 @@
 
 #include &quot;Game/Camera.h&quot;
 #include &quot;GenericParticleProjectile.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Rendering/Textures/ColorMap.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/GeoSquareProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/GeoSquareProjectile.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/GeoSquareProjectile.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -5,7 +5,7 @@
 #include &quot;GeoSquareProjectile.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CGeoSquareProjectile, CProjectile, (float3(0,0,0),float3(0,0,0),float3(0,0,0),float3(0,0,0),0,0));
 

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/GfxProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/GfxProjectile.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/GfxProjectile.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -4,12 +4,12 @@
 //////////////////////////////////////////////////////////////////////
 #include &quot;mmgr.h&quot;
 
-#include &quot;Game/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
 #include &quot;Game/Camera.h&quot;
 #include &quot;GfxProjectile.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CGfxProjectile, CProjectile, );
 

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/HeatCloudProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/HeatCloudProjectile.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/HeatCloudProjectile.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -8,7 +8,7 @@
 #include &quot;HeatCloudProjectile.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CHeatCloudProjectile, CProjectile, );
 

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/MuzzleFlame.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/MuzzleFlame.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/MuzzleFlame.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -5,7 +5,7 @@
 #include &quot;MuzzleFlame.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 
 CR_BIND_DERIVED(CMuzzleFlame, CProjectile, (float3(0,0,0),float3(0,0,0),float3(0,0,0),0));

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/RepulseGfx.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/RepulseGfx.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/RepulseGfx.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -6,7 +6,7 @@
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CRepulseGfx, CProjectile, (NULL,NULL,0,float3(0,0,0)));
 

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/ShieldPartProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/ShieldPartProjectile.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/ShieldPartProjectile.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -6,7 +6,7 @@
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;Rendering/Textures/TextureAtlas.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CShieldPartProjectile, CProjectile, (float3(0,0,0),0,0,0,float3(0,0,0),0,NULL,NULL));
 

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/SimpleParticleSystem.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/SimpleParticleSystem.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/SimpleParticleSystem.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -2,9 +2,9 @@
 #include &quot;mmgr.h&quot;
 
 #include &quot;Game/Camera.h&quot;
-#include &quot;Game/GlobalConstants.h&quot;
+#include &quot;Sim/Misc/GlobalConstants.h&quot;
 #include &quot;GenericParticleProjectile.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Rendering/Textures/ColorMap.h&quot;
 #include &quot;SimpleParticleSystem.h&quot;

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/SmokeProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/SmokeProjectile.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/SmokeProjectile.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -12,7 +12,7 @@
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Sim/Misc/Wind.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CSmokeProjectile, CProjectile, );
 

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/SmokeProjectile2.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/SmokeProjectile2.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/SmokeProjectile2.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -12,7 +12,7 @@
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Sim/Misc/Wind.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CSmokeProjectile2, CProjectile, );
 

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/SmokeTrailProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/SmokeTrailProjectile.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/SmokeTrailProjectile.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -15,7 +15,7 @@
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Sim/Misc/Wind.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CSmokeTrailProjectile, CProjectile, (float3(0,0,0),float3(0,0,0),float3(0,0,0),float3(0,0,0),NULL,0,0,0,0,0,0,NULL,NULL));
 

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/SpherePartProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/SpherePartProjectile.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/SpherePartProjectile.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -2,12 +2,12 @@
 #include &lt;algorithm&gt;
 #include &quot;mmgr.h&quot;
 
-#include &quot;Game/GlobalConstants.h&quot;
+#include &quot;Sim/Misc/GlobalConstants.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;SpherePartProjectile.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 using std::min;
 

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/TracerProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/TracerProjectile.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/TracerProjectile.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -7,7 +7,7 @@
 
 #include &quot;TracerProjectile.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;			// Header File For The OpenGL32 Library
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CTracerProjectile, CProjectile, )
 

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/WakeProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/WakeProjectile.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/WakeProjectile.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -2,13 +2,13 @@
 #include &quot;mmgr.h&quot;
 
 #include &quot;Game/Camera.h&quot;
-#include &quot;Game/GlobalConstants.h&quot;
+#include &quot;Sim/Misc/GlobalConstants.h&quot;
 #include &quot;Rendering/Env/BaseWater.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Sim/Misc/Wind.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;WakeProjectile.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CWakeProjectile, CProjectile, (float3(0,0,0),float3(0,0,0),0,0,NULL,0,0,0));
 

Modified: branches/caiinterface/rts/Sim/Projectiles/Unsynced/WreckProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/Unsynced/WreckProjectile.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Projectiles/Unsynced/WreckProjectile.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -13,7 +13,7 @@
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;SmokeProjectile.h&quot;
 #include &quot;WreckProjectile.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CWreckProjectile, CProjectile, (float3(0,0,0),float3(0,0,0),0,0));
 

Modified: branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/EmgProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/EmgProjectile.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/EmgProjectile.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -8,7 +8,7 @@
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
 #include &quot;Sync/SyncTracer.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CEmgProjectile, CWeaponProjectile, (float3(0,0,0),float3(0,0,0),NULL,float3(0,0,0),0,0,NULL));
 

Modified: branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/ExplosiveProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/ExplosiveProjectile.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/ExplosiveProjectile.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -14,7 +14,7 @@
 #include &quot;Sim/Misc/InterceptHandler.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 #ifdef TRACE_SYNC
 	#include &quot;Sync/SyncTracer.h&quot;

Modified: branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/FireBallProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/FireBallProjectile.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/FireBallProjectile.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -9,7 +9,7 @@
 #include &quot;Rendering/GL/VertexArray.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CFireBallProjectile, CWeaponProjectile, (float3(0,0,0),float3(0,0,0),NULL,NULL,float3(0,0,0),NULL));
 CR_BIND(CFireBallProjectile::Spark, );

Modified: branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/FlameProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/FlameProjectile.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/FlameProjectile.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -8,7 +8,7 @@
 #include &quot;Rendering/Textures/ColorMap.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CFlameProjectile, CWeaponProjectile, (float3(0,0,0),float3(0,0,0),float3(0,0,0),NULL,NULL,0));
 

Modified: branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/LargeBeamLaserProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/LargeBeamLaserProjectile.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/LargeBeamLaserProjectile.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -8,7 +8,7 @@
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CLargeBeamLaserProjectile, CWeaponProjectile, (float3(0,0,0),float3(0,0,0),float3(0,0,0),float3(0,0,0),NULL,NULL));
 

Modified: branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/LaserProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/LaserProjectile.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/LaserProjectile.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -9,7 +9,7 @@
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;Sim/Projectiles/Unsynced/SimpleParticleSystem.h&quot;
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 #ifdef TRACE_SYNC
 	#include &quot;Sync/SyncTracer.h&quot;

Modified: branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/LightningProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/LightningProjectile.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/LightningProjectile.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -7,7 +7,7 @@
 #include &quot;Sim/Weapons/Weapon.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
-#include &quot;Game/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
 
 #ifdef TRACE_SYNC
 	#include &quot;Sync/SyncTracer.h&quot;

Modified: branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/MissileProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/MissileProjectile.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/MissileProjectile.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -21,7 +21,7 @@
 #include &quot;Sync/SyncTracer.h&quot;
 #include &quot;Rendering/UnitModels/s3oParser.h&quot;
 #include &quot;Rendering/UnitModels/3DOParser.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 static const float Smoke_Time=60;
 

Modified: branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/StarburstProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/StarburstProjectile.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/StarburstProjectile.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -18,7 +18,7 @@
 #include &quot;StarburstProjectile.h&quot;
 #include &quot;Sync/SyncTracer.h&quot;
 #include &quot;Rendering/UnitModels/s3oParser.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 static const float Smoke_Time=70;
 

Modified: branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/TorpedoProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/TorpedoProjectile.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/TorpedoProjectile.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -13,7 +13,7 @@
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
 #include &quot;TorpedoProjectile.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 #ifdef TRACE_SYNC
 	#include &quot;Sync/SyncTracer.h&quot;

Modified: branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/WeaponProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/WeaponProjectile.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/WeaponProjectile.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -18,8 +18,8 @@
 #include &quot;Sim/Features/Feature.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Misc/InterceptHandler.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
-#include &quot;System/LogOutput.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
+#include &quot;LogOutput.h&quot;
 #ifdef TRACE_SYNC
 	#include &quot;Sync/SyncTracer.h&quot;
 #endif
@@ -95,7 +95,7 @@
 		if(weaponDef-&gt;interceptedByShieldType) {
 			interceptHandler.AddShieldInterceptableProjectile(this);
 		}
-		
+
 		alwaysVisible = weaponDef-&gt;visuals.alwaysVisible;
 
 		if (!weaponDef-&gt;visuals.modelName.empty()) {
@@ -131,8 +131,10 @@
 					weaponDef-&gt;dynDamageInverted);
 
 		if (weaponDef-&gt;impactOnly) {
-			weaponDef-&gt;explosionGenerator-&gt;Explosion(pos,((weaponDef-&gt;dynDamageExp&gt;0)
-					? dynDamages : weaponDef-&gt;damages)[0],weaponDef-&gt;areaOfEffect,owner,0,NULL,impactDir);
+			if (weaponDef-&gt;explosionGenerator) {
+				weaponDef-&gt;explosionGenerator-&gt;Explosion(pos,((weaponDef-&gt;dynDamageExp&gt;0)
+						? dynDamages : weaponDef-&gt;damages)[0],weaponDef-&gt;areaOfEffect,owner,0,NULL,impactDir);
+			}
 		} else {
 			helper-&gt;Explosion(pos,
 				(weaponDef-&gt;dynDamageExp &gt; 0)?
@@ -196,7 +198,9 @@
 				damages, owner,
 				impactDir * (damages[0] + weaponDef-&gt;damages.impulseBoost)
 				* weaponDef-&gt;damages.impulseFactor, weaponDef-&gt;id);
-			weaponDef-&gt;explosionGenerator-&gt;Explosion(pos,damages[0],weaponDef-&gt;areaOfEffect,owner,0,unit,impactDir);
+			if (weaponDef-&gt;explosionGenerator) {
+				weaponDef-&gt;explosionGenerator-&gt;Explosion(pos,damages[0],weaponDef-&gt;areaOfEffect,owner,0,unit,impactDir);
+			}
 		}
 		else {
 		    helper-&gt;Explosion(pos, damages,
@@ -252,13 +256,13 @@
 		{
 			wh = ground-&gt;GetHeight2(pos.x, pos.z);
 		} else if(weaponDef-&gt;groundBounce)
-		{ 
+		{
 			wh = ground-&gt;GetHeight(pos.x, pos.z);
 		}
 		if(pos.y &lt; wh)
 		{
 			bounces++;
-			if(!keepBouncing || (this-&gt;weaponDef-&gt;numBounce &gt;= 0 
+			if(!keepBouncing || (this-&gt;weaponDef-&gt;numBounce &gt;= 0
 							&amp;&amp; bounces &gt; this-&gt;weaponDef-&gt;numBounce))
 			{
 				//Collision();
@@ -278,7 +282,7 @@
 			}
 		}
 	}
-	
+
 }
 
 bool CWeaponProjectile::TraveledRange()

Deleted: branches/caiinterface/rts/Sim/SideParser.cpp
===================================================================
--- branches/caiinterface/rts/Sim/SideParser.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/SideParser.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,155 +0,0 @@
-
-#include &quot;StdAfx.h&quot;
-
-#include &lt;string&gt;
-#include &lt;set&gt;
-using std::string;
-using std::set;
-
-#include &quot;mmgr.h&quot;
-
-#include &quot;SideParser.h&quot;
-#include &quot;Lua/LuaParser.h&quot;
-#include &quot;Lua/LuaSyncedRead.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/Util.h&quot;
-
-
-SideParser sideParser;
-
-
-/******************************************************************************/
-
-SideParser::SideParser()
-{
-}
-
-
-SideParser::~SideParser()
-{
-}
-
-
-bool SideParser::Load()
-{
-	dataVec.clear();
-	errorLog.clear();
-
-	LuaParser parser(&quot;gamedata/sidedata.lua&quot;,
-	                 SPRING_VFS_MOD_BASE, SPRING_VFS_MOD_BASE);
-#if !defined UNITSYNC &amp;&amp; !defined DEDICATED
-	// this should not be included with unitsync:
-	// 1. avoids linkage with LuaSyncedRead
-	// 2. ModOptions are not valid during unitsync mod parsing
-	parser.GetTable(&quot;Spring&quot;);
-	parser.AddFunc(&quot;GetModOptions&quot;, LuaSyncedRead::GetModOptions);
-	parser.EndTable();
-#endif
-	if (!parser.Execute()) {
-		errorLog = parser.GetErrorLog();
-		return false;
-	}
-
-	set&lt;string&gt; sideSet;
-
-	const LuaTable root = parser.GetRoot();
-	for (int i = 1; /* no-op */; i++) {
-		const LuaTable sideTable = root.SubTable(i);
-		if (!sideTable.IsValid()) {
-			break;
-		}
-
-		Data data;
-		data.caseName  = sideTable.GetString(&quot;name&quot;, &quot;&quot;);
-		data.sideName  = StringToLower(data.caseName);
-		data.startUnit = sideTable.GetString(&quot;startUnit&quot;, &quot;&quot;);
-		data.startUnit = StringToLower(data.startUnit);
-
-		if (data.sideName.empty()) {
-			logOutput.Print(&quot;Missing side name: %i&quot;, i);
-		}
-		else if (data.startUnit.empty()) {
-			logOutput.Print(&quot;Missing side start unit: &quot; + data.sideName);
-		}
-		else {
-			if (sideSet.find(data.sideName) != sideSet.end()) {
-				logOutput.Print(&quot;Duplicate side name: &quot; + data.sideName);
-			}
-			else {
-				sideSet.insert(data.sideName);
-				dataVec.push_back(data);
-			}
-		}
-	}
-	return true;
-}
-
- 
-/******************************************************************************/
-
-const SideParser::Data* SideParser::FindSide(const string&amp; sideName) const
-{
-	const string name = StringToLower(sideName);
-	for (unsigned int i = 0; i &lt; dataVec.size(); i++) {
-		const Data&amp; data = dataVec[i];
-		if (name == data.sideName) {
-			return &data;
-		}
-	}
-	return NULL;
-}
-
-
-const string&amp; SideParser::GetSideName(unsigned int index,
-                                      const string&amp; def) const
-{
-	if (!ValidSide(index)) {
-		return def;
-	}
-	return dataVec[index].sideName;
-}
-
-
-const string&amp; SideParser::GetCaseName(unsigned int index,
-                                      const string&amp; def) const
-{
-	if (!ValidSide(index)) {
-		return def;
-	}
-	return dataVec[index].caseName;
-}
-
-
-const string&amp; SideParser::GetCaseName(const string&amp; name,
-                                      const string&amp; def) const
-{
-	const Data* data = FindSide(name);
-	if (data == NULL) {
-		return def;
-	}
-	return data-&gt;caseName;
-}
-
-
-const string&amp; SideParser::GetStartUnit(unsigned int index,
-                                       const string&amp; def) const
-{
-	if (!ValidSide(index)) {
-		return def;
-	}
-	return dataVec[index].startUnit;
-}
-
-
-const string&amp; SideParser::GetStartUnit(const string&amp; name,
-                                       const string&amp; def) const
-{
-	const Data* data = FindSide(name);
-	if (data == NULL) {
-		return def;
-	}
-	return data-&gt;startUnit;
-}
-
-
-/******************************************************************************/

Deleted: branches/caiinterface/rts/Sim/SideParser.h
===================================================================
--- branches/caiinterface/rts/Sim/SideParser.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/SideParser.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,54 +0,0 @@
-
-#ifndef SIDE_PARSER_H
-#define SIDE_PARSER_H
-
-#include &lt;string&gt;
-#include &lt;vector&gt;
-
-
-class SideParser
-{
-	public:
-		SideParser();
-		~SideParser();
-
-		bool Load();
-		const std::string&amp; GetErrorLog() const { return errorLog; }
-
-		const unsigned int GetCount() const { return dataVec.size(); }
-
-		const std::string&amp; GetSideName(unsigned int index,
-		                               const std::string&amp; def = &quot;&quot;) const;
-		const std::string&amp; GetCaseName(unsigned int index,
-		                               const std::string&amp; def = &quot;&quot;) const;
-		const std::string&amp; GetCaseName(const std::string&amp; name,
-		                               const std::string&amp; def = &quot;&quot;) const;
-		const std::string&amp; GetStartUnit(unsigned int index,
-		                                const std::string&amp; def = &quot;&quot;) const;
-		const std::string&amp; GetStartUnit(const std::string&amp; name,
-		                                const std::string&amp; def = &quot;&quot;) const;
-
-		bool ValidSide(unsigned int index) const {
-			return (index &lt; dataVec.size());
-		}
-
-	private:
-		struct Data {
-			std::string caseName;  // full  case
-			std::string sideName;  // lower case
-			std::string startUnit; // lower case
-		};
-		typedef std::vector&lt;Data&gt; DataVec;
-
-		const Data* FindSide(const std::string&amp; sideName) const;
-
-	private:
-		DataVec dataVec;
-		std::string errorLog;
-};
-
-
-extern SideParser sideParser;
-
-
-#endif // SIDE_PARSER_H

Modified: branches/caiinterface/rts/Sim/Units/COB/CobFile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/COB/CobFile.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Units/COB/CobFile.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -10,7 +10,7 @@
 #include &quot;LogOutput.h&quot;
 #include &quot;Sound.h&quot;
 #include &quot;Platform/byteorder.h&quot;
-#include &quot;System/Util.h&quot;
+#include &quot;Util.h&quot;
 
 //The following structure is taken from <A HREF="http://visualta.tauniverse.com/Downloads/ta-cob-fmt.txt">http://visualta.tauniverse.com/Downloads/ta-cob-fmt.txt</A>
 //Information on missing fields from Format_Cob.pas

Modified: branches/caiinterface/rts/Sim/Units/COB/CobInstance.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/COB/CobInstance.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Units/COB/CobInstance.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -18,6 +18,7 @@
 #include &quot;Sim/Misc/GroundBlockingObjectMap.h&quot;
 #include &quot;Sim/Misc/LosHandler.h&quot;
 #include &quot;Sim/Misc/RadarHandler.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/MoveTypes/AirMoveType.h&quot;
 #include &quot;Sim/MoveTypes/MoveType.h&quot;
 #include &quot;Sim/Projectiles/ExplosionGenerator.h&quot;
@@ -38,7 +39,7 @@
 #include &quot;Sim/Weapons/PlasmaRepulser.h&quot;
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
 #include &quot;Sim/Weapons/Weapon.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 #include &quot;Sound.h&quot;
 #include &quot;Sync/SyncTracer.h&quot;
 
@@ -1100,7 +1101,7 @@
 		return u ? unit-&gt;team : 0; }
 	case UNIT_ALLIED:{
 		CUnit *u = (p1 &gt;= 0 &amp;&amp; p1 &lt; MAX_UNITS) ? uh-&gt;units[p1] : NULL;
-		if (u) return gs-&gt;Ally (unit-&gt;allyteam, u-&gt;allyteam) ? 1 : 0;
+		if (u) return teamHandler-&gt;Ally (unit-&gt;allyteam, u-&gt;allyteam) ? 1 : 0;
 		return 0;}
 	case UNIT_BUILD_PERCENT_LEFT:{
 		CUnit *u = (p1 &gt;= 0 &amp;&amp; p1 &lt; MAX_UNITS) ? uh-&gt;units[p1] : NULL;
@@ -1379,7 +1380,7 @@
 		}
 	}
 	case GAME_FRAME: {
-		return gs-&gt;frameNum;	                 		
+		return gs-&gt;frameNum;
 	}
 	default:
 		if ((val &gt;= GLOBAL_VAR_START) &amp;&amp; (val &lt;= GLOBAL_VAR_END)) {

Modified: branches/caiinterface/rts/Sim/Units/COB/CobInstance.h
===================================================================
--- branches/caiinterface/rts/Sim/Units/COB/CobInstance.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Units/COB/CobInstance.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -10,7 +10,7 @@
 const float  RAD2TAANG = 9.587526207370107576104371709781e-5f;
 
 #include &quot;Object.h&quot;
-#include &quot;Game/GlobalConstants.h&quot;
+#include &quot;Sim/Misc/GlobalConstants.h&quot;
 
 
 #define PACKXZ(x,z) (((int)(x) &lt;&lt; 16)+((int)(z) &amp; 0xffff))

Modified: branches/caiinterface/rts/Sim/Units/COB/CobThread.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/COB/CobThread.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Units/COB/CobThread.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -10,7 +10,7 @@
 
 #include &quot;LogOutput.h&quot;
 
-#include &quot;Game/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
 
 CCobThread::CCobThread(CCobFile &amp;script, CCobInstance *owner)
 : owner(owner), script(script)

Modified: branches/caiinterface/rts/Sim/Units/CommandAI/AirCAI.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/CommandAI/AirCAI.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Units/CommandAI/AirCAI.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -10,16 +10,17 @@
 #include &quot;Map/Ground.h&quot;
 #include &quot;Rendering/GL/glExtra.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/MoveTypes/AirMoveType.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
 #include &quot;Sim/Weapons/Weapon.h&quot;
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
-#include &quot;System/myMath.h&quot;
-#include &quot;System/LogOutput.h&quot;
+#include &quot;myMath.h&quot;
+#include &quot;LogOutput.h&quot;
 #include &lt;assert.h&gt;
-#include &quot;System/GlobalUnsynced.h&quot;
-#include &quot;System/Util.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
+#include &quot;Util.h&quot;
 
 
 CR_BIND_DERIVED(CAirCAI,CMobileCAI , );
@@ -55,7 +56,7 @@
 		c.tooltip=&quot;Sets the aircraft to attack enemy units within a circle&quot;;
 		possibleCommands.push_back(c);
 	}
-	
+
 	if(owner-&gt;unitDef-&gt;canLoopbackAttack){
 		c.params.clear();
 		c.id=CMD_LOOPBACKATTACK;
@@ -259,7 +260,7 @@
 	if (c.id == CMD_WAIT) {
 		if ((myPlane-&gt;aircraftState == AAirMoveType::AIRCRAFT_FLYING)
 		    &amp;&amp; !owner-&gt;unitDef-&gt;DontLand() &amp;&amp; myPlane-&gt;autoLand) {
-			StopMove(); 
+			StopMove();
 //			myPlane-&gt;SetState(AAirMoveType::AIRCRAFT_LANDING);
 		}
 		return;
@@ -597,7 +598,7 @@
 int CAirCAI::GetDefaultCmd(CUnit* pointed, CFeature* feature)
 {
 	if (pointed) {
-		if (!gs-&gt;Ally(gu-&gt;myAllyTeam, pointed-&gt;allyteam)) {
+		if (!teamHandler-&gt;Ally(gu-&gt;myAllyTeam, pointed-&gt;allyteam)) {
 			if (owner-&gt;unitDef-&gt;canAttack) {
 				return CMD_ATTACK;
 			}

Modified: branches/caiinterface/rts/Sim/Units/CommandAI/BuilderCAI.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/CommandAI/BuilderCAI.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Units/CommandAI/BuilderCAI.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -10,7 +10,7 @@
 #include &quot;ExternalAI/Group.h&quot;
 #include &quot;Game/GameHelper.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
-#include &quot;Game/Team.h&quot;
+#include &quot;Sim/Misc/Team.h&quot;
 #include &quot;Game/UI/CommandColors.h&quot;
 #include &quot;Game/UI/CursorIcons.h&quot;
 #include &quot;LogOutput.h&quot;
@@ -25,6 +25,7 @@
 #include &quot;Sim/Features/FeatureHandler.h&quot;
 #include &quot;Sim/Misc/GroundBlockingObjectMap.h&quot;
 #include &quot;Sim/Misc/QuadField.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/MoveTypes/MoveType.h&quot;
 #include &quot;Sim/Units/UnitSet.h&quot;
 #include &quot;Sim/Units/UnitDefHandler.h&quot;
@@ -36,9 +37,9 @@
 #include &quot;Sim/Units/UnitTypes/TransportUnit.h&quot;
 #include &quot;myMath.h&quot;
 #include &quot;creg/STL_Map.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
-#include &quot;System/Util.h&quot;
-#include &quot;System/Exceptions.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
+#include &quot;Util.h&quot;
+#include &quot;Exceptions.h&quot;
 
 
 CR_BIND_DERIVED(CBuilderCAI ,CMobileCAI , );
@@ -416,7 +417,7 @@
 						if (luaRules &amp;&amp; !luaRules-&gt;AllowUnitCreation(build.def, owner, &amp;build.pos)) {
 							FinishCommand();
 						}
-						else if (uh-&gt;maxUnits &gt; (int) gs-&gt;Team(owner-&gt;team)-&gt;units.size()) {
+						else if (uh-&gt;maxUnits &gt; (int) teamHandler-&gt;Team(owner-&gt;team)-&gt;units.size()) {
 							// max unitlimit reached
 							buildRetries++;
 							owner-&gt;moveType-&gt;KeepPointingTo(build.pos, fac-&gt;buildDistance * 0.7f + radius, false);
@@ -956,7 +957,7 @@
 int CBuilderCAI::GetDefaultCmd(CUnit* pointed, CFeature* feature)
 {
 	if (pointed) {
-		if (!gs-&gt;Ally(gu-&gt;myAllyTeam, pointed-&gt;allyteam)) {
+		if (!teamHandler-&gt;Ally(gu-&gt;myAllyTeam, pointed-&gt;allyteam)) {
 			if (owner-&gt;unitDef-&gt;canAttack &amp;&amp; (owner-&gt;maxRange &gt; 0)) {
 				return CMD_ATTACK;
 			} else if (owner-&gt;unitDef-&gt;canReclaim &amp;&amp; pointed-&gt;unitDef-&gt;reclaimable) {
@@ -1039,7 +1040,7 @@
 		}
 
 		const int cmdUnitId = (int)c.params[0];
-		if (cmdUnitId == unit-&gt;id &amp;&amp; gs-&gt;Ally(unit-&gt;team, (*it)-&gt;team)) {
+		if (cmdUnitId == unit-&gt;id &amp;&amp; teamHandler-&gt;Ally(unit-&gt;team, (*it)-&gt;team)) {
 			retval = true;
 			break;
 		}
@@ -1116,7 +1117,7 @@
 
 	const CFeature* best = NULL;
 	float bestDist = 1.0e30f;
-	const CTeam* team = gs-&gt;Team(owner-&gt;team);
+	const CTeam* team = teamHandler-&gt;Team(owner-&gt;team);
 
 	for (fi = features.begin(); fi != features.end(); ++fi) {
 		const CFeature* f = *fi;
@@ -1204,7 +1205,7 @@
 	for (ui = cu.begin(); ui != cu.end(); ++ui) {
 		CUnit* unit = *ui;
 
-		if (!gs-&gt;Ally(myAllyteam, unit-&gt;allyteam) &amp;&amp; (unit != owner) &amp;&amp;
+		if (!teamHandler-&gt;Ally(myAllyteam, unit-&gt;allyteam) &amp;&amp; (unit != owner) &amp;&amp;
 			!unit-&gt;beingBuilt &amp;&amp; unit-&gt;unitDef-&gt;capturable) {
 			const float dist = f3SqLen(unit-&gt;pos - owner-&gt;pos);
 
@@ -1246,7 +1247,7 @@
 
 	for (ui = cu.begin(); ui != cu.end(); ++ui) {
 		CUnit* unit = *ui;
-		if (gs-&gt;Ally(owner-&gt;allyteam, unit-&gt;allyteam)) {
+		if (teamHandler-&gt;Ally(owner-&gt;allyteam, unit-&gt;allyteam)) {
 			if (!haveEnemy &amp;&amp; (unit-&gt;health &lt; unit-&gt;maxHealth)) {
 				// dont lock-on to units outside of our reach (for immobile builders)
 				if (!owner-&gt;unitDef-&gt;canmove &amp;&amp; !ObjInBuildRange(unit)) {
@@ -1336,7 +1337,7 @@
 {
 	if(uh-&gt;limitDgun &amp;&amp; owner-&gt;unitDef-&gt;isCommander) {
 		glColor4f(1.0f, 1.0f, 1.0f, 0.6f);
-		glSurfaceCircle(gs-&gt;Team(owner-&gt;team)-&gt;startPos, uh-&gt;dgunRadius, 40);
+		glSurfaceCircle(teamHandler-&gt;Team(owner-&gt;team)-&gt;startPos, uh-&gt;dgunRadius, 40);
 	}
 
 	lineDrawer.StartPath(owner-&gt;midPos, cmdColors.start);

Modified: branches/caiinterface/rts/Sim/Units/CommandAI/BuilderCAI.h
===================================================================
--- branches/caiinterface/rts/Sim/Units/CommandAI/BuilderCAI.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Units/CommandAI/BuilderCAI.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -3,8 +3,8 @@
 
 #include &lt;map&gt;
 #include &quot;MobileCAI.h&quot;
-#include &quot;../UnitDef.h&quot;
-#include &quot;../../Objects/SolidObject.h&quot;
+#include &quot;Sim/Units/UnitDef.h&quot;
+#include &quot;Sim/Objects/SolidObject.h&quot;
 
 class CUnitSet;
 

Modified: branches/caiinterface/rts/Sim/Units/CommandAI/CommandAI.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/CommandAI/CommandAI.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Units/CommandAI/CommandAI.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -8,7 +8,6 @@
 #include &quot;ExternalAI/Group.h&quot;
 #include &quot;Game/GameHelper.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
-#include &quot;Game/Team.h&quot;
 #include &quot;Game/WaitCommandsAI.h&quot;
 #include &quot;Game/UI/CommandColors.h&quot;
 #include &quot;Game/UI/CursorIcons.h&quot;
@@ -18,6 +17,7 @@
 #include &quot;Map/Ground.h&quot;
 #include &quot;Sim/Features/Feature.h&quot;
 #include &quot;Sim/Features/FeatureHandler.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/MoveTypes/MoveType.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;Sim/Units/UnitDefHandler.h&quot;
@@ -26,15 +26,15 @@
 #include &quot;Sim/Units/UnitTypes/Factory.h&quot;
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
 #include &quot;Sim/Weapons/Weapon.h&quot;
-#include &quot;System/EventHandler.h&quot;
+#include &quot;EventHandler.h&quot;
 #include &quot;LoadSaveInterface.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;myMath.h&quot;
 #include &quot;creg/STL_Set.h&quot;
 #include &quot;creg/STL_Deque.h&quot;
 #include &lt;assert.h&gt;
-#include &quot;System/GlobalUnsynced.h&quot;
-#include &quot;System/Util.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
+#include &quot;Util.h&quot;
 
 const int TARGET_LOST_TIMER =120;	// in calls to SlowUpdate() (approx. once every second)
 
@@ -370,7 +370,7 @@
 	const UnitDef* ud = owner-&gt;unitDef;
 	int maxHeightDiff = SQUARE_SIZE;
 	// AI's may do as they like
-	bool aiOrder = (gs-&gt;Team(owner-&gt;team) &amp;&amp; gs-&gt;Team(owner-&gt;team)-&gt;isAI);
+	bool aiOrder = (teamHandler-&gt;Team(owner-&gt;team) &amp;&amp; teamHandler-&gt;Team(owner-&gt;team)-&gt;isAI);
 
 	switch (c.id) {
 		case CMD_DGUN:
@@ -1224,7 +1224,7 @@
 int CCommandAI::GetDefaultCmd(CUnit* pointed, CFeature* feature)
 {
 	if (pointed) {
-		if (!gs-&gt;Ally(gu-&gt;myAllyTeam, pointed-&gt;allyteam)) {
+		if (!teamHandler-&gt;Ally(gu-&gt;myAllyTeam, pointed-&gt;allyteam)) {
 			if (isAttackCapable()) {
 				return CMD_ATTACK;
 			}

Modified: branches/caiinterface/rts/Sim/Units/CommandAI/CommandAI.h
===================================================================
--- branches/caiinterface/rts/Sim/Units/CommandAI/CommandAI.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Units/CommandAI/CommandAI.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -6,7 +6,7 @@
 #include &lt;set&gt;
 
 #include &quot;Object.h&quot;
-#include &quot;Sim/Units/CommandAI/Command.h&quot;
+#include &quot;Command.h&quot;
 #include &quot;CommandQueue.h&quot;
 #include &quot;float3.h&quot;
 

Modified: branches/caiinterface/rts/Sim/Units/CommandAI/CommandQueue.h
===================================================================
--- branches/caiinterface/rts/Sim/Units/CommandAI/CommandQueue.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Units/CommandAI/CommandQueue.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -3,7 +3,7 @@
 
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &lt;deque&gt;
-#include &quot;Sim/Units/CommandAI/Command.h&quot;
+#include &quot;Command.h&quot;
 
 // A wrapper class for  std::deque&lt;Command&gt;  to keep track of commands
 

Modified: branches/caiinterface/rts/Sim/Units/CommandAI/FactoryCAI.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/CommandAI/FactoryCAI.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Units/CommandAI/FactoryCAI.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -4,10 +4,9 @@
 #include &quot;FactoryCAI.h&quot;
 #include &quot;LineDrawer.h&quot;
 #include &quot;ExternalAI/Group.h&quot;
-#include &quot;Game/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
 #include &quot;Game/GameHelper.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
-#include &quot;Game/Team.h&quot;
 #include &quot;Game/WaitCommandsAI.h&quot;
 #include &quot;Game/UI/CommandColors.h&quot;
 #include &quot;Game/UI/CursorIcons.h&quot;
@@ -15,15 +14,16 @@
 #include &quot;Rendering/GL/glExtra.h&quot;
 #include &quot;Rendering/UnitModels/UnitDrawer.h&quot;
 #include &quot;Lua/LuaRules.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
 #include &quot;Sim/Units/UnitLoader.h&quot;
 #include &quot;Sim/Units/UnitDefHandler.h&quot;
 #include &quot;Sim/Units/UnitTypes/Factory.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;creg/STL_Map.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
-#include &quot;System/Util.h&quot;
-#include &quot;System/Exceptions.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
+#include &quot;Util.h&quot;
+#include &quot;Exceptions.h&quot;
 
 CR_BIND_DERIVED(CFactoryCAI ,CCommandAI , );
 
@@ -386,7 +386,7 @@
 				else if(uh-&gt;unitsByDefs[owner-&gt;team][def-&gt;id].size() &gt;= def-&gt;maxThisUnit){ //unit restricted?
 					CancelRestrictedUnit(c, boi-&gt;second);
 				}
-				else if(uh-&gt;maxUnits&gt;gs-&gt;Team(owner-&gt;team)-&gt;units.size()){  //max unitlimit reached?
+				else if(uh-&gt;maxUnits&gt;teamHandler-&gt;Team(owner-&gt;team)-&gt;units.size()){  //max unitlimit reached?
 					fac-&gt;StartBuild(boi-&gt;second.fullName);
 					building=true;
 				}
@@ -423,7 +423,7 @@
 int CFactoryCAI::GetDefaultCmd(CUnit* pointed, CFeature* feature)
 {
 	if (pointed) {
-		if (gs-&gt;Ally(gu-&gt;myAllyTeam, pointed-&gt;allyteam)) {
+		if (teamHandler-&gt;Ally(gu-&gt;myAllyTeam, pointed-&gt;allyteam)) {
 			if (owner-&gt;unitDef-&gt;canGuard) {
 				return CMD_GUARD;
 			}

Modified: branches/caiinterface/rts/Sim/Units/CommandAI/MobileCAI.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/CommandAI/MobileCAI.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Units/CommandAI/MobileCAI.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -7,11 +7,11 @@
 #include &quot;ExternalAI/Group.h&quot;
 #include &quot;Game/GameHelper.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
-#include &quot;Game/Team.h&quot;
 #include &quot;Game/UI/CommandColors.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Sim/Misc/AirBaseHandler.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/MoveTypes/MoveType.h&quot;
 #include &quot;Sim/MoveTypes/TAAirMoveType.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
@@ -21,11 +21,11 @@
 #include &quot;Sim/Weapons/Weapon.h&quot;
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
 #include &quot;Sim/Weapons/DGunWeapon.h&quot;
-#include &quot;System/LogOutput.h&quot;
+#include &quot;LogOutput.h&quot;
 #include &quot;myMath.h&quot;
 #include &lt;assert.h&gt;
-#include &quot;System/Util.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;Util.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 CR_BIND_DERIVED(CMobileCAI ,CCommandAI , );
 
@@ -633,7 +633,7 @@
 void CMobileCAI::ExecuteDGun(Command &amp;c)
 {
 	if (uh-&gt;limitDgun &amp;&amp; owner-&gt;unitDef-&gt;isCommander
-			&amp;&amp; owner-&gt;pos.SqDistance(gs-&gt;Team(owner-&gt;team)-&gt;startPos) &gt; Square(uh-&gt;dgunRadius)) {
+			&amp;&amp; owner-&gt;pos.SqDistance(teamHandler-&gt;Team(owner-&gt;team)-&gt;startPos) &gt; Square(uh-&gt;dgunRadius)) {
 		StopMove();
 		return FinishCommand();
 	}
@@ -878,7 +878,7 @@
 int CMobileCAI::GetDefaultCmd(CUnit* pointed, CFeature* feature)
 {
 	if (pointed) {
-		if (!gs-&gt;Ally(gu-&gt;myAllyTeam,pointed-&gt;allyteam)) {
+		if (!teamHandler-&gt;Ally(gu-&gt;myAllyTeam,pointed-&gt;allyteam)) {
 			if (owner-&gt;unitDef-&gt;canAttack) {
 				return CMD_ATTACK;
 			}

Modified: branches/caiinterface/rts/Sim/Units/CommandAI/TransportCAI.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/CommandAI/TransportCAI.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Units/CommandAI/TransportCAI.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -3,6 +3,7 @@
 
 #include &quot;TransportCAI.h&quot;
 #include &quot;LineDrawer.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/COB/CobInstance.h&quot;
@@ -16,11 +17,11 @@
 #include &quot;Rendering/GL/glExtra.h&quot;
 #include &quot;Game/GameHelper.h&quot;
 #include &quot;Sim/MoveTypes/TAAirMoveType.h&quot;
-#include &quot;Sim/ModInfo.h&quot;
+#include &quot;Sim/Misc/ModInfo.h&quot;
 #include &quot;Rendering/UnitModels/3DOParser.h&quot;
 #include &quot;creg/STL_List.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
-#include &quot;System/myMath.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
+#include &quot;myMath.h&quot;
 
 #define AIRTRANSPORT_DOCKING_RADIUS 16
 #define AIRTRANSPORT_DOCKING_ANGLE 50
@@ -281,7 +282,7 @@
 	if(unit-&gt;mass&gt;=100000 || unit-&gt;beingBuilt)
 		return false;
 	// don't transport cloaked enemies
-	if (unit-&gt;isCloaked &amp;&amp; !gs-&gt;AlliedTeams(unit-&gt;team, owner-&gt;team))
+	if (unit-&gt;isCloaked &amp;&amp; !teamHandler-&gt;AlliedTeams(unit-&gt;team, owner-&gt;team))
 		return false;
 	if(unit-&gt;xsize &gt; owner-&gt;unitDef-&gt;transportSize*2)
 		return false;
@@ -880,7 +881,7 @@
 int CTransportCAI::GetDefaultCmd(CUnit* pointed, CFeature* feature)
 {
 	if (pointed) {
-		if (!gs-&gt;Ally(gu-&gt;myAllyTeam, pointed-&gt;allyteam)) {
+		if (!teamHandler-&gt;Ally(gu-&gt;myAllyTeam, pointed-&gt;allyteam)) {
 			if (owner-&gt;unitDef-&gt;canAttack) {
 				return CMD_ATTACK;
 			} else if (CanTransport(pointed)) {

Modified: branches/caiinterface/rts/Sim/Units/Unit.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/Unit.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Units/Unit.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -17,7 +17,6 @@
 #include &quot;Game/GameSetup.h&quot;
 #include &quot;Game/Player.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
-#include &quot;Game/Team.h&quot;
 #include &quot;Game/UI/MiniMap.h&quot;
 #include &quot;Lua/LuaRules.h&quot;
 #include &quot;Map/Ground.h&quot;
@@ -36,8 +35,9 @@
 #include &quot;Sim/Misc/LosHandler.h&quot;
 #include &quot;Sim/Misc/QuadField.h&quot;
 #include &quot;Sim/Misc/RadarHandler.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Misc/Wind.h&quot;
-#include &quot;Sim/ModInfo.h&quot;
+#include &quot;Sim/Misc/ModInfo.h&quot;
 #include &quot;Sim/MoveTypes/AirMoveType.h&quot;
 #include &quot;Sim/MoveTypes/MoveType.h&quot;
 #include &quot;Sim/MoveTypes/ScriptMoveType.h&quot;
@@ -49,12 +49,12 @@
 #include &quot;Sim/Weapons/Weapon.h&quot;
 #include &quot;Sync/SyncedPrimitive.h&quot;
 #include &quot;Sync/SyncTracer.h&quot;
-#include &quot;System/EventHandler.h&quot;
-#include &quot;System/LoadSaveInterface.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/Matrix44f.h&quot;
-#include &quot;System/myMath.h&quot;
-#include &quot;System/Sound.h&quot;
+#include &quot;EventHandler.h&quot;
+#include &quot;LoadSaveInterface.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;Matrix44f.h&quot;
+#include &quot;myMath.h&quot;
+#include &quot;Sound.h&quot;
 #include &quot;UnitDef.h&quot;
 #include &quot;Unit.h&quot;
 #include &quot;UnitHandler.h&quot;
@@ -314,17 +314,17 @@
 
 void CUnit::SetMetalStorage(float newStorage)
 {
-	gs-&gt;Team(team)-&gt;metalStorage-=metalStorage;
+	teamHandler-&gt;Team(team)-&gt;metalStorage-=metalStorage;
 	metalStorage = newStorage;
-	gs-&gt;Team(team)-&gt;metalStorage+=metalStorage;
+	teamHandler-&gt;Team(team)-&gt;metalStorage+=metalStorage;
 }
 
 
 void CUnit::SetEnergyStorage(float newStorage)
 {
-	gs-&gt;Team(team)-&gt;energyStorage-=energyStorage;
+	teamHandler-&gt;Team(team)-&gt;energyStorage-=energyStorage;
 	energyStorage = newStorage;
-	gs-&gt;Team(team)-&gt;energyStorage+=energyStorage;
+	teamHandler-&gt;Team(team)-&gt;energyStorage+=energyStorage;
 }
 
 
@@ -332,7 +332,7 @@
 {
 	pos = position;
 	team = Team;
-	allyteam = gs-&gt;AllyTeam(Team);
+	allyteam = teamHandler-&gt;AllyTeam(Team);
 	lineage = Team;
 	unitDef = def;
 	unitDefName = unitDef-&gt;name;
@@ -677,7 +677,7 @@
 		nextPosErrorUpdate = 16;
 	}
 
-	for (int at = 0; at &lt; gs-&gt;activeAllyTeams; ++at) {
+	for (int at = 0; at &lt; teamHandler-&gt;ActiveAllyTeams(); ++at) {
 		UpdateLosStatus(at);
 	}
 
@@ -1005,9 +1005,9 @@
 			// Dont log overkill damage (so dguns/nukes etc dont inflate values)
 			const float statsdamage = std::max(0.0f, std::min(maxHealth - health, damage));
 			if (attacker) {
-				gs-&gt;Team(attacker-&gt;team)-&gt;currentStats.damageDealt += statsdamage;
+				teamHandler-&gt;Team(attacker-&gt;team)-&gt;currentStats.damageDealt += statsdamage;
 			}
-			gs-&gt;Team(team)-&gt;currentStats.damageReceived += statsdamage;
+			teamHandler-&gt;Team(team)-&gt;currentStats.damageReceived += statsdamage;
 			health -= damage;
 		}
 		else { // healing
@@ -1054,7 +1054,7 @@
 
 	if (damage &gt; 0.0f) {
 		recentDamage += damage;
-		if ((attacker != NULL) &amp;&amp; !gs-&gt;Ally(allyteam, attacker-&gt;allyteam)) {
+		if ((attacker != NULL) &amp;&amp; !teamHandler-&gt;Ally(allyteam, attacker-&gt;allyteam)) {
 			attacker-&gt;AddExperience(0.1f * experienceMod
 			                             * (power / attacker-&gt;power)
 			                             * (damage + std::min(0.0f, health)) / maxHealth);
@@ -1094,9 +1094,9 @@
 	if (health &lt;= 0.0f) {
 		KillUnit(false, false, attacker);
 		if (isDead &amp;&amp; (attacker != 0) &amp;&amp;
-		    !gs-&gt;Ally(allyteam, attacker-&gt;allyteam) &amp;&amp; !beingBuilt) {
+		    !teamHandler-&gt;Ally(allyteam, attacker-&gt;allyteam) &amp;&amp; !beingBuilt) {
 			attacker-&gt;AddExperience(expMultiplier * 0.1f * (power / attacker-&gt;power));
-			gs-&gt;Team(attacker-&gt;team)-&gt;currentStats.unitsKilled++;
+			teamHandler-&gt;Team(attacker-&gt;team)-&gt;currentStats.unitsKilled++;
 		}
 	}
 //	if(attacker!=0 &amp;&amp; attacker-&gt;team==team)
@@ -1115,7 +1115,7 @@
 
 
 void CUnit::UpdateDrawPos() {
-	CTransportUnit *trans=GetTransporter(); 
+	CTransportUnit *trans=GetTransporter();
 #if defined(USE_GML) &amp;&amp; GML_ENABLE_SIMDRAW
 	if (trans) {
 		drawPos = pos + (trans-&gt;speed * ((float)gu-&gt;lastFrameStart - (float)lastUnitUpdate) * gu-&gt;weightedSpeedFactor);
@@ -1256,7 +1256,7 @@
 		                             ph-&gt;seismictex, 30, 15, 0, pingSize, 1,
 		                             float3(0.8f,0.0f,0.0f));
 	}
-	for (int a = 0; a &lt; gs-&gt;activeAllyTeams; ++a) {
+	for (int a = 0; a &lt; teamHandler-&gt;ActiveAllyTeams(); ++a) {
 		if (radarhandler-&gt;InSeismicDistance(this, a)) {
 			const float3 err(errorScale[a] * (0.5f - rx), 0.0f,
 			                 errorScale[a] * (0.5f - rz));
@@ -1312,7 +1312,7 @@
 	eoh-&gt;UnitCaptured(*this, oldteam);
 
 	// reset states and clear the queues
-	if (!gs-&gt;AlliedTeams(oldteam, newteam)) {
+	if (!teamHandler-&gt;AlliedTeams(oldteam, newteam)) {
 		ChangeTeamReset();
 	}
 
@@ -1332,28 +1332,28 @@
 	// Sharing commander in com ends game kills you.
 	// Note that this will kill the com too.
 	if (unitDef-&gt;isCommander) {
-		gs-&gt;Team(oldteam)-&gt;CommanderDied(this);
+		teamHandler-&gt;Team(oldteam)-&gt;CommanderDied(this);
 	}
 
 	if (type == ChangeGiven) {
-		gs-&gt;Team(oldteam)-&gt;RemoveUnit(this, CTeam::RemoveGiven);
-		gs-&gt;Team(newteam)-&gt;AddUnit(this,    CTeam::AddGiven);
+		teamHandler-&gt;Team(oldteam)-&gt;RemoveUnit(this, CTeam::RemoveGiven);
+		teamHandler-&gt;Team(newteam)-&gt;AddUnit(this,    CTeam::AddGiven);
 	} else {
-		gs-&gt;Team(oldteam)-&gt;RemoveUnit(this, CTeam::RemoveCaptured);
-		gs-&gt;Team(newteam)-&gt;AddUnit(this,    CTeam::AddCaptured);
+		teamHandler-&gt;Team(oldteam)-&gt;RemoveUnit(this, CTeam::RemoveCaptured);
+		teamHandler-&gt;Team(newteam)-&gt;AddUnit(this,    CTeam::AddCaptured);
 	}
 
 	if (!beingBuilt) {
-		gs-&gt;Team(oldteam)-&gt;metalStorage  -= metalStorage;
-		gs-&gt;Team(oldteam)-&gt;energyStorage -= energyStorage;
+		teamHandler-&gt;Team(oldteam)-&gt;metalStorage  -= metalStorage;
+		teamHandler-&gt;Team(oldteam)-&gt;energyStorage -= energyStorage;
 
-		gs-&gt;Team(newteam)-&gt;metalStorage  += metalStorage;
-		gs-&gt;Team(newteam)-&gt;energyStorage += energyStorage;
+		teamHandler-&gt;Team(newteam)-&gt;metalStorage  += metalStorage;
+		teamHandler-&gt;Team(newteam)-&gt;energyStorage += energyStorage;
 	}
 
 
 	team = newteam;
-	allyteam = gs-&gt;AllyTeam(newteam);
+	allyteam = teamHandler-&gt;AllyTeam(newteam);
 
 	uh-&gt;unitsByDefs[oldteam][unitDef-&gt;id].erase(this);
 	uh-&gt;unitsByDefs[newteam][unitDef-&gt;id].insert(this);
@@ -1493,7 +1493,7 @@
 
 void CUnit::SetLastAttacker(CUnit* attacker)
 {
-	if (gs-&gt;Ally(team, attacker-&gt;team) || gs-&gt;AlliedTeams(team, attacker-&gt;team)) {
+	if (teamHandler-&gt;AlliedTeams(team, attacker-&gt;team)) {
 		return;
 	}
 	if (lastAttacker &amp;&amp; lastAttacker != userTarget)
@@ -1699,8 +1699,8 @@
 
 
 		if (beingBuilt) { //build
-			if ((gs-&gt;Team(builder-&gt;team)-&gt;metal  &gt;= metalUse) &amp;&amp;
-			    (gs-&gt;Team(builder-&gt;team)-&gt;energy &gt;= energyUse) &amp;&amp;
+			if ((teamHandler-&gt;Team(builder-&gt;team)-&gt;metal  &gt;= metalUse) &amp;&amp;
+			    (teamHandler-&gt;Team(builder-&gt;team)-&gt;energy &gt;= energyUse) &amp;&amp;
 			    (!luaRules || luaRules-&gt;AllowUnitBuildStep(builder, this, part))) {
 				if (builder-&gt;UseMetal(metalUse)) { //just because we checked doesn't mean they were deducted since upkeep can prevent deduction
 					if (builder-&gt;UseEnergy(energyUse)) {
@@ -1720,8 +1720,8 @@
 				return true;
 			} else {
 				// update the energy and metal required counts
-				gs-&gt;Team(builder-&gt;team)-&gt;metalPull  += metalUse;
-				gs-&gt;Team(builder-&gt;team)-&gt;energyPull += energyUse;
+				teamHandler-&gt;Team(builder-&gt;team)-&gt;metalPull  += metalUse;
+				teamHandler-&gt;Team(builder-&gt;team)-&gt;energyPull += energyUse;
 			}
 			return false;
 		}
@@ -1729,7 +1729,7 @@
 			const float energyUseScaled = energyUse * modInfo.repairEnergyCostFactor;
 
 	  		if (!builder-&gt;UseEnergy(energyUseScaled)) {
-				gs-&gt;Team(builder-&gt;team)-&gt;energyPull += energyUseScaled;
+				teamHandler-&gt;Team(builder-&gt;team)-&gt;energyPull += energyUseScaled;
 				return false;
 			}
 
@@ -1763,7 +1763,7 @@
 		const float energyUseScaled = energyUse * modInfo.reclaimUnitEnergyCostFactor;
 
 		if (!builder-&gt;UseEnergy(-energyUseScaled)) {
-			gs-&gt;Team(builder-&gt;team)-&gt;energyPull += energyUseScaled;
+			teamHandler-&gt;Team(builder-&gt;team)-&gt;energyPull += energyUseScaled;
 			return false;
 		}
 
@@ -1895,9 +1895,9 @@
 
 	blockHeightChanges = false;
 	if (unitDef-&gt;isCommander) {
-		gs-&gt;Team(team)-&gt;CommanderDied(this);
+		teamHandler-&gt;Team(team)-&gt;CommanderDied(this);
 	}
-	gs-&gt;Team(this-&gt;lineage)-&gt;LeftLineage(this);
+	teamHandler-&gt;Team(this-&gt;lineage)-&gt;LeftLineage(this);
 
 	if (showDeathSequence &amp;&amp; (!reclaimed &amp;&amp; !beingBuilt)) {
 		string exp;
@@ -1976,8 +1976,8 @@
 		AddMetal(-metal);
 		return true;
 	}
-	gs-&gt;Team(team)-&gt;metalPull += metal;
-	bool canUse = gs-&gt;Team(team)-&gt;UseMetal(metal);
+	teamHandler-&gt;Team(team)-&gt;metalPull += metal;
+	bool canUse = teamHandler-&gt;Team(team)-&gt;UseMetal(metal);
 	if (canUse)
 		metalUseI += metal;
 	return canUse;
@@ -1991,7 +1991,7 @@
 		return;
 	}
 	metalMakeI += metal;
-	gs-&gt;Team(team)-&gt;AddMetal(metal, handicap);
+	teamHandler-&gt;Team(team)-&gt;AddMetal(metal, handicap);
 }
 
 
@@ -2001,8 +2001,8 @@
 		AddEnergy(-energy);
 		return true;
 	}
-	gs-&gt;Team(team)-&gt;energyPull += energy;
-	bool canUse = gs-&gt;Team(team)-&gt;UseEnergy(energy);
+	teamHandler-&gt;Team(team)-&gt;energyPull += energy;
+	bool canUse = teamHandler-&gt;Team(team)-&gt;UseEnergy(energy);
 	if (canUse)
 		energyUseI += energy;
 	return canUse;
@@ -2016,7 +2016,7 @@
 		return;
 	}
 	energyMakeI += energy;
-	gs-&gt;Team(team)-&gt;AddEnergy(energy, handicap);
+	teamHandler-&gt;Team(team)-&gt;AddEnergy(energy, handicap);
 }
 
 
@@ -2219,7 +2219,7 @@
 
 	//FIXME script = SAFE_NEW CUnitScript(this);
 	//FIXME localmodel = modelParser-&gt;CreateLocalModel(model, script-&gt;GetPieces());
-	cob = SAFE_NEW CCobInstance(GCobEngine.GetCobFile(&quot;scripts/&quot; + unitDef-&gt;name+&quot;.cob&quot;), this);
+	cob = SAFE_NEW CCobInstance(GCobEngine.GetCobFile(unitDef-&gt;scriptPath), this);
 	modelParser-&gt;CreateLocalModel(this);
 
 	// Calculate the max() of the available weapon reloadtimes

Modified: branches/caiinterface/rts/Sim/Units/Unit.h
===================================================================
--- branches/caiinterface/rts/Sim/Units/Unit.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Units/Unit.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -10,8 +10,8 @@
 
 #include &quot;Lua/LuaUnitMaterial.h&quot;
 #include &quot;Sim/Objects/SolidObject.h&quot;
-#include &quot;System/Matrix44f.h&quot;
-#include &quot;Game/GlobalConstants.h&quot;
+#include &quot;Matrix44f.h&quot;
+#include &quot;Sim/Misc/GlobalConstants.h&quot;
 #include &quot;Vec2.h&quot;
 
 class CCobInstance;

Modified: branches/caiinterface/rts/Sim/Units/UnitDef.h
===================================================================
--- branches/caiinterface/rts/Sim/Units/UnitDef.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Units/UnitDef.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -197,6 +197,9 @@
 	bool useCSOffset;
 	*/
 
+	std::string scriptName;	// the name of the unit's script, e.g. &quot;armjeth.cob&quot;
+	std::string scriptPath;	// the path of the unit's script, e.g. &quot;scripts/armjeth.cob&quot;
+
 	std::string collisionVolumeType;	// can be &quot;Ell&quot;, &quot;CylT&quot; (where T is one of &quot;XYZ&quot;), or &quot;Box&quot;
 	float3 collisionVolumeScales;		// the collision volume's full axis lengths
 	float3 collisionVolumeOffsets;		// relative to the unit's center position

Modified: branches/caiinterface/rts/Sim/Units/UnitDefHandler.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/UnitDefHandler.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Units/UnitDefHandler.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -13,7 +13,7 @@
 #include &quot;FileSystem/FileHandler.h&quot;
 #include &quot;Game/Game.h&quot;
 #include &quot;Game/GameSetup.h&quot;
-#include &quot;Game/Team.h&quot;
+#include &quot;Sim/Misc/Team.h&quot;
 #include &quot;Lua/LuaParser.h&quot;
 #include &quot;Map/MapInfo.h&quot;
 #include &quot;Map/ReadMap.h&quot;
@@ -22,17 +22,17 @@
 #include &quot;Rendering/IconHandler.h&quot;
 #include &quot;Rendering/Textures/Bitmap.h&quot;
 #include &quot;Rendering/UnitModels/3DModelParser.h&quot;
-#include &quot;Sim/ModInfo.h&quot;
-#include &quot;Sim/SideParser.h&quot;
+#include &quot;Sim/Misc/ModInfo.h&quot;
+#include &quot;Sim/Misc/SideParser.h&quot;
 #include &quot;Sim/Misc/CategoryHandler.h&quot;
 #include &quot;Sim/Misc/CollisionVolume.h&quot;
 #include &quot;Sim/Misc/DamageArrayHandler.h&quot;
 #include &quot;Sim/Projectiles/ExplosionGenerator.h&quot;
-#include &quot;Sim/Units/COB/CobFile.h&quot;
+#include &quot;COB/CobFile.h&quot;
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/Sound.h&quot;
-#include &quot;System/Exceptions.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;Sound.h&quot;
+#include &quot;Exceptions.h&quot;
 
 const char YARDMAP_CHAR = 'c';		//Need to be low case.
 
@@ -684,6 +684,9 @@
 	ud.model.modelpath = &quot;objects3d/&quot; + objectname;
 	ud.model.modelname = objectname;
 
+	ud.scriptName = udTable.GetString(&quot;script&quot;, unitName + &quot;.cob&quot;);
+	ud.scriptPath = &quot;scripts/&quot; + ud.scriptName;
+
 	ud.wreckName = udTable.GetString(&quot;corpse&quot;, &quot;&quot;);
 	ud.deathExplosion = udTable.GetString(&quot;explodeAs&quot;, &quot;&quot;);
 	ud.selfDExplosion = udTable.GetString(&quot;selfDestructAs&quot;, &quot;&quot;);

Modified: branches/caiinterface/rts/Sim/Units/UnitHandler.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/UnitHandler.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Units/UnitHandler.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -4,7 +4,7 @@
 
 #include &quot;StdAfx.h&quot;
 #include &lt;assert.h&gt;
-#include &quot;System/mmgr.h&quot;
+#include &quot;mmgr.h&quot;
 
 #include &quot;UnitHandler.h&quot;
 #include &quot;Unit.h&quot;
@@ -14,7 +14,6 @@
 #include &quot;Game/GameSetup.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
-#include &quot;Game/Team.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Map/MapInfo.h&quot;
 #include &quot;Map/ReadMap.h&quot;
@@ -25,19 +24,20 @@
 #include &quot;Sim/Misc/AirBaseHandler.h&quot;
 #include &quot;Sim/Misc/GroundBlockingObjectMap.h&quot;
 #include &quot;Sim/Misc/QuadField.h&quot;
-#include &quot;Sim/Units/CommandAI/Command.h&quot;
-#include &quot;Sim/Units/Unit.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
-#include &quot;System/FileSystem/FileHandler.h&quot;
-#include &quot;System/LoadSaveInterface.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/TimeProfiler.h&quot;
-#include &quot;System/myMath.h&quot;
-#include &quot;System/Platform/ConfigHandler.h&quot;
-#include &quot;System/Sync/SyncTracer.h&quot;
-#include &quot;System/creg/STL_Deque.h&quot;
-#include &quot;System/creg/STL_List.h&quot;
-#include &quot;System/creg/STL_Set.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
+#include &quot;CommandAI/Command.h&quot;
+#include &quot;Unit.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
+#include &quot;FileSystem/FileHandler.h&quot;
+#include &quot;LoadSaveInterface.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;TimeProfiler.h&quot;
+#include &quot;myMath.h&quot;
+#include &quot;Platform/ConfigHandler.h&quot;
+#include &quot;Sync/SyncTracer.h&quot;
+#include &quot;creg/STL_Deque.h&quot;
+#include &quot;creg/STL_List.h&quot;
+#include &quot;creg/STL_Set.h&quot;
 #include &quot;Rendering/UnitModels/UnitDrawer.h&quot;
 
 using std::min;
@@ -151,8 +151,8 @@
 
 	maxUnits = gameSetup-&gt;maxUnits;
 
-	if (maxUnits &gt; ((MAX_UNITS / gs-&gt;activeTeams) - 5)) {
-		maxUnits = (MAX_UNITS / gs-&gt;activeTeams) -5;
+	if (maxUnits &gt; ((MAX_UNITS / teamHandler-&gt;ActiveTeams()) - 5)) {
+		maxUnits = (MAX_UNITS / teamHandler-&gt;ActiveTeams()) -5;
 	}
 
 	if (gameSetup-&gt;limitDgun) {
@@ -186,7 +186,7 @@
 
 int CUnitHandler::AddUnit(CUnit *unit)
 {
-//	GML_RECMUTEX_LOCK(unit); // AddUnit. Not needed, protected via LoadUnit. 
+//	GML_RECMUTEX_LOCK(unit); // AddUnit. Not needed, protected via LoadUnit.
 
 	ASSERT_SYNCED_MODE;
 	int num = (int)(gs-&gt;randFloat()) * ((int)activeUnits.size() - 1);
@@ -209,7 +209,7 @@
 	freeIDs.resize(freeMax);
 
 	units[unit-&gt;id] = unit;
-	gs-&gt;Team(unit-&gt;team)-&gt;AddUnit(unit, CTeam::AddBuilt);
+	teamHandler-&gt;Team(unit-&gt;team)-&gt;AddUnit(unit, CTeam::AddBuilt);
 	unitsByDefs[unit-&gt;team][unit-&gt;unitDef-&gt;id].insert(unit);
 
 	maxUnitRadius = max(unit-&gt;radius, maxUnitRadius);
@@ -245,7 +245,7 @@
 			activeUnits.erase(usi);
 			units[delUnit-&gt;id] = 0;
 			freeIDs.push_back(delUnit-&gt;id);
-			gs-&gt;Team(delTeam)-&gt;RemoveUnit(delUnit, CTeam::RemoveDied);
+			teamHandler-&gt;Team(delTeam)-&gt;RemoveUnit(delUnit, CTeam::RemoveDied);
 
 			unitsByDefs[delTeam][delType].erase(delUnit);
 
@@ -326,7 +326,7 @@
 
 	if (!(gs-&gt;frameNum &amp; 15)) {
 		if (diminishingMetalMakers)
-			metalMakerEfficiency = 8.0f / (8.0f + max(0.0f, sqrt(metalMakerIncome / gs-&gt;activeTeams) - 4));
+			metalMakerEfficiency = 8.0f / (8.0f + max(0.0f, sqrt(metalMakerIncome / teamHandler-&gt;ActiveTeams()) - 4));
 		metalMakerIncome = 0;
 	}
 }
@@ -705,7 +705,7 @@
 
 bool CUnitHandler::CanBuildUnit(const UnitDef* unitdef, int team)
 {
-	if (gs-&gt;Team(team)-&gt;units.size() &gt;= uh-&gt;maxUnits) {
+	if (teamHandler-&gt;Team(team)-&gt;units.size() &gt;= uh-&gt;maxUnits) {
 		return false;
 	}
 	if (unitsByDefs[team][unitdef-&gt;id].size() &gt;= unitdef-&gt;maxThisUnit) {

Modified: branches/caiinterface/rts/Sim/Units/UnitHandler.h
===================================================================
--- branches/caiinterface/rts/Sim/Units/UnitHandler.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Units/UnitHandler.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -13,7 +13,7 @@
 
 #include &quot;UnitDef.h&quot;
 #include &quot;UnitSet.h&quot;
-#include &quot;Sim/Units/CommandAI/Command.h&quot;
+#include &quot;CommandAI/Command.h&quot;
 
 class CBuilderCAI;
 class CFeature;

Modified: branches/caiinterface/rts/Sim/Units/UnitLoader.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/UnitLoader.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Units/UnitLoader.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -338,8 +338,7 @@
 		unit-&gt;pos.y = ground-&gt;GetHeight2(unit-&gt;pos.x, unit-&gt;pos.z);
 	}
 
-//FIXME: add unitdef tag cob/cobscript/cobfilename
-	unit-&gt;cob = SAFE_NEW CCobInstance(GCobEngine.GetCobFile(&quot;scripts/&quot; + name + &quot;.cob&quot;), unit);
+	unit-&gt;cob = SAFE_NEW CCobInstance(GCobEngine.GetCobFile(ud-&gt;scriptPath), unit);
 	modelParser-&gt;CreateLocalModel(unit);
 
 

Modified: branches/caiinterface/rts/Sim/Units/UnitTracker.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/UnitTracker.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Units/UnitTracker.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -10,7 +10,7 @@
 #include &quot;Game/SelectedUnits.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 #include &quot;LogOutput.h&quot;
 
 

Modified: branches/caiinterface/rts/Sim/Units/UnitTypes/Builder.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/UnitTypes/Builder.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Units/UnitTypes/Builder.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -8,7 +8,6 @@
 #include &quot;Builder.h&quot;
 #include &quot;Building.h&quot;
 #include &quot;Game/GameHelper.h&quot;
-#include &quot;Game/Team.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Lua/LuaRules.h&quot;
 #include &quot;Map/Ground.h&quot;
@@ -18,7 +17,8 @@
 #include &quot;Rendering/UnitModels/3DOParser.h&quot;
 #include &quot;Sim/Features/Feature.h&quot;
 #include &quot;Sim/Features/FeatureHandler.h&quot;
-#include &quot;Sim/ModInfo.h&quot;
+#include &quot;Sim/Misc/ModInfo.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;Sim/Projectiles/Unsynced/GfxProjectile.h&quot;
 #include &quot;Sim/Units/COB/CobInstance.h&quot;
@@ -26,8 +26,8 @@
 #include &quot;Sim/Units/UnitDefHandler.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
 #include &quot;Sim/Units/UnitLoader.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
-#include &quot;System/EventHandler.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
+#include &quot;EventHandler.h&quot;
 #include &quot;Sound.h&quot;
 #include &quot;mmgr.h&quot;
 
@@ -241,7 +241,7 @@
 						float ch  = heightmap[(tz2 + z) * (gs-&gt;mapx + 1) + x];
 						float ch2 = heightmap[(tz2 + 3) * (gs-&gt;mapx + 1) + x];
 						float adjust = ((ch3 * (3 - z) + ch2 * z) / 3 - ch) * terraformScale;
-	
+
 						readmap-&gt;AddHeight((tz2 + z) * (gs-&gt;mapx + 1) + x, adjust);
 					}
 				}
@@ -350,7 +350,7 @@
 				const float energyUseScaled = curCapture-&gt;energyCost * captureFraction * modInfo.captureEnergyCostFactor;
 
 				if (!UseEnergy(energyUseScaled)) {
-					gs-&gt;Team(team)-&gt;energyPull += energyUseScaled;
+					teamHandler-&gt;Team(team)-&gt;energyPull += energyUseScaled;
 				} else {
 					curCapture-&gt;captureProgress = captureProgressTemp;
 					CreateNanoParticle(curCapture-&gt;midPos,curCapture-&gt;radius*0.7f,false);
@@ -367,7 +367,7 @@
 							// capture succesful
 							int oldLineage = curCapture-&gt;lineage;
 							curCapture-&gt;lineage = this-&gt;lineage;
-							gs-&gt;Team(oldLineage)-&gt;LeftLineage(curCapture);
+							teamHandler-&gt;Team(oldLineage)-&gt;LeftLineage(curCapture);
 						}
 						curCapture-&gt;captureProgress=0.0f;
 						StopBuild(true);
@@ -725,7 +725,7 @@
 		float3 color = unitDef-&gt;nanoColor;
 
 		if (gu-&gt;teamNanospray) {
-			unsigned char* tcol = gs-&gt;Team(team)-&gt;color;
+			unsigned char* tcol = teamHandler-&gt;Team(team)-&gt;color;
 			color = float3(tcol[0] * (1.f / 255.f), tcol[1] * (1.f / 255.f), tcol[2] * (1.f / 255.f));
 		}
 

Modified: branches/caiinterface/rts/Sim/Units/UnitTypes/Building.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/UnitTypes/Building.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Units/UnitTypes/Building.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -14,7 +14,7 @@
 #include &quot;Rendering/GroundDecalHandler.h&quot;
 #include &quot;Game/GameSetup.h&quot;
 #include &quot;Rendering/UnitModels/UnitDrawer.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 #include &quot;mmgr.h&quot;
 

Modified: branches/caiinterface/rts/Sim/Units/UnitTypes/ExtractorBuilding.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/UnitTypes/ExtractorBuilding.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Units/UnitTypes/ExtractorBuilding.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -18,7 +18,7 @@
 #include &quot;Sim/Misc/QuadField.h&quot;
 #include &quot;Sync/SyncTracer.h&quot;
 #include &quot;creg/STL_List.h&quot;
-#include &quot;System/myMath.h&quot;
+#include &quot;myMath.h&quot;
 #include &quot;mmgr.h&quot;
 
 CR_BIND_DERIVED(CExtractorBuilding, CBuilding, );

Modified: branches/caiinterface/rts/Sim/Units/UnitTypes/Factory.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/UnitTypes/Factory.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Units/UnitTypes/Factory.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -4,10 +4,8 @@
 //////////////////////////////////////////////////////////////////////
 
 #include &quot;Factory.h&quot;
-#include &quot;Game/Team.h&quot;
 #include &quot;Game/Camera.h&quot;
 #include &quot;Game/GameHelper.h&quot;
-#include &quot;Game/Team.h&quot;
 #include &quot;Game/WaitCommandsAI.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Map/ReadMap.h&quot;
@@ -15,6 +13,7 @@
 #include &quot;Rendering/UnitModels/3DOParser.h&quot;
 #include &quot;Sim/Misc/GroundBlockingObjectMap.h&quot;
 #include &quot;Sim/Misc/QuadField.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;Sim/Projectiles/Unsynced/GfxProjectile.h&quot;
 #include &quot;Sim/Units/COB/CobFile.h&quot;
@@ -25,8 +24,8 @@
 #include &quot;Sim/Units/UnitHandler.h&quot;
 #include &quot;Sim/Units/UnitLoader.h&quot;
 #include &quot;Sync/SyncTracer.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
-#include &quot;System/EventHandler.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
+#include &quot;EventHandler.h&quot;
 #include &quot;Sound.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Matrix44f.h&quot;
@@ -355,7 +354,7 @@
 			float3 color = unitDef-&gt;nanoColor;
 
 			if (gu-&gt;teamNanospray) {
-				unsigned char* tcol = gs-&gt;Team(team)-&gt;color;
+				unsigned char* tcol = teamHandler-&gt;Team(team)-&gt;color;
 				color = float3(tcol[0] * (1.0f / 255.0f), tcol[1] * (1.0f / 255.0f), tcol[2] * (1.0f / 255.0f));
 			}
 

Modified: branches/caiinterface/rts/Sim/Units/UnitTypes/TransportUnit.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/UnitTypes/TransportUnit.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Units/UnitTypes/TransportUnit.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -8,7 +8,8 @@
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;Sim/Misc/DamageArray.h&quot;
 #include &quot;Sim/Misc/LosHandler.h&quot;
-#include &quot;System/EventHandler.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
+#include &quot;EventHandler.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;creg/STL_List.h&quot;
 #include &quot;mmgr.h&quot;
@@ -147,7 +148,7 @@
 		return false;
 	}
 
-	if (!unit-&gt;unitDef-&gt;transportByEnemy &amp;&amp; !gs-&gt;AlliedTeams(unit-&gt;team, team)) {
+	if (!unit-&gt;unitDef-&gt;transportByEnemy &amp;&amp; !teamHandler-&gt;AlliedTeams(unit-&gt;team, team)) {
 		return false;
 	}
 

Modified: branches/caiinterface/rts/Sim/Weapons/BeamLaser.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Weapons/BeamLaser.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Weapons/BeamLaser.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,7 +1,7 @@
 #include &quot;StdAfx.h&quot;
 #include &quot;BeamLaser.h&quot;
 #include &quot;Game/GameHelper.h&quot;
-#include &quot;Game/Team.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Matrix44f.h&quot;
@@ -15,7 +15,7 @@
 #include &quot;Sim/Units/COB/CobInstance.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitTypes/Building.h&quot;
-#include &quot;Sim/Weapons/PlasmaRepulser.h&quot;
+#include &quot;PlasmaRepulser.h&quot;
 #include &quot;Sound.h&quot;
 #include &quot;WeaponDefHandler.h&quot;
 #include &quot;mmgr.h&quot;
@@ -61,7 +61,7 @@
 
 	if(lastFireFrame &gt; gs-&gt;frameNum - 18 &amp;&amp; lastFireFrame != gs-&gt;frameNum  &amp;&amp; weaponDef-&gt;sweepFire)
 	{
-		if (gs-&gt;Team(owner-&gt;team)-&gt;metal&gt;=metalFireCost &amp;&amp; gs-&gt;Team(owner-&gt;team)-&gt;energy&gt;=energyFireCost)
+		if (teamHandler-&gt;Team(owner-&gt;team)-&gt;metal&gt;=metalFireCost &amp;&amp; teamHandler-&gt;Team(owner-&gt;team)-&gt;energy&gt;=energyFireCost)
 		{
 			owner-&gt;UseEnergy(energyFireCost / salvoSize);
 			owner-&gt;UseMetal(metalFireCost / salvoSize);

Modified: branches/caiinterface/rts/Sim/Weapons/DGunWeapon.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Weapons/DGunWeapon.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Weapons/DGunWeapon.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,13 +1,13 @@
 #include &quot;StdAfx.h&quot;
 #include &quot;DGunWeapon.h&quot;
-#include &quot;Game/GlobalSynced.h&quot;
-#include &quot;Game/Team.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Projectiles/WeaponProjectiles/FireBallProjectile.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
 #include &quot;Sound.h&quot;
 #include &quot;WeaponDefHandler.h&quot;
-#include &quot;System/myMath.h&quot;
+#include &quot;myMath.h&quot;
 #include &quot;mmgr.h&quot;
 
 CR_BIND_DERIVED(CDGunWeapon, CWeapon, (NULL));
@@ -41,7 +41,7 @@
 
 void CDGunWeapon::Fire(void)
 {
-	if(uh-&gt;limitDgun &amp;&amp; owner-&gt;unitDef-&gt;isCommander &amp;&amp; owner-&gt;pos.SqDistance(gs-&gt;Team(owner-&gt;team)-&gt;startPos)&gt;Square(uh-&gt;dgunRadius)){
+	if(uh-&gt;limitDgun &amp;&amp; owner-&gt;unitDef-&gt;isCommander &amp;&amp; owner-&gt;pos.SqDistance(teamHandler-&gt;Team(owner-&gt;team)-&gt;startPos)&gt;Square(uh-&gt;dgunRadius)){
 		return;		//prevents dgunning using fps view if outside dgunlimit
 	}
 

Modified: branches/caiinterface/rts/Sim/Weapons/EmgCannon.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Weapons/EmgCannon.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Weapons/EmgCannon.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,7 +1,7 @@
 #include &quot;StdAfx.h&quot;
 #include &quot;EmgCannon.h&quot;
 #include &quot;Game/GameHelper.h&quot;
-#include &quot;Game/Team.h&quot;
+#include &quot;Sim/Misc/Team.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Sim/MoveTypes/AirMoveType.h&quot;
 #include &quot;Sim/Projectiles/WeaponProjectiles/EmgProjectile.h&quot;

Modified: branches/caiinterface/rts/Sim/Weapons/MeleeWeapon.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Weapons/MeleeWeapon.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Weapons/MeleeWeapon.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -6,7 +6,7 @@
 #include &quot;MeleeWeapon.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sound.h&quot;
-#include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
+#include &quot;WeaponDefHandler.h&quot;
 #include &quot;mmgr.h&quot;
 
 CR_BIND_DERIVED(CMeleeWeapon, CWeapon, (NULL));

Modified: branches/caiinterface/rts/Sim/Weapons/PlasmaRepulser.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Weapons/PlasmaRepulser.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Weapons/PlasmaRepulser.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,8 +1,8 @@
 #include &quot;StdAfx.h&quot;
 #include &quot;creg/STL_List.h&quot;
 #include &quot;creg/STL_Set.h&quot;
-#include &quot;Game/GlobalSynced.h&quot;
-#include &quot;Game/Team.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;PlasmaRepulser.h&quot;
 #include &quot;Rendering/UnitModels/3DOParser.h&quot;
@@ -17,7 +17,7 @@
 #include &quot;WeaponDefHandler.h&quot;
 #include &quot;Weapon.h&quot;
 #include &quot;mmgr.h&quot;
-#include &quot;System/myMath.h&quot;
+#include &quot;myMath.h&quot;
 
 CR_BIND_DERIVED(CPlasmaRepulser, CWeapon, (NULL));
 
@@ -88,7 +88,7 @@
 	const int defRechargeDelay = weaponDef-&gt;shieldRechargeDelay;
 
 	rechargeDelay -= (rechargeDelay &gt; 0) ? 1 : 0;
-	
+
 	if (startShowingShield) {
 		// one-time iteration when shield first goes online
 		// (adds the projectile parts, this assumes owner is
@@ -153,7 +153,7 @@
 		for (std::list&lt;CWeaponProjectile*&gt;::iterator pi=incoming.begin();pi!=incoming.end();++pi) {
 			const float3 dif = (*pi)-&gt;pos-owner-&gt;pos;
 			if ((*pi)-&gt;checkCol &amp;&amp; dif.SqLength()&lt;sqRadius &amp;&amp; curPower &gt; (*pi)-&gt;weaponDef-&gt;damages[0]) {
-				if (gs-&gt;Team(owner-&gt;team)-&gt;energy &gt; weaponDef-&gt;shieldEnergyUse) {
+				if (teamHandler-&gt;Team(owner-&gt;team)-&gt;energy &gt; weaponDef-&gt;shieldEnergyUse) {
 					rechargeDelay = defRechargeDelay;
 					if (weaponDef-&gt;shieldRepulser) {
 						// bounce the projectile
@@ -215,12 +215,12 @@
 					if(weaponDef-&gt;shieldRepulser) {	//bounce the projectile
 						int type=(*pi)-&gt;ShieldRepulse(this,weaponPos,weaponDef-&gt;shieldForce,weaponDef-&gt;shieldMaxSpeed);
 						if (type==1){
-							gs-&gt;Team(owner-&gt;team)-&gt;energyPullAmount += weaponDef-&gt;shieldEnergyUse;
+							teamHandler-&gt;Team(owner-&gt;team)-&gt;energyPullAmount += weaponDef-&gt;shieldEnergyUse;
 						} else {
-							gs-&gt;Team(owner-&gt;team)-&gt;energyPullAmount += weaponDef-&gt;shieldEnergyUse/30.0f;
+							teamHandler-&gt;Team(owner-&gt;team)-&gt;energyPullAmount += weaponDef-&gt;shieldEnergyUse/30.0f;
 						}
 					} else {						//kill the projectile
-						gs-&gt;Team(owner-&gt;team)-&gt;energyPullAmount += weaponDef-&gt;shieldEnergyUse;
+						teamHandler-&gt;Team(owner-&gt;team)-&gt;energyPullAmount += weaponDef-&gt;shieldEnergyUse;
 					}*/
 				}
 			}
@@ -247,7 +247,7 @@
 
 void CPlasmaRepulser::NewProjectile(CWeaponProjectile* p)
 {
-	if (weaponDef-&gt;smartShield &amp;&amp; gs-&gt;AlliedTeams(p-&gt;owner-&gt;team, owner-&gt;team)) {
+	if (weaponDef-&gt;smartShield &amp;&amp; teamHandler-&gt;AlliedTeams(p-&gt;owner-&gt;team, owner-&gt;team)) {
 		return;
 	}
 
@@ -286,7 +286,7 @@
 	if (emitter-&gt;weaponDef-&gt;damages[0] &gt; curPower) {
 		return -1;
 	}
-	if (weaponDef-&gt;smartShield &amp;&amp; gs-&gt;AlliedTeams(emitter-&gt;owner-&gt;team,owner-&gt;team)) {
+	if (weaponDef-&gt;smartShield &amp;&amp; teamHandler-&gt;AlliedTeams(emitter-&gt;owner-&gt;team,owner-&gt;team)) {
 		return -1;
 	}
 

Modified: branches/caiinterface/rts/Sim/Weapons/Rifle.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Weapons/Rifle.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Weapons/Rifle.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -12,7 +12,7 @@
 #include &quot;Sim/Projectiles/Unsynced/SmokeProjectile.h&quot;
 #include &quot;Sim/Projectiles/Unsynced/TracerProjectile.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
-#include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
+#include &quot;WeaponDefHandler.h&quot;
 #include &quot;Sound.h&quot;
 #include &quot;Sync/SyncTracer.h&quot;
 #include &quot;mmgr.h&quot;

Modified: branches/caiinterface/rts/Sim/Weapons/Weapon.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Weapons/Weapon.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Weapons/Weapon.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -8,7 +8,6 @@
 #include &quot;Game/Camera.h&quot;
 #include &quot;Game/GameHelper.h&quot;
 #include &quot;Game/Player.h&quot;
-#include &quot;Game/Team.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;myMath.h&quot;
@@ -16,7 +15,8 @@
 #include &quot;Sim/Misc/GeometricObjects.h&quot;
 #include &quot;Sim/Misc/InterceptHandler.h&quot;
 #include &quot;Sim/Misc/LosHandler.h&quot;
-#include &quot;Sim/ModInfo.h&quot;
+#include &quot;Sim/Misc/ModInfo.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/MoveTypes/TAAirMoveType.h&quot;
 #include &quot;Sim/Projectiles/WeaponProjectiles/WeaponProjectile.h&quot;
 #include &quot;Sim/Units/COB/CobFile.h&quot;
@@ -24,7 +24,7 @@
 #include &quot;Sim/Units/CommandAI/CommandAI.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sync/SyncTracer.h&quot;
-#include &quot;System/EventHandler.h&quot;
+#include &quot;EventHandler.h&quot;
 #include &quot;WeaponDefHandler.h&quot;
 #include &quot;Weapon.h&quot;
 #include &quot;mmgr.h&quot;
@@ -305,14 +305,14 @@
 	}
 	if(weaponDef-&gt;stockpile &amp;&amp; numStockpileQued){
 		float p=1.0f/stockpileTime;
-		if(gs-&gt;Team(owner-&gt;team)-&gt;metal&gt;=metalFireCost*p &amp;&amp; gs-&gt;Team(owner-&gt;team)-&gt;energy&gt;=energyFireCost*p){
+		if(teamHandler-&gt;Team(owner-&gt;team)-&gt;metal&gt;=metalFireCost*p &amp;&amp; teamHandler-&gt;Team(owner-&gt;team)-&gt;energy&gt;=energyFireCost*p){
 			owner-&gt;UseEnergy(energyFireCost*p);
 			owner-&gt;UseMetal(metalFireCost*p);
 			buildPercent+=p;
 		} else {
 			// update the energy and metal required counts
-			gs-&gt;Team(owner-&gt;team)-&gt;energyPull += energyFireCost*p;
-			gs-&gt;Team(owner-&gt;team)-&gt;metalPull += metalFireCost*p;
+			teamHandler-&gt;Team(owner-&gt;team)-&gt;energyPull += energyFireCost*p;
+			teamHandler-&gt;Team(owner-&gt;team)-&gt;metalPull += metalFireCost*p;
 		}
 		if(buildPercent&gt;=1){
 			const int oldCount = numStockpiled;
@@ -339,8 +339,8 @@
 	   )
 	{
 		if ((weaponDef-&gt;stockpile ||
-		     (gs-&gt;Team(owner-&gt;team)-&gt;metal &gt;= metalFireCost &amp;&amp;
-		      gs-&gt;Team(owner-&gt;team)-&gt;energy &gt;= energyFireCost)))
+		     (teamHandler-&gt;Team(owner-&gt;team)-&gt;metal &gt;= metalFireCost &amp;&amp;
+		      teamHandler-&gt;Team(owner-&gt;team)-&gt;energy &gt;= energyFireCost)))
 		{
 			std::vector&lt;int&gt; args;
 			args.push_back(0);
@@ -384,8 +384,8 @@
 				// update the energy and metal required counts
 				const int minPeriod = std::max(1, (int)(reloadTime / owner-&gt;reloadSpeed));
 				const float averageFactor = 1.0f / (float)minPeriod;
-				gs-&gt;Team(owner-&gt;team)-&gt;energyPull += averageFactor * energyFireCost;
-				gs-&gt;Team(owner-&gt;team)-&gt;metalPull += averageFactor * metalFireCost;
+				teamHandler-&gt;Team(owner-&gt;team)-&gt;energyPull += averageFactor * energyFireCost;
+				teamHandler-&gt;Team(owner-&gt;team)-&gt;metalPull += averageFactor * metalFireCost;
 			}
 		}
 	}
@@ -556,7 +556,7 @@
 	if (haveUserTarget)          { return false; }
 
 	if (targetType == Target_None) { return true; }
-	
+
 	if (avoidTarget)             { return true; }
 
 	if (targetType == Target_Unit) {
@@ -829,7 +829,7 @@
 	weaponPos=owner-&gt;pos+owner-&gt;frontdir*relWeaponPos.z+owner-&gt;updir*relWeaponPos.y+owner-&gt;rightdir*relWeaponPos.x;
 	weaponMuzzlePos=owner-&gt;pos+owner-&gt;frontdir*relWeaponMuzzlePos.z+owner-&gt;updir*relWeaponMuzzlePos.y+owner-&gt;rightdir*relWeaponMuzzlePos.x;
 	return val;
-	
+
 }
 
 void CWeapon::Init(void)

Modified: branches/caiinterface/rts/Sim/Weapons/WeaponDefHandler.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Weapons/WeaponDefHandler.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Weapons/WeaponDefHandler.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -4,7 +4,7 @@
 #include &lt;iostream&gt;
 #include &lt;stdexcept&gt;
 #include &quot;WeaponDefHandler.h&quot;
-#include &quot;Game/GlobalConstants.h&quot;
+#include &quot;Sim/Misc/GlobalConstants.h&quot;
 #include &quot;Game/Game.h&quot;
 #include &quot;Lua/LuaParser.h&quot;
 #include &quot;FileSystem/FileHandler.h&quot;
@@ -16,11 +16,11 @@
 #include &quot;Sim/Projectiles/ExplosionGenerator.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;Sim/Projectiles/Projectile.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/Sound.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;Sound.h&quot;
 #include &quot;mmgr.h&quot;
-#include &quot;System/Util.h&quot;
-#include &quot;System/Exceptions.h&quot;
+#include &quot;Util.h&quot;
+#include &quot;Exceptions.h&quot;
 
 using std::min;
 using std::max;

Modified: branches/caiinterface/rts/Sim/Weapons/bombdropper.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Weapons/bombdropper.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/Sim/Weapons/bombdropper.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -5,8 +5,8 @@
 #include &quot;StdAfx.h&quot;
 #include &quot;bombdropper.h&quot;
 #include &quot;Game/GameHelper.h&quot;
-#include &quot;Game/GlobalSynced.h&quot;
-#include &quot;Game/Team.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/Team.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Map/MapInfo.h&quot;
 #include &quot;Sim/MoveTypes/TAAirMoveType.h&quot;
@@ -16,7 +16,7 @@
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sound.h&quot;
 #include &quot;WeaponDefHandler.h&quot;
-#include &quot;System/myMath.h&quot;
+#include &quot;myMath.h&quot;
 #include &quot;mmgr.h&quot;
 
 CR_BIND_DERIVED(CBombDropper, CWeapon, (NULL, false));

Modified: branches/caiinterface/rts/System/DemoReader.cpp
===================================================================
--- branches/caiinterface/rts/System/DemoReader.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/DemoReader.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -46,7 +46,7 @@
 		// debugging SVN demos impossible (because VERSION_STRING is different
 		// each build.)
 #ifndef _DEBUG
-		|| strcmp(fileHeader.versionString, VERSION_STRING)
+		|| strcmp(fileHeader.versionString, SpringVersion::Get().c_str())
 #endif
 	) {
 		delete playbackDemo;

Modified: branches/caiinterface/rts/System/DemoRecorder.cpp
===================================================================
--- branches/caiinterface/rts/System/DemoRecorder.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/DemoRecorder.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -8,12 +8,13 @@
 #include &quot;mmgr.h&quot;
 
 #include &quot;Sync/Syncify.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;FileSystem/FileHandler.h&quot;
 #include &quot;Game/GameVersion.h&quot;
 #include &quot;Game/GameSetup.h&quot;
-#include &quot;System/Util.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;Exceptions.h&quot;
+#include &quot;Util.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 
 #include &quot;LogOutput.h&quot;
 
@@ -39,7 +40,7 @@
 	strcpy(fileHeader.magic, DEMOFILE_MAGIC);
 	fileHeader.version = DEMOFILE_VERSION;
 	fileHeader.headerSize = sizeof(DemoFileHeader);
-	strcpy(fileHeader.versionString, VERSION_STRING);
+	strcpy(fileHeader.versionString, SpringVersion::Get().c_str());
 
 	__time64_t currtime;
 	_time64(&amp;currtime);
@@ -105,11 +106,17 @@
 	_time64(&amp;long_time);                /* Get time as long integer. */
 	newtime = _localtime64(&amp;long_time); /* Convert to local time. */
 
+	// Don't see how this can happen (according to docs _localtime64 only returns
+	// NULL if long_time is before 1/1/1970...) but a user's stacktrace indicated
+	// NULL newtime in the snprintf line...
+	if (!newtime)
+		throw content_error(&quot;error: _localtime64 returned NULL&quot;);
+
 	char buf[1000];
 	SNPRINTF(buf, sizeof(buf), &quot;%04i%02i%02i_%02i%02i%02i&quot;, newtime-&gt;tm_year+1900, newtime-&gt;tm_mon + 1, newtime-&gt;tm_mday,
         newtime-&gt;tm_hour, newtime-&gt;tm_min, newtime-&gt;tm_sec);
 	std::string name = std::string(buf) + &quot;_&quot; + mapname.substr(0, mapname.find_first_of(&quot;.&quot;));
-	name += std::string(&quot;_&quot;) + VERSION_STRING_DETAILED;
+	name += std::string(&quot;_&quot;) + SpringVersion::Get();
 	// games without gameSetup should have different names
 	if (!gameSetup) {
 	    name = &quot;local_&quot; + name;

Modified: branches/caiinterface/rts/System/DemoRecorder.h
===================================================================
--- branches/caiinterface/rts/System/DemoRecorder.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/DemoRecorder.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -6,7 +6,7 @@
 
 #include &quot;Demo.h&quot;
 #include &quot;Game/Player.h&quot;
-#include &quot;Game/Team.h&quot;
+#include &quot;Sim/Misc/Team.h&quot;
 
 /**
 @brief Used to record demos

Modified: branches/caiinterface/rts/System/FileSystem/ArchiveDir.cpp
===================================================================
--- branches/caiinterface/rts/System/FileSystem/ArchiveDir.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/FileSystem/ArchiveDir.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -4,7 +4,7 @@
 #include &quot;ArchiveDir.h&quot;
 #include &lt;assert.h&gt;
 #include &lt;stdexcept&gt;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;Util.h&quot;
 #include &quot;mmgr.h&quot;
 

Modified: branches/caiinterface/rts/System/FileSystem/ArchiveFactory.cpp
===================================================================
--- branches/caiinterface/rts/System/FileSystem/ArchiveFactory.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/FileSystem/ArchiveFactory.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -7,7 +7,7 @@
 #include &quot;ArchiveHPI.h&quot;
 #include &quot;ArchiveZip.h&quot;
 #include &quot;Archive7Zip.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem.h&quot;
 
 #include &quot;Util.h&quot;
 

Modified: branches/caiinterface/rts/System/FileSystem/ArchiveScanner.cpp
===================================================================
--- branches/caiinterface/rts/System/FileSystem/ArchiveScanner.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/FileSystem/ArchiveScanner.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -11,13 +11,13 @@
 #include &quot;ArchiveScanner.h&quot;
 
 #include &quot;Lua/LuaParser.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/FileSystem/ArchiveFactory.h&quot;
-#include &quot;System/FileSystem/ArchiveBuffered.h&quot;
-#include &quot;System/FileSystem/CRC.h&quot;
-#include &quot;System/FileSystem/FileFilter.h&quot;
-#include &quot;System/FileSystem/FileHandler.h&quot;
-#include &quot;System/Platform/FileSystem.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;ArchiveFactory.h&quot;
+#include &quot;ArchiveBuffered.h&quot;
+#include &quot;CRC.h&quot;
+#include &quot;FileFilter.h&quot;
+#include &quot;FileHandler.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;Util.h&quot;
 #include &quot;Exceptions.h&quot;
 

Copied: branches/caiinterface/rts/System/FileSystem/DataDirLocater.cpp (from rev 7023, trunk/rts/System/FileSystem/DataDirLocater.cpp)
===================================================================
--- branches/caiinterface/rts/System/FileSystem/DataDirLocater.cpp	                        (rev 0)
+++ branches/caiinterface/rts/System/FileSystem/DataDirLocater.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -0,0 +1,369 @@
+/**
+ * @file DataDirLocater.cpp
+ * @author Tobi Vollebregt
+ *
+ * Copyright (C) 2006-2008 Tobi Vollebregt
+ * Licensed under the terms of the GNU GPL, v2 or later
+ */
+
+#include &quot;StdAfx.h&quot;
+#include &quot;DataDirLocater.h&quot;
+
+#include &lt;cstdlib&gt;
+#ifdef WIN32
+	#include &lt;io.h&gt;
+  #include &lt;direct.h&gt;
+  #include &lt;windows.h&gt;
+	#include &lt;shlobj.h&gt;
+	#include &lt;shlwapi.h&gt;
+	#ifndef SHGFP_TYPE_CURRENT
+		#define SHGFP_TYPE_CURRENT 0
+	#endif
+#endif
+#include &lt;sstream&gt;
+#include &lt;string.h&gt;
+#include &quot;FileSystem/VFSHandler.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;Platform/ConfigHandler.h&quot;
+#include &quot;FileSystem.h&quot;
+#include &quot;mmgr.h&quot;
+#include &quot;Exceptions.h&quot;
+
+/**
+ * @brief construct a data directory object
+ *
+ * Appends a slash to the end of the path if there isn't one already.
+ */
+DataDir::DataDir(const std::string&amp; p) : path(p), writable(false)
+{
+#ifndef _WIN32
+	if (path.empty())
+		path = &quot;./&quot;;
+	if (path[path.size() - 1] != '/')
+		path += '/';
+#else
+	if (path.empty())
+		path = &quot;.\\&quot;;
+	if (path[path.size() - 1] != '\\')
+		path += '\\';
+#endif
+}
+
+/**
+ * @brief construct a data directory locater
+ *
+ * Does not locate data directories, use LocateDataDirs() for that.
+ */
+DataDirLocater::DataDirLocater() : writedir(NULL)
+{
+}
+
+/**
+ * @brief substitute environment variables with their values
+ */
+std::string DataDirLocater::SubstEnvVars(const std::string&amp; in) const
+{
+	bool escape = false;
+	std::ostringstream out;
+	for (std::string::const_iterator ch = in.begin(); ch != in.end(); ++ch) {
+		if (escape) {
+			escape = false;
+			out &lt;&lt; *ch;
+		} else {
+			switch (*ch) {
+#ifndef _WIN32
+				case '\\': {
+					escape = true;
+					break;
+				}
+#endif
+				case '$': {
+					std::ostringstream envvar;
+					for (++ch; ch != in.end() &amp;&amp; (isalnum(*ch) || *ch == '_'); ++ch)
+						envvar &lt;&lt; *ch;
+					--ch;
+					char* subst = getenv(envvar.str().c_str());
+					if (subst &amp;&amp; *subst)
+						out &lt;&lt; subst;
+					break;
+				}
+				default: {
+					out &lt;&lt; *ch;
+					break;
+				}
+			}
+		}
+	}
+	return out.str();
+}
+
+/**
+ * @brief Adds the directories in the colon separated string to the datadir handler.
+ */
+void DataDirLocater::AddDirs(const std::string&amp; in)
+{
+	size_t prev_colon = 0, colon;
+#ifndef _WIN32
+	while ((colon = in.find(':', prev_colon)) != std::string::npos) {
+#else
+	while ((colon = in.find(';', prev_colon)) != std::string::npos) {
+#endif
+		datadirs.push_back(in.substr(prev_colon, colon - prev_colon));
+#ifdef DEBUG
+		logOutput.Print(&quot;Adding %s to directories&quot; , in.substr(prev_colon, colon - prev_colon).c_str());
+#endif
+		prev_colon = colon + 1;
+	}
+#ifdef DEBUG
+	logOutput.Print(&quot;Adding %s to directories&quot; , in.substr(prev_colon).c_str());
+#endif
+	datadirs.push_back(in.substr(prev_colon));
+}
+
+/**
+ * @brief Figure out permissions we have for a single data directory d.
+ * @returns whether we have permissions to read the data directory.
+ */
+bool DataDirLocater::DeterminePermissions(DataDir* d)
+{
+#ifndef _WIN32
+	if (d-&gt;path.c_str()[0] != '/' || d-&gt;path.find(&quot;..&quot;) != std::string::npos)
+#else
+	if (d-&gt;path.find(&quot;..&quot;) != std::string::npos)
+#endif
+		throw content_error(&quot;specify data directories using absolute paths please&quot;);
+	// Figure out whether we have read/write permissions
+	// First check read access, if we got that check write access too
+	// (no support for write-only directories)
+	// Note: we check for executable bit otherwise we can't browse the directory
+	// Note: we fail to test whether the path actually is a directory
+	// Note: modifying permissions while or after this function runs has undefined behaviour
+#ifndef _WIN32
+	if (access(d-&gt;path.c_str(), R_OK | X_OK | F_OK) == 0) {
+		// Note: disallow multiple write directories.
+		// There isn't really a use for it as every thing is written to the first one anyway,
+		// and it may give funny effects on errors, e.g. it probably only gives funny things
+		// like network mounted datadir lost connection and suddenly files end up in some
+		// other random writedir you didn't even remember you had added it.
+		if (!writedir &amp;&amp; access(d-&gt;path.c_str(), W_OK) == 0) {
+#else
+	if (_access(d-&gt;path.c_str(), 4) == 0) {
+		if (!writedir &amp;&amp; _access(d-&gt;path.c_str(), 2) == 0) {
+#endif
+			d-&gt;writable = true;
+			writedir = &amp;*d;
+		}
+		return true;
+	} else {
+		if (filesystem.CreateDirectory(d-&gt;path)) {
+			// it didn't exist before, now it does and we just created it with rw access,
+			// so we just assume we still have read-write acces...
+			if (!writedir) {
+				d-&gt;writable = true;
+				writedir = d;
+			}
+			return true;
+		}
+	}
+	return false;
+}
+
+/**
+ * @brief Figure out permissions we have for the data directories.
+ */
+void DataDirLocater::DeterminePermissions()
+{
+	std::vector&lt;DataDir&gt; newDatadirs;
+	std::string previous; // used to filter out consecutive duplicates
+	// (I didn't bother filtering out non-consecutive duplicates because then
+	//  there is the question which of the multiple instances to purge.)
+
+	writedir = NULL;
+
+	for (std::vector&lt;DataDir&gt;::iterator d = datadirs.begin(); d != datadirs.end(); ++d) {
+		if (d-&gt;path != previous &amp;&amp; DeterminePermissions(&amp;*d)) {
+			newDatadirs.push_back(*d);
+			previous = d-&gt;path;
+		}
+	}
+
+	datadirs = newDatadirs;
+}
+
+/**
+ * @brief locate spring data directory
+ *
+ * On *nix platforms, attempts to locate
+ * and change to the spring data directory
+ *
+ * In Unixes, the data directory to chdir to is determined by the following, in this
+ * order (first items override lower items):
+ *
+ * - 'SPRING_DATADIR' environment variable. (colon separated list, like PATH)
+ * - 'SpringData=/path/to/data' declaration in '~/.springrc'. (colon separated list)
+ * - &quot;$HOME/.spring&quot;
+ * - In the same order any line in '/etc/spring/datadir', if that file exists.
+ * - 'datadir=/path/to/data' option passed to 'scons configure'.
+ * - 'prefix=/install/path' option passed to scons configure. The datadir is
+ *   assumed to be at '$prefix/games/spring' in this case.
+ * - the default datadirs in the default prefix, ie. '/usr/local/games/spring'
+ *   (This is set by the build system, ie. SPRING_DATADIR and SPRING_DATADIR_2
+ *   preprocessor definitions.)
+ *
+ * In Windows, its:
+ * - SPRING_DATADIR env-variable
+ * - user configurable (SpringData in registry)
+ * - location of the binary dir (like it has been until 0.76b1)
+ * - the Users 'Documents'-directory (in subdirectory Spring), unless spring is configured to use another
+ * - all users app-data (in subdirectory Spring)
+ * - compiler flags SPRING_DATADIR and SPRING_DATADIR_2
+ *
+ * All of the above methods support environment variable substitution, eg.
+ * '$HOME/myspringdatadir' will be converted by spring to something like
+ * '/home/username/myspringdatadir'.
+ *
+ * If it fails to chdir to the above specified directory spring will asume the
+ * current working directory is the data directory.
+ */
+void DataDirLocater::LocateDataDirs()
+{
+	// Construct the list of datadirs from various sources.
+	datadirs.clear();
+
+	// environment variable
+	char* env = getenv(&quot;SPRING_DATADIR&quot;);
+	if (env &amp;&amp; *env)
+		AddDirs(SubstEnvVars(env));
+
+	// user defined (in spring config handler (Linux: ~/.springrc, Windows: registry))
+	std::string userDef = configHandler.GetString(&quot;SpringData&quot;, &quot;&quot;);
+	if (!userDef.empty()) {
+		AddDirs(SubstEnvVars(userDef));
+	}
+
+#ifdef WIN32
+	TCHAR currentDir[MAX_PATH];
+	::GetCurrentDirectory(sizeof(currentDir) - 1, currentDir);
+	std::string curPath = currentDir;
+	AddDirs(std::string(currentDir));
+
+	// my documents
+	TCHAR strPath[MAX_PATH];
+	SHGetFolderPath( NULL, CSIDL_PERSONAL, NULL, SHGFP_TYPE_CURRENT, strPath);
+	std::string cfg = strPath;
+	cfg += &quot;\\Spring&quot;; // e.g. F:\Dokumente und Einstellungen\Karl-Robert\Eigene Dateien\Spring
+	AddDirs(cfg);
+	cfg.clear();
+
+	// appdata
+	SHGetFolderPath( NULL, CSIDL_COMMON_APPDATA, NULL, SHGFP_TYPE_CURRENT, strPath);
+	cfg = strPath;
+	cfg += &quot;\\Spring&quot;; // e.g. F:\Dokumente und Einstellungen\All Users\Anwendungsdaten\Spring
+	AddDirs(cfg);
+#elif defined(__APPLE__)
+	// copied from old MacFileSystemHandler, won't compile here, but would not compile in its old location either
+	// needs fixing for new DataDirLocater-structure
+	// Get the path to the application bundle we are running:
+	char cPath[1024];
+	CFBundleRef mainBundle = CFBundleGetMainBundle();
+	if(!mainBundle)
+		throw content_error(&quot;Could not determine bundle path&quot;);
+
+	CFURLRef mainBundleURL = CFBundleCopyBundleURL(mainBundle);
+	if(!mainBundleURL)
+		throw content_error(&quot;Could not determine bundle path&quot;);
+
+	CFStringRef cfStringRef = CFURLCopyFileSystemPath(mainBundleURL, kCFURLPOSIXPathStyle);
+	if(!cfStringRef)
+		throw content_error(&quot;Could not determine bundle path&quot;);
+
+	CFStringGetCString(cfStringRef, cPath, 1024, kCFStringEncodingASCII);
+
+	CFRelease(mainBundleURL);
+	CFRelease(cfStringRef);
+	std::string path(cPath);
+	
+	datadirs.clear();
+	writedir = NULL;
+	
+	// Add bundle resources:
+	datadirs.push_back(path + &quot;/Contents/Resources/&quot;);
+	datadirs.rbegin()-&gt;readable = true;
+	// Add the directory surrounding the bundle, for users to add mods and maps in:
+	datadirs.push_back(filesystem.GetDirectory(path));
+	// Use surrounding directory as writedir for now, should propably
+	// change this to something inside the home directory:
+	datadirs.rbegin()-&gt;writable = true;
+	datadirs.rbegin()-&gt;readable = true;
+	writedir = &amp;*datadirs.rbegin();
+#else
+	// home
+	AddDirs(SubstEnvVars(&quot;$HOME/.spring&quot;));
+
+	// settings in /etc
+	FILE* f = ::fopen(&quot;/etc/spring/datadir&quot;, &quot;r&quot;);
+	if (f) {
+		char buf[1024];
+		while (fgets(buf, sizeof(buf), f)) {
+			char* newl = strchr(buf, '\n');
+			if (newl)
+				*newl = 0;
+			char white[3] = {'\t', ' ', 0};
+			if (strlen(buf) &gt; 0 &amp;&amp; strspn(buf, white) != strlen(buf)) // don't count lines of whitespaces / tabulators
+				AddDirs(SubstEnvVars(buf));
+		}
+		fclose(f);
+	}
+#endif
+
+	// compiler flags
+#ifdef SPRING_DATADIR
+	datadirs.push_back(SubstEnvVars(SPRING_DATADIR));
+#endif
+	// should not be needed because you can seperate directories with a ':' in SPRING_DATADIR(1)
+#ifdef SPRING_DATADIR_2
+	datadirs.push_back(SubstEnvVars(SPRING_DATADIR_2));
+#endif
+
+	// Figure out permissions of all datadirs
+	DeterminePermissions();
+
+	if (!writedir) {
+		// bail out
+#ifdef WIN32
+		const std::string errstr = &quot;Not a single writable data directory found!\n\n&quot;
+				&quot;Configure a writable data directory using either:\n&quot;
+				&quot;- the SPRING_DATADIR environment variable,\n&quot;
+				&quot;- a SpringData=C:/path/to/data declaration in spring's registry entry or\n&quot;
+				&quot;- by giving you write access to the installation directory&quot;;
+#else
+		const std::string errstr = &quot;Not a single writable data directory found!\n\n&quot;
+				&quot;Configure a writable data directory using either:\n&quot;
+				&quot;- the SPRING_DATADIR environment variable,\n&quot;
+				&quot;- a SpringData=/path/to/data declaration in ~/.springrc or\n&quot;
+				&quot;- the configuration file /etc/spring/datadir&quot;;
+#endif
+		throw content_error(errstr);
+	}
+
+	// for now, chdir to the datadirectory as a safety measure:
+	// all AIs still just assume it's ok to put their stuff in the current directory after all
+	// Not only safety anymore, it's just easier if other code can safely assume that
+	// writedir == current working directory
+#ifndef _WIN32
+	chdir(GetWriteDir()-&gt;path.c_str());
+#else
+	_chdir(GetWriteDir()-&gt;path.c_str());
+#endif
+	// Initialize the log. Only after this moment log will be written to file.
+	logOutput.Initialize();
+	// Logging MAY NOT start before the chdir, otherwise the logfile ends up
+	// in the wrong directory.
+	// Update: now it actually may start before, log has preInitLog.
+	for (std::vector&lt;DataDir&gt;::const_iterator d = datadirs.begin(); d != datadirs.end(); ++d) {
+		if (d-&gt;writable)
+			logOutput.Print(&quot;Using read-write data directory: %s&quot;, d-&gt;path.c_str());
+		else
+			logOutput.Print(&quot;Using read-only  data directory: %s&quot;, d-&gt;path.c_str());
+	}
+}

Copied: branches/caiinterface/rts/System/FileSystem/DataDirLocater.h (from rev 7023, trunk/rts/System/FileSystem/DataDirLocater.h)
===================================================================
--- branches/caiinterface/rts/System/FileSystem/DataDirLocater.h	                        (rev 0)
+++ branches/caiinterface/rts/System/FileSystem/DataDirLocater.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -0,0 +1,40 @@
+/**
+ * @file DataDirLocater.h
+ * @author Tobi Vollebregt
+ *
+ * Copyright (C) 2006-2008 Tobi Vollebregt
+ * Licensed under the terms of the GNU GPL, v2 or later
+ */
+#ifndef DATADIRLOCATER_H
+#define DATADIRLOCATER_H
+
+#include &lt;string&gt;
+#include &lt;vector&gt;
+
+struct DataDir
+{
+	DataDir(const std::string&amp; p);
+	std::string path;
+	bool writable;
+};
+
+class DataDirLocater
+{
+public:
+	DataDirLocater();
+	void LocateDataDirs();
+
+	const std::vector&lt;DataDir&gt;&amp; GetDataDirs() const { return datadirs; }
+	const DataDir* GetWriteDir() const { return writedir; }
+
+private:
+	std::string SubstEnvVars(const std::string&amp; in) const;
+	void AddDirs(const std::string&amp; in);
+	bool DeterminePermissions(DataDir* d);
+	void DeterminePermissions();
+
+	std::vector&lt;DataDir&gt; datadirs;
+	const DataDir* writedir;
+};
+
+#endif // !defined(DATADIRLOCATER_H)

Modified: branches/caiinterface/rts/System/FileSystem/FileHandler.cpp
===================================================================
--- branches/caiinterface/rts/System/FileSystem/FileHandler.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/FileSystem/FileHandler.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -9,7 +9,7 @@
 
 #include &quot;FileHandler.h&quot;
 #include &quot;VFSHandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 
 #include &quot;Util.h&quot;
 using namespace std;

Copied: branches/caiinterface/rts/System/FileSystem/FileSystem.cpp (from rev 7023, trunk/rts/System/FileSystem/FileSystem.cpp)
===================================================================
--- branches/caiinterface/rts/System/FileSystem/FileSystem.cpp	                        (rev 0)
+++ branches/caiinterface/rts/System/FileSystem/FileSystem.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -0,0 +1,421 @@
+/**
+ * @file FileSystem.cpp
+ * @brief Abstracts locating of content on different platforms
+ * @author Tobi Vollebregt
+ *
+ * FindFiles implementation by Chris Han.
+ * Glob conversion by Chris Han (based on work by Nathaniel Smith).
+ * Copyright (C) 2005-2006.  Licensed under the terms of the
+ * GNU GPL, v2 or later
+ */
+
+#include &quot;StdAfx.h&quot;
+#include &lt;assert.h&gt;
+#include &lt;limits.h&gt;
+#include &lt;boost/regex.hpp&gt;
+#include &lt;fstream&gt;
+#include &lt;sys/stat.h&gt;
+#include &lt;sys/types.h&gt;
+#include &quot;FileSystem.h&quot;
+
+#include &quot;UnixFileSystemHandler.h&quot;
+
+#include &quot;FileSystem/ArchiveScanner.h&quot;
+#include &quot;FileSystem/VFSHandler.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;Util.h&quot;
+#include &quot;mmgr.h&quot;
+
+
+#define fs (FileSystemHandler::GetInstance())
+
+FileSystem filesystem;
+
+
+////////////////////////////////////////
+////////// FileSystemHandler
+
+/**
+ * @brief The global data directory handler instance
+ */
+FileSystemHandler* FileSystemHandler::instance = NULL;
+
+/**
+ * @brief get the data directory handler instance
+ */
+FileSystemHandler&amp; FileSystemHandler::GetInstance()
+{
+	if (!instance)
+		Initialize(false);
+	return *instance;
+}
+
+/**
+ * @brief initialize the data directory handler
+ */
+void FileSystemHandler::Initialize(bool verbose)
+{
+	if (!instance) {
+		// FIXME this leaks memory
+		instance = new UnixFileSystemHandler(verbose);
+		try {
+			instance-&gt;Initialize();
+		}
+		catch (...) {
+			SafeDelete(instance);
+			throw;
+		}
+	}
+}
+
+void FileSystemHandler::Cleanup()
+{
+	SafeDelete(instance);
+}
+
+FileSystemHandler::~FileSystemHandler()
+{
+	SafeDelete(archiveScanner);
+	SafeDelete(vfsHandler);
+}
+
+FileSystemHandler::FileSystemHandler(int native_path_sep): native_path_separator(native_path_sep)
+{
+	// NOTE TO SELF: NEVER EVAR DO THIS AGAIN THIS WAY
+
+	// combined with init code in constructor and exceptions being thrown
+	// when this init code fails it results in dangling pointers.
+
+	// (if constructor throws exception object doesn't exist, by definition,
+	//  but global variable instance would still point to it....)
+
+//	// need to set this here already or we get stuck in an infinite loop
+//	// because WinFileSystemHandler/UnixFileSystemHandler ctor initializes the
+//	// ArchiveScanner (which uses FileSystemHandler::GetInstance again...).
+//	instance = this;
+}
+
+////////////////////////////////////////
+////////// FileSystem
+
+/**
+ * @brief quote macro
+ * @param c Character to test
+ * @param str string currently being built
+ *
+ * Given a string str that we're assembling,
+ * and an upcoming character c, will append
+ * an extra '\\' to quote the character if necessary.
+ */
+#define QUOTE(c,str)			\
+	do {					\
+		if (!(isalnum(c)||(c)=='_'))	\
+			str+='\\';		\
+		str+=c;				\
+} while (0)
+
+/**
+ * @brief glob to regex
+ * @param glob string containing glob
+ * @return string containing regex
+ *
+ * Converts a glob expression to a regex
+ */
+std::string FileSystem::glob_to_regex(const std::string&amp; glob) const
+{
+	std::string regex;
+	regex.reserve(glob.size()&lt;&lt;1);
+	int braces = 0;
+	for (std::string::const_iterator i = glob.begin(); i != glob.end(); ++i) {
+		char c = *i;
+#ifdef DEBUG
+		if (braces&gt;=5)
+			logOutput.Print(&quot;glob_to_regex warning: braces nested too deeply\n%s&quot;, glob.c_str());
+#endif
+		switch (c) {
+			case '*':
+				regex+=&quot;.*&quot;;
+				break;
+			case '?':
+				regex+='.';
+				break;
+			case '{':
+				braces++;
+				regex+='(';
+				break;
+			case '}':
+#ifdef DEBUG
+				if (!braces)
+					logOutput.Print(&quot;glob_to_regex warning: closing brace without an equivalent opening brace\n%s&quot;, glob.c_str());
+#endif
+				regex+=')';
+				braces--;
+				break;
+			case ',':
+				if (braces)
+					regex+='|';
+				else
+					QUOTE(c,regex);
+				break;
+			case '\\':
+#ifdef DEBUG
+				if (++i==glob.end())
+					logOutput.Print(&quot;glob_to_regex warning: pattern ends with backslash\n%s&quot;, glob.c_str());
+#else
+				++i;
+#endif
+				QUOTE(*i,regex);
+				break;
+			default:
+				QUOTE(c,regex);
+				break;
+		}
+	}
+#ifdef DEBUG
+	if (braces)
+		logOutput.Print(&quot;glob_to_regex warning: unterminated brace expression\n%s&quot;, glob.c_str());
+#endif
+	return regex;
+}
+
+/**
+ * @brief get filesize
+ *
+ * @return the filesize or 0 if the file doesn't exist.
+ */
+size_t FileSystem::GetFilesize(std::string file) const
+{
+	if (!CheckFile(file))
+		return 0;
+	FixSlashes(file);
+	struct stat info;
+	if (stat(file.c_str(), &amp;info) != 0)
+		return 0;
+	return info.st_size;
+}
+
+/**
+ * @brief create a directory
+ *
+ * Works like mkdir -p, ie. attempts to create parent directories too.
+ * Operates on the current working directory.
+ */
+bool FileSystem::CreateDirectory(std::string dir) const
+{
+	if (!CheckFile(dir))
+		return false;
+
+	ForwardSlashes(dir);
+	size_t prev_slash = 0, slash;
+	while ((slash = dir.find('/', prev_slash + 1)) != std::string::npos) {
+		if (!fs.mkdir(dir.substr(0, slash)))
+			return false;
+		prev_slash = slash;
+	}
+	return fs.mkdir(dir);
+}
+
+
+/**
+ * @brief find files
+ *
+ * Compiles a std::vector of all files below dir that match pattern.
+ *
+ * If FileSystem::RECURSE flag is set it recurses into subdirectories.
+ * If FileSystem::INCLUDE_DIRS flag is set it includes directories in the
+ * result too, as long as they match the pattern.
+ *
+ * Note that pattern doesn't apply to the names of recursed directories,
+ * it does apply to the files inside though.
+ */
+std::vector&lt;std::string&gt; FileSystem::FindFiles(std::string dir, const std::string&amp; pattern, int flags) const
+{
+	if (!CheckFile(dir)) {
+		return std::vector&lt;std::string&gt;();
+	}
+
+	if (dir.empty()) {
+		dir = &quot;./&quot;;
+	}
+	else {
+		const char lastChar = dir[dir.length() - 1];
+		if ((lastChar != '/') &amp;&amp; (lastChar != '\\')) {
+			dir += '/';
+		}
+	}
+
+	FixSlashes(dir);
+
+	if (flags &amp; ONLY_DIRS) {
+		flags |= INCLUDE_DIRS;
+	}
+
+	return fs.FindFiles(dir, pattern, flags);
+}
+
+
+/**
+ * @brief get the directory part of a path
+ */
+std::string FileSystem::GetDirectory(const std::string&amp; path) const
+{
+	size_t s = path.find_last_of('/');
+	size_t bs = path.find_last_of('\\');
+	if (s != std::string::npos &amp;&amp; bs != std::string::npos)
+		return path.substr(0, std::max(s, bs) + 1);
+	if (s != std::string::npos)
+		return path.substr(0, s + 1);
+	if (bs != std::string::npos)
+		return path.substr(0, bs + 1);
+	return path;
+}
+
+/**
+ * @brief get the filename part of a path
+ */
+std::string FileSystem::GetFilename(const std::string&amp; path) const
+{
+	size_t s = path.find_last_of('/');
+	size_t bs = path.find_last_of('\\');
+	if (s != std::string::npos &amp;&amp; bs != std::string::npos)
+		return path.substr(std::max(s, bs) + 1);
+	if (s != std::string::npos)
+		return path.substr(s + 1);
+	if (bs != std::string::npos)
+		return path.substr(bs + 1);
+	return path;
+}
+
+/**
+ * @brief get the basename part of a path, ie. the filename without extension
+ */
+std::string FileSystem::GetBasename(const std::string&amp; path) const
+{
+	std::string fn = GetFilename(path);
+	size_t dot = fn.find_last_of('.');
+	if (dot != std::string::npos)
+		return fn.substr(0, dot);
+	return fn;
+}
+
+/**
+ * @brief get the extension of the filename part of the path
+ */
+std::string FileSystem::GetExtension(const std::string&amp; path) const
+{
+	std::string fn = GetFilename(path);
+	size_t dot = fn.find_last_of('.');
+	if (dot != std::string::npos)
+		return fn.substr(dot + 1);
+	return &quot;&quot;;
+}
+
+/**
+ * @brief converts all slashes and backslashes in path to the native_path_separator
+ */
+std::string&amp; FileSystem::FixSlashes(std::string&amp; path) const
+{
+	int sep = fs.GetNativePathSeparator();
+	for (unsigned i = 0; i &lt; path.size(); ++i)
+		if (path[i] == '/' || path[i] == '\\')
+			path[i] = sep;
+	return path;
+}
+
+/**
+ * @brief converts backslashes in path to forward slashes
+ */
+std::string&amp; FileSystem::ForwardSlashes(std::string&amp; path) const
+{
+	for (unsigned i = 0; i &lt; path.size(); ++i)
+		if (path[i] == '\\')
+			path[i] = '/';
+	return path;
+}
+
+/**
+ * @brief does a little checking of a filename
+ */
+bool FileSystem::CheckFile(const std::string&amp; file) const
+{
+	// Don't allow code to escape from the data directories.
+	// Note: this does NOT mean this is a SAFE fopen function:
+	// symlink-, hardlink-, you name it-attacks are all very well possible.
+	// The check is just ment to &quot;enforce&quot; certain coding behaviour.
+	if (file.find(&quot;..&quot;) != std::string::npos)
+		return false;
+
+	return true;
+}
+
+/**
+ * @brief does a little checking of a modestring
+ */
+bool FileSystem::CheckMode(const char* mode) const
+{
+	assert(mode &amp;&amp; *mode);
+	return true;
+}
+
+/**
+ * @brief locate a file
+ *
+ * Attempts to locate a file.
+ *
+ * If the FileSystem::WRITE flag is set, it just returns the argument
+ * (assuming the file should come in the current working directory).
+ * If FileSystem::CREATE_DIRS is set it tries to create the subdirectory
+ * the file should live in.
+ *
+ * Otherwise (if flags == 0), it dispatches the call to
+ * FileSystemHandler::LocateFile(), which either searches for it in multiple
+ * data directories (UNIX) or just returns the argument (Windows).
+ */
+std::string FileSystem::LocateFile(std::string file, int flags) const
+{
+	if (!CheckFile(file)) {
+		return &quot;&quot;;
+	}
+
+	FixSlashes(file);
+
+	if (flags &amp; WRITE) {
+		if (flags &amp; CREATE_DIRS) {
+			CreateDirectory(GetDirectory(file));
+		}
+		return file;
+	}
+
+	return fs.LocateFile(file);
+}
+
+
+bool FileSystem::InReadDir(const std::string&amp; path)
+{
+	if (path.find(&quot;..&quot;) != std::string::npos) {
+		return false; // realpath() would be nice
+	}
+	const std::vector&lt;std::string&gt; readDirs = fs.GetDataDirectories();
+	return true;
+}
+
+
+bool FileSystem::InWriteDir(const std::string&amp; path, const std::string&amp; prefix)
+{
+	const std::string writeDir = fs.GetWriteDir();
+	return true;
+}
+
+
+/**
+ * @brief remove a file
+ *
+ * Operates on the current working directory.
+ */
+bool FileSystem::Remove(std::string file) const
+{
+	if (!CheckFile(file))
+		return false;
+	FixSlashes(file);
+	return ::remove(file.c_str()) == 0;
+}

Copied: branches/caiinterface/rts/System/FileSystem/FileSystem.h (from rev 7023, trunk/rts/System/FileSystem/FileSystem.h)
===================================================================
--- branches/caiinterface/rts/System/FileSystem/FileSystem.h	                        (rev 0)
+++ branches/caiinterface/rts/System/FileSystem/FileSystem.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -0,0 +1,113 @@
+/**
+ * @file FileSystem.h
+ * @brief Abstracts locating of content on different platforms
+ * @author Tobi Vollebregt
+ *
+ * Copyright (C) 2006.  Licensed under the terms of the
+ * GNU GPL, v2 or later
+ */
+
+#ifndef FILESYSTEM_H
+#define FILESYSTEM_H
+
+#include &lt;vector&gt;
+#include &lt;string&gt;
+
+// winapi redifines this which breaks things
+#if defined(CreateDirectory)
+# undef CreateDirectory
+#endif
+
+/**
+ * @brief native file system handling abstraction
+ */
+class FileSystemHandler
+{
+	public:
+
+		static FileSystemHandler&amp; GetInstance();
+		static void Initialize(bool verbose);
+		static void Cleanup();
+
+		virtual ~FileSystemHandler();
+		FileSystemHandler(int native_path_sep = '/');
+		virtual void Initialize() = 0;
+
+		// almost direct wrappers to system calls
+		virtual bool mkdir(const std::string&amp; dir) const = 0;
+
+		// custom functions
+		virtual std::vector&lt;std::string&gt; FindFiles(const std::string&amp; dir, const std::string&amp; pattern, int flags) const = 0;
+		virtual std::string LocateFile(const std::string&amp; file) const = 0;
+		virtual std::string GetWriteDir() const = 0;
+		virtual std::vector&lt;std::string&gt; GetDataDirectories() const = 0;
+
+		int GetNativePathSeparator() const { return native_path_separator; }
+
+	protected:
+
+		static FileSystemHandler* instance;
+
+		const int native_path_separator;
+};
+
+/**
+ * @brief filesystem interface
+ *
+ * Use this from the rest of the spring code!
+ */
+class FileSystem
+{
+	public:
+		// flags for FindFiles
+		enum FindFilesBits {
+			RECURSE      = (1 &lt;&lt; 0),
+			INCLUDE_DIRS = (1 &lt;&lt; 1),
+			ONLY_DIRS    = (1 &lt;&lt; 2),
+		};
+		// flags for LocateFile
+		enum LocateFileBits {
+			WRITE       = (1 &lt;&lt; 0),
+			CREATE_DIRS = (1 &lt;&lt; 1),
+		};
+
+	public:
+		FileSystem() {}
+
+		// generic functions
+		std::string LocateFile(std::string file, int flags = 0) const;
+		bool Remove(std::string file) const;
+
+		// metadata read functions
+		size_t GetFilesize(std::string path) const;
+
+		// directory functions
+		bool CreateDirectory(std::string dir) const;
+		std::vector&lt;std::string&gt; FindFiles(std::string dir, const std::string&amp; pattern, int flags = 0) const;
+
+		// convenience functions
+		std::string GetDirectory (const std::string&amp; path) const;
+		std::string GetFilename  (const std::string&amp; path) const;
+		std::string GetBasename  (const std::string&amp; path) const;
+		std::string GetExtension (const std::string&amp; path) const;
+		std::string glob_to_regex(const std::string&amp; glob) const;
+		std::string&amp; FixSlashes  (std::string&amp; path) const;
+		std::string&amp; ForwardSlashes(std::string&amp; path) const;
+
+		// access check functions
+		bool InReadDir(const std::string&amp; path);
+		bool InWriteDir(const std::string&amp; path, const std::string&amp; prefix = &quot;&quot;);
+
+	private:
+		bool CheckFile(const std::string&amp; file) const;
+		bool CheckDir(const std::string&amp; dir) const;
+		bool CheckMode(const char* mode) const;
+
+		FileSystem(const FileSystem&amp;);
+		FileSystem&amp; operator=(const FileSystem&amp;);
+};
+
+// basically acts like a namespace, but with semantics like configHandler has
+extern FileSystem filesystem;
+
+#endif // !FILESYSTEM_H

Modified: branches/caiinterface/rts/System/FileSystem/SimpleParser.h
===================================================================
--- branches/caiinterface/rts/System/FileSystem/SimpleParser.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/FileSystem/SimpleParser.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -7,7 +7,7 @@
 #include &lt;string&gt;
 #include &lt;vector&gt;
 
-#include &quot;System/FileSystem/FileHandler.h&quot;
+#include &quot;FileHandler.h&quot;
 
 
 class CSimpleParser

Copied: branches/caiinterface/rts/System/FileSystem/UnixFileSystemHandler.cpp (from rev 7023, trunk/rts/System/FileSystem/UnixFileSystemHandler.cpp)
===================================================================
--- branches/caiinterface/rts/System/FileSystem/UnixFileSystemHandler.cpp	                        (rev 0)
+++ branches/caiinterface/rts/System/FileSystem/UnixFileSystemHandler.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -0,0 +1,312 @@
+/**
+ * @file UnixFileSystemHandler.cpp
+ * @brief Abstracts locating of content on different platforms
+ * @author Tobi Vollebregt
+ *
+ * Linux and Windows implementation, supporting multiple data directories / search paths.
+ *
+ * Copyright (C) 2006-2008 Tobi Vollebregt.
+ * Licensed under the terms of the GNU GPL, v2 or later
+ */
+
+#include &quot;UnixFileSystemHandler.h&quot;
+#include &lt;limits.h&gt;
+#include &lt;boost/regex.hpp&gt;
+#include &lt;sys/stat.h&gt;
+#include &lt;sys/types.h&gt;
+#ifndef _WIN32
+#include &lt;dirent.h&gt;
+#include &lt;sstream&gt;
+#include &lt;unistd.h&gt;
+#else
+#include &lt;windows.h&gt;
+#include &lt;io.h&gt;
+#include &lt;direct.h&gt;
+#endif
+#include &quot;ArchiveScanner.h&quot;
+#include &quot;VFSHandler.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;Platform/ConfigHandler.h&quot;
+#include &quot;mmgr.h&quot;
+
+/**
+ * @brief Creates the archive scanner and vfs handler
+ *
+ * For the archiveScanner, it keeps cache data (&quot;archivecache.txt&quot;) in the
+ * writedir. Cache data in other directories is ignored.
+ * It scans maps, base and mods subdirectories of all readable datadirs
+ * for archives. Archives in higher priority datadirs override archives
+ * in lower priority datadirs.
+ *
+ * Note that the archive namespace is global, ie. each archive basename may
+ * only occur once in all data directories. If a name is found more then once,
+ * then higher priority datadirs override lower priority datadirs and per
+ * datadir the 'mods' subdir overrides 'base' which overrides 'maps'.
+ */
+void UnixFileSystemHandler::InitVFS() const
+{
+	const DataDir* writedir = locater.GetWriteDir();
+	const std::vector&lt;DataDir&gt;&amp; datadirs = locater.GetDataDirs();
+
+	archiveScanner = new CArchiveScanner();
+
+	archiveScanner-&gt;ReadCacheData(writedir-&gt;path + archiveScanner-&gt;GetFilename());
+
+	std::vector&lt;std::string&gt; scanDirs;
+	for (std::vector&lt;DataDir&gt;::const_reverse_iterator d = datadirs.rbegin(); d != datadirs.rend(); ++d) {
+		scanDirs.push_back(d-&gt;path + &quot;maps&quot;);
+		scanDirs.push_back(d-&gt;path + &quot;base&quot;);
+		scanDirs.push_back(d-&gt;path + &quot;mods&quot;);
+	}
+	archiveScanner-&gt;ScanDirs(scanDirs, true);
+
+	archiveScanner-&gt;WriteCacheData(writedir-&gt;path + archiveScanner-&gt;GetFilename());
+
+	vfsHandler = new CVFSHandler();
+}
+
+
+/**
+ * @brief Creates the archive scanner and vfs handler
+ *
+ * Locates data directories and initializes the VFS.
+ */
+UnixFileSystemHandler::UnixFileSystemHandler(bool verbose) :
+#ifndef _WIN32
+		FileSystemHandler('/')
+#else
+		FileSystemHandler('\\')
+#endif
+{
+}
+
+
+void UnixFileSystemHandler::Initialize()
+{
+	locater.LocateDataDirs();
+	InitVFS();
+}
+
+
+UnixFileSystemHandler::~UnixFileSystemHandler()
+{
+	configHandler.Deallocate();
+}
+
+
+/**
+ * @brief returns the highest priority writable directory, aka the writedir
+ */
+std::string UnixFileSystemHandler::GetWriteDir() const
+{
+	const DataDir* writedir = locater.GetWriteDir();
+	assert(writedir &amp;&amp; writedir-&gt;writable); // duh
+	return writedir-&gt;path;
+}
+
+
+/**
+ * @brief find files
+ * @param dir path in which to start looking (tried relative to each data directory)
+ * @param pattern pattern to search for
+ * @param recurse whether or not to recursively search
+ * @param include_dirs whether or not to include directory names in the result
+ * @return vector of std::strings containing absolute paths to the files
+ *
+ * Will search for a file given a particular pattern.
+ * Starts from dirpath, descending down if recurse is true.
+ */
+std::vector&lt;std::string&gt; UnixFileSystemHandler::FindFiles(const std::string&amp; dir, const std::string&amp; pattern, int flags) const
+{
+	std::vector&lt;std::string&gt; matches;
+
+	// if it's an absolute path, don't look for it in the data directories
+	if ((dir[0] == '/') || ((dir.length() &gt; 1) &amp;&amp; (dir[1] == ':'))) {
+		FindFilesSingleDir(matches, dir, pattern, flags);
+		return matches;
+	}
+
+	const std::vector&lt;DataDir&gt;&amp; datadirs = locater.GetDataDirs();
+	for (std::vector&lt;DataDir&gt;::const_reverse_iterator d = datadirs.rbegin(); d != datadirs.rend(); ++d) {
+		FindFilesSingleDir(matches, d-&gt;path + dir, pattern, flags);
+	}
+	return matches;
+}
+
+
+std::string UnixFileSystemHandler::LocateFile(const std::string&amp; file) const
+{
+	// if it's an absolute path, don't look for it in the data directories
+#ifdef WIN32
+	if ((file.length() &gt; 1) &amp;&amp; (file[1] == ':')) {
+		return file;
+	}
+
+	const std::vector&lt;DataDir&gt;&amp; datadirs = locater.GetDataDirs();
+	for (std::vector&lt;DataDir&gt;::const_iterator d = datadirs.begin(); d != datadirs.end(); ++d) {
+		std::string fn(d-&gt;path + file);
+		if (_access(fn.c_str(), 4) == 0) {
+			return fn;
+		}
+	}
+	return file;
+#else
+	if (file[0] == '/') {
+		return file;
+	}
+
+	const std::vector&lt;DataDir&gt;&amp; datadirs = locater.GetDataDirs();
+	for (std::vector&lt;DataDir&gt;::const_iterator d = datadirs.begin(); d != datadirs.end(); ++d) {
+		std::string fn(d-&gt;path + file);
+		if (access(fn.c_str(), R_OK | F_OK) == 0) {
+			return fn;
+		}
+	}
+	return file;
+#endif
+}
+
+
+std::vector&lt;std::string&gt; UnixFileSystemHandler::GetDataDirectories() const
+{
+	std::vector&lt;std::string&gt; f;
+
+	const std::vector&lt;DataDir&gt;&amp; datadirs = locater.GetDataDirs();
+	for (std::vector&lt;DataDir&gt;::const_iterator d = datadirs.begin(); d != datadirs.end(); ++d) {
+		f.push_back(d-&gt;path);
+	}
+	return f;
+}
+
+
+/**
+ * @brief creates a rwxr-xr-x dir in the writedir
+ *
+ * Returns true if the postcondition of this function is that dir exists in
+ * the write directory.
+ *
+ * Note that this function does not check access to the dir, ie. if you've
+ * created it manually with 0000 permissions then this function may return
+ * true, subsequent operation on files inside the directory may still fail.
+ *
+ * As a rule of thumb, set identical permissions on identical items in the
+ * data directory, ie. all subdirectories the same perms, all files the same
+ * perms.
+ */
+bool UnixFileSystemHandler::mkdir(const std::string&amp; dir) const
+{
+#ifdef _WIN32
+	struct _stat info;
+
+	// First check if directory exists. We'll return success if it does.
+	if (_stat(dir.c_str(), &amp;info) == 0 &amp;&amp; (info.st_mode&amp;_S_IFDIR))
+		return true;
+#else
+	struct stat info;
+
+	// First check if directory exists. We'll return success if it does.
+	if (stat(dir.c_str(), &amp;info) == 0 &amp;&amp; S_ISDIR(info.st_mode))
+		return true;
+#endif
+	// If it doesn't exist we try to mkdir it and return success if that succeeds.
+#ifndef _WIN32
+	if (::mkdir(dir.c_str(), S_IRWXU | S_IRGRP | S_IXGRP | S_IROTH | S_IXOTH) == 0)
+#else
+	if (::_mkdir(dir.c_str()) == 0)
+#endif
+		return true;
+
+	// Otherwise we return false.
+	return false;
+}
+
+
+static void FindFiles(std::vector&lt;std::string&gt;&amp; matches, const std::string&amp; dir, const boost::regex &amp;regexpattern, int flags)
+{
+#ifdef _WIN32
+	WIN32_FIND_DATA wfd;
+  HANDLE hFind = FindFirstFile((dir+&quot;\\*&quot;).c_str(), &amp;wfd);
+
+	if (hFind != INVALID_HANDLE_VALUE) {
+		do {
+			if(strcmp(wfd.cFileName,&quot;.&quot;) &amp;&amp; strcmp(wfd.cFileName ,&quot;..&quot;)) {
+				if(!(wfd.dwFileAttributes&amp;FILE_ATTRIBUTE_DIRECTORY)) {
+					if ((flags &amp; FileSystem::ONLY_DIRS) == 0) {
+						if (boost::regex_match(wfd.cFileName, regexpattern)) {
+							matches.push_back(dir + wfd.cFileName);
+						}
+					}
+				}
+				else {
+					if (flags &amp; FileSystem::INCLUDE_DIRS) {
+						if (boost::regex_match(wfd.cFileName, regexpattern)) {
+							matches.push_back(dir + wfd.cFileName + &quot;\\&quot;);
+						}
+					}
+					if (flags &amp; FileSystem::RECURSE) {
+						FindFiles(matches, dir + wfd.cFileName + &quot;\\&quot;, regexpattern, flags);
+					}
+				}
+			}
+		} while (FindNextFile(hFind, &amp;wfd));
+		FindClose(hFind);
+	}
+#else
+	DIR* dp;
+	struct dirent* ep;
+
+	if (!(dp = opendir(dir.c_str())))
+		return;
+
+	while ((ep = readdir(dp))) {
+		// exclude hidden files
+		if (ep-&gt;d_name[0] != '.') {
+			// is it a file? (we just treat sockets / pipes / fifos / character&amp;block devices as files...)
+			// (need to stat because d_type is DT_UNKNOWN on linux :-/)
+			struct stat info;
+			if (stat((dir + ep-&gt;d_name).c_str(), &amp;info) == 0) {
+				if (!S_ISDIR(info.st_mode)) {
+					if ((flags &amp; FileSystem::ONLY_DIRS) == 0) {
+						if (boost::regex_match(ep-&gt;d_name, regexpattern)) {
+							matches.push_back(dir + ep-&gt;d_name);
+						}
+					}
+				}
+				else {
+					// or a directory?
+					if (flags &amp; FileSystem::INCLUDE_DIRS) {
+						if (boost::regex_match(ep-&gt;d_name, regexpattern)) {
+							matches.push_back(dir + ep-&gt;d_name + &quot;/&quot;);
+						}
+					}
+					if (flags &amp; FileSystem::RECURSE) {
+						FindFiles(matches, dir + ep-&gt;d_name + &quot;/&quot;, regexpattern, flags);
+					}
+				}
+			}
+		}
+	}
+	closedir(dp);
+#endif
+}
+
+
+/**
+ * @brief internal find-files-in-a-single-datadir-function
+ * @param dir path in which to start looking
+ * @param pattern pattern to search for
+ * @param recurse whether or not to recursively search
+ * @param include_dirs whether or not to include directory names in the result
+ * @return vector of std::strings
+ *
+ * Will search for a file given a particular pattern.
+ * Starts from dirpath, descending down if recurse is true.
+ */
+void UnixFileSystemHandler::FindFilesSingleDir(std::vector&lt;std::string&gt;&amp; matches, const std::string&amp; dir, const std::string &amp;pattern, int flags) const
+{
+	assert(!dir.empty() &amp;&amp; dir[dir.length() - 1] == native_path_separator);
+
+	boost::regex regexpattern(filesystem.glob_to_regex(pattern));
+
+	::FindFiles(matches, dir, regexpattern, flags);
+}

Copied: branches/caiinterface/rts/System/FileSystem/UnixFileSystemHandler.h (from rev 7023, trunk/rts/System/FileSystem/UnixFileSystemHandler.h)
===================================================================
--- branches/caiinterface/rts/System/FileSystem/UnixFileSystemHandler.h	                        (rev 0)
+++ branches/caiinterface/rts/System/FileSystem/UnixFileSystemHandler.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -0,0 +1,46 @@
+/**
+ * @file UnixFileSystemHandler.h
+ * @brief Abstracts locating of content on different platforms
+ * @author Tobi Vollebregt
+ *
+ * Unix implementation
+ *
+ * Copyright (C) 2006.  Licensed under the terms of the
+ * GNU GPL, v2 or later
+ */
+
+#ifndef UNIXFILESYSTEMHANDLER_H
+#define UNIXFILESYSTEMHANDLER_H
+
+#include &lt;string&gt;
+#include &lt;vector&gt;
+#include &quot;DataDirLocater.h&quot;
+#include &quot;FileSystem.h&quot;
+
+/**
+ * @brief Unix file system / data directory handler
+ */
+class UnixFileSystemHandler : public FileSystemHandler
+{
+	public:
+
+		virtual ~UnixFileSystemHandler();
+		UnixFileSystemHandler(bool verbose);
+		virtual void Initialize();
+
+		virtual bool mkdir(const std::string&amp; dir) const;
+
+		virtual std::string GetWriteDir() const;
+		virtual std::vector&lt;std::string&gt; FindFiles(const std::string&amp; dir, const std::string&amp; pattern, int flags) const;
+		virtual std::string LocateFile(const std::string&amp; file) const;
+		virtual std::vector&lt;std::string&gt; GetDataDirectories() const;
+
+	protected:
+
+		void InitVFS() const;
+		void FindFilesSingleDir(std::vector&lt;std::string&gt;&amp; matches, const std::string&amp; dir, const std::string &amp;pattern, int flags) const;
+
+		DataDirLocater locater;
+};
+
+#endif // !UNIXFILESYSTEMHANDLER_H

Modified: branches/caiinterface/rts/System/FileSystem/VFSHandler.cpp
===================================================================
--- branches/caiinterface/rts/System/FileSystem/VFSHandler.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/FileSystem/VFSHandler.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -8,7 +8,7 @@
 #include &quot;ArchiveBase.h&quot;
 #include &quot;ArchiveDir.h&quot; // for FileData::dynamic
 #include &quot;LogOutput.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;Util.h&quot;
 
 

Modified: branches/caiinterface/rts/System/GlobalUnsynced.cpp
===================================================================
--- branches/caiinterface/rts/System/GlobalUnsynced.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/GlobalUnsynced.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -17,9 +17,9 @@
 #include &quot;Game/GameHelper.h&quot;
 #include &quot;Game/GameSetup.h&quot;
 #include &quot;Sync/SyncTracer.h&quot;
-#include &quot;Game/Team.h&quot;
+#include &quot;Sim/Misc/Team.h&quot;
 #include &quot;Game/Player.h&quot;
-#include &quot;Game/GlobalConstants.h&quot;
+#include &quot;Sim/Misc/GlobalConstants.h&quot;
 #include &quot;Rendering/Textures/TAPalette.h&quot;
 #include &quot;Lua/LuaGaia.h&quot;
 #include &quot;Lua/LuaRules.h&quot;

Modified: branches/caiinterface/rts/System/LoadSaveHandler.cpp
===================================================================
--- branches/caiinterface/rts/System/LoadSaveHandler.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/LoadSaveHandler.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -17,20 +17,20 @@
 #include &quot;Sim/Misc/CategoryHandler.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;Platform/errorhandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;creg/Serializer.h&quot;
 #include &quot;Game/Game.h&quot;
 #include &quot;Game/GameSetup.h&quot;
 #include &quot;Game/GameServer.h&quot;
-#include &quot;Game/Team.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Game/WaitCommandsAI.h&quot;
 #include &quot;Sim/Misc/Wind.h&quot;
 #include &quot;Sim/Units/CommandAI/BuilderCAI.h&quot;
 #include &quot;Game/GameServer.h&quot;
 #include &quot;Rendering/InMapDraw.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
-#include &quot;System/Exceptions.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
+#include &quot;Exceptions.h&quot;
 
 extern std::string stupidGlobalMapname;
 
@@ -123,7 +123,7 @@
 
 void CLoadSaveHandler::SaveGame(std::string file)
 {
-	LoadStartPicture(gs-&gt;Team(gu-&gt;myTeam)-&gt;side);
+	LoadStartPicture(teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;side);
 	PrintLoadMsg(&quot;Saving game&quot;);
 	try {
 		std::ofstream ofs(filesystem.LocateFile(file, FileSystem::WRITE).c_str(), std::ios::out|std::ios::binary);
@@ -172,7 +172,7 @@
 	ReadString(*ifs, scriptText);
 	if (!scriptText.empty() &amp;&amp; !gameSetup) {
 		CGameSetup* temp = SAFE_NEW CGameSetup();
-		if (!temp-&gt;Init(scriptText.c_str(),scriptText.size())) {
+		if (!temp-&gt;Init(scriptText)) {
 			delete temp;
 			temp = 0;
 		} else {
@@ -188,7 +188,7 @@
 //this should be called on frame 0 when the game has started
 void CLoadSaveHandler::LoadGame()
 {
-	LoadStartPicture(gs-&gt;Team(gu-&gt;myTeam)-&gt;side);
+	LoadStartPicture(teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;side);
 	PrintLoadMsg(&quot;Loading game&quot;);
 	creg::CInputStreamSerializer inputStream;
 	void *pGSC = 0;
@@ -204,7 +204,7 @@
 	eoh-&gt;Load(ifs);
 	delete ifs;
 	for (int a=0;a&lt;MAX_TEAMS;a++) {//For old savegames
-		if (gs-&gt;Team(a)-&gt;isDead &amp;&amp; eoh-&gt;IsSkirmishAI(a)) {
+		if (teamHandler-&gt;Team(a)-&gt;isDead &amp;&amp; eoh-&gt;IsSkirmishAI(a)) {
 			eoh-&gt;DestroySkirmishAI(a);
 		}
 	}

Modified: branches/caiinterface/rts/System/LogOutput.cpp
===================================================================
--- branches/caiinterface/rts/System/LogOutput.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/LogOutput.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -15,7 +15,7 @@
 #include &quot;Util.h&quot;
 #include &quot;float3.h&quot;
 //#if !defined DEDICATED &amp;&amp; !defined BUILDING_AI &amp;&amp; !defined BUILDING_AI_INTERFACE
-#include &quot;Game/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
 //#endif	// !defined DEDICATED &amp;&amp; !defined BUILDING_AI &amp;&amp; !defined BUILDING_AI_INTERFACE
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;mmgr.h&quot;

Modified: branches/caiinterface/rts/System/Messages.cpp
===================================================================
--- branches/caiinterface/rts/System/Messages.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/Messages.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -14,7 +14,7 @@
 #include &quot;LogOutput.h&quot;
 #include &quot;Messages.h&quot;
 #include &quot;Lua/LuaParser.h&quot;
-#include &quot;System/Util.h&quot;
+#include &quot;Util.h&quot;
 
 using std::string;
 using std::vector;

Modified: branches/caiinterface/rts/System/MouseInput.cpp
===================================================================
--- branches/caiinterface/rts/System/MouseInput.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/MouseInput.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -17,7 +17,7 @@
 #include &lt;SDL_events.h&gt;
 #include &lt;SDL_syswm.h&gt;
 
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 #include &quot;Platform/Win/win32.h&quot;
 #include &quot;MouseInput.h&quot;
 #include &quot;LogOutput.h&quot;

Modified: branches/caiinterface/rts/System/Platform/ConfigHandler.cpp
===================================================================
--- branches/caiinterface/rts/System/Platform/ConfigHandler.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/Platform/ConfigHandler.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -21,47 +21,38 @@
 #include &quot;Game/GameVersion.h&quot;
 
 
-/**
- * @brief instance
- *
- * Default instantiation of ConfigHandler instance
- * is NULL.
- */
-#ifndef USE_GML // GML calls GetInstance() from a global scope and needs these to be initialized in gml.cpp instead to avoid crash
-ConfigHandler* ConfigHandler::instance = NULL;
-std::string ConfigHandler::configSource;
-#endif
+ConfigHandler* _configHandler;
 
+
 /**
- * Returns reference to the current platform's config class.
- * If none exists, create one.
+ * Instantiates a copy of the current platform's config class.
+ * Re-instantiates if the configHandler already existed.
  */
-ConfigHandler&amp; ConfigHandler::GetInstance()
+void ConfigHandler::Instantiate(std::string configSource)
 {
-	if (!instance) {
-		if (configSource.empty()) {
+	Deallocate();
+
+	if (configSource.empty()) {
 #ifdef _WIN32
-			configSource = &quot;Software\\SJ\\Spring&quot;;
-			std::string version(VERSION_STRING);
-			if (version.size()&gt;0 &amp;&amp; version[version.size()-1] == '+')
-				configSource += &quot; SVN&quot;;
+		configSource = &quot;Software\\SJ\\Spring&quot;;
+		const std::string version = SpringVersion::Get();
+		if (version.size()&gt;0 &amp;&amp; version[version.size()-1] == '+')
+			configSource += &quot; SVN&quot;;
 #elif defined(__APPLE__)
-			configSource = &quot;this string is not currently used&quot;;
+		configSource = &quot;this string is not currently used&quot;;
 #else
-			configSource = DotfileHandler::GetDefaultConfig();
+		configSource = DotfileHandler::GetDefaultConfig();
 #endif
-		}
+	}
 
 #ifdef _WIN32
-		instance = SAFE_NEW RegHandler(configSource);
+	_configHandler = SAFE_NEW RegHandler(configSource);
 #elif defined(__APPLE__)
-		PreInitMac();
-		instance = SAFE_NEW UserDefsHandler(); // Config path is based on bundle id
+	PreInitMac();
+	_configHandler = SAFE_NEW UserDefsHandler(); // Config path is based on bundle id
 #else
-		instance = SAFE_NEW DotfileHandler(configSource);
+	_configHandler = SAFE_NEW DotfileHandler(configSource);
 #endif
-	}
-	return *instance;
 }
 
 
@@ -70,9 +61,9 @@
  */
 void ConfigHandler::Deallocate()
 {
-	if (instance)
-		delete instance;
-	instance = 0;
+	// can not use SafeDelete because ~ConfigHandler is protected
+	delete _configHandler;
+	_configHandler = NULL;
 }
 
 
@@ -100,16 +91,3 @@
 
 	SetString(name, buffer.str());
 }
-
-
-bool ConfigHandler::SetConfigSource(const std::string&amp; source)
-{
-	configSource = source;
-	return true;
-}
-
-
-const std::string&amp; ConfigHandler::GetConfigSource()
-{
-	return configSource;
-}

Modified: branches/caiinterface/rts/System/Platform/ConfigHandler.h
===================================================================
--- branches/caiinterface/rts/System/Platform/ConfigHandler.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/Platform/ConfigHandler.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -2,7 +2,7 @@
  * @file ConfigHandler.h
  * @brief config base
  * @author Christopher Han &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">xiphux at gmail.com</A>&gt;
- * 
+ *
  * Definition of config structure class
  * Copyright (C) 2005.  Licensed under the terms of the
  * GNU GPL, v2 or later.
@@ -13,16 +13,8 @@
 #include &lt;string&gt;
 
 /**
- * @brief configHandler
- *
- * Just a shortcut to prevent having to replace
- * configHandler throughout the entire engine
- */
-#define configHandler (ConfigHandler::GetInstance())
-
-/**
  * @brief config handler base
- * 
+ *
  * This is the abstract configuration handler class used
  * for polymorphic configuration.  Platform-specifics should derive
  * from this.
@@ -59,7 +51,7 @@
 	 * @return integer value
 	 */
 	virtual int GetInt(std::string name, int def) = 0;
-	
+
 	/**
 	@brief get float value
 	*/
@@ -71,31 +63,22 @@
 	virtual void SetFloat(const std::string&amp; name, float value);
 
 	/**
-	 * @brief get instance
-	 * @return reference to current platform's ConfigHandler
+	 * @brief instantiate global configHandler
 	 */
-	static ConfigHandler&amp; GetInstance();
+	static void Instantiate(std::string configSource);
 
-	static bool SetConfigSource(const std::string&amp; name);
-	static const std::string&amp; GetConfigSource();
-
 	/**
 	 * @brief deallocate
 	 */
 	static void Deallocate();
 
+protected:
 	virtual ~ConfigHandler();
+};
 
-protected:
-	static std::string configSource;
+extern ConfigHandler* _configHandler;
 
-	/**
-	 * @brief instance
-	 *
-	 * ConfigHandler pointer pointing to current platform's
-	 * ConfigHandler instance
-	 */
-	static ConfigHandler* instance;
-};
+// quick hack so I don't have to change . to -&gt; in the entire project
+#define configHandler (*_configHandler)
 
 #endif /* CONFIGHANDLER_H */

Deleted: branches/caiinterface/rts/System/Platform/FileSystem.cpp
===================================================================
--- branches/caiinterface/rts/System/Platform/FileSystem.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/Platform/FileSystem.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,433 +0,0 @@
-/**
- * @file FileSystem.cpp
- * @brief Abstracts locating of content on different platforms
- * @author Tobi Vollebregt
- *
- * FindFiles implementation by Chris Han.
- * Glob conversion by Chris Han (based on work by Nathaniel Smith).
- * Copyright (C) 2005-2006.  Licensed under the terms of the
- * GNU GPL, v2 or later
- */
-
-#include &quot;StdAfx.h&quot;
-#include &lt;assert.h&gt;
-#include &lt;limits.h&gt;
-#include &lt;boost/regex.hpp&gt;
-#include &lt;fstream&gt;
-#include &lt;sys/stat.h&gt;
-#include &lt;sys/types.h&gt;
-#include &quot;FileSystem.h&quot;
-
-#ifdef WIN32
-#	include &quot;Win/WinFileSystemHandler.h&quot;
-#elif defined(__APPLE__)
-#	include &quot;Mac/MacFileSystemHandler.h&quot;
-#else
-#	include &quot;Linux/UnixFileSystemHandler.h&quot;
-#endif
-
-#include &quot;FileSystem/ArchiveScanner.h&quot;
-#include &quot;FileSystem/VFSHandler.h&quot;
-#include &quot;LogOutput.h&quot;
-#include &quot;Util.h&quot;
-#include &quot;mmgr.h&quot;
-
-
-#define fs (FileSystemHandler::GetInstance())
-
-FileSystem filesystem;
-
-
-////////////////////////////////////////
-////////// FileSystemHandler
-
-/**
- * @brief The global data directory handler instance
- */
-FileSystemHandler* FileSystemHandler::instance = NULL;
-
-/**
- * @brief get the data directory handler instance
- */
-FileSystemHandler&amp; FileSystemHandler::GetInstance()
-{
-	if (!instance)
-		Initialize(false);
-	return *instance;
-}
-
-/**
- * @brief initialize the data directory handler
- */
-void FileSystemHandler::Initialize(bool verbose)
-{
-	if (!instance) {
-		// FIXME this leaks memory
-#ifdef WIN32
-		instance = new UnixFileSystemHandler(verbose);
-#elif defined(__APPLE__)
-		instance = new MacFileSystemHandler(verbose);
-#else
-		instance = new UnixFileSystemHandler(verbose);
-#endif
-		try {
-			instance-&gt;Initialize();
-		}
-		catch (...) {
-			SafeDelete(instance);
-			throw;
-		}
-	}
-}
-
-void FileSystemHandler::Cleanup()
-{
-	SafeDelete(instance);
-}
-
-FileSystemHandler::~FileSystemHandler()
-{
-	SafeDelete(archiveScanner);
-	SafeDelete(vfsHandler);
-}
-
-FileSystemHandler::FileSystemHandler(int native_path_sep): native_path_separator(native_path_sep)
-{
-	// NOTE TO SELF: NEVER EVAR DO THIS AGAIN THIS WAY
-
-	// combined with init code in constructor and exceptions being thrown
-	// when this init code fails it results in dangling pointers.
-
-	// (if constructor throws exception object doesn't exist, by definition,
-	//  but global variable instance would still point to it....)
-
-//	// need to set this here already or we get stuck in an infinite loop
-//	// because WinFileSystemHandler/UnixFileSystemHandler ctor initializes the
-//	// ArchiveScanner (which uses FileSystemHandler::GetInstance again...).
-//	instance = this;
-}
-
-////////////////////////////////////////
-////////// FileSystem
-
-/**
- * @brief quote macro
- * @param c Character to test
- * @param str string currently being built
- *
- * Given a string str that we're assembling,
- * and an upcoming character c, will append
- * an extra '\\' to quote the character if necessary.
- */
-#define QUOTE(c,str)			\
-	do {					\
-		if (!(isalnum(c)||(c)=='_'))	\
-			str+='\\';		\
-		str+=c;				\
-} while (0)
-
-/**
- * @brief glob to regex
- * @param glob string containing glob
- * @return string containing regex
- *
- * Converts a glob expression to a regex
- */
-std::string FileSystem::glob_to_regex(const std::string&amp; glob) const
-{
-	std::string regex;
-	regex.reserve(glob.size()&lt;&lt;1);
-	int braces = 0;
-	for (std::string::const_iterator i = glob.begin(); i != glob.end(); ++i) {
-		char c = *i;
-#ifdef DEBUG
-		if (braces&gt;=5)
-			logOutput.Print(&quot;glob_to_regex warning: braces nested too deeply\n%s&quot;, glob.c_str());
-#endif
-		switch (c) {
-			case '*':
-				regex+=&quot;.*&quot;;
-				break;
-			case '?':
-				regex+='.';
-				break;
-			case '{':
-				braces++;
-				regex+='(';
-				break;
-			case '}':
-#ifdef DEBUG
-				if (!braces)
-					logOutput.Print(&quot;glob_to_regex warning: closing brace without an equivalent opening brace\n%s&quot;, glob.c_str());
-#endif
-				regex+=')';
-				braces--;
-				break;
-			case ',':
-				if (braces)
-					regex+='|';
-				else
-					QUOTE(c,regex);
-				break;
-			case '\\':
-#ifdef DEBUG
-				if (++i==glob.end())
-					logOutput.Print(&quot;glob_to_regex warning: pattern ends with backslash\n%s&quot;, glob.c_str());
-#else
-				++i;
-#endif
-				QUOTE(*i,regex);
-				break;
-			default:
-				QUOTE(c,regex);
-				break;
-		}
-	}
-#ifdef DEBUG
-	if (braces)
-		logOutput.Print(&quot;glob_to_regex warning: unterminated brace expression\n%s&quot;, glob.c_str());
-#endif
-	return regex;
-}
-
-/**
- * @brief get filesize
- *
- * @return the filesize or 0 if the file doesn't exist.
- */
-size_t FileSystem::GetFilesize(std::string file) const
-{
-	if (!CheckFile(file))
-		return 0;
-	FixSlashes(file);
-	struct stat info;
-	if (stat(file.c_str(), &amp;info) != 0)
-		return 0;
-	return info.st_size;
-}
-
-/**
- * @brief create a directory
- *
- * Works like mkdir -p, ie. attempts to create parent directories too.
- * Operates on the current working directory.
- */
-bool FileSystem::CreateDirectory(std::string dir) const
-{
-	if (!CheckFile(dir))
-		return false;
-
-	ForwardSlashes(dir);
-	size_t prev_slash = 0, slash;
-	while ((slash = dir.find('/', prev_slash + 1)) != std::string::npos) {
-		if (!fs.mkdir(dir.substr(0, slash)))
-			return false;
-		prev_slash = slash;
-	}
-	return fs.mkdir(dir);
-}
-
-
-/**
- * @brief find files
- *
- * Compiles a std::vector of all files below dir that match pattern.
- *
- * If FileSystem::RECURSE flag is set it recurses into subdirectories.
- * If FileSystem::INCLUDE_DIRS flag is set it includes directories in the
- * result too, as long as they match the pattern.
- *
- * Note that pattern doesn't apply to the names of recursed directories,
- * it does apply to the files inside though.
- */
-std::vector&lt;std::string&gt; FileSystem::FindFiles(std::string dir, const std::string&amp; pattern, int flags) const
-{
-	if (!CheckFile(dir)) {
-		return std::vector&lt;std::string&gt;();
-	}
-
-	if (dir.empty()) {
-		dir = &quot;./&quot;;
-	}
-	else {
-		const char lastChar = dir[dir.length() - 1];
-		if ((lastChar != '/') &amp;&amp; (lastChar != '\\')) {
-			dir += '/';
-		}
-	}
-
-	FixSlashes(dir);
-
-	if (flags &amp; ONLY_DIRS) {
-		flags |= INCLUDE_DIRS;
-	}
-
-	return fs.FindFiles(dir, pattern, flags);
-}
-
-
-/**
- * @brief get the directory part of a path
- */
-std::string FileSystem::GetDirectory(const std::string&amp; path) const
-{
-	size_t s = path.find_last_of('/');
-	size_t bs = path.find_last_of('\\');
-	if (s != std::string::npos &amp;&amp; bs != std::string::npos)
-		return path.substr(0, std::max(s, bs) + 1);
-	if (s != std::string::npos)
-		return path.substr(0, s + 1);
-	if (bs != std::string::npos)
-		return path.substr(0, bs + 1);
-	return path;
-}
-
-/**
- * @brief get the filename part of a path
- */
-std::string FileSystem::GetFilename(const std::string&amp; path) const
-{
-	size_t s = path.find_last_of('/');
-	size_t bs = path.find_last_of('\\');
-	if (s != std::string::npos &amp;&amp; bs != std::string::npos)
-		return path.substr(std::max(s, bs) + 1);
-	if (s != std::string::npos)
-		return path.substr(s + 1);
-	if (bs != std::string::npos)
-		return path.substr(bs + 1);
-	return path;
-}
-
-/**
- * @brief get the basename part of a path, ie. the filename without extension
- */
-std::string FileSystem::GetBasename(const std::string&amp; path) const
-{
-	std::string fn = GetFilename(path);
-	size_t dot = fn.find_last_of('.');
-	if (dot != std::string::npos)
-		return fn.substr(0, dot);
-	return fn;
-}
-
-/**
- * @brief get the extension of the filename part of the path
- */
-std::string FileSystem::GetExtension(const std::string&amp; path) const
-{
-	std::string fn = GetFilename(path);
-	size_t dot = fn.find_last_of('.');
-	if (dot != std::string::npos)
-		return fn.substr(dot + 1);
-	return &quot;&quot;;
-}
-
-/**
- * @brief converts all slashes and backslashes in path to the native_path_separator
- */
-std::string&amp; FileSystem::FixSlashes(std::string&amp; path) const
-{
-	int sep = fs.GetNativePathSeparator();
-	for (unsigned i = 0; i &lt; path.size(); ++i)
-		if (path[i] == '/' || path[i] == '\\')
-			path[i] = sep;
-	return path;
-}
-
-/**
- * @brief converts backslashes in path to forward slashes
- */
-std::string&amp; FileSystem::ForwardSlashes(std::string&amp; path) const
-{
-	for (unsigned i = 0; i &lt; path.size(); ++i)
-		if (path[i] == '\\')
-			path[i] = '/';
-	return path;
-}
-
-/**
- * @brief does a little checking of a filename
- */
-bool FileSystem::CheckFile(const std::string&amp; file) const
-{
-	// Don't allow code to escape from the data directories.
-	// Note: this does NOT mean this is a SAFE fopen function:
-	// symlink-, hardlink-, you name it-attacks are all very well possible.
-	// The check is just ment to &quot;enforce&quot; certain coding behaviour.
-	if (file.find(&quot;..&quot;) != std::string::npos)
-		return false;
-
-	return true;
-}
-
-/**
- * @brief does a little checking of a modestring
- */
-bool FileSystem::CheckMode(const char* mode) const
-{
-	assert(mode &amp;&amp; *mode);
-	return true;
-}
-
-/**
- * @brief locate a file
- *
- * Attempts to locate a file.
- *
- * If the FileSystem::WRITE flag is set, it just returns the argument
- * (assuming the file should come in the current working directory).
- * If FileSystem::CREATE_DIRS is set it tries to create the subdirectory
- * the file should live in.
- *
- * Otherwise (if flags == 0), it dispatches the call to
- * FileSystemHandler::LocateFile(), which either searches for it in multiple
- * data directories (UNIX) or just returns the argument (Windows).
- */
-std::string FileSystem::LocateFile(std::string file, int flags) const
-{
-	if (!CheckFile(file)) {
-		return &quot;&quot;;
-	}
-
-	FixSlashes(file);
-
-	if (flags &amp; WRITE) {
-		if (flags &amp; CREATE_DIRS) {
-			CreateDirectory(GetDirectory(file));
-		}
-		return file;
-	}
-
-	return fs.LocateFile(file);
-}
-
-
-bool FileSystem::InReadDir(const std::string&amp; path)
-{
-	if (path.find(&quot;..&quot;) != std::string::npos) {
-		return false; // realpath() would be nice
-	}
-	const std::vector&lt;std::string&gt; readDirs = fs.GetDataDirectories();
-	return true;
-}
-
-
-bool FileSystem::InWriteDir(const std::string&amp; path, const std::string&amp; prefix)
-{
-	const std::string writeDir = fs.GetWriteDir();
-	return true;
-}
-
-
-/**
- * @brief remove a file
- *
- * Operates on the current working directory.
- */
-bool FileSystem::Remove(std::string file) const
-{
-	if (!CheckFile(file))
-		return false;
-	FixSlashes(file);
-	return ::remove(file.c_str()) == 0;
-}

Deleted: branches/caiinterface/rts/System/Platform/FileSystem.h
===================================================================
--- branches/caiinterface/rts/System/Platform/FileSystem.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/Platform/FileSystem.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,113 +0,0 @@
-/**
- * @file FileSystem.h
- * @brief Abstracts locating of content on different platforms
- * @author Tobi Vollebregt
- *
- * Copyright (C) 2006.  Licensed under the terms of the
- * GNU GPL, v2 or later
- */
-
-#ifndef FILESYSTEM_H
-#define FILESYSTEM_H
-
-#include &lt;vector&gt;
-#include &lt;string&gt;
-
-// winapi redifines this which breaks things
-#if defined(CreateDirectory)
-# undef CreateDirectory
-#endif
-
-/**
- * @brief native file system handling abstraction
- */
-class FileSystemHandler
-{
-	public:
-
-		static FileSystemHandler&amp; GetInstance();
-		static void Initialize(bool verbose);
-		static void Cleanup();
-
-		virtual ~FileSystemHandler();
-		FileSystemHandler(int native_path_sep = '/');
-		virtual void Initialize() = 0;
-
-		// almost direct wrappers to system calls
-		virtual bool mkdir(const std::string&amp; dir) const = 0;
-
-		// custom functions
-		virtual std::vector&lt;std::string&gt; FindFiles(const std::string&amp; dir, const std::string&amp; pattern, int flags) const = 0;
-		virtual std::string LocateFile(const std::string&amp; file) const = 0;
-		virtual std::string GetWriteDir() const = 0;
-		virtual std::vector&lt;std::string&gt; GetDataDirectories() const = 0;
-
-		int GetNativePathSeparator() const { return native_path_separator; }
-
-	protected:
-
-		static FileSystemHandler* instance;
-
-		const int native_path_separator;
-};
-
-/**
- * @brief filesystem interface
- *
- * Use this from the rest of the spring code!
- */
-class FileSystem
-{
-	public:
-		// flags for FindFiles
-		enum FindFilesBits {
-			RECURSE      = (1 &lt;&lt; 0),
-			INCLUDE_DIRS = (1 &lt;&lt; 1),
-			ONLY_DIRS    = (1 &lt;&lt; 2),
-		};
-		// flags for LocateFile
-		enum LocateFileBits {
-			WRITE       = (1 &lt;&lt; 0),
-			CREATE_DIRS = (1 &lt;&lt; 1),
-		};
-
-	public:
-		FileSystem() {}
-
-		// generic functions
-		std::string LocateFile(std::string file, int flags = 0) const;
-		bool Remove(std::string file) const;
-
-		// metadata read functions
-		size_t GetFilesize(std::string path) const;
-
-		// directory functions
-		bool CreateDirectory(std::string dir) const;
-		std::vector&lt;std::string&gt; FindFiles(std::string dir, const std::string&amp; pattern, int flags = 0) const;
-
-		// convenience functions
-		std::string GetDirectory (const std::string&amp; path) const;
-		std::string GetFilename  (const std::string&amp; path) const;
-		std::string GetBasename  (const std::string&amp; path) const;
-		std::string GetExtension (const std::string&amp; path) const;
-		std::string glob_to_regex(const std::string&amp; glob) const;
-		std::string&amp; FixSlashes  (std::string&amp; path) const;
-		std::string&amp; ForwardSlashes(std::string&amp; path) const;
-
-		// access check functions
-		bool InReadDir(const std::string&amp; path);
-		bool InWriteDir(const std::string&amp; path, const std::string&amp; prefix = &quot;&quot;);
-
-	private:
-		bool CheckFile(const std::string&amp; file) const;
-		bool CheckDir(const std::string&amp; dir) const;
-		bool CheckMode(const char* mode) const;
-
-		FileSystem(const FileSystem&amp;);
-		FileSystem&amp; operator=(const FileSystem&amp;);
-};
-
-// basically acts like a namespace, but with semantics like configHandler has
-extern FileSystem filesystem;
-
-#endif // !FILESYSTEM_H

Deleted: branches/caiinterface/rts/System/Platform/Linux/DataDirLocater.cpp
===================================================================
--- branches/caiinterface/rts/System/Platform/Linux/DataDirLocater.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/Platform/Linux/DataDirLocater.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,335 +0,0 @@
-/**
- * @file DataDirLocater.cpp
- * @author Tobi Vollebregt
- *
- * Copyright (C) 2006-2008 Tobi Vollebregt
- * Licensed under the terms of the GNU GPL, v2 or later
- */
-
-#include &quot;StdAfx.h&quot;
-#include &quot;DataDirLocater.h&quot;
-
-#include &lt;cstdlib&gt;
-#ifdef WIN32
-	#include &lt;io.h&gt;
-  #include &lt;direct.h&gt;
-  #include &lt;windows.h&gt;
-	#include &lt;shlobj.h&gt;
-	#include &lt;shlwapi.h&gt;
-	#ifndef SHGFP_TYPE_CURRENT
-		#define SHGFP_TYPE_CURRENT 0
-	#endif
-#endif
-#include &lt;sstream&gt;
-#include &lt;string.h&gt;
-#include &quot;System/FileSystem/VFSHandler.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/Platform/ConfigHandler.h&quot;
-#include &quot;System/Platform/FileSystem.h&quot;
-#include &quot;mmgr.h&quot;
-#include &quot;Exceptions.h&quot;
-
-/**
- * @brief construct a data directory object
- *
- * Appends a slash to the end of the path if there isn't one already.
- */
-DataDir::DataDir(const std::string&amp; p) : path(p), writable(false)
-{
-#ifndef _WIN32
-	if (path.empty())
-		path = &quot;./&quot;;
-	if (path[path.size() - 1] != '/')
-		path += '/';
-#else
-	if (path.empty())
-		path = &quot;.\\&quot;;
-	if (path[path.size() - 1] != '\\')
-		path += '\\';
-#endif
-}
-
-/**
- * @brief construct a data directory locater
- *
- * Does not locate data directories, use LocateDataDirs() for that.
- */
-DataDirLocater::DataDirLocater() : writedir(NULL)
-{
-}
-
-/**
- * @brief substitute environment variables with their values
- */
-std::string DataDirLocater::SubstEnvVars(const std::string&amp; in) const
-{
-	bool escape = false;
-	std::ostringstream out;
-	for (std::string::const_iterator ch = in.begin(); ch != in.end(); ++ch) {
-		if (escape) {
-			escape = false;
-			out &lt;&lt; *ch;
-		} else {
-			switch (*ch) {
-#ifndef _WIN32
-				case '\\': {
-					escape = true;
-					break;
-				}
-#endif
-				case '$': {
-					std::ostringstream envvar;
-					for (++ch; ch != in.end() &amp;&amp; (isalnum(*ch) || *ch == '_'); ++ch)
-						envvar &lt;&lt; *ch;
-					--ch;
-					char* subst = getenv(envvar.str().c_str());
-					if (subst &amp;&amp; *subst)
-						out &lt;&lt; subst;
-					break;
-				}
-				default: {
-					out &lt;&lt; *ch;
-					break;
-				}
-			}
-		}
-	}
-	return out.str();
-}
-
-/**
- * @brief Adds the directories in the colon separated string to the datadir handler.
- */
-void DataDirLocater::AddDirs(const std::string&amp; in)
-{
-	size_t prev_colon = 0, colon;
-#ifndef _WIN32
-	while ((colon = in.find(':', prev_colon)) != std::string::npos) {
-#else
-	while ((colon = in.find(';', prev_colon)) != std::string::npos) {
-#endif
-		datadirs.push_back(in.substr(prev_colon, colon - prev_colon));
-#ifdef DEBUG
-		logOutput.Print(&quot;Adding %s to directories&quot; , in.substr(prev_colon, colon - prev_colon).c_str());
-#endif
-		prev_colon = colon + 1;
-	}
-#ifdef DEBUG
-	logOutput.Print(&quot;Adding %s to directories&quot; , in.substr(prev_colon).c_str());
-#endif
-	datadirs.push_back(in.substr(prev_colon));
-}
-
-/**
- * @brief Figure out permissions we have for a single data directory d.
- * @returns whether we have permissions to read the data directory.
- */
-bool DataDirLocater::DeterminePermissions(DataDir* d)
-{
-#ifndef _WIN32
-	if (d-&gt;path.c_str()[0] != '/' || d-&gt;path.find(&quot;..&quot;) != std::string::npos)
-#else
-	if (d-&gt;path.find(&quot;..&quot;) != std::string::npos)
-#endif
-		throw content_error(&quot;specify data directories using absolute paths please&quot;);
-	// Figure out whether we have read/write permissions
-	// First check read access, if we got that check write access too
-	// (no support for write-only directories)
-	// Note: we check for executable bit otherwise we can't browse the directory
-	// Note: we fail to test whether the path actually is a directory
-	// Note: modifying permissions while or after this function runs has undefined behaviour
-#ifndef _WIN32
-	if (access(d-&gt;path.c_str(), R_OK | X_OK | F_OK) == 0) {
-		// Note: disallow multiple write directories.
-		// There isn't really a use for it as every thing is written to the first one anyway,
-		// and it may give funny effects on errors, e.g. it probably only gives funny things
-		// like network mounted datadir lost connection and suddenly files end up in some
-		// other random writedir you didn't even remember you had added it.
-		if (!writedir &amp;&amp; access(d-&gt;path.c_str(), W_OK) == 0) {
-#else
-	if (_access(d-&gt;path.c_str(), 4) == 0) {
-		if (!writedir &amp;&amp; _access(d-&gt;path.c_str(), 2) == 0) {
-#endif
-			d-&gt;writable = true;
-			writedir = &amp;*d;
-		}
-		return true;
-	} else {
-		if (filesystem.CreateDirectory(d-&gt;path)) {
-			// it didn't exist before, now it does and we just created it with rw access,
-			// so we just assume we still have read-write acces...
-			if (!writedir) {
-				d-&gt;writable = true;
-				writedir = d;
-			}
-			return true;
-		}
-	}
-	return false;
-}
-
-/**
- * @brief Figure out permissions we have for the data directories.
- */
-void DataDirLocater::DeterminePermissions()
-{
-	std::vector&lt;DataDir&gt; newDatadirs;
-	std::string previous; // used to filter out consecutive duplicates
-	// (I didn't bother filtering out non-consecutive duplicates because then
-	//  there is the question which of the multiple instances to purge.)
-
-	writedir = NULL;
-
-	for (std::vector&lt;DataDir&gt;::iterator d = datadirs.begin(); d != datadirs.end(); ++d) {
-		if (d-&gt;path != previous &amp;&amp; DeterminePermissions(&amp;*d)) {
-			newDatadirs.push_back(*d);
-			previous = d-&gt;path;
-		}
-	}
-
-	datadirs = newDatadirs;
-}
-
-/**
- * @brief locate spring data directory
- *
- * On *nix platforms, attempts to locate
- * and change to the spring data directory
- *
- * In Unixes, the data directory to chdir to is determined by the following, in this
- * order (first items override lower items):
- *
- * - 'SPRING_DATADIR' environment variable. (colon separated list, like PATH)
- * - 'SpringData=/path/to/data' declaration in '~/.springrc'. (colon separated list)
- * - &quot;$HOME/.spring&quot;
- * - In the same order any line in '/etc/spring/datadir', if that file exists.
- * - 'datadir=/path/to/data' option passed to 'scons configure'.
- * - 'prefix=/install/path' option passed to scons configure. The datadir is
- *   assumed to be at '$prefix/games/spring' in this case.
- * - the default datadirs in the default prefix, ie. '/usr/local/games/spring'
- *   (This is set by the build system, ie. SPRING_DATADIR and SPRING_DATADIR_2
- *   preprocessor definitions.)
- *
- * In Windows, its:
- * - SPRING_DATADIR env-variable
- * - user configurable (SpringData in registry)
- * - location of the binary dir (like it has been until 0.76b1)
- * - the Users 'Documents'-directory (in subdirectory Spring), unless spring is configured to use another
- * - all users app-data (in subdirectory Spring)
- * - compiler flags SPRING_DATADIR and SPRING_DATADIR_2
- *
- * All of the above methods support environment variable substitution, eg.
- * '$HOME/myspringdatadir' will be converted by spring to something like
- * '/home/username/myspringdatadir'.
- *
- * If it fails to chdir to the above specified directory spring will asume the
- * current working directory is the data directory.
- */
-void DataDirLocater::LocateDataDirs()
-{
-	// Construct the list of datadirs from various sources.
-	datadirs.clear();
-
-	// environment variable
-	char* env = getenv(&quot;SPRING_DATADIR&quot;);
-	if (env &amp;&amp; *env)
-		AddDirs(SubstEnvVars(env));
-
-	// user defined (in spring config handler (Linux: ~/.springrc, Windows: registry))
-	#if !defined WIN32 || !(defined BUILDING_AI || defined BUILDING_AI_INTERFACE)
-	std::string userDef = configHandler.GetString(&quot;SpringData&quot;, &quot;&quot;);
-	if (!userDef.empty()) {
-		AddDirs(SubstEnvVars(userDef));
-	}
-	#endif	/* !defined WIN32 || !(defined BUILDING_AI || defined BUILDING_AI_INTERFACE) */
-
-#ifdef WIN32
-	TCHAR currentDir[MAX_PATH];
-	::GetCurrentDirectory(sizeof(currentDir) - 1, currentDir);
-	std::string curPath = currentDir;
-	AddDirs(std::string(currentDir));
-
-	// my documents
-	TCHAR strPath[MAX_PATH];
-	SHGetFolderPath( NULL, CSIDL_PERSONAL, NULL, SHGFP_TYPE_CURRENT, strPath);
-	std::string cfg = strPath;
-	cfg += &quot;\\Spring&quot;; // e.g. F:\Dokumente und Einstellungen\Karl-Robert\Eigene Dateien\Spring
-	AddDirs(cfg);
-	cfg.clear();
-
-	// appdata
-	SHGetFolderPath( NULL, CSIDL_COMMON_APPDATA, NULL, SHGFP_TYPE_CURRENT, strPath);
-	cfg = strPath;
-	cfg += &quot;\\Spring&quot;; // e.g. F:\Dokumente und Einstellungen\All Users\Anwendungsdaten\Spring
-	AddDirs(cfg);
-#else
-	// home
-	AddDirs(SubstEnvVars(&quot;$HOME/.spring&quot;));
-
-	// settings in /etc
-	FILE* f = ::fopen(&quot;/etc/spring/datadir&quot;, &quot;r&quot;);
-	if (f) {
-		char buf[1024];
-		while (fgets(buf, sizeof(buf), f)) {
-			char* newl = strchr(buf, '\n');
-			if (newl)
-				*newl = 0;
-			char white[3] = {'\t', ' ', 0};
-			if (strlen(buf) &gt; 0 &amp;&amp; strspn(buf, white) != strlen(buf)) // don't count lines of whitespaces / tabulators
-				AddDirs(SubstEnvVars(buf));
-		}
-		fclose(f);
-	}
-#endif
-
-	// compiler flags
-#ifdef SPRING_DATADIR
-	datadirs.push_back(SubstEnvVars(SPRING_DATADIR));
-#endif
-	// should not be needed because you can seperate directories with a ':' in SPRING_DATADIR(1)
-#ifdef SPRING_DATADIR_2
-	datadirs.push_back(SubstEnvVars(SPRING_DATADIR_2));
-#endif
-
-	// Figure out permissions of all datadirs
-	DeterminePermissions();
-
-	if (!writedir) {
-		// bail out
-#ifdef WIN32
-		const std::string errstr = &quot;Not a single writable data directory found!\n\n&quot;
-				&quot;Configure a writable data directory using either:\n&quot;
-				&quot;- the SPRING_DATADIR environment variable,\n&quot;
-				&quot;- a SpringData=C:/path/to/data declaration in spring's registry entry or\n&quot;
-				&quot;- by giving you write access to the installation directory&quot;;
-#else
-		const std::string errstr = &quot;Not a single writable data directory found!\n\n&quot;
-				&quot;Configure a writable data directory using either:\n&quot;
-				&quot;- the SPRING_DATADIR environment variable,\n&quot;
-				&quot;- a SpringData=/path/to/data declaration in ~/.springrc or\n&quot;
-				&quot;- the configuration file /etc/spring/datadir&quot;;
-#endif
-		throw content_error(errstr);
-	}
-
-	// for now, chdir to the datadirectory as a safety measure:
-	// all AIs still just assume it's ok to put their stuff in the current directory after all
-	// Not only safety anymore, it's just easier if other code can safely assume that
-	// writedir == current working directory
-#ifndef _WIN32
-	chdir(GetWriteDir()-&gt;path.c_str());
-#else
-	_chdir(GetWriteDir()-&gt;path.c_str());
-#endif
-	// Initialize the log. Only after this moment log will be written to file.
-	logOutput.Initialize();
-	// Logging MAY NOT start before the chdir, otherwise the logfile ends up
-	// in the wrong directory.
-	// Update: now it actually may start before, log has preInitLog.
-	for (std::vector&lt;DataDir&gt;::const_iterator d = datadirs.begin(); d != datadirs.end(); ++d) {
-		if (d-&gt;writable)
-			logOutput.Print(&quot;Using read-write data directory: %s&quot;, d-&gt;path.c_str());
-		else
-			logOutput.Print(&quot;Using read-only  data directory: %s&quot;, d-&gt;path.c_str());
-	}
-}

Deleted: branches/caiinterface/rts/System/Platform/Linux/DataDirLocater.h
===================================================================
--- branches/caiinterface/rts/System/Platform/Linux/DataDirLocater.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/Platform/Linux/DataDirLocater.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,40 +0,0 @@
-/**
- * @file DataDirLocater.h
- * @author Tobi Vollebregt
- *
- * Copyright (C) 2006-2008 Tobi Vollebregt
- * Licensed under the terms of the GNU GPL, v2 or later
- */
-#ifndef DATADIRLOCATER_H
-#define DATADIRLOCATER_H
-
-#include &lt;string&gt;
-#include &lt;vector&gt;
-
-struct DataDir
-{
-	DataDir(const std::string&amp; p);
-	std::string path;
-	bool writable;
-};
-
-class DataDirLocater
-{
-public:
-	DataDirLocater();
-	void LocateDataDirs();
-
-	const std::vector&lt;DataDir&gt;&amp; GetDataDirs() const { return datadirs; }
-	const DataDir* GetWriteDir() const { return writedir; }
-
-private:
-	std::string SubstEnvVars(const std::string&amp; in) const;
-	void AddDirs(const std::string&amp; in);
-	bool DeterminePermissions(DataDir* d);
-	void DeterminePermissions();
-
-	std::vector&lt;DataDir&gt; datadirs;
-	const DataDir* writedir;
-};
-
-#endif // !defined(DATADIRLOCATER_H)

Modified: branches/caiinterface/rts/System/Platform/Linux/DotfileHandler.cpp
===================================================================
--- branches/caiinterface/rts/System/Platform/Linux/DotfileHandler.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/Platform/Linux/DotfileHandler.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -228,7 +228,7 @@
 	const string home = getenv(&quot;HOME&quot;);
 
 	const string defCfg = home + &quot;/&quot; + base;
-	const string verCfg = defCfg + &quot;-&quot; + string(VERSION_STRING);
+	const string verCfg = defCfg + &quot;-&quot; + SpringVersion::Get();
 
 	string cfg;
 

Modified: branches/caiinterface/rts/System/Platform/Linux/OggStream.cpp
===================================================================
--- branches/caiinterface/rts/System/Platform/Linux/OggStream.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/Platform/Linux/OggStream.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -78,10 +78,17 @@
 	}
 }
 
+
+unsigned int COggStream::GetTotalTime() {
+	return ov_time_total(&amp;oggStream,-1);
+}
+
+
 // display Ogg info and comments
 void COggStream::DisplayInfo() {
 	logOutput.Print(&quot;version:           %d&quot;, vorbisInfo-&gt;version);
 	logOutput.Print(&quot;channels:          %d&quot;, vorbisInfo-&gt;channels);
+	logOutput.Print(&quot;time (sec):        %lf&quot;, ov_time_total(&amp;oggStream,-1));
 	logOutput.Print(&quot;rate (Hz):         %ld&quot;, vorbisInfo-&gt;rate);
 	logOutput.Print(&quot;bitrate (upper):   %ld&quot;, vorbisInfo-&gt;bitrate_upper);
 	logOutput.Print(&quot;bitrate (nominal): %ld&quot;, vorbisInfo-&gt;bitrate_nominal);

Modified: branches/caiinterface/rts/System/Platform/Linux/OggStream.h
===================================================================
--- branches/caiinterface/rts/System/Platform/Linux/OggStream.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/Platform/Linux/OggStream.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -18,7 +18,8 @@
 		void Stop();
 		void TogglePause();
 		void Update();
-		unsigned int GetPlayTime() const { return ((!stopped)? secsPlayed: 0); }
+		unsigned int GetPlayTime() const { return ((stopped)? 0 : secsPlayed); }
+		unsigned int GetTotalTime();
 		void SetVolume(float, bool b = false);
 
     private:

Modified: branches/caiinterface/rts/System/Platform/Linux/OpenALSound.cpp
===================================================================
--- branches/caiinterface/rts/System/Platform/Linux/OpenALSound.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/Platform/Linux/OpenALSound.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -5,6 +5,8 @@
 #include &quot;StdAfx.h&quot;
 #include &quot;Sound.h&quot;
 
+#include &lt;AL/alc.h&gt;
+
 #include &quot;LogOutput.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;Game/Camera.h&quot;
@@ -16,7 +18,7 @@
 #include &quot;OpenALSound.h&quot;
 #include &quot;OggStream.h&quot;
 #include &quot;mmgr.h&quot;
-#include &quot;System/Exceptions.h&quot;
+#include &quot;Exceptions.h&quot;
 
 // Ogg-Vorbis audio stream object
 COggStream oggStream;
@@ -78,7 +80,7 @@
 		alDeleteBuffers(1, &amp;it-&gt;second);
 	}
 	ALCcontext *curcontext = alcGetCurrentContext();
-	ALCdevice *curdevice = alcGetContextsDevice(curcontext);
+	//ALCdevice *curdevice = alcGetContextsDevice(curcontext);
 	alcSuspendContext(curcontext);
 	/*
 	 * FIXME
@@ -165,7 +167,8 @@
 
 void COpenALSound::StopStream() { oggStream.Stop(); }
 void COpenALSound::PauseStream() { oggStream.TogglePause(); }
-unsigned int COpenALSound::GetStreamTime() { return oggStream.GetPlayTime(); }
+unsigned int COpenALSound::GetStreamTime() { return oggStream.GetTotalTime(); }
+unsigned int COpenALSound::GetStreamPlayTime() { return oggStream.GetPlayTime(); }
 void COpenALSound::SetStreamVolume(float v) { oggStream.SetVolume(v); }
 
 
@@ -352,7 +355,7 @@
 
 	if (header-&gt;datalen &gt; size - sizeof(WAVHeader)) {
 //		logOutput.Print(&quot;\n&quot;);
-		logOutput.Print(&quot;OpenAL: %s has data length %d greater than actual data length %d\n&quot;,
+		logOutput.Print(&quot;OpenAL: %s has data length %d greater than actual data length %ld\n&quot;,
 			name, header-&gt;datalen, size - sizeof(WAVHeader));
 //		logOutput.Print(&quot;OpenAL: size %d\n&quot;, size);
 //		logOutput.Print(&quot;OpenAL: sizeof(WAVHeader) %d\n&quot;, sizeof(WAVHeader));

Modified: branches/caiinterface/rts/System/Platform/Linux/OpenALSound.h
===================================================================
--- branches/caiinterface/rts/System/Platform/Linux/OpenALSound.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/Platform/Linux/OpenALSound.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -5,12 +5,9 @@
 #include &quot;Sound.h&quot;
 
 #include &lt;map&gt;
-#include &lt;vector&gt;
 #include &lt;AL/al.h&gt;
-#include &lt;AL/alc.h&gt;
 #include &quot;SDL_types.h&quot;
 
-
 class COpenALSound: public CSound
 {
 public:
@@ -24,6 +21,7 @@
 	void StopStream();
 	void PauseStream();
 	unsigned int GetStreamTime();
+	unsigned int GetStreamPlayTime();
 	void SetStreamVolume(float);
 
 	void SetVolume(float v);

Deleted: branches/caiinterface/rts/System/Platform/Linux/UnixFileSystemHandler.cpp
===================================================================
--- branches/caiinterface/rts/System/Platform/Linux/UnixFileSystemHandler.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/Platform/Linux/UnixFileSystemHandler.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,312 +0,0 @@
-/**
- * @file UnixFileSystemHandler.cpp
- * @brief Abstracts locating of content on different platforms
- * @author Tobi Vollebregt
- *
- * Linux and Windows implementation, supporting multiple data directories / search paths.
- *
- * Copyright (C) 2006-2008 Tobi Vollebregt.
- * Licensed under the terms of the GNU GPL, v2 or later
- */
-
-#include &quot;UnixFileSystemHandler.h&quot;
-#include &lt;limits.h&gt;
-#include &lt;boost/regex.hpp&gt;
-#include &lt;sys/stat.h&gt;
-#include &lt;sys/types.h&gt;
-#ifndef _WIN32
-#include &lt;dirent.h&gt;
-#include &lt;sstream&gt;
-#include &lt;unistd.h&gt;
-#else
-#include &lt;windows.h&gt;
-#include &lt;io.h&gt;
-#include &lt;direct.h&gt;
-#endif
-#include &quot;System/FileSystem/ArchiveScanner.h&quot;
-#include &quot;System/FileSystem/VFSHandler.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/Platform/ConfigHandler.h&quot;
-#include &quot;mmgr.h&quot;
-
-/**
- * @brief Creates the archive scanner and vfs handler
- *
- * For the archiveScanner, it keeps cache data (&quot;archivecache.txt&quot;) in the
- * writedir. Cache data in other directories is ignored.
- * It scans maps, base and mods subdirectories of all readable datadirs
- * for archives. Archives in higher priority datadirs override archives
- * in lower priority datadirs.
- *
- * Note that the archive namespace is global, ie. each archive basename may
- * only occur once in all data directories. If a name is found more then once,
- * then higher priority datadirs override lower priority datadirs and per
- * datadir the 'mods' subdir overrides 'base' which overrides 'maps'.
- */
-void UnixFileSystemHandler::InitVFS() const
-{
-	const DataDir* writedir = locater.GetWriteDir();
-	const std::vector&lt;DataDir&gt;&amp; datadirs = locater.GetDataDirs();
-
-	archiveScanner = new CArchiveScanner();
-
-	archiveScanner-&gt;ReadCacheData(writedir-&gt;path + archiveScanner-&gt;GetFilename());
-
-	std::vector&lt;std::string&gt; scanDirs;
-	for (std::vector&lt;DataDir&gt;::const_reverse_iterator d = datadirs.rbegin(); d != datadirs.rend(); ++d) {
-		scanDirs.push_back(d-&gt;path + &quot;maps&quot;);
-		scanDirs.push_back(d-&gt;path + &quot;base&quot;);
-		scanDirs.push_back(d-&gt;path + &quot;mods&quot;);
-	}
-	archiveScanner-&gt;ScanDirs(scanDirs, true);
-
-	archiveScanner-&gt;WriteCacheData(writedir-&gt;path + archiveScanner-&gt;GetFilename());
-
-	vfsHandler = new CVFSHandler();
-}
-
-
-/**
- * @brief Creates the archive scanner and vfs handler
- *
- * Locates data directories and initializes the VFS.
- */
-UnixFileSystemHandler::UnixFileSystemHandler(bool verbose) :
-#ifndef _WIN32
-		FileSystemHandler('/')
-#else
-		FileSystemHandler('\\')
-#endif
-{
-}
-
-
-void UnixFileSystemHandler::Initialize()
-{
-	locater.LocateDataDirs();
-	InitVFS();
-}
-
-
-UnixFileSystemHandler::~UnixFileSystemHandler()
-{
-	configHandler.Deallocate();
-}
-
-
-/**
- * @brief returns the highest priority writable directory, aka the writedir
- */
-std::string UnixFileSystemHandler::GetWriteDir() const
-{
-	const DataDir* writedir = locater.GetWriteDir();
-	assert(writedir &amp;&amp; writedir-&gt;writable); // duh
-	return writedir-&gt;path;
-}
-
-
-/**
- * @brief find files
- * @param dir path in which to start looking (tried relative to each data directory)
- * @param pattern pattern to search for
- * @param recurse whether or not to recursively search
- * @param include_dirs whether or not to include directory names in the result
- * @return vector of std::strings containing absolute paths to the files
- *
- * Will search for a file given a particular pattern.
- * Starts from dirpath, descending down if recurse is true.
- */
-std::vector&lt;std::string&gt; UnixFileSystemHandler::FindFiles(const std::string&amp; dir, const std::string&amp; pattern, int flags) const
-{
-	std::vector&lt;std::string&gt; matches;
-
-	// if it's an absolute path, don't look for it in the data directories
-	if ((dir[0] == '/') || ((dir.length() &gt; 1) &amp;&amp; (dir[1] == ':'))) {
-		FindFilesSingleDir(matches, dir, pattern, flags);
-		return matches;
-	}
-
-	const std::vector&lt;DataDir&gt;&amp; datadirs = locater.GetDataDirs();
-	for (std::vector&lt;DataDir&gt;::const_reverse_iterator d = datadirs.rbegin(); d != datadirs.rend(); ++d) {
-		FindFilesSingleDir(matches, d-&gt;path + dir, pattern, flags);
-	}
-	return matches;
-}
-
-
-std::string UnixFileSystemHandler::LocateFile(const std::string&amp; file) const
-{
-	// if it's an absolute path, don't look for it in the data directories
-#ifdef WIN32
-	if ((file.length() &gt; 1) &amp;&amp; (file[1] == ':')) {
-		return file;
-	}
-
-	const std::vector&lt;DataDir&gt;&amp; datadirs = locater.GetDataDirs();
-	for (std::vector&lt;DataDir&gt;::const_iterator d = datadirs.begin(); d != datadirs.end(); ++d) {
-		std::string fn(d-&gt;path + file);
-		if (_access(fn.c_str(), 4) == 0) {
-			return fn;
-		}
-	}
-	return file;
-#else
-	if (file[0] == '/') {
-		return file;
-	}
-
-	const std::vector&lt;DataDir&gt;&amp; datadirs = locater.GetDataDirs();
-	for (std::vector&lt;DataDir&gt;::const_iterator d = datadirs.begin(); d != datadirs.end(); ++d) {
-		std::string fn(d-&gt;path + file);
-		if (access(fn.c_str(), R_OK | F_OK) == 0) {
-			return fn;
-		}
-	}
-	return file;
-#endif
-}
-
-
-std::vector&lt;std::string&gt; UnixFileSystemHandler::GetDataDirectories() const
-{
-	std::vector&lt;std::string&gt; f;
-
-	const std::vector&lt;DataDir&gt;&amp; datadirs = locater.GetDataDirs();
-	for (std::vector&lt;DataDir&gt;::const_iterator d = datadirs.begin(); d != datadirs.end(); ++d) {
-		f.push_back(d-&gt;path);
-	}
-	return f;
-}
-
-
-/**
- * @brief creates a rwxr-xr-x dir in the writedir
- *
- * Returns true if the postcondition of this function is that dir exists in
- * the write directory.
- *
- * Note that this function does not check access to the dir, ie. if you've
- * created it manually with 0000 permissions then this function may return
- * true, subsequent operation on files inside the directory may still fail.
- *
- * As a rule of thumb, set identical permissions on identical items in the
- * data directory, ie. all subdirectories the same perms, all files the same
- * perms.
- */
-bool UnixFileSystemHandler::mkdir(const std::string&amp; dir) const
-{
-#ifdef _WIN32
-	struct _stat info;
-
-	// First check if directory exists. We'll return success if it does.
-	if (_stat(dir.c_str(), &amp;info) == 0 &amp;&amp; (info.st_mode&amp;_S_IFDIR))
-		return true;
-#else
-	struct stat info;
-
-	// First check if directory exists. We'll return success if it does.
-	if (stat(dir.c_str(), &amp;info) == 0 &amp;&amp; S_ISDIR(info.st_mode))
-		return true;
-#endif
-	// If it doesn't exist we try to mkdir it and return success if that succeeds.
-#ifndef _WIN32
-	if (::mkdir(dir.c_str(), S_IRWXU | S_IRGRP | S_IXGRP | S_IROTH | S_IXOTH) == 0)
-#else
-	if (::_mkdir(dir.c_str()) == 0)
-#endif
-		return true;
-
-	// Otherwise we return false.
-	return false;
-}
-
-
-static void FindFiles(std::vector&lt;std::string&gt;&amp; matches, const std::string&amp; dir, const boost::regex &amp;regexpattern, int flags)
-{
-#ifdef _WIN32
-	WIN32_FIND_DATA wfd;
-  HANDLE hFind = FindFirstFile((dir+&quot;\\*&quot;).c_str(), &amp;wfd);
-
-	if (hFind != INVALID_HANDLE_VALUE) {
-		do {
-			if(strcmp(wfd.cFileName,&quot;.&quot;) &amp;&amp; strcmp(wfd.cFileName ,&quot;..&quot;)) {
-				if(!(wfd.dwFileAttributes&amp;FILE_ATTRIBUTE_DIRECTORY)) {
-					if ((flags &amp; FileSystem::ONLY_DIRS) == 0) {
-						if (boost::regex_match(wfd.cFileName, regexpattern)) {
-							matches.push_back(dir + wfd.cFileName);
-						}
-					}
-				}
-				else {
-					if (flags &amp; FileSystem::INCLUDE_DIRS) {
-						if (boost::regex_match(wfd.cFileName, regexpattern)) {
-							matches.push_back(dir + wfd.cFileName + &quot;\\&quot;);
-						}
-					}
-					if (flags &amp; FileSystem::RECURSE) {
-						FindFiles(matches, dir + wfd.cFileName + &quot;\\&quot;, regexpattern, flags);
-					}
-				}
-			}
-		} while (FindNextFile(hFind, &amp;wfd));
-		FindClose(hFind);
-	}
-#else
-	DIR* dp;
-	struct dirent* ep;
-
-	if (!(dp = opendir(dir.c_str())))
-		return;
-
-	while ((ep = readdir(dp))) {
-		// exclude hidden files
-		if (ep-&gt;d_name[0] != '.') {
-			// is it a file? (we just treat sockets / pipes / fifos / character&amp;block devices as files...)
-			// (need to stat because d_type is DT_UNKNOWN on linux :-/)
-			struct stat info;
-			if (stat((dir + ep-&gt;d_name).c_str(), &amp;info) == 0) {
-				if (!S_ISDIR(info.st_mode)) {
-					if ((flags &amp; FileSystem::ONLY_DIRS) == 0) {
-						if (boost::regex_match(ep-&gt;d_name, regexpattern)) {
-							matches.push_back(dir + ep-&gt;d_name);
-						}
-					}
-				}
-				else {
-					// or a directory?
-					if (flags &amp; FileSystem::INCLUDE_DIRS) {
-						if (boost::regex_match(ep-&gt;d_name, regexpattern)) {
-							matches.push_back(dir + ep-&gt;d_name + &quot;/&quot;);
-						}
-					}
-					if (flags &amp; FileSystem::RECURSE) {
-						FindFiles(matches, dir + ep-&gt;d_name + &quot;/&quot;, regexpattern, flags);
-					}
-				}
-			}
-		}
-	}
-	closedir(dp);
-#endif
-}
-
-
-/**
- * @brief internal find-files-in-a-single-datadir-function
- * @param dir path in which to start looking
- * @param pattern pattern to search for
- * @param recurse whether or not to recursively search
- * @param include_dirs whether or not to include directory names in the result
- * @return vector of std::strings
- *
- * Will search for a file given a particular pattern.
- * Starts from dirpath, descending down if recurse is true.
- */
-void UnixFileSystemHandler::FindFilesSingleDir(std::vector&lt;std::string&gt;&amp; matches, const std::string&amp; dir, const std::string &amp;pattern, int flags) const
-{
-	assert(!dir.empty() &amp;&amp; dir[dir.length() - 1] == native_path_separator);
-
-	boost::regex regexpattern(filesystem.glob_to_regex(pattern));
-
-	::FindFiles(matches, dir, regexpattern, flags);
-}

Deleted: branches/caiinterface/rts/System/Platform/Linux/UnixFileSystemHandler.h
===================================================================
--- branches/caiinterface/rts/System/Platform/Linux/UnixFileSystemHandler.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/Platform/Linux/UnixFileSystemHandler.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,46 +0,0 @@
-/**
- * @file UnixFileSystemHandler.h
- * @brief Abstracts locating of content on different platforms
- * @author Tobi Vollebregt
- *
- * Unix implementation
- *
- * Copyright (C) 2006.  Licensed under the terms of the
- * GNU GPL, v2 or later
- */
-
-#ifndef UNIXFILESYSTEMHANDLER_H
-#define UNIXFILESYSTEMHANDLER_H
-
-#include &lt;string&gt;
-#include &lt;vector&gt;
-#include &quot;DataDirLocater.h&quot;
-#include &quot;System/Platform/FileSystem.h&quot;
-
-/**
- * @brief Unix file system / data directory handler
- */
-class UnixFileSystemHandler : public FileSystemHandler
-{
-	public:
-
-		virtual ~UnixFileSystemHandler();
-		UnixFileSystemHandler(bool verbose);
-		virtual void Initialize();
-
-		virtual bool mkdir(const std::string&amp; dir) const;
-
-		virtual std::string GetWriteDir() const;
-		virtual std::vector&lt;std::string&gt; FindFiles(const std::string&amp; dir, const std::string&amp; pattern, int flags) const;
-		virtual std::string LocateFile(const std::string&amp; file) const;
-		virtual std::vector&lt;std::string&gt; GetDataDirectories() const;
-
-	protected:
-
-		void InitVFS() const;
-		void FindFilesSingleDir(std::vector&lt;std::string&gt;&amp; matches, const std::string&amp; dir, const std::string &amp;pattern, int flags) const;
-
-		DataDirLocater locater;
-};
-
-#endif // !UNIXFILESYSTEMHANDLER_H

Deleted: branches/caiinterface/rts/System/Platform/Mac/MacFileSystemHandler.cpp
===================================================================
--- branches/caiinterface/rts/System/Platform/Mac/MacFileSystemHandler.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/Platform/Mac/MacFileSystemHandler.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,72 +0,0 @@
-/*
- * @file MacFileSystemHandler.cpp
- * @author Fabian Herb
- *
- * Copyright (C) 2008.  Licensed under the terms of the
- * GNU GPL, v2 or later
- */
-
-#include &lt;CoreFoundation/CoreFoundation.h&gt;
-#include &quot;StdAfx.h&quot;
-#include &quot;LogOutput.h&quot;
-#include &quot;Platform/Mac/MacFileSystemHandler.h&quot;
-
-/**
- * This does exactly the same as the constructor of UnixFileSystemHandler, but unfortunately
- * simply making LocateDataDirs() virtual did not work, it would not call the correct one.
- */
-MacFileSystemHandler::MacFileSystemHandler(bool verbose) : UnixFileSystemHandler(verbose, false)
-{
-	LocateDataDirs();
-	InitVFS();
-	
-	for (std::vector&lt;DataDir&gt;::const_iterator d = datadirs.begin(); d != datadirs.end(); ++d) {
-		if (d-&gt;readable) {
-			if (d-&gt;writable)
-				logOutput.Print(&quot;Using read-write data directory: %s&quot;, d-&gt;path.c_str());
-			else
-				logOutput.Print(&quot;Using read-only  data directory: %s&quot;, d-&gt;path.c_str());
-		}
-	}
-}
-
-void MacFileSystemHandler::LocateDataDirs()
-{
-	// Get the path to the application bundle we are running:
-	char cPath[1024];
-    CFBundleRef mainBundle = CFBundleGetMainBundle();
-    if(!mainBundle)
-	    throw content_error(&quot;Could not determine bundle path&quot;);
-
-    CFURLRef mainBundleURL = CFBundleCopyBundleURL(mainBundle);
-	if(!mainBundleURL)
-		 throw content_error(&quot;Could not determine bundle path&quot;);
-
-    CFStringRef cfStringRef = CFURLCopyFileSystemPath(mainBundleURL, kCFURLPOSIXPathStyle);
-	if(!cfStringRef)
-		 throw content_error(&quot;Could not determine bundle path&quot;);
-
-    CFStringGetCString(cfStringRef, cPath, 1024, kCFStringEncodingASCII);
-
-    CFRelease(mainBundleURL);
-    CFRelease(cfStringRef);
-	std::string path(cPath);
-	
-	datadirs.clear();
-	writedir = NULL;
-	
-	// Add bundle resources:
-	datadirs.push_back(path + &quot;/Contents/Resources/&quot;);
-	datadirs.rbegin()-&gt;readable = true;
-	// Add the directory surrounding the bundle, for users to add mods and maps in:
-	datadirs.push_back(filesystem.GetDirectory(path));
-	// Use surrounding directory as writedir for now, should propably
-	// change this to something inside the home directory:
-	datadirs.rbegin()-&gt;writable = true;
-	datadirs.rbegin()-&gt;readable = true;
-	writedir = &amp;*datadirs.rbegin();
-	
-	// See UnixFileSystemHandler::LocateDataDirs() on why we change the working
-	// directory here:
-	chdir(GetWriteDir().c_str());
-}

Deleted: branches/caiinterface/rts/System/Platform/Mac/MacFileSystemHandler.h
===================================================================
--- branches/caiinterface/rts/System/Platform/Mac/MacFileSystemHandler.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/Platform/Mac/MacFileSystemHandler.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,26 +0,0 @@
-/*
- * @file MacFileSystemHandler.h
- * @author Fabian Herb
- * @brief Abstracts locating of content on different platforms
- *
- * Copyright (C) 2008.  Licensed under the terms of the
- * GNU GPL, v2 or later
- *
- */
- 
-#ifndef MACFILESYSTEMHANDLER_H
-#define MACFILESYSTEMHANDLER_H
-
-#include &quot;Platform/Linux/UnixFileSystemHandler.h&quot;
-
-/// Mac file system handler, configures mac-specific search paths
-class MacFileSystemHandler : public UnixFileSystemHandler
-{
-public:
-	MacFileSystemHandler(bool verbose);
-protected:
-	/// Adds the application bundle resources and the surrounding dir to the searchtree
-	void LocateDataDirs();
-};
-
-#endif

Modified: branches/caiinterface/rts/System/Platform/NullSound.h
===================================================================
--- branches/caiinterface/rts/System/Platform/NullSound.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/Platform/NullSound.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,7 +1,7 @@
 #ifndef NULL_SOUND_H
 #define NULL_SOUND_H
 
-#include &quot;../Sound.h&quot;
+#include &quot;Sound.h&quot;
 
 // Null sound system
 class CNullSound: public CSound
@@ -20,6 +20,7 @@
 	void StopStream() { return; }
 	void PauseStream() { return; }
 	unsigned int GetStreamTime() { return 0; }
+	unsigned int GetStreamPlayTime() { return 0; }
 	void SetStreamVolume(float) { return; }
 
 	void SetVolume(float vol) { return; }

Modified: branches/caiinterface/rts/System/Platform/Win/AVIGenerator.cpp
===================================================================
--- branches/caiinterface/rts/System/Platform/Win/AVIGenerator.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/Platform/Win/AVIGenerator.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -347,7 +347,7 @@
 		freeImageBuffers.push_back(tmpBuf);
 	}
 
-	HWND mainWindow = FindWindow(NULL, (&quot;Spring &quot; + std::string(VERSION_STRING_DETAILED)).c_str());
+	HWND mainWindow = FindWindow(NULL, (&quot;Spring &quot; + SpringVersion::GetFull()).c_str());
 	if(fullscreen){
 		ShowWindow(mainWindow, SW_SHOWMINNOACTIVE);
 	}

Modified: branches/caiinterface/rts/System/Platform/Win/CrashHandler.cpp
===================================================================
--- branches/caiinterface/rts/System/Platform/Win/CrashHandler.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/Platform/Win/CrashHandler.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -124,9 +124,9 @@
 	// Prologue.
 	logOutput.RemoveAllSubscribers();
 #ifdef USE_GML
-	PRINT(&quot;Spring %s MT (%d threads) has crashed.&quot;, VERSION_STRING_DETAILED, gmlThreadCount);
+	PRINT(&quot;Spring %s MT (%d threads) has crashed.&quot;, SpringVersion::GetFull().c_str(), gmlThreadCount);
 #else
-	PRINT(&quot;Spring %s has crashed.&quot;, VERSION_STRING_DETAILED);
+	PRINT(&quot;Spring %s has crashed.&quot;, SpringVersion::GetFull().c_str());
 #endif
 	// Initialize IMAGEHLP.DLL.
 	SymInitialize(GetCurrentProcess(), &quot;.&quot;, TRUE);

Deleted: branches/caiinterface/rts/System/Platform/Win/DataDirLocater.cpp
===================================================================
--- branches/caiinterface/rts/System/Platform/Win/DataDirLocater.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/Platform/Win/DataDirLocater.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1 +0,0 @@
-#include &quot;Platform/Linux/DataDirLocater.cpp&quot;

Deleted: branches/caiinterface/rts/System/Platform/Win/DataDirLocater.h
===================================================================
--- branches/caiinterface/rts/System/Platform/Win/DataDirLocater.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/Platform/Win/DataDirLocater.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1 +0,0 @@
-#include &quot;Platform/Linux/DataDirLocater.h&quot;

Modified: branches/caiinterface/rts/System/Platform/Win/DxSound.cpp
===================================================================
--- branches/caiinterface/rts/System/Platform/Win/DxSound.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/Platform/Win/DxSound.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -132,7 +132,8 @@
 
 void CDxSound::StopStream() { oggStream.Stop(); }
 void CDxSound::PauseStream() { oggStream.TogglePause(); }
-unsigned int CDxSound::GetStreamTime() { return oggStream.GetPlayTime(); }
+unsigned int CDxSound::GetStreamTime() { return oggStream.GetTotalTime(); }
+unsigned int CDxSound::GetStreamPlayTime() { return oggStream.GetPlayTime(); }
 void CDxSound::SetStreamVolume(float v) { oggStream.SetVolume(v); }
 
 

Modified: branches/caiinterface/rts/System/Platform/Win/DxSound.h
===================================================================
--- branches/caiinterface/rts/System/Platform/Win/DxSound.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/Platform/Win/DxSound.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -18,7 +18,7 @@
 #include &lt;list&gt;
 #include &lt;SDL_types.h&gt;
 
-#include &quot;OggStream.h&quot;
+#include &quot;Platform/Win/OggStream.h&quot;
 
 class CWorldObject;
 
@@ -37,6 +37,7 @@
 	void StopStream();
 	void PauseStream();
 	unsigned int GetStreamTime();
+	unsigned int GetStreamPlayTime();
 	void SetStreamVolume(float);
 
 	void SetVolume(float v);

Modified: branches/caiinterface/rts/System/Platform/Win/OggStream.cpp
===================================================================
--- branches/caiinterface/rts/System/Platform/Win/OggStream.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/Platform/Win/OggStream.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -127,7 +127,7 @@
 		// 0.1 --&gt;  -9000
 		// ..............
 		// 1.0 --&gt;      0
-		float db = (1.0f - v) * -10000;
+		long db = (long)(1.0f - v) * -10000;
 
 		DSB-&gt;SetVolume(db);
 	}
@@ -145,6 +145,10 @@
 	}
 }
 
+unsigned int COggStream::GetTotalTime() {
+	return ov_time_total(&amp;oggStream,-1);
+}
+
 void COggStream::UpdateTimer() {
 	unsigned int tick = SDL_GetTicks();
 
@@ -214,6 +218,7 @@
 void COggStream::DisplayInfo() {
 	logOutput.Print(&quot;version:           %d&quot;, vorbisInfo-&gt;version);
 	logOutput.Print(&quot;channels:          %d&quot;, vorbisInfo-&gt;channels);
+	logOutput.Print(&quot;time (sec):        %d&quot;, ov_time_total(&amp;oggStream,-1));
 	logOutput.Print(&quot;rate (Hz):         %d&quot;, vorbisInfo-&gt;rate);
 	logOutput.Print(&quot;bitrate (upper):   %d&quot;, vorbisInfo-&gt;bitrate_upper);
 	logOutput.Print(&quot;bitrate (nominal): %d&quot;, vorbisInfo-&gt;bitrate_nominal);

Modified: branches/caiinterface/rts/System/Platform/Win/OggStream.h
===================================================================
--- branches/caiinterface/rts/System/Platform/Win/OggStream.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/Platform/Win/OggStream.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -26,7 +26,8 @@
 		void Stop();
 		void TogglePause();
 		void Update();
-		unsigned int GetPlayTime() const { return ((!stopped)? secsPlayed: 0); }
+		unsigned int GetPlayTime() const { return ((stopped)? 0 : secsPlayed); }
+		unsigned int GetTotalTime();
 		void SetVolume(float, bool b = false);
 
 	private:

Deleted: branches/caiinterface/rts/System/Platform/Win/WinFileSystemHandler.cpp
===================================================================
--- branches/caiinterface/rts/System/Platform/Win/WinFileSystemHandler.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/Platform/Win/WinFileSystemHandler.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,2 +0,0 @@
-#include &quot;StdAfx.h&quot;
-#include &quot;Platform/Linux/UnixFileSystemHandler.cpp&quot;

Deleted: branches/caiinterface/rts/System/Platform/Win/WinFileSystemHandler.h
===================================================================
--- branches/caiinterface/rts/System/Platform/Win/WinFileSystemHandler.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/Platform/Win/WinFileSystemHandler.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,2 +0,0 @@
-//HACK don't want to adjust scons to build the unix one for windows
-#include &quot;Platform/Linux/UnixFileSystemHandler.h&quot;

Modified: branches/caiinterface/rts/System/Platform/byteorder.h
===================================================================
--- branches/caiinterface/rts/System/Platform/byteorder.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/Platform/byteorder.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -78,7 +78,7 @@
 #elif defined(__APPLE__)
 // Should work for both x86 and ppc
 
-#include &quot;CoreFoundation/CFByteOrder.h&quot;
+#include &quot;CFByteOrder.h&quot;
 
 #define swabword(w) (CFSwapInt16LittleToHost((uint32_t)w))
 #define swabdword(w) (CFSwapInt32LittleToHost((uint32_t)w))

Modified: branches/caiinterface/rts/System/Platform/errorhandler.cpp
===================================================================
--- branches/caiinterface/rts/System/Platform/errorhandler.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/Platform/errorhandler.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -9,7 +9,7 @@
  * GNU GPL, v2 or later.
  */
 #include &lt;StdAfx.h&gt;
-#include &quot;Platform/errorhandler.h&quot;
+#include &quot;errorhandler.h&quot;
 
 #include &lt;SDL.h&gt;
 #ifdef _WIN32

Modified: branches/caiinterface/rts/System/Script/LuaBinder.cpp
===================================================================
--- branches/caiinterface/rts/System/Script/LuaBinder.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/Script/LuaBinder.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -3,8 +3,8 @@
 #include &quot;Game/StartScripts/Script.h&quot;
 #include &quot;float3.h&quot;
 #include &quot;LogOutput.h&quot;
-#include &quot;Game/GlobalSynced.h&quot;
-#include &quot;Game/Team.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitTypes/TransportUnit.h&quot;
 #include &quot;TdfParser.h&quot;
@@ -190,10 +190,10 @@
 		class_&lt;CGlobalSyncedStuff&gt;(&quot;GlobalSynced&quot;)
 			.def_readonly(&quot;frameNum&quot;, &amp;CGlobalSyncedStuff::frameNum)
 			.def_readonly(&quot;mapx&quot;, &amp;CGlobalSyncedStuff::mapx)
-			.def_readonly(&quot;activeTeams&quot;, &amp;CGlobalSyncedStuff::activeTeams)
+			.def_readonly(&quot;activeTeams&quot;, &amp;CGlobalSyncedStuff::activeTeamsBackwardCompatForLuaBinder)
 			.def_readonly(&quot;mapy&quot;, &amp;CGlobalSyncedStuff::mapy)
 			.def(&quot;randInt&quot;, &amp;CGlobalSyncedStuff::randInt),
-			
+
 		class_&lt;SFloat3&gt;(&quot;sfloat3&quot;)
 			.def(constructor&lt;const float, const float, const float&gt;())
 			.def_readwrite(&quot;x&quot;, &amp;SFloat3::x)
@@ -223,7 +223,7 @@
 			.def(&quot;GiveCommand&quot;, &amp;UnitGiveCommand)
 			.def(&quot;ChangeTeam&quot;, &amp;CUnit::ChangeTeam)
 			.def(&quot;IsValid&quot;, &amp;UnitPointerIsValid),
-			
+
 		class_&lt;CTeam&gt;(&quot;Team&quot;)
 			.def(&quot;setmetalstorage&quot;, &amp;CTeam::SetBaseMetalStorage)
 			.def(&quot;setenergystorage&quot;, &amp;CTeam::SetBaseEnergyStorage)
@@ -304,7 +304,7 @@
 			def(&quot;GetAt&quot;, &amp;GetFeaturesAt, raw(_1)),
 			def(&quot;Load&quot;, &amp;FeatureLoaderLoadFeature, adopt(result))
 		],
-		
+
 		namespace_(&quot;game&quot;)
 		[
 			def(&quot;End&quot;, &amp;EndGame),

Modified: branches/caiinterface/rts/System/Script/LuaFunctions.cpp
===================================================================
--- branches/caiinterface/rts/System/Script/LuaFunctions.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/Script/LuaFunctions.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -5,7 +5,7 @@
 #include &quot;StdAfx.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;LuaFunctions.h&quot;
-#include &quot;Game/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
 #include &quot;float3.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;ExternalAI/EngineOutHandler.h&quot;
@@ -19,13 +19,14 @@
 #include &quot;Sim/Features/Feature.h&quot;
 #include &quot;Sim/Features/FeatureHandler.h&quot;
 #include &quot;Sim/Misc/QuadField.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Units/CommandAI/CommandAI.h&quot;
 #include &quot;Sim/Units/UnitDefHandler.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
 #include &quot;Sim/Units/UnitLoader.h&quot;
 #include &quot;Sim/Units/UnitTypes/TransportUnit.h&quot;
-#include &quot;System/EventHandler.h&quot;
+#include &quot;EventHandler.h&quot;
 
 using namespace std;
 using namespace luabind;
@@ -62,7 +63,7 @@
 		CUnit* x = unitLoader.LoadUnit(name, pos, team, buil, 0, NULL);
 		return SAFE_NEW CObject_pointer&lt;CUnit&gt;(x);
 	}
-	
+
 	void RemoveUnit(CObject_pointer&lt;CUnit&gt;* u)
 	{
 		if (u-&gt;held)
@@ -174,10 +175,10 @@
 		if (selectedUnits.selectionChanged)
 			selectedUnits.SendSelection();
 	}
-	
+
 	CTeam* GetTeam(int num)
 	{
-		return gs-&gt;Team(num);
+		return teamHandler-&gt;Team(num);
 	}
 
 	string MapGetTDFName()

Modified: branches/caiinterface/rts/System/Sound.cpp
===================================================================
--- branches/caiinterface/rts/System/Sound.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/Sound.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -4,7 +4,7 @@
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
-#include &quot;System/Exceptions.h&quot;
+#include &quot;Exceptions.h&quot;
 
 #ifdef _WIN32
 #include &quot;Platform/Win/DxSound.h&quot;

Modified: branches/caiinterface/rts/System/Sound.h
===================================================================
--- branches/caiinterface/rts/System/Sound.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/Sound.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -4,7 +4,7 @@
 #include &lt;set&gt;
 #include &lt;string&gt;
 
-#include &quot;System/float3.h&quot; // for zerovector
+#include &quot;float3.h&quot; // for zerovector
 
 class CWorldObject;
 class CUnit;
@@ -29,6 +29,7 @@
 	virtual void StopStream() = 0;
 	virtual void PauseStream() = 0;
 	virtual unsigned int GetStreamTime() = 0;
+	virtual unsigned int GetStreamPlayTime() = 0;
 	virtual void SetStreamVolume(float) = 0;
 
 	virtual void SetVolume(float vol) = 0; // 1 = full volume

Modified: branches/caiinterface/rts/System/SpringApp.cpp
===================================================================
--- branches/caiinterface/rts/System/SpringApp.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/SpringApp.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -14,20 +14,20 @@
 #undef KeyPress
 #undef KeyRelease
 
-#include &quot;Game/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
 #include &quot;Game/GameVersion.h&quot;
 #include &quot;Game/GameSetup.h&quot;
 #include &quot;Game/GameController.h&quot;
 #include &quot;Game/SelectMenu.h&quot;
 #include &quot;Game/PreGame.h&quot;
 #include &quot;Game/Game.h&quot;
-#include &quot;Game/Team.h&quot;
+#include &quot;Sim/Misc/Team.h&quot;
 #include &quot;Game/UI/KeyBindings.h&quot;
 #include &quot;Lua/LuaOpenGL.h&quot;
 #include &quot;Platform/BaseCmd.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;Platform/errorhandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;FileSystem/FileHandler.h&quot;
 #include &quot;ExternalAI/IAILibraryManager.h&quot;
 #include &quot;Rendering/glFont.h&quot;
@@ -41,9 +41,9 @@
 #include &quot;MouseInput.h&quot;
 #include &quot;bitops.h&quot;
 #include &quot;Sync/Syncify.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
-#include &quot;System/Util.h&quot;
-#include &quot;System/Exceptions.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
+#include &quot;Util.h&quot;
+#include &quot;Exceptions.h&quot;
 
 #include &quot;mmgr.h&quot;
 
@@ -105,10 +105,6 @@
 	FSAA = false;
 
 	signal(SIGABRT, SigAbrtHandler);
-#if defined(USE_GML) &amp;&amp; GML_ENABLE_SIMLOOP
-	extern volatile int multiThreadSim;
-	multiThreadSim=configHandler.GetInt(&quot;MultiThreadSim&quot;, 1);
-#endif
 }
 
 /**
@@ -234,7 +230,7 @@
 
 	FileSystemHandler::Initialize(true);
 
-	if (!InitWindow((&quot;Spring &quot; + std::string(VERSION_STRING_DETAILED)).c_str())) {
+	if (!InitWindow((&quot;Spring &quot; + SpringVersion::GetFull()).c_str())) {
 		SDL_Quit();
 		return false;
 	}
@@ -663,11 +659,11 @@
 	cmdline-&gt;parse();
 
 	string configSource;
-	if (cmdline-&gt;result(&quot;config&quot;, configSource)) {
-		ConfigHandler::SetConfigSource(configSource);
-	}
+	cmdline-&gt;result(&quot;config&quot;, configSource);
+	// it is not allowed to use configHandler before this line runs.
+	ConfigHandler::Instantiate(configSource);
 
-	logOutput.Print(&quot;using configuration source \&quot;&quot; + configHandler.GetConfigSource() + &quot;\&quot;&quot;);
+	logOutput.Print(&quot;using configuration source \&quot;&quot; + configSource + &quot;\&quot;&quot;);
 
 #ifdef _DEBUG
 	fullscreen = false;
@@ -677,10 +673,10 @@
 
 	// mutually exclusive options that cause spring to quit immediately
 	if (cmdline-&gt;result(&quot;help&quot;)) {
-		cmdline-&gt;usage(&quot;Spring&quot;,VERSION_STRING);
+		cmdline-&gt;usage(&quot;Spring&quot;,SpringVersion::GetFull());
 		exit(0);
 	} else if (cmdline-&gt;result(&quot;version&quot;)) {
-		std::cout &lt;&lt; &quot;Spring &quot; &lt;&lt; VERSION_STRING &lt;&lt; std::endl;
+		std::cout &lt;&lt; &quot;Spring &quot; &lt;&lt; SpringVersion::GetFull() &lt;&lt; std::endl;
 		exit(0);
 	} else if (cmdline-&gt;result(&quot;projectiledump&quot;)) {
 		CCustomExplosionGenerator::OutputProjectileClassInfo();
@@ -725,6 +721,13 @@
 		screenHeight = std::max(screenHeight, 1);
 	}
 
+#ifdef USE_GML
+	gmlThreadCountOverride = configHandler.GetInt(&quot;HardwareThreadCount&quot;, 0);
+#if GML_ENABLE_SIMLOOP
+	extern volatile int multiThreadSim;
+	multiThreadSim=configHandler.GetInt(&quot;MultiThreadSim&quot;, 1);
+#endif
+#endif
 }
 
 /**
@@ -793,11 +796,10 @@
 		if (argv[i][0] != '-')
 		{
 			string command(argv[i]);
-			int idx = command.rfind(&quot;sdf&quot;);
-			if (idx == (int)command.size()-3) {
+			if (command.rfind(&quot;sdf&quot;) == command.size() - 3) {
 				demofile = command;
 				logOutput &lt;&lt; &quot;Using demofile &quot; &lt;&lt; demofile.c_str() &lt;&lt; &quot;\n&quot;;
-			} else if (command.rfind(&quot;ssf&quot;) == command.size()-3) {
+			} else if (command.rfind(&quot;ssf&quot;) == command.size() - 3) {
 				savefile = command;
 				logOutput &lt;&lt; &quot;Using savefile &quot; &lt;&lt; savefile.c_str() &lt;&lt; &quot;\n&quot;;
 			} else {
@@ -822,7 +824,7 @@
 		CFileHandler fh(startscript);
 		if (!fh.FileExists())
 			throw content_error(&quot;Setupscript doesn't exists in given location: &quot;+startscript);
-		
+
 		std::string buf;
 		if (!fh.LoadStringData(buf))
 			throw content_error(&quot;Setupscript cannot be read: &quot;+startscript);

Modified: branches/caiinterface/rts/System/StdAfx.h
===================================================================
--- branches/caiinterface/rts/System/StdAfx.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/StdAfx.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -34,7 +34,7 @@
 #include &lt;cassert&gt;
 
 // do not include &lt;cmath&gt; or &lt;math.h&gt; before this, it'll cause ambiguous call er
-#include &quot;streflop_cond.h&quot;
+#include &quot;lib/streflop/streflop_cond.h&quot;
 #endif
 
 // maybe we should remove syncify altogether?
@@ -58,13 +58,13 @@
 // also, they shouldn't get in the way of mmgr
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;float3.h&quot;
-#include &quot;System/Util.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
+#include &quot;Util.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
 #if !defined BUILDING_AI &amp;&amp; !defined BUILDING_AI_INTERFACE
 #include &quot;Map/Ground.h&quot;
 #include &quot;Map/ReadMap.h&quot;
-#include &quot;Game/GlobalSynced.h&quot;
-#include &quot;Game/GlobalConstants.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/GlobalConstants.h&quot;
 #include &quot;Game/Camera.h&quot;
 #endif	/* !defined BUILDING_AI &amp;&amp; !defined BUILDING_AI_INTERFACE */
 #endif // USE_PRECOMPILED_HEADER

Modified: branches/caiinterface/rts/System/Sync/SyncChecker.h
===================================================================
--- branches/caiinterface/rts/System/Sync/SyncChecker.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/Sync/SyncChecker.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -11,7 +11,7 @@
 #include &lt;SDL_types.h&gt;
 
 #ifdef TRACE_SYNC
-#include &quot;Sync/SyncTracer.h&quot;
+#include &quot;SyncTracer.h&quot;
 #endif
 
 #include &lt;boost/cstdint.hpp&gt; /* Replace with &lt;stdint.h&gt; if appropriate */

Modified: branches/caiinterface/rts/System/Sync/SyncDebugger.cpp
===================================================================
--- branches/caiinterface/rts/System/Sync/SyncDebugger.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/Sync/SyncDebugger.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -7,10 +7,10 @@
 #include &lt;boost/format.hpp&gt;
 
 #include &quot;LogOutput.h&quot;
-#include &quot;System/GlobalUnsynced.h&quot;
-#include &quot;GlobalSynced.h&quot;
-#include &quot;System/BaseNetProtocol.h&quot;
-#include &quot;System/NetProtocol.h&quot;
+#include &quot;GlobalUnsynced.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
+#include &quot;BaseNetProtocol.h&quot;
+#include &quot;NetProtocol.h&quot;
 #include &quot;SyncDebugger.h&quot;
 #include &quot;SyncChecker.h&quot;
 #include &quot;SyncTracer.h&quot;
@@ -239,7 +239,7 @@
 				logger.AddLine(&quot;Server: received checksum response of %d instead of %d bytes&quot;, *(short*)&amp;inbuf[1], HISTORY_SIZE * 4 + 12);
 			} else {
 				int player = inbuf[3];
-				if(player &gt;= gs-&gt;activePlayers || player &lt; 0) {
+				if(player &gt;= playerHandler-&gt;ActivePlayers() || player &lt; 0) {
 					logger.AddLine(&quot;Server: got invalid playernum %d in checksum response&quot;, player);
 				} else {
 					logger.AddLine(&quot;Server: got checksum response from %d&quot;, player);
@@ -250,8 +250,8 @@
 					remoteFlop[player] = *(Uint64*)&amp;inbuf[4];
 					assert(!checksumResponses[player].empty());
 					int i = 0;
-					while (i &lt; gs-&gt;activePlayers &amp;&amp; !checksumResponses[i].empty()) ++i;
-					if (i == gs-&gt;activePlayers) {
+					while (i &lt; playerHandler-&gt;ActivePlayers() &amp;&amp; !checksumResponses[i].empty()) ++i;
+					if (i == playerHandler-&gt;ActivePlayers()) {
 						ServerQueueBlockRequests();
 						logger.AddLine(&quot;Server: checksum responses received; %d block requests queued&quot;, pendingBlocksToRequest.size());
 					}
@@ -264,7 +264,7 @@
 				logger.AddLine(&quot;Server: received block response of %d instead of %d bytes&quot;, *(short*)&amp;inbuf[1], BLOCK_SIZE * 4 + 4);
 			} else {
 				int player = inbuf[3];
-				if(player &gt;= gs-&gt;activePlayers || player &lt; 0) {
+				if(player &gt;= playerHandler-&gt;ActivePlayers() || player &lt; 0) {
 					logger.AddLine(&quot;Server: got invalid playernum %d in block response&quot;, player);
 				} else {
 					const unsigned* begin = (unsigned*)&amp;inbuf[4];
@@ -274,8 +274,8 @@
 					std::copy(begin, end, remoteHistory[player].begin() + size);
 					int i = 0;
 					size += BLOCK_SIZE;
-					while (i &lt; gs-&gt;activePlayers &amp;&amp; size == remoteHistory[i].size()) ++i;
-					if (i == gs-&gt;activePlayers) {
+					while (i &lt; playerHandler-&gt;ActivePlayers() &amp;&amp; size == remoteHistory[i].size()) ++i;
+					if (i == playerHandler-&gt;ActivePlayers()) {
 						logger.AddLine(&quot;Server: block responses received&quot;);
 						ServerReceivedBlockResponses();
 					}
@@ -397,7 +397,7 @@
 {
 	logger.AddLine(&quot;Server: queuing block requests&quot;);
 	Uint64 correctFlop = 0;
-	for (int j = 0; j &lt; gs-&gt;activePlayers; ++j) {
+	for (int j = 0; j &lt; playerHandler-&gt;ActivePlayers(); ++j) {
 		if (correctFlop) {
 			if (remoteFlop[j] != correctFlop)
 				logger.AddLine(&quot;Server: bad flop# %llu instead of %llu for player %d&quot;, remoteFlop[j], correctFlop, j);
@@ -409,7 +409,7 @@
 	for (unsigned c = 0; c &lt; HISTORY_SIZE; ++i, ++c) {
 		unsigned correctChecksum = 0;
 		if (i == HISTORY_SIZE) i = 0;
-		for (int j = 0; j &lt; gs-&gt;activePlayers; ++j) {
+		for (int j = 0; j &lt; playerHandler-&gt;ActivePlayers(); ++j) {
 			if (correctChecksum &amp;&amp; checksumResponses[j][i] != correctChecksum) {
 				pendingBlocksToRequest.push_back(i);
 				break;
@@ -527,7 +527,7 @@
 		unsigned correctChecksum = 0;
 		if (i == virtualHistorySize) i = 0;
 		bool err = false;
-		for (int j = 0; j &lt; gs-&gt;activePlayers; ++j) {
+		for (int j = 0; j &lt; playerHandler-&gt;ActivePlayers(); ++j) {
 			if (correctChecksum &amp;&amp; remoteHistory[j][i] != correctChecksum) {
 				if (historybt) {
 					virtualBlockNr = i / BLOCK_SIZE;

Modified: branches/caiinterface/rts/System/Sync/SyncDebugger.h
===================================================================
--- branches/caiinterface/rts/System/Sync/SyncDebugger.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/Sync/SyncDebugger.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -10,7 +10,7 @@
 #include &lt;vector&gt;
 #include &lt;SDL_types.h&gt;
 
-#include &quot;Game/GlobalConstants.h&quot;
+#include &quot;Sim/Misc/GlobalConstants.h&quot;
 
 /**
  * @brief sync debugger class

Modified: branches/caiinterface/rts/System/Sync/SyncTracer.cpp
===================================================================
--- branches/caiinterface/rts/System/Sync/SyncTracer.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/Sync/SyncTracer.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -3,7 +3,7 @@
 //////////////////////////////////////////////////////////////////////
 
 #include &quot;StdAfx.h&quot;
-#include &quot;Sync/SyncTracer.h&quot;
+#include &quot;SyncTracer.h&quot;
 #include &lt;stdio.h&gt;
 #include &quot;LogOutput.h&quot;
 #include &quot;mmgr.h&quot;

Modified: branches/caiinterface/rts/System/TdfParser.cpp
===================================================================
--- branches/caiinterface/rts/System/TdfParser.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/TdfParser.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -63,34 +63,35 @@
 std::size_t TdfParser::parse_error::get_column() const {return column;}
 std::string const&amp; TdfParser::parse_error::get_filename() const {return filename;}
 
-void TdfParser::TdfSection::print( std::ostream &amp; out )  const{
-  for( std::map&lt;std::string,TdfSection*&gt;::const_iterator it = sections.begin(), e=sections.end(); it != e; ++it ) {
-    out &lt;&lt; &quot;[&quot; &lt;&lt; it-&gt;first &lt;&lt; &quot;] {\n&quot;;
-    it-&gt;second-&gt;print(out);
-    out &lt;&lt; &quot;};&quot;;
-  }
-  for( std::map&lt;std::string,std::string&gt;::const_iterator it = values.begin(), e=values.end(); it != e; ++it ) {
-    out &lt;&lt; it-&gt;first  &lt;&lt; &quot;=&quot; &lt;&lt; it-&gt;second &lt;&lt; &quot;;\n&quot;;
-  }
+void TdfParser::TdfSection::print( std::ostream &amp; out ) const
+{
+	for( std::map&lt;std::string,TdfSection*&gt;::const_iterator it = sections.begin(), e=sections.end(); it != e; ++it ) {
+		out &lt;&lt; &quot;[&quot; &lt;&lt; it-&gt;first &lt;&lt; &quot;]\n{\n&quot;;
+		it-&gt;second-&gt;print(out);
+		out &lt;&lt; &quot;}\n&quot;;
+	}
+	for( std::map&lt;std::string,std::string&gt;::const_iterator it = values.begin(), e=values.end(); it != e; ++it ) {
+		out &lt;&lt; it-&gt;first  &lt;&lt; &quot;=&quot; &lt;&lt; it-&gt;second &lt;&lt; &quot;;\n&quot;;
+	}
 }
 
-TdfParser::TdfSection* TdfParser::TdfSection::construct_subsection( std::string const&amp; name )
+TdfParser::TdfSection* TdfParser::TdfSection::construct_subsection(const std::string&amp; name )
 {
-  std::string lowerd_name = StringToLower(name);
-  std::map&lt;std::string,TdfSection*&gt;::iterator it = sections.find(lowerd_name);
-  if( it != sections.end() )
-    return it-&gt;second;
-  else {
-    TdfSection* ret = SAFE_NEW TdfSection;
-    sections[lowerd_name] = ret;
-    return ret;
-  }
+	std::string lowerd_name = StringToLower(name);
+	std::map&lt;std::string,TdfSection*&gt;::iterator it = sections.find(lowerd_name);
+	if( it != sections.end() )
+		return it-&gt;second;
+	else {
+		TdfSection* ret = SAFE_NEW TdfSection;
+		sections[lowerd_name] = ret;
+		return ret;
+	}
 }
 
-void TdfParser::TdfSection::add_name_value(std::string const&amp; name, std::string&amp; value )
+void TdfParser::TdfSection::add_name_value(const std::string&amp; name, const std::string&amp; value )
 {
-  std::string lowerd_name = StringToLower(name);
-  values[lowerd_name] = value;
+	std::string lowerd_name = StringToLower(name);
+	values[lowerd_name] = value;
 }
 
 
@@ -105,8 +106,6 @@
     delete it-&gt;second;
 }
 
-TdfParser::TdfParser() {
-}
 void TdfParser::print( std::ostream &amp; out ) const {
   root_section.print( out );
 }
@@ -219,49 +218,6 @@
 	return value;
 }
 
-//finds a value in the file, if not found returns false, and errormessages is returned in value
-/*bool TdfParser::GetValue(std::string &amp;value, ...)
-{
-	std::string searchpath; //for errormessages
-	va_list loc;
-	va_start(loc, value);
-	int numargs=0;
-	while(va_arg(loc, char*)) //determine number of arguments
-		numargs++;
-	va_start(loc, value);
-	TdfSection *sectionptr;
-	for(int i=0; i&lt;numargs-1; i++)
-	{
-		char *arg = va_arg(loc, char*);
-		searchpath += '\\';
-		searchpath += arg;
-		sectionptr = sections[arg];
-		if(sectionptr==NULL)
-		{
-			value = &quot;Section &quot; + searchpath + &quot; missing in file &quot; + filename;
-			return false;
-		}
-	}
-	char *arg = va_arg(loc, char*);
-	std::string svalue = sectionptr-&gt;values[arg];
-	searchpath += '\\';
-	searchpath += arg;
-	if(svalue == &quot;&quot;)
-	{
-		value = &quot;Value &quot; + searchpath + &quot; missing in file &quot; + filename;
-		return false;
-	}
-	value = svalue;
-	return true;
-}*/
-
-/*void TdfParser::Test()
-{
-	TdfSection *unitinfo = sections[&quot;UNITINFO&quot;];
-	TdfSection *weapons = unitinfo-&gt;sections[&quot;WEAPONS&quot;];
-	std::string mo = weapons-&gt;values[&quot;weapon1&quot;];
-}*/
-
 //finds a value in the file , if not found returns false, and errormessages is returned in value
 //location of value is sent as a string &quot;section\section\value&quot;
 bool TdfParser::SGetValue(std::string &amp;value, std::string const&amp; location) const
@@ -319,7 +275,6 @@
 		root_section.sections.find(loclist[0]);
 	if(sit == root_section.sections.end())
 	{
-//		handleerror(hWnd, (&quot;Section &quot; + loclist[0] + &quot; missing in file &quot; + filename).c_str(), &quot;Sun parsing error&quot;, MBF_OK);
 		logOutput.Print (&quot;Section &quot; + loclist[0] + &quot; missing in file &quot; + filename);
 		return emptymap;
 	}
@@ -332,7 +287,6 @@
 		sit = sectionptr-&gt;sections.find(loclist[i]);
 		if(sit == sectionptr-&gt;sections.end())
 		{
-//			handleerror(hWnd, (&quot;Section &quot; + searchpath + &quot; missing in file &quot; + filename).c_str(), &quot;Sun parsing error&quot;, MBF_OK);
 			logOutput.Print (&quot;Section &quot; + searchpath + &quot; missing in file &quot; + filename);
 			return emptymap;
 		}
@@ -356,7 +310,6 @@
 			searchpath += loclist[i];
 			if(sectionsptr-&gt;find(loclist[i]) == sectionsptr-&gt;end())
 			{
-//				handleerror(hWnd, (&quot;Section &quot; + searchpath + &quot; missing in file &quot; + filename).c_str(), &quot;Sun parsing error&quot;, MBF_OK);
 				logOutput.Print (&quot;Section &quot; + searchpath + &quot; missing in file &quot; + filename);
 				return returnvec;
 			}
@@ -413,27 +366,6 @@
   return loclist;
 }
 
-/*
-template&lt;typename T&gt;
-void TdfParser::GetMsg(T&amp; value, const std::string&amp; key)
-{
-	std::string str;
-	str = SGetValueMSG(key);
-	std::stringstream stream;
-	stream &lt;&lt; str;
-	stream &gt;&gt; value;
-}
-
-template&lt;typename T&gt;
-void TdfParser::GetDef(T&amp; value, const std::string&amp; key, const std::string&amp; defvalue)
-{
-	std::string str;
-	str = SGetValueDef(key, defvalue);
-	std::stringstream stream;
-	stream &lt;&lt; str;
-	stream &gt;&gt; value;
-}*/
-
 float3 TdfParser::GetFloat3(float3 def, std::string const&amp; location) const
 {
 	std::string s=SGetValueDef(&quot;&quot;,location);
@@ -443,23 +375,3 @@
 	ParseArray(s,&amp;ret.x,3);
 	return ret;
 }
-
-#ifdef TEST
-int main(int argc, char **argv) {
-  try{
-    while( --argc ) {
-      std::cout &lt;&lt; &quot;Parsing : &quot; &lt;&lt;  argv[argc] &lt;&lt; &quot; ... &quot;;
-      TdfParser p( argv[argc] );
-      p.print( std::cout );
-      std::cout &lt;&lt;&quot; Ok.&quot; &lt;&lt; std::endl;
-    }
-
-  }
-  catch( std::exception const&amp; e){
-    std::cout &lt;&lt; e.what();
-    return 1;
-  }
-  std::cout &lt;&lt; &quot;Fine&quot; &lt;&lt; std::endl;
-  return 0;
-}
-#endif

Modified: branches/caiinterface/rts/System/TdfParser.h
===================================================================
--- branches/caiinterface/rts/System/TdfParser.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/TdfParser.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -30,16 +30,23 @@
 	};
 	struct TdfSection
 	{
+		TdfSection* construct_subsection(const std::string&amp; name );
+		~TdfSection();
+		
 		std::map&lt;std::string, TdfSection*&gt; sections;
 		std::map&lt;std::string, std::string&gt; values;
 		void print( std::ostream &amp; out ) const;
-		void add_name_value( std::string const&amp; name, std::string&amp; value );
-		TdfSection* construct_subsection( std::string const&amp; name );
-
-		~TdfSection();
+		void add_name_value(const std::string&amp; name, const std::string&amp; value );
+		template&lt;typename T&gt;
+		void AddPair(const std::string&amp; key, const T&amp; value)
+		{
+			std::ostringstream buf;
+			buf &lt;&lt; value;
+			add_name_value(key, buf.str());
+		}
 	};
 
-	TdfParser();
+	TdfParser() {};
 	TdfParser( std::string const&amp; filename );
 	TdfParser( const char* buffer, std::size_t size );
 
@@ -66,6 +73,19 @@
 		*  @return returns true on success, false otherwise and error message in value.
 		*/
 	bool SGetValue(std::string &amp;value, std::string const&amp; location) const;
+	template &lt;typename T&gt;
+	bool GetValue(T&amp; val, const std::string&amp; location) const
+	{
+		std::string buf;
+		if (SGetValue(buf, location))
+		{
+			std::istringstream stream(buf);
+			stream &gt;&gt; val;
+			return true;
+		}
+		else
+			return false;
+	};
 
 	/**
 		*  Treat the value as a vector and fill out vec with the items.
@@ -139,6 +159,8 @@
 		stream &lt;&lt; str;
 		stream &gt;&gt; value;
 	}
+	
+	TdfSection* GetRootSection() {return &amp;root_section; };
 
 private:
 	TdfSection root_section;

Modified: branches/caiinterface/rts/System/creg/STL_Map.h
===================================================================
--- branches/caiinterface/rts/System/creg/STL_Map.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/creg/STL_Map.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,23 +1,29 @@
 #ifndef CR_MAP_TYPE_IMPL_H
 #define CR_MAP_TYPE_IMPL_H
 
-#include &quot;creg.h&quot;
-
-///@TODO gcc hash_map declared as deprecated, port to hash_map
 #ifdef _MSC_VER
 	#define SPRING_HASH_MAP stdext::hash_map
-	#define SPRING_HASH_MAP_H &lt;hash_map&gt;
+	#include &lt;hash_map&gt;
 #elif __GNUG__
-	#define SPRING_HASH_MAP __gnu_cxx::hash_map
-	#define SPRING_HASH_MAP_H &lt;ext/hash_map&gt;
+/* Test for GCC &gt;= 4.3.2 */
+	#if __GNUC__ &gt; 4 || \
+		(__GNUC__ == 4 &amp;&amp; (__GNUC_MINOR__ &gt; 3 || \
+						(__GNUC_MINOR__ == 3 &amp;&amp; \
+							__GNUC_PATCHLEVEL__ &gt;= 2)))
+		#include &lt;tr1/unordered_map&gt;
+		#define SPRING_HASH_MAP std::tr1::unordered_map
+	#else
+		#define SPRING_HASH_MAP __gnu_cxx::hash_map
+		#include &lt;ext/hash_map&gt;
+	#endif
 #else
 	#error Unsupported compiler
 #endif
 
 #include &lt;map&gt;
-// hash_map, defined in stdafx.h
-#include SPRING_HASH_MAP_H
 
+#include &quot;creg.h&quot;
+
 namespace creg
 {
 	// implement map insert() function with an interface common to all map types

Modified: branches/caiinterface/rts/System/creg/STL_Set.h
===================================================================
--- branches/caiinterface/rts/System/creg/STL_Set.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/creg/STL_Set.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,21 +1,26 @@
 #ifndef CR_SET_TYPE_IMPL_H
 #define CR_SET_TYPE_IMPL_H
 
-///@TODO gcc hash_set declared as deprecated, port to unordered_set
 #ifdef _MSC_VER
+	#include &lt;hash_set&gt;
 	#define SPRING_HASH_SET stdext::hash_set
-	#define SPRING_HASH_SET_H &lt;hash_set&gt;
 #elif __GNUG__
-	#define SPRING_HASH_SET __gnu_cxx::hash_set
-	#define SPRING_HASH_SET_H &lt;ext/hash_set&gt;
+	/* Test for GCC &gt;= 4.3.2 */
+	#if __GNUC__ &gt; 4 || \
+		(__GNUC__ == 4 &amp;&amp; (__GNUC_MINOR__ &gt; 3 || \
+						(__GNUC_MINOR__ == 3 &amp;&amp; \
+							__GNUC_PATCHLEVEL__ &gt;= 2)))
+		#include &lt;tr1/unordered_set&gt;
+		#define SPRING_HASH_SET std::tr1::unordered_set
+	#else
+		#define SPRING_HASH_SET __gnu_cxx::hash_set
+		#include &lt;ext/hash_set&gt;
+	#endif
 #else
 	#error Unsupported compiler
 #endif
 
 #include &lt;set&gt;
-// hash_set, defined in stdafx.h
-#include &quot;System/StdAfx.h&quot;
-#include SPRING_HASH_SET_H
 
 namespace creg
 {

Modified: branches/caiinterface/rts/System/creg/creg.cpp
===================================================================
--- branches/caiinterface/rts/System/creg/creg.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/creg/creg.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -20,7 +20,7 @@
 # define	operator_delete		::operator delete
 #endif
 
-#include &quot;System/Util.h&quot;
+#include &quot;Util.h&quot;
 #include &quot;creg.h&quot;
 
 using namespace creg;

Modified: branches/caiinterface/rts/System/myMath.h
===================================================================
--- branches/caiinterface/rts/System/myMath.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/System/myMath.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,7 +1,7 @@
 #ifndef MYMATH_H
 #define MYMATH_H
 
-#include &quot;Game/GlobalConstants.h&quot;
+#include &quot;Sim/Misc/GlobalConstants.h&quot;
 #include &quot;Vec2.h&quot;
 #include &quot;float3.h&quot;
 
@@ -123,7 +123,12 @@
 float LinePointDist(const float3&amp; l1, const float3&amp; l2, const float3&amp; p);
 float3 ClosestPointOnLine(const float3&amp; l1, const float3&amp; l2, const float3&amp; p);
 
-inline float Square(const float&amp; x)
+#ifndef __GNUC__
+#  define  __attribute__(x)  /*NOTHING*/
+#endif
+
+float Square(const float x) __attribute__((const));
+inline float Square(const float x)
 {
 	return x*x;
 }

Modified: branches/caiinterface/rts/build/scons/filelist.py
===================================================================
--- branches/caiinterface/rts/build/scons/filelist.py	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/build/scons/filelist.py	2008-11-13 00:10:39 UTC (rev 7028)
@@ -90,7 +90,7 @@
 		'rts/lib/streflop', # streflop is compiled with it's own Makefiles
 		'rts/System/Platform/BackgroundReader.cpp',
 		'rts/System/Platform/Mac', # Mac build uses XCode
-		'rts/System/Platform/Linux/DataDirLocater.cpp', # see SConstruct
+		'rts/System/FileSystem/DataDirLocater.cpp', # see SConstruct
 		#'rts/ExternalAI/Interface/LegacyCppWrapper', # only needed by AI libraries using the legacy C++ interface to connect with spring
 	]
 	# we may be called before we were configured (e.g. when cleaning)

Modified: branches/caiinterface/rts/build/scons/rts.py
===================================================================
--- branches/caiinterface/rts/build/scons/rts.py	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/build/scons/rts.py	2008-11-13 00:10:39 UTC (rev 7028)
@@ -101,7 +101,7 @@
 		('profile_use',       'Set to yes to compile with -fprofile-use to use profiling information', False),
 		('cpppath',           'Set path to extra header files', []),
 		('libpath',           'Set path to extra libraries', []),
-		('fpmath',            'Set to 387 or SSE on i386 and AMD64 architectures', '387'),
+		('fpmath',            'Set to 387 or SSE on i386 and AMD64 architectures', 'sse'),
 		('prefix',            'Install prefix used at runtime', '/usr/local'),
 		('installprefix',     'Install prefix used for installion', '$prefix'),
 		('datadir',           'Data directory (relative to prefix)', 'share/games/spring'),
@@ -140,7 +140,7 @@
 	# Use this to avoid an error message 'how to make target configure ?'
 	env.Alias('configure', None)
 
-	if not 'configure' in sys.argv and not ((env.has_key('is_configured') and env['is_configured'] == 6) or env.GetOption('clean')):
+	if not 'configure' in sys.argv and not ((env.has_key('is_configured') and env['is_configured'] == 8) or env.GetOption('clean')):
 		print &quot;Not configured or configure script updated.  Run `scons configure' first.&quot;
 		print &quot;Use `scons --help' to show available configure options to `scons configure'.&quot;
 		env.Exit(1)
@@ -175,7 +175,7 @@
 
 		args = makeHashTable(sys.argv)
 
-		env['is_configured'] = 6
+		env['is_configured'] = 8
 
 		if args.has_key('platform'): env['platform'] = args['platform']
 		else: env['platform'] = detect.platform()
@@ -337,7 +337,7 @@
 		bool_opt('syncdebug', False)
 		bool_opt('synccheck', True)
 		bool_opt('synctrace', False)
-		string_opt('fpmath', '387')
+		string_opt('fpmath', 'sse')
 
 		# If sync debugger is on, disable inlining, as it makes it much harder to follow backtraces.
 		if env['syncdebug']:
@@ -351,10 +351,11 @@
 		# Allow easy switching between 387 and SSE fpmath.
 		if env['fpmath']:
 			env['CCFLAGS'] += ['-mfpmath='+env['fpmath']]
-			if env['fpmath'] == 'sse':
+			if env['fpmath'] == '387':
 				print &quot;WARNING: SSE math vs X87 math is unsynced!&quot;
 				print &quot;WARNING: Do not go online with the binary you are currently building!&quot;
-				env['CCFLAGS'] += ['-msse', '-msse2']
+			else:
+				env['CCFLAGS'] += ['-msse']
 
 		env['CXXFLAGS'] = env['CCFLAGS']
 

Modified: branches/caiinterface/rts/build/vstudio8/rts.vcproj
===================================================================
--- branches/caiinterface/rts/build/vstudio8/rts.vcproj	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/build/vstudio8/rts.vcproj	2008-11-13 00:10:39 UTC (rev 7028)
@@ -3231,6 +3231,10 @@
 					&gt;
 				&lt;/File&gt;
 				&lt;File
+					RelativePath=&quot;..\..\Sim\Misc\CollisionVolume.cpp&quot;
+					&gt;
+				&lt;/File&gt;
+				&lt;File
 					RelativePath=&quot;..\..\Sim\Misc\CollisionVolume.h&quot;
 					&gt;
 				&lt;/File&gt;
@@ -5749,7 +5753,7 @@
 						&gt;
 						&lt;Tool
 							Name=&quot;VCCLCompilerTool&quot;
-							useprecompiledheader=&quot;0&quot;
+							UsePrecompiledHeader=&quot;0&quot;
 						/&gt;
 					&lt;/FileConfiguration&gt;
 					&lt;FileConfiguration
@@ -5757,7 +5761,7 @@
 						&gt;
 						&lt;Tool
 							Name=&quot;VCCLCompilerTool&quot;
-							useprecompiledheader=&quot;0&quot;
+							UsePrecompiledHeader=&quot;0&quot;
 						/&gt;
 					&lt;/FileConfiguration&gt;
 					&lt;FileConfiguration
@@ -5765,7 +5769,7 @@
 						&gt;
 						&lt;Tool
 							Name=&quot;VCCLCompilerTool&quot;
-							useprecompiledheader=&quot;0&quot;
+							UsePrecompiledHeader=&quot;0&quot;
 						/&gt;
 					&lt;/FileConfiguration&gt;
 				&lt;/File&gt;

Modified: branches/caiinterface/rts/lib/gml/gml.cpp
===================================================================
--- branches/caiinterface/rts/lib/gml/gml.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/rts/lib/gml/gml.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -36,9 +36,6 @@
 #ifdef USE_GML
 #include &quot;gmlcls.h&quot;
 #include &quot;LogOutput.h&quot;
-#include &quot;Platform/ConfigHandler.h&quot;
-ConfigHandler* ConfigHandler::instance = NULL;
-std::string ConfigHandler::configSource;
 
 #define EXEC_RUN (BYTE *)NULL
 #define EXEC_SYNC (BYTE *)-1
@@ -59,7 +56,7 @@
 int gmlThreadNumber=0;
 #endif
 
-int gmlThreadCountOverride=configHandler.GetInt(&quot;HardwareThreadCount&quot;, 0); // number of threads to use (can be manually overridden here)
+int gmlThreadCountOverride=0; // number of threads to use (can be manually overridden here)
 int gmlThreadCount=GML_CPU_COUNT; // number of threads to use
 int gmlItemsConsumed=0;
 

Modified: branches/caiinterface/tools/DedicatedServer/CMakeLists.txt
===================================================================
--- branches/caiinterface/tools/DedicatedServer/CMakeLists.txt	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/tools/DedicatedServer/CMakeLists.txt	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,4 +1,4 @@
-ADD_DEFINITIONS(-DSTREFLOP_X87) # should be in ../../CMakeLists.txt
+ADD_DEFINITIONS(-DSTREFLOP_SSE) # should be in ../../CMakeLists.txt
 ADD_DEFINITIONS(-DDEDICATED ${PIC_FLAG} -DNO_AVI)
 
 AUX_SOURCE_DIRECTORY(../../rts/System/Net/ netfiles)
@@ -7,13 +7,9 @@
 
 IF (UNIX)
 	SET(platformfiles
-		../../rts/System/Platform/Linux/UnixFileSystemHandler
-		../../rts/System/Platform/Linux/DataDirLocater
 		../../rts/System/Platform/Linux/DotfileHandler)
 ELSE (UNIX)
 	SET(platformfiles
-		../../rts/System/Platform/Win/WinFileSystemHandler
-		../../rts/System/Platform/Win/DataDirLocater
 		../../rts/System/Platform/Win/RegHandler)
 ENDIF (UNIX)
 
@@ -23,7 +19,6 @@
 	${platformfiles}
 	 ${netfiles}
 	../../rts/System/TdfParser
-	../../rts/System/Platform/FileSystem
 	../../rts/System/Platform/ConfigHandler
 	../../rts/System/LogOutput
 	../../rts/System/BaseNetProtocol

Modified: branches/caiinterface/tools/DedicatedServer/main.cpp
===================================================================
--- branches/caiinterface/tools/DedicatedServer/main.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/tools/DedicatedServer/main.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -1,7 +1,7 @@
 #include &quot;Game/GameServer.h&quot;
 #include &quot;GameSetup.h&quot;
 #include &quot;GameData.h&quot;
-#include &quot;System/Platform/FileSystem.h&quot;
+#include &quot;System/FileSystem/FileSystem.h&quot;
 #include &quot;System/FileSystem/ArchiveScanner.h&quot;
 #include &quot;System/FileSystem/VFSHandler.h&quot;
 #include &quot;System/FileSystem/FileHandler.h&quot;

Modified: branches/caiinterface/tools/unitsync/CMakeLists.txt
===================================================================
--- branches/caiinterface/tools/unitsync/CMakeLists.txt	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/tools/unitsync/CMakeLists.txt	2008-11-13 00:10:39 UTC (rev 7028)
@@ -39,24 +39,19 @@
 
 IF (UNIX)
 	SET(platformfiles
-		../../rts/System/Platform/Linux/UnixFileSystemHandler
-		../../rts/System/Platform/Linux/DataDirLocater
 		../../rts/System/Platform/Linux/DotfileHandler)
 ELSE (UNIX)
 	SET(platformfiles
-		../../rts/System/Platform/Win/WinFileSystemHandler
-		../../rts/System/Platform/Linux/DataDirLocater
 		../../rts/System/Platform/Win/RegHandler)
 ENDIF (UNIX)
 list(APPEND platformfiles
-	../../rts/System/Platform/FileSystem
 	../../rts/System/Platform/ConfigHandler)
 
 AUX_SOURCE_DIRECTORY(../../rts/System/FileSystem/ fsfiles)
 set(unitsync_files
 	../../rts/System/LogOutput
 	../../rts/System/TdfParser
-	../../rts/Sim/SideParser
+	../../rts/Sim/Misc/SideParser
 	../../rts/Game/GameVersion
 	../../rts/Lua/LuaParser
 	../../rts/Lua/LuaUtils

Copied: branches/caiinterface/tools/unitsync/Doxyfile (from rev 7023, trunk/tools/unitsync/Doxyfile)
===================================================================
--- branches/caiinterface/tools/unitsync/Doxyfile	                        (rev 0)
+++ branches/caiinterface/tools/unitsync/Doxyfile	2008-11-13 00:10:39 UTC (rev 7028)
@@ -0,0 +1,241 @@
+# Doxyfile 1.5.5
+
+#---------------------------------------------------------------------------
+# Project related configuration options
+#---------------------------------------------------------------------------
+DOXYFILE_ENCODING      = UTF-8
+PROJECT_NAME           = Unitsync
+PROJECT_NUMBER         = 
+OUTPUT_DIRECTORY       = doc
+CREATE_SUBDIRS         = NO
+OUTPUT_LANGUAGE        = English
+BRIEF_MEMBER_DESC      = YES
+REPEAT_BRIEF           = NO
+ABBREVIATE_BRIEF       = 
+ALWAYS_DETAILED_SEC    = NO
+INLINE_INHERITED_MEMB  = NO
+FULL_PATH_NAMES        = NO
+STRIP_FROM_PATH        = 
+STRIP_FROM_INC_PATH    = 
+SHORT_NAMES            = NO
+JAVADOC_AUTOBRIEF      = NO
+QT_AUTOBRIEF           = NO
+MULTILINE_CPP_IS_BRIEF = NO
+DETAILS_AT_TOP         = NO
+INHERIT_DOCS           = YES
+SEPARATE_MEMBER_PAGES  = NO
+TAB_SIZE               = 4
+ALIASES                = 
+OPTIMIZE_OUTPUT_FOR_C  = NO
+OPTIMIZE_OUTPUT_JAVA   = NO
+OPTIMIZE_FOR_FORTRAN   = NO
+OPTIMIZE_OUTPUT_VHDL   = NO
+BUILTIN_STL_SUPPORT    = YES
+CPP_CLI_SUPPORT        = NO
+SIP_SUPPORT            = NO
+DISTRIBUTE_GROUP_DOC   = NO
+SUBGROUPING            = YES
+TYPEDEF_HIDES_STRUCT   = NO
+#---------------------------------------------------------------------------
+# Build related configuration options
+#---------------------------------------------------------------------------
+EXTRACT_ALL            = NO
+EXTRACT_PRIVATE        = NO
+EXTRACT_STATIC         = NO
+EXTRACT_LOCAL_CLASSES  = NO
+EXTRACT_LOCAL_METHODS  = NO
+EXTRACT_ANON_NSPACES   = NO
+HIDE_UNDOC_MEMBERS     = YES
+HIDE_UNDOC_CLASSES     = YES
+HIDE_FRIEND_COMPOUNDS  = NO
+HIDE_IN_BODY_DOCS      = NO
+INTERNAL_DOCS          = NO
+CASE_SENSE_NAMES       = YES
+HIDE_SCOPE_NAMES       = NO
+SHOW_INCLUDE_FILES     = YES
+INLINE_INFO            = YES
+SORT_MEMBER_DOCS       = YES
+SORT_BRIEF_DOCS        = NO
+SORT_GROUP_NAMES       = NO
+SORT_BY_SCOPE_NAME     = NO
+GENERATE_TODOLIST      = YES
+GENERATE_TESTLIST      = YES
+GENERATE_BUGLIST       = YES
+GENERATE_DEPRECATEDLIST= YES
+ENABLED_SECTIONS       = 
+MAX_INITIALIZER_LINES  = 30
+SHOW_USED_FILES        = YES
+SHOW_DIRECTORIES       = YES
+FILE_VERSION_FILTER    = 
+#---------------------------------------------------------------------------
+# configuration options related to warning and progress messages
+#---------------------------------------------------------------------------
+QUIET                  = NO
+WARNINGS               = YES
+WARN_IF_UNDOCUMENTED   = NO
+WARN_IF_DOC_ERROR      = YES
+WARN_NO_PARAMDOC       = NO
+WARN_FORMAT            = &quot;$file:$line: $text  &quot;
+WARN_LOGFILE           = 
+#---------------------------------------------------------------------------
+# configuration options related to the input files
+#---------------------------------------------------------------------------
+INPUT                  = unitsync.cpp \
+                         unitsync.h
+INPUT_ENCODING         = UTF-8
+FILE_PATTERNS          = 
+RECURSIVE              = NO
+EXCLUDE                = 
+EXCLUDE_SYMLINKS       = NO
+EXCLUDE_PATTERNS       = 
+EXCLUDE_SYMBOLS        = 
+EXAMPLE_PATH           = 
+EXAMPLE_PATTERNS       = 
+EXAMPLE_RECURSIVE      = NO
+IMAGE_PATH             = 
+INPUT_FILTER           = 
+FILTER_PATTERNS        = 
+FILTER_SOURCE_FILES    = NO
+#---------------------------------------------------------------------------
+# configuration options related to source browsing
+#---------------------------------------------------------------------------
+SOURCE_BROWSER         = NO
+INLINE_SOURCES         = NO
+STRIP_CODE_COMMENTS    = YES
+REFERENCED_BY_RELATION = YES
+REFERENCES_RELATION    = YES
+REFERENCES_LINK_SOURCE = YES
+USE_HTAGS              = NO
+VERBATIM_HEADERS       = NO
+#---------------------------------------------------------------------------
+# configuration options related to the alphabetical class index
+#---------------------------------------------------------------------------
+ALPHABETICAL_INDEX     = NO
+COLS_IN_ALPHA_INDEX    = 5
+IGNORE_PREFIX          = 
+#---------------------------------------------------------------------------
+# configuration options related to the HTML output
+#---------------------------------------------------------------------------
+GENERATE_HTML          = YES
+HTML_OUTPUT            = html
+HTML_FILE_EXTENSION    = .html
+HTML_HEADER            = 
+HTML_FOOTER            = 
+HTML_STYLESHEET        = 
+HTML_ALIGN_MEMBERS     = YES
+GENERATE_HTMLHELP      = NO
+GENERATE_DOCSET        = NO
+DOCSET_FEEDNAME        = &quot;Doxygen generated docs&quot;
+DOCSET_BUNDLE_ID       = org.doxygen.Project
+HTML_DYNAMIC_SECTIONS  = NO
+CHM_FILE               = 
+HHC_LOCATION           = 
+GENERATE_CHI           = NO
+BINARY_TOC             = NO
+TOC_EXPAND             = NO
+DISABLE_INDEX          = NO
+ENUM_VALUES_PER_LINE   = 4
+GENERATE_TREEVIEW      = NO
+TREEVIEW_WIDTH         = 250
+#---------------------------------------------------------------------------
+# configuration options related to the LaTeX output
+#---------------------------------------------------------------------------
+GENERATE_LATEX         = NO
+LATEX_OUTPUT           = latex
+LATEX_CMD_NAME         = latex
+MAKEINDEX_CMD_NAME     = makeindex
+COMPACT_LATEX          = NO
+PAPER_TYPE             = a4wide
+EXTRA_PACKAGES         = 
+LATEX_HEADER           = 
+PDF_HYPERLINKS         = NO
+USE_PDFLATEX           = NO
+LATEX_BATCHMODE        = NO
+LATEX_HIDE_INDICES     = NO
+#---------------------------------------------------------------------------
+# configuration options related to the RTF output
+#---------------------------------------------------------------------------
+GENERATE_RTF           = NO
+RTF_OUTPUT             = rtf
+COMPACT_RTF            = NO
+RTF_HYPERLINKS         = NO
+RTF_STYLESHEET_FILE    = 
+RTF_EXTENSIONS_FILE    = 
+#---------------------------------------------------------------------------
+# configuration options related to the man page output
+#---------------------------------------------------------------------------
+GENERATE_MAN           = NO
+MAN_OUTPUT             = man
+MAN_EXTENSION          = .3
+MAN_LINKS              = NO
+#---------------------------------------------------------------------------
+# configuration options related to the XML output
+#---------------------------------------------------------------------------
+GENERATE_XML           = NO
+XML_OUTPUT             = xml
+XML_SCHEMA             = 
+XML_DTD                = 
+XML_PROGRAMLISTING     = YES
+#---------------------------------------------------------------------------
+# configuration options for the AutoGen Definitions output
+#---------------------------------------------------------------------------
+GENERATE_AUTOGEN_DEF   = NO
+#---------------------------------------------------------------------------
+# configuration options related to the Perl module output
+#---------------------------------------------------------------------------
+GENERATE_PERLMOD       = NO
+PERLMOD_LATEX          = NO
+PERLMOD_PRETTY         = YES
+PERLMOD_MAKEVAR_PREFIX = 
+#---------------------------------------------------------------------------
+# Configuration options related to the preprocessor   
+#---------------------------------------------------------------------------
+ENABLE_PREPROCESSING   = YES
+MACRO_EXPANSION        = YES
+EXPAND_ONLY_PREDEF     = YES
+SEARCH_INCLUDES        = YES
+INCLUDE_PATH           = 
+INCLUDE_FILE_PATTERNS  = 
+PREDEFINED             = DLL_EXPORT= \
+                         __stdcall=
+EXPAND_AS_DEFINED      = 
+SKIP_FUNCTION_MACROS   = YES
+#---------------------------------------------------------------------------
+# Configuration::additions related to external references   
+#---------------------------------------------------------------------------
+TAGFILES               = 
+GENERATE_TAGFILE       = 
+ALLEXTERNALS           = NO
+EXTERNAL_GROUPS        = YES
+PERL_PATH              = /usr/bin/perl
+#---------------------------------------------------------------------------
+# Configuration options related to the dot tool   
+#---------------------------------------------------------------------------
+CLASS_DIAGRAMS         = YES
+MSCGEN_PATH            = 
+HIDE_UNDOC_RELATIONS   = YES
+HAVE_DOT               = NO
+CLASS_GRAPH            = YES
+COLLABORATION_GRAPH    = YES
+GROUP_GRAPHS           = YES
+UML_LOOK               = NO
+TEMPLATE_RELATIONS     = NO
+INCLUDE_GRAPH          = YES
+INCLUDED_BY_GRAPH      = YES
+CALL_GRAPH             = YES
+CALLER_GRAPH           = YES
+GRAPHICAL_HIERARCHY    = YES
+DIRECTORY_GRAPH        = YES
+DOT_IMAGE_FORMAT       = png
+DOT_PATH               = 
+DOTFILE_DIRS           = 
+DOT_GRAPH_MAX_NODES    = 50
+MAX_DOT_GRAPH_DEPTH    = 0
+DOT_TRANSPARENT        = NO
+DOT_MULTI_TARGETS      = YES
+GENERATE_LEGEND        = YES
+DOT_CLEANUP            = YES
+#---------------------------------------------------------------------------
+# Configuration::additions related to the search engine   
+#---------------------------------------------------------------------------
+SEARCHENGINE           = NO

Modified: branches/caiinterface/tools/unitsync/javabind.cpp
===================================================================
--- branches/caiinterface/tools/unitsync/javabind.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/tools/unitsync/javabind.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -7,7 +7,7 @@
 #include &quot;FileSystem/VFSHandler.h&quot;
 #include &quot;Map/SMF/mapfile.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;Rendering/Textures/Bitmap.h&quot;
 
 #include &lt;string&gt;

Modified: branches/caiinterface/tools/unitsync/pybind.cpp
===================================================================
--- branches/caiinterface/tools/unitsync/pybind.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/tools/unitsync/pybind.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -14,7 +14,7 @@
 #include &lt;cstring&gt;
 #include &quot;unitsync.h&quot;
 #include &quot;Rendering/Textures/Bitmap.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 
 #define NAMEBUF_SIZE 4096
 

Modified: branches/caiinterface/tools/unitsync/unitsync.cpp
===================================================================
--- branches/caiinterface/tools/unitsync/unitsync.cpp	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/tools/unitsync/unitsync.cpp	2008-11-13 00:10:39 UTC (rev 7028)
@@ -17,9 +17,9 @@
 #include &quot;Map/MapParser.h&quot;
 #include &quot;Map/SMF/SmfMapFile.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;Rendering/Textures/Bitmap.h&quot;
-#include &quot;Sim/SideParser.h&quot;
+#include &quot;Sim/Misc/SideParser.h&quot;
 #include &quot;ExternalAI/Interface/aidefines.h&quot;
 #include &quot;ExternalAI/Interface/SSAILibrary.h&quot;
 #include &quot;System/Exceptions.h&quot;
@@ -59,7 +59,7 @@
 		COneTimeInit()
 		{
 			logOutput.SetFilename(&quot;unitsync.log&quot;);
-			logOutput.Print(LOG_UNITSYNC, &quot;loaded, %s\n&quot;, VERSION_STRING_DETAILED);
+			logOutput.Print(LOG_UNITSYNC, &quot;loaded, %s\n&quot;, SpringVersion::GetFull().c_str());
 		}
 	};
 }
@@ -168,8 +168,12 @@
 //////////////////////////
 //////////////////////////
 
+/** @addtogroup unitsync_api
+	@{ */
+
 /**
- * @brief returns next error in queue of errors and removes this error from queue
+ * @brief Retrieve next error in queue of errors and removes this error from queue
+ * @return An error message, or NULL if there are no more errors in the queue
  *
  * Use this method to get a (short) description of errors that occurred in any
  * other unitsync methods. Call this in a loop until it returns NULL to get all
@@ -179,9 +183,11 @@
  * them, not even whether they have terminating newline or not.
  *
  * Example:
+ *		@code
  *		const char* err;
  *		while ((err = GetNextError()) != NULL)
  *			printf(&quot;unitsync error: %s\n&quot;, err);
+ *		@endcode
  */
 Export(const char*) GetNextError()
 {
@@ -204,20 +210,21 @@
 
 
 /**
- * @brief returns the version fo spring this was compiled with
+ * @brief Retrieve the version of Spring this unitsync was compiled with
+ * @return The Spring/unitsync version string
  *
  * Returns a const char* string specifying the version of spring used to build this library with.
  * It was added to aid in lobby creation, where checks for updates to spring occur.
  */
 Export(const char*) GetSpringVersion()
 {
-	return VERSION_STRING;
+	return SpringVersion::Get().c_str();
 }
 
 
 /**
  * @brief Creates a messagebox with said message
- * @param p_szMessage const char* string holding the message
+ * @param p_szMessage string holding the message
  *
  * Creates a messagebox with the title &quot;Message from DLL&quot;, an OK button, and the specified message
  */
@@ -253,7 +260,7 @@
 
 
 /**
- * @brief uninitialize the unitsync library
+ * @brief Uninitialize the unitsync library
  */
 Export(void) UnInit()
 {
@@ -265,13 +272,17 @@
 
 
 /**
- * @brief initialize the unitsync library
+ * @brief Initialize the unitsync library
+ * @return Zero on error; non-zero on success
  *
  * Call this function before calling any other function in unitsync.
  * In case unitsync was already initialized, it is uninitialized and then
  * reinitialized.
  *
- * @return zero on failure, non-zero on success
+ * Calling this function is currently the only way to clear the VFS of the
+ * files which are mapped into it.  In other words, after using AddArchive() or
+ * AddAllArchives() you have to call Init when you want to remove the archives
+ * from the VFS and start with a clean state.
  */
 Export(int) Init(bool isServer, int id)
 {
@@ -294,7 +305,7 @@
 		}
 
 		syncer = new CSyncer();
-		logOutput.Print(LOG_UNITSYNC, &quot;initialized, %s\n&quot;, VERSION_STRING_DETAILED);
+		logOutput.Print(LOG_UNITSYNC, &quot;initialized, %s\n&quot;, SpringVersion::GetFull().c_str());
 		logOutput.Print(LOG_UNITSYNC, &quot;%s\n&quot;, isServer ? &quot;hosting&quot; : &quot;joining&quot;);
 		return 1;
 	}
@@ -304,7 +315,10 @@
 
 
 /**
- * @brief get the main, writable, data directory that's used by unitsync and Spring
+ * @brief Get the main data directory that's used by unitsync and Spring
+ * @return NULL on error; the data directory path on success
+ *
+ * This is the data directory which is used to write logs, screenshots, demos, etc.
  */
 Export(const char*) GetWritableDataDirectory()
 {
@@ -320,13 +334,17 @@
 
 
 /**
- * @brief process another unit and return how many are left to process
- * @return int The number of unprocessed units to be handled
+ * @brief Process another unit and return how many are left to process
+ * @return The number of unprocessed units to be handled
  *
- * Call this function repeatedly until it returns 0 before calling any other function related to units.
+ * Call this function repeatedly until it returns 0 before calling any other
+ * function related to units.
  *
  * Because of risk for infinite loops, this function can not return any error code.
  * It is advised to poll GetNextError() after calling this function.
+ *
+ * Before any units are available, you'll first need to map a mod's archives
+ * into the VFS using AddArchive() or AddAllArchives().
  */
 Export(int) ProcessUnits(void)
 {
@@ -340,7 +358,8 @@
 
 
 /**
- * @brief identical to ProcessUnits, neither generates checksum anymore
+ * @brief Identical to ProcessUnits(), neither generates checksum anymore
+ * @see ProcessUnits
  */
 Export(int) ProcessUnitsNoChecksum(void)
 {
@@ -349,16 +368,18 @@
 
 
 /**
- * @brief returns the number of units
- * @return int number of units processed and available, 0 on error
+ * @brief Get the number of units
+ * @return Zero on error; the number of units available on success
  *
- * Will return the number of units. Remember to call processUnits() beforehand until it returns 0.
- * As ProcessUnits is called the number of processed units goes up, and so will the value returned
- * by this function.
+ * Will return the number of units. Remember to call ProcessUnits() beforehand
+ * until it returns 0.  As ProcessUnits() is called the number of processed
+ * units goes up, and so will the value returned by this function.
  *
  * Example:
- *		while (ProcessUnits()) {}
+ *		@code
+ *		while (ProcessUnits() != 0) {}
  *		int unit_number = GetUnitCount();
+ *		@endcode
  */
 Export(int) GetUnitCount()
 {
@@ -372,12 +393,12 @@
 
 
 /**
- * @brief returns the units internal mod name
- * @param int the units id number
- * @return const char* The units internal modname or NULL on error.
+ * @brief Get the units internal mod name
+ * @param unit The units id number
+ * @return The units internal modname or NULL on error
  *
- * This function returns the units internal mod name. For example it would return armck and not
- * Arm Construction kbot.
+ * This function returns the units internal mod name. For example it would
+ * return 'armck' and not 'Arm Construction kbot'.
  */
 Export(const char*) GetUnitName(int unit)
 {
@@ -392,12 +413,12 @@
 
 
 /**
- * @brief returns The units human readable name
- * @param int The units id number
- * @return const char* The Units human readable name or NULL on error.
+ * @brief Get the units human readable name
+ * @param unit The units id number
+ * @return The units human readable name or NULL on error
  *
- * This function returns the units human name. For example it would return Arm Construction kbot
- * and not armck.
+ * This function returns the units human name. For example it would return
+ * 'Arm Construction kbot' and not 'armck'.
  */
 Export(const char*) GetFullUnitName(int unit)
 {
@@ -414,10 +435,10 @@
 //////////////////////////
 
 /**
- * @brief adds an archive to the VFS (Virtual File System)
+ * @brief Adds an archive to the VFS (Virtual File System)
  *
  * After this, the contents of the archive are available to other unitsync functions,
- * for example: OpenFileVFS, ReadFileVFS, FileSizeVFS, etc.
+ * for example: ProcessUnits(), OpenFileVFS(), ReadFileVFS(), FileSizeVFS(), etc.
  */
 Export(void) AddArchive(const char* name)
 {
@@ -433,10 +454,8 @@
 
 
 /**
- * @brief adds an achive and all it's dependencies to the VFS
- *
- * After this, the contents of the archive are available to other unitsync functions,
- * for example: OpenFileVFS, ReadFileVFS, FileSizeVFS, etc.
+ * @brief Adds an achive and all it's dependencies to the VFS
+ * @see AddArchive
  */
 Export(void) AddAllArchives(const char* root)
 {
@@ -455,7 +474,8 @@
 
 
 /**
- * @brief gets checksum of an archive
+ * @brief Get checksum of an archive
+ * @return Zero on error; the checksum on success
  *
  * This checksum depends only on the contents from the archive itself, and not
  * on the contents from dependencies of this archive (if any).
@@ -475,7 +495,8 @@
 
 
 /**
- * @brief gets the real path to the archive
+ * @brief Gets the real path to the archive
+ * @return NULL on error; a path to the archive on success
  */
 Export(const char*) GetArchivePath(const char* arname)
 {
@@ -496,9 +517,22 @@
 
 
 /**
- * @brief gets the number of maps available
+ * @brief Get the number of maps available
+ * @return Zero on error; the number of maps available on success
  *
  * Call this before any of the map functions which take a map index as parameter.
+ * This function actually performs a relatively costly enumeration of all maps,
+ * so you should resist from calling it repeatedly in a loop.  Rather use:
+ *		@code
+ *		int map_count = GetMapCount();
+ *		for (int index = 0; index &lt; map_count; ++index) {
+ *			printf(&quot;map name: %s\n&quot;, GetMapName(index));
+ *		}
+ *		@endcode
+ * Then:
+ *		@code
+ *		for (int index = 0; index &lt; GetMapCount(); ++index) { ... }
+ *		@endcode
  */
 Export(int) GetMapCount()
 {
@@ -527,7 +561,8 @@
 
 
 /**
- * @brief get the name of a map, e.g. &quot;SmallDivide.smf&quot;
+ * @brief Get the name of a map
+ * @return NULL on error; the name of the map (e.g. &quot;SmallDivide.smf&quot;) on success
  */
 Export(const char*) GetMapName(int index)
 {
@@ -651,11 +686,11 @@
 
 
 /**
- * @brief get map info
+ * @brief Retrieve map info
  * @param name name of the map, e.g. &quot;SmallDivide.smf&quot;
  * @param outInfo pointer to structure which is filled with map info
  * @param version this determines which fields of the MapInfo structure are filled
- * @return zero on failure, non-zero on success
+ * @return Zero on error; non-zero on success
  *
  * If version &gt;= 1, then the author field is filled.
  */
@@ -670,10 +705,11 @@
 
 
 /**
- * @brief get map info, equivalent to GetMapInfoEx(name, outInfo, 0)
+ * @brief Retrieve map info, equivalent to GetMapInfoEx(name, outInfo, 0)
  * @param name name of the map, e.g. &quot;SmallDivide.smf&quot;
  * @param outInfo pointer to structure which is filled with map info
- * @return zero on failure, non-zero on success
+ * @return Zero on error; non-zero on success
+ * @see GetMapInfoEx
  */
 Export(int) GetMapInfo(const char* name, MapInfo* outInfo)
 {
@@ -687,6 +723,14 @@
 
 static vector&lt;string&gt; mapArchives;
 
+
+/**
+ * @brief Retrieves the number of archives a map requires
+ * @param mapName name of the map, e.g. &quot;SmallDivide.smf&quot;
+ * @return Zero on error; the number of archives on success
+ *
+ * Must be called before GetMapArchiveName()
+ */
 Export(int) GetMapArchiveCount(const char* mapName)
 {
 	try {
@@ -700,6 +744,12 @@
 	return 0;
 }
 
+
+/**
+ * @brief Retrieves an archive a map requires
+ * @param index the index of the archive
+ * @return NULL on error; the name of the archive on success
+ */
 Export(const char*) GetMapArchiveName(int index)
 {
 	try {
@@ -712,6 +762,17 @@
 	return NULL;
 }
 
+
+/**
+ * @brief Get map checksum given a map index
+ * @param index the index of the map
+ * @return Zero on error; the checksum on success
+ *
+ * This checksum depends on Spring internals, and as such should not be expected
+ * to remain stable between releases.
+ *
+ * (It is ment to check sync between clients in lobby, for example.)
+ */
 Export(unsigned int) GetMapChecksum(int index)
 {
 	try {
@@ -724,6 +785,13 @@
 	return 0;
 }
 
+
+/**
+ * @brief Get map checksum given a map name
+ * @param mapName name of the map, e.g. &quot;SmallDivide.smf&quot;
+ * @return Zero on error; the checksum on success
+ * @see GetMapChecksum
+ */
 Export(unsigned int) GetMapChecksumFromName(const char* mapName)
 {
 	try {
@@ -735,6 +803,7 @@
 	return 0;
 }
 
+
 #define RM	0x0000F800
 #define GM  0x000007E0
 #define BM  0x0000001F
@@ -878,12 +947,10 @@
  * 4x4 image.
  * @return A pointer to a static memory area containing the minimap as a 16 bit
  * packed RGB-565 (MSB to LSB: 5 bits red, 6 bits green, 5 bits blue) linear
- * bitmap.
+ * bitmap on success; NULL on error.
  *
  * An example usage would be GetMinimap(&quot;SmallDivide.smf&quot;, 2).
  * This would return a 16 bit packed RGB-565 256x256 (= 1024/2^2) bitmap.
- *
- * Be sure you've made a call to Init prior to using this.
  */
 Export(void*) GetMinimap(const char* filename, int miplevel)
 {
@@ -920,7 +987,7 @@
  * @param name     Of which infomap to retrieve the dimensions.
  * @param width    This is set to the width of the infomap, or 0 on error.
  * @param height   This is set to the height of the infomap, or 0 on error.
- * @return 1 when the infomap was found with a nonzero size, 0 on error.
+ * @return Non-zero when the infomap was found with a non-zero size; zero on error.
  * @see GetInfoMap
  */
 Export(int) GetInfoMapSize(const char* filename, const char* name, int* width, int* height)
@@ -956,9 +1023,9 @@
  * @param name     Which infomap to extract from the file.
  * @param data     Pointer to memory location with enough room to hold the infomap data.
  * @param typeHint One of bm_grayscale_8 (or 1) and bm_grayscale_16 (or 2).
- * @return 1 if the infomap was succesfully extracted (and optionally converted),
- * or 0 on error (map wasn't found, infomap wasn't found, or typeHint could not
- * be honoured.)
+ * @return Non-zero if the infomap was succesfully extracted (and optionally
+ * converted), or zero on error (map wasn't found, infomap wasn't found, or
+ * typeHint could not be honoured.)
  *
  * This function extracts an infomap from a map. This can currently be one of:
  * &quot;height&quot;, &quot;metal&quot;, &quot;grass&quot;, &quot;type&quot;. The heightmap is natively in 16 bits per
@@ -1019,11 +1086,9 @@
 
 
 /**
- * @brief Retrieves the name of this mod
- * @return int The number of mods
- *
- * Returns the name of the mod usually found in modinfo.tdf.
- * Be sure you've made calls to Init and GetPrimaryModCount prior to using this.
+ * @brief Retrieves the number of mods available
+ * @return int Zero on error; The number of mods available on success
+ * @see GetMapCount
  */
 Export(int) GetPrimaryModCount()
 {
@@ -1040,11 +1105,11 @@
 
 /**
  * @brief Retrieves the name of this mod
- * @param index in The mods index/id
- * @return const char* The mods name
+ * @param index The mods index/id
+ * @return NULL on error; The mods name on success
  *
  * Returns the name of the mod usually found in modinfo.tdf.
- * Be sure you've made calls to Init and GetPrimaryModCount prior to using this.
+ * Be sure you've made a call to GetPrimaryModCount() prior to using this.
  */
 Export(const char*) GetPrimaryModName(int index)
 {
@@ -1062,11 +1127,11 @@
 
 /**
  * @brief Retrieves the shortened name of this mod
- * @param index in The mods index/id
- * @return const char* The mods abbrieviated name
+ * @param index The mods index/id
+ * @return NULL on error; The mods abbrieviated name on success
  *
  * Returns the shortened name of the mod usually found in modinfo.tdf.
- * Be sure you've made calls to Init and GetPrimaryModCount prior to using this.
+ * Be sure you've made a call GetPrimaryModCount() prior to using this.
  */
 Export(const char*) GetPrimaryModShortName(int index)
 {
@@ -1084,11 +1149,11 @@
 
 /**
  * @brief Retrieves the version string of this mod
- * @param index in The mods index/id
- * @return const char* The mods version string
+ * @param index The mods index/id
+ * @return NULL on error; The mods version string on success
  *
  * Returns value of the mutator tag for the specified mod usually found in modinfo.tdf.
- * Be sure you've made calls to Init and GetPrimaryModCount prior to using this.
+ * Be sure you've made a call to GetPrimaryModCount() prior to using this.
  */
 Export(const char*) GetPrimaryModVersion(int index)
 {
@@ -1106,11 +1171,11 @@
 
 /**
  * @brief Retrieves the mutator name of this mod
- * @param index in The mods index/id
- * @return const char* The mods mutator name
+ * @param index The mods index/id
+ * @return NULL on error; The mods mutator name on success
  *
  * Returns value of the mutator tag for the specified mod usually found in modinfo.tdf.
- * Be sure you've made calls to Init and GetPrimaryModCount prior to using this.
+ * Be sure you've made a call to GetPrimaryModCount() prior to using this.
  */
 Export(const char*) GetPrimaryModMutator(int index)
 {
@@ -1128,11 +1193,11 @@
 
 /**
  * @brief Retrieves the game name of this mod
- * @param index in The mods index/id
- * @return const char* The mods game
+ * @param index The mods index/id
+ * @return NULL on error; The mods game name on success
  *
  * Returns the name of the game this mod belongs to usually found in modinfo.tdf.
- * Be sure you've made calls to Init and GetPrimaryModCount prior to using this.
+ * Be sure you've made a call to GetPrimaryModCount() prior to using this.
  */
 Export(const char*) GetPrimaryModGame(int index)
 {
@@ -1150,11 +1215,11 @@
 
 /**
  * @brief Retrieves the short game name of this mod
- * @param index in The mods index/id
- * @return const char* The mods abbrieviated game name
+ * @param index The mods index/id
+ * @return NULL on error; The mods abbrieviated game name on success
  *
  * Returns the abbrieviated name of the game this mod belongs to usually found in modinfo.tdf.
- * Be sure you've made calls to Init and GetPrimaryModCount prior to using this.
+ * Be sure you've made a call to GetPrimaryModCount() prior to using this.
  */
 Export(const char*) GetPrimaryModShortGame(int index)
 {
@@ -1172,11 +1237,11 @@
 
 /**
  * @brief Retrieves the description of this mod
- * @param index in The mods index/id
- * @return const char* The mods description
+ * @param index The mods index/id
+ * @return NULL on error; The mods description on success
  *
  * Returns a description for the specified mod usually found in modinfo.tdf.
- * Be sure you've made calls to Init and GetPrimaryModCount prior to using this.
+ * Be sure you've made a call to GetPrimaryModCount() prior to using this.
  */
 Export(const char*) GetPrimaryModDescription(int index)
 {
@@ -1192,6 +1257,14 @@
 }
 
 
+/**
+ * @brief Retrieves the mod's first/primary archive
+ * @param index The mods index/id
+ * @return NULL on error; The mods primary archive on success
+ *
+ * Returns the name of the primary archive of the mod.
+ * Be sure you've made a call to GetPrimaryModCount() prior to using this.
+ */
 Export(const char*) GetPrimaryModArchive(int index)
 {
 	try {
@@ -1209,13 +1282,19 @@
 
 /**
  * @brief Retrieves the number of archives a mod requires
- * @param index int The index of the mod
- * @return the number of archives this mod depends on.
+ * @param index The index of the mod
+ * @return Zero on error; the number of archives this mod depends on otherwise
  *
  * This is used to get the entire list of archives that a mod requires.
  * Call GetPrimaryModArchiveCount() with selected mod first to get number of
  * archives, and then use GetPrimaryModArchiveList() for 0 to count-1 to get the
- * name of each archive.
+ * name of each archive.  In code:
+ *		@code
+ *		int count = GetPrimaryModArchiveCount(mod_index);
+ *		for (int arnr = 0; arnr &lt; count; ++arnr) {
+ *			printf(&quot;primary mod archive: %s\n&quot;, GetPrimaryModArchiveList(arnr));
+ *		}
+ *		@endcode
  */
 Export(int) GetPrimaryModArchiveCount(int index)
 {
@@ -1230,11 +1309,12 @@
 	return 0;
 }
 
+
 /**
  * @brief Retrieves the name of the current mod's archive.
- * @param arnr The mod's archive index/id.
- * @return the name of the archive
- * @see GetPrimaryModArchiveCount()
+ * @param arnr The archive's index/id.
+ * @return NULL on error; the name of the archive on success
+ * @see GetPrimaryModArchiveCount
  */
 Export(const char*) GetPrimaryModArchiveList(int archiveNr)
 {
@@ -1249,6 +1329,12 @@
 	return NULL;
 }
 
+
+/**
+ * @brief The reverse of GetPrimaryModName()
+ * @param name The name of the mod
+ * @return -1 if the mod can not be found; the index of the mod otherwise
+ */
 Export(int) GetPrimaryModIndex(const char* name)
 {
 	try {
@@ -1266,6 +1352,13 @@
 	return -1;
 }
 
+
+/**
+ * @brief Get checksum of mod
+ * @param index The mods index/id
+ * @return Zero on error; the checksum on success.
+ * @see GetMapChecksum
+ */
 Export(unsigned int) GetPrimaryModChecksum(int index)
 {
 	try {
@@ -1278,6 +1371,13 @@
 	return 0;
 }
 
+
+/**
+ * @brief Get checksum of mod given the mod's name
+ * @param name The name of the mod
+ * @return Zero on error; the checksum on success.
+ * @see GetMapChecksum
+ */
 Export(unsigned int) GetPrimaryModChecksumFromName(const char* name)
 {
 	try {
@@ -1293,6 +1393,14 @@
 //////////////////////////
 //////////////////////////
 
+/**
+ * @brief Retrieve the number of available sides
+ * @return Zero on error; the number of sides on success
+ *
+ * This function parses the mod's side data, and returns the number of sides
+ * available. Be sure to map the mod into the VFS using AddArchive() or
+ * AddAllArchives() prior to using this function.
+ */
 Export(int) GetSideCount()
 {
 	try {
@@ -1308,6 +1416,12 @@
 }
 
 
+/**
+ * @brief Retrieve a side's name
+ * @return NULL on error; the side's name on success
+ *
+ * Be sure you've made a call to GetSideCount() prior to using this.
+ */
 Export(const char*) GetSideName(int side)
 {
 	try {
@@ -1322,6 +1436,12 @@
 }
 
 
+/**
+ * @brief Retrieve a side's default starting unit
+ * @return NULL on error; the side's starting unit name on success
+ *
+ * Be sure you've made a call to GetSideCount() prior to using this.
+ */
 Export(const char*) GetSideStartUnit(int side)
 {
 	try {
@@ -1387,6 +1507,13 @@
 }
 
 
+/**
+ * @brief Retrieve the number of LUA AIs available
+ * @return Zero on error; the number of LUA AIs otherwise
+ *
+ * Usually LUA AIs are shipped inside a mod, so be sure to map the mod into
+ * the VFS using AddArchive() or AddAllArchives() prior to using this function.
+ */
 Export(int) GetLuaAICount()
 {
 	try {
@@ -1400,6 +1527,12 @@
 }
 
 
+/**
+ * @brief Retrieve the name of a LUA AI
+ * @return NULL on error; the name of the LUA AI on success
+ *
+ * Be sure you've made a call to GetLuaAICount() prior to using this.
+ */
 Export(const char*) GetLuaAIName(int aiIndex)
 {
 	try {
@@ -1413,6 +1546,12 @@
 }
 
 
+/**
+ * @brief Retrieve the description of a LUA AI
+ * @return NULL on error; the description of the LUA AI on success
+ *
+ * Be sure you've made a call to GetLuaAICount() prior to using this.
+ */
 Export(const char*) GetLuaAIDesc(int aiIndex)
 {
 	try {
@@ -1616,6 +1755,11 @@
 }
 
 
+/**
+ * @brief Retrieve the number of map options available
+ * @param name the name of the map
+ * @return Zero on error; the number of map options available on success
+ */
 Export(int) GetMapOptionCount(const char* name)
 {
 	try {
@@ -1642,6 +1786,13 @@
 }
 
 
+/**
+ * @brief Retrieve the number of mod options available
+ * @return Zero on error; the number of mod options available on success
+ *
+ * Be sure to map the mod into the VFS using AddArchive() or AddAllArchives()
+ * prior to using this function.
+ */
 Export(int) GetModOptionCount()
 {
 	try {
@@ -1809,6 +1960,16 @@
 }
 
 
+/**
+ * @brief Retrieve an option's key
+ * @param optIndex option index/id
+ * @return NULL on error; the option's key on success
+ *
+ * The key of an option is the name it should be given in the start script's
+ * MODOPTIONS or MAPOPTIONS section.
+ * Be sure you've made a call to either GetMapOptionCount()
+ * or GetModOptionCount() prior to using this.
+ */
 Export(const char*) GetOptionKey(int optIndex)
 {
 	try {
@@ -1820,6 +1981,14 @@
 }
 
 
+/**
+ * @brief Retrieve an option's name
+ * @param optIndex option index/id
+ * @return NULL on error; the option's user visible name on success
+ *
+ * Be sure you've made a call to either GetMapOptionCount()
+ * or GetModOptionCount() prior to using this.
+ */
 Export(const char*) GetOptionName(int optIndex)
 {
 	try {
@@ -1830,6 +1999,15 @@
 	return NULL;
 }
 
+
+/**
+ * @brief Retrieve an option's section
+ * @param optIndex option index/id
+ * @return NULL on error; the option's section name on success
+ *
+ * Be sure you've made a call to either GetMapOptionCount()
+ * or GetModOptionCount() prior to using this.
+ */
 Export(const char*) GetOptionSection(int optIndex)
 {
 	try {
@@ -1840,6 +2018,17 @@
 	return NULL;
 }
 
+
+/**
+ * @brief Retrieve an option's style
+ * @param optIndex option index/id
+ * @return NULL on error; the option's style on success
+ *
+ * The format of an option style string is currently undecided.
+ *
+ * Be sure you've made a call to either GetMapOptionCount()
+ * or GetModOptionCount() prior to using this.
+ */
 Export(const char*) GetOptionStyle(int optIndex)
 {
 	try {
@@ -1850,6 +2039,15 @@
 	return NULL;
 }
 
+
+/**
+ * @brief Retrieve an option's description
+ * @param optIndex option index/id
+ * @return NULL on error; the option's description on success
+ *
+ * Be sure you've made a call to either GetMapOptionCount()
+ * or GetModOptionCount() prior to using this.
+ */
 Export(const char*) GetOptionDesc(int optIndex)
 {
 	try {
@@ -1861,6 +2059,14 @@
 }
 
 
+/**
+ * @brief Retrieve an option's type
+ * @param optIndex option index/id
+ * @return opt_error on error; the option's type on success
+ *
+ * Be sure you've made a call to either GetMapOptionCount()
+ * or GetModOptionCount() prior to using this.
+ */
 Export(int) GetOptionType(int optIndex)
 {
 	try {
@@ -1874,6 +2080,14 @@
 
 // Bool Options
 
+/**
+ * @brief Retrieve an opt_bool option's default value
+ * @param optIndex option index/id
+ * @return Zero on error; the option's default value (0 or 1) on success
+ *
+ * Be sure you've made a call to either GetMapOptionCount()
+ * or GetModOptionCount() prior to using this.
+ */
 Export(int) GetOptionBoolDef(int optIndex)
 {
 	try {
@@ -1887,6 +2101,14 @@
 
 // Number Options
 
+/**
+ * @brief Retrieve an opt_number option's default value
+ * @param optIndex option index/id
+ * @return Zero on error; the option's default value on success
+ *
+ * Be sure you've made a call to either GetMapOptionCount()
+ * or GetModOptionCount() prior to using this.
+ */
 Export(float) GetOptionNumberDef(int optIndex)
 {
 	try {
@@ -1898,6 +2120,14 @@
 }
 
 
+/**
+ * @brief Retrieve an opt_number option's minimum value
+ * @param optIndex option index/id
+ * @return -1.0e30 on error; the option's minimum value on success
+ *
+ * Be sure you've made a call to either GetMapOptionCount()
+ * or GetModOptionCount() prior to using this.
+ */
 Export(float) GetOptionNumberMin(int optIndex)
 {
 	try {
@@ -1909,6 +2139,14 @@
 }
 
 
+/**
+ * @brief Retrieve an opt_number option's maximum value
+ * @param optIndex option index/id
+ * @return +1.0e30 on error; the option's maximum value on success
+ *
+ * Be sure you've made a call to either GetMapOptionCount()
+ * or GetModOptionCount() prior to using this.
+ */
 Export(float) GetOptionNumberMax(int optIndex)
 {
 	try {
@@ -1920,6 +2158,14 @@
 }
 
 
+/**
+ * @brief Retrieve an opt_number option's step value
+ * @param optIndex option index/id
+ * @return Zero on error; the option's step value on success
+ *
+ * Be sure you've made a call to either GetMapOptionCount()
+ * or GetModOptionCount() prior to using this.
+ */
 Export(float) GetOptionNumberStep(int optIndex)
 {
 	try {
@@ -1933,6 +2179,14 @@
 
 // String Options
 
+/**
+ * @brief Retrieve an opt_string option's default value
+ * @param optIndex option index/id
+ * @return NULL on error; the option's default value on success
+ *
+ * Be sure you've made a call to either GetMapOptionCount()
+ * or GetModOptionCount() prior to using this.
+ */
 Export(const char*) GetOptionStringDef(int optIndex)
 {
 	try {
@@ -1944,6 +2198,14 @@
 }
 
 
+/**
+ * @brief Retrieve an opt_string option's maximum length
+ * @param optIndex option index/id
+ * @return Zero on error; the option's maximum length on success
+ *
+ * Be sure you've made a call to either GetMapOptionCount()
+ * or GetModOptionCount() prior to using this.
+ */
 Export(int) GetOptionStringMaxLen(int optIndex)
 {
 	try {
@@ -1957,6 +2219,14 @@
 
 // List Options
 
+/**
+ * @brief Retrieve an opt_list option's number of available items
+ * @param optIndex option index/id
+ * @return Zero on error; the option's number of available items on success
+ *
+ * Be sure you've made a call to either GetMapOptionCount()
+ * or GetModOptionCount() prior to using this.
+ */
 Export(int) GetOptionListCount(int optIndex)
 {
 	try {
@@ -1968,6 +2238,14 @@
 }
 
 
+/**
+ * @brief Retrieve an opt_list option's default value
+ * @param optIndex option index/id
+ * @return NULL on error; the option's default value (list item key) on success
+ *
+ * Be sure you've made a call to either GetMapOptionCount()
+ * or GetModOptionCount() prior to using this.
+ */
 Export(const char*) GetOptionListDef(int optIndex)
 {
 	try {
@@ -1979,6 +2257,15 @@
 }
 
 
+/**
+ * @brief Retrieve an opt_list option item's key
+ * @param optIndex option index/id
+ * @param itemIndex list item index/id
+ * @return NULL on error; the option item's key (list item key) on success
+ *
+ * Be sure you've made a call to either GetMapOptionCount()
+ * or GetModOptionCount() prior to using this.
+ */
 Export(const char*) GetOptionListItemKey(int optIndex, int itemIndex)
 {
 	try {
@@ -1991,6 +2278,15 @@
 }
 
 
+/**
+ * @brief Retrieve an opt_list option item's name
+ * @param optIndex option index/id
+ * @param itemIndex list item index/id
+ * @return NULL on error; the option item's name on success
+ *
+ * Be sure you've made a call to either GetMapOptionCount()
+ * or GetModOptionCount() prior to using this.
+ */
 Export(const char*) GetOptionListItemName(int optIndex, int itemIndex)
 {
 	try {
@@ -2003,6 +2299,15 @@
 }
 
 
+/**
+ * @brief Retrieve an opt_list option item's description
+ * @param optIndex option index/id
+ * @param itemIndex list item index/id
+ * @return NULL on error; the option item's description on success
+ *
+ * Be sure you've made a call to either GetMapOptionCount()
+ * or GetModOptionCount() prior to using this.
+ */
 Export(const char*) GetOptionListItemDesc(int optIndex, int itemIndex)
 {
 	try {
@@ -2096,9 +2401,14 @@
 	return 1;
 }
 
+
 /**
- * A return value of 0 means that any map can be selected
- * Map names should be complete  (including the .smf or .sm3 extension)
+ * @brief Retrieve the number of valid maps for the current mod
+ * @return 0 on error; the number of valid maps on success
+ *
+ * A return value of 0 means that any map can be selected.
+ * Be sure to map the mod into the VFS using AddArchive() or AddAllArchives()
+ * prior to using this function.
  */
  Export(int) GetModValidMapCount()
 {
@@ -2135,6 +2445,13 @@
 }
 
 
+/**
+ * @brief Retrieve the name of a map valid for the current mod
+ * @return NULL on error; the name of the map on success
+ *
+ * Map names should be complete  (including the .smf or .sm3 extension.)
+ * Be sure you've made a call to GetModValidMapCount() prior to using this.
+ */
 Export(const char*) GetModValidMap(int index)
 {
 	try {
@@ -2150,8 +2467,6 @@
 //////////////////////////
 //////////////////////////
 
-// Map the wanted archives into the VFS with AddArchive before using these functions
-
 static map&lt;int, CFileHandler*&gt; openFiles;
 static int nextFile = 0;
 static vector&lt;string&gt; curFindFiles;
@@ -2164,6 +2479,18 @@
 		throw content_error(&quot;Unregistered handle. Pass a handle returned by OpenFileVFS.&quot;);
 }
 
+
+/**
+ * @brief Open a file from the VFS
+ * @param name the name of the file
+ * @return Zero on error; a non-zero file handle on success.
+ *
+ * The returned file handle is needed for subsequent calls to CloseFileVFS(),
+ * ReadFileVFS() and FileSizeVFS().
+ *
+ * Map the wanted archives into the VFS with AddArchive() or AddAllArchives()
+ * before using this function.
+ */
 Export(int) OpenFileVFS(const char* name)
 {
 	try {
@@ -2187,6 +2514,11 @@
 	return 0;
 }
 
+
+/**
+ * @brief Close a file in the VFS
+ * @param handle the file handle as returned by OpenFileVFS()
+ */
 Export(void) CloseFileVFS(int handle)
 {
 	try {
@@ -2199,6 +2531,14 @@
 	UNITSYNC_CATCH_BLOCKS;
 }
 
+/**
+ * @brief Read some data from a file in the VFS
+ * @param handle the file handle as returned by OpenFileVFS()
+ * @param buf output buffer, must be at least length bytes
+ * @param length how many bytes to read from the file
+ * @return -1 on error; the number of bytes read on success
+ * (if this is less than length you reached the end of the file.)
+ */
 Export(void) ReadFileVFS(int handle, void* buf, int length)
 {
 	try {
@@ -2213,6 +2553,12 @@
 	UNITSYNC_CATCH_BLOCKS;
 }
 
+
+/**
+ * @brief Retrieve size of a file in the VFS
+ * @param handle the file handle as returned by OpenFileVFS()
+ * @return -1 on error; the size of the file on success
+ */
 Export(int) FileSizeVFS(int handle)
 {
 	try {
@@ -2314,6 +2660,7 @@
 static map&lt;int, CArchiveBase*&gt; openArchives;
 static int nextArchive = 0;
 
+
 static void CheckArchiveHandle(int handle)
 {
 	CheckInit();
@@ -2322,7 +2669,13 @@
 		throw content_error(&quot;Unregistered handle. Pass a handle returned by OpenArchive.&quot;);
 }
 
-// returns 0 on error, a handle otherwise
+
+/**
+ * @brief Open an archive
+ * @param name the name of the archive (*.sdz, *.sd7, ...)
+ * @return Zero on error; a non-zero archive handle on success.
+ * @sa OpenArchiveType
+ */
 Export(int) OpenArchive(const char* name)
 {
 	try {
@@ -2343,7 +2696,20 @@
 	return 0;
 }
 
-// returns 0 on error, a handle otherwise
+
+/**
+ * @brief Open an archive
+ * @param name the name of the archive (*.sd7, *.sdz, *.sdd, *.ccx, *.hpi, *.ufo, *.gp3, *.gp4, *.swx)
+ * @param type the type of the archive (sd7, 7z, sdz, zip, sdd, dir, ccx, hpi, ufo, gp3, gp4, swx)
+ * @return Zero on error; a non-zero archive handle on success.
+ * @sa OpenArchive
+ *
+ * The list of supported types and recognized extensions may change at any time.
+ * (But this list will always be the same as the file types recognized by the engine.)
+ *
+ * This function is pointless, because OpenArchive() does the same and automatically
+ * detects the file type based on it's extension.  Who added it anyway?
+ */
 Export(int) OpenArchiveType(const char* name, const char* type)
 {
 	try {
@@ -2365,6 +2731,11 @@
 	return 0;
 }
 
+
+/**
+ * @brief Close an archive in the VFS
+ * @param archive the archive handle as returned by OpenArchive()
+ */
 Export(void) CloseArchive(int archive)
 {
 	try {
@@ -2376,6 +2747,7 @@
 	UNITSYNC_CATCH_BLOCKS;
 }
 
+
 Export(int) FindFilesArchive(int archive, int cur, char* nameBuf, int* size)
 {
 	try {
@@ -2399,6 +2771,16 @@
 	return 0;
 }
 
+
+/**
+ * @brief Open an archive member
+ * @param archive the archive handle as returned by OpenArchive()
+ * @param name the name of the file
+ * @return Zero on error; a non-zero file handle on success.
+ *
+ * The returned file handle is needed for subsequent calls to ReadArchiveFile(),
+ * CloseArchiveFile() and SizeArchiveFile().
+ */
 Export(int) OpenArchiveFile(int archive, const char* name)
 {
 	try {
@@ -2412,6 +2794,16 @@
 	return 0;
 }
 
+
+/**
+ * @brief Read some data from an archive member
+ * @param archive the archive handle as returned by OpenArchive()
+ * @param handle the file handle as returned by OpenArchiveFile()
+ * @param buffer output buffer, must be at least numBytes bytes
+ * @param numBytes how many bytes to read from the file
+ * @return -1 on error; the number of bytes read on success
+ * (if this is less than numBytes you reached the end of the file.)
+ */
 Export(int) ReadArchiveFile(int archive, int handle, void* buffer, int numBytes)
 {
 	try {
@@ -2423,9 +2815,15 @@
 		return a-&gt;ReadFile(handle, buffer, numBytes);
 	}
 	UNITSYNC_CATCH_BLOCKS;
-	return 0;
+	return -1;
 }
 
+
+/**
+ * @brief Close an archive member
+ * @param archive the archive handle as returned by OpenArchive()
+ * @param handle the file handle as returned by OpenArchiveFile()
+ */
 Export(void) CloseArchiveFile(int archive, int handle)
 {
 	try {
@@ -2437,6 +2835,13 @@
 	UNITSYNC_CATCH_BLOCKS;
 }
 
+
+/**
+ * @brief Retrieve size of an archive member
+ * @param archive the archive handle as returned by OpenArchive()
+ * @param handle the file handle as returned by OpenArchiveFile()
+ * @return -1 on error; the size of the file on success
+ */
 Export(int) SizeArchiveFile(int archive, int handle)
 {
 	try {
@@ -2562,6 +2967,8 @@
 	UNITSYNC_CATCH_BLOCKS;
 }
 
+/** @} */
+
 //////////////////////////
 //////////////////////////
 

Modified: branches/caiinterface/tools/unitsync/unitsync.h
===================================================================
--- branches/caiinterface/tools/unitsync/unitsync.h	2008-11-12 22:35:24 UTC (rev 7027)
+++ branches/caiinterface/tools/unitsync/unitsync.h	2008-11-13 00:10:39 UTC (rev 7028)
@@ -10,40 +10,59 @@
 #define STRBUF_SIZE 100000
 
 
+/**
+ * @addtogroup unitsync_api Unitsync API
+ * @{
+*/
+
+/**
+ * @brief 2d vector storing a map defined starting position
+ * @sa MapInfo
+ */
 struct StartPos
 {
-	int x;
-	int z;
+	int x; ///&lt; X component
+	int z; ///&lt; Z component
 };
 
 
+/**
+ * @brief Metadata of a map
+ * @sa GetMapInfo GetMapInfoEx
+ */
 struct MapInfo
 {
-	char* description; // max 255 chars
-	int tidalStrength;
-	int gravity;
-	float maxMetal;
-	int extractorRadius;
-	int minWind;
-	int maxWind;
+	char* description;   ///&lt; Description (max 255 chars)
+	int tidalStrength;   ///&lt; Tidal strength
+	int gravity;         ///&lt; Gravity
+	float maxMetal;      ///&lt; Metal scale factor
+	int extractorRadius; ///&lt; Extractor radius (of metal extractors)
+	int minWind;         ///&lt; Minimum wind speed
+	int maxWind;         ///&lt; Maximum wind speed
 
 	// 0.61b1+
-	int width;
-	int height;
-	int posCount;
-	StartPos positions[16];		// I'd rather not allocate memory, this should be enough
+	int width;              ///&lt; Width of the map
+	int height;             ///&lt; Height of the map
+	int posCount;           ///&lt; Number of defined start positions
+	StartPos positions[16]; ///&lt; Start positions defined by the map (max 16)
 
 	// VERSION&gt;=1
-	char* author; // max 200 chars
+	char* author;   ///&lt; Creator of the map (max 200 chars)
 };
 
 
+/**
+ * @brief Available bitmap typeHints
+ * @sa GetInfoMap
+ */
 enum BitmapType {
-	bm_grayscale_8 = 1,
-	bm_grayscale_16 = 2
+	bm_grayscale_8  = 1, ///&lt; 8 bits per pixel grayscale bitmap
+	bm_grayscale_16 = 2  ///&lt; 16 bits per pixel grayscale bitmap
 };
 
+/** @} */
 
+
 const char *GetStr(std::string str);
 
 
@@ -398,4 +417,4 @@
  */
 Export(void) SetSpringConfigFloat(const char* name, const float value);
 
-#endif	/* UNITSYNC_H */
+#endif // UNITSYNC_H


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001796.html">[Taspring-linux-commit] r7027 - trunk
</A></li>
	<LI>Next message: <A HREF="001798.html">[Taspring-linux-commit] r7029 - trunk/rts/System/Platform/Win
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1797">[ date ]</a>
              <a href="thread.html#1797">[ thread ]</a>
              <a href="subject.html#1797">[ subject ]</a>
              <a href="author.html#1797">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
