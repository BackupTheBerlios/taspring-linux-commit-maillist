<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r7024 - in branches/caiinterface:	AI/Bindings/LegacyCpp AI/Interfaces/Java rts/ExternalAI	rts/ExternalAI/Interface rts/Game rts/Game/StartScripts	rts/Lua rts/Sim/MoveTypes rts/Sim/Units	rts/Sim/Units/CommandAI rts/System rts/System/Script
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-November/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r7024%20-%20in%20branches/caiinterface%3A%0A%09AI/Bindings/LegacyCpp%20AI/Interfaces/Java%20rts/ExternalAI%0A%09rts/ExternalAI/Interface%20rts/Game%20rts/Game/StartScripts%0A%09rts/Lua%20rts/Sim/MoveTypes%20rts/Sim/Units%0A%09rts/Sim/Units/CommandAI%20rts/System%20rts/System/Script&In-Reply-To=%3C20081112212257.9B5D146E9%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001792.html">
   <LINK REL="Next"  HREF="001794.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r7024 - in branches/caiinterface:	AI/Bindings/LegacyCpp AI/Interfaces/Java rts/ExternalAI	rts/ExternalAI/Interface rts/Game rts/Game/StartScripts	rts/Lua rts/Sim/MoveTypes rts/Sim/Units	rts/Sim/Units/CommandAI rts/System rts/System/Script</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r7024%20-%20in%20branches/caiinterface%3A%0A%09AI/Bindings/LegacyCpp%20AI/Interfaces/Java%20rts/ExternalAI%0A%09rts/ExternalAI/Interface%20rts/Game%20rts/Game/StartScripts%0A%09rts/Lua%20rts/Sim/MoveTypes%20rts/Sim/Units%0A%09rts/Sim/Units/CommandAI%20rts/System%20rts/System/Script&In-Reply-To=%3C20081112212257.9B5D146E9%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r7024 - in branches/caiinterface:	AI/Bindings/LegacyCpp AI/Interfaces/Java rts/ExternalAI	rts/ExternalAI/Interface rts/Game rts/Game/StartScripts	rts/Lua rts/Sim/MoveTypes rts/Sim/Units	rts/Sim/Units/CommandAI rts/System rts/System/Script">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Wed Nov 12 22:22:57 CET 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001792.html">[Taspring-linux-commit] r7023 - trunk
</A></li>
        <LI>Next message: <A HREF="001794.html">[Taspring-linux-commit] r7025 - trunk/tools/DedicatedServer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1793">[ date ]</a>
              <a href="thread.html#1793">[ thread ]</a>
              <a href="subject.html#1793">[ subject ]</a>
              <a href="author.html#1793">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: hoijui
Date: 2008-11-12 22:22:55 +0100 (Wed, 12 Nov 2008)
New Revision: 7024

Modified:
   branches/caiinterface/AI/Bindings/LegacyCpp/AIAICallback.cpp
   branches/caiinterface/AI/Interfaces/Java/InterfaceUtil.c
   branches/caiinterface/AI/Interfaces/Java/InterfaceUtil.h
   branches/caiinterface/rts/ExternalAI/AICallback.cpp
   branches/caiinterface/rts/ExternalAI/AIInterfaceLibrary.cpp
   branches/caiinterface/rts/ExternalAI/EngineOutHandler.cpp
   branches/caiinterface/rts/ExternalAI/EngineOutHandler.h
   branches/caiinterface/rts/ExternalAI/GlobalAIHandler.cpp
   branches/caiinterface/rts/ExternalAI/GlobalAIHandler.h
   branches/caiinterface/rts/ExternalAI/Group.h
   branches/caiinterface/rts/ExternalAI/GroupAI.cpp
   branches/caiinterface/rts/ExternalAI/GroupAILibrary.cpp
   branches/caiinterface/rts/ExternalAI/GroupAILibrary.h
   branches/caiinterface/rts/ExternalAI/GroupAIWrapper.cpp
   branches/caiinterface/rts/ExternalAI/GroupAIWrapper.h
   branches/caiinterface/rts/ExternalAI/GroupHandler.cpp
   branches/caiinterface/rts/ExternalAI/GroupHandler.h
   branches/caiinterface/rts/ExternalAI/IGroupAI.h
   branches/caiinterface/rts/ExternalAI/IGroupAILibrary.h
   branches/caiinterface/rts/ExternalAI/Interface/AISEvents.h
   branches/caiinterface/rts/ExternalAI/Interface/SAICallback.h
   branches/caiinterface/rts/ExternalAI/SAICallback.cpp
   branches/caiinterface/rts/ExternalAI/SkirmishAI.cpp
   branches/caiinterface/rts/ExternalAI/SkirmishAI.h
   branches/caiinterface/rts/ExternalAI/SkirmishAILibrary.cpp
   branches/caiinterface/rts/ExternalAI/SkirmishAIWrapper.cpp
   branches/caiinterface/rts/ExternalAI/SkirmishAIWrapper.h
   branches/caiinterface/rts/ExternalAI/aikey.h
   branches/caiinterface/rts/Game/Game.cpp
   branches/caiinterface/rts/Game/GlobalConstants.h
   branches/caiinterface/rts/Game/SelectedUnits.cpp
   branches/caiinterface/rts/Game/StartScripts/CommanderScript.cpp
   branches/caiinterface/rts/Game/StartScripts/SkirmishAITestScript.cpp
   branches/caiinterface/rts/Game/Team.cpp
   branches/caiinterface/rts/Lua/LuaSyncedRead.cpp
   branches/caiinterface/rts/Lua/LuaUnsyncedCtrl.cpp
   branches/caiinterface/rts/Sim/MoveTypes/GroundMoveType.cpp
   branches/caiinterface/rts/Sim/Units/CommandAI/CommandAI.cpp
   branches/caiinterface/rts/Sim/Units/Unit.cpp
   branches/caiinterface/rts/System/LoadSaveHandler.cpp
   branches/caiinterface/rts/System/Script/LuaFunctions.cpp
Log:
* All engine -&gt; AI communication now goeas through EngineOutHandler (obsoletes GlobalAIHandler)
* C interface cleaned up a little, to faciliate parsing it when generating wrappers

Modified: branches/caiinterface/AI/Bindings/LegacyCpp/AIAICallback.cpp
===================================================================
--- branches/caiinterface/AI/Bindings/LegacyCpp/AIAICallback.cpp	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/AI/Bindings/LegacyCpp/AIAICallback.cpp	2008-11-12 21:22:55 UTC (rev 7024)
@@ -65,7 +65,7 @@
 void CAIAICallback::init() {
 
 	// init caches
-	int maxCacheSize = 512;
+	int maxCacheSize = 1024;
 	int maxUnits = 10000;
 	int maxGroups = 100;
 

Modified: branches/caiinterface/AI/Interfaces/Java/InterfaceUtil.c
===================================================================
--- branches/caiinterface/AI/Interfaces/Java/InterfaceUtil.c	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/AI/Interfaces/Java/InterfaceUtil.c	2008-11-12 21:22:55 UTC (rev 7024)
@@ -31,6 +31,21 @@
 #include &lt;dirent.h&gt;		// needed for dir listing
 #endif	// WIN32
 
+static const char* myDataDir = NULL;
+static const char* myDataDirVers = NULL;
+
+char* util_setDataDirs(const char* unversioned, const char* versioned) {
+
+	myDataDir = unversioned;
+	myDataDirVers = versioned;
+}
+const char* util_getDataDirUnversioned() {
+	return myDataDir;
+}
+const char* util_getDataDirVersioned() {
+	return myDataDirVers;
+}
+
 char* util_allocStr(unsigned int length) {
 	return (char*) calloc(length+1, sizeof(char));
 }

Modified: branches/caiinterface/AI/Interfaces/Java/InterfaceUtil.h
===================================================================
--- branches/caiinterface/AI/Interfaces/Java/InterfaceUtil.h	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/AI/Interfaces/Java/InterfaceUtil.h	2008-11-12 21:22:55 UTC (rev 7024)
@@ -57,6 +57,10 @@
 	#define STRCASECMP strcasecmp
 #endif	// _MSC_VER
 
+char* util_setDataDirs(const char* unversioned, const char* versioned);
+const char* util_getDataDirUnversioned();
+const char* util_getDataDirVersioned();
+
 char* util_allocStr(unsigned int length);
 
 char* util_allocStrCpy(const char* toCopy);

Modified: branches/caiinterface/rts/ExternalAI/AICallback.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/AICallback.cpp	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/rts/ExternalAI/AICallback.cpp	2008-11-12 21:22:55 UTC (rev 7024)
@@ -43,7 +43,7 @@
 #include &quot;AICheats.h&quot;
 #include &quot;GlobalAICallback.h&quot;
 #include &quot;SkirmishAIWrapper.h&quot;
-#include &quot;GlobalAIHandler.h&quot;
+#include &quot;EngineOutHandler.h&quot;
 #include &quot;Group.h&quot;
 #include &quot;GroupHandler.h&quot;
 #include &quot;IGroupAI.h&quot;
@@ -89,7 +89,7 @@
 	if (group)
 		logOutput.Print(&quot;Group%i: %s&quot;, group-&gt;id, text);
 	else
-		logOutput.Print(&quot;GlobalAI%i: %s&quot;, team, text);
+		logOutput.Print(&quot;SkirmishAI%i: %s&quot;, team, text);
 }
 
 void CAICallback::SetLastMsgPos(float3 pos)
@@ -189,16 +189,20 @@
 // (still completely insecure ofcourse, but it filters out the easiest way of cheating)
 void CAICallback::verify()
 {
-	const CSkirmishAIWrapper* skirmishAI = globalAI-&gt;GetSkirmishAI(team);
-	if (
-			skirmishAI
-			&amp;&amp; (((group
-					&amp;&amp; group-&gt;handler != /*skirmishAI-&gt;gh*/grouphandlers[skirmishAI-&gt;GetTeamId()]
-					/*&amp;&amp; group-&gt;handler != grouphandler*/)
-			|| skirmishAI-&gt;GetTeamId() != team))) {
-		handleerror (0, &quot;AI has modified spring components(possible cheat)&quot;, &quot;Spring is closing:&quot;, MBF_OK | MBF_EXCL);
-		exit (-1);
-	}
+//TODO: add checks
+// the old check (see code below) checks for something which is not possible
+// anymore with the C AI interface
+//	const CSkirmishAIWrapper* skirmishAI = eoh-&gt;GetSkirmishAI(team);
+//	if (
+//			skirmishAI
+//			&amp;&amp; (((group
+//					&amp;&amp; group-&gt;handler != /*skirmishAI-&gt;gh*/grouphandlers[skirmishAI-&gt;GetTeamId()]
+//					/*&amp;&amp; group-&gt;handler != grouphandler*/)
+//			|| skirmishAI-&gt;GetTeamId() != team))) {
+//		handleerror (0, &quot;AI has modified spring components(possible cheat)&quot;,
+//				&quot;Spring is closing:&quot;, MBF_OK | MBF_EXCL);
+//		exit (-1);
+//	}
 }
 
 int CAICallback::GetCurrentFrame()
@@ -230,12 +234,12 @@
 		return gs-&gt;Team(teamId)-&gt;side.c_str();
 	} else {
 		// if this is not a GameSetup-type game but a
-		// GlobalAI-test one, the side-strings for all
+		// SkirmishAI-test one, the side-strings for all
 		// active teams (0, 1, 2) will always be &quot;arm&quot;
-		// since CGlobalAITestScript does not override
+		// since CSkirmishAITestScript does not override
 		// the CTeam defaults (unlike CGameSetup), so
 		// return 0 or AI's that rely on this function
-		// will break in GlobalAI tests
+		// will break in SkirmishAI tests
 		return 0;
 	}
 }
@@ -1303,7 +1307,7 @@
 			*((int*)data) = damageArrayHandler-&gt;GetNumTypes();
 			return true;
 		}case AIVAL_EXCEPTION_HANDLING:{
-			*(bool*)data = CGlobalAIHandler::CatchException();
+			*(bool*)data = CEngineOutHandler::IsCatchExceptions();
 			return true;
 		}case AIVAL_MAP_CHECKSUM:{
 			*(unsigned int*)data = readmap-&gt;mapChecksum;

Modified: branches/caiinterface/rts/ExternalAI/AIInterfaceLibrary.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/AIInterfaceLibrary.cpp	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/rts/ExternalAI/AIInterfaceLibrary.cpp	2008-11-12 21:22:55 UTC (rev 7024)
@@ -255,7 +255,7 @@
 	SGAISpecifier gAISpecifier = aiInfo-&gt;GetSpecifier();
 	if (groupAILoadCount[gAISpecifier] == 0) {
 		const SGAILibrary* gLib = sAIInterfaceLibrary.loadGroupAILibrary(info, num);
-		ai = new CGroupAILibrary(*gLib, gAISpecifier);
+		ai = new CGroupAILibrary(*gLib, gAISpecifier, info, num);
 		loadedGroupAILibraries[gAISpecifier] = ai;
 	} else {
 		ai = loadedGroupAILibraries[gAISpecifier];

Modified: branches/caiinterface/rts/ExternalAI/EngineOutHandler.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/EngineOutHandler.cpp	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/rts/ExternalAI/EngineOutHandler.cpp	2008-11-12 21:22:55 UTC (rev 7024)
@@ -18,13 +18,23 @@
 #include &quot;EngineOutHandler.h&quot;
 #include &quot;Group.h&quot;
 #include &quot;GroupHandler.h&quot;
+#include &quot;SkirmishAIWrapper.h&quot;
+//#include &quot;GroupAIWrapper.h&quot;
+#include &quot;Game/GlobalSynced.h&quot;
+#include &quot;Game/GameHelper.h&quot;
+#include &quot;Game/Player.h&quot;
+#include &quot;Sim/Units/Unit.h&quot;
+#include &quot;Platform/ConfigHandler.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;Util.h&quot;
+#include &quot;TimeProfiler.h&quot;
 
 
 CR_BIND_DERIVED(CEngineOutHandler,CObject,)
 
 CR_REG_METADATA(CEngineOutHandler, (
-				CR_MEMBER(skirmishAIs),
-				CR_MEMBER(groupAIs)
+				CR_MEMBER(skirmishAIs)//,
+//				CR_MEMBER(groupAIs)
 				));
 
 /////////////////////////////
@@ -64,7 +74,7 @@
 		} else throw;						\
 	}
 
-static void handleAIException(const char* description) {
+void handleAIException(const char* description) {
 
 	if (description) {
 		logOutput.Print(&quot;AI Exception: \'%s\'&quot;, description);
@@ -85,7 +95,7 @@
 		singleton = SAFE_NEW CEngineOutHandler();
 	}
 }
-const CEngineOutHandler* CEngineOutHandler::GetInstance() {
+CEngineOutHandler* CEngineOutHandler::GetInstance() {
 
 	if (singleton == NULL) {
 		Initialize();
@@ -96,20 +106,20 @@
 void CEngineOutHandler::Destroy() {
 
 	if (singleton != NULL) {
-		SafeDelete(singleton);
+		CEngineOutHandler* tmp = singleton;
 		singleton = NULL;
+		delete tmp;
 	}
 }
 
-CEngineOutHandler::CEngineOutHandler() {
+CEngineOutHandler::CEngineOutHandler() : activeTeams(gs-&gt;activeTeams) {
 
-	activeTeams = gs-&gt;activeTeams;
-
-	for (unsigned int t=0; t &lt; MAX_TEAMS; ++t) {
+	for (int t=0; t &lt; MAX_TEAMS; ++t) {
 		skirmishAIs[t] = NULL;
 	}
 	hasSkirmishAIs = false;
 
+/*
 	for (unsigned int t=0; t &lt; MAX_TEAMS; ++t) {
 		for (unsigned int g=0; g &lt; MAX_GROUPS; ++g) {
 			groupAIs[t][g] = NULL;
@@ -117,19 +127,22 @@
 		hasTeamGroupAIs[t] = false;
 	}
 	hasGroupAIs = false;
+*/
 }
 
 CEngineOutHandler::~CEngineOutHandler() {
 
-	for (unsigned int t=0; t &lt; MAX_TEAMS; ++t) {
+	for (int t=0; t &lt; MAX_TEAMS; ++t) {
 		delete skirmishAIs[t];
 	}
 
+/*
 	for (unsigned int t=0; t &lt; MAX_TEAMS; ++t) {
 		for (unsigned int g=0; g &lt; MAX_GROUPS; ++g) {
 			delete groupAIs[t][g];
 		}
 	}
+*/
 }
 
 
@@ -144,6 +157,7 @@
 			}												\
 		}
 
+/*
 #define DO_FOR_ALL_GROUP_AIS(FUNC)									\
 		if (hasGroupAIs) {											\
 			for (unsigned int t=0; t &lt; activeTeams; ++t) {			\
@@ -156,10 +170,11 @@
 				}													\
 			}														\
 		}
+*/
 
 #define DO_FOR_SKIRMISH_AND_GROUP_AIS(FUNC)	\
-		DO_FOR_ALL_SKIRMISH_AIS(FUNC)		\
-		DO_FOR_ALL_GROUP_AIS(FUNC)
+		DO_FOR_ALL_SKIRMISH_AIS(FUNC)//		\
+		//DO_FOR_ALL_GROUP_AIS(FUNC)
 
 
 void CEngineOutHandler::PostLoad() {}
@@ -200,44 +215,45 @@
 
 
 
-#define DO_FOR_ALLIED_SKIRMISH_AIS(FUNC, ALLY_TEAM_ID)				\
-	if (hasSkirmishAIs) {											\
-		for (unsigned int t=0; t &lt; activeTeams; ++t) {				\
-			if (skirmishAIs[t] &amp;&amp; gs-&gt;AllyTeam(t) == ALLY_TEAM_ID	\
-					&amp;&amp; !gs-&gt;Ally(ALLY_TEAM_ID, unit-&gt;allyteam)) {	\
-				try {												\
-					skirmishAIs[t]-&gt;FUNC;							\
-				} HANDLE_EXCEPTION;									\
-			}														\
-		}															\
+#define DO_FOR_ALLIED_SKIRMISH_AIS(FUNC, ALLY_TEAM_ID, UNIT_ALLY_TEAM_ID)	\
+	if (hasSkirmishAIs &amp;&amp; !gs-&gt;Ally(ALLY_TEAM_ID, UNIT_ALLY_TEAM_ID)) {		\
+		for (unsigned int t=0; t &lt; activeTeams; ++t) {						\
+			if (skirmishAIs[t] &amp;&amp; gs-&gt;AllyTeam(t) == ALLY_TEAM_ID) {		\
+				try {														\
+					skirmishAIs[t]-&gt;FUNC;									\
+				} HANDLE_EXCEPTION;											\
+			}																\
+		}																	\
 	}
 
-#define DO_FOR_ALLIED_GROUP_AIS(FUNC, ALLY_TEAM_ID)						\
-	if (hasGroupAIs) {													\
-		for (unsigned int t=0; t &lt; activeTeams; ++t) {					\
-			if (hasTeamGroupAIs[t] &amp;&amp; gs-&gt;AllyTeam(t) == ALLY_TEAM_ID	\
-					&amp;&amp; !gs-&gt;Ally(ALLY_TEAM_ID, unit-&gt;allyteam)) {		\
-				for (unsigned int g=0; g &lt; MAX_GROUPS; ++g) {			\
-					if (groupAIs[t][g]) {								\
-						try {											\
-							groupAIs[t][g]-&gt;EnemyEnterLOS(unitId);		\
-						} HANDLE_EXCEPTION;								\
-					}													\
-				}														\
-			}															\
-		}																\
+/*
+#define DO_FOR_ALLIED_GROUP_AIS(FUNC, ALLY_TEAM_ID, UNIT_ALLY_TEAM_ID)		\
+	if (hasGroupAIs &amp;&amp; !gs-&gt;Ally(ALLY_TEAM_ID, UNIT_ALLY_TEAM_ID)) {		\
+		for (unsigned int t=0; t &lt; activeTeams; ++t) {						\
+			if (hasTeamGroupAIs[t] &amp;&amp; gs-&gt;AllyTeam(t) == ALLY_TEAM_ID) {	\
+				for (unsigned int g=0; g &lt; MAX_GROUPS; ++g) {				\
+					if (groupAIs[t][g]) {									\
+						try {												\
+							groupAIs[t][g]-&gt;EnemyEnterLOS(unitId);			\
+						} HANDLE_EXCEPTION;									\
+					}														\
+				}															\
+			}																\
+		}																	\
 	}
+*/
 
 
-#define DO_FOR_ALLIED_SKIRMISH_AND_GROUP_AIS(FUNC, ALLY_TEAM_ID)	\
-		DO_FOR_ALLIED_SKIRMISH_AIS(FUNC, ALLY_TEAM_ID)				\
-		DO_FOR_ALLIED_GROUP_AIS(FUNC, ALLY_TEAM_ID)
+#define DO_FOR_ALLIED_SKIRMISH_AND_GROUP_AIS(FUNC, ALLY_TEAM_ID, UNIT_ALLY_TEAM_ID)	\
+		DO_FOR_ALLIED_SKIRMISH_AIS(FUNC, ALLY_TEAM_ID, UNIT_ALLY_TEAM_ID)//			\
+		//DO_FOR_ALLIED_GROUP_AIS(FUNC, ALLY_TEAM_ID, UNIT_ALLY_TEAM_ID)
 
 
 void CEngineOutHandler::UnitEnteredLos(const CUnit&amp; unit, int allyTeamId) {
 
-	int unitId = unit-&gt;id;
-	DO_FOR_ALLIED_SKIRMISH_AND_GROUP_AIS(EnemyEnterLOS(unitId), allyTeamId)
+	int unitId = unit.id;
+	int unitAllyTeamId = unit.allyteam;
+	DO_FOR_ALLIED_SKIRMISH_AND_GROUP_AIS(EnemyEnterLOS(unitId), allyTeamId, unitAllyTeamId)
 	
 /*
 	if (hasSkirmishAIs) {
@@ -268,20 +284,23 @@
 
 void CEngineOutHandler::UnitLeftLos(const CUnit&amp; unit, int allyTeamId) {
 
-	int unitId = unit-&gt;id;
-	DO_FOR_ALLIED_SKIRMISH_AND_GROUP_AIS(EnemyLeaveLOS(unitId), allyTeamId)
+	int unitId = unit.id;
+	int unitAllyTeamId = unit.allyteam;
+	DO_FOR_ALLIED_SKIRMISH_AND_GROUP_AIS(EnemyLeaveLOS(unitId), allyTeamId, unitAllyTeamId)
 }
 
 void CEngineOutHandler::UnitEnteredRadar(const CUnit&amp; unit, int allyTeamId) {
 
-	int unitId = unit-&gt;id;
-	DO_FOR_ALLIED_SKIRMISH_AND_GROUP_AIS(EnemyEnterRadar(unitId), allyTeamId)
+	int unitId = unit.id;
+	int unitAllyTeamId = unit.allyteam;
+	DO_FOR_ALLIED_SKIRMISH_AND_GROUP_AIS(EnemyEnterRadar(unitId), allyTeamId, unitAllyTeamId)
 }
 
 void CEngineOutHandler::UnitLeftRadar(const CUnit&amp; unit, int allyTeamId) {
 
-	int unitId = unit-&gt;id;
-	DO_FOR_ALLIED_SKIRMISH_AND_GROUP_AIS(EnemyLeaveRadar(unitId), allyTeamId)
+	int unitId = unit.id;
+	int unitAllyTeamId = unit.allyteam;
+	DO_FOR_ALLIED_SKIRMISH_AND_GROUP_AIS(EnemyLeaveRadar(unitId), allyTeamId, unitAllyTeamId)
 }
 
 
@@ -294,6 +313,7 @@
 		} HANDLE_EXCEPTION;							\
 	}
 
+/*
 #define DO_FOR_TEAM_GROUP_AIS(FUNC, TEAM_ID)		\
 	if (hasTeamGroupAIs[TEAM_ID]) {				\
 		for (unsigned int g=0; g &lt; MAX_GROUPS; ++g) {	\
@@ -304,32 +324,33 @@
 			}											\
 		}												\
 	}
+*/
 
 
 #define DO_FOR_TEAM_SKIRMISH_AND_GROUP_AIS(FUNC, TEAM_ID)	\
-		DO_FOR_TEAM_SKIRMISH_AIS(FUNC, TEAM_ID)				\
-		DO_FOR_TEAM_GROUP_AIS(FUNC, TEAM_ID)
+		DO_FOR_TEAM_SKIRMISH_AIS(FUNC, TEAM_ID)//				\
+		//DO_FOR_TEAM_GROUP_AIS(FUNC, TEAM_ID)
 
 void CEngineOutHandler::UnitIdle(const CUnit&amp; unit) {
 
-	int teamId = unit-&gt;team;
-	int unitId = unit-&gt;id;
+	int teamId = unit.team;
+	int unitId = unit.id;
 
 	DO_FOR_TEAM_SKIRMISH_AND_GROUP_AIS(UnitIdle(unitId), teamId);
 }
 
 void CEngineOutHandler::UnitCreated(const CUnit&amp; unit) {
 
-	int teamId = unit-&gt;team;
-	int unitId = unit-&gt;id;
+	int teamId = unit.team;
+	int unitId = unit.id;
 
 	DO_FOR_TEAM_SKIRMISH_AND_GROUP_AIS(UnitCreated(unitId), teamId);
 }
 
 void CEngineOutHandler::UnitFinished(const CUnit&amp; unit) {
 
-	int teamId = unit-&gt;team;
-	int unitId = unit-&gt;id;
+	int teamId = unit.team;
+	int unitId = unit.id;
 
 	DO_FOR_TEAM_SKIRMISH_AND_GROUP_AIS(UnitFinished(unitId), teamId);
 }
@@ -337,16 +358,16 @@
 
 void CEngineOutHandler::UnitMoveFailed(const CUnit&amp; unit) {
 
-	int teamId = unit-&gt;team;
-	int unitId = unit-&gt;id;
+	int teamId = unit.team;
+	int unitId = unit.id;
 
 	DO_FOR_TEAM_SKIRMISH_AND_GROUP_AIS(UnitMoveFailed(unitId), teamId);
 }
 
 void CEngineOutHandler::UnitGiven(const CUnit&amp; unit, int oldTeam) {
 
-	int newTeam = unit-&gt;team;
-	int unitId = unit-&gt;id;
+	int newTeam = unit.team;
+	int unitId = unit.id;
 
 	DO_FOR_TEAM_SKIRMISH_AND_GROUP_AIS(UnitGiven(unitId, oldTeam, newTeam), newTeam);
 	//DO_FOR_TEAM_SKIRMISH_AND_GROUP_AIS(UnitGiven(unitId, oldTeam, newTeam), oldTeam);
@@ -354,8 +375,8 @@
 
 void CEngineOutHandler::UnitCaptured(const CUnit&amp; unit, int newTeam) {
 
-	int oldTeam = unit-&gt;team;
-	int unitId = unit-&gt;id;
+	int oldTeam = unit.team;
+	int unitId = unit.id;
 
 	DO_FOR_TEAM_SKIRMISH_AND_GROUP_AIS(UnitCaptured(unitId, oldTeam, newTeam), oldTeam);
 	//DO_FOR_TEAM_SKIRMISH_AND_GROUP_AIS(UnitCaptured(unitId, oldTeam, newTeam), newTeam);
@@ -365,31 +386,32 @@
 void CEngineOutHandler::UnitDestroyed(const CUnit&amp; destroyed,
 		const CUnit* attacker) {
 
-	int destroyedId = destroyed-&gt;id;
+	int destroyedId = destroyed.id;
 	int attackerId = attacker ? attacker-&gt;id : 0;
 
 	if (hasSkirmishAIs) {
 		try {
 			for (unsigned int t=0; t &lt; activeTeams; ++t) {
 				if (skirmishAIs[t]
-						&amp;&amp; !gs-&gt;Ally(gs-&gt;AllyTeam(t), destroyed-&gt;allyteam)
+						&amp;&amp; !gs-&gt;Ally(gs-&gt;AllyTeam(t), destroyed.allyteam)
 						&amp;&amp; (skirmishAIs[t]-&gt;IsCheatEventsEnabled()
-							|| (destroyed-&gt;losStatus[t] &amp; (LOS_INLOS | LOS_INRADAR)))) {
+							|| (destroyed.losStatus[t] &amp; (LOS_INLOS | LOS_INRADAR)))) {
 					skirmishAIs[t]-&gt;EnemyDestroyed(destroyedId, attackerId);
 				}
 			}
-			if (skirmishAIs[destroyed-&gt;team]) {
-				skirmishAIs[destroyed-&gt;team]-&gt;UnitDestroyed(destroyedId, attackerId);
+			if (skirmishAIs[destroyed.team]) {
+				skirmishAIs[destroyed.team]-&gt;UnitDestroyed(destroyedId, attackerId);
 			}
 		} HANDLE_EXCEPTION;
 	}
 	
+/*
 	if (hasGroupAIs) {
 		for (unsigned int t=0; t &lt; activeTeams; ++t) {
 			if (hasTeamGroupAIs[t]
-						&amp;&amp; !gs-&gt;Ally(gs-&gt;AllyTeam(t), destroyed-&gt;allyteam)) {
+						&amp;&amp; !gs-&gt;Ally(gs-&gt;AllyTeam(t), destroyed.allyteam)) {
 				bool isVisible =
-						destroyed-&gt;losStatus[t] &amp; (LOS_INLOS | LOS_INRADAR);
+						destroyed.losStatus[t] &amp; (LOS_INLOS | LOS_INRADAR);
 				for (unsigned int g=0; g &lt; MAX_GROUPS; ++g) {
 					if (groupAIs[t][g]
 							&amp;&amp; (groupAIs[t][g]-&gt;IsCheatEventsEnabled()
@@ -401,40 +423,41 @@
 				}
 			}	
 		}
-		if (hasTeamGroupAIs[destroyed-&gt;team]) {
+		if (hasTeamGroupAIs[destroyed.team]) {
 			for (unsigned int g=0; g &lt; MAX_GROUPS; ++g) {
-				if (groupAIs[destroyed-&gt;team][g]) {
+				if (groupAIs[destroyed.team][g]) {
 					try {
-						groupAIs[destroyed-&gt;team][g]-&gt;EnemyDestroyed(destroyedId, attackerId);
+						groupAIs[destroyed.team][g]-&gt;EnemyDestroyed(destroyedId, attackerId);
 					} HANDLE_EXCEPTION;
 				}
 			}
 		}
 	}
+*/
 }
 
 
 void CEngineOutHandler::UnitDamaged(const CUnit&amp; damaged, const CUnit* attacker,
 		float damage) {
 
-	int damagedUnitId = damaged-&gt;id;
+	int damagedUnitId = damaged.id;
 	int attackerUnitId = attacker ? attacker-&gt;id : -1;
 	float3 attackDir_damagedsView;
 	float3 attackDir_attackersView;
 	if (attacker) {
 		attackDir_damagedsView =
-				helper-&gt;GetUnitErrorPos(attacker, damaged-&gt;allyteam)
-				- damaged-&gt;pos;
+				helper-&gt;GetUnitErrorPos(attacker, damaged.allyteam)
+				- damaged.pos;
 		attackDir_damagedsView.ANormalize();
 
 		attackDir_attackersView =
 				attacker-&gt;pos
-				- helper-&gt;GetUnitErrorPos(damaged, attacker-&gt;allyteam);
+				- helper-&gt;GetUnitErrorPos(&amp;damaged, attacker-&gt;allyteam);
 		attackDir_attackersView.ANormalize();
 	} else {
 		attackDir_damagedsView = ZeroVector;
 	}
-	int dt = damaged-&gt;team;
+	int dt = damaged.team;
 	int at = attacker-&gt;team;
 
 	if (hasSkirmishAIs) {
@@ -446,9 +469,9 @@
 
 			if (attacker) {
 				if (skirmishAIs[at]
-						&amp;&amp; !gs-&gt;Ally(gs-&gt;AllyTeam(at), attacked-&gt;allyteam)
+						&amp;&amp; !gs-&gt;Ally(gs-&gt;AllyTeam(at), damaged.allyteam)
 						&amp;&amp; (skirmishAIs[at]-&gt;IsCheatEventsEnabled()
-							|| (attacked-&gt;losStatus[at] &amp; (LOS_INLOS | LOS_INRADAR)))) {
+							|| (damaged.losStatus[at] &amp; (LOS_INLOS | LOS_INRADAR)))) {
 					skirmishAIs[at]-&gt;EnemyDamaged(damagedUnitId, attackerUnitId,
 							damage, attackDir_attackersView);
 				}
@@ -456,6 +479,7 @@
 		} HANDLE_EXCEPTION;
 	}
 
+/*
 	if (hasTeamGroupAIs[dt]) {
 		for (unsigned int g=0; g &lt; MAX_GROUPS; ++g) {
 			if (groupAIs[dt][g]) {
@@ -480,6 +504,7 @@
 			}
 		}
 	}
+*/
 }
 
 
@@ -489,16 +514,16 @@
 void CEngineOutHandler::SeismicPing(int allyTeamId, const CUnit&amp; unit,
 		const float3&amp; pos, float strength) {
 
-	int unitId = unit-&gt;id;
-	
-	DO_FOR_ALLIED_SKIRMISH_AND_GROUP_AIS(SeismicPing(allyTeamId, unitId, pos, strength), allyTeamId)
+	int unitId = unit.id;
+	int unitAllyTeamId = unit.allyteam;
+	DO_FOR_ALLIED_SKIRMISH_AND_GROUP_AIS(SeismicPing(allyTeamId, unitId, pos, strength), allyTeamId, unitAllyTeamId)
 }
 
 void CEngineOutHandler::WeaponFired(const CUnit&amp; unit, const WeaponDef&amp; def) {
 
-	int teamId = unit-&gt;team;
-	int unitId = unit-&gt;id;
-	int defId = def-&gt;id;
+	int teamId = unit.team;
+	int unitId = unit.id;
+	int defId = def.id;
 
 	DO_FOR_TEAM_SKIRMISH_AND_GROUP_AIS(WeaponFired(unitId, defId), teamId);
 }
@@ -512,11 +537,10 @@
 	DO_FOR_TEAM_SKIRMISH_AND_GROUP_AIS(PlayerCommandGiven(selectedUnitIds, c, playerId), teamId);
 }
 
-void CommandFinished(const CUnit&amp; unit, int commandTopicId) {
+void CEngineOutHandler::CommandFinished(const CUnit&amp; unit, int commandTopicId) {
 
-	int teamId = unit-&gt;team;
-	int unitId = unit-&gt;id;
-	
+	int teamId = unit.team;
+	int unitId = unit.id;
 	DO_FOR_TEAM_SKIRMISH_AND_GROUP_AIS(CommandFinished(unitId, commandTopicId), teamId);
 }
 
@@ -552,7 +576,7 @@
 	return false;
 }
 
-bool CEngineOutHandler::IsSkirmishAI(int teamId) {
+bool CEngineOutHandler::IsSkirmishAI(int teamId) const {
 	return skirmishAIs[teamId];
 }
 
@@ -567,45 +591,7 @@
 
 
 
-
-bool CEngineOutHandler::CreateSkirmishAI(int teamId, const SSAIKey&amp; key,
-		const std::map&lt;std::string, std::string&gt;&amp; options) {
-
-	if ((teamId &lt; 0) || (teamId &gt;= gs-&gt;activeTeams)) {
-		return false;
-	}
-
-	try {
-		if (skirmishAIs[teamId]) {
-			delete skirmishAIs[teamId];
-			skirmishAIs[teamId] = NULL;
-		}
-
-		skirmishAIs[teamId] = SAFE_NEW CSkirmishAIWrapper(teamId, key, options);
-		hasSkirmishAIs = true;
-
-		return true;
-	} HANDLE_EXCEPTION;
-
-	return false;
-}
-
-bool CEngineOutHandler::IsSkirmishAI(int teamId) {
-	return skirmishAIs[teamId];
-}
-
-void CEngineOutHandler::DestroySkirmishAI(int teamId) {
-	
-	try {
-		delete skirmishAIs[teamId];
-		skirmishAIs[teamId] = NULL;
-	} HANDLE_EXCEPTION;
-}
-
-
-
-
-
+/*
 bool CreateGroupAI(const CGroup&amp; group, const SGAIKey&amp; key,
 			const std::map&lt;std::string, std::string&gt;&amp; options) {
 
@@ -635,19 +621,20 @@
 
 bool CEngineOutHandler::IsGroupAI(const CGroup&amp; group) {
 
-	int teamId = group-&gt;handler-&gt;team;
-	int groupId = group-&gt;id;
+	int teamId = group.handler-&gt;team;
+	int groupId = group.id;
 
 	return groupAIs[teamId][groupId];
 }
 
 void CEngineOutHandler::DestroyGroupAI(const CGroup&amp; group) {
 
-	int teamId = group-&gt;handler-&gt;team;
-	int groupId = group-&gt;id;
+	int teamId = group.handler-&gt;team;
+	int groupId = group.id;
 
 	try {
 		delete groupAIs[teamId][groupId];
 		groupAIs[teamId][groupId] = NULL;
 	} HANDLE_EXCEPTION;
 }
+*/

Modified: branches/caiinterface/rts/ExternalAI/EngineOutHandler.h
===================================================================
--- branches/caiinterface/rts/ExternalAI/EngineOutHandler.h	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/rts/ExternalAI/EngineOutHandler.h	2008-11-12 21:22:55 UTC (rev 7024)
@@ -19,6 +19,7 @@
 #define _ENGINEOUTHANDLER_H
 
 #include &quot;Object.h&quot;
+#include &quot;Game/GlobalConstants.h&quot;
 
 #include &lt;map&gt;
 #include &lt;string&gt;
@@ -27,11 +28,14 @@
 class float3;
 class CUnit;
 class CGroup;
+class WeaponDef;
 struct SSAIKey;
 class CSkirmishAIWrapper;
 struct SGAIKey;
 class CGroupAIWrapper;
 
+void handleAIException(const char* description);
+
 class CEngineOutHandler : public CObject {
 private:
 	CEngineOutHandler();
@@ -84,10 +88,10 @@
 
 
 	// Group AI stuff
-	bool CreateGroupAI(const CGroup&amp; group, const SGAIKey&amp; key,
-			const std::map&lt;std::string, std::string&gt;&amp; options);
-	bool IsGroupAI(const CGroup&amp; group) const;
-	void DestroyGroupAI(const CGroup&amp; group);
+//	bool CreateGroupAI(const CGroup&amp; group, const SGAIKey&amp; key,
+//			const std::map&lt;std::string, std::string&gt;&amp; options);
+//	bool IsGroupAI(const CGroup&amp; group) const;
+//	void DestroyGroupAI(const CGroup&amp; group);
 
 
 	void SetCheating(bool enable);
@@ -97,17 +101,19 @@
 	void Load(std::istream* s);
 	void Save(std::ostream* s);
 
+	static bool IsCatchExceptions();
 private:
-	static bool IsCatchExceptions();
+	static CEngineOutHandler* singleton;
 
 private:
 	const unsigned int activeTeams;
 
 	CSkirmishAIWrapper* skirmishAIs[MAX_TEAMS];
 	bool hasSkirmishAIs;
-	CGroupAIWrapper* groupAIs[MAX_TEAMS][MAX_GROUPS];
-	bool hasGroupAIs;
-	bool hasTeamGroupAIs[MAX_TEAMS];
+	//CGroupAIWrapper* groupAIs[MAX_TEAMS][MAX_GROUPS];
+//	CGroupAIWrapper* groupAIs[MAX_TEAMS][16];
+//	bool hasGroupAIs;
+//	bool hasTeamGroupAIs[MAX_TEAMS];
 };
 
 #define eoh CEngineOutHandler::GetInstance()

Modified: branches/caiinterface/rts/ExternalAI/GlobalAIHandler.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/GlobalAIHandler.cpp	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/rts/ExternalAI/GlobalAIHandler.cpp	2008-11-12 21:22:55 UTC (rev 7024)
@@ -1,431 +1,431 @@
-#include &quot;StdAfx.h&quot;
-#include &quot;GlobalAIHandler.h&quot;
-#include &quot;Interface/SAIInterfaceLibrary.h&quot;
-#include &quot;AILibraryManager.h&quot;
-#include &quot;SkirmishAI.h&quot;
-#include &quot;SkirmishAIWrapper.h&quot;
-#include &quot;IGlobalAI.h&quot;
-#include &quot;Game/GlobalSynced.h&quot;
-#include &quot;Game/GameHelper.h&quot;
-#include &quot;Game/Player.h&quot;
-#include &quot;Game/Team.h&quot;
-#include &quot;Sim/Units/Unit.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/TimeProfiler.h&quot;
-#include &quot;System/NetProtocol.h&quot;
-#include &quot;System/Platform/errorhandler.h&quot;
-#include &quot;mmgr.h&quot;
-
-CGlobalAIHandler* globalAI=0;
-
-CR_BIND_DERIVED(CGlobalAIHandler,CObject,)
-
-CR_REG_METADATA(CGlobalAIHandler, (
-				CR_MEMBER(ais),
-				CR_MEMBER(hasAI)
-//				CR_MEMBER(memBuffers)
-				));
-
-bool CGlobalAIHandler::CatchException()
-{
-	static bool init=false;
-	static bool Catch;
-	if (!init) {
-		Catch=configHandler.GetInt (&quot;CatchAIExceptions&quot;, 1)!=0;
-		init=true;
-	}
-	return Catch;
-}
-
-// to switch off the exception handling and have it catched by the debugger.
-#define HANDLE_EXCEPTION  \
-	catch (const std::exception&amp; e) {	\
-		if (CatchException ()) {		\
-			AIException(e.what());		\
-			throw;						\
-		} else throw;					\
-	}									\
-	catch (const char *s) {	\
-		if (CatchException ()) {		\
-			AIException(s);				\
-			throw;						\
-		} else throw;					\
-	}									\
-	catch (...) {						\
-		if (CatchException ()) {		\
-			AIException(0);				\
-			throw;						\
-		}else throw;					\
-	}
-
-void AIException(const char *what)
-{
-//	static char msg[512];
-	if(what) {
-//		SNPRINTF(msg, sizeof(msg), &quot;An exception occured in the global ai dll: \'%s\',\n please contact the author of the AI.&quot;,	what);
-//		handleerror(0,msg, &quot;Exception in global AI&quot;,0);
-		logOutput.Print(&quot;Global ai exception:\'%s\'&quot;,what);
-	} else
-//		handleerror(0,&quot;An unhandled exception occured in the global ai dll, please contact the author of the ai.&quot;,&quot;Error in global ai&quot;,0);
-		logOutput.Print(&quot;Global ai exception&quot;);
-//	exit(-1);
-}
-
-CGlobalAIHandler::CGlobalAIHandler(void)
-{
-	hasAI=false;
-
-	for(int a=0;a&lt;MAX_TEAMS;++a)
-		ais[a]=0;
-}
-
-CGlobalAIHandler::~CGlobalAIHandler(void)
-{
-	for(int a=0;a&lt;MAX_TEAMS;++a)
-		delete ais[a];
-}
-
-void CGlobalAIHandler::PostLoad()
-{
-}
-
-void CGlobalAIHandler::Load(std::istream *s)
-{
-	try {
-		for(int a=0;a&lt;gs-&gt;activeTeams;++a)
-			if(ais[a])
-				ais[a]-&gt;Load(s);
-	} HANDLE_EXCEPTION;
-}
-
-void CGlobalAIHandler::Save(std::ostream *s)
-{
-	try {
-		for(int a=0;a&lt;gs-&gt;activeTeams;++a)
-			if(ais[a])
-				ais[a]-&gt;Save(s);
-	} HANDLE_EXCEPTION;
-}
-
-void CGlobalAIHandler::Update()
-{
-	SCOPED_TIMER(&quot;Skimrish AI&quot;)
-	try {
-		int frame = gs-&gt;frameNum;
-		for(int a=0;a&lt;gs-&gt;activeTeams;++a)
-			if(ais[a])
-				ais[a]-&gt;Update(frame);
-	} HANDLE_EXCEPTION;
-}
-
-void CGlobalAIHandler::PreDestroy ()
-{
-	try {
-		for(int a=0;a&lt;gs-&gt;activeTeams;a++)
-			if(ais[a])
-				ais[a]-&gt;PreDestroy();
-	} HANDLE_EXCEPTION;
-}
-
-void CGlobalAIHandler::UnitEnteredLos(CUnit* unit, int allyteam)
-{
-	if (hasAI) {
-		for (int a = 0; a &lt; gs-&gt;activeTeams; ++a) {
-			if (ais[a] &amp;&amp; gs-&gt;AllyTeam(a) == allyteam &amp;&amp; !gs-&gt;Ally(allyteam, unit-&gt;allyteam))
-				try {
-					ais[a]-&gt;EnemyEnterLOS(unit-&gt;id);
-				} HANDLE_EXCEPTION;
-		}
-	}
-}
-
-void CGlobalAIHandler::UnitLeftLos(CUnit* unit,int allyteam)
-{
-	if(hasAI){
-		for(int a=0;a&lt;gs-&gt;activeTeams;++a){
-			if(ais[a] &amp;&amp; gs-&gt;AllyTeam(a)==allyteam &amp;&amp; !gs-&gt;Ally(allyteam,unit-&gt;allyteam))
-				try {
-					ais[a]-&gt;EnemyLeaveLOS(unit-&gt;id);
-				} HANDLE_EXCEPTION;
-		}
-	}
-}
-
-void CGlobalAIHandler::UnitEnteredRadar(CUnit* unit,int allyteam)
-{
-	if(hasAI){
-		for(int a=0;a&lt;gs-&gt;activeTeams;++a){
-			if(ais[a] &amp;&amp; gs-&gt;AllyTeam(a)==allyteam &amp;&amp; !gs-&gt;Ally(allyteam,unit-&gt;allyteam))
-				try {
-					ais[a]-&gt;EnemyEnterRadar(unit-&gt;id);
-				} HANDLE_EXCEPTION;
-		}
-	}
-}
-
-void CGlobalAIHandler::UnitLeftRadar(CUnit* unit,int allyteam)
-{
-	if(hasAI){
-		for(int a=0;a&lt;gs-&gt;activeTeams;++a) {
-			if(ais[a] &amp;&amp; gs-&gt;AllyTeam(a)==allyteam &amp;&amp; !gs-&gt;Ally(allyteam,unit-&gt;allyteam))
-			{
-				try {
-					ais[a]-&gt;EnemyLeaveRadar(unit-&gt;id);
-				} HANDLE_EXCEPTION;
-			}
-		}
-	}
-}
-
-void CGlobalAIHandler::UnitIdle(CUnit* unit)
-{
-	if(ais[unit-&gt;team])
-		try {
-			ais[unit-&gt;team]-&gt;UnitIdle(unit-&gt;id);
-		} HANDLE_EXCEPTION;
-}
-
-void CGlobalAIHandler::UnitCreated(CUnit* unit)
-{
-	if(ais[unit-&gt;team])
-		try {
-			ais[unit-&gt;team]-&gt;UnitCreated(unit-&gt;id);
-		} 	HANDLE_EXCEPTION;
-}
-
-void CGlobalAIHandler::UnitFinished(CUnit* unit)
-{
-	if(ais[unit-&gt;team])
-		try {
-			ais[unit-&gt;team]-&gt;UnitFinished(unit-&gt;id);
-		} HANDLE_EXCEPTION;
-}
-
-void CGlobalAIHandler::UnitDestroyed(CUnit* unit,CUnit* attacker)
-{
-	if(hasAI){
-		try {
-			for(int a=0;a&lt;gs-&gt;activeTeams;++a){
-				if(ais[a]
-						&amp;&amp; !gs-&gt;Ally(gs-&gt;AllyTeam(a),unit-&gt;allyteam)
-						&amp;&amp; (ais[a]-&gt;IsCheatEventsEnabled() || (unit-&gt;losStatus[a] &amp; (LOS_INLOS | LOS_INRADAR))))
-					ais[a]-&gt;EnemyDestroyed(unit-&gt;id, attacker ? attacker-&gt;id : 0);
-			}
-			if(ais[unit-&gt;team])
-				ais[unit-&gt;team]-&gt;UnitDestroyed(unit-&gt;id,attacker?attacker-&gt;id:0);
-		} HANDLE_EXCEPTION;
-	}
-}
-
-void CGlobalAIHandler::UnitDamaged(CUnit* attacked, CUnit* attacker, float damage)
-{
-	if(hasAI){
-		try {
-			if(ais[attacked-&gt;team])
-				if(attacker){
-					float3 dir=helper-&gt;GetUnitErrorPos(attacker,attacked-&gt;allyteam)-attacked-&gt;pos;
-					dir.ANormalize();
-					ais[attacked-&gt;team]-&gt;UnitDamaged(attacked-&gt;id,attacker-&gt;id,damage,dir);
-				} else {
-					ais[attacked-&gt;team]-&gt;UnitDamaged(attacked-&gt;id,-1,damage,ZeroVector);
-				}
-
-			if(attacker) {
-				int a = attacker-&gt;team;
-				if(ais[attacker-&gt;team] &amp;&amp; !gs-&gt;Ally(gs-&gt;AllyTeam(a),attacked-&gt;allyteam) &amp;&amp; (ais[a]-&gt;IsCheatEventsEnabled() || (attacked-&gt;losStatus[a] &amp; (LOS_INLOS | LOS_INRADAR)))) {
-					float3 dir=attacker-&gt;pos-helper-&gt;GetUnitErrorPos(attacked,attacker-&gt;allyteam);
-					dir.ANormalize();
-					ais[a]-&gt;EnemyDamaged(attacked-&gt;id,attacker-&gt;id,damage,dir);
-				}
-			}
-		} HANDLE_EXCEPTION;
-	}
-}
-
-void CGlobalAIHandler::UnitMoveFailed(CUnit* unit)
-{
-	if(ais[unit-&gt;team])
-		try {
-			ais[unit-&gt;team]-&gt;UnitMoveFailed(unit-&gt;id);
-		} HANDLE_EXCEPTION;
-}
-
-void CGlobalAIHandler::UnitGiven(CUnit *unit, int oldTeam)
-{
-	if(ais[unit-&gt;team])
-		try {
-			ais[unit-&gt;team]-&gt;UnitGiven(unit-&gt;id, oldTeam, unit-&gt;team);
-		} HANDLE_EXCEPTION;
-}
-
-void CGlobalAIHandler::UnitTaken(CUnit *unit, int newTeam)
-{
-	if(ais[unit-&gt;team])
-		try {
-			ais[unit-&gt;team]-&gt;UnitCaptured(unit-&gt;id, unit-&gt;team, newTeam);
-		} HANDLE_EXCEPTION;
-}
-
-
-
-
-
-
-
-
-/*
-void* CGlobalAIHandler::GetAIBuffer(int team, std::string name, int length)
-{
-	if(memBuffers[team].find(name)!=memBuffers[team].end()){
-		memBuffers[team][name].usage++;
-		return memBuffers[team][name].mem;
-	}
-	AIMemBuffer mb;
-	mb.usage=1;
-	mb.mem=SAFE_NEW char[length];
-	memset(mb.mem,0,length);
-
-	memBuffers[team][name]=mb;
-	return mb.mem;
-}
-
-void CGlobalAIHandler::ReleaseAIBuffer(int team, std::string name)
-{
-	if(memBuffers[team].find(name)!=memBuffers[team].end()){
-		memBuffers[team][name].usage--;
-		if(memBuffers[team][name].usage==0){
-			delete memBuffers[team][name].mem;
-			memBuffers[team].erase(name);
-		}
-	}
-}
-*/
-
-void CGlobalAIHandler::GotChatMsg(const char* msg, int fromPlayerId)
-{
-	if(hasAI){
-		for(int a=0;a&lt;gs-&gt;activeTeams;++a)
-		{
-			if(ais[a])
-			{
-				try {
-					ais[a]-&gt;GotChatMsg(msg, fromPlayerId);
-				} HANDLE_EXCEPTION
-			}
-		}
-	}
-}
-
-void CGlobalAIHandler::PlayerCommandGiven(std::vector&lt;int&gt;&amp; selectedunits, Command&amp; c, int playerId)
-{
-	if(ais[gs-&gt;players[playerId]-&gt;team]){
-		try {
-			ais[gs-&gt;players[playerId]-&gt;team]-&gt;PlayerCommandGiven(selectedunits, c, playerId);
-		}
-		HANDLE_EXCEPTION;
-	}
-}
-
-void CGlobalAIHandler::SeismicPing(int allyTeam, CUnit* unit, const float3&amp; pos, float strength)
-{
-	if(hasAI){
-		for(int a=0;a&lt;gs-&gt;activeTeams;++a){
-			if(ais[a] &amp;&amp; gs-&gt;AllyTeam(a)==allyTeam &amp;&amp; !gs-&gt;Ally(allyTeam, unit-&gt;allyteam))
-				try {
-					ais[a]-&gt;SeismicPing(allyTeam, unit-&gt;id, pos, strength);
-				} HANDLE_EXCEPTION;
-		}
-	}
-}
-
-
-
-
-void CGlobalAIHandler::WeaponFired(CUnit* unit, const WeaponDef* def)
-{
-	if(ais[unit-&gt;team]){
-		try {
-			ais[unit-&gt;team]-&gt;WeaponFired(unit-&gt;id, def-&gt;id);
-		} HANDLE_EXCEPTION;
-	}
-}
-
-
-
-
-
-
-
-bool CGlobalAIHandler::CreateSkirmishAI(
-		int teamId,
-		const SSAIKey&amp; skirmishAIKey,
-		const std::map&lt;std::string, std::string&gt;&amp; skirmishAIOptions)
-{
-	if ((teamId &lt; 0) || (teamId &gt;= gs-&gt;activeTeams)) {
-		return false;
-	}
-
-	/*if (net-&gt;localDemoPlayback) {
-		return false;
-	}*/
-
-	//TODO: make this work again
-/*
-	if (strncmp(dll, &quot;LuaAI:&quot;, 6) == 0) {
-		CTeam* team = gs-&gt;Team(teamId);
-		if (team != NULL) {
-			team-&gt;luaAI = (dll + 6);
-			return true;
-		}
-		return false;
-	}
-*/
-
-	try {
-		if (ais[teamId]) {
-			delete ais[teamId];
-			ais[teamId] = 0;
-		}
-
-		//TODO : This is the crossover to the new AI
-		//Eventually we should rewrite a less hacky AILibraryHandler
-		//and change all calls to the global ai to be appropriate.
-		//ais[teamId] = SAFE_NEW CGlobalAI(teamId, dll);
-		//ais[teamId] = SAFE_NEW CAILibraryGlobalAI(dll, teamId);
-/*
-		const ISkirmishAILibrary* skirmishAILibrary = IAILibraryManager::GetInstance()-&gt;FetchSkirmishAILibrary(skirmishAIKey);
-		skirmishAIs[teamId] = SAFE_NEW CSkirmishAI(teamId, skirmishAILibrary);
-*/
-		ais[teamId] = SAFE_NEW CSkirmishAIWrapper(teamId, skirmishAIKey,
-				skirmishAIOptions);
-		
-/*
-		if (!ais[teamId]-&gt;ai) {
-			delete ais[teamId];
-			ais[teamId] = 0;
-			return false;
-		}
-*/
-
-		hasAI = true;
-		return true;
-	} HANDLE_EXCEPTION;
-	return false;
-}
-
-bool CGlobalAIHandler::IsSkirmishAI(int teamId) {
-	return ais[teamId] != 0;
-}
-
-void CGlobalAIHandler::DestroySkirmishAI(int teamId) {
-	
-	try {
-		delete ais[teamId];
-		ais[teamId] = 0;
-	} HANDLE_EXCEPTION;
-}
-
-const CSkirmishAIWrapper* CGlobalAIHandler::GetSkirmishAI(int teamId) {
-	return ais[teamId];
-}
-
+//
+//#include &quot;StdAfx.h&quot;
+//#include &quot;GlobalAIHandler.h&quot;
+//#include &quot;Interface/SAIInterfaceLibrary.h&quot;
+//#include &quot;AILibraryManager.h&quot;
+//#include &quot;SkirmishAI.h&quot;
+//#include &quot;SkirmishAIWrapper.h&quot;
+//#include &quot;IGlobalAI.h&quot;
+//#include &quot;Game/GlobalSynced.h&quot;
+//#include &quot;Game/GameHelper.h&quot;
+//#include &quot;Game/Player.h&quot;
+//#include &quot;Game/Team.h&quot;
+//#include &quot;Sim/Units/Unit.h&quot;
+//#include &quot;System/LogOutput.h&quot;
+//#include &quot;System/TimeProfiler.h&quot;
+//#include &quot;System/NetProtocol.h&quot;
+//#include &quot;System/Platform/errorhandler.h&quot;
+//#include &quot;mmgr.h&quot;
+//
+//CGlobalAIHandler* globalAI=0;
+//
+//CR_BIND_DERIVED(CGlobalAIHandler,CObject,)
+//
+//CR_REG_METADATA(CGlobalAIHandler, (
+//				CR_MEMBER(ais),
+//				CR_MEMBER(hasAI)
+////				CR_MEMBER(memBuffers)
+//				));
+//
+//bool CGlobalAIHandler::CatchException()
+//{
+//	static bool init=false;
+//	static bool Catch;
+//	if (!init) {
+//		Catch=configHandler.GetInt (&quot;CatchAIExceptions&quot;, 1)!=0;
+//		init=true;
+//	}
+//	return Catch;
+//}
+//
+//// to switch off the exception handling and have it catched by the debugger.
+//#define HANDLE_EXCEPTION  \
+//	catch (const std::exception&amp; e) {	\
+//		if (CatchException ()) {		\
+//			AIException(e.what());		\
+//			throw;						\
+//		} else throw;					\
+//	}									\
+//	catch (const char *s) {	\
+//		if (CatchException ()) {		\
+//			AIException(s);				\
+//			throw;						\
+//		} else throw;					\
+//	}									\
+//	catch (...) {						\
+//		if (CatchException ()) {		\
+//			AIException(0);				\
+//			throw;						\
+//		}else throw;					\
+//	}
+//
+//void AIException(const char *what)
+//{
+////	static char msg[512];
+//	if(what) {
+////		SNPRINTF(msg, sizeof(msg), &quot;An exception occured in the global ai dll: \'%s\',\n please contact the author of the AI.&quot;,	what);
+////		handleerror(0,msg, &quot;Exception in global AI&quot;,0);
+//		logOutput.Print(&quot;Global ai exception:\'%s\'&quot;,what);
+//	} else
+////		handleerror(0,&quot;An unhandled exception occured in the global ai dll, please contact the author of the ai.&quot;,&quot;Error in global ai&quot;,0);
+//		logOutput.Print(&quot;Global ai exception&quot;);
+////	exit(-1);
+//}
+//
+//CGlobalAIHandler::CGlobalAIHandler(void)
+//{
+//	hasAI=false;
+//
+//	for(int a=0;a&lt;MAX_TEAMS;++a)
+//		ais[a]=0;
+//}
+//
+//CGlobalAIHandler::~CGlobalAIHandler(void)
+//{
+//	for(int a=0;a&lt;MAX_TEAMS;++a)
+//		delete ais[a];
+//}
+//
+//void CGlobalAIHandler::PostLoad()
+//{
+//}
+//
+//void CGlobalAIHandler::Load(std::istream *s)
+//{
+//	try {
+//		for(int a=0;a&lt;gs-&gt;activeTeams;++a)
+//			if(ais[a])
+//				ais[a]-&gt;Load(s);
+//	} HANDLE_EXCEPTION;
+//}
+//
+//void CGlobalAIHandler::Save(std::ostream *s)
+//{
+//	try {
+//		for(int a=0;a&lt;gs-&gt;activeTeams;++a)
+//			if(ais[a])
+//				ais[a]-&gt;Save(s);
+//	} HANDLE_EXCEPTION;
+//}
+//
+//void CGlobalAIHandler::Update()
+//{
+//	SCOPED_TIMER(&quot;Skimrish AI&quot;)
+//	try {
+//		int frame = gs-&gt;frameNum;
+//		for(int a=0;a&lt;gs-&gt;activeTeams;++a)
+//			if(ais[a])
+//				ais[a]-&gt;Update(frame);
+//	} HANDLE_EXCEPTION;
+//}
+//
+//void CGlobalAIHandler::PreDestroy ()
+//{
+//	try {
+//		for(int a=0;a&lt;gs-&gt;activeTeams;a++)
+//			if(ais[a])
+//				ais[a]-&gt;PreDestroy();
+//	} HANDLE_EXCEPTION;
+//}
+//
+//void CGlobalAIHandler::UnitEnteredLos(CUnit* unit, int allyteam)
+//{
+//	if (hasAI) {
+//		for (int a = 0; a &lt; gs-&gt;activeTeams; ++a) {
+//			if (ais[a] &amp;&amp; gs-&gt;AllyTeam(a) == allyteam &amp;&amp; !gs-&gt;Ally(allyteam, unit-&gt;allyteam))
+//				try {
+//					ais[a]-&gt;EnemyEnterLOS(unit-&gt;id);
+//				} HANDLE_EXCEPTION;
+//		}
+//	}
+//}
+//
+//void CGlobalAIHandler::UnitLeftLos(CUnit* unit,int allyteam)
+//{
+//	if(hasAI){
+//		for(int a=0;a&lt;gs-&gt;activeTeams;++a){
+//			if(ais[a] &amp;&amp; gs-&gt;AllyTeam(a)==allyteam &amp;&amp; !gs-&gt;Ally(allyteam,unit-&gt;allyteam))
+//				try {
+//					ais[a]-&gt;EnemyLeaveLOS(unit-&gt;id);
+//				} HANDLE_EXCEPTION;
+//		}
+//	}
+//}
+//
+//void CGlobalAIHandler::UnitEnteredRadar(CUnit* unit,int allyteam)
+//{
+//	if(hasAI){
+//		for(int a=0;a&lt;gs-&gt;activeTeams;++a){
+//			if(ais[a] &amp;&amp; gs-&gt;AllyTeam(a)==allyteam &amp;&amp; !gs-&gt;Ally(allyteam,unit-&gt;allyteam))
+//				try {
+//					ais[a]-&gt;EnemyEnterRadar(unit-&gt;id);
+//				} HANDLE_EXCEPTION;
+//		}
+//	}
+//}
+//
+//void CGlobalAIHandler::UnitLeftRadar(CUnit* unit,int allyteam)
+//{
+//	if(hasAI){
+//		for(int a=0;a&lt;gs-&gt;activeTeams;++a) {
+//			if(ais[a] &amp;&amp; gs-&gt;AllyTeam(a)==allyteam &amp;&amp; !gs-&gt;Ally(allyteam,unit-&gt;allyteam))
+//			{
+//				try {
+//					ais[a]-&gt;EnemyLeaveRadar(unit-&gt;id);
+//				} HANDLE_EXCEPTION;
+//			}
+//		}
+//	}
+//}
+//
+//void CGlobalAIHandler::UnitIdle(CUnit* unit)
+//{
+//	if(ais[unit-&gt;team])
+//		try {
+//			ais[unit-&gt;team]-&gt;UnitIdle(unit-&gt;id);
+//		} HANDLE_EXCEPTION;
+//}
+//
+//void CGlobalAIHandler::UnitCreated(CUnit* unit)
+//{
+//	if(ais[unit-&gt;team])
+//		try {
+//			ais[unit-&gt;team]-&gt;UnitCreated(unit-&gt;id);
+//		} 	HANDLE_EXCEPTION;
+//}
+//
+//void CGlobalAIHandler::UnitFinished(CUnit* unit)
+//{
+//	if(ais[unit-&gt;team])
+//		try {
+//			ais[unit-&gt;team]-&gt;UnitFinished(unit-&gt;id);
+//		} HANDLE_EXCEPTION;
+//}
+//
+//void CGlobalAIHandler::UnitDestroyed(CUnit* unit,CUnit* attacker)
+//{
+//	if(hasAI){
+//		try {
+//			for(int a=0;a&lt;gs-&gt;activeTeams;++a){
+//				if(ais[a]
+//						&amp;&amp; !gs-&gt;Ally(gs-&gt;AllyTeam(a),unit-&gt;allyteam)
+//						&amp;&amp; (ais[a]-&gt;IsCheatEventsEnabled() || (unit-&gt;losStatus[a] &amp; (LOS_INLOS | LOS_INRADAR))))
+//					ais[a]-&gt;EnemyDestroyed(unit-&gt;id, attacker ? attacker-&gt;id : 0);
+//			}
+//			if(ais[unit-&gt;team])
+//				ais[unit-&gt;team]-&gt;UnitDestroyed(unit-&gt;id,attacker?attacker-&gt;id:0);
+//		} HANDLE_EXCEPTION;
+//	}
+//}
+//
+//void CGlobalAIHandler::UnitDamaged(CUnit* attacked, CUnit* attacker, float damage)
+//{
+//	if(hasAI){
+//		try {
+//			if(ais[attacked-&gt;team])
+//				if(attacker){
+//					float3 dir=helper-&gt;GetUnitErrorPos(attacker,attacked-&gt;allyteam)-attacked-&gt;pos;
+//					dir.ANormalize();
+//					ais[attacked-&gt;team]-&gt;UnitDamaged(attacked-&gt;id,attacker-&gt;id,damage,dir);
+//				} else {
+//					ais[attacked-&gt;team]-&gt;UnitDamaged(attacked-&gt;id,-1,damage,ZeroVector);
+//				}
+//
+//			if(attacker) {
+//				int a = attacker-&gt;team;
+//				if(ais[attacker-&gt;team] &amp;&amp; !gs-&gt;Ally(gs-&gt;AllyTeam(a),attacked-&gt;allyteam) &amp;&amp; (ais[a]-&gt;IsCheatEventsEnabled() || (attacked-&gt;losStatus[a] &amp; (LOS_INLOS | LOS_INRADAR)))) {
+//					float3 dir=attacker-&gt;pos-helper-&gt;GetUnitErrorPos(attacked,attacker-&gt;allyteam);
+//					dir.ANormalize();
+//					ais[a]-&gt;EnemyDamaged(attacked-&gt;id,attacker-&gt;id,damage,dir);
+//				}
+//			}
+//		} HANDLE_EXCEPTION;
+//	}
+//}
+//
+//void CGlobalAIHandler::UnitMoveFailed(CUnit* unit)
+//{
+//	if(ais[unit-&gt;team])
+//		try {
+//			ais[unit-&gt;team]-&gt;UnitMoveFailed(unit-&gt;id);
+//		} HANDLE_EXCEPTION;
+//}
+//
+//void CGlobalAIHandler::UnitGiven(CUnit *unit, int oldTeam)
+//{
+//	if(ais[unit-&gt;team])
+//		try {
+//			ais[unit-&gt;team]-&gt;UnitGiven(unit-&gt;id, oldTeam, unit-&gt;team);
+//		} HANDLE_EXCEPTION;
+//}
+//
+//void CGlobalAIHandler::UnitTaken(CUnit *unit, int newTeam)
+//{
+//	if(ais[unit-&gt;team])
+//		try {
+//			ais[unit-&gt;team]-&gt;UnitCaptured(unit-&gt;id, unit-&gt;team, newTeam);
+//		} HANDLE_EXCEPTION;
+//}
+//
+//
+//
+//
+//
+//
+//
+//
+///*
+//void* CGlobalAIHandler::GetAIBuffer(int team, std::string name, int length)
+//{
+//	if(memBuffers[team].find(name)!=memBuffers[team].end()){
+//		memBuffers[team][name].usage++;
+//		return memBuffers[team][name].mem;
+//	}
+//	AIMemBuffer mb;
+//	mb.usage=1;
+//	mb.mem=SAFE_NEW char[length];
+//	memset(mb.mem,0,length);
+//
+//	memBuffers[team][name]=mb;
+//	return mb.mem;
+//}
+//
+//void CGlobalAIHandler::ReleaseAIBuffer(int team, std::string name)
+//{
+//	if(memBuffers[team].find(name)!=memBuffers[team].end()){
+//		memBuffers[team][name].usage--;
+//		if(memBuffers[team][name].usage==0){
+//			delete memBuffers[team][name].mem;
+//			memBuffers[team].erase(name);
+//		}
+//	}
+//}
+//*/
+//
+//void CGlobalAIHandler::GotChatMsg(const char* msg, int fromPlayerId)
+//{
+//	if(hasAI){
+//		for(int a=0;a&lt;gs-&gt;activeTeams;++a)
+//		{
+//			if(ais[a])
+//			{
+//				try {
+//					ais[a]-&gt;GotChatMsg(msg, fromPlayerId);
+//				} HANDLE_EXCEPTION
+//			}
+//		}
+//	}
+//}
+//
+//void CGlobalAIHandler::PlayerCommandGiven(std::vector&lt;int&gt;&amp; selectedunits, Command&amp; c, int playerId)
+//{
+//	if(ais[gs-&gt;players[playerId]-&gt;team]){
+//		try {
+//			ais[gs-&gt;players[playerId]-&gt;team]-&gt;PlayerCommandGiven(selectedunits, c, playerId);
+//		}
+//		HANDLE_EXCEPTION;
+//	}
+//}
+//
+//void CGlobalAIHandler::SeismicPing(int allyTeam, CUnit* unit, const float3&amp; pos, float strength)
+//{
+//	if(hasAI){
+//		for(int a=0;a&lt;gs-&gt;activeTeams;++a){
+//			if(ais[a] &amp;&amp; gs-&gt;AllyTeam(a)==allyTeam &amp;&amp; !gs-&gt;Ally(allyTeam, unit-&gt;allyteam))
+//				try {
+//					ais[a]-&gt;SeismicPing(allyTeam, unit-&gt;id, pos, strength);
+//				} HANDLE_EXCEPTION;
+//		}
+//	}
+//}
+//
+//
+//
+//
+//void CGlobalAIHandler::WeaponFired(CUnit* unit, const WeaponDef* def)
+//{
+//	if(ais[unit-&gt;team]){
+//		try {
+//			ais[unit-&gt;team]-&gt;WeaponFired(unit-&gt;id, def-&gt;id);
+//		} HANDLE_EXCEPTION;
+//	}
+//}
+//
+//
+//
+//
+//
+//
+//
+//bool CGlobalAIHandler::CreateSkirmishAI(
+//		int teamId,
+//		const SSAIKey&amp; skirmishAIKey,
+//		const std::map&lt;std::string, std::string&gt;&amp; skirmishAIOptions)
+//{
+//	if ((teamId &lt; 0) || (teamId &gt;= gs-&gt;activeTeams)) {
+//		return false;
+//	}
+//
+//	/*if (net-&gt;localDemoPlayback) {
+//		return false;
+//	}*/
+//
+//	//TODO: make this work again
+///*
+//	if (strncmp(dll, &quot;LuaAI:&quot;, 6) == 0) {
+//		CTeam* team = gs-&gt;Team(teamId);
+//		if (team != NULL) {
+//			team-&gt;luaAI = (dll + 6);
+//			return true;
+//		}
+//		return false;
+//	}
+//*/
+//
+//	try {
+//		if (ais[teamId]) {
+//			delete ais[teamId];
+//			ais[teamId] = 0;
+//		}
+//
+//		//TODO : This is the crossover to the new AI
+//		//Eventually we should rewrite a less hacky AILibraryHandler
+//		//and change all calls to the global ai to be appropriate.
+//		//ais[teamId] = SAFE_NEW CGlobalAI(teamId, dll);
+//		//ais[teamId] = SAFE_NEW CAILibraryGlobalAI(dll, teamId);
+///*
+//		const ISkirmishAILibrary* skirmishAILibrary = IAILibraryManager::GetInstance()-&gt;FetchSkirmishAILibrary(skirmishAIKey);
+//		skirmishAIs[teamId] = SAFE_NEW CSkirmishAI(teamId, skirmishAILibrary);
+//*/
+//		ais[teamId] = SAFE_NEW CSkirmishAIWrapper(teamId, skirmishAIKey,
+//				skirmishAIOptions);
+//		
+///*
+//		if (!ais[teamId]-&gt;ai) {
+//			delete ais[teamId];
+//			ais[teamId] = 0;
+//			return false;
+//		}
+//*/
+//
+//		hasAI = true;
+//		return true;
+//	} HANDLE_EXCEPTION;
+//	return false;
+//}
+//
+//bool CGlobalAIHandler::IsSkirmishAI(int teamId) {
+//	return ais[teamId] != 0;
+//}
+//
+//void CGlobalAIHandler::DestroySkirmishAI(int teamId) {
+//	
+//	try {
+//		delete ais[teamId];
+//		ais[teamId] = 0;
+//	} HANDLE_EXCEPTION;
+//}
+//
+//const CSkirmishAIWrapper* CGlobalAIHandler::GetSkirmishAI(int teamId) {
+//	return ais[teamId];
+//}

Modified: branches/caiinterface/rts/ExternalAI/GlobalAIHandler.h
===================================================================
--- branches/caiinterface/rts/ExternalAI/GlobalAIHandler.h	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/rts/ExternalAI/GlobalAIHandler.h	2008-11-12 21:22:55 UTC (rev 7024)
@@ -1,67 +1,67 @@
-#ifndef GLOBALAIHANDLER_H
-#define GLOBALAIHANDLER_H
-
-#include &quot;IAILibraryManager.h&quot;
-#include &quot;ISkirmishAI.h&quot;
-#include &quot;Object.h&quot;
-#include &quot;Platform/ConfigHandler.h&quot;
-#include &quot;float3.h&quot;
-#include &quot;Game/GlobalConstants.h&quot;
-#include &lt;map&gt;
-#include &lt;string&gt;
-
-class CUnit;
-class CGlobalAI;
-class CSkirmishAIWrapper;
-struct WeaponDef;
-struct Command;
-
-class CGlobalAIHandler :
-	public CObject
-{
-public:
-	CR_DECLARE(CGlobalAIHandler);
-//	CR_DECLARE_SUB(AIMemBuffer);
-	static bool CatchException();
-
-	CGlobalAIHandler();
-	~CGlobalAIHandler();
-
-	void PostLoad();
-	void PreDestroy();
-
-	void Update();
-	void UnitEnteredLos(CUnit* unit, int allyTeam);
-	void UnitLeftLos(CUnit* unit, int allyTeam);
-	void UnitEnteredRadar(CUnit* unit, int allyTeam);
-	void UnitLeftRadar(CUnit* unit, int allyTeam);
-	void SeismicPing(int allyteam, CUnit *unit, const float3 &amp;pos, float strength);
-
-	void UnitIdle(CUnit* unit);
-	void UnitCreated(CUnit* unit);
-	void UnitFinished(CUnit* unit);
-	void UnitDestroyed(CUnit* unit, CUnit *attacker);
-	void UnitDamaged(CUnit* attacked, CUnit* attacker, float damage);
-	void UnitMoveFailed(CUnit* unit);
-	void UnitTaken(CUnit* unit, int newTeam);
-	void UnitGiven(CUnit* unit, int oldTeam);
-	void WeaponFired(CUnit* unit, const WeaponDef* def);
-	void PlayerCommandGiven(std::vector&lt;int&gt;&amp; selectedunits,Command&amp; c,int player);
-	void Load(std::istream *s);
-	void Save(std::ostream *s);
-	void GotChatMsg(const char* msg, int player);
-
-	bool CreateSkirmishAI(int teamId, const SSAIKey&amp; skirmishAIKey,
-			const std::map&lt;std::string, std::string&gt;&amp; skirmishAIOptions);
-	bool IsSkirmishAI(int teamId);
-	void DestroySkirmishAI(int teamId);
-	const CSkirmishAIWrapper* GetSkirmishAI(int teamId);
-
-private:
-	CSkirmishAIWrapper* ais[MAX_TEAMS];
-	bool hasAI;
-};
-
-extern CGlobalAIHandler* globalAI;
-
-#endif
+//#ifndef GLOBALAIHANDLER_H
+//#define GLOBALAIHANDLER_H
+//
+//#include &quot;IAILibraryManager.h&quot;
+//#include &quot;ISkirmishAI.h&quot;
+//#include &quot;Object.h&quot;
+//#include &quot;Platform/ConfigHandler.h&quot;
+//#include &quot;float3.h&quot;
+//#include &quot;Game/GlobalConstants.h&quot;
+//#include &lt;map&gt;
+//#include &lt;string&gt;
+//
+//class CUnit;
+//class CGlobalAI;
+//class CSkirmishAIWrapper;
+//struct WeaponDef;
+//struct Command;
+//
+//class CGlobalAIHandler :
+//	public CObject
+//{
+//public:
+//	CR_DECLARE(CGlobalAIHandler);
+////	CR_DECLARE_SUB(AIMemBuffer);
+//	static bool CatchException();
+//
+//	CGlobalAIHandler();
+//	~CGlobalAIHandler();
+//
+//	void PostLoad();
+//	void PreDestroy();
+//
+//	void Update();
+//	void UnitEnteredLos(CUnit* unit, int allyTeam);
+//	void UnitLeftLos(CUnit* unit, int allyTeam);
+//	void UnitEnteredRadar(CUnit* unit, int allyTeam);
+//	void UnitLeftRadar(CUnit* unit, int allyTeam);
+//	void SeismicPing(int allyteam, CUnit *unit, const float3 &amp;pos, float strength);
+//
+//	void UnitIdle(CUnit* unit);
+//	void UnitCreated(CUnit* unit);
+//	void UnitFinished(CUnit* unit);
+//	void UnitDestroyed(CUnit* unit, CUnit *attacker);
+//	void UnitDamaged(CUnit* attacked, CUnit* attacker, float damage);
+//	void UnitMoveFailed(CUnit* unit);
+//	void UnitTaken(CUnit* unit, int newTeam);
+//	void UnitGiven(CUnit* unit, int oldTeam);
+//	void WeaponFired(CUnit* unit, const WeaponDef* def);
+//	void PlayerCommandGiven(std::vector&lt;int&gt;&amp; selectedunits,Command&amp; c,int player);
+//	void Load(std::istream *s);
+//	void Save(std::ostream *s);
+//	void GotChatMsg(const char* msg, int player);
+//
+//	bool CreateSkirmishAI(int teamId, const SSAIKey&amp; skirmishAIKey,
+//			const std::map&lt;std::string, std::string&gt;&amp; skirmishAIOptions);
+//	bool IsSkirmishAI(int teamId);
+//	void DestroySkirmishAI(int teamId);
+//	const CSkirmishAIWrapper* GetSkirmishAI(int teamId);
+//
+//private:
+//	CSkirmishAIWrapper* ais[MAX_TEAMS];
+//	bool hasAI;
+//};
+//
+//extern CGlobalAIHandler* globalAI;
+//
+//#endif

Modified: branches/caiinterface/rts/ExternalAI/Group.h
===================================================================
--- branches/caiinterface/rts/ExternalAI/Group.h	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/rts/ExternalAI/Group.h	2008-11-12 21:22:55 UTC (rev 7024)
@@ -8,34 +8,29 @@
 #include &lt;string&gt;
 #include &lt;set&gt;
 #include &quot;Sim/Units/CommandAI/Command.h&quot;
-//#include &quot;Platform/SharedLib.h&quot;
+#include &quot;Platform/SharedLib.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;Sim/Units/UnitSet.h&quot;
-//#include &quot;ExternalAI/aikey.h&quot;
-//class IGroupAI;
+#include &quot;ExternalAI/aikey.h&quot;
+class IGroupAI;
 class CUnit;
 class CFeature;
-//class CGroupAICallback;
+class CGroupAICallback;
 class CGroupHandler;
-struct SGAIKey;
 
 class CGroup : public CObject
 {
 public:
 	CR_DECLARE(CGroup);
-	//CGroup(AIKey aiKey, int id, CGroupHandler* groupHandler);
-	CGroup(int id);
+	CGroup(AIKey aiKey, int id, CGroupHandler* groupHandler);
 	virtual ~CGroup();
 	void Serialize(creg::ISerializer *s);
 	void PostLoad();
 
-//	void Update();
+	void Update();
 	void DrawCommands();
-//	void SetNewAI(AIKey aiKey);
+	void SetNewAI(AIKey aiKey);
 
-	void SetAI(const SGAIKey* key);
-	void ClearAI();
-
 	void CommandFinished(int unitId, int commandTopicId);
 	void RemoveUnit(CUnit* unit);	//call setgroup(0) instead of calling this directly
 	bool AddUnit(CUnit* unit);		//dont call this directly call unit.SetGroup and let that call this
@@ -48,26 +43,25 @@
 
 	CUnitSet units;
 
-//	vector&lt;CommandDescription&gt; myCommands;
-//	SharedLib *lib;
-//	typedef int (* GETGROUPAIVERSION)();
-//	typedef IGroupAI* (* GETNEWAI)(unsigned aiNumber);
-//	typedef void (* RELEASEAI)(unsigned aiNumber,IGroupAI* i);
-//	typedef bool (* ISUNITSUITED)(unsigned aiNumber,const UnitDef* unitDef);
+	vector&lt;CommandDescription&gt; myCommands;
+	SharedLib *lib;
+	typedef int (* GETGROUPAIVERSION)();
+	typedef IGroupAI* (* GETNEWAI)(unsigned aiNumber);
+	typedef void (* RELEASEAI)(unsigned aiNumber,IGroupAI* i);
+	typedef bool (* ISUNITSUITED)(unsigned aiNumber,const UnitDef* unitDef);
 
-//	GETGROUPAIVERSION GetGroupAiVersion;
-//	GETNEWAI GetNewAI;
-//	RELEASEAI ReleaseAI;
-//	ISUNITSUITED IsUnitSuited;
+	GETGROUPAIVERSION GetGroupAiVersion;
+	GETNEWAI GetNewAI;
+	RELEASEAI ReleaseAI;
+	ISUNITSUITED IsUnitSuited;
 	int lastCommandPage;
-//	int currentAiNum;
-//	AIKey currentAiKey;
-	const SGAIKey* currentAIKey;
-//
-//	IGroupAI* ai;
-//	CGroupAICallback* callback;
+	int currentAiNum;
+	AIKey currentAiKey;
 
-//	CGroupHandler* handler;
+	IGroupAI* ai;
+	CGroupAICallback* callback;
+
+	CGroupHandler* handler;
 };
 
-#endif /* GROUP_H */
+#endif // GROUP_H

Modified: branches/caiinterface/rts/ExternalAI/GroupAI.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/GroupAI.cpp	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/rts/ExternalAI/GroupAI.cpp	2008-11-12 21:22:55 UTC (rev 7024)
@@ -24,12 +24,12 @@
 		: teamId(teamId), groupId(groupId), key(key) {
 
 	library = IAILibraryManager::GetInstance()-&gt;FetchGroupAILibrary(key);
-	library-&gt;Init(teamId);
+	library-&gt;Init(teamId, groupId);
 }
 
 CGroupAI::~CGroupAI() {
 
-	library-&gt;Release(teamId);
+	library-&gt;Release(teamId, groupId);
 	IAILibraryManager::GetInstance()-&gt;ReleaseGroupAILibrary(key);
 }
 

Modified: branches/caiinterface/rts/ExternalAI/GroupAILibrary.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/GroupAILibrary.cpp	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/rts/ExternalAI/GroupAILibrary.cpp	2008-11-12 21:22:55 UTC (rev 7024)
@@ -22,7 +22,10 @@
 #include &lt;string&gt;
 
 CGroupAILibrary::CGroupAILibrary(const SGAILibrary&amp; ai,
-		const SGAISpecifier&amp; specifier) : sGAI(ai), specifier(specifier) {}
+		const SGAISpecifier&amp; specifier,
+		const InfoItem info[], unsigned int numInfoItems)
+		: sGAI(ai), specifier(specifier),
+		info(info), numInfoItems(numInfoItems) {}
 
 CGroupAILibrary::~CGroupAILibrary() {}
 	
@@ -80,8 +83,7 @@
 */
 
 
-void CGroupAILibrary::Init(int teamId, int groupId, const InfoItem info[],
-		unsigned int numInfoItems) const {
+void CGroupAILibrary::Init(int teamId, int groupId) const {
 	
 	if (sGAI.init != NULL) {
 		int error = sGAI.init(teamId, groupId, info, numInfoItems);

Modified: branches/caiinterface/rts/ExternalAI/GroupAILibrary.h
===================================================================
--- branches/caiinterface/rts/ExternalAI/GroupAILibrary.h	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/rts/ExternalAI/GroupAILibrary.h	2008-11-12 21:22:55 UTC (rev 7024)
@@ -25,7 +25,8 @@
 
 class CGroupAILibrary : public IGroupAILibrary {
 public:
-	CGroupAILibrary(const SGAILibrary&amp; ai, const SGAISpecifier&amp; specifier);
+	CGroupAILibrary(const SGAILibrary&amp; ai, const SGAISpecifier&amp; specifier,
+			const InfoItem info[], unsigned int numInfoItems);
 	virtual ~CGroupAILibrary();
 	
 	virtual SGAISpecifier GetSpecifier() const;
@@ -41,14 +42,15 @@
 //	virtual std::vector&lt;Option&gt; GetOptions() const;
 	
 	
-    virtual void Init(int teamId, int groupId, const InfoItem info[],
-			unsigned int numInfoItems) const;
+    virtual void Init(int teamId, int groupId) const;
     virtual void Release(int teamId, int groupId) const;
     virtual int HandleEvent(int teamId, int groupId, int topic, const void* data) const;
 	
 private:
 	SGAILibrary sGAI;
 	SGAISpecifier specifier;
+	const InfoItem* info;
+	unsigned int numInfoItems;
 	
 private:
 //	void reportInterfaceFunctionError(const std::string* libFileName, const std::string* functionName);

Modified: branches/caiinterface/rts/ExternalAI/GroupAIWrapper.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/GroupAIWrapper.cpp	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/rts/ExternalAI/GroupAIWrapper.cpp	2008-11-12 21:22:55 UTC (rev 7024)
@@ -15,6 +15,7 @@
 	along with this program.  If not, see &lt;<A HREF="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</A>&gt;.
 */
 
+/*
 #include &quot;GroupAIWrapper.h&quot;
 
 #include &quot;StdAfx.h&quot;
@@ -195,18 +196,16 @@
 
 void CGroupAIWrapper::Load(std::istream* s) {
 
-/* TODO
-	SLoadAIEvent evtData = {s.TO_FILENAME(TODO), callback};
-	ai-&gt;HandleEvent(EVENT_LOAD_AI, &amp;evtData);
-*/
+//TODO
+//	SLoadAIEvent evtData = {s.TO_FILENAME(TODO), callback};
+//	ai-&gt;HandleEvent(EVENT_LOAD_AI, &amp;evtData);
 }
 
 void CGroupAIWrapper::Save(std::ostream* s) {
 
-/* TODO
-	SSaveAIEvent evtData = {s.TO_FILENAME(TODO)};
-	ai-&gt;HandleEvent(EVENT_SAVE_AI, &amp;evtData);
-*/
+//TODO
+//	SSaveAIEvent evtData = {s.TO_FILENAME(TODO)};
+//	ai-&gt;HandleEvent(EVENT_SAVE_AI, &amp;evtData);
 }
 
 void CGroupAIWrapper::UnitIdle(int unitId) {
@@ -357,3 +356,4 @@
 {
 	return ai-&gt;HandleEvent(topic, data);
 }
+*/

Modified: branches/caiinterface/rts/ExternalAI/GroupAIWrapper.h
===================================================================
--- branches/caiinterface/rts/ExternalAI/GroupAIWrapper.h	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/rts/ExternalAI/GroupAIWrapper.h	2008-11-12 21:22:55 UTC (rev 7024)
@@ -15,108 +15,108 @@
 	along with this program.  If not, see &lt;<A HREF="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</A>&gt;.
 */
 
-#ifndef _GROUPAIWRAPPER_H
-#define _GROUPAIWRAPPER_H
-
-#include &quot;Object.h&quot;
-#include &quot;IGroupAI.h&quot;
-#include &quot;GlobalAICallback.h&quot;
-#include &quot;Interface/SAICallback.h&quot;
-#include &quot;Interface/SAIInterfaceLibrary.h&quot;
-#include &quot;Platform/SharedLib.h&quot;
-
-#include &lt;map&gt;
-#include &lt;string&gt;
-
-class CAICallback;
-struct Command;
-struct float3;
-
-class CGroupAIWrapper : public CObject, public IGroupAI {
-public:
-	CR_DECLARE(CGroupAIWrapper);
-
-	CGroupAIWrapper(int teamId, int groupId, const SGAIKey&amp; key,
-			const std::map&lt;std::string, std::string&gt;&amp; options = (std::map&lt;std::string, std::string&gt;()));
-	~CGroupAIWrapper();
-
-	void Serialize(creg::ISerializer *s);
-	void PostLoad();
-
-	// AI Events
-	virtual void Load(std::istream *s);
-	virtual void Save(std::ostream *s);
-
-	// Events in common with Skirmish AIs
-	virtual void UnitIdle(int unitId);
-	virtual void UnitCreated(int unitId);
-	virtual void UnitFinished(int unitId);
-	virtual void UnitDestroyed(int unitId, int attackerUnitId);
-	virtual void UnitDamaged(int unitId, int attackerUnitId, float damage, const float3&amp; dir);
-	virtual void UnitMoveFailed(int unitId);
-	virtual void UnitGiven(int unitId, int oldTeam, int newTeam);
-	virtual void UnitCaptured(int unitId, int oldTeam, int newTeam);
-	virtual void EnemyEnterLOS(int unitId);
-	virtual void EnemyLeaveLOS(int unitId);
-	virtual void EnemyEnterRadar(int unitId);
-	virtual void EnemyLeaveRadar(int unitId);
-	virtual void EnemyDestroyed(int enemyUnitId, int attackerUnitId);
-	virtual void EnemyDamaged(int enemyUnitId, int attackerUnitId, float damage, const float3&amp; dir);
-	virtual void Update(int frame);
-//	virtual void Update();				//called once a frame (30 times a second)
-	virtual void GotChatMsg(const char* msg, int fromPlayerId);
-	virtual void WeaponFired(int unitId, int weaponDefId);
-	virtual void PlayerCommandGiven(const std::vector&lt;int&gt;&amp; selectedUnits, const Command&amp; c, int playerId);
-//	virtual void GiveCommand(Command* c);		//the group is given a command by the player
-	virtual void SeismicPing(int allyTeam, int unitId, const float3&amp; pos, float strength);
-
-	// Group AI specific Events
-	virtual bool AddUnit(int unitId);		//group should return false if it doenst want the unit for some reason
-	virtual void RemoveUnit(int unitId);		//no way to refuse giving up a unit
-	//the ai tells the interface what commands it can take (note that it returns a reference so it must keep the vector in memory itself)
-	virtual const std::vector&lt;CommandDescription&gt;&amp; GetPossibleCommands();
-	virtual int GetDefaultCmd(int unitId);	//the default command for the ai given that the mouse pointer hovers above unit unitid (or no unit if unitid=0)
-	virtual void CommandFinished(int unitId, int commandTopic);	//a specific unit has finished a specific command, might be a good idea to give new orders to it
-	virtual void DrawCommands();				//the place to use the LineDrawer interface functions
-
-
-	virtual void PreDestroy(); // called just before all the units are destroyed
-
-	virtual int GetTeamId() const;
-	virtual int GetGroupId() const;
-
-	virtual void SetCheatEventsEnabled(bool enable);
-	virtual bool IsCheatEventsEnabled() const;
-
-
-	/**
-	 * Inherited form IGroupAI.
-	 * CAUTION: takes C AI Interface events, not engine C++ ones!
-	 */
-	virtual int HandleEvent(int topic, const void* data) const;
-
-private:
-	virtual void Init();
-	virtual void Release();
-
-private:
-	int teamId;
-	int groupId;
-	bool cheatEvents;
-
-//	bool loadSupported;
-
-	IGroupAI* ai;
-	CGroupAICallback* callback;
-	SAICallback* c_callback;
-	SGAIKey key;
-	std::vector&lt;std::string&gt; optionKeys;
-	std::vector&lt;std::string&gt; optionValues;
-	const char** optionKeys_c;
-	const char** optionValues_c;
-
-private:
-	void LoadGroupAI(bool postLoad);
-};
-
-#endif // _GROUPAIWRAPPER_H
+//#ifndef _GROUPAIWRAPPER_H
+//#define _GROUPAIWRAPPER_H
+//
+//#include &quot;Object.h&quot;
+//#include &quot;IGroupAI.h&quot;
+//#include &quot;GlobalAICallback.h&quot;
+//#include &quot;Interface/SAICallback.h&quot;
+//#include &quot;Interface/SAIInterfaceLibrary.h&quot;
+//#include &quot;Platform/SharedLib.h&quot;
+//
+//#include &lt;map&gt;
+//#include &lt;string&gt;
+//
+//class CAICallback;
+//struct Command;
+//struct float3;
+//
+//class CGroupAIWrapper : public CObject, public IGroupAI {
+//public:
+//	CR_DECLARE(CGroupAIWrapper);
+//
+//	CGroupAIWrapper(int teamId, int groupId, const SGAIKey&amp; key,
+//			const std::map&lt;std::string, std::string&gt;&amp; options = (std::map&lt;std::string, std::string&gt;()));
+//	~CGroupAIWrapper();
+//
+//	void Serialize(creg::ISerializer *s);
+//	void PostLoad();
+//
+//	// AI Events
+//	virtual void Load(std::istream *s);
+//	virtual void Save(std::ostream *s);
+//
+//	// Events in common with Skirmish AIs
+//	virtual void UnitIdle(int unitId);
+//	virtual void UnitCreated(int unitId);
+//	virtual void UnitFinished(int unitId);
+//	virtual void UnitDestroyed(int unitId, int attackerUnitId);
+//	virtual void UnitDamaged(int unitId, int attackerUnitId, float damage, const float3&amp; dir);
+//	virtual void UnitMoveFailed(int unitId);
+//	virtual void UnitGiven(int unitId, int oldTeam, int newTeam);
+//	virtual void UnitCaptured(int unitId, int oldTeam, int newTeam);
+//	virtual void EnemyEnterLOS(int unitId);
+//	virtual void EnemyLeaveLOS(int unitId);
+//	virtual void EnemyEnterRadar(int unitId);
+//	virtual void EnemyLeaveRadar(int unitId);
+//	virtual void EnemyDestroyed(int enemyUnitId, int attackerUnitId);
+//	virtual void EnemyDamaged(int enemyUnitId, int attackerUnitId, float damage, const float3&amp; dir);
+//	virtual void Update(int frame);
+////	virtual void Update();				//called once a frame (30 times a second)
+//	virtual void GotChatMsg(const char* msg, int fromPlayerId);
+//	virtual void WeaponFired(int unitId, int weaponDefId);
+//	virtual void PlayerCommandGiven(const std::vector&lt;int&gt;&amp; selectedUnits, const Command&amp; c, int playerId);
+////	virtual void GiveCommand(Command* c);		//the group is given a command by the player
+//	virtual void SeismicPing(int allyTeam, int unitId, const float3&amp; pos, float strength);
+//
+//	// Group AI specific Events
+//	virtual bool AddUnit(int unitId);		//group should return false if it doenst want the unit for some reason
+//	virtual void RemoveUnit(int unitId);		//no way to refuse giving up a unit
+//	//the ai tells the interface what commands it can take (note that it returns a reference so it must keep the vector in memory itself)
+//	virtual const std::vector&lt;CommandDescription&gt;&amp; GetPossibleCommands();
+//	virtual int GetDefaultCmd(int unitId);	//the default command for the ai given that the mouse pointer hovers above unit unitid (or no unit if unitid=0)
+//	virtual void CommandFinished(int unitId, int commandTopic);	//a specific unit has finished a specific command, might be a good idea to give new orders to it
+//	virtual void DrawCommands();				//the place to use the LineDrawer interface functions
+//
+//
+//	virtual void PreDestroy(); // called just before all the units are destroyed
+//
+//	virtual int GetTeamId() const;
+//	virtual int GetGroupId() const;
+//
+//	virtual void SetCheatEventsEnabled(bool enable);
+//	virtual bool IsCheatEventsEnabled() const;
+//
+//
+//	/**
+//	 * Inherited form IGroupAI.
+//	 * CAUTION: takes C AI Interface events, not engine C++ ones!
+//	 */
+//	virtual int HandleEvent(int topic, const void* data) const;
+//
+//private:
+//	virtual void Init();
+//	virtual void Release();
+//
+//private:
+//	int teamId;
+//	int groupId;
+//	bool cheatEvents;
+//
+////	bool loadSupported;
+//
+//	IGroupAI* ai;
+//	CGroupAICallback* callback;
+//	SAICallback* c_callback;
+//	SGAIKey key;
+//	std::vector&lt;std::string&gt; optionKeys;
+//	std::vector&lt;std::string&gt; optionValues;
+//	const char** optionKeys_c;
+//	const char** optionValues_c;
+//
+//private:
+//	void LoadGroupAI(bool postLoad);
+//};
+//
+//#endif // _GROUPAIWRAPPER_H

Modified: branches/caiinterface/rts/ExternalAI/GroupHandler.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/GroupHandler.cpp	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/rts/ExternalAI/GroupHandler.cpp	2008-11-12 21:22:55 UTC (rev 7024)
@@ -63,32 +63,26 @@
 
 void CGroupHandler::Load(std::istream *s)
 {
-/*
 	for(std::vector&lt;CGroup*&gt;::iterator ai=groups.begin();ai!=groups.end();++ai)
 		if((*ai)&amp;&amp;((*ai)-&gt;ai)) {
 			(*ai)-&gt;ai-&gt;Load((IGroupAICallback*)(*ai)-&gt;callback,s);
 		}
-*/
 }
 
 void CGroupHandler::Save(std::ostream *s)
 {
-/*
 	for(std::vector&lt;CGroup*&gt;::iterator ai=groups.begin();ai!=groups.end();++ai)
 		if((*ai)&amp;&amp;((*ai)-&gt;ai)) {
 			(*ai)-&gt;ai-&gt;Save(s);
 		}
-*/
 }
 
 void CGroupHandler::Update()
 {
 	SCOPED_TIMER(&quot;Group AI&quot;);
-/*
 	for(std::vector&lt;CGroup*&gt;::iterator ai=groups.begin();ai!=groups.end();++ai)
 		if((*ai)!=0)
 			(*ai)-&gt;Update();
-*/
 }
 
 void CGroupHandler::DrawCommands()
@@ -125,13 +119,11 @@
 
 	int i=GetGroupAiVersion();
 
-/*
 	if (i!=AI_INTERFACE_VERSION){
 		logOutput.Print(&quot;AI dll %s has incorrect version&quot;, name.c_str());
 		delete lib;
 		return;
 	}
-*/
 
 	IsUnitSuited = (ISUNITSUITED)lib-&gt;FindAddress(&quot;IsUnitSuited&quot;);
 	if (!IsUnitSuited){

Modified: branches/caiinterface/rts/ExternalAI/GroupHandler.h
===================================================================
--- branches/caiinterface/rts/ExternalAI/GroupHandler.h	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/rts/ExternalAI/GroupHandler.h	2008-11-12 21:22:55 UTC (rev 7024)
@@ -10,11 +10,11 @@
 #include &lt;string&gt;
 #include &lt;vector&gt;
 #include &lt;set&gt;
-//#include &quot;ExternalAI/aikey.h&quot;
+#include &quot;ExternalAI/aikey.h&quot;
 #include &quot;Game/GlobalConstants.h&quot;
 
 class CGroup;
-//class CUnitSet;
+class CUnitSet;
 
 /**
  * Handles All Groups of a single team.
@@ -32,9 +32,9 @@
 	 * This function initialized a singleton instance,
 	 * if not yet done by a call to GetInstance()
 	 */
-	static void Initialize(int teamId);
-	static CGroupHandler* GetInstance(int teamId);
-	static void Destroy(int teamId);
+//	static void Initialize(int teamId);
+//	static CGroupHandler* GetInstance(int teamId);
+//	static void Destroy(int teamId);
 
 	void PostLoad();
 
@@ -42,29 +42,30 @@
 	void DrawCommands();
 	void GroupCommand(int num);
 	void GroupCommand(int num, const std::string&amp; cmd);
-//	CGroup* CreateNewGroup(AIKey aiKey);
+	CGroup* CreateNewGroup(AIKey aiKey);
 	void RemoveGroup(CGroup* group);
 	void Load(std::istream *s);
 	void Save(std::ostream *s);
 
-//	std::map&lt;AIKey, std::string&gt; availableAI;
+	std::vector&lt;CGroup*&gt; groups;
+	std::map&lt;AIKey, std::string&gt; availableAI;
 
-//	std::map&lt;AIKey, std::string&gt; GetSuitedAis(const CUnitSet&amp; units);
-//	std::map&lt;AIKey, std::string&gt; lastSuitedAis;
+	std::map&lt;AIKey, std::string&gt; GetSuitedAis(const CUnitSet&amp; units);
+	std::map&lt;AIKey, std::string&gt; lastSuitedAis;
 
+	int team;
 protected:
-	int teamId;
-	std::vector&lt;CGroup*&gt; groups;
-//	void FindDlls(void);
-//	void TestDll(std::string name);
+//	std::vector&lt;CGroup*&gt; groups;
+	void FindDlls(void);
+	void TestDll(std::string name);
 
 	std::vector&lt;int&gt; freeGroups;
 	int firstUnusedGroup;
 private:
-//	AIKey defaultKey;
+	AIKey defaultKey;
 };
 
 //extern CGroupHandler* grouphandler;
-//extern CGroupHandler* grouphandlers[MAX_TEAMS];
+extern CGroupHandler* grouphandlers[MAX_TEAMS];
 
 #endif	// _GROUPHANDLER_H

Modified: branches/caiinterface/rts/ExternalAI/IGroupAI.h
===================================================================
--- branches/caiinterface/rts/ExternalAI/IGroupAI.h	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/rts/ExternalAI/IGroupAI.h	2008-11-12 21:22:55 UTC (rev 7024)
@@ -1,30 +1,36 @@
-/*
-	Copyright (c) 2008 Robin Vobruba &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">hoijui.quaero at gmail.com</A>&gt;
+#ifndef IGROUPAI_H
+#define IGROUPAI_H
+// IGroupAI.h: interface for the IGroupAI class.
+// Dont modify this file
+//////////////////////////////////////////////////////////////////////
 
-	This program is free software {} you can redistribute it and/or modify
-	it under the terms of the GNU General Public License as published by
-	the Free Software Foundation {} either version 2 of the License, or
-	(at your option) any later version.
+#include &quot;aibase.h&quot;
+#include &quot;Sim/Units/CommandAI/Command.h&quot;
 
-	This program is distributed in the hope that it will be useful,
-	but WITHOUT ANY WARRANTY {} without even the implied warranty of
-	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-	GNU General Public License for more details.
+class IGroupAICallback;
+class IAICallback;
 
-	You should have received a copy of the GNU General Public License
-	along with this program.  If not, see &lt;<A HREF="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</A>&gt;.
-*/
+#define AI_INTERFACE_VERSION (14 + AI_INTERFACE_GENERATED_VERSION)
 
-#ifndef	_IGROUPAI_H
-#define	_IGROUPAI_H
+class SPRING_API IGroupAI
+{
+public:
+	virtual void InitAi(IGroupAICallback* callback)=0;
+	virtual bool AddUnit(int unit)=0;									//group should return false if it doenst want the unit for some reason
+	virtual void RemoveUnit(int unit)=0;								//no way to refuse giving up a unit
 
-class IGroupAI {
-public:
-	/**
-	 * Inherited form IGroupAILibrary.
-	 * CAUTION: takes C AI Interface events, not engine C++ ones!
-	 */
-	virtual int HandleEvent(int topic, const void* data) const = 0;
+	virtual void GiveCommand(Command* c)=0;								//the group is given a command by the player
+	virtual const std::vector&lt;CommandDescription&gt;&amp; GetPossibleCommands()=0;	//the ai tells the interface what commands it can take (note that it returns a reference so it must keep the vector in memory itself)
+	virtual int GetDefaultCmd(int unitid)=0;							//the default command for the ai given that the mouse pointer hovers above unit unitid (or no unit if unitid=0)
+
+	virtual void CommandFinished(int unit,int type)=0;					//a specific unit has finished a specific command, might be a good idea to give new orders to it
+
+	virtual void Update()=0;											//called once a frame (30 times a second)
+	virtual void DrawCommands()=0;										//the place to use the LineDrawer interface functions
+	virtual void Load(IGroupAICallback* callback,std::istream *s){};	//load ai from file
+	virtual void Save(std::ostream *s){};							//save ai to file
+
+	DECLARE_PURE_VIRTUAL(~IGroupAI())
 };
 
-#endif	// _IGROUPAI_H
+#endif /* IGROUPAI_H */

Modified: branches/caiinterface/rts/ExternalAI/IGroupAILibrary.h
===================================================================
--- branches/caiinterface/rts/ExternalAI/IGroupAILibrary.h	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/rts/ExternalAI/IGroupAILibrary.h	2008-11-12 21:22:55 UTC (rev 7024)
@@ -45,8 +45,7 @@
 //	virtual std::vector&lt;Option&gt; GetOptions() const = 0;
 	
 	
-    virtual void Init(int teamId, int groupId, const InfoItem info[],
-			unsigned int numInfoItems) const = 0;
+    virtual void Init(int teamId, int groupId) const = 0;
     virtual void Release(int teamId, int groupId) const = 0;
     virtual int HandleEvent(int teamId, int groupId, int topic, const void* data) const = 0;
 };

Modified: branches/caiinterface/rts/ExternalAI/Interface/AISEvents.h
===================================================================
--- branches/caiinterface/rts/ExternalAI/Interface/AISEvents.h	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/rts/ExternalAI/Interface/AISEvents.h	2008-11-12 21:22:55 UTC (rev 7024)
@@ -33,30 +33,31 @@
 #include &quot;SAICallback.h&quot;
 
 enum EventTopic {
-	EVENT_NULL                  =  0,
-	EVENT_INIT                  =  1,
-	EVENT_RELEASE               =  2,
-	EVENT_UPDATE                =  3,
-	EVENT_MESSAGE               =  4,
-	EVENT_UNIT_CREATED          =  5,
-	EVENT_UNIT_FINISHED         =  6,
-	EVENT_UNIT_IDLE             =  7,
-	EVENT_UNIT_MOVE_FAILED      =  8,
-	EVENT_UNIT_DAMAGED          =  9,
-	EVENT_UNIT_DESTROYED        = 10,
-	EVENT_UNIT_GIVEN            = 11,
-	EVENT_UNIT_CAPTURED         = 12,
-	EVENT_ENEMY_ENTER_LOS       = 13,
-	EVENT_ENEMY_LEAVE_LOS       = 14,
-	EVENT_ENEMY_ENTER_RADAR     = 15,
-	EVENT_ENEMY_LEAVE_RADAR     = 16,
-	EVENT_ENEMY_DAMAGED         = 17,
-	EVENT_ENEMY_DESTROYED       = 18,
-	EVENT_WEAPON_FIRED          = 19,
-	EVENT_PLAYER_COMMAND        = 20,
-	EVENT_SEISMIC_PING          = 21,
+	EVENT_NULL                         =  0,
+	EVENT_INIT                         =  1,
+	EVENT_RELEASE                      =  2,
+	EVENT_UPDATE                       =  3,
+	EVENT_MESSAGE                      =  4,
+	EVENT_UNIT_CREATED                 =  5,
+	EVENT_UNIT_FINISHED                =  6,
+	EVENT_UNIT_IDLE                    =  7,
+	EVENT_UNIT_MOVE_FAILED             =  8,
+	EVENT_UNIT_DAMAGED                 =  9,
+	EVENT_UNIT_DESTROYED               = 10,
+	EVENT_UNIT_GIVEN                   = 11,
+	EVENT_UNIT_CAPTURED                = 12,
+	EVENT_ENEMY_ENTER_LOS              = 13,
+	EVENT_ENEMY_LEAVE_LOS              = 14,
+	EVENT_ENEMY_ENTER_RADAR            = 15,
+	EVENT_ENEMY_LEAVE_RADAR            = 16,
+	EVENT_ENEMY_DAMAGED                = 17,
+	EVENT_ENEMY_DESTROYED              = 18,
+	EVENT_WEAPON_FIRED                 = 19,
+	EVENT_PLAYER_COMMAND               = 20,
+	EVENT_SEISMIC_PING                 = 21,
+	EVENT_COMMAND_FINISHED             = 22,
 };
-const unsigned int NUM_EVENTS   = 22;
+const unsigned int NUM_EVENTS          = 23;
 
 
 struct SInitEvent {
@@ -161,6 +162,11 @@
 	int playerId;
 }; // EVENT_PLAYER_COMMAND
 
+struct SCommandFinishedEvent {
+	int unitId;
+	int commandTopicId;
+}; // EVENT_COMMAND_FINISHED
+
 struct SSeismicPingEvent {
 	struct SAIFloat3 pos;
 	float strength;

Modified: branches/caiinterface/rts/ExternalAI/Interface/SAICallback.h
===================================================================
--- branches/caiinterface/rts/ExternalAI/Interface/SAICallback.h	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/rts/ExternalAI/Interface/SAICallback.h	2008-11-12 21:22:55 UTC (rev 7024)
@@ -365,7 +365,7 @@
 int (CALLING_CONV *Unit_STATIC_getNeutrals)(int teamId, int unitIds[]);
 int (CALLING_CONV *Unit_STATIC_getNeutralsIn)(int teamId, int unitIds[], struct SAIFloat3 pos, float radius);
 int (CALLING_CONV *Unit_STATIC_getSelected)(int teamId, int unitIds[]);
-int (CALLING_CONV *Unit_STATIC_updateSelectedUnitsIcons)(int teamId);
+void (CALLING_CONV *Unit_STATIC_updateSelectedUnitsIcons)(int teamId);
 
 int (CALLING_CONV *Unit_getDefId)(int teamId, int unitId);
 int (CALLING_CONV *Unit_getAiHint)(int teamId, int unitId);

Modified: branches/caiinterface/rts/ExternalAI/SAICallback.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/SAICallback.cpp	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/rts/ExternalAI/SAICallback.cpp	2008-11-12 21:22:55 UTC (rev 7024)
@@ -21,6 +21,8 @@
 #include &quot;IAICallback.h&quot;
 #include &quot;IAICheats.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
+#include &quot;Sim/Units/UnitHandler.h&quot;
+#include &quot;Sim/Units/CommandAI/CommandAI.h&quot;
 #include &quot;Sim/MoveTypes/MoveInfo.h&quot;
 #include &quot;Sim/Features/FeatureDef.h&quot;
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
@@ -75,11 +77,12 @@
 
 static bool isControlledByLocalPlayer(int teamId) {
 	//TODO
-	???
-		gs-&gt;players[i]-&gt;...;
-	bool gs-&gt;Team(teamId)-&gt;gaia;
-	bool gs-&gt;Team(teamId)-&gt;isAI;
-	bool gs-&gt;players[0]-&gt;;
+	//???
+	//bool gs-&gt;players[i]-&gt;CanControlTeam(int teamID);
+	//bool gs-&gt;Team(teamId)-&gt;gaia;
+	//bool gs-&gt;Team(teamId)-&gt;isAI;
+	//bool gs-&gt;players[0]-&gt;;
+	return true;
 }
 
 static const UnitDef* getUnitDefById(int teamId, int unitDefId) {
@@ -3186,22 +3189,17 @@
 	sAICallback-&gt;Game_getMyAllyTeam = _Game_getMyAllyTeam;
 	sAICallback-&gt;Game_getPlayerTeam = _Game_getPlayerTeam;
 	sAICallback-&gt;Game_getTeamSide = _Game_getTeamSide;
-	sAICallback-&gt;WeaponDef_STATIC_getNumDamageTypes = _WeaponDef_STATIC_getNumDamageTypes;
-	sAICallback-&gt;Map_getChecksum = _Map_getChecksum;
 	sAICallback-&gt;Game_isExceptionHandlingEnabled = _Game_isExceptionHandlingEnabled;
 	sAICallback-&gt;Game_isDebugModeEnabled = _Game_isDebugModeEnabled;
 	sAICallback-&gt;Game_getMode = _Game_getMode;
 	sAICallback-&gt;Game_isPaused = _Game_isPaused;
 	sAICallback-&gt;Game_getSpeedFactor = _Game_getSpeedFactor;
+	sAICallback-&gt;Game_getSetupScript = _Game_getSetupScript;
 	sAICallback-&gt;Gui_getViewRange = _Gui_getViewRange;
 	sAICallback-&gt;Gui_getScreenX = _Gui_getScreenX;
 	sAICallback-&gt;Gui_getScreenY = _Gui_getScreenY;
 	sAICallback-&gt;Gui_Camera_getDirection = _Gui_Camera_getDirection;
 	sAICallback-&gt;Gui_Camera_getPosition = _Gui_Camera_getPosition;
-	sAICallback-&gt;File_locateForReading = _File_locateForReading;
-	sAICallback-&gt;File_locateForWriting = _File_locateForWriting;
-	sAICallback-&gt;Unit_STATIC_getLimit = _Unit_STATIC_getLimit;
-	sAICallback-&gt;Game_getSetupScript = _Game_getSetupScript;
 	sAICallback-&gt;Cheats_isEnabled = _Cheats_isEnabled;
 	sAICallback-&gt;Cheats_setEnabled = _Cheats_setEnabled;
 	sAICallback-&gt;Cheats_setEventsEnabled = _Cheats_setEventsEnabled;
@@ -3216,6 +3214,8 @@
 	sAICallback-&gt;ResourceInfo_Energy_getStorage = _ResourceInfo_Energy_getStorage;
 	sAICallback-&gt;File_getSize = _File_getSize;
 	sAICallback-&gt;File_getContent = _File_getContent;
+	sAICallback-&gt;File_locateForReading = _File_locateForReading;
+	sAICallback-&gt;File_locateForWriting = _File_locateForWriting;
 	sAICallback-&gt;UnitDef_STATIC_getIds = _UnitDef_STATIC_getIds;
 	sAICallback-&gt;UnitDef_STATIC_getNumIds = _UnitDef_STATIC_getNumIds;
 	sAICallback-&gt;UnitDef_STATIC_getIdByName = _UnitDef_STATIC_getIdByName;
@@ -3428,7 +3428,6 @@
 	sAICallback-&gt;UnitDef_getNumBuildOptions = _UnitDef_getNumBuildOptions;
 	sAICallback-&gt;UnitDef_getBuildOptions = _UnitDef_getBuildOptions;
 	sAICallback-&gt;UnitDef_getNumCustomParams = _UnitDef_getNumCustomParams;
-//	sAICallback-&gt;UnitDef_getCustomParams = _UnitDef_getCustomParams;
 	sAICallback-&gt;UnitDef_getCustomParamKeys = _UnitDef_getCustomParamKeys;
 	sAICallback-&gt;UnitDef_getCustomParamValues = _UnitDef_getCustomParamValues;
 	sAICallback-&gt;UnitDef_hasMoveData = _UnitDef_hasMoveData;
@@ -3455,6 +3454,7 @@
 	sAICallback-&gt;UnitDef_UnitDefWeapon_getFuelUsage = _UnitDef_UnitDefWeapon_getFuelUsage;
 	sAICallback-&gt;UnitDef_UnitDefWeapon_getBadTargetCat = _UnitDef_UnitDefWeapon_getBadTargetCat;
 	sAICallback-&gt;UnitDef_UnitDefWeapon_getOnlyTargetCat = _UnitDef_UnitDefWeapon_getOnlyTargetCat;
+	sAICallback-&gt;Unit_STATIC_getLimit = _Unit_STATIC_getLimit;
 	sAICallback-&gt;Unit_STATIC_getEnemies = _Unit_STATIC_getEnemies;
 	sAICallback-&gt;Unit_STATIC_getEnemiesIn = _Unit_STATIC_getEnemiesIn;
 	sAICallback-&gt;Unit_STATIC_getEnemiesInRadarAndLos = _Unit_STATIC_getEnemiesInRadarAndLos;
@@ -3463,6 +3463,7 @@
 	sAICallback-&gt;Unit_STATIC_getNeutrals = _Unit_STATIC_getNeutrals;
 	sAICallback-&gt;Unit_STATIC_getNeutralsIn = _Unit_STATIC_getNeutralsIn;
 	sAICallback-&gt;Unit_STATIC_getSelected = _Unit_STATIC_getSelected;
+	sAICallback-&gt;Unit_STATIC_updateSelectedUnitsIcons = _Unit_STATIC_updateSelectedUnitsIcons;
 	sAICallback-&gt;Unit_getDefId = _Unit_getDefId;
 	sAICallback-&gt;Unit_getAiHint = _Unit_getAiHint;
 	sAICallback-&gt;Unit_getTeam = _Unit_getTeam;
@@ -3505,6 +3506,7 @@
 	sAICallback-&gt;Unit_isParalyzed = _Unit_isParalyzed;
 	sAICallback-&gt;Unit_isNeutral = _Unit_isNeutral;
 	sAICallback-&gt;Unit_getBuildingFacing = _Unit_getBuildingFacing;
+	sAICallback-&gt;Unit_getLastUserOrderFrame = _Unit_getLastUserOrderFrame;
 	sAICallback-&gt;Group_getNumSupportedCommands = _Group_getNumSupportedCommands;
 	sAICallback-&gt;Group_SupportedCommands_getId = _Group_SupportedCommands_getId;
 	sAICallback-&gt;Group_SupportedCommands_getName = _Group_SupportedCommands_getName;
@@ -3513,7 +3515,14 @@
 	sAICallback-&gt;Group_SupportedCommands_isDisabled = _Group_SupportedCommands_isDisabled;
 	sAICallback-&gt;Group_SupportedCommands_getNumParams = _Group_SupportedCommands_getNumParams;
 	sAICallback-&gt;Group_SupportedCommands_getParams = _Group_SupportedCommands_getParams;
+	sAICallback-&gt;Group_OrderPreview_getId = _Group_OrderPreview_getId;
+	sAICallback-&gt;Group_OrderPreview_getOptions = _Group_OrderPreview_getOptions;
+	sAICallback-&gt;Group_OrderPreview_getTag = _Group_OrderPreview_getTag;
+	sAICallback-&gt;Group_OrderPreview_getTimeOut = _Group_OrderPreview_getTimeOut;
+	sAICallback-&gt;Group_OrderPreview_getParams = _Group_OrderPreview_getParams;
+	sAICallback-&gt;Group_isSelected = _Group_isSelected;
 	sAICallback-&gt;Mod_getName = _Mod_getName;
+	sAICallback-&gt;Map_getChecksum = _Map_getChecksum;
 	sAICallback-&gt;Map_getStartPos = _Map_getStartPos;
 	sAICallback-&gt;Map_getMousePos = _Map_getMousePos;
 	sAICallback-&gt;Map_isPosInCamera = _Map_isPosInCamera;
@@ -3569,7 +3578,6 @@
 	sAICallback-&gt;FeatureDef_getXsize = _FeatureDef_getXsize;
 	sAICallback-&gt;FeatureDef_getYsize = _FeatureDef_getYsize;
 	sAICallback-&gt;FeatureDef_getNumCustomParams = _FeatureDef_getNumCustomParams;
-//	sAICallback-&gt;FeatureDef_getCustomParams = _FeatureDef_getCustomParams;
 	sAICallback-&gt;FeatureDef_getCustomParamKeys = _FeatureDef_getCustomParamKeys;
 	sAICallback-&gt;FeatureDef_getCustomParamValues = _FeatureDef_getCustomParamValues;
 	sAICallback-&gt;Feature_STATIC_getIds = _Feature_STATIC_getIds;
@@ -3579,6 +3587,7 @@
 	sAICallback-&gt;Feature_getReclaimLeft = _Feature_getReclaimLeft;
 	sAICallback-&gt;Feature_getPos = _Feature_getPos;
 	sAICallback-&gt;WeaponDef_STATIC_getIdByName = _WeaponDef_STATIC_getIdByName;
+	sAICallback-&gt;WeaponDef_STATIC_getNumDamageTypes = _WeaponDef_STATIC_getNumDamageTypes;
 	sAICallback-&gt;WeaponDef_getName = _WeaponDef_getName;
 	sAICallback-&gt;WeaponDef_getType = _WeaponDef_getType;
 	sAICallback-&gt;WeaponDef_getDescription = _WeaponDef_getDescription;
@@ -3707,17 +3716,8 @@
 	sAICallback-&gt;WeaponDef_getDynDamageRange = _WeaponDef_getDynDamageRange;
 	sAICallback-&gt;WeaponDef_isDynDamageInverted = _WeaponDef_isDynDamageInverted;
 	sAICallback-&gt;WeaponDef_getNumCustomParams = _WeaponDef_getNumCustomParams;
-//	sAICallback-&gt;WeaponDef_getCustomParams = _WeaponDef_getCustomParams;
 	sAICallback-&gt;WeaponDef_getCustomParamKeys = _WeaponDef_getCustomParamKeys;
 	sAICallback-&gt;WeaponDef_getCustomParamValues = _WeaponDef_getCustomParamValues;
-	sAICallback-&gt;Unit_STATIC_updateSelectedUnitsIcons = _Unit_STATIC_updateSelectedUnitsIcons;
-	sAICallback-&gt;Group_OrderPreview_getId = _Group_OrderPreview_getId;
-	sAICallback-&gt;Group_OrderPreview_getOptions = _Group_OrderPreview_getOptions;
-	sAICallback-&gt;Group_OrderPreview_getTag = _Group_OrderPreview_getTag;
-	sAICallback-&gt;Group_OrderPreview_getTimeOut = _Group_OrderPreview_getTimeOut;
-	sAICallback-&gt;Group_OrderPreview_getParams = _Group_OrderPreview_getParams;
-	sAICallback-&gt;Group_isSelected = _Group_isSelected;
-	sAICallback-&gt;Unit_getLastUserOrderFrame = _Unit_getLastUserOrderFrame;
 	
 	team_globalCallback[teamId] = aiGlobalCallback;
 //	team_callback[teamId] = aiCallback;

Modified: branches/caiinterface/rts/ExternalAI/SkirmishAI.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/SkirmishAI.cpp	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/rts/ExternalAI/SkirmishAI.cpp	2008-11-12 21:22:55 UTC (rev 7024)
@@ -21,9 +21,9 @@
 #include &quot;ISkirmishAILibrary.h&quot;
 
 CSkirmishAI::CSkirmishAI(int teamId, const SSAIKey&amp; key)
-		: teamId(teamId), skirmishAIKey(skirmishAIKey) {
+		: teamId(teamId), key(key) {
 
-	library = IAILibraryManager::GetInstance()-&gt;FetchSkirmishAILibrary(skirmishAIKey);
+	library = IAILibraryManager::GetInstance()-&gt;FetchSkirmishAILibrary(key);
 	library-&gt;Init(teamId);
 }
 

Modified: branches/caiinterface/rts/ExternalAI/SkirmishAI.h
===================================================================
--- branches/caiinterface/rts/ExternalAI/SkirmishAI.h	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/rts/ExternalAI/SkirmishAI.h	2008-11-12 21:22:55 UTC (rev 7024)
@@ -33,8 +33,8 @@
 
 private:
 	int teamId;
-	const SSAIKey skirmishAIKey;
-	const ISkirmishAILibrary* skirmishAILibrary;
+	const SSAIKey key;
+	const ISkirmishAILibrary* library;
 };
 
 #endif	// _SKIRMISHAI_H

Modified: branches/caiinterface/rts/ExternalAI/SkirmishAILibrary.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/SkirmishAILibrary.cpp	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/rts/ExternalAI/SkirmishAILibrary.cpp	2008-11-12 21:22:55 UTC (rev 7024)
@@ -24,8 +24,8 @@
 CSkirmishAILibrary::CSkirmishAILibrary(const SSAILibrary&amp; ai,
 		const SSAISpecifier&amp; specifier,
 		const InfoItem info[], unsigned int numInfoItems)
-		: sSAI(ai), specifier(specifier), info(info),
-		numInfoItems(numInfoItems) {}
+		: sSAI(ai), specifier(specifier),
+		info(info), numInfoItems(numInfoItems) {}
 
 CSkirmishAILibrary::~CSkirmishAILibrary() {}
 	

Modified: branches/caiinterface/rts/ExternalAI/SkirmishAIWrapper.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/SkirmishAIWrapper.cpp	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/rts/ExternalAI/SkirmishAIWrapper.cpp	2008-11-12 21:22:55 UTC (rev 7024)
@@ -22,7 +22,8 @@
 #include &quot;IGlobalAI.h&quot;
 #include &quot;SkirmishAI.h&quot;
 #include &quot;GlobalAICallback.h&quot;
-#include &quot;GlobalAIHandler.h&quot;
+#include &quot;EngineOutHandler.h&quot;
+#include &quot;IAILibraryManager.h&quot;
 #include &quot;Platform/FileSystem.h&quot;
 #include &quot;Platform/errorhandler.h&quot;
 #include &quot;Platform/SharedLib.h&quot;
@@ -52,26 +53,24 @@
 	CR_POSTLOAD(PostLoad)
 ));
 
-void AIException(const char *what);
-
-#define HANDLE_EXCEPTION					\
-	catch (const std::exception&amp; e) {		\
-		if (globalAI-&gt;CatchException()) {	\
-			AIException(e.what());			\
-			throw;							\
-		} else throw;						\
-	}										\
-	catch (const char *s) {	\
-		if (globalAI-&gt;CatchException()) {	\
-			AIException(s);					\
-			throw;							\
-		} else throw;						\
-	}										\
-	catch (...) {							\
-		if (globalAI-&gt;CatchException()) {	\
-			AIException(0);					\
-			throw;							\
-		} else throw;						\
+#define HANDLE_EXCEPTION								\
+	catch (const std::exception&amp; e) {					\
+		if (CEngineOutHandler::IsCatchExceptions()) {	\
+			handleAIException(e.what());				\
+			throw;										\
+		} else throw;									\
+	}													\
+	catch (const char *s) {								\
+		if (CEngineOutHandler::IsCatchExceptions()) {	\
+			handleAIException(s);						\
+			throw;										\
+		} else throw;									\
+	}													\
+	catch (...) {										\
+		if (CEngineOutHandler::IsCatchExceptions()) {	\
+			handleAIException(0);						\
+			throw;										\
+		} else throw;									\
 	}
 
 
@@ -336,6 +335,12 @@
 	ai-&gt;HandleEvent(EVENT_PLAYER_COMMAND, &amp;evtData);
 }
 
+void CSkirmishAIWrapper::CommandFinished(int unitId, int commandTopicId) {
+
+	SCommandFinishedEvent evtData = {unitId, commandTopicId};
+	ai-&gt;HandleEvent(EVENT_COMMAND_FINISHED, &amp;evtData);
+}
+
 void CSkirmishAIWrapper::SeismicPing(int allyTeam, int unitId,
 		const float3&amp; pos, float strength) {
 

Modified: branches/caiinterface/rts/ExternalAI/SkirmishAIWrapper.h
===================================================================
--- branches/caiinterface/rts/ExternalAI/SkirmishAIWrapper.h	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/rts/ExternalAI/SkirmishAIWrapper.h	2008-11-12 21:22:55 UTC (rev 7024)
@@ -65,6 +65,7 @@
 	virtual void GotChatMsg(const char* msg, int fromPlayerId);
 	virtual void WeaponFired(int unitId, int weaponDefId);
 	virtual void PlayerCommandGiven(const std::vector&lt;int&gt;&amp; selectedUnits, const Command&amp; c, int playerId);
+	virtual void CommandFinished(int unitId, int commandTopicId);
 	virtual void SeismicPing(int allyTeam, int unitId, const float3&amp; pos, float strength);
 
 

Modified: branches/caiinterface/rts/ExternalAI/aikey.h
===================================================================
--- branches/caiinterface/rts/ExternalAI/aikey.h	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/rts/ExternalAI/aikey.h	2008-11-12 21:22:55 UTC (rev 7024)
@@ -1,47 +1,45 @@
-//#ifndef AIKEY_H
-//#define AIKEY_H
-//// aikey.h: defines the AIKey data type, a pair of (dllName, aiNumber)
-//// which allows multiple AIs to exist within a single DLL. An instance
-//// of AIKey uniquely identifies a particular AI.
-////////////////////////////////////////////////////////////////////////
-//
-//#include &lt;string&gt;
-//
-//#include &quot;creg/creg.h&quot;
-//
-//struct AIKey
-//{
-//	CR_DECLARE_STRUCT(AIKey);
-//	std::string dllName;
-//	unsigned aiNumber;
-//
-//	AIKey(){}
-//	AIKey(std::string DllName,unsigned AiNumber)
-//	: dllName(DllName), aiNumber(AiNumber)
-//	{}
-//
-//	bool operator&lt;(const AIKey&amp;that) const
-//	{
-//		if(dllName==that.dllName){
-//			return aiNumber&lt;that.aiNumber;
-//		} else {
-//			return dllName&lt;that.dllName;
-//		}
-//	};
-//
-//	bool operator!=(const AIKey&amp;that) const
-//	{
-//		return ! ((* this) == that);
-//	};
-//
-//	bool operator==(const AIKey&amp;that) const
-//	{
-//		return (aiNumber==that.aiNumber)
-//			&amp;&amp; (dllName==that.dllName);
-//	};
-//
-//};
-//
-//
-//#endif // AIKEY_H
-//
+#ifndef AIKEY_H
+#define AIKEY_H
+// aikey.h: defines the AIKey data type, a pair of (dllName, aiNumber)
+// which allows multiple AIs to exist within a single DLL. An instance
+// of AIKey uniquely identifies a particular AI.
+//////////////////////////////////////////////////////////////////////
+
+#include &lt;string&gt;
+
+#include &quot;creg/creg.h&quot;
+
+struct AIKey
+{
+	CR_DECLARE_STRUCT(AIKey);
+	std::string dllName;
+	unsigned aiNumber;
+
+	AIKey(){}
+	AIKey(std::string DllName,unsigned AiNumber)
+	: dllName(DllName), aiNumber(AiNumber)
+	{}
+
+	bool operator&lt;(const AIKey&amp;that) const
+	{
+		if(dllName==that.dllName){
+			return aiNumber&lt;that.aiNumber;
+		} else {
+			return dllName&lt;that.dllName;
+		}
+	};
+
+	bool operator!=(const AIKey&amp;that) const
+	{
+		return ! ((* this) == that);
+	};
+
+	bool operator==(const AIKey&amp;that) const
+	{
+		return (aiNumber==that.aiNumber)
+			&amp;&amp; (dllName==that.dllName);
+	};
+
+};
+
+#endif // AIKEY_H

Modified: branches/caiinterface/rts/Game/Game.cpp
===================================================================
--- branches/caiinterface/rts/Game/Game.cpp	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/rts/Game/Game.cpp	2008-11-12 21:22:55 UTC (rev 7024)
@@ -440,7 +440,10 @@
 	keyBindings-&gt;Load(&quot;uikeys.txt&quot;);
 
 	water=CBaseWater::GetWater(NULL);
+	for(int a=0;a&lt;MAX_TEAMS;a++)
+		grouphandlers[a] = SAFE_NEW CGroupHandler(a);
 
+//	globalAI = SAFE_NEW CGlobalAIHandler();
 	CEngineOutHandler::Initialize();
 
 	CPlayer* p = gs-&gt;players[gu-&gt;myPlayerNum];
@@ -554,9 +557,15 @@
 
 	SafeDelete(gameServer);
 
+//	globalAI-&gt;PreDestroy ();
+//	SafeDelete(globalAI);
 	eoh-&gt;PreDestroy();
 	CEngineOutHandler::Destroy();
 
+	for(int a=0;a&lt;MAX_TEAMS;a++) {
+		SafeDelete(grouphandlers[a]);
+	}
+
 	SafeDelete(water);
 	SafeDelete(sky);
 	SafeDelete(resourceBar);
@@ -1113,7 +1122,6 @@
 			const int team = (t - '0');
 			do { c++; } while ((c[0] != 0) &amp;&amp; isspace(c[0]));
 			grouphandlers[gu-&gt;myTeam]-&gt;GroupCommand(team, c);
-			eoh-&gt;
 		}
 	}
 	else if (cmd == &quot;group0&quot;) {
@@ -3151,7 +3159,11 @@
 			sound-&gt;Update();
 		sound-&gt;NewFrame();
 		treeDrawer-&gt;Update();
+//		globalAI-&gt;Update();
 		eoh-&gt;Update();
+		for (int a = 0; a &lt; MAX_TEAMS; a++) {
+			grouphandlers[a]-&gt;Update();
+		}
 		profiler.Update();
 		unitDrawer-&gt;Update();
 #ifdef DIRECT_CONTROL_ALLOWED
@@ -4572,6 +4584,7 @@
 		}
 	}
 
+//	globalAI-&gt;GotChatMsg(msg.msg.c_str(), msg.fromPlayer);
 	eoh-&gt;GotChatMsg(msg.msg.c_str(), msg.fromPlayer);
 }
 

Modified: branches/caiinterface/rts/Game/GlobalConstants.h
===================================================================
--- branches/caiinterface/rts/Game/GlobalConstants.h	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/rts/Game/GlobalConstants.h	2008-11-12 21:22:55 UTC (rev 7024)
@@ -38,14 +38,6 @@
 const int MAX_TEAMS = 17;
 
 /**
- * @brief max groups
- *
- * Defines the maximum number of groups per team.
- * Normal groups go from 0 - 9, special groups are 10+.
- */
-const int MAX_GROUPS = 16;
-
-/**
  * @brief max players
  *
  * Defines the maximum number of players as 32

Modified: branches/caiinterface/rts/Game/SelectedUnits.cpp
===================================================================
--- branches/caiinterface/rts/Game/SelectedUnits.cpp	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/rts/Game/SelectedUnits.cpp	2008-11-12 21:22:55 UTC (rev 7024)
@@ -18,7 +18,7 @@
 #include &quot;Net/PackPacket.h&quot;
 #include &quot;ExternalAI/GroupHandler.h&quot;
 #include &quot;ExternalAI/Group.h&quot;
-#include &quot;ExternalAI/GlobalAIHandler.h&quot;
+#include &quot;ExternalAI/EngineOutHandler.h&quot;
 #include &quot;UI/CommandColors.h&quot;
 #include &quot;UI/GuiHandler.h&quot;
 #include &quot;UI/TooltipConsole.h&quot;
@@ -552,7 +552,7 @@
 	selectedUnitsAI.GiveCommandNet(c, playerID);
 
 	if (netSelected[playerID].size() &gt; 0) {
-		globalAI-&gt;PlayerCommandGiven(netSelected[playerID], c, playerID);
+		eoh-&gt;PlayerCommandGiven(netSelected[playerID], c, playerID);
 	}
 }
 

Modified: branches/caiinterface/rts/Game/StartScripts/CommanderScript.cpp
===================================================================
--- branches/caiinterface/rts/Game/StartScripts/CommanderScript.cpp	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/rts/Game/StartScripts/CommanderScript.cpp	2008-11-12 21:22:55 UTC (rev 7024)
@@ -6,7 +6,7 @@
 #include &quot;mmgr.h&quot;
 
 #include &quot;CommanderScript.h&quot;
-#include &quot;ExternalAI/GlobalAIHandler.h&quot;
+#include &quot;ExternalAI/EngineOutHandler.h&quot;
 #include &quot;ExternalAI/Interface/SAIInterfaceLibrary.h&quot;
 #include &quot;Game/Game.h&quot;
 #include &quot;Game/GameSetup.h&quot;
@@ -60,7 +60,7 @@
 		// create a Skirmish AI if required
 		if (!SSAIKey_Comparator::IsEmpty(team-&gt;skirmishAISpecifier) // is an AI specifyed?
 				&amp;&amp; (gu-&gt;myPlayerNum == team-&gt;leader)) {
-			globalAI-&gt;CreateSkirmishAI(a, team-&gt;skirmishAISpecifier, team-&gt;skirmishAIOptions);
+			eoh-&gt;CreateSkirmishAI(a, team-&gt;skirmishAISpecifier, team-&gt;skirmishAIOptions);
 		}
 
 		// get the team startup info

Modified: branches/caiinterface/rts/Game/StartScripts/SkirmishAITestScript.cpp
===================================================================
--- branches/caiinterface/rts/Game/StartScripts/SkirmishAITestScript.cpp	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/rts/Game/StartScripts/SkirmishAITestScript.cpp	2008-11-12 21:22:55 UTC (rev 7024)
@@ -4,7 +4,7 @@
 #include &lt;algorithm&gt;
 #include &lt;cctype&gt;
 #include &quot;System/StdAfx.h&quot;
-#include &quot;ExternalAI/GlobalAIHandler.h&quot;
+#include &quot;ExternalAI/EngineOutHandler.h&quot;
 #include &quot;Game/Team.h&quot;
 #include &quot;Lua/LuaParser.h&quot;
 #include &quot;Map/MapParser.h&quot;
@@ -24,11 +24,10 @@
 
 CSkirmishAITestScript::CSkirmishAITestScript(const SSAIKey&amp; key,
 		const std::map&lt;std::string, std::string&gt;&amp; options)
-		: CScript(std::string(&quot;GlobalAI test (&quot;)
+		: CScript(std::string(&quot;Skirmish AI test (&quot;)
 			+ std::string(key.ai.shortName) + std::string(&quot; v&quot;)
 			+ std::string(key.ai.version) + std::string(&quot;)&quot;)),
-		key(key),
-		options(options)
+		key(key), options(options)
 {
 	// make sure CSelectedUnits::AiOrder()
 	// still works without a setup script
@@ -39,14 +38,11 @@
 }
 
 
-CSkirmishAITestScript::~CSkirmishAITestScript(void)
-{
-}
+CSkirmishAITestScript::~CSkirmishAITestScript(void) {}
 
-
 void CSkirmishAITestScript::GameStart(void)
 {
-	globalAI-&gt;CreateSkirmishAI(1, key, options);
+	eoh-&gt;CreateSkirmishAI(1, key, options);
 
 	gs-&gt;Team(0)-&gt;energy        = 1000;
 	gs-&gt;Team(0)-&gt;energyStorage = 1000;

Modified: branches/caiinterface/rts/Game/Team.cpp
===================================================================
--- branches/caiinterface/rts/Game/Team.cpp	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/rts/Game/Team.cpp	2008-11-12 21:22:55 UTC (rev 7024)
@@ -17,7 +17,7 @@
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
-#include &quot;ExternalAI/GlobalAIHandler.h&quot;
+#include &quot;ExternalAI/EngineOutHandler.h&quot;
 #include &quot;System/EventHandler.h&quot;
 #include &quot;System/GlobalUnsynced.h&quot;
 #include &quot;creg/STL_List.h&quot;
@@ -269,8 +269,8 @@
 			gs-&gt;players[a]-&gt;StartSpectating();
 		}
 	}
-	if (globalAI-&gt;IsSkirmishAI(teamNum)) {
-		globalAI-&gt;DestroySkirmishAI(teamNum);
+	if (eoh-&gt;IsSkirmishAI(teamNum)) {
+		eoh-&gt;DestroySkirmishAI(teamNum);
 	}
 
 	CLuaUI::UpdateTeams();

Modified: branches/caiinterface/rts/Lua/LuaSyncedRead.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaSyncedRead.cpp	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/rts/Lua/LuaSyncedRead.cpp	2008-11-12 21:22:55 UTC (rev 7024)
@@ -19,7 +19,7 @@
 #include &quot;LuaPathFinder.h&quot;
 #include &quot;LuaRules.h&quot;
 #include &quot;LuaUtils.h&quot;
-#include &quot;ExternalAI/GlobalAIHandler.h&quot;
+#include &quot;ExternalAI/EngineOutHandler.h&quot;
 #include &quot;Sim/Units/CommandAI/Command.h&quot;
 #include &quot;Game/Game.h&quot;
 #include &quot;Game/GameSetup.h&quot;
@@ -1016,7 +1016,7 @@
 
 	bool isAiTeam = false;
 	if (!team-&gt;luaAI.empty() ||
-	    ((globalAI != NULL) &amp;&amp; globalAI-&gt;IsSkirmishAI(teamID))) {
+	    (eoh-&gt;IsSkirmishAI(teamID))) {
 		isAiTeam = true;
 	}
 

Modified: branches/caiinterface/rts/Lua/LuaUnsyncedCtrl.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaUnsyncedCtrl.cpp	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/rts/Lua/LuaUnsyncedCtrl.cpp	2008-11-12 21:22:55 UTC (rev 7024)
@@ -24,7 +24,6 @@
 #include &quot;LuaUtils.h&quot;
 #include &quot;LuaTextures.h&quot;
 
-#include &quot;ExternalAI/GlobalAIHandler.h&quot;
 #include &quot;ExternalAI/Group.h&quot;
 #include &quot;ExternalAI/GroupHandler.h&quot;
 #include &quot;Game/Camera.h&quot;
@@ -60,6 +59,7 @@
 
 #include &quot;System/FileSystem/FileHandler.h&quot;
 #include &quot;System/Platform/FileSystem.h&quot;
+#include &quot;System/Platform/ConfigHandler.h&quot;
 
 using namespace std;
 

Modified: branches/caiinterface/rts/Sim/MoveTypes/GroundMoveType.cpp
===================================================================
--- branches/caiinterface/rts/Sim/MoveTypes/GroundMoveType.cpp	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/rts/Sim/MoveTypes/GroundMoveType.cpp	2008-11-12 21:22:55 UTC (rev 7024)
@@ -2,7 +2,7 @@
 #include &quot;mmgr.h&quot;
 
 #include &quot;GroundMoveType.h&quot;
-#include &quot;ExternalAI/GlobalAIHandler.h&quot;
+#include &quot;ExternalAI/EngineOutHandler.h&quot;
 #include &quot;Game/Camera.h&quot;
 #include &quot;Game/Game.h&quot;
 #include &quot;Game/GameHelper.h&quot;
@@ -1402,7 +1402,7 @@
 	progressState = Failed;
 
 	eventHandler.UnitMoveFailed(owner);
-	globalAI-&gt;UnitMoveFailed(owner);
+	eoh-&gt;UnitMoveFailed(*owner);
 
 	// sends a message to user.
 	ENTER_UNSYNCED;

Modified: branches/caiinterface/rts/Sim/Units/CommandAI/CommandAI.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/CommandAI/CommandAI.cpp	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/rts/Sim/Units/CommandAI/CommandAI.cpp	2008-11-12 21:22:55 UTC (rev 7024)
@@ -4,7 +4,7 @@
 #include &quot;CommandAI.h&quot;
 #include &quot;FactoryCAI.h&quot;
 #include &quot;LineDrawer.h&quot;
-#include &quot;ExternalAI/GlobalAIHandler.h&quot;
+#include &quot;ExternalAI/EngineOutHandler.h&quot;
 #include &quot;ExternalAI/Group.h&quot;
 #include &quot;Game/GameHelper.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
@@ -737,7 +737,7 @@
 
 	if (commandQue.empty()) {
 		if (!owner-&gt;group) {
-			globalAI-&gt;UnitIdle(owner);
+			eoh-&gt;UnitIdle(*owner);
 		}
 		eventHandler.UnitIdle(owner);
 	}
@@ -1369,7 +1369,7 @@
 
 	if (commandQue.empty()) {
 		if (!owner-&gt;group) {
-			globalAI-&gt;UnitIdle(owner);
+			eoh-&gt;UnitIdle(*owner);
 		}
 		eventHandler.UnitIdle(owner);
 	}
@@ -1421,7 +1421,7 @@
 		&amp;&amp; (commandQue.front().id==CMD_ATTACK || commandQue.front().id==CMD_DGUN) &amp;&amp; inCommand)
 	{
 		owner-&gt;AttackUnit(0,true);
-		globalAI-&gt;WeaponFired(owner,weapon-&gt;weaponDef);
+		eoh-&gt;WeaponFired(*owner, *(weapon-&gt;weaponDef));
 		FinishCommand();
 	}
 }

Modified: branches/caiinterface/rts/Sim/Units/Unit.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/Unit.cpp	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/rts/Sim/Units/Unit.cpp	2008-11-12 21:22:55 UTC (rev 7024)
@@ -10,7 +10,7 @@
 #include &quot;CommandAI/CommandAI.h&quot;
 #include &quot;CommandAI/FactoryCAI.h&quot;
 #include &quot;creg/STL_List.h&quot;
-#include &quot;ExternalAI/GlobalAIHandler.h&quot;
+#include &quot;ExternalAI/EngineOutHandler.h&quot;
 #include &quot;ExternalAI/Group.h&quot;
 #include &quot;Game/Camera.h&quot;
 #include &quot;Game/GameHelper.h&quot;
@@ -601,20 +601,20 @@
 		if (diffBits &amp; LOS_INLOS) {
 			if (newStatus &amp; LOS_INLOS) {
 				eventHandler.UnitEnteredLos(this, at);
-				globalAI-&gt;UnitEnteredLos(this, at);
+				eoh-&gt;UnitEnteredLos(*this, at);
 			} else {
 				eventHandler.UnitLeftLos(this, at);
-				globalAI-&gt;UnitLeftLos(this, at);
+				eoh-&gt;UnitLeftLos(*this, at);
 			}
 		}
 
 		if (diffBits &amp; LOS_INRADAR) {
 			if (newStatus &amp; LOS_INRADAR) {
 				eventHandler.UnitEnteredRadar(this, at);
-				globalAI-&gt;UnitEnteredRadar(this, at);
+				eoh-&gt;UnitEnteredRadar(*this, at);
 			} else {
 				eventHandler.UnitLeftRadar(this, at);
-				globalAI-&gt;UnitLeftRadar(this, at);
+				eoh-&gt;UnitLeftRadar(*this, at);
 			}
 		}
 	}
@@ -1089,7 +1089,7 @@
 	}
 
 	eventHandler.UnitDamaged(this, attacker, damage, weaponId, !!damages.paralyzeDamageTime);
-	globalAI-&gt;UnitDamaged(this, attacker, damage);
+	eoh-&gt;UnitDamaged(*this, attacker, damage);
 
 	if (health &lt;= 0.0f) {
 		KillUnit(false, false, attacker);
@@ -1262,7 +1262,7 @@
 			                 errorScale[a] * (0.5f - rz));
 			const float3 pingPos = (pos + err);
 			eventHandler.UnitSeismicPing(this, a, pingPos, pingSize);
-			globalAI-&gt;SeismicPing(a, this, pingPos, pingSize);
+			eoh-&gt;SeismicPing(a, *this, pingPos, pingSize);
 		}
 	}
 }
@@ -1309,7 +1309,7 @@
 	SetGroup(0);
 
 	eventHandler.UnitTaken(this, newteam);
-	globalAI-&gt;UnitTaken(this, oldteam);
+	eoh-&gt;UnitCaptured(*this, oldteam);
 
 	// reset states and clear the queues
 	if (!gs-&gt;AlliedTeams(oldteam, newteam)) {
@@ -1380,7 +1380,7 @@
 	}
 
 	eventHandler.UnitGiven(this, oldteam);
-	globalAI-&gt;UnitGiven(this, oldteam);
+	eoh-&gt;UnitGiven(*this, oldteam);
 
 	return true;
 }
@@ -1617,7 +1617,7 @@
 	}
 
 	eventHandler.UnitCreated(this, builder);
-	globalAI-&gt;UnitCreated(this); // FIXME -- add builder?
+	eoh-&gt;UnitCreated(*this); // FIXME -- add builder?
 }
 
 
@@ -1844,7 +1844,7 @@
 	}
 
 	eventHandler.UnitFinished(this);
-	globalAI-&gt;UnitFinished(this);
+	eoh-&gt;UnitFinished(*this);
 
 	if (oldCloak != isCloaked) {
 		eventHandler.UnitCloaked(this); // do this after the UnitFinished call-in
@@ -1891,7 +1891,7 @@
 	deathSpeed = speed;
 
 	eventHandler.UnitDestroyed(this, attacker);
-	globalAI-&gt;UnitDestroyed(this, attacker);
+	eoh-&gt;UnitDestroyed(*this, attacker);
 
 	blockHeightChanges = false;
 	if (unitDef-&gt;isCommander) {

Modified: branches/caiinterface/rts/System/LoadSaveHandler.cpp
===================================================================
--- branches/caiinterface/rts/System/LoadSaveHandler.cpp	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/rts/System/LoadSaveHandler.cpp	2008-11-12 21:22:55 UTC (rev 7024)
@@ -2,7 +2,7 @@
 #include &lt;fstream&gt;
 #include &quot;mmgr.h&quot;
 
-#include &quot;ExternalAI/GlobalAIHandler.h&quot;
+#include &quot;ExternalAI/EngineOutHandler.h&quot;
 #include &quot;ExternalAI/GroupHandler.h&quot;
 #include &quot;LoadSaveHandler.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
@@ -108,7 +108,7 @@
 	s.SerializeObjectInstance(inMapDrawer,inMapDrawer-&gt;GetClass());
 	for (int a=0;a&lt;MAX_TEAMS;a++)
 		s.SerializeObjectInstance(grouphandlers[a], grouphandlers[a]-&gt;GetClass());
-	s.SerializeObjectInstance(globalAI, globalAI-&gt;GetClass());
+	s.SerializeObjectInstance(eoh, eoh-&gt;GetClass());
 	s.SerializeObjectInstance(&amp;CBuilderCAI::reclaimers,CBuilderCAI::reclaimers.GetClass());
 //	s.Serialize()
 }
@@ -150,7 +150,7 @@
 		int aistart = ofs.tellp();
 		for (int a=0;a&lt;MAX_TEAMS;a++)
 			grouphandlers[a]-&gt;Save(&amp;ofs);
-		globalAI-&gt;Save(&amp;ofs);
+		eoh-&gt;Save(&amp;ofs);
 		PrintSize(&quot;AIs&quot;,((int)ofs.tellp())-aistart);
 	} catch (content_error &amp;e) {
 		logOutput.Print(&quot;Save faild(content error): %s&quot;,e.what());
@@ -201,11 +201,11 @@
 	delete gsc; // only job of gsc is to collect gamestate data
 	for (int a=0;a&lt;MAX_TEAMS;a++)
 		grouphandlers[a]-&gt;Load(ifs);
-	globalAI-&gt;Load(ifs);
+	eoh-&gt;Load(ifs);
 	delete ifs;
 	for (int a=0;a&lt;MAX_TEAMS;a++) {//For old savegames
-		if (gs-&gt;Team(a)-&gt;isDead &amp;&amp; globalAI-&gt;IsSkirmishAI(a)) {
-			globalAI-&gt;DestroySkirmishAI(a);
+		if (gs-&gt;Team(a)-&gt;isDead &amp;&amp; eoh-&gt;IsSkirmishAI(a)) {
+			eoh-&gt;DestroySkirmishAI(a);
 		}
 	}
 	gs-&gt;paused = false;

Modified: branches/caiinterface/rts/System/Script/LuaFunctions.cpp
===================================================================
--- branches/caiinterface/rts/System/Script/LuaFunctions.cpp	2008-11-11 19:27:20 UTC (rev 7023)
+++ branches/caiinterface/rts/System/Script/LuaFunctions.cpp	2008-11-12 21:22:55 UTC (rev 7024)
@@ -8,7 +8,7 @@
 #include &quot;Game/GlobalSynced.h&quot;
 #include &quot;float3.h&quot;
 #include &quot;LogOutput.h&quot;
-#include &quot;ExternalAI/GlobalAIHandler.h&quot;
+#include &quot;ExternalAI/EngineOutHandler.h&quot;
 #include &quot;Sim/Units/CommandAI/Command.h&quot;
 #include &quot;Game/Game.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
@@ -46,7 +46,7 @@
 	void CreateSkirmishAI(int teamId, const SSAIKey&amp; key,
 			const std::map&lt;std::string, std::string&gt;&amp; options)
 	{
-			globalAI-&gt;CreateSkirmishAI(teamId, key, options);
+			eoh-&gt;CreateSkirmishAI(teamId, key, options);
 	}
 
 	void UnitGiveCommand(CObject_pointer&lt;CUnit&gt;* u, Command* c)


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001792.html">[Taspring-linux-commit] r7023 - trunk
</A></li>
	<LI>Next message: <A HREF="001794.html">[Taspring-linux-commit] r7025 - trunk/tools/DedicatedServer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1793">[ date ]</a>
              <a href="thread.html#1793">[ thread ]</a>
              <a href="subject.html#1793">[ subject ]</a>
              <a href="author.html#1793">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
