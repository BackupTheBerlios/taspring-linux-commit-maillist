<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r6975 - in branches/caiinterface:	AI/Interfaces Documentation installer/builddata/springcontent	rts/ExternalAI rts/ExternalAI/Interface	rts/ExternalAI/Interface/LegacyCppWrapper/Event rts/Game	rts/Game/Server rts/Game/StartScripts rts/Game/UI rts/Lua	rts/Rendering rts/Rendering/GL rts/Rendering/Textures	rts/Rendering/UnitModels	rts/Sim/Projectiles/WeaponProjectiles rts/Sim/Units/COB	rts/Sim/Weapons rts/System rts/System/Script	rts/build/vstudio8 rts/lib/gml tools/DedicatedServer
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-November/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6975%20-%20in%20branches/caiinterface%3A%0A%09AI/Interfaces%20Documentation%20installer/builddata/springcontent%0A%09rts/ExternalAI%20rts/ExternalAI/Interface%0A%09rts/ExternalAI/Interface/LegacyCppWrapper/Event%20rts/Game%0A%09rts/Game/Server%20rts/Game/StartScripts%20rts/Game/UI%20rts/Lua%0A%09rts/Rendering%20rts/Rendering/GL%20rts/Rendering/Textures%0A%09rts/Rendering/UnitModels%0A%09rts/Sim/Projectiles/WeaponProjectiles%20rts/Sim/Units/COB%0A%09rts/Sim/Weapons%20rts/System%20rts/System/Script%0A%09rts/build/vstudio8%20rts/lib/gml%20tools/DedicatedServer&In-Reply-To=%3C20081104095737.7BE5E4753%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001743.html">
   <LINK REL="Next"  HREF="001745.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r6975 - in branches/caiinterface:	AI/Interfaces Documentation installer/builddata/springcontent	rts/ExternalAI rts/ExternalAI/Interface	rts/ExternalAI/Interface/LegacyCppWrapper/Event rts/Game	rts/Game/Server rts/Game/StartScripts rts/Game/UI rts/Lua	rts/Rendering rts/Rendering/GL rts/Rendering/Textures	rts/Rendering/UnitModels	rts/Sim/Projectiles/WeaponProjectiles rts/Sim/Units/COB	rts/Sim/Weapons rts/System rts/System/Script	rts/build/vstudio8 rts/lib/gml tools/DedicatedServer</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6975%20-%20in%20branches/caiinterface%3A%0A%09AI/Interfaces%20Documentation%20installer/builddata/springcontent%0A%09rts/ExternalAI%20rts/ExternalAI/Interface%0A%09rts/ExternalAI/Interface/LegacyCppWrapper/Event%20rts/Game%0A%09rts/Game/Server%20rts/Game/StartScripts%20rts/Game/UI%20rts/Lua%0A%09rts/Rendering%20rts/Rendering/GL%20rts/Rendering/Textures%0A%09rts/Rendering/UnitModels%0A%09rts/Sim/Projectiles/WeaponProjectiles%20rts/Sim/Units/COB%0A%09rts/Sim/Weapons%20rts/System%20rts/System/Script%0A%09rts/build/vstudio8%20rts/lib/gml%20tools/DedicatedServer&In-Reply-To=%3C20081104095737.7BE5E4753%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r6975 - in branches/caiinterface:	AI/Interfaces Documentation installer/builddata/springcontent	rts/ExternalAI rts/ExternalAI/Interface	rts/ExternalAI/Interface/LegacyCppWrapper/Event rts/Game	rts/Game/Server rts/Game/StartScripts rts/Game/UI rts/Lua	rts/Rendering rts/Rendering/GL rts/Rendering/Textures	rts/Rendering/UnitModels	rts/Sim/Projectiles/WeaponProjectiles rts/Sim/Units/COB	rts/Sim/Weapons rts/System rts/System/Script	rts/build/vstudio8 rts/lib/gml tools/DedicatedServer">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Tue Nov  4 10:57:37 CET 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001743.html">[Taspring-linux-commit] r6974 - trunk/rts/Sim/Misc
</A></li>
        <LI>Next message: <A HREF="001745.html">[Taspring-linux-commit] r6976 - in branches/caiinterface: . AI	AI/Bindings AI/Bindings/LegacyCpp AI/Bindings/LegacyCpp/Event	AI/Skirmish/KAIK AI/Skirmish/NullLegacyCppAI AI/Skirmish/RAI	rts/ExternalAI/Interface rts/build/scons
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1744">[ date ]</a>
              <a href="thread.html#1744">[ thread ]</a>
              <a href="subject.html#1744">[ subject ]</a>
              <a href="author.html#1744">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: hoijui
Date: 2008-11-04 10:57:36 +0100 (Tue, 04 Nov 2008)
New Revision: 6975

Added:
   branches/caiinterface/rts/Game/StartScripts/SkirmishAITestScript.cpp
   branches/caiinterface/rts/Game/StartScripts/SkirmishAITestScript.h
Removed:
   branches/caiinterface/rts/Game/StartScripts/GlobalAITestScript.cpp
   branches/caiinterface/rts/Game/StartScripts/GlobalAITestScript.h
Modified:
   branches/caiinterface/AI/Interfaces/CMakeLists.txt
   branches/caiinterface/Documentation/Spring start.txt
   branches/caiinterface/installer/builddata/springcontent/EngineOptions.lua
   branches/caiinterface/rts/ExternalAI/AICallback.cpp
   branches/caiinterface/rts/ExternalAI/AILibraryManager.cpp
   branches/caiinterface/rts/ExternalAI/GlobalAIHandler.cpp
   branches/caiinterface/rts/ExternalAI/GlobalAIHandler.h
   branches/caiinterface/rts/ExternalAI/Interface/AISEvents.h
   branches/caiinterface/rts/ExternalAI/Interface/LegacyCppWrapper/Event/AIInitEvent.h
   branches/caiinterface/rts/ExternalAI/SkirmishAIWrapper.cpp
   branches/caiinterface/rts/ExternalAI/SkirmishAIWrapper.h
   branches/caiinterface/rts/Game/ConsoleHistory.cpp
   branches/caiinterface/rts/Game/Game.cpp
   branches/caiinterface/rts/Game/Game.h
   branches/caiinterface/rts/Game/GameController.cpp
   branches/caiinterface/rts/Game/GameController.h
   branches/caiinterface/rts/Game/GameData.cpp
   branches/caiinterface/rts/Game/GameData.h
   branches/caiinterface/rts/Game/GameHelper.h
   branches/caiinterface/rts/Game/GameServer.cpp
   branches/caiinterface/rts/Game/GameServer.h
   branches/caiinterface/rts/Game/GameSetup.cpp
   branches/caiinterface/rts/Game/GameSetup.h
   branches/caiinterface/rts/Game/GlobalSynced.cpp
   branches/caiinterface/rts/Game/PreGame.cpp
   branches/caiinterface/rts/Game/PreGame.h
   branches/caiinterface/rts/Game/SelectMenu.cpp
   branches/caiinterface/rts/Game/SelectMenu.h
   branches/caiinterface/rts/Game/Server/MsgStrings.h
   branches/caiinterface/rts/Game/StartScripts/CommanderScript.cpp
   branches/caiinterface/rts/Game/StartScripts/ScriptHandler.cpp
   branches/caiinterface/rts/Game/Team.cpp
   branches/caiinterface/rts/Game/Team.h
   branches/caiinterface/rts/Game/UI/GuiHandler.cpp
   branches/caiinterface/rts/Lua/LuaSyncedCtrl.cpp
   branches/caiinterface/rts/Rendering/GL/glList.h
   branches/caiinterface/rts/Rendering/GroundDecalHandler.cpp
   branches/caiinterface/rts/Rendering/GroundDecalHandler.h
   branches/caiinterface/rts/Rendering/Textures/TextureHandler.cpp
   branches/caiinterface/rts/Rendering/UnitModels/3DOParser.cpp
   branches/caiinterface/rts/Rendering/UnitModels/s3oParser.cpp
   branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/WeaponProjectile.cpp
   branches/caiinterface/rts/Sim/Units/COB/CobInstance.cpp
   branches/caiinterface/rts/Sim/Weapons/BeamLaser.cpp
   branches/caiinterface/rts/Sim/Weapons/LightingCannon.cpp
   branches/caiinterface/rts/System/DemoReader.cpp
   branches/caiinterface/rts/System/DemoRecorder.cpp
   branches/caiinterface/rts/System/DemoRecorder.h
   branches/caiinterface/rts/System/LogOutput.cpp
   branches/caiinterface/rts/System/NetProtocol.cpp
   branches/caiinterface/rts/System/NetProtocol.h
   branches/caiinterface/rts/System/Script/LuaFunctions.cpp
   branches/caiinterface/rts/System/Script/LuaFunctions.h
   branches/caiinterface/rts/System/SpringApp.cpp
   branches/caiinterface/rts/build/vstudio8/rts.vcproj
   branches/caiinterface/rts/lib/gml/gml.cpp
   branches/caiinterface/rts/lib/gml/gml.h
   branches/caiinterface/tools/DedicatedServer/main.cpp
Log:
* reintegrated trunk up to 6967
* added support for supplying options to skirmish AIs (see Documentation/Spring start.txt for details)

Modified: branches/caiinterface/AI/Interfaces/CMakeLists.txt
===================================================================
--- branches/caiinterface/AI/Interfaces/CMakeLists.txt	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/AI/Interfaces/CMakeLists.txt	2008-11-04 09:57:36 UTC (rev 6975)
@@ -77,7 +77,7 @@
 
 	# Install the Java part of the interface
 	install (FILES ${Java_AIINTERFACE_SRC}/java/interface.jar DESTINATION ${AI_INTERFACES_DATA}/Java/${Java_AIINTERFACE_VERS}/jlib)
-	install (FILES ${Java_AIINTERFACE_SRC}/jlib/*.jar DESTINATION ${AI_INTERFACES_DATA}/Java/${Java_AIINTERFACE_VERS}/jlib)
+	install(DIRECTORY ${Java_AIINTERFACE_SRC}/jlib/ DESTINATION ${AI_INTERFACES_DATA}/Java/${Java_AIINTERFACE_VERS}/jlib FILES_MATCHING PATTERN &quot;*.jar&quot;)
 
 	# Install the Java test Skirmish AI
 	install (FILES ${Java_AIINTERFACE_SRC}/java/ai.jar DESTINATION ${CMAKE_SOURCE_DIR}/AI/Skirmish/hoijuiAI/jlib)

Modified: branches/caiinterface/Documentation/Spring start.txt
===================================================================
--- branches/caiinterface/Documentation/Spring start.txt	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/Documentation/Spring start.txt	2008-11-04 09:57:36 UTC (rev 6975)
@@ -1,26 +1,19 @@
-// Send a file formated like this as the only command line argument to the
-// spring executable.  All players must get the exact same file except
-// MyPlayerNum, HostIP, SourcePort, PLAYER\CountryCode, PLAYER\Rank,
-// and possibly TEAM\AIDLL.
+// A clients example
+// If spring is started as client, it needs the following information to work properly
 
-// Since december 2007 the restrictions on player/team/allyteam numbering are
-// loosened:
+[GAME]
+{
+	HostIP=xxx.xxx.xxx.xxx;
+	HostPort=xxx;       // standard is 8452
+	SourcePort=0;       // set this if you want a different source port (as client), 0 means OS-select
 
-// Players and teams must be in the same order on each client, but the
-// numbering does not need to be consecutive, or even identical on each client:
-// the sequences of players/teams/allyteams may contain gaps.
+	MyPlayerNum=x;      //only variable that should vary between different players, (deprecated, if you want to use this you need the full script, even as client)
+	MyPlayerName=somename; //can be used instead of MyPlayerNum
+	IsHost=x;			// 0 - no server will be started in this instance, 1 - start a server (if you don't set this, you need the full script and myPlayerNum to work)
+}
 
-// For example, one may define NumPlayers=2 and add a PLAYER10 and PLAYER14
-// section to the script, and Spring will automatically compress this
-// internally to PLAYER0 and PLAYER1. Same applies to teams and allyteams.
-
-// The used numbers must be lower than the maximum number of those sections.
-// At the time of this writing this is: 32/17/17 for players/teams/allyteams
-// respectively.
-
-// From now on, the Gametype, Mapname and the Scriptname-tags are only needed for the gamehost
-// a client will ignore these tags because he recieves everything from the server
-
+// A host example
+// note that the same values for clients also need to be set here
 [GAME]
 {
 	Mapname=;           //with .smf extension
@@ -31,19 +24,20 @@
 	Demofile=demo.sdf;  // if set this game is a multiplayer demo replay
 	Savefile=save.ssf;  // if set this game is a continuation of a saved game
 
-	HostIP=xxx.xxx.xxx.xxx;
+	HostIP=xxx.xxx.xxx.xxx; // you normally won't set this as host
 	HostPort=xxx;       // usually 8452
 	SourcePort=0;       // set this if you want a different source port (as client)
 	AutohostPort=X;     // communicate with spring, specify the port you are listening (as host)
 
-	MyPlayerNum=x;      //only variable that should vary between different players
+	MyPlayerNum=x;      //only variable that should vary between different players, deprecated
 	MyPlayerName=somename; //can be used instead of MyPlayerNum (will overwrite it in fact)
 
+	IsHost=x;			// 0 - no server will be started in this instance, 1 - start a server
 	NumPlayers=x;       // not mandatory, but can be used for debugging purposes
 	NumTeams=y;         // same here, set this to check if the script is right
 	NumAllyTeams=z;     // see above
 
-	// a player (player 0 is the host)
+	// a player (player 0 is the host only if IsHost is not set)
 	[PLAYER0]
 	{
 		Name=name;
@@ -65,8 +59,19 @@
 		Handicap=0-100; // Percent bonus on all resources collected ?
 		StartPosX=0;    // Use these in combination with StartPosType=3
 		StartPosZ=0;    // range is in map coordinates as returned by unitsync (NOT like StartRectTop et al)
-		AiDLL=file;     // If this line exists the team will have a global ai loaded from
-		// the file, the teamleader field indicates which computer the ai will run on.
+		LuaAI=name;     // name of the LUA AI that controlls this team
+		[AI]            // [optional]Skirmish AI section
+		{
+			Name=RAI;     // name of the Skirmish AI that controlls this team
+			              // (see spring.exe --list-skirmish-ais for possible values))
+			Version=0.1;  // [optional] version of the Skirmish AI that controlls this team
+			[OPTIONS]     // [optional] contains AI implementaition specific option values
+			{
+				difficultyLevel=1;
+			}
+		}
+		// Either LuaAI is set, the [AI] section is defined or none of the two.
+		// The TeamLeader field indicates which computer the a Skirmish AI will run on.
 	}
 	//more teams
 

Modified: branches/caiinterface/installer/builddata/springcontent/EngineOptions.lua
===================================================================
--- branches/caiinterface/installer/builddata/springcontent/EngineOptions.lua	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/installer/builddata/springcontent/EngineOptions.lua	2008-11-04 09:57:36 UTC (rev 6975)
@@ -22,10 +22,10 @@
 --------------------------------------------------------------------------------
 --------------------------------------------------------------------------------
 --
---  Example EngineOptions.lua 
+--  Example EngineOptions.lua
 --
 
-local options = 
+local options =
 {
   {
     key    = 'GameMode',
@@ -33,9 +33,9 @@
     desc   = 'Determines what condition triggers the defeat of a player',
     type   = 'list',
     def    = '0',
-    items  = 
+    items  =
     {
-      { 
+      {
         key  = '0',
         name = 'Kill everything',
         desc = 'The player will lose only after all units of the player will be killed',
@@ -52,14 +52,14 @@
       },
     },
   },
-  
+
   {
     key    = 'StartingResources',
     name   = 'Starting Resources',
     desc   = 'Sets storage and amount of resources that players will start with',
     type   = 'section',
   },
-  
+
   {
     key    = 'StartMetal',
     name   = 'Starting metal',
@@ -78,25 +78,25 @@
     desc   = 'Determines amount of energy and energy storage that each player will start with',
     type   = 'number',
     section= 'StartingResources',
-    def    = 500,
+    def    = 1000,
     min    = 0,
     max    = 10000,
     step   = 1,  -- quantization is aligned to the def value
                     -- (step &lt;= 0) means that there is no quantization
   },
-  
+
   {
     key    = 'MaxUnits',
     name   = 'Max units',
     desc   = 'Determines the ceiling of how many units and buildings a player is allowed to own at the same time',
     type   = 'number',
-    def    = 1000,
+    def    = 500,
     min    = 1,
     max    = 10000,
     step   = 1,  -- quantization is aligned to the def value
                     -- (step &lt;= 0) means that there is no quantization
   },
-  
+
   {
     key    = 'LimitDgun',
     name   = 'Limit D-Gun range',
@@ -104,7 +104,7 @@
     type   = 'bool',
     def    = false,
   },
-  
+
   {
     key    = 'GhostedBuildings',
     name   = 'Ghosted buildings',
@@ -125,7 +125,7 @@
     name   = 'Fixed ingame alliances',
     desc   = 'Disables the possibility of players to dynamically change alliances ingame',
     type   = 'bool',
-    def    = true,
+    def    = false,
   },
 
   {
@@ -134,7 +134,7 @@
     desc   = 'Limits maximum and minimum speed that the players will be allowed to change to',
     type   = 'section',
   },
-  
+
   {
     key    = 'MaxSpeed',
     name   = 'Maximum game speed',
@@ -147,7 +147,7 @@
     step   = 0.1,  -- quantization is aligned to the def value
                     -- (step &lt;= 0) means that there is no quantization
   },
-  
+
   {
     key    = 'MinSpeed',
     name   = 'Minimum game speed',
@@ -160,7 +160,7 @@
     step   = 0.1,  -- quantization is aligned to the def value
                     -- (step &lt;= 0) means that there is no quantization
   },
-  
+
   {
     key    = 'DisableMapDamage',
     name   = 'Undeformable map',
@@ -170,7 +170,7 @@
   },
 --[[
 -- the following options can create problems and were never used by interface programs, thus are commented out for the moment
-  
+
   {
     key    = 'LuaGaia',
     name   = 'Enables gaia',
@@ -178,7 +178,7 @@
     type   = 'bool',
     def    = true,
   },
-  
+
   {
     key    = 'NoHelperAIs',
     name   = 'Disable helper AIs',
@@ -186,7 +186,7 @@
     type   = 'bool',
     def    = false,
   },
-  
+
   {
     key    = 'LuaRules',
     name   = 'Enable LuaRules',

Modified: branches/caiinterface/rts/ExternalAI/AICallback.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/AICallback.cpp	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/ExternalAI/AICallback.cpp	2008-11-04 09:57:36 UTC (rev 6975)
@@ -1351,7 +1351,7 @@
 			return true;
 		}
 		case AIVAL_SCRIPT: {
-			*(const char**) data = gameSetup ? gameSetup-&gt;gameSetupText : &quot;&quot;;
+			*(const char**) data = gameSetup ? gameSetup-&gt;gameSetupText.c_str() : &quot;&quot;;
 			return true;
 		}
 		default:

Modified: branches/caiinterface/rts/ExternalAI/AILibraryManager.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/AILibraryManager.cpp	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/ExternalAI/AILibraryManager.cpp	2008-11-04 09:57:36 UTC (rev 6975)
@@ -485,10 +485,6 @@
 			team = gs-&gt;Team(t);
 			if (team != NULL &amp;&amp; team-&gt;isAI) {
 				IAILibraryManager::T_skirmishAIInfos::const_iterator aiInfo;
-/*
-				const std::string&amp; t_sn = td-&gt;skirmishAIShortName;
-				const std::string&amp; t_v = td-&gt;skirmishAIVersion;
-*/
 				const char * tmpStr = team-&gt;skirmishAISpecifier.ai.shortName;
 				const std::string&amp; t_sn = tmpStr != NULL ? tmpStr : &quot;&quot;;
 				tmpStr = team-&gt;skirmishAISpecifier.ai.version;

Modified: branches/caiinterface/rts/ExternalAI/GlobalAIHandler.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/GlobalAIHandler.cpp	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/ExternalAI/GlobalAIHandler.cpp	2008-11-04 09:57:36 UTC (rev 6975)
@@ -1,5 +1,3 @@
-#include &lt;iostream&gt;
-
 #include &quot;StdAfx.h&quot;
 #include &quot;GlobalAIHandler.h&quot;
 #include &quot;Interface/SAIInterfaceLibrary.h&quot;
@@ -73,7 +71,7 @@
 //	exit(-1);
 }
 
-CGlobalAIHandler::CGlobalAIHandler()
+CGlobalAIHandler::CGlobalAIHandler(void)
 {
 	hasAI=false;
 
@@ -81,7 +79,7 @@
 		ais[a]=0;
 }
 
-CGlobalAIHandler::~CGlobalAIHandler()
+CGlobalAIHandler::~CGlobalAIHandler(void)
 {
 	for(int a=0;a&lt;MAX_TEAMS;++a)
 		delete ais[a];
@@ -346,15 +344,18 @@
 
 
 
-bool CGlobalAIHandler::CreateSkirmishAI(int teamId, const SSAIKey&amp; skirmishAIKey)
+bool CGlobalAIHandler::CreateSkirmishAI(
+		int teamId,
+		const SSAIKey&amp; skirmishAIKey,
+		const std::map&lt;std::string, std::string&gt;&amp; skirmishAIOptions)
 {
 	if ((teamId &lt; 0) || (teamId &gt;= gs-&gt;activeTeams)) {
 		return false;
 	}
 
-	if (net-&gt;localDemoPlayback) {
+	/*if (net-&gt;localDemoPlayback) {
 		return false;
-	}
+	}*/
 
 	//TODO: make this work again
 /*
@@ -383,7 +384,8 @@
 		const ISkirmishAILibrary* skirmishAILibrary = IAILibraryManager::GetInstance()-&gt;FetchSkirmishAILibrary(skirmishAIKey);
 		skirmishAIs[teamId] = SAFE_NEW CSkirmishAI(teamId, skirmishAILibrary);
 */
-		ais[teamId] = SAFE_NEW CSkirmishAIWrapper(teamId, skirmishAIKey);
+		ais[teamId] = SAFE_NEW CSkirmishAIWrapper(teamId, skirmishAIKey,
+				skirmishAIOptions);
 		
 /*
 		if (!ais[teamId]-&gt;ai) {

Modified: branches/caiinterface/rts/ExternalAI/GlobalAIHandler.h
===================================================================
--- branches/caiinterface/rts/ExternalAI/GlobalAIHandler.h	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/ExternalAI/GlobalAIHandler.h	2008-11-04 09:57:36 UTC (rev 6975)
@@ -51,7 +51,8 @@
 	void Save(std::ostream *s);
 	void GotChatMsg(const char* msg, int player);
 
-	bool CreateSkirmishAI(int teamId, const SSAIKey&amp; skirmishAIKey);
+	bool CreateSkirmishAI(int teamId, const SSAIKey&amp; skirmishAIKey,
+			const std::map&lt;std::string, std::string&gt;&amp; skirmishAIOptions);
 	bool IsSkirmishAI(int teamId);
 	void DestroySkirmishAI(int teamId);
 	const CSkirmishAIWrapper* GetSkirmishAI(int teamId);

Modified: branches/caiinterface/rts/ExternalAI/Interface/AISEvents.h
===================================================================
--- branches/caiinterface/rts/ExternalAI/Interface/AISEvents.h	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/ExternalAI/Interface/AISEvents.h	2008-11-04 09:57:36 UTC (rev 6975)
@@ -53,7 +53,10 @@
 
 struct SInitEvent {
 	int team;
-	struct SAICallback* c_callback;
+	struct SAICallback* callback;
+	unsigned int sizeOptions;
+	const char** optionKeys;
+	const char** optionValues;
 };
 
 struct SReleaseEvent {

Modified: branches/caiinterface/rts/ExternalAI/Interface/LegacyCppWrapper/Event/AIInitEvent.h
===================================================================
--- branches/caiinterface/rts/ExternalAI/Interface/LegacyCppWrapper/Event/AIInitEvent.h	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/ExternalAI/Interface/LegacyCppWrapper/Event/AIInitEvent.h	2008-11-04 09:57:36 UTC (rev 6975)
@@ -26,7 +26,7 @@
     void run(IGlobalAI* ai) {
         //((CAIGlobalAI*) ai)-&gt;gai-&gt;InitAI(event.callback, event.team);
         //((CAIGlobalAI*) ai)-&gt;InitAI(event.c_callback, event.team, event.callback);
-        IGlobalAICallback* wrappedGlobalAICallback = new CAIGlobalAICallback(event.c_callback, event.team);
+        IGlobalAICallback* wrappedGlobalAICallback = new CAIGlobalAICallback(event.callback, event.team);
         ai-&gt;InitAI(wrappedGlobalAICallback, event.team);
     }
 private:

Modified: branches/caiinterface/rts/ExternalAI/SkirmishAIWrapper.cpp
===================================================================
--- branches/caiinterface/rts/ExternalAI/SkirmishAIWrapper.cpp	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/ExternalAI/SkirmishAIWrapper.cpp	2008-11-04 09:57:36 UTC (rev 6975)
@@ -40,7 +40,9 @@
 CR_REG_METADATA(CSkirmishAIWrapper, (
 	CR_MEMBER(teamId),
 	CR_MEMBER(cheatEvents),
-	CR_MEMBER(skirmishAIKey),
+	CR_MEMBER(key),
+	CR_MEMBER(optionKeys),
+	CR_MEMBER(optionValues),
 /*
 	CR_MEMBER(libName),
 	CR_MEMBER(IsCInterface),
@@ -73,11 +75,18 @@
 	}
 
 
-CSkirmishAIWrapper::CSkirmishAIWrapper(int teamId, const SSAIKey&amp; skirmishAIKey)
-		: teamId(teamId), cheatEvents(false), skirmishAIKey(skirmishAIKey) {
+CSkirmishAIWrapper::CSkirmishAIWrapper(int teamId, const SSAIKey&amp; key,
+		const std::map&lt;std::string, std::string&gt;&amp; options)
+		: teamId(teamId), cheatEvents(false), key(key) {
 	
-	LoadSkirmishAI(teamId, skirmishAIKey, false);
-	
+	std::map&lt;std::string, std::string&gt;::const_iterator op;
+    for (op = options.begin(); op != options.end(); ++op) {
+        optionKeys.push_back(op-&gt;first);
+        optionValues.push_back(op-&gt;second);
+    }
+
+	LoadSkirmishAI(teamId, key, false);
+
 	Init();
 }
 
@@ -99,7 +108,7 @@
 
 
 void CSkirmishAIWrapper::PostLoad() {
-	LoadSkirmishAI(teamId, skirmishAIKey, true);
+	LoadSkirmishAI(teamId, key, true);
 }
 
 
@@ -107,15 +116,15 @@
 void CSkirmishAIWrapper::LoadSkirmishAI(int teamId,
 		const SSAIKey&amp; skirmishAIKey, bool postLoad) {
 	
-	ai = SAFE_NEW CSkirmishAI(teamId, skirmishAIKey);
+	ai = SAFE_NEW CSkirmishAI(teamId, key);
 	
 	IAILibraryManager* libManager = IAILibraryManager::GetInstance();
-	libManager-&gt;FetchSkirmishAILibrary(skirmishAIKey);
+	libManager-&gt;FetchSkirmishAILibrary(key);
 	const CSkirmishAILibraryInfo* infos =
-			libManager-&gt;GetSkirmishAIInfos()-&gt;at(skirmishAIKey);
+			libManager-&gt;GetSkirmishAIInfos()-&gt;at(key);
 	bool loadSupported =
 			infos-&gt;GetInfo(SKIRMISH_AI_PROPERTY_LOAD_SUPPORTED) == &quot;yes&quot;;
-	libManager-&gt;ReleaseSkirmishAILibrary(skirmishAIKey);
+	libManager-&gt;ReleaseSkirmishAILibrary(key);
 
 	if (postLoad &amp;&amp; !loadSupported) {
 		// fallback code to help the AI if it
@@ -153,12 +162,28 @@
 	}
 }
 
+static const char** allocCStrArray(std::vector&lt;std::string&gt; strVec) {
+
+	const char** strArr = NULL;
+
+	unsigned int size = strVec.size();
+	strArr = (const char**) calloc(size, sizeof(char*));
+	unsigned int i;
+    for (i = 0; i &lt; size; ++i) {
+        strArr[i] = strVec[i].c_str();
+    }
+
+	return strArr;
+}
+
 void CSkirmishAIWrapper::Init() {
-	
+
 	callback = SAFE_NEW CGlobalAICallback(this);
 	c_callback = initSAICallback(teamId, callback);
-	
-	SInitEvent evtData = {teamId, c_callback};
+	optionKeys_c = allocCStrArray(optionKeys);
+	optionValues_c = allocCStrArray(optionValues);
+
+	SInitEvent evtData = {teamId, c_callback, optionKeys.size(), optionKeys_c, optionValues_c};
 	ai-&gt;HandleEvent(EVENT_INIT, &amp;evtData);
 }
 
@@ -167,6 +192,9 @@
 	SReleaseEvent evtData = {teamId};
 	ai-&gt;HandleEvent(EVENT_RELEASE, &amp;evtData);
 	
+	free(optionKeys_c);
+	free(optionValues_c);
+	
 	// further cleanup is done in the destructor
 }
 

Modified: branches/caiinterface/rts/ExternalAI/SkirmishAIWrapper.h
===================================================================
--- branches/caiinterface/rts/ExternalAI/SkirmishAIWrapper.h	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/ExternalAI/SkirmishAIWrapper.h	2008-11-04 09:57:36 UTC (rev 6975)
@@ -25,6 +25,9 @@
 #include &quot;Interface/SAIInterfaceLibrary.h&quot;
 #include &quot;Platform/SharedLib.h&quot;
 
+#include &lt;map&gt;
+#include &lt;string&gt;
+
 class CAICallback;
 struct Command;
 struct float3;
@@ -33,7 +36,8 @@
 public:
 	CR_DECLARE(CSkirmishAIWrapper);
 //	CSkirmishAIWrapper();
-	CSkirmishAIWrapper(int teamId, const SSAIKey&amp; skirmishAIKey);
+	CSkirmishAIWrapper(int teamId, const SSAIKey&amp; key,
+			const std::map&lt;std::string, std::string&gt;&amp; options = (std::map&lt;std::string, std::string&gt;()));
 	~CSkirmishAIWrapper();
 
 	void Serialize(creg::ISerializer *s);
@@ -93,7 +97,11 @@
 	ISkirmishAI* ai;
 	CGlobalAICallback* callback;
 	SAICallback* c_callback;
-	SSAIKey skirmishAIKey;
+	SSAIKey key;
+	std::vector&lt;std::string&gt; optionKeys;
+	std::vector&lt;std::string&gt; optionValues;
+	const char** optionKeys_c;
+	const char** optionValues_c;
 
 //	typedef bool (*ISCINTERFACE)();
 //	typedef int (*GETGLOBALAIVERSION)();

Modified: branches/caiinterface/rts/Game/ConsoleHistory.cpp
===================================================================
--- branches/caiinterface/rts/Game/ConsoleHistory.cpp	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/Game/ConsoleHistory.cpp	2008-11-04 09:57:36 UTC (rev 6975)
@@ -3,6 +3,7 @@
 //////////////////////////////////////////////////////////////////////
 
 #include &quot;StdAfx.h&quot;
+#include &quot;Rendering/GL/myGL.h&quot;
 
 #include &quot;mmgr.h&quot;
 
@@ -28,6 +29,8 @@
 
 void CConsoleHistory::ResetPosition()
 {
+	GML_STDMUTEX_LOCK(hist);
+
 	pos = lines.end();
 	return;
 }
@@ -35,6 +38,8 @@
 
 bool CConsoleHistory::AddLine(const std::string&amp; msg)
 {
+	GML_STDMUTEX_LOCK(hist);
+
 	std::string message;
 	if ((msg.find_first_of(&quot;aAsS&quot;) == 0) &amp;&amp; (msg[1] == ':')) {
 		message = msg.substr(2);
@@ -71,6 +76,8 @@
 
 std::string CConsoleHistory::NextLine(const std::string&amp; current)
 {
+	GML_STDMUTEX_LOCK(hist);
+
 	std::string prefix, message;
 	if ((current.find_first_of(&quot;aAsS&quot;) == 0) &amp;&amp; (current[1] == ':')) {
 		prefix  = current.substr(0, 2);
@@ -108,6 +115,8 @@
 
 std::string CConsoleHistory::PrevLine(const std::string&amp; current)
 {
+	GML_STDMUTEX_LOCK(hist);
+
 	std::string prefix, message;
 	if ((current.find_first_of(&quot;aAsS&quot;) == 0) &amp;&amp; (current[1] == ':')) {
 		prefix  = current.substr(0, 2);

Modified: branches/caiinterface/rts/Game/Game.cpp
===================================================================
--- branches/caiinterface/rts/Game/Game.cpp	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/Game/Game.cpp	2008-11-04 09:57:36 UTC (rev 6975)
@@ -124,7 +124,6 @@
 #include &quot;System/FileSystem/SimpleParser.h&quot;
 #include &quot;System/Platform/NullSound.h&quot;
 #include &quot;System/Net/RawPacket.h&quot;
-#include &quot;Platform/Clipboard.h&quot;
 #include &quot;UI/CommandColors.h&quot;
 #include &quot;UI/CursorIcons.h&quot;
 #include &quot;UI/EndGameBox.h&quot;
@@ -446,11 +445,7 @@
 	globalAI = SAFE_NEW CGlobalAIHandler();
 
 	CPlayer* p = gs-&gt;players[gu-&gt;myPlayerNum];
-	if(!gameSetup || net-&gt;localDemoPlayback) {
-		p-&gt;name = configHandler.GetString(&quot;name&quot;, &quot;&quot;);
-	} else {
-		GameSetupDrawer::Enable();
-	}
+	GameSetupDrawer::Enable();
 
 	if (gs-&gt;useLuaRules) {
 		PrintLoadMsg(&quot;Loading LuaRules&quot;);
@@ -522,9 +517,6 @@
 	//sending your playername to the server indicates that you are finished loading
 	net-&gt;Send(CBaseNetProtocol::Get().SendPlayerName(gu-&gt;myPlayerNum, p-&gt;name));
 
-	if (net-&gt;localDemoPlayback) // auto-start when playing a demo in local mode
-		net-&gt;Send(CBaseNetProtocol::Get().SendStartPlaying(0));
-
 	lastCpuUsageTime = gu-&gt;gameTime + 10;
 
 	mouse-&gt;ShowMouse();
@@ -765,10 +757,7 @@
 					userInput.insert(writingPos, action.extra);
 					writingPos += action.extra.length();
 				} else {
-					CClipboard clipboard;
-					const string text = clipboard.GetContents();
-					userInput.insert(writingPos, text);
-					writingPos += text.length();
+					PasteClipboard();
 				}
 				break;
 			}
@@ -1077,7 +1066,7 @@
 		camMove[7]=true;
 	}
 	else if (cmd == &quot;team&quot;){
-		if (gs-&gt;cheatEnabled || net-&gt;localDemoPlayback)
+		if (gs-&gt;cheatEnabled)
 		{
 			int team=atoi(action.extra.c_str());
 			if ((team &gt;= 0) &amp;&amp; (team &lt;gs-&gt;activeTeams)) {
@@ -1110,7 +1099,7 @@
 	else if (cmd == &quot;ally&quot;){
 		if (action.extra.size() &gt; 0)
 		{
-			if (gameSetup &amp;&amp; !gameSetup-&gt;fixedAllies)
+			if (!gameSetup-&gt;fixedAllies)
 			{
 				std::istringstream is(action.extra);
 				int otherAllyTeam = -1;
@@ -1169,7 +1158,7 @@
 	else if (((cmd == &quot;chat&quot;)     || (cmd == &quot;chatall&quot;) ||
 	         (cmd == &quot;chatally&quot;) || (cmd == &quot;chatspec&quot;)) &amp;&amp;
 	         // if chat is bound to enter and we're waiting for user to press enter to start game, ignore.
-				  (ks.Key() != SDLK_RETURN || (gameSetup || playing ))) {
+				  (ks.Key() != SDLK_RETURN || playing || !keys[SDLK_LCTRL] )) {
 
 		if (cmd == &quot;chatall&quot;)  { userInputPrefix = &quot;&quot;; }
 		if (cmd == &quot;chatally&quot;) { userInputPrefix = &quot;a:&quot;; }
@@ -1784,7 +1773,7 @@
 		}
 	}
 	else if (cmd == &quot;allmapmarks&quot;) {
-		if (gs-&gt;cheatEnabled &amp;&amp; !net-&gt;localDemoPlayback) {
+		if (gs-&gt;cheatEnabled) {
 			if (action.extra.empty()) {
 				inMapDrawer-&gt;ToggleAllVisible();
 			} else {
@@ -1848,10 +1837,7 @@
 				userInput.insert(writingPos, action.extra);
 				writingPos += action.extra.length();
 			} else {
-				CClipboard clipboard;
-				const string text = clipboard.GetContents();
-				userInput.insert(writingPos, text);
-				writingPos += text.length();
+				PasteClipboard();
 			}
 			return 0;
 		}
@@ -2511,12 +2497,6 @@
 	}
 #endif
 
-#ifdef SYNCIFY		//syncify doesnt support multithreading ...
-	if (gameServer) {
-		gameServer-&gt;Update();
-	}
-#endif
-
 	if(creatingVideo &amp;&amp; playing &amp;&amp; gameServer){
 		gameServer-&gt;CreateNewFrame(false, true);
 	}
@@ -2540,22 +2520,6 @@
 		}
 	}
 
-	if (gameServer &amp;&amp; !gameServer-&gt;GameHasStarted() &amp;&amp; !gameSetup) {
-		bool allReady = true;
-		for (int a = 0; a &lt; gs-&gt;activePlayers; a++) {
-			if(gs-&gt;players[a]-&gt;active &amp;&amp; !gs-&gt;players[a]-&gt;readyToStart) {
-				allReady = false;
-				break;
-			}
-		}
-		if (allReady &amp;&amp; (keys[SDLK_RETURN] || script-&gt;onlySinglePlayer)) {
-			chatting = false;
-			userWriting = false;
-			writingPos = 0;
-			net-&gt;Send(CBaseNetProtocol::Get().SendStartPlaying(0));
-		}
-	}
-
 	return true;
 }
 
@@ -2902,11 +2866,6 @@
 		}
 	}
 
-	if (gameServer &amp;&amp; gameServer-&gt;WaitsOnCon() &amp;&amp; !gameSetup) {
-		glColor3f(1.0f, 1.0f, 1.0f);
-		font-&gt;glPrintCentered (0.5f, 0.5f, 1.5f, &quot;Waiting for connections. Press return to start&quot;);
-	}
-
 	if (userWriting) {
 		DrawInputText();
 	}
@@ -3583,7 +3542,7 @@
 			case NETMSG_STARTPOS:{
 				unsigned player = inbuf[1];
 				int team = inbuf[2];
-				if ((team &gt;= gs-&gt;activeTeams) || (team &lt; 0) || !gameSetup) {
+				if ((team &gt;= gs-&gt;activeTeams) || (team &lt; 0)) {
 					logOutput.Print(&quot;Got invalid team num %i in startpos msg&quot;,team);
 				} else {
 					float3 pos(*(float*)&amp;inbuf[4],
@@ -3651,7 +3610,7 @@
 #endif
 				AddTraffic(-1, packetCode, dataLength);
 
-				if (creatingVideo &amp;&amp; net-&gt;localDemoPlayback) {
+				if (creatingVideo) {
 					POP_CODE_MODE;
 					return;
 				}
@@ -4501,13 +4460,8 @@
 		// Write CPlayer::Statistics and CTeam::Statistics to demo
 		int numPlayers;
 		// FIXME: ugh, there should be a better way to figure out number of players ...
-		if (gameSetup != NULL) {
-			numPlayers = gameSetup-&gt;numPlayers;
-		} else {
-			numPlayers = 0;
-			while (gs-&gt;players[numPlayers]-&gt;currentStats-&gt;mousePixels != 0)
-				++numPlayers;
-		}
+		numPlayers = gameSetup-&gt;numPlayers;
+
 		int numTeams = gs-&gt;activeAllyTeams;
 		if (gs-&gt;useLuaGaia) {
 			--numTeams;

Modified: branches/caiinterface/rts/Game/Game.h
===================================================================
--- branches/caiinterface/rts/Game/Game.h	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/Game/Game.h	2008-11-04 09:57:36 UTC (rev 6975)
@@ -8,7 +8,6 @@
 #include &lt;time.h&gt;
 #include &lt;string&gt;
 #include &lt;map&gt;
-#include &quot;SDL_types.h&quot;
 
 #include &quot;GameController.h&quot;
 #include &quot;creg/creg.h&quot;

Modified: branches/caiinterface/rts/Game/GameController.cpp
===================================================================
--- branches/caiinterface/rts/Game/GameController.cpp	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/Game/GameController.cpp	2008-11-04 09:57:36 UTC (rev 6975)
@@ -3,6 +3,7 @@
 #include &quot;mmgr.h&quot;
 
 #include &quot;GameController.h&quot;
+#include &quot;System/Platform/Clipboard.h&quot;
 
 
 CGameController::CGameController(void)
@@ -58,3 +59,11 @@
 	return 0;
 }
 
+
+void CGameController::PasteClipboard()
+{
+	CClipboard clipboard;
+	const std::string text = clipboard.GetContents();
+	userInput.insert(writingPos, text);
+	writingPos += text.length();
+}

Modified: branches/caiinterface/rts/Game/GameController.h
===================================================================
--- branches/caiinterface/rts/Game/GameController.h	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/Game/GameController.h	2008-11-04 09:57:36 UTC (rev 6975)
@@ -20,6 +20,9 @@
 	char ignoreChar;
 	std::basic_string&lt;char&gt; userInput;
 	std::basic_string&lt;char&gt; userPrompt;
+
+protected:
+	void PasteClipboard();
 };
 
 extern CGameController* activeController;

Modified: branches/caiinterface/rts/Game/GameData.cpp
===================================================================
--- branches/caiinterface/rts/Game/GameData.cpp	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/Game/GameData.cpp	2008-11-04 09:57:36 UTC (rev 6975)
@@ -21,6 +21,7 @@
 {
 	assert(pckt-&gt;data[0] == NETMSG_GAMEDATA);
 	UnpackPacket packet(pckt, 3);
+	packet &gt;&gt; setupText;
 	packet &gt;&gt; script;
 	packet &gt;&gt; map;
 	packet &gt;&gt; mapChecksum;
@@ -31,9 +32,10 @@
 
 const netcode::RawPacket* GameData::Pack() const
 {
-	unsigned short size = 3 + 2*sizeof(unsigned) + map.size() + mod.size() + script.size() + 4 + 3;
+	unsigned short size = 3 + 2*sizeof(unsigned) + setupText.size()+1 + map.size() + mod.size() + script.size() + 4 + 3;
 	PackPacket* buffer = new PackPacket(size, NETMSG_GAMEDATA);
 	*buffer &lt;&lt; size;
+	*buffer &lt;&lt; setupText;
 	*buffer &lt;&lt; script;
 	*buffer &lt;&lt; map;
 	*buffer &lt;&lt; mapChecksum;
@@ -43,6 +45,11 @@
 	return buffer;
 }
 
+void GameData::SetSetup(const std::string&amp; newSetup)
+{
+	setupText = newSetup;
+}
+
 void GameData::SetScript(const std::string&amp; newScript)
 {
 	script = newScript;

Modified: branches/caiinterface/rts/Game/GameData.h
===================================================================
--- branches/caiinterface/rts/Game/GameData.h	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/Game/GameData.h	2008-11-04 09:57:36 UTC (rev 6975)
@@ -16,11 +16,13 @@
 	
 	const netcode::RawPacket* Pack() const;
 	
+	void SetSetup(const std::string&amp; newSetup);
 	void SetScript(const std::string&amp; newScript);
 	void SetMap(const std::string&amp; newMap, const unsigned checksum);
 	void SetMod(const std::string&amp; newMod, const unsigned checksum);
 	void SetRandomSeed(const unsigned seed);
 	
+	const std::string&amp; GetSetup() const {return setupText;};
 	const std::string&amp; GetScript() const {return script;};
 	const std::string&amp; GetMap() const {return map;};
 	unsigned GetMapChecksum() const {return mapChecksum;};
@@ -29,6 +31,8 @@
 	unsigned GetRandomSeed() const {return randomSeed;};
 
 private:
+	std::string setupText;
+
 	std::string script;
 	std::string map;
 	unsigned mapChecksum;

Modified: branches/caiinterface/rts/Game/GameHelper.h
===================================================================
--- branches/caiinterface/rts/Game/GameHelper.h	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/Game/GameHelper.h	2008-11-04 09:57:36 UTC (rev 6975)
@@ -7,6 +7,7 @@
 
 #include &lt;list&gt;
 #include &lt;map&gt;
+#include &lt;vector&gt;
 #include &quot;Object.h&quot;
 class CGame;
 class CUnit;
@@ -15,9 +16,7 @@
 class CFeature;
 
 struct UnitDef;
-#include &lt;vector&gt;
 #include &quot;Sim/Misc/DamageArray.h&quot;
-#include &lt;list&gt;
 #include &quot;MemPool.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
 

Modified: branches/caiinterface/rts/Game/GameServer.cpp
===================================================================
--- branches/caiinterface/rts/Game/GameServer.cpp	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/Game/GameServer.cpp	2008-11-04 09:57:36 UTC (rev 6975)
@@ -103,9 +103,10 @@
 
 CGameServer* gameServer=0;
 
-CGameServer::CGameServer(int port, bool onlyLocal, const GameData* const newGameData, const CGameSetup* const mysetup = 0, const std::string&amp; demoName)
+CGameServer::CGameServer(const LocalSetup* settings, bool onlyLocal, const GameData* const newGameData, const CGameSetup* const mysetup)
 : setup(mysetup)
 {
+	assert(setup);
 	serverStartTime = SDL_GetTicks();
 	delayedSyncResponseFrame = 0;
 	syncErrorFrame=0;
@@ -133,29 +134,25 @@
 	sentGameOverMsg = false;
 	
 	if (!onlyLocal)
-		UDPNet.reset(new netcode::UDPListener(port));
+		UDPNet.reset(new netcode::UDPListener(settings-&gt;hostport));
 	
+	if (settings-&gt;autohostport &gt; 0) {
+		AddAutohostInterface(settings-&gt;autohostport);
+	}
 	rng.Seed(SDL_GetTicks());
-	Message(str( format(ServerStart) %port) );
+	Message(str( format(ServerStart) %settings-&gt;hostport) );
 
 	lastTick = SDL_GetTicks();
 
-	if (setup) {
-		maxUserSpeed = setup-&gt;maxSpeed;
-		minUserSpeed = setup-&gt;minSpeed;
-		noHelperAIs = (bool)setup-&gt;noHelperAIs;
-	}
-	else
-	{
-		maxUserSpeed=5;
-		minUserSpeed=0.3f;
-	}
+	maxUserSpeed = setup-&gt;maxSpeed;
+	minUserSpeed = setup-&gt;minSpeed;
+	noHelperAIs = (bool)setup-&gt;noHelperAIs;
 
 	gameData.reset(newGameData);
-	if (!demoName.empty())
+	if (setup-&gt;hostDemo)
 	{
-		Message(str( format(PlayingDemo) %demoName ));
-		demoReader.reset(new CDemoReader(demoName, modGameTime+0.1f));
+		Message(str( format(PlayingDemo) %setup-&gt;demoName ));
+		demoReader.reset(new CDemoReader(setup-&gt;demoName, modGameTime+0.1f));
 	}
 
 	RestrictedAction(&quot;kick&quot;);			RestrictedAction(&quot;kickbynum&quot;);
@@ -176,6 +173,7 @@
 	RestrictedAction(&quot;editdefs&quot;);
 	RestrictedAction(&quot;luagaia&quot;);
 	RestrictedAction(&quot;singlestep&quot;);
+
 	thread = new boost::thread(boost::bind&lt;void, CGameServer, CGameServer*&gt;(&amp;CGameServer::UpdateLoop, this));
 
 #ifdef STREFLOP_H
@@ -205,7 +203,6 @@
 {
 	if (!hostif)
 	{
-		boost::recursive_mutex::scoped_lock scoped_lock(gameServerMutex);
 		hostif.reset(new AutohostInterface(remotePort));
 		hostif-&gt;SendStart();
 		Message(str(format(ConnectAutohost) %remotePort));
@@ -409,7 +406,7 @@
 
 void CGameServer::Update()
 {
-	if (!isPaused &amp;&amp; !WaitsOnCon())
+	if (!isPaused &amp;&amp; gameStartTime &gt; 0)
 	{
 		modGameTime += float(SDL_GetTicks() - lastUpdate) * 0.001f * internalSpeed;
 	}
@@ -552,7 +549,7 @@
 			} else {
 				players[playerNum]-&gt;name = (std::string)((char*)inbuf+3);
 				players[playerNum]-&gt;readyToStart = true;
-				Message(str(format(PlayerJoined) %players[playerNum]-&gt;name %playerNum));
+				Message(str(format(PlayerJoined) %players[playerNum]-&gt;name));
 				Broadcast(CBaseNetProtocol::Get().SendPlayerName(playerNum, players[playerNum]-&gt;name));
 				if (hostif)
 				{
@@ -583,7 +580,7 @@
 			if(inbuf[1] != a){
 				Warning(str(format(WrongPlayer) %(unsigned)inbuf[0] %a %(unsigned)inbuf[1]));
 			}
-			else if (setup &amp;&amp; setup-&gt;startPosType == CGameSetup::StartPos_ChooseInGame)
+			else if (setup-&gt;startPosType == CGameSetup::StartPos_ChooseInGame)
 			{
 				unsigned team = (unsigned)inbuf[2];
 				if (teams[team])
@@ -820,7 +817,7 @@
 			const unsigned char player = inbuf[1];
 			const unsigned char whichAllyTeam = inbuf[2];
 			const unsigned char allied = inbuf[3];
-			if (setup &amp;&amp; !setup-&gt;fixedAllies)
+			if (!setup-&gt;fixedAllies)
 			{
 				Broadcast(CBaseNetProtocol::Get().SendSetAllied(player, whichAllyTeam, allied));
 			}
@@ -954,11 +951,9 @@
 
 	// Third dword is CRC of setupText (if there is a setup)
 	// or pseudo random bytes (if there is no setup)
-	if (setup != NULL) {
-		CRC crc;
-		crc.Update(setup-&gt;gameSetupText, setup-&gt;gameSetupTextLength);
-		gameID.intArray[2] = crc.GetDigest();
-	}
+	CRC crc;
+	crc.Update(setup-&gt;gameSetupText.c_str(), setup-&gt;gameSetupText.length());
+	gameID.intArray[2] = crc.GetDigest();
 
 	CRC entropy;
 	entropy.Update(lastTick);
@@ -971,40 +966,23 @@
 {
 	assert(!gameStartTime);
 	bool allReady = true;
-	
-	if (setup)
-	{
-		unsigned numDemoPlayers = demoReader ? demoReader-&gt;GetFileHeader().maxPlayerNum+1 : 0;
-		unsigned start = numDemoPlayers;
+
 #ifdef DEDICATED
-		// Lobby-protocol doesn't support creating games without players inside
-		// so in dedicated mode there will always be the host-player in the script
-		// which doesn't exist and will never join, so skip it in this case
-		if (setup &amp;&amp; 0 == start)
-			start++;
+	// Lobby-protocol doesn't support creating games without players inside
+	// so in dedicated mode there will always be the host-player in the script
+	// which doesn't exist and will never join, so skip it in this case
+	for (int a = std::max(setup-&gt;numDemoPlayers,1); a &lt; setup-&gt;numPlayers; a++)
+#else
+	for (int a = setup-&gt;numDemoPlayers; a &lt; setup-&gt;numPlayers; a++)
 #endif
-		for (int a = start; a &lt; setup-&gt;numPlayers; a++) {
-			if (!players[a] || !players[a]-&gt;readyToStart) {
-				allReady = false;
-				break;
-			} else if (teams[players[a]-&gt;team] &amp;&amp; !teams[players[a]-&gt;team]-&gt;readyToStart &amp;&amp; !demoReader)
-			{
-				allReady = false;
-				break;
-			}
-		}
-	}
-	else
 	{
-		allReady = false;
-		// no setup, wait for host to send NETMSG_STARTPLAYING
-		// if this is the case, forced is true...
-		if (forced)
+		if (!players[a] || !players[a]-&gt;readyToStart) {
+			allReady = false;
+			break;
+		} else if (teams[players[a]-&gt;team] &amp;&amp; !teams[players[a]-&gt;team]-&gt;readyToStart &amp;&amp; !demoReader)
 		{
-			// immediately start
-			readyTime = SDL_GetTicks();
-			rng.Seed(readyTime);
-			StartGame();
+			allReady = false;
+			break;
 		}
 	}
 
@@ -1045,14 +1023,12 @@
 	}
 
 	GenerateAndSendGameID();
-	if (setup) {
-		for (int a = 0; a &lt; setup-&gt;numTeams; ++a)
-		{
-			if (teams[a]) // its a player
-				Broadcast(CBaseNetProtocol::Get().SendStartPos(SERVER_PLAYER, a, 1, teams[a]-&gt;startpos.x, teams[a]-&gt;startpos.y, teams[a]-&gt;startpos.z));
-			else // maybe an AI?
-				Broadcast(CBaseNetProtocol::Get().SendStartPos(SERVER_PLAYER, a, 1, setup-&gt;teamStartingData[a].startPos.x, setup-&gt;teamStartingData[a].startPos.y, setup-&gt;teamStartingData[a].startPos.z));
-		}
+	for (int a = 0; a &lt; setup-&gt;numTeams; ++a)
+	{
+		if (teams[a]) // its a player
+			Broadcast(CBaseNetProtocol::Get().SendStartPos(SERVER_PLAYER, a, 1, teams[a]-&gt;startpos.x, teams[a]-&gt;startpos.y, teams[a]-&gt;startpos.z));
+		else // maybe an AI?
+			Broadcast(CBaseNetProtocol::Get().SendStartPos(SERVER_PLAYER, a, 1, setup-&gt;teamStartingData[a].startPos.x, setup-&gt;teamStartingData[a].startPos.y, setup-&gt;teamStartingData[a].startPos.z));
 	}
 
 	Broadcast(CBaseNetProtocol::Get().SendRandSeed(rng()));
@@ -1206,7 +1182,7 @@
 				hasPlayer = true;
 			}
 		}
-		if (!setup || !SSAIKey_Comparator::IsEmpty(gs-&gt;Team(a)-&gt;skirmishAISpecifier)) // is not empty?
+		if (!SSAIKey_Comparator::IsEmpty(gs-&gt;Team(a)-&gt;skirmishAISpecifier)) // is not empty?
 			hasPlayer = true;
 
 		if (!gs-&gt;Team(a)-&gt;isDead &amp;&amp; !gs-&gt;Team(a)-&gt;gaia &amp;&amp; hasPlayer)
@@ -1311,7 +1287,7 @@
 	while (!quitServer)
 	{
 		bool hasData = false;
-		if (hasLocalClient)
+		if (hasLocalClient || !UDPNet)
 		{
 			SDL_Delay(10); // don't take 100% cpu time
 			hasData = true;
@@ -1364,16 +1340,13 @@
 	unsigned hisNewNumber = 0;
 	bool found = false;
 
-	if (setup)
+	for (unsigned i = setup-&gt;numDemoPlayers; i &lt; setup-&gt;numPlayers; ++i)
 	{
-		for (unsigned i = 0; i &lt; setup-&gt;numPlayers; ++i)
+		if (name == setup-&gt;playerStartingData[i].name)
 		{
-			if (name == setup-&gt;playerStartingData[i].name)
-			{
-				hisNewNumber = i;
-				found = true;
-				break;
-			}
+			hisNewNumber = i;
+			found = true;
+			break;
 		}
 	}
 
@@ -1392,7 +1365,7 @@
 		}
 	}
 
-	if (setup &amp;&amp; (hisNewNumber &gt;= static_cast&lt;unsigned&gt;(setup-&gt;numPlayers) || !found) &amp;&amp; !demoReader)
+	if ((hisNewNumber &gt;= static_cast&lt;unsigned&gt;(setup-&gt;numPlayers) || !found) &amp;&amp; !demoReader)
 	{
 		// player not found
 		Message(str(format(&quot;Player %s not found, rejecting connection attempt&quot;) %name));
@@ -1401,18 +1374,18 @@
 	
 	players[hisNewNumber].reset(new GameParticipant(isLocal)); // give him rights to change speed, kick players etc
 	players[hisNewNumber]-&gt;link = link;
-	if (setup &amp;&amp; hisNewNumber &lt; setup-&gt;playerStartingData.size()) {
+	if (hisNewNumber &lt; setup-&gt;playerStartingData.size()) {
 		*static_cast&lt;PlayerBase*&gt;(players[hisNewNumber].get()) = setup-&gt;playerStartingData[hisNewNumber];
 	}
-	link-&gt;SendData(CBaseNetProtocol::Get().SendSetPlayerNum((unsigned char)hisNewNumber));
 	link-&gt;SendData(boost::shared_ptr&lt;const RawPacket&gt;(gameData-&gt;Pack()));
+	link-&gt;SendData(CBaseNetProtocol::Get().SendSetPlayerNum((unsigned char)hisNewNumber));
 
 	for (int a = 0; a &lt; MAX_PLAYERS; ++a) {
 		if(players[a] &amp;&amp; players[a]-&gt;readyToStart)
 			Broadcast(CBaseNetProtocol::Get().SendPlayerName(a, players[a]-&gt;name));
 	}
 
-	if (setup &amp;&amp; (!demoReader || setup-&gt;demoName.empty()) /* gamesetup from demo? */)
+	if (!demoReader || setup-&gt;demoName.empty()) // gamesetup from demo?
 	{
 		unsigned hisTeam = setup-&gt;playerStartingData[hisNewNumber].team;
 		if (!teams[hisTeam]) // create new team
@@ -1431,21 +1404,7 @@
 				Broadcast(CBaseNetProtocol::Get().SendStartPos(SERVER_PLAYER, a, teams[a]-&gt;readyToStart, teams[a]-&gt;startpos.x, teams[a]-&gt;startpos.y, teams[a]-&gt;startpos.z));
 		}
 	}
-	else
-	{
-		unsigned hisTeam = hisNewNumber;
-		if (!demoReader)
-		{
-			teams[hisTeam].reset(new GameTeam());
-			players[hisNewNumber]-&gt;team = hisTeam;
-			Broadcast(CBaseNetProtocol::Get().SendJoinTeam(hisNewNumber, hisTeam));
-			for (int a = 0; a &lt; MAX_TEAMS; ++a)
-			{
-				if (teams[a] &amp;&amp; a != (int)hisNewNumber)
-					Broadcast(CBaseNetProtocol::Get().SendJoinTeam(a, players[a]-&gt;team));
-			}
-		}
-	}
+	
 	Message(str(format(NewConnection) %name %hisNewNumber %version));
 
 	link-&gt;Flush(true);

Modified: branches/caiinterface/rts/Game/GameServer.h
===================================================================
--- branches/caiinterface/rts/Game/GameServer.h	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/Game/GameServer.h	2008-11-04 09:57:36 UTC (rev 6975)
@@ -27,6 +27,7 @@
 class CDemoReader;
 class AutohostInterface;
 class CGameSetup;
+class LocalSetup;
 class ChatMessage;
 
 const unsigned SERVER_PLAYER = 255; //server generated message which needs a playernumber
@@ -63,7 +64,7 @@
 {
 	friend class CLoadSaveHandler;     //For initialize server state after load
 public:
-	CGameServer(int port, bool onlyLocal, const GameData* const gameData, const CGameSetup* const setup, const std::string&amp; demoName = &quot;&quot;);
+	CGameServer(const LocalSetup* settings, bool onlyLocal, const GameData* const gameData, const CGameSetup* const setup);
 	virtual ~CGameServer();
 
 	void AddLocalClient(const std::string&amp; myName, const std::string&amp; myVersion);
@@ -160,7 +161,7 @@
 	boost::scoped_ptr&lt;GameTeam&gt; teams[MAX_TEAMS];
 
 	/////////////////// game settings ///////////////////
-	const CGameSetup* const setup;
+	boost::scoped_ptr&lt;const CGameSetup&gt; setup;
 	boost::scoped_ptr&lt;const GameData&gt; gameData;
 	/// Wheter the game is pausable for others than the host
 	bool gamePausable;

Modified: branches/caiinterface/rts/Game/GameSetup.cpp
===================================================================
--- branches/caiinterface/rts/Game/GameSetup.cpp	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/Game/GameSetup.cpp	2008-11-04 09:57:36 UTC (rev 6975)
@@ -11,12 +11,7 @@
 #include &quot;GameSetup.h&quot;
 #include &quot;TdfParser.h&quot;
 #include &quot;FileSystem/ArchiveScanner.h&quot;
-#include &quot;FileSystem/FileHandler.h&quot;
-#include &quot;FileSystem/VFSHandler.h&quot;
-#include &quot;TdfParser.h&quot;
-#include &quot;Lua/LuaParser.h&quot;
 #include &quot;Map/MapParser.h&quot;
-#include &quot;Map/ReadMap.h&quot;
 #include &quot;Rendering/Textures/TAPalette.h&quot;
 #include &quot;System/UnsyncedRNG.h&quot;
 #include &quot;System/Exceptions.h&quot;
@@ -29,10 +24,10 @@
 const CGameSetup* gameSetup = NULL;
 
 LocalSetup::LocalSetup() :
-		autohostport(0),
-		hostport(8452),
 		myPlayerNum(0),
+		hostport(8452),
 		sourceport(0),
+		autohostport(0),
 		isHost(true)
 {
 }
@@ -71,7 +66,7 @@
 	}
 	
 	int tmp_isHost;
-	file.GetDef(myPlayerNum,  &quot;-1&quot;, &quot;GAME\\IsHost&quot;);
+	file.GetDef(tmp_isHost,  &quot;-1&quot;, &quot;GAME\\IsHost&quot;);
 	if (tmp_isHost == 1)
 		isHost = true;
 	else if (tmp_isHost == 0)
@@ -106,7 +101,6 @@
 
 CGameSetup::CGameSetup()
 {
-	gameSetupText=0;
 	startPosType=StartPos_Fixed;
 	numDemoPlayers=0;
 	hostDemo=false;
@@ -114,25 +108,11 @@
 
 CGameSetup::~CGameSetup()
 {
-	if (gameSetupText)
-		delete[] gameSetupText;
 }
 
-bool CGameSetup::Init(std::string setupFile)
+bool CGameSetup::Init(std::string script)
 {
-	if(setupFile.empty())
-		return false;
-	CFileHandler fh(setupFile);
-	if (!fh.FileExists())
-		return false;
-	char* c=SAFE_NEW char[fh.FileSize()];
-	fh.Read(c,fh.FileSize());
-
-	bool ret=Init(c,fh.FileSize());
-
-	delete[] c;
-
-	return ret;
+	return Init(script.c_str(), script.size());
 }
 
 /**
@@ -182,12 +162,12 @@
 void CGameSetup::LoadStartPositions()
 {
 	TdfParser file;
-	file.LoadBuffer(gameSetupText, gameSetupTextLength-1);
+	file.LoadBuffer(gameSetupText.c_str(), gameSetupText.length());
 
 	if (startPosType == StartPos_Random) {
 		// Server syncs these later, so we can use unsynced rng
 		UnsyncedRNG rng;
-		rng.Seed(gameSetupTextLength ^ SDL_GetTicks());
+		rng.Seed(gameSetupText.length()^ SDL_GetTicks());
 		int teamStartNum[MAX_TEAMS];
 		for (int i = 0; i &lt; MAX_TEAMS; ++i)
 			teamStartNum[i] = i;
@@ -304,7 +284,8 @@
 		}
 
 		// Get default color from palette (based on &quot;color&quot; tag)
-		int colorNum = atoi(file.SGetValueDef(&quot;0&quot;, s + &quot;color&quot;).c_str());
+		int colorNum = atoi(file.SGetValueDef(&quot;-1&quot;, s + &quot;color&quot;).c_str());
+		if (colorNum == -1) colorNum = a;
 		colorNum %= palette.NumTeamColors();
 		float3 defaultCol(palette.teamColor[colorNum][0] / 255.0f, palette.teamColor[colorNum][1] / 255.0f, palette.teamColor[colorNum][2] / 255.0f);
 
@@ -325,13 +306,19 @@
 		// If this is a demo replay, non-Lua AIs aren't loaded.
 		data.luaAI = file.SGetValueDef(&quot;&quot;, s + &quot;aispecifier&quot;);
 		if (data.luaAI.empty()) {
-			data.luaAI = file.SGetValueDef(&quot;&quot;, s + &quot;luaai&quot;);
+			data.luaAI = file.SGetValueDef(&quot;&quot;, s + &quot;LuaAI&quot;);
+		// this else if is only here fo rbackwards compatibility
 		} else if (data.luaAI.size() &gt; 6 &amp;&amp; data.luaAI.substr(0, 6) == &quot;LuaAI:&quot;) {
 			data.luaAI = data.luaAI.substr(6);
 		}
-		data.skirmishAIShortName = file.SGetValueDef(&quot;&quot;, s + &quot;ainame&quot;);
-		data.skirmishAIVersion = file.SGetValueDef(&quot;&quot;, s + &quot;aiversion&quot;);
 		
+		string aiS(s + &quot;AI\\&quot;);
+		data.skirmishAIShortName = file.SGetValueDef(&quot;&quot;, aiS + &quot;Name&quot;);
+		data.skirmishAIVersion = file.SGetValueDef(&quot;&quot;, aiS + &quot;Version&quot;);
+		if (file.SectionExist(aiS + &quot;Options&quot;)) {
+			data.skirmishAIOptions = file.GetAllValues(aiS + &quot;Options&quot;);
+		}
+		
 		teamStartingData.push_back(data);
 
 		teamRemap[a] = i;
@@ -445,10 +432,7 @@
 bool CGameSetup::Init(const char* buf, int size)
 {
 	// Copy buffer contents
-	gameSetupText = SAFE_NEW char[size+1];
-	memcpy(gameSetupText, buf, size);
-	gameSetupText[size] = 0;
-	gameSetupTextLength = size;
+	gameSetupText.assign(buf,size);
 
 	// Parse
 	TdfParser file;

Modified: branches/caiinterface/rts/Game/GameSetup.h
===================================================================
--- branches/caiinterface/rts/Game/GameSetup.h	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/Game/GameSetup.h	2008-11-04 09:57:36 UTC (rev 6975)
@@ -34,7 +34,7 @@
 public:
 	CGameSetup();
 	~CGameSetup();
-	bool Init(std::string setupFile);
+	bool Init(std::string script);
 	bool Init(const char* buf, int size);
 	void LoadStartPositions();
 	
@@ -60,8 +60,7 @@
 	std::string luaGaiaStr;
 	std::string luaRulesStr;
 	
-	char* gameSetupText;
-	int gameSetupTextLength;
+	std::string gameSetupText;
 	
 	StartPosType startPosType;
 	
@@ -79,6 +78,7 @@
 		std::string luaAI;
 		std::string skirmishAIShortName;
 		std::string skirmishAIVersion;
+		std::map&lt;std::string, std::string&gt; skirmishAIOptions;
 	};
 	std::vector&lt;TeamData&gt; teamStartingData;
 	

Modified: branches/caiinterface/rts/Game/GlobalSynced.cpp
===================================================================
--- branches/caiinterface/rts/Game/GlobalSynced.cpp	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/Game/GlobalSynced.cpp	2008-11-04 09:57:36 UTC (rev 6975)
@@ -142,7 +142,9 @@
 		teams[i]-&gt;energy = setup-&gt;startEnergy;
 		teams[i]-&gt;energyIncome = setup-&gt;startEnergy;
 
-		float3 start(setup-&gt;teamStartingData[i].startPos.x, setup-&gt;teamStartingData[i].startPos.y, setup-&gt;teamStartingData[i].startPos.z);
+		float3 start(setup-&gt;teamStartingData[i].startPos.x,
+				setup-&gt;teamStartingData[i].startPos.y,
+				setup-&gt;teamStartingData[i].startPos.z);
 		teams[i]-&gt;StartposMessage(start, (setup-&gt;startPosType != CGameSetup::StartPos_ChooseInGame));
 		std::memcpy(teams[i]-&gt;color, setup-&gt;teamStartingData[i].color, 4);
 		teams[i]-&gt;handicap = setup-&gt;teamStartingData[i].handicap;
@@ -152,25 +154,27 @@
 		if (!(setup-&gt;teamStartingData[i].luaAI.empty())) {
 			teams[i]-&gt;luaAI = setup-&gt;teamStartingData[i].luaAI;
 			teams[i]-&gt;isAI = true;
-		}
-		else {
+		} else if (!(setup-&gt;teamStartingData[i].skirmishAIShortName.empty())) {
 			if (setup-&gt;hostDemo) {
 				SSAIKey key = {{NULL, NULL}, {NULL, NULL}};
 				teams[i]-&gt;skirmishAISpecifier = key;
-			}
-			else
-			{
+			} else {
 				const char* sn = setup-&gt;teamStartingData[i].skirmishAIShortName.c_str();
-				const char* v = setup-&gt;teamStartingData[i].skirmishAIVersion.empty() ? NULL : setup-&gt;teamStartingData[i].skirmishAIVersion.c_str();
+				const char* v = setup-&gt;teamStartingData[i].skirmishAIVersion.empty()
+						? NULL : setup-&gt;teamStartingData[i].skirmishAIVersion.c_str();
 				SSAISpecifier spec = {sn, v};
-				std::vector&lt;SSAIKey&gt; fittingKeys = IAILibraryManager::GetInstance()-&gt;ResolveSkirmishAIKey(spec);
+				std::vector&lt;SSAIKey&gt; fittingKeys =
+						IAILibraryManager::GetInstance()-&gt;ResolveSkirmishAIKey(spec);
 				if (fittingKeys.size() &gt; 0) {
 					teams[i]-&gt;skirmishAISpecifier = fittingKeys[0];
+					teams[i]-&gt;skirmishAIOptions = setup-&gt;teamStartingData[i].skirmishAIOptions;
 					teams[i]-&gt;isAI = true;
 				} else {
 					const int MAX_MSG_LENGTH = 511;
 					char s_msg[MAX_MSG_LENGTH + 1];
-					SNPRINTF(s_msg, MAX_MSG_LENGTH, &quot;Specifyed Skirmish AI could not be found: %s (version: %s)&quot;, spec.shortName, spec.version != NULL ? spec.version : &quot;&lt;not specifyed&gt;&quot;);
+					SNPRINTF(s_msg, MAX_MSG_LENGTH,
+							&quot;Specifyed Skirmish AI could not be found: %s (version: %s)&quot;,
+							spec.shortName, spec.version != NULL ? spec.version : &quot;&lt;not specifyed&gt;&quot;);
 					handleerror(NULL, s_msg, &quot;Game Script Error&quot;, MBF_OK | MBF_EXCL);
 				}
 			}

Modified: branches/caiinterface/rts/Game/PreGame.cpp
===================================================================
--- branches/caiinterface/rts/Game/PreGame.cpp	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/Game/PreGame.cpp	2008-11-04 09:57:36 UTC (rev 6975)
@@ -5,6 +5,7 @@
 #include &lt;SDL_timer.h&gt;
 #include &lt;SDL_types.h&gt;
 #include &lt;set&gt;
+#include &lt;cfloat&gt;
 
 #include &quot;mmgr.h&quot;
 
@@ -29,26 +30,14 @@
 #include &quot;Lua/LuaRules.h&quot;
 #include &quot;Lua/LuaParser.h&quot;
 #include &quot;Map/MapParser.h&quot;
-#include &quot;Platform/Clipboard.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;Platform/FileSystem.h&quot;
-#include &quot;Rendering/glFont.h&quot;
-#include &quot;Rendering/GL/glList.h&quot;
 #include &quot;Rendering/Textures/TAPalette.h&quot;
 #include &quot;StartScripts/ScriptHandler.h&quot;
 #include &quot;UI/InfoConsole.h&quot;
-#include &quot;UI/MouseHandler.h&quot;
 #include &quot;Exceptions.h&quot;
 
-// msvc behaves really strange
-#if _MSC_VER
-namespace std {
-	using ::sin;
-}
-#endif
 
-const int springDefaultPort = 8452;
-
 CPreGame* pregame = NULL;
 using netcode::RawPacket;
 
@@ -56,101 +45,54 @@
 extern bool globalQuit;
 std::string stupidGlobalMapname;
 
-CglList* CPreGame::showList = NULL;
-std::string CPreGame::userScript;
-std::string CPreGame::userMap;
-std::string CPreGame::userMod;
 
-
-CPreGame::CPreGame(const LocalSetup* setup, const string&amp; demo, const std::string&amp; save)
-: settings(setup),
-  state(UNKNOWN),
-  hasDemo(!demo.empty()),
-  hasSave(!save.empty()),
-  gameData(0),
-  savefile(NULL)
+CPreGame::CPreGame(const LocalSetup* setup) :
+		settings(setup),
+		savefile(NULL)
 {
-	demoFile = gameSetup? gameSetup-&gt;demoName : demo;
-
-	if (!gameSetup &amp;&amp; demoFile.empty()) {
-		gs-&gt;noHelperAIs = !!configHandler.GetInt(&quot;NoHelperAIs&quot;, 0);
-		LoadLua();
-	}
-
+	localDemoHack = false;
 	infoConsole = SAFE_NEW CInfoConsole;
 
-	pregame = this; // prevent crashes if Select* is called from ctor
 	net = SAFE_NEW CNetProtocol();
 
-	//vfsHandler=SAFE_NEW CHpiHandler();
-
 	activeController=this;
 
-	if(!gameSetup){
-		for(int a=0;a&lt;gs-&gt;activeTeams;a++){
-			for(int b=0;b&lt;4;++b){
-				gs-&gt;Team(a)-&gt;color[b]=palette.teamColor[a][b];
-			}
-		}
+	if(!settings-&gt;isHost)
+	{
+		net-&gt;InitClient(settings-&gt;hostip.c_str(), settings-&gt;hostport, settings-&gt;sourceport, settings-&gt;myPlayerName, std::string(VERSION_STRING_DETAILED));
 	}
-
-	if(settings-&gt;isHost){
+	else
+	{
 		net-&gt;InitLocalClient();
-		if (!demoFile.empty())
-		{
-			ReadDataFromDemo(demoFile);
-			state = WAIT_CONNECTING;
-		}
-		else if(gameSetup){
-			StartServer(gameSetup-&gt;mapName, gameSetup-&gt;baseMod, gameSetup-&gt;scriptName);
-			state = WAIT_CONNECTING;
-		} else if (hasSave) {
-			savefile = new CLoadSaveHandler();
-			savefile-&gt;LoadGameStartInfo(savefile-&gt;FindSaveFile(save.c_str()));
-			StartServer(gameSetup-&gt;mapName, gameSetup-&gt;baseMod, gameSetup-&gt;scriptName);
-			state = WAIT_CONNECTING;
-		} else {
-			ShowModList();
-			state = WAIT_ON_USERINPUT;
-		}
-	} else {
-		if(gameSetup){
-			PrintLoadMsg(&quot;Connecting to server&quot;);
-			net-&gt;InitClient(settings-&gt;hostip.c_str(), settings-&gt;hostport, settings-&gt;sourceport, settings-&gt;myPlayerName, std::string(VERSION_STRING_DETAILED));
-			state = WAIT_CONNECTING;
-		} else {
-			if (hasDemo) {
-				net-&gt;localDemoPlayback = true;
-				state = WAIT_CONNECTING;
-				ReadDataFromDemo(demoFile); // scan for GameData
-				net-&gt;InitLocalClient();
-				if (gameSetup) {	// we read a gameSetup from the demofiles
-					logOutput.Print(&quot;Read GameSetup from Demofile&quot;);
-				}
-				else { // we dont read a GameSetup from demofile (this code was copied from CDemoReader)
-					logOutput.Print(&quot;Demo file does not contain a setupscript&quot;);
-					LoadLua();
-				}
-			}
-			else {
-				PrintLoadMsg(&quot;Connecting to server&quot;);
-				net-&gt;InitClient(settings-&gt;hostip.c_str(), settings-&gt;hostport, settings-&gt;sourceport, settings-&gt;myPlayerName, std::string(VERSION_STRING_DETAILED));
-				state = WAIT_CONNECTING;
-			}
-		}
 	}
-	assert(state != UNKNOWN);
 }
 
 
 CPreGame::~CPreGame()
 {
-	delete gameData;
-	delete infoConsole;
-	infoConsole = 0;
+	// don't delete infoconsole, its beeing reused by CGame
 }
 
+void CPreGame::LoadSetupscript(const std::string&amp; script)
+{
+	assert(settings-&gt;isHost);
+	StartServer(script);
+}
 
+void CPreGame::LoadDemo(const std::string&amp; demo)
+{
+	assert(settings-&gt;isHost);
+	ReadDataFromDemo(demo);
+}
+
+void CPreGame::LoadSavefile(const std::string&amp; save)
+{
+	assert(settings-&gt;isHost);
+	savefile = new CLoadSaveHandler();
+	savefile-&gt;LoadGameStartInfo(savefile-&gt;FindSaveFile(save.c_str()));
+	StartServer(savefile-&gt;scriptText);
+}
+
 int CPreGame::KeyPressed(unsigned short k,bool isRepeat)
 {
 	if (k == SDLK_ESCAPE){
@@ -160,11 +102,6 @@
 		} else
 			logOutput.Print(&quot;Use shift-esc to quit&quot;);
 	}
-	if (showList) { //are we currently showing a list?
-		showList-&gt;KeyPressed(k, isRepeat);
-		return 0;
-	}
-
 	return 0;
 }
 
@@ -172,39 +109,21 @@
 bool CPreGame::Draw()
 {
 	SDL_Delay(10); // milliseconds
-	if (!gu-&gt;active) {
-		return true;
+	
+	if (!net-&gt;Connected())
+	{
+		if ( ((SDL_GetTicks()/1000) % 2) == 0 )
+			PrintLoadMsg(&quot;Connecting to server .&quot;, false);
+		else
+			PrintLoadMsg(&quot;Connecting to server  &quot;, false);
 	}
-
-	if (showList) {
-		PrintLoadMsg(&quot;&quot;, false); // just clear screen and set up matrices etc.
+	else
+	{
+		PrintLoadMsg(&quot;Awaiting server response&quot;, false);
 	}
-	else {
-		switch (state) {
-			case WAIT_ON_GAMEDATA:
-				PrintLoadMsg(&quot;Waiting on game data&quot;, false);
-				break;
-			case WAIT_CONNECTING:
-				if ( ((SDL_GetTicks()/1000) % 2) == 0 )
-					PrintLoadMsg(&quot;Connecting to server .&quot;, false);
-				else
-					PrintLoadMsg(&quot;Connecting to server  &quot;, false);
-				break;
-			case UNKNOWN:
-			case WAIT_ON_USERINPUT:
-			case ALL_READY:
-			default:
-				PrintLoadMsg(&quot;&quot;, false); // just clear screen and set up matrices etc.
-				break;
-		}
-	}
 
 	infoConsole-&gt;Draw();
 
-	if (showList) {
-		showList-&gt;Draw();
-	}
-
 	return true;
 }
 
@@ -212,71 +131,23 @@
 bool CPreGame::Update()
 {
 	good_fpu_control_registers(&quot;CPreGame::Update&quot;);
+	net-&gt;Update();
+	UpdateClientNet();
 
-	switch (state) {
-
-		case UNKNOWN:
-			logOutput.Print(&quot;Internal error in CPreGame&quot;);
-			return false;
-
-		case WAIT_ON_USERINPUT: {
-			break;
-		}
-
-		case WAIT_CONNECTING:
-			if (net-&gt;Connected())
-				state = WAIT_ON_GAMEDATA; // fall through
-			else
-				break; // abort
-
-		case WAIT_ON_GAMEDATA: {
-			if (gameData) // we recieved tha gameData
-				state = ALL_READY;
-			else
-				break;
-		}
-
-		case ALL_READY: {
-			ENTER_MIXED;
-			const int teamID = gs-&gt;players[gu-&gt;myPlayerNum]-&gt;team;
-			const CTeam* team = gs-&gt;Team(teamID);
-			assert(team);
-			if (net-&gt;localDemoPlayback) {
-				gs-&gt;players[gu-&gt;myPlayerNum]-&gt;StartSpectating();
-			}
-			LoadStartPicture(team-&gt;side);
-
-			game = SAFE_NEW CGame(gameData-&gt;GetMap(), modArchive, infoConsole, savefile);
-
-			if (savefile) {
-				savefile-&gt;LoadGame();
-			}
-
-			infoConsole = 0;
-
-			ENTER_UNSYNCED;
-			pregame=0;
-			delete this;
-			return true;
-		}
-		default:
-			assert(false);
-			break;
-	}
-
-	if(state &gt;= WAIT_CONNECTING){
-		net-&gt;Update();
-		UpdateClientNet();
-	}
-
 	return true;
 }
 
 
-void CPreGame::StartServer(std::string map, std::string mod, std::string script)
+void CPreGame::StartServer(const std::string&amp; setupscript)
 {
 	assert(!gameServer);
 	GameData* startupData = new GameData();
+	CGameSetup* setup = new CGameSetup();
+	setup-&gt;Init(setupscript);
+	std::string map = setup-&gt;mapName;
+	std::string mod = setup-&gt;baseMod;
+	std::string script = setup-&gt;scriptName;
+	
 	startupData-&gt;SetRandomSeed(static_cast&lt;unsigned&gt;(gu-&gt;usRandInt()));
 	bool mapHasStartscript = false;
 	if (!map.empty())
@@ -333,6 +204,7 @@
 		}
 	}
 	startupData-&gt;SetMap(map, archiveScanner-&gt;GetMapChecksum(map));
+	setup-&gt;LoadStartPositions();
 
 	if (gameSetup) {
 		const_cast&lt;CGameSetup*&gt;(gameSetup)-&gt;LoadStartPositions(); // only host needs to do this, because
@@ -340,11 +212,8 @@
 	}
 	
 	good_fpu_control_registers(&quot;before CGameServer creation&quot;);
-	int myPort = settings-&gt;hostport;
-	gameServer = new CGameServer(myPort, false, startupData, gameSetup, demoFile);
-	if (settings-&gt;autohostport &gt; 0) {
-		gameServer-&gt;AddAutohostInterface(settings-&gt;autohostport);
-	}
+	startupData-&gt;SetSetup(setup-&gt;gameSetupText);
+	gameServer = new CGameServer(settings.get(), false, startupData, setup);
 	gameServer-&gt;AddLocalClient(settings-&gt;myPlayerName, std::string(VERSION_STRING_DETAILED));
 	good_fpu_control_registers(&quot;after CGameServer creation&quot;);
 }
@@ -352,11 +221,6 @@
 
 void CPreGame::UpdateClientNet()
 {
-	if (gameData)
-	{
-		logOutput.Print(&quot;Warning: game should have started before&quot;);
-		return;
-	}
 	if (!net-&gt;Active())
 	{
 		logOutput.Print(&quot;Server not reachable&quot;);
@@ -372,10 +236,25 @@
 			case NETMSG_SETPLAYERNUM: {
 				gu-&gt;SetMyPlayer(packet-&gt;data[1]);
 				logOutput.Print(&quot;Became player %i&quot;, gu-&gt;myPlayerNum);
-			} break;
+				
+				const int teamID = gs-&gt;players[gu-&gt;myPlayerNum]-&gt;team;
+				const CTeam* team = gs-&gt;Team(teamID);
+				assert(team);
+				LoadStartPicture(team-&gt;side);
+
+				game = SAFE_NEW CGame(gameData-&gt;GetMap(), modArchive, infoConsole, savefile);
+
+				if (savefile) {
+					savefile-&gt;LoadGame();
+				}
+
+				pregame=0;
+				delete this;
+				return;
+			}
 			case NETMSG_GAMEDATA: {
 				GameDataReceived(packet);
-				return;
+				break;
 			}
 			default: {
 				logOutput.Print(&quot;Unknown net-msg recieved from CPreGame: %i&quot;, int(packet-&gt;data[0]));
@@ -390,27 +269,43 @@
 {
 	assert(!gameServer);
 	logOutput.Print(&quot;Pre-scanning demo file for game data...&quot;);
-	bool hasSetup = static_cast&lt;bool&gt;(gameSetup);
 	CDemoReader scanner(demoName, 0);
-	bool demoSetup = static_cast&lt;bool&gt;(gameSetup);
-	if (demoSetup &amp;&amp; ! hasSetup)
-	{
-		//HACK: make gs read the setup if we just read it out of the demofile
-		gs-&gt;LoadFromSetup(gameSetup);
-		gu-&gt;SetMyPlayer(0); //HACK load data for player 0
-	}
 
-	if (!hasSetup)
-		gu-&gt;SetMyPlayer(scanner.GetFileHeader().maxPlayerNum + 1); //HACK pt. #2: set real player num
-
-	boost::shared_ptr&lt;const RawPacket&gt; buf(scanner.GetData(static_cast&lt;float&gt;(INT_MAX)));
+	boost::shared_ptr&lt;const RawPacket&gt; buf(scanner.GetData(static_cast&lt;float&gt;(FLT_MAX )));
 	while ( buf )
 	{
 		if (buf-&gt;data[0] == NETMSG_GAMEDATA)
 		{
 			GameData *data = new GameData(boost::shared_ptr&lt;const RawPacket&gt;(buf));
+			CGameSetup* tempSetup = new CGameSetup();
+			if (tempSetup-&gt;Init(data-&gt;GetSetup()))
+			{
+				tempSetup-&gt;scriptName = data-&gt;GetScript();
+				tempSetup-&gt;mapName = data-&gt;GetMap();
+				tempSetup-&gt;baseMod = data-&gt;GetMod();
+				tempSetup-&gt;hostDemo = true;
+				tempSetup-&gt;demoName = demoName;
+				
+				// all players in the setupscript are from demo
+				for (std::vector&lt;PlayerBase&gt;::iterator it = tempSetup-&gt;playerStartingData.begin(); it != tempSetup-&gt;playerStartingData.end(); ++it)
+					it-&gt;isFromDemo = true;
+				
+				// add myself to the script
+				PlayerBase myPlayer;
+				myPlayer.name = settings-&gt;myPlayerName;
+				myPlayer.spectator = true;
+				tempSetup-&gt;playerStartingData.push_back(myPlayer);
+				tempSetup-&gt;numDemoPlayers = std::max(scanner.GetFileHeader().maxPlayerNum+1, tempSetup-&gt;numPlayers);
+				tempSetup-&gt;numPlayers = tempSetup-&gt;numDemoPlayers+1;
+				tempSetup-&gt;maxSpeed = 10;
+				localDemoHack = true;
+			}
+			else
+			{
+				throw content_error(&quot;Server sent us incorrect script&quot;);
+			}
 			good_fpu_control_registers(&quot;before CGameServer creation&quot;);
-			gameServer = new CGameServer(settings-&gt;hostport, false, data, gameSetup, demoName);
+			gameServer = new CGameServer(settings.get(), true, data, tempSetup);
 			gameServer-&gt;AddLocalClient(settings-&gt;myPlayerName, std::string(VERSION_STRING_DETAILED));
 			good_fpu_control_registers(&quot;after CGameServer creation&quot;);
 			break;
@@ -420,112 +315,12 @@
 		{
 			throw content_error(&quot;End of demo reached and no game data found&quot;);
 		}
-		buf.reset(scanner.GetData(static_cast&lt;float&gt;(INT_MAX)));
+		buf.reset(scanner.GetData(static_cast&lt;float&gt;(FLT_MAX )));
 	}
+
 	assert(gameServer);
 }
 
-
-/** Create a CglList for selecting the map. */
-void CPreGame::ShowMapList()
-{
-	CglList* list = SAFE_NEW CglList(&quot;Select map&quot;, SelectMap, 2);
-	std::vector&lt;std::string&gt; found = filesystem.FindFiles(&quot;maps/&quot;,&quot;{*.sm3,*.smf}&quot;);
-	std::vector&lt;std::string&gt; arFound = archiveScanner-&gt;GetMaps();
-	if (found.begin() == found.end() &amp;&amp; arFound.begin() == arFound.end()) {
-		throw content_error(&quot;PreGame couldn't find any map files&quot;);
-		return;
-	}
-
-	std::set&lt;std::string&gt; mapSet; // use a set to sort them
-	for (std::vector&lt;std::string&gt;::iterator it = found.begin(); it != found.end(); it++) {
-		std::string fn(filesystem.GetFilename(*it));
-		mapSet.insert(fn.c_str());
-	}
-	for (std::vector&lt;std::string&gt;::iterator it = arFound.begin(); it != arFound.end(); it++) {
-		mapSet.insert((*it).c_str());
-	}
-
-	list-&gt;AddItem(&quot;Random map&quot;, &quot;Random map&quot;); // always first
-	for (std::set&lt;std::string&gt;::iterator sit = mapSet.begin(); sit != mapSet.end(); ++sit) {
-		list-&gt;AddItem(sit-&gt;c_str(), sit-&gt;c_str());
-	}
-	showList = list;
-}
-
-
-/** Create a CglList for selecting the script. */
-void CPreGame::ShowScriptList()
-{
-	CglList* list = CScriptHandler::Instance().GenList(SelectScript);
-	showList = list;
-}
-
-
-/** Create a CglList for selecting the mod. */
-void CPreGame::ShowModList()
-{
-	CglList* list = SAFE_NEW CglList(&quot;Select mod&quot;, SelectMod, 3);
-	std::vector&lt;CArchiveScanner::ModData&gt; found = archiveScanner-&gt;GetPrimaryMods();
-	if (found.empty()) {
-		throw content_error(&quot;PreGame couldn't find any mod files&quot;);
-		return;
-	}
-
-	std::map&lt;std::string, std::string&gt; modMap; // name, desc  (using a map to sort)
-	for (std::vector&lt;CArchiveScanner::ModData&gt;::iterator it = found.begin(); it != found.end(); ++it) {
-		modMap[it-&gt;name] = it-&gt;description;
-	}
-
-	list-&gt;AddItem(&quot;Random mod&quot;, &quot;Random mod&quot;); // always first
-	std::map&lt;std::string, std::string&gt;::iterator mit;
-	for (mit = modMap.begin(); mit != modMap.end(); ++mit) {
-		list-&gt;AddItem(mit-&gt;first.c_str(), mit-&gt;second.c_str());
-	}
-	showList = list;
-}
-
-
-void CPreGame::SelectMap(std::string s)
-{
-	if (s == &quot;Random map&quot;) {
-		s = pregame-&gt;showList-&gt;items[1 + gu-&gt;usRandInt() % (showList-&gt;items.size() - 1)];
-	}
-
-	delete showList;
-	showList = NULL;
-
-	userMap = s;
-	pregame-&gt;StartServer(userMap, userMod, userScript);
-	pregame-&gt;state = WAIT_CONNECTING;
-}
-
-
-void CPreGame::SelectScript(std::string s)
-{
-	delete showList;
-	showList = NULL;
-
-	userScript = s;
-	pregame-&gt;ShowMapList();
-}
-
-
-void CPreGame::SelectMod(std::string s)
-{
-	if (s == &quot;Random mod&quot;) {
-		const int index = 1 + (gu-&gt;usRandInt() % (showList-&gt;items.size() - 1));
-		s = showList-&gt;items[index];
-	}
-
-	delete showList;
-	showList = NULL;
-
-	userMod = s;
-	pregame-&gt;ShowScriptList();
-}
-
-
 void CPreGame::LoadMap(const std::string&amp; mapName, const bool forceReload)
 {
 	static bool alreadyLoaded = false;
@@ -594,8 +389,41 @@
 
 void CPreGame::GameDataReceived(boost::shared_ptr&lt;const netcode::RawPacket&gt; packet)
 {
-	gameData = new GameData(packet);
+	gameData.reset(new GameData(packet));
 	
+	CGameSetup* temp = new CGameSetup();
+	if (temp-&gt;Init(gameData-&gt;GetSetup()))
+	{
+		temp-&gt;scriptName = gameData-&gt;GetScript();
+		temp-&gt;mapName = gameData-&gt;GetMap();
+		temp-&gt;baseMod = gameData-&gt;GetMod();
+		
+		if (localDemoHack)
+		{
+			temp-&gt;hostDemo = true;
+				
+				// all players in the setupscript are from demo
+			for (std::vector&lt;PlayerBase&gt;::iterator it = temp-&gt;playerStartingData.begin(); it != temp-&gt;playerStartingData.end(); ++it)
+				it-&gt;isFromDemo = true;
+				
+			// add myself to the script
+			PlayerBase myPlayer;
+			myPlayer.name = settings-&gt;myPlayerName;
+			myPlayer.spectator = true;
+			temp-&gt;playerStartingData.push_back(myPlayer);
+			temp-&gt;numDemoPlayers = temp-&gt;numPlayers;
+			temp-&gt;numPlayers = temp-&gt;numDemoPlayers+1;
+			temp-&gt;maxSpeed = 10;
+		}
+		gameSetup = const_cast&lt;const CGameSetup*&gt;(temp);
+		gs-&gt;LoadFromSetup(gameSetup);
+		LoadLua();
+	}
+	else
+	{
+		throw content_error(&quot;Server sent us incorrect script&quot;);
+	}
+	
 	gs-&gt;SetRandSeed(gameData-&gt;GetRandomSeed(), true);
 	logOutput &lt;&lt; &quot;Using map &quot; &lt;&lt; gameData-&gt;GetMap() &lt;&lt; &quot;\n&quot;;
 	stupidGlobalMapname = gameData-&gt;GetMap();
@@ -615,9 +443,4 @@
 	modArchive = archiveScanner-&gt;ModNameToModArchive(gameData-&gt;GetMod());
 	archiveScanner-&gt;CheckMod(modArchive, gameData-&gt;GetModChecksum());
 	
-	if (gameSetup) {
-		const_cast&lt;CGameSetup*&gt;(gameSetup)-&gt;scriptName = gameData-&gt;GetScript();
-		const_cast&lt;CGameSetup*&gt;(gameSetup)-&gt;mapName = gameData-&gt;GetMap();
-		const_cast&lt;CGameSetup*&gt;(gameSetup)-&gt;baseMod = gameData-&gt;GetMod();
-	}
 }

Modified: branches/caiinterface/rts/Game/PreGame.h
===================================================================
--- branches/caiinterface/rts/Game/PreGame.h	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/Game/PreGame.h	2008-11-04 09:57:36 UTC (rev 6975)
@@ -7,7 +7,6 @@
 
 #include &quot;GameController.h&quot;
 
-class CglList;
 class CInfoConsole;
 class CLoadSaveHandler;
 class GameData;
@@ -34,15 +33,19 @@
 class CPreGame : public CGameController
 {
 public:
-	CPreGame(const LocalSetup* setup, const std::string&amp; demo, const std::string&amp; save);
+	CPreGame(const LocalSetup* setup);
 	virtual ~CPreGame();
+	
+	void LoadSetupscript(const std::string&amp; script);
+	void LoadDemo(const std::string&amp; demo);
+	void LoadSavefile(const std::string&amp; save);
 
 	bool Draw();
 	int KeyPressed(unsigned short k, bool isRepeat);
 	bool Update();
 
 private:
-	void StartServer(std::string map, std::string mod, std::string script);
+	void StartServer(const std::string&amp; setupscript);
 	
 	/// reads out map, mod and script from demos (with or without a gameSetupScript)
 	void ReadDataFromDemo(const std::string&amp; demoName);
@@ -52,50 +55,27 @@
 
 	CInfoConsole* infoConsole;
 
-	void ShowMapList();
-	void ShowScriptList();
-	void ShowModList();
-	static CglList* showList;
-	
-	/// Choose the script we will tell the server to start with
-	static void SelectScript(std::string s);
-	static void SelectMap(std::string s);
-	static void SelectMod(std::string s);
-	static std::string userScript;
-	static std::string userMap;
-	static std::string userMod;
-
 	/// Load map and dependend archives into archive scanner
-	static void LoadMap(const std::string&amp; mapName, const bool forceReload = false);
+	void LoadMap(const std::string&amp; mapName, const bool forceReload = false);
 	
 	/// Map all required archives depending on selected mod(s)
-	static void LoadMod(const std::string&amp; modName);
+	void LoadMod(const std::string&amp; modName);
 	
 	void LoadLua();
 
 	void GameDataReceived(boost::shared_ptr&lt;const netcode::RawPacket&gt; packet);
-	
-	enum State {
-		UNKNOWN,
-		WAIT_ON_USERINPUT, // wait for user to set script, map, mod
-		WAIT_CONNECTING, // connecting to server
-		WAIT_ON_GAMEDATA, // wait for the server to send us the GameData
-		ALL_READY, // ready to start
-	};
-	State state;
 
-	const bool hasDemo,hasSave;
-
 	/**
 	@brief GameData we recieved from server
 	
 	We won't start until we recieved this
 	*/
-	const GameData* gameData;
+	boost::scoped_ptr&lt;const GameData&gt; gameData;
 	boost::scoped_ptr&lt;const LocalSetup&gt; settings;
 	std::string modArchive;
-	std::string demoFile;
 	CLoadSaveHandler *savefile;
+	
+	bool localDemoHack;
 };
 
 extern CPreGame* pregame;

Modified: branches/caiinterface/rts/Game/SelectMenu.cpp
===================================================================
--- branches/caiinterface/rts/Game/SelectMenu.cpp	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/Game/SelectMenu.cpp	2008-11-04 09:57:36 UTC (rev 6975)
@@ -1,17 +1,25 @@
 #include &quot;SelectMenu.h&quot;
+#include &quot;Rendering/GL/myGL.h&quot;
 
 #include &lt;SDL_keysym.h&gt;
 #include &lt;SDL_timer.h&gt;
 #include &lt;SDL_types.h&gt;
+#include &lt;boost/bind.hpp&gt;
+#include &lt;sstream&gt;
+#include &lt;stack&gt;
 
 #include &quot;GameSetup.h&quot;
 #include &quot;PreGame.h&quot;
-#include &quot;Platform/Clipboard.h&quot;
-#include &quot;Platform/ConfigHandler.h&quot;
-#include &quot;LogOutput.h&quot;
-#include &quot;Util.h&quot;
-#include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Rendering/glFont.h&quot;
+#include &quot;Rendering/GL/glList.h&quot;
+#include &quot;System/LogOutput.h&quot;
+#include &quot;System/Exceptions.h&quot;
+#include &quot;System/FileSystem/ArchiveScanner.h&quot;
+#include &quot;System/FileSystem/FileHandler.h&quot;
+#include &quot;System/FileSystem/VFSHandler.h&quot;
+#include &quot;System/Platform/FileSystem.h&quot;
+#include &quot;System/Platform/ConfigHandler.h&quot;
+#include &quot;StartScripts/ScriptHandler.h&quot;
 
 using std::string;
 
@@ -19,15 +27,107 @@
 extern bool globalQuit;
 
 
-SelectMenu::SelectMenu(bool server) : isServer(server)
+class TdfWriter
 {
-	if (!isServer)
+public:
+	void PushSection(const std::string&amp; section)
 	{
+		Indent();
+		str &lt;&lt; &quot;[&quot;&lt;&lt;section&lt;&lt;&quot;]\n{\n&quot;;
+		sections.push(section);
+	};
+	void PopSection()
+	{
+		assert(!sections.empty());
+		Indent();
+		str &lt;&lt; &quot;} //&quot;&lt;&lt; sections.top() &lt;&lt; &quot;\n&quot;;
+		sections.pop();
+	};
+	
+	template&lt;typename T&gt;
+	void AddPair(const std::string&amp; key, const T&amp; value)
+	{
+		Indent();
+		str &lt;&lt; key &lt;&lt; &quot;=&quot; &lt;&lt; value &lt;&lt; &quot;;\n&quot;;
+	};
+	
+	std::string Get() const
+	{
+		return str.str();
+	};
+	
+private:
+	void Indent()
+	{
+		for (unsigned i = 0; i &lt; sections.size(); ++i)
+		str &lt;&lt; &quot;    &quot;;
+	};
+
+	std::ostringstream str;
+	std::stack&lt;std::string&gt; sections;
+};
+
+std::string CreateDefaultSetup(const std::string&amp; map, const std::string&amp; mod, const std::string&amp; script, const std::string&amp; playername)
+{
+	TdfWriter setup;
+	setup.PushSection(&quot;GAME&quot;);
+	setup.AddPair(&quot;Mapname&quot;, map);
+	setup.AddPair(&quot;Gametype&quot;, mod);
+	setup.AddPair(&quot;Scriptname&quot;, script);
+	
+	setup.AddPair(&quot;IsHost&quot;, 1);
+	setup.AddPair(&quot;MyPlayerName&quot;, playername);
+	
+	setup.AddPair(&quot;NoHelperAIs&quot;, configHandler.GetInt(&quot;NoHelperAIs&quot;, 0));
+	
+	setup.PushSection(&quot;PLAYER0&quot;);
+	setup.AddPair(&quot;Name&quot;, playername);
+	setup.AddPair(&quot;Team&quot;, 0);
+	setup.PopSection();
+	
+	setup.PushSection(&quot;PLAYER1&quot;);
+	setup.AddPair(&quot;Name&quot;, &quot;Enemy&quot;);
+	setup.AddPair(&quot;Team&quot;, 1);
+	setup.PopSection();
+	
+	setup.PushSection(&quot;TEAM0&quot;);
+	setup.AddPair(&quot;Leader&quot;, 0);
+	setup.AddPair(&quot;AllyTeam&quot;, 0);
+	setup.PopSection();
+	
+	setup.PushSection(&quot;TEAM1&quot;);
+	setup.AddPair(&quot;AllyTeam&quot;, 1);
+	setup.PopSection();
+	
+	setup.PushSection(&quot;ALLYTEAM0&quot;);
+	setup.AddPair(&quot;NumAllies&quot;, 0);
+	setup.PopSection();
+	
+	setup.PushSection(&quot;ALLYTEAM1&quot;);
+	setup.AddPair(&quot;NumAllies&quot;, 0);
+	setup.PopSection();
+	setup.PopSection();
+	
+	return setup.Get();
+}
+
+SelectMenu::SelectMenu(bool server) :
+		showList(NULL)
+{
+	mySettings = new LocalSetup();
+	mySettings-&gt;isHost = server;
+	mySettings-&gt;myPlayerName = configHandler.GetString(&quot;name&quot;, &quot;unnamed&quot;);
+	if (!mySettings-&gt;isHost)
+	{
 		userInput=configHandler.GetString(&quot;address&quot;,&quot;&quot;);
 		writingPos = userInput.length();
 		userPrompt = &quot;Enter server address: &quot;;
 		userWriting = true;
 	}
+	else
+	{
+		ShowModList();
+	}
 }
 
 
@@ -41,13 +141,15 @@
 			logOutput.Print(&quot;Use shift-esc to quit&quot;);
 	}
 
+	if (showList) { //are we currently showing a list?
+		showList-&gt;KeyPressed(k, isRepeat);
+		return 0;
+	}
+
 	if (userWriting) {
 		keys[k] = true;
 		if (k == SDLK_v &amp;&amp; keys[SDLK_LCTRL]){
-			CClipboard clipboard;
-			const string text = clipboard.GetContents();
-			userInput.insert(writingPos, text);
-			writingPos += text.length();
+			PasteClipboard();
 			return 0;
 		}
 		if(k == SDLK_BACKSPACE){
@@ -115,35 +217,131 @@
 		glColor4f(1.0f, 1.0f, 1.0f, 1.0f);
 		font-&gt;glPrintAt(xStart, yStart, fontScale, tempstring.c_str());
 	}
+	
+	if (showList) {
+		showList-&gt;Draw();
+	}
 
 	return true;
 }
 
 bool SelectMenu::Update()
 {
-	if (isServer)
+	if (!mySettings-&gt;isHost)
 	{
-		LocalSetup* mySettings = new LocalSetup();
-		mySettings-&gt;myPlayerName = configHandler.GetString(&quot;name&quot;, &quot;unnamed&quot;);
-		mySettings-&gt;isHost = true;
-		pregame = new CPreGame(mySettings, &quot;&quot;, &quot;&quot;);
-		delete this;
-	}
-	else
-	{
 		// we are a client, wait for user to type address
 		if (!userWriting)
 		{
 			configHandler.SetString(&quot;address&quot;,userInput);
-			LocalSetup* mySettings = new LocalSetup();
-			mySettings-&gt;myPlayerName = configHandler.GetString(&quot;name&quot;, &quot;unnamed&quot;);
 			mySettings-&gt;hostip = userInput;
-			mySettings-&gt;isHost = false;
-			pregame = new CPreGame(mySettings, &quot;&quot;, &quot;&quot;);
+			pregame = new CPreGame(mySettings);
 			delete this;
 		}
 	}
 
-
 	return true;
 }
+
+/** Create a CglList for selecting the map. */
+void SelectMenu::ShowMapList()
+{
+	CglList* list = new CglList(&quot;Select map&quot;, boost::bind(&amp;SelectMenu::SelectMap, this, _1), 2);
+	std::vector&lt;std::string&gt; found = filesystem.FindFiles(&quot;maps/&quot;,&quot;{*.sm3,*.smf}&quot;);
+	std::vector&lt;std::string&gt; arFound = archiveScanner-&gt;GetMaps();
+	if (found.begin() == found.end() &amp;&amp; arFound.begin() == arFound.end()) {
+		throw content_error(&quot;PreGame couldn't find any map files&quot;);
+		return;
+	}
+
+	std::set&lt;std::string&gt; mapSet; // use a set to sort them
+	for (std::vector&lt;std::string&gt;::iterator it = found.begin(); it != found.end(); it++) {
+		std::string fn(filesystem.GetFilename(*it));
+		mapSet.insert(fn.c_str());
+	}
+	for (std::vector&lt;std::string&gt;::iterator it = arFound.begin(); it != arFound.end(); it++) {
+		mapSet.insert((*it).c_str());
+	}
+
+	list-&gt;AddItem(&quot;Random map&quot;, &quot;Random map&quot;); // always first
+	for (std::set&lt;std::string&gt;::iterator sit = mapSet.begin(); sit != mapSet.end(); ++sit) {
+		list-&gt;AddItem(sit-&gt;c_str(), sit-&gt;c_str());
+	}
+	showList = list;
+}
+
+
+/** Create a CglList for selecting the script. */
+void SelectMenu::ShowScriptList()
+{
+	CglList* list = CScriptHandler::Instance().GenList(boost::bind(&amp;SelectMenu::SelectScript, this, _1));
+	showList = list;
+}
+
+
+/** Create a CglList for selecting the mod. */
+void SelectMenu::ShowModList()
+{
+	CglList* list = new CglList(&quot;Select mod&quot;, boost::bind(&amp;SelectMenu::SelectMod, this, _1), 3);
+	std::vector&lt;CArchiveScanner::ModData&gt; found = archiveScanner-&gt;GetPrimaryMods();
+	if (found.empty()) {
+		throw content_error(&quot;PreGame couldn't find any mod files&quot;);
+		return;
+	}
+
+	std::map&lt;std::string, std::string&gt; modMap; // name, desc  (using a map to sort)
+	for (std::vector&lt;CArchiveScanner::ModData&gt;::iterator it = found.begin(); it != found.end(); ++it) {
+		modMap[it-&gt;name] = it-&gt;description;
+	}
+
+	list-&gt;AddItem(&quot;Random mod&quot;, &quot;Random mod&quot;); // always first
+	std::map&lt;std::string, std::string&gt;::iterator mit;
+	for (mit = modMap.begin(); mit != modMap.end(); ++mit) {
+		list-&gt;AddItem(mit-&gt;first.c_str(), mit-&gt;second.c_str());
+	}
+	showList = list;
+}
+
+
+void SelectMenu::SelectMap(const std::string&amp; s)
+{
+	if (s == &quot;Random map&quot;) {
+		userMap = showList-&gt;items[1 + gu-&gt;usRandInt() % (showList-&gt;items.size() - 1)];
+	}
+	else
+		userMap = s;
+
+	delete showList;
+	showList = NULL;
+	
+	pregame = new CPreGame(mySettings);
+	pregame-&gt;LoadSetupscript(CreateDefaultSetup(userMap, userMod, userScript, mySettings-&gt;myPlayerName));
+	delete this;
+}
+
+
+void SelectMenu::SelectScript(const std::string&amp; s)
+{
+	userScript = s;
+
+	delete showList;
+	showList = NULL;
+
+	ShowMapList();
+}
+
+
+void SelectMenu::SelectMod(const std::string&amp; s)
+{
+	if (s == &quot;Random mod&quot;) {
+		const int index = 1 + (gu-&gt;usRandInt() % (showList-&gt;items.size() - 1));
+		userMod = showList-&gt;items[index];
+	}
+	else
+		userMod = s;
+
+	delete showList;
+	showList = NULL;
+
+	ShowScriptList();
+}
+

Modified: branches/caiinterface/rts/Game/SelectMenu.h
===================================================================
--- branches/caiinterface/rts/Game/SelectMenu.h	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/Game/SelectMenu.h	2008-11-04 09:57:36 UTC (rev 6975)
@@ -3,6 +3,16 @@
 
 #include &quot;GameController.h&quot;
 
+class LocalSetup;
+class CglList;
+
+/**
<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">+ at brief</A> User prompt for options when no script is given
+
+When no setupscript is given, this will show a menu to select server address (when running in client (&quot;-c&quot;)mode).
+If in host mode, it will show lists for Map, Mod and Script.
+When everything is selected, it will generate a gamesetup-script and start CPreGame
+*/
 class SelectMenu : public CGameController
 {
 public:
@@ -12,8 +22,23 @@
 	int KeyPressed(unsigned short k, bool isRepeat);
 	bool Update();
 	
+	void ShowMapList();
+	void ShowScriptList();
+	void ShowModList();
+	
+	/// Callback functions for CglList
+	void SelectScript(const std::string&amp; s);
+	void SelectMap(const std::string&amp; s);
+	void SelectMod(const std::string&amp; s);
+	
 private:
-	bool isServer;
+	std::string userScript;
+	std::string userMap;
+	std::string userMod;
+	
+	bool addressKnown;
+	LocalSetup* mySettings;
+	CglList* showList;
 };
 
 #endif
\ No newline at end of file

Modified: branches/caiinterface/rts/Game/Server/MsgStrings.h
===================================================================
--- branches/caiinterface/rts/Game/Server/MsgStrings.h	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/Game/Server/MsgStrings.h	2008-11-04 09:57:36 UTC (rev 6975)
@@ -18,10 +18,10 @@
 const std::string SyncError = &quot;Sync error for %s in frame %d (%x)&quot;;
 const std::string NoSyncCheck = &quot;Warning: Sync checking disabled!&quot;;
 
-const std::string NewConnection = &quot;Player %s with number %d connected (client version %s)&quot;;
+const std::string NewConnection = &quot;Player %s connected with number %d (client version %s)&quot;;
 const std::string ConnectionReject = &quot;Connection attempt rejected (Message ID: %d Network version: %d Datalength: %d)&quot;;
 const std::string WrongPlayer = &quot;Got message %d from %d claiming to be from %d&quot;;
-const std::string PlayerJoined = &quot;Player %s finished loading and joined as player %d&quot;;
+const std::string PlayerJoined = &quot;Player %s finished loading and is now ingame&quot;;
 const std::string PlayerLeft = &quot;Player %s left the game: %s&quot;;
 
 const std::string NoStartposChange = &quot;%s tried to change his startposition illegally&quot;;

Modified: branches/caiinterface/rts/Game/StartScripts/CommanderScript.cpp
===================================================================
--- branches/caiinterface/rts/Game/StartScripts/CommanderScript.cpp	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/Game/StartScripts/CommanderScript.cpp	2008-11-04 09:57:36 UTC (rev 6975)
@@ -58,10 +58,10 @@
 			team-&gt;metalStorage = 20;
 			team-&gt;energyStorage = 20;
 
-			// create a GlobalAI if required
+			// create a Skirmish AI if required
 			if (!SSAIKey_Comparator::IsEmpty(team-&gt;skirmishAISpecifier) // is an AI specifyed?
 					&amp;&amp; (gu-&gt;myPlayerNum == team-&gt;leader)) {
-				globalAI-&gt;CreateSkirmishAI(a, team-&gt;skirmishAISpecifier);
+				globalAI-&gt;CreateSkirmishAI(a, team-&gt;skirmishAISpecifier, team-&gt;skirmishAIOptions);
 			}
 
 			// get the team startup info

Deleted: branches/caiinterface/rts/Game/StartScripts/GlobalAITestScript.cpp
===================================================================
--- branches/caiinterface/rts/Game/StartScripts/GlobalAITestScript.cpp	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/Game/StartScripts/GlobalAITestScript.cpp	2008-11-04 09:57:36 UTC (rev 6975)
@@ -1,77 +0,0 @@
-#include &lt;algorithm&gt;
-#include &lt;cctype&gt;
-#include &quot;System/StdAfx.h&quot;
-#include &quot;GlobalAITestScript.h&quot;
-#include &quot;ExternalAI/GlobalAIHandler.h&quot;
-#include &quot;Game/Team.h&quot;
-#include &quot;Lua/LuaParser.h&quot;
-#include &quot;Map/MapParser.h&quot;
-#include &quot;Map/ReadMap.h&quot;
-#include &quot;Sim/SideParser.h&quot;
-#include &quot;Sim/Units/UnitDefHandler.h&quot;
-#include &quot;Sim/Units/UnitLoader.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/Platform/FileSystem.h&quot;
-#include &quot;Game/GameSetup.h&quot;
-#include &quot;mmgr.h&quot;
-#include &quot;Exceptions.h&quot;
-
-
-extern std::string stupidGlobalMapname;
-
-
-CGlobalAITestScript::CGlobalAITestScript(const SSAIKey&amp; skirmishAISpecifier)
-		: CScript(std::string(&quot;GlobalAI test (&quot;)
-		+ std::string(skirmishAISpecifier.ai.shortName) + std::string(&quot; v&quot;)
-		+ std::string(skirmishAISpecifier.ai.version) + std::string(&quot;)&quot;)),
-	skirmishAISpecifier(skirmishAISpecifier)
-{
-	if (!gameSetup) {
-		// make sure CSelectedUnits::AiOrder()
-		// still works without a setup script
-		gs-&gt;Team(1)-&gt;isAI = true;
-		gs-&gt;Team(1)-&gt;skirmishAISpecifier = skirmishAISpecifier;
-		gs-&gt;Team(1)-&gt;leader = 0;
-	}
-}
-
-
-CGlobalAITestScript::~CGlobalAITestScript(void)
-{
-}
-
-
-void CGlobalAITestScript::GameStart(void)
-{
-	globalAI-&gt;CreateSkirmishAI(1, skirmishAISpecifier);
-
-	gs-&gt;Team(0)-&gt;energy        = 1000;
-	gs-&gt;Team(0)-&gt;energyStorage = 1000;
-	gs-&gt;Team(0)-&gt;metal         = 1000;
-	gs-&gt;Team(0)-&gt;metalStorage  = 1000;
-
-	gs-&gt;Team(1)-&gt;energy        = 1000;
-	gs-&gt;Team(1)-&gt;energyStorage = 1000;
-	gs-&gt;Team(1)-&gt;metal         = 1000;
-	gs-&gt;Team(1)-&gt;metalStorage  = 1000;
-
-	const std::string startUnit0 = sideParser.GetStartUnit(0, &quot;&quot;);
-	const std::string startUnit1 = sideParser.GetStartUnit(1, startUnit0);
-	// default to side 1, in case mod has only 1 side
-
-	if (startUnit0.length() == 0) {
-		throw content_error (&quot;Unable to load a commander for the first side&quot;);
-	}
-
-	MapParser mapParser(stupidGlobalMapname);
-	if (!mapParser.IsValid()) {
-		throw content_error(&quot;MapParser: &quot; + mapParser.GetErrorLog());
-	}
-	float3 startPos0(1000.0f, 80.0f, 1000.0f);
-	float3 startPos1(1200.0f, 80.0f, 1200.0f);
-	mapParser.GetStartPos(0, startPos0);
-	mapParser.GetStartPos(1, startPos1);
-
-	unitLoader.LoadUnit(startUnit0, startPos0, 0, false, 0, NULL);
-	unitLoader.LoadUnit(startUnit1, startPos1, 1, false, 0, NULL);
-}

Deleted: branches/caiinterface/rts/Game/StartScripts/GlobalAITestScript.h
===================================================================
--- branches/caiinterface/rts/Game/StartScripts/GlobalAITestScript.h	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/Game/StartScripts/GlobalAITestScript.h	2008-11-04 09:57:36 UTC (rev 6975)
@@ -1,18 +0,0 @@
-#ifndef GLOBALAITESTSCRIPT_H
-#define GLOBALAITESTSCRIPT_H
-
-#include &quot;Script.h&quot;
-#include &quot;ExternalAI/Interface/SAIInterfaceLibrary.h&quot;
-
-class CGlobalAITestScript :
-	public CScript
-{
-	SSAIKey skirmishAISpecifier;
-public:
-	CGlobalAITestScript(const SSAIKey&amp; skirmishAISpecifier);
-	~CGlobalAITestScript(void);
-
-	void GameStart(void);
-};
-
-#endif

Modified: branches/caiinterface/rts/Game/StartScripts/ScriptHandler.cpp
===================================================================
--- branches/caiinterface/rts/Game/StartScripts/ScriptHandler.cpp	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/Game/StartScripts/ScriptHandler.cpp	2008-11-04 09:57:36 UTC (rev 6975)
@@ -13,7 +13,7 @@
 #include &quot;CommanderScript.h&quot;
 #include &quot;CommanderScript2.h&quot;
 #include &quot;AirScript.h&quot;
-#include &quot;GlobalAITestScript.h&quot;
+#include &quot;SkirmishAITestScript.h&quot;
 #include &quot;SpawnScript.h&quot;
 #include &quot;EmptyScript.h&quot;
 #include &quot;TestScript.h&quot;
@@ -53,7 +53,7 @@
 	
 	IAILibraryManager::T_skirmishAIKeys::const_iterator ai, e;
 	for(ai=skirmishAIKeys-&gt;begin(), e=skirmishAIKeys-&gt;end(); ai != e; ++ai) {
-		loaded_scripts.push_back(SAFE_NEW CGlobalAITestScript(*ai));
+		loaded_scripts.push_back(SAFE_NEW CSkirmishAITestScript(*ai));
 	}
 
 	std::vector&lt;std::string&gt; f = CFileHandler::FindFiles(&quot;Saves/&quot;, &quot;*.ssf&quot;);

Copied: branches/caiinterface/rts/Game/StartScripts/SkirmishAITestScript.cpp (from rev 6851, branches/caiinterface/rts/Game/StartScripts/GlobalAITestScript.cpp)
===================================================================
--- branches/caiinterface/rts/Game/StartScripts/SkirmishAITestScript.cpp	                        (rev 0)
+++ branches/caiinterface/rts/Game/StartScripts/SkirmishAITestScript.cpp	2008-11-04 09:57:36 UTC (rev 6975)
@@ -0,0 +1,82 @@
+
+#include &quot;SkirmishAITestScript.h&quot;
+
+#include &lt;algorithm&gt;
+#include &lt;cctype&gt;
+#include &quot;System/StdAfx.h&quot;
+#include &quot;ExternalAI/GlobalAIHandler.h&quot;
+#include &quot;Game/Team.h&quot;
+#include &quot;Lua/LuaParser.h&quot;
+#include &quot;Map/MapParser.h&quot;
+#include &quot;Map/ReadMap.h&quot;
+#include &quot;Sim/SideParser.h&quot;
+#include &quot;Sim/Units/UnitDefHandler.h&quot;
+#include &quot;Sim/Units/UnitLoader.h&quot;
+#include &quot;System/LogOutput.h&quot;
+#include &quot;System/Platform/FileSystem.h&quot;
+#include &quot;Game/GameSetup.h&quot;
+#include &quot;mmgr.h&quot;
+#include &quot;Exceptions.h&quot;
+
+
+extern std::string stupidGlobalMapname;
+
+
+CSkirmishAITestScript::CSkirmishAITestScript(const SSAIKey&amp; key,
+		const std::map&lt;std::string, std::string&gt;&amp; options)
+		: CScript(std::string(&quot;GlobalAI test (&quot;)
+			+ std::string(key.ai.shortName) + std::string(&quot; v&quot;)
+			+ std::string(key.ai.version) + std::string(&quot;)&quot;)),
+		key(key),
+		options(options)
+{
+	if (!gameSetup) {
+		// make sure CSelectedUnits::AiOrder()
+		// still works without a setup script
+		gs-&gt;Team(1)-&gt;isAI = true;
+		gs-&gt;Team(1)-&gt;skirmishAISpecifier = key;
+		gs-&gt;Team(1)-&gt;skirmishAIOptions = options;
+		gs-&gt;Team(1)-&gt;leader = 0;
+	}
+}
+
+
+CSkirmishAITestScript::~CSkirmishAITestScript(void)
+{
+}
+
+
+void CSkirmishAITestScript::GameStart(void)
+{
+	globalAI-&gt;CreateSkirmishAI(1, key, options);
+
+	gs-&gt;Team(0)-&gt;energy        = 1000;
+	gs-&gt;Team(0)-&gt;energyStorage = 1000;
+	gs-&gt;Team(0)-&gt;metal         = 1000;
+	gs-&gt;Team(0)-&gt;metalStorage  = 1000;
+
+	gs-&gt;Team(1)-&gt;energy        = 1000;
+	gs-&gt;Team(1)-&gt;energyStorage = 1000;
+	gs-&gt;Team(1)-&gt;metal         = 1000;
+	gs-&gt;Team(1)-&gt;metalStorage  = 1000;
+
+	const std::string startUnit0 = sideParser.GetStartUnit(0, &quot;&quot;);
+	const std::string startUnit1 = sideParser.GetStartUnit(1, startUnit0);
+	// default to side 1, in case mod has only 1 side
+
+	if (startUnit0.length() == 0) {
+		throw content_error (&quot;Unable to load a commander for the first side&quot;);
+	}
+
+	MapParser mapParser(stupidGlobalMapname);
+	if (!mapParser.IsValid()) {
+		throw content_error(&quot;MapParser: &quot; + mapParser.GetErrorLog());
+	}
+	float3 startPos0(1000.0f, 80.0f, 1000.0f);
+	float3 startPos1(1200.0f, 80.0f, 1200.0f);
+	mapParser.GetStartPos(0, startPos0);
+	mapParser.GetStartPos(1, startPos1);
+
+	unitLoader.LoadUnit(startUnit0, startPos0, 0, false, 0, NULL);
+	unitLoader.LoadUnit(startUnit1, startPos1, 1, false, 0, NULL);
+}


Property changes on: branches/caiinterface/rts/Game/StartScripts/SkirmishAITestScript.cpp
___________________________________________________________________
Name: svn:mergeinfo
   + 
Name: svn:eol-style
   + native

Copied: branches/caiinterface/rts/Game/StartScripts/SkirmishAITestScript.h (from rev 6851, branches/caiinterface/rts/Game/StartScripts/GlobalAITestScript.h)
===================================================================
--- branches/caiinterface/rts/Game/StartScripts/SkirmishAITestScript.h	                        (rev 0)
+++ branches/caiinterface/rts/Game/StartScripts/SkirmishAITestScript.h	2008-11-04 09:57:36 UTC (rev 6975)
@@ -0,0 +1,22 @@
+#ifndef _SKIRMISHAITESTSCRIPT_H
+#define _SKIRMISHAITESTSCRIPT_H
+
+#include &quot;Script.h&quot;
+#include &quot;ExternalAI/Interface/SAIInterfaceLibrary.h&quot;
+
+#include &lt;map&gt;
+#include &lt;string&gt;
+
+class CSkirmishAITestScript : public CScript
+{
+	SSAIKey key;
+	std::map&lt;std::string, std::string&gt; options;
+public:
+	CSkirmishAITestScript(const SSAIKey&amp; key,
+			const std::map&lt;std::string, std::string&gt;&amp; options = (std::map&lt;std::string, std::string&gt;()));
+	~CSkirmishAITestScript(void);
+
+	void GameStart(void);
+};
+
+#endif	// _SKIRMISHAITESTSCRIPT_H


Property changes on: branches/caiinterface/rts/Game/StartScripts/SkirmishAITestScript.h
___________________________________________________________________
Name: svn:mergeinfo
   + 
Name: svn:eol-style
   + native

Modified: branches/caiinterface/rts/Game/Team.cpp
===================================================================
--- branches/caiinterface/rts/Game/Team.cpp	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/Game/Team.cpp	2008-11-04 09:57:36 UTC (rev 6975)
@@ -40,6 +40,7 @@
 				CR_MEMBER(isAI),
 				CR_MEMBER(luaAI),
 				CR_MEMBER(skirmishAISpecifier),
+				CR_MEMBER(skirmishAIOptions),
 				CR_MEMBER(units),
 				CR_MEMBER(startPos),
 				CR_MEMBER(metal),

Modified: branches/caiinterface/rts/Game/Team.h
===================================================================
--- branches/caiinterface/rts/Game/Team.h	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/Game/Team.h	2008-11-04 09:57:36 UTC (rev 6975)
@@ -68,6 +68,7 @@
 	bool isAI;
 	std::string luaAI;
 	SSAIKey skirmishAISpecifier;
+	std::map&lt;std::string, std::string&gt; skirmishAIOptions;
 
 	// color info is unsynced
 	unsigned char color[4];

Modified: branches/caiinterface/rts/Game/UI/GuiHandler.cpp
===================================================================
--- branches/caiinterface/rts/Game/UI/GuiHandler.cpp	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/Game/UI/GuiHandler.cpp	2008-11-04 09:57:36 UTC (rev 6975)
@@ -3725,23 +3725,25 @@
 	// draw buildings we are about to build
 	if ((inCommand &gt;= 0) &amp;&amp; (inCommand &lt; commands.size()) &amp;&amp;
 	    (commands[inCommand].type == CMDTYPE_ICON_BUILDING)) {
-		GML_STDMUTEX_LOCK(cai); // DrawMapStuff
-		// draw build distance for all immobile builders during build commands
-		std::list&lt;CBuilderCAI*&gt;::const_iterator bi;
-		for (bi = uh-&gt;builderCAIs.begin(); bi != uh-&gt;builderCAIs.end(); ++bi) {
-			const CUnit* unit = (*bi)-&gt;owner;
-			if ((unit == pointedAt) || (unit-&gt;team != gu-&gt;myTeam)) {
-				continue;
-			}
-			const UnitDef* unitdef = unit-&gt;unitDef;
-			if (unitdef-&gt;builder &amp;&amp; !unitdef-&gt;canmove) {
-				const float radius = unitdef-&gt;buildDistance;
-				if (radius &gt; 0.0f) {
-					glDisable(GL_TEXTURE_2D);
-					const float* color = cmdColors.rangeBuild;
-					glColor4f(color[0], color[1], color[2], color[3] * 0.333f);
-					glSurfaceCircle(unit-&gt;pos, radius, 40);
+		{ // limit the locking scope to avoid deadlock
+			GML_STDMUTEX_LOCK(cai); // DrawMapStuff
+			// draw build distance for all immobile builders during build commands
+			std::list&lt;CBuilderCAI*&gt;::const_iterator bi;
+			for (bi = uh-&gt;builderCAIs.begin(); bi != uh-&gt;builderCAIs.end(); ++bi) {
+				const CUnit* unit = (*bi)-&gt;owner;
+				if ((unit == pointedAt) || (unit-&gt;team != gu-&gt;myTeam)) {
+					continue;
 				}
+				const UnitDef* unitdef = unit-&gt;unitDef;
+				if (unitdef-&gt;builder &amp;&amp; !unitdef-&gt;canmove) {
+					const float radius = unitdef-&gt;buildDistance;
+					if (radius &gt; 0.0f) {
+						glDisable(GL_TEXTURE_2D);
+						const float* color = cmdColors.rangeBuild;
+						glColor4f(color[0], color[1], color[2], color[3] * 0.333f);
+						glSurfaceCircle(unit-&gt;pos, radius, 40);
+					}
+				}
 			}
 		}
 

Modified: branches/caiinterface/rts/Lua/LuaSyncedCtrl.cpp
===================================================================
--- branches/caiinterface/rts/Lua/LuaSyncedCtrl.cpp	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/Lua/LuaSyncedCtrl.cpp	2008-11-04 09:57:36 UTC (rev 6975)
@@ -2037,24 +2037,7 @@
 		return 0;
 	}
 	CBuilding* building = dynamic_cast&lt;CBuilding*&gt;(unit);
-	if (building &amp;&amp; building-&gt;buildingDecal) {
-		std::vector&lt;CGroundDecalHandler::BuildingDecalType*&gt;&amp; types =
-			groundDecals-&gt;buildingDecalTypes;
-		std::vector&lt;CGroundDecalHandler::BuildingDecalType*&gt;::iterator bdt;
-		for (bdt = types.begin(); bdt != types.end(); ++bdt) {
-			std::set&lt;BuildingGroundDecal*&gt;&amp; decals = (*bdt)-&gt;buildingDecals;
-			std::set&lt;BuildingGroundDecal*&gt;::iterator bgd;
-			for (bgd = decals.begin(); bgd != decals.end(); ++bgd) {
-				BuildingGroundDecal* decal = *bgd;
-				if (decal == building-&gt;buildingDecal) {
-					delete decal;
-					decals.erase(bgd);
-					building-&gt;buildingDecal = NULL;
-					return 0;
-				}
-			}
-		}
-	}
+	groundDecals-&gt;ForceRemoveBuilding(building);
 	return 0;
 }
 

Modified: branches/caiinterface/rts/Rendering/GL/glList.h
===================================================================
--- branches/caiinterface/rts/Rendering/GL/glList.h	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/Rendering/GL/glList.h	2008-11-04 09:57:36 UTC (rev 6975)
@@ -4,12 +4,14 @@
 //
 //////////////////////////////////////////////////////////////////////
 
-#include &quot;Game/UI/InputReceiver.h&quot;
 #include &lt;string&gt;
 #include &lt;vector&gt;
+#include &lt;boost/function.hpp&gt;
 
-typedef void (* ListSelectCallback) (std::string selected);
+#include &quot;Game/UI/InputReceiver.h&quot;
 
+typedef boost::function&lt;void(const std::string&amp;)&gt; ListSelectCallback;
+
 class CglList : public CInputReceiver
 {
 public:

Modified: branches/caiinterface/rts/Rendering/GroundDecalHandler.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/GroundDecalHandler.cpp	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/Rendering/GroundDecalHandler.cpp	2008-11-04 09:57:36 UTC (rev 6975)
@@ -129,7 +129,8 @@
 	#undef HEIGHT2WORLD
 }
 
-static inline void DrawBuildingDecal(BuildingGroundDecal* decal)
+
+inline void CGroundDecalHandler::DrawBuildingDecal(BuildingGroundDecal* decal)
 {
 	const float* hm = readmap-&gt;GetHeightmap();
 	const int gsmx = gs-&gt;mapx;
@@ -304,7 +305,8 @@
 	#undef HEIGHT
 }
 
-static inline void DrawGroundScar(CGroundDecalHandler::Scar* scar, bool fade)
+
+inline void CGroundDecalHandler::DrawGroundScar(CGroundDecalHandler::Scar* scar, bool fade)
 {
 	const float* hm = readmap-&gt;GetHeightmap();
 	const int gsmx = gs-&gt;mapx;
@@ -385,8 +387,6 @@
 }
 
 
-
-
 void CGroundDecalHandler::Draw(void)
 {
 	if (!drawDecals) {
@@ -452,7 +452,7 @@
 				if (decal-&gt;owner &amp;&amp; decal-&gt;owner-&gt;buildProgress &gt;= 0) {
 					decal-&gt;alpha = decal-&gt;owner-&gt;buildProgress;
 				} else if (!decal-&gt;gbOwner) {
-					decal-&gt;alpha -= decal-&gt;AlphaFalloff * gu-&gt;lastFrameTime * gs-&gt;speedFactor;
+					decal-&gt;alpha -= decal-&gt;alphaFalloff * gu-&gt;lastFrameTime * gs-&gt;speedFactor;
 				}
 
 				if (decal-&gt;alpha &lt; 0.0f) {
@@ -461,8 +461,6 @@
 						decal-&gt;owner-&gt;buildingDecal = 0;
 					}
 
-					delete decal-&gt;va;
-					decal-&gt;va = 0x0;
 					delete decal;
 
 					set&lt;BuildingGroundDecal*&gt;::iterator next(bgdi); ++next;
@@ -929,7 +927,7 @@
 
 	decal-&gt;owner = building;
 	decal-&gt;gbOwner = 0;
-	decal-&gt;AlphaFalloff = building-&gt;unitDef-&gt;buildingDecalDecaySpeed;
+	decal-&gt;alphaFalloff = building-&gt;unitDef-&gt;buildingDecalDecaySpeed;
 	decal-&gt;alpha = 0;
 	decal-&gt;pos = building-&gt;pos;
 	decal-&gt;radius = sqrt((float) (sizex * sizex + sizey * sizey)) * 8 + 20;
@@ -965,6 +963,30 @@
 }
 
 
+/**
+ * @brief immediately remove a building's ground decal, if any (without fade out)
+ */
+void CGroundDecalHandler::ForceRemoveBuilding(CBuilding* building)
+{
+	if (!building || !building-&gt;buildingDecal)
+		return;
+
+	std::vector&lt;BuildingDecalType*&gt;&amp; types = buildingDecalTypes;
+	std::vector&lt;BuildingDecalType*&gt;::iterator bdt;
+
+	for (bdt = types.begin(); bdt != types.end(); ++bdt) {
+		std::set&lt;BuildingGroundDecal*&gt;&amp; decals = (*bdt)-&gt;buildingDecals;
+		std::set&lt;BuildingGroundDecal*&gt;::iterator bgd = decals.find(building-&gt;buildingDecal);
+		if (bgd != decals.end()) {
+			BuildingGroundDecal* decal = *bgd;
+			decals.erase(bgd);
+			building-&gt;buildingDecal = NULL;
+			delete decal;
+		}
+	}
+}
+
+
 int CGroundDecalHandler::GetBuildingDecalType(const std::string&amp; name)
 {
 	if (decalLevel == 0) {

Modified: branches/caiinterface/rts/Rendering/GroundDecalHandler.h
===================================================================
--- branches/caiinterface/rts/Rendering/GroundDecalHandler.h	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/Rendering/GroundDecalHandler.h	2008-11-04 09:57:36 UTC (rev 6975)
@@ -9,6 +9,7 @@
 #include &quot;Rendering/UnitModels/UnitDrawer.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Rendering/GL/VertexArray.h&quot;
+#include &quot;Util.h&quot;
 
 class CUnit;
 class CBuilding;
@@ -31,8 +32,8 @@
 };
 
 struct BuildingGroundDecal {
-	BuildingGroundDecal(): va(0x0), owner(0x0), gbOwner(0x0), alpha(1.0f) {
-	}
+	BuildingGroundDecal(): va(NULL), owner(NULL), gbOwner(NULL), alpha(1.0f) {}
+	~BuildingGroundDecal() { SafeDelete(va); }
 
 	CVertexArray* va;
 	CBuilding* owner;
@@ -45,7 +46,7 @@
 	float radius;
 
 	float alpha;
-	float AlphaFalloff;
+	float alphaFalloff;
 };
 
 
@@ -67,8 +68,13 @@
 
 	void AddBuilding(CBuilding* building);
 	void RemoveBuilding(CBuilding* building,CUnitDrawer::GhostBuilding* gb);
+	void ForceRemoveBuilding(CBuilding* building);
 	int GetBuildingDecalType(const std::string&amp; name);
 
+	bool GetDrawDecals() const { return drawDecals; }
+	void SetDrawDecals(bool v) { if (decalLevel &gt; 0) { drawDecals = v; } }
+
+private:
 	GLuint scarTex;
 	int decalLevel;
 	int groundScarAlphaFade;
@@ -88,9 +94,8 @@
 	std::vector&lt;BuildingDecalType*&gt; buildingDecalTypes;
 
 	struct Scar {
-		Scar(): va(0x0) {
-		}
-		~Scar() { delete va; va = 0; }
+		Scar(): va(NULL) {}
+		~Scar() { SafeDelete(va); }
 
 		float3 pos;
 		float radius;
@@ -118,10 +123,6 @@
 	int lastTest;
 	float maxOverlap;
 
-	bool GetDrawDecals() const { return drawDecals; }
-	void SetDrawDecals(bool v) { if (decalLevel &gt; 0) { drawDecals = v; } }
-
-protected:
 	bool drawDecals;
 
 	std::set&lt;Scar*&gt;* scarField;
@@ -131,6 +132,9 @@
 	unsigned int decalVP;
 	unsigned int decalFP;
 
+	void DrawBuildingDecal(BuildingGroundDecal* decal);
+	void DrawGroundScar(Scar* scar, bool fade);
+
 	int OverlapSize(Scar* s1, Scar* s2);
 	void TestOverlaps(Scar* scar);
 	void RemoveScar(Scar* scar, bool removeFromScars);

Modified: branches/caiinterface/rts/Rendering/Textures/TextureHandler.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/Textures/TextureHandler.cpp	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/Rendering/Textures/TextureHandler.cpp	2008-11-04 09:57:36 UTC (rev 6975)
@@ -287,7 +287,7 @@
 		model-&gt;textureType=s3oTextureNames[totalName];
 	}
 	model-&gt;textureType=0;
-	GML_STDMUTEX_LOCK(model); // LoadS3OTexture
+//	GML_STDMUTEX_LOCK(model); // LoadS3OTexture
 	loadTextures.push_back(model);
 }
 

Modified: branches/caiinterface/rts/Rendering/UnitModels/3DOParser.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/UnitModels/3DOParser.cpp	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/Rendering/UnitModels/3DOParser.cpp	2008-11-04 09:57:36 UTC (rev 6975)
@@ -158,6 +158,8 @@
 
 S3DOModel* C3DOParser::Load3DO(string name,float scale,int team)
 {
+	GML_STDMUTEX_LOCK(model); // Load3DO
+
 	int color=team;
 
 	if(name.find(&quot;.&quot;)==string::npos)
@@ -513,7 +515,7 @@
 }
 
 void C3DOParser::CreateLists(S3DO *o) {
-	GML_STDMUTEX_LOCK(model); // CreateLists
+//	GML_STDMUTEX_LOCK(model); // CreateLists
 	createLists.push_back(o);
 }
 

Modified: branches/caiinterface/rts/Rendering/UnitModels/s3oParser.cpp
===================================================================
--- branches/caiinterface/rts/Rendering/UnitModels/s3oParser.cpp	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/Rendering/UnitModels/s3oParser.cpp	2008-11-04 09:57:36 UTC (rev 6975)
@@ -61,6 +61,8 @@
 
 S3DOModel* CS3OParser::LoadS3O(std::string name,float scale,int side)
 {
+	GML_STDMUTEX_LOCK(model); // LoadS3O
+
 	if(name.find(&quot;.&quot;)==std::string::npos)
 		name+=&quot;.s3o&quot;;
 
@@ -343,7 +345,7 @@
 }
 
 void CS3OParser::CreateLists(SS3O *o) {
-	GML_STDMUTEX_LOCK(model); // CreateLists
+//	GML_STDMUTEX_LOCK(model); // CreateLists
 	createLists.push_back(o);
 }
 

Modified: branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/WeaponProjectile.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/WeaponProjectile.cpp	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/Sim/Projectiles/WeaponProjectiles/WeaponProjectile.cpp	2008-11-04 09:57:36 UTC (rev 6975)
@@ -203,7 +203,7 @@
 				weaponDef-&gt;areaOfEffect, weaponDef-&gt;edgeEffectiveness,
 				weaponDef-&gt;explosionSpeed, owner, true,
 				weaponDef-&gt;noExplode ? 0.3f : 1,
-				weaponDef-&gt;noExplode, weaponDef-&gt;explosionGenerator, unit,
+				weaponDef-&gt;noExplode || weaponDef-&gt;noSelfDamage, weaponDef-&gt;explosionGenerator, unit,
 				impactDir, weaponDef-&gt;id);
 		}
 	}

Modified: branches/caiinterface/rts/Sim/Units/COB/CobInstance.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Units/COB/CobInstance.cpp	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/Sim/Units/COB/CobInstance.cpp	2008-11-04 09:57:36 UTC (rev 6975)
@@ -733,7 +733,7 @@
 
 				helper-&gt;Explosion(
 					pos, weaponDef-&gt;damages, weaponDef-&gt;areaOfEffect, weaponDef-&gt;edgeEffectiveness,
-					weaponDef-&gt;explosionSpeed, unit, true, 1.0f, false, weaponDef-&gt;explosionGenerator,
+					weaponDef-&gt;explosionSpeed, unit, true, 1.0f, weaponDef-&gt;noSelfDamage, weaponDef-&gt;explosionGenerator,
 					NULL, float3(0, 0, 0), weaponDef-&gt;id
 				);
 			}

Modified: branches/caiinterface/rts/Sim/Weapons/BeamLaser.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Weapons/BeamLaser.cpp	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/Sim/Weapons/BeamLaser.cpp	2008-11-04 09:57:36 UTC (rev 6975)
@@ -263,7 +263,7 @@
 		DamageArray dynDamages;
 		if (weaponDef-&gt;dynDamageExp &gt; 0)
 			dynDamages = weaponDefHandler-&gt;DynamicDamages(weaponDef-&gt;damages, weaponMuzzlePos, curPos, weaponDef-&gt;dynDamageRange&gt;0?weaponDef-&gt;dynDamageRange:weaponDef-&gt;range, weaponDef-&gt;dynDamageExp, weaponDef-&gt;dynDamageMin, weaponDef-&gt;dynDamageInverted);
-		helper-&gt;Explosion(hitPos, weaponDef-&gt;dynDamageExp&gt;0?dynDamages*(intensity*damageMul):weaponDef-&gt;damages*(intensity*damageMul), areaOfEffect, weaponDef-&gt;edgeEffectiveness, weaponDef-&gt;explosionSpeed,owner, true, 1.0f, false, weaponDef-&gt;explosionGenerator, hit, dir, weaponDef-&gt;id);
+		helper-&gt;Explosion(hitPos, weaponDef-&gt;dynDamageExp&gt;0?dynDamages*(intensity*damageMul):weaponDef-&gt;damages*(intensity*damageMul), areaOfEffect, weaponDef-&gt;edgeEffectiveness, weaponDef-&gt;explosionSpeed,owner, true, 1.0f, weaponDef-&gt;noSelfDamage, weaponDef-&gt;explosionGenerator, hit, dir, weaponDef-&gt;id);
 	}
 
 	if(targetUnit)

Modified: branches/caiinterface/rts/Sim/Weapons/LightingCannon.cpp
===================================================================
--- branches/caiinterface/rts/Sim/Weapons/LightingCannon.cpp	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/Sim/Weapons/LightingCannon.cpp	2008-11-04 09:57:36 UTC (rev 6975)
@@ -110,7 +110,7 @@
 	if (weaponDef-&gt;dynDamageExp &gt; 0)
 		dynDamages = weaponDefHandler-&gt;DynamicDamages(weaponDef-&gt;damages, weaponMuzzlePos, targetPos, weaponDef-&gt;dynDamageRange&gt;0?weaponDef-&gt;dynDamageRange:weaponDef-&gt;range, weaponDef-&gt;dynDamageExp, weaponDef-&gt;dynDamageMin, weaponDef-&gt;dynDamageInverted);
 
-	helper-&gt;Explosion(weaponMuzzlePos+dir*r,weaponDef-&gt;dynDamageExp&gt;0?dynDamages:weaponDef-&gt;damages,areaOfEffect,weaponDef-&gt;edgeEffectiveness,weaponDef-&gt;explosionSpeed,owner,false,0.5f,true,weaponDef-&gt;explosionGenerator, u,dir, weaponDef-&gt;id);
+	helper-&gt;Explosion(weaponMuzzlePos+dir*r,weaponDef-&gt;dynDamageExp&gt;0?dynDamages:weaponDef-&gt;damages,areaOfEffect,weaponDef-&gt;edgeEffectiveness,weaponDef-&gt;explosionSpeed,owner,true,0.5f,weaponDef-&gt;noSelfDamage,weaponDef-&gt;explosionGenerator, u,dir, weaponDef-&gt;id);
 
 	SAFE_NEW CLightingProjectile(weaponMuzzlePos,
 		weaponMuzzlePos + dir * (r + 10), owner, color, weaponDef, 10, this);

Modified: branches/caiinterface/rts/System/DemoReader.cpp
===================================================================
--- branches/caiinterface/rts/System/DemoReader.cpp	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/System/DemoReader.cpp	2008-11-04 09:57:36 UTC (rev 6975)
@@ -2,6 +2,7 @@
 
 #include &lt;limits.h&gt;
 #include &lt;stdexcept&gt;
+#include &lt;assert.h&gt;
 #include &quot;mmgr.h&quot;
 
 #include &quot;DemoReader.h&quot;
@@ -53,20 +54,6 @@
 		throw std::runtime_error(std::string(&quot;Demofile corrupt or created by a different version of Spring: &quot;)+filename);
 	}
 
-	if (fileHeader.scriptSize != 0) {
-		char* buf = new char[fileHeader.scriptSize];
-		playbackDemo-&gt;Read(buf, fileHeader.scriptSize);
-		if (!gameSetup) { // dont overwrite existing gamesetup (when hosting a demo)
-			CGameSetup* temp = new CGameSetup();
-			temp-&gt;Init(buf, fileHeader.scriptSize);
-			temp-&gt;demoName = filename;
-			temp-&gt;numDemoPlayers = GetFileHeader().maxPlayerNum+1;
-			temp-&gt;maxSpeed = 10;
-			gameSetup = temp;
-		}
-		delete[] buf;
-	}
-
 	playbackDemo-&gt;Read((void*)&amp;chunkHeader, sizeof(chunkHeader));
 	chunkHeader.swab();
 

Modified: branches/caiinterface/rts/System/DemoRecorder.cpp
===================================================================
--- branches/caiinterface/rts/System/DemoRecorder.cpp	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/System/DemoRecorder.cpp	2008-11-04 09:57:36 UTC (rev 6975)
@@ -47,16 +47,6 @@
 
 	recordDemo.write((char*)&amp;fileHeader, sizeof(fileHeader));
 
-	if (gameSetup) {
-		// strip trailing null termination characters
-		int length = gameSetup-&gt;gameSetupTextLength;
-		while (gameSetup-&gt;gameSetupText[length - 1] == '\0')
-			--length;
-
-		fileHeader.scriptSize = length;
-		recordDemo.write(gameSetup-&gt;gameSetupText, length);
-	}
-
 	fileHeader.playerStatElemSize = sizeof(CPlayer::Statistics);
 	fileHeader.teamStatElemSize = sizeof(CTeam::Statistics);
 	fileHeader.teamStatPeriod = CTeam::statsPeriod;
@@ -85,6 +75,16 @@
 	}
 }
 
+void CDemoRecorder::WriteSetupText(const std::string&amp; text)
+{
+	int length = gameSetup-&gt;gameSetupText.length();
+	while (gameSetup-&gt;gameSetupText.c_str()[length - 1] == '\0')
+		--length;
+
+	fileHeader.scriptSize = length;
+	recordDemo.write(gameSetup-&gt;gameSetupText.c_str(), length);
+}
+
 void CDemoRecorder::SaveToDemo(const unsigned char* buf, const unsigned length)
 {
 	DemoStreamChunkHeader chunkHeader;

Modified: branches/caiinterface/rts/System/DemoRecorder.h
===================================================================
--- branches/caiinterface/rts/System/DemoRecorder.h	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/System/DemoRecorder.h	2008-11-04 09:57:36 UTC (rev 6975)
@@ -17,6 +17,7 @@
 	CDemoRecorder();
 	~CDemoRecorder();
 
+	void WriteSetupText(const std::string&amp; text);
 	void SaveToDemo(const unsigned char* buf,const unsigned length);
 	
 	/**

Modified: branches/caiinterface/rts/System/LogOutput.cpp
===================================================================
--- branches/caiinterface/rts/System/LogOutput.cpp	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/System/LogOutput.cpp	2008-11-04 09:57:36 UTC (rev 6975)
@@ -1,4 +1,5 @@
 #include &quot;StdAfx.h&quot;
+#include &quot;Rendering/GL/myGL.h&quot;
 
 #include &quot;LogOutput.h&quot;
 
@@ -49,7 +50,7 @@
 /******************************************************************************/
 /******************************************************************************/
 
-//CLogOutput logOutput;
+CLogOutput&amp; logOutput = CLogOutput::GetInstance();
 
 namespace
 {
@@ -76,7 +77,6 @@
 static std::ofstream* filelog = 0;
 static bool initialized = false;
 static bool stdoutDebug = false;
-CLogOutput&amp; logOutput = CLogOutput::GetInstance();
 static boost::recursive_mutex tempstrMutex;
 static string tempstr;
 
@@ -108,6 +108,8 @@
 
 void CLogOutput::End()
 {
+	GML_STDMUTEX_LOCK(log);
+
 //	delete FILE_LOG;
 //	FILE_LOG = 0;
 	SafeDelete(filelog);
@@ -116,12 +118,16 @@
 
 void CLogOutput::SetMirrorToStdout(bool value)
 {
+	GML_STDMUTEX_LOCK(log);
+
 	stdoutDebug = value;
 }
 
 
 void CLogOutput::SetFilename(const char* fname)
 {
+	GML_STDMUTEX_LOCK(log);
+
 	assert(!initialized);
 	filename = fname;
 }
@@ -136,6 +142,8 @@
  */
 void CLogOutput::Initialize()
 {
+//	GML_STDMUTEX_LOCK(log);
+
 	if (initialized) return;
 
 	filelog = new std::ofstream(filename);
@@ -223,6 +231,8 @@
  */
 void CLogOutput::Output(CLogSubsystem&amp; subsystem, const char* str)
 {
+	GML_STDMUTEX_LOCK(log);
+
 /*
 	if (!INITIALIZED) {
 		FILE_LOG = new std::ofstream(LOG_FILE_NAME);
@@ -260,7 +270,7 @@
 	OutputDebugString(str);
 	if (newline)
 		OutputDebugString(&quot;\n&quot;);
-#endif
+#endif	// _MSC_VER
 
 //	if (FILE_LOG) {
 	if (filelog) {
@@ -269,7 +279,7 @@
 			(*filelog) &lt;&lt; IntToString(gs-&gt;frameNum, &quot;[%7d] &quot;);
 //			(*FILE_LOG) &lt;&lt; IntToString(gs-&gt;frameNum, &quot;[%7d] &quot;);
 		}
-#endif	/* !defined DEDICATED &amp;&amp; !defined BUILDING_AI &amp;&amp; !defined BUILDING_AI_INTERFACE */
+#endif	// !defined DEDICATED &amp;&amp; !defined BUILDING_AI &amp;&amp; !defined BUILDING_AI_INTERFACE
 //		(*FILE_LOG) &lt;&lt; str;
 //		if (newline)
 //			(*FILE_LOG) &lt;&lt; &quot;\n&quot;;
@@ -298,6 +308,8 @@
 
 void CLogOutput::SetLastMsgPos(const float3&amp; pos)
 {
+	GML_STDMUTEX_LOCK(log);
+
 	for(vector&lt;ILogSubscriber*&gt;::iterator lsi = subscribers.begin(); lsi != subscribers.end(); ++lsi)
 		(*lsi)-&gt;SetLastMsgPos(pos);
 }
@@ -305,18 +317,24 @@
 
 void CLogOutput::AddSubscriber(ILogSubscriber* ls)
 {
+	GML_STDMUTEX_LOCK(log);
+
 	subscribers.push_back(ls);
 }
 
 
 void CLogOutput::RemoveAllSubscribers()
 {
+	GML_STDMUTEX_LOCK(log);
+
 	subscribers.clear();
 }
 
 
 void CLogOutput::RemoveSubscriber(ILogSubscriber *ls)
 {
+	GML_STDMUTEX_LOCK(log);
+
 	subscribers.erase(std::find(subscribers.begin(), subscribers.end(), ls));
 }
 

Modified: branches/caiinterface/rts/System/NetProtocol.cpp
===================================================================
--- branches/caiinterface/rts/System/NetProtocol.cpp	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/System/NetProtocol.cpp	2008-11-04 09:57:36 UTC (rev 6975)
@@ -23,7 +23,6 @@
 
 CNetProtocol::CNetProtocol()
 {
-	localDemoPlayback = false;
 }
 
 CNetProtocol::~CNetProtocol()
@@ -54,10 +53,7 @@
 {
 	server.reset(new netcode::CLocalConnection);
 	server-&gt;Flush();
-	if (!localDemoPlayback)
-	{
-		record.reset(new CDemoRecorder());
-	}
+	record.reset(new CDemoRecorder()); //TODO don't record a new demo when already watching one
 	
 	logOutput.Print(&quot;Connecting to local server&quot;);
 }

Modified: branches/caiinterface/rts/System/NetProtocol.h
===================================================================
--- branches/caiinterface/rts/System/NetProtocol.h	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/System/NetProtocol.h	2008-11-04 09:57:36 UTC (rev 6975)
@@ -41,12 +41,6 @@
 	bool Connected() const;
 
 	/**
-	@brief Wheter a demo is played local
-	@todo remove
-	*/
-	bool localDemoPlayback;
-
-	/**
 	@brief Take a look at the messages in the recieve buffer (read-only)
 	@return A RawPacket holding the data, or 0 if no data
 	@param ahead How many packets to look ahead. A typical usage would be:

Modified: branches/caiinterface/rts/System/Script/LuaFunctions.cpp
===================================================================
--- branches/caiinterface/rts/System/Script/LuaFunctions.cpp	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/System/Script/LuaFunctions.cpp	2008-11-04 09:57:36 UTC (rev 6975)
@@ -43,9 +43,10 @@
 		eventHandler.GameOver();
 	}
 
-	void CreateSkirmishAI(int teamId, const SSAIKey&amp; skirmishAIKey)
+	void CreateSkirmishAI(int teamId, const SSAIKey&amp; key,
+			const std::map&lt;std::string, std::string&gt;&amp; options)
 	{
-			globalAI-&gt;CreateSkirmishAI(teamId, skirmishAIKey);
+			globalAI-&gt;CreateSkirmishAI(teamId, key, options);
 	}
 
 	void UnitGiveCommand(CObject_pointer&lt;CUnit&gt;* u, Command* c)

Modified: branches/caiinterface/rts/System/Script/LuaFunctions.h
===================================================================
--- branches/caiinterface/rts/System/Script/LuaFunctions.h	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/System/Script/LuaFunctions.h	2008-11-04 09:57:36 UTC (rev 6975)
@@ -6,6 +6,9 @@
 #include &quot;LuaBinder.h&quot;
 #include &quot;Object.h&quot;
 
+#include &lt;map&gt;
+#include &lt;string&gt;
+
 struct Command;
 class float3;
 class CUnit;
@@ -29,7 +32,8 @@
 
 namespace luafunctions
 {
-	void CreateSkirmishAI(int teamId, const SSAIKey&amp; skirmishAIKey);
+	void CreateSkirmishAI(int teamId, const SSAIKey&amp; key,
+			const std::map&lt;std::string, std::string&gt;&amp; options = (std::map&lt;std::string, std::string&gt;()));
 	void EndGame();
 	void UnitGiveCommand(CObject_pointer&lt;CUnit&gt;* u, Command* c);
 	CObject_pointer&lt;CUnit&gt;* UnitGetTransporter(CObject_pointer&lt;CUnit&gt;* u);

Modified: branches/caiinterface/rts/System/SpringApp.cpp
===================================================================
--- branches/caiinterface/rts/System/SpringApp.cpp	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/System/SpringApp.cpp	2008-11-04 09:57:36 UTC (rev 6975)
@@ -834,36 +834,31 @@
 		else if (cmdline-&gt;result(&quot;server&quot;))
 			startsetup-&gt;isHost = true;
 
-		CGameSetup* temp = SAFE_NEW CGameSetup();
-		if (temp-&gt;Init(startscript))
-		{
-			gameSetup = const_cast&lt;const CGameSetup*&gt;(temp);
-			gs-&gt;LoadFromSetup(gameSetup);
-		}
-		else
-		{
-			throw content_error(&quot;Setupscript parse error: &quot;+startscript);
-		}
 #ifdef SYNCDEBUG
 		CSyncDebugger::GetInstance()-&gt;Initialize(startsetup-&gt;isHost);
 #endif
-		pregame = SAFE_NEW CPreGame(startsetup, &quot;&quot;, &quot;&quot;);
+		pregame = SAFE_NEW CPreGame(startsetup);
+		if (startsetup-&gt;isHost)
+			pregame-&gt;LoadSetupscript(buf);
 	}
 	else if (!demofile.empty())
 	{
-		startsetup-&gt;isHost = false;
+		startsetup-&gt;isHost = true; // local demo play
+		startsetup-&gt;myPlayerName = configHandler.GetString(&quot;name&quot;, &quot;unnamed&quot;);
 #ifdef SYNCDEBUG
-		CSyncDebugger::GetInstance()-&gt;Initialize(false);
+		CSyncDebugger::GetInstance()-&gt;Initialize(true);
 #endif
-		pregame = SAFE_NEW CPreGame(startsetup, demofile, &quot;&quot;);
+		pregame = SAFE_NEW CPreGame(startsetup);
+		pregame-&gt;LoadDemo(demofile);
 	}
 	else if (!savefile.empty())
 	{
-		startsetup-&gt;isHost = false;
+		startsetup-&gt;isHost = true;
 #ifdef SYNCDEBUG
-		CSyncDebugger::GetInstance()-&gt;Initialize(false);
+		CSyncDebugger::GetInstance()-&gt;Initialize(true);
 #endif
-		pregame = SAFE_NEW CPreGame(startsetup, &quot;&quot;, savefile);
+		pregame = SAFE_NEW CPreGame(startsetup);
+		pregame-&gt;LoadSavefile(savefile);
 	}
 	else
 	{
@@ -1076,14 +1071,21 @@
 					}
 					break;
 				}
-				case SDL_MOUSEMOTION:
+				case SDL_MOUSEMOTION: {
+					mouseInput-&gt;HandleSDLMouseEvent (event);
+					break;
+				}
 				case SDL_MOUSEBUTTONDOWN:
 				case SDL_MOUSEBUTTONUP:
 				case SDL_SYSWMEVENT: {
+//					GML_STDMUTEX_LOCK(sim);
+
 					mouseInput-&gt;HandleSDLMouseEvent (event);
 					break;
 				}
 				case SDL_KEYDOWN: {
+//					GML_STDMUTEX_LOCK(sim);
+
 					int i = event.key.keysym.sym;
 					currentUnicode = event.key.keysym.unicode;
 
@@ -1132,6 +1134,7 @@
 					break;
 				}
 				case SDL_KEYUP: {
+//					GML_STDMUTEX_LOCK(sim);
 					int i = event.key.keysym.sym;
 					currentUnicode = event.key.keysym.unicode;
 

Modified: branches/caiinterface/rts/build/vstudio8/rts.vcproj
===================================================================
--- branches/caiinterface/rts/build/vstudio8/rts.vcproj	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/build/vstudio8/rts.vcproj	2008-11-04 09:57:36 UTC (rev 6975)
@@ -852,6 +852,14 @@
 				&gt;
 			&lt;/File&gt;
 			&lt;File
+				RelativePath=&quot;..\..\Game\SelectMenu.cpp&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
+				RelativePath=&quot;..\..\Game\SelectMenu.h&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
 				RelativePath=&quot;..\..\Game\Team.cpp&quot;
 				&gt;
 			&lt;/File&gt;

Modified: branches/caiinterface/rts/lib/gml/gml.cpp
===================================================================
--- branches/caiinterface/rts/lib/gml/gml.cpp	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/lib/gml/gml.cpp	2008-11-04 09:57:36 UTC (rev 6975)
@@ -204,6 +204,9 @@
 boost::mutex posmutex;
 boost::mutex rendermutex;
 boost::mutex simmutex;
+boost::mutex netmutex;
+boost::mutex histmutex;
+boost::mutex logmutex;
 
 #include &lt;boost/thread/recursive_mutex.hpp&gt;
 boost::recursive_mutex unitmutex;

Modified: branches/caiinterface/rts/lib/gml/gml.h
===================================================================
--- branches/caiinterface/rts/lib/gml/gml.h	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/rts/lib/gml/gml.h	2008-11-04 09:57:36 UTC (rev 6975)
@@ -165,6 +165,9 @@
 extern boost::mutex posmutex;
 extern boost::mutex rendermutex;
 extern boost::mutex simmutex;
+extern boost::mutex netmutex;
+extern boost::mutex histmutex;
+extern boost::mutex logmutex;
 
 #include &lt;boost/thread/recursive_mutex.hpp&gt;
 extern boost::recursive_mutex unitmutex;
@@ -200,8 +203,8 @@
 #define GML_GET_TICKS(var) var=gmlGetTicks()
 #define GML_UPDATE_TICKS() gmlUpdateTicks()
 
-#define GML_PARG_H , boost::recursive_mutex::scoped_lock&amp; projlock = boost::recursive_mutex::scoped_lock(projmutex)
-#define GML_PARG_C , boost::recursive_mutex::scoped_lock&amp; projlock
+#define GML_PARG_H , boost::recursive_mutex::scoped_lock *projlock = &amp;boost::recursive_mutex::scoped_lock(projmutex)
+#define GML_PARG_C , boost::recursive_mutex::scoped_lock *projlock
 #define GML_PARG_P , projlock
 
 #else

Modified: branches/caiinterface/tools/DedicatedServer/main.cpp
===================================================================
--- branches/caiinterface/tools/DedicatedServer/main.cpp	2008-11-04 03:08:36 UTC (rev 6974)
+++ branches/caiinterface/tools/DedicatedServer/main.cpp	2008-11-04 09:57:36 UTC (rev 6975)
@@ -19,7 +19,7 @@
 int main(int argc, char *argv[])
 {
 	try {
-	std::cout &lt;&lt; &quot;BIG FAT WARNING: this server is currently under development. If you find any errors (you most likely will)&quot;;
+	std::cout &lt;&lt; &quot;This server is currently under development. If you find any errors&quot;;
 	std::cout &lt;&lt; &quot; report them to mantis or the forums.&quot; &lt;&lt; std::endl &lt;&lt; std::endl;
 	FileSystemHandler::Cleanup();
 	FileSystemHandler::Initialize(false);
@@ -54,7 +54,7 @@
 		GameData* data = new GameData();
 		UnsyncedRNG rng;
 		rng.Seed(SDL_GetTicks());
-		rng.Seed(gameSetup-&gt;gameSetupTextLength);
+		rng.Seed(gameSetup-&gt;gameSetupText.length());
 		data-&gt;SetRandomSeed(SDL_GetTicks());
 
 		//  Use script provided hashes if they exist
@@ -88,14 +88,7 @@
 		}
 
 		data-&gt;SetScript(gameSetup-&gt;scriptName);
-		server = new CGameServer(settings-&gt;hostport, false, data, gameSetup);
-		
-		if (settings-&gt;autohostport &gt; 0)
-			server-&gt;AddAutohostInterface(settings-&gt;autohostport);
-		else
-		{
-			std::cout &lt;&lt; &quot;You should specify an AutohostPort in the script&quot; &lt;&lt; std::endl;
-		}
+		server = new CGameServer(settings, false, data, gameSetup);
 
 		while (!server-&gt;HasFinished()) // check if still running
 #ifdef _WIN32
@@ -104,7 +97,6 @@
 			sleep(1);	// if so, wait 1  second
 #endif
 		delete server;	// delete the server after usage
-		delete gameSetup;
 	}
 	else
 	{


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001743.html">[Taspring-linux-commit] r6974 - trunk/rts/Sim/Misc
</A></li>
	<LI>Next message: <A HREF="001745.html">[Taspring-linux-commit] r6976 - in branches/caiinterface: . AI	AI/Bindings AI/Bindings/LegacyCpp AI/Bindings/LegacyCpp/Event	AI/Skirmish/KAIK AI/Skirmish/NullLegacyCppAI AI/Skirmish/RAI	rts/ExternalAI/Interface rts/build/scons
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1744">[ date ]</a>
              <a href="thread.html#1744">[ thread ]</a>
              <a href="subject.html#1744">[ subject ]</a>
              <a href="author.html#1744">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
