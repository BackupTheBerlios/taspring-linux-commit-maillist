<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r7026 - in trunk/rts: ExternalAI Game	Game/StartScripts Game/UI Lua Rendering Rendering/Textures	Rendering/UnitModels Sim/Features Sim/Misc Sim/MoveTypes	Sim/Projectiles Sim/Units Sim/Units/COB Sim/Units/CommandAI	Sim/Units/UnitTypes Sim/Weapons System System/Platform	System/Script System/Sync build/scons lib/gml
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-November/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r7026%20-%20in%20trunk/rts%3A%20ExternalAI%20Game%0A%09Game/StartScripts%20Game/UI%20Lua%20Rendering%20Rendering/Textures%0A%09Rendering/UnitModels%20Sim/Features%20Sim/Misc%20Sim/MoveTypes%0A%09Sim/Projectiles%20Sim/Units%20Sim/Units/COB%20Sim/Units/CommandAI%0A%09Sim/Units/UnitTypes%20Sim/Weapons%20System%20System/Platform%0A%09System/Script%20System/Sync%20build/scons%20lib/gml&In-Reply-To=%3C20081112222607.F126746E9%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001794.html">
   <LINK REL="Next"  HREF="001796.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r7026 - in trunk/rts: ExternalAI Game	Game/StartScripts Game/UI Lua Rendering Rendering/Textures	Rendering/UnitModels Sim/Features Sim/Misc Sim/MoveTypes	Sim/Projectiles Sim/Units Sim/Units/COB Sim/Units/CommandAI	Sim/Units/UnitTypes Sim/Weapons System System/Platform	System/Script System/Sync build/scons lib/gml</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r7026%20-%20in%20trunk/rts%3A%20ExternalAI%20Game%0A%09Game/StartScripts%20Game/UI%20Lua%20Rendering%20Rendering/Textures%0A%09Rendering/UnitModels%20Sim/Features%20Sim/Misc%20Sim/MoveTypes%0A%09Sim/Projectiles%20Sim/Units%20Sim/Units/COB%20Sim/Units/CommandAI%0A%09Sim/Units/UnitTypes%20Sim/Weapons%20System%20System/Platform%0A%09System/Script%20System/Sync%20build/scons%20lib/gml&In-Reply-To=%3C20081112222607.F126746E9%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r7026 - in trunk/rts: ExternalAI Game	Game/StartScripts Game/UI Lua Rendering Rendering/Textures	Rendering/UnitModels Sim/Features Sim/Misc Sim/MoveTypes	Sim/Projectiles Sim/Units Sim/Units/COB Sim/Units/CommandAI	Sim/Units/UnitTypes Sim/Weapons System System/Platform	System/Script System/Sync build/scons lib/gml">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Wed Nov 12 23:26:07 CET 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001794.html">[Taspring-linux-commit] r7025 - trunk/tools/DedicatedServer
</A></li>
        <LI>Next message: <A HREF="001796.html">[Taspring-linux-commit] r7027 - trunk
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1795">[ date ]</a>
              <a href="thread.html#1795">[ thread ]</a>
              <a href="subject.html#1795">[ subject ]</a>
              <a href="author.html#1795">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: tvo
Date: 2008-11-12 23:26:06 +0100 (Wed, 12 Nov 2008)
New Revision: 7026

Added:
   trunk/rts/Game/PlayerHandler.cpp
   trunk/rts/Game/PlayerHandler.h
   trunk/rts/Sim/Misc/TeamHandler.cpp
   trunk/rts/Sim/Misc/TeamHandler.h
Modified:
   trunk/rts/ExternalAI/AICallback.cpp
   trunk/rts/ExternalAI/AICheats.cpp
   trunk/rts/ExternalAI/GlobalAI.cpp
   trunk/rts/ExternalAI/GlobalAIHandler.cpp
   trunk/rts/Game/Game.cpp
   trunk/rts/Game/GameHelper.cpp
   trunk/rts/Game/GameServer.cpp
   trunk/rts/Game/Player.cpp
   trunk/rts/Game/Player.h
   trunk/rts/Game/PlayerRoster.cpp
   trunk/rts/Game/PreGame.cpp
   trunk/rts/Game/SelectedUnits.cpp
   trunk/rts/Game/SelectedUnitsAI.cpp
   trunk/rts/Game/StartScripts/CommanderScript.cpp
   trunk/rts/Game/StartScripts/CommanderScript2.cpp
   trunk/rts/Game/StartScripts/GlobalAITestScript.cpp
   trunk/rts/Game/StartScripts/SpawnScript.cpp
   trunk/rts/Game/UI/EndGameBox.cpp
   trunk/rts/Game/UI/GameSetupDrawer.cpp
   trunk/rts/Game/UI/HwMouseCursor.cpp
   trunk/rts/Game/UI/HwMouseCursor.h
   trunk/rts/Game/UI/MiniMap.cpp
   trunk/rts/Game/UI/MouseCursor.cpp
   trunk/rts/Game/UI/MouseHandler.cpp
   trunk/rts/Game/UI/QuitBox.cpp
   trunk/rts/Game/UI/ResourceBar.cpp
   trunk/rts/Game/UI/SelectionKeyHandler.cpp
   trunk/rts/Game/UI/ShareBox.cpp
   trunk/rts/Game/UI/TooltipConsole.cpp
   trunk/rts/Game/WaitCommandsAI.cpp
   trunk/rts/Lua/LuaGaia.cpp
   trunk/rts/Lua/LuaHandle.cpp
   trunk/rts/Lua/LuaHandleSynced.cpp
   trunk/rts/Lua/LuaIO.cpp
   trunk/rts/Lua/LuaOpenGL.cpp
   trunk/rts/Lua/LuaRules.cpp
   trunk/rts/Lua/LuaSyncedCtrl.cpp
   trunk/rts/Lua/LuaSyncedRead.cpp
   trunk/rts/Lua/LuaUnsyncedCtrl.cpp
   trunk/rts/Lua/LuaUnsyncedRead.cpp
   trunk/rts/Rendering/InMapDraw.cpp
   trunk/rts/Rendering/Textures/TextureHandler.cpp
   trunk/rts/Rendering/UnitModels/3DOParser.cpp
   trunk/rts/Rendering/UnitModels/UnitDrawer.cpp
   trunk/rts/Sim/Features/Feature.cpp
   trunk/rts/Sim/Misc/AirBaseHandler.cpp
   trunk/rts/Sim/Misc/GlobalSynced.cpp
   trunk/rts/Sim/Misc/GlobalSynced.h
   trunk/rts/Sim/Misc/InterceptHandler.cpp
   trunk/rts/Sim/Misc/LosHandler.cpp
   trunk/rts/Sim/Misc/RadarHandler.cpp
   trunk/rts/Sim/Misc/Team.cpp
   trunk/rts/Sim/MoveTypes/GroundMoveType.cpp
   trunk/rts/Sim/Projectiles/ProjectileHandler.cpp
   trunk/rts/Sim/Units/COB/CobInstance.cpp
   trunk/rts/Sim/Units/CommandAI/AirCAI.cpp
   trunk/rts/Sim/Units/CommandAI/BuilderCAI.cpp
   trunk/rts/Sim/Units/CommandAI/CommandAI.cpp
   trunk/rts/Sim/Units/CommandAI/FactoryCAI.cpp
   trunk/rts/Sim/Units/CommandAI/MobileCAI.cpp
   trunk/rts/Sim/Units/CommandAI/TransportCAI.cpp
   trunk/rts/Sim/Units/Unit.cpp
   trunk/rts/Sim/Units/UnitHandler.cpp
   trunk/rts/Sim/Units/UnitTypes/Builder.cpp
   trunk/rts/Sim/Units/UnitTypes/Factory.cpp
   trunk/rts/Sim/Units/UnitTypes/TransportUnit.cpp
   trunk/rts/Sim/Weapons/BeamLaser.cpp
   trunk/rts/Sim/Weapons/DGunWeapon.cpp
   trunk/rts/Sim/Weapons/PlasmaRepulser.cpp
   trunk/rts/Sim/Weapons/Weapon.cpp
   trunk/rts/System/LoadSaveHandler.cpp
   trunk/rts/System/Platform/ConfigHandler.cpp
   trunk/rts/System/Platform/ConfigHandler.h
   trunk/rts/System/Script/LuaBinder.cpp
   trunk/rts/System/Script/LuaFunctions.cpp
   trunk/rts/System/SpringApp.cpp
   trunk/rts/System/Sync/SyncDebugger.cpp
   trunk/rts/build/scons/rts.py
   trunk/rts/lib/gml/gml.cpp
Log:
* Refactored (part of) CGlobalSyncedStuff into new CTeamHandler and CPlayerHandler
* Changed configHandler from global variable disguised as singleton/monostate to real global variable
* Fixed not honoring config source argument when GML is enabled
* Fixed scons building with SSE properly (accidentally set -msse when compiling with x87 math and vv)
* Some other small cleanups



Modified: trunk/rts/ExternalAI/AICallback.cpp
===================================================================
--- trunk/rts/ExternalAI/AICallback.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/ExternalAI/AICallback.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -7,9 +7,9 @@
 #include &quot;Game/CameraHandler.h&quot;
 #include &quot;Game/GameHelper.h&quot;
 #include &quot;Game/GameSetup.h&quot;
-#include &quot;Game/Player.h&quot;
+#include &quot;Game/PlayerHandler.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Game/UI/MiniMap.h&quot;
 #include &quot;Game/UI/MouseHandler.h&quot;
 #include &quot;Lua/LuaRules.h&quot;
@@ -111,8 +111,8 @@
 
 	if (team != receivingTeamId) {
 		if (receivingTeamId &gt;= 0 &amp;&amp; receivingTeamId &lt; (MAX_TEAMS - 1)) {
-			if (gs-&gt;Team(receivingTeamId) &amp;&amp; gs-&gt;Team(team)) {
-				if (!gs-&gt;Team(receivingTeamId)-&gt;isDead &amp;&amp; !gs-&gt;Team(team)-&gt;isDead) {
+			if (teamHandler-&gt;Team(receivingTeamId) &amp;&amp; teamHandler-&gt;Team(team)) {
+				if (!teamHandler-&gt;Team(receivingTeamId)-&gt;isDead &amp;&amp; !teamHandler-&gt;Team(team)-&gt;isDead) {
 					// note: we can't use the existing SendShare()
 					// since its handler in CGame uses myPlayerNum
 					// (NETMSG_SHARE param) to determine which team
@@ -141,8 +141,8 @@
 
 	if (team != receivingTeamId) {
 		if (receivingTeamId &gt;= 0 &amp;&amp; receivingTeamId &lt; (MAX_TEAMS - 1)) {
-			if (gs-&gt;Team(receivingTeamId) &amp;&amp; gs-&gt;Team(team)) {
-				if (!gs-&gt;Team(receivingTeamId)-&gt;isDead &amp;&amp; !gs-&gt;Team(team)-&gt;isDead) {
+			if (teamHandler-&gt;Team(receivingTeamId) &amp;&amp; teamHandler-&gt;Team(team)) {
+				if (!teamHandler-&gt;Team(receivingTeamId)-&gt;isDead &amp;&amp; !teamHandler-&gt;Team(team)-&gt;isDead) {
 					// we must iterate over the ID's to check if
 					// all of them really belong to the AI's team
 					for (std::vector&lt;int&gt;::const_iterator it = unitIds.begin(); it != unitIds.end(); it++ ) {
@@ -208,12 +208,12 @@
 
 int CAICallback::GetMyAllyTeam()
 {
-	return gs-&gt;AllyTeam(team);
+	return teamHandler-&gt;AllyTeam(team);
 }
 
 int CAICallback::GetPlayerTeam(int playerId)
 {
-	CPlayer *pl = gs-&gt;players [playerId];
+	CPlayer* pl = playerHandler-&gt;Player(playerId);
 	if (pl-&gt;spectator)
 		return -1;
 	return pl-&gt;team;
@@ -221,8 +221,8 @@
 
 const char* CAICallback::GetTeamSide(int teamId)
 {
-	if (teamId &lt; gs-&gt;activeTeams &amp;&amp; gameSetup) {
-		return gs-&gt;Team(teamId)-&gt;side.c_str();
+	if (teamId &lt; teamHandler-&gt;ActiveTeams() &amp;&amp; gameSetup) {
+		return teamHandler-&gt;Team(teamId)-&gt;side.c_str();
 	} else {
 		// if this is not a GameSetup-type game but a
 		// GlobalAI-test one, the side-strings for all
@@ -369,8 +369,8 @@
 	if (CHECK_UNITID(unitId)) {
 		CUnit* unit = uh-&gt;units[unitId];
 		if (unit) {
-			const int allyTeam = gs-&gt;AllyTeam(team);
-			if (gs-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
+			const int allyTeam = teamHandler-&gt;AllyTeam(team);
+			if (teamHandler-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
 				return unit-&gt;aihint;
 			}
 			else if (unit-&gt;losStatus[allyTeam] &amp; LOS_INLOS) {
@@ -392,7 +392,7 @@
 	verify ();
 	if (CHECK_UNITID(unitId)) {
 		CUnit* unit=uh-&gt;units[unitId];
-		if(unit &amp;&amp; (unit-&gt;losStatus[gs-&gt;AllyTeam(team)] &amp; LOS_INLOS)){
+		if(unit &amp;&amp; (unit-&gt;losStatus[teamHandler-&gt;AllyTeam(team)] &amp; LOS_INLOS)){
 			return unit-&gt;team;
 		}
 	}
@@ -404,7 +404,7 @@
 	verify ();
 	if (CHECK_UNITID(unitId)) {
 		CUnit* unit=uh-&gt;units[unitId];
-		if(unit &amp;&amp; (unit-&gt;losStatus[gs-&gt;AllyTeam(team)] &amp; LOS_INLOS)){
+		if(unit &amp;&amp; (unit-&gt;losStatus[teamHandler-&gt;AllyTeam(team)] &amp; LOS_INLOS)){
 			return unit-&gt;allyteam;
 		}
 	}
@@ -418,9 +418,9 @@
 		CUnit* unit = uh-&gt;units[unitId];
 
 		if (unit) {
-			const int allyTeam = gs-&gt;AllyTeam(team);
+			const int allyTeam = teamHandler-&gt;AllyTeam(team);
 
-			if (gs-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
+			if (teamHandler-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
 				return unit-&gt;health;
 			}
 			else if (unit-&gt;losStatus[allyTeam] &amp; LOS_INLOS) {
@@ -446,8 +446,8 @@
 	if (CHECK_UNITID(unitId)) {
 		CUnit* unit = uh-&gt;units[unitId];
 		if (unit) {
-			const int allyTeam = gs-&gt;AllyTeam(team);
-			if (gs-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
+			const int allyTeam = teamHandler-&gt;AllyTeam(team);
+			if (teamHandler-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
 				return unit-&gt;maxHealth;
 			}
 			else if (unit-&gt;losStatus[allyTeam] &amp; LOS_INLOS) {
@@ -471,8 +471,8 @@
 	if (CHECK_UNITID(unitId)) {
 		CUnit* unit = uh-&gt;units[unitId];
 		if (unit) {
-			const int allyTeam = gs-&gt;AllyTeam(team);
-			if (gs-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
+			const int allyTeam = teamHandler-&gt;AllyTeam(team);
+			if (teamHandler-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
 				return unit-&gt;maxSpeed;
 			}
 			else if (unit-&gt;losStatus[allyTeam] &amp; LOS_INLOS) {
@@ -495,8 +495,8 @@
 	if (CHECK_UNITID(unitId)) {
 		CUnit* unit = uh-&gt;units[unitId];
 		if (unit) {
-			const int allyTeam = gs-&gt;AllyTeam(team);
-			if (gs-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
+			const int allyTeam = teamHandler-&gt;AllyTeam(team);
+			if (teamHandler-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
 				return unit-&gt;power;
 			}
 			else if (unit-&gt;losStatus[allyTeam] &amp; LOS_INLOS) {
@@ -519,7 +519,7 @@
 	verify ();
 	if (CHECK_UNITID(unitId)) {
 		CUnit* unit=uh-&gt;units[unitId];
-		if (unit &amp;&amp; (unit-&gt;losStatus[gs-&gt;AllyTeam(team)] &amp; LOS_INLOS)) {
+		if (unit &amp;&amp; (unit-&gt;losStatus[teamHandler-&gt;AllyTeam(team)] &amp; LOS_INLOS)) {
 			return unit-&gt;experience;
 		}
 	}
@@ -532,8 +532,8 @@
 	if (CHECK_UNITID(unitId)) {
 		CUnit* unit = uh-&gt;units[unitId];
 		if (unit) {
-			const int allyTeam = gs-&gt;AllyTeam(team);
-			if (gs-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
+			const int allyTeam = teamHandler-&gt;AllyTeam(team);
+			if (teamHandler-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
 				return unit-&gt;maxRange;
 			}
 			else if (unit-&gt;losStatus[allyTeam] &amp; LOS_INLOS) {
@@ -557,8 +557,8 @@
 		CUnit* unit = uh-&gt;units[unitId];
 		if (unit) {
 			const UnitDef* unitDef = unit-&gt;unitDef;
-			const int allyTeam = gs-&gt;AllyTeam(team);
-			if (gs-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
+			const int allyTeam = teamHandler-&gt;AllyTeam(team);
+			if (teamHandler-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
 				return unitDef;
 			}
 			const unsigned short losStatus = unit-&gt;losStatus[allyTeam];
@@ -591,8 +591,8 @@
 	verify ();
 	if (CHECK_UNITID(unitId)) {
 		CUnit* unit=uh-&gt;units[unitId];
-		if(unit &amp;&amp; (unit-&gt;losStatus[gs-&gt;AllyTeam(team)] &amp; (LOS_INLOS|LOS_INRADAR))){
-			return helper-&gt;GetUnitErrorPos(unit,gs-&gt;AllyTeam(team));
+		if(unit &amp;&amp; (unit-&gt;losStatus[teamHandler-&gt;AllyTeam(team)] &amp; (LOS_INLOS|LOS_INRADAR))){
+			return helper-&gt;GetUnitErrorPos(unit,teamHandler-&gt;AllyTeam(team));
 		}
 	}
 	return ZeroVector;
@@ -602,7 +602,7 @@
 	verify ();
 	if (CHECK_UNITID(unitId)) {
 		CUnit* unit=uh-&gt;units[unitId];
-		if(unit &amp;&amp; (unit-&gt;losStatus[gs-&gt;AllyTeam(team)] &amp; LOS_INLOS)){
+		if(unit &amp;&amp; (unit-&gt;losStatus[teamHandler-&gt;AllyTeam(team)] &amp; LOS_INLOS)){
 			return unit-&gt;buildFacing;
 		}
 	}
@@ -613,7 +613,7 @@
 	verify ();
 	if (CHECK_UNITID(unitId)) {
 		CUnit* unit=uh-&gt;units[unitId];
-		if(unit &amp;&amp; (unit-&gt;losStatus[gs-&gt;AllyTeam(team)] &amp; LOS_INLOS)){
+		if(unit &amp;&amp; (unit-&gt;losStatus[teamHandler-&gt;AllyTeam(team)] &amp; LOS_INLOS)){
 			return unit-&gt;isCloaked;
 		}
 	}
@@ -625,7 +625,7 @@
 
 	if (CHECK_UNITID(unitId)) {
 		CUnit* unit = uh-&gt;units[unitId];
-		if (unit &amp;&amp; (unit-&gt;losStatus[gs-&gt;AllyTeam(team)] &amp; LOS_INLOS)) {
+		if (unit &amp;&amp; (unit-&gt;losStatus[teamHandler-&gt;AllyTeam(team)] &amp; LOS_INLOS)) {
 			return unit-&gt;stunned;
 		}
 	}
@@ -639,7 +639,7 @@
 	if (CHECK_UNITID(unitId)) {
 		CUnit* unit = uh-&gt;units[unitId];
 
-		if (unit &amp;&amp; (unit-&gt;losStatus[gs-&gt;AllyTeam(team)] &amp; LOS_INLOS)) {
+		if (unit &amp;&amp; (unit-&gt;losStatus[teamHandler-&gt;AllyTeam(team)] &amp; LOS_INLOS)) {
 			if (unit-&gt;IsNeutral())
 				return true;
 		}
@@ -681,8 +681,8 @@
 	for (std::list&lt;CUnit*&gt;::iterator ui = uh-&gt;activeUnits.begin(); ui != uh-&gt;activeUnits.end(); ++ui) {
 		CUnit* u = *ui;
 
-		if (!gs-&gt;Ally(u-&gt;allyteam, gs-&gt;AllyTeam(team)) &amp;&amp;
-		    (u-&gt;losStatus[gs-&gt;AllyTeam(team)] &amp; LOS_INLOS)) {
+		if (!teamHandler-&gt;Ally(u-&gt;allyteam, teamHandler-&gt;AllyTeam(team)) &amp;&amp;
+		    (u-&gt;losStatus[teamHandler-&gt;AllyTeam(team)] &amp; LOS_INLOS)) {
 			if (!IsUnitNeutral(u-&gt;id)) {
 				unitIds[a++] = u-&gt;id;
 			}
@@ -701,7 +701,7 @@
 	for (std::list&lt;CUnit*&gt;::iterator ui = uh-&gt;activeUnits.begin(); ui != uh-&gt;activeUnits.end(); ++ui) {
 		CUnit* u = *ui;
 
-		if (!gs-&gt;Ally(u-&gt;allyteam, gs-&gt;AllyTeam(team)) &amp;&amp; (u-&gt;losStatus[gs-&gt;AllyTeam(team)] &amp; (LOS_INLOS | LOS_INRADAR))) {
+		if (!teamHandler-&gt;Ally(u-&gt;allyteam, teamHandler-&gt;AllyTeam(team)) &amp;&amp; (u-&gt;losStatus[teamHandler-&gt;AllyTeam(team)] &amp; (LOS_INLOS | LOS_INRADAR))) {
 			if (!IsUnitNeutral(u-&gt;id)) {
 				unitIds[a++] = u-&gt;id;
 			}
@@ -721,7 +721,7 @@
 	for (ui = unit.begin(); ui != unit.end(); ++ui) {
 		CUnit* u = *ui;
 
-		if (!gs-&gt;Ally(u-&gt;allyteam, gs-&gt;AllyTeam(team)) &amp;&amp; (u-&gt;losStatus[gs-&gt;AllyTeam(team)] &amp; LOS_INLOS)) {
+		if (!teamHandler-&gt;Ally(u-&gt;allyteam, teamHandler-&gt;AllyTeam(team)) &amp;&amp; (u-&gt;losStatus[teamHandler-&gt;AllyTeam(team)] &amp; LOS_INLOS)) {
 			if (!IsUnitNeutral(u-&gt;id)) {
 				unitIds[a] = u-&gt;id;
 				++a;
@@ -741,7 +741,7 @@
 	for (std::list&lt;CUnit*&gt;::iterator ui = uh-&gt;activeUnits.begin(); ui != uh-&gt;activeUnits.end(); ++ui) {
 		CUnit* u = *ui;
 
-		if (gs-&gt;Ally(u-&gt;allyteam, gs-&gt;AllyTeam(team))) {
+		if (teamHandler-&gt;Ally(u-&gt;allyteam, teamHandler-&gt;AllyTeam(team))) {
 			// IsUnitNeutral does a LOS check, but inconsequential
 			// since we can always see friendly units anyway
 			if (!IsUnitNeutral(u-&gt;id)) {
@@ -763,7 +763,7 @@
 	for (ui = unit.begin(); ui != unit.end(); ++ui) {
 		CUnit* u = *ui;
 
-		if (gs-&gt;Ally(u-&gt;allyteam, gs-&gt;AllyTeam(team))) {
+		if (teamHandler-&gt;Ally(u-&gt;allyteam, teamHandler-&gt;AllyTeam(team))) {
 			// IsUnitNeutral does a LOS check, but inconsequential
 			// since we can always see friendly units anyway
 			if (!IsUnitNeutral(u-&gt;id)) {
@@ -900,17 +900,17 @@
 
 const unsigned short* CAICallback::GetLosMap()
 {
-	return &amp;loshandler-&gt;losMap[gs-&gt;AllyTeam(team)].front();
+	return &amp;loshandler-&gt;losMap[teamHandler-&gt;AllyTeam(team)].front();
 }
 
 const unsigned short* CAICallback::GetRadarMap()
 {
-	return &amp;radarhandler-&gt;radarMaps[gs-&gt;AllyTeam(team)].front();
+	return &amp;radarhandler-&gt;radarMaps[teamHandler-&gt;AllyTeam(team)].front();
 }
 
 const unsigned short* CAICallback::GetJammerMap()
 {
-	return &amp;radarhandler-&gt;jammerMaps[gs-&gt;AllyTeam(team)].front();
+	return &amp;radarhandler-&gt;jammerMaps[teamHandler-&gt;AllyTeam(team)].front();
 }
 
 const unsigned char* CAICallback::GetMetalMap()
@@ -1011,7 +1011,7 @@
 	CFeature* f;
 	BuildInfo bi(unitDef, pos, facing);
 	bi.pos=helper-&gt;Pos2BuildPos (bi);
-	return !!uh-&gt;TestUnitBuildSquare(bi,f,gs-&gt;AllyTeam(team));
+	return !!uh-&gt;TestUnitBuildSquare(bi,f,teamHandler-&gt;AllyTeam(team));
 }
 
 
@@ -1053,7 +1053,7 @@
 {
 	if (!unitdef) return float3(-1.0f,0.0f,0.0f);
 	CFeature* feature;
-	int allyteam=gs-&gt;AllyTeam(team);
+	int allyteam=teamHandler-&gt;AllyTeam(team);
 
 	int endr = (int)(searchRadius / (SQUARE_SIZE*2));
 	const vector&lt;SearchOffset&gt;&amp; ofs = GetSearchOffsetTable (endr);
@@ -1100,49 +1100,49 @@
 
 float CAICallback::GetMetal()
 {
-	return gs-&gt;Team(team)-&gt;metal;
+	return teamHandler-&gt;Team(team)-&gt;metal;
 }
 
 float CAICallback::GetMetalIncome()
 {
-	return gs-&gt;Team(team)-&gt;prevMetalIncome;
+	return teamHandler-&gt;Team(team)-&gt;prevMetalIncome;
 }
 
 float CAICallback::GetMetalUsage()
 {
-	return gs-&gt;Team(team)-&gt;prevMetalExpense;
+	return teamHandler-&gt;Team(team)-&gt;prevMetalExpense;
 }
 
 float CAICallback::GetMetalStorage()
 {
-	return gs-&gt;Team(team)-&gt;metalStorage;
+	return teamHandler-&gt;Team(team)-&gt;metalStorage;
 }
 
 float CAICallback::GetEnergy()
 {
-	return gs-&gt;Team(team)-&gt;energy;
+	return teamHandler-&gt;Team(team)-&gt;energy;
 }
 
 float CAICallback::GetEnergyIncome()
 {
-	return gs-&gt;Team(team)-&gt;prevEnergyIncome;
+	return teamHandler-&gt;Team(team)-&gt;prevEnergyIncome;
 }
 
 float CAICallback::GetEnergyUsage()
 {
-	return gs-&gt;Team(team)-&gt;prevEnergyExpense;
+	return teamHandler-&gt;Team(team)-&gt;prevEnergyExpense;
 }
 
 float CAICallback::GetEnergyStorage()
 {
-	return gs-&gt;Team(team)-&gt;energyStorage;
+	return teamHandler-&gt;Team(team)-&gt;energyStorage;
 }
 
 bool CAICallback::GetUnitResourceInfo (int unitId, UnitResourceInfo *i)
 {
 	if (CHECK_UNITID(unitId)) {
 		CUnit* unit=uh-&gt;units[unitId];
-		if(unit &amp;&amp; (unit-&gt;losStatus[gs-&gt;AllyTeam(team)] &amp; LOS_INLOS))
+		if(unit &amp;&amp; (unit-&gt;losStatus[teamHandler-&gt;AllyTeam(team)] &amp; LOS_INLOS))
 		{
 			i-&gt;energyMake = unit-&gt;energyMake;
 			i-&gt;energyUse = unit-&gt;energyUse;
@@ -1159,7 +1159,7 @@
 	verify ();
 	if (CHECK_UNITID(unitId)) {
 		CUnit* unit=uh-&gt;units[unitId];
-		if(unit &amp;&amp; (unit-&gt;losStatus[gs-&gt;AllyTeam(team)] &amp; LOS_INLOS))
+		if(unit &amp;&amp; (unit-&gt;losStatus[teamHandler-&gt;AllyTeam(team)] &amp; LOS_INLOS))
 			return unit-&gt;activated;
 	}
 	return false;
@@ -1170,7 +1170,7 @@
 	verify ();
 	if (CHECK_UNITID(unitId)) {
 		CUnit* unit=uh-&gt;units[unitId];
-		if(unit &amp;&amp; (unit-&gt;losStatus[gs-&gt;AllyTeam(team)] &amp; LOS_INLOS))
+		if(unit &amp;&amp; (unit-&gt;losStatus[teamHandler-&gt;AllyTeam(team)] &amp; LOS_INLOS))
 			return unit-&gt;beingBuilt;
 	}
 	return false;
@@ -1180,7 +1180,7 @@
 {
 	verify ();
 	int i = 0;
-	int allyteam = gs-&gt;AllyTeam(team);
+	int allyteam = teamHandler-&gt;AllyTeam(team);
 
 	const CFeatureSet&amp; fset = featureHandler-&gt;GetActiveFeatures();
 	for (CFeatureSet::const_iterator it = fset.begin(); it != fset.end(); ++i) {
@@ -1201,7 +1201,7 @@
 {
 	verify ();
 	vector&lt;CFeature*&gt; ft = qf-&gt;GetFeaturesExact (pos, radius);
-	int allyteam = gs-&gt;AllyTeam(team);
+	int allyteam = teamHandler-&gt;AllyTeam(team);
 	int n = 0;
 
 	for (int a=0;a&lt;ft.size();a++)
@@ -1228,7 +1228,7 @@
 
 	if (it != fset.end()) {
 		const CFeature *f = *it;
-		int allyteam = gs-&gt;AllyTeam(team);
+		int allyteam = teamHandler-&gt;AllyTeam(team);
 		if (f-&gt;allyteam &lt; 0 || f-&gt;allyteam == allyteam || loshandler-&gt;InLos(f-&gt;pos,allyteam))
 			return f-&gt;def;
 	}
@@ -1249,7 +1249,7 @@
 
 	if (it != fset.end()) {
 		const CFeature *f = *it;
-		int allyteam = gs-&gt;AllyTeam(team);
+		int allyteam = teamHandler-&gt;AllyTeam(team);
 		if (f-&gt;allyteam &lt; 0 || f-&gt;allyteam == allyteam || loshandler-&gt;InLos(f-&gt;pos,allyteam))
 			return f-&gt;health;
 	}
@@ -1265,7 +1265,7 @@
 
 	if (it != fset.end()) {
 		const CFeature *f = *it;
-		int allyteam = gs-&gt;AllyTeam(team);
+		int allyteam = teamHandler-&gt;AllyTeam(team);
 		if (f-&gt;allyteam &lt; 0 || f-&gt;allyteam == allyteam || loshandler-&gt;InLos(f-&gt;pos,allyteam))
 			return f-&gt;reclaimLeft;
 	}
@@ -1281,7 +1281,7 @@
 
 	if (it != fset.end()) {
 		const CFeature *f = *it;
-		int allyteam = gs-&gt;AllyTeam(team);
+		int allyteam = teamHandler-&gt;AllyTeam(team);
 		if (f-&gt;allyteam &lt; 0 || f-&gt;allyteam == allyteam || loshandler-&gt;InLos(f-&gt;pos,allyteam))
 			return f-&gt;pos;
 	}
@@ -1425,14 +1425,14 @@
 	verify ();
 	if (CHECK_UNITID(unitId)) {
 		CUnit* unit = uh-&gt;units[unitId];
-		const int allyTeam = gs-&gt;AllyTeam(team);
+		const int allyTeam = teamHandler-&gt;AllyTeam(team);
 		if (!(unit &amp;&amp; (unit-&gt;losStatus[allyTeam] &amp; LOS_INLOS))) {
 			return false;  //return if the unit doesn't exist or cant be seen
 		}
 
 		switch (property) {
 			case AIVAL_UNITDEF: {
-				if (gs-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
+				if (teamHandler-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
 					(*(const UnitDef**)data) = unit-&gt;unitDef;
 				} else {
 					const UnitDef* unitDef = unit-&gt;unitDef;
@@ -1450,14 +1450,14 @@
 				return true;
 			}
 			case AIVAL_STOCKPILED: {
-				if (!unit-&gt;stockpileWeapon || !gs-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
+				if (!unit-&gt;stockpileWeapon || !teamHandler-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
 					return false;
 				}
 				(*(int*)data) = unit-&gt;stockpileWeapon-&gt;numStockpiled;
 				return true;
 			}
 			case AIVAL_STOCKPILE_QUED: {
-				if (!unit-&gt;stockpileWeapon || !gs-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
+				if (!unit-&gt;stockpileWeapon || !teamHandler-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
 					return false;
 				}
 				(*(int*)data) = unit-&gt;stockpileWeapon-&gt;numStockpileQued;
@@ -1531,7 +1531,7 @@
 	GML_RECMUTEX_LOCK(sel); // GetSelectedUnit
 	// check if the allyteam of the player running
 	// the AI lib matches the AI's actual allyteam
-	if (gu-&gt;myAllyTeam == gs-&gt;AllyTeam(team)) {
+	if (gu-&gt;myAllyTeam == teamHandler-&gt;AllyTeam(team)) {
 		for (CUnitSet::iterator ui = selectedUnits.selectedUnits.begin(); ui != selectedUnits.selectedUnits.end(); ++ui)
 			unitIds[a++] = (*ui)-&gt;id;
 	}
@@ -1541,7 +1541,7 @@
 
 float3 CAICallback::GetMousePos() {
 	verify ();
-	if (gu-&gt;myAllyTeam == gs-&gt;AllyTeam(team))
+	if (gu-&gt;myAllyTeam == teamHandler-&gt;AllyTeam(team))
 		return inMapDrawer-&gt;GetMouseMapPos();
 	else
 		return ZeroVector;
@@ -1553,13 +1553,13 @@
 	int a=0;
 	verify ();
 
-	if (gu-&gt;myAllyTeam != gs-&gt;AllyTeam(team))
+	if (gu-&gt;myAllyTeam != teamHandler-&gt;AllyTeam(team))
 		return 0;
 
 	for (int i=0;i&lt;inMapDrawer-&gt;numQuads;i++){
 		if(!inMapDrawer-&gt;drawQuads[i].points.empty()){
 			for(std::list&lt;CInMapDraw::MapPoint&gt;::iterator mp=inMapDrawer-&gt;drawQuads[i].points.begin();mp!=inMapDrawer-&gt;drawQuads[i].points.end();++mp){
-				if(mp-&gt;color==gs-&gt;Team(team)-&gt;color) { //Maybe add so that markers of your ally team would be also found?
+				if(mp-&gt;color==teamHandler-&gt;Team(team)-&gt;color) { //Maybe add so that markers of your ally team would be also found?
 					pm[a].pos=mp-&gt;pos;
 					pm[a].color=mp-&gt;color;
 					pm[a].label=mp-&gt;label.c_str();
@@ -1577,13 +1577,13 @@
 	int a=0;
 	verify ();
 
-	if (gu-&gt;myAllyTeam != gs-&gt;AllyTeam(team))
+	if (gu-&gt;myAllyTeam != teamHandler-&gt;AllyTeam(team))
 		return 0;
 
 	for (int i=0;i&lt;inMapDrawer-&gt;numQuads;i++){
 		if(!inMapDrawer-&gt;drawQuads[i].points.empty()){
 			for(std::list&lt;CInMapDraw::MapLine&gt;::iterator ml=inMapDrawer-&gt;drawQuads[i].lines.begin();ml!=inMapDrawer-&gt;drawQuads[i].lines.end();++ml){
-				if(ml-&gt;color==gs-&gt;Team(team)-&gt;color){ //Maybe add so that markers of your ally team would be also found?
+				if(ml-&gt;color==teamHandler-&gt;Team(team)-&gt;color){ //Maybe add so that markers of your ally team would be also found?
 					lm[a].pos=ml-&gt;pos;
 					lm[a].color=ml-&gt;color;
 					lm[a].pos2=ml-&gt;pos2;
@@ -1619,7 +1619,7 @@
 
 const float3 *CAICallback::GetStartPos()
 {
-	return &amp;gs-&gt;Team(team)-&gt;startPos;
+	return &amp;teamHandler-&gt;Team(team)-&gt;startPos;
 }
 
 

Modified: trunk/rts/ExternalAI/AICheats.cpp
===================================================================
--- trunk/rts/ExternalAI/AICheats.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/ExternalAI/AICheats.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -9,7 +9,7 @@
 #include &quot;Sim/Units/UnitLoader.h&quot;
 #include &quot;NetProtocol.h&quot;
 #include &quot;Sim/Misc/GlobalSynced.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Game/GameServer.h&quot;
 #include &quot;Game/GameSetup.h&quot;
 #include &quot;mmgr.h&quot;
@@ -50,20 +50,20 @@
 void CAICheats::SetMyHandicap(float handicap)
 {
 	if (!OnlyPassiveCheats()) {
-		gs-&gt;Team(ai-&gt;team)-&gt;handicap = 1 + handicap / 100;
+		teamHandler-&gt;Team(ai-&gt;team)-&gt;handicap = 1 + handicap / 100;
 	}
 }
 
 void CAICheats::GiveMeMetal(float amount)
 {
 	if (!OnlyPassiveCheats())
-		gs-&gt;Team(ai-&gt;team)-&gt;metal += amount;
+		teamHandler-&gt;Team(ai-&gt;team)-&gt;metal += amount;
 }
 
 void CAICheats::GiveMeEnergy(float amount)
 {
 	if (!OnlyPassiveCheats())
-		gs-&gt;Team(ai-&gt;team)-&gt;energy += amount;
+		teamHandler-&gt;Team(ai-&gt;team)-&gt;energy += amount;
 }
 
 int CAICheats::CreateUnit(const char* name, float3 pos)
@@ -106,7 +106,7 @@
 	for (list&lt;CUnit*&gt;::iterator ui = uh-&gt;activeUnits.begin(); ui != uh-&gt;activeUnits.end(); ++ui) {
 		CUnit* u = *ui;
 
-		if (!gs-&gt;Ally(u-&gt;allyteam, gs-&gt;AllyTeam(ai-&gt;team))) {
+		if (!teamHandler-&gt;Ally(u-&gt;allyteam, teamHandler-&gt;AllyTeam(ai-&gt;team))) {
 			if (!IsUnitNeutral(u-&gt;id)) {
 				units[a++] = u-&gt;id;
 			}
@@ -125,7 +125,7 @@
 	for (ui = unit.begin(); ui != unit.end(); ++ui) {
 		CUnit* u = *ui;
 
-		if (!gs-&gt;Ally(u-&gt;allyteam, gs-&gt;AllyTeam(ai-&gt;team))) {
+		if (!teamHandler-&gt;Ally(u-&gt;allyteam, teamHandler-&gt;AllyTeam(ai-&gt;team))) {
 			if (!IsUnitNeutral(u-&gt;id)) {
 				units[a] = u-&gt;id;
 				++a;

Modified: trunk/rts/ExternalAI/GlobalAI.cpp
===================================================================
--- trunk/rts/ExternalAI/GlobalAI.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/ExternalAI/GlobalAI.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -10,6 +10,7 @@
 #include &quot;LogOutput.h&quot;
 #include &quot;mmgr.h&quot;
 #include &quot;Sim/Misc/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
 
@@ -159,15 +160,15 @@
 						ai-&gt;UnitFinished(a);
 					} HANDLE_EXCEPTION;
 			} else {
-				if ((uh-&gt;units[a]-&gt;allyteam == gs-&gt;AllyTeam(team)) || gs-&gt;Ally(gs-&gt;AllyTeam(team), uh-&gt;units[a]-&gt;allyteam)) {
+				if ((uh-&gt;units[a]-&gt;allyteam == teamHandler-&gt;AllyTeam(team)) || teamHandler-&gt;Ally(teamHandler-&gt;AllyTeam(team), uh-&gt;units[a]-&gt;allyteam)) {
 					/* do nothing */
 				} else {
-					if (uh-&gt;units[a]-&gt;losStatus[gs-&gt;AllyTeam(team)] &amp; (LOS_INRADAR | LOS_INLOS)) {
+					if (uh-&gt;units[a]-&gt;losStatus[teamHandler-&gt;AllyTeam(team)] &amp; (LOS_INRADAR | LOS_INLOS)) {
 						try {
 							ai-&gt;EnemyEnterRadar(a);
 						} HANDLE_EXCEPTION;
 					}
-					if (uh-&gt;units[a]-&gt;losStatus[gs-&gt;AllyTeam(team)] &amp; LOS_INLOS) {
+					if (uh-&gt;units[a]-&gt;losStatus[teamHandler-&gt;AllyTeam(team)] &amp; LOS_INLOS) {
 						try {
 							ai-&gt;EnemyEnterLOS(a);
 						} HANDLE_EXCEPTION;

Modified: trunk/rts/ExternalAI/GlobalAIHandler.cpp
===================================================================
--- trunk/rts/ExternalAI/GlobalAIHandler.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/ExternalAI/GlobalAIHandler.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -4,8 +4,8 @@
 #include &quot;IGlobalAI.h&quot;
 #include &quot;Sim/Misc/GlobalSynced.h&quot;
 #include &quot;Game/GameHelper.h&quot;
-#include &quot;Game/Player.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
+#include &quot;Game/PlayerHandler.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;TimeProfiler.h&quot;
@@ -95,7 +95,7 @@
 void CGlobalAIHandler::Load(std::istream *s)
 {
 	try {
-		for(int a=0;a&lt;gs-&gt;activeTeams;++a)
+		for(int a=0;a&lt;teamHandler-&gt;ActiveTeams();++a)
 			if(ais[a])
 				ais[a]-&gt;Load(s);
 	} HANDLE_EXCEPTION;
@@ -104,7 +104,7 @@
 void CGlobalAIHandler::Save(std::ostream *s)
 {
 	try {
-		for(int a=0;a&lt;gs-&gt;activeTeams;++a)
+		for(int a=0;a&lt;teamHandler-&gt;ActiveTeams();++a)
 			if(ais[a])
 				ais[a]-&gt;Save(s);
 	} HANDLE_EXCEPTION;
@@ -114,7 +114,7 @@
 {
 	SCOPED_TIMER(&quot;Global AI&quot;)
 	try {
-		for(int a=0;a&lt;gs-&gt;activeTeams;++a)
+		for(int a=0;a&lt;teamHandler-&gt;ActiveTeams();++a)
 			if(ais[a])
 				ais[a]-&gt;Update();
 	} HANDLE_EXCEPTION;
@@ -123,7 +123,7 @@
 void CGlobalAIHandler::PreDestroy ()
 {
 	try {
-		for(int a=0;a&lt;gs-&gt;activeTeams;a++)
+		for(int a=0;a&lt;teamHandler-&gt;ActiveTeams();a++)
 			if(ais[a])
 				ais[a]-&gt;PreDestroy ();
 	} HANDLE_EXCEPTION;
@@ -132,8 +132,8 @@
 void CGlobalAIHandler::UnitEnteredLos(CUnit* unit, int allyteam)
 {
 	if (hasAI) {
-		for (int a = 0; a &lt; gs-&gt;activeTeams; ++a) {
-			if (ais[a] &amp;&amp; gs-&gt;AllyTeam(a) == allyteam &amp;&amp; !gs-&gt;Ally(allyteam, unit-&gt;allyteam))
+		for (int a = 0; a &lt; teamHandler-&gt;ActiveTeams(); ++a) {
+			if (ais[a] &amp;&amp; teamHandler-&gt;AllyTeam(a) == allyteam &amp;&amp; !teamHandler-&gt;Ally(allyteam, unit-&gt;allyteam))
 				try {
 					ais[a]-&gt;ai-&gt;EnemyEnterLOS(unit-&gt;id);
 				} HANDLE_EXCEPTION;
@@ -144,8 +144,8 @@
 void CGlobalAIHandler::UnitLeftLos(CUnit* unit,int allyteam)
 {
 	if(hasAI){
-		for(int a=0;a&lt;gs-&gt;activeTeams;++a){
-			if(ais[a] &amp;&amp; gs-&gt;AllyTeam(a)==allyteam &amp;&amp; !gs-&gt;Ally(allyteam,unit-&gt;allyteam))
+		for(int a=0;a&lt;teamHandler-&gt;ActiveTeams();++a){
+			if(ais[a] &amp;&amp; teamHandler-&gt;AllyTeam(a)==allyteam &amp;&amp; !teamHandler-&gt;Ally(allyteam,unit-&gt;allyteam))
 				try {
 					ais[a]-&gt;ai-&gt;EnemyLeaveLOS(unit-&gt;id);
 				} HANDLE_EXCEPTION;
@@ -156,8 +156,8 @@
 void CGlobalAIHandler::UnitEnteredRadar(CUnit* unit,int allyteam)
 {
 	if(hasAI){
-		for(int a=0;a&lt;gs-&gt;activeTeams;++a){
-			if(ais[a] &amp;&amp; gs-&gt;AllyTeam(a)==allyteam &amp;&amp; !gs-&gt;Ally(allyteam,unit-&gt;allyteam))
+		for(int a=0;a&lt;teamHandler-&gt;ActiveTeams();++a){
+			if(ais[a] &amp;&amp; teamHandler-&gt;AllyTeam(a)==allyteam &amp;&amp; !teamHandler-&gt;Ally(allyteam,unit-&gt;allyteam))
 				try {
 					ais[a]-&gt;ai-&gt;EnemyEnterRadar(unit-&gt;id);
 				} HANDLE_EXCEPTION;
@@ -168,8 +168,8 @@
 void CGlobalAIHandler::UnitLeftRadar(CUnit* unit,int allyteam)
 {
 	if(hasAI){
-		for(int a=0;a&lt;gs-&gt;activeTeams;++a) {
-			if(ais[a] &amp;&amp; gs-&gt;AllyTeam(a)==allyteam &amp;&amp; !gs-&gt;Ally(allyteam,unit-&gt;allyteam))
+		for(int a=0;a&lt;teamHandler-&gt;ActiveTeams();++a) {
+			if(ais[a] &amp;&amp; teamHandler-&gt;AllyTeam(a)==allyteam &amp;&amp; !teamHandler-&gt;Ally(allyteam,unit-&gt;allyteam))
 			{
 				try {
 					ais[a]-&gt;ai-&gt;EnemyLeaveRadar(unit-&gt;id);
@@ -207,8 +207,8 @@
 {
 	if(hasAI){
 		try {
-			for(int a=0;a&lt;gs-&gt;activeTeams;++a){
-				if(ais[a] &amp;&amp; !gs-&gt;Ally(gs-&gt;AllyTeam(a),unit-&gt;allyteam) &amp;&amp; (ais[a]-&gt;cheatevents || (unit-&gt;losStatus[a] &amp; (LOS_INLOS | LOS_INRADAR))))
+			for(int a=0;a&lt;teamHandler-&gt;ActiveTeams();++a){
+				if(ais[a] &amp;&amp; !teamHandler-&gt;Ally(teamHandler-&gt;AllyTeam(a),unit-&gt;allyteam) &amp;&amp; (ais[a]-&gt;cheatevents || (unit-&gt;losStatus[a] &amp; (LOS_INLOS | LOS_INRADAR))))
 					ais[a]-&gt;ai-&gt;EnemyDestroyed(unit-&gt;id,attacker?attacker-&gt;id:0);
 			}
 			if(ais[unit-&gt;team])
@@ -219,12 +219,12 @@
 
 bool CGlobalAIHandler::CreateGlobalAI(int teamID, const char* dll)
 {
-	if ((teamID &lt; 0) || (teamID &gt;= gs-&gt;activeTeams)) {
+	if ((teamID &lt; 0) || (teamID &gt;= teamHandler-&gt;ActiveTeams())) {
 		return false;
 	}
 
 	if (strncmp(dll, &quot;LuaAI:&quot;, 6) == 0) {
-		CTeam* team = gs-&gt;Team(teamID);
+		CTeam* team = teamHandler-&gt;Team(teamID);
 		if (team != NULL) {
 			team-&gt;luaAI = (dll + 6);
 			return true;
@@ -281,7 +281,7 @@
 void CGlobalAIHandler::GotChatMsg(const char* msg, int player)
 {
 	if(hasAI){
-		for(int a=0;a&lt;gs-&gt;activeTeams;++a)
+		for(int a=0;a&lt;teamHandler-&gt;ActiveTeams();++a)
 		{
 			if(ais[a])
 			{
@@ -308,7 +308,7 @@
 
 			if(attacker) {
 				int a = attacker-&gt;team;
-				if(ais[attacker-&gt;team] &amp;&amp; !gs-&gt;Ally(gs-&gt;AllyTeam(a),attacked-&gt;allyteam) &amp;&amp; (ais[a]-&gt;cheatevents || (attacked-&gt;losStatus[a] &amp; (LOS_INLOS | LOS_INRADAR)))) {
+				if(ais[attacker-&gt;team] &amp;&amp; !teamHandler-&gt;Ally(teamHandler-&gt;AllyTeam(a),attacked-&gt;allyteam) &amp;&amp; (ais[a]-&gt;cheatevents || (attacked-&gt;losStatus[a] &amp; (LOS_INLOS | LOS_INRADAR)))) {
 					float3 dir=attacker-&gt;pos-helper-&gt;GetUnitErrorPos(attacked,attacker-&gt;allyteam);
 					dir.ANormalize();
 					ais[a]-&gt;ai-&gt;EnemyDamaged(attacked-&gt;id,attacker-&gt;id,damage,dir);
@@ -366,13 +366,13 @@
 
 void CGlobalAIHandler::PlayerCommandGiven(std::vector&lt;int&gt;&amp; selectedunits,Command&amp; c,int player)
 {
-	if(ais[gs-&gt;players[player]-&gt;team]){
+	if(ais[playerHandler-&gt;Player(player)-&gt;team]){
 		try {
 			IGlobalAI::PlayerCommandEvent pce;
 			pce.units = selectedunits;
 			pce.player = player;
 			pce.command = c;
-			ais[gs-&gt;players[player]-&gt;team]-&gt;ai-&gt;HandleEvent(AI_EVENT_PLAYER_COMMAND,&amp;pce);
+			ais[playerHandler-&gt;Player(player)-&gt;team]-&gt;ai-&gt;HandleEvent(AI_EVENT_PLAYER_COMMAND,&amp;pce);
 		}
 		HANDLE_EXCEPTION;
 	}
@@ -381,8 +381,8 @@
 void CGlobalAIHandler::SeismicPing(int allyteam, CUnit *unit, const float3 &amp;pos, float strength)
 {
 	if(hasAI){
-		for(int a=0;a&lt;gs-&gt;activeTeams;++a){
-			if(ais[a] &amp;&amp; gs-&gt;AllyTeam(a)==allyteam &amp;&amp; !gs-&gt;Ally(allyteam,unit-&gt;allyteam))
+		for(int a=0;a&lt;teamHandler-&gt;ActiveTeams();++a){
+			if(ais[a] &amp;&amp; teamHandler-&gt;AllyTeam(a)==allyteam &amp;&amp; !teamHandler-&gt;Ally(allyteam,unit-&gt;allyteam))
 				try {
 					IGlobalAI::SeismicPingEvent spe;
 					spe.pos = pos;

Modified: trunk/rts/Game/Game.cpp
===================================================================
--- trunk/rts/Game/Game.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Game/Game.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -42,9 +42,9 @@
 #include &quot;GameVersion.h&quot;
 #include &quot;LoadSaveHandler.h&quot;
 #include &quot;SelectedUnits.h&quot;
+#include &quot;PlayerHandler.h&quot;
 #include &quot;PlayerRoster.h&quot;
 #include &quot;Sync/SyncTracer.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
 #include &quot;ChatMessage.h&quot;
 #include &quot;TimeProfiler.h&quot;
 #include &quot;WaitCommandsAI.h&quot;
@@ -91,16 +91,17 @@
 #include &quot;Lua/LuaParser.h&quot;
 #include &quot;Lua/LuaSyncedRead.h&quot;
 #include &quot;Lua/LuaUnsyncedCtrl.h&quot;
-#include &quot;Sim/Misc/ModInfo.h&quot;
-#include &quot;Sim/Misc/SideParser.h&quot;
 #include &quot;Sim/Misc/CategoryHandler.h&quot;
 #include &quot;Sim/Misc/DamageArrayHandler.h&quot;
 #include &quot;Sim/Features/FeatureHandler.h&quot;
 #include &quot;Sim/Misc/GeometricObjects.h&quot;
 #include &quot;Sim/Misc/GroundBlockingObjectMap.h&quot;
 #include &quot;Sim/Misc/LosHandler.h&quot;
+#include &quot;Sim/Misc/ModInfo.h&quot;
 #include &quot;Sim/Misc/QuadField.h&quot;
 #include &quot;Sim/Misc/RadarHandler.h&quot;
+#include &quot;Sim/Misc/SideParser.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Misc/Wind.h&quot;
 #include &quot;Sim/MoveTypes/MoveInfo.h&quot;
 #include &quot;Sim/Path/PathManager.h&quot;
@@ -290,7 +291,7 @@
 	consoleHistory = SAFE_NEW CConsoleHistory;
 	wordCompletion = SAFE_NEW CWordCompletion;
 	for (int pp = 0; pp &lt; MAX_PLAYERS; pp++) {
-	  wordCompletion-&gt;AddWord(gs-&gt;players[pp]-&gt;name, false, false, false);
+	  wordCompletion-&gt;AddWord(playerHandler-&gt;Player(pp)-&gt;name, false, false, false);
 	}
 
 #ifdef DIRECT_CONTROL_ALLOWED
@@ -444,7 +445,7 @@
 
 	globalAI = SAFE_NEW CGlobalAIHandler();
 
-	CPlayer* p = gs-&gt;players[gu-&gt;myPlayerNum];
+	CPlayer* p = playerHandler-&gt;Player(gu-&gt;myPlayerNum);
 	GameSetupDrawer::Enable();
 
 	if (gs-&gt;useLuaRules) {
@@ -640,7 +641,7 @@
 int CGame::KeyPressed(unsigned short k, bool isRepeat)
 {
 	if (!gameOver &amp;&amp; !isRepeat) {
-		gs-&gt;players[gu-&gt;myPlayerNum]-&gt;currentStats-&gt;keyPresses++;
+		playerHandler-&gt;Player(gu-&gt;myPlayerNum)-&gt;currentStats-&gt;keyPresses++;
 	}
 
 	if (!hotBinding.empty()) {
@@ -665,7 +666,7 @@
 
 	if (userWriting) {
 		unsigned int actionIndex;
-		for (actionIndex = 0; actionIndex &lt; (int)actionList.size(); actionIndex++) {
+		for (actionIndex = 0; actionIndex &lt; actionList.size(); actionIndex++) {
 			const Action&amp; action = actionList[actionIndex];
 
 			if (action.command == &quot;edit_return&quot;) {
@@ -966,7 +967,7 @@
 	else if (cmd == &quot;w&quot;) {
 		const std::string::size_type pos = action.extra.find_first_of(&quot; &quot;);
 		if (pos != std::string::npos) {
-			const int playernum = gs-&gt;Player(action.extra.substr(0, pos));
+			const int playernum = playerHandler-&gt;Player(action.extra.substr(0, pos));
 			if (playernum &gt;= 0) {
 				SendNetChat(action.extra.substr(pos+1), playernum);
 			} else {
@@ -1069,7 +1070,7 @@
 		if (gs-&gt;cheatEnabled)
 		{
 			int team=atoi(action.extra.c_str());
-			if ((team &gt;= 0) &amp;&amp; (team &lt;gs-&gt;activeTeams)) {
+			if ((team &gt;= 0) &amp;&amp; (team &lt; teamHandler-&gt;ActiveTeams())) {
 				net-&gt;Send(CBaseNetProtocol::Get().SendJoinTeam(gu-&gt;myPlayerNum, team));
 			}
 		}
@@ -1079,9 +1080,9 @@
 	}
 	else if ((cmd == &quot;specteam&quot;) &amp;&amp; gu-&gt;spectating) {
 		const int team = atoi(action.extra.c_str());
-		if ((team &gt;= 0) &amp;&amp; (team &lt; gs-&gt;activeTeams)) {
+		if ((team &gt;= 0) &amp;&amp; (team &lt; teamHandler-&gt;ActiveTeams())) {
 			gu-&gt;myTeam = team;
-			gu-&gt;myAllyTeam = gs-&gt;AllyTeam(team);
+			gu-&gt;myAllyTeam = teamHandler-&gt;AllyTeam(team);
 		}
 		CLuaUI::UpdateTeams();
 	}
@@ -1519,7 +1520,7 @@
 		//  * If he's a spectator.
 		//  * If there are other active players on his team.
 		//  * If there are no other players
-		if (!playing || gameOver || gs-&gt;Team(gu-&gt;myTeam)-&gt;isDead || gu-&gt;spectating) {
+		if (!playing || gameOver || teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;isDead || gu-&gt;spectating) {
 			userMayQuit = true;
 		}
 		else {
@@ -1527,9 +1528,9 @@
 			bool onlyActive = true;
 			for (int a = 0;a &lt; MAX_PLAYERS; ++a) {
 				if (a != gu-&gt;myPlayerNum) {
-					if (gs-&gt;players[a]-&gt;active) {
+					if (playerHandler-&gt;Player(a)-&gt;active) {
 						onlyActive = false;
-						if (gs-&gt;players[a]-&gt;team == gu-&gt;myTeam) {
+						if (playerHandler-&gt;Player(a)-&gt;team == gu-&gt;myTeam) {
 							userMayQuit = true;
 							break;
 						}
@@ -2089,7 +2090,7 @@
 		selectedUnits.PossibleCommandChange(NULL);
 		if (gs-&gt;noHelperAIs) {
 			// remove any current GroupAIs
-			CUnitSet&amp; teamUnits = gs-&gt;Team(gu-&gt;myTeam)-&gt;units;
+			CUnitSet&amp; teamUnits = teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;units;
 			CUnitSet::iterator it;
 			for(it = teamUnits.begin(); it != teamUnits.end(); ++it)
 			{
@@ -2128,15 +2129,14 @@
 		}
 	}
 	else if (action.command == &quot;nocost&quot; &amp;&amp; gs-&gt;cheatEnabled) {
-		for(unsigned i=0; i&lt;unitDefHandler-&gt;numUnitDefs; i++)
-		{
+		for(int i = 0; i &lt; unitDefHandler-&gt;numUnitDefs; ++i) {
 			unitDefHandler-&gt;unitDefs[i].metalCost = 1;
 			unitDefHandler-&gt;unitDefs[i].energyCost = 1;
 			unitDefHandler-&gt;unitDefs[i].buildTime = 10;
 			unitDefHandler-&gt;unitDefs[i].metalUpkeep = 0;
 			unitDefHandler-&gt;unitDefs[i].energyUpkeep = 0;
 		}
-		unitDefHandler-&gt;noCost=true;
+		unitDefHandler-&gt;noCost = true;
 		logOutput.Print(&quot;Everything is for free!&quot;);
 	}
 	else if (action.command == &quot;give&quot; &amp;&amp; gs-&gt;cheatEnabled) {
@@ -2158,7 +2158,7 @@
 		}
 
 		int amount = 1;
-		int team = gs-&gt;players[playernum]-&gt;team;
+		int team = playerHandler-&gt;Player(playernum)-&gt;team;
 
 		int amountArg = -1;
 		int teamArg = -1;
@@ -2187,7 +2187,7 @@
 		if (teamArg &gt;= 0) {
 			const string&amp; teamStr = args[teamArg];
 			team = atoi(teamStr.c_str());
-			if ((team &lt; 0) || (team &gt;= gs-&gt;activeTeams) || (teamStr.find_first_not_of(&quot;0123456789&quot;) != string::npos)) {
+			if ((team &lt; 0) || (team &gt;= teamHandler-&gt;ActiveTeams()) || (teamStr.find_first_not_of(&quot;0123456789&quot;) != string::npos)) {
 				logOutput.Print(&quot;Bad give team: %s&quot;, teamStr.c_str());
 				return;
 			}
@@ -2198,7 +2198,7 @@
 		if (unitName == &quot;all&quot;) {
 			// player entered &quot;.give all&quot;
 			int sqSize = (int) streflop::ceil(streflop::sqrt((float) unitDefHandler-&gt;numUnitDefs));
-			int currentNumUnits = gs-&gt;Team(team)-&gt;units.size();
+			int currentNumUnits = teamHandler-&gt;Team(team)-&gt;units.size();
 			int numRequestedUnits = unitDefHandler-&gt;numUnitDefs;
 
 			// make sure team unit-limit not exceeded
@@ -2227,7 +2227,7 @@
 		}
 		else if (!unitName.empty()) {
 			int numRequestedUnits = amount;
-			int currentNumUnits = gs-&gt;Team(team)-&gt;units.size();
+			int currentNumUnits = teamHandler-&gt;Team(team)-&gt;units.size();
 
 			if (currentNumUnits &gt;= uh-&gt;maxUnits) {
 				logOutput.Print(&quot;Unable to give any more units to team %i&quot;, team);
@@ -2414,22 +2414,22 @@
 	}
 #endif
 	else if (action.command == &quot;atm&quot; &amp;&amp; gs-&gt;cheatEnabled) {
-		int team = gs-&gt;players[playernum]-&gt;team;
-		gs-&gt;Team(team)-&gt;AddMetal(1000);
-		gs-&gt;Team(team)-&gt;AddEnergy(1000);
+		int team = playerHandler-&gt;Player(playernum)-&gt;team;
+		teamHandler-&gt;Team(team)-&gt;AddMetal(1000);
+		teamHandler-&gt;Team(team)-&gt;AddEnergy(1000);
 	}
-	else if (action.command == &quot;take&quot; &amp;&amp; (!gs-&gt;players[playernum]-&gt;spectator || gs-&gt;cheatEnabled)) {
-		int sendTeam = gs-&gt;players[playernum]-&gt;team;
-		for (int a = 0; a &lt; gs-&gt;activeTeams; ++a) {
-			if (gs-&gt;AlliedTeams(a, sendTeam)) {
+	else if (action.command == &quot;take&quot; &amp;&amp; (!playerHandler-&gt;Player(playernum)-&gt;spectator || gs-&gt;cheatEnabled)) {
+		int sendTeam = playerHandler-&gt;Player(playernum)-&gt;team;
+		for (int a = 0; a &lt; teamHandler-&gt;ActiveTeams(); ++a) {
+			if (teamHandler-&gt;AlliedTeams(a, sendTeam)) {
 				bool hasPlayer = false;
-				for (int b = 0; b &lt; gs-&gt;activePlayers; ++b) {
-					if (gs-&gt;players[b]-&gt;active &amp;&amp; gs-&gt;players[b]-&gt;team==a &amp;&amp; !gs-&gt;players[b]-&gt;spectator) {
+				for (int b = 0; b &lt; playerHandler-&gt;ActivePlayers(); ++b) {
+					if (playerHandler-&gt;Player(b)-&gt;active &amp;&amp; playerHandler-&gt;Player(b)-&gt;team==a &amp;&amp; !playerHandler-&gt;Player(b)-&gt;spectator) {
 						hasPlayer = true;
 					}
 				}
 				if (!hasPlayer) {
-					gs-&gt;Team(a)-&gt;GiveEverythingTo(sendTeam);
+					teamHandler-&gt;Team(a)-&gt;GiveEverythingTo(sendTeam);
 				}
 			}
 		}
@@ -2932,7 +2932,7 @@
 		const int* indices = playerRoster.GetIndices(&amp;count);
 
 		for (int a = 0; a &lt; count; ++a) {
-			const CPlayer* p = gs-&gt;players[indices[a]];
+			const CPlayer* p = playerHandler-&gt;Player(indices[a]);
 			float color[4];
 			const char* prefix;
 			if (p-&gt;spectator) {
@@ -2942,14 +2942,14 @@
 				color[3] = 1.0f;
 				prefix = &quot;S|&quot;;
 			} else {
-				const unsigned char* bColor = gs-&gt;Team(p-&gt;team)-&gt;color;
+				const unsigned char* bColor = teamHandler-&gt;Team(p-&gt;team)-&gt;color;
 				color[0] = (float)bColor[0] / 255.0f;
 				color[1] = (float)bColor[1] / 255.0f;
 				color[2] = (float)bColor[2] / 255.0f;
 				color[3] = (float)bColor[3] / 255.0f;
-				if (gu-&gt;myAllyTeam == gs-&gt;AllyTeam(p-&gt;team))
+				if (gu-&gt;myAllyTeam ==teamHandler-&gt;AllyTeam(p-&gt;team))
 					prefix = &quot;A|&quot;;	// same AllyTeam
-				else if (gs-&gt;AlliedTeams(gu-&gt;myTeam, p-&gt;team))
+				else if (teamHandler-&gt;AlliedTeams(gu-&gt;myTeam, p-&gt;team))
 					prefix = &quot;E+|&quot;;	// different AllyTeams, but are allied
 				else
 					prefix = &quot;E|&quot;;	//no alliance at all
@@ -3072,8 +3072,8 @@
 	lastframe = SDL_GetTicks();
 
 	ENTER_MIXED;
-	gu-&gt;myTeam = gs-&gt;players[gu-&gt;myPlayerNum]-&gt;team;
-	gu-&gt;myAllyTeam = gs-&gt;AllyTeam(gu-&gt;myTeam);
+	gu-&gt;myTeam = playerHandler-&gt;Player(gu-&gt;myPlayerNum)-&gt;team;
+	gu-&gt;myAllyTeam = teamHandler-&gt;AllyTeam(gu-&gt;myTeam);
 //	grouphandler-&gt;team = gu-&gt;myTeam;
 	CLuaUI::UpdateTeams();
 
@@ -3217,23 +3217,24 @@
 	loshandler-&gt;Update();
 
 	if (!(gs-&gt;frameNum &amp; 31)) {
-		for (int a = 0; a &lt; gs-&gt;activeTeams; ++a) {
-			gs-&gt;Team(a)-&gt;ResetFrameVariables();
+		// TODO: move to CTeamHandler
+		for (int a = 0; a &lt; teamHandler-&gt;ActiveTeams(); ++a) {
+			teamHandler-&gt;Team(a)-&gt;ResetFrameVariables();
 		}
-		for (int a = 0; a &lt; gs-&gt;activeTeams; ++a) {
-			gs-&gt;Team(a)-&gt;SlowUpdate();
+		for (int a = 0; a &lt; teamHandler-&gt;ActiveTeams(); ++a) {
+			teamHandler-&gt;Team(a)-&gt;SlowUpdate();
 		}
 	}
 
 	lastUpdate = SDL_GetTicks();
 
 #ifdef DIRECT_CONTROL_ALLOWED
-	for(int a=0;a&lt;gs-&gt;activePlayers;++a){
-		if(!gs-&gt;players[a]-&gt;active || !gs-&gt;players[a]-&gt;playerControlledUnit)
+	for(int a=0;a&lt;playerHandler-&gt;ActivePlayers();++a){
+		if(!playerHandler-&gt;Player(a)-&gt;active || !playerHandler-&gt;Player(a)-&gt;playerControlledUnit)
 			continue;
 
-		CUnit* unit=gs-&gt;players[a]-&gt;playerControlledUnit;
-		DirectControlStruct* dc=&amp;gs-&gt;players[a]-&gt;myControl;
+		CUnit* unit=playerHandler-&gt;Player(a)-&gt;playerControlledUnit;
+		DirectControlStruct* dc=&amp;playerHandler-&gt;Player(a)-&gt;myControl;
 
 		std::vector&lt;int&gt; args;
 		args.push_back(0);
@@ -3243,7 +3244,7 @@
 		pos+=UpVector*7;
 
 		CUnit* hit;
-		float dist=helper-&gt;TraceRayTeam(pos,dc-&gt;viewDir,unit-&gt;maxRange,hit,1,unit,gs-&gt;AllyTeam(gs-&gt;players[a]-&gt;team));
+		float dist=helper-&gt;TraceRayTeam(pos,dc-&gt;viewDir,unit-&gt;maxRange,hit,1,unit,teamHandler-&gt;AllyTeam(playerHandler-&gt;Player(a)-&gt;team));
 		dc-&gt;target=hit;
 
 		if(hit){
@@ -3383,23 +3384,23 @@
 				} else {
 					switch (inbuf[2]) {
 						case 1: {
-							if (gs-&gt;players[player]-&gt;spectator) {
-								logOutput.Print(&quot;Spectator %s left&quot;, gs-&gt;players[player]-&gt;name.c_str());
+							if (playerHandler-&gt;Player(player)-&gt;spectator) {
+								logOutput.Print(&quot;Spectator %s left&quot;, playerHandler-&gt;Player(player)-&gt;name.c_str());
 							} else {
-								logOutput.Print(&quot;Player %s left&quot;, gs-&gt;players[player]-&gt;name.c_str());
+								logOutput.Print(&quot;Player %s left&quot;, playerHandler-&gt;Player(player)-&gt;name.c_str());
 							}
 							break;
 						}
 						case 2:
-							logOutput.Print(&quot;Player %s has been kicked&quot;, gs-&gt;players[player]-&gt;name.c_str());
+							logOutput.Print(&quot;Player %s has been kicked&quot;, playerHandler-&gt;Player(player)-&gt;name.c_str());
 							break;
 						case 0:
-							logOutput.Print(&quot;Lost connection to %s&quot;, gs-&gt;players[player]-&gt;name.c_str());
+							logOutput.Print(&quot;Lost connection to %s&quot;, playerHandler-&gt;Player(player)-&gt;name.c_str());
 							break;
 						default:
-							logOutput.Print(&quot;Player %s left the game (reason unknown: %i)&quot;, gs-&gt;players[player]-&gt;name.c_str(), inbuf[2]);
+							logOutput.Print(&quot;Player %s left the game (reason unknown: %i)&quot;, playerHandler-&gt;Player(player)-&gt;name.c_str(), inbuf[2]);
 					}
-					gs-&gt;players[player]-&gt;active = false;
+					playerHandler-&gt;Player(player)-&gt;active = false;
 				}
 				AddTraffic(player, packetCode, dataLength);
 				break;
@@ -3445,7 +3446,7 @@
 				logOutput.Print(&quot;Game over&quot;);
 			// Warning: using CPlayer::Statistics here may cause endianness problems
 			// once net-&gt;SendData is endian aware!
-				net-&gt;Send(CBaseNetProtocol::Get().SendPlayerStat(gu-&gt;myPlayerNum, *gs-&gt;players[gu-&gt;myPlayerNum]-&gt;currentStats));
+				net-&gt;Send(CBaseNetProtocol::Get().SendPlayerStat(gu-&gt;myPlayerNum, *playerHandler-&gt;Player(gu-&gt;myPlayerNum)-&gt;currentStats));
 				ENTER_SYNCED;
 				AddTraffic(-1, packetCode, dataLength);
 				break;
@@ -3457,11 +3458,11 @@
 					logOutput.Print(&quot;Got invalid player num %i in playerstat msg&quot;,player);
 					break;
 				}
-				*gs-&gt;players[player]-&gt;currentStats = *(CPlayer::Statistics*)&amp;inbuf[2];
+				*playerHandler-&gt;Player(player)-&gt;currentStats = *(CPlayer::Statistics*)&amp;inbuf[2];
 				if (gameOver) {
 					CDemoRecorder* record = net-&gt;GetDemoRecorder();
 					if (record != NULL) {
-						record-&gt;SetPlayerStats(player, *gs-&gt;players[player]-&gt;currentStats);
+						record-&gt;SetPlayerStats(player, *playerHandler-&gt;Player(player)-&gt;currentStats);
 					}
 				}
 				AddTraffic(player, packetCode, dataLength);
@@ -3476,9 +3477,9 @@
 				else if (!skipping) {
 					gs-&gt;paused=!!inbuf[2];
 					if(gs-&gt;paused){
-						logOutput.Print(&quot;%s paused the game&quot;,gs-&gt;players[player]-&gt;name.c_str());
+						logOutput.Print(&quot;%s paused the game&quot;,playerHandler-&gt;Player(player)-&gt;name.c_str());
 					} else {
-						logOutput.Print(&quot;%s unpaused the game&quot;,gs-&gt;players[player]-&gt;name.c_str());
+						logOutput.Print(&quot;%s unpaused the game&quot;,playerHandler-&gt;Player(player)-&gt;name.c_str());
 					}
 					lastframe = SDL_GetTicks();
 				}
@@ -3497,7 +3498,7 @@
 				gs-&gt;userSpeedFactor = *((float*) &amp;inbuf[2]);
 
 				unsigned char pNum = *(unsigned char*) &amp;inbuf[1];
-				const char* pName = (pNum == SERVER_PLAYER)? &quot;server&quot;: gs-&gt;players[pNum]-&gt;name.c_str();
+				const char* pName = (pNum == SERVER_PLAYER)? &quot;server&quot;: playerHandler-&gt;Player(pNum)-&gt;name.c_str();
 
 				logOutput.Print(&quot;Speed set to %.1f [%s]&quot;, gs-&gt;userSpeedFactor, pName);
 				AddTraffic(pNum, packetCode, dataLength);
@@ -3515,8 +3516,8 @@
 				if (player &gt;= MAX_PLAYERS || player &lt; 0) {
 					logOutput.Print(&quot;Got invalid player num %i in playerinfo msg&quot;, player);
 				} else {
-					gs-&gt;players[player]-&gt;cpuUsage = *(float*) &amp;inbuf[2];
-					gs-&gt;players[player]-&gt;ping = *(int*) &amp;inbuf[6];
+					playerHandler-&gt;Player(player)-&gt;cpuUsage = *(float*) &amp;inbuf[2];
+					playerHandler-&gt;Player(player)-&gt;ping = *(int*) &amp;inbuf[6];
 				}
 				AddTraffic(player, packetCode, dataLength);
 				break;
@@ -3524,13 +3525,13 @@
 
 			case NETMSG_PLAYERNAME: {
 				int player = inbuf[2];
-				gs-&gt;players[player]-&gt;name=(char*)(&amp;inbuf[3]);
-				gs-&gt;players[player]-&gt;readyToStart=true;
-				gs-&gt;players[player]-&gt;active=true;
+				playerHandler-&gt;Player(player)-&gt;name=(char*)(&amp;inbuf[3]);
+				playerHandler-&gt;Player(player)-&gt;readyToStart=true;
+				playerHandler-&gt;Player(player)-&gt;active=true;
 				if (net-&gt;GetDemoRecorder()) {
 					net-&gt;GetDemoRecorder()-&gt;SetMaxPlayerNum(inbuf[2]);
 				}
-				wordCompletion-&gt;AddWord(gs-&gt;players[player]-&gt;name, false, false, false); // required?
+				wordCompletion-&gt;AddWord(playerHandler-&gt;Player(player)-&gt;name, false, false, false); // required?
 				AddTraffic(player, packetCode, dataLength);
 				break;
 			}
@@ -3552,7 +3553,7 @@
 			case NETMSG_STARTPOS:{
 				unsigned player = inbuf[1];
 				int team = inbuf[2];
-				if ((team &gt;= gs-&gt;activeTeams) || (team &lt; 0)) {
+				if ((team &gt;= teamHandler-&gt;ActiveTeams()) || (team &lt; 0)) {
 					logOutput.Print(&quot;Got invalid team num %i in startpos msg&quot;,team);
 				} else {
 					float3 pos(*(float*)&amp;inbuf[4],
@@ -3560,10 +3561,10 @@
 					           *(float*)&amp;inbuf[12]);
 					if (!luaRules || luaRules-&gt;AllowStartPosition(player, pos)) {
 						if (inbuf[3] != 2) {
-							gs-&gt;Team(team)-&gt;StartposMessage(pos, !!inbuf[3]);
+							teamHandler-&gt;Team(team)-&gt;StartposMessage(pos, !!inbuf[3]);
 						}
 						else
-							gs-&gt;Team(team)-&gt;StartposMessage(pos);
+							teamHandler-&gt;Team(team)-&gt;StartposMessage(pos);
 						char label[128];
 						SNPRINTF(label, sizeof(label), &quot;Start %i&quot;, team);
 						inMapDrawer-&gt;LocalPoint(pos, label, player);
@@ -3657,7 +3658,7 @@
 							break;
 						}
 						if ((uh-&gt;units[unitid] &amp;&amp;
-						    (uh-&gt;units[unitid]-&gt;team == gs-&gt;players[player]-&gt;team)) ||
+						    (uh-&gt;units[unitid]-&gt;team == playerHandler-&gt;Player(player)-&gt;team)) ||
 						    gs-&gt;godMode) {
 							selected.push_back(unitid);
 						}
@@ -3758,14 +3759,14 @@
 
 				if (metalShare &gt; 0.0f) {
 					if (!luaRules || luaRules-&gt;AllowResourceTransfer(srcTeam, dstTeam, &quot;m&quot;, metalShare)) {
-						gs-&gt;Team(srcTeam)-&gt;metal -= metalShare;
-						gs-&gt;Team(dstTeam)-&gt;metal += metalShare;
+						teamHandler-&gt;Team(srcTeam)-&gt;metal -= metalShare;
+						teamHandler-&gt;Team(dstTeam)-&gt;metal += metalShare;
 					}
 				}
 				if (energyShare &gt; 0.0f) {
 					if (!luaRules || luaRules-&gt;AllowResourceTransfer(srcTeam, dstTeam, &quot;e&quot;, energyShare)) {
-						gs-&gt;Team(srcTeam)-&gt;energy -= energyShare;
-						gs-&gt;Team(dstTeam)-&gt;energy += energyShare;
+						teamHandler-&gt;Team(srcTeam)-&gt;energy -= energyShare;
+						teamHandler-&gt;Team(dstTeam)-&gt;energy += energyShare;
 					}
 				}
 
@@ -3814,22 +3815,22 @@
 					logOutput.Print(&quot;Got invalid player num %i in share msg&quot;,player);
 					break;
 				}
-				int team1 = gs-&gt;players[player]-&gt;team;
+				int team1 = playerHandler-&gt;Player(player)-&gt;team;
 				int team2 = inbuf[2];
 				bool shareUnits = !!inbuf[3];
-				float metalShare = std::min(*(float*)&amp;inbuf[4], (float)gs-&gt;Team(team1)-&gt;metal);
-				float energyShare = std::min(*(float*)&amp;inbuf[8], (float)gs-&gt;Team(team1)-&gt;energy);
+				float metalShare = std::min(*(float*)&amp;inbuf[4], (float)teamHandler-&gt;Team(team1)-&gt;metal);
+				float energyShare = std::min(*(float*)&amp;inbuf[8], (float)teamHandler-&gt;Team(team1)-&gt;energy);
 
 				if (metalShare != 0.0f) {
 					if (!luaRules || luaRules-&gt;AllowResourceTransfer(team1, team2, &quot;m&quot;, metalShare)) {
-						gs-&gt;Team(team1)-&gt;metal -= metalShare;
-						gs-&gt;Team(team2)-&gt;metal += metalShare;
+						teamHandler-&gt;Team(team1)-&gt;metal -= metalShare;
+						teamHandler-&gt;Team(team2)-&gt;metal += metalShare;
 					}
 				}
 				if (energyShare != 0.0f) {
 					if (!luaRules || luaRules-&gt;AllowResourceTransfer(team1, team2, &quot;e&quot;, energyShare)) {
-						gs-&gt;Team(team1)-&gt;energy -= energyShare;
-						gs-&gt;Team(team2)-&gt;energy += energyShare;
+						teamHandler-&gt;Team(team1)-&gt;energy -= energyShare;
+						teamHandler-&gt;Team(team2)-&gt;energy += energyShare;
 					}
 				}
 
@@ -3854,17 +3855,17 @@
 			case NETMSG_SETSHARE: {
 				int player=inbuf[1];
 				int team=inbuf[2];
-				if ((team &gt;= gs-&gt;activeTeams) || (team &lt; 0)) {
+				if ((team &gt;= teamHandler-&gt;ActiveTeams()) || (team &lt; 0)) {
 					logOutput.Print(&quot;Got invalid team num %i in setshare msg&quot;,team);
 				} else {
 					float metalShare=*(float*)&amp;inbuf[3];
 					float energyShare=*(float*)&amp;inbuf[7];
 
 					if (!luaRules || luaRules-&gt;AllowResourceLevel(team, &quot;m&quot;, metalShare)) {
-						gs-&gt;Team(team)-&gt;metalShare = metalShare;
+						teamHandler-&gt;Team(team)-&gt;metalShare = metalShare;
 					}
 					if (!luaRules || luaRules-&gt;AllowResourceLevel(team, &quot;e&quot;, energyShare)) {
-						gs-&gt;Team(team)-&gt;energyShare = energyShare;
+						teamHandler-&gt;Team(team)-&gt;energyShare = energyShare;
 					}
 				}
 				AddTraffic(player, packetCode, dataLength);
@@ -3878,11 +3879,11 @@
 			case NETMSG_TEAM: {
 				const int player = (int)inbuf[1];
 				const unsigned char action = inbuf[2];
-				const int fromTeam = gs-&gt;players[player]-&gt;team;
+				const int fromTeam = playerHandler-&gt;Player(player)-&gt;team;
 
 				unsigned numPlayersInTeam = 0;
 				for (int a = 0; a &lt; MAX_PLAYERS; ++a) {
-					if (gs-&gt;players[a]-&gt;active &amp;&amp; (gs-&gt;players[a]-&gt;team == fromTeam)) {
+					if (playerHandler-&gt;Player(a)-&gt;active &amp;&amp; (playerHandler-&gt;Player(a)-&gt;team == fromTeam)) {
 						++numPlayersInTeam;
 					}
 				}
@@ -3892,23 +3893,23 @@
 					case TEAMMSG_GIVEAWAY: {
 						const int toTeam = inbuf[3];
 						if (numPlayersInTeam == 1) {
-							gs-&gt;Team(fromTeam)-&gt;GiveEverythingTo(toTeam);
-							gs-&gt;Team(fromTeam)-&gt;leader = -1;
+							teamHandler-&gt;Team(fromTeam)-&gt;GiveEverythingTo(toTeam);
+							teamHandler-&gt;Team(fromTeam)-&gt;leader = -1;
 						} else {
-							gs-&gt;players[player]-&gt;StartSpectating();
+							playerHandler-&gt;Player(player)-&gt;StartSpectating();
 						}
 						CPlayer::UpdateControlledTeams();
 						break;
 					}
 					case TEAMMSG_RESIGN: {
-						gs-&gt;players[player]-&gt;StartSpectating();
+						playerHandler-&gt;Player(player)-&gt;StartSpectating();
 						if (player == gu-&gt;myPlayerNum) {
 							selectedUnits.ClearSelected();
 							unitTracker.Disable();
 							CLuaUI::UpdateTeams();
 						}
 						if (numPlayersInTeam == 1) {
-							gs-&gt;Team(fromTeam)-&gt;leader = -1;
+							teamHandler-&gt;Team(fromTeam)-&gt;leader = -1;
 						}
 						logOutput.Print(&quot;Player %i resigned and is now spectating!&quot;, player);
 						CPlayer::UpdateControlledTeams();
@@ -3916,11 +3917,11 @@
 					}
 					case TEAMMSG_JOIN_TEAM: {
 						int newTeam = int(inbuf[3]);
-						gs-&gt;players[player]-&gt;team = newTeam;
-						gs-&gt;players[player]-&gt;spectator = false;
+						playerHandler-&gt;Player(player)-&gt;team = newTeam;
+						playerHandler-&gt;Player(player)-&gt;spectator = false;
 						if (player == gu-&gt;myPlayerNum) {
 							gu-&gt;myTeam = newTeam;
-							gu-&gt;myAllyTeam = gs-&gt;AllyTeam(gu-&gt;myTeam);
+							gu-&gt;myAllyTeam = teamHandler-&gt;AllyTeam(gu-&gt;myTeam);
 							gu-&gt;spectating           = false;
 							gu-&gt;spectatingFullView   = false;
 							gu-&gt;spectatingFullSelect = false;
@@ -3928,8 +3929,8 @@
 							unitTracker.Disable();
 							CLuaUI::UpdateTeams();
 						}
-						if (gs-&gt;Team(newTeam)-&gt;leader == -1) {
-							gs-&gt;Team(newTeam)-&gt;leader = player;
+						if (teamHandler-&gt;Team(newTeam)-&gt;leader == -1) {
+							teamHandler-&gt;Team(newTeam)-&gt;leader = player;
 						}
 						CPlayer::UpdateControlledTeams();
 						eventHandler.PlayerChanged(player);
@@ -3950,11 +3951,11 @@
 					// FIXME - need to reset unit allyTeams
 					//       - need to reset unit texture for 3do
 					//       - need a call-in for AIs
-					gs-&gt;SetAlly(gs-&gt;AllyTeam(gs-&gt;players[player]-&gt;team), whichAllyTeam, allied);
+					teamHandler-&gt;SetAlly(teamHandler-&gt;AllyTeam(playerHandler-&gt;Player(player)-&gt;team), whichAllyTeam, allied);
 				} else {
 					logOutput.Print(&quot;Player %i sent out wrong allyTeam index in alliance message&quot;, player);
 				}
-				eventHandler.TeamChanged(gs-&gt;players[player]-&gt;team);
+				eventHandler.TeamChanged(playerHandler-&gt;Player(player)-&gt;team);
 				break;
 			}
 			case NETMSG_CCOMMAND: {
@@ -3972,27 +3973,27 @@
 					break;
 				}
 
-				CUnit* ctrlUnit = gs-&gt;players[player]-&gt;playerControlledUnit;
+				CUnit* ctrlUnit = playerHandler-&gt;Player(player)-&gt;playerControlledUnit;
 				if (ctrlUnit) {
-					CUnit* unit=gs-&gt;players[player]-&gt;playerControlledUnit;
-				//logOutput.Print(&quot;Player %s released control over unit %i type %s&quot;,gs-&gt;players[player]-&gt;name.c_str(),unit-&gt;id,unit-&gt;unitDef-&gt;humanName.c_str());
+					CUnit* unit=playerHandler-&gt;Player(player)-&gt;playerControlledUnit;
+				//logOutput.Print(&quot;Player %s released control over unit %i type %s&quot;,playerHandler-&gt;Player(player)-&gt;name.c_str(),unit-&gt;id,unit-&gt;unitDef-&gt;humanName.c_str());
 
 					unit-&gt;directControl=0;
 					unit-&gt;AttackUnit(0,true);
-					gs-&gt;players[player]-&gt;StopControllingUnit();
+					playerHandler-&gt;Player(player)-&gt;StopControllingUnit();
 				}
 				else {
 					if(!selectedUnits.netSelected[player].empty() &amp;&amp; uh-&gt;units[selectedUnits.netSelected[player][0]] &amp;&amp; !uh-&gt;units[selectedUnits.netSelected[player][0]]-&gt;weapons.empty()){
 						CUnit* unit = uh-&gt;units[selectedUnits.netSelected[player][0]];
-						//logOutput.Print(&quot;Player %s took control over unit %i type %s&quot;,gs-&gt;players[player]-&gt;name.c_str(),unit-&gt;id,unit-&gt;unitDef-&gt;humanName.c_str());
+						//logOutput.Print(&quot;Player %s took control over unit %i type %s&quot;,playerHandler-&gt;Player(player)-&gt;name.c_str(),unit-&gt;id,unit-&gt;unitDef-&gt;humanName.c_str());
 						if (unit-&gt;directControl) {
 							if (player == gu-&gt;myPlayerNum) {
 								logOutput.Print(&quot;Sorry someone already controls that unit&quot;);
 							}
 						}
 						else if (!luaRules || luaRules-&gt;AllowDirectUnitControl(player, unit)) {
-							unit-&gt;directControl=&amp;gs-&gt;players[player]-&gt;myControl;
-							gs-&gt;players[player]-&gt;playerControlledUnit=unit;
+							unit-&gt;directControl=&amp;playerHandler-&gt;Player(player)-&gt;myControl;
+							playerHandler-&gt;Player(player)-&gt;playerControlledUnit=unit;
 							ENTER_UNSYNCED;
 							if (player == gu-&gt;myPlayerNum) {
 								gu-&gt;directControl = unit;
@@ -4020,8 +4021,8 @@
 					logOutput.Print(&quot;Got invalid player num %i in dc update msg&quot;,player);
 					break;
 				}
-				DirectControlStruct* dc = &amp;gs-&gt;players[player]-&gt;myControl;
-				CUnit* unit = gs-&gt;players[player]-&gt;playerControlledUnit;
+				DirectControlStruct* dc = &amp;playerHandler-&gt;Player(player)-&gt;myControl;
+				CUnit* unit = playerHandler-&gt;Player(player)-&gt;playerControlledUnit;
 
 				dc-&gt;forward    = !!(inbuf[2] &amp; (1 &lt;&lt; 0));
 				dc-&gt;back       = !!(inbuf[2] &amp; (1 &lt;&lt; 1));
@@ -4233,7 +4234,7 @@
 		file &lt;&lt; &quot;  xpos &quot; &lt;&lt; p-&gt;pos.x &lt;&lt; &quot; ypos &quot; &lt;&lt; p-&gt;pos.y &lt;&lt; &quot; zpos &quot; &lt;&lt; p-&gt;pos.z &lt;&lt; &quot;\n&quot;;
 		file &lt;&lt; &quot;  xspeed &quot; &lt;&lt; p-&gt;speed.x &lt;&lt; &quot; yspeed &quot; &lt;&lt; p-&gt;speed.y &lt;&lt; &quot; zspeed &quot; &lt;&lt; p-&gt;speed.z &lt;&lt; &quot;\n&quot;;
 	}
-	for(int a=0;a&lt;gs-&gt;activeTeams;++a){
+	for(int a=0;a&lt;teamHandler-&gt;ActiveTeams();++a){
 		file &lt;&lt; &quot;Losmap for team &quot; &lt;&lt; a &lt;&lt; &quot;\n&quot;;
 		for(int y=0;y&lt;gs-&gt;mapy&gt;&gt;modInfo.losMipLevel;++y){
 			file &lt;&lt; &quot; &quot;;
@@ -4327,7 +4328,7 @@
 		glColor4f(0.2f, 0.8f, 0.2f, 0.8f);
 		font-&gt;glFormatAt(0.02f, 0.65f, 1.0f, &quot;Health %.0f / %.0f&quot;, (float)unit-&gt;health, (float)unit-&gt;maxHealth);
 
-		if(gs-&gt;players[gu-&gt;myPlayerNum]-&gt;myControl.mouse2){
+		if(playerHandler-&gt;Player(gu-&gt;myPlayerNum)-&gt;myControl.mouse2){
 			font-&gt;glPrintAt(0.02f, 0.7f, 1.0f, &quot;Free fire mode&quot;);
 		}
 
@@ -4472,15 +4473,16 @@
 		// FIXME: ugh, there should be a better way to figure out number of players ...
 		numPlayers = gameSetup-&gt;numPlayers;
 
-		int numTeams = gs-&gt;activeAllyTeams;
+		// TODO: move this to a method in CTeamHandler
+		// Figure out who won the game.
+		int numTeams = teamHandler-&gt;ActiveAllyTeams();
 		if (gs-&gt;useLuaGaia) {
 			--numTeams;
 		}
-		// Figure out who won the game.
 		int winner = -1;
 		for (int i = 0; i &lt; numTeams; ++i) {
-			if (!gs-&gt;Team(i)-&gt;isDead) {
-				winner = gs-&gt;AllyTeam(i);
+			if (!teamHandler-&gt;Team(i)-&gt;isDead) {
+				winner = teamHandler-&gt;AllyTeam(i);
 				break;
 			}
 		}
@@ -4488,10 +4490,10 @@
 		record-&gt;SetTime(gs-&gt;frameNum / 30, (int)gu-&gt;gameTime);
 		record-&gt;InitializeStats(numPlayers, numTeams, winner);
 		for (int i = 0; i &lt; numPlayers; ++i) {
-			record-&gt;SetPlayerStats(i, *gs-&gt;players[i]-&gt;currentStats);
+			record-&gt;SetPlayerStats(i, *playerHandler-&gt;Player(i)-&gt;currentStats);
 		}
 		for (int i = 0; i &lt; numTeams; ++i) {
-			record-&gt;SetTeamStats(i, gs-&gt;Team(i)-&gt;statHistory);
+			record-&gt;SetTeamStats(i, teamHandler-&gt;Team(i)-&gt;statHistory);
 		}
 	}
 }
@@ -4535,7 +4537,7 @@
 	string s = msg.msg;
 
 	if (!s.empty()) {
-		CPlayer* player = (msg.fromPlayer == SERVER_PLAYER) ? 0 : gs-&gt;players[msg.fromPlayer];
+		CPlayer* player = (msg.fromPlayer == SERVER_PLAYER) ? 0 : playerHandler-&gt;Player(msg.fromPlayer);
 		const bool myMsg = (msg.fromPlayer == gu-&gt;myPlayerNum);
 
 		string label;
@@ -4564,8 +4566,8 @@
 		*/
 
 		if (msg.destination == ChatMessage::TO_ALLIES &amp;&amp; player) {
-			const int msgAllyTeam = gs-&gt;AllyTeam(player-&gt;team);
-			const bool allied = gs-&gt;Ally(msgAllyTeam, gu-&gt;myAllyTeam);
+			const int msgAllyTeam = teamHandler-&gt;AllyTeam(player-&gt;team);
+			const bool allied = teamHandler-&gt;Ally(msgAllyTeam, gu-&gt;myAllyTeam);
 			if (gu-&gt;spectating || (allied &amp;&amp; !player-&gt;spectator)) {
 				logOutput.Print(label + &quot;Allies: &quot; + s);
 				sound-&gt;PlaySample(chatSound, 5);
@@ -4734,7 +4736,7 @@
 				continue; // bad pointer
 			}
 			if (!gu-&gt;spectatingFullSelect) {
-				const CUnitSet&amp; teamUnits = gs-&gt;Team(gu-&gt;myTeam)-&gt;units;
+				const CUnitSet&amp; teamUnits = teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;units;
 				if (teamUnits.find(unit) == teamUnits.end()) {
 					continue; // not mine to select
 				}
@@ -4829,7 +4831,7 @@
 void CGame::ReColorTeams()
 {
 	for (int t = 0; t &lt; MAX_TEAMS; t++) {
-		CTeam* team = gs-&gt;Team(t);
+		CTeam* team = teamHandler-&gt;Team(t);
 		team-&gt;origColor[0] = team-&gt;color[0];
 		team-&gt;origColor[1] = team-&gt;color[1];
 		team-&gt;origColor[2] = team-&gt;color[2];
@@ -4858,11 +4860,11 @@
 	luaParser.AddInt(&quot;gameMode&quot;, gs-&gt;gameMode);
 
 	luaParser.GetTable(&quot;teams&quot;);
-	for(int t = 0; t &lt; gs-&gt;activeTeams; ++t) {
+	for(int t = 0; t &lt; teamHandler-&gt;ActiveTeams(); ++t) {
 		luaParser.GetTable(t); {
-			const CTeam* team = gs-&gt;Team(t);
-			const unsigned char* color = gs-&gt;Team(t)-&gt;color;
-			luaParser.AddInt(&quot;allyTeam&quot;, gs-&gt;AllyTeam(t));
+			const CTeam* team = teamHandler-&gt;Team(t);
+			const unsigned char* color = teamHandler-&gt;Team(t)-&gt;color;
+			luaParser.AddInt(&quot;allyTeam&quot;, teamHandler-&gt;AllyTeam(t));
 			luaParser.AddBool(&quot;gaia&quot;,    team-&gt;gaia);
 			luaParser.AddInt(&quot;leader&quot;,   team-&gt;leader);
 			luaParser.AddString(&quot;side&quot;,  team-&gt;side);
@@ -4879,9 +4881,9 @@
 	luaParser.EndTable(); // teams
 
 	luaParser.GetTable(&quot;players&quot;);
-	for(int p = 0; p &lt; gs-&gt;activePlayers; ++p) {
+	for(int p = 0; p &lt; playerHandler-&gt;ActivePlayers(); ++p) {
 		luaParser.GetTable(p); {
-			const CPlayer* player = gs-&gt;players[p];
+			const CPlayer* player = playerHandler-&gt;Player(p);
 			luaParser.AddString(&quot;name&quot;,     player-&gt;name);
 			luaParser.AddInt(&quot;team&quot;,        player-&gt;team);
 			luaParser.AddBool(&quot;active&quot;,     player-&gt;active);
@@ -4900,10 +4902,10 @@
 		logOutput.Print(&quot;teamcolors.lua: root table is not valid\n&quot;);
 	}
 
-	for (int t = 0; t &lt; gs-&gt;activeTeams; ++t) {
+	for (int t = 0; t &lt; teamHandler-&gt;ActiveTeams(); ++t) {
 		LuaTable teamTable = root.SubTable(t);
 		if (teamTable.IsValid()) {
-			unsigned char* color = gs-&gt;Team(t)-&gt;color;
+			unsigned char* color = teamHandler-&gt;Team(t)-&gt;color;
 			color[0] = GetLuaColor(teamTable, 1, color[0]);
 			color[1] = GetLuaColor(teamTable, 2, color[1]);
 			color[2] = GetLuaColor(teamTable, 3, color[2]);

Modified: trunk/rts/Game/GameHelper.cpp
===================================================================
--- trunk/rts/Game/GameHelper.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Game/GameHelper.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -25,6 +25,7 @@
 #include &quot;Sim/Misc/GeometricObjects.h&quot;
 #include &quot;Sim/Misc/LosHandler.h&quot;
 #include &quot;Sim/Misc/QuadField.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Misc/RadarHandler.h&quot;
 #include &quot;Sim/Misc/ModInfo.h&quot;
 #include &quot;Sim/Projectiles/ExplosionGenerator.h&quot;
@@ -410,7 +411,7 @@
 
 			const CollisionVolume* cv = u-&gt;collisionVolume;
 
-			if (gs-&gt;Ally(u-&gt;allyteam, allyteam) || (u-&gt;losStatus[allyteam] &amp; LOS_INLOS)) {
+			if (teamHandler-&gt;Ally(u-&gt;allyteam, allyteam) || (u-&gt;losStatus[allyteam] &amp; LOS_INLOS)) {
 				float3 dif = (u-&gt;midPos + cv-&gt;GetOffsets()) - start;
 				float closeLength = dif.dot(dir);
 
@@ -471,8 +472,8 @@
 	int tempNum = gs-&gt;tempNum++;
 	std::vector&lt;int&gt;::iterator qi;
 	for (qi = quads.begin(); qi != quads.end(); ++qi) {
-		for (int t = 0; t &lt; gs-&gt;activeAllyTeams; ++t) {
-			if (gs-&gt;Ally(attacker-&gt;allyteam, t)) {
+		for (int t = 0; t &lt; teamHandler-&gt;ActiveAllyTeams(); ++t) {
+			if (teamHandler-&gt;Ally(attacker-&gt;allyteam, t)) {
 				continue;
 			}
 			std::list&lt;CUnit*&gt;::const_iterator ui;
@@ -602,7 +603,7 @@
 		std::list&lt;CUnit*&gt;::const_iterator ui;
 
 		for (ui = quad.units.begin(); ui != quad.units.end(); ++ui) {
-			if ((*ui)-&gt;tempNum != tempNum &amp;&amp; !gs-&gt;Ally(searchAllyteam, (*ui)-&gt;allyteam) &amp;&amp;
+			if ((*ui)-&gt;tempNum != tempNum &amp;&amp; !teamHandler-&gt;Ally(searchAllyteam, (*ui)-&gt;allyteam) &amp;&amp;
 				(((*ui)-&gt;losStatus[searchAllyteam] &amp; (LOS_INLOS | LOS_INRADAR)))) {
 
 				(*ui)-&gt;tempNum = tempNum;
@@ -640,7 +641,7 @@
 				CUnit* unit = *ui;
 
 				if (unit-&gt;tempNum != tempNum &amp;&amp;
-				    !gs-&gt;Ally(searchAllyteam, unit-&gt;allyteam)) {
+				    !teamHandler-&gt;Ally(searchAllyteam, unit-&gt;allyteam)) {
 					unit-&gt;tempNum = tempNum;
 
 					// FIXME: use volumeBoundingRadius?
@@ -670,7 +671,7 @@
 				CUnit* unit = *ui;
 
 				if (unit-&gt;tempNum != tempNum &amp;&amp;
-				    !gs-&gt;Ally(searchAllyteam, unit-&gt;allyteam)) {
+				    !teamHandler-&gt;Ally(searchAllyteam, unit-&gt;allyteam)) {
 					unit-&gt;tempNum = tempNum;
 					const float sqDist = (pos - unit-&gt;midPos).SqLength2D();
 
@@ -700,7 +701,7 @@
 		const CQuadField::Quad&amp; quad = qf-&gt;GetQuad(*qi);
 		std::list&lt;CUnit*&gt;::const_iterator ui;
 		for (ui = quad.units.begin(); ui != quad.units.end(); ++ui) {
-			if((*ui)-&gt;tempNum!=tempNum &amp;&amp; gs-&gt;Ally(searchAllyteam,(*ui)-&gt;allyteam)){
+			if((*ui)-&gt;tempNum!=tempNum &amp;&amp; teamHandler-&gt;Ally(searchAllyteam,(*ui)-&gt;allyteam)){
 				(*ui)-&gt;tempNum=tempNum;
 				float sqDist=(pos-(*ui)-&gt;midPos).SqLength2D();
 				if(sqDist &lt;= closeDist){
@@ -727,7 +728,7 @@
 		const CQuadField::Quad&amp; quad = qf-&gt;GetQuad(*qi);
 		std::list&lt;CUnit*&gt;::const_iterator ui;
 		for (ui = quad.units.begin(); ui != quad.units.end(); ++ui) {
-			if((*ui)-&gt;unitDef-&gt;canfly &amp;&amp; (*ui)-&gt;tempNum!=tempNum &amp;&amp; !gs-&gt;Ally(searchAllyteam,(*ui)-&gt;allyteam) &amp;&amp; !(*ui)-&gt;crashing &amp;&amp; (((*ui)-&gt;losStatus[searchAllyteam] &amp; (LOS_INLOS | LOS_INRADAR)))){
+			if((*ui)-&gt;unitDef-&gt;canfly &amp;&amp; (*ui)-&gt;tempNum!=tempNum &amp;&amp; !teamHandler-&gt;Ally(searchAllyteam,(*ui)-&gt;allyteam) &amp;&amp; !(*ui)-&gt;crashing &amp;&amp; (((*ui)-&gt;losStatus[searchAllyteam] &amp; (LOS_INLOS | LOS_INRADAR)))){
 				(*ui)-&gt;tempNum=tempNum;
 				float sqDist=(pos-(*ui)-&gt;midPos).SqLength2D();
 				if(sqDist &lt;= closeDist){
@@ -757,7 +758,7 @@
 		for (ui = quad.units.begin(); ui != quad.units.end(); ++ui) {
 			CUnit* u = *ui;
 
-			if (u-&gt;tempNum != tempNum &amp;&amp; !gs-&gt;Ally(searchAllyteam, u-&gt;allyteam) &amp;&amp;
+			if (u-&gt;tempNum != tempNum &amp;&amp; !teamHandler-&gt;Ally(searchAllyteam, u-&gt;allyteam) &amp;&amp;
 				((u-&gt;losStatus[searchAllyteam] &amp; (LOS_INLOS | LOS_INRADAR)))) {
 
 				u-&gt;tempNum = tempNum;
@@ -852,7 +853,7 @@
 float3 CGameHelper::GetUnitErrorPos(const CUnit* unit, int allyteam)
 {
 	float3 pos = unit-&gt;midPos;
-	if (gs-&gt;Ally(allyteam,unit-&gt;allyteam) || (unit-&gt;losStatus[allyteam] &amp; LOS_INLOS)) {
+	if (teamHandler-&gt;Ally(allyteam,unit-&gt;allyteam) || (unit-&gt;losStatus[allyteam] &amp; LOS_INLOS)) {
 		// ^ it's one of our own, or it's in LOS, so don't add an error ^
 	} else if ((!gameSetup || gameSetup-&gt;ghostedBuildings) &amp;&amp; (unit-&gt;losStatus[allyteam] &amp; LOS_PREVLOS) &amp;&amp; (unit-&gt;losStatus[allyteam] &amp; LOS_CONTRADAR) &amp;&amp; !unit-&gt;mobility) {
 		// ^ this is a ghosted building, so don't add an error ^
@@ -876,7 +877,7 @@
 		if (exclude) {
 			const int eAllyTeam = exclude-&gt;allyteam;
 			const int uAllyTeam = u-&gt;allyteam;
-			allied = (gs-&gt;Ally(uAllyTeam, eAllyTeam) || gs-&gt;Ally(eAllyTeam, uAllyTeam));
+			allied = (teamHandler-&gt;Ally(uAllyTeam, eAllyTeam) || teamHandler-&gt;Ally(eAllyTeam, uAllyTeam));
 		}
 
 		if (u != exclude &amp;&amp; allied &amp;&amp; !u-&gt;unitDef-&gt;pushResistant &amp;&amp; !u-&gt;usingScriptMoveType) {

Modified: trunk/rts/Game/GameServer.cpp
===================================================================
--- trunk/rts/Game/GameServer.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Game/GameServer.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -27,11 +27,11 @@
 
 #include &quot;LogOutput.h&quot;
 #include &quot;GameSetup.h&quot;
-#include &quot;Sim/Misc/GlobalSynced.h&quot;
 #include &quot;Action.h&quot;
 #include &quot;ChatMessage.h&quot;
 #include &quot;CommandMessage.h&quot;
 #include &quot;BaseNetProtocol.h&quot;
+#include &quot;PlayerHandler.h&quot;
 #include &quot;Net/UDPListener.h&quot;
 #include &quot;Net/Connection.h&quot;
 #include &quot;Net/UDPConnection.h&quot;
@@ -44,7 +44,8 @@
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;FileSystem/CRC.h&quot;
 #include &quot;Player.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Server/MsgStrings.h&quot;
 
 
@@ -125,10 +126,10 @@
 	noHelperAIs = false;
 	cheating = false;
 	sentGameOverMsg = false;
-	
+
 	if (!onlyLocal)
 		UDPNet.reset(new netcode::UDPListener(settings-&gt;hostport));
-	
+
 	if (settings-&gt;autohostport &gt; 0) {
 		AddAutohostInterface(settings-&gt;autohostport);
 	}
@@ -225,7 +226,7 @@
 		}
 		CommandMessage msg2(&quot;skip end&quot;, SERVER_PLAYER);
 		Broadcast(boost::shared_ptr&lt;const netcode::RawPacket&gt;(msg2.Pack()));
-		
+
 		if (UDPNet)
 			UDPNet-&gt;Update();
 		lastUpdate = SDL_GetTicks();
@@ -469,7 +470,7 @@
 			}
 		}
 	}
-	
+
 	if ((SDL_GetTicks() - serverStartTime) &gt; serverTimeout)
 	{
 		bool hasPlayers = false;
@@ -478,7 +479,7 @@
 			if (players[i])
 				hasPlayers = true;
 		}
-		
+
 		if (!hasPlayers)
 		{
 			Message(NoClientsExit);
@@ -744,7 +745,7 @@
 				for (int a = 0; a &lt; MAX_PLAYERS; ++a)
 					if (players[a] &amp;&amp; players[a]-&gt;team == fromTeam)
 						++numPlayersInTeam;
-							
+
 				switch (action)
 				{
 					case TEAMMSG_GIVEAWAY: {
@@ -878,7 +879,7 @@
 	{
 		boost::shared_ptr&lt;netcode::UDPConnection&gt; prev = UDPNet-&gt;PreviewConnection().lock();
 		boost::shared_ptr&lt;const RawPacket&gt; packet = prev-&gt;GetData();
-		
+
 		if (packet &amp;&amp; packet-&gt;length &gt;= 3 &amp;&amp; packet-&gt;data[0] == NETMSG_ATTEMPTCONNECT)
 		{
 			netcode::UnpackPacket msg(packet, 3);
@@ -914,7 +915,7 @@
 				}
 				continue;
 			}
-			
+
 			boost::shared_ptr&lt;const RawPacket&gt; packet;
 			while (players[a] &amp;&amp; (packet = players[a]-&gt;link-&gt;GetData()))
 			{
@@ -996,7 +997,7 @@
 void CGameServer::StartGame()
 {
 	gameStartTime = SDL_GetTicks();
-	
+
 	if (UDPNet)
 		UDPNet-&gt;Listen(false); // don't accept new connections
 
@@ -1007,7 +1008,7 @@
 
 	// make sure initial game speed is within allowed range and sent a new speed if not
 	UserSpeedChange(userSpeedFactor, SERVER_PLAYER);
-	
+
 	if (demoReader) {
 		// the client told us to start a demo
 		// no need to send startpos and startplaying since its in the demo
@@ -1167,22 +1168,22 @@
 #ifndef DEDICATED
 	int numActiveTeams[MAX_TEAMS]; // active teams per ally team
 	memset(numActiveTeams, 0, sizeof(numActiveTeams));
-	for (int a = 0; a &lt; gs-&gt;activeTeams; ++a)
+	for (int a = 0; a &lt; teamHandler-&gt;ActiveTeams(); ++a)
 	{
 		bool hasPlayer = false;
-		for (int b = 0; b &lt; gs-&gt;activePlayers; ++b) {
-			if (gs-&gt;players[b]-&gt;active &amp;&amp; gs-&gt;players[b]-&gt;team == static_cast&lt;int&gt;(a) &amp;&amp; !gs-&gt;players[b]-&gt;spectator) {
+		for (int b = 0; b &lt; playerHandler-&gt;ActivePlayers(); ++b) {
+			if (playerHandler-&gt;Player(b)-&gt;active &amp;&amp; playerHandler-&gt;Player(b)-&gt;team == static_cast&lt;int&gt;(a) &amp;&amp; !playerHandler-&gt;Player(b)-&gt;spectator) {
 				hasPlayer = true;
 			}
 		}
-		if (gs-&gt;Team(a)-&gt;isAI)
+		if (teamHandler-&gt;Team(a)-&gt;isAI)
 			hasPlayer = true;
 
-		if (!gs-&gt;Team(a)-&gt;isDead &amp;&amp; !gs-&gt;Team(a)-&gt;gaia &amp;&amp; hasPlayer)
-			++numActiveTeams[gs-&gt;AllyTeam(a)];
+		if (!teamHandler-&gt;Team(a)-&gt;isDead &amp;&amp; !teamHandler-&gt;Team(a)-&gt;gaia &amp;&amp; hasPlayer)
+			++numActiveTeams[teamHandler-&gt;AllyTeam(a)];
 	}
 
-	for (int a = 0; a &lt; gs-&gt;activeAllyTeams; ++a)
+	for (int a = 0; a &lt; teamHandler-&gt;ActiveAllyTeams(); ++a)
 		if (numActiveTeams[a] != 0)
 			++numActiveAllyTeams;
 #else
@@ -1225,7 +1226,7 @@
 #endif
 		CheckSync();
 		int newFrames = 1;
-	
+
 		if(!fixedFrameTime){
 			unsigned currentTick = SDL_GetTicks();
 			unsigned timeElapsed = currentTick - lastTick;
@@ -1244,7 +1245,7 @@
 			newFrames = (timeLeft &gt; 0)? int(streflop::ceil(timeLeft)): 0;
 			timeLeft -= newFrames;
 		}
-	
+
 		bool rec = false;
 #ifndef NO_AVI
 		rec = game &amp;&amp; game-&gt;creatingVideo;
@@ -1252,7 +1253,7 @@
 		bool normalFrame = !isPaused &amp;&amp; !rec;
 		bool videoFrame = !isPaused &amp;&amp; fixedFrameTime;
 		bool singleStep = fixedFrameTime &amp;&amp; !rec;
-	
+
 		if(normalFrame || videoFrame || singleStep){
 			for(int i=0; i &lt; newFrames; ++i){
 				assert(!demoReader);
@@ -1290,10 +1291,10 @@
 			assert(UDPNet);
 			hasData = UDPNet-&gt;HasIncomingData(10); // may block up to 10 ms if there is no data (don't need a lock)
 		}
-		
+
 		if (UDPNet)
 			UDPNet-&gt;Update();
-		
+
 		boost::recursive_mutex::scoped_lock scoped_lock(gameServerMutex);
 		if (hasData)
 			ServerReadNet(); // new data arrived, we may have new packets
@@ -1364,7 +1365,7 @@
 		Message(str(format(&quot;Player %s not found, rejecting connection attempt&quot;) %name));
 		return 0;
 	}
-	
+
 	players[hisNewNumber].reset(new GameParticipant(isLocal)); // give him rights to change speed, kick players etc
 	players[hisNewNumber]-&gt;link = link;
 	if (hisNewNumber &lt; setup-&gt;playerStartingData.size()) {
@@ -1397,7 +1398,7 @@
 				Broadcast(CBaseNetProtocol::Get().SendStartPos(SERVER_PLAYER, a, teams[a]-&gt;readyToStart, teams[a]-&gt;startpos.x, teams[a]-&gt;startpos.y, teams[a]-&gt;startpos.z));
 		}
 	}
-	
+
 	Message(str(format(NewConnection) %name %hisNewNumber %version));
 
 	link-&gt;Flush(true);
@@ -1424,7 +1425,7 @@
 void CGameServer::UserSpeedChange(float newSpeed, int player)
 {
 	newSpeed = std::min(maxUserSpeed, std::max(newSpeed, minUserSpeed));
-	
+
 	if (userSpeedFactor != newSpeed)
 	{
 		if (internalSpeed &gt; newSpeed || internalSpeed == userSpeedFactor) // insta-raise speed when not slowed down

Modified: trunk/rts/Game/Player.cpp
===================================================================
--- trunk/rts/Game/Player.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Game/Player.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -7,7 +7,8 @@
 #include &quot;mmgr.h&quot;
 
 #include &quot;Player.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
+#include &quot;PlayerHandler.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Misc/GlobalSynced.h&quot;
 #ifdef DIRECT_CONTROL_ALLOWED
 #  include &quot;UI/MouseHandler.h&quot;
@@ -106,8 +107,8 @@
 	}
 
 	// AI teams
-	for (int t = 0; t &lt; gs-&gt;activeTeams; t++) {
-		const CTeam* team = gs-&gt;Team(t);
+	for (int t = 0; t &lt; teamHandler-&gt;ActiveTeams(); t++) {
+		const CTeam* team = teamHandler-&gt;Team(t);
 		if (team &amp;&amp; team-&gt;isAI &amp;&amp;
 		    !team-&gt;dllAI.empty() &amp;&amp; // luaAI does not require client control
 		    (team-&gt;leader == playerNum)) {
@@ -119,8 +120,8 @@
 
 void CPlayer::UpdateControlledTeams()
 {
-	for (int p = 0; p &lt; gs-&gt;activePlayers; p++) {
-		CPlayer* player = gs-&gt;players[p];
+	for (int p = 0; p &lt; playerHandler-&gt;ActivePlayers(); p++) {
+		CPlayer* player = playerHandler-&gt;Player(p);
 		if (player) {
 			player-&gt;SetControlledTeams();
 		}
@@ -131,7 +132,7 @@
 void CPlayer::StartSpectating()
 {
 	spectator = true;
-	if (gs-&gt;players[gu-&gt;myPlayerNum] == this) { //TODO bad hack
+	if (playerHandler-&gt;Player(gu-&gt;myPlayerNum) == this) { //TODO bad hack
 		gu-&gt;spectating           = true;
 		gu-&gt;spectatingFullView   = true;
 		gu-&gt;spectatingFullSelect = true;
@@ -145,12 +146,12 @@
 {
 	ENTER_UNSYNCED;
 	if (gu-&gt;directControl == playerControlledUnit) {
-		assert(gs-&gt;players[gu-&gt;myPlayerNum] == this);
+		assert(playerHandler-&gt;Player(gu-&gt;myPlayerNum) == this);
 		gu-&gt;directControl = 0;
 
 		/* Switch back to the camera we were using before. */
 		camHandler-&gt;PopMode();
-		
+
 		if (mouse-&gt;locked &amp;&amp; !mouse-&gt;wasLocked){
 			mouse-&gt;locked = false;
 			mouse-&gt;ShowMouse();

Modified: trunk/rts/Game/Player.h
===================================================================
--- trunk/rts/Game/Player.h	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Game/Player.h	2008-11-12 22:26:06 UTC (rev 7026)
@@ -38,7 +38,7 @@
 	CR_DECLARE_SUB(Statistics);
 	CPlayer();
 	~CPlayer();
-	
+
 	std::set&lt;int&gt; controlledTeams;
 	bool CanControlTeam(int teamID) const {
 		return (controlledTeams.find(teamID) != controlledTeams.end());
@@ -84,7 +84,7 @@
 	DirectControlStruct myControl;
 
 	CUnit* playerControlledUnit;
-	
+
 	void StopControllingUnit();
 #endif
 

Added: trunk/rts/Game/PlayerHandler.cpp
===================================================================
--- trunk/rts/Game/PlayerHandler.cpp	                        (rev 0)
+++ trunk/rts/Game/PlayerHandler.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -0,0 +1,58 @@
+/* Author: Tobi Vollebregt */
+
+/* based on code from GlobalSynced.{cpp,h} */
+
+#include &quot;StdAfx.h&quot;
+#include &quot;PlayerHandler.h&quot;
+#include &quot;Game/GameSetup.h&quot;
+#include &quot;mmgr.h&quot;
+
+CR_BIND(CPlayerHandler,);
+
+CR_REG_METADATA(CPlayerHandler, (
+	CR_MEMBER(players),
+	CR_MEMBER(activePlayers),
+	CR_RESERVED(64)
+));
+
+
+CPlayerHandler* playerHandler;
+
+
+CPlayerHandler::CPlayerHandler()
+{
+	for(int i = 0; i &lt; MAX_PLAYERS; ++i) {
+		players[i].playerNum = i;
+	}
+
+	activePlayers = MAX_PLAYERS;
+}
+
+
+CPlayerHandler::~CPlayerHandler()
+{
+}
+
+
+void CPlayerHandler::LoadFromSetup(const CGameSetup* setup)
+{
+	activePlayers = setup-&gt;numPlayers;
+
+	for (int i = 0; i &lt; activePlayers; ++i)
+	{
+		// TODO: refactor
+		// NOTE: this seems slightly better already then the static_cast
+		Player(i)-&gt;PlayerBase::operator=(setup-&gt;playerStartingData[i]);
+	}
+}
+
+
+int CPlayerHandler::Player(const std::string&amp; name)
+{
+	for (int i = 0; i &lt; MAX_PLAYERS; ++i) {
+		if (Player(i)-&gt;name == name) {
+			return i;
+		}
+	}
+	return -1;
+}

Added: trunk/rts/Game/PlayerHandler.h
===================================================================
--- trunk/rts/Game/PlayerHandler.h	                        (rev 0)
+++ trunk/rts/Game/PlayerHandler.h	2008-11-12 22:26:06 UTC (rev 7026)
@@ -0,0 +1,65 @@
+/* Author: Tobi Vollebregt */
+
+/* based on code from GlobalSynced.{cpp,h} */
+
+#ifndef PLAYERHANDLER_H
+#define PLAYERHANDLER_H
+
+#include &quot;creg/creg.h&quot;
+#include &quot;Sim/Misc/GlobalConstants.h&quot;
+#include &quot;Player.h&quot;
+
+class CGameSetup;
+
+
+class CPlayerHandler
+{
+public:
+	CR_DECLARE(CPlayerHandler);
+
+	CPlayerHandler();
+	~CPlayerHandler();
+
+	void LoadFromSetup(const CGameSetup* setup);
+
+	/**
+	 * @brief Player
+	 * @param i index to fetch
+	 * @return CPlayer pointer
+	 *
+	 * Accesses a CPlayer instance at a given index
+	 */
+	CPlayer* Player(int i) { return &amp;players[i]; }
+
+	/**
+	 * @brief Player
+	 * @param name name of the player
+	 * @return his playernumber of -1 if not found
+	 *
+	 * Search a player by name.
+	 */
+	int Player(const std::string&amp; name);
+
+	int ActivePlayers() const { return activePlayers; }
+
+private:
+
+	/**
+	 * @brief active players
+	 *
+	 * The number of active players
+	 */
+	int activePlayers;
+
+	/**
+	 * @brief players
+	 *
+	 * Array of CPlayer instances, for all the
+	 * players in the game (size MAX_PLAYERS)
+	 */
+	CPlayer players[MAX_PLAYERS];
+};
+
+extern CPlayerHandler* playerHandler;
+
+#endif // !PLAYERHANDLER_H

Modified: trunk/rts/Game/PlayerRoster.cpp
===================================================================
--- trunk/rts/Game/PlayerRoster.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Game/PlayerRoster.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -8,8 +8,8 @@
 #include &lt;assert.h&gt;
 
 #include &quot;PlayerRoster.h&quot;
-#include &quot;Player.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
+#include &quot;PlayerHandler.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Util.h&quot;
 #include &quot;Sim/Misc/GlobalSynced.h&quot;
 #include &quot;GlobalUnsynced.h&quot;
@@ -110,20 +110,21 @@
 	static int players[MAX_PLAYERS];
 	static int knownPlayers = 0;
 
-	if (gs-&gt;activePlayers &gt; knownPlayers) {
-		for (int i = 0; i &lt; gs-&gt;activePlayers; i++) {
+	if (playerHandler-&gt;ActivePlayers() &gt; knownPlayers) {
+		for (int i = 0; i &lt; playerHandler-&gt;ActivePlayers(); i++) {
 			players[i] = i;
 		}
-		knownPlayers = gs-&gt;activePlayers;
+		knownPlayers = playerHandler-&gt;ActivePlayers();
 	}
 
-	qsort(players, gs-&gt;activePlayers, sizeof(int), compareFunc);
+	// TODO: use std::sort
+	qsort(players, playerHandler-&gt;ActivePlayers(), sizeof(int), compareFunc);
 
 	if (count != NULL) {
 		// set the count
 		int&amp; c = *count;
-		for (c = 0; c &lt; gs-&gt;activePlayers; c++) {
-			const CPlayer* p = gs-&gt;players[players[c]];
+		for (c = 0; c &lt; playerHandler-&gt;ActivePlayers(); c++) {
+			const CPlayer* p = playerHandler-&gt;Player(players[c]);
 			if ((p == NULL) || !p-&gt;active) {
 				break;
 			}
@@ -157,8 +158,8 @@
 {
 	const int aID = *((const int*)a);
 	const int bID = *((const int*)b);
-	const CPlayer* aP = gs-&gt;players[aID];
-	const CPlayer* bP = gs-&gt;players[bID];
+	const CPlayer* aP = playerHandler-&gt;Player(aID);
+	const CPlayer* bP = playerHandler-&gt;Player(bID);
 
 	const int basic = CompareBasics(aP, bP);
 	if (basic != 0) {
@@ -182,8 +183,8 @@
 	if ((aTeam != myTeam) &amp;&amp; (bTeam == myTeam)) { return +1; }
 
 	// my allies first
-	const int aAlly = gs-&gt;AllyTeam(aTeam);
-	const int bAlly = gs-&gt;AllyTeam(bTeam);
+	const int aAlly = teamHandler-&gt;AllyTeam(aTeam);
+	const int bAlly = teamHandler-&gt;AllyTeam(bTeam);
 	const int myATeam = gu-&gt;myAllyTeam;
 	if ((aAlly == myATeam) &amp;&amp; (bAlly != myATeam)) { return -1; }
 	if ((aAlly != myATeam) &amp;&amp; (bAlly == myATeam)) { return +1; }
@@ -210,8 +211,8 @@
 {
 	const int aID = *((const int*)a);
 	const int bID = *((const int*)b);
-	const CPlayer* aP = gs-&gt;players[aID];
-	const CPlayer* bP = gs-&gt;players[bID];
+	const CPlayer* aP = playerHandler-&gt;Player(aID);
+	const CPlayer* bP = playerHandler-&gt;Player(bID);
 
 	const int basic = CompareBasics(aP, bP);
 	if (basic != 0) {
@@ -236,8 +237,8 @@
 {
 	const int aID = *((const int*)a);
 	const int bID = *((const int*)b);
-	const CPlayer* aP = gs-&gt;players[aID];
-	const CPlayer* bP = gs-&gt;players[bID];
+	const CPlayer* aP = playerHandler-&gt;Player(aID);
+	const CPlayer* bP = playerHandler-&gt;Player(bID);
 
 	const int basic = CompareBasics(aP, bP);
 	if (basic != 0) {
@@ -257,8 +258,8 @@
 {
 	const int aID = *((const int*)a);
 	const int bID = *((const int*)b);
-	const CPlayer* aP = gs-&gt;players[aID];
-	const CPlayer* bP = gs-&gt;players[bID];
+	const CPlayer* aP = playerHandler-&gt;Player(aID);
+	const CPlayer* bP = playerHandler-&gt;Player(bID);
 
 	const int basic = CompareBasics(aP, bP);
 	if (basic != 0) {
@@ -279,8 +280,8 @@
 {
 	const int aID = *((const int*)a);
 	const int bID = *((const int*)b);
-	const CPlayer* aP = gs-&gt;players[aID];
-	const CPlayer* bP = gs-&gt;players[bID];
+	const CPlayer* aP = playerHandler-&gt;Player(aID);
+	const CPlayer* bP = playerHandler-&gt;Player(bID);
 
 	const int basic = CompareBasics(aP, bP);
 	if (basic != 0) {

Modified: trunk/rts/Game/PreGame.cpp
===================================================================
--- trunk/rts/Game/PreGame.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Game/PreGame.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -12,7 +12,7 @@
 #include &quot;PreGame.h&quot;
 #include &quot;Game.h&quot;
 #include &quot;GameVersion.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;FPUCheck.h&quot;
 #include &quot;GameServer.h&quot;
 #include &quot;GameSetup.h&quot;
@@ -109,7 +109,7 @@
 {
 	SDL_Delay(10); // milliseconds
 	ClearScreen();
-	
+
 	if (!net-&gt;Connected())
 	{
 		if (settings-&gt;isHost)
@@ -123,15 +123,15 @@
 	{
 		font-&gt;glPrintCentered (0.5f,0.48f, 2.0f, &quot;Waiting for server response&quot;);
 	}
-	
+
 	font-&gt;glFormatAt(0.60f,0.40f, 1.0f, &quot;Server: %s:%d&quot;, settings-&gt;hostip.c_str(), settings-&gt;hostport);
 	if (!settings-&gt;isHost)
 		font-&gt;glFormatAt(0.60f,0.35f, 1.0f, &quot;Local endpoint: port %d UDP%s&quot;, settings-&gt;sourceport, (settings-&gt;sourceport == 0) ? &quot; (autoselect)&quot; : &quot;&quot;);
 	else
 		font-&gt;glFormatAt (0.60f,0.35f, 1.0f, &quot;Local endpoint: shared memory&quot;);
-	
+
 	font-&gt;glFormatAt (0.60f,0.30f, 1.0f, &quot;Using playername: %s&quot;, settings-&gt;myPlayerName.c_str());
-	
+
 	// credits
 	font-&gt;glPrintCentered(0.5f,0.06f,1.0f,&quot;Spring %s&quot;, SpringVersion::GetFull().c_str());
 	font-&gt;glPrintCentered(0.5f,0.02f,0.6f,&quot;This program is distributed under the GNU General Public License, see license.html for more info&quot;);
@@ -159,7 +159,7 @@
 	std::string map = setup-&gt;mapName;
 	std::string mod = setup-&gt;baseMod;
 	std::string script = setup-&gt;scriptName;
-	
+
 	startupData-&gt;SetRandomSeed(static_cast&lt;unsigned&gt;(gu-&gt;usRandInt()));
 	bool mapHasStartscript = false;
 	if (!map.empty())
@@ -190,7 +190,7 @@
 	startupData-&gt;SetScript(script);
 	// here we now the name of the script to use
 
-	try { // to load the script 
+	try { // to load the script
 		CScriptHandler::SelectScript(script);
 		std::string scriptWantedMod;
 		scriptWantedMod = CScriptHandler::Instance().chosenScript-&gt;GetModName();
@@ -207,7 +207,7 @@
 	mod = archiveScanner-&gt;ModArchiveToModName(mod);
 	std::string modArchive = archiveScanner-&gt;ModNameToModArchive(mod);
 	startupData-&gt;SetMod(mod, archiveScanner-&gt;GetModChecksum(modArchive));
-	
+
 	if (!mapHasStartscript) {
 		std::string mapFromScript = CScriptHandler::Instance().chosenScript-&gt;GetMapName();
 		if (!mapFromScript.empty() &amp;&amp; map != mapFromScript) {
@@ -246,10 +246,9 @@
 			}
 			case NETMSG_SETPLAYERNUM: { // this is sent afterwards to let us know which playernum we have
 				gu-&gt;SetMyPlayer(packet-&gt;data[1]);
-				logOutput.Print(&quot;Became player %i&quot;, gu-&gt;myPlayerNum);
-				
-				const int teamID = gs-&gt;players[gu-&gt;myPlayerNum]-&gt;team;
-				const CTeam* team = gs-&gt;Team(teamID);
+				logOutput.Print(&quot;Became player %i (team %i, allyteam %i)&quot;, gu-&gt;myPlayerNum, gu-&gt;myTeam, gu-&gt;myAllyTeam);
+
+				const CTeam* team = teamHandler-&gt;Team(gu-&gt;myTeam);
 				assert(team);
 				LoadStartPicture(team-&gt;side);
 
@@ -283,17 +282,17 @@
 		if (buf-&gt;data[0] == NETMSG_GAMEDATA)
 		{
 			GameData *data = new GameData(boost::shared_ptr&lt;const RawPacket&gt;(buf));
-			
+
 			// modify the startscriptscript so it can be used to watch the demo
 			TdfParser script(data-&gt;GetSetup().c_str(), data-&gt;GetSetup().size());
 			TdfParser::TdfSection* tgame = script.GetRootSection()-&gt;sections[&quot;game&quot;];
-			
+
 			tgame-&gt;AddPair(&quot;ScriptName&quot;, data-&gt;GetScript());
 			tgame-&gt;AddPair(&quot;MapName&quot;, data-&gt;GetMap());
 			tgame-&gt;AddPair(&quot;Gametype&quot;, data-&gt;GetMod());
-			
+
 			tgame-&gt;AddPair(&quot;Demofile&quot;, demoName);
-			
+
 			unsigned numPlayers = 0;
 			for (std::map&lt;std::string, TdfParser::TdfSection*&gt;::iterator it = tgame-&gt;sections.begin(); it != tgame-&gt;sections.end(); ++it) {
 				if (it-&gt;first.substr(0, 6) == &quot;player&quot;)
@@ -302,7 +301,7 @@
 					++numPlayers;
 				}
 			}
-			
+
 			// add local spectator (and assert we didn't already have MAX_PLAYERS players)
 			char section[50];
 			sprintf(section, &quot;PLAYER%i&quot;, numPlayers);
@@ -310,12 +309,12 @@
 			TdfParser::TdfSection* me = tgame-&gt;construct_subsection(s);
 			me-&gt;AddPair(&quot;name&quot;, settings-&gt;myPlayerName);
 			me-&gt;AddPair(&quot;spectator&quot;, 1);
-			
+
 			std::ostringstream buf;
 			script.print(buf);
 			data-&gt;SetSetup(buf.str());
 			CGameSetup* tempSetup = new CGameSetup();
-			
+
 			if (!tempSetup-&gt;Init(buf.str()))
 			{
 				throw content_error(&quot;Demo contains incorrect script&quot;);
@@ -326,7 +325,7 @@
 			good_fpu_control_registers(&quot;after CGameServer creation&quot;);
 			break;
 		}
-		
+
 		if (scanner.ReachedEnd())
 		{
 			throw content_error(&quot;End of demo reached and no game data found&quot;);
@@ -340,7 +339,7 @@
 void CPreGame::LoadMap(const std::string&amp; mapName, const bool forceReload)
 {
 	static bool alreadyLoaded = false;
-	
+
 	if (!alreadyLoaded || forceReload)
 	{
 		CFileHandler* f = SAFE_NEW CFileHandler(&quot;maps/&quot; + mapName);
@@ -364,7 +363,7 @@
 void CPreGame::LoadMod(const std::string&amp; modName)
 {
 	static bool alreadyLoaded = false;
-	
+
 	if (!alreadyLoaded) {
 		// Map all required archives depending on selected mod(s)
 		std::string modArchive = archiveScanner-&gt;ModNameToModArchive(modName);
@@ -385,14 +384,14 @@
 void CPreGame::GameDataReceived(boost::shared_ptr&lt;const netcode::RawPacket&gt; packet)
 {
 	gameData.reset(new GameData(packet));
-	
+
 	CGameSetup* temp = new CGameSetup();
 	if (temp-&gt;Init(gameData-&gt;GetSetup()))
 	{
 		temp-&gt;scriptName = gameData-&gt;GetScript();
 		temp-&gt;mapName = gameData-&gt;GetMap();
 		temp-&gt;baseMod = gameData-&gt;GetMod();
-		
+
 		gameSetup = const_cast&lt;const CGameSetup*&gt;(temp);
 		std::cout &lt;&lt; gameSetup &lt;&lt; std::endl;
 		gs-&gt;LoadFromSetup(gameSetup);
@@ -401,11 +400,11 @@
 	{
 		throw content_error(&quot;Server sent us incorrect script&quot;);
 	}
-	
+
 	gs-&gt;SetRandSeed(gameData-&gt;GetRandomSeed(), true);
 	logOutput &lt;&lt; &quot;Using map &quot; &lt;&lt; gameData-&gt;GetMap() &lt;&lt; &quot;\n&quot;;
 	stupidGlobalMapname = gameData-&gt;GetMap();
-	
+
 	if (net &amp;&amp; net-&gt;GetDemoRecorder()) {
 		net-&gt;GetDemoRecorder()-&gt;SetName(gameData-&gt;GetMap());
 		logOutput &lt;&lt; &quot;Recording demo &quot; &lt;&lt; net-&gt;GetDemoRecorder()-&gt;GetName() &lt;&lt; &quot;\n&quot;;
@@ -415,11 +414,11 @@
 
 	logOutput &lt;&lt; &quot;Using script &quot; &lt;&lt; gameData-&gt;GetScript() &lt;&lt; &quot;\n&quot;;
 	CScriptHandler::SelectScript(gameData-&gt;GetScript());
-	
+
 	logOutput &lt;&lt; &quot;Using mod &quot; &lt;&lt; gameData-&gt;GetMod() &lt;&lt; &quot;\n&quot;;
 	LoadMod(gameData-&gt;GetMod());
 	modArchive = archiveScanner-&gt;ModNameToModArchive(gameData-&gt;GetMod());
 	logOutput &lt;&lt; &quot;Using mod archive &quot; &lt;&lt; modArchive &lt;&lt; &quot;\n&quot;;
 	archiveScanner-&gt;CheckMod(modArchive, gameData-&gt;GetModChecksum());
-	
+
 }

Modified: trunk/rts/Game/SelectedUnits.cpp
===================================================================
--- trunk/rts/Game/SelectedUnits.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Game/SelectedUnits.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -9,7 +9,7 @@
 
 #include &quot;mmgr.h&quot;
 
-#include &quot;Sim/Misc/Team.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Misc/GlobalSynced.h&quot;
 #include &quot;SelectedUnits.h&quot;
 #include &quot;WaitCommandsAI.h&quot;
@@ -35,7 +35,7 @@
 #include &quot;Sim/Units/UnitTypes/TransportUnit.h&quot;
 #include &quot;EventHandler.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
-#include &quot;Player.h&quot;
+#include &quot;PlayerHandler.h&quot;
 #include &quot;Camera.h&quot;
 #include &quot;Sound.h&quot;
 #include &quot;Util.h&quot;
@@ -260,11 +260,11 @@
 	}
 
 	if (fromUser) {		//add some statistics
-		gs-&gt;players[gu-&gt;myPlayerNum]-&gt;currentStats-&gt;numCommands++;
+		playerHandler-&gt;Player(gu-&gt;myPlayerNum)-&gt;currentStats-&gt;numCommands++;
 		if (selectedGroup!=-1) {
-			gs-&gt;players[gu-&gt;myPlayerNum]-&gt;currentStats-&gt;unitCommands+=grouphandlers[gu-&gt;myTeam]-&gt;groups[selectedGroup]-&gt;units.size();
+			playerHandler-&gt;Player(gu-&gt;myPlayerNum)-&gt;currentStats-&gt;unitCommands+=grouphandlers[gu-&gt;myTeam]-&gt;groups[selectedGroup]-&gt;units.size();
 		} else {
-			gs-&gt;players[gu-&gt;myPlayerNum]-&gt;currentStats-&gt;unitCommands+=selectedUnits.size();
+			playerHandler-&gt;Player(gu-&gt;myPlayerNum)-&gt;currentStats-&gt;unitCommands+=selectedUnits.size();
 		}
 	}
 
@@ -324,7 +324,7 @@
 		return;
 	}
 	else if (c.id == CMD_DEATHWAIT) {
-		if (gs-&gt;activeAllyTeams &lt;= 2) {
+		if (teamHandler-&gt;ActiveAllyTeams() &lt;= 2) {
 			waitCommandsAI.AddDeathWait(c);
 		} else {
 			logOutput.Print(&quot;DeathWait can only be used when there are 2 Ally Teams&quot;);
@@ -496,7 +496,7 @@
 		if (!selectedUnits.empty() &amp;&amp;
 				((cmdColors.BuildBoxesOnShift() &amp;&amp; keys[SDLK_LSHIFT]) ||
 				 ((guihandler-&gt;inCommand &gt;= 0) &amp;&amp;
-					(guihandler-&gt;inCommand &lt; guihandler-&gt;commands.size()) &amp;&amp;
+					(guihandler-&gt;inCommand &lt; int(guihandler-&gt;commands.size())) &amp;&amp;
 					(guihandler-&gt;commands[guihandler-&gt;inCommand].id &lt; 0)))) {
 			GML_STDMUTEX_LOCK(cai); // Draw
 			bool myColor = true;
@@ -511,7 +511,7 @@
 					}
 					builder-&gt;DrawQuedBuildingSquares();
 				}
-				else if (gs-&gt;AlliedTeams(builder-&gt;owner-&gt;team, gu-&gt;myTeam)) {
+				else if (teamHandler-&gt;AlliedTeams(builder-&gt;owner-&gt;team, gu-&gt;myTeam)) {
 					if (myColor) {
 						glColor4fv(cmdColors.allyBuildBox);
 						myColor = false;
@@ -564,7 +564,7 @@
 		return;
 	}
 
-	const CPlayer* player = gs-&gt;players[playerID];
+	const CPlayer* player = playerHandler-&gt;Player(playerID);
 	if (player == NULL) {
 		return;
 	}
@@ -573,7 +573,7 @@
 		                playerID, unitid, unit-&gt;team);
 		return;
 	}
-	
+
 	unit-&gt;commandAI-&gt;GiveCommand(c, false);
 }
 
@@ -642,7 +642,7 @@
 }
 
 
-// CALLINFO: 
+// CALLINFO:
 // DrawMapStuff --&gt; CGuiHandler::GetDefaultCommand --&gt; GetDefaultCmd
 // CMouseHandler::DrawCursor --&gt; DrawCentroidCursor --&gt; CGuiHandler::GetDefaultCommand --&gt; GetDefaultCmd
 // LuaUnsyncedRead::GetDefaultCommand --&gt; CGuiHandler::GetDefaultCommand --&gt; GetDefaultCmd
@@ -670,7 +670,7 @@
 	targetUnit = unit;
 	targetFeature = feature;
 	if (targetUnit) {
-		targetIsEnemy = !gs-&gt;Ally(gu-&gt;myAllyTeam, targetUnit-&gt;allyteam);
+		targetIsEnemy = !teamHandler-&gt;Ally(gu-&gt;myAllyTeam, targetUnit-&gt;allyteam);
 	}
 
 	// find the best leader to pick the command
@@ -701,7 +701,7 @@
 		possibleCommandsChanged = true;
 }
 
-// CALLINFO: 
+// CALLINFO:
 // CGame::Draw --&gt; DrawCommands
 // CMiniMap::DrawForReal --&gt; DrawCommands
 void CSelectedUnits::DrawCommands()
@@ -763,8 +763,8 @@
 	} else if (!selectedUnits.empty()) {
 		// show the player name instead of unit name if it has FBI tag showPlayerName
 		if ((*selectedUnits.begin())-&gt;unitDef-&gt;showPlayerName) {
-			if (gs-&gt;Team((*selectedUnits.begin())-&gt;team)-&gt;leader &gt;= 0)
-				s = gs-&gt;players[gs-&gt;Team((*selectedUnits.begin())-&gt;team)-&gt;leader]-&gt;name.c_str();
+			if (teamHandler-&gt;Team((*selectedUnits.begin())-&gt;team)-&gt;leader &gt;= 0)
+				s = playerHandler-&gt;Player(teamHandler-&gt;Team((*selectedUnits.begin())-&gt;team)-&gt;leader)-&gt;name.c_str();
 			else
 				s = &quot;Uncontrolled&quot;;
 		} else {
@@ -906,7 +906,7 @@
 	*packet &lt;&lt; static_cast&lt;unsigned char&gt;(NETMSG_AICOMMANDS)
 	        &lt;&lt; static_cast&lt;unsigned short&gt;(msgLen)
 	        &lt;&lt; static_cast&lt;unsigned char&gt;(gu-&gt;myPlayerNum);
-	
+
 	*packet &lt;&lt; static_cast&lt;unsigned short&gt;(unitIDCount);
 	for (std::vector&lt;int&gt;::const_iterator it = unitIDs.begin(); it != unitIDs.end(); ++it)
 	{

Modified: trunk/rts/Game/SelectedUnitsAI.cpp
===================================================================
--- trunk/rts/Game/SelectedUnitsAI.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Game/SelectedUnitsAI.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -15,10 +15,11 @@
 #include &quot;NetProtocol.h&quot;
 #include &quot;Sim/Misc/GlobalSynced.h&quot;
 #include &quot;GlobalUnsynced.h&quot;
-#include &quot;Player.h&quot;
+#include &quot;PlayerHandler.h&quot;
 #include &quot;WaitCommandsAI.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Sim/Misc/QuadField.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/MoveTypes/MoveType.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
 #include &quot;Sim/Units/CommandAI/CommandAI.h&quot;
@@ -514,11 +515,11 @@
 	if ((player &lt; 0) || (player &gt;= MAX_PLAYERS)) {
 		return;
 	}
-	const CPlayer* p = gs-&gt;players[player];
+	const CPlayer* p = playerHandler-&gt;Player(player);
 	if (p == NULL) {
 		return;
 	}
-	const int allyTeam = gs-&gt;AllyTeam(p-&gt;team);
+	const int allyTeam = teamHandler-&gt;AllyTeam(p-&gt;team);
 
 	vector&lt;CUnit*&gt; tmpUnits = qf-&gt;GetUnits(pos, radius);
 
@@ -548,11 +549,11 @@
 	if ((player &lt; 0) || (player &gt;= MAX_PLAYERS)) {
 		return;
 	}
-	const CPlayer* p = gs-&gt;players[player];
+	const CPlayer* p = playerHandler-&gt;Player(player);
 	if (p == NULL) {
 		return;
 	}
-	const int allyTeam = gs-&gt;AllyTeam(p-&gt;team);
+	const int allyTeam = teamHandler-&gt;AllyTeam(p-&gt;team);
 
 	const float3 mins(std::min(pos0.x, pos1.x), 0.0f, std::min(pos0.z, pos1.z));
 	const float3 maxs(std::max(pos0.x, pos1.x), 0.0f, std::max(pos0.z, pos1.z));

Modified: trunk/rts/Game/StartScripts/CommanderScript.cpp
===================================================================
--- trunk/rts/Game/StartScripts/CommanderScript.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Game/StartScripts/CommanderScript.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -9,13 +9,13 @@
 #include &quot;ExternalAI/GlobalAIHandler.h&quot;
 #include &quot;Game/Game.h&quot;
 #include &quot;Game/GameSetup.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
 #include &quot;Game/UI/MiniMap.h&quot;
 #include &quot;Game/UI/InfoConsole.h&quot;
 #include &quot;Lua/LuaParser.h&quot;
 #include &quot;Map/MapParser.h&quot;
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;Sim/Misc/SideParser.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitDefHandler.h&quot;
 #include &quot;Sim/Units/UnitLoader.h&quot;
@@ -41,14 +41,14 @@
 void CCommanderScript::GameStart()
 {
 	// setup the teams
-	for (int a = 0; a &lt; gs-&gt;activeTeams; ++a) {
+	for (int a = 0; a &lt; teamHandler-&gt;ActiveTeams(); ++a) {
 
 		// don't spawn a commander for the gaia team
-		if (gs-&gt;useLuaGaia &amp;&amp; (a == gs-&gt;gaiaTeamID)) {
+		if (gs-&gt;useLuaGaia &amp;&amp; (a == teamHandler-&gt;GaiaTeamID())) {
 			continue;
 		}
 
-		CTeam* team = gs-&gt;Team(a);
+		CTeam* team = teamHandler-&gt;Team(a);
 
 		if (team-&gt;gaia) continue;
 

Modified: trunk/rts/Game/StartScripts/CommanderScript2.cpp
===================================================================
--- trunk/rts/Game/StartScripts/CommanderScript2.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Game/StartScripts/CommanderScript2.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -2,7 +2,7 @@
 #include &quot;mmgr.h&quot;
 
 #include &quot;CommanderScript2.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Lua/LuaParser.h&quot;
 #include &quot;Map/MapParser.h&quot;
 #include &quot;Map/ReadMap.h&quot;
@@ -28,19 +28,19 @@
 
 void CCommanderScript2::GameStart()
 {
-	gs-&gt;Team(0)-&gt;energy=1000;
-	gs-&gt;Team(0)-&gt;energyIncome=1000;	//for the endgame statistics
-	gs-&gt;Team(0)-&gt;energyStorage=1000;
-	gs-&gt;Team(0)-&gt;metal=1000;
-	gs-&gt;Team(0)-&gt;metalIncome=1000;
-	gs-&gt;Team(0)-&gt;metalStorage=1000;
+	teamHandler-&gt;Team(0)-&gt;energy=1000;
+	teamHandler-&gt;Team(0)-&gt;energyIncome=1000;	//for the endgame statistics
+	teamHandler-&gt;Team(0)-&gt;energyStorage=1000;
+	teamHandler-&gt;Team(0)-&gt;metal=1000;
+	teamHandler-&gt;Team(0)-&gt;metalIncome=1000;
+	teamHandler-&gt;Team(0)-&gt;metalStorage=1000;
 
-	gs-&gt;Team(1)-&gt;energy=1000;
-	gs-&gt;Team(1)-&gt;energyIncome=1000;
-	gs-&gt;Team(1)-&gt;energyStorage=1000;
-	gs-&gt;Team(1)-&gt;metal=1000;
-	gs-&gt;Team(1)-&gt;metalIncome=1000;
-	gs-&gt;Team(1)-&gt;metalStorage=1000;
+	teamHandler-&gt;Team(1)-&gt;energy=1000;
+	teamHandler-&gt;Team(1)-&gt;energyIncome=1000;
+	teamHandler-&gt;Team(1)-&gt;energyStorage=1000;
+	teamHandler-&gt;Team(1)-&gt;metal=1000;
+	teamHandler-&gt;Team(1)-&gt;metalIncome=1000;
+	teamHandler-&gt;Team(1)-&gt;metalStorage=1000;
 
 	const std::string startUnit0 = sideParser.GetStartUnit(0, &quot;&quot;);
 	const std::string startUnit1 = sideParser.GetStartUnit(1, startUnit0);

Modified: trunk/rts/Game/StartScripts/GlobalAITestScript.cpp
===================================================================
--- trunk/rts/Game/StartScripts/GlobalAITestScript.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Game/StartScripts/GlobalAITestScript.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -3,7 +3,7 @@
 #include &quot;StdAfx.h&quot;
 #include &quot;GlobalAITestScript.h&quot;
 #include &quot;ExternalAI/GlobalAIHandler.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Lua/LuaParser.h&quot;
 #include &quot;Map/MapParser.h&quot;
 #include &quot;Map/ReadMap.h&quot;
@@ -26,9 +26,9 @@
 {
 	// make sure CSelectedUnits::AiOrder()
 	// still works without a setup script
-	gs-&gt;Team(1)-&gt;isAI = true;
-	gs-&gt;Team(1)-&gt;dllAI = dllName;
-	gs-&gt;Team(1)-&gt;leader = 0;
+	teamHandler-&gt;Team(1)-&gt;isAI = true;
+	teamHandler-&gt;Team(1)-&gt;dllAI = dllName;
+	teamHandler-&gt;Team(1)-&gt;leader = 0;
 }
 
 
@@ -41,15 +41,15 @@
 {
 	globalAI-&gt;CreateGlobalAI(1, dllName.c_str());
 
-	gs-&gt;Team(0)-&gt;energy        = 1000;
-	gs-&gt;Team(0)-&gt;energyStorage = 1000;
-	gs-&gt;Team(0)-&gt;metal         = 1000;
-	gs-&gt;Team(0)-&gt;metalStorage  = 1000;
+	teamHandler-&gt;Team(0)-&gt;energy        = 1000;
+	teamHandler-&gt;Team(0)-&gt;energyStorage = 1000;
+	teamHandler-&gt;Team(0)-&gt;metal         = 1000;
+	teamHandler-&gt;Team(0)-&gt;metalStorage  = 1000;
 
-	gs-&gt;Team(1)-&gt;energy        = 1000;
-	gs-&gt;Team(1)-&gt;energyStorage = 1000;
-	gs-&gt;Team(1)-&gt;metal         = 1000;
-	gs-&gt;Team(1)-&gt;metalStorage  = 1000;
+	teamHandler-&gt;Team(1)-&gt;energy        = 1000;
+	teamHandler-&gt;Team(1)-&gt;energyStorage = 1000;
+	teamHandler-&gt;Team(1)-&gt;metal         = 1000;
+	teamHandler-&gt;Team(1)-&gt;metalStorage  = 1000;
 
 	const std::string startUnit0 = sideParser.GetStartUnit(0, &quot;&quot;);
 	const std::string startUnit1 = sideParser.GetStartUnit(1, startUnit0);

Modified: trunk/rts/Game/StartScripts/SpawnScript.cpp
===================================================================
--- trunk/rts/Game/StartScripts/SpawnScript.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Game/StartScripts/SpawnScript.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -5,7 +5,7 @@
 #include &quot;mmgr.h&quot;
 
 #include &quot;SpawnScript.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Lua/LuaParser.h&quot;
 #include &quot;Map/MapParser.h&quot;
 #include &quot;Map/ReadMap.h&quot;
@@ -101,16 +101,16 @@
 		}
 	}
 
-	if(!myUnits.empty() &amp;&amp; !gs-&gt;Team(1 - curUnit-&gt;team)-&gt;units.empty()) {
+	if(!myUnits.empty() &amp;&amp; !teamHandler-&gt;Team(1 - curUnit-&gt;team)-&gt;units.empty()) {
 		if(uh-&gt;units[curUnit-&gt;id]){
 			if(curUnit-&gt;target&lt;0 || uh-&gt;units[curUnit-&gt;target]==0){
 				// We can't rely on the ordering of units in a std::set&lt;CUnit*&gt;,
 				// because they're sorted on memory address. Hence we must first
 				// build a set of IDs and then pick an unit from that.
 				// This guarantees the script doesn't desync in multiplayer games.
-				int num = gs-&gt;randInt() % gs-&gt;Team(1 - curUnit-&gt;team)-&gt;units.size();
+				int num = gs-&gt;randInt() % teamHandler-&gt;Team(1 - curUnit-&gt;team)-&gt;units.size();
 				std::set&lt;int&gt; unitids;
-				CUnitSet* tu = &amp;gs-&gt;Team(1 - curUnit-&gt;team)-&gt;units;
+				CUnitSet* tu = &amp;teamHandler-&gt;Team(1 - curUnit-&gt;team)-&gt;units;
 				for (CUnitSet::iterator u = tu-&gt;begin(); u != tu-&gt;end(); ++u)
 					unitids.insert((*u)-&gt;id);
 				std::set&lt;int&gt;::iterator ui = unitids.begin();

Modified: trunk/rts/Game/UI/EndGameBox.cpp
===================================================================
--- trunk/rts/Game/UI/EndGameBox.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Game/UI/EndGameBox.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -5,8 +5,8 @@
 #include &quot;EndGameBox.h&quot;
 #include &quot;MouseHandler.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
-#include &quot;Game/Player.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
+#include &quot;Game/PlayerHandler.h&quot;
 #include &quot;Rendering/glFont.h&quot;
 #include &quot;NetProtocol.h&quot;
 #include &quot;Game/Game.h&quot;
@@ -223,7 +223,7 @@
 	font-&gt;glPrintAt(box.x1+sumBox.x1+0.015f,box.y1+sumBox.y1+0.005f,0.7f,&quot;Team stats&quot;);
 	font-&gt;glPrintAt(box.x1+difBox.x1+0.015f,box.y1+difBox.y1+0.005f,0.7f,&quot;Team delta stats&quot;);
 
-	if(gs-&gt;Team(gu-&gt;myTeam)-&gt;isDead){
+	if(teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;isDead){
 		font-&gt;glPrintAt(box.x1+0.25f,box.y1+0.65f,1,&quot;You lost the game&quot;);
 	} else {
 		font-&gt;glPrintAt(box.x1+0.25f,box.y1+0.65f,1,&quot;You won the game&quot;);
@@ -240,19 +240,19 @@
 		}
 
 		float ypos=0.5f;
-		for(int a=0;a&lt;gs-&gt;activePlayers;++a){
-			if(gs-&gt;players[a]-&gt;currentStats-&gt;mousePixels==0)
+		for(int a=0;a&lt;playerHandler-&gt;ActivePlayers();++a){
+			if(playerHandler-&gt;Player(a)-&gt;currentStats-&gt;mousePixels==0)
 				continue;
 			char values[6][100];
 
-			sprintf(values[0],&quot;%s&quot;,	gs-&gt;players[a]-&gt;name.c_str());
-			sprintf(values[1],&quot;%i&quot;,(int)(gs-&gt;players[a]-&gt;currentStats-&gt;mouseClicks*60/game-&gt;totalGameTime));
-			sprintf(values[2],&quot;%i&quot;,(int)(gs-&gt;players[a]-&gt;currentStats-&gt;mousePixels*60/game-&gt;totalGameTime));
-			sprintf(values[3],&quot;%i&quot;,(int)(gs-&gt;players[a]-&gt;currentStats-&gt;keyPresses*60/game-&gt;totalGameTime));
-			sprintf(values[4],&quot;%i&quot;,(int)(gs-&gt;players[a]-&gt;currentStats-&gt;numCommands*60/game-&gt;totalGameTime));
+			sprintf(values[0],&quot;%s&quot;,	playerHandler-&gt;Player(a)-&gt;name.c_str());
+			sprintf(values[1],&quot;%i&quot;,(int)(playerHandler-&gt;Player(a)-&gt;currentStats-&gt;mouseClicks*60/game-&gt;totalGameTime));
+			sprintf(values[2],&quot;%i&quot;,(int)(playerHandler-&gt;Player(a)-&gt;currentStats-&gt;mousePixels*60/game-&gt;totalGameTime));
+			sprintf(values[3],&quot;%i&quot;,(int)(playerHandler-&gt;Player(a)-&gt;currentStats-&gt;keyPresses*60/game-&gt;totalGameTime));
+			sprintf(values[4],&quot;%i&quot;,(int)(playerHandler-&gt;Player(a)-&gt;currentStats-&gt;numCommands*60/game-&gt;totalGameTime));
 			sprintf(values[5],&quot;%i&quot;,(int)
-				( gs-&gt;players[a]-&gt;currentStats-&gt;numCommands != 0 ) ?
-				( gs-&gt;players[a]-&gt;currentStats-&gt;unitCommands/gs-&gt;players[a]-&gt;currentStats-&gt;numCommands) :
+				( playerHandler-&gt;Player(a)-&gt;currentStats-&gt;numCommands != 0 ) ?
+				( playerHandler-&gt;Player(a)-&gt;currentStats-&gt;unitCommands/playerHandler-&gt;Player(a)-&gt;currentStats-&gt;numCommands) :
 				( 0 ));
 
 			float xpos=0.01f;
@@ -337,9 +337,9 @@
 		glEnd();
 		glDisable(GL_LINE_STIPPLE);
 
-		for(int team=0; team&lt;gs-&gt;activeTeams; team++){
-			if (gs-&gt;Team(team)-&gt;gaia) continue;
-			glColor4ubv(gs-&gt;Team(team)-&gt;color);
+		for(int team=0; team&lt;teamHandler-&gt;ActiveTeams(); team++){
+			if (teamHandler-&gt;Team(team)-&gt;gaia) continue;
+			glColor4ubv(teamHandler-&gt;Team(team)-&gt;color);
 
 			glBegin(GL_LINE_STRIP);
 			for(int a=0;a&lt;numPoints;++a){
@@ -427,9 +427,9 @@
 	stats.push_back(Stat(&quot;Damage Dealt&quot;));
 	stats.push_back(Stat(&quot;Damage Received&quot;));
 
-	for(int team=0; team&lt;gs-&gt;activeTeams; team++){
-		if (gs-&gt;Team(team)-&gt;gaia) continue;
-		for(std::list&lt;CTeam::Statistics&gt;::iterator si=gs-&gt;Team(team)-&gt;statHistory.begin(); si!=gs-&gt;Team(team)-&gt;statHistory.end(); si++){
+	for(int team=0; team&lt;teamHandler-&gt;ActiveTeams(); team++){
+		if (teamHandler-&gt;Team(team)-&gt;gaia) continue;
+		for(std::list&lt;CTeam::Statistics&gt;::iterator si=teamHandler-&gt;Team(team)-&gt;statHistory.begin(); si!=teamHandler-&gt;Team(team)-&gt;statHistory.end(); si++){
 			stats[0].AddStat(team,0);
 
 			stats[1].AddStat(team, si-&gt;metalUsed);

Modified: trunk/rts/Game/UI/GameSetupDrawer.cpp
===================================================================
--- trunk/rts/Game/UI/GameSetupDrawer.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Game/UI/GameSetupDrawer.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -13,10 +13,10 @@
 #include &quot;NetProtocol.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;Game/CameraHandler.h&quot;
-#include &quot;Game/Player.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
+#include &quot;Game/PlayerHandler.h&quot;
 #include &quot;Game/GameSetup.h&quot;
 #include &quot;Sim/Misc/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;StartPosSelecter.h&quot;
 #include &quot;Rendering/glFont.h&quot;
 #include &quot;EventHandler.h&quot;
@@ -91,7 +91,7 @@
 		char buf[64];
 		sprintf(buf, &quot;Starting in %i&quot;, readyCountdown / 1000);
 		state = buf;
-	} else if (!gs-&gt;Team(gu-&gt;myTeam)-&gt;IsReadyToStart()) {
+	} else if (!teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;IsReadyToStart()) {
 		state = &quot;Choose start pos&quot;;
 	} else if (gu-&gt;myPlayerNum==0) {
 		state = &quot;Waiting for players, Ctrl+Return to force start&quot;;
@@ -102,9 +102,9 @@
 	// not the most efficent way to do this, but who cares?
 	std::map&lt;int, std::string&gt; playerStates;
 	for (int a = 0; a &lt; gameSetup-&gt;numPlayers; a++) {
-		if (!gs-&gt;players[a]-&gt;readyToStart) {
+		if (!playerHandler-&gt;Player(a)-&gt;readyToStart) {
 			playerStates[a] = &quot;missing&quot;;
-		} else if (!gs-&gt;Team(gs-&gt;players[a]-&gt;team)-&gt;IsReadyToStart()) {
+		} else if (!teamHandler-&gt;Team(playerHandler-&gt;Player(a)-&gt;team)-&gt;IsReadyToStart()) {
 			playerStates[a] = &quot;notready&quot;;
 		} else {
 			playerStates[a] = &quot;ready&quot;;
@@ -137,9 +137,9 @@
 		const float  white[4] = { 1.0f, 1.0f, 1.0f, 1.0f };
 		if (a == gameSetup-&gt;numPlayers) {
 			color = white; //blue;
-		} else if (!gs-&gt;players[a]-&gt;readyToStart) {
+		} else if (!playerHandler-&gt;Player(a)-&gt;readyToStart) {
 			color = red;
-		} else if (!gs-&gt;Team(gs-&gt;players[a]-&gt;team)-&gt;IsReadyToStart()) {
+		} else if (!teamHandler-&gt;Team(playerHandler-&gt;Player(a)-&gt;team)-&gt;IsReadyToStart()) {
 			color = yellow;
 		} else {
 			color = green;
@@ -149,7 +149,7 @@
 		if (a == gameSetup-&gt;numPlayers) {
 			name = &quot;Players:&quot;;
 		} else {
-			name = gs-&gt;players[a]-&gt;name.c_str();
+			name = playerHandler-&gt;Player(a)-&gt;name.c_str();
 		}
 		const float fontScale = 1.0f;
 		const float yScale = fontScale * font-&gt;GetHeight();

Modified: trunk/rts/Game/UI/HwMouseCursor.cpp
===================================================================
--- trunk/rts/Game/UI/HwMouseCursor.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Game/UI/HwMouseCursor.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -42,7 +42,7 @@
 		void PushFrame(int index, float delay){};
 		void Finish(){};
 
-		bool needsYFlip() {return false;};
+		bool NeedsYFlip() {return false;};
 
 		bool IsValid(){return false;};
 		void Bind(){};
@@ -58,7 +58,7 @@
 		void PushFrame(int index, float delay);
 		void Finish();
 
-		bool needsYFlip() {return true;};
+		bool NeedsYFlip() {return true;};
 
 		void Bind();
 
@@ -111,7 +111,7 @@
 		void PushFrame(int index, float delay);
 		void Finish();
 
-		bool needsYFlip() {return false;};
+		bool NeedsYFlip() {return false;};
 
 		bool IsValid() {return (cursor!=0);};
 		void Bind();
@@ -142,7 +142,7 @@
 
 
 //////////////////////////////////////////////////////////////////////
-// Implementation 
+// Implementation
 //////////////////////////////////////////////////////////////////////
 
 
@@ -415,7 +415,7 @@
 
 void CHwX11Cursor::resizeImage(XcursorImage*&amp; image, const int new_x, const int new_y)
 {
-	if (image-&gt;width==new_x &amp;&amp; image-&gt;height==new_y)
+	if (int(image-&gt;width) == new_x &amp;&amp; int(image-&gt;height) == new_y)
 		return;
 
 	const int old_x = image-&gt;width;
@@ -424,7 +424,7 @@
 	XcursorImage* new_image = XcursorImageCreate(new_x, new_y);
 	new_image-&gt;delay = image-&gt;delay;
 
-	unsigned char* src = (unsigned char*)image-&gt;pixels;
+	const unsigned char* src = (unsigned char*)image-&gt;pixels;
 	unsigned char* dst = (unsigned char*)new_image-&gt;pixels;
 	memset(dst, 0, new_x*new_y*4);
 
@@ -466,15 +466,15 @@
 
 void CHwX11Cursor::PushFrame(int index, float delay)
 {
-	if (index&gt;=cimages.size())
+	if (index &gt;= int(cimages.size()))
 		return;
 
-	if (cimages[index]-&gt;delay!=delay) {
+	if (cimages[index]-&gt;delay != delay) {
 		// make a copy of the existing one
 		XcursorImage* ci = cimages[index];
 		PushImage( ci-&gt;width, ci-&gt;height, ci-&gt;pixels );
 		SetDelay(delay);
-	}else{
+	} else {
 		cimages.push_back( cimages[index] );
 	}
 }
@@ -485,12 +485,12 @@
 		return;
 
 	//resize images
-	for (std::vector&lt;XcursorImage*&gt;::iterator it=cimages.begin(); it&lt;cimages.end(); it++)
-		resizeImage(*it,xmaxsize,ymaxsize);
+	for (std::vector&lt;XcursorImage*&gt;::iterator it = cimages.begin(); it &lt; cimages.end(); ++it)
+		resizeImage(*it, xmaxsize, ymaxsize);
 
 	XcursorImages *cis = XcursorImagesCreate(cimages.size());
 	cis-&gt;nimage = cimages.size();
-	for (int i=0; i &lt; cimages.size(); i++ ) {
+	for (int i = 0; i &lt; int(cimages.size()); ++i) {
 		XcursorImage* ci = cimages[i];
 		ci-&gt;xhot = (hotSpot==CMouseCursor::TopLeft) ? 0 : ci-&gt;width/2;
 		ci-&gt;yhot = (hotSpot==CMouseCursor::TopLeft) ? 0 : ci-&gt;height/2;

Modified: trunk/rts/Game/UI/HwMouseCursor.h
===================================================================
--- trunk/rts/Game/UI/HwMouseCursor.h	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Game/UI/HwMouseCursor.h	2008-11-12 22:26:06 UTC (rev 7026)
@@ -14,7 +14,7 @@
 		virtual void PushFrame(int index, float delay) = 0;
 		virtual void Finish() = 0;
 
-		virtual bool needsYFlip() = 0; //windows needs flipped Y axis
+		virtual bool NeedsYFlip() = 0; //windows needs flipped Y axis
 
 		virtual bool IsValid() = 0;
 		virtual void Bind() = 0;

Modified: trunk/rts/Game/UI/MiniMap.cpp
===================================================================
--- trunk/rts/Game/UI/MiniMap.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Game/UI/MiniMap.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -18,7 +18,7 @@
 #include &quot;Game/GameHelper.h&quot;
 #include &quot;Game/Player.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;GuiHandler.h&quot;
 #include &quot;Lua/LuaUnsyncedCtrl.h&quot;
 #include &quot;Map/BaseGroundDrawer.h&quot;
@@ -688,13 +688,13 @@
 
 		if (gu-&gt;spectatingFullSelect) {
 			team = 0;
-			lastTeam = gs-&gt;activeTeams - 1;
+			lastTeam = teamHandler-&gt;ActiveTeams() - 1;
 		} else {
 			team = gu-&gt;myTeam;
 			lastTeam = gu-&gt;myTeam;
 		}
 		for (; team &lt;= lastTeam; team++) {
-			CUnitSet&amp; teamUnits = gs-&gt;Team(team)-&gt;units;
+			CUnitSet&amp; teamUnits = teamHandler-&gt;Team(team)-&gt;units;
 			for (ui = teamUnits.begin(); ui != teamUnits.end(); ++ui) {
 				const float3&amp; midPos = (*ui)-&gt;midPos;
 
@@ -756,13 +756,13 @@
 					int team, lastTeam;
 					if (gu-&gt;spectatingFullSelect) {
 						team = 0;
-						lastTeam = gs-&gt;activeTeams - 1;
+						lastTeam = teamHandler-&gt;ActiveTeams() - 1;
 					} else {
 						team = gu-&gt;myTeam;
 						lastTeam = gu-&gt;myTeam;
 					}
 					for (; team &lt;= lastTeam; team++) {
-						CUnitSet&amp; myUnits = gs-&gt;Team(team)-&gt;units;
+						CUnitSet&amp; myUnits = teamHandler-&gt;Team(team)-&gt;units;
 						for (ui = myUnits.begin(); ui != myUnits.end(); ++ui) {
 							if ((*ui)-&gt;aihint == unit-&gt;aihint) {
 								selectedUnits.AddUnit(*ui);
@@ -839,7 +839,7 @@
 //	CCamera *c = camera;
 //	camera = new CCamera(*c);
 
-//	const float3 tmpMouseDir = mouse-&gt;dir; 
+//	const float3 tmpMouseDir = mouse-&gt;dir;
 
 	float3 mapPos = GetMapPosition(x, y);
 	const CUnit* unit = GetSelectUnit(mapPos);
@@ -1488,13 +1488,13 @@
 		if (simpleColors) {
 			if (unit-&gt;team == gu-&gt;myTeam) {
 				glColor3ubv(myColor);
-			} else if (gs-&gt;Ally(gu-&gt;myAllyTeam, unit-&gt;allyteam)) {
+			} else if (teamHandler-&gt;Ally(gu-&gt;myAllyTeam, unit-&gt;allyteam)) {
 				glColor3ubv(allyColor);
 			} else {
 				glColor3ubv(enemyColor);
 			}
 		} else {
-			glColor3ubv(gs-&gt;Team(unit-&gt;team)-&gt;color);
+			glColor3ubv(teamHandler-&gt;Team(unit-&gt;team)-&gt;color);
 		}
 	}
 

Modified: trunk/rts/Game/UI/MouseCursor.cpp
===================================================================
--- trunk/rts/Game/UI/MouseCursor.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Game/UI/MouseCursor.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -176,7 +176,7 @@
 		delete f;
 	}
 
-	while (frames.size() &lt; lastFrame) {
+	while (int(frames.size()) &lt; lastFrame) {
 		SNPRINTF(namebuf, sizeof(namebuf), &quot;anims/%s_%d.%s&quot;,
 		         name.c_str(), frames.size(), ext);
 		ImageData image;
@@ -212,7 +212,7 @@
 		setBitmapTransparency(b, 84, 84, 252);
 	}
 
-	if (hwCursor-&gt;needsYFlip()) {
+	if (hwCursor-&gt;NeedsYFlip()) {
 		//WINDOWS
 		b.ReverseYAxis();
 		hwCursor-&gt;PushImage(b.xsize,b.ysize,b.mem);
@@ -357,7 +357,7 @@
 
 	while (animTime &gt; frames[currentFrame].endTime) {
 		currentFrame++;
-		if (currentFrame &gt;= frames.size()) {
+		if (currentFrame &gt;= int(frames.size())) {
 			currentFrame = 0;
 		}
 	}
@@ -372,5 +372,5 @@
 
 void CMouseCursor::BindHwCursor()
 {
-	hwCursor-&gt;Bind();	
+	hwCursor-&gt;Bind();
 }

Modified: trunk/rts/Game/UI/MouseHandler.cpp
===================================================================
--- trunk/rts/Game/UI/MouseHandler.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Game/UI/MouseHandler.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -20,8 +20,7 @@
 #include &quot;Game/Game.h&quot;
 #include &quot;Game/GameHelper.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
-#include &quot;Game/Player.h&quot;
+#include &quot;Game/PlayerHandler.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Map/MapDamage.h&quot;
 #include &quot;Lua/LuaInputReceiver.h&quot;
@@ -34,6 +33,7 @@
 #include &quot;Sim/Features/FeatureDef.h&quot;
 #include &quot;Sim/Features/Feature.h&quot;
 #include &quot;Sim/Misc/LosHandler.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
@@ -181,7 +181,7 @@
 	buttons[SDL_BUTTON_RIGHT].movement += abs(dx) + abs(dy);
 
 	if (!game-&gt;gameOver) {
-		gs-&gt;players[gu-&gt;myPlayerNum]-&gt;currentStats-&gt;mousePixels+=abs(dx)+abs(dy);
+		playerHandler-&gt;Player(gu-&gt;myPlayerNum)-&gt;currentStats-&gt;mousePixels+=abs(dx)+abs(dy);
 	}
 
 	if(activeReceiver){
@@ -210,7 +210,7 @@
 	dir = hide? camera-&gt;forward: camera-&gt;CalcPixelDir(x, y);
 
 	if (!game-&gt;gameOver)
-		gs-&gt;players[gu-&gt;myPlayerNum]-&gt;currentStats-&gt;mouseClicks++;
+		playerHandler-&gt;Player(gu-&gt;myPlayerNum)-&gt;currentStats-&gt;mouseClicks++;
 
 	if (button == 4) {
 		if (guihandler-&gt;buildSpacing &gt; 0)
@@ -409,13 +409,13 @@
 			int team, lastTeam;
 			if (gu-&gt;spectatingFullSelect) {
 				team = 0;
-				lastTeam = gs-&gt;activeTeams - 1;
+				lastTeam = teamHandler-&gt;ActiveTeams() - 1;
 			} else {
 				team = gu-&gt;myTeam;
 				lastTeam = gu-&gt;myTeam;
 			}
 			for (; team &lt;= lastTeam; team++) {
-				for(ui=gs-&gt;Team(team)-&gt;units.begin();ui!=gs-&gt;Team(team)-&gt;units.end();++ui){
+				for(ui=teamHandler-&gt;Team(team)-&gt;units.begin();ui!=teamHandler-&gt;Team(team)-&gt;units.end();++ui){
 					float3 vec=(*ui)-&gt;midPos-camera-&gt;pos;
 					if(vec.dot(norm1)&lt;0 &amp;&amp; vec.dot(norm2)&lt;0 &amp;&amp; vec.dot(norm3)&lt;0 &amp;&amp; vec.dot(norm4)&lt;0){
 						if (keys[SDLK_LCTRL] &amp;&amp; selectedUnits.selectedUnits.find(*ui) != selectedUnits.selectedUnits.end()) {
@@ -459,14 +459,14 @@
 						int team, lastTeam;
 						if (gu-&gt;spectatingFullSelect) {
 							team = 0;
-							lastTeam = gs-&gt;activeTeams - 1;
+							lastTeam = teamHandler-&gt;ActiveTeams() - 1;
 						} else {
 							team = gu-&gt;myTeam;
 							lastTeam = gu-&gt;myTeam;
 						}
 						for (; team &lt;= lastTeam; team++) {
 							CUnitSet::iterator ui;
-							CUnitSet&amp; teamUnits = gs-&gt;Team(team)-&gt;units;
+							CUnitSet&amp; teamUnits = teamHandler-&gt;Team(team)-&gt;units;
 							for (ui = teamUnits.begin(); ui != teamUnits.end(); ++ui) {
 								if (((*ui)-&gt;aihint == unit-&gt;aihint) &amp;&amp;
 										(camera-&gt;InView((*ui)-&gt;midPos) || keys[SDLK_LCTRL])) {

Modified: trunk/rts/Game/UI/QuitBox.cpp
===================================================================
--- trunk/rts/Game/UI/QuitBox.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Game/UI/QuitBox.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -2,12 +2,13 @@
 #include &lt;SDL_keysym.h&gt;
 #include &quot;mmgr.h&quot;
 
-#include &quot;Sim/Misc/Team.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Misc/GlobalSynced.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;MouseHandler.h&quot;
 #include &quot;NetProtocol.h&quot;
 #include &quot;QuitBox.h&quot;
+#include &quot;Game/PlayerHandler.h&quot;
 #include &quot;Rendering/glFont.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
 
@@ -50,13 +51,13 @@
 	noAlliesLeft=true;
 	shareTeam=0;
 	// if we have alive allies left, set the shareteam to an undead ally.
-	for(int team=0;team&lt;gs-&gt;activeTeams;++team){
-		if (gs-&gt;Team(team)-&gt;gaia) continue;
-		if(team!=gu-&gt;myTeam &amp;&amp; !gs-&gt;Team(team)-&gt;isDead)
+	for(int team=0;team&lt;teamHandler-&gt;ActiveTeams();++team){
+		if (teamHandler-&gt;Team(team)-&gt;gaia) continue;
+		if(team!=gu-&gt;myTeam &amp;&amp; !teamHandler-&gt;Team(team)-&gt;isDead)
 		{
-			if(shareTeam==gu-&gt;myTeam || gs-&gt;Team(shareTeam)-&gt;isDead)
+			if(shareTeam==gu-&gt;myTeam || teamHandler-&gt;Team(shareTeam)-&gt;isDead)
 				shareTeam=team;
-			if(gs-&gt;Ally(gu-&gt;myAllyTeam, gs-&gt;AllyTeam(team))){
+			if(teamHandler-&gt;Ally(gu-&gt;myAllyTeam, teamHandler-&gt;AllyTeam(team))){
 				noAlliesLeft=false;
 				shareTeam=team;
 				break;
@@ -122,12 +123,12 @@
 	font-&gt;glPrintAt(box.x1 + quitBox.x1       + 0.025f,
 	                box.y1 + quitBox.y1       + 0.005f, 1, &quot;Quit&quot;);
 
-	for(int team=0;team&lt;gs-&gt;activeTeams-1;++team){
+	for(int team=0;team&lt;teamHandler-&gt;ActiveTeams()-1;++team){
 		int actualTeam=team;
 		if (team &gt;= gu-&gt;myTeam) {
 			actualTeam++;
 		}
-		if (gs-&gt;Team(actualTeam)-&gt;gaia) continue;
+		if (teamHandler-&gt;Team(actualTeam)-&gt;gaia) continue;
 
 		if (shareTeam == actualTeam) {
 			glColor4f(1,1,1,0.8f);
@@ -136,21 +137,21 @@
 		}
 
 		std::string teamName;
-		if (gs-&gt;Team(actualTeam)-&gt;leader &gt;= 0)
-			teamName = gs-&gt;players[gs-&gt;Team(actualTeam)-&gt;leader]-&gt;name;
+		if (teamHandler-&gt;Team(actualTeam)-&gt;leader &gt;= 0)
+			teamName = playerHandler-&gt;Player(teamHandler-&gt;Team(actualTeam)-&gt;leader)-&gt;name;
 		else
 			teamName = &quot;uncontrolled&quot;;
 
 		std::string ally, dead;
-		if (gs-&gt;Ally(gu-&gt;myAllyTeam, gs-&gt;AllyTeam(actualTeam))) {
+		if (teamHandler-&gt;Ally(gu-&gt;myAllyTeam, teamHandler-&gt;AllyTeam(actualTeam))) {
 			ally = &quot; &lt;Ally&gt;)&quot;;
 		} else {
 			ally = &quot; &lt;Enemy&gt;&quot;;
 		}
-		if(gs-&gt;Team(actualTeam)-&gt;isDead) {
+		if(teamHandler-&gt;Team(actualTeam)-&gt;isDead) {
 			dead = &quot; &lt;Dead&gt;&quot;;
 		}
-		if (actualTeam == gs-&gt;gaiaTeamID) {
+		if (actualTeam == teamHandler-&gt;GaiaTeamID()) {
 			teamName = &quot;Gaia&quot;;
 			ally   = &quot; &lt;Gaia&gt;&quot;;
 		}
@@ -202,9 +203,9 @@
 			int team=(int)((box.y1+teamBox.y2-my)/0.025f);
 			if(team&gt;=gu-&gt;myTeam)
 				team++;
-			if(team&lt;gs-&gt;activeTeams &amp;&amp; !gs-&gt;Team(team)-&gt;isDead){
+			if(team&lt;teamHandler-&gt;ActiveTeams() &amp;&amp; !teamHandler-&gt;Team(team)-&gt;isDead){
 				// we don't want to give everything to the enemy if there are allies left
-				if(noAlliesLeft || (!noAlliesLeft &amp;&amp; gs-&gt;Ally(gu-&gt;myAllyTeam, gs-&gt;AllyTeam(team)))){
+				if(noAlliesLeft || (!noAlliesLeft &amp;&amp; teamHandler-&gt;Ally(gu-&gt;myAllyTeam, teamHandler-&gt;AllyTeam(team)))){
 					shareTeam=team;
 				}
 			}
@@ -219,15 +220,15 @@
 	float mx=MouseX(x);
 	float my=MouseY(y);
 
-	if(InBox(mx,my,box+resignBox) || InBox(mx,my,box+giveAwayBox) &amp;&amp; !gs-&gt;Team(shareTeam)-&gt;isDead &amp;&amp; !gs-&gt;Team(gu-&gt;myTeam)-&gt;isDead){
+	if(InBox(mx,my,box+resignBox) || InBox(mx,my,box+giveAwayBox) &amp;&amp; !teamHandler-&gt;Team(shareTeam)-&gt;isDead &amp;&amp; !teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;isDead){
 		// give away all units (and resources)
 		if(InBox(mx,my,box+giveAwayBox)) {
 			net-&gt;Send(CBaseNetProtocol::Get().SendGiveAwayEverything(gu-&gt;myPlayerNum, shareTeam));
 			// inform other users of the giving away of units
 			char givenAwayMsg[200];
 			sprintf(givenAwayMsg,&quot;%s gave everything to %s.&quot;,
-				gs-&gt;players[gu-&gt;myPlayerNum]-&gt;name.c_str(),
-				gs-&gt;players[gs-&gt;Team(shareTeam)-&gt;leader]-&gt;name.c_str());
+				playerHandler-&gt;Player(gu-&gt;myPlayerNum)-&gt;name.c_str(),
+				playerHandler-&gt;Player(teamHandler-&gt;Team(shareTeam)-&gt;leader)-&gt;name.c_str());
 			net-&gt;Send(CBaseNetProtocol::Get().SendSystemMessage(gu-&gt;myPlayerNum, givenAwayMsg));
 		}
 		// resign, so self-d all units
@@ -262,9 +263,9 @@
 		int team=(int)((box.y1+teamBox.y2-my)/0.025f);
 		if(team&gt;=gu-&gt;myTeam)
 			team++;
-		if(team&lt;gs-&gt;activeTeams &amp;&amp; !gs-&gt;Team(team)-&gt;isDead){
+		if(team&lt;teamHandler-&gt;ActiveTeams() &amp;&amp; !teamHandler-&gt;Team(team)-&gt;isDead){
 			// we don't want to give everything to the enemy if there are allies left
-			if(noAlliesLeft || (!noAlliesLeft &amp;&amp; gs-&gt;Ally(gu-&gt;myAllyTeam, gs-&gt;AllyTeam(team)))){
+			if(noAlliesLeft || (!noAlliesLeft &amp;&amp; teamHandler-&gt;Ally(gu-&gt;myAllyTeam, teamHandler-&gt;AllyTeam(team)))){
 				shareTeam=team;
 			}
 		}

Modified: trunk/rts/Game/UI/ResourceBar.cpp
===================================================================
--- trunk/rts/Game/UI/ResourceBar.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Game/UI/ResourceBar.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -4,7 +4,7 @@
 #include &quot;ResourceBar.h&quot;
 #include &quot;MouseHandler.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Misc/GlobalSynced.h&quot;
 #include &quot;Rendering/glFont.h&quot;
 #include &quot;NetProtocol.h&quot;
@@ -61,7 +61,7 @@
 		return;
 	}
 
-	const CTeam* myTeam = gs-&gt;Team(gu-&gt;myTeam);
+	const CTeam* myTeam = teamHandler-&gt;Team(gu-&gt;myTeam);
 
 	GLfloat x1,y1,x2,y2,x;
 
@@ -246,12 +246,12 @@
 			if(InBox(mx,my,box+metalBox)){
 				moveBox = false;
 				float metalShare = std::max(0.f, std::min(1.f,(mx-(box.x1+metalBox.x1))/(metalBox.x2-metalBox.x1)));
-				net-&gt;Send(CBaseNetProtocol::Get().SendSetShare(gu-&gt;myPlayerNum, gu-&gt;myTeam, metalShare, gs-&gt;Team(gu-&gt;myTeam)-&gt;energyShare));
+				net-&gt;Send(CBaseNetProtocol::Get().SendSetShare(gu-&gt;myPlayerNum, gu-&gt;myTeam, metalShare, teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;energyShare));
 			}
 			if(InBox(mx,my,box+energyBox)){
 				moveBox = false;
 				float energyShare = std::max(0.f, std::min(1.f,(mx-(box.x1+energyBox.x1))/(energyBox.x2-energyBox.x1)));
-				net-&gt;Send(CBaseNetProtocol::Get().SendSetShare(gu-&gt;myPlayerNum, gu-&gt;myTeam, gs-&gt;Team(gu-&gt;myTeam)-&gt;metalShare, energyShare));
+				net-&gt;Send(CBaseNetProtocol::Get().SendSetShare(gu-&gt;myPlayerNum, gu-&gt;myTeam, teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;metalShare, energyShare));
 			}
 		}
 		return true;

Modified: trunk/rts/Game/UI/SelectionKeyHandler.cpp
===================================================================
--- trunk/rts/Game/UI/SelectionKeyHandler.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Game/UI/SelectionKeyHandler.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -8,7 +8,7 @@
 #include &quot;Game/Camera.h&quot;
 #include &quot;Game/CameraHandler.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;MouseHandler.h&quot;
@@ -151,7 +151,7 @@
 	if(s==&quot;AllMap&quot;){
 		if (!gu-&gt;spectatingFullSelect) {
 			// team units
-			CUnitSet* tu=&amp;gs-&gt;Team(gu-&gt;myTeam)-&gt;units;
+			CUnitSet* tu=&amp;teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;units;
 			for(CUnitSet::iterator ui=tu-&gt;begin();ui!=tu-&gt;end();++ui){
 				selection.push_back(*ui);
 			}
@@ -165,7 +165,7 @@
 	} else if(s==&quot;Visible&quot;){
 		if (!gu-&gt;spectatingFullSelect) {
 			// team units in viewport
-			CUnitSet* tu=&amp;gs-&gt;Team(gu-&gt;myTeam)-&gt;units;
+			CUnitSet* tu=&amp;teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;units;
 			for (CUnitSet::iterator ui=tu-&gt;begin();ui!=tu-&gt;end();++ui){
 				if (camera-&gt;InView((*ui)-&gt;midPos,(*ui)-&gt;radius)){
 					selection.push_back(*ui);
@@ -189,7 +189,7 @@
 
 		if (!gu-&gt;spectatingFullSelect) {
 		  // team units in mouse range
-			CUnitSet* tu=&amp;gs-&gt;Team(gu-&gt;myTeam)-&gt;units;
+			CUnitSet* tu=&amp;teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;units;
 			for(CUnitSet::iterator ui=tu-&gt;begin();ui!=tu-&gt;end();++ui){
 				if(mp.SqDistance((*ui)-&gt;pos)&lt;Square(maxDist)){
 					selection.push_back(*ui);

Modified: trunk/rts/Game/UI/ShareBox.cpp
===================================================================
--- trunk/rts/Game/UI/ShareBox.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Game/UI/ShareBox.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -5,8 +5,8 @@
 #include &quot;ShareBox.h&quot;
 #include &quot;MouseHandler.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
-#include &quot;Game/Player.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
+#include &quot;Game/PlayerHandler.h&quot;
 #include &quot;Sim/Misc/GlobalSynced.h&quot;
 #include &quot;Rendering/glFont.h&quot;
 #include &quot;NetProtocol.h&quot;
@@ -65,11 +65,11 @@
 	// find a default team to share to that is not gu-&gt;myTeam and is not dead.
 	shareTeam = lastShareTeam;
 
-	while (shareTeam == gu-&gt;myTeam || gs-&gt;Team(shareTeam)-&gt;isDead) {
+	while (shareTeam == gu-&gt;myTeam || teamHandler-&gt;Team(shareTeam)-&gt;isDead) {
 		++shareTeam;
 
 		// wrap around
-		if (shareTeam &gt;= gs-&gt;activeTeams)
+		if (shareTeam &gt;= teamHandler-&gt;ActiveTeams())
 			shareTeam = 0;
 
 		// we're back at the start, so there are no teams alive...
@@ -170,17 +170,17 @@
 	font-&gt;glPrintAt(box.x1+0.01f,box.y1+0.16f,0.7f,&quot;Share Energy&quot;);
 
 	glColor4f(1,1,1,0.8f);
-	font-&gt;glFormatAt(box.x1+0.25f,box.y1+0.12f,0.7f,&quot;%.0f&quot;,float(gs-&gt;Team(gu-&gt;myTeam)-&gt;energy));
-	font-&gt;glFormatAt(box.x1+0.14f,box.y1+0.12f,0.7f,&quot;%.0f&quot;,gs-&gt;Team(gu-&gt;myTeam)-&gt;energy*energyShare);
+	font-&gt;glFormatAt(box.x1+0.25f,box.y1+0.12f,0.7f,&quot;%.0f&quot;,float(teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;energy));
+	font-&gt;glFormatAt(box.x1+0.14f,box.y1+0.12f,0.7f,&quot;%.0f&quot;,teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;energy*energyShare);
 
 	glColor4f(0.8f,0.8f,0.9f,0.8f);
 	font-&gt;glPrintAt(box.x1+0.01f,box.y1+0.22f,0.7f,&quot;Share Metal&quot;);
 
 	glColor4f(1,1,1,0.8f);
-	font-&gt;glFormatAt(box.x1+0.25f,box.y1+0.18f,0.7f,&quot;%.0f&quot;,float(gs-&gt;Team(gu-&gt;myTeam)-&gt;metal));
-	font-&gt;glFormatAt(box.x1+0.14f,box.y1+0.18f,0.7f,&quot;%.0f&quot;,gs-&gt;Team(gu-&gt;myTeam)-&gt;metal*metalShare);
+	font-&gt;glFormatAt(box.x1+0.25f,box.y1+0.18f,0.7f,&quot;%.0f&quot;,float(teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;metal));
+	font-&gt;glFormatAt(box.x1+0.14f,box.y1+0.18f,0.7f,&quot;%.0f&quot;,teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;metal*metalShare);
 
-	for(int team=0;team&lt;gs-&gt;activeTeams-1;++team){
+	for(int team=0;team&lt;teamHandler-&gt;ActiveTeams()-1;++team){
 		int actualTeam=team;
 		if (team &gt;= gu-&gt;myTeam) {
 			actualTeam++;
@@ -189,25 +189,25 @@
 		const float alpha = (shareTeam == actualTeam) ? 0.8f : 0.4f;
 		std::string teamName;
 
-		if (gs-&gt;Team(actualTeam)-&gt;leader &gt;= 0) {
-			teamName = gs-&gt;players[gs-&gt;Team(actualTeam)-&gt;leader]-&gt;name;
+		if (teamHandler-&gt;Team(actualTeam)-&gt;leader &gt;= 0) {
+			teamName = playerHandler-&gt;Player(teamHandler-&gt;Team(actualTeam)-&gt;leader)-&gt;name;
 		} else {
 			teamName = &quot;Uncontrolled&quot;;
 		}
 
 		std::string ally, dead;
-		if (gs-&gt;Ally(gu-&gt;myAllyTeam, gs-&gt;AllyTeam(actualTeam))) {
+		if (teamHandler-&gt;Ally(gu-&gt;myAllyTeam, teamHandler-&gt;AllyTeam(actualTeam))) {
 			glColor4f(0.5f, 1.0f, 0.5f, alpha);
 			ally = &quot; &lt;Ally&gt;&quot;;
 		} else {
 			glColor4f(1.0f, 0.5f, 0.5f, alpha);
 			ally = &quot; &lt;Enemy&gt;&quot;;
 		}
-		if (gs-&gt;Team(actualTeam)-&gt;isDead) {
+		if (teamHandler-&gt;Team(actualTeam)-&gt;isDead) {
 			glColor4f(0.5f, 0.5f, 1.0f, alpha);
 			dead = &quot; &lt;Dead&gt;&quot;;
 		}
-		if (actualTeam == gs-&gt;gaiaTeamID) {
+		if (actualTeam == teamHandler-&gt;GaiaTeamID()) {
 			glColor4f(0.8f, 0.8f, 0.8f, alpha);
 			teamName = &quot;Gaia&quot;;
 			ally   = &quot; &lt;Gaia&gt;&quot;;
@@ -273,7 +273,7 @@
 			int team=(int)((box.y1+teamBox.y2-my)/0.025f);
 			if(team&gt;=gu-&gt;myTeam)
 				team++;
-			if(team&lt;gs-&gt;activeTeams &amp;&amp; !gs-&gt;Team(team)-&gt;isDead)
+			if(team&lt;teamHandler-&gt;ActiveTeams() &amp;&amp; !teamHandler-&gt;Team(team)-&gt;isDead)
 				shareTeam=team;
 		}
 		return true;
@@ -290,14 +290,14 @@
 		shareUnits = !shareUnits;
 	}
 	if ((InBox(mx, my, box + okBox) || InBox(mx, my, box + applyBox)) &amp;&amp;
-			 shareTeam != -1 &amp;&amp; !gs-&gt;Team(shareTeam)-&gt;isDead &amp;&amp; !gs-&gt;Team(gu-&gt;myTeam)-&gt;isDead) {
+			 shareTeam != -1 &amp;&amp; !teamHandler-&gt;Team(shareTeam)-&gt;isDead &amp;&amp; !teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;isDead) {
 		if (shareUnits) {
 			Command c;
 			c.id = CMD_STOP;
 			// make sure the units are stopped and that the selection is transmitted
 			selectedUnits.GiveCommand(c, false);
 		}
-		net-&gt;Send(CBaseNetProtocol::Get().SendShare(gu-&gt;myPlayerNum, shareTeam, shareUnits, metalShare * gs-&gt;Team(gu-&gt;myTeam)-&gt;metal, energyShare * gs-&gt;Team(gu-&gt;myTeam)-&gt;energy));
+		net-&gt;Send(CBaseNetProtocol::Get().SendShare(gu-&gt;myPlayerNum, shareTeam, shareUnits, metalShare * teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;metal, energyShare * teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;energy));
 		if (shareUnits)
 			selectedUnits.ClearSelected();
 		lastShareTeam = shareTeam;
@@ -331,7 +331,7 @@
 		int team=(int)((box.y1+teamBox.y2-my)/0.025f);
 		if(team&gt;=gu-&gt;myTeam)
 			team++;
-		if(team&lt;gs-&gt;activeTeams &amp;&amp; !gs-&gt;Team(team)-&gt;isDead)
+		if(team&lt;teamHandler-&gt;ActiveTeams() &amp;&amp; !teamHandler-&gt;Team(team)-&gt;isDead)
 			shareTeam=team;
 	}
 }

Modified: trunk/rts/Game/UI/TooltipConsole.cpp
===================================================================
--- trunk/rts/Game/UI/TooltipConsole.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Game/UI/TooltipConsole.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -5,8 +5,8 @@
 #include &quot;MouseHandler.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Rendering/glFont.h&quot;
-#include &quot;Game/Player.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
+#include &quot;Game/PlayerHandler.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Map/MapDamage.h&quot;
 #include &quot;Map/MapInfo.h&quot;
@@ -190,7 +190,7 @@
 
 	std::string s;
 
-	const bool enemyUnit = (gs-&gt;AllyTeam(unit-&gt;team) != gu-&gt;myAllyTeam) &amp;&amp;
+	const bool enemyUnit = (teamHandler-&gt;AllyTeam(unit-&gt;team) != gu-&gt;myAllyTeam) &amp;&amp;
 	                       !gu-&gt;spectatingFullView;
 
 	const UnitDef* unitDef = unit-&gt;unitDef;
@@ -209,8 +209,8 @@
 
 	// show the player name instead of unit name if it has FBI tag showPlayerName
 	if (effectiveDef-&gt;showPlayerName) {
-		if (gs-&gt;Team(unit-&gt;team)-&gt;leader &gt;= 0) {
-			s = gs-&gt;players[gs-&gt;Team(unit-&gt;team)-&gt;leader]-&gt;name.c_str();
+		if (teamHandler-&gt;Team(unit-&gt;team)-&gt;leader &gt;= 0) {
+			s = playerHandler-&gt;Player(teamHandler-&gt;Team(unit-&gt;team)-&gt;leader)-&gt;name.c_str();
 		} else {
 			s = &quot;Uncontrolled&quot;;
 		}

Modified: trunk/rts/Game/WaitCommandsAI.cpp
===================================================================
--- trunk/rts/Game/WaitCommandsAI.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Game/WaitCommandsAI.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -8,7 +8,7 @@
 #include &lt;SDL_timer.h&gt;
 #include &quot;WaitCommandsAI.h&quot;
 #include &quot;SelectedUnits.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;GameHelper.h&quot;
 #include &quot;Sim/Misc/QuadField.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
@@ -897,7 +897,7 @@
 	const int count = (int)tmpUnits.size();
 	for (int i = 0; i &lt; count; i++) {
 		CUnit* unit = tmpUnits[i];
-		if (enemies &amp;&amp; gs-&gt;Ally(unit-&gt;allyteam, gu-&gt;myAllyTeam)) {
+		if (enemies &amp;&amp; teamHandler-&gt;Ally(unit-&gt;allyteam, gu-&gt;myAllyTeam)) {
 			continue;
 		}
 		if (!(unit-&gt;losStatus[gu-&gt;myAllyTeam] &amp; (LOS_INLOS | LOS_INRADAR))) {

Modified: trunk/rts/Lua/LuaGaia.cpp
===================================================================
--- trunk/rts/Lua/LuaGaia.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Lua/LuaGaia.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -19,12 +19,13 @@
 #include &quot;LuaWeaponDefs.h&quot;
 #include &quot;LuaOpenGL.h&quot;
 
-#include &quot;Sim/Misc/GlobalSynced.h&quot;
-#include &quot;Sim/Units/CommandAI/Command.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Rendering/UnitModels/UnitDrawer.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
+#include &quot;Sim/Units/CommandAI/Command.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;FileSystem/FileHandler.h&quot;
 #include &quot;FileSystem/FileSystem.h&quot;
@@ -88,10 +89,10 @@
 
 	fullCtrl = false;
 	fullRead = false;
-	ctrlTeam = gs-&gt;gaiaTeamID;
-	readTeam = gs-&gt;gaiaTeamID;
-	readAllyTeam = gs-&gt;gaiaAllyTeamID;
-	selectTeam = gs-&gt;gaiaTeamID;
+	ctrlTeam = teamHandler-&gt;GaiaTeamID();
+	readTeam = teamHandler-&gt;GaiaTeamID();
+	readAllyTeam = teamHandler-&gt;GaiaAllyTeamID();
+	selectTeam = teamHandler-&gt;GaiaTeamID();
 
 	Init(LuaGaiaSyncedFilename, LuaGaiaUnsyncedFilename, SPRING_VFS_MAP);
 }

Modified: trunk/rts/Lua/LuaHandle.cpp
===================================================================
--- trunk/rts/Lua/LuaHandle.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Lua/LuaHandle.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -21,15 +21,16 @@
 #include &quot;LuaOpenGL.h&quot;
 #include &quot;LuaBitOps.h&quot;
 #include &quot;LuaUtils.h&quot;
-#include &quot;Game/Player.h&quot;
+#include &quot;Game/PlayerHandler.h&quot;
 #include &quot;Game/UI/KeyCodes.h&quot;
 #include &quot;Game/UI/KeySet.h&quot;
 #include &quot;Game/UI/KeyBindings.h&quot;
 #include &quot;Game/UI/MiniMap.h&quot;
-#include &quot;Sim/Misc/GlobalSynced.h&quot;
 #include &quot;Rendering/InMapDraw.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Rendering/UnitModels/UnitDrawer.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Projectiles/Projectile.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
@@ -1078,7 +1079,7 @@
 				sendMsg = gu-&gt;spectating;
 			}
 			else if (mode == 'a') {
-				const CPlayer* player = gs-&gt;players[playerID];
+				const CPlayer* player = playerHandler-&gt;Player(playerID);
 				if (player == NULL) {
 					return;
 				}
@@ -1088,8 +1089,8 @@
 				else if (player-&gt;spectator) {
 					sendMsg = gu-&gt;spectating;
 				} else {
-					const int msgAllyTeam = gs-&gt;AllyTeam(player-&gt;team);
-					sendMsg = gs-&gt;Ally(msgAllyTeam, gu-&gt;myAllyTeam);
+					const int msgAllyTeam = teamHandler-&gt;AllyTeam(player-&gt;team);
+					sendMsg = teamHandler-&gt;Ally(msgAllyTeam, gu-&gt;myAllyTeam);
 				}
 			}
 			if (sendMsg) {

Modified: trunk/rts/Lua/LuaHandleSynced.cpp
===================================================================
--- trunk/rts/Lua/LuaHandleSynced.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Lua/LuaHandleSynced.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -32,12 +32,13 @@
 #include &quot;LuaOpenGL.h&quot;
 #include &quot;LuaVFS.h&quot;
 
-#include &quot;Sim/Units/CommandAI/Command.h&quot;
 #include &quot;Game/Game.h&quot;
 #include &quot;Game/WordCompletion.h&quot;
 #include &quot;Sim/Misc/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
+#include &quot;Sim/Units/CommandAI/Command.h&quot;
 #include &quot;Sim/Units/COB/CobInstance.h&quot;
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
 #include &quot;EventHandler.h&quot;
@@ -1014,7 +1015,7 @@
 	// parse the new access
 	if (lua_isnumber(L, 1)) {
 		const int teamID = lua_toint(L, 1);
-		if ((teamID &lt; MinSpecialTeam) || (teamID &gt;= gs-&gt;activeTeams)) {
+		if ((teamID &lt; MinSpecialTeam) || (teamID &gt;= teamHandler-&gt;ActiveTeams())) {
 			luaL_error(L, &quot;Bad teamID in SetCtrlTeam&quot;);
 		}
 		// ctrl
@@ -1022,7 +1023,7 @@
 		lhs-&gt;fullCtrl = (lhs-&gt;ctrlTeam == CEventClient::AllAccessTeam);
 		// read
 		lhs-&gt;readTeam = teamID;
-		lhs-&gt;readAllyTeam = (teamID &lt; 0) ? teamID : gs-&gt;AllyTeam(teamID);
+		lhs-&gt;readAllyTeam = (teamID &lt; 0) ? teamID : teamHandler-&gt;AllyTeam(teamID);
 		lhs-&gt;fullRead = (lhs-&gt;readAllyTeam == CEventClient::AllAccessTeam);
 		activeFullRead     = lhs-&gt;fullRead;
 		activeReadAllyTeam = lhs-&gt;readAllyTeam;
@@ -1037,7 +1038,7 @@
 			}
 			const string key = lua_tostring(L, -2);
 			const int teamID = lua_toint(L, -1);
-			if ((teamID &lt; MinSpecialTeam) || (teamID &gt;= gs-&gt;activeTeams)) {
+			if ((teamID &lt; MinSpecialTeam) || (teamID &gt;= teamHandler-&gt;ActiveTeams())) {
 				luaL_error(L, &quot;Bad teamID in SetCtrlTeam&quot;);
 			}
 
@@ -1047,7 +1048,7 @@
 			}
 			else if (key == &quot;read&quot;) {
 				lhs-&gt;readTeam = teamID;
-				lhs-&gt;readAllyTeam = (teamID &lt; 0) ? teamID : gs-&gt;AllyTeam(teamID);
+				lhs-&gt;readAllyTeam = (teamID &lt; 0) ? teamID : teamHandler-&gt;AllyTeam(teamID);
 				lhs-&gt;fullRead = (lhs-&gt;readAllyTeam == CEventClient::AllAccessTeam);
 				activeFullRead     = lhs-&gt;fullRead;
 				activeReadAllyTeam = lhs-&gt;readAllyTeam;

Modified: trunk/rts/Lua/LuaIO.cpp
===================================================================
--- trunk/rts/Lua/LuaIO.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Lua/LuaIO.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -87,9 +87,6 @@
 
 FILE* LuaIO::fopen(lua_State* L, const char* path, const char* mode)
 {
-	bool read  = false;
-	bool write = false;
-
 	// check the mode string
 	const string modeStr = StringToLower(mode);
 	if (modeStr.find_first_not_of(&quot;rwabt+&quot;) != string::npos) {
@@ -112,14 +109,14 @@
 		errno = EINVAL;
 		return NULL;
 	}
-	errno = EINVAL;	
+	errno = EINVAL;
 	return NULL;
 }
 
 
 int LuaIO::pclose(lua_State* L, FILE* stream)
 {
-	errno = ECHILD;	
+	errno = ECHILD;
 	return -1;
 }
 

Modified: trunk/rts/Lua/LuaOpenGL.cpp
===================================================================
--- trunk/rts/Lua/LuaOpenGL.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Lua/LuaOpenGL.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -53,6 +53,7 @@
 #include &quot;Sim/Features/Feature.h&quot;
 #include &quot;Sim/Features/FeatureHandler.h&quot;
 #include &quot;Sim/Misc/LosHandler.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;Sim/Units/UnitDefHandler.h&quot;
@@ -1407,7 +1408,7 @@
 	const int fullSize = (order * dataSize);
 	float* points = SAFE_NEW float[fullSize];
 	if (ParseFloatArray(L, points, fullSize) == fullSize) {
-		glMap1f(target, u1, u2, stride, order, points);	
+		glMap1f(target, u1, u2, stride, order, points);
 	}
 	delete[] points;
 	return 0;
@@ -1441,9 +1442,9 @@
 	}
 	const int fullSize = (uorder * vorder * dataSize);
 	float* points = SAFE_NEW float[fullSize];
-	if (ParseFloatArray(L, points, fullSize) == fullSize) {			
+	if (ParseFloatArray(L, points, fullSize) == fullSize) {
 		glMap2f(target, u1, u2, ustride, uorder,
-										v1, v2, vstride, vorder, points);	
+										v1, v2, vstride, vorder, points);
 	}
 	delete[] points;
 	return 0;
@@ -1565,7 +1566,7 @@
 			return NULL;
 		}
 	} else {
-		if (!gs-&gt;Ally(readAllyTeam, unit-&gt;allyteam) &amp;&amp;
+		if (!teamHandler-&gt;Ally(readAllyTeam, unit-&gt;allyteam) &amp;&amp;
 		    !(unit-&gt;losStatus[readAllyTeam] &amp; LOS_INLOS)) {
 			return NULL;
 		}
@@ -5080,7 +5081,7 @@
 	if ((xsize &lt;= 0) || (ysize &lt;= 0)) {
 		return 0;
 	}
-	const int memsize = xsize * ysize * 4;	
+	const int memsize = xsize * ysize * 4;
 
 	unsigned char* img = SAFE_NEW unsigned char[memsize];
 	memset(img, 0, memsize);

Modified: trunk/rts/Lua/LuaRules.cpp
===================================================================
--- trunk/rts/Lua/LuaRules.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Lua/LuaRules.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -24,8 +24,6 @@
 
 #include &quot;Sim/Units/CommandAI/Command.h&quot;
 #include &quot;Game/Game.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
-#include &quot;Sim/Misc/GlobalSynced.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Rendering/UnitModels/UnitDrawer.h&quot;
 #include &quot;Rendering/UnitModels/3DModelParser.h&quot;
@@ -33,6 +31,8 @@
 #include &quot;Rendering/UnitModels/s3oParser.h&quot;
 #include &quot;Sim/Features/Feature.h&quot;
 #include &quot;Sim/Features/FeatureDef.h&quot;
+#include &quot;Sim/Misc/GlobalSynced.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
@@ -138,7 +138,7 @@
 {
 	if (L != NULL) {
 		Shutdown();
-		KillLua();		
+		KillLua();
 	}
 	luaRules = NULL;
 
@@ -849,8 +849,8 @@
 	lua_pop(L, 1);
 	return retval;
 }
-	
 
+
 const char* CLuaRules::AICallIn(const char* data, int inSize, int* outSize)
 {
 	if (!haveAICallIn) {
@@ -889,8 +889,8 @@
 	}
 
 	lua_pop(L, 1);
-	
-	return outData;	
+
+	return outData;
 }
 
 
@@ -1166,7 +1166,7 @@
 	if ((teamID &lt; 0) || (teamID &gt;= MAX_TEAMS)) {
 		luaL_error(L, &quot;%s(): Bad teamID: %i\n&quot;, teamID);
 	}
-	CTeam* team = gs-&gt;Team(teamID);
+	CTeam* team = teamHandler-&gt;Team(teamID);
 	if (team == NULL) {
 		return NULL;
 	}

Modified: trunk/rts/Lua/LuaSyncedCtrl.cpp
===================================================================
--- trunk/rts/Lua/LuaSyncedCtrl.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Lua/LuaSyncedCtrl.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -19,11 +19,11 @@
 #include &quot;LuaSyncedMoveCtrl.h&quot;
 #include &quot;LuaUtils.h&quot;
 #include &quot;ExternalAI/GlobalAIHandler.h&quot;
-#include &quot;Sim/Units/CommandAI/Command.h&quot;
 #include &quot;Game/Game.h&quot;
 #include &quot;Game/GameServer.h&quot;
 #include &quot;Game/Camera.h&quot;
 #include &quot;Game/GameHelper.h&quot;
+#include &quot;Game/PlayerHandler.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
 #include &quot;Sim/Misc/Team.h&quot;
 #include &quot;Map/Ground.h&quot;
@@ -37,6 +37,7 @@
 #include &quot;Sim/Misc/CollisionVolume.h&quot;
 #include &quot;Sim/Misc/DamageArray.h&quot;
 #include &quot;Sim/Misc/LosHandler.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Misc/QuadField.h&quot;
 #include &quot;Sim/MoveTypes/AirMoveType.h&quot;
 #include &quot;Sim/MoveTypes/TAAirMoveType.h&quot;
@@ -52,6 +53,7 @@
 #include &quot;Sim/Units/UnitTypes/Builder.h&quot;
 #include &quot;Sim/Units/UnitTypes/Factory.h&quot;
 #include &quot;Sim/Units/UnitTypes/TransportUnit.h&quot;
+#include &quot;Sim/Units/CommandAI/Command.h&quot;
 #include &quot;Sim/Units/CommandAI/CommandAI.h&quot;
 #include &quot;Sim/Units/CommandAI/FactoryCAI.h&quot;
 #include &quot;Sim/Units/CommandAI/LineDrawer.h&quot;
@@ -239,7 +241,7 @@
 	if (ctrlTeam &lt; 0) {
 		return ctrlTeam;
 	}
-	return gs-&gt;AllyTeam(ctrlTeam);
+	return teamHandler-&gt;AllyTeam(ctrlTeam);
 }
 
 
@@ -259,7 +261,7 @@
 	if (ctrlTeam &lt; 0) {
 		return (ctrlTeam == CEventClient::AllAccessTeam) ? true : false;
 	}
-	return (gs-&gt;AllyTeam(ctrlTeam) == allyTeamID);
+	return (teamHandler-&gt;AllyTeam(ctrlTeam) == allyTeamID);
 }
 
 
@@ -280,9 +282,9 @@
 		return (ctrlTeam == CEventClient::AllAccessTeam) ? true : false;
 	}
 	if (allyTeamID &lt; 0) {
-		return (ctrlTeam == gs-&gt;gaiaTeamID);
+		return (ctrlTeam == teamHandler-&gt;GaiaTeamID());
 	}
-	return (gs-&gt;AllyTeam(ctrlTeam) == allyTeamID);
+	return (teamHandler-&gt;AllyTeam(ctrlTeam) == allyTeamID);
 }
 
 
@@ -301,7 +303,7 @@
 	if (allyTeamID &lt; 0) {
 		return false;
 	}
-	return (gs-&gt;AllyTeam(ctrlTeam) == allyTeamID);
+	return (teamHandler-&gt;AllyTeam(ctrlTeam) == allyTeamID);
 }
 
 
@@ -385,10 +387,10 @@
 		return NULL;
 	}
 	const int teamID = lua_toint(L, index);
-	if ((teamID &lt; 0) || (teamID &gt;= gs-&gt;activeTeams)) {
+	if ((teamID &lt; 0) || (teamID &gt;= teamHandler-&gt;ActiveTeams())) {
 		luaL_error(L, &quot;%s(): Bad teamID: %d&quot;, caller, teamID);
 	}
-	CTeam* team = gs-&gt;Team(teamID);
+	CTeam* team = teamHandler-&gt;Team(teamID);
 	if (team == NULL) {
 		return NULL;
 	}
@@ -418,7 +420,7 @@
 	if ((playerID &lt; 0) || (playerID &gt;= MAX_PLAYERS)) {
 		luaL_error(L, &quot;Bad playerID: %d\n&quot;, playerID);
 	}
-	CPlayer* player = gs-&gt;players[playerID];
+	CPlayer* player = playerHandler-&gt;Player(playerID);
 	if (player == NULL) {
 		luaL_error(L, &quot;Bad playerID: %d\n&quot;, playerID);
 	}
@@ -479,13 +481,13 @@
 int LuaSyncedCtrl::AddTeamResource(lua_State* L)
 {
 	const int teamID = luaL_checkint(L, 1);
-	if ((teamID &lt; 0) || (teamID &gt;= gs-&gt;activeTeams)) {
+	if ((teamID &lt; 0) || (teamID &gt;= teamHandler-&gt;ActiveTeams())) {
 		return 0;
 	}
 	if (!CanControlTeam(teamID)) {
 		return 0;
 	}
-	CTeam* team = gs-&gt;Team(teamID);
+	CTeam* team = teamHandler-&gt;Team(teamID);
 	if (team == NULL) {
 		return 0;
 	}
@@ -507,13 +509,13 @@
 int LuaSyncedCtrl::UseTeamResource(lua_State* L)
 {
 	const int teamID = luaL_checkint(L, 1);
-	if ((teamID &lt; 0) || (teamID &gt;= gs-&gt;activeTeams)) {
+	if ((teamID &lt; 0) || (teamID &gt;= teamHandler-&gt;ActiveTeams())) {
 		return 0;
 	}
 	if (!CanControlTeam(teamID)) {
 		return 0;
 	}
-	CTeam* team = gs-&gt;Team(teamID);
+	CTeam* team = teamHandler-&gt;Team(teamID);
 	if (team == NULL) {
 		return 0;
 	}
@@ -570,13 +572,13 @@
 int LuaSyncedCtrl::SetTeamResource(lua_State* L)
 {
 	const int teamID = luaL_checkint(L, 1);
-	if ((teamID &lt; 0) || (teamID &gt;= gs-&gt;activeTeams)) {
+	if ((teamID &lt; 0) || (teamID &gt;= teamHandler-&gt;ActiveTeams())) {
 		return 0;
 	}
 	if (!CanControlTeam(teamID)) {
 		return 0;
 	}
-	CTeam* team = gs-&gt;Team(teamID);
+	CTeam* team = teamHandler-&gt;Team(teamID);
 	if (team == NULL) {
 		return 0;
 	}
@@ -606,13 +608,13 @@
 int LuaSyncedCtrl::SetTeamShareLevel(lua_State* L)
 {
 	const int teamID = luaL_checkint(L, 1);
-	if ((teamID &lt; 0) || (teamID &gt;= gs-&gt;activeTeams)) {
+	if ((teamID &lt; 0) || (teamID &gt;= teamHandler-&gt;ActiveTeams())) {
 		return 0;
 	}
 	if (!CanControlTeam(teamID)) {
 		return 0;
 	}
-	CTeam* team = gs-&gt;Team(teamID);
+	CTeam* team = teamHandler-&gt;Team(teamID);
 	if (team == NULL) {
 		return 0;
 	}
@@ -892,7 +894,7 @@
 		luaL_error(L, &quot;CreateUnit(): bad team number: %d&quot;, teamID);
 	}
 
-	if (gs-&gt;AllyTeam(teamID) &gt;= gs-&gt;activeAllyTeams) {
+	if (teamHandler-&gt;AllyTeam(teamID) &gt;= teamHandler-&gt;ActiveAllyTeams()) {
 		// FIXME: there's a segv in CLosHandler::LosAddAir,
 		//        this is a dirty hack to avoid it
 		luaL_error(L, &quot;CreateUnit(): inactive team: %d&quot;, teamID);
@@ -974,10 +976,10 @@
 	}
 
 	const int newTeam = luaL_checkint(L, 2);
-	if ((newTeam &lt; 0) || (newTeam &gt;= gs-&gt;activeTeams)) {
+	if ((newTeam &lt; 0) || (newTeam &gt;= teamHandler-&gt;ActiveTeams())) {
 		return 0;
 	}
-	const CTeam* team = gs-&gt;Team(newTeam);
+	const CTeam* team = teamHandler-&gt;Team(newTeam);
 	if (team == NULL) {
 		return 0;
 	}
@@ -2008,7 +2010,7 @@
 				}
 			}
 		}
-		CTeam* team = gs-&gt;Team(unit-&gt;team);
+		CTeam* team = teamHandler-&gt;Team(unit-&gt;team);
 		if ((team-&gt;metal &gt;= metal) &amp;&amp; (team-&gt;energy &gt;= energy)) {
 			unit-&gt;UseMetal(metal);
 			unit-&gt;UseEnergy(energy);
@@ -2083,7 +2085,7 @@
 		}
 	}
 
-	const int allyTeam = (team &lt; 0) ? -1 : gs-&gt;AllyTeam(team);
+	const int allyTeam = (team &lt; 0) ? -1 : teamHandler-&gt;AllyTeam(team);
 	if (!CanControlFeatureAllyTeam(allyTeam)) {
 		luaL_error(L, &quot;CreateFeature() bad team permission %d&quot;, team);
 	}

Modified: trunk/rts/Lua/LuaSyncedRead.cpp
===================================================================
--- trunk/rts/Lua/LuaSyncedRead.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Lua/LuaSyncedRead.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -20,13 +20,11 @@
 #include &quot;LuaRules.h&quot;
 #include &quot;LuaUtils.h&quot;
 #include &quot;ExternalAI/GlobalAIHandler.h&quot;
-#include &quot;Sim/Units/CommandAI/Command.h&quot;
 #include &quot;Game/Game.h&quot;
 #include &quot;Game/GameSetup.h&quot;
 #include &quot;Game/Camera.h&quot;
 #include &quot;Game/GameHelper.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
-#include &quot;Game/Player.h&quot;
+#include &quot;Game/PlayerHandler.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Map/MapDamage.h&quot;
 #include &quot;Map/MapInfo.h&quot;
@@ -41,6 +39,7 @@
 #include &quot;Sim/Misc/GroundBlockingObjectMap.h&quot;
 #include &quot;Sim/Misc/LosHandler.h&quot;
 #include &quot;Sim/Misc/QuadField.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Misc/Wind.h&quot;
 #include &quot;Sim/MoveTypes/AirMoveType.h&quot;
 #include &quot;Sim/MoveTypes/GroundMoveType.h&quot;
@@ -57,6 +56,7 @@
 #include &quot;Sim/Units/UnitTypes/Builder.h&quot;
 #include &quot;Sim/Units/UnitTypes/Factory.h&quot;
 #include &quot;Sim/Units/UnitTypes/TransportUnit.h&quot;
+#include &quot;Sim/Units/CommandAI/Command.h&quot;
 #include &quot;Sim/Units/CommandAI/CommandAI.h&quot;
 #include &quot;Sim/Units/CommandAI/FactoryCAI.h&quot;
 #include &quot;Sim/Units/CommandAI/LineDrawer.h&quot;
@@ -304,7 +304,7 @@
 	if (readAllyTeam &lt; 0) {
 		return fullRead;
 	}
-	return (gs-&gt;AllyTeam(team) == readAllyTeam);
+	return (teamHandler-&gt;AllyTeam(team) == readAllyTeam);
 }
 
 
@@ -463,7 +463,7 @@
 	if ((playerID &lt; 0) || (playerID &gt;= MAX_PLAYERS)) {
 		luaL_error(L, &quot;Bad playerID in %s\n&quot;, caller);
 	}
-	CPlayer* player = gs-&gt;players[playerID];
+	CPlayer* player = playerHandler-&gt;Player(playerID);
 	if (player == NULL) {
 		luaL_error(L, &quot;Bad player in %s\n&quot;, caller);
 	}
@@ -480,7 +480,7 @@
 	if ((teamID &lt; 0) || (teamID &gt;= MAX_TEAMS)) {
 		luaL_error(L, &quot;Bad teamID in %s\n&quot;, caller);
 	}
-	return gs-&gt;Team(teamID);
+	return teamHandler-&gt;Team(teamID);
 }
 
 
@@ -493,7 +493,7 @@
 	if ((teamID &lt; 0) || (teamID &gt;= MAX_TEAMS)) {
 		luaL_error(L, &quot;Bad teamID in %s\n&quot;, caller);
 	}
-	CTeam* team = gs-&gt;Team(teamID);
+	CTeam* team = teamHandler-&gt;Team(teamID);
 	if (team == NULL) {
 		luaL_error(L, &quot;Bad teamID in %s\n&quot;, caller);
 	}
@@ -661,7 +661,7 @@
 	if (!gs-&gt;useLuaGaia) {
 		return 0;
 	}
-	lua_pushnumber(L, gs-&gt;gaiaTeamID);
+	lua_pushnumber(L, teamHandler-&gt;GaiaTeamID());
 	return 1;
 }
 
@@ -911,7 +911,7 @@
 	CheckNoArgs(L, __FUNCTION__);
 	lua_newtable(L);
 	int count = 0;
-	for (int at = 0; at &lt; gs-&gt;activeAllyTeams; at++) {
+	for (int at = 0; at &lt; teamHandler-&gt;ActiveAllyTeams(); at++) {
 		count++;
 		lua_pushnumber(L, count);
 		lua_pushnumber(L, at);
@@ -932,18 +932,18 @@
 	int allyTeamID = -1;
 	if (args == 1) {
 		allyTeamID = lua_toint(L, 1);
-		if ((allyTeamID &lt; 0) || (allyTeamID &gt;= gs-&gt;activeAllyTeams)) {
+		if ((allyTeamID &lt; 0) || (allyTeamID &gt;= teamHandler-&gt;ActiveAllyTeams())) {
 			return 0;
 		}
 	}
 
 	lua_newtable(L);
 	int count = 0;
-	for (int t = 0; t &lt; gs-&gt;activeTeams; t++) {
-		if (gs-&gt;Team(t) == NULL) {
+	for (int t = 0; t &lt; teamHandler-&gt;ActiveTeams(); t++) {
+		if (teamHandler-&gt;Team(t) == NULL) {
 			continue;
 		}
-		if ((allyTeamID &lt; 0) || (allyTeamID == gs-&gt;AllyTeam(t))) {
+		if ((allyTeamID &lt; 0) || (allyTeamID == teamHandler-&gt;AllyTeam(t))) {
 			count++;
 			lua_pushnumber(L, count);
 			lua_pushnumber(L, t);
@@ -974,14 +974,14 @@
 		}
 	}
 
-	if (teamID &gt;= gs-&gt;activeTeams) {
+	if (teamID &gt;= teamHandler-&gt;ActiveTeams()) {
 		return 0;
 	}
 
 	lua_newtable(L);
 	int count = 0;
-	for (int p = 0; p &lt; gs-&gt;activePlayers; p++) {
-		const CPlayer* player = gs-&gt;players[p];
+	for (int p = 0; p &lt; playerHandler-&gt;ActivePlayers(); p++) {
+		const CPlayer* player = playerHandler-&gt;Player(p);
 		if (player == NULL) {
 			continue;
 		}
@@ -1006,10 +1006,10 @@
 int LuaSyncedRead::GetTeamInfo(lua_State* L)
 {
 	const int teamID = luaL_checkint(L, 1);
-	if ((teamID &lt; 0) || (teamID &gt;= gs-&gt;activeTeams)) {
+	if ((teamID &lt; 0) || (teamID &gt;= teamHandler-&gt;ActiveTeams())) {
 		return 0;
 	}
-	const CTeam* team = gs-&gt;Team(teamID);
+	const CTeam* team = teamHandler-&gt;Team(teamID);
 	if (team == NULL) {
 		return 0;
 	}
@@ -1025,7 +1025,7 @@
 	lua_pushboolean(L, team-&gt;isDead);
 	lua_pushboolean(L, isAiTeam);
 	lua_pushstring(L,  team-&gt;side.c_str());
-	lua_pushnumber(L,  gs-&gt;AllyTeam(team-&gt;teamNum));
+	lua_pushnumber(L,  teamHandler-&gt;AllyTeam(team-&gt;teamNum));
 
 	return 6;
 }
@@ -1223,7 +1223,7 @@
 		return 0;
 	}
 
-	const CPlayer* player = gs-&gt;players[playerID];
+	const CPlayer* player = playerHandler-&gt;Player(playerID);
 	if (player == NULL) {
 		return 0;
 	}
@@ -1237,7 +1237,7 @@
 	lua_pushboolean(L, player-&gt;active);
 	lua_pushboolean(L, player-&gt;spectator);
 	lua_pushnumber(L, player-&gt;team);
-	lua_pushnumber(L, gs-&gt;AllyTeam(player-&gt;team));
+	lua_pushnumber(L, teamHandler-&gt;AllyTeam(player-&gt;team));
 	const float pingScale = (GAME_SPEED * gs-&gt;speedFactor);
 	const float pingSecs = float(player-&gt;ping - 1) / pingScale;
 	lua_pushnumber(L, pingSecs);
@@ -1259,7 +1259,7 @@
 		return 0;
 	}
 
-	const CPlayer* player = gs-&gt;players[playerID];
+	const CPlayer* player = playerHandler-&gt;Player(playerID);
 	if (player == NULL) {
 		return 0;
 	}
@@ -1270,7 +1270,7 @@
 	}
 
 	if ((readAllyTeam == CEventClient::NoAccessTeam) ||
-	    ((readAllyTeam &gt;= 0) &amp;&amp; !gs-&gt;Ally(unit-&gt;allyteam, readAllyTeam))) {
+	    ((readAllyTeam &gt;= 0) &amp;&amp; !teamHandler-&gt;Ally(unit-&gt;allyteam, readAllyTeam))) {
 		return 0;
 	}
 
@@ -1284,11 +1284,11 @@
 {
 	const int team1 = (int)luaL_checkint(L, -1);
 	const int team2 = (int)luaL_checkint(L, -2);
-	if ((team1 &lt; 0) || (team1 &gt;= gs-&gt;activeTeams) ||
-	    (team2 &lt; 0) || (team2 &gt;= gs-&gt;activeTeams)) {
+	if ((team1 &lt; 0) || (team1 &gt;= teamHandler-&gt;ActiveTeams()) ||
+	    (team2 &lt; 0) || (team2 &gt;= teamHandler-&gt;ActiveTeams())) {
 		return 0;
 	}
-	lua_pushboolean(L, gs-&gt;AlliedTeams(team1, team2));
+	lua_pushboolean(L, teamHandler-&gt;AlliedTeams(team1, team2));
 	return 1;
 }
 
@@ -1301,12 +1301,12 @@
 	    (player2 &lt; 0) || (player2 &gt;= MAX_PLAYERS)) {
 		return 0;
 	}
-	const CPlayer* p1 = gs-&gt;players[player1];
-	const CPlayer* p2 = gs-&gt;players[player2];
+	const CPlayer* p1 = playerHandler-&gt;Player(player1);
+	const CPlayer* p2 = playerHandler-&gt;Player(player2);
 	if ((p1 == NULL) || (p2 == NULL)) {
 		return 0;
 	}
-	lua_pushboolean(L, gs-&gt;AlliedTeams(p1-&gt;team, p2-&gt;team));
+	lua_pushboolean(L, teamHandler-&gt;AlliedTeams(p1-&gt;team, p2-&gt;team));
 	return 1;
 }
 
@@ -1776,7 +1776,7 @@
 	}
 	if (teamID &lt; EnemyUnits) {
 		luaL_error(L, &quot;Bad teamID in %s (%i)&quot;, caller, teamID);
-	} else if (teamID &gt;= gs-&gt;activeTeams) {
+	} else if (teamID &gt;= teamHandler-&gt;ActiveTeams()) {
 		luaL_error(L, &quot;Bad teamID in %s (%i)&quot;, caller, teamID);
 	}
 	return teamID;
@@ -2048,7 +2048,7 @@
 	}
 	else {
 		startTeam = 0;
-		endTeam = gs-&gt;activeTeams - 1;
+		endTeam = teamHandler-&gt;ActiveTeams() - 1;
 	}
 
 #define PLANES_TEST                  \
@@ -2062,7 +2062,7 @@
 	const int readTeam = CLuaHandle::GetActiveHandle()-&gt;GetReadTeam();
 
 	for (int team = startTeam; team &lt;= endTeam; team++) {
-		const CUnitSet&amp; units = gs-&gt;Team(team)-&gt;units;
+		const CUnitSet&amp; units = teamHandler-&gt;Team(team)-&gt;units;
 		CUnitSet::const_iterator it;
 
 		if (allegiance &gt;= 0) {
@@ -2080,12 +2080,12 @@
 			}
 		}
 		else if (allegiance == AllyUnits) {
-			if (readAllyTeam == gs-&gt;AllyTeam(team)) {
+			if (readAllyTeam == teamHandler-&gt;AllyTeam(team)) {
 				LOOP_UNIT_CONTAINER(NULL_TEST, PLANES_TEST);
 			}
 		}
 		else if (allegiance == EnemyUnits) {
-			if (readAllyTeam != gs-&gt;AllyTeam(team)) {
+			if (readAllyTeam != teamHandler-&gt;AllyTeam(team)) {
 				LOOP_UNIT_CONTAINER(VISIBLE_TEST, PLANES_TEST);
 			}
 		}
@@ -2346,7 +2346,7 @@
 	const UnitDef* decoyDef = IsAllyUnit(unit) ? NULL : unitDef-&gt;decoyDef;
 	const UnitDef* effectiveDef = EffectiveUnitDef(unit);
 	if (effectiveDef-&gt;showPlayerName) {
-		tooltip = gs-&gt;players[gs-&gt;Team(unit-&gt;team)-&gt;leader]-&gt;name;
+		tooltip = playerHandler-&gt;Player(teamHandler-&gt;Team(unit-&gt;team)-&gt;leader)-&gt;name;
 	} else {
 		if (!decoyDef) {
 			tooltip = unit-&gt;tooltip;
@@ -2413,7 +2413,7 @@
 	if (IsEnemyUnit(unit)) {
 		return 1;
 	}
-	const CTeam* team = gs-&gt;Team(unit-&gt;team);
+	const CTeam* team = teamHandler-&gt;Team(unit-&gt;team);
 	if (team == NULL) {
 		return 1;
 	}
@@ -2955,7 +2955,7 @@
 		}
 		allyTeam = luaL_checkint(L, 2);
 	}
-	if ((allyTeam &lt; 0) || (allyTeam &gt;= gs-&gt;activeAllyTeams)) {
+	if ((allyTeam &lt; 0) || (allyTeam &gt;= teamHandler-&gt;ActiveAllyTeams())) {
 		return 0;
 	}
 	const unsigned short losStatus = unit-&gt;losStatus[allyTeam];
@@ -4074,13 +4074,13 @@
 	if (lua_isnoneornil(L, arg)) {
 		return readAllyTeam;
 	}
-	const bool isGaia = (readAllyTeam == gs-&gt;gaiaAllyTeamID);
+	const bool isGaia = (readAllyTeam == teamHandler-&gt;GaiaAllyTeamID());
 	if (fullRead || isGaia) {
 		const int at = luaL_checkint(L, arg);
-		if (at &gt;= gs-&gt;activeAllyTeams) {
+		if (at &gt;= teamHandler-&gt;ActiveAllyTeams()) {
 			luaL_error(L, &quot;Invalid allyTeam&quot;);
 		}
-		if (isGaia &amp;&amp; (at &gt;= 0) &amp;&amp; (at != gs-&gt;gaiaAllyTeamID)) {
+		if (isGaia &amp;&amp; (at &gt;= 0) &amp;&amp; (at != teamHandler-&gt;GaiaAllyTeamID())) {
 			luaL_error(L, &quot;Invalid gaia access&quot;);
 		}
 		return at;
@@ -4108,13 +4108,13 @@
 		inRadar = radarhandler-&gt;InRadar(pos, allyTeamID);
 	}
 	else {
-		for (int at = 0; at &lt; gs-&gt;activeAllyTeams; at++) {
+		for (int at = 0; at &lt; teamHandler-&gt;ActiveAllyTeams(); at++) {
 			if (loshandler-&gt;InLos(pos, at)) {
 				inLos = true;
 				break;
 			}
 		}
-		for (int at = 0; at &lt; gs-&gt;activeAllyTeams; at++) {
+		for (int at = 0; at &lt; teamHandler-&gt;ActiveAllyTeams(); at++) {
 			if (radarhandler-&gt;InRadar(pos, at)) {
 				inRadar = true;
 				break;
@@ -4142,7 +4142,7 @@
 		state = loshandler-&gt;InLos(pos, allyTeamID);
 	}
 	else {
-		for (int at = 0; at &lt; gs-&gt;activeAllyTeams; at++) {
+		for (int at = 0; at &lt; teamHandler-&gt;ActiveAllyTeams(); at++) {
 			if (loshandler-&gt;InLos(pos, at)) {
 				state = true;
 				break;
@@ -4168,7 +4168,7 @@
 		state = radarhandler-&gt;InRadar(pos, allyTeamID);
 	}
 	else {
-		for (int at = 0; at &lt; gs-&gt;activeAllyTeams; at++) {
+		for (int at = 0; at &lt; teamHandler-&gt;ActiveAllyTeams(); at++) {
 			if (radarhandler-&gt;InRadar(pos, at)) {
 				state = true;
 				break;
@@ -4194,7 +4194,7 @@
 		state = loshandler-&gt;InAirLos(pos, allyTeamID);
 	}
 	else {
-		for (int at = 0; at &lt; gs-&gt;activeAllyTeams; at++) {
+		for (int at = 0; at &lt; teamHandler-&gt;ActiveAllyTeams(); at++) {
 			if (loshandler-&gt;InAirLos(pos, at)) {
 				state = true;
 				break;

Modified: trunk/rts/Lua/LuaUnsyncedCtrl.cpp
===================================================================
--- trunk/rts/Lua/LuaUnsyncedCtrl.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Lua/LuaUnsyncedCtrl.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -32,8 +32,7 @@
 #include &quot;Game/Camera/CameraController.h&quot;
 #include &quot;Game/Game.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
-#include &quot;Game/Player.h&quot;
+#include &quot;Game/PlayerHandler.h&quot;
 #include &quot;Game/UI/CommandColors.h&quot;
 #include &quot;Game/UI/CursorIcons.h&quot;
 #include &quot;Game/UI/GuiHandler.h&quot;
@@ -49,6 +48,7 @@
 #include &quot;Rendering/FontTexture.h&quot;
 #include &quot;Rendering/IconHandler.h&quot;
 #include &quot;Rendering/InMapDraw.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitDefHandler.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
@@ -214,7 +214,7 @@
 	if (ctrlTeam &lt; 0) {
 		return ctrlTeam;
 	}
-	return gs-&gt;AllyTeam(ctrlTeam);
+	return teamHandler-&gt;AllyTeam(ctrlTeam);
 }
 
 
@@ -234,7 +234,7 @@
 	if (ctrlTeam &lt; 0) {
 		return (ctrlTeam == CEventClient::AllAccessTeam) ? true : false;
 	}
-	return (gs-&gt;AllyTeam(ctrlTeam) == allyteam);
+	return (teamHandler-&gt;AllyTeam(ctrlTeam) == allyteam);
 }
 
 
@@ -383,7 +383,7 @@
 	if ((playerID &lt; 0) || (playerID &gt;= MAX_PLAYERS)) {
 		luaL_error(L, &quot;Invalid message playerID: %i&quot;, playerID);
 	}
-	const CPlayer* player = gs-&gt;players[playerID];
+	const CPlayer* player = playerHandler-&gt;Player(playerID);
 	if ((player == NULL) || !player-&gt;active || player-&gt;name.empty()) {
 		luaL_error(L, &quot;Invalid message playerID: %i&quot;, playerID);
 	}
@@ -608,7 +608,7 @@
 	                 lua_tofloat(L, 3),
 	                 lua_tofloat(L, 4));
 	const int team = lua_toint(L, 5);
-	if ((team &lt; 0) || (team &gt;= gs-&gt;activeTeams)) {
+	if ((team &lt; 0) || (team &gt;= teamHandler-&gt;ActiveTeams())) {
 		return 0;
 	}
 	const int facing = lua_toint(L, 6);
@@ -775,7 +775,7 @@
 	if ((teamID &lt; 0) || (teamID &gt;= MAX_TEAMS)) {
 		return 0;
 	}
-	CTeam* team = gs-&gt;Team(teamID);
+	CTeam* team = teamHandler-&gt;Team(teamID);
 	if (team == NULL) {
 		return 0;
 	}
@@ -1934,10 +1934,10 @@
 	const float shareLevel = max(0.0f, min(1.0f, lua_tofloat(L, 2)));
 
 	if (shareType == &quot;metal&quot;) {
-		net-&gt;Send(CBaseNetProtocol::Get().SendSetShare(gu-&gt;myPlayerNum, gu-&gt;myTeam, shareLevel, gs-&gt;Team(gu-&gt;myTeam)-&gt;energyShare));
+		net-&gt;Send(CBaseNetProtocol::Get().SendSetShare(gu-&gt;myPlayerNum, gu-&gt;myTeam, shareLevel, teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;energyShare));
 	}
 	else if (shareType == &quot;energy&quot;) {
-		net-&gt;Send(CBaseNetProtocol::Get().SendSetShare(gu-&gt;myPlayerNum, gu-&gt;myTeam,	gs-&gt;Team(gu-&gt;myTeam)-&gt;metalShare, shareLevel));
+		net-&gt;Send(CBaseNetProtocol::Get().SendSetShare(gu-&gt;myPlayerNum, gu-&gt;myTeam,	teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;metalShare, shareLevel));
 	}
 	else {
 		logOutput.Print(&quot;SetShareLevel() unknown resource: %s&quot;, shareType.c_str());
@@ -1961,10 +1961,10 @@
 		luaL_error(L, &quot;Incorrect arguments to ShareResources()&quot;);
 	}
 	const int teamID = lua_toint(L, 1);
-	if ((teamID &lt; 0) || (teamID &gt;= gs-&gt;activeTeams)) {
+	if ((teamID &lt; 0) || (teamID &gt;= teamHandler-&gt;ActiveTeams())) {
 		return 0;
 	}
-	const CTeam* team = gs-&gt;Team(teamID);
+	const CTeam* team = teamHandler-&gt;Team(teamID);
 	if ((team == NULL) || team-&gt;isDead) {
 		return 0;
 	}

Modified: trunk/rts/Lua/LuaUnsyncedRead.cpp
===================================================================
--- trunk/rts/Lua/LuaUnsyncedRead.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Lua/LuaUnsyncedRead.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -29,11 +29,10 @@
 #include &quot;Game/Game.h&quot;
 #include &quot;Game/GameHelper.h&quot;
 #include &quot;Game/GameSetup.h&quot;
-#include &quot;Game/Player.h&quot;
+#include &quot;Game/PlayerHandler.h&quot;
 #include &quot;Game/PlayerRoster.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
 #include &quot;Game/CameraHandler.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
 #include &quot;Game/UI/GuiHandler.h&quot;
 #include &quot;Game/UI/InfoConsole.h&quot;
 #include &quot;Game/UI/KeyCodes.h&quot;
@@ -49,6 +48,7 @@
 #include &quot;Rendering/Env/BaseWater.h&quot;
 #include &quot;Rendering/UnitModels/UnitDrawer.h&quot;
 #include &quot;Sim/Features/Feature.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
 #include &quot;Sim/Units/UnitTypes/TransportUnit.h&quot;
@@ -611,7 +611,7 @@
 	}
 	int allyTeamID = readAllyTeam;
 	if (teamID &gt;= 0) {
-		allyTeamID = gs-&gt;AllyTeam(teamID);
+		allyTeamID = teamHandler-&gt;AllyTeam(teamID);
 	}
 	if (allyTeamID &lt; 0) {
 		if (!fullRead) {
@@ -636,14 +636,14 @@
 	// setup the list of unit sets
 	vector&lt;const CUnitSet*&gt; unitSets;
 	if (teamID &gt;= 0) {
-		unitSets.push_back(&amp;gs-&gt;Team(teamID)-&gt;units);
+		unitSets.push_back(&amp;teamHandler-&gt;Team(teamID)-&gt;units);
 	}
 	else {
-		for (int t = 0; t &lt; gs-&gt;activeTeams; t++) {
+		for (int t = 0; t &lt; teamHandler-&gt;ActiveTeams(); t++) {
 			if ((teamID == AllUnits) ||
-			    ((teamID == AllyUnits)  &amp;&amp; (allyTeamID == gs-&gt;AllyTeam(t))) ||
-			    ((teamID == EnemyUnits) &amp;&amp; (allyTeamID != gs-&gt;AllyTeam(t)))) {
-				unitSets.push_back(&amp;gs-&gt;Team(t)-&gt;units);
+			    ((teamID == AllyUnits)  &amp;&amp; (allyTeamID == teamHandler-&gt;AllyTeam(t))) ||
+			    ((teamID == EnemyUnits) &amp;&amp; (allyTeamID != teamHandler-&gt;AllyTeam(t)))) {
+				unitSets.push_back(&amp;teamHandler-&gt;Team(t)-&gt;units);
 			}
 		}
 	}
@@ -1112,13 +1112,13 @@
 	lua_pushnumber(L, index); index++; \
 	lua_push ## type(L, val); lua_rawset(L, -3);
 
-	const CPlayer* p = gs-&gt;players[playerID];
+	const CPlayer* p = playerHandler-&gt;Player(playerID);
 	int index = 1;
 	lua_newtable(L);
 	PUSH_ROSTER_ENTRY(string, p-&gt;name.c_str());
 	PUSH_ROSTER_ENTRY(number, playerID);
 	PUSH_ROSTER_ENTRY(number, p-&gt;team);
-	PUSH_ROSTER_ENTRY(number, gs-&gt;AllyTeam(p-&gt;team));
+	PUSH_ROSTER_ENTRY(number, teamHandler-&gt;AllyTeam(p-&gt;team));
 	PUSH_ROSTER_ENTRY(number, p-&gt;spectator);
 	PUSH_ROSTER_ENTRY(number, p-&gt;cpuUsage);
 	const float pingScale = (GAME_SPEED * gs-&gt;speedFactor);
@@ -1163,10 +1163,10 @@
 int LuaUnsyncedRead::GetTeamColor(lua_State* L)
 {
 	const int teamID = luaL_checkint(L, 1);
-	if ((teamID &lt; 0) || (teamID &gt;= gs-&gt;activeTeams)) {
+	if ((teamID &lt; 0) || (teamID &gt;= teamHandler-&gt;ActiveTeams())) {
 		return 0;
 	}
-	const CTeam* team = gs-&gt;Team(teamID);
+	const CTeam* team = teamHandler-&gt;Team(teamID);
 	if (team == NULL) {
 		return 0;
 	}
@@ -1183,10 +1183,10 @@
 int LuaUnsyncedRead::GetTeamOrigColor(lua_State* L)
 {
 	const int teamID = luaL_checkint(L, 1);
-	if ((teamID &lt; 0) || (teamID &gt;= gs-&gt;activeTeams)) {
+	if ((teamID &lt; 0) || (teamID &gt;= teamHandler-&gt;ActiveTeams())) {
 		return 0;
 	}
-	const CTeam* team = gs-&gt;Team(teamID);
+	const CTeam* team = teamHandler-&gt;Team(teamID);
 	if (team == NULL) {
 		return 0;
 	}

Modified: trunk/rts/Rendering/InMapDraw.cpp
===================================================================
--- trunk/rts/Rendering/InMapDraw.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Rendering/InMapDraw.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -6,13 +6,13 @@
 #include &quot;InMapDraw.h&quot;
 #include &quot;Game/Camera.h&quot;
 #include &quot;Game/Game.h&quot;
-#include &quot;Game/Player.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
+#include &quot;Game/PlayerHandler.h&quot;
 #include &quot;Game/UI/MiniMap.h&quot;
 #include &quot;Game/UI/MouseHandler.h&quot;
 #include &quot;Map/BaseGroundDrawer.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Map/ReadMap.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;glFont.h&quot;
 #include &quot;GL/myGL.h&quot;
 #include &quot;GL/VertexArray.h&quot;
@@ -183,8 +183,8 @@
 	if (s.IsWriting()) {
 		char ColorType = 0;
 		char ColorId = 0;
-		if (!ColorType) for (int a=0;a&lt;MAX_TEAMS;a++) 
-			if (*color==gs-&gt;Team(a)-&gt;color) {
+		if (!ColorType) for (int a=0;a&lt;MAX_TEAMS;a++)
+			if (*color==teamHandler-&gt;Team(a)-&gt;color) {
 				ColorType = 1;
 				ColorId = a;
 				break;
@@ -202,7 +202,7 @@
 				break;
 			}
 			case 1:{
-				*color = gs-&gt;Team(ColorId)-&gt;color;
+				*color = teamHandler-&gt;Team(ColorId)-&gt;color;
 				break;
 			}
 		}
@@ -240,7 +240,7 @@
 	for (std::list&lt;CInMapDraw::MapPoint&gt;::iterator pi = dq-&gt;points.begin(); pi != dq-&gt;points.end(); ++pi) {
 		const int allyteam = pi-&gt;senderAllyTeam;
 		const bool spec = pi-&gt;senderSpectator;
-		const bool allied = (gs-&gt;Ally(gu-&gt;myAllyTeam, allyteam) &amp;&amp; gs-&gt;Ally(allyteam, gu-&gt;myAllyTeam));
+		const bool allied = (teamHandler-&gt;Ally(gu-&gt;myAllyTeam, allyteam) &amp;&amp; teamHandler-&gt;Ally(allyteam, gu-&gt;myAllyTeam));
 		const bool maySee = (gu-&gt;spectating || (!spec &amp;&amp; allied) || imd-&gt;drawAll);
 
 		if (maySee) {
@@ -293,7 +293,7 @@
 	for (std::list&lt;CInMapDraw::MapLine&gt;::iterator li = dq-&gt;lines.begin(); li != dq-&gt;lines.end(); ++li) {
 		const int allyteam = li-&gt;senderAllyTeam;
 		const bool spec = li-&gt;senderSpectator;
-		const bool allied = (gs-&gt;Ally(gu-&gt;myAllyTeam, allyteam) &amp;&amp; gs-&gt;Ally(allyteam, gu-&gt;myAllyTeam));
+		const bool allied = (teamHandler-&gt;Ally(gu-&gt;myAllyTeam, allyteam) &amp;&amp; teamHandler-&gt;Ally(allyteam, gu-&gt;myAllyTeam));
 		const bool maySee = (gu-&gt;spectating || (!spec &amp;&amp; allied) || imd-&gt;drawAll);
 
 		if (maySee) {
@@ -439,14 +439,14 @@
 	if ((playerID &lt; 0) || (playerID &gt;= MAX_PLAYERS)) {
 		return;
 	}
-	const CPlayer* sender = gs-&gt;players[playerID];
+	const CPlayer* sender = playerHandler-&gt;Player(playerID);
 	if (sender == NULL) {
 		return;
 	}
 	const int  team      = sender-&gt;team;
-	const int  allyteam  = gs-&gt;AllyTeam(team);
-	const bool alliedMsg = (gs-&gt;Ally(gu-&gt;myAllyTeam, allyteam) &amp;&amp;
-	                        gs-&gt;Ally(allyteam, gu-&gt;myAllyTeam));
+	const int  allyteam  = teamHandler-&gt;AllyTeam(team);
+	const bool alliedMsg = (teamHandler-&gt;Ally(gu-&gt;myAllyTeam, allyteam) &amp;&amp;
+	                        teamHandler-&gt;Ally(allyteam, gu-&gt;myAllyTeam));
 	bool allowed = true;
 
 	if (!gu-&gt;spectating &amp;&amp; (sender-&gt;spectator || !alliedMsg)) {
@@ -467,7 +467,7 @@
 
 	MapPoint point;
 	point.pos = pos;
-	point.color = gs-&gt;Team(team)-&gt;color;
+	point.color = teamHandler-&gt;Team(team)-&gt;color;
 	point.label = label;
 	point.senderAllyTeam = allyteam;
 	point.senderSpectator = sender-&gt;spectator;
@@ -496,14 +496,14 @@
 	if ((playerID &lt; 0) || (playerID &gt;= MAX_PLAYERS)) {
 		return;
 	}
-	const CPlayer* sender = gs-&gt;players[playerID];
+	const CPlayer* sender = playerHandler-&gt;Player(playerID);
 	if (sender == NULL) {
 		return;
 	}
 	const int  team      = sender-&gt;team;
-	const int  allyteam  = gs-&gt;AllyTeam(team);
-	const bool alliedMsg = (gs-&gt;Ally(gu-&gt;myAllyTeam, allyteam) &amp;&amp;
-	                        gs-&gt;Ally(allyteam, gu-&gt;myAllyTeam));
+	const int  allyteam  = teamHandler-&gt;AllyTeam(team);
+	const bool alliedMsg = (teamHandler-&gt;Ally(gu-&gt;myAllyTeam, allyteam) &amp;&amp;
+	                        teamHandler-&gt;Ally(allyteam, gu-&gt;myAllyTeam));
 
 	float3 pos1 = constPos1;
 	float3 pos2 = constPos2;
@@ -519,7 +519,7 @@
 	MapLine line;
 	line.pos  = pos1;
 	line.pos2 = pos2;
-	line.color = gs-&gt;Team(team)-&gt;color;
+	line.color = teamHandler-&gt;Team(team)-&gt;color;
 	line.senderAllyTeam = allyteam;
 	line.senderSpectator = sender-&gt;spectator;
 
@@ -536,14 +536,14 @@
 	if ((playerID &lt; 0) || (playerID &gt;= MAX_PLAYERS)) {
 		return;
 	}
-	const CPlayer* sender = gs-&gt;players[playerID];
+	const CPlayer* sender = playerHandler-&gt;Player(playerID);
 	if (sender == NULL) {
 		return;
 	}
 	const int  team      = sender-&gt;team;
-	const int  allyteam  = gs-&gt;AllyTeam(team);
-	const bool alliedMsg = (gs-&gt;Ally(gu-&gt;myAllyTeam, allyteam) &amp;&amp;
-	                        gs-&gt;Ally(allyteam, gu-&gt;myAllyTeam));
+	const int  allyteam  = teamHandler-&gt;AllyTeam(team);
+	const bool alliedMsg = (teamHandler-&gt;Ally(gu-&gt;myAllyTeam, allyteam) &amp;&amp;
+	                        teamHandler-&gt;Ally(allyteam, gu-&gt;myAllyTeam));
 
 	float3 pos = constPos;
 	pos.CheckInBounds();

Modified: trunk/rts/Rendering/Textures/TextureHandler.cpp
===================================================================
--- trunk/rts/Rendering/Textures/TextureHandler.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Rendering/Textures/TextureHandler.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -14,7 +14,7 @@
 #include &quot;FileSystem/FileHandler.h&quot;
 #include &quot;FileSystem/SimpleParser.h&quot;
 #include &quot;Sim/Misc/GlobalSynced.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;Platform/errorhandler.h&quot;
@@ -87,7 +87,7 @@
 			texfiles[numfiles++] = tex;
 			totalSize += tex-&gt;tex.xsize * tex-&gt;tex.ysize;
 		} else {
-			for(int a = 0; a &lt; gs-&gt;activeTeams; ++a){
+			for(int a = 0; a &lt; teamHandler-&gt;ActiveTeams(); ++a){
 				TexFile* tex = CreateTeamTex(s, s2, a);
 				texfiles[numfiles++] = tex;
 				totalSize += tex-&gt;tex.xsize * tex-&gt;tex.ysize;
@@ -360,7 +360,7 @@
 	sprintf(tmp,&quot;%s%02i&quot;,name2.c_str(),team);
 	tex-&gt;name=tmp;
 
-	unsigned char* teamCol=gs-&gt;Team(team)-&gt;color;
+	unsigned char* teamCol=teamHandler-&gt;Team(team)-&gt;color;
 	CBitmap* bm=&amp;tex-&gt;tex;
 	for(int a=0;a&lt;bm-&gt;ysize*bm-&gt;xsize;++a){
 		if(bm-&gt;mem[a*4]==bm-&gt;mem[a*4+2] &amp;&amp; bm-&gt;mem[a*4+1]==0){

Modified: trunk/rts/Rendering/UnitModels/3DOParser.cpp
===================================================================
--- trunk/rts/Rendering/UnitModels/3DOParser.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Rendering/UnitModels/3DOParser.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -177,7 +177,7 @@
 	}
 
 //	if(sideName.find(&quot;armstump.3do&quot;)!=std::string.npos){
-//		logOutput.Print(&quot;New type %s %i %s %s&quot;,name.c_str(),team,sideName.c_str(),gs-&gt;players[gs-&gt;Team(team)-&gt;leader]-&gt;name.c_str());
+//		logOutput.Print(&quot;New type %s %i %s %s&quot;,name.c_str(),team,sideName.c_str(),playerHandler-&gt;Player(teamHandler-&gt;Team(team)-&gt;leader)-&gt;name.c_str());
 //	}
 	PUSH_CODE_MODE;
 	ENTER_SYNCED;

Modified: trunk/rts/Rendering/UnitModels/UnitDrawer.cpp
===================================================================
--- trunk/rts/Rendering/UnitModels/UnitDrawer.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Rendering/UnitModels/UnitDrawer.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -9,7 +9,6 @@
 #include &quot;Game/GameHelper.h&quot;
 #include &quot;Game/GameSetup.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
 #include &quot;Lua/LuaMaterial.h&quot;
 #include &quot;Lua/LuaUnitMaterial.h&quot;
 #include &quot;Lua/LuaRules.h&quot;
@@ -35,6 +34,7 @@
 #include &quot;Sim/Misc/CollisionVolume.h&quot;
 #include &quot;Sim/Misc/LosHandler.h&quot;
 #include &quot;Sim/Misc/RadarHandler.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Units/CommandAI/BuilderCAI.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;Sim/Units/UnitDefHandler.h&quot;
@@ -782,7 +782,7 @@
 	if (unit-&gt;commandAI-&gt;selected) {
 		glColor3ub(255, 255, 255);
 	} else {
-		glColor3ubv(gs-&gt;Team(unit-&gt;team)-&gt;color);
+		glColor3ubv(teamHandler-&gt;Team(unit-&gt;team)-&gt;color);
 	}
 
 	// If the icon is partly under the ground, move it up.
@@ -1112,7 +1112,7 @@
 void CUnitDrawer::SetS3OTeamColour(int team)
 {
 	if (advShading) {
-		unsigned char* col = gs-&gt;Team(team)-&gt;color;
+		unsigned char* col = teamHandler-&gt;Team(team)-&gt;color;
 		glProgramEnvParameter4fARB(GL_FRAGMENT_PROGRAM_ARB, 14, col[0] / 255.f, col[1] / 255.f, col[2] / 255.f, 1);
 		if (luaDrawing) { // FIXME?
 			SetBasicS3OTeamColour(team);
@@ -1125,7 +1125,7 @@
 
 void CUnitDrawer::SetBasicS3OTeamColour(int team)
 {
-	unsigned char* col = gs-&gt;Team(team)-&gt;color;
+	unsigned char* col = teamHandler-&gt;Team(team)-&gt;color;
 	float texConstant[] = {col[0] / 255.f, col[1] / 255.f, col[2] / 255.f, 1};
 	glTexEnvfv(GL_TEXTURE_ENV, GL_TEXTURE_ENV_COLOR, texConstant);
 }
@@ -1885,7 +1885,7 @@
 		fc = unit-&gt;unitDef-&gt;nanoColor;
 	}
 	else {
-		const unsigned char* tcol = gs-&gt;Team(unit-&gt;team)-&gt;color;
+		const unsigned char* tcol = teamHandler-&gt;Team(unit-&gt;team)-&gt;color;
 		fc = float3(tcol[0] * (1.0f / 255.0f),
 								tcol[1] * (1.0f / 255.0f),
 								tcol[2] * (1.0f / 255.0f));

Modified: trunk/rts/Sim/Features/Feature.cpp
===================================================================
--- trunk/rts/Sim/Features/Feature.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Sim/Features/Feature.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -3,7 +3,6 @@
 
 #include &quot;Feature.h&quot;
 #include &quot;FeatureHandler.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Lua/LuaRules.h&quot;
 #include &quot;Map/Ground.h&quot;
@@ -16,8 +15,9 @@
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Rendering/UnitModels/3DOParser.h&quot;
 #include &quot;Rendering/UnitModels/UnitDrawer.h&quot;
+#include &quot;Sim/Misc/CollisionVolume.h&quot;
 #include &quot;Sim/Misc/ModInfo.h&quot;
-#include &quot;Sim/Misc/CollisionVolume.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Projectiles/FireProjectile.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;Sim/Projectiles/Unsynced/GeoThermSmokeProjectile.h&quot;
@@ -132,7 +132,7 @@
 		allyteam = -1;
 	} else {
 		team = newTeam;
-		allyteam = gs-&gt;AllyTeam(newTeam);
+		allyteam = teamHandler-&gt;AllyTeam(newTeam);
 	}
 
 	if (def-&gt;drawType == DRAWTYPE_3DO){
@@ -265,8 +265,8 @@
 		// Work out how much that will cost
 		const float metalUse  = part * def-&gt;metal;
 		const float energyUse = part * def-&gt;energy;
-		if ((gs-&gt;Team(builder-&gt;team)-&gt;metal  &gt;= metalUse)  &amp;&amp;
-		    (gs-&gt;Team(builder-&gt;team)-&gt;energy &gt;= energyUse) &amp;&amp;
+		if ((teamHandler-&gt;Team(builder-&gt;team)-&gt;metal  &gt;= metalUse)  &amp;&amp;
+		    (teamHandler-&gt;Team(builder-&gt;team)-&gt;energy &gt;= energyUse) &amp;&amp;
 				(!luaRules || luaRules-&gt;AllowFeatureBuildStep(builder, this, part))) {
 			builder-&gt;UseMetal(metalUse);
 			builder-&gt;UseEnergy(energyUse);
@@ -279,8 +279,8 @@
 		}
 		else {
 			// update the energy and metal required counts
-			gs-&gt;Team(builder-&gt;team)-&gt;energyPull += energyUse;
-			gs-&gt;Team(builder-&gt;team)-&gt;metalPull  += metalUse;
+			teamHandler-&gt;Team(builder-&gt;team)-&gt;energyPull += energyUse;
+			teamHandler-&gt;Team(builder-&gt;team)-&gt;metalPull  += metalUse;
 		}
 		return false;
 	}
@@ -318,7 +318,7 @@
 		const float energyUseScaled = metalFraction * modInfo.reclaimFeatureEnergyCostFactor;
 
 		if (!builder-&gt;UseEnergy(energyUseScaled)) {
-			gs-&gt;Team(builder-&gt;team)-&gt;energyPull += energyUseScaled;
+			teamHandler-&gt;Team(builder-&gt;team)-&gt;energyPull += energyUseScaled;
 			return false;
 		}
 

Modified: trunk/rts/Sim/Misc/AirBaseHandler.cpp
===================================================================
--- trunk/rts/Sim/Misc/AirBaseHandler.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Sim/Misc/AirBaseHandler.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -3,6 +3,7 @@
 #include &quot;AirBaseHandler.h&quot;
 
 #include &quot;GlobalSynced.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/COB/CobInstance.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
@@ -14,7 +15,7 @@
 CR_REG_METADATA(CAirBaseHandler,(
 	CR_MEMBER(freeBases),
 	CR_MEMBER(bases),
-	CR_RESERVED(16)	
+	CR_RESERVED(16)
 	));
 
 CR_BIND_DERIVED(CAirBaseHandler::LandingPad, CObject, (NULL, 0, NULL));
@@ -42,7 +43,7 @@
 CAirBaseHandler::~CAirBaseHandler(void)
 {
 	//shouldnt be any bases left here...
-	for (int a = 0; a &lt; gs-&gt;activeAllyTeams; ++a) {
+	for (int a = 0; a &lt; teamHandler-&gt;ActiveAllyTeams(); ++a) {
 		for (airBaseLstIt bi = bases[a].begin(); bi != bases[a].end(); ++bi) {
 			for (padLstIt pi = (*bi)-&gt;pads.begin(); pi !=(*bi)-&gt;pads.end(); ++pi) {
 				delete *pi;

Modified: trunk/rts/Sim/Misc/GlobalSynced.cpp
===================================================================
--- trunk/rts/Sim/Misc/GlobalSynced.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Sim/Misc/GlobalSynced.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -5,11 +5,14 @@
 #include &lt;cstring&gt;
 
 #include &quot;Game/GameSetup.h&quot;
-#include &quot;Team.h&quot;
-#include &quot;Game/Player.h&quot;
+#include &quot;Game/PlayerHandler.h&quot;
 #include &quot;Lua/LuaGaia.h&quot;
 #include &quot;Lua/LuaRules.h&quot;
+#include &quot;Team.h&quot;
+#include &quot;TeamHandler.h&quot;
+#include &quot;Util.h&quot;
 
+
 /**
  * @brief global synced
  *
@@ -36,16 +39,8 @@
 	CR_MEMBER(editDefsEnabled),
 	CR_MEMBER(useLuaRules),
 	CR_MEMBER(useLuaGaia),
-	CR_MEMBER(gaiaTeamID),
-	CR_MEMBER(gaiaAllyTeamID),
 	CR_MEMBER(gameMode),
-	CR_MEMBER(players),
-	CR_MEMBER(activeTeams),
-	CR_MEMBER(activeAllyTeams),
-	CR_MEMBER(activePlayers),
-	CR_MEMBER(allies),
-	CR_MEMBER(team2allyteam),
-	CR_MEMBER(teams),
+	CR_MEMBER(activeTeamsBackwardCompatForLuaBinder),
 	CR_RESERVED(64)
 ));
 
@@ -71,45 +66,22 @@
 	tempNum = 2;
 	gameMode = 0;
 	useLuaGaia = true;
-	gaiaTeamID = -1;
-	gaiaAllyTeamID = -1;
 	useLuaRules = true;
-	
-	for(int a = 0; a &lt; MAX_TEAMS; ++a) {
-		teams[a] = SAFE_NEW CTeam();
-		teams[a]-&gt;teamNum = a;
-		team2allyteam[a] = a;
-	}
-	for(int a = 0; a &lt; MAX_PLAYERS; ++a) {
-		players[a] = SAFE_NEW CPlayer();
-		players[a]-&gt;playerNum = a;
-	}
 
-	for (int a = 0; a &lt; MAX_TEAMS; ++a) {
-		for (int b = 0; b &lt; MAX_TEAMS; ++b) {
-			allies[a][b] = false;
-		}
-		allies[a][a] = true;
-	}
-
-	activeTeams = 2;
-	activeAllyTeams = 2;
-	activePlayers = MAX_PLAYERS;
+	// TODO: put this somewhere else (playerHandler is unsynced, even)
+	playerHandler = new CPlayerHandler();
+	teamHandler = new CTeamHandler();
 }
 
-/**
- * Destroys data inside CGlobalSyncedStuff
- */
+
 CGlobalSyncedStuff::~CGlobalSyncedStuff()
 {
-	for(int a = 0; a &lt; MAX_TEAMS; a++) {
-		delete teams[a];
-	}
-	for(int a = 0; a &lt; MAX_PLAYERS; a++) {
-		delete players[a];
-	}
+	// TODO: put this somewhere else (playerHandler is unsynced, even)
+	SafeDelete(playerHandler);
+	SafeDelete(teamHandler);
 }
 
+
 void CGlobalSyncedStuff::LoadFromSetup(const CGameSetup* setup)
 {
 	gameMode = setup-&gt;gameMode;
@@ -118,78 +90,12 @@
 	useLuaGaia  = CLuaGaia::SetConfigString(setup-&gt;luaGaiaStr);
 	useLuaRules = CLuaRules::SetConfigString(setup-&gt;luaRulesStr);
 
-	activePlayers = setup-&gt;numPlayers;
-	activeTeams = setup-&gt;numTeams;
-	activeAllyTeams = setup-&gt;numAllyTeams;
-	
-	assert(activeTeams &lt;= MAX_TEAMS);
-	assert(activeAllyTeams &lt;= MAX_TEAMS);
+	// TODO: this call is unsynced, technically
+	playerHandler-&gt;LoadFromSetup(setup);
 
-	for (int i = 0; i &lt; activePlayers; ++i)
-	{
-		// TODO: refactor
-		*static_cast&lt;PlayerBase*&gt;(players[i]) = setup-&gt;playerStartingData[i];
-	}
+	teamHandler-&gt;LoadFromSetup(setup);
 
-	for (int i = 0; i &lt; activeTeams; ++i)
-	{
-		teams[i]-&gt;metal = setup-&gt;startMetal;
-		teams[i]-&gt;metalIncome = setup-&gt;startMetal; // for the endgame statistics
-
-		teams[i]-&gt;energy = setup-&gt;startEnergy;
-		teams[i]-&gt;energyIncome = setup-&gt;startEnergy;
-
-		float3 start(setup-&gt;teamStartingData[i].startPos.x, setup-&gt;teamStartingData[i].startPos.y, setup-&gt;teamStartingData[i].startPos.z);
-		teams[i]-&gt;StartposMessage(start, (setup-&gt;startPosType != CGameSetup::StartPos_ChooseInGame));
-		std::memcpy(teams[i]-&gt;color, setup-&gt;teamStartingData[i].color, 4);
-		teams[i]-&gt;handicap = setup-&gt;teamStartingData[i].handicap;
-		teams[i]-&gt;leader = setup-&gt;teamStartingData[i].leader;
-		teams[i]-&gt;side = setup-&gt;teamStartingData[i].side;
-		SetAllyTeam(i, setup-&gt;teamStartingData[i].teamAllyteam);
-		if (!setup-&gt;teamStartingData[i].aiDll.empty())
-		{
-			if (setup-&gt;teamStartingData[i].aiDll.substr(0, 6) == &quot;LuaAI:&quot;) // its a LuaAI
-			{
-				teams[i]-&gt;luaAI = setup-&gt;teamStartingData[i].aiDll.substr(6);
-				teams[i]-&gt;isAI = true;
-			}
-			else // no LuaAI
-			{
-				if (setup-&gt;hostDemo) // in demo replay, we don't need AI's to load again
-					teams[i]-&gt;dllAI = &quot;&quot;;
-				else
-				{
-					teams[i]-&gt;dllAI = setup-&gt;teamStartingData[i].aiDll;
-					teams[i]-&gt;isAI = true;
-				}
-			}
-		}
-	}
-
-	for (int allyTeam1 = 0; allyTeam1 &lt; activeAllyTeams; ++allyTeam1)
-	{
-		for (int allyTeam2 = 0; allyTeam2 &lt; activeAllyTeams; ++allyTeam2)
-			allies[allyTeam1][allyTeam2] = setup-&gt;allyStartingData[allyTeam1].allies[allyTeam2];
-	}
-
-	if (useLuaGaia) {
-		// Gaia adjustments
-		gaiaTeamID = activeTeams;
-		gaiaAllyTeamID = activeAllyTeams;
-		activeTeams++;
-		activeAllyTeams++;
-
-		// Setup the gaia team
-		CTeam* team = gs-&gt;Team(gs-&gt;gaiaTeamID);
-		team-&gt;color[0] = 255;
-		team-&gt;color[1] = 255;
-		team-&gt;color[2] = 255;
-		team-&gt;color[3] = 255;
-		team-&gt;gaia = true;
-		team-&gt;StartposMessage(float3(0.0, 0.0, 0.0), true);
-		//players[setup-&gt;numPlayers]-&gt;team = gaiaTeamID;
-		SetAllyTeam(gaiaTeamID, gaiaAllyTeamID);
-	}
+	activeTeamsBackwardCompatForLuaBinder = teamHandler-&gt;ActiveTeams();
 }
 
 /**
@@ -230,13 +136,3 @@
 
 	return ret;
 }
-
-int CGlobalSyncedStuff::Player(const std::string&amp; name)
-{
-	for (int i = 0; i &lt; MAX_PLAYERS; ++i) {
-		if (players[i] &amp;&amp; players[i]-&gt;name == name) {
-			return i;
-		}
-	}
-	return -1;
-}

Modified: trunk/rts/Sim/Misc/GlobalSynced.h
===================================================================
--- trunk/rts/Sim/Misc/GlobalSynced.h	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Sim/Misc/GlobalSynced.h	2008-11-12 22:26:06 UTC (rev 7026)
@@ -177,20 +177,6 @@
 	bool useLuaGaia;
 
 	/**
-	* @brief gaia team
-	*
-	* gaia's team id
-	*/
-	int gaiaTeamID;
-
-	/**
-	* @brief gaia team
-	*
-	* gaia's team id
-	*/
-	int gaiaAllyTeamID;
-
-	/**
 	* @brief game mode
 	*
 	* Determines the commander mode of this game
@@ -200,103 +186,9 @@
 	*/
 	int gameMode;
 
-	/**
-	* @brief players
-	*
-	* Array of CPlayer pointers, for all the
-	* players in the game
-	* (size MAX_PLAYERS)
-	*/
-	CPlayer* players[MAX_PLAYERS];
+	// do not use, backward compatibility
+	int activeTeamsBackwardCompatForLuaBinder;
 
-	/**
-	* @brief active teams
-	*
-	* The number of active teams
-	* (don't change during play)
-	*/
-	int activeTeams;
-
-	/**
-	* @brief active ally teams
-	*
-	* The number of active ally teams
-	*/
-	int activeAllyTeams;
-
-	/**
-	* @brief active players
-	*
-	* The number of active players
-	*/
-	int activePlayers;
-
-	/**
-	* @brief Player
-	* @param name name of the player
-	* @return his playernumber of -1 if not found
-	*
-	* Search a player by name.
-	*/
-	int Player(const std::string&amp; name);
-
-	/**
-	* @brief Team
-	* @param i index to fetch
-	* @return CTeam pointer
-	*
-	* Accesses a CTeam pointer at a given index
-	*/
-	CTeam *Team(int i) { return teams[i]; }
-
-	/**
-	* @brief ally
-	* @param a first index
-	* @param b second index
-	* @return allies[a][b]
-	*
-	* Returns ally at [a][b]
-	*/
-	bool Ally(int a,int b) { return allies[a][b]; }
-
-	/**
-	* @brief ally team
-	* @param team team to find
-	* @return the ally team
-	*
-	* returns the team2ally at given index
-	*/
-	int AllyTeam(int team) { return team2allyteam[team]; }
-
-	/**
-	* @brief allied teams
-	* @param a first team
-	* @param b second team
-	* @return whether teams are allied
-	*
-	* Tests whether teams are allied
-	*/
-	bool AlliedTeams(int a,int b) { return allies[team2allyteam[a]][team2allyteam[b]]; }
-
-	/**
-	* @brief set ally team
-	* @param team team to set
-	* @param allyteam allyteam to set
-	*
-	* Sets team's ally team
-	*/
-	void SetAllyTeam(int team, int allyteam) { team2allyteam[team]=allyteam; }
-
-	/**
-	* @brief set ally
-	* @param allyteamA first allyteam
-	* @param allyteamB second allyteam
-	* @param allied whether or not these two teams are allied
-	*
-	* Sets two allyteams to be allied or not
-	*/
-	void SetAlly(int allyteamA,int allyteamB, bool allied) { allies[allyteamA][allyteamB]=allied; }
-
 private:
 	/**
 	* @brief random seed
@@ -311,29 +203,6 @@
 	* Holds the synced initial random seed
 	*/
 	int initRandSeed;
-
-	/**
-	* @brief allies array
-	*
-	* Array indicates whether teams are allied,
-	* allies[a][b] means allyteam a is allied with
-	* allyteam b, NOT the other way around
-	*/
-	bool allies[MAX_TEAMS][MAX_TEAMS];
-
-	/**
-	* @brief team to ally team
-	*
-	* Array stores what ally team a specific team is part of
-	*/
-	int team2allyteam[MAX_TEAMS];
-
-	/**
-	* @brief teams
-	*
-	* Array of CTeam pointers for teams in game
-	*/
-	CTeam* teams[MAX_TEAMS];
 };
 
 extern CGlobalSyncedStuff* gs;

Modified: trunk/rts/Sim/Misc/InterceptHandler.cpp
===================================================================
--- trunk/rts/Sim/Misc/InterceptHandler.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Sim/Misc/InterceptHandler.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -9,6 +9,7 @@
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
 #include &quot;Sim/Weapons/PlasmaRepulser.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;myMath.h&quot;
 #include &quot;creg/STL_List.h&quot;
@@ -54,7 +55,7 @@
 
 	for(std::list&lt;CWeapon*&gt;::iterator wi=interceptors.begin();wi!=interceptors.end();++wi){
 		CWeapon* w=*wi;
-		if ((targTeam==-1 || !gs-&gt;Ally(w-&gt;owner-&gt;allyteam,targTeam)) &amp;&amp; (target-&gt;weaponDef-&gt;targetable &amp; w-&gt;weaponDef-&gt;interceptor) &amp;&amp; w-&gt;weaponPos.SqDistance2D(destination) &lt; Square(w-&gt;weaponDef-&gt;coverageRange)){
+		if ((targTeam==-1 || !teamHandler-&gt;Ally(w-&gt;owner-&gt;allyteam,targTeam)) &amp;&amp; (target-&gt;weaponDef-&gt;targetable &amp; w-&gt;weaponDef-&gt;interceptor) &amp;&amp; w-&gt;weaponPos.SqDistance2D(destination) &lt; Square(w-&gt;weaponDef-&gt;coverageRange)){
 			w-&gt;incoming.push_back(target);
 			w-&gt;AddDeathDependence(target);
 		}

Modified: trunk/rts/Sim/Misc/LosHandler.cpp
===================================================================
--- trunk/rts/Sim/Misc/LosHandler.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Sim/Misc/LosHandler.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -11,6 +11,7 @@
 
 #include &quot;ModInfo.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Map/ReadMap.h&quot;
 #include &quot;TimeProfiler.h&quot;
 #include &quot;LogOutput.h&quot;
@@ -96,7 +97,7 @@
 	losSizeY(std::max(1, gs-&gt;mapy &gt;&gt; losMipLevel)),
 	requireSonarUnderWater(modInfo.requireSonarUnderWater)
 {
-	for (int a = 0; a &lt; gs-&gt;activeAllyTeams; ++a) {
+	for (int a = 0; a &lt; teamHandler-&gt;ActiveAllyTeams(); ++a) {
 		losMap[a].resize(losSizeX * losSizeY, 0);
 		airLosMap[a].resize(airSizeX * airSizeY, 0);
 	}
@@ -203,7 +204,7 @@
 void CLosHandler::LosAdd(LosInstance* instance)
 {
 	assert(instance);
-	assert(instance-&gt;allyteam &lt; gs-&gt;activeAllyTeams);
+	assert(instance-&gt;allyteam &lt; teamHandler-&gt;ActiveAllyTeams());
 	assert(instance-&gt;allyteam &gt;= 0);
 
 	const int allyteam  = instance-&gt;allyteam;

Modified: trunk/rts/Sim/Misc/RadarHandler.cpp
===================================================================
--- trunk/rts/Sim/Misc/RadarHandler.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Sim/Misc/RadarHandler.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -6,6 +6,7 @@
 #include &quot;LosHandler.h&quot;
 #include &quot;Rendering/UnitModels/3DOParser.h&quot;
 #include &quot;Map/ReadMap.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 
 
 CR_BIND(CRadarHandler, (false));
@@ -32,7 +33,7 @@
 	const int size = xsize*ysize*2;
 
 	// NOTE This could be tricky if gs is serialized after radarHandler.
-	for (int a = 0; a &lt; gs-&gt;activeAllyTeams; ++a) {
+	for (int a = 0; a &lt; teamHandler-&gt;ActiveAllyTeams(); ++a) {
 		s.Serialize(&amp;radarMaps[a].front(), size);
 		if (!circularRadar) {
 			s.Serialize(&amp;airRadarMaps[a].front(), size);
@@ -61,7 +62,7 @@
 	commonJammerMap.resize(size, 0);
 	commonSonarJammerMap.resize(size, 0);
 
-	for (int a = 0; a &lt; gs-&gt;activeAllyTeams; ++a) {
+	for (int a = 0; a &lt; teamHandler-&gt;ActiveAllyTeams(); ++a) {
 		radarMaps[a].resize(size, 0);
 		sonarMaps[a].resize(size, 0);
 		seismicMaps[a].resize(size, 0);

Modified: trunk/rts/Sim/Misc/Team.cpp
===================================================================
--- trunk/rts/Sim/Misc/Team.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Sim/Misc/Team.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -6,11 +6,12 @@
 #include &quot;mmgr.h&quot;
 
 #include &quot;Team.h&quot;
+#include &quot;TeamHandler.h&quot;
 
 #include &quot;Messages.h&quot;
 #include &quot;GlobalSynced.h&quot;
 #include &quot;LogOutput.h&quot;
-#include &quot;Game/Player.h&quot;
+#include &quot;Game/PlayerHandler.h&quot;
 #include &quot;GlobalUnsynced.h&quot;
 #include &quot;Game/UI/LuaUI.h&quot;
 #include &quot;Lua/LuaRules.h&quot;
@@ -224,7 +225,7 @@
 
 void CTeam::GiveEverythingTo(const unsigned toTeam)
 {
-	CTeam* target = gs-&gt;Team(toTeam);
+	CTeam* target = teamHandler-&gt;Team(toTeam);
 
 	if (!target) {
 		logOutput.Print(&quot;Team %i didn't exists, can't give units&quot;, toTeam);
@@ -253,9 +254,10 @@
 
 void CTeam::Died()
 {
+	// TODO: event based
 	if (leader &gt;= 0) {
 		logOutput.Print(CMessages::Tr(&quot;Team%i(%s) is no more&quot;).c_str(),
-		                teamNum, gs-&gt;players[leader]-&gt;name.c_str());
+		                teamNum, playerHandler-&gt;Player(leader)-&gt;name.c_str());
 	} else {
 		logOutput.Print(CMessages::Tr(&quot;Team%i is no more&quot;).c_str(), teamNum);
 	}
@@ -265,8 +267,8 @@
 	net-&gt;Send(CBaseNetProtocol::Get().SendTeamDied(gu-&gt;myPlayerNum, teamNum));
 
 	for (int a = 0; a &lt; MAX_PLAYERS; ++a) {
-		if (gs-&gt;players[a]-&gt;active &amp;&amp; (gs-&gt;players[a]-&gt;team == teamNum)) {
-			gs-&gt;players[a]-&gt;StartSpectating();
+		if (playerHandler-&gt;Player(a)-&gt;active &amp;&amp; (playerHandler-&gt;Player(a)-&gt;team == teamNum)) {
+			playerHandler-&gt;Player(a)-&gt;StartSpectating();
 		}
 	}
 	if (globalAI-&gt;ais[teamNum]) {
@@ -275,7 +277,7 @@
 	}
 
 	CLuaUI::UpdateTeams();
-  CPlayer::UpdateControlledTeams();
+	CPlayer::UpdateControlledTeams();
 	eventHandler.TeamDied(teamNum);
 }
 
@@ -326,9 +328,9 @@
 	currentStats.energyUsed += prevEnergyUpkeep + prevEnergyExpense;
 
 	float eShare = 0.0f, mShare = 0.0f;
-	for (int a = 0; a &lt; gs-&gt;activeTeams; ++a) {
-		if ((a != teamNum) &amp;&amp; (gs-&gt;AllyTeam(teamNum) == gs-&gt;AllyTeam(a))) {
-			CTeam* team = gs-&gt;Team(a);
+	for (int a = 0; a &lt; teamHandler-&gt;ActiveTeams(); ++a) {
+		if ((a != teamNum) &amp;&amp; (teamHandler-&gt;AllyTeam(teamNum) == teamHandler-&gt;AllyTeam(a))) {
+			CTeam* team = teamHandler-&gt;Team(a);
 			eShare += std::max(0.0f, (team-&gt;energyStorage * 0.99f) - team-&gt;energy);
 			mShare += std::max(0.0f, (team-&gt;metalStorage  * 0.99f) - team-&gt;metal);
 		}
@@ -349,9 +351,9 @@
 	if (mShare &gt; 0.0f) {
 		dm = std::min(1.0f, mExcess/mShare);
 	}
-	for (int a = 0; a &lt; gs-&gt;activeTeams; ++a) {
-		if ((a != teamNum) &amp;&amp; (gs-&gt;AllyTeam(teamNum) == gs-&gt;AllyTeam(a))) {
-			CTeam* team = gs-&gt;Team(a);
+	for (int a = 0; a &lt; teamHandler-&gt;ActiveTeams(); ++a) {
+		if ((a != teamNum) &amp;&amp; (teamHandler-&gt;AllyTeam(teamNum) == teamHandler-&gt;AllyTeam(a))) {
+			CTeam* team = teamHandler-&gt;Team(a);
 
 			const float edif = std::max(0.0f, (team-&gt;energyStorage * 0.99f) - team-&gt;energy) * de;
 			energy -= edif;

Added: trunk/rts/Sim/Misc/TeamHandler.cpp
===================================================================
--- trunk/rts/Sim/Misc/TeamHandler.cpp	                        (rev 0)
+++ trunk/rts/Sim/Misc/TeamHandler.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -0,0 +1,125 @@
+/* Author: Tobi Vollebregt */
+
+/* based on code from GlobalSynced.{cpp,h} */
+
+#include &quot;StdAfx.h&quot;
+#include &quot;TeamHandler.h&quot;
+#include &quot;Game/GameSetup.h&quot;
+#include &quot;Lua/LuaGaia.h&quot;
+#include &quot;mmgr.h&quot;
+
+CR_BIND(CTeamHandler,);
+
+CR_REG_METADATA(CTeamHandler, (
+	CR_MEMBER(gaiaTeamID),
+	CR_MEMBER(gaiaAllyTeamID),
+	CR_MEMBER(activeTeams),
+	CR_MEMBER(activeAllyTeams),
+	CR_MEMBER(allies),
+	CR_MEMBER(team2allyteam),
+	CR_MEMBER(teams),
+	CR_RESERVED(64)
+));
+
+
+CTeamHandler* teamHandler;
+
+
+CTeamHandler::CTeamHandler()
+{
+	gaiaTeamID = -1;
+	gaiaAllyTeamID = -1;
+
+	for(int a = 0; a &lt; MAX_TEAMS; ++a) {
+		teams[a].teamNum = a;
+		team2allyteam[a] = a;
+	}
+
+	for (int a = 0; a &lt; MAX_TEAMS; ++a) {
+		for (int b = 0; b &lt; MAX_TEAMS; ++b) {
+			allies[a][b] = false;
+		}
+		allies[a][a] = true;
+	}
+
+	activeTeams = 2;
+	activeAllyTeams = 2;
+}
+
+
+CTeamHandler::~CTeamHandler()
+{
+}
+
+
+void CTeamHandler::LoadFromSetup(const CGameSetup* setup)
+{
+	const bool useLuaGaia  = CLuaGaia::SetConfigString(setup-&gt;luaGaiaStr);
+
+	activeTeams = setup-&gt;numTeams;
+	activeAllyTeams = setup-&gt;numAllyTeams;
+
+	assert(activeTeams &lt;= MAX_TEAMS);
+	assert(activeAllyTeams &lt;= MAX_TEAMS);
+
+	for (int i = 0; i &lt; activeTeams; ++i) {
+		// TODO: this loop body could use some more refactoring
+		CTeam* team = Team(i);
+		const CGameSetup::TeamData&amp; teamStartingData = setup-&gt;teamStartingData[i];
+
+		team-&gt;metal = setup-&gt;startMetal;
+		team-&gt;metalIncome = setup-&gt;startMetal; // for the endgame statistics
+
+		team-&gt;energy = setup-&gt;startEnergy;
+		team-&gt;energyIncome = setup-&gt;startEnergy;
+
+		float3 start(teamStartingData.startPos.x, teamStartingData.startPos.y, teamStartingData.startPos.z);
+		team-&gt;StartposMessage(start, (setup-&gt;startPosType != CGameSetup::StartPos_ChooseInGame));
+		std::memcpy(team-&gt;color, teamStartingData.color, 4);
+		team-&gt;handicap = teamStartingData.handicap;
+		team-&gt;leader = teamStartingData.leader;
+		team-&gt;side = teamStartingData.side;
+		SetAllyTeam(i, teamStartingData.teamAllyteam);
+
+		if (!teamStartingData.aiDll.empty()) {
+			if (teamStartingData.aiDll.substr(0, 6) == &quot;LuaAI:&quot;) { // its a LuaAI
+				team-&gt;luaAI = teamStartingData.aiDll.substr(6);
+				team-&gt;isAI = true;
+			}
+			else { // no LuaAI
+				if (setup-&gt;hostDemo) // in demo replay, we don't need AI's to load again
+					team-&gt;dllAI = &quot;&quot;;
+				else {
+					team-&gt;dllAI = teamStartingData.aiDll;
+					team-&gt;isAI = true;
+				}
+			}
+		}
+	}
+
+	for (int allyTeam1 = 0; allyTeam1 &lt; activeAllyTeams; ++allyTeam1)
+	{
+		for (int allyTeam2 = 0; allyTeam2 &lt; activeAllyTeams; ++allyTeam2)
+			allies[allyTeam1][allyTeam2] = setup-&gt;allyStartingData[allyTeam1].allies[allyTeam2];
+	}
+
+	if (useLuaGaia) {
+		// Gaia adjustments
+		gaiaTeamID = activeTeams;
+		gaiaAllyTeamID = activeAllyTeams;
+		activeTeams++;
+		activeAllyTeams++;
+
+		// Setup the gaia team
+		CTeam* team = Team(gaiaTeamID);
+		team-&gt;color[0] = 255;
+		team-&gt;color[1] = 255;
+		team-&gt;color[2] = 255;
+		team-&gt;color[3] = 255;
+		team-&gt;gaia = true;
+		team-&gt;StartposMessage(float3(0.0, 0.0, 0.0), true);
+		//players[setup-&gt;numPlayers]-&gt;team = gaiaTeamID;
+		SetAllyTeam(gaiaTeamID, gaiaAllyTeamID);
+	}
+}
+

Added: trunk/rts/Sim/Misc/TeamHandler.h
===================================================================
--- trunk/rts/Sim/Misc/TeamHandler.h	                        (rev 0)
+++ trunk/rts/Sim/Misc/TeamHandler.h	2008-11-12 22:26:06 UTC (rev 7026)
@@ -0,0 +1,149 @@
+/* Author: Tobi Vollebregt */
+
+/* based on code from GlobalSynced.{cpp,h} */
+
+#ifndef TEAMHANDLER_H
+#define TEAMHANDLER_H
+
+#include &quot;creg/creg.h&quot;
+#include &quot;Team.h&quot;
+
+class CGameSetup;
+
+
+/** @brief Handles teams and allyteams */
+class CTeamHandler
+{
+public:
+	CR_DECLARE(CTeamHandler);
+
+	CTeamHandler();
+	~CTeamHandler();
+
+	void LoadFromSetup(const CGameSetup* setup);
+
+	// from CGlobalSynced:
+
+	/**
+	 * @brief Team
+	 * @param i index to fetch
+	 * @return CTeam pointer
+	 *
+	 * Accesses a CTeam instance at a given index
+	 */
+	CTeam* Team(int i) { return &amp;teams[i]; }
+
+	/**
+	 * @brief ally
+	 * @param a first allyteam
+	 * @param b second allyteam
+	 * @return allies[a][b]
+	 *
+	 * Returns ally at [a][b]
+	 */
+	bool Ally(int a, int b) { return allies[a][b]; }
+
+	/**
+	 * @brief ally team
+	 * @param team team to find
+	 * @return the ally team
+	 *
+	 * returns the team2ally at given index
+	 */
+	int AllyTeam(int team) { return team2allyteam[team]; }
+
+	/**
+	 * @brief allied teams
+	 * @param a first team
+	 * @param b second team
+	 * @return whether teams are allied
+	 *
+	 * Tests whether teams are allied
+	 */
+	bool AlliedTeams(int a, int b) { return allies[team2allyteam[a]][team2allyteam[b]]; }
+
+	/**
+	 * @brief set ally team
+	 * @param team team to set
+	 * @param allyteam allyteam to set
+	 *
+	 * Sets team's ally team
+	 */
+	void SetAllyTeam(int team, int allyteam) { team2allyteam[team] = allyteam; }
+
+	/**
+	 * @brief set ally
+	 * @param allyteamA first allyteam
+	 * @param allyteamB second allyteam
+	 * @param allied whether or not these two teams are allied
+	 *
+	 * Sets two allyteams to be allied or not
+	 */
+	void SetAlly(int allyteamA, int allyteamB, bool allied) { allies[allyteamA][allyteamB] = allied; }
+
+	// accessors
+
+	int GaiaTeamID() const { return gaiaTeamID; }
+	int GaiaAllyTeamID() const { return gaiaAllyTeamID; }
+
+	int ActiveTeams() const { return activeTeams; }
+	int ActiveAllyTeams() const { return activeAllyTeams; }
+
+private:
+
+	/**
+	 * @brief gaia team
+	 *
+	 * gaia's team id
+	 */
+	int gaiaTeamID;
+
+	/**
+	 * @brief gaia team
+	 *
+	 * gaia's team id
+	 */
+	int gaiaAllyTeamID;
+
+	/**
+	 * @brief active teams
+	 *
+	 * The number of active teams
+	 * (don't change during play)
+	 */
+	int activeTeams;
+
+	/**
+	 * @brief active ally teams
+	 *
+	 * The number of active ally teams
+	 */
+	int activeAllyTeams;
+
+	/**
+	 * @brief allies array
+	 *
+	 * Array indicates whether teams are allied,
+	 * allies[a][b] means allyteam a is allied with
+	 * allyteam b, NOT the other way around
+	 */
+	bool allies[MAX_TEAMS][MAX_TEAMS];
+
+	/**
+	 * @brief team to ally team
+	 *
+	 * Array stores what ally team a specific team is part of
+	 */
+	int team2allyteam[MAX_TEAMS];
+
+	/**
+	 * @brief teams
+	 *
+	 * Array of CTeam instances for teams in game
+	 */
+	CTeam teams[MAX_TEAMS];
+};
+
+extern CTeamHandler* teamHandler;
+
+#endif // !TEAMHANDLER_H

Modified: trunk/rts/Sim/MoveTypes/GroundMoveType.cpp
===================================================================
--- trunk/rts/Sim/MoveTypes/GroundMoveType.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Sim/MoveTypes/GroundMoveType.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -21,6 +21,7 @@
 #include &quot;Sim/Misc/LosHandler.h&quot;
 #include &quot;Sim/Misc/QuadField.h&quot;
 #include &quot;Sim/Misc/RadarHandler.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Path/PathManager.h&quot;
 #include &quot;Sim/Units/COB/CobFile.h&quot;
 #include &quot;Sim/Units/COB/CobInstance.h&quot;
@@ -1523,7 +1524,7 @@
 
 					const int uAllyTeam = u-&gt;allyteam;
 					const int oAllyTeam = owner-&gt;allyteam;
-					const bool allied = (gs-&gt;Ally(uAllyTeam, oAllyTeam) || gs-&gt;Ally(oAllyTeam, uAllyTeam));
+					const bool allied = (teamHandler-&gt;Ally(uAllyTeam, oAllyTeam) || teamHandler-&gt;Ally(oAllyTeam, uAllyTeam));
 
 					if (!u-&gt;unitDef-&gt;pushResistant &amp;&amp; !u-&gt;usingScriptMoveType &amp;&amp; allied) {
 						// push the blocking unit out of the way
@@ -1608,7 +1609,7 @@
 
 					const int uAllyTeam = u-&gt;allyteam;
 					const int oAllyTeam = owner-&gt;allyteam;
-					const bool allied = (gs-&gt;Ally(uAllyTeam, oAllyTeam) || gs-&gt;Ally(oAllyTeam, uAllyTeam));
+					const bool allied = (teamHandler-&gt;Ally(uAllyTeam, oAllyTeam) || teamHandler-&gt;Ally(oAllyTeam, uAllyTeam));
 
 					if (!u-&gt;unitDef-&gt;pushResistant &amp;&amp; !u-&gt;usingScriptMoveType &amp;&amp; allied) {
 						// push the blocking unit out of the way

Modified: trunk/rts/Sim/Projectiles/ProjectileHandler.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/ProjectileHandler.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Sim/Projectiles/ProjectileHandler.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -30,6 +30,7 @@
 #include &quot;Sim/Misc/CollisionVolume.h&quot;
 #include &quot;Sim/Misc/LosHandler.h&quot;
 #include &quot;Sim/Misc/QuadField.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Unsynced/ShieldPartProjectile.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
@@ -586,7 +587,7 @@
 		pro-&gt;UpdateDrawPos();
 
 		if (camera-&gt;InView(pro-&gt;pos, pro-&gt;drawRadius) &amp;&amp; (gu-&gt;spectatingFullView || loshandler-&gt;InLos(pro, gu-&gt;myAllyTeam) ||
-			(pro-&gt;owner &amp;&amp; gs-&gt;Ally(pro-&gt;owner-&gt;allyteam, gu-&gt;myAllyTeam)))) {
+			(pro-&gt;owner &amp;&amp; teamHandler-&gt;Ally(pro-&gt;owner-&gt;allyteam, gu-&gt;myAllyTeam)))) {
 
 			CUnit* owner = pro-&gt;owner;
 			CUnit* trans = owner? (CUnit*) owner-&gt;GetTransporter(): 0;
@@ -680,7 +681,7 @@
 
 	for (psi = ps.begin(); psi != ps.end(); ++psi) {
 		if ((gu-&gt;spectatingFullView || loshandler-&gt;InLos(*psi, gu-&gt;myAllyTeam) ||
-			((*psi)-&gt;owner &amp;&amp; gs-&gt;Ally((*psi)-&gt;owner-&gt;allyteam, gu-&gt;myAllyTeam)))) {
+			((*psi)-&gt;owner &amp;&amp; teamHandler-&gt;Ally((*psi)-&gt;owner-&gt;allyteam, gu-&gt;myAllyTeam)))) {
 
 			if ((*psi)-&gt;s3domodel)
 				(*psi)-&gt;DrawUnitPart();

Modified: trunk/rts/Sim/Units/COB/CobInstance.cpp
===================================================================
--- trunk/rts/Sim/Units/COB/CobInstance.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Sim/Units/COB/CobInstance.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -18,6 +18,7 @@
 #include &quot;Sim/Misc/GroundBlockingObjectMap.h&quot;
 #include &quot;Sim/Misc/LosHandler.h&quot;
 #include &quot;Sim/Misc/RadarHandler.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/MoveTypes/AirMoveType.h&quot;
 #include &quot;Sim/MoveTypes/MoveType.h&quot;
 #include &quot;Sim/Projectiles/ExplosionGenerator.h&quot;
@@ -1100,7 +1101,7 @@
 		return u ? unit-&gt;team : 0; }
 	case UNIT_ALLIED:{
 		CUnit *u = (p1 &gt;= 0 &amp;&amp; p1 &lt; MAX_UNITS) ? uh-&gt;units[p1] : NULL;
-		if (u) return gs-&gt;Ally (unit-&gt;allyteam, u-&gt;allyteam) ? 1 : 0;
+		if (u) return teamHandler-&gt;Ally (unit-&gt;allyteam, u-&gt;allyteam) ? 1 : 0;
 		return 0;}
 	case UNIT_BUILD_PERCENT_LEFT:{
 		CUnit *u = (p1 &gt;= 0 &amp;&amp; p1 &lt; MAX_UNITS) ? uh-&gt;units[p1] : NULL;
@@ -1379,7 +1380,7 @@
 		}
 	}
 	case GAME_FRAME: {
-		return gs-&gt;frameNum;	                 		
+		return gs-&gt;frameNum;
 	}
 	default:
 		if ((val &gt;= GLOBAL_VAR_START) &amp;&amp; (val &lt;= GLOBAL_VAR_END)) {

Modified: trunk/rts/Sim/Units/CommandAI/AirCAI.cpp
===================================================================
--- trunk/rts/Sim/Units/CommandAI/AirCAI.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Sim/Units/CommandAI/AirCAI.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -10,6 +10,7 @@
 #include &quot;Map/Ground.h&quot;
 #include &quot;Rendering/GL/glExtra.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/MoveTypes/AirMoveType.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
@@ -55,7 +56,7 @@
 		c.tooltip=&quot;Sets the aircraft to attack enemy units within a circle&quot;;
 		possibleCommands.push_back(c);
 	}
-	
+
 	if(owner-&gt;unitDef-&gt;canLoopbackAttack){
 		c.params.clear();
 		c.id=CMD_LOOPBACKATTACK;
@@ -259,7 +260,7 @@
 	if (c.id == CMD_WAIT) {
 		if ((myPlane-&gt;aircraftState == AAirMoveType::AIRCRAFT_FLYING)
 		    &amp;&amp; !owner-&gt;unitDef-&gt;DontLand() &amp;&amp; myPlane-&gt;autoLand) {
-			StopMove(); 
+			StopMove();
 //			myPlane-&gt;SetState(AAirMoveType::AIRCRAFT_LANDING);
 		}
 		return;
@@ -597,7 +598,7 @@
 int CAirCAI::GetDefaultCmd(CUnit* pointed, CFeature* feature)
 {
 	if (pointed) {
-		if (!gs-&gt;Ally(gu-&gt;myAllyTeam, pointed-&gt;allyteam)) {
+		if (!teamHandler-&gt;Ally(gu-&gt;myAllyTeam, pointed-&gt;allyteam)) {
 			if (owner-&gt;unitDef-&gt;canAttack) {
 				return CMD_ATTACK;
 			}

Modified: trunk/rts/Sim/Units/CommandAI/BuilderCAI.cpp
===================================================================
--- trunk/rts/Sim/Units/CommandAI/BuilderCAI.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Sim/Units/CommandAI/BuilderCAI.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -25,6 +25,7 @@
 #include &quot;Sim/Features/FeatureHandler.h&quot;
 #include &quot;Sim/Misc/GroundBlockingObjectMap.h&quot;
 #include &quot;Sim/Misc/QuadField.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/MoveTypes/MoveType.h&quot;
 #include &quot;Sim/Units/UnitSet.h&quot;
 #include &quot;Sim/Units/UnitDefHandler.h&quot;
@@ -416,7 +417,7 @@
 						if (luaRules &amp;&amp; !luaRules-&gt;AllowUnitCreation(build.def, owner, &amp;build.pos)) {
 							FinishCommand();
 						}
-						else if (uh-&gt;maxUnits &gt; (int) gs-&gt;Team(owner-&gt;team)-&gt;units.size()) {
+						else if (uh-&gt;maxUnits &gt; (int) teamHandler-&gt;Team(owner-&gt;team)-&gt;units.size()) {
 							// max unitlimit reached
 							buildRetries++;
 							owner-&gt;moveType-&gt;KeepPointingTo(build.pos, fac-&gt;buildDistance * 0.7f + radius, false);
@@ -956,7 +957,7 @@
 int CBuilderCAI::GetDefaultCmd(CUnit* pointed, CFeature* feature)
 {
 	if (pointed) {
-		if (!gs-&gt;Ally(gu-&gt;myAllyTeam, pointed-&gt;allyteam)) {
+		if (!teamHandler-&gt;Ally(gu-&gt;myAllyTeam, pointed-&gt;allyteam)) {
 			if (owner-&gt;unitDef-&gt;canAttack &amp;&amp; (owner-&gt;maxRange &gt; 0)) {
 				return CMD_ATTACK;
 			} else if (owner-&gt;unitDef-&gt;canReclaim &amp;&amp; pointed-&gt;unitDef-&gt;reclaimable) {
@@ -1039,7 +1040,7 @@
 		}
 
 		const int cmdUnitId = (int)c.params[0];
-		if (cmdUnitId == unit-&gt;id &amp;&amp; gs-&gt;Ally(unit-&gt;team, (*it)-&gt;team)) {
+		if (cmdUnitId == unit-&gt;id &amp;&amp; teamHandler-&gt;Ally(unit-&gt;team, (*it)-&gt;team)) {
 			retval = true;
 			break;
 		}
@@ -1116,7 +1117,7 @@
 
 	const CFeature* best = NULL;
 	float bestDist = 1.0e30f;
-	const CTeam* team = gs-&gt;Team(owner-&gt;team);
+	const CTeam* team = teamHandler-&gt;Team(owner-&gt;team);
 
 	for (fi = features.begin(); fi != features.end(); ++fi) {
 		const CFeature* f = *fi;
@@ -1204,7 +1205,7 @@
 	for (ui = cu.begin(); ui != cu.end(); ++ui) {
 		CUnit* unit = *ui;
 
-		if (!gs-&gt;Ally(myAllyteam, unit-&gt;allyteam) &amp;&amp; (unit != owner) &amp;&amp;
+		if (!teamHandler-&gt;Ally(myAllyteam, unit-&gt;allyteam) &amp;&amp; (unit != owner) &amp;&amp;
 			!unit-&gt;beingBuilt &amp;&amp; unit-&gt;unitDef-&gt;capturable) {
 			const float dist = f3SqLen(unit-&gt;pos - owner-&gt;pos);
 
@@ -1246,7 +1247,7 @@
 
 	for (ui = cu.begin(); ui != cu.end(); ++ui) {
 		CUnit* unit = *ui;
-		if (gs-&gt;Ally(owner-&gt;allyteam, unit-&gt;allyteam)) {
+		if (teamHandler-&gt;Ally(owner-&gt;allyteam, unit-&gt;allyteam)) {
 			if (!haveEnemy &amp;&amp; (unit-&gt;health &lt; unit-&gt;maxHealth)) {
 				// dont lock-on to units outside of our reach (for immobile builders)
 				if (!owner-&gt;unitDef-&gt;canmove &amp;&amp; !ObjInBuildRange(unit)) {
@@ -1336,7 +1337,7 @@
 {
 	if(uh-&gt;limitDgun &amp;&amp; owner-&gt;unitDef-&gt;isCommander) {
 		glColor4f(1.0f, 1.0f, 1.0f, 0.6f);
-		glSurfaceCircle(gs-&gt;Team(owner-&gt;team)-&gt;startPos, uh-&gt;dgunRadius, 40);
+		glSurfaceCircle(teamHandler-&gt;Team(owner-&gt;team)-&gt;startPos, uh-&gt;dgunRadius, 40);
 	}
 
 	lineDrawer.StartPath(owner-&gt;midPos, cmdColors.start);

Modified: trunk/rts/Sim/Units/CommandAI/CommandAI.cpp
===================================================================
--- trunk/rts/Sim/Units/CommandAI/CommandAI.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Sim/Units/CommandAI/CommandAI.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -8,7 +8,6 @@
 #include &quot;ExternalAI/Group.h&quot;
 #include &quot;Game/GameHelper.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
 #include &quot;Game/WaitCommandsAI.h&quot;
 #include &quot;Game/UI/CommandColors.h&quot;
 #include &quot;Game/UI/CursorIcons.h&quot;
@@ -18,6 +17,7 @@
 #include &quot;Map/Ground.h&quot;
 #include &quot;Sim/Features/Feature.h&quot;
 #include &quot;Sim/Features/FeatureHandler.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/MoveTypes/MoveType.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;Sim/Units/UnitDefHandler.h&quot;
@@ -370,7 +370,7 @@
 	const UnitDef* ud = owner-&gt;unitDef;
 	int maxHeightDiff = SQUARE_SIZE;
 	// AI's may do as they like
-	bool aiOrder = (gs-&gt;Team(owner-&gt;team) &amp;&amp; gs-&gt;Team(owner-&gt;team)-&gt;isAI);
+	bool aiOrder = (teamHandler-&gt;Team(owner-&gt;team) &amp;&amp; teamHandler-&gt;Team(owner-&gt;team)-&gt;isAI);
 
 	switch (c.id) {
 		case CMD_DGUN:
@@ -1224,7 +1224,7 @@
 int CCommandAI::GetDefaultCmd(CUnit* pointed, CFeature* feature)
 {
 	if (pointed) {
-		if (!gs-&gt;Ally(gu-&gt;myAllyTeam, pointed-&gt;allyteam)) {
+		if (!teamHandler-&gt;Ally(gu-&gt;myAllyTeam, pointed-&gt;allyteam)) {
 			if (isAttackCapable()) {
 				return CMD_ATTACK;
 			}

Modified: trunk/rts/Sim/Units/CommandAI/FactoryCAI.cpp
===================================================================
--- trunk/rts/Sim/Units/CommandAI/FactoryCAI.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Sim/Units/CommandAI/FactoryCAI.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -7,7 +7,6 @@
 #include &quot;Sim/Misc/GlobalSynced.h&quot;
 #include &quot;Game/GameHelper.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
 #include &quot;Game/WaitCommandsAI.h&quot;
 #include &quot;Game/UI/CommandColors.h&quot;
 #include &quot;Game/UI/CursorIcons.h&quot;
@@ -15,6 +14,7 @@
 #include &quot;Rendering/GL/glExtra.h&quot;
 #include &quot;Rendering/UnitModels/UnitDrawer.h&quot;
 #include &quot;Lua/LuaRules.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
 #include &quot;Sim/Units/UnitLoader.h&quot;
 #include &quot;Sim/Units/UnitDefHandler.h&quot;
@@ -386,7 +386,7 @@
 				else if(uh-&gt;unitsByDefs[owner-&gt;team][def-&gt;id].size() &gt;= def-&gt;maxThisUnit){ //unit restricted?
 					CancelRestrictedUnit(c, boi-&gt;second);
 				}
-				else if(uh-&gt;maxUnits&gt;gs-&gt;Team(owner-&gt;team)-&gt;units.size()){  //max unitlimit reached?
+				else if(uh-&gt;maxUnits&gt;teamHandler-&gt;Team(owner-&gt;team)-&gt;units.size()){  //max unitlimit reached?
 					fac-&gt;StartBuild(boi-&gt;second.fullName);
 					building=true;
 				}
@@ -423,7 +423,7 @@
 int CFactoryCAI::GetDefaultCmd(CUnit* pointed, CFeature* feature)
 {
 	if (pointed) {
-		if (gs-&gt;Ally(gu-&gt;myAllyTeam, pointed-&gt;allyteam)) {
+		if (teamHandler-&gt;Ally(gu-&gt;myAllyTeam, pointed-&gt;allyteam)) {
 			if (owner-&gt;unitDef-&gt;canGuard) {
 				return CMD_GUARD;
 			}

Modified: trunk/rts/Sim/Units/CommandAI/MobileCAI.cpp
===================================================================
--- trunk/rts/Sim/Units/CommandAI/MobileCAI.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Sim/Units/CommandAI/MobileCAI.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -7,11 +7,11 @@
 #include &quot;ExternalAI/Group.h&quot;
 #include &quot;Game/GameHelper.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
 #include &quot;Game/UI/CommandColors.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;Sim/Misc/AirBaseHandler.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/MoveTypes/MoveType.h&quot;
 #include &quot;Sim/MoveTypes/TAAirMoveType.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
@@ -633,7 +633,7 @@
 void CMobileCAI::ExecuteDGun(Command &amp;c)
 {
 	if (uh-&gt;limitDgun &amp;&amp; owner-&gt;unitDef-&gt;isCommander
-			&amp;&amp; owner-&gt;pos.SqDistance(gs-&gt;Team(owner-&gt;team)-&gt;startPos) &gt; Square(uh-&gt;dgunRadius)) {
+			&amp;&amp; owner-&gt;pos.SqDistance(teamHandler-&gt;Team(owner-&gt;team)-&gt;startPos) &gt; Square(uh-&gt;dgunRadius)) {
 		StopMove();
 		return FinishCommand();
 	}
@@ -878,7 +878,7 @@
 int CMobileCAI::GetDefaultCmd(CUnit* pointed, CFeature* feature)
 {
 	if (pointed) {
-		if (!gs-&gt;Ally(gu-&gt;myAllyTeam,pointed-&gt;allyteam)) {
+		if (!teamHandler-&gt;Ally(gu-&gt;myAllyTeam,pointed-&gt;allyteam)) {
 			if (owner-&gt;unitDef-&gt;canAttack) {
 				return CMD_ATTACK;
 			}

Modified: trunk/rts/Sim/Units/CommandAI/TransportCAI.cpp
===================================================================
--- trunk/rts/Sim/Units/CommandAI/TransportCAI.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Sim/Units/CommandAI/TransportCAI.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -3,6 +3,7 @@
 
 #include &quot;TransportCAI.h&quot;
 #include &quot;LineDrawer.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/COB/CobInstance.h&quot;
@@ -281,7 +282,7 @@
 	if(unit-&gt;mass&gt;=100000 || unit-&gt;beingBuilt)
 		return false;
 	// don't transport cloaked enemies
-	if (unit-&gt;isCloaked &amp;&amp; !gs-&gt;AlliedTeams(unit-&gt;team, owner-&gt;team))
+	if (unit-&gt;isCloaked &amp;&amp; !teamHandler-&gt;AlliedTeams(unit-&gt;team, owner-&gt;team))
 		return false;
 	if(unit-&gt;xsize &gt; owner-&gt;unitDef-&gt;transportSize*2)
 		return false;
@@ -880,7 +881,7 @@
 int CTransportCAI::GetDefaultCmd(CUnit* pointed, CFeature* feature)
 {
 	if (pointed) {
-		if (!gs-&gt;Ally(gu-&gt;myAllyTeam, pointed-&gt;allyteam)) {
+		if (!teamHandler-&gt;Ally(gu-&gt;myAllyTeam, pointed-&gt;allyteam)) {
 			if (owner-&gt;unitDef-&gt;canAttack) {
 				return CMD_ATTACK;
 			} else if (CanTransport(pointed)) {

Modified: trunk/rts/Sim/Units/Unit.cpp
===================================================================
--- trunk/rts/Sim/Units/Unit.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Sim/Units/Unit.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -17,7 +17,6 @@
 #include &quot;Game/GameSetup.h&quot;
 #include &quot;Game/Player.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
 #include &quot;Game/UI/MiniMap.h&quot;
 #include &quot;Lua/LuaRules.h&quot;
 #include &quot;Map/Ground.h&quot;
@@ -36,6 +35,7 @@
 #include &quot;Sim/Misc/LosHandler.h&quot;
 #include &quot;Sim/Misc/QuadField.h&quot;
 #include &quot;Sim/Misc/RadarHandler.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Misc/Wind.h&quot;
 #include &quot;Sim/Misc/ModInfo.h&quot;
 #include &quot;Sim/MoveTypes/AirMoveType.h&quot;
@@ -314,17 +314,17 @@
 
 void CUnit::SetMetalStorage(float newStorage)
 {
-	gs-&gt;Team(team)-&gt;metalStorage-=metalStorage;
+	teamHandler-&gt;Team(team)-&gt;metalStorage-=metalStorage;
 	metalStorage = newStorage;
-	gs-&gt;Team(team)-&gt;metalStorage+=metalStorage;
+	teamHandler-&gt;Team(team)-&gt;metalStorage+=metalStorage;
 }
 
 
 void CUnit::SetEnergyStorage(float newStorage)
 {
-	gs-&gt;Team(team)-&gt;energyStorage-=energyStorage;
+	teamHandler-&gt;Team(team)-&gt;energyStorage-=energyStorage;
 	energyStorage = newStorage;
-	gs-&gt;Team(team)-&gt;energyStorage+=energyStorage;
+	teamHandler-&gt;Team(team)-&gt;energyStorage+=energyStorage;
 }
 
 
@@ -332,7 +332,7 @@
 {
 	pos = position;
 	team = Team;
-	allyteam = gs-&gt;AllyTeam(Team);
+	allyteam = teamHandler-&gt;AllyTeam(Team);
 	lineage = Team;
 	unitDef = def;
 	unitDefName = unitDef-&gt;name;
@@ -677,7 +677,7 @@
 		nextPosErrorUpdate = 16;
 	}
 
-	for (int at = 0; at &lt; gs-&gt;activeAllyTeams; ++at) {
+	for (int at = 0; at &lt; teamHandler-&gt;ActiveAllyTeams(); ++at) {
 		UpdateLosStatus(at);
 	}
 
@@ -1005,9 +1005,9 @@
 			// Dont log overkill damage (so dguns/nukes etc dont inflate values)
 			const float statsdamage = std::max(0.0f, std::min(maxHealth - health, damage));
 			if (attacker) {
-				gs-&gt;Team(attacker-&gt;team)-&gt;currentStats.damageDealt += statsdamage;
+				teamHandler-&gt;Team(attacker-&gt;team)-&gt;currentStats.damageDealt += statsdamage;
 			}
-			gs-&gt;Team(team)-&gt;currentStats.damageReceived += statsdamage;
+			teamHandler-&gt;Team(team)-&gt;currentStats.damageReceived += statsdamage;
 			health -= damage;
 		}
 		else { // healing
@@ -1054,7 +1054,7 @@
 
 	if (damage &gt; 0.0f) {
 		recentDamage += damage;
-		if ((attacker != NULL) &amp;&amp; !gs-&gt;Ally(allyteam, attacker-&gt;allyteam)) {
+		if ((attacker != NULL) &amp;&amp; !teamHandler-&gt;Ally(allyteam, attacker-&gt;allyteam)) {
 			attacker-&gt;AddExperience(0.1f * experienceMod
 			                             * (power / attacker-&gt;power)
 			                             * (damage + std::min(0.0f, health)) / maxHealth);
@@ -1094,9 +1094,9 @@
 	if (health &lt;= 0.0f) {
 		KillUnit(false, false, attacker);
 		if (isDead &amp;&amp; (attacker != 0) &amp;&amp;
-		    !gs-&gt;Ally(allyteam, attacker-&gt;allyteam) &amp;&amp; !beingBuilt) {
+		    !teamHandler-&gt;Ally(allyteam, attacker-&gt;allyteam) &amp;&amp; !beingBuilt) {
 			attacker-&gt;AddExperience(expMultiplier * 0.1f * (power / attacker-&gt;power));
-			gs-&gt;Team(attacker-&gt;team)-&gt;currentStats.unitsKilled++;
+			teamHandler-&gt;Team(attacker-&gt;team)-&gt;currentStats.unitsKilled++;
 		}
 	}
 //	if(attacker!=0 &amp;&amp; attacker-&gt;team==team)
@@ -1115,7 +1115,7 @@
 
 
 void CUnit::UpdateDrawPos() {
-	CTransportUnit *trans=GetTransporter(); 
+	CTransportUnit *trans=GetTransporter();
 #if defined(USE_GML) &amp;&amp; GML_ENABLE_SIMDRAW
 	if (trans) {
 		drawPos = pos + (trans-&gt;speed * ((float)gu-&gt;lastFrameStart - (float)lastUnitUpdate) * gu-&gt;weightedSpeedFactor);
@@ -1256,7 +1256,7 @@
 		                             ph-&gt;seismictex, 30, 15, 0, pingSize, 1,
 		                             float3(0.8f,0.0f,0.0f));
 	}
-	for (int a = 0; a &lt; gs-&gt;activeAllyTeams; ++a) {
+	for (int a = 0; a &lt; teamHandler-&gt;ActiveAllyTeams(); ++a) {
 		if (radarhandler-&gt;InSeismicDistance(this, a)) {
 			const float3 err(errorScale[a] * (0.5f - rx), 0.0f,
 			                 errorScale[a] * (0.5f - rz));
@@ -1312,7 +1312,7 @@
 	globalAI-&gt;UnitTaken(this, oldteam);
 
 	// reset states and clear the queues
-	if (!gs-&gt;AlliedTeams(oldteam, newteam)) {
+	if (!teamHandler-&gt;AlliedTeams(oldteam, newteam)) {
 		ChangeTeamReset();
 	}
 
@@ -1332,28 +1332,28 @@
 	// Sharing commander in com ends game kills you.
 	// Note that this will kill the com too.
 	if (unitDef-&gt;isCommander) {
-		gs-&gt;Team(oldteam)-&gt;CommanderDied(this);
+		teamHandler-&gt;Team(oldteam)-&gt;CommanderDied(this);
 	}
 
 	if (type == ChangeGiven) {
-		gs-&gt;Team(oldteam)-&gt;RemoveUnit(this, CTeam::RemoveGiven);
-		gs-&gt;Team(newteam)-&gt;AddUnit(this,    CTeam::AddGiven);
+		teamHandler-&gt;Team(oldteam)-&gt;RemoveUnit(this, CTeam::RemoveGiven);
+		teamHandler-&gt;Team(newteam)-&gt;AddUnit(this,    CTeam::AddGiven);
 	} else {
-		gs-&gt;Team(oldteam)-&gt;RemoveUnit(this, CTeam::RemoveCaptured);
-		gs-&gt;Team(newteam)-&gt;AddUnit(this,    CTeam::AddCaptured);
+		teamHandler-&gt;Team(oldteam)-&gt;RemoveUnit(this, CTeam::RemoveCaptured);
+		teamHandler-&gt;Team(newteam)-&gt;AddUnit(this,    CTeam::AddCaptured);
 	}
 
 	if (!beingBuilt) {
-		gs-&gt;Team(oldteam)-&gt;metalStorage  -= metalStorage;
-		gs-&gt;Team(oldteam)-&gt;energyStorage -= energyStorage;
+		teamHandler-&gt;Team(oldteam)-&gt;metalStorage  -= metalStorage;
+		teamHandler-&gt;Team(oldteam)-&gt;energyStorage -= energyStorage;
 
-		gs-&gt;Team(newteam)-&gt;metalStorage  += metalStorage;
-		gs-&gt;Team(newteam)-&gt;energyStorage += energyStorage;
+		teamHandler-&gt;Team(newteam)-&gt;metalStorage  += metalStorage;
+		teamHandler-&gt;Team(newteam)-&gt;energyStorage += energyStorage;
 	}
 
 
 	team = newteam;
-	allyteam = gs-&gt;AllyTeam(newteam);
+	allyteam = teamHandler-&gt;AllyTeam(newteam);
 
 	uh-&gt;unitsByDefs[oldteam][unitDef-&gt;id].erase(this);
 	uh-&gt;unitsByDefs[newteam][unitDef-&gt;id].insert(this);
@@ -1493,7 +1493,7 @@
 
 void CUnit::SetLastAttacker(CUnit* attacker)
 {
-	if (gs-&gt;Ally(team, attacker-&gt;team) || gs-&gt;AlliedTeams(team, attacker-&gt;team)) {
+	if (teamHandler-&gt;AlliedTeams(team, attacker-&gt;team)) {
 		return;
 	}
 	if (lastAttacker &amp;&amp; lastAttacker != userTarget)
@@ -1699,8 +1699,8 @@
 
 
 		if (beingBuilt) { //build
-			if ((gs-&gt;Team(builder-&gt;team)-&gt;metal  &gt;= metalUse) &amp;&amp;
-			    (gs-&gt;Team(builder-&gt;team)-&gt;energy &gt;= energyUse) &amp;&amp;
+			if ((teamHandler-&gt;Team(builder-&gt;team)-&gt;metal  &gt;= metalUse) &amp;&amp;
+			    (teamHandler-&gt;Team(builder-&gt;team)-&gt;energy &gt;= energyUse) &amp;&amp;
 			    (!luaRules || luaRules-&gt;AllowUnitBuildStep(builder, this, part))) {
 				if (builder-&gt;UseMetal(metalUse)) { //just because we checked doesn't mean they were deducted since upkeep can prevent deduction
 					if (builder-&gt;UseEnergy(energyUse)) {
@@ -1720,8 +1720,8 @@
 				return true;
 			} else {
 				// update the energy and metal required counts
-				gs-&gt;Team(builder-&gt;team)-&gt;metalPull  += metalUse;
-				gs-&gt;Team(builder-&gt;team)-&gt;energyPull += energyUse;
+				teamHandler-&gt;Team(builder-&gt;team)-&gt;metalPull  += metalUse;
+				teamHandler-&gt;Team(builder-&gt;team)-&gt;energyPull += energyUse;
 			}
 			return false;
 		}
@@ -1729,7 +1729,7 @@
 			const float energyUseScaled = energyUse * modInfo.repairEnergyCostFactor;
 
 	  		if (!builder-&gt;UseEnergy(energyUseScaled)) {
-				gs-&gt;Team(builder-&gt;team)-&gt;energyPull += energyUseScaled;
+				teamHandler-&gt;Team(builder-&gt;team)-&gt;energyPull += energyUseScaled;
 				return false;
 			}
 
@@ -1763,7 +1763,7 @@
 		const float energyUseScaled = energyUse * modInfo.reclaimUnitEnergyCostFactor;
 
 		if (!builder-&gt;UseEnergy(-energyUseScaled)) {
-			gs-&gt;Team(builder-&gt;team)-&gt;energyPull += energyUseScaled;
+			teamHandler-&gt;Team(builder-&gt;team)-&gt;energyPull += energyUseScaled;
 			return false;
 		}
 
@@ -1895,9 +1895,9 @@
 
 	blockHeightChanges = false;
 	if (unitDef-&gt;isCommander) {
-		gs-&gt;Team(team)-&gt;CommanderDied(this);
+		teamHandler-&gt;Team(team)-&gt;CommanderDied(this);
 	}
-	gs-&gt;Team(this-&gt;lineage)-&gt;LeftLineage(this);
+	teamHandler-&gt;Team(this-&gt;lineage)-&gt;LeftLineage(this);
 
 	if (showDeathSequence &amp;&amp; (!reclaimed &amp;&amp; !beingBuilt)) {
 		string exp;
@@ -1976,8 +1976,8 @@
 		AddMetal(-metal);
 		return true;
 	}
-	gs-&gt;Team(team)-&gt;metalPull += metal;
-	bool canUse = gs-&gt;Team(team)-&gt;UseMetal(metal);
+	teamHandler-&gt;Team(team)-&gt;metalPull += metal;
+	bool canUse = teamHandler-&gt;Team(team)-&gt;UseMetal(metal);
 	if (canUse)
 		metalUseI += metal;
 	return canUse;
@@ -1991,7 +1991,7 @@
 		return;
 	}
 	metalMakeI += metal;
-	gs-&gt;Team(team)-&gt;AddMetal(metal, handicap);
+	teamHandler-&gt;Team(team)-&gt;AddMetal(metal, handicap);
 }
 
 
@@ -2001,8 +2001,8 @@
 		AddEnergy(-energy);
 		return true;
 	}
-	gs-&gt;Team(team)-&gt;energyPull += energy;
-	bool canUse = gs-&gt;Team(team)-&gt;UseEnergy(energy);
+	teamHandler-&gt;Team(team)-&gt;energyPull += energy;
+	bool canUse = teamHandler-&gt;Team(team)-&gt;UseEnergy(energy);
 	if (canUse)
 		energyUseI += energy;
 	return canUse;
@@ -2016,7 +2016,7 @@
 		return;
 	}
 	energyMakeI += energy;
-	gs-&gt;Team(team)-&gt;AddEnergy(energy, handicap);
+	teamHandler-&gt;Team(team)-&gt;AddEnergy(energy, handicap);
 }
 
 

Modified: trunk/rts/Sim/Units/UnitHandler.cpp
===================================================================
--- trunk/rts/Sim/Units/UnitHandler.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Sim/Units/UnitHandler.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -14,7 +14,6 @@
 #include &quot;Game/GameSetup.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Map/MapInfo.h&quot;
 #include &quot;Map/ReadMap.h&quot;
@@ -25,6 +24,7 @@
 #include &quot;Sim/Misc/AirBaseHandler.h&quot;
 #include &quot;Sim/Misc/GroundBlockingObjectMap.h&quot;
 #include &quot;Sim/Misc/QuadField.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;CommandAI/Command.h&quot;
 #include &quot;Unit.h&quot;
 #include &quot;GlobalUnsynced.h&quot;
@@ -151,8 +151,8 @@
 
 	maxUnits = gameSetup-&gt;maxUnits;
 
-	if (maxUnits &gt; ((MAX_UNITS / gs-&gt;activeTeams) - 5)) {
-		maxUnits = (MAX_UNITS / gs-&gt;activeTeams) -5;
+	if (maxUnits &gt; ((MAX_UNITS / teamHandler-&gt;ActiveTeams()) - 5)) {
+		maxUnits = (MAX_UNITS / teamHandler-&gt;ActiveTeams()) -5;
 	}
 
 	if (gameSetup-&gt;limitDgun) {
@@ -186,7 +186,7 @@
 
 int CUnitHandler::AddUnit(CUnit *unit)
 {
-//	GML_RECMUTEX_LOCK(unit); // AddUnit. Not needed, protected via LoadUnit. 
+//	GML_RECMUTEX_LOCK(unit); // AddUnit. Not needed, protected via LoadUnit.
 
 	ASSERT_SYNCED_MODE;
 	int num = (int)(gs-&gt;randFloat()) * ((int)activeUnits.size() - 1);
@@ -209,7 +209,7 @@
 	freeIDs.resize(freeMax);
 
 	units[unit-&gt;id] = unit;
-	gs-&gt;Team(unit-&gt;team)-&gt;AddUnit(unit, CTeam::AddBuilt);
+	teamHandler-&gt;Team(unit-&gt;team)-&gt;AddUnit(unit, CTeam::AddBuilt);
 	unitsByDefs[unit-&gt;team][unit-&gt;unitDef-&gt;id].insert(unit);
 
 	maxUnitRadius = max(unit-&gt;radius, maxUnitRadius);
@@ -245,7 +245,7 @@
 			activeUnits.erase(usi);
 			units[delUnit-&gt;id] = 0;
 			freeIDs.push_back(delUnit-&gt;id);
-			gs-&gt;Team(delTeam)-&gt;RemoveUnit(delUnit, CTeam::RemoveDied);
+			teamHandler-&gt;Team(delTeam)-&gt;RemoveUnit(delUnit, CTeam::RemoveDied);
 
 			unitsByDefs[delTeam][delType].erase(delUnit);
 
@@ -326,7 +326,7 @@
 
 	if (!(gs-&gt;frameNum &amp; 15)) {
 		if (diminishingMetalMakers)
-			metalMakerEfficiency = 8.0f / (8.0f + max(0.0f, sqrt(metalMakerIncome / gs-&gt;activeTeams) - 4));
+			metalMakerEfficiency = 8.0f / (8.0f + max(0.0f, sqrt(metalMakerIncome / teamHandler-&gt;ActiveTeams()) - 4));
 		metalMakerIncome = 0;
 	}
 }
@@ -705,7 +705,7 @@
 
 bool CUnitHandler::CanBuildUnit(const UnitDef* unitdef, int team)
 {
-	if (gs-&gt;Team(team)-&gt;units.size() &gt;= uh-&gt;maxUnits) {
+	if (teamHandler-&gt;Team(team)-&gt;units.size() &gt;= uh-&gt;maxUnits) {
 		return false;
 	}
 	if (unitsByDefs[team][unitdef-&gt;id].size() &gt;= unitdef-&gt;maxThisUnit) {

Modified: trunk/rts/Sim/Units/UnitTypes/Builder.cpp
===================================================================
--- trunk/rts/Sim/Units/UnitTypes/Builder.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Sim/Units/UnitTypes/Builder.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -8,7 +8,6 @@
 #include &quot;Builder.h&quot;
 #include &quot;Building.h&quot;
 #include &quot;Game/GameHelper.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Lua/LuaRules.h&quot;
 #include &quot;Map/Ground.h&quot;
@@ -19,6 +18,7 @@
 #include &quot;Sim/Features/Feature.h&quot;
 #include &quot;Sim/Features/FeatureHandler.h&quot;
 #include &quot;Sim/Misc/ModInfo.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;Sim/Projectiles/Unsynced/GfxProjectile.h&quot;
 #include &quot;Sim/Units/COB/CobInstance.h&quot;
@@ -241,7 +241,7 @@
 						float ch  = heightmap[(tz2 + z) * (gs-&gt;mapx + 1) + x];
 						float ch2 = heightmap[(tz2 + 3) * (gs-&gt;mapx + 1) + x];
 						float adjust = ((ch3 * (3 - z) + ch2 * z) / 3 - ch) * terraformScale;
-	
+
 						readmap-&gt;AddHeight((tz2 + z) * (gs-&gt;mapx + 1) + x, adjust);
 					}
 				}
@@ -350,7 +350,7 @@
 				const float energyUseScaled = curCapture-&gt;energyCost * captureFraction * modInfo.captureEnergyCostFactor;
 
 				if (!UseEnergy(energyUseScaled)) {
-					gs-&gt;Team(team)-&gt;energyPull += energyUseScaled;
+					teamHandler-&gt;Team(team)-&gt;energyPull += energyUseScaled;
 				} else {
 					curCapture-&gt;captureProgress = captureProgressTemp;
 					CreateNanoParticle(curCapture-&gt;midPos,curCapture-&gt;radius*0.7f,false);
@@ -367,7 +367,7 @@
 							// capture succesful
 							int oldLineage = curCapture-&gt;lineage;
 							curCapture-&gt;lineage = this-&gt;lineage;
-							gs-&gt;Team(oldLineage)-&gt;LeftLineage(curCapture);
+							teamHandler-&gt;Team(oldLineage)-&gt;LeftLineage(curCapture);
 						}
 						curCapture-&gt;captureProgress=0.0f;
 						StopBuild(true);
@@ -725,7 +725,7 @@
 		float3 color = unitDef-&gt;nanoColor;
 
 		if (gu-&gt;teamNanospray) {
-			unsigned char* tcol = gs-&gt;Team(team)-&gt;color;
+			unsigned char* tcol = teamHandler-&gt;Team(team)-&gt;color;
 			color = float3(tcol[0] * (1.f / 255.f), tcol[1] * (1.f / 255.f), tcol[2] * (1.f / 255.f));
 		}
 

Modified: trunk/rts/Sim/Units/UnitTypes/Factory.cpp
===================================================================
--- trunk/rts/Sim/Units/UnitTypes/Factory.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Sim/Units/UnitTypes/Factory.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -4,10 +4,8 @@
 //////////////////////////////////////////////////////////////////////
 
 #include &quot;Factory.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
 #include &quot;Game/Camera.h&quot;
 #include &quot;Game/GameHelper.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
 #include &quot;Game/WaitCommandsAI.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Map/ReadMap.h&quot;
@@ -15,6 +13,7 @@
 #include &quot;Rendering/UnitModels/3DOParser.h&quot;
 #include &quot;Sim/Misc/GroundBlockingObjectMap.h&quot;
 #include &quot;Sim/Misc/QuadField.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;Sim/Projectiles/Unsynced/GfxProjectile.h&quot;
 #include &quot;Sim/Units/COB/CobFile.h&quot;
@@ -355,7 +354,7 @@
 			float3 color = unitDef-&gt;nanoColor;
 
 			if (gu-&gt;teamNanospray) {
-				unsigned char* tcol = gs-&gt;Team(team)-&gt;color;
+				unsigned char* tcol = teamHandler-&gt;Team(team)-&gt;color;
 				color = float3(tcol[0] * (1.0f / 255.0f), tcol[1] * (1.0f / 255.0f), tcol[2] * (1.0f / 255.0f));
 			}
 

Modified: trunk/rts/Sim/Units/UnitTypes/TransportUnit.cpp
===================================================================
--- trunk/rts/Sim/Units/UnitTypes/TransportUnit.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Sim/Units/UnitTypes/TransportUnit.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -8,6 +8,7 @@
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;Sim/Misc/DamageArray.h&quot;
 #include &quot;Sim/Misc/LosHandler.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;EventHandler.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;creg/STL_List.h&quot;
@@ -147,7 +148,7 @@
 		return false;
 	}
 
-	if (!unit-&gt;unitDef-&gt;transportByEnemy &amp;&amp; !gs-&gt;AlliedTeams(unit-&gt;team, team)) {
+	if (!unit-&gt;unitDef-&gt;transportByEnemy &amp;&amp; !teamHandler-&gt;AlliedTeams(unit-&gt;team, team)) {
 		return false;
 	}
 

Modified: trunk/rts/Sim/Weapons/BeamLaser.cpp
===================================================================
--- trunk/rts/Sim/Weapons/BeamLaser.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Sim/Weapons/BeamLaser.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -1,7 +1,7 @@
 #include &quot;StdAfx.h&quot;
 #include &quot;BeamLaser.h&quot;
 #include &quot;Game/GameHelper.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;Matrix44f.h&quot;
@@ -61,7 +61,7 @@
 
 	if(lastFireFrame &gt; gs-&gt;frameNum - 18 &amp;&amp; lastFireFrame != gs-&gt;frameNum  &amp;&amp; weaponDef-&gt;sweepFire)
 	{
-		if (gs-&gt;Team(owner-&gt;team)-&gt;metal&gt;=metalFireCost &amp;&amp; gs-&gt;Team(owner-&gt;team)-&gt;energy&gt;=energyFireCost)
+		if (teamHandler-&gt;Team(owner-&gt;team)-&gt;metal&gt;=metalFireCost &amp;&amp; teamHandler-&gt;Team(owner-&gt;team)-&gt;energy&gt;=energyFireCost)
 		{
 			owner-&gt;UseEnergy(energyFireCost / salvoSize);
 			owner-&gt;UseMetal(metalFireCost / salvoSize);

Modified: trunk/rts/Sim/Weapons/DGunWeapon.cpp
===================================================================
--- trunk/rts/Sim/Weapons/DGunWeapon.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Sim/Weapons/DGunWeapon.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -1,7 +1,7 @@
 #include &quot;StdAfx.h&quot;
 #include &quot;DGunWeapon.h&quot;
 #include &quot;Sim/Misc/GlobalSynced.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Projectiles/WeaponProjectiles/FireBallProjectile.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
@@ -41,7 +41,7 @@
 
 void CDGunWeapon::Fire(void)
 {
-	if(uh-&gt;limitDgun &amp;&amp; owner-&gt;unitDef-&gt;isCommander &amp;&amp; owner-&gt;pos.SqDistance(gs-&gt;Team(owner-&gt;team)-&gt;startPos)&gt;Square(uh-&gt;dgunRadius)){
+	if(uh-&gt;limitDgun &amp;&amp; owner-&gt;unitDef-&gt;isCommander &amp;&amp; owner-&gt;pos.SqDistance(teamHandler-&gt;Team(owner-&gt;team)-&gt;startPos)&gt;Square(uh-&gt;dgunRadius)){
 		return;		//prevents dgunning using fps view if outside dgunlimit
 	}
 

Modified: trunk/rts/Sim/Weapons/PlasmaRepulser.cpp
===================================================================
--- trunk/rts/Sim/Weapons/PlasmaRepulser.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Sim/Weapons/PlasmaRepulser.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -2,7 +2,7 @@
 #include &quot;creg/STL_List.h&quot;
 #include &quot;creg/STL_Set.h&quot;
 #include &quot;Sim/Misc/GlobalSynced.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;PlasmaRepulser.h&quot;
 #include &quot;Rendering/UnitModels/3DOParser.h&quot;
@@ -88,7 +88,7 @@
 	const int defRechargeDelay = weaponDef-&gt;shieldRechargeDelay;
 
 	rechargeDelay -= (rechargeDelay &gt; 0) ? 1 : 0;
-	
+
 	if (startShowingShield) {
 		// one-time iteration when shield first goes online
 		// (adds the projectile parts, this assumes owner is
@@ -153,7 +153,7 @@
 		for (std::list&lt;CWeaponProjectile*&gt;::iterator pi=incoming.begin();pi!=incoming.end();++pi) {
 			const float3 dif = (*pi)-&gt;pos-owner-&gt;pos;
 			if ((*pi)-&gt;checkCol &amp;&amp; dif.SqLength()&lt;sqRadius &amp;&amp; curPower &gt; (*pi)-&gt;weaponDef-&gt;damages[0]) {
-				if (gs-&gt;Team(owner-&gt;team)-&gt;energy &gt; weaponDef-&gt;shieldEnergyUse) {
+				if (teamHandler-&gt;Team(owner-&gt;team)-&gt;energy &gt; weaponDef-&gt;shieldEnergyUse) {
 					rechargeDelay = defRechargeDelay;
 					if (weaponDef-&gt;shieldRepulser) {
 						// bounce the projectile
@@ -215,12 +215,12 @@
 					if(weaponDef-&gt;shieldRepulser) {	//bounce the projectile
 						int type=(*pi)-&gt;ShieldRepulse(this,weaponPos,weaponDef-&gt;shieldForce,weaponDef-&gt;shieldMaxSpeed);
 						if (type==1){
-							gs-&gt;Team(owner-&gt;team)-&gt;energyPullAmount += weaponDef-&gt;shieldEnergyUse;
+							teamHandler-&gt;Team(owner-&gt;team)-&gt;energyPullAmount += weaponDef-&gt;shieldEnergyUse;
 						} else {
-							gs-&gt;Team(owner-&gt;team)-&gt;energyPullAmount += weaponDef-&gt;shieldEnergyUse/30.0f;
+							teamHandler-&gt;Team(owner-&gt;team)-&gt;energyPullAmount += weaponDef-&gt;shieldEnergyUse/30.0f;
 						}
 					} else {						//kill the projectile
-						gs-&gt;Team(owner-&gt;team)-&gt;energyPullAmount += weaponDef-&gt;shieldEnergyUse;
+						teamHandler-&gt;Team(owner-&gt;team)-&gt;energyPullAmount += weaponDef-&gt;shieldEnergyUse;
 					}*/
 				}
 			}
@@ -247,7 +247,7 @@
 
 void CPlasmaRepulser::NewProjectile(CWeaponProjectile* p)
 {
-	if (weaponDef-&gt;smartShield &amp;&amp; gs-&gt;AlliedTeams(p-&gt;owner-&gt;team, owner-&gt;team)) {
+	if (weaponDef-&gt;smartShield &amp;&amp; teamHandler-&gt;AlliedTeams(p-&gt;owner-&gt;team, owner-&gt;team)) {
 		return;
 	}
 
@@ -286,7 +286,7 @@
 	if (emitter-&gt;weaponDef-&gt;damages[0] &gt; curPower) {
 		return -1;
 	}
-	if (weaponDef-&gt;smartShield &amp;&amp; gs-&gt;AlliedTeams(emitter-&gt;owner-&gt;team,owner-&gt;team)) {
+	if (weaponDef-&gt;smartShield &amp;&amp; teamHandler-&gt;AlliedTeams(emitter-&gt;owner-&gt;team,owner-&gt;team)) {
 		return -1;
 	}
 

Modified: trunk/rts/Sim/Weapons/Weapon.cpp
===================================================================
--- trunk/rts/Sim/Weapons/Weapon.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/Sim/Weapons/Weapon.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -8,7 +8,6 @@
 #include &quot;Game/Camera.h&quot;
 #include &quot;Game/GameHelper.h&quot;
 #include &quot;Game/Player.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;myMath.h&quot;
@@ -17,6 +16,7 @@
 #include &quot;Sim/Misc/InterceptHandler.h&quot;
 #include &quot;Sim/Misc/LosHandler.h&quot;
 #include &quot;Sim/Misc/ModInfo.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/MoveTypes/TAAirMoveType.h&quot;
 #include &quot;Sim/Projectiles/WeaponProjectiles/WeaponProjectile.h&quot;
 #include &quot;Sim/Units/COB/CobFile.h&quot;
@@ -305,14 +305,14 @@
 	}
 	if(weaponDef-&gt;stockpile &amp;&amp; numStockpileQued){
 		float p=1.0f/stockpileTime;
-		if(gs-&gt;Team(owner-&gt;team)-&gt;metal&gt;=metalFireCost*p &amp;&amp; gs-&gt;Team(owner-&gt;team)-&gt;energy&gt;=energyFireCost*p){
+		if(teamHandler-&gt;Team(owner-&gt;team)-&gt;metal&gt;=metalFireCost*p &amp;&amp; teamHandler-&gt;Team(owner-&gt;team)-&gt;energy&gt;=energyFireCost*p){
 			owner-&gt;UseEnergy(energyFireCost*p);
 			owner-&gt;UseMetal(metalFireCost*p);
 			buildPercent+=p;
 		} else {
 			// update the energy and metal required counts
-			gs-&gt;Team(owner-&gt;team)-&gt;energyPull += energyFireCost*p;
-			gs-&gt;Team(owner-&gt;team)-&gt;metalPull += metalFireCost*p;
+			teamHandler-&gt;Team(owner-&gt;team)-&gt;energyPull += energyFireCost*p;
+			teamHandler-&gt;Team(owner-&gt;team)-&gt;metalPull += metalFireCost*p;
 		}
 		if(buildPercent&gt;=1){
 			const int oldCount = numStockpiled;
@@ -339,8 +339,8 @@
 	   )
 	{
 		if ((weaponDef-&gt;stockpile ||
-		     (gs-&gt;Team(owner-&gt;team)-&gt;metal &gt;= metalFireCost &amp;&amp;
-		      gs-&gt;Team(owner-&gt;team)-&gt;energy &gt;= energyFireCost)))
+		     (teamHandler-&gt;Team(owner-&gt;team)-&gt;metal &gt;= metalFireCost &amp;&amp;
+		      teamHandler-&gt;Team(owner-&gt;team)-&gt;energy &gt;= energyFireCost)))
 		{
 			std::vector&lt;int&gt; args;
 			args.push_back(0);
@@ -384,8 +384,8 @@
 				// update the energy and metal required counts
 				const int minPeriod = std::max(1, (int)(reloadTime / owner-&gt;reloadSpeed));
 				const float averageFactor = 1.0f / (float)minPeriod;
-				gs-&gt;Team(owner-&gt;team)-&gt;energyPull += averageFactor * energyFireCost;
-				gs-&gt;Team(owner-&gt;team)-&gt;metalPull += averageFactor * metalFireCost;
+				teamHandler-&gt;Team(owner-&gt;team)-&gt;energyPull += averageFactor * energyFireCost;
+				teamHandler-&gt;Team(owner-&gt;team)-&gt;metalPull += averageFactor * metalFireCost;
 			}
 		}
 	}
@@ -556,7 +556,7 @@
 	if (haveUserTarget)          { return false; }
 
 	if (targetType == Target_None) { return true; }
-	
+
 	if (avoidTarget)             { return true; }
 
 	if (targetType == Target_Unit) {
@@ -829,7 +829,7 @@
 	weaponPos=owner-&gt;pos+owner-&gt;frontdir*relWeaponPos.z+owner-&gt;updir*relWeaponPos.y+owner-&gt;rightdir*relWeaponPos.x;
 	weaponMuzzlePos=owner-&gt;pos+owner-&gt;frontdir*relWeaponMuzzlePos.z+owner-&gt;updir*relWeaponMuzzlePos.y+owner-&gt;rightdir*relWeaponMuzzlePos.x;
 	return val;
-	
+
 }
 
 void CWeapon::Init(void)

Modified: trunk/rts/System/LoadSaveHandler.cpp
===================================================================
--- trunk/rts/System/LoadSaveHandler.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/System/LoadSaveHandler.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -23,7 +23,7 @@
 #include &quot;Game/Game.h&quot;
 #include &quot;Game/GameSetup.h&quot;
 #include &quot;Game/GameServer.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Game/WaitCommandsAI.h&quot;
 #include &quot;Sim/Misc/Wind.h&quot;
@@ -124,7 +124,7 @@
 
 void CLoadSaveHandler::SaveGame(std::string file)
 {
-	LoadStartPicture(gs-&gt;Team(gu-&gt;myTeam)-&gt;side);
+	LoadStartPicture(teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;side);
 	PrintLoadMsg(&quot;Saving game&quot;);
 	try {
 		std::ofstream ofs(filesystem.LocateFile(file, FileSystem::WRITE).c_str(), std::ios::out|std::ios::binary);
@@ -189,7 +189,7 @@
 //this should be called on frame 0 when the game has started
 void CLoadSaveHandler::LoadGame()
 {
-	LoadStartPicture(gs-&gt;Team(gu-&gt;myTeam)-&gt;side);
+	LoadStartPicture(teamHandler-&gt;Team(gu-&gt;myTeam)-&gt;side);
 	PrintLoadMsg(&quot;Loading game&quot;);
 	creg::CInputStreamSerializer inputStream;
 	void *pGSC = 0;
@@ -205,7 +205,7 @@
 	globalAI-&gt;Load(ifs);
 	delete ifs;
 	for (int a=0;a&lt;MAX_TEAMS;a++) {//For old savegames
-		if (gs-&gt;Team(a)-&gt;isDead &amp;&amp; globalAI-&gt;ais[a]) {
+		if (teamHandler-&gt;Team(a)-&gt;isDead &amp;&amp; globalAI-&gt;ais[a]) {
 			delete globalAI-&gt;ais[a];
 			globalAI-&gt;ais[a] = 0;
 		}

Modified: trunk/rts/System/Platform/ConfigHandler.cpp
===================================================================
--- trunk/rts/System/Platform/ConfigHandler.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/System/Platform/ConfigHandler.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -21,47 +21,38 @@
 #include &quot;Game/GameVersion.h&quot;
 
 
-/**
- * @brief instance
- *
- * Default instantiation of ConfigHandler instance
- * is NULL.
- */
-#ifndef USE_GML // GML calls GetInstance() from a global scope and needs these to be initialized in gml.cpp instead to avoid crash
-ConfigHandler* ConfigHandler::instance = NULL;
-std::string ConfigHandler::configSource;
-#endif
+ConfigHandler* _configHandler;
 
+
 /**
- * Returns reference to the current platform's config class.
- * If none exists, create one.
+ * Instantiates a copy of the current platform's config class.
+ * Re-instantiates if the configHandler already existed.
  */
-ConfigHandler&amp; ConfigHandler::GetInstance()
+void ConfigHandler::Instantiate(std::string configSource)
 {
-	if (!instance) {
-		if (configSource.empty()) {
+	Deallocate();
+
+	if (configSource.empty()) {
 #ifdef _WIN32
-			configSource = &quot;Software\\SJ\\Spring&quot;;
-			const std::string version = SpringVersion::Get();
-			if (version.size()&gt;0 &amp;&amp; version[version.size()-1] == '+')
-				configSource += &quot; SVN&quot;;
+		configSource = &quot;Software\\SJ\\Spring&quot;;
+		const std::string version = SpringVersion::Get();
+		if (version.size()&gt;0 &amp;&amp; version[version.size()-1] == '+')
+			configSource += &quot; SVN&quot;;
 #elif defined(__APPLE__)
-			configSource = &quot;this string is not currently used&quot;;
+		configSource = &quot;this string is not currently used&quot;;
 #else
-			configSource = DotfileHandler::GetDefaultConfig();
+		configSource = DotfileHandler::GetDefaultConfig();
 #endif
-		}
+	}
 
 #ifdef _WIN32
-		instance = SAFE_NEW RegHandler(configSource);
+	_configHandler = SAFE_NEW RegHandler(configSource);
 #elif defined(__APPLE__)
-		PreInitMac();
-		instance = SAFE_NEW UserDefsHandler(); // Config path is based on bundle id
+	PreInitMac();
+	_configHandler = SAFE_NEW UserDefsHandler(); // Config path is based on bundle id
 #else
-		instance = SAFE_NEW DotfileHandler(configSource);
+	_configHandler = SAFE_NEW DotfileHandler(configSource);
 #endif
-	}
-	return *instance;
 }
 
 
@@ -70,9 +61,9 @@
  */
 void ConfigHandler::Deallocate()
 {
-	if (instance)
-		delete instance;
-	instance = 0;
+	// can not use SafeDelete because ~ConfigHandler is protected
+	delete _configHandler;
+	_configHandler = NULL;
 }
 
 
@@ -100,16 +91,3 @@
 
 	SetString(name, buffer.str());
 }
-
-
-bool ConfigHandler::SetConfigSource(const std::string&amp; source)
-{
-	configSource = source;
-	return true;
-}
-
-
-const std::string&amp; ConfigHandler::GetConfigSource()
-{
-	return configSource;
-}

Modified: trunk/rts/System/Platform/ConfigHandler.h
===================================================================
--- trunk/rts/System/Platform/ConfigHandler.h	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/System/Platform/ConfigHandler.h	2008-11-12 22:26:06 UTC (rev 7026)
@@ -2,7 +2,7 @@
  * @file ConfigHandler.h
  * @brief config base
  * @author Christopher Han &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">xiphux at gmail.com</A>&gt;
- * 
+ *
  * Definition of config structure class
  * Copyright (C) 2005.  Licensed under the terms of the
  * GNU GPL, v2 or later.
@@ -13,16 +13,8 @@
 #include &lt;string&gt;
 
 /**
- * @brief configHandler
- *
- * Just a shortcut to prevent having to replace
- * configHandler throughout the entire engine
- */
-#define configHandler (ConfigHandler::GetInstance())
-
-/**
  * @brief config handler base
- * 
+ *
  * This is the abstract configuration handler class used
  * for polymorphic configuration.  Platform-specifics should derive
  * from this.
@@ -59,7 +51,7 @@
 	 * @return integer value
 	 */
 	virtual int GetInt(std::string name, int def) = 0;
-	
+
 	/**
 	@brief get float value
 	*/
@@ -71,31 +63,22 @@
 	virtual void SetFloat(const std::string&amp; name, float value);
 
 	/**
-	 * @brief get instance
-	 * @return reference to current platform's ConfigHandler
+	 * @brief instantiate global configHandler
 	 */
-	static ConfigHandler&amp; GetInstance();
+	static void Instantiate(std::string configSource);
 
-	static bool SetConfigSource(const std::string&amp; name);
-	static const std::string&amp; GetConfigSource();
-
 	/**
 	 * @brief deallocate
 	 */
 	static void Deallocate();
 
+protected:
 	virtual ~ConfigHandler();
+};
 
-protected:
-	static std::string configSource;
+extern ConfigHandler* _configHandler;
 
-	/**
-	 * @brief instance
-	 *
-	 * ConfigHandler pointer pointing to current platform's
-	 * ConfigHandler instance
-	 */
-	static ConfigHandler* instance;
-};
+// quick hack so I don't have to change . to -&gt; in the entire project
+#define configHandler (*_configHandler)
 
 #endif /* CONFIGHANDLER_H */

Modified: trunk/rts/System/Script/LuaBinder.cpp
===================================================================
--- trunk/rts/System/Script/LuaBinder.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/System/Script/LuaBinder.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -4,7 +4,7 @@
 #include &quot;float3.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Sim/Misc/GlobalSynced.h&quot;
-#include &quot;Sim/Misc/Team.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitTypes/TransportUnit.h&quot;
 #include &quot;TdfParser.h&quot;
@@ -190,10 +190,10 @@
 		class_&lt;CGlobalSyncedStuff&gt;(&quot;GlobalSynced&quot;)
 			.def_readonly(&quot;frameNum&quot;, &amp;CGlobalSyncedStuff::frameNum)
 			.def_readonly(&quot;mapx&quot;, &amp;CGlobalSyncedStuff::mapx)
-			.def_readonly(&quot;activeTeams&quot;, &amp;CGlobalSyncedStuff::activeTeams)
+			.def_readonly(&quot;activeTeams&quot;, &amp;CGlobalSyncedStuff::activeTeamsBackwardCompatForLuaBinder)
 			.def_readonly(&quot;mapy&quot;, &amp;CGlobalSyncedStuff::mapy)
 			.def(&quot;randInt&quot;, &amp;CGlobalSyncedStuff::randInt),
-			
+
 		class_&lt;SFloat3&gt;(&quot;sfloat3&quot;)
 			.def(constructor&lt;const float, const float, const float&gt;())
 			.def_readwrite(&quot;x&quot;, &amp;SFloat3::x)
@@ -223,7 +223,7 @@
 			.def(&quot;GiveCommand&quot;, &amp;UnitGiveCommand)
 			.def(&quot;ChangeTeam&quot;, &amp;CUnit::ChangeTeam)
 			.def(&quot;IsValid&quot;, &amp;UnitPointerIsValid),
-			
+
 		class_&lt;CTeam&gt;(&quot;Team&quot;)
 			.def(&quot;setmetalstorage&quot;, &amp;CTeam::SetBaseMetalStorage)
 			.def(&quot;setenergystorage&quot;, &amp;CTeam::SetBaseEnergyStorage)
@@ -304,7 +304,7 @@
 			def(&quot;GetAt&quot;, &amp;GetFeaturesAt, raw(_1)),
 			def(&quot;Load&quot;, &amp;FeatureLoaderLoadFeature, adopt(result))
 		],
-		
+
 		namespace_(&quot;game&quot;)
 		[
 			def(&quot;End&quot;, &amp;EndGame),

Modified: trunk/rts/System/Script/LuaFunctions.cpp
===================================================================
--- trunk/rts/System/Script/LuaFunctions.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/System/Script/LuaFunctions.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -19,6 +19,7 @@
 #include &quot;Sim/Features/Feature.h&quot;
 #include &quot;Sim/Features/FeatureHandler.h&quot;
 #include &quot;Sim/Misc/QuadField.h&quot;
+#include &quot;Sim/Misc/TeamHandler.h&quot;
 #include &quot;Sim/Units/CommandAI/CommandAI.h&quot;
 #include &quot;Sim/Units/UnitDefHandler.h&quot;
 #include &quot;Sim/Units/Unit.h&quot;
@@ -61,7 +62,7 @@
 		CUnit* x = unitLoader.LoadUnit(name, pos, team, buil, 0, NULL);
 		return SAFE_NEW CObject_pointer&lt;CUnit&gt;(x);
 	}
-	
+
 	void RemoveUnit(CObject_pointer&lt;CUnit&gt;* u)
 	{
 		if (u-&gt;held)
@@ -173,10 +174,10 @@
 		if (selectedUnits.selectionChanged)
 			selectedUnits.SendSelection();
 	}
-	
+
 	CTeam* GetTeam(int num)
 	{
-		return gs-&gt;Team(num);
+		return teamHandler-&gt;Team(num);
 	}
 
 	string MapGetTDFName()

Modified: trunk/rts/System/SpringApp.cpp
===================================================================
--- trunk/rts/System/SpringApp.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/System/SpringApp.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -104,10 +104,6 @@
 	FSAA = false;
 
 	signal(SIGABRT, SigAbrtHandler);
-#if defined(USE_GML) &amp;&amp; GML_ENABLE_SIMLOOP
-	extern volatile int multiThreadSim;
-	multiThreadSim=configHandler.GetInt(&quot;MultiThreadSim&quot;, 1);
-#endif
 }
 
 /**
@@ -659,11 +655,11 @@
 	cmdline-&gt;parse();
 
 	string configSource;
-	if (cmdline-&gt;result(&quot;config&quot;, configSource)) {
-		ConfigHandler::SetConfigSource(configSource);
-	}
+	cmdline-&gt;result(&quot;config&quot;, configSource);
+	// it is not allowed to use configHandler before this line runs.
+	ConfigHandler::Instantiate(configSource);
 
-	logOutput.Print(&quot;using configuration source \&quot;&quot; + configHandler.GetConfigSource() + &quot;\&quot;&quot;);
+	logOutput.Print(&quot;using configuration source \&quot;&quot; + configSource + &quot;\&quot;&quot;);
 
 #ifdef _DEBUG
 	fullscreen = false;
@@ -712,6 +708,13 @@
 		screenHeight = std::max(screenHeight, 1);
 	}
 
+#ifdef USE_GML
+	gmlThreadCountOverride = configHandler.GetInt(&quot;HardwareThreadCount&quot;, 0);
+#if GML_ENABLE_SIMLOOP
+	extern volatile int multiThreadSim;
+	multiThreadSim=configHandler.GetInt(&quot;MultiThreadSim&quot;, 1);
+#endif
+#endif
 }
 
 /**
@@ -780,11 +783,10 @@
 		if (argv[i][0] != '-')
 		{
 			string command(argv[i]);
-			int idx = command.rfind(&quot;sdf&quot;);
-			if (idx == command.size()-3) {
+			if (command.rfind(&quot;sdf&quot;) == command.size() - 3) {
 				demofile = command;
 				logOutput &lt;&lt; &quot;Using demofile &quot; &lt;&lt; demofile.c_str() &lt;&lt; &quot;\n&quot;;
-			} else if (command.rfind(&quot;ssf&quot;) == command.size()-3) {
+			} else if (command.rfind(&quot;ssf&quot;) == command.size() - 3) {
 				savefile = command;
 				logOutput &lt;&lt; &quot;Using savefile &quot; &lt;&lt; savefile.c_str() &lt;&lt; &quot;\n&quot;;
 			} else {
@@ -809,7 +811,7 @@
 		CFileHandler fh(startscript);
 		if (!fh.FileExists())
 			throw content_error(&quot;Setupscript doesn't exists in given location: &quot;+startscript);
-		
+
 		std::string buf;
 		if (!fh.LoadStringData(buf))
 			throw content_error(&quot;Setupscript cannot be read: &quot;+startscript);

Modified: trunk/rts/System/Sync/SyncDebugger.cpp
===================================================================
--- trunk/rts/System/Sync/SyncDebugger.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/System/Sync/SyncDebugger.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -239,7 +239,7 @@
 				logger.AddLine(&quot;Server: received checksum response of %d instead of %d bytes&quot;, *(short*)&amp;inbuf[1], HISTORY_SIZE * 4 + 12);
 			} else {
 				int player = inbuf[3];
-				if(player &gt;= gs-&gt;activePlayers || player &lt; 0) {
+				if(player &gt;= playerHandler-&gt;ActivePlayers() || player &lt; 0) {
 					logger.AddLine(&quot;Server: got invalid playernum %d in checksum response&quot;, player);
 				} else {
 					logger.AddLine(&quot;Server: got checksum response from %d&quot;, player);
@@ -250,8 +250,8 @@
 					remoteFlop[player] = *(Uint64*)&amp;inbuf[4];
 					assert(!checksumResponses[player].empty());
 					int i = 0;
-					while (i &lt; gs-&gt;activePlayers &amp;&amp; !checksumResponses[i].empty()) ++i;
-					if (i == gs-&gt;activePlayers) {
+					while (i &lt; playerHandler-&gt;ActivePlayers() &amp;&amp; !checksumResponses[i].empty()) ++i;
+					if (i == playerHandler-&gt;ActivePlayers()) {
 						ServerQueueBlockRequests();
 						logger.AddLine(&quot;Server: checksum responses received; %d block requests queued&quot;, pendingBlocksToRequest.size());
 					}
@@ -264,7 +264,7 @@
 				logger.AddLine(&quot;Server: received block response of %d instead of %d bytes&quot;, *(short*)&amp;inbuf[1], BLOCK_SIZE * 4 + 4);
 			} else {
 				int player = inbuf[3];
-				if(player &gt;= gs-&gt;activePlayers || player &lt; 0) {
+				if(player &gt;= playerHandler-&gt;ActivePlayers() || player &lt; 0) {
 					logger.AddLine(&quot;Server: got invalid playernum %d in block response&quot;, player);
 				} else {
 					const unsigned* begin = (unsigned*)&amp;inbuf[4];
@@ -274,8 +274,8 @@
 					std::copy(begin, end, remoteHistory[player].begin() + size);
 					int i = 0;
 					size += BLOCK_SIZE;
-					while (i &lt; gs-&gt;activePlayers &amp;&amp; size == remoteHistory[i].size()) ++i;
-					if (i == gs-&gt;activePlayers) {
+					while (i &lt; playerHandler-&gt;ActivePlayers() &amp;&amp; size == remoteHistory[i].size()) ++i;
+					if (i == playerHandler-&gt;ActivePlayers()) {
 						logger.AddLine(&quot;Server: block responses received&quot;);
 						ServerReceivedBlockResponses();
 					}
@@ -397,7 +397,7 @@
 {
 	logger.AddLine(&quot;Server: queuing block requests&quot;);
 	Uint64 correctFlop = 0;
-	for (int j = 0; j &lt; gs-&gt;activePlayers; ++j) {
+	for (int j = 0; j &lt; playerHandler-&gt;ActivePlayers(); ++j) {
 		if (correctFlop) {
 			if (remoteFlop[j] != correctFlop)
 				logger.AddLine(&quot;Server: bad flop# %llu instead of %llu for player %d&quot;, remoteFlop[j], correctFlop, j);
@@ -409,7 +409,7 @@
 	for (unsigned c = 0; c &lt; HISTORY_SIZE; ++i, ++c) {
 		unsigned correctChecksum = 0;
 		if (i == HISTORY_SIZE) i = 0;
-		for (int j = 0; j &lt; gs-&gt;activePlayers; ++j) {
+		for (int j = 0; j &lt; playerHandler-&gt;ActivePlayers(); ++j) {
 			if (correctChecksum &amp;&amp; checksumResponses[j][i] != correctChecksum) {
 				pendingBlocksToRequest.push_back(i);
 				break;
@@ -527,7 +527,7 @@
 		unsigned correctChecksum = 0;
 		if (i == virtualHistorySize) i = 0;
 		bool err = false;
-		for (int j = 0; j &lt; gs-&gt;activePlayers; ++j) {
+		for (int j = 0; j &lt; playerHandler-&gt;ActivePlayers(); ++j) {
 			if (correctChecksum &amp;&amp; remoteHistory[j][i] != correctChecksum) {
 				if (historybt) {
 					virtualBlockNr = i / BLOCK_SIZE;

Modified: trunk/rts/build/scons/rts.py
===================================================================
--- trunk/rts/build/scons/rts.py	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/build/scons/rts.py	2008-11-12 22:26:06 UTC (rev 7026)
@@ -140,7 +140,7 @@
 	# Use this to avoid an error message 'how to make target configure ?'
 	env.Alias('configure', None)
 
-	if not 'configure' in sys.argv and not ((env.has_key('is_configured') and env['is_configured'] == 7) or env.GetOption('clean')):
+	if not 'configure' in sys.argv and not ((env.has_key('is_configured') and env['is_configured'] == 8) or env.GetOption('clean')):
 		print &quot;Not configured or configure script updated.  Run `scons configure' first.&quot;
 		print &quot;Use `scons --help' to show available configure options to `scons configure'.&quot;
 		env.Exit(1)
@@ -175,7 +175,7 @@
 
 		args = makeHashTable(sys.argv)
 
-		env['is_configured'] = 7
+		env['is_configured'] = 8
 
 		if args.has_key('platform'): env['platform'] = args['platform']
 		else: env['platform'] = detect.platform()
@@ -352,6 +352,7 @@
 			if env['fpmath'] == '387':
 				print &quot;WARNING: SSE math vs X87 math is unsynced!&quot;
 				print &quot;WARNING: Do not go online with the binary you are currently building!&quot;
+			else:
 				env['CCFLAGS'] += ['-msse']
 
 		env['CXXFLAGS'] = env['CCFLAGS']

Modified: trunk/rts/lib/gml/gml.cpp
===================================================================
--- trunk/rts/lib/gml/gml.cpp	2008-11-12 22:07:47 UTC (rev 7025)
+++ trunk/rts/lib/gml/gml.cpp	2008-11-12 22:26:06 UTC (rev 7026)
@@ -36,9 +36,6 @@
 #ifdef USE_GML
 #include &quot;gmlcls.h&quot;
 #include &quot;LogOutput.h&quot;
-#include &quot;Platform/ConfigHandler.h&quot;
-ConfigHandler* ConfigHandler::instance = NULL;
-std::string ConfigHandler::configSource;
 
 #define EXEC_RUN (BYTE *)NULL
 #define EXEC_SYNC (BYTE *)-1
@@ -59,7 +56,7 @@
 int gmlThreadNumber=0;
 #endif
 
-int gmlThreadCountOverride=configHandler.GetInt(&quot;HardwareThreadCount&quot;, 0); // number of threads to use (can be manually overridden here)
+int gmlThreadCountOverride=0; // number of threads to use (can be manually overridden here)
 int gmlThreadCount=GML_CPU_COUNT; // number of threads to use
 int gmlItemsConsumed=0;
 


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001794.html">[Taspring-linux-commit] r7025 - trunk/tools/DedicatedServer
</A></li>
	<LI>Next message: <A HREF="001796.html">[Taspring-linux-commit] r7027 - trunk
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1795">[ date ]</a>
              <a href="thread.html#1795">[ thread ]</a>
              <a href="subject.html#1795">[ subject ]</a>
              <a href="author.html#1795">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
