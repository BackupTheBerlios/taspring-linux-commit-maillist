<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r7014 - in trunk: rts/ExternalAI rts/Game	rts/Game/StartScripts rts/Game/UI rts/Lua rts/Map/SM3/terrain	rts/Rendering rts/Rendering/Textures rts/Sim/Path rts/System	rts/System/FileSystem rts/System/Platform	rts/System/Platform/Linux rts/System/Platform/Mac	rts/System/Platform/Win tools/DedicatedServer tools/unitsync
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-November/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r7014%20-%20in%20trunk%3A%20rts/ExternalAI%20rts/Game%0A%09rts/Game/StartScripts%20rts/Game/UI%20rts/Lua%20rts/Map/SM3/terrain%0A%09rts/Rendering%20rts/Rendering/Textures%20rts/Sim/Path%20rts/System%0A%09rts/System/FileSystem%20rts/System/Platform%0A%09rts/System/Platform/Linux%20rts/System/Platform/Mac%0A%09rts/System/Platform/Win%20tools/DedicatedServer%20tools/unitsync&In-Reply-To=%3C20081110233521.867494768%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001782.html">
   <LINK REL="Next"  HREF="001784.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r7014 - in trunk: rts/ExternalAI rts/Game	rts/Game/StartScripts rts/Game/UI rts/Lua rts/Map/SM3/terrain	rts/Rendering rts/Rendering/Textures rts/Sim/Path rts/System	rts/System/FileSystem rts/System/Platform	rts/System/Platform/Linux rts/System/Platform/Mac	rts/System/Platform/Win tools/DedicatedServer tools/unitsync</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r7014%20-%20in%20trunk%3A%20rts/ExternalAI%20rts/Game%0A%09rts/Game/StartScripts%20rts/Game/UI%20rts/Lua%20rts/Map/SM3/terrain%0A%09rts/Rendering%20rts/Rendering/Textures%20rts/Sim/Path%20rts/System%0A%09rts/System/FileSystem%20rts/System/Platform%0A%09rts/System/Platform/Linux%20rts/System/Platform/Mac%0A%09rts/System/Platform/Win%20tools/DedicatedServer%20tools/unitsync&In-Reply-To=%3C20081110233521.867494768%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r7014 - in trunk: rts/ExternalAI rts/Game	rts/Game/StartScripts rts/Game/UI rts/Lua rts/Map/SM3/terrain	rts/Rendering rts/Rendering/Textures rts/Sim/Path rts/System	rts/System/FileSystem rts/System/Platform	rts/System/Platform/Linux rts/System/Platform/Mac	rts/System/Platform/Win tools/DedicatedServer tools/unitsync">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Tue Nov 11 00:35:20 CET 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001782.html">[Taspring-linux-commit] r7013 - branches/gmltest/rts/lib/lua/src
</A></li>
        <LI>Next message: <A HREF="001784.html">[Taspring-linux-commit] r7015 - trunk
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1783">[ date ]</a>
              <a href="thread.html#1783">[ thread ]</a>
              <a href="subject.html#1783">[ subject ]</a>
              <a href="author.html#1783">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: Auswaschbar
Date: 2008-11-11 00:35:19 +0100 (Tue, 11 Nov 2008)
New Revision: 7014

Added:
   trunk/rts/System/FileSystem/DataDirLocater.cpp
   trunk/rts/System/FileSystem/DataDirLocater.h
   trunk/rts/System/FileSystem/FileSystem.cpp
   trunk/rts/System/FileSystem/FileSystem.h
   trunk/rts/System/FileSystem/UnixFileSystemHandler.cpp
   trunk/rts/System/FileSystem/UnixFileSystemHandler.h
Removed:
   trunk/rts/System/Platform/FileSystem.cpp
   trunk/rts/System/Platform/FileSystem.h
   trunk/rts/System/Platform/Linux/DataDirLocater.cpp
   trunk/rts/System/Platform/Linux/DataDirLocater.h
   trunk/rts/System/Platform/Linux/UnixFileSystemHandler.cpp
   trunk/rts/System/Platform/Linux/UnixFileSystemHandler.h
   trunk/rts/System/Platform/Mac/MacFileSystemHandler.cpp
   trunk/rts/System/Platform/Mac/MacFileSystemHandler.h
   trunk/rts/System/Platform/Win/DataDirLocater.cpp
   trunk/rts/System/Platform/Win/DataDirLocater.h
   trunk/rts/System/Platform/Win/WinFileSystemHandler.cpp
   trunk/rts/System/Platform/Win/WinFileSystemHandler.h
Modified:
   trunk/rts/ExternalAI/AICallback.cpp
   trunk/rts/ExternalAI/GlobalAI.cpp
   trunk/rts/ExternalAI/GroupHandler.cpp
   trunk/rts/Game/Game.cpp
   trunk/rts/Game/PreGame.cpp
   trunk/rts/Game/SelectMenu.cpp
   trunk/rts/Game/StartScripts/GlobalAITestScript.cpp
   trunk/rts/Game/StartScripts/LoadScript.cpp
   trunk/rts/Game/UI/LuaUI.cpp
   trunk/rts/Game/UI/SelectionKeyHandler.cpp
   trunk/rts/Lua/LuaFeatureDefs.cpp
   trunk/rts/Lua/LuaGaia.cpp
   trunk/rts/Lua/LuaHandleSynced.cpp
   trunk/rts/Lua/LuaIO.cpp
   trunk/rts/Lua/LuaParser.cpp
   trunk/rts/Lua/LuaRules.cpp
   trunk/rts/Lua/LuaSyncedRead.cpp
   trunk/rts/Lua/LuaUnitDefs.cpp
   trunk/rts/Lua/LuaUnsyncedCtrl.cpp
   trunk/rts/Lua/LuaUnsyncedRead.cpp
   trunk/rts/Lua/LuaVFS.cpp
   trunk/rts/Map/SM3/terrain/TerrainTextureGLSL.cpp
   trunk/rts/Map/SM3/terrain/Textures.cpp
   trunk/rts/Rendering/Textures/Bitmap.cpp
   trunk/rts/Rendering/glFont.cpp
   trunk/rts/Sim/Path/PathEstimator.cpp
   trunk/rts/System/DemoRecorder.cpp
   trunk/rts/System/FileSystem/ArchiveDir.cpp
   trunk/rts/System/FileSystem/ArchiveFactory.cpp
   trunk/rts/System/FileSystem/ArchiveScanner.cpp
   trunk/rts/System/FileSystem/FileHandler.cpp
   trunk/rts/System/FileSystem/VFSHandler.cpp
   trunk/rts/System/LoadSaveHandler.cpp
   trunk/rts/System/SpringApp.cpp
   trunk/tools/DedicatedServer/CMakeLists.txt
   trunk/tools/DedicatedServer/main.cpp
   trunk/tools/unitsync/CMakeLists.txt
   trunk/tools/unitsync/javabind.cpp
   trunk/tools/unitsync/pybind.cpp
   trunk/tools/unitsync/unitsync.cpp
Log:
* move FileSystem.[h|cpp] to System/FileSystem (ouch)
* move UnixFileSystemHandler.* and DataDirLocater to FileSystem because its the only one (should be merged into FileSystem)


Modified: trunk/rts/ExternalAI/AICallback.cpp
===================================================================
--- trunk/rts/ExternalAI/AICallback.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/ExternalAI/AICallback.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -19,7 +19,7 @@
 #include &quot;NetProtocol.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;Platform/errorhandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;Rendering/InMapDraw.h&quot;
 #include &quot;Rendering/UnitModels/3DModelParser.h&quot;
 #include &quot;Rendering/UnitModels/UnitDrawer.h&quot;

Modified: trunk/rts/ExternalAI/GlobalAI.cpp
===================================================================
--- trunk/rts/ExternalAI/GlobalAI.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/ExternalAI/GlobalAI.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -4,7 +4,7 @@
 #include &quot;GlobalAICallback.h&quot;
 #include &quot;GlobalAIHandler.h&quot;
 #include &quot;GroupHandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;Platform/errorhandler.h&quot;
 #include &quot;Platform/SharedLib.h&quot;
 #include &quot;LogOutput.h&quot;

Modified: trunk/rts/ExternalAI/GroupHandler.cpp
===================================================================
--- trunk/rts/ExternalAI/GroupHandler.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/ExternalAI/GroupHandler.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -15,7 +15,7 @@
 #include &quot;Game/CameraHandler.h&quot;
 #include &quot;Platform/SharedLib.h&quot;
 #include &quot;Platform/errorhandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;SDL_types.h&quot;
 #include &quot;SDL_keysym.h&quot;
 #include &quot;mmgr.h&quot;

Modified: trunk/rts/Game/Game.cpp
===================================================================
--- trunk/rts/Game/Game.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/Game/Game.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -68,7 +68,7 @@
 #include &quot;NetProtocol.h&quot;
 #include &quot;DemoRecorder.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;Rendering/Env/BaseSky.h&quot;
 #include &quot;Rendering/Env/BaseTreeDrawer.h&quot;
 #include &quot;Rendering/Env/BaseWater.h&quot;

Modified: trunk/rts/Game/PreGame.cpp
===================================================================
--- trunk/rts/Game/PreGame.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/Game/PreGame.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -32,7 +32,7 @@
 #include &quot;Lua/LuaParser.h&quot;
 #include &quot;Map/MapParser.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;Rendering/glFont.h&quot;
 #include &quot;Rendering/Textures/TAPalette.h&quot;
 #include &quot;StartScripts/ScriptHandler.h&quot;

Modified: trunk/rts/Game/SelectMenu.cpp
===================================================================
--- trunk/rts/Game/SelectMenu.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/Game/SelectMenu.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -18,7 +18,7 @@
 #include &quot;FileSystem/ArchiveScanner.h&quot;
 #include &quot;FileSystem/FileHandler.h&quot;
 #include &quot;FileSystem/VFSHandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;StartScripts/ScriptHandler.h&quot;
 
@@ -27,8 +27,6 @@
 extern Uint8* keys;
 extern bool globalQuit;
 
-#include &lt;iostream&gt;
-
 std::string CreateDefaultSetup(const std::string&amp; map, const std::string&amp; mod, const std::string&amp; script, const std::string&amp; playername)
 {
 	TdfParser::TdfSection setup;
@@ -66,7 +64,6 @@
 	std::ostringstream str;
 	setup.print(str);
 	
-	std::cout &lt;&lt; std::endl &lt;&lt; str.str() &lt;&lt; std::endl;
 	return str.str();
 }
 

Modified: trunk/rts/Game/StartScripts/GlobalAITestScript.cpp
===================================================================
--- trunk/rts/Game/StartScripts/GlobalAITestScript.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/Game/StartScripts/GlobalAITestScript.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -11,7 +11,7 @@
 #include &quot;Sim/Units/UnitDefHandler.h&quot;
 #include &quot;Sim/Units/UnitLoader.h&quot;
 #include &quot;LogOutput.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;Game/GameSetup.h&quot;
 #include &quot;mmgr.h&quot;
 #include &quot;Exceptions.h&quot;

Modified: trunk/rts/Game/StartScripts/LoadScript.cpp
===================================================================
--- trunk/rts/Game/StartScripts/LoadScript.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/Game/StartScripts/LoadScript.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -11,7 +11,7 @@
 #include &quot;Sim/Units/UnitDefHandler.h&quot;
 #include &quot;LoadSaveHandler.h&quot;
 #include &quot;FileSystem/FileHandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 
 extern std::string stupidGlobalMapname;
 

Modified: trunk/rts/Game/UI/LuaUI.cpp
===================================================================
--- trunk/rts/Game/UI/LuaUI.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/Game/UI/LuaUI.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -73,7 +73,7 @@
 #include &quot;FileSystem/FileHandler.h&quot;
 #include &quot;FileSystem/VFSHandler.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;Util.h&quot;
 
 

Modified: trunk/rts/Game/UI/SelectionKeyHandler.cpp
===================================================================
--- trunk/rts/Game/UI/SelectionKeyHandler.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/Game/UI/SelectionKeyHandler.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -12,7 +12,7 @@
 #include &quot;LogOutput.h&quot;
 #include &quot;Map/Ground.h&quot;
 #include &quot;MouseHandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;SelectionKeyHandler.h&quot;
 #include &quot;Sim/Misc/CategoryHandler.h&quot;
 #include &quot;Sim/Units/CommandAI/CommandAI.h&quot;

Modified: trunk/rts/Lua/LuaFeatureDefs.cpp
===================================================================
--- trunk/rts/Lua/LuaFeatureDefs.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/Lua/LuaFeatureDefs.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -24,7 +24,7 @@
 #include &quot;Sim/Features/FeatureHandler.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;FileSystem/FileHandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 
 using namespace std;
 

Modified: trunk/rts/Lua/LuaGaia.cpp
===================================================================
--- trunk/rts/Lua/LuaGaia.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/Lua/LuaGaia.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -27,7 +27,7 @@
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;FileSystem/FileHandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;Util.h&quot;
 
 

Modified: trunk/rts/Lua/LuaHandleSynced.cpp
===================================================================
--- trunk/rts/Lua/LuaHandleSynced.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/Lua/LuaHandleSynced.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -43,7 +43,7 @@
 #include &quot;EventHandler.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;FileSystem/FileHandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 
 
 static const LuaHashString unsyncedStr(&quot;UNSYNCED&quot;);

Modified: trunk/rts/Lua/LuaIO.cpp
===================================================================
--- trunk/rts/Lua/LuaIO.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/Lua/LuaIO.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -19,7 +19,7 @@
 
 #include &quot;LuaHandle.h&quot;
 #include &quot;LuaInclude.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;Util.h&quot;
 
 

Modified: trunk/rts/Lua/LuaParser.cpp
===================================================================
--- trunk/rts/Lua/LuaParser.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/Lua/LuaParser.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -22,7 +22,7 @@
 #include &quot;LogOutput.h&quot;
 #include &quot;FileSystem/FileHandler.h&quot;
 #include &quot;FileSystem/VFSHandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;Platform/errorhandler.h&quot;
 #include &quot;Util.h&quot;
 

Modified: trunk/rts/Lua/LuaRules.cpp
===================================================================
--- trunk/rts/Lua/LuaRules.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/Lua/LuaRules.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -39,7 +39,7 @@
 #include &quot;Sim/Units/COB/CobInstance.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;FileSystem/FileHandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &lt;assert.h&gt;
 
 CLuaRules* luaRules = NULL;

Modified: trunk/rts/Lua/LuaSyncedRead.cpp
===================================================================
--- trunk/rts/Lua/LuaSyncedRead.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/Lua/LuaSyncedRead.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -67,7 +67,7 @@
 #include &quot;LogOutput.h&quot;
 #include &quot;FileSystem/FileHandler.h&quot;
 #include &quot;FileSystem/VFSHandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;Util.h&quot;
 
 using namespace std;

Modified: trunk/rts/Lua/LuaUnitDefs.cpp
===================================================================
--- trunk/rts/Lua/LuaUnitDefs.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/Lua/LuaUnitDefs.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -51,7 +51,7 @@
 #include &quot;LogOutput.h&quot;
 #include &quot;FileSystem/FileHandler.h&quot;
 #include &quot;FileSystem/SimpleParser.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;Util.h&quot;
 
 using namespace std;

Modified: trunk/rts/Lua/LuaUnsyncedCtrl.cpp
===================================================================
--- trunk/rts/Lua/LuaUnsyncedCtrl.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/Lua/LuaUnsyncedCtrl.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -59,7 +59,7 @@
 #include &quot;Sound.h&quot;
 
 #include &quot;FileSystem/FileHandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 
 using namespace std;
 

Modified: trunk/rts/Lua/LuaUnsyncedRead.cpp
===================================================================
--- trunk/rts/Lua/LuaUnsyncedRead.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/Lua/LuaUnsyncedRead.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -55,7 +55,7 @@
 #include &quot;NetProtocol.h&quot;
 #include &quot;FileSystem/FileHandler.h&quot;
 #include &quot;FileSystem/VFSHandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;Sound.h&quot;
 
 

Modified: trunk/rts/Lua/LuaVFS.cpp
===================================================================
--- trunk/rts/Lua/LuaVFS.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/Lua/LuaVFS.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -24,7 +24,7 @@
 #include &quot;LogOutput.h&quot;
 #include &quot;FileSystem/FileHandler.h&quot;
 #include &quot;FileSystem/VFSHandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;Util.h&quot;
 
 

Modified: trunk/rts/Map/SM3/terrain/TerrainTextureGLSL.cpp
===================================================================
--- trunk/rts/Map/SM3/terrain/TerrainTextureGLSL.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/Map/SM3/terrain/TerrainTextureGLSL.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -35,7 +35,7 @@
 #include &quot;TerrainTextureGLSL.h&quot;
 #include &quot;Rendering/GL/IFramebuffer.h&quot;
 #include &quot;FileSystem/FileHandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;bitops.h&quot;
 #include &quot;Util.h&quot;
 #include &quot;GlobalUnsynced.h&quot;

Modified: trunk/rts/Map/SM3/terrain/Textures.cpp
===================================================================
--- trunk/rts/Map/SM3/terrain/Textures.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/Map/SM3/terrain/Textures.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -38,7 +38,7 @@
 #include &quot;TerrainNode.h&quot;
 #include &quot;Textures.h&quot;
 #include &quot;Rendering/Textures/Bitmap.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;float3.h&quot;
 
 

Modified: trunk/rts/Rendering/Textures/Bitmap.cpp
===================================================================
--- trunk/rts/Rendering/Textures/Bitmap.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/Rendering/Textures/Bitmap.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -24,7 +24,7 @@
 
 #include &quot;Rendering/GL/myGL.h&quot;
 #include &quot;FileSystem/FileHandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;Bitmap.h&quot;
 #include &quot;bitops.h&quot;
 

Modified: trunk/rts/Rendering/glFont.cpp
===================================================================
--- trunk/rts/Rendering/glFont.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/Rendering/glFont.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -13,7 +13,7 @@
 #include &quot;LogOutput.h&quot;
 #include &quot;Game/Camera.h&quot;
 #include &quot;myMath.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;GlobalUnsynced.h&quot;
 #include &quot;Util.h&quot;
 #include &quot;Exceptions.h&quot;

Modified: trunk/rts/Sim/Path/PathEstimator.cpp
===================================================================
--- trunk/rts/Sim/Path/PathEstimator.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/Sim/Path/PathEstimator.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -18,7 +18,7 @@
 #include &quot;Sim/Units/UnitDef.h&quot;
 
 #include &quot;FileSystem/ArchiveZip.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 
 #define PATHDEBUG false
 

Modified: trunk/rts/System/DemoRecorder.cpp
===================================================================
--- trunk/rts/System/DemoRecorder.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/System/DemoRecorder.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -8,7 +8,7 @@
 #include &quot;mmgr.h&quot;
 
 #include &quot;Sync/Syncify.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;FileSystem/FileHandler.h&quot;
 #include &quot;Game/GameVersion.h&quot;
 #include &quot;Game/GameSetup.h&quot;

Modified: trunk/rts/System/FileSystem/ArchiveDir.cpp
===================================================================
--- trunk/rts/System/FileSystem/ArchiveDir.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/System/FileSystem/ArchiveDir.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -4,7 +4,7 @@
 #include &quot;ArchiveDir.h&quot;
 #include &lt;assert.h&gt;
 #include &lt;stdexcept&gt;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;Util.h&quot;
 #include &quot;mmgr.h&quot;
 

Modified: trunk/rts/System/FileSystem/ArchiveFactory.cpp
===================================================================
--- trunk/rts/System/FileSystem/ArchiveFactory.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/System/FileSystem/ArchiveFactory.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -7,7 +7,7 @@
 #include &quot;ArchiveHPI.h&quot;
 #include &quot;ArchiveZip.h&quot;
 #include &quot;Archive7Zip.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem.h&quot;
 
 #include &quot;Util.h&quot;
 

Modified: trunk/rts/System/FileSystem/ArchiveScanner.cpp
===================================================================
--- trunk/rts/System/FileSystem/ArchiveScanner.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/System/FileSystem/ArchiveScanner.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -17,7 +17,7 @@
 #include &quot;CRC.h&quot;
 #include &quot;FileFilter.h&quot;
 #include &quot;FileHandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;Util.h&quot;
 #include &quot;Exceptions.h&quot;
 

Copied: trunk/rts/System/FileSystem/DataDirLocater.cpp (from rev 7013, trunk/rts/System/Platform/Linux/DataDirLocater.cpp)
===================================================================
--- trunk/rts/System/FileSystem/DataDirLocater.cpp	                        (rev 0)
+++ trunk/rts/System/FileSystem/DataDirLocater.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -0,0 +1,369 @@
+/**
+ * @file DataDirLocater.cpp
+ * @author Tobi Vollebregt
+ *
+ * Copyright (C) 2006-2008 Tobi Vollebregt
+ * Licensed under the terms of the GNU GPL, v2 or later
+ */
+
+#include &quot;StdAfx.h&quot;
+#include &quot;DataDirLocater.h&quot;
+
+#include &lt;cstdlib&gt;
+#ifdef WIN32
+	#include &lt;io.h&gt;
+  #include &lt;direct.h&gt;
+  #include &lt;windows.h&gt;
+	#include &lt;shlobj.h&gt;
+	#include &lt;shlwapi.h&gt;
+	#ifndef SHGFP_TYPE_CURRENT
+		#define SHGFP_TYPE_CURRENT 0
+	#endif
+#endif
+#include &lt;sstream&gt;
+#include &lt;string.h&gt;
+#include &quot;FileSystem/VFSHandler.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;Platform/ConfigHandler.h&quot;
+#include &quot;FileSystem.h&quot;
+#include &quot;mmgr.h&quot;
+#include &quot;Exceptions.h&quot;
+
+/**
+ * @brief construct a data directory object
+ *
+ * Appends a slash to the end of the path if there isn't one already.
+ */
+DataDir::DataDir(const std::string&amp; p) : path(p), writable(false)
+{
+#ifndef _WIN32
+	if (path.empty())
+		path = &quot;./&quot;;
+	if (path[path.size() - 1] != '/')
+		path += '/';
+#else
+	if (path.empty())
+		path = &quot;.\\&quot;;
+	if (path[path.size() - 1] != '\\')
+		path += '\\';
+#endif
+}
+
+/**
+ * @brief construct a data directory locater
+ *
+ * Does not locate data directories, use LocateDataDirs() for that.
+ */
+DataDirLocater::DataDirLocater() : writedir(NULL)
+{
+}
+
+/**
+ * @brief substitute environment variables with their values
+ */
+std::string DataDirLocater::SubstEnvVars(const std::string&amp; in) const
+{
+	bool escape = false;
+	std::ostringstream out;
+	for (std::string::const_iterator ch = in.begin(); ch != in.end(); ++ch) {
+		if (escape) {
+			escape = false;
+			out &lt;&lt; *ch;
+		} else {
+			switch (*ch) {
+#ifndef _WIN32
+				case '\\': {
+					escape = true;
+					break;
+				}
+#endif
+				case '$': {
+					std::ostringstream envvar;
+					for (++ch; ch != in.end() &amp;&amp; (isalnum(*ch) || *ch == '_'); ++ch)
+						envvar &lt;&lt; *ch;
+					--ch;
+					char* subst = getenv(envvar.str().c_str());
+					if (subst &amp;&amp; *subst)
+						out &lt;&lt; subst;
+					break;
+				}
+				default: {
+					out &lt;&lt; *ch;
+					break;
+				}
+			}
+		}
+	}
+	return out.str();
+}
+
+/**
+ * @brief Adds the directories in the colon separated string to the datadir handler.
+ */
+void DataDirLocater::AddDirs(const std::string&amp; in)
+{
+	size_t prev_colon = 0, colon;
+#ifndef _WIN32
+	while ((colon = in.find(':', prev_colon)) != std::string::npos) {
+#else
+	while ((colon = in.find(';', prev_colon)) != std::string::npos) {
+#endif
+		datadirs.push_back(in.substr(prev_colon, colon - prev_colon));
+#ifdef DEBUG
+		logOutput.Print(&quot;Adding %s to directories&quot; , in.substr(prev_colon, colon - prev_colon).c_str());
+#endif
+		prev_colon = colon + 1;
+	}
+#ifdef DEBUG
+	logOutput.Print(&quot;Adding %s to directories&quot; , in.substr(prev_colon).c_str());
+#endif
+	datadirs.push_back(in.substr(prev_colon));
+}
+
+/**
+ * @brief Figure out permissions we have for a single data directory d.
+ * @returns whether we have permissions to read the data directory.
+ */
+bool DataDirLocater::DeterminePermissions(DataDir* d)
+{
+#ifndef _WIN32
+	if (d-&gt;path.c_str()[0] != '/' || d-&gt;path.find(&quot;..&quot;) != std::string::npos)
+#else
+	if (d-&gt;path.find(&quot;..&quot;) != std::string::npos)
+#endif
+		throw content_error(&quot;specify data directories using absolute paths please&quot;);
+	// Figure out whether we have read/write permissions
+	// First check read access, if we got that check write access too
+	// (no support for write-only directories)
+	// Note: we check for executable bit otherwise we can't browse the directory
+	// Note: we fail to test whether the path actually is a directory
+	// Note: modifying permissions while or after this function runs has undefined behaviour
+#ifndef _WIN32
+	if (access(d-&gt;path.c_str(), R_OK | X_OK | F_OK) == 0) {
+		// Note: disallow multiple write directories.
+		// There isn't really a use for it as every thing is written to the first one anyway,
+		// and it may give funny effects on errors, e.g. it probably only gives funny things
+		// like network mounted datadir lost connection and suddenly files end up in some
+		// other random writedir you didn't even remember you had added it.
+		if (!writedir &amp;&amp; access(d-&gt;path.c_str(), W_OK) == 0) {
+#else
+	if (_access(d-&gt;path.c_str(), 4) == 0) {
+		if (!writedir &amp;&amp; _access(d-&gt;path.c_str(), 2) == 0) {
+#endif
+			d-&gt;writable = true;
+			writedir = &amp;*d;
+		}
+		return true;
+	} else {
+		if (filesystem.CreateDirectory(d-&gt;path)) {
+			// it didn't exist before, now it does and we just created it with rw access,
+			// so we just assume we still have read-write acces...
+			if (!writedir) {
+				d-&gt;writable = true;
+				writedir = d;
+			}
+			return true;
+		}
+	}
+	return false;
+}
+
+/**
+ * @brief Figure out permissions we have for the data directories.
+ */
+void DataDirLocater::DeterminePermissions()
+{
+	std::vector&lt;DataDir&gt; newDatadirs;
+	std::string previous; // used to filter out consecutive duplicates
+	// (I didn't bother filtering out non-consecutive duplicates because then
+	//  there is the question which of the multiple instances to purge.)
+
+	writedir = NULL;
+
+	for (std::vector&lt;DataDir&gt;::iterator d = datadirs.begin(); d != datadirs.end(); ++d) {
+		if (d-&gt;path != previous &amp;&amp; DeterminePermissions(&amp;*d)) {
+			newDatadirs.push_back(*d);
+			previous = d-&gt;path;
+		}
+	}
+
+	datadirs = newDatadirs;
+}
+
+/**
+ * @brief locate spring data directory
+ *
+ * On *nix platforms, attempts to locate
+ * and change to the spring data directory
+ *
+ * In Unixes, the data directory to chdir to is determined by the following, in this
+ * order (first items override lower items):
+ *
+ * - 'SPRING_DATADIR' environment variable. (colon separated list, like PATH)
+ * - 'SpringData=/path/to/data' declaration in '~/.springrc'. (colon separated list)
+ * - &quot;$HOME/.spring&quot;
+ * - In the same order any line in '/etc/spring/datadir', if that file exists.
+ * - 'datadir=/path/to/data' option passed to 'scons configure'.
+ * - 'prefix=/install/path' option passed to scons configure. The datadir is
+ *   assumed to be at '$prefix/games/spring' in this case.
+ * - the default datadirs in the default prefix, ie. '/usr/local/games/spring'
+ *   (This is set by the build system, ie. SPRING_DATADIR and SPRING_DATADIR_2
+ *   preprocessor definitions.)
+ *
+ * In Windows, its:
+ * - SPRING_DATADIR env-variable
+ * - user configurable (SpringData in registry)
+ * - location of the binary dir (like it has been until 0.76b1)
+ * - the Users 'Documents'-directory (in subdirectory Spring), unless spring is configured to use another
+ * - all users app-data (in subdirectory Spring)
+ * - compiler flags SPRING_DATADIR and SPRING_DATADIR_2
+ *
+ * All of the above methods support environment variable substitution, eg.
+ * '$HOME/myspringdatadir' will be converted by spring to something like
+ * '/home/username/myspringdatadir'.
+ *
+ * If it fails to chdir to the above specified directory spring will asume the
+ * current working directory is the data directory.
+ */
+void DataDirLocater::LocateDataDirs()
+{
+	// Construct the list of datadirs from various sources.
+	datadirs.clear();
+
+	// environment variable
+	char* env = getenv(&quot;SPRING_DATADIR&quot;);
+	if (env &amp;&amp; *env)
+		AddDirs(SubstEnvVars(env));
+
+	// user defined (in spring config handler (Linux: ~/.springrc, Windows: registry))
+	std::string userDef = configHandler.GetString(&quot;SpringData&quot;, &quot;&quot;);
+	if (!userDef.empty()) {
+		AddDirs(SubstEnvVars(userDef));
+	}
+
+#ifdef WIN32
+	TCHAR currentDir[MAX_PATH];
+	::GetCurrentDirectory(sizeof(currentDir) - 1, currentDir);
+	std::string curPath = currentDir;
+	AddDirs(std::string(currentDir));
+
+	// my documents
+	TCHAR strPath[MAX_PATH];
+	SHGetFolderPath( NULL, CSIDL_PERSONAL, NULL, SHGFP_TYPE_CURRENT, strPath);
+	std::string cfg = strPath;
+	cfg += &quot;\\Spring&quot;; // e.g. F:\Dokumente und Einstellungen\Karl-Robert\Eigene Dateien\Spring
+	AddDirs(cfg);
+	cfg.clear();
+
+	// appdata
+	SHGetFolderPath( NULL, CSIDL_COMMON_APPDATA, NULL, SHGFP_TYPE_CURRENT, strPath);
+	cfg = strPath;
+	cfg += &quot;\\Spring&quot;; // e.g. F:\Dokumente und Einstellungen\All Users\Anwendungsdaten\Spring
+	AddDirs(cfg);
+#elif defined(__APPLE__)
+	// copied from old MacFileSystemHandler, won't compile here, but would not compile in its old location either
+	// needs fixing for new DataDirLocater-structure
+	// Get the path to the application bundle we are running:
+	char cPath[1024];
+	CFBundleRef mainBundle = CFBundleGetMainBundle();
+	if(!mainBundle)
+		throw content_error(&quot;Could not determine bundle path&quot;);
+
+	CFURLRef mainBundleURL = CFBundleCopyBundleURL(mainBundle);
+	if(!mainBundleURL)
+		throw content_error(&quot;Could not determine bundle path&quot;);
+
+	CFStringRef cfStringRef = CFURLCopyFileSystemPath(mainBundleURL, kCFURLPOSIXPathStyle);
+	if(!cfStringRef)
+		throw content_error(&quot;Could not determine bundle path&quot;);
+
+	CFStringGetCString(cfStringRef, cPath, 1024, kCFStringEncodingASCII);
+
+	CFRelease(mainBundleURL);
+	CFRelease(cfStringRef);
+	std::string path(cPath);
+	
+	datadirs.clear();
+	writedir = NULL;
+	
+	// Add bundle resources:
+	datadirs.push_back(path + &quot;/Contents/Resources/&quot;);
+	datadirs.rbegin()-&gt;readable = true;
+	// Add the directory surrounding the bundle, for users to add mods and maps in:
+	datadirs.push_back(filesystem.GetDirectory(path));
+	// Use surrounding directory as writedir for now, should propably
+	// change this to something inside the home directory:
+	datadirs.rbegin()-&gt;writable = true;
+	datadirs.rbegin()-&gt;readable = true;
+	writedir = &amp;*datadirs.rbegin();
+#else
+	// home
+	AddDirs(SubstEnvVars(&quot;$HOME/.spring&quot;));
+
+	// settings in /etc
+	FILE* f = ::fopen(&quot;/etc/spring/datadir&quot;, &quot;r&quot;);
+	if (f) {
+		char buf[1024];
+		while (fgets(buf, sizeof(buf), f)) {
+			char* newl = strchr(buf, '\n');
+			if (newl)
+				*newl = 0;
+			char white[3] = {'\t', ' ', 0};
+			if (strlen(buf) &gt; 0 &amp;&amp; strspn(buf, white) != strlen(buf)) // don't count lines of whitespaces / tabulators
+				AddDirs(SubstEnvVars(buf));
+		}
+		fclose(f);
+	}
+#endif
+
+	// compiler flags
+#ifdef SPRING_DATADIR
+	datadirs.push_back(SubstEnvVars(SPRING_DATADIR));
+#endif
+	// should not be needed because you can seperate directories with a ':' in SPRING_DATADIR(1)
+#ifdef SPRING_DATADIR_2
+	datadirs.push_back(SubstEnvVars(SPRING_DATADIR_2));
+#endif
+
+	// Figure out permissions of all datadirs
+	DeterminePermissions();
+
+	if (!writedir) {
+		// bail out
+#ifdef WIN32
+		const std::string errstr = &quot;Not a single writable data directory found!\n\n&quot;
+				&quot;Configure a writable data directory using either:\n&quot;
+				&quot;- the SPRING_DATADIR environment variable,\n&quot;
+				&quot;- a SpringData=C:/path/to/data declaration in spring's registry entry or\n&quot;
+				&quot;- by giving you write access to the installation directory&quot;;
+#else
+		const std::string errstr = &quot;Not a single writable data directory found!\n\n&quot;
+				&quot;Configure a writable data directory using either:\n&quot;
+				&quot;- the SPRING_DATADIR environment variable,\n&quot;
+				&quot;- a SpringData=/path/to/data declaration in ~/.springrc or\n&quot;
+				&quot;- the configuration file /etc/spring/datadir&quot;;
+#endif
+		throw content_error(errstr);
+	}
+
+	// for now, chdir to the datadirectory as a safety measure:
+	// all AIs still just assume it's ok to put their stuff in the current directory after all
+	// Not only safety anymore, it's just easier if other code can safely assume that
+	// writedir == current working directory
+#ifndef _WIN32
+	chdir(GetWriteDir()-&gt;path.c_str());
+#else
+	_chdir(GetWriteDir()-&gt;path.c_str());
+#endif
+	// Initialize the log. Only after this moment log will be written to file.
+	logOutput.Initialize();
+	// Logging MAY NOT start before the chdir, otherwise the logfile ends up
+	// in the wrong directory.
+	// Update: now it actually may start before, log has preInitLog.
+	for (std::vector&lt;DataDir&gt;::const_iterator d = datadirs.begin(); d != datadirs.end(); ++d) {
+		if (d-&gt;writable)
+			logOutput.Print(&quot;Using read-write data directory: %s&quot;, d-&gt;path.c_str());
+		else
+			logOutput.Print(&quot;Using read-only  data directory: %s&quot;, d-&gt;path.c_str());
+	}
+}


Property changes on: trunk/rts/System/FileSystem/DataDirLocater.cpp
___________________________________________________________________
Name: svn:mergeinfo
   + 
Name: svn:eol-style
   + native

Copied: trunk/rts/System/FileSystem/DataDirLocater.h (from rev 7013, trunk/rts/System/Platform/Linux/DataDirLocater.h)
===================================================================
--- trunk/rts/System/FileSystem/DataDirLocater.h	                        (rev 0)
+++ trunk/rts/System/FileSystem/DataDirLocater.h	2008-11-10 23:35:19 UTC (rev 7014)
@@ -0,0 +1,40 @@
+/**
+ * @file DataDirLocater.h
+ * @author Tobi Vollebregt
+ *
+ * Copyright (C) 2006-2008 Tobi Vollebregt
+ * Licensed under the terms of the GNU GPL, v2 or later
+ */
+#ifndef DATADIRLOCATER_H
+#define DATADIRLOCATER_H
+
+#include &lt;string&gt;
+#include &lt;vector&gt;
+
+struct DataDir
+{
+	DataDir(const std::string&amp; p);
+	std::string path;
+	bool writable;
+};
+
+class DataDirLocater
+{
+public:
+	DataDirLocater();
+	void LocateDataDirs();
+
+	const std::vector&lt;DataDir&gt;&amp; GetDataDirs() const { return datadirs; }
+	const DataDir* GetWriteDir() const { return writedir; }
+
+private:
+	std::string SubstEnvVars(const std::string&amp; in) const;
+	void AddDirs(const std::string&amp; in);
+	bool DeterminePermissions(DataDir* d);
+	void DeterminePermissions();
+
+	std::vector&lt;DataDir&gt; datadirs;
+	const DataDir* writedir;
+};
+
+#endif // !defined(DATADIRLOCATER_H)


Property changes on: trunk/rts/System/FileSystem/DataDirLocater.h
___________________________________________________________________
Name: svn:mergeinfo
   + 
Name: svn:eol-style
   + native

Modified: trunk/rts/System/FileSystem/FileHandler.cpp
===================================================================
--- trunk/rts/System/FileSystem/FileHandler.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/System/FileSystem/FileHandler.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -9,7 +9,7 @@
 
 #include &quot;FileHandler.h&quot;
 #include &quot;VFSHandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 
 #include &quot;Util.h&quot;
 using namespace std;

Copied: trunk/rts/System/FileSystem/FileSystem.cpp (from rev 7013, trunk/rts/System/Platform/FileSystem.cpp)
===================================================================
--- trunk/rts/System/FileSystem/FileSystem.cpp	                        (rev 0)
+++ trunk/rts/System/FileSystem/FileSystem.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -0,0 +1,421 @@
+/**
+ * @file FileSystem.cpp
+ * @brief Abstracts locating of content on different platforms
+ * @author Tobi Vollebregt
+ *
+ * FindFiles implementation by Chris Han.
+ * Glob conversion by Chris Han (based on work by Nathaniel Smith).
+ * Copyright (C) 2005-2006.  Licensed under the terms of the
+ * GNU GPL, v2 or later
+ */
+
+#include &quot;StdAfx.h&quot;
+#include &lt;assert.h&gt;
+#include &lt;limits.h&gt;
+#include &lt;boost/regex.hpp&gt;
+#include &lt;fstream&gt;
+#include &lt;sys/stat.h&gt;
+#include &lt;sys/types.h&gt;
+#include &quot;FileSystem.h&quot;
+
+#include &quot;UnixFileSystemHandler.h&quot;
+
+#include &quot;FileSystem/ArchiveScanner.h&quot;
+#include &quot;FileSystem/VFSHandler.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;Util.h&quot;
+#include &quot;mmgr.h&quot;
+
+
+#define fs (FileSystemHandler::GetInstance())
+
+FileSystem filesystem;
+
+
+////////////////////////////////////////
+////////// FileSystemHandler
+
+/**
+ * @brief The global data directory handler instance
+ */
+FileSystemHandler* FileSystemHandler::instance = NULL;
+
+/**
+ * @brief get the data directory handler instance
+ */
+FileSystemHandler&amp; FileSystemHandler::GetInstance()
+{
+	if (!instance)
+		Initialize(false);
+	return *instance;
+}
+
+/**
+ * @brief initialize the data directory handler
+ */
+void FileSystemHandler::Initialize(bool verbose)
+{
+	if (!instance) {
+		// FIXME this leaks memory
+		instance = new UnixFileSystemHandler(verbose);
+		try {
+			instance-&gt;Initialize();
+		}
+		catch (...) {
+			SafeDelete(instance);
+			throw;
+		}
+	}
+}
+
+void FileSystemHandler::Cleanup()
+{
+	SafeDelete(instance);
+}
+
+FileSystemHandler::~FileSystemHandler()
+{
+	SafeDelete(archiveScanner);
+	SafeDelete(vfsHandler);
+}
+
+FileSystemHandler::FileSystemHandler(int native_path_sep): native_path_separator(native_path_sep)
+{
+	// NOTE TO SELF: NEVER EVAR DO THIS AGAIN THIS WAY
+
+	// combined with init code in constructor and exceptions being thrown
+	// when this init code fails it results in dangling pointers.
+
+	// (if constructor throws exception object doesn't exist, by definition,
+	//  but global variable instance would still point to it....)
+
+//	// need to set this here already or we get stuck in an infinite loop
+//	// because WinFileSystemHandler/UnixFileSystemHandler ctor initializes the
+//	// ArchiveScanner (which uses FileSystemHandler::GetInstance again...).
+//	instance = this;
+}
+
+////////////////////////////////////////
+////////// FileSystem
+
+/**
+ * @brief quote macro
+ * @param c Character to test
+ * @param str string currently being built
+ *
+ * Given a string str that we're assembling,
+ * and an upcoming character c, will append
+ * an extra '\\' to quote the character if necessary.
+ */
+#define QUOTE(c,str)			\
+	do {					\
+		if (!(isalnum(c)||(c)=='_'))	\
+			str+='\\';		\
+		str+=c;				\
+} while (0)
+
+/**
+ * @brief glob to regex
+ * @param glob string containing glob
+ * @return string containing regex
+ *
+ * Converts a glob expression to a regex
+ */
+std::string FileSystem::glob_to_regex(const std::string&amp; glob) const
+{
+	std::string regex;
+	regex.reserve(glob.size()&lt;&lt;1);
+	int braces = 0;
+	for (std::string::const_iterator i = glob.begin(); i != glob.end(); ++i) {
+		char c = *i;
+#ifdef DEBUG
+		if (braces&gt;=5)
+			logOutput.Print(&quot;glob_to_regex warning: braces nested too deeply\n%s&quot;, glob.c_str());
+#endif
+		switch (c) {
+			case '*':
+				regex+=&quot;.*&quot;;
+				break;
+			case '?':
+				regex+='.';
+				break;
+			case '{':
+				braces++;
+				regex+='(';
+				break;
+			case '}':
+#ifdef DEBUG
+				if (!braces)
+					logOutput.Print(&quot;glob_to_regex warning: closing brace without an equivalent opening brace\n%s&quot;, glob.c_str());
+#endif
+				regex+=')';
+				braces--;
+				break;
+			case ',':
+				if (braces)
+					regex+='|';
+				else
+					QUOTE(c,regex);
+				break;
+			case '\\':
+#ifdef DEBUG
+				if (++i==glob.end())
+					logOutput.Print(&quot;glob_to_regex warning: pattern ends with backslash\n%s&quot;, glob.c_str());
+#else
+				++i;
+#endif
+				QUOTE(*i,regex);
+				break;
+			default:
+				QUOTE(c,regex);
+				break;
+		}
+	}
+#ifdef DEBUG
+	if (braces)
+		logOutput.Print(&quot;glob_to_regex warning: unterminated brace expression\n%s&quot;, glob.c_str());
+#endif
+	return regex;
+}
+
+/**
+ * @brief get filesize
+ *
+ * @return the filesize or 0 if the file doesn't exist.
+ */
+size_t FileSystem::GetFilesize(std::string file) const
+{
+	if (!CheckFile(file))
+		return 0;
+	FixSlashes(file);
+	struct stat info;
+	if (stat(file.c_str(), &amp;info) != 0)
+		return 0;
+	return info.st_size;
+}
+
+/**
+ * @brief create a directory
+ *
+ * Works like mkdir -p, ie. attempts to create parent directories too.
+ * Operates on the current working directory.
+ */
+bool FileSystem::CreateDirectory(std::string dir) const
+{
+	if (!CheckFile(dir))
+		return false;
+
+	ForwardSlashes(dir);
+	size_t prev_slash = 0, slash;
+	while ((slash = dir.find('/', prev_slash + 1)) != std::string::npos) {
+		if (!fs.mkdir(dir.substr(0, slash)))
+			return false;
+		prev_slash = slash;
+	}
+	return fs.mkdir(dir);
+}
+
+
+/**
+ * @brief find files
+ *
+ * Compiles a std::vector of all files below dir that match pattern.
+ *
+ * If FileSystem::RECURSE flag is set it recurses into subdirectories.
+ * If FileSystem::INCLUDE_DIRS flag is set it includes directories in the
+ * result too, as long as they match the pattern.
+ *
+ * Note that pattern doesn't apply to the names of recursed directories,
+ * it does apply to the files inside though.
+ */
+std::vector&lt;std::string&gt; FileSystem::FindFiles(std::string dir, const std::string&amp; pattern, int flags) const
+{
+	if (!CheckFile(dir)) {
+		return std::vector&lt;std::string&gt;();
+	}
+
+	if (dir.empty()) {
+		dir = &quot;./&quot;;
+	}
+	else {
+		const char lastChar = dir[dir.length() - 1];
+		if ((lastChar != '/') &amp;&amp; (lastChar != '\\')) {
+			dir += '/';
+		}
+	}
+
+	FixSlashes(dir);
+
+	if (flags &amp; ONLY_DIRS) {
+		flags |= INCLUDE_DIRS;
+	}
+
+	return fs.FindFiles(dir, pattern, flags);
+}
+
+
+/**
+ * @brief get the directory part of a path
+ */
+std::string FileSystem::GetDirectory(const std::string&amp; path) const
+{
+	size_t s = path.find_last_of('/');
+	size_t bs = path.find_last_of('\\');
+	if (s != std::string::npos &amp;&amp; bs != std::string::npos)
+		return path.substr(0, std::max(s, bs) + 1);
+	if (s != std::string::npos)
+		return path.substr(0, s + 1);
+	if (bs != std::string::npos)
+		return path.substr(0, bs + 1);
+	return path;
+}
+
+/**
+ * @brief get the filename part of a path
+ */
+std::string FileSystem::GetFilename(const std::string&amp; path) const
+{
+	size_t s = path.find_last_of('/');
+	size_t bs = path.find_last_of('\\');
+	if (s != std::string::npos &amp;&amp; bs != std::string::npos)
+		return path.substr(std::max(s, bs) + 1);
+	if (s != std::string::npos)
+		return path.substr(s + 1);
+	if (bs != std::string::npos)
+		return path.substr(bs + 1);
+	return path;
+}
+
+/**
+ * @brief get the basename part of a path, ie. the filename without extension
+ */
+std::string FileSystem::GetBasename(const std::string&amp; path) const
+{
+	std::string fn = GetFilename(path);
+	size_t dot = fn.find_last_of('.');
+	if (dot != std::string::npos)
+		return fn.substr(0, dot);
+	return fn;
+}
+
+/**
+ * @brief get the extension of the filename part of the path
+ */
+std::string FileSystem::GetExtension(const std::string&amp; path) const
+{
+	std::string fn = GetFilename(path);
+	size_t dot = fn.find_last_of('.');
+	if (dot != std::string::npos)
+		return fn.substr(dot + 1);
+	return &quot;&quot;;
+}
+
+/**
+ * @brief converts all slashes and backslashes in path to the native_path_separator
+ */
+std::string&amp; FileSystem::FixSlashes(std::string&amp; path) const
+{
+	int sep = fs.GetNativePathSeparator();
+	for (unsigned i = 0; i &lt; path.size(); ++i)
+		if (path[i] == '/' || path[i] == '\\')
+			path[i] = sep;
+	return path;
+}
+
+/**
+ * @brief converts backslashes in path to forward slashes
+ */
+std::string&amp; FileSystem::ForwardSlashes(std::string&amp; path) const
+{
+	for (unsigned i = 0; i &lt; path.size(); ++i)
+		if (path[i] == '\\')
+			path[i] = '/';
+	return path;
+}
+
+/**
+ * @brief does a little checking of a filename
+ */
+bool FileSystem::CheckFile(const std::string&amp; file) const
+{
+	// Don't allow code to escape from the data directories.
+	// Note: this does NOT mean this is a SAFE fopen function:
+	// symlink-, hardlink-, you name it-attacks are all very well possible.
+	// The check is just ment to &quot;enforce&quot; certain coding behaviour.
+	if (file.find(&quot;..&quot;) != std::string::npos)
+		return false;
+
+	return true;
+}
+
+/**
+ * @brief does a little checking of a modestring
+ */
+bool FileSystem::CheckMode(const char* mode) const
+{
+	assert(mode &amp;&amp; *mode);
+	return true;
+}
+
+/**
+ * @brief locate a file
+ *
+ * Attempts to locate a file.
+ *
+ * If the FileSystem::WRITE flag is set, it just returns the argument
+ * (assuming the file should come in the current working directory).
+ * If FileSystem::CREATE_DIRS is set it tries to create the subdirectory
+ * the file should live in.
+ *
+ * Otherwise (if flags == 0), it dispatches the call to
+ * FileSystemHandler::LocateFile(), which either searches for it in multiple
+ * data directories (UNIX) or just returns the argument (Windows).
+ */
+std::string FileSystem::LocateFile(std::string file, int flags) const
+{
+	if (!CheckFile(file)) {
+		return &quot;&quot;;
+	}
+
+	FixSlashes(file);
+
+	if (flags &amp; WRITE) {
+		if (flags &amp; CREATE_DIRS) {
+			CreateDirectory(GetDirectory(file));
+		}
+		return file;
+	}
+
+	return fs.LocateFile(file);
+}
+
+
+bool FileSystem::InReadDir(const std::string&amp; path)
+{
+	if (path.find(&quot;..&quot;) != std::string::npos) {
+		return false; // realpath() would be nice
+	}
+	const std::vector&lt;std::string&gt; readDirs = fs.GetDataDirectories();
+	return true;
+}
+
+
+bool FileSystem::InWriteDir(const std::string&amp; path, const std::string&amp; prefix)
+{
+	const std::string writeDir = fs.GetWriteDir();
+	return true;
+}
+
+
+/**
+ * @brief remove a file
+ *
+ * Operates on the current working directory.
+ */
+bool FileSystem::Remove(std::string file) const
+{
+	if (!CheckFile(file))
+		return false;
+	FixSlashes(file);
+	return ::remove(file.c_str()) == 0;
+}


Property changes on: trunk/rts/System/FileSystem/FileSystem.cpp
___________________________________________________________________
Name: svn:mergeinfo
   + 
Name: svn:eol-style
   + native

Copied: trunk/rts/System/FileSystem/FileSystem.h (from rev 7013, trunk/rts/System/Platform/FileSystem.h)
===================================================================
--- trunk/rts/System/FileSystem/FileSystem.h	                        (rev 0)
+++ trunk/rts/System/FileSystem/FileSystem.h	2008-11-10 23:35:19 UTC (rev 7014)
@@ -0,0 +1,113 @@
+/**
+ * @file FileSystem.h
+ * @brief Abstracts locating of content on different platforms
+ * @author Tobi Vollebregt
+ *
+ * Copyright (C) 2006.  Licensed under the terms of the
+ * GNU GPL, v2 or later
+ */
+
+#ifndef FILESYSTEM_H
+#define FILESYSTEM_H
+
+#include &lt;vector&gt;
+#include &lt;string&gt;
+
+// winapi redifines this which breaks things
+#if defined(CreateDirectory)
+# undef CreateDirectory
+#endif
+
+/**
+ * @brief native file system handling abstraction
+ */
+class FileSystemHandler
+{
+	public:
+
+		static FileSystemHandler&amp; GetInstance();
+		static void Initialize(bool verbose);
+		static void Cleanup();
+
+		virtual ~FileSystemHandler();
+		FileSystemHandler(int native_path_sep = '/');
+		virtual void Initialize() = 0;
+
+		// almost direct wrappers to system calls
+		virtual bool mkdir(const std::string&amp; dir) const = 0;
+
+		// custom functions
+		virtual std::vector&lt;std::string&gt; FindFiles(const std::string&amp; dir, const std::string&amp; pattern, int flags) const = 0;
+		virtual std::string LocateFile(const std::string&amp; file) const = 0;
+		virtual std::string GetWriteDir() const = 0;
+		virtual std::vector&lt;std::string&gt; GetDataDirectories() const = 0;
+
+		int GetNativePathSeparator() const { return native_path_separator; }
+
+	protected:
+
+		static FileSystemHandler* instance;
+
+		const int native_path_separator;
+};
+
+/**
+ * @brief filesystem interface
+ *
+ * Use this from the rest of the spring code!
+ */
+class FileSystem
+{
+	public:
+		// flags for FindFiles
+		enum FindFilesBits {
+			RECURSE      = (1 &lt;&lt; 0),
+			INCLUDE_DIRS = (1 &lt;&lt; 1),
+			ONLY_DIRS    = (1 &lt;&lt; 2),
+		};
+		// flags for LocateFile
+		enum LocateFileBits {
+			WRITE       = (1 &lt;&lt; 0),
+			CREATE_DIRS = (1 &lt;&lt; 1),
+		};
+
+	public:
+		FileSystem() {}
+
+		// generic functions
+		std::string LocateFile(std::string file, int flags = 0) const;
+		bool Remove(std::string file) const;
+
+		// metadata read functions
+		size_t GetFilesize(std::string path) const;
+
+		// directory functions
+		bool CreateDirectory(std::string dir) const;
+		std::vector&lt;std::string&gt; FindFiles(std::string dir, const std::string&amp; pattern, int flags = 0) const;
+
+		// convenience functions
+		std::string GetDirectory (const std::string&amp; path) const;
+		std::string GetFilename  (const std::string&amp; path) const;
+		std::string GetBasename  (const std::string&amp; path) const;
+		std::string GetExtension (const std::string&amp; path) const;
+		std::string glob_to_regex(const std::string&amp; glob) const;
+		std::string&amp; FixSlashes  (std::string&amp; path) const;
+		std::string&amp; ForwardSlashes(std::string&amp; path) const;
+
+		// access check functions
+		bool InReadDir(const std::string&amp; path);
+		bool InWriteDir(const std::string&amp; path, const std::string&amp; prefix = &quot;&quot;);
+
+	private:
+		bool CheckFile(const std::string&amp; file) const;
+		bool CheckDir(const std::string&amp; dir) const;
+		bool CheckMode(const char* mode) const;
+
+		FileSystem(const FileSystem&amp;);
+		FileSystem&amp; operator=(const FileSystem&amp;);
+};
+
+// basically acts like a namespace, but with semantics like configHandler has
+extern FileSystem filesystem;
+
+#endif // !FILESYSTEM_H


Property changes on: trunk/rts/System/FileSystem/FileSystem.h
___________________________________________________________________
Name: svn:mergeinfo
   + 
Name: svn:eol-style
   + native

Copied: trunk/rts/System/FileSystem/UnixFileSystemHandler.cpp (from rev 7013, trunk/rts/System/Platform/Linux/UnixFileSystemHandler.cpp)
===================================================================
--- trunk/rts/System/FileSystem/UnixFileSystemHandler.cpp	                        (rev 0)
+++ trunk/rts/System/FileSystem/UnixFileSystemHandler.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -0,0 +1,312 @@
+/**
+ * @file UnixFileSystemHandler.cpp
+ * @brief Abstracts locating of content on different platforms
+ * @author Tobi Vollebregt
+ *
+ * Linux and Windows implementation, supporting multiple data directories / search paths.
+ *
+ * Copyright (C) 2006-2008 Tobi Vollebregt.
+ * Licensed under the terms of the GNU GPL, v2 or later
+ */
+
+#include &quot;UnixFileSystemHandler.h&quot;
+#include &lt;limits.h&gt;
+#include &lt;boost/regex.hpp&gt;
+#include &lt;sys/stat.h&gt;
+#include &lt;sys/types.h&gt;
+#ifndef _WIN32
+#include &lt;dirent.h&gt;
+#include &lt;sstream&gt;
+#include &lt;unistd.h&gt;
+#else
+#include &lt;windows.h&gt;
+#include &lt;io.h&gt;
+#include &lt;direct.h&gt;
+#endif
+#include &quot;ArchiveScanner.h&quot;
+#include &quot;VFSHandler.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;Platform/ConfigHandler.h&quot;
+#include &quot;mmgr.h&quot;
+
+/**
+ * @brief Creates the archive scanner and vfs handler
+ *
+ * For the archiveScanner, it keeps cache data (&quot;archivecache.txt&quot;) in the
+ * writedir. Cache data in other directories is ignored.
+ * It scans maps, base and mods subdirectories of all readable datadirs
+ * for archives. Archives in higher priority datadirs override archives
+ * in lower priority datadirs.
+ *
+ * Note that the archive namespace is global, ie. each archive basename may
+ * only occur once in all data directories. If a name is found more then once,
+ * then higher priority datadirs override lower priority datadirs and per
+ * datadir the 'mods' subdir overrides 'base' which overrides 'maps'.
+ */
+void UnixFileSystemHandler::InitVFS() const
+{
+	const DataDir* writedir = locater.GetWriteDir();
+	const std::vector&lt;DataDir&gt;&amp; datadirs = locater.GetDataDirs();
+
+	archiveScanner = new CArchiveScanner();
+
+	archiveScanner-&gt;ReadCacheData(writedir-&gt;path + archiveScanner-&gt;GetFilename());
+
+	std::vector&lt;std::string&gt; scanDirs;
+	for (std::vector&lt;DataDir&gt;::const_reverse_iterator d = datadirs.rbegin(); d != datadirs.rend(); ++d) {
+		scanDirs.push_back(d-&gt;path + &quot;maps&quot;);
+		scanDirs.push_back(d-&gt;path + &quot;base&quot;);
+		scanDirs.push_back(d-&gt;path + &quot;mods&quot;);
+	}
+	archiveScanner-&gt;ScanDirs(scanDirs, true);
+
+	archiveScanner-&gt;WriteCacheData(writedir-&gt;path + archiveScanner-&gt;GetFilename());
+
+	vfsHandler = new CVFSHandler();
+}
+
+
+/**
+ * @brief Creates the archive scanner and vfs handler
+ *
+ * Locates data directories and initializes the VFS.
+ */
+UnixFileSystemHandler::UnixFileSystemHandler(bool verbose) :
+#ifndef _WIN32
+		FileSystemHandler('/')
+#else
+		FileSystemHandler('\\')
+#endif
+{
+}
+
+
+void UnixFileSystemHandler::Initialize()
+{
+	locater.LocateDataDirs();
+	InitVFS();
+}
+
+
+UnixFileSystemHandler::~UnixFileSystemHandler()
+{
+	configHandler.Deallocate();
+}
+
+
+/**
+ * @brief returns the highest priority writable directory, aka the writedir
+ */
+std::string UnixFileSystemHandler::GetWriteDir() const
+{
+	const DataDir* writedir = locater.GetWriteDir();
+	assert(writedir &amp;&amp; writedir-&gt;writable); // duh
+	return writedir-&gt;path;
+}
+
+
+/**
+ * @brief find files
+ * @param dir path in which to start looking (tried relative to each data directory)
+ * @param pattern pattern to search for
+ * @param recurse whether or not to recursively search
+ * @param include_dirs whether or not to include directory names in the result
+ * @return vector of std::strings containing absolute paths to the files
+ *
+ * Will search for a file given a particular pattern.
+ * Starts from dirpath, descending down if recurse is true.
+ */
+std::vector&lt;std::string&gt; UnixFileSystemHandler::FindFiles(const std::string&amp; dir, const std::string&amp; pattern, int flags) const
+{
+	std::vector&lt;std::string&gt; matches;
+
+	// if it's an absolute path, don't look for it in the data directories
+	if ((dir[0] == '/') || ((dir.length() &gt; 1) &amp;&amp; (dir[1] == ':'))) {
+		FindFilesSingleDir(matches, dir, pattern, flags);
+		return matches;
+	}
+
+	const std::vector&lt;DataDir&gt;&amp; datadirs = locater.GetDataDirs();
+	for (std::vector&lt;DataDir&gt;::const_reverse_iterator d = datadirs.rbegin(); d != datadirs.rend(); ++d) {
+		FindFilesSingleDir(matches, d-&gt;path + dir, pattern, flags);
+	}
+	return matches;
+}
+
+
+std::string UnixFileSystemHandler::LocateFile(const std::string&amp; file) const
+{
+	// if it's an absolute path, don't look for it in the data directories
+#ifdef WIN32
+	if ((file.length() &gt; 1) &amp;&amp; (file[1] == ':')) {
+		return file;
+	}
+
+	const std::vector&lt;DataDir&gt;&amp; datadirs = locater.GetDataDirs();
+	for (std::vector&lt;DataDir&gt;::const_iterator d = datadirs.begin(); d != datadirs.end(); ++d) {
+		std::string fn(d-&gt;path + file);
+		if (_access(fn.c_str(), 4) == 0) {
+			return fn;
+		}
+	}
+	return file;
+#else
+	if (file[0] == '/') {
+		return file;
+	}
+
+	const std::vector&lt;DataDir&gt;&amp; datadirs = locater.GetDataDirs();
+	for (std::vector&lt;DataDir&gt;::const_iterator d = datadirs.begin(); d != datadirs.end(); ++d) {
+		std::string fn(d-&gt;path + file);
+		if (access(fn.c_str(), R_OK | F_OK) == 0) {
+			return fn;
+		}
+	}
+	return file;
+#endif
+}
+
+
+std::vector&lt;std::string&gt; UnixFileSystemHandler::GetDataDirectories() const
+{
+	std::vector&lt;std::string&gt; f;
+
+	const std::vector&lt;DataDir&gt;&amp; datadirs = locater.GetDataDirs();
+	for (std::vector&lt;DataDir&gt;::const_iterator d = datadirs.begin(); d != datadirs.end(); ++d) {
+		f.push_back(d-&gt;path);
+	}
+	return f;
+}
+
+
+/**
+ * @brief creates a rwxr-xr-x dir in the writedir
+ *
+ * Returns true if the postcondition of this function is that dir exists in
+ * the write directory.
+ *
+ * Note that this function does not check access to the dir, ie. if you've
+ * created it manually with 0000 permissions then this function may return
+ * true, subsequent operation on files inside the directory may still fail.
+ *
+ * As a rule of thumb, set identical permissions on identical items in the
+ * data directory, ie. all subdirectories the same perms, all files the same
+ * perms.
+ */
+bool UnixFileSystemHandler::mkdir(const std::string&amp; dir) const
+{
+#ifdef _WIN32
+	struct _stat info;
+
+	// First check if directory exists. We'll return success if it does.
+	if (_stat(dir.c_str(), &amp;info) == 0 &amp;&amp; (info.st_mode&amp;_S_IFDIR))
+		return true;
+#else
+	struct stat info;
+
+	// First check if directory exists. We'll return success if it does.
+	if (stat(dir.c_str(), &amp;info) == 0 &amp;&amp; S_ISDIR(info.st_mode))
+		return true;
+#endif
+	// If it doesn't exist we try to mkdir it and return success if that succeeds.
+#ifndef _WIN32
+	if (::mkdir(dir.c_str(), S_IRWXU | S_IRGRP | S_IXGRP | S_IROTH | S_IXOTH) == 0)
+#else
+	if (::_mkdir(dir.c_str()) == 0)
+#endif
+		return true;
+
+	// Otherwise we return false.
+	return false;
+}
+
+
+static void FindFiles(std::vector&lt;std::string&gt;&amp; matches, const std::string&amp; dir, const boost::regex &amp;regexpattern, int flags)
+{
+#ifdef _WIN32
+	WIN32_FIND_DATA wfd;
+  HANDLE hFind = FindFirstFile((dir+&quot;\\*&quot;).c_str(), &amp;wfd);
+
+	if (hFind != INVALID_HANDLE_VALUE) {
+		do {
+			if(strcmp(wfd.cFileName,&quot;.&quot;) &amp;&amp; strcmp(wfd.cFileName ,&quot;..&quot;)) {
+				if(!(wfd.dwFileAttributes&amp;FILE_ATTRIBUTE_DIRECTORY)) {
+					if ((flags &amp; FileSystem::ONLY_DIRS) == 0) {
+						if (boost::regex_match(wfd.cFileName, regexpattern)) {
+							matches.push_back(dir + wfd.cFileName);
+						}
+					}
+				}
+				else {
+					if (flags &amp; FileSystem::INCLUDE_DIRS) {
+						if (boost::regex_match(wfd.cFileName, regexpattern)) {
+							matches.push_back(dir + wfd.cFileName + &quot;\\&quot;);
+						}
+					}
+					if (flags &amp; FileSystem::RECURSE) {
+						FindFiles(matches, dir + wfd.cFileName + &quot;\\&quot;, regexpattern, flags);
+					}
+				}
+			}
+		} while (FindNextFile(hFind, &amp;wfd));
+		FindClose(hFind);
+	}
+#else
+	DIR* dp;
+	struct dirent* ep;
+
+	if (!(dp = opendir(dir.c_str())))
+		return;
+
+	while ((ep = readdir(dp))) {
+		// exclude hidden files
+		if (ep-&gt;d_name[0] != '.') {
+			// is it a file? (we just treat sockets / pipes / fifos / character&amp;block devices as files...)
+			// (need to stat because d_type is DT_UNKNOWN on linux :-/)
+			struct stat info;
+			if (stat((dir + ep-&gt;d_name).c_str(), &amp;info) == 0) {
+				if (!S_ISDIR(info.st_mode)) {
+					if ((flags &amp; FileSystem::ONLY_DIRS) == 0) {
+						if (boost::regex_match(ep-&gt;d_name, regexpattern)) {
+							matches.push_back(dir + ep-&gt;d_name);
+						}
+					}
+				}
+				else {
+					// or a directory?
+					if (flags &amp; FileSystem::INCLUDE_DIRS) {
+						if (boost::regex_match(ep-&gt;d_name, regexpattern)) {
+							matches.push_back(dir + ep-&gt;d_name + &quot;/&quot;);
+						}
+					}
+					if (flags &amp; FileSystem::RECURSE) {
+						FindFiles(matches, dir + ep-&gt;d_name + &quot;/&quot;, regexpattern, flags);
+					}
+				}
+			}
+		}
+	}
+	closedir(dp);
+#endif
+}
+
+
+/**
+ * @brief internal find-files-in-a-single-datadir-function
+ * @param dir path in which to start looking
+ * @param pattern pattern to search for
+ * @param recurse whether or not to recursively search
+ * @param include_dirs whether or not to include directory names in the result
+ * @return vector of std::strings
+ *
+ * Will search for a file given a particular pattern.
+ * Starts from dirpath, descending down if recurse is true.
+ */
+void UnixFileSystemHandler::FindFilesSingleDir(std::vector&lt;std::string&gt;&amp; matches, const std::string&amp; dir, const std::string &amp;pattern, int flags) const
+{
+	assert(!dir.empty() &amp;&amp; dir[dir.length() - 1] == native_path_separator);
+
+	boost::regex regexpattern(filesystem.glob_to_regex(pattern));
+
+	::FindFiles(matches, dir, regexpattern, flags);
+}


Property changes on: trunk/rts/System/FileSystem/UnixFileSystemHandler.cpp
___________________________________________________________________
Name: svn:mergeinfo
   + 
Name: svn:eol-style
   + native

Copied: trunk/rts/System/FileSystem/UnixFileSystemHandler.h (from rev 7013, trunk/rts/System/Platform/Linux/UnixFileSystemHandler.h)
===================================================================
--- trunk/rts/System/FileSystem/UnixFileSystemHandler.h	                        (rev 0)
+++ trunk/rts/System/FileSystem/UnixFileSystemHandler.h	2008-11-10 23:35:19 UTC (rev 7014)
@@ -0,0 +1,46 @@
+/**
+ * @file UnixFileSystemHandler.h
+ * @brief Abstracts locating of content on different platforms
+ * @author Tobi Vollebregt
+ *
+ * Unix implementation
+ *
+ * Copyright (C) 2006.  Licensed under the terms of the
+ * GNU GPL, v2 or later
+ */
+
+#ifndef UNIXFILESYSTEMHANDLER_H
+#define UNIXFILESYSTEMHANDLER_H
+
+#include &lt;string&gt;
+#include &lt;vector&gt;
+#include &quot;DataDirLocater.h&quot;
+#include &quot;FileSystem.h&quot;
+
+/**
+ * @brief Unix file system / data directory handler
+ */
+class UnixFileSystemHandler : public FileSystemHandler
+{
+	public:
+
+		virtual ~UnixFileSystemHandler();
+		UnixFileSystemHandler(bool verbose);
+		virtual void Initialize();
+
+		virtual bool mkdir(const std::string&amp; dir) const;
+
+		virtual std::string GetWriteDir() const;
+		virtual std::vector&lt;std::string&gt; FindFiles(const std::string&amp; dir, const std::string&amp; pattern, int flags) const;
+		virtual std::string LocateFile(const std::string&amp; file) const;
+		virtual std::vector&lt;std::string&gt; GetDataDirectories() const;
+
+	protected:
+
+		void InitVFS() const;
+		void FindFilesSingleDir(std::vector&lt;std::string&gt;&amp; matches, const std::string&amp; dir, const std::string &amp;pattern, int flags) const;
+
+		DataDirLocater locater;
+};
+
+#endif // !UNIXFILESYSTEMHANDLER_H


Property changes on: trunk/rts/System/FileSystem/UnixFileSystemHandler.h
___________________________________________________________________
Name: svn:mergeinfo
   + 
Name: svn:eol-style
   + native

Modified: trunk/rts/System/FileSystem/VFSHandler.cpp
===================================================================
--- trunk/rts/System/FileSystem/VFSHandler.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/System/FileSystem/VFSHandler.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -8,7 +8,7 @@
 #include &quot;ArchiveBase.h&quot;
 #include &quot;ArchiveDir.h&quot; // for FileData::dynamic
 #include &quot;LogOutput.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;Util.h&quot;
 
 

Modified: trunk/rts/System/LoadSaveHandler.cpp
===================================================================
--- trunk/rts/System/LoadSaveHandler.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/System/LoadSaveHandler.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -18,7 +18,7 @@
 #include &quot;Sim/Misc/CategoryHandler.h&quot;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;Platform/errorhandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;creg/Serializer.h&quot;
 #include &quot;Game/Game.h&quot;
 #include &quot;Game/GameSetup.h&quot;

Deleted: trunk/rts/System/Platform/FileSystem.cpp
===================================================================
--- trunk/rts/System/Platform/FileSystem.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/System/Platform/FileSystem.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -1,433 +0,0 @@
-/**
- * @file FileSystem.cpp
- * @brief Abstracts locating of content on different platforms
- * @author Tobi Vollebregt
- *
- * FindFiles implementation by Chris Han.
- * Glob conversion by Chris Han (based on work by Nathaniel Smith).
- * Copyright (C) 2005-2006.  Licensed under the terms of the
- * GNU GPL, v2 or later
- */
-
-#include &quot;StdAfx.h&quot;
-#include &lt;assert.h&gt;
-#include &lt;limits.h&gt;
-#include &lt;boost/regex.hpp&gt;
-#include &lt;fstream&gt;
-#include &lt;sys/stat.h&gt;
-#include &lt;sys/types.h&gt;
-#include &quot;FileSystem.h&quot;
-
-#ifdef WIN32
-#	include &quot;Win/WinFileSystemHandler.h&quot;
-#elif defined(__APPLE__)
-#	include &quot;Mac/MacFileSystemHandler.h&quot;
-#else
-#	include &quot;Linux/UnixFileSystemHandler.h&quot;
-#endif
-
-#include &quot;FileSystem/ArchiveScanner.h&quot;
-#include &quot;FileSystem/VFSHandler.h&quot;
-#include &quot;LogOutput.h&quot;
-#include &quot;Util.h&quot;
-#include &quot;mmgr.h&quot;
-
-
-#define fs (FileSystemHandler::GetInstance())
-
-FileSystem filesystem;
-
-
-////////////////////////////////////////
-////////// FileSystemHandler
-
-/**
- * @brief The global data directory handler instance
- */
-FileSystemHandler* FileSystemHandler::instance = NULL;
-
-/**
- * @brief get the data directory handler instance
- */
-FileSystemHandler&amp; FileSystemHandler::GetInstance()
-{
-	if (!instance)
-		Initialize(false);
-	return *instance;
-}
-
-/**
- * @brief initialize the data directory handler
- */
-void FileSystemHandler::Initialize(bool verbose)
-{
-	if (!instance) {
-		// FIXME this leaks memory
-#ifdef WIN32
-		instance = new UnixFileSystemHandler(verbose);
-#elif defined(__APPLE__)
-		instance = new MacFileSystemHandler(verbose);
-#else
-		instance = new UnixFileSystemHandler(verbose);
-#endif
-		try {
-			instance-&gt;Initialize();
-		}
-		catch (...) {
-			SafeDelete(instance);
-			throw;
-		}
-	}
-}
-
-void FileSystemHandler::Cleanup()
-{
-	SafeDelete(instance);
-}
-
-FileSystemHandler::~FileSystemHandler()
-{
-	SafeDelete(archiveScanner);
-	SafeDelete(vfsHandler);
-}
-
-FileSystemHandler::FileSystemHandler(int native_path_sep): native_path_separator(native_path_sep)
-{
-	// NOTE TO SELF: NEVER EVAR DO THIS AGAIN THIS WAY
-
-	// combined with init code in constructor and exceptions being thrown
-	// when this init code fails it results in dangling pointers.
-
-	// (if constructor throws exception object doesn't exist, by definition,
-	//  but global variable instance would still point to it....)
-
-//	// need to set this here already or we get stuck in an infinite loop
-//	// because WinFileSystemHandler/UnixFileSystemHandler ctor initializes the
-//	// ArchiveScanner (which uses FileSystemHandler::GetInstance again...).
-//	instance = this;
-}
-
-////////////////////////////////////////
-////////// FileSystem
-
-/**
- * @brief quote macro
- * @param c Character to test
- * @param str string currently being built
- *
- * Given a string str that we're assembling,
- * and an upcoming character c, will append
- * an extra '\\' to quote the character if necessary.
- */
-#define QUOTE(c,str)			\
-	do {					\
-		if (!(isalnum(c)||(c)=='_'))	\
-			str+='\\';		\
-		str+=c;				\
-} while (0)
-
-/**
- * @brief glob to regex
- * @param glob string containing glob
- * @return string containing regex
- *
- * Converts a glob expression to a regex
- */
-std::string FileSystem::glob_to_regex(const std::string&amp; glob) const
-{
-	std::string regex;
-	regex.reserve(glob.size()&lt;&lt;1);
-	int braces = 0;
-	for (std::string::const_iterator i = glob.begin(); i != glob.end(); ++i) {
-		char c = *i;
-#ifdef DEBUG
-		if (braces&gt;=5)
-			logOutput.Print(&quot;glob_to_regex warning: braces nested too deeply\n%s&quot;, glob.c_str());
-#endif
-		switch (c) {
-			case '*':
-				regex+=&quot;.*&quot;;
-				break;
-			case '?':
-				regex+='.';
-				break;
-			case '{':
-				braces++;
-				regex+='(';
-				break;
-			case '}':
-#ifdef DEBUG
-				if (!braces)
-					logOutput.Print(&quot;glob_to_regex warning: closing brace without an equivalent opening brace\n%s&quot;, glob.c_str());
-#endif
-				regex+=')';
-				braces--;
-				break;
-			case ',':
-				if (braces)
-					regex+='|';
-				else
-					QUOTE(c,regex);
-				break;
-			case '\\':
-#ifdef DEBUG
-				if (++i==glob.end())
-					logOutput.Print(&quot;glob_to_regex warning: pattern ends with backslash\n%s&quot;, glob.c_str());
-#else
-				++i;
-#endif
-				QUOTE(*i,regex);
-				break;
-			default:
-				QUOTE(c,regex);
-				break;
-		}
-	}
-#ifdef DEBUG
-	if (braces)
-		logOutput.Print(&quot;glob_to_regex warning: unterminated brace expression\n%s&quot;, glob.c_str());
-#endif
-	return regex;
-}
-
-/**
- * @brief get filesize
- *
- * @return the filesize or 0 if the file doesn't exist.
- */
-size_t FileSystem::GetFilesize(std::string file) const
-{
-	if (!CheckFile(file))
-		return 0;
-	FixSlashes(file);
-	struct stat info;
-	if (stat(file.c_str(), &amp;info) != 0)
-		return 0;
-	return info.st_size;
-}
-
-/**
- * @brief create a directory
- *
- * Works like mkdir -p, ie. attempts to create parent directories too.
- * Operates on the current working directory.
- */
-bool FileSystem::CreateDirectory(std::string dir) const
-{
-	if (!CheckFile(dir))
-		return false;
-
-	ForwardSlashes(dir);
-	size_t prev_slash = 0, slash;
-	while ((slash = dir.find('/', prev_slash + 1)) != std::string::npos) {
-		if (!fs.mkdir(dir.substr(0, slash)))
-			return false;
-		prev_slash = slash;
-	}
-	return fs.mkdir(dir);
-}
-
-
-/**
- * @brief find files
- *
- * Compiles a std::vector of all files below dir that match pattern.
- *
- * If FileSystem::RECURSE flag is set it recurses into subdirectories.
- * If FileSystem::INCLUDE_DIRS flag is set it includes directories in the
- * result too, as long as they match the pattern.
- *
- * Note that pattern doesn't apply to the names of recursed directories,
- * it does apply to the files inside though.
- */
-std::vector&lt;std::string&gt; FileSystem::FindFiles(std::string dir, const std::string&amp; pattern, int flags) const
-{
-	if (!CheckFile(dir)) {
-		return std::vector&lt;std::string&gt;();
-	}
-
-	if (dir.empty()) {
-		dir = &quot;./&quot;;
-	}
-	else {
-		const char lastChar = dir[dir.length() - 1];
-		if ((lastChar != '/') &amp;&amp; (lastChar != '\\')) {
-			dir += '/';
-		}
-	}
-
-	FixSlashes(dir);
-
-	if (flags &amp; ONLY_DIRS) {
-		flags |= INCLUDE_DIRS;
-	}
-
-	return fs.FindFiles(dir, pattern, flags);
-}
-
-
-/**
- * @brief get the directory part of a path
- */
-std::string FileSystem::GetDirectory(const std::string&amp; path) const
-{
-	size_t s = path.find_last_of('/');
-	size_t bs = path.find_last_of('\\');
-	if (s != std::string::npos &amp;&amp; bs != std::string::npos)
-		return path.substr(0, std::max(s, bs) + 1);
-	if (s != std::string::npos)
-		return path.substr(0, s + 1);
-	if (bs != std::string::npos)
-		return path.substr(0, bs + 1);
-	return path;
-}
-
-/**
- * @brief get the filename part of a path
- */
-std::string FileSystem::GetFilename(const std::string&amp; path) const
-{
-	size_t s = path.find_last_of('/');
-	size_t bs = path.find_last_of('\\');
-	if (s != std::string::npos &amp;&amp; bs != std::string::npos)
-		return path.substr(std::max(s, bs) + 1);
-	if (s != std::string::npos)
-		return path.substr(s + 1);
-	if (bs != std::string::npos)
-		return path.substr(bs + 1);
-	return path;
-}
-
-/**
- * @brief get the basename part of a path, ie. the filename without extension
- */
-std::string FileSystem::GetBasename(const std::string&amp; path) const
-{
-	std::string fn = GetFilename(path);
-	size_t dot = fn.find_last_of('.');
-	if (dot != std::string::npos)
-		return fn.substr(0, dot);
-	return fn;
-}
-
-/**
- * @brief get the extension of the filename part of the path
- */
-std::string FileSystem::GetExtension(const std::string&amp; path) const
-{
-	std::string fn = GetFilename(path);
-	size_t dot = fn.find_last_of('.');
-	if (dot != std::string::npos)
-		return fn.substr(dot + 1);
-	return &quot;&quot;;
-}
-
-/**
- * @brief converts all slashes and backslashes in path to the native_path_separator
- */
-std::string&amp; FileSystem::FixSlashes(std::string&amp; path) const
-{
-	int sep = fs.GetNativePathSeparator();
-	for (unsigned i = 0; i &lt; path.size(); ++i)
-		if (path[i] == '/' || path[i] == '\\')
-			path[i] = sep;
-	return path;
-}
-
-/**
- * @brief converts backslashes in path to forward slashes
- */
-std::string&amp; FileSystem::ForwardSlashes(std::string&amp; path) const
-{
-	for (unsigned i = 0; i &lt; path.size(); ++i)
-		if (path[i] == '\\')
-			path[i] = '/';
-	return path;
-}
-
-/**
- * @brief does a little checking of a filename
- */
-bool FileSystem::CheckFile(const std::string&amp; file) const
-{
-	// Don't allow code to escape from the data directories.
-	// Note: this does NOT mean this is a SAFE fopen function:
-	// symlink-, hardlink-, you name it-attacks are all very well possible.
-	// The check is just ment to &quot;enforce&quot; certain coding behaviour.
-	if (file.find(&quot;..&quot;) != std::string::npos)
-		return false;
-
-	return true;
-}
-
-/**
- * @brief does a little checking of a modestring
- */
-bool FileSystem::CheckMode(const char* mode) const
-{
-	assert(mode &amp;&amp; *mode);
-	return true;
-}
-
-/**
- * @brief locate a file
- *
- * Attempts to locate a file.
- *
- * If the FileSystem::WRITE flag is set, it just returns the argument
- * (assuming the file should come in the current working directory).
- * If FileSystem::CREATE_DIRS is set it tries to create the subdirectory
- * the file should live in.
- *
- * Otherwise (if flags == 0), it dispatches the call to
- * FileSystemHandler::LocateFile(), which either searches for it in multiple
- * data directories (UNIX) or just returns the argument (Windows).
- */
-std::string FileSystem::LocateFile(std::string file, int flags) const
-{
-	if (!CheckFile(file)) {
-		return &quot;&quot;;
-	}
-
-	FixSlashes(file);
-
-	if (flags &amp; WRITE) {
-		if (flags &amp; CREATE_DIRS) {
-			CreateDirectory(GetDirectory(file));
-		}
-		return file;
-	}
-
-	return fs.LocateFile(file);
-}
-
-
-bool FileSystem::InReadDir(const std::string&amp; path)
-{
-	if (path.find(&quot;..&quot;) != std::string::npos) {
-		return false; // realpath() would be nice
-	}
-	const std::vector&lt;std::string&gt; readDirs = fs.GetDataDirectories();
-	return true;
-}
-
-
-bool FileSystem::InWriteDir(const std::string&amp; path, const std::string&amp; prefix)
-{
-	const std::string writeDir = fs.GetWriteDir();
-	return true;
-}
-
-
-/**
- * @brief remove a file
- *
- * Operates on the current working directory.
- */
-bool FileSystem::Remove(std::string file) const
-{
-	if (!CheckFile(file))
-		return false;
-	FixSlashes(file);
-	return ::remove(file.c_str()) == 0;
-}

Deleted: trunk/rts/System/Platform/FileSystem.h
===================================================================
--- trunk/rts/System/Platform/FileSystem.h	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/System/Platform/FileSystem.h	2008-11-10 23:35:19 UTC (rev 7014)
@@ -1,113 +0,0 @@
-/**
- * @file FileSystem.h
- * @brief Abstracts locating of content on different platforms
- * @author Tobi Vollebregt
- *
- * Copyright (C) 2006.  Licensed under the terms of the
- * GNU GPL, v2 or later
- */
-
-#ifndef FILESYSTEM_H
-#define FILESYSTEM_H
-
-#include &lt;vector&gt;
-#include &lt;string&gt;
-
-// winapi redifines this which breaks things
-#if defined(CreateDirectory)
-# undef CreateDirectory
-#endif
-
-/**
- * @brief native file system handling abstraction
- */
-class FileSystemHandler
-{
-	public:
-
-		static FileSystemHandler&amp; GetInstance();
-		static void Initialize(bool verbose);
-		static void Cleanup();
-
-		virtual ~FileSystemHandler();
-		FileSystemHandler(int native_path_sep = '/');
-		virtual void Initialize() = 0;
-
-		// almost direct wrappers to system calls
-		virtual bool mkdir(const std::string&amp; dir) const = 0;
-
-		// custom functions
-		virtual std::vector&lt;std::string&gt; FindFiles(const std::string&amp; dir, const std::string&amp; pattern, int flags) const = 0;
-		virtual std::string LocateFile(const std::string&amp; file) const = 0;
-		virtual std::string GetWriteDir() const = 0;
-		virtual std::vector&lt;std::string&gt; GetDataDirectories() const = 0;
-
-		int GetNativePathSeparator() const { return native_path_separator; }
-
-	protected:
-
-		static FileSystemHandler* instance;
-
-		const int native_path_separator;
-};
-
-/**
- * @brief filesystem interface
- *
- * Use this from the rest of the spring code!
- */
-class FileSystem
-{
-	public:
-		// flags for FindFiles
-		enum FindFilesBits {
-			RECURSE      = (1 &lt;&lt; 0),
-			INCLUDE_DIRS = (1 &lt;&lt; 1),
-			ONLY_DIRS    = (1 &lt;&lt; 2),
-		};
-		// flags for LocateFile
-		enum LocateFileBits {
-			WRITE       = (1 &lt;&lt; 0),
-			CREATE_DIRS = (1 &lt;&lt; 1),
-		};
-
-	public:
-		FileSystem() {}
-
-		// generic functions
-		std::string LocateFile(std::string file, int flags = 0) const;
-		bool Remove(std::string file) const;
-
-		// metadata read functions
-		size_t GetFilesize(std::string path) const;
-
-		// directory functions
-		bool CreateDirectory(std::string dir) const;
-		std::vector&lt;std::string&gt; FindFiles(std::string dir, const std::string&amp; pattern, int flags = 0) const;
-
-		// convenience functions
-		std::string GetDirectory (const std::string&amp; path) const;
-		std::string GetFilename  (const std::string&amp; path) const;
-		std::string GetBasename  (const std::string&amp; path) const;
-		std::string GetExtension (const std::string&amp; path) const;
-		std::string glob_to_regex(const std::string&amp; glob) const;
-		std::string&amp; FixSlashes  (std::string&amp; path) const;
-		std::string&amp; ForwardSlashes(std::string&amp; path) const;
-
-		// access check functions
-		bool InReadDir(const std::string&amp; path);
-		bool InWriteDir(const std::string&amp; path, const std::string&amp; prefix = &quot;&quot;);
-
-	private:
-		bool CheckFile(const std::string&amp; file) const;
-		bool CheckDir(const std::string&amp; dir) const;
-		bool CheckMode(const char* mode) const;
-
-		FileSystem(const FileSystem&amp;);
-		FileSystem&amp; operator=(const FileSystem&amp;);
-};
-
-// basically acts like a namespace, but with semantics like configHandler has
-extern FileSystem filesystem;
-
-#endif // !FILESYSTEM_H

Deleted: trunk/rts/System/Platform/Linux/DataDirLocater.cpp
===================================================================
--- trunk/rts/System/Platform/Linux/DataDirLocater.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/System/Platform/Linux/DataDirLocater.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -1,333 +0,0 @@
-/**
- * @file DataDirLocater.cpp
- * @author Tobi Vollebregt
- *
- * Copyright (C) 2006-2008 Tobi Vollebregt
- * Licensed under the terms of the GNU GPL, v2 or later
- */
-
-#include &quot;StdAfx.h&quot;
-#include &quot;DataDirLocater.h&quot;
-
-#include &lt;cstdlib&gt;
-#ifdef WIN32
-	#include &lt;io.h&gt;
-  #include &lt;direct.h&gt;
-  #include &lt;windows.h&gt;
-	#include &lt;shlobj.h&gt;
-	#include &lt;shlwapi.h&gt;
-	#ifndef SHGFP_TYPE_CURRENT
-		#define SHGFP_TYPE_CURRENT 0
-	#endif
-#endif
-#include &lt;sstream&gt;
-#include &lt;string.h&gt;
-#include &quot;FileSystem/VFSHandler.h&quot;
-#include &quot;LogOutput.h&quot;
-#include &quot;Platform/ConfigHandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
-#include &quot;mmgr.h&quot;
-#include &quot;Exceptions.h&quot;
-
-/**
- * @brief construct a data directory object
- *
- * Appends a slash to the end of the path if there isn't one already.
- */
-DataDir::DataDir(const std::string&amp; p) : path(p), writable(false)
-{
-#ifndef _WIN32
-	if (path.empty())
-		path = &quot;./&quot;;
-	if (path[path.size() - 1] != '/')
-		path += '/';
-#else
-	if (path.empty())
-		path = &quot;.\\&quot;;
-	if (path[path.size() - 1] != '\\')
-		path += '\\';
-#endif
-}
-
-/**
- * @brief construct a data directory locater
- *
- * Does not locate data directories, use LocateDataDirs() for that.
- */
-DataDirLocater::DataDirLocater() : writedir(NULL)
-{
-}
-
-/**
- * @brief substitute environment variables with their values
- */
-std::string DataDirLocater::SubstEnvVars(const std::string&amp; in) const
-{
-	bool escape = false;
-	std::ostringstream out;
-	for (std::string::const_iterator ch = in.begin(); ch != in.end(); ++ch) {
-		if (escape) {
-			escape = false;
-			out &lt;&lt; *ch;
-		} else {
-			switch (*ch) {
-#ifndef _WIN32
-				case '\\': {
-					escape = true;
-					break;
-				}
-#endif
-				case '$': {
-					std::ostringstream envvar;
-					for (++ch; ch != in.end() &amp;&amp; (isalnum(*ch) || *ch == '_'); ++ch)
-						envvar &lt;&lt; *ch;
-					--ch;
-					char* subst = getenv(envvar.str().c_str());
-					if (subst &amp;&amp; *subst)
-						out &lt;&lt; subst;
-					break;
-				}
-				default: {
-					out &lt;&lt; *ch;
-					break;
-				}
-			}
-		}
-	}
-	return out.str();
-}
-
-/**
- * @brief Adds the directories in the colon separated string to the datadir handler.
- */
-void DataDirLocater::AddDirs(const std::string&amp; in)
-{
-	size_t prev_colon = 0, colon;
-#ifndef _WIN32
-	while ((colon = in.find(':', prev_colon)) != std::string::npos) {
-#else
-	while ((colon = in.find(';', prev_colon)) != std::string::npos) {
-#endif
-		datadirs.push_back(in.substr(prev_colon, colon - prev_colon));
-#ifdef DEBUG
-		logOutput.Print(&quot;Adding %s to directories&quot; , in.substr(prev_colon, colon - prev_colon).c_str());
-#endif
-		prev_colon = colon + 1;
-	}
-#ifdef DEBUG
-	logOutput.Print(&quot;Adding %s to directories&quot; , in.substr(prev_colon).c_str());
-#endif
-	datadirs.push_back(in.substr(prev_colon));
-}
-
-/**
- * @brief Figure out permissions we have for a single data directory d.
- * @returns whether we have permissions to read the data directory.
- */
-bool DataDirLocater::DeterminePermissions(DataDir* d)
-{
-#ifndef _WIN32
-	if (d-&gt;path.c_str()[0] != '/' || d-&gt;path.find(&quot;..&quot;) != std::string::npos)
-#else
-	if (d-&gt;path.find(&quot;..&quot;) != std::string::npos)
-#endif
-		throw content_error(&quot;specify data directories using absolute paths please&quot;);
-	// Figure out whether we have read/write permissions
-	// First check read access, if we got that check write access too
-	// (no support for write-only directories)
-	// Note: we check for executable bit otherwise we can't browse the directory
-	// Note: we fail to test whether the path actually is a directory
-	// Note: modifying permissions while or after this function runs has undefined behaviour
-#ifndef _WIN32
-	if (access(d-&gt;path.c_str(), R_OK | X_OK | F_OK) == 0) {
-		// Note: disallow multiple write directories.
-		// There isn't really a use for it as every thing is written to the first one anyway,
-		// and it may give funny effects on errors, e.g. it probably only gives funny things
-		// like network mounted datadir lost connection and suddenly files end up in some
-		// other random writedir you didn't even remember you had added it.
-		if (!writedir &amp;&amp; access(d-&gt;path.c_str(), W_OK) == 0) {
-#else
-	if (_access(d-&gt;path.c_str(), 4) == 0) {
-		if (!writedir &amp;&amp; _access(d-&gt;path.c_str(), 2) == 0) {
-#endif
-			d-&gt;writable = true;
-			writedir = &amp;*d;
-		}
-		return true;
-	} else {
-		if (filesystem.CreateDirectory(d-&gt;path)) {
-			// it didn't exist before, now it does and we just created it with rw access,
-			// so we just assume we still have read-write acces...
-			if (!writedir) {
-				d-&gt;writable = true;
-				writedir = d;
-			}
-			return true;
-		}
-	}
-	return false;
-}
-
-/**
- * @brief Figure out permissions we have for the data directories.
- */
-void DataDirLocater::DeterminePermissions()
-{
-	std::vector&lt;DataDir&gt; newDatadirs;
-	std::string previous; // used to filter out consecutive duplicates
-	// (I didn't bother filtering out non-consecutive duplicates because then
-	//  there is the question which of the multiple instances to purge.)
-
-	writedir = NULL;
-
-	for (std::vector&lt;DataDir&gt;::iterator d = datadirs.begin(); d != datadirs.end(); ++d) {
-		if (d-&gt;path != previous &amp;&amp; DeterminePermissions(&amp;*d)) {
-			newDatadirs.push_back(*d);
-			previous = d-&gt;path;
-		}
-	}
-
-	datadirs = newDatadirs;
-}
-
-/**
- * @brief locate spring data directory
- *
- * On *nix platforms, attempts to locate
- * and change to the spring data directory
- *
- * In Unixes, the data directory to chdir to is determined by the following, in this
- * order (first items override lower items):
- *
- * - 'SPRING_DATADIR' environment variable. (colon separated list, like PATH)
- * - 'SpringData=/path/to/data' declaration in '~/.springrc'. (colon separated list)
- * - &quot;$HOME/.spring&quot;
- * - In the same order any line in '/etc/spring/datadir', if that file exists.
- * - 'datadir=/path/to/data' option passed to 'scons configure'.
- * - 'prefix=/install/path' option passed to scons configure. The datadir is
- *   assumed to be at '$prefix/games/spring' in this case.
- * - the default datadirs in the default prefix, ie. '/usr/local/games/spring'
- *   (This is set by the build system, ie. SPRING_DATADIR and SPRING_DATADIR_2
- *   preprocessor definitions.)
- *
- * In Windows, its:
- * - SPRING_DATADIR env-variable
- * - user configurable (SpringData in registry)
- * - location of the binary dir (like it has been until 0.76b1)
- * - the Users 'Documents'-directory (in subdirectory Spring), unless spring is configured to use another
- * - all users app-data (in subdirectory Spring)
- * - compiler flags SPRING_DATADIR and SPRING_DATADIR_2
- *
- * All of the above methods support environment variable substitution, eg.
- * '$HOME/myspringdatadir' will be converted by spring to something like
- * '/home/username/myspringdatadir'.
- *
- * If it fails to chdir to the above specified directory spring will asume the
- * current working directory is the data directory.
- */
-void DataDirLocater::LocateDataDirs()
-{
-	// Construct the list of datadirs from various sources.
-	datadirs.clear();
-
-	// environment variable
-	char* env = getenv(&quot;SPRING_DATADIR&quot;);
-	if (env &amp;&amp; *env)
-		AddDirs(SubstEnvVars(env));
-
-	// user defined (in spring config handler (Linux: ~/.springrc, Windows: registry))
-	std::string userDef = configHandler.GetString(&quot;SpringData&quot;, &quot;&quot;);
-	if (!userDef.empty()) {
-		AddDirs(SubstEnvVars(userDef));
-	}
-
-#ifdef WIN32
-	TCHAR currentDir[MAX_PATH];
-	::GetCurrentDirectory(sizeof(currentDir) - 1, currentDir);
-	std::string curPath = currentDir;
-	AddDirs(std::string(currentDir));
-
-	// my documents
-	TCHAR strPath[MAX_PATH];
-	SHGetFolderPath( NULL, CSIDL_PERSONAL, NULL, SHGFP_TYPE_CURRENT, strPath);
-	std::string cfg = strPath;
-	cfg += &quot;\\Spring&quot;; // e.g. F:\Dokumente und Einstellungen\Karl-Robert\Eigene Dateien\Spring
-	AddDirs(cfg);
-	cfg.clear();
-
-	// appdata
-	SHGetFolderPath( NULL, CSIDL_COMMON_APPDATA, NULL, SHGFP_TYPE_CURRENT, strPath);
-	cfg = strPath;
-	cfg += &quot;\\Spring&quot;; // e.g. F:\Dokumente und Einstellungen\All Users\Anwendungsdaten\Spring
-	AddDirs(cfg);
-#else
-	// home
-	AddDirs(SubstEnvVars(&quot;$HOME/.spring&quot;));
-
-	// settings in /etc
-	FILE* f = ::fopen(&quot;/etc/spring/datadir&quot;, &quot;r&quot;);
-	if (f) {
-		char buf[1024];
-		while (fgets(buf, sizeof(buf), f)) {
-			char* newl = strchr(buf, '\n');
-			if (newl)
-				*newl = 0;
-			char white[3] = {'\t', ' ', 0};
-			if (strlen(buf) &gt; 0 &amp;&amp; strspn(buf, white) != strlen(buf)) // don't count lines of whitespaces / tabulators
-				AddDirs(SubstEnvVars(buf));
-		}
-		fclose(f);
-	}
-#endif
-
-	// compiler flags
-#ifdef SPRING_DATADIR
-	datadirs.push_back(SubstEnvVars(SPRING_DATADIR));
-#endif
-	// should not be needed because you can seperate directories with a ':' in SPRING_DATADIR(1)
-#ifdef SPRING_DATADIR_2
-	datadirs.push_back(SubstEnvVars(SPRING_DATADIR_2));
-#endif
-
-	// Figure out permissions of all datadirs
-	DeterminePermissions();
-
-	if (!writedir) {
-		// bail out
-#ifdef WIN32
-		const std::string errstr = &quot;Not a single writable data directory found!\n\n&quot;
-				&quot;Configure a writable data directory using either:\n&quot;
-				&quot;- the SPRING_DATADIR environment variable,\n&quot;
-				&quot;- a SpringData=C:/path/to/data declaration in spring's registry entry or\n&quot;
-				&quot;- by giving you write access to the installation directory&quot;;
-#else
-		const std::string errstr = &quot;Not a single writable data directory found!\n\n&quot;
-				&quot;Configure a writable data directory using either:\n&quot;
-				&quot;- the SPRING_DATADIR environment variable,\n&quot;
-				&quot;- a SpringData=/path/to/data declaration in ~/.springrc or\n&quot;
-				&quot;- the configuration file /etc/spring/datadir&quot;;
-#endif
-		throw content_error(errstr);
-	}
-
-	// for now, chdir to the datadirectory as a safety measure:
-	// all AIs still just assume it's ok to put their stuff in the current directory after all
-	// Not only safety anymore, it's just easier if other code can safely assume that
-	// writedir == current working directory
-#ifndef _WIN32
-	chdir(GetWriteDir()-&gt;path.c_str());
-#else
-	_chdir(GetWriteDir()-&gt;path.c_str());
-#endif
-	// Initialize the log. Only after this moment log will be written to file.
-	logOutput.Initialize();
-	// Logging MAY NOT start before the chdir, otherwise the logfile ends up
-	// in the wrong directory.
-	// Update: now it actually may start before, log has preInitLog.
-	for (std::vector&lt;DataDir&gt;::const_iterator d = datadirs.begin(); d != datadirs.end(); ++d) {
-		if (d-&gt;writable)
-			logOutput.Print(&quot;Using read-write data directory: %s&quot;, d-&gt;path.c_str());
-		else
-			logOutput.Print(&quot;Using read-only  data directory: %s&quot;, d-&gt;path.c_str());
-	}
-}

Deleted: trunk/rts/System/Platform/Linux/DataDirLocater.h
===================================================================
--- trunk/rts/System/Platform/Linux/DataDirLocater.h	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/System/Platform/Linux/DataDirLocater.h	2008-11-10 23:35:19 UTC (rev 7014)
@@ -1,40 +0,0 @@
-/**
- * @file DataDirLocater.h
- * @author Tobi Vollebregt
- *
- * Copyright (C) 2006-2008 Tobi Vollebregt
- * Licensed under the terms of the GNU GPL, v2 or later
- */
-#ifndef DATADIRLOCATER_H
-#define DATADIRLOCATER_H
-
-#include &lt;string&gt;
-#include &lt;vector&gt;
-
-struct DataDir
-{
-	DataDir(const std::string&amp; p);
-	std::string path;
-	bool writable;
-};
-
-class DataDirLocater
-{
-public:
-	DataDirLocater();
-	void LocateDataDirs();
-
-	const std::vector&lt;DataDir&gt;&amp; GetDataDirs() const { return datadirs; }
-	const DataDir* GetWriteDir() const { return writedir; }
-
-private:
-	std::string SubstEnvVars(const std::string&amp; in) const;
-	void AddDirs(const std::string&amp; in);
-	bool DeterminePermissions(DataDir* d);
-	void DeterminePermissions();
-
-	std::vector&lt;DataDir&gt; datadirs;
-	const DataDir* writedir;
-};
-
-#endif // !defined(DATADIRLOCATER_H)

Deleted: trunk/rts/System/Platform/Linux/UnixFileSystemHandler.cpp
===================================================================
--- trunk/rts/System/Platform/Linux/UnixFileSystemHandler.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/System/Platform/Linux/UnixFileSystemHandler.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -1,312 +0,0 @@
-/**
- * @file UnixFileSystemHandler.cpp
- * @brief Abstracts locating of content on different platforms
- * @author Tobi Vollebregt
- *
- * Linux and Windows implementation, supporting multiple data directories / search paths.
- *
- * Copyright (C) 2006-2008 Tobi Vollebregt.
- * Licensed under the terms of the GNU GPL, v2 or later
- */
-
-#include &quot;UnixFileSystemHandler.h&quot;
-#include &lt;limits.h&gt;
-#include &lt;boost/regex.hpp&gt;
-#include &lt;sys/stat.h&gt;
-#include &lt;sys/types.h&gt;
-#ifndef _WIN32
-#include &lt;dirent.h&gt;
-#include &lt;sstream&gt;
-#include &lt;unistd.h&gt;
-#else
-#include &lt;windows.h&gt;
-#include &lt;io.h&gt;
-#include &lt;direct.h&gt;
-#endif
-#include &quot;FileSystem/ArchiveScanner.h&quot;
-#include &quot;FileSystem/VFSHandler.h&quot;
-#include &quot;LogOutput.h&quot;
-#include &quot;Platform/ConfigHandler.h&quot;
-#include &quot;mmgr.h&quot;
-
-/**
- * @brief Creates the archive scanner and vfs handler
- *
- * For the archiveScanner, it keeps cache data (&quot;archivecache.txt&quot;) in the
- * writedir. Cache data in other directories is ignored.
- * It scans maps, base and mods subdirectories of all readable datadirs
- * for archives. Archives in higher priority datadirs override archives
- * in lower priority datadirs.
- *
- * Note that the archive namespace is global, ie. each archive basename may
- * only occur once in all data directories. If a name is found more then once,
- * then higher priority datadirs override lower priority datadirs and per
- * datadir the 'mods' subdir overrides 'base' which overrides 'maps'.
- */
-void UnixFileSystemHandler::InitVFS() const
-{
-	const DataDir* writedir = locater.GetWriteDir();
-	const std::vector&lt;DataDir&gt;&amp; datadirs = locater.GetDataDirs();
-
-	archiveScanner = new CArchiveScanner();
-
-	archiveScanner-&gt;ReadCacheData(writedir-&gt;path + archiveScanner-&gt;GetFilename());
-
-	std::vector&lt;std::string&gt; scanDirs;
-	for (std::vector&lt;DataDir&gt;::const_reverse_iterator d = datadirs.rbegin(); d != datadirs.rend(); ++d) {
-		scanDirs.push_back(d-&gt;path + &quot;maps&quot;);
-		scanDirs.push_back(d-&gt;path + &quot;base&quot;);
-		scanDirs.push_back(d-&gt;path + &quot;mods&quot;);
-	}
-	archiveScanner-&gt;ScanDirs(scanDirs, true);
-
-	archiveScanner-&gt;WriteCacheData(writedir-&gt;path + archiveScanner-&gt;GetFilename());
-
-	vfsHandler = new CVFSHandler();
-}
-
-
-/**
- * @brief Creates the archive scanner and vfs handler
- *
- * Locates data directories and initializes the VFS.
- */
-UnixFileSystemHandler::UnixFileSystemHandler(bool verbose) :
-#ifndef _WIN32
-		FileSystemHandler('/')
-#else
-		FileSystemHandler('\\')
-#endif
-{
-}
-
-
-void UnixFileSystemHandler::Initialize()
-{
-	locater.LocateDataDirs();
-	InitVFS();
-}
-
-
-UnixFileSystemHandler::~UnixFileSystemHandler()
-{
-	configHandler.Deallocate();
-}
-
-
-/**
- * @brief returns the highest priority writable directory, aka the writedir
- */
-std::string UnixFileSystemHandler::GetWriteDir() const
-{
-	const DataDir* writedir = locater.GetWriteDir();
-	assert(writedir &amp;&amp; writedir-&gt;writable); // duh
-	return writedir-&gt;path;
-}
-
-
-/**
- * @brief find files
- * @param dir path in which to start looking (tried relative to each data directory)
- * @param pattern pattern to search for
- * @param recurse whether or not to recursively search
- * @param include_dirs whether or not to include directory names in the result
- * @return vector of std::strings containing absolute paths to the files
- *
- * Will search for a file given a particular pattern.
- * Starts from dirpath, descending down if recurse is true.
- */
-std::vector&lt;std::string&gt; UnixFileSystemHandler::FindFiles(const std::string&amp; dir, const std::string&amp; pattern, int flags) const
-{
-	std::vector&lt;std::string&gt; matches;
-
-	// if it's an absolute path, don't look for it in the data directories
-	if ((dir[0] == '/') || ((dir.length() &gt; 1) &amp;&amp; (dir[1] == ':'))) {
-		FindFilesSingleDir(matches, dir, pattern, flags);
-		return matches;
-	}
-
-	const std::vector&lt;DataDir&gt;&amp; datadirs = locater.GetDataDirs();
-	for (std::vector&lt;DataDir&gt;::const_reverse_iterator d = datadirs.rbegin(); d != datadirs.rend(); ++d) {
-		FindFilesSingleDir(matches, d-&gt;path + dir, pattern, flags);
-	}
-	return matches;
-}
-
-
-std::string UnixFileSystemHandler::LocateFile(const std::string&amp; file) const
-{
-	// if it's an absolute path, don't look for it in the data directories
-#ifdef WIN32
-	if ((file.length() &gt; 1) &amp;&amp; (file[1] == ':')) {
-		return file;
-	}
-
-	const std::vector&lt;DataDir&gt;&amp; datadirs = locater.GetDataDirs();
-	for (std::vector&lt;DataDir&gt;::const_iterator d = datadirs.begin(); d != datadirs.end(); ++d) {
-		std::string fn(d-&gt;path + file);
-		if (_access(fn.c_str(), 4) == 0) {
-			return fn;
-		}
-	}
-	return file;
-#else
-	if (file[0] == '/') {
-		return file;
-	}
-
-	const std::vector&lt;DataDir&gt;&amp; datadirs = locater.GetDataDirs();
-	for (std::vector&lt;DataDir&gt;::const_iterator d = datadirs.begin(); d != datadirs.end(); ++d) {
-		std::string fn(d-&gt;path + file);
-		if (access(fn.c_str(), R_OK | F_OK) == 0) {
-			return fn;
-		}
-	}
-	return file;
-#endif
-}
-
-
-std::vector&lt;std::string&gt; UnixFileSystemHandler::GetDataDirectories() const
-{
-	std::vector&lt;std::string&gt; f;
-
-	const std::vector&lt;DataDir&gt;&amp; datadirs = locater.GetDataDirs();
-	for (std::vector&lt;DataDir&gt;::const_iterator d = datadirs.begin(); d != datadirs.end(); ++d) {
-		f.push_back(d-&gt;path);
-	}
-	return f;
-}
-
-
-/**
- * @brief creates a rwxr-xr-x dir in the writedir
- *
- * Returns true if the postcondition of this function is that dir exists in
- * the write directory.
- *
- * Note that this function does not check access to the dir, ie. if you've
- * created it manually with 0000 permissions then this function may return
- * true, subsequent operation on files inside the directory may still fail.
- *
- * As a rule of thumb, set identical permissions on identical items in the
- * data directory, ie. all subdirectories the same perms, all files the same
- * perms.
- */
-bool UnixFileSystemHandler::mkdir(const std::string&amp; dir) const
-{
-#ifdef _WIN32
-	struct _stat info;
-
-	// First check if directory exists. We'll return success if it does.
-	if (_stat(dir.c_str(), &amp;info) == 0 &amp;&amp; (info.st_mode&amp;_S_IFDIR))
-		return true;
-#else
-	struct stat info;
-
-	// First check if directory exists. We'll return success if it does.
-	if (stat(dir.c_str(), &amp;info) == 0 &amp;&amp; S_ISDIR(info.st_mode))
-		return true;
-#endif
-	// If it doesn't exist we try to mkdir it and return success if that succeeds.
-#ifndef _WIN32
-	if (::mkdir(dir.c_str(), S_IRWXU | S_IRGRP | S_IXGRP | S_IROTH | S_IXOTH) == 0)
-#else
-	if (::_mkdir(dir.c_str()) == 0)
-#endif
-		return true;
-
-	// Otherwise we return false.
-	return false;
-}
-
-
-static void FindFiles(std::vector&lt;std::string&gt;&amp; matches, const std::string&amp; dir, const boost::regex &amp;regexpattern, int flags)
-{
-#ifdef _WIN32
-	WIN32_FIND_DATA wfd;
-  HANDLE hFind = FindFirstFile((dir+&quot;\\*&quot;).c_str(), &amp;wfd);
-
-	if (hFind != INVALID_HANDLE_VALUE) {
-		do {
-			if(strcmp(wfd.cFileName,&quot;.&quot;) &amp;&amp; strcmp(wfd.cFileName ,&quot;..&quot;)) {
-				if(!(wfd.dwFileAttributes&amp;FILE_ATTRIBUTE_DIRECTORY)) {
-					if ((flags &amp; FileSystem::ONLY_DIRS) == 0) {
-						if (boost::regex_match(wfd.cFileName, regexpattern)) {
-							matches.push_back(dir + wfd.cFileName);
-						}
-					}
-				}
-				else {
-					if (flags &amp; FileSystem::INCLUDE_DIRS) {
-						if (boost::regex_match(wfd.cFileName, regexpattern)) {
-							matches.push_back(dir + wfd.cFileName + &quot;\\&quot;);
-						}
-					}
-					if (flags &amp; FileSystem::RECURSE) {
-						FindFiles(matches, dir + wfd.cFileName + &quot;\\&quot;, regexpattern, flags);
-					}
-				}
-			}
-		} while (FindNextFile(hFind, &amp;wfd));
-		FindClose(hFind);
-	}
-#else
-	DIR* dp;
-	struct dirent* ep;
-
-	if (!(dp = opendir(dir.c_str())))
-		return;
-
-	while ((ep = readdir(dp))) {
-		// exclude hidden files
-		if (ep-&gt;d_name[0] != '.') {
-			// is it a file? (we just treat sockets / pipes / fifos / character&amp;block devices as files...)
-			// (need to stat because d_type is DT_UNKNOWN on linux :-/)
-			struct stat info;
-			if (stat((dir + ep-&gt;d_name).c_str(), &amp;info) == 0) {
-				if (!S_ISDIR(info.st_mode)) {
-					if ((flags &amp; FileSystem::ONLY_DIRS) == 0) {
-						if (boost::regex_match(ep-&gt;d_name, regexpattern)) {
-							matches.push_back(dir + ep-&gt;d_name);
-						}
-					}
-				}
-				else {
-					// or a directory?
-					if (flags &amp; FileSystem::INCLUDE_DIRS) {
-						if (boost::regex_match(ep-&gt;d_name, regexpattern)) {
-							matches.push_back(dir + ep-&gt;d_name + &quot;/&quot;);
-						}
-					}
-					if (flags &amp; FileSystem::RECURSE) {
-						FindFiles(matches, dir + ep-&gt;d_name + &quot;/&quot;, regexpattern, flags);
-					}
-				}
-			}
-		}
-	}
-	closedir(dp);
-#endif
-}
-
-
-/**
- * @brief internal find-files-in-a-single-datadir-function
- * @param dir path in which to start looking
- * @param pattern pattern to search for
- * @param recurse whether or not to recursively search
- * @param include_dirs whether or not to include directory names in the result
- * @return vector of std::strings
- *
- * Will search for a file given a particular pattern.
- * Starts from dirpath, descending down if recurse is true.
- */
-void UnixFileSystemHandler::FindFilesSingleDir(std::vector&lt;std::string&gt;&amp; matches, const std::string&amp; dir, const std::string &amp;pattern, int flags) const
-{
-	assert(!dir.empty() &amp;&amp; dir[dir.length() - 1] == native_path_separator);
-
-	boost::regex regexpattern(filesystem.glob_to_regex(pattern));
-
-	::FindFiles(matches, dir, regexpattern, flags);
-}

Deleted: trunk/rts/System/Platform/Linux/UnixFileSystemHandler.h
===================================================================
--- trunk/rts/System/Platform/Linux/UnixFileSystemHandler.h	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/System/Platform/Linux/UnixFileSystemHandler.h	2008-11-10 23:35:19 UTC (rev 7014)
@@ -1,46 +0,0 @@
-/**
- * @file UnixFileSystemHandler.h
- * @brief Abstracts locating of content on different platforms
- * @author Tobi Vollebregt
- *
- * Unix implementation
- *
- * Copyright (C) 2006.  Licensed under the terms of the
- * GNU GPL, v2 or later
- */
-
-#ifndef UNIXFILESYSTEMHANDLER_H
-#define UNIXFILESYSTEMHANDLER_H
-
-#include &lt;string&gt;
-#include &lt;vector&gt;
-#include &quot;DataDirLocater.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
-
-/**
- * @brief Unix file system / data directory handler
- */
-class UnixFileSystemHandler : public FileSystemHandler
-{
-	public:
-
-		virtual ~UnixFileSystemHandler();
-		UnixFileSystemHandler(bool verbose);
-		virtual void Initialize();
-
-		virtual bool mkdir(const std::string&amp; dir) const;
-
-		virtual std::string GetWriteDir() const;
-		virtual std::vector&lt;std::string&gt; FindFiles(const std::string&amp; dir, const std::string&amp; pattern, int flags) const;
-		virtual std::string LocateFile(const std::string&amp; file) const;
-		virtual std::vector&lt;std::string&gt; GetDataDirectories() const;
-
-	protected:
-
-		void InitVFS() const;
-		void FindFilesSingleDir(std::vector&lt;std::string&gt;&amp; matches, const std::string&amp; dir, const std::string &amp;pattern, int flags) const;
-
-		DataDirLocater locater;
-};
-
-#endif // !UNIXFILESYSTEMHANDLER_H

Deleted: trunk/rts/System/Platform/Mac/MacFileSystemHandler.cpp
===================================================================
--- trunk/rts/System/Platform/Mac/MacFileSystemHandler.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/System/Platform/Mac/MacFileSystemHandler.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -1,72 +0,0 @@
-/*
- * @file MacFileSystemHandler.cpp
- * @author Fabian Herb
- *
- * Copyright (C) 2008.  Licensed under the terms of the
- * GNU GPL, v2 or later
- */
-
-#include &lt;CoreFoundation/CoreFoundation.h&gt;
-#include &quot;StdAfx.h&quot;
-#include &quot;LogOutput.h&quot;
-#include &quot;MacFileSystemHandler.h&quot;
-
-/**
- * This does exactly the same as the constructor of UnixFileSystemHandler, but unfortunately
- * simply making LocateDataDirs() virtual did not work, it would not call the correct one.
- */
-MacFileSystemHandler::MacFileSystemHandler(bool verbose) : UnixFileSystemHandler(verbose, false)
-{
-	LocateDataDirs();
-	InitVFS();
-	
-	for (std::vector&lt;DataDir&gt;::const_iterator d = datadirs.begin(); d != datadirs.end(); ++d) {
-		if (d-&gt;readable) {
-			if (d-&gt;writable)
-				logOutput.Print(&quot;Using read-write data directory: %s&quot;, d-&gt;path.c_str());
-			else
-				logOutput.Print(&quot;Using read-only  data directory: %s&quot;, d-&gt;path.c_str());
-		}
-	}
-}
-
-void MacFileSystemHandler::LocateDataDirs()
-{
-	// Get the path to the application bundle we are running:
-	char cPath[1024];
-    CFBundleRef mainBundle = CFBundleGetMainBundle();
-    if(!mainBundle)
-	    throw content_error(&quot;Could not determine bundle path&quot;);
-
-    CFURLRef mainBundleURL = CFBundleCopyBundleURL(mainBundle);
-	if(!mainBundleURL)
-		 throw content_error(&quot;Could not determine bundle path&quot;);
-
-    CFStringRef cfStringRef = CFURLCopyFileSystemPath(mainBundleURL, kCFURLPOSIXPathStyle);
-	if(!cfStringRef)
-		 throw content_error(&quot;Could not determine bundle path&quot;);
-
-    CFStringGetCString(cfStringRef, cPath, 1024, kCFStringEncodingASCII);
-
-    CFRelease(mainBundleURL);
-    CFRelease(cfStringRef);
-	std::string path(cPath);
-	
-	datadirs.clear();
-	writedir = NULL;
-	
-	// Add bundle resources:
-	datadirs.push_back(path + &quot;/Contents/Resources/&quot;);
-	datadirs.rbegin()-&gt;readable = true;
-	// Add the directory surrounding the bundle, for users to add mods and maps in:
-	datadirs.push_back(filesystem.GetDirectory(path));
-	// Use surrounding directory as writedir for now, should propably
-	// change this to something inside the home directory:
-	datadirs.rbegin()-&gt;writable = true;
-	datadirs.rbegin()-&gt;readable = true;
-	writedir = &amp;*datadirs.rbegin();
-	
-	// See UnixFileSystemHandler::LocateDataDirs() on why we change the working
-	// directory here:
-	chdir(GetWriteDir().c_str());
-}

Deleted: trunk/rts/System/Platform/Mac/MacFileSystemHandler.h
===================================================================
--- trunk/rts/System/Platform/Mac/MacFileSystemHandler.h	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/System/Platform/Mac/MacFileSystemHandler.h	2008-11-10 23:35:19 UTC (rev 7014)
@@ -1,26 +0,0 @@
-/*
- * @file MacFileSystemHandler.h
- * @author Fabian Herb
- * @brief Abstracts locating of content on different platforms
- *
- * Copyright (C) 2008.  Licensed under the terms of the
- * GNU GPL, v2 or later
- *
- */
- 
-#ifndef MACFILESYSTEMHANDLER_H
-#define MACFILESYSTEMHANDLER_H
-
-#include &quot;Platform/Linux/UnixFileSystemHandler.h&quot;
-
-/// Mac file system handler, configures mac-specific search paths
-class MacFileSystemHandler : public UnixFileSystemHandler
-{
-public:
-	MacFileSystemHandler(bool verbose);
-protected:
-	/// Adds the application bundle resources and the surrounding dir to the searchtree
-	void LocateDataDirs();
-};
-
-#endif

Deleted: trunk/rts/System/Platform/Win/DataDirLocater.cpp
===================================================================
--- trunk/rts/System/Platform/Win/DataDirLocater.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/System/Platform/Win/DataDirLocater.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -1 +0,0 @@
-#include &quot;Platform/Linux/DataDirLocater.cpp&quot;

Deleted: trunk/rts/System/Platform/Win/DataDirLocater.h
===================================================================
--- trunk/rts/System/Platform/Win/DataDirLocater.h	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/System/Platform/Win/DataDirLocater.h	2008-11-10 23:35:19 UTC (rev 7014)
@@ -1 +0,0 @@
-#include &quot;Platform/Linux/DataDirLocater.h&quot;

Deleted: trunk/rts/System/Platform/Win/WinFileSystemHandler.cpp
===================================================================
--- trunk/rts/System/Platform/Win/WinFileSystemHandler.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/System/Platform/Win/WinFileSystemHandler.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -1,2 +0,0 @@
-#include &quot;StdAfx.h&quot;
-#include &quot;Platform/Linux/UnixFileSystemHandler.cpp&quot;

Deleted: trunk/rts/System/Platform/Win/WinFileSystemHandler.h
===================================================================
--- trunk/rts/System/Platform/Win/WinFileSystemHandler.h	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/System/Platform/Win/WinFileSystemHandler.h	2008-11-10 23:35:19 UTC (rev 7014)
@@ -1,2 +0,0 @@
-//HACK don't want to adjust scons to build the unix one for windows
-#include &quot;Platform/Linux/UnixFileSystemHandler.h&quot;

Modified: trunk/rts/System/SpringApp.cpp
===================================================================
--- trunk/rts/System/SpringApp.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/rts/System/SpringApp.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -27,7 +27,7 @@
 #include &quot;Platform/BaseCmd.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;Platform/errorhandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;FileSystem/FileHandler.h&quot;
 #include &quot;Rendering/glFont.h&quot;
 #include &quot;Rendering/GLContext.h&quot;

Modified: trunk/tools/DedicatedServer/CMakeLists.txt
===================================================================
--- trunk/tools/DedicatedServer/CMakeLists.txt	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/tools/DedicatedServer/CMakeLists.txt	2008-11-10 23:35:19 UTC (rev 7014)
@@ -1,63 +1,58 @@
-ADD_DEFINITIONS(-DSTREFLOP_X87) # should be in ../../CMakeLists.txt
-ADD_DEFINITIONS(-DDEDICATED ${PIC_FLAG} -DNO_AVI)
-
-AUX_SOURCE_DIRECTORY(../../rts/System/Net/ netfiles)
-INCLUDE_DIRECTORIES(../../rts/System/Net/ ../../rts/System/ ../../rts/lib/lua/include)
-INCLUDE_DIRECTORIES(../../rts/ ../../rts/Game ../../rts/lib/7zip ../../rts/System)
-
-IF (UNIX)
-	SET(platformfiles
-		../../rts/System/Platform/Linux/UnixFileSystemHandler
-		../../rts/System/Platform/Linux/DataDirLocater
-		../../rts/System/Platform/Linux/DotfileHandler)
-ELSE (UNIX)
-	SET(platformfiles
-		../../rts/System/Platform/Win/WinFileSystemHandler
-		../../rts/System/Platform/Win/DataDirLocater
-		../../rts/System/Platform/Win/RegHandler)
-ENDIF (UNIX)
-
-AUX_SOURCE_DIRECTORY(../../rts/System/FileSystem/ fsfiles)
-SET(system_files 
-	${fsfiles}
-	${platformfiles}
-	 ${netfiles}
-	../../rts/System/TdfParser
-	../../rts/System/Platform/FileSystem
-	../../rts/System/Platform/ConfigHandler
-	../../rts/System/LogOutput
-	../../rts/System/BaseNetProtocol
-	../../rts/System/Demo
-	../../rts/System/DemoReader
-	../../rts/System/AutohostInterface
-	../../rts/System/UnsyncedRNG )
-
-AUX_SOURCE_DIRECTORY(../../rts/Game/Server serverfiles)
-ADD_LIBRARY(springserver SHARED
-	${system_files}
-	${serverfiles}
-	../../rts/Game/GameServer
-	../../rts/Game/GameSetup
-	../../rts/Game/GameData
-	../../rts/Game/PlayerBase
-	../../rts/Game/GameVersion
-	../../rts/Game/CommandMessage
-	../../rts/Game/ChatMessage
-	../../rts/Game/Console
-	../../rts/Game/Action
-	../../rts/Lua/LuaIO
-	../../rts/Lua/LuaParser
-	../../rts/Lua/LuaUtils
-	../../rts/Map/MapParser
-	../../rts/Rendering/Textures/TAPalette)
-TARGET_LINK_LIBRARIES(springserver ${SDL_LIBRARY} ${Boost_REGEX_LIBRARY} ${Boost_THREAD_LIBRARY} hpiutil2 7zip minizip lua)
-if (MINGW)
-	TARGET_LINK_LIBRARIES (springserver ws2_32)
-else (MINGW)
-	ADD_DEFINITIONS (-fvisibility=default ) #overwrite hidden visibility
-endif (MINGW)
-
-ADD_EXECUTABLE(spring-dedicated main)
-TARGET_LINK_LIBRARIES(spring-dedicated springserver)
-
-install (TARGETS springserver spring-dedicated RUNTIME DESTINATION ${BINDIR} LIBRARY DESTINATION ${LIBDIR})
+ADD_DEFINITIONS(-DSTREFLOP_X87) # should be in ../../CMakeLists.txt
+ADD_DEFINITIONS(-DDEDICATED ${PIC_FLAG} -DNO_AVI)
+
+AUX_SOURCE_DIRECTORY(../../rts/System/Net/ netfiles)
+INCLUDE_DIRECTORIES(../../rts/System/Net/ ../../rts/System/ ../../rts/lib/lua/include)
+INCLUDE_DIRECTORIES(../../rts/ ../../rts/Game ../../rts/lib/7zip ../../rts/System)
+
+IF (UNIX)
+	SET(platformfiles
+		../../rts/System/Platform/Linux/DotfileHandler)
+ELSE (UNIX)
+	SET(platformfiles
+		../../rts/System/Platform/Win/RegHandler)
+ENDIF (UNIX)
+
+AUX_SOURCE_DIRECTORY(../../rts/System/FileSystem/ fsfiles)
+SET(system_files 
+	${fsfiles}
+	${platformfiles}
+	 ${netfiles}
+	../../rts/System/TdfParser
+	../../rts/System/Platform/ConfigHandler
+	../../rts/System/LogOutput
+	../../rts/System/BaseNetProtocol
+	../../rts/System/Demo
+	../../rts/System/DemoReader
+	../../rts/System/AutohostInterface
+	../../rts/System/UnsyncedRNG )
+
+AUX_SOURCE_DIRECTORY(../../rts/Game/Server serverfiles)
+ADD_LIBRARY(springserver SHARED
+	${system_files}
+	${serverfiles}
+	../../rts/Game/GameServer
+	../../rts/Game/GameSetup
+	../../rts/Game/GameData
+	../../rts/Game/PlayerBase
+	../../rts/Game/GameVersion
+	../../rts/Game/CommandMessage
+	../../rts/Game/ChatMessage
+	../../rts/Game/Console
+	../../rts/Game/Action
+	../../rts/Lua/LuaIO
+	../../rts/Lua/LuaParser
+	../../rts/Lua/LuaUtils
+	../../rts/Map/MapParser
+	../../rts/Rendering/Textures/TAPalette)
+TARGET_LINK_LIBRARIES(springserver ${SDL_LIBRARY} ${Boost_REGEX_LIBRARY} ${Boost_THREAD_LIBRARY} hpiutil2 7zip minizip lua)
+if (MINGW)
+	TARGET_LINK_LIBRARIES (springserver ws2_32)
+else (MINGW)
+	ADD_DEFINITIONS (-fvisibility=default ) #overwrite hidden visibility
+endif (MINGW)
+
+ADD_EXECUTABLE(spring-dedicated main)
+TARGET_LINK_LIBRARIES(spring-dedicated springserver)
+
+install (TARGETS springserver spring-dedicated RUNTIME DESTINATION ${BINDIR} LIBRARY DESTINATION ${LIBDIR})

Modified: trunk/tools/DedicatedServer/main.cpp
===================================================================
--- trunk/tools/DedicatedServer/main.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/tools/DedicatedServer/main.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -1,7 +1,7 @@
 #include &quot;Game/GameServer.h&quot;
 #include &quot;GameSetup.h&quot;
 #include &quot;GameData.h&quot;
-#include &quot;System/Platform/FileSystem.h&quot;
+#include &quot;System/FileSystem/FileSystem.h&quot;
 #include &quot;System/FileSystem/ArchiveScanner.h&quot;
 #include &quot;System/FileSystem/VFSHandler.h&quot;
 #include &quot;System/FileSystem/FileHandler.h&quot;

Modified: trunk/tools/unitsync/CMakeLists.txt
===================================================================
--- trunk/tools/unitsync/CMakeLists.txt	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/tools/unitsync/CMakeLists.txt	2008-11-10 23:35:19 UTC (rev 7014)
@@ -39,17 +39,12 @@
 
 IF (UNIX)
 	SET(platformfiles
-		../../rts/System/Platform/Linux/UnixFileSystemHandler
-		../../rts/System/Platform/Linux/DataDirLocater
 		../../rts/System/Platform/Linux/DotfileHandler)
 ELSE (UNIX)
 	SET(platformfiles
-		../../rts/System/Platform/Win/WinFileSystemHandler
-		../../rts/System/Platform/Linux/DataDirLocater
 		../../rts/System/Platform/Win/RegHandler)
 ENDIF (UNIX)
 list(APPEND platformfiles
-	../../rts/System/Platform/FileSystem
 	../../rts/System/Platform/ConfigHandler)
 
 AUX_SOURCE_DIRECTORY(../../rts/System/FileSystem/ fsfiles)

Modified: trunk/tools/unitsync/javabind.cpp
===================================================================
--- trunk/tools/unitsync/javabind.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/tools/unitsync/javabind.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -7,7 +7,7 @@
 #include &quot;FileSystem/VFSHandler.h&quot;
 #include &quot;Map/SMF/mapfile.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;Rendering/Textures/Bitmap.h&quot;
 
 #include &lt;string&gt;

Modified: trunk/tools/unitsync/pybind.cpp
===================================================================
--- trunk/tools/unitsync/pybind.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/tools/unitsync/pybind.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -14,7 +14,7 @@
 #include &lt;cstring&gt;
 #include &quot;unitsync.h&quot;
 #include &quot;Rendering/Textures/Bitmap.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 
 #define NAMEBUF_SIZE 4096
 

Modified: trunk/tools/unitsync/unitsync.cpp
===================================================================
--- trunk/tools/unitsync/unitsync.cpp	2008-11-10 21:19:55 UTC (rev 7013)
+++ trunk/tools/unitsync/unitsync.cpp	2008-11-10 23:35:19 UTC (rev 7014)
@@ -17,7 +17,7 @@
 #include &quot;Map/MapParser.h&quot;
 #include &quot;Map/SMF/SmfMapFile.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
+#include &quot;FileSystem/FileSystem.h&quot;
 #include &quot;Rendering/Textures/Bitmap.h&quot;
 #include &quot;Sim/Misc/SideParser.h&quot;
 #include &quot;System/Exceptions.h&quot;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001782.html">[Taspring-linux-commit] r7013 - branches/gmltest/rts/lib/lua/src
</A></li>
	<LI>Next message: <A HREF="001784.html">[Taspring-linux-commit] r7015 - trunk
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1783">[ date ]</a>
              <a href="thread.html#1783">[ thread ]</a>
              <a href="subject.html#1783">[ subject ]</a>
              <a href="author.html#1783">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
