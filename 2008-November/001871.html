<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r7102 - in Lobby/springie: Springie	Springie/autohost Springie/client Springie/spring	Springie/utils libs
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-November/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r7102%20-%20in%20Lobby/springie%3A%20Springie%0A%09Springie/autohost%20Springie/client%20Springie/spring%0A%09Springie/utils%20libs&In-Reply-To=%3C20081128033613.6B36C476B%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001870.html">
   <LINK REL="Next"  HREF="001872.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r7102 - in Lobby/springie: Springie	Springie/autohost Springie/client Springie/spring	Springie/utils libs</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r7102%20-%20in%20Lobby/springie%3A%20Springie%0A%09Springie/autohost%20Springie/client%20Springie/spring%0A%09Springie/utils%20libs&In-Reply-To=%3C20081128033613.6B36C476B%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r7102 - in Lobby/springie: Springie	Springie/autohost Springie/client Springie/spring	Springie/utils libs">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Fri Nov 28 04:36:13 CET 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001870.html">[Taspring-linux-commit] r7101 - in trunk/rts: Game Lua Map/SMF	Rendering/Env Rendering/UnitModels Sim/Path Sim/Projectiles	Sim/Units System lib/gml
</A></li>
        <LI>Next message: <A HREF="001872.html">[Taspring-linux-commit] r7103 - in Lobby/springie:	Springie/autohost Springie/utils libs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1871">[ date ]</a>
              <a href="thread.html#1871">[ thread ]</a>
              <a href="subject.html#1871">[ subject ]</a>
              <a href="author.html#1871">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: Licho
Date: 2008-11-28 04:36:12 +0100 (Fri, 28 Nov 2008)
New Revision: 7102

Modified:
   Lobby/springie/Springie/Main.cs
   Lobby/springie/Springie/autohost/AutoHost.cs
   Lobby/springie/Springie/autohost/AutoHost_commands.cs
   Lobby/springie/Springie/client/TasClient.cs
   Lobby/springie/Springie/spring/Spring.cs
   Lobby/springie/Springie/utils/Stats.cs
   Lobby/springie/libs/PlanetWarsShared.dll
Log:
 * added awards -&gt; PlanetWars sending
 * added faction channel guarding and logging (kicks people not belonging to that faction and logs stuff to central server)

Modified: Lobby/springie/Springie/Main.cs
===================================================================
--- Lobby/springie/Springie/Main.cs	2008-11-27 13:54:29 UTC (rev 7101)
+++ Lobby/springie/Springie/Main.cs	2008-11-28 03:36:12 UTC (rev 7102)
@@ -1,224 +1,295 @@
 #region using
 
+#region using
+
 using System;
+using System.Collections.Generic;
 using System.IO;
+using System.Linq;
 using System.Timers;
-using System.Windows.Forms;
 using System.Xml.Serialization;
+using PlanetWarsShared;
 using PlanetWarsShared.Springie;
 using Springie.autohost;
 using Springie.Client;
 using Springie.SpringNamespace;
-using Timer=System.Timers.Timer;
 
+    #endregion
+
 #endregion
 
 namespace Springie
 {
-	public class Main
-	{
-		#region Constants
+    public class Main
+    {
+        #region Constants
 
-		public const string ConfigMain = &quot;main.xml&quot;;
+        public const string ConfigMain = &quot;main.xml&quot;;
 
-		#endregion
+        #endregion
 
-		#region Fields
+        #region Fields
 
-		private AutoHost autoHost;
-		private AutoUpdater autoUpdater;
-		private Timer recon;
-		private Spring spring;
+        private AutoHost autoHost;
+        private AutoUpdater autoUpdater;
+        private List&lt;string&gt; planetWarsChannels = new List&lt;string&gt;();
+        private Dictionary&lt;string, string&gt; planetWarsPlayerSide = new Dictionary&lt;string, string&gt;();
+        private Timer recon;
+        private Spring spring;
 
-		private Stats stats;
+        private Stats stats;
 
-		private TasClient tas;
+        private TasClient tas;
 
-		#endregion
+        #endregion
 
-		#region Properties
+        #region Properties
 
-		public AutoHost AutoHost
-		{
-			get { return autoHost; }
-		}
+        public AutoHost AutoHost
+        {
+            get { return autoHost; }
+        }
 
-		public MainConfig config;
-		public ISpringieServer PlanetWars;
+        public MainConfig config;
+        public ISpringieServer PlanetWars;
 
-		public Spring Spring
-		{
-			get { return spring; }
-		}
+        public AuthInfo PlanetwarsAccount
+        {
+            get { return new AuthInfo(config.PlanetWarsServerLogin, config.PlanetWarsServerPassword); }
+        }
 
-		public Stats Stats
-		{
-			get { return stats; }
-		}
+        public Spring Spring
+        {
+            get { return spring; }
+        }
 
-		public TasClient Tas
-		{
-			get { return tas; }
-		}
+        public Stats Stats
+        {
+            get { return stats; }
+        }
 
-		#endregion
+        public TasClient Tas
+        {
+            get { return tas; }
+        }
 
-		#region Constructors
+        #endregion
 
-		public Main()
-		{
-			LoadConfig();
-			SaveConfig();
-		}
+        #region Constructors
 
-		#endregion
+        public Main()
+        {
+            LoadConfig();
+            SaveConfig();
+        }
 
-		#region Public methods
+        #endregion
 
-		public void InitializePlanetWarsServer()
-		{
-			PlanetWars = (ISpringieServer) Activator.GetObject(typeof (ISpringieServer), String.Format(&quot;<A HREF="tcp://{0">tcp://{0</A>}:1666/IServer&quot;, config.PlanetWarsServer));
-		}
+        #region Public methods
 
-		public void LoadConfig()
-		{
-			config = new MainConfig();
-			if (File.Exists(Program.WorkPath + '/' + ConfigMain))
-			{
-				var s = new XmlSerializer(config.GetType());
-				var r = File.OpenText(Program.WorkPath + '/' + ConfigMain);
-				config = (MainConfig) s.Deserialize(r);
-				r.Close();
-			}
-		}
+        public void InitializePlanetWarsServer()
+        {
+            PlanetWars = (ISpringieServer) Activator.GetObject(typeof (ISpringieServer), String.Format(&quot;<A HREF="tcp://{0">tcp://{0</A>}:1666/IServer&quot;, config.PlanetWarsServer));
 
-		public void ReLogin()
-		{
-			tas_Connected(this, new TasEventArgs());
-		}
+            planetWarsPlayerSide = new Dictionary&lt;string, string&gt;();
 
-		public void SaveConfig()
-		{
-			var s = new XmlSerializer(config.GetType());
-			var f = File.OpenWrite(Program.WorkPath + '/' + ConfigMain);
-			f.SetLength(0);
-			s.Serialize(f, config);
-			f.Close();
-		}
+            // fill factions for channel monitoring and join channels
+            planetWarsChannels = new List&lt;string&gt;();
+            var factions = PlanetWars.GetFactions();
+            foreach (var fact in factions) {
+                string name = fact.Name.ToLower();
+                planetWarsChannels.Add(name);
+                if (!Program.main.config.JoinChannels.Contains(name)) {
+                    var list = new List&lt;string&gt;(Program.main.config.JoinChannels);
+                    list.Add(name);
+                    Program.main.config.JoinChannels = list.ToArray();
+                    if (tas != null &amp;&amp; tas.IsConnected &amp;&amp; tas.IsLoggedIn) tas.JoinChannel(name);
+                }
+            }
+        }
 
+        public void LoadConfig()
+        {
+            config = new MainConfig();
+            if (File.Exists(Program.WorkPath + '/' + ConfigMain)) {
+                var s = new XmlSerializer(config.GetType());
+                var r = File.OpenText(Program.WorkPath + '/' + ConfigMain);
+                config = (MainConfig) s.Deserialize(r);
+                r.Close();
+            }
+        }
 
-		public bool Start()
-		{
-			if (config.AttemptToRecconnect) {
-				recon = new Timer(config.AttemptReconnectInterval*1000);
-				recon.Elapsed += recon_Elapsed;
-			}
+        public void ReLogin()
+        {
+            tas_Connected(this, new TasEventArgs());
+        }
 
-			recon.Enabled = false;
-			spring = new Spring();
+        public void SaveConfig()
+        {
+            var s = new XmlSerializer(config.GetType());
+            var f = File.OpenWrite(Program.WorkPath + '/' + ConfigMain);
+            f.SetLength(0);
+            s.Serialize(f, config);
+            f.Close();
+        }
 
-			if (config.PlanetWarsEnabled) InitializePlanetWarsServer();
 
-			tas = new TasClient();
-			tas.ConnectionLost += tas_ConnectionLost;
-			tas.Connected += tas_Connected;
-			tas.LoginDenied += tas_LoginDenied;
-			tas.LoginAccepted += tas_LoginAccepted;
-			tas.Said += tas_Said;
-			tas.MyStatusChangedToInGame += tas_MyStatusChangedToInGame;
-			spring.SpringExited += spring_SpringExited;
-			spring.SpringStarted += spring_SpringStarted;
-			spring.PlayerSaid += spring_PlayerSaid;
-  		autoHost = new AutoHost(tas, spring, null);
-			autoUpdater = new AutoUpdater(spring, tas);
+        public bool Start()
+        {
+            if (config.AttemptToRecconnect) {
+                recon = new Timer(config.AttemptReconnectInterval*1000);
+                recon.Elapsed += recon_Elapsed;
+            }
 
-			if (config.StatsEnabledReal) stats = new Stats(tas, spring);
-			try {
-				tas.Connect(config.ServerHost, config.ServerPort);
-			} catch {
-				recon.Start();
-			}
-			return true;
-		}
+            recon.Enabled = false;
+            spring = new Spring();
 
+            if (config.PlanetWarsEnabled) InitializePlanetWarsServer();
 
-		public void Stop()
-		{
-			tas.ConnectionLost -= tas_ConnectionLost;
-			tas.Disconnect();
-		}
+            tas = new TasClient();
+            tas.ConnectionLost += tas_ConnectionLost;
+            tas.Connected += tas_Connected;
+            tas.LoginDenied += tas_LoginDenied;
+            tas.LoginAccepted += tas_LoginAccepted;
+            tas.Said += tas_Said;
+            tas.MyStatusChangedToInGame += tas_MyStatusChangedToInGame;
+            tas.ChannelUserAdded += tas_ChannelUserAdded;
+            spring.SpringExited += spring_SpringExited;
+            spring.SpringStarted += spring_SpringStarted;
+            spring.PlayerSaid += spring_PlayerSaid;
+            autoHost = new AutoHost(tas, spring, null);
+            autoUpdater = new AutoUpdater(spring, tas);
 
-		#endregion
+            if (config.StatsEnabledReal) stats = new Stats(tas, spring);
+            try {
+                tas.Connect(config.ServerHost, config.ServerPort);
+            } catch {
+                recon.Start();
+            }
+            return true;
+        }
 
-		#region Event Handlers
 
-		private void recon_Elapsed(object sender, ElapsedEventArgs e)
-		{
-			recon.Stop();
-			try {
-				tas.Connect(config.ServerHost, config.ServerPort);
-			} catch {
-				recon.Start();
-			}
-		}
+        public void Stop()
+        {
+            tas.ConnectionLost -= tas_ConnectionLost;
+            tas.Disconnect();
+        }
 
+        #endregion
 
+        #region Event Handlers
+
+        private void recon_Elapsed(object sender, ElapsedEventArgs e)
+        {
+            recon.Stop();
+            try {
+                tas.Connect(config.ServerHost, config.ServerPort);
+            } catch {
+                recon.Start();
+            }
+        }
+
+
         private void spring_PlayerSaid(object sender, SpringLogEventArgs e)
-		{
-			tas.GameSaid(e.Username, e.Line);
-			if (config.RedirectGameChat &amp;&amp; e.Username != tas.UserName &amp;&amp; !e.Line.StartsWith(&quot;Allies:&quot;) &amp;&amp; !e.Line.StartsWith(&quot;Spectators:&quot;)) tas.Say(TasClient.SayPlace.Battle, &quot;&quot;, &quot;[&quot; + e.Username + &quot;]&quot; + e.Line, false);
-		}
+        {
+            tas.GameSaid(e.Username, e.Line);
+            if (config.RedirectGameChat &amp;&amp; e.Username != tas.UserName &amp;&amp; !e.Line.StartsWith(&quot;Allies:&quot;) &amp;&amp; !e.Line.StartsWith(&quot;Spectators:&quot;)) tas.Say(TasClient.SayPlace.Battle, &quot;&quot;, &quot;[&quot; + e.Username + &quot;]&quot; + e.Line, false);
+        }
 
-		private void spring_SpringExited(object sender, EventArgs e)
-		{
-			if (tas != null) tas.ChangeMyStatus(false, false);
-		}
+        private void spring_SpringExited(object sender, EventArgs e)
+        {
+            if (tas != null) tas.ChangeMyStatus(false, false);
+        }
 
-		private void spring_SpringStarted(object sender, EventArgs e)
-		{
-			tas.ChangeLock(false);
-		}
+        private void spring_SpringStarted(object sender, EventArgs e)
+        {
+            tas.ChangeLock(false);
+        }
 
+        private void tas_ChannelUserAdded(object sender, TasEventArgs e)
+        {
+            if (config.PlanetWarsEnabled &amp;&amp; PlanetWars != null) {
+                string channel = e.ServerParams[0];
+                string name = e.ServerParams[1];
 
-		// login accepted - join channels
+                if (planetWarsChannels.Contains(channel) &amp;&amp; name != &quot;ChanServ&quot; &amp;&amp; name != tas.UserName) {
+                    bool? isOk = null;
+                    string side;
+                    if (planetWarsPlayerSide.TryGetValue(name, out side)) {
+                        // first check cached value
+                        isOk = side == channel;
+                    }
+                    if (!isOk.HasValue) {
+                        IPlayer usinfo = null;
+                        try {
+                            usinfo = PlanetWars.GetPlayerInfo(name);
+                        } catch (Exception ex) {
+                            autoHost.SayBattle(&quot;Error fetching user info:&quot; + ex);
+                        }
+                        if (usinfo == null) isOk = false;
+                        else {
+                            string realFact = usinfo.FactionName.ToLower();
+                            planetWarsPlayerSide[name] = realFact;
+                            isOk = realFact == channel;
+                        }
+                    }
 
-		// im connected, let's login
-		private void tas_Connected(object sender, TasEventArgs e)
-		{
-			tas.Login(config.AccountName, config.AccountPassword, MainConfig.SpringieVersion);
-		}
+                    // he is not from this faction, mute him
+                    if (!isOk.Value) tas.Say(TasClient.SayPlace.User, &quot;ChanServ&quot;, string.Format(&quot;!kick #{0} {1} This is PlanetWars faction channel&quot;, channel, name), false);
+                }
+            }
+        }
 
 
-		private void tas_ConnectionLost(object sender, TasEventArgs e)
-		{
-			autoHost.Stop();
-			recon.Start();
-		}
+        // login accepted - join channels
 
-		private void tas_LoginAccepted(object sender, TasEventArgs e)
-		{
-			for (int i = 0; i &lt; config.JoinChannels.Length; ++i) tas.JoinChannel(config.JoinChannels[i]);
-			autoHost.Start(null, null);
-		}
+        // im connected, let's login
+        private void tas_Connected(object sender, TasEventArgs e)
+        {
+            tas.Login(config.AccountName, config.AccountPassword, MainConfig.SpringieVersion);
+        }
 
-		private void tas_LoginDenied(object sender, TasEventArgs e)
-		{
-			ErrorHandling.HandleException(null, &quot;Login failed&quot;);
-			if (Program.GuiEnabled &amp;&amp; Program.formMain != null )Program.formMain.GetNewLogPass();
-		}
 
-		private void tas_MyStatusChangedToInGame(object sender, TasEventArgs e)
-		{
-			spring.StartGame(tas.GetBattle());
-		}
+        private void tas_ConnectionLost(object sender, TasEventArgs e)
+        {
+            autoHost.Stop();
+            recon.Start();
+        }
 
-		private void tas_Said(object sender, TasSayEventArgs e)
-		{
-			if (config.RedirectGameChat &amp;&amp; e.Place == TasSayEventArgs.Places.Battle &amp;&amp; e.Origin == TasSayEventArgs.Origins.Player &amp;&amp; e.UserName != tas.UserName &amp;&amp; e.IsEmote == false) {
-				spring.SayGame(&quot;[&quot; + e.UserName + &quot;]&quot; + e.Text);
-			}
-		}
+        private void tas_LoginAccepted(object sender, TasEventArgs e)
+        {
+            for (int i = 0; i &lt; config.JoinChannels.Length; ++i) tas.JoinChannel(config.JoinChannels[i]);
+            autoHost.Start(null, null);
+        }
 
-		#endregion
-	}
+        private void tas_LoginDenied(object sender, TasEventArgs e)
+        {
+            ErrorHandling.HandleException(null, &quot;Login failed&quot;);
+            if (Program.GuiEnabled &amp;&amp; Program.formMain != null) Program.formMain.GetNewLogPass();
+        }
+
+        private void tas_MyStatusChangedToInGame(object sender, TasEventArgs e)
+        {
+            spring.StartGame(tas.GetBattle());
+        }
+
+        private void tas_Said(object sender, TasSayEventArgs e)
+        {
+            if (config.PlanetWarsEnabled &amp;&amp; PlanetWars != null) {
+                if (e.Origin == TasSayEventArgs.Origins.Player &amp;&amp; e.Place == TasSayEventArgs.Places.Channel &amp;&amp; planetWarsChannels.Contains(e.Channel)) {
+                    //  lets log this
+                    try {
+                        PlanetWars.SendChatLine(PlanetwarsAccount, e.Channel, e.UserName, e.Text);
+                    } catch (Exception ex) {
+                        autoHost.SayBattle(&quot;Error sending chat:&quot; + ex);
+                    }
+                }
+            }
+
+            if (config.RedirectGameChat &amp;&amp; e.Place == TasSayEventArgs.Places.Battle &amp;&amp; e.Origin == TasSayEventArgs.Origins.Player &amp;&amp; e.UserName != tas.UserName &amp;&amp; e.IsEmote == false) spring.SayGame(&quot;[&quot; + e.UserName + &quot;]&quot; + e.Text);
+        }
+
+        #endregion
+    }
 }
\ No newline at end of file

Modified: Lobby/springie/Springie/autohost/AutoHost.cs
===================================================================
--- Lobby/springie/Springie/autohost/AutoHost.cs	2008-11-27 13:54:29 UTC (rev 7101)
+++ Lobby/springie/Springie/autohost/AutoHost.cs	2008-11-28 03:36:12 UTC (rev 7102)
@@ -478,9 +478,12 @@
 
 		private void spring_GameOver(object sender, SpringLogEventArgs e)
 		{
-			Thread.Sleep(3000); // wait for stats
 			SayBattle(&quot;Game over, exiting&quot;);
-			spring.ExitGame();
+		    new Thread(x =&gt;
+		                   {
+		                       Thread.Sleep(3000); // wait for stats
+		                       spring.ExitGame();
+		                   }).Start();
 
 			if (config.MapCycle.Length &gt; 0) {
 				mapCycleIndex = mapCycleIndex%config.MapCycle.Length;

Modified: Lobby/springie/Springie/autohost/AutoHost_commands.cs
===================================================================
--- Lobby/springie/Springie/autohost/AutoHost_commands.cs	2008-11-27 13:54:29 UTC (rev 7101)
+++ Lobby/springie/Springie/autohost/AutoHost_commands.cs	2008-11-28 03:36:12 UTC (rev 7102)
@@ -1164,7 +1164,7 @@
 
             try {
                 var pw = Program.main.PlanetWars;
-                string response = pw.Register(new AuthInfo {Login = Program.main.config.PlanetWarsServerLogin, Password = Program.main.config.PlanetWarsServerPassword}, new AuthInfo {Login = e.UserName, Password = words[1]}, words[0], words.Length &gt; 2 ? Utils.Glue(words, 2) : null);
+                string response = pw.Register(Program.main.PlanetwarsAccount, new AuthInfo {Login = e.UserName, Password = words[1]}, words[0], words.Length &gt; 2 ? Utils.Glue(words, 2) : null);
                 Respond(e, string.Format(response));
             } catch (Exception ex) {
                 Respond(e, string.Format(&quot;Error when registering: {0}&quot;, ex));

Modified: Lobby/springie/Springie/client/TasClient.cs
===================================================================
--- Lobby/springie/Springie/client/TasClient.cs	2008-11-27 13:54:29 UTC (rev 7101)
+++ Lobby/springie/Springie/client/TasClient.cs	2008-11-28 03:36:12 UTC (rev 7102)
@@ -652,13 +652,16 @@
 
 					case &quot;CLIENTS&quot;: // client list sent after channel join
 						var usrs = Utils.Glue(args, 1).Split(' ');
-						foreach (var s in usrs) joinedChannels[args[0]].channelUsers.Add(s);
-						if (ChannelUserAdded != null) ChannelUserAdded(this, new TasEventArgs(args[0]));
+						foreach (var s in usrs) {
+						    joinedChannels[args[0]].channelUsers.Add(s);
+                            if (ChannelUserAdded != null) ChannelUserAdded(this, new TasEventArgs(args[0], s));
+						}
+						
 						break;
 
 					case &quot;JOINED&quot;: // user joined one of my channels
 						joinedChannels[args[0]].channelUsers.Add(args[1]);
-						if (ChannelUserAdded != null) ChannelUserAdded(this, new TasEventArgs(args[0]));
+						if (ChannelUserAdded != null) ChannelUserAdded(this, new TasEventArgs(args[0], args[1]));
 						break;
 
 					case &quot;LEFT&quot;: // user left one of my channels

Modified: Lobby/springie/Springie/spring/Spring.cs
===================================================================
--- Lobby/springie/Springie/spring/Spring.cs	2008-11-27 13:54:29 UTC (rev 7101)
+++ Lobby/springie/Springie/spring/Spring.cs	2008-11-28 03:36:12 UTC (rev 7102)
@@ -6,296 +6,339 @@
 using System.IO;
 using System.Threading;
 using System.Windows.Forms;
+using PlanetWarsShared;
 using Springie.Client;
 
 #endregion
 
 namespace Springie.SpringNamespace
 {
-	public class SpringLogEventArgs : EventArgs
-	{
-		#region Fields
+    public class SpringLogEventArgs : EventArgs
+    {
+        #region Fields
 
-		private List&lt;string&gt; args = new List&lt;string&gt;();
-		private string line;
-		private string username;
+        private List&lt;string&gt; args = new List&lt;string&gt;();
+        private string line;
+        private string username;
 
-		#endregion
+        #endregion
 
-		#region Properties
+        #region Properties
 
-		public List&lt;string&gt; Args
-		{
-			get { return args; }
-		}
+        public List&lt;string&gt; Args
+        {
+            get { return args; }
+        }
 
-		public string Line
-		{
-			get { return line; }
-		}
+        public string Line
+        {
+            get { return line; }
+        }
 
-		public string Username
-		{
-			get { return username; }
-		}
+        public string Username
+        {
+            get { return username; }
+        }
 
-		#endregion
+        #endregion
 
-		#region Constructors
+        #region Constructors
 
-		public SpringLogEventArgs(string username) : this(username, &quot;&quot;) {}
+        public SpringLogEventArgs(string username) : this(username, &quot;&quot;) {}
 
-		public SpringLogEventArgs(string username, string line)
-		{
-			this.line = line;
-			this.username = username;
-		}
+        public SpringLogEventArgs(string username, string line)
+        {
+            this.line = line;
+            this.username = username;
+        }
 
-		#endregion
-	} ;
+        #endregion
+    } ;
 
-	/// &lt;summary&gt;
-	/// represents one install location of spring game
-	/// &lt;/summary&gt;
-	public class Spring : IDisposable
-	{
-		#region Constants
+    /// &lt;summary&gt;
+    /// represents one install location of spring game
+    /// &lt;/summary&gt;
+    public class Spring : IDisposable
+    {
+        #region Constants
 
-		public const int MaxAllies = 10;
-		public const int MaxTeams = 32;
+        public const int MaxAllies = 10;
+        public const int MaxTeams = 32;
 
-		#endregion
+        #endregion
 
-		#region Fields
+        #region Fields
 
-		private DateTime gameStarted;
-		//    const string PathDivider = &quot;/&quot;;
+        private DateTime gameStarted;
+        private Dictionary&lt;string, int&gt; PlanetWarsMessages = new Dictionary&lt;string, int&gt;();
+        //    const string PathDivider = &quot;/&quot;;
 
-		private Process process;
-		private Talker talker;
+        private Process process;
+        private List&lt;string&gt; readyPlayers = new List&lt;string&gt;();
+        private Talker talker;
 
 
-		private UnitSyncWrapper unitSyncWrapper;
-		private List&lt;string&gt; readyPlayers = new List&lt;string&gt;();
+        private UnitSyncWrapper unitSyncWrapper;
 
-		#endregion
+        #endregion
 
-		#region Properties
+        #region Properties
 
-		public DateTime GameStarted
-		{
-			get { return gameStarted; }
-		}
+        public DateTime GameStarted
+        {
+            get { return gameStarted; }
+        }
 
-		public bool IsRunning
-		{
-			get
-			{
-				try {
-					return (process != null &amp;&amp; !process.HasExited);
-				} catch(Exception ex) {
-					ErrorHandling.HandleException(ex, &quot;Error determining process state&quot;);
-					return false;
-				}
-			}
-		}
+        public bool IsRunning
+        {
+            get
+            {
+                try {
+                    return (process != null &amp;&amp; !process.HasExited);
+                } catch (Exception ex) {
+                    ErrorHandling.HandleException(ex, &quot;Error determining process state&quot;);
+                    return false;
+                }
+            }
+        }
 
 
-		public ProcessPriorityClass ProcessPriority
-		{
-			get
-			{
-				if (IsRunning) return process.PriorityClass;
-				else return Program.main.config.HostingProcessPriority;
-			}
-			set { if (IsRunning) process.PriorityClass = value; }
-		}
+        public ProcessPriorityClass ProcessPriority
+        {
+            get
+            {
+                if (IsRunning) return process.PriorityClass;
+                else return Program.main.config.HostingProcessPriority;
+            }
+            set { if (IsRunning) process.PriorityClass = value; }
+        }
 
-		public UnitSyncWrapper UnitSyncWrapper
-		{
-			get { return unitSyncWrapper; }
-		}
+        public UnitSyncWrapper UnitSyncWrapper
+        {
+            get { return unitSyncWrapper; }
+        }
 
-		#endregion
+        #endregion
 
-		#region Events
+        #region Events
 
-		public event EventHandler&lt;SpringLogEventArgs&gt; GameOver; // game has ended
-		public event EventHandler&lt;SpringLogEventArgs&gt; PlayerDisconnected;
-		public event EventHandler&lt;SpringLogEventArgs&gt; PlayerJoined;
-		public event EventHandler&lt;SpringLogEventArgs&gt; PlayerLeft;
-		public event EventHandler&lt;SpringLogEventArgs&gt; PlayerLost; // player lost the game
-		public event EventHandler&lt;SpringLogEventArgs&gt; PlayerSaid;
-		//public event EventHandler&lt;&gt; 
-		public event EventHandler SpringExited;
-		public event EventHandler SpringStarted;
-		public event EventHandler NotifyModsChanged;
+        public event EventHandler&lt;SpringLogEventArgs&gt; GameOver; // game has ended
+        public event EventHandler NotifyModsChanged;
+        public event EventHandler&lt;SpringLogEventArgs&gt; PlayerDisconnected;
+        public event EventHandler&lt;SpringLogEventArgs&gt; PlayerJoined;
+        public event EventHandler&lt;SpringLogEventArgs&gt; PlayerLeft;
+        public event EventHandler&lt;SpringLogEventArgs&gt; PlayerLost; // player lost the game
+        public event EventHandler&lt;SpringLogEventArgs&gt; PlayerSaid;
+        //public event EventHandler&lt;&gt; 
+        public event EventHandler SpringExited;
+        public event EventHandler SpringStarted;
 
-		#endregion
+        #endregion
 
-		#region Constructors
+        #region Constructors
 
-		public Spring()
-		{
-			if (!File.Exists(Program.main.config.ExecutableName)) {
-				ErrorHandling.HandleException(null, Program.main.config.ExecutableName + &quot; not found&quot;);
-				if (Program.GuiEnabled) MessageBox.Show(Program.main.config.ExecutableName + &quot; not found&quot;, &quot;Cannot find dedicated server executable&quot;);
-			}
+        public Spring()
+        {
+            if (!File.Exists(Program.main.config.ExecutableName)) {
+                ErrorHandling.HandleException(null, Program.main.config.ExecutableName + &quot; not found&quot;);
+                if (Program.GuiEnabled) MessageBox.Show(Program.main.config.ExecutableName + &quot; not found&quot;, &quot;Cannot find dedicated server executable&quot;);
+            }
 
-			// init unitsync and load basic info
-			unitSyncWrapper = new UnitSyncWrapper();
-			unitSyncWrapper.NotifyModsChanged += unitSyncWrapper_NotifyModsChanged;
-		}
+            // init unitsync and load basic info
+            unitSyncWrapper = new UnitSyncWrapper();
+            unitSyncWrapper.NotifyModsChanged += unitSyncWrapper_NotifyModsChanged;
+        }
 
-		void unitSyncWrapper_NotifyModsChanged(object sender, EventArgs e)
-		{
-			if (NotifyModsChanged != null) NotifyModsChanged(sender, e);
-		}
 
+        public void Dispose() {}
 
-		public void Dispose() {}
+        #endregion
 
-		#endregion
+        #region Public methods
 
-		#region Public methods
+        public void ExitGame()
+        {
+            if (IsRunning) {
+                SayGame(&quot;/kill&quot;);
+                process.WaitForExit(2000);
+                if (!IsRunning) return;
+                process.Kill();
+                ;
+                process.WaitForExit(1000);
+                if (!IsRunning) return;
+                process.Kill();
+            }
+        }
 
-		public void ExitGame()
-		{
-			if (IsRunning) {
-				SayGame(&quot;/kill&quot;);
-			  process.WaitForExit(2000);
-				if (!IsRunning) return;
-				process.Kill();;
-				process.WaitForExit(1000);
-				if (!IsRunning) return;
-				process.Kill();
-			}
-		}
+        public void ForceStart()
+        {
+            if (IsRunning) talker.SendText(&quot;/forcestart&quot;);
+        }
 
-		public void ForceStart()
-		{
-			if (IsRunning) talker.SendText(&quot;/forcestart&quot;);
-		}
+        public bool IsPlayerReady(string name)
+        {
+            return readyPlayers.Contains(name);
+        }
 
 
-		public void Kick(string name)
-		{
-			SayGame(&quot;/kick &quot; + name);
-		}
+        public void Kick(string name)
+        {
+            SayGame(&quot;/kick &quot; + name);
+        }
 
 
-		public void SayGame(string text)
-		{
-			if (IsRunning) talker.SendText(text);
-		}
+        public void SayGame(string text)
+        {
+            if (IsRunning) talker.SendText(text);
+        }
 
-		public void StartGame(Battle battle)
-		{
-			if (!IsRunning) {
-				List&lt;Battle.GrPlayer&gt; players;
-				talker = new Talker();
-				readyPlayers.Clear();
-				talker.SpringEvent += talker_SpringEvent;
-				string configName = Path.Combine(Program.WorkPath, &quot;springie&quot; + Program.main.AutoHost.config.HostingPort + &quot;.txt&quot;).Replace('\\','/');
-				ConfigMaker.Generate(configName, battle, talker.LoopbackPort, out players);
-				talker.SetPlayers(players);
+        public void StartGame(Battle battle)
+        {
+            if (!IsRunning) {
+                List&lt;Battle.GrPlayer&gt; players;
+                talker = new Talker();
+                readyPlayers.Clear();
+                talker.SpringEvent += talker_SpringEvent;
+                string configName = Path.Combine(Program.WorkPath, &quot;springie&quot; + Program.main.AutoHost.config.HostingPort + &quot;.txt&quot;).Replace('\\', '/');
+                ConfigMaker.Generate(configName, battle, talker.LoopbackPort, out players);
+                talker.SetPlayers(players);
 
 
-				process = new Process();
-				process.StartInfo.CreateNoWindow = true;
-				process.StartInfo.Arguments += configName;
-				process.StartInfo.FileName = Program.main.config.ExecutableName;
-				process.StartInfo.WorkingDirectory = Path.GetDirectoryName(Program.main.config.ExecutableName);
-				process.StartInfo.UseShellExecute = false;
-				process.Exited += springProcess_Exited;
-				process.EnableRaisingEvents = true;
-				process.Start();
-				gameStarted = DateTime.Now;
-				Thread.Sleep(1000);
-				if (!Program.IsLinux &amp;&amp; IsRunning) process.PriorityClass = Program.main.config.HostingProcessPriority;
-				if (IsRunning &amp;&amp; SpringStarted != null) SpringStarted(this, EventArgs.Empty);
-			}
-		}
+                process = new Process();
+                process.StartInfo.CreateNoWindow = true;
+                process.StartInfo.Arguments += configName;
+                process.StartInfo.FileName = Program.main.config.ExecutableName;
+                process.StartInfo.WorkingDirectory = Path.GetDirectoryName(Program.main.config.ExecutableName);
+                process.StartInfo.UseShellExecute = false;
+                process.Exited += springProcess_Exited;
+                process.EnableRaisingEvents = true;
+                PlanetWarsMessages = new Dictionary&lt;string, int&gt;();
+                process.Start();
+                gameStarted = DateTime.Now;
+                Thread.Sleep(1000);
+                if (!Program.IsLinux &amp;&amp; IsRunning) process.PriorityClass = Program.main.config.HostingProcessPriority;
+                if (IsRunning &amp;&amp; SpringStarted != null) SpringStarted(this, EventArgs.Empty);
+            }
+        }
 
-		#endregion
+        #endregion
 
-		#region Event Handlers
+        #region Other methods
 
-		private void springProcess_Exited(object sender, EventArgs e)
-		{
-			process = null;
-			talker.Close();
-			talker = null;
-			if (SpringExited != null) SpringExited(this, EventArgs.Empty);
-		}
+        private void HandlePlanetWarsMessages(Talker.SpringEventArgs e)
+        {
+            if (!Program.main.config.PlanetWarsEnabled || Program.main.PlanetWars == null) return;
+            if (e.Param == 125) return;
 
-		private void talker_SpringEvent(object sender, Talker.SpringEventArgs e)
-		{
-			switch (e.EventType) {
-				case Talker.SpringEventType.PLAYER_JOINED:
-			        //Program.main.AutoHost.SayBattle(&quot;dbg joined &quot; + e.PlayerName);
-					if (PlayerJoined != null) PlayerJoined(this, new SpringLogEventArgs(e.PlayerName));
-					break;
+            int count;
+            if (!PlanetWarsMessages.TryGetValue(e.Text, out count)) count = 0;
+            count++;
+            PlanetWarsMessages[e.Text] = count;
+            if (count != 2) return; // only send if count matches 2 exactly
 
-				case Talker.SpringEventType.PLAYER_LEFT:
-					//Program.main.AutoHost.SayBattle(&quot;dbg left &quot; + e.PlayerName);
-                    if (e.Param == 0 &amp;&amp; PlayerDisconnected != null) PlayerDisconnected(this, new SpringLogEventArgs(e.PlayerName));
-					if (PlayerLeft != null) PlayerLeft(this, new SpringLogEventArgs(e.PlayerName));
-					
-					break;
-
-				case Talker.SpringEventType.PLAYER_CHAT:
-                    
-                    const string pwPrefix = &quot;Encoded mission report:&quot;;
-                    if (Program.main.config.PlanetWarsEnabled &amp;&amp; Program.main.PlanetWars != null &amp;&amp; e.Text.StartsWith(pwPrefix))
+            // awards
+            const string awardPrefix = &quot;Encoded mission report:award: &quot;;
+            if (e.Text.StartsWith(awardPrefix))
+            {
+                string substr = e.Text.Substring(awardPrefix.Length);
+                if (!string.IsNullOrEmpty(substr))
+                {
+                    try
                     {
-                        var substr = e.Text.Substring(pwPrefix.Length);
-                        if (!string.IsNullOrEmpty(substr))
-                        {
-                            try
-                            {
-                                Program.main.PlanetWars.SubmitGameEvent(substr, Program.main.Tas.GetBattle().Map.Name);
-                            }
-                            catch (Exception ex)
-                            {
-                                Program.main.AutoHost.SayBattle(&quot;Error sending data:&quot; + ex);
-                            }
-                        }
+                        var parts = substr.Split(new[] { ' ' }, 3);
+                        string name = parts[0];
+                        string awardType = parts[1];
+                        string awardText = parts[2];
+                        Program.main.AutoHost.SayBattle(string.Format(&quot;Award for {0} - {1} - {2}&quot;, name, awardType, awardText));
+                        Program.main.PlanetWars.AddAward(Program.main.PlanetwarsAccount, name, awardType, awardText, Program.main.Tas.GetBattle().Map.Name);
+                        return;
                     }
+                    catch (Exception ex)
+                    {
+                        Program.main.AutoHost.SayBattle(&quot;Error sending data:&quot; + ex);
+                    }
+                }
+            }
 
-					// only public chat
-					if (PlayerSaid != null &amp;&amp; e.Param == 125) PlayerSaid(this, new SpringLogEventArgs(e.PlayerName, e.Text)); 
-					break;
 
-				case Talker.SpringEventType.PLAYER_DEFEATED:
+            // deployment
+            const string pwPrefix = &quot;Encoded mission report:&quot;;
+            if (Program.main.config.PlanetWarsEnabled &amp;&amp; Program.main.PlanetWars != null &amp;&amp; e.Text.StartsWith(pwPrefix)) {
+                string substr = e.Text.Substring(pwPrefix.Length);
+                if (!string.IsNullOrEmpty(substr)) {
+                    try {
+                        Program.main.PlanetWars.SubmitGameEvent(substr, Program.main.Tas.GetBattle().Map.Name);
+                        return;
+                    } catch (Exception ex) {
+                        Program.main.AutoHost.SayBattle(&quot;Error sending data:&quot; + ex);
+                    }
+                }
+            }
+
+        }
+
+        #endregion
+
+        #region Event Handlers
+
+        private void springProcess_Exited(object sender, EventArgs e)
+        {
+            process = null;
+            talker.Close();
+            talker = null;
+            if (SpringExited != null) SpringExited(this, EventArgs.Empty);
+        }
+
+        private void talker_SpringEvent(object sender, Talker.SpringEventArgs e)
+        {
+            switch (e.EventType) {
+                case Talker.SpringEventType.PLAYER_JOINED:
+                    //Program.main.AutoHost.SayBattle(&quot;dbg joined &quot; + e.PlayerName);
+                    if (PlayerJoined != null) PlayerJoined(this, new SpringLogEventArgs(e.PlayerName));
+                    break;
+
+                case Talker.SpringEventType.PLAYER_LEFT:
+                    //Program.main.AutoHost.SayBattle(&quot;dbg left &quot; + e.PlayerName);
+                    if (e.Param == 0 &amp;&amp; PlayerDisconnected != null) PlayerDisconnected(this, new SpringLogEventArgs(e.PlayerName));
+                    if (PlayerLeft != null) PlayerLeft(this, new SpringLogEventArgs(e.PlayerName));
+
+                    break;
+
+                case Talker.SpringEventType.PLAYER_CHAT:
+
+                    HandlePlanetWarsMessages(e);
+
+                    // only public chat
+                    if (PlayerSaid != null &amp;&amp; e.Param == 125) PlayerSaid(this, new SpringLogEventArgs(e.PlayerName, e.Text));
+                    break;
+
+                case Talker.SpringEventType.PLAYER_DEFEATED:
                     //Program.main.AutoHost.SayBattle(&quot;dbg defeated &quot; + e.PlayerName);
-					if (PlayerLost != null) PlayerLost(this, new SpringLogEventArgs(e.PlayerName));
-					break;
+                    if (PlayerLost != null) PlayerLost(this, new SpringLogEventArgs(e.PlayerName));
+                    break;
 
-				case Talker.SpringEventType.SERVER_GAMEOVER:
+                case Talker.SpringEventType.SERVER_GAMEOVER:
                     //Program.main.AutoHost.SayBattle(&quot;dbg gameover &quot; + e.PlayerName);
-					if (GameOver != null) GameOver(this, new SpringLogEventArgs(e.PlayerName));
-					break;
+                    if (GameOver != null) GameOver(this, new SpringLogEventArgs(e.PlayerName));
+                    break;
 
-				case Talker.SpringEventType.PLAYER_READY:
+                case Talker.SpringEventType.PLAYER_READY:
                     //Program.main.AutoHost.SayBattle(&quot;dbg ready &quot; + e.PlayerName);
-					if (e.Param ==1) readyPlayers.Add(e.PlayerName);
-					break;
+                    if (e.Param == 1) readyPlayers.Add(e.PlayerName);
+                    break;
 
-				case Talker.SpringEventType.SERVER_QUIT:
+                case Talker.SpringEventType.SERVER_QUIT:
                     //Program.main.AutoHost.SayBattle(&quot;dbg quit &quot;);
-					//if (GameOver != null) GameOver(this, new SpringLogEventArgs(e.PlayerName));
-					break;
-			}
-		}
+                    //if (GameOver != null) GameOver(this, new SpringLogEventArgs(e.PlayerName));
+                    break;
+            }
+        }
 
-		public bool IsPlayerReady(string name)
-		{
-			return readyPlayers.Contains(name);
-		}
+        private void unitSyncWrapper_NotifyModsChanged(object sender, EventArgs e)
+        {
+            if (NotifyModsChanged != null) NotifyModsChanged(sender, e);
+        }
 
-
-
-		#endregion
-	}
+        #endregion
+    }
 }
\ No newline at end of file

Modified: Lobby/springie/Springie/utils/Stats.cs
===================================================================
--- Lobby/springie/Springie/utils/Stats.cs	2008-11-27 13:54:29 UTC (rev 7101)
+++ Lobby/springie/Springie/utils/Stats.cs	2008-11-28 03:36:12 UTC (rev 7102)
@@ -184,15 +184,16 @@
 					var pw = Program.main.PlanetWars;
 
                     foreach (var p in players.Values) {
-                        Program.main.AutoHost.SayBattle(string.Format(&quot;name: {0}, onvictory:{1}, alivetill: {2}, side:{3}, spec:{4}&quot;, p.Name, p.OnVictoryTeam, p.AliveTillEnd, p.Side, p.Spectator));
+                        Program.main.AutoHost.SayBattle(string.Format(&quot;Player: {0}, victory:{1}, alive till end: {2}, side:{3}, spec:{4}&quot;, p.Name, p.OnVictoryTeam, p.AliveTillEnd, p.Side, p.Spectator));
                     }
 
                     ICollection&lt;RankNotification&gt; notifications;
-				    string response = pw.SendBattleResult(new AuthInfo {Login = Program.main.config.PlanetWarsServerLogin, Password = Program.main.config.PlanetWarsServerPassword}, battle.Map.Name, players.Values, out notifications);
+				    string response = pw.SendBattleResult(Program.main.PlanetwarsAccount, battle.Map.Name, players.Values, out notifications);
 
                     
 					Program.main.AutoHost.SayBattle(response);
-					foreach (var p in players.Values) if (p.Name != tas.UserName) tas.Say(TasClient.SayPlace.User, p.Name, response, false);
+				    var users = tas.GetBattle().Users;
+                    foreach (var p in players.Values) if (p.Name != tas.UserName &amp;&amp; users.Find(x=&gt;x.name == p.Name) == null) tas.Say(TasClient.SayPlace.User, p.Name, response, false);
 
                     foreach (var kvp in notifications) tas.Say(TasClient.SayPlace.User, kvp.Name, kvp.Text, false);
 

Modified: Lobby/springie/libs/PlanetWarsShared.dll
===================================================================
(Binary files differ)


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001870.html">[Taspring-linux-commit] r7101 - in trunk/rts: Game Lua Map/SMF	Rendering/Env Rendering/UnitModels Sim/Path Sim/Projectiles	Sim/Units System lib/gml
</A></li>
	<LI>Next message: <A HREF="001872.html">[Taspring-linux-commit] r7103 - in Lobby/springie:	Springie/autohost Springie/utils libs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1871">[ date ]</a>
              <a href="thread.html#1871">[ thread ]</a>
              <a href="subject.html#1871">[ subject ]</a>
              <a href="author.html#1871">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
