<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r5469 - in trunk/AI/Global/NTai/AI: .	NTai/Agents NTai/Core NTai/Helpers/Units NTai/Tasks	NTai/Units NTai/Units/Behaviours
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-February/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5469%20-%20in%20trunk/AI/Global/NTai/AI%3A%20.%0A%09NTai/Agents%20NTai/Core%20NTai/Helpers/Units%20NTai/Tasks%0A%09NTai/Units%20NTai/Units/Behaviours&In-Reply-To=%3CE1JNaST-0002dj-EZ%40proserver.fnord.lan%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000275.html">
   <LINK REL="Next"  HREF="000277.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r5469 - in trunk/AI/Global/NTai/AI: .	NTai/Agents NTai/Core NTai/Helpers/Units NTai/Tasks	NTai/Units NTai/Units/Behaviours</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5469%20-%20in%20trunk/AI/Global/NTai/AI%3A%20.%0A%09NTai/Agents%20NTai/Core%20NTai/Helpers/Units%20NTai/Tasks%0A%09NTai/Units%20NTai/Units/Behaviours&In-Reply-To=%3CE1JNaST-0002dj-EZ%40proserver.fnord.lan%3E"
       TITLE="[Taspring-linux-commit] r5469 - in trunk/AI/Global/NTai/AI: .	NTai/Agents NTai/Core NTai/Helpers/Units NTai/Tasks	NTai/Units NTai/Units/Behaviours">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Fri Feb  8 22:08:29 CET 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000275.html">[Taspring-linux-commit] r5468 - trunk/rts/Game
</A></li>
        <LI>Next message: <A HREF="000277.html">[Taspring-linux-commit] r5470 - trunk/AI/Global/NTai/AI/NTai/Core
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#276">[ date ]</a>
              <a href="thread.html#276">[ thread ]</a>
              <a href="subject.html#276">[ subject ]</a>
              <a href="author.html#276">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: tnowell
Date: 2008-02-08 22:08:28 +0100 (Fri, 08 Feb 2008)
New Revision: 5469

Added:
   trunk/AI/Global/NTai/AI/NTai/Core/CGlobalProxy.cpp
   trunk/AI/Global/NTai/AI/NTai/Core/CGlobalProxy.h
Modified:
   trunk/AI/Global/NTai/AI/AI.vcproj
   trunk/AI/Global/NTai/AI/NTai/Agents/CManufacturer.h
   trunk/AI/Global/NTai/AI/NTai/Agents/Chaser.cpp
   trunk/AI/Global/NTai/AI/NTai/Core/Global.cpp
   trunk/AI/Global/NTai/AI/NTai/Core/Global.h
   trunk/AI/Global/NTai/AI/NTai/Core/include.h
   trunk/AI/Global/NTai/AI/NTai/Helpers/Units/Actions.cpp
   trunk/AI/Global/NTai/AI/NTai/Tasks/CKeywordConstructionTask.cpp
   trunk/AI/Global/NTai/AI/NTai/Tasks/CLeaveBuildSpotTask.cpp
   trunk/AI/Global/NTai/AI/NTai/Tasks/CUnitConstructionTask.cpp
   trunk/AI/Global/NTai/AI/NTai/Units/Behaviours/AttackBehaviour.cpp
   trunk/AI/Global/NTai/AI/NTai/Units/Behaviours/CDGunBehaviour.cpp
   trunk/AI/Global/NTai/AI/NTai/Units/Behaviours/CRetreatBehaviour.cpp
   trunk/AI/Global/NTai/AI/NTai/Units/Behaviours/CRetreatBehaviour.h
   trunk/AI/Global/NTai/AI/NTai/Units/CUnit.cpp
Log:
- tonnes of comment and white space formatting fixes
- added a companion class for Global called CGlobalProxy. This way work done can be done using the event loop messaging system rather than being done as soon as it arrives, this way it can be done in stages using the message throttling for better load balancing.
- changed more checks to use CMessage::IsType()

Modified: trunk/AI/Global/NTai/AI/AI.vcproj
===================================================================
--- trunk/AI/Global/NTai/AI/AI.vcproj	2008-02-08 19:47:23 UTC (rev 5468)
+++ trunk/AI/Global/NTai/AI/AI.vcproj	2008-02-08 21:08:28 UTC (rev 5469)
@@ -189,6 +189,14 @@
 				&gt;
 			&lt;/File&gt;
 			&lt;File
+				RelativePath=&quot;.\NTai\Core\CGlobalProxy.cpp&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
+				RelativePath=&quot;.\NTai\Core\CGlobalProxy.h&quot;
+				&gt;
+			&lt;/File&gt;
+			&lt;File
 				RelativePath=&quot;.\NTai\Helpers\grid\CGridCell.cpp&quot;
 				&gt;
 			&lt;/File&gt;

Modified: trunk/AI/Global/NTai/AI/NTai/Agents/CManufacturer.h
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Agents/CManufacturer.h	2008-02-08 19:47:23 UTC (rev 5468)
+++ trunk/AI/Global/NTai/AI/NTai/Agents/CManufacturer.h	2008-02-08 21:08:28 UTC (rev 5469)
@@ -7,13 +7,12 @@
 	class CBPlan: public boost::noncopyable{ // This is not used for factories building units.
 	public:
 		CBPlan();
-	//	CBPlan();
 		~CBPlan();
 
 		bool IsValid(){
 			return valid;
 		}
-		//bool HasBuilder(int i);
+
 		void AddBuilder(int i);
 		bool HasBuilders();
 		void RemoveBuilder(int i);
@@ -32,8 +31,6 @@
 	private:
 		bool valid;
 		int bcount;
-		//boost::mutex plan_mutex;
-		//set&lt;int&gt; builders;				// the builder
 
 	};
 
@@ -62,22 +59,21 @@
 		map&lt;string,btype&gt; types;
 		map&lt;btype,string&gt; typenames;
 
-		btype GetTaskType(string s);						// retrieves the associated tasktype
-		string GetTaskName(btype type);						// retrieves the associated taskname
+		// retrieves the associated tasktype
+		btype GetTaskType(string s);
 
-		void RegisterTaskPair(string name, btype type);		// registers this pair so it can be logged and used in the tasklists
+		// retrieves the associated taskname
+		string GetTaskName(btype type);
+
+		// registers this pair so it can be logged and used in the tasklists
+		void RegisterTaskPair(string name, btype type);
+
 		void RegisterTaskTypes();
 
 		bool CanBuild(int uid,const UnitDef* ud, string name);
 
 		deque&lt;CBPlan* &gt;* BPlans;
 
-		//bool WipePlansForBuilder(int unit);
-
-		//int WhatIsUnitBuilding(int builder);
-
-		//bool UnitTargetStartedBuilding(int builder);
-
 		deque&lt;CBPlan* &gt;::iterator OverlappingPlans(float3 pos,const UnitDef* ud);
 
 		uint getplans();

Modified: trunk/AI/Global/NTai/AI/NTai/Agents/Chaser.cpp
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Agents/Chaser.cpp	2008-02-08 19:47:23 UTC (rev 5468)
+++ trunk/AI/Global/NTai/AI/NTai/Agents/Chaser.cpp	2008-02-08 21:08:28 UTC (rev 5469)
@@ -15,24 +15,29 @@
 	void Chaser::InitAI(Global* GLI){
 		G = GLI;
 		NLOG(&quot;Chaser::InitAI&quot;);
+		
+
 		enemynum=0;
-		G-&gt;Get_mod_tdf()-&gt;GetDef(threshold, &quot;5&quot;, &quot;AI\\initial_threat_value&quot;);
-		G-&gt;Get_mod_tdf()-&gt;GetDef(thresh_increase, &quot;1&quot;, &quot;AI\\increase_threshold_value&quot;);
-		G-&gt;Get_mod_tdf()-&gt;GetDef(thresh_percentage_incr, &quot;1&quot;, &quot;AI\\increase_threshold_percentage&quot;);
-		G-&gt;Get_mod_tdf()-&gt;GetDef(max_threshold, &quot;1&quot;, &quot;AI\\maximum_attack_group_size&quot;);
 
-		float3 mapdim= float3((float)G-&gt;cb-&gt;GetMapWidth()*SQUARE_SIZE, 0, (float)G-&gt;cb-&gt;GetMapHeight()*SQUARE_SIZE);
+		TdfParser* t = G-&gt;Get_mod_tdf();
+
+		t-&gt;GetDef(threshold, &quot;5&quot;, &quot;AI\\initial_threat_value&quot;);
+		t-&gt;GetDef(thresh_increase, &quot;1&quot;, &quot;AI\\increase_threshold_value&quot;);
+		t-&gt;GetDef(thresh_percentage_incr, &quot;1&quot;, &quot;AI\\increase_threshold_percentage&quot;);
+		t-&gt;GetDef(max_threshold, &quot;1&quot;, &quot;AI\\maximum_attack_group_size&quot;);
+
+		float3 mapdim = float3((float)G-&gt;cb-&gt;GetMapWidth()*SQUARE_SIZE, 0, (float)G-&gt;cb-&gt;GetMapHeight()*SQUARE_SIZE);
 		Grid.Initialize(mapdim, float3(1024, 0, 1024), true);
 		Grid.ApplyModifierOnUpdate(0.9f, (15 SECONDS));
 		Grid.SetDefaultGridValue(5.0f);
 		Grid.SetMinimumValue(10.0f);
 
-		CTokenizer&lt;CIsComma&gt;::Tokenize(fire_at_will, G-&gt;Get_mod_tdf()-&gt;SGetValueMSG(&quot;AI\\fire_at_will&quot;), CIsComma());
-		CTokenizer&lt;CIsComma&gt;::Tokenize(return_fire, G-&gt;Get_mod_tdf()-&gt;SGetValueMSG(&quot;AI\\return_fire&quot;), CIsComma());
-		CTokenizer&lt;CIsComma&gt;::Tokenize(hold_fire, G-&gt;Get_mod_tdf()-&gt;SGetValueMSG(&quot;AI\\hold_fire&quot;), CIsComma());
-		CTokenizer&lt;CIsComma&gt;::Tokenize(roam, G-&gt;Get_mod_tdf()-&gt;SGetValueMSG(&quot;AI\\roam&quot;), CIsComma());
-		CTokenizer&lt;CIsComma&gt;::Tokenize(maneouvre, G-&gt;Get_mod_tdf()-&gt;SGetValueMSG(&quot;AI\\maneouvre&quot;), CIsComma());
-		CTokenizer&lt;CIsComma&gt;::Tokenize(hold_pos, G-&gt;Get_mod_tdf()-&gt;SGetValueMSG(&quot;AI\\hold_pos&quot;), CIsComma());
+		CTokenizer&lt;CIsComma&gt;::Tokenize(fire_at_will, t-&gt;SGetValueMSG(&quot;AI\\fire_at_will&quot;), CIsComma());
+		CTokenizer&lt;CIsComma&gt;::Tokenize(return_fire, t-&gt;SGetValueMSG(&quot;AI\\return_fire&quot;), CIsComma());
+		CTokenizer&lt;CIsComma&gt;::Tokenize(hold_fire, t-&gt;SGetValueMSG(&quot;AI\\hold_fire&quot;), CIsComma());
+		CTokenizer&lt;CIsComma&gt;::Tokenize(roam, t-&gt;SGetValueMSG(&quot;AI\\roam&quot;), CIsComma());
+		CTokenizer&lt;CIsComma&gt;::Tokenize(maneouvre, t-&gt;SGetValueMSG(&quot;AI\\maneouvre&quot;), CIsComma());
+		CTokenizer&lt;CIsComma&gt;::Tokenize(hold_pos, t-&gt;SGetValueMSG(&quot;AI\\hold_pos&quot;), CIsComma());
 
 	}
 

Added: trunk/AI/Global/NTai/AI/NTai/Core/CGlobalProxy.cpp
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Core/CGlobalProxy.cpp	                        (rev 0)
+++ trunk/AI/Global/NTai/AI/NTai/Core/CGlobalProxy.cpp	2008-02-08 21:08:28 UTC (rev 5469)
@@ -0,0 +1,80 @@
+#include &quot;include.h&quot;
+
+namespace ntai {
+
+	CGlobalProxy::CGlobalProxy(Global* GL){
+		//
+		G = GL;
+	}
+
+	CGlobalProxy::~CGlobalProxy(){
+		//
+	}
+
+
+	// Interface functions
+
+	// initialize the AI
+	bool CGlobalProxy::Init(){
+		//
+		return true;
+	}
+
+	void CGlobalProxy::RecieveMessage(CMessage &amp;message){
+		//
+
+		if(message.IsType(&quot;update&quot;)){
+			//
+			if(message.GetFrame() == (1 SECOND)){
+				NLOG(&quot;STARTUP BANNER IN Global::Update()&quot;);
+
+				if(G-&gt;L.FirstInstance()){
+					
+					string s = string(&quot;:: &quot;) + AI_NAME + string(&quot; by Tom J. Nowell&quot;);
+					
+					G-&gt;cb-&gt;SendTextMsg(s.c_str(), 0);
+					G-&gt;cb-&gt;SendTextMsg(&quot;:: Copyright (C) 2005-2008 AF Tom J. Nowell&quot;, 0);
+					
+					string q = string(&quot; :: &quot;) + G-&gt;Get_mod_tdf()-&gt;SGetValueMSG(&quot;AI\\message&quot;);
+					
+					if(q != string(&quot;&quot;)){
+						G-&gt;cb-&gt;SendTextMsg(q.c_str(), 0);
+					}
+
+					G-&gt;cb-&gt;SendTextMsg(&quot;Please check www.darkstars.co.uk for updates&quot;, 0);
+				}
+
+				int* ax = new int[10000];
+				int anum = G-&gt;cb-&gt;GetFriendlyUnits(ax);
+				
+				G-&gt;ComName = string(&quot;&quot;);
+		        
+				if(anum !=0){
+					for(int a = 0; a&lt;anum; a++){
+						if(G-&gt;cb-&gt;GetUnitTeam(ax[a]) == G-&gt;cb-&gt;GetMyTeam()){
+							const UnitDef* ud = G-&gt;GetUnitDef(ax[a]);
+							if(ud!=0){
+								//
+								G-&gt;ComName = ud-&gt;name;
+								G-&gt;Cached-&gt;comID=ax[a];
+								break;
+							}
+						}
+					}
+				}
+				delete[] ax;
+			}
+
+			G-&gt;OrderRouter-&gt;Update();
+
+			if(message.GetFrame()%(2 MINUTES) == 0){
+				G-&gt;SaveUnitData();
+			}
+
+			G-&gt;Actions-&gt;Update();
+				
+			G-&gt;Ch-&gt;Update();
+		}
+	}
+
+}

Added: trunk/AI/Global/NTai/AI/NTai/Core/CGlobalProxy.h
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Core/CGlobalProxy.h	                        (rev 0)
+++ trunk/AI/Global/NTai/AI/NTai/Core/CGlobalProxy.h	2008-02-08 21:08:28 UTC (rev 5469)
@@ -0,0 +1,18 @@
+namespace ntai {
+
+	// ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
+
+	class CGlobalProxy : public IModule{
+	public:
+		CGlobalProxy(Global* GL);
+		virtual ~CGlobalProxy();
+
+		bool Init();
+
+		void RecieveMessage(CMessage &amp;message);
+
+	private:
+		Global* G;
+	};
+
+}

Modified: trunk/AI/Global/NTai/AI/NTai/Core/Global.cpp
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Core/Global.cpp	2008-02-08 19:47:23 UTC (rev 5468)
+++ trunk/AI/Global/NTai/AI/NTai/Core/Global.cpp	2008-02-08 21:08:28 UTC (rev 5469)
@@ -16,13 +16,11 @@
 	map&lt;string, float&gt; builderefficiency;
 	map&lt;string, int&gt; lastbuilderefficiencyupdate;
 
-	// ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
 
 	TdfParser* Global::Get_mod_tdf(){
 		return info-&gt;mod_tdf;
 	}
 
-	// ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
 
 	void trim(string &amp;str){
 		string::size_type pos = str.find_last_not_of(' ');
@@ -214,14 +212,14 @@
 		END_EXCEPTION_HANDLING(&quot;CMessage message(\&quot;enemydamaged\&quot;); FireEvent(message);&quot;)*/
 	}
 
-	// ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
-
 	void Global::Update(){
 		bool paused = false;
 
 		NLOG(&quot;Global::Update()&quot;);
 		cb-&gt;GetValue(AIVAL_GAME_PAUSED, &amp;paused);
-		if(paused) return;
+		if(paused){
+			return;
+		}
 		START_EXCEPTION_HANDLING
 
 		if(!handlers.empty()){
@@ -256,72 +254,10 @@
 
 		}
 
-		if(cb-&gt;GetCurrentFrame() == (1 SECOND)){
-			NLOG(&quot;STARTUP BANNER IN Global::Update()&quot;);
+		
 
-			if(L.FirstInstance()){
-				string s = string(&quot;:: &quot;) + AI_NAME + string(&quot; by AF&quot;);
-				cb-&gt;SendTextMsg(s.c_str(), 0);
-				cb-&gt;SendTextMsg(&quot;:: Copyright (C) 2006 AF&quot;, 0);
-				string q = string(&quot; :: &quot;) + Get_mod_tdf()-&gt;SGetValueMSG(&quot;AI\\message&quot;);
-				if(q != string(&quot;&quot;)){
-					cb-&gt;SendTextMsg(q.c_str(), 0);
-				}
-				cb-&gt;SendTextMsg(&quot;Please check www.darkstars.co.uk for updates&quot;, 0);
-			}
-
-			int* ax = new int[10000];
-			int anum =cb-&gt;GetFriendlyUnits(ax);
-			
-			ComName = string(&quot;&quot;);
-	        
-			if(anum !=0){
-				for(int a = 0; a&lt;anum; a++){
-					if(cb-&gt;GetUnitTeam(ax[a]) == cb-&gt;GetMyTeam()){
-						const UnitDef* ud = GetUnitDef(ax[a]);
-						if(ud!=0){
-							//
-							ComName = ud-&gt;name;
-							Cached-&gt;comID=ax[a];
-						}
-					}
-				}
-			}
-			delete[] ax;
-		}
-		END_EXCEPTION_HANDLING(&quot;Startup Banner and getting commander name&quot;)
-
 		START_EXCEPTION_HANDLING
-		OrderRouter-&gt;Update();
-		END_EXCEPTION_HANDLING(&quot;OrderRouter-&gt;Update()&quot;)
 
-		//if( EVERY_((2 SECONDS)) &amp;&amp; (Cached-&gt;cheating == true) ){
-		//	float a = cb-&gt;GetEnergyStorage() - cb-&gt;GetEnergy();
-		//	if( a &gt; 50) chcb-&gt;GiveMeEnergy(a);
-		//	a = cb-&gt;GetMetalStorage() - cb-&gt;GetMetal();
-		//	if(a &gt; 50) chcb-&gt;GiveMeMetal(a);
-		//}
-
-		START_EXCEPTION_HANDLING
-		if(EVERY_((2 MINUTES))){
-			//L.print(&quot;saving UnitData&quot;);
-			SaveUnitData();
-			/*if(!SaveUnitData()){
-			 L.print(&quot;UnitData saved&quot;);
-			 }else{
-			 L.print(&quot;UnitData not saved&quot;);
-			 }*/
-		}
-		END_EXCEPTION_HANDLING(&quot;SaveUnitData()&quot;)
-
-		//EXCEPTION_HANDLER(Pl-&gt;Update(),&quot;Pl-&gt;Update()&quot;,NA)
-
-		START_EXCEPTION_HANDLING
-		Actions-&gt;Update();
-		END_EXCEPTION_HANDLING(&quot;Actions-&gt;Update()&quot;)
-
-		START_EXCEPTION_HANDLING
-
 		CMessage message(&quot;update&quot;);
 
 		// a lifetime of 15 frames, so there should never be more than
@@ -333,11 +269,10 @@
 		END_EXCEPTION_HANDLING(&quot;CMessage message(\&quot;update\&quot;); FireEvent(message);&quot;)
 
 		//EXCEPTION_HANDLER(Manufacturer-&gt;Update(),&quot;Manufacturer-&gt;Update()&quot;,NA)
-		Ch-&gt;Update();
+		
 
 	}
 
-	// ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
 
 	void Global::SortSolobuilds(int unit){
 		Cached-&gt;enemies.erase(unit);
@@ -396,7 +331,6 @@
 
 	}
 
-	// ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
 	void Global::EnemyDestroyed(int enemy, int attacker){
 
 		if(ValidUnitID(attacker)){
@@ -932,6 +866,11 @@
 
 		Ch-&gt;InitAI(this);
 		L.print(&quot;Chaser Init'd&quot;);
+
+		gproxy = boost::shared_ptr&lt;IModule&gt;(new CGlobalProxy(this));
+		gproxy-&gt;Init();
+		RegisterMessageHandler(gproxy);
+
 	}
 
 	int Global::GetCurrentFrame(){
@@ -1326,7 +1265,7 @@
 	bool Global::SaveUnitData(){
 		NLOG(&quot;Global::SaveUnitData()&quot;);
 
-		if(L.FirstInstance() == true){
+		if(L.FirstInstance()){
 			ofstream off;
 
 			string filename = info-&gt;datapath;
@@ -1339,9 +1278,13 @@
 			off.open(filename.c_str());
 
 			if(off.is_open() == true){
-				off &lt;&lt; &quot;[AI]&quot; &lt;&lt; endl &lt;&lt; &quot;{&quot; &lt;&lt; endl &lt;&lt; &quot;    // &quot; &lt;&lt; AI_NAME &lt;&lt; &quot; AF :: unit efficiency cache file&quot; &lt;&lt; endl &lt;&lt; endl;
 
-				off &lt;&lt; &quot;    version=XE9.79;&quot; &lt;&lt; endl;
+				off &lt;&lt; &quot;[AI]&quot; &lt;&lt; endl;
+				off &lt;&lt; &quot;{&quot; &lt;&lt; endl;
+				off &lt;&lt; &quot;    // &quot; &lt;&lt; AI_NAME &lt;&lt; &quot; AF :: unit efficiency cache file&quot; &lt;&lt; endl;
+				off &lt;&lt; endl;
+
+				off &lt;&lt; &quot;    version=&quot;&lt;&lt; AI_NAME &lt;&lt;&quot;;&quot; &lt;&lt; endl;
 				off &lt;&lt; &quot;    firstload=&quot; &lt;&lt; firstload &lt;&lt; &quot;;&quot; &lt;&lt; endl;
 				off &lt;&lt; &quot;    modname=&quot; &lt;&lt; G-&gt;cb-&gt;GetModName() &lt;&lt; &quot;;&quot; &lt;&lt; endl;
 				off &lt;&lt; &quot;    iterations=&quot; &lt;&lt; iterations &lt;&lt; &quot;;&quot; &lt;&lt; endl;
@@ -1350,10 +1293,13 @@
 				off &lt;&lt; &quot;    [VALUES]&quot; &lt;&lt; endl &lt;&lt; &quot;    {&quot; &lt;&lt; endl;
 
 				for(map&lt;string, float&gt;::const_iterator i = efficiency.begin(); i != efficiency.end(); ++i){
-					off &lt;&lt; &quot;        &quot;&lt;&lt; i-&gt;first &lt;&lt; &quot;=&quot; &lt;&lt; i-&gt;second &lt;&lt; &quot;;    // &quot; &lt;&lt; unit_names[i-&gt;first] &lt;&lt; &quot; :: &quot;&lt;&lt; unit_descriptions[i-&gt;first]&lt;&lt;endl;
+					off &lt;&lt; &quot;        &quot;&lt;&lt; i-&gt;first &lt;&lt; &quot;=&quot; &lt;&lt; i-&gt;second &lt;&lt; &quot;;&quot;;
+					off &lt;&lt; &quot;// &quot; &lt;&lt; unit_names[i-&gt;first] &lt;&lt; &quot; :: &quot;&lt;&lt; unit_descriptions[i-&gt;first]&lt;&lt;endl;
 				}
+
 				off &lt;&lt; &quot;    }&quot; &lt;&lt; endl;
-				off &lt;&lt; &quot;    [NAMES]&quot; &lt;&lt; endl &lt;&lt; &quot;    {&quot;&lt;&lt; endl;
+				off &lt;&lt; &quot;    [NAMES]&quot; &lt;&lt; endl;
+				off &lt;&lt; &quot;    {&quot;&lt;&lt; endl;
 
 				for(map&lt;string, float&gt;::const_iterator i = efficiency.begin(); i != efficiency.end(); ++i){
 					off &lt;&lt; &quot;        &quot;&lt;&lt; i-&gt;first &lt;&lt; &quot;=&quot; &lt;&lt; unit_names[i-&gt;first] &lt;&lt; &quot;;&quot; &lt;&lt;endl;
@@ -1361,7 +1307,8 @@
 
 				off &lt;&lt; &quot;    }&quot; &lt;&lt; endl;
 
-				off &lt;&lt; &quot;    [DESCRIPTIONS]&quot; &lt;&lt; endl &lt;&lt; &quot;    {&quot;&lt;&lt; endl;
+				off &lt;&lt; &quot;    [DESCRIPTIONS]&quot; &lt;&lt; endl;
+				off &lt;&lt; &quot;    {&quot;&lt;&lt; endl;
 
 				for(map&lt;string, float&gt;::const_iterator i = efficiency.begin(); i != efficiency.end(); ++i){
 					off &lt;&lt; &quot;        &quot;&lt;&lt; i-&gt;first &lt;&lt; &quot;=&quot; &lt;&lt; unit_descriptions[i-&gt;first] &lt;&lt; &quot;;&quot;&lt;&lt;endl;
@@ -1369,31 +1316,41 @@
 
 				off &lt;&lt; &quot;    }&quot; &lt;&lt; endl;
 				off &lt;&lt; &quot;}&quot; &lt;&lt; endl;
+
 				off.close();
 
 				saved = true;
 				return true;
+
 			}else{
 				G-&gt;L.print(&quot;failed to save :&quot; + filename);
 				off.close();
+
 				return false;
 			}
 		}
+
 		return false;
 	}
 
 	float Global::GetTargettingWeight(string unit, string target){
+
 		float tempscore = 0;
 
-		if(info-&gt;hardtarget == false){
+		if(!info-&gt;hardtarget){
+
 			tempscore = GetEfficiency(target);
+
 		}else{
+
 			string fh = unit + &quot;\\target_weights\\&quot; + target;
 			string fg = unit + &quot;\\target_weights\\undefined&quot;;
 
 			float fz = GetEfficiency(target);
 			string tempdef = Get_mod_tdf()-&gt;SGetValueDef(to_string(fz), fg.c_str());
-			tempscore = (float)atof(Get_mod_tdf()-&gt;SGetValueDef(tempdef, fh).c_str()); // load &quot;unitname\\target_weights\\enemyunitname&quot; to retirieve targetting weights
+			
+			// load &quot;unitname\\target_weights\\enemyunitname&quot; to retirieve targetting weights
+			tempscore = (float)atof(Get_mod_tdf()-&gt;SGetValueDef(tempdef, fh).c_str()); 
 		}
 
 		return tempscore;
@@ -1450,7 +1407,7 @@
 	}
 
 	void Global::FireEvent(CMessage &amp;message){
-		if(message.GetType() == string(&quot;&quot;)){
+		if(message.IsType(&quot;&quot;)){
 			return;
 		}
 
@@ -1475,8 +1432,6 @@
 
 }
 
-// ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
-
 /** Random note
 unitdef-&gt;type can be one of the following:
  MetalExtractor

Modified: trunk/AI/Global/NTai/AI/NTai/Core/Global.h
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Core/Global.h	2008-02-08 19:47:23 UTC (rev 5468)
+++ trunk/AI/Global/NTai/AI/NTai/Core/Global.h	2008-02-08 21:08:28 UTC (rev 5469)
@@ -1,9 +1,8 @@
-// ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
+// ||||||||||||||||||||||||||||||||||||||||||||||||
 // Global class implementation.
 
+#include &quot;CGlobalProxy.h&quot;
 
-// ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
-//using namespace std;
 namespace ntai {
 
 	void trim(string &amp;str);
@@ -11,91 +10,262 @@
 	bool ValidUnitID(int id);
 
 
-	// ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
-
 	class Global{
 	public:
 		//destructor/constructor
 		virtual ~Global(); // destructor
 		Global(IGlobalAICallback* callback); // constructor
 
-		CMetalHandler* M; // mex positioning
-		Log L; // Logging class
+		/* 
+		 * A class that implements what this class implements
+		 * using events so that theyre correctly throttle
+		 */
+		boost::shared_ptr&lt;IModule&gt; gproxy;
 
-		Planning* Pl; // Deals with planning things, (only feasible() is actually used)
-		Global* G; // pointer to this class so that macros work
+		/*
+		 * mex positioning
+		 */
+		CMetalHandler* M; 
 
+		/*
+		 * Logging class
+		 */
+		Log L; 
+
+		/*
+		 * Deals with planning things, (only feasible() is
+		 * actually used)
+		 */
+		Planning* Pl;
+
+		/*
+		 * pointer to this class so that macros work
+		 */
+		Global* G;
+
 		IAICheats* chcb;
-		IAICallback* cb;// engine callback interface
-		IGlobalAICallback* gcb;// global AI engine callback interface
 
-		Chaser* Ch;// Chaser Agent, deals with attacking and things such as kamikaze units/dgunning/stockpiling missiles/several attack unit behaviours
+		/*
+		 * engine callback interface
+		 */
+		IAICallback* cb;
+
+		/*
+		 * global AI engine callback interface
+		 */
+		IGlobalAICallback* gcb;
+
+		/*
+		 * Chaser Agent, deals with attacking and things such
+		 * as kamikaze units/dgunning/stockpiling missiles/several
+		 * attack unit behaviours
+		 */
+		Chaser* Ch;
+
 		CUnitDefLoader* UnitDefLoader;
 
-		boost::shared_ptr&lt;CManufacturer&gt; Manufacturer; // Construction helper
-		boost::shared_ptr&lt;CBuildingPlacer&gt; BuildingPlacer; // Building placement algorithm
-		CEconomy* Economy; // Construction rules (AAI/OTAI/JCAI style building selection)
-		COrderRouter* OrderRouter; // Handles the caching of orders sent to the engine, aswell as a few other things like delayed orders etc...
+		/*
+		 * Construction helper
+		 */
+		boost::shared_ptr&lt;CManufacturer&gt; Manufacturer;
+
+		/*
+		 * Building placement algorithm
+		 */
+		boost::shared_ptr&lt;CBuildingPlacer&gt; BuildingPlacer;
+
+		/*
+		 * Construction rules (AAI/OTAI/JCAI style building selection)
+		 */
+		CEconomy* Economy;
+
+		/* 
+		 * Handles the caching of orders sent to the engine, aswell
+		 * as a few other things like delayed orders etc...
+		 */
+		COrderRouter* OrderRouter;
 		
 		CMap* Map;
+
 		CActions* Actions;
 		
-		CCached* Cached; // cached data or other data used across the AI at runtime
-		CConfigData* info; // stuff loaded from configs that ideally should not change
+		/* 
+		 * Cached data or other data used across the AI at runtime
+		 */
+		CCached* Cached;
 
-		CDTHandler* DTHandler; // handles dragon teeth rings
+		/*
+		 * stuff loaded from configs that ideally should not change
+
+		 */
+		CConfigData* info;
+
+		/*
+		 * handles dragon teeth rings
+		 */
+		CDTHandler* DTHandler;
+		
 		CRadarHandler* RadarHandler;
-		//CTaskFactory* TaskFactory;
 
 
-		std::map&lt;std::string,std::string&gt; unit_names; //unitname -&gt; human name
-		std::map&lt;std::string,std::string&gt; unit_descriptions; //unitname -&gt; human name
+		/*
+		 * unitname -&gt; human name
+		 */
+		std::map&lt;std::string,std::string&gt; unit_names;
 
+		/*
+		 * unitname -&gt; human name
+		 */
+		std::map&lt;std::string,std::string&gt; unit_descriptions;
 
+
 		float max_energy_use;
 
 
 		std::set&lt;int&gt; idlenextframe;
+
+
 		// Interface functions
-		void InitAI(IAICallback* callback, int team); // initialize the AI
-		void UnitCreated(int unit); // a unit has been created, but this is currently not used.....
-		void UnitFinished(int unit); // a unit has been finished (finished being built)
-		void UnitDestroyed(int unit, int attacker); // a unit has been destroyed
-		void EnemyEnterLOS(int enemy); // an enemy has entered LOS
-		void EnemyLeaveLOS(int enemy); // An enemy has left LOS
-		void EnemyEnterRadar(int enemy); // an enemy has entered radar
-		void EnemyLeaveRadar(int enemy); // an enemy has left radar
+
+		/*
+		 * initialize the AI
+		 */
+		void InitAI(IAICallback* callback, int team);
+
+		/*
+		 * a unit has been created, but this is currently not used.....
+		 */
+		void UnitCreated(int unit);
+
+		/*
+		 * a unit has been finished (finished being built)
+		 */
+		void UnitFinished(int unit);
+
+		/*
+		 * a unit has been destroyed
+		 */
+		void UnitDestroyed(int unit, int attacker);
+
+		/*
+		 * an enemy has entered LOS
+		 */
+		void EnemyEnterLOS(int enemy);
+
+		/*
+		 * An enemy has left LOS
+		 */
+		void EnemyLeaveLOS(int enemy);
+
+		/*
+		 * an enemy has entered radar
+		 */
+		void EnemyEnterRadar(int enemy);
+
+		/*
+		 * an enemy has left radar
+		 */
+		void EnemyLeaveRadar(int enemy);
+
+		/*
+		 * 
+		 */
 		void EnemyDamaged(int damaged,int attacker,float damage,float3 dir);
-		void EnemyDestroyed(int enemy,int attacker); // an enemy has been destroyed
-		void UnitIdle(int unit); // a unit is now idle
-		void GotChatMsg(const char* msg, int player); // received a console message
-		void UnitDamaged(int damaged, int attacker, float damage,float3 dir); // a unit has been damaged
-		void UnitMoveFailed(int unit); // a unit has failed to mvoe to its given location
-		void Update();// called every frame (usually 30 frames per second)
+
+		/*
+		 * an enemy has been destroyed
+		 */
+		void EnemyDestroyed(int enemy,int attacker);
+
+		/*
+		 * a unit is now idle
+		 */
+		void UnitIdle(int unit);
+
+		/*
+		 * received a console message
+		 */
+		void GotChatMsg(const char* msg, int player);
+
+		/*
+		 * a unit has been damaged
+		 */
+		void UnitDamaged(int damaged, int attacker, float damage,float3 dir);
+
+		/*
+		 * a unit has failed to move to its given location
+		 */
+		void UnitMoveFailed(int unit);
+
+		/*
+		 * called every game frame (usually 30 frames per second)
+		 */
+		void Update();// 
+
 		void SortSolobuilds(int unit);
 
 		std::string ComName;
-		void Crash();// Used to crash NTAI when the user types the &quot;.crash&quot; command
 
+		/*
+		 * Used to crash NTAI when the user types the &quot;.crash&quot; command
+		 */
+		void Crash();
+
 		bool InLOS(float3 pos);
 
 		int GetEnemyUnits(int* units, const float3 &amp;pos, float radius);
+
 		int GetEnemyUnits(int* units);
+
 		int GetEnemyUnitsInRadarAndLos(int* units);
-		std::set&lt;int&gt; LOSGetEnemy(){// returns enemies in LOS (faster than the callback function)
+
+		/*
+		 * returns enemies in LOS (faster than the callback function)
+		 */
+		std::set&lt;int&gt; LOSGetEnemy(){
 			return Cached-&gt;enemies;
 		}
-		bool ReadFile(string filename, string* buffer); // reads a file in from the given path and shoves it in the buffer string provided
-		TdfParser* Get_mod_tdf();// returns a TdfParser object loaded with the contents of mod.tdf
+		
+		/*
+		 * reads a file in from the given path and shoves it in the
+		 * buffer string provided
+		 */
+		bool ReadFile(string filename, string* buffer); // 
+		
+		/*
+		 * returns a TdfParser object loaded with the contents of
+		 * mod.tdf
+		 */
+		TdfParser* Get_mod_tdf();
 
 		//learning stuff
+		
 		void SetEfficiency(std::string s, float e);
-		float GetEfficiency(std::string s, float def_value=500.0f); // returns the efficiency of the unit with name s.
-		float GetEfficiency(std::string s,std::set&lt;std::string&gt;&amp; doneconstructors,int techlevel=1); // returns the efficiency of the unit with name s, but not including those in the vector constructors if it's a builder to prevent recursive loops
+		
+		/*
+		 * returns the efficiency of the unit with name s.
+		 */
+		float GetEfficiency(std::string s, float def_value=500.0f);
+		
+		/*
+		 * returns the efficiency of the unit with name s,
+		 * but not including those in the vector constructors
+		 * if it's a builder to prevent recursive loops.
+		 */
+		float GetEfficiency(std::string s,std::set&lt;std::string&gt;&amp; doneconstructors,int techlevel=1);
+		
 		float GetTargettingWeight(std::string unit, std::string target);
-		bool LoadUnitData(); // loads unit efficiency data from the learning file
-		bool SaveUnitData(); // saves unit efficiency data back to file
 
+		/*
+		 * loads unit efficiency data from the learning file
+		 */
+		bool LoadUnitData();
+		
+		/*
+		 * saves unit efficiency data back to file
+		 */
+		bool SaveUnitData();
+
 		int GetCurrentFrame();
 		const UnitDef* GetEnemyDef(int enemy);
 
@@ -110,7 +280,10 @@
 			}*/
 		}
 
-		float3 GetUnitPos(int unitid,int enemy=0);// 1 = true, 2 = false, 0 = find out for us/wedunno
+		/*
+		 * 1 = true, 2 = false, 0 = find out for us/dunno
+		 */
+		float3 GetUnitPos(int unitid,int enemy=0);
 
 		MTRand_int32 mrand;
 
@@ -131,4 +304,3 @@
 	};
 
 }
-// ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||

Modified: trunk/AI/Global/NTai/AI/NTai/Core/include.h
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Core/include.h	2008-02-08 19:47:23 UTC (rev 5468)
+++ trunk/AI/Global/NTai/AI/NTai/Core/include.h	2008-02-08 21:08:28 UTC (rev 5469)
@@ -117,8 +117,9 @@
 
 // Global classes
 
+
 #include &quot;Global.h&quot;											// (the root object representing the AI itself)
 
 // The name NTAI gives to the spring engine.
-const char AI_NAME[]= {&quot;NTai XE9.79+&quot;};
+const char AI_NAME[]= {&quot;NTai XE9.8+&quot;};
 

Modified: trunk/AI/Global/NTai/AI/NTai/Helpers/Units/Actions.cpp
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Helpers/Units/Actions.cpp	2008-02-08 19:47:23 UTC (rev 5468)
+++ trunk/AI/Global/NTai/AI/NTai/Helpers/Units/Actions.cpp	2008-02-08 21:08:28 UTC (rev 5469)
@@ -381,19 +381,25 @@
         delete [] en;
         return false;
     }
+
 }
 
 void CActions::ScheduleIdle(int unit){
     NLOG(&quot;CActions::ScheduleIdle&quot;);
+
     if(ValidUnitID(unit)){
+
         TCommand tc(unit, &quot;schedule idle unit&quot;);
         tc.created = G-&gt;cb-&gt;GetCurrentFrame();
         tc.ID(CMD_IDLE);
+
         if(G-&gt;OrderRouter-&gt;GiveOrder(tc, false)== false){
             G-&gt;L.print(&quot;GiveOrder on scedule idle failed!!&quot;);
         }
     }
+
 }
+
 bool CActions::DGun(int uid, int enemy){
     NLOG(&quot;CActions::DGun&quot;);
 
@@ -403,30 +409,39 @@
     tc.c.timeOut = 3 SECONDS+(G-&gt;cb-&gt;GetCurrentFrame()%300) + G-&gt;cb-&gt;GetCurrentFrame(); // dont let this command get in the way of the commanders taskqueue with a never ending vendetta that can never be fulfilled
 
     tc.created = G-&gt;cb-&gt;GetCurrentFrame();
+
     if(G-&gt;OrderRouter-&gt;GiveOrder(tc, true)==false){
 		// GiveOrder returned an error
         return false; 
+
     }else{
         // Command successful, This unit is now dgunning
         return true;
+
     }
+
 }
+
 bool CActions::Reclaim(int uid, int enemy){
     NLOG(&quot;CActions::Reclaim&quot;);
+
     TCommand tc(uid, &quot;cmd_recl CActions::Reclaim&quot;);
     tc.ID(CMD_RECLAIM);
     tc.Push(enemy);
     tc.created = G-&gt;cb-&gt;GetCurrentFrame();
+
     return G-&gt;OrderRouter-&gt;GiveOrder(tc, true);
 }
 
 bool CActions::AreaReclaim(int uid, float3 pos, int radius){
     NLOG(&quot;CActions::AreaReclaim&quot;);
+
     TCommand tc(uid, &quot;cmd_recl CActions::AreaReclaim&quot;);
     tc.ID(CMD_RECLAIM);
     tc.PushFloat3(pos);
     tc.Push(radius);
     tc.created = G-&gt;cb-&gt;GetCurrentFrame();
+
     return G-&gt;OrderRouter-&gt;GiveOrder(tc, true);
 }
 
@@ -435,7 +450,7 @@
 	
 	CUnitTypeData* utd = G-&gt;UnitDefLoader-&gt;GetUnitTypeDataByUnitId(uid);
     
-	if(utd == 0 ){
+	if(utd == 0){
         G-&gt;L.print(&quot;Dgunning failed, utd == 0&quot;);
         return false;
     }
@@ -445,7 +460,8 @@
     }
 
     float3 compos = G-&gt;GetUnitPos(uid);
-    if(G-&gt;Map-&gt;CheckFloat3(compos)==false){
+
+    if(!G-&gt;Map-&gt;CheckFloat3(compos)){
         return false;
     }
     
@@ -454,6 +470,7 @@
     int e = G-&gt;GetEnemyUnits(en, compos, G-&gt;cb-&gt;GetUnitMaxRange(uid)*1.3f); // get all enemy units within weapons range atm
     
 	if(e&gt;0){
+
         for(int i = 0; i &lt; e; i++){
             
 			if(ValidUnitID(en[i])==false){

Modified: trunk/AI/Global/NTai/AI/NTai/Tasks/CKeywordConstructionTask.cpp
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Tasks/CKeywordConstructionTask.cpp	2008-02-08 19:47:23 UTC (rev 5468)
+++ trunk/AI/Global/NTai/AI/NTai/Tasks/CKeywordConstructionTask.cpp	2008-02-08 21:08:28 UTC (rev 5469)
@@ -14,9 +14,12 @@
 
 void CKeywordConstructionTask::RecieveMessage(CMessage &amp;message){
 	NLOG(&quot;CKeywordConstructionTask::RecieveMessage&quot;);
-	if (!valid) return;
+	
+	if (!valid){
+		return;
+	}
 
-	if(message.GetType() == string(&quot;unitidle&quot;)){
+	if(message.IsType(&quot;unitidle&quot;)){
 		if(message.GetParameter(0) == unit){
 			if((type == B_GUARDIAN)
 				||(type == B_GUARDIAN_MOBILES)
@@ -27,14 +30,14 @@
 				return;
 			}
 		}
-	}else if(message.GetType() == string(&quot;type?&quot;)){
+	}else if(message.IsType(&quot;type?&quot;)){
 		message.SetType(&quot; keywordtask: &quot;+G-&gt;Manufacturer-&gt;GetTaskName(this-&gt;type));
-	}else	if(message.GetType() == string(&quot;unitdestroyed&quot;)){
+	}else if(message.IsType(&quot;unitdestroyed&quot;)){
 		if(message.GetParameter(0) == unit){
 			End();
 			return;
 		}
-	}else	if(message.GetType() == string(&quot;buildposition&quot;)){
+	}else if(message.IsType(&quot;buildposition&quot;)){
 		// continue construction
 		//
 

Modified: trunk/AI/Global/NTai/AI/NTai/Tasks/CLeaveBuildSpotTask.cpp
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Tasks/CLeaveBuildSpotTask.cpp	2008-02-08 19:47:23 UTC (rev 5468)
+++ trunk/AI/Global/NTai/AI/NTai/Tasks/CLeaveBuildSpotTask.cpp	2008-02-08 21:08:28 UTC (rev 5469)
@@ -17,13 +17,13 @@
 			return;
 		}
 
-		if(message.GetType() == string(&quot;unitidle&quot;)){
+		if(message.IsType(&quot;unitidle&quot;)){
 			if(message.GetParameter(0) == unit){
 				End();
 				//CMessage message2(string(&quot;taskfinished&quot;));
 				//FireEventListener(message2);
 			}
-		}else if(message.GetType() == string(&quot;type?&quot;)){
+		}else if(message.IsType(&quot;type?&quot;)){
 			message.SetType(&quot; leave buildspot task&quot;);
 		}
 	}

Modified: trunk/AI/Global/NTai/AI/NTai/Tasks/CUnitConstructionTask.cpp
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Tasks/CUnitConstructionTask.cpp	2008-02-08 19:47:23 UTC (rev 5468)
+++ trunk/AI/Global/NTai/AI/NTai/Tasks/CUnitConstructionTask.cpp	2008-02-08 21:08:28 UTC (rev 5469)
@@ -31,24 +31,30 @@
 	}
 
 	NLOG(&quot;CUnitConstructionTask::RecieveMessage&quot;);
-	if(message.GetType() == string(&quot;unitidle&quot;)){
+
+	if(message.IsType(&quot;unitidle&quot;)){
 		if(message.GetParameter(0) == unit){
 			End();
 			return;
 		}
-	} else if(message.GetType() == string(&quot;unitdestroyed&quot;)){
+
+	} else if(message.IsType(&quot;unitdestroyed&quot;)){
 		if(message.GetParameter(0) == unit){
 			End();
 			return;
 		}
-	}else if(message.GetType() == string(&quot;type?&quot;)){
+
+	}else if(message.IsType(&quot;type?&quot;)){
 		message.SetType(&quot; build:&quot;+building-&gt;GetUnitDef()-&gt;name);
-	}else if(message.GetType() == string(&quot;buildposition&quot;)){
+	}else if(message.IsType(&quot;buildposition&quot;)){
 		// continue construction
 		//
+
 		TCommand tc(unit,&quot;CBuild&quot;);
 		tc.ID(-building-&gt;GetUnitDef()-&gt;id);
+
 		float3 pos = message.GetFloat3();
+		
 		if(!building-&gt;IsMobile()){
 			if(pos==UpVector){
 				G-&gt;L.print(&quot;BuildPlacement returned UpVector or some other nasty position, a build location wasn't found!&quot;);

Modified: trunk/AI/Global/NTai/AI/NTai/Units/Behaviours/AttackBehaviour.cpp
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Units/Behaviours/AttackBehaviour.cpp	2008-02-08 19:47:23 UTC (rev 5468)
+++ trunk/AI/Global/NTai/AI/NTai/Units/Behaviours/AttackBehaviour.cpp	2008-02-08 21:08:28 UTC (rev 5469)
@@ -1,7 +1,6 @@
 #include &quot;../../Core/include.h&quot;
 
 CAttackBehaviour::CAttackBehaviour(Global* GL, int uid){
-	//
 	G = GL;
 	engaged = false;
 	unit = G-&gt;GetUnit(uid);
@@ -17,25 +16,30 @@
 }
 
 void CAttackBehaviour::RecieveMessage(CMessage &amp;message){
-	if(message.GetType() == string(&quot;update&quot;)){
+
+	if(message.IsType(&quot;update&quot;)){
+		
 		if(engaged){
 			return;
 		}
-		if(EVERY_(120 FRAMES)){
+
+		if(message.GetFrame()%(120 FRAMES) == 0){
 			
 			float3 pos = G-&gt;GetUnitPos(uid);
-			if(G-&gt;Map-&gt;CheckFloat3(pos)==false){
+
+			if(!G-&gt;Map-&gt;CheckFloat3(pos)){
 				return;
 			}
 
 			engaged = G-&gt;Actions-&gt;AttackNear(uid, 3.5f);
+
 		}
-	}else if(message.GetType() == string(&quot;unitdestroyed&quot;)){
-		if(message.GetParameter(0)== uid){
+	}else if(message.IsType(&quot;unitdestroyed&quot;)){
+		if(message.GetParameter(0) == uid){
 			End();
 		}
-	}else if(message.GetType() == string(&quot;unitidle&quot;)){
-		if(message.GetParameter(0)== uid){
+	}else if(message.IsType(&quot;unitidle&quot;)){
+		if(message.GetParameter(0) == uid){
 			engaged=false;
 		}
 	}

Modified: trunk/AI/Global/NTai/AI/NTai/Units/Behaviours/CDGunBehaviour.cpp
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Units/Behaviours/CDGunBehaviour.cpp	2008-02-08 19:47:23 UTC (rev 5468)
+++ trunk/AI/Global/NTai/AI/NTai/Units/Behaviours/CDGunBehaviour.cpp	2008-02-08 21:08:28 UTC (rev 5469)
@@ -17,18 +17,18 @@
 }
 
 void CDGunBehaviour::RecieveMessage(CMessage &amp;message){
-	if(message.GetType() == string(&quot;update&quot;)){
+	if(message.IsType(&quot;update&quot;)){
 		if(message.GetFrame() % (64) == 0){
 			if(!active){
 				active = G-&gt;Actions-&gt;DGunNearby(uid);
 			}
 		}
-	}else if(message.GetType() == string(&quot;unitdestroyed&quot;)){
+	}else if(message.IsType(&quot;unitdestroyed&quot;)){
 		if(message.GetParameter(0)== uid){
 			End();
 			return;
 		}
-	}else if(message.GetType() == string(&quot;unitidle&quot;)){
+	}else if(message.IsType(&quot;unitidle&quot;)){
 		if(message.GetParameter(0)== uid){
 			active=false;
 		}

Modified: trunk/AI/Global/NTai/AI/NTai/Units/Behaviours/CRetreatBehaviour.cpp
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Units/Behaviours/CRetreatBehaviour.cpp	2008-02-08 19:47:23 UTC (rev 5468)
+++ trunk/AI/Global/NTai/AI/NTai/Units/Behaviours/CRetreatBehaviour.cpp	2008-02-08 21:08:28 UTC (rev 5469)
@@ -17,17 +17,20 @@
 }
 
 void CRetreatBehaviour::RecieveMessage(CMessage &amp;message){
-	if(message.GetType() == string(&quot;unitdamaged&quot;)){
+
+	if(message.IsType(&quot;unitdamaged&quot;)){
 		if(message.GetParameter(0) == uid){
 			damage += message.GetParameter(2);
 		}
-	}else if(message.GetType() == string(&quot;update&quot;)){
-		if(G-&gt;GetCurrentFrame() % (64) == 0){
+
+	}else if(message.IsType(&quot;update&quot;)){
+		if(message.GetFrame() % (64) == 0){
 			float d = damage;
 			damage = 0;
 
 			if(!active){
 				float3 dpos = G-&gt;GetUnitPos(uid);
+
 				if(G-&gt;Map-&gt;CheckFloat3(dpos) == false){
 					return;
 				}
@@ -50,14 +53,16 @@
 				}
 			}
 		}
-	}else if(message.GetType() == string(&quot;unitdestroyed&quot;)){
+	}else if(message.IsType(&quot;unitdestroyed&quot;)){
 		if(message.GetParameter(0)== uid){
 			End();
 			return;
 		}
-	}else if(message.GetType() == string(&quot;unitidle&quot;)){
+
+	}else if(message.IsType(&quot;unitidle&quot;)){
 		if(message.GetParameter(0)== uid){
 			active=false;
 		}
 	}
+
 }

Modified: trunk/AI/Global/NTai/AI/NTai/Units/Behaviours/CRetreatBehaviour.h
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Units/Behaviours/CRetreatBehaviour.h	2008-02-08 19:47:23 UTC (rev 5468)
+++ trunk/AI/Global/NTai/AI/NTai/Units/Behaviours/CRetreatBehaviour.h	2008-02-08 21:08:28 UTC (rev 5469)
@@ -1,3 +1,4 @@
+
 namespace ntai {
 	class CRetreatBehaviour : public IBehaviour{
 	public:

Modified: trunk/AI/Global/NTai/AI/NTai/Units/CUnit.cpp
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Units/CUnit.cpp	2008-02-08 19:47:23 UTC (rev 5468)
+++ trunk/AI/Global/NTai/AI/NTai/Units/CUnit.cpp	2008-02-08 21:08:28 UTC (rev 5469)
@@ -61,8 +61,11 @@
 		if(!IsValid()){
 			return;
 		}
-		if(message.GetType() == string(&quot;update&quot;)){
-			if(under_construction) return;
+		if(message.IsType(&quot;update&quot;)){
+			if(under_construction){
+				return;
+			}
+
 			if(EVERY_((GetAge()%16+17))){
 				if(!tasks.empty()){
 					if(tasks.front()-&gt;IsValid()==false){
@@ -76,41 +79,40 @@
 					}
 				}
 			}
-			/*if(EVERY_(32)){
-				float3 p = G-&gt;GetUnitPos(uid);
-				G-&gt;cb-&gt;CreateLineFigure(p,p+float3(30,40,30),5,0,32,0);
-				float3 p2 = G-&gt;cb-&gt;GetMousePos();
-				if(p2.distance2D(p)&lt;30){
-					CMessage m(&quot;type?&quot;);
-					tasks.front()-&gt;RecieveMessage(m);
-					G-&gt;cb-&gt;SendTextMsg(m.GetType().c_str(),1);
-				}
-			}*/
-		}else if(message.GetType() == string(&quot;&quot;)){
+
+		}else if(message.IsType(&quot;&quot;)){
 			return;
-		}else if(message.GetType() == string(&quot;unitfinished&quot;)){
+		}else if(message.IsType(&quot;unitfinished&quot;)){
 			if(message.GetParameter(0) == this-&gt;uid){
 				under_construction = false;
 				LoadBehaviours();
 			}
-		}else if(message.GetType() == string(&quot;unitdestroyed&quot;)){
+		}else if(message.IsType(&quot;unitdestroyed&quot;)){
 			if(message.GetParameter(0) == uid){
+
 				if(!utd-&gt;IsMobile()){
 					G-&gt;BuildingPlacer-&gt;UnBlock(G-&gt;GetUnitPos(uid),utd);
 				}
+
 				if(!tasks.empty()){
 					tasks.erase(tasks.begin(),tasks.end());
 					tasks.clear();
 				}
+
 				if(!behaviours.empty()){
 					behaviours.erase(behaviours.begin(),behaviours.end());
 					behaviours.clear();
 				}
+
 				this-&gt;End();
 				return;
 			}
 		}
-		if(under_construction) return;
+
+		if(under_construction){
+			return;
+		}
+
 		if(!nolist){
 			if(tasks.empty()){
 				if(LoadTaskList()){
@@ -118,7 +120,7 @@
 					t-&gt;Init();
 					G-&gt;RegisterMessageHandler(t);
 				}
-				//executenext = !tasks.empty();
+
 			}
 		}
 	}
@@ -135,12 +137,12 @@
 
 	bool CUnit::operator==(int unit){
 		NLOG(&quot;CUnit::operator==&quot;);
-		if(valid == false) return false;
-		if(unit == uid){
-			return true;
-		}else{
+
+		if(valid == false){
 			return false;
 		}
+
+		return (unit == uid);
 	}
 
 	int CUnit::GetID(){
@@ -150,12 +152,9 @@
 
 	bool CUnit::AddTask(boost::shared_ptr&lt;IModule&gt; &amp;t){
 		NLOG(&quot;CBuilder::AddTask&quot;);
-		//if(t-&gt;IsValid()){
-			//t-&gt;AddListener(me);
-			tasks.push_back(t);
-			return true;
-		//}
-		//return false;
+		
+		tasks.push_back(t);
+		return true;
 	}
 
 	bool CUnit::LoadTaskList(){
@@ -175,7 +174,7 @@
 		string u = utd-&gt;GetName();
 		if(sl != string(&quot;&quot;)){
 			CTokenizer&lt;CIsComma&gt;::Tokenize(vl, sl, CIsComma());
-			//vl = bds::set_cont(vl,sl.c_str());
+
 			if(vl.empty() == false){
 				int randnum = G-&gt;mrand()%vl.size();
 				u = vl.at(min(randnum,max(int(vl.size()-1),1)));
@@ -196,7 +195,6 @@
 		vector&lt;string&gt; v;
 
 		CTokenizer&lt;CIsComma&gt;::Tokenize(v, s, CIsComma());
-		//v = bds::set_cont(v,s.c_str());
 
 		if(v.empty() == false){
 			G-&gt;L.print(&quot;loading contents of  tasklist :: &quot; + u + &quot; :: filling tasklist with #&quot; + to_string(v.size()) + &quot; items&quot;);
@@ -221,10 +219,14 @@
 					}
 					polate = !polate;
 				}
+
 				string q = *vi;
+
 				trim(q);
 				tolowercase(q);
+
 				CUnitTypeData* b = G-&gt;UnitDefLoader-&gt;GetUnitTypeDataByName(q);
+
 				if(b != 0){
 					boost::shared_ptr&lt;IModule&gt; t(new CUnitConstructionTask(G,uid,utd,b));
 					AddTask(t);
@@ -258,6 +260,7 @@
 					AddTask(t);
 				} else{
 					btype x = G-&gt;Manufacturer-&gt;GetTaskType(q);
+
 					if( x != B_NA){
 						boost::shared_ptr&lt;IModule&gt; t(new CKeywordConstructionTask(G,this-&gt;uid,x));
 						AddTask(t);
@@ -267,6 +270,7 @@
 				}
 
 			}
+
 			if(utd-&gt;GetUnitDef()-&gt;isCommander){
 				G-&gt;Map-&gt;basepos = G-&gt;GetUnitPos(GetID());
 			}


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000275.html">[Taspring-linux-commit] r5468 - trunk/rts/Game
</A></li>
	<LI>Next message: <A HREF="000277.html">[Taspring-linux-commit] r5470 - trunk/AI/Global/NTai/AI/NTai/Core
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#276">[ date ]</a>
              <a href="thread.html#276">[ thread ]</a>
              <a href="subject.html#276">[ subject ]</a>
              <a href="author.html#276">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
