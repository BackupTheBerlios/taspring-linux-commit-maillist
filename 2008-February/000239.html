<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r5432 - in trunk: Documentation	tools/ArchiveMover tools/DemoDumper
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-February/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5432%20-%20in%20trunk%3A%20Documentation%0A%09tools/ArchiveMover%20tools/DemoDumper&In-Reply-To=%3CE1JKjbN-0002Ly-4A%40proserver.fnord.lan%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000238.html">
   <LINK REL="Next"  HREF="000240.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r5432 - in trunk: Documentation	tools/ArchiveMover tools/DemoDumper</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5432%20-%20in%20trunk%3A%20Documentation%0A%09tools/ArchiveMover%20tools/DemoDumper&In-Reply-To=%3CE1JKjbN-0002Ly-4A%40proserver.fnord.lan%3E"
       TITLE="[Taspring-linux-commit] r5432 - in trunk: Documentation	tools/ArchiveMover tools/DemoDumper">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Fri Feb  1 01:17:53 CET 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000238.html">[Taspring-linux-commit] r5431 - trunk/Lobby/TASClient
</A></li>
        <LI>Next message: <A HREF="000240.html">[Taspring-linux-commit] r5433 - trunk
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#239">[ date ]</a>
              <a href="thread.html#239">[ thread ]</a>
              <a href="subject.html#239">[ subject ]</a>
              <a href="author.html#239">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: tvo
Date: 2008-02-01 01:17:52 +0100 (Fri, 01 Feb 2008)
New Revision: 5432

Removed:
   trunk/Documentation/xtachanges.txt
Modified:
   trunk/tools/ArchiveMover/ArchiveMover.cpp
   trunk/tools/DemoDumper/DemoDumper.cpp
Log:
* Make ArchiveMover and DemoDumper compile on Linux.
  (no buildsys yet, but it will come sometime :-))
  I think DemoAnalyser and DemoDumper should be merged sometime.

* Removed XTA SE changelog, doesn't belong here anymore.



Deleted: trunk/Documentation/xtachanges.txt
===================================================================
--- trunk/Documentation/xtachanges.txt	2008-01-31 23:08:02 UTC (rev 5431)
+++ trunk/Documentation/xtachanges.txt	2008-02-01 00:17:52 UTC (rev 5432)
@@ -1,68 +0,0 @@
-XTA SE changelog
-
-0.66
-
-Reduced speed of rocket kbot rockets 50%
-Increased cost of l2 factories 25%
-Reduced range of annihilator 5%
-
-0.65
-
-Fixed Raven hitsound and move interpolation
-Increased anti air damage from AA weapons, raised hp for non gunship aircrafts to compensate
-Reduced speed of gunships, but increased acceleration
-Anti air ships are now more effective
-Set raven and heavy plasma turrets to not be able to target air to avoid some friendly fire accidents
-Set maximum transportable mass to 3000 for tranport aircrafts
-Increased accuracy of buzzsaw/vulcan
-Fixed fibber move class
-
-0.64
-
-Weakened most expensive mobile units to compensate for friendly fire, mostly by lowering hp
-Lowered speed for sumo,warrior
-Lowered range for sumo
-Increased cost of Krogoth
-Increased build time and energy cost for l2 gunships
-Increased damage from ground aa missile units
-Removed damage modifier differences between seaair and landair and modified seaair hp to fit new scale
-Added new unit Raven heavy rocket kbot, build in arm adv kbot lab
-0.63
-
-Incresed areaofeffect for commander explosions to make sure you cant dgun one without dying
-Increased weapontimer for nukes to lessen risk of it hitting mountains
-Changed how antinukes explodes, they did more damage being destroyed than self destructing for some reason
-Increased damage for bombers bombs
-
-0.62
-
-Lowered hp for all mines so that they cant be placed so close to each other
-Increased build time for annihilator
-Reduced hp of goliath/krogoth 10%
-
-0.61
-
-Added tracks to all tanks
-Anni,Penetrator,DDM got a small targetMoverError to make them worse at hitting aircrafts
-Goliath,MobArt now has worse accuracy while moving
-Increased damage while decreasing range a bit for explosions from buildings that are killed
-
-0.6
-
-50% longer los for all units
-Krogoth/Goliath 20% more expensive
-Goliath less accurate
-Gunships -15% hp
-Fighters +20% damage against land +30% vs air
-Annihilator/Penetrator/Doomsday get beam lasers
-Annihilator 50% more expensive, get lot higher damage output
-Flakker type weapons get slightly higher area of effect to compensate for less edgeeffectivness
-Removed build time from core solar since it screwed up ctrl-b
-Necro/Fark can now resurrect
-Spider now has a paralyzing beamlaser
-Vulcan/Buzzsaw/Mobile artillery and artillery kbots get HighTrajectory tags
-MobArt get somewhat lower health
-Removed Leveller and flea from lvl1 factories
-Increades damage of nukes 20%
-Added tracks to stumpy and bulldog
-Added flares to fighters and advanced bombers
\ No newline at end of file

Modified: trunk/tools/ArchiveMover/ArchiveMover.cpp
===================================================================
--- trunk/tools/ArchiveMover/ArchiveMover.cpp	2008-01-31 23:08:02 UTC (rev 5431)
+++ trunk/tools/ArchiveMover/ArchiveMover.cpp	2008-02-01 00:17:52 UTC (rev 5432)
@@ -22,7 +22,8 @@
 using std::endl;
 
 
-#define ARCHIVE_MOVER_USE_WIN_API
+// FIXME: put in MSVC project file
+//#define ARCHIVE_MOVER_USE_WIN_API
 
 #ifdef ARCHIVE_MOVER_USE_WIN_API
   #ifndef NOMINMAX
@@ -61,6 +62,41 @@
 }
 
 
+#if defined(WIN32) &amp;&amp; (defined(UNICODE) || defined(_UNICODE))
+
+	typedef fs::wpath Path;
+	typedef fs::filesystem_wpath_error FilesystemPathError;
+
+	typedef wchar_t Char;
+	typedef std::wstring String;
+	typedef std::wstringstream StringStream;
+	std::wostream&amp; cout = std::wcout;
+
+	// Untested with MSVC (works fine with GCC).
+	#define _(s) L ## s
+	#define fopen _wfopen
+
+#else
+
+	// fs::wpath segfaults on Linux when doing something simple like:
+	//		Path p = fs::current_path&lt;Path&gt;();
+	// (this is used by fs::system_complete() and others ...)
+	typedef fs::path Path;
+	typedef fs::filesystem_path_error FilesystemPathError;
+
+	// And converting stuff back and forth between wide chars and narrow chars
+	// is a PITA so we just define String to normal string too.
+	// (Accented chars are for nubs anyway, in particular in filenames ;-))
+	typedef char Char;
+	typedef std::string String;
+	typedef std::stringstream StringStream;
+	std::ostream&amp; cout = std::cout;
+
+	#define _(s) s
+
+#endif
+
+
 //**************************************************************************************
 
 #define NEW_LIFETIME_MANAGER_NAME(type, name) \
@@ -125,15 +161,15 @@
 //******************************************************************************
 
 
-enum archive_type {
+enum ArchiveType {
 	R_MOD,
 	R_MAP,
 	R_OTHER
 };
 
-static int run(int argc, const wchar_t* const* argv);
-static archive_type read_archive_content_sd7(const fs::wpath&amp; filename);
-static archive_type read_archive_content_sdz(const fs::wpath&amp; filename);
+static int run(int argc, const Char* const* argv);
+static ArchiveType read_archive_content_sd7(const Path&amp; filename);
+static ArchiveType read_archive_content_sdz(const Path&amp; filename);
 
 
 static std::string string_to_lower(const std::string&amp; s){
@@ -144,14 +180,14 @@
 }
 
 
-struct scoped_message : public std::wstringstream{
-	~scoped_message(){
-		std::wstring str = this-&gt;str();
+struct ScopedMessage : public StringStream{
+	~ScopedMessage(){
+		String str = this-&gt;str();
 		if (!str.empty()) {
 #ifdef ARCHIVE_MOVER_USE_WIN_API
-			MessageBoxW(NULL, str.c_str(), L&quot;Spring - ArchiveMover&quot;, MB_APPLMODAL);
+			MessageBoxW(NULL, str.c_str(), _(&quot;Spring - ArchiveMover&quot;), MB_APPLMODAL);
 #else
-			std::wcout&lt;&lt;str&lt;&lt;endl;
+			cout&lt;&lt;str&lt;&lt;endl;
 #endif
 		}
 	}
@@ -174,8 +210,8 @@
 	return false;
 }
 
-static bool is_map_or_mod(const std::string&amp; filename, archive_type&amp; current_filetype){
-	archive_type filetype = R_OTHER;
+static bool is_map_or_mod(const std::string&amp; filename, ArchiveType&amp; current_filetype){
+	ArchiveType filetype = R_OTHER;
 	if(is_map(filename)){
 		filetype = R_MAP;
 	}else if(is_mod(filename)){
@@ -213,11 +249,11 @@
 	return ret;
 }
 #elif defined(_MSC_VER) &amp;&amp; (defined(UNICODE) || defined(_UNICODE))
-int wmain(int argc, wchar_t** argv){
+int wmain(int argc, const wchar_t* const* argv){
 	return run(argc, argv);
 }
 #else
-int main(int argc, char** argv){
+int main(int argc, const char* const* argv){
 /*	//Untested
 	mbstate_t mbstate;
 	memset((void*)&amp;mbstate, 0, sizeof(mbstate));
@@ -246,24 +282,25 @@
 
 	return ret;
 */
+	return run(argc, argv);
 }
 #endif
 
 
-static int run(int argc, const wchar_t* const* argv){
+static int run(int argc, const Char* const* argv){
 
-	scoped_message message;
+	ScopedMessage message;
 	try{
 		bool show_usage = false;
 		bool quiet = false;
-		const wchar_t* source_file_arg = NULL;
+		const Char* source_file_arg = NULL;
 
 		for (int i = 1; i &lt; argc; ++i) {
-			std::wstring arg = argv[i];
+			String arg = argv[i];
 			if (arg[0] == '-') {
-				if (arg == L&quot;--help&quot; || arg == L&quot;-h&quot;)
+				if (arg == _(&quot;--help&quot;) || arg == _(&quot;-h&quot;))
 					show_usage = true;
-				else if (arg == L&quot;--quiet&quot; || arg == L&quot;-q&quot;)
+				else if (arg == _(&quot;--quiet&quot;) || arg == _(&quot;-q&quot;))
 					quiet = true;
 			} else {
 				// multiple file arguments is erroneous
@@ -274,34 +311,34 @@
 		}
 
 		if(show_usage || source_file_arg == NULL){
-			message&lt;&lt;L&quot;Usage: &quot;&lt;&lt;fs::system_complete(argv[0]).leaf()&lt;&lt;L&quot; [--quiet] &lt;filename&gt;&quot;&lt;&lt;endl&lt;&lt;endl;
+			message&lt;&lt;_(&quot;Usage: &quot;)&lt;&lt;fs::system_complete(argv[0]).leaf()&lt;&lt;_(&quot; [--quiet] &lt;filename&gt;&quot;)&lt;&lt;endl&lt;&lt;endl;
 			return 1;
 		}
 
-		const fs::wpath source_file = fs::system_complete(source_file_arg);
-		fs::wpath target_dir = fs::system_complete(argv[0]).branch_path();
+		const Path source_file = fs::system_complete(source_file_arg);
+		Path target_dir = fs::system_complete(argv[0]).branch_path();
 
 		if(!fs::exists(source_file)){
-			message&lt;&lt;source_file&lt;&lt;endl&lt;&lt;L&quot;File not found.&quot;&lt;&lt;endl;
+			message&lt;&lt;source_file&lt;&lt;endl&lt;&lt;_(&quot;File not found.&quot;)&lt;&lt;endl;
 			return 1;
 		}
 
 
-		archive_type content = read_archive_content_sd7(source_file);
+		ArchiveType content = read_archive_content_sd7(source_file);
 		if(content == R_OTHER){
 			content = read_archive_content_sdz(source_file);
 		}
 
 		if(content == R_OTHER){
-			message&lt;&lt;L&quot;'&quot;&lt;&lt;source_file.leaf()&lt;&lt;L&quot;' is not a valid map/mod &quot;
-			L&quot;it may be corrupted, try to redownload it.&quot;&lt;&lt;endl;
+			message&lt;&lt;_(&quot;'&quot;)&lt;&lt;source_file.leaf()&lt;&lt;_(&quot;' is not a valid map/mod &quot;)
+			_(&quot;it may be corrupted, try to redownload it.&quot;)&lt;&lt;endl;
 			return 1;
 		}
 
 
-		//for(fs::wpath test_path = source_file; test_path.has_root_directory(); ){
+		//for(Path test_path = source_file; test_path.has_root_directory(); ){
 		//	if(fs::equivalent(test_path, target_dir)){
-		//		message&lt;&lt;L&quot;'&quot;&lt;&lt;source_file.leaf()&lt;&lt;L&quot;' already exists in the Spring directory.&quot;&lt;&lt;endl;
+		//		message&lt;&lt;_(&quot;'&quot;)&lt;&lt;source_file.leaf()&lt;&lt;_(&quot;' already exists in the Spring directory.&quot;)&lt;&lt;endl;
 		//		return 1;
 		//	}
 		//	test_path = test_path.branch_path();
@@ -310,29 +347,29 @@
 
 		if(content == R_MAP){
 			//message&lt;&lt;&quot;isMap: &quot;&lt;&lt;filename&lt;&lt;endl;
-			target_dir /= L&quot;maps&quot;;
+			target_dir /= _(&quot;maps&quot;);
 		}else if(content == R_MOD){
 			//message&lt;&lt;&quot;isMod: &quot;&lt;&lt;filename&lt;&lt;endl;
-			target_dir /= L&quot;mods&quot;;
+			target_dir /= _(&quot;mods&quot;);
 		}else{
 			assert(false);
 		}
 
 		if(!fs::exists(target_dir)){
-			message&lt;&lt;L&quot;The target directory '&quot;&lt;&lt;target_dir&lt;&lt;L&quot;' doesn't exist.&quot;&lt;&lt;endl;
+			message&lt;&lt;_(&quot;The target directory '&quot;)&lt;&lt;target_dir&lt;&lt;_(&quot;' doesn't exist.&quot;)&lt;&lt;endl;
 			return 1;
 		}
 
 		// stash existing files away
 		if (fs::exists(target_dir / source_file.leaf())) {
 			int i = 0;
-			fs::wpath target_test;
+			Path target_test;
 			do {
-				std::wstring stashed = (source_file.leaf() + L&quot;.old&quot;);
+				String stashed = (source_file.leaf() + _(&quot;.old&quot;));
 				if (i &gt; 0) {
-					std::wstringstream tmp;
+					StringStream tmp;
 					tmp &lt;&lt; i;
-					stashed += L&quot;.&quot;+tmp.str();
+					stashed += _(&quot;.&quot;)+tmp.str();
 				}
 				target_test = target_dir / stashed;
 				++i;
@@ -346,53 +383,53 @@
 		fs::rename(source_file, target_dir);
 
 		if (!quiet) {
-			message&lt;&lt;L&quot;The &quot;&lt;&lt;(content == R_MAP? L&quot;map '&quot; : L&quot;mod '&quot;)&lt;&lt;source_file.leaf()
-			&lt;&lt;L&quot;' has been saved succesfully to '&quot;&lt;&lt;target_dir.branch_path()&lt;&lt;L&quot;'.&quot;&lt;&lt;endl
-			&lt;&lt;L&quot;Use the reload mods/maps button in the lobby to make Spring find it.&quot;&lt;&lt;endl;
+			message&lt;&lt;_(&quot;The &quot;)&lt;&lt;(content == R_MAP? _(&quot;map '&quot;) : _(&quot;mod '&quot;))&lt;&lt;source_file.leaf()
+			&lt;&lt;_(&quot;' has been saved succesfully to '&quot;)&lt;&lt;target_dir.branch_path()&lt;&lt;_(&quot;'.&quot;)&lt;&lt;endl
+			&lt;&lt;_(&quot;Use the reload mods/maps button in the lobby to make Spring find it.&quot;)&lt;&lt;endl;
 		}
 
 	}
-	catch(fs::filesystem_wpath_error&amp; error) {
+	catch(FilesystemPathError&amp; error) {
 		fs::errno_type error_nr = fs::lookup_errno(error.system_error());
-		message&lt;&lt;L&quot;Cannot move file: &quot;;
+		message&lt;&lt;_(&quot;Cannot move file: &quot;);
 		switch(error_nr){
 			case EPERM:
 			case EACCES:{
-				message&lt;&lt;L&quot;Permission denied.&quot;;
+				message&lt;&lt;_(&quot;Permission denied.&quot;);
 				break;
 			}
 			case ENOSPC:{
-				message&lt;&lt;L&quot;Not enough free disk space.&quot;;
+				message&lt;&lt;_(&quot;Not enough free disk space.&quot;);
 				break;
 			}
 			case ENOENT:{
-				message&lt;&lt;L&quot;Invalid path.&quot;;
+				message&lt;&lt;_(&quot;Invalid path.&quot;);
 				break;
 			}
 			case EROFS:{
-				message&lt;&lt;L&quot;Target path is read only.&quot;;
+				message&lt;&lt;_(&quot;Target path is read only.&quot;);
 				break;
 			}
 			case EEXIST:{
-				message&lt;&lt;L&quot;Target folder already contains a file named '&quot;&lt;&lt;error.path1().leaf()&lt;&lt;L&quot;'.&quot;;
+				message&lt;&lt;_(&quot;Target folder already contains a file named '&quot;)&lt;&lt;error.path1().leaf()&lt;&lt;_(&quot;'.&quot;);
 				break;
 			}
 			default:{
-				message&lt;&lt;strerror(error_nr)&lt;&lt;L&quot;.&quot;;
+				message&lt;&lt;strerror(error_nr)&lt;&lt;_(&quot;.&quot;);
 			}
 		}
 		message&lt;&lt;endl&lt;&lt;endl;
-		message&lt;&lt;L&quot;Source file: &quot;&lt;&lt;error.path1()&lt;&lt;endl; 
-		message&lt;&lt;L&quot;Target folder: &quot;&lt;&lt;error.path2().branch_path()&lt;&lt;endl;
+		message&lt;&lt;_(&quot;Source file: &quot;)&lt;&lt;error.path1()&lt;&lt;endl; 
+		message&lt;&lt;_(&quot;Target folder: &quot;)&lt;&lt;error.path2().branch_path()&lt;&lt;endl;
 	}
 	catch(fs::filesystem_error&amp; error) {
-		message&lt;&lt;L&quot;Filesystem error in: &quot;&lt;&lt;error.what()&lt;&lt;endl;
+		message&lt;&lt;_(&quot;Filesystem error in: &quot;)&lt;&lt;error.what()&lt;&lt;endl;
 	}
 	catch(std::exception&amp; error) {
-		message&lt;&lt;L&quot;Found an exception with: &quot;&lt;&lt;error.what()&lt;&lt;endl;
+		message&lt;&lt;_(&quot;Found an exception with: &quot;)&lt;&lt;error.what()&lt;&lt;endl;
 	}
 	catch(...) {
-		message&lt;&lt;L&quot;Found an unknown exception.&quot;&lt;&lt;endl;
+		message&lt;&lt;_(&quot;Found an unknown exception.&quot;)&lt;&lt;endl;
 	}
 
 	return 0;
@@ -405,26 +442,26 @@
 static voidpf ZCALLBACK sdz_open_file_unicode(voidpf opaque, const char *filename, int mode){
 
 	FILE* file = NULL;
-	const wchar_t* mode_fopen = NULL;
+	const Char* mode_fopen = NULL;
 	if ((mode &amp; ZLIB_FILEFUNC_MODE_READWRITEFILTER)==ZLIB_FILEFUNC_MODE_READ){
-		mode_fopen = L&quot;rb&quot;;
+		mode_fopen = _(&quot;rb&quot;);
 	}else if (mode &amp; ZLIB_FILEFUNC_MODE_EXISTING){
-		mode_fopen = L&quot;r+b&quot;;
+		mode_fopen = _(&quot;r+b&quot;);
 	}else if (mode &amp; ZLIB_FILEFUNC_MODE_CREATE){
-		mode_fopen = L&quot;wb&quot;;
+		mode_fopen = _(&quot;wb&quot;);
 	}
 
 	if(filename == NULL &amp;&amp; mode_fopen != NULL &amp;&amp; opaque != NULL){
-		file = _wfopen(static_cast&lt;const fs::wpath*&gt;(opaque)-&gt;string().c_str(), mode_fopen);
+		file = fopen(static_cast&lt;const Path*&gt;(opaque)-&gt;string().c_str(), mode_fopen);
 	}
 	return file;
 }
 
-static archive_type read_archive_content_sdz(const fs::wpath&amp; filename){
+static ArchiveType read_archive_content_sdz(const Path&amp; filename){
 
 	zlib_filefunc_def file_api;
 	fill_fopen_filefunc(&amp;file_api);
-	file_api.opaque = &amp;const_cast&lt;fs::wpath&amp;&gt;(filename);
+	file_api.opaque = &amp;const_cast&lt;Path&amp;&gt;(filename);
 	file_api.zopen_file = sdz_open_file_unicode;
 
 	unzFile_ptr sdz = unzOpen2_p(&amp;file_api);
@@ -437,7 +474,7 @@
 	}
 
 	const int buffer_size = 1024*1024;
-	archive_type content = R_OTHER;
+	ArchiveType content = R_OTHER;
 	boost::scoped_array&lt;char&gt; read_buf(new char[buffer_size]);
 
 
@@ -516,7 +553,7 @@
 }
 
 
-static archive_type read_archive_content_sd7(const fs::wpath&amp; filename){
+static ArchiveType read_archive_content_sd7(const Path&amp; filename){
 
 	SD7Stream stream;
 	stream.funcs.Read = sd7_read_file;
@@ -549,7 +586,7 @@
 	unsigned int block_index = 0;
 	SzOutBuffer_ptr out_buffer = SzOutBuffer_p(0);
 	size_t out_buffer_size = 0;
-	archive_type content = R_OTHER;
+	ArchiveType content = R_OTHER;
 
 	for (unsigned int i = 0; i &lt; db-&gt;Database.NumFiles; ++i) {
 		CFileItem* fi = db-&gt;Database.Files + i;

Modified: trunk/tools/DemoDumper/DemoDumper.cpp
===================================================================
--- trunk/tools/DemoDumper/DemoDumper.cpp	2008-01-31 23:08:02 UTC (rev 5431)
+++ trunk/tools/DemoDumper/DemoDumper.cpp	2008-02-01 00:17:52 UTC (rev 5432)
@@ -48,29 +48,62 @@
 namespace fs = boost::filesystem;
 
 
+#if defined(WIN32) &amp;&amp; (defined(UNICODE) || defined(_UNICODE))
+
+	typedef fs::wpath Path;
+
+	typedef wchar_t Char;
+	typedef std::wstring String;
+	typedef std::wstringstream StringStream;
+	std::wostream&amp; cout = std::wcout;
+
+	// Untested with MSVC (works fine with GCC).
+	#define _(s) L ## s
+
+#else
+
+	// fs::wpath segfaults on Linux when doing something simple like:
+	//		Path p = fs::current_path&lt;Path&gt;();
+	// (this is used by fs::system_complete() and others ...)
+	typedef fs::path Path;
+
+	// And converting stuff back and forth between wide chars and narrow chars
+	// is a PITA so we just define String to normal string too.
+	// (Accented chars are for nubs anyway, in particular in filenames ;-))
+	typedef char Char;
+	typedef std::string String;
+	typedef std::stringstream StringStream;
+	std::ostream&amp; cout = std::cout;
+
+	#define _(s) s
+
+#endif
+
+
 /******************************************************************************/
 
-struct scoped_message : public std::wstringstream {
-	~scoped_message(){
+struct ScopedMessage : public StringStream {
+	~ScopedMessage(){
 #ifdef DEMO_DUMPER_USE_WIN_API
-		MessageBoxW(NULL, this-&gt;str().c_str(), L&quot;Spring - DemoDumper&quot;, MB_APPLMODAL);
+		MessageBoxW(NULL, this-&gt;str().c_str(), _(&quot;Spring - DemoDumper&quot;), MB_APPLMODAL);
 #else
-		std::wcout&lt;&lt;this-&gt;str()&lt;&lt;endl;
+		cout&lt;&lt;this-&gt;str()&lt;&lt;endl;
 #endif
 	}
 };
 
 
-struct demofile_exception : public std::exception {
-	fs::wpath filename;
-	std::wstring message;
-	demofile_exception(const fs::wpath&amp; fname, const std::wstring&amp; msg) :
+struct DemofileException : public std::exception {
+	Path filename;
+	String message;
+	DemofileException(const Path&amp; fname, const String&amp; msg) :
 		filename(fname), message(msg) {}
+	~DemofileException() throw() {}
 };
 
 
-static int run(int argc, wchar_t** argv);
-static void read_demofile(scoped_message&amp; message, const fs::wpath&amp; source_file);
+static int run(int argc, const Char* const* argv);
+static void read_demofile(ScopedMessage&amp; message, const Path&amp; source_file);
 
 
 /******************************************************************************/
@@ -92,13 +125,14 @@
 
 	return ret;
 }
-#elif defined(_MSC_VER) &amp;&amp; (defined(UNICODE) || defined(_UNICODE))
-int wmain(int argc, wchar_t** argv)
+#elif defined(WIN32) &amp;&amp; (defined(UNICODE) || defined(_UNICODE))
+int wmain(int argc, const wchar_t* const* argv)
 {
 	return run(argc, argv);
 }
 #else
-int main(int argc, char** argv){
+int main(int argc, const char* const* argv)
+{
 /*	//Untested
 	mbstate_t mbstate;
 	memset((void*)&amp;mbstate, 0, sizeof(mbstate));
@@ -127,53 +161,53 @@
 
 	return ret;
 */
+	return run(argc, argv);
 }
 #endif
 
 
-static int run(int argc, wchar_t** argv)
+static int run(int argc, const Char* const* argv)
 {
-	scoped_message message;
+	ScopedMessage message;
 	try{
 		if(argc == 0){
-			message&lt;&lt;L&quot;Error: Zero arguments.&quot;&lt;&lt;endl;
+			message&lt;&lt;_(&quot;Error: Zero arguments.&quot;)&lt;&lt;endl;
 			return 1;
 		}else if(argc != 2){
-			message&lt;&lt;L&quot;Usage: &quot;&lt;&lt;fs::system_complete(argv[0]).leaf()&lt;&lt;L&quot; &lt;filename&gt;&quot;&lt;&lt;endl&lt;&lt;endl;
+			message&lt;&lt;_(&quot;Usage: &quot;)&lt;&lt;fs::system_complete(argv[0]).leaf()&lt;&lt;_(&quot; &lt;filename&gt;&quot;)&lt;&lt;endl&lt;&lt;endl;
 			return 1;
 		}
 
+		const Path source_file = fs::system_complete(argv[1]);
 
-		const fs::wpath source_file = fs::system_complete(argv[1]);
-		fs::wpath target_dir = fs::system_complete(argv[0]).branch_path();
-
 		if(!fs::exists(source_file)){
-			message&lt;&lt;source_file&lt;&lt;endl&lt;&lt;L&quot;File not found.&quot;&lt;&lt;endl;
+			message&lt;&lt;source_file&lt;&lt;endl&lt;&lt;_(&quot;File not found.&quot;)&lt;&lt;endl;
 			return 1;
 		}
 
 		read_demofile(message, source_file);
 
 	}
-	catch (demofile_exception&amp; error) {
-		message&lt;&lt;&quot;Cannot read demofile: &quot;&lt;&lt;error.filename&lt;&lt;endl;
-		message&lt;&lt;L&quot;: &quot;&lt;&lt;error.message&lt;&lt;endl;
+	catch (DemofileException&amp; error) {
+		message&lt;&lt;_(&quot;Cannot read demofile: &quot;)&lt;&lt;error.filename;
+		message&lt;&lt;_(&quot;: &quot;)&lt;&lt;error.message&lt;&lt;endl;
 	}
 	catch(fs::filesystem_error&amp; error){
-		message&lt;&lt;L&quot;Filesystem error in: &quot;&lt;&lt;error.what()&lt;&lt;endl;
+		message&lt;&lt;_(&quot;Filesystem error in: &quot;)&lt;&lt;error.what()&lt;&lt;endl;
 	}
 	catch(std::exception&amp; error){
-		message&lt;&lt;L&quot;Found an exception with: &quot;&lt;&lt;error.what()&lt;&lt;endl;
+		message&lt;&lt;_(&quot;Found an exception with: &quot;)&lt;&lt;error.what()&lt;&lt;endl;
 	}
 	catch(...){
-		message&lt;&lt;L&quot;Found an unknown exception.&quot;&lt;&lt;endl;
+		message&lt;&lt;_(&quot;Found an unknown exception.&quot;)&lt;&lt;endl;
 	}
 
 	return 0;
 }
 
 
-struct PlayerStatistics {
+struct PlayerStatistics
+{
 	/// how many pixels the mouse has traversed in total
 	int mousePixels;
 	int mouseClicks;
@@ -206,7 +240,7 @@
 };
 
 
-std::wstringstream&amp; operator&lt;&lt;(std::wstringstream&amp; str, const DemoFileHeader&amp; header)
+StringStream&amp; operator&lt;&lt;(StringStream&amp; str, const DemoFileHeader&amp; header)
 {
 	char idbuf[128];
 	const unsigned char* p = header.gameID;
@@ -216,65 +250,65 @@
 		p[ 0], p[ 1], p[ 2], p[ 3], p[ 4], p[ 5], p[ 6], p[ 7],
 		p[ 8], p[ 9], p[10], p[11], p[12], p[13], p[14], p[15]);
 
-	str&lt;&lt;L&quot;Magic: &quot;&lt;&lt;header.magic&lt;&lt;endl;
-	str&lt;&lt;L&quot;Version: &quot;&lt;&lt;header.version&lt;&lt;endl;
-	str&lt;&lt;L&quot;HeaderSize: &quot;&lt;&lt;header.headerSize&lt;&lt;endl;
-	str&lt;&lt;L&quot;VersionString: &quot;&lt;&lt;header.versionString&lt;&lt;endl;
-	str&lt;&lt;L&quot;GameID: &quot;&lt;&lt;idbuf&lt;&lt;endl;
-	str&lt;&lt;L&quot;UnixTime: &quot;&lt;&lt;header.unixTime&lt;&lt;endl;
-	str&lt;&lt;L&quot;ScriptSize: &quot;&lt;&lt;header.scriptSize&lt;&lt;endl;
-	str&lt;&lt;L&quot;DemoStreamSize: &quot;&lt;&lt;header.demoStreamSize&lt;&lt;endl;
-	str&lt;&lt;L&quot;GameTime: &quot;&lt;&lt;header.gameTime&lt;&lt;endl;
-	str&lt;&lt;L&quot;WallclockTime: &quot;&lt;&lt;header.wallclockTime&lt;&lt;endl;
-	str&lt;&lt;L&quot;NumPlayers: &quot;&lt;&lt;header.numPlayers&lt;&lt;endl;
-	str&lt;&lt;L&quot;PlayerStatSize: &quot;&lt;&lt;header.playerStatSize&lt;&lt;endl;
-	str&lt;&lt;L&quot;PlayerStatElemSize: &quot;&lt;&lt;header.playerStatElemSize&lt;&lt;endl;
-	str&lt;&lt;L&quot;NumTeams: &quot;&lt;&lt;header.numTeams&lt;&lt;endl;
-	str&lt;&lt;L&quot;TeamStatSize: &quot;&lt;&lt;header.teamStatSize&lt;&lt;endl;
-	str&lt;&lt;L&quot;TeamStatElemSize: &quot;&lt;&lt;header.teamStatElemSize&lt;&lt;endl;
-	str&lt;&lt;L&quot;TeamStatPeriod: &quot;&lt;&lt;header.teamStatPeriod&lt;&lt;endl;
-	str&lt;&lt;L&quot;WinningAllyTeam: &quot;&lt;&lt;header.winningAllyTeam&lt;&lt;endl;
+	str&lt;&lt;_(&quot;Magic: &quot;)&lt;&lt;header.magic&lt;&lt;endl;
+	str&lt;&lt;_(&quot;Version: &quot;)&lt;&lt;header.version&lt;&lt;endl;
+	str&lt;&lt;_(&quot;HeaderSize: &quot;)&lt;&lt;header.headerSize&lt;&lt;endl;
+	str&lt;&lt;_(&quot;VersionString: &quot;)&lt;&lt;header.versionString&lt;&lt;endl;
+	str&lt;&lt;_(&quot;GameID: &quot;)&lt;&lt;idbuf&lt;&lt;endl;
+	str&lt;&lt;_(&quot;UnixTime: &quot;)&lt;&lt;header.unixTime&lt;&lt;endl;
+	str&lt;&lt;_(&quot;ScriptSize: &quot;)&lt;&lt;header.scriptSize&lt;&lt;endl;
+	str&lt;&lt;_(&quot;DemoStreamSize: &quot;)&lt;&lt;header.demoStreamSize&lt;&lt;endl;
+	str&lt;&lt;_(&quot;GameTime: &quot;)&lt;&lt;header.gameTime&lt;&lt;endl;
+	str&lt;&lt;_(&quot;WallclockTime: &quot;)&lt;&lt;header.wallclockTime&lt;&lt;endl;
+	str&lt;&lt;_(&quot;NumPlayers: &quot;)&lt;&lt;header.numPlayers&lt;&lt;endl;
+	str&lt;&lt;_(&quot;PlayerStatSize: &quot;)&lt;&lt;header.playerStatSize&lt;&lt;endl;
+	str&lt;&lt;_(&quot;PlayerStatElemSize: &quot;)&lt;&lt;header.playerStatElemSize&lt;&lt;endl;
+	str&lt;&lt;_(&quot;NumTeams: &quot;)&lt;&lt;header.numTeams&lt;&lt;endl;
+	str&lt;&lt;_(&quot;TeamStatSize: &quot;)&lt;&lt;header.teamStatSize&lt;&lt;endl;
+	str&lt;&lt;_(&quot;TeamStatElemSize: &quot;)&lt;&lt;header.teamStatElemSize&lt;&lt;endl;
+	str&lt;&lt;_(&quot;TeamStatPeriod: &quot;)&lt;&lt;header.teamStatPeriod&lt;&lt;endl;
+	str&lt;&lt;_(&quot;WinningAllyTeam: &quot;)&lt;&lt;header.winningAllyTeam&lt;&lt;endl;
 	return str;
 }
 
 
-std::wstringstream&amp; operator&lt;&lt;(std::wstringstream&amp; str, const PlayerStatistics&amp; header)
+StringStream&amp; operator&lt;&lt;(StringStream&amp; str, const PlayerStatistics&amp; header)
 {
-	str&lt;&lt;L&quot;MousePixels: &quot;&lt;&lt;header.mousePixels&lt;&lt;endl;
-	str&lt;&lt;L&quot;MouseClicks: &quot;&lt;&lt;header.mouseClicks&lt;&lt;endl;
-	str&lt;&lt;L&quot;KeyPresses: &quot;&lt;&lt;header.keyPresses&lt;&lt;endl;
-	str&lt;&lt;L&quot;NumCommands: &quot;&lt;&lt;header.numCommands&lt;&lt;endl;
-	str&lt;&lt;L&quot;UnitCommands: &quot;&lt;&lt;header.unitCommands&lt;&lt;endl;
+	str&lt;&lt;_(&quot;MousePixels: &quot;)&lt;&lt;header.mousePixels&lt;&lt;endl;
+	str&lt;&lt;_(&quot;MouseClicks: &quot;)&lt;&lt;header.mouseClicks&lt;&lt;endl;
+	str&lt;&lt;_(&quot;KeyPresses: &quot;)&lt;&lt;header.keyPresses&lt;&lt;endl;
+	str&lt;&lt;_(&quot;NumCommands: &quot;)&lt;&lt;header.numCommands&lt;&lt;endl;
+	str&lt;&lt;_(&quot;UnitCommands: &quot;)&lt;&lt;header.unitCommands&lt;&lt;endl;
 	return str;
 }
 
 
-std::wstringstream&amp; operator&lt;&lt;(std::wstringstream&amp; str, const TeamStatistics&amp; header)
+StringStream&amp; operator&lt;&lt;(StringStream&amp; str, const TeamStatistics&amp; header)
 {
-	str&lt;&lt;L&quot;MetalUsed: &quot;&lt;&lt;header.metalUsed&lt;&lt;endl;
-	str&lt;&lt;L&quot;EnergyUsed: &quot;&lt;&lt;header.energyUsed&lt;&lt;endl;
-	str&lt;&lt;L&quot;MetalProduced: &quot;&lt;&lt;header.metalProduced&lt;&lt;endl;
-	str&lt;&lt;L&quot;EnergyProduced: &quot;&lt;&lt;header.energyProduced&lt;&lt;endl;
-	str&lt;&lt;L&quot;MetalExcess: &quot;&lt;&lt;header.metalExcess&lt;&lt;endl;
-	str&lt;&lt;L&quot;EnergyExcess: &quot;&lt;&lt;header.energyExcess&lt;&lt;endl;
-	str&lt;&lt;L&quot;MetalReceived: &quot;&lt;&lt;header.metalReceived&lt;&lt;endl;
-	str&lt;&lt;L&quot;EnergyReceived: &quot;&lt;&lt;header.energyReceived&lt;&lt;endl;
-	str&lt;&lt;L&quot;MetalSent: &quot;&lt;&lt;header.metalSent&lt;&lt;endl;
-	str&lt;&lt;L&quot;EnergySent: &quot;&lt;&lt;header.energySent&lt;&lt;endl;
-	str&lt;&lt;L&quot;DamageDealt: &quot;&lt;&lt;header.damageDealt&lt;&lt;endl;
-	str&lt;&lt;L&quot;DamageReceived: &quot;&lt;&lt;header.damageReceived&lt;&lt;endl;
-	str&lt;&lt;L&quot;UnitsProduced: &quot;&lt;&lt;header.unitsProduced&lt;&lt;endl;
-	str&lt;&lt;L&quot;UnitsDied: &quot;&lt;&lt;header.unitsDied&lt;&lt;endl;
-	str&lt;&lt;L&quot;UnitsReceived: &quot;&lt;&lt;header.unitsReceived&lt;&lt;endl;
-	str&lt;&lt;L&quot;UnitsSent: &quot;&lt;&lt;header.unitsSent&lt;&lt;endl;
-	str&lt;&lt;L&quot;UnitsCaptured: &quot;&lt;&lt;header.unitsCaptured&lt;&lt;endl;
-	str&lt;&lt;L&quot;UnitsOutCaptured: &quot;&lt;&lt;header.unitsOutCaptured&lt;&lt;endl;
-	str&lt;&lt;L&quot;UnitsKilled: &quot;&lt;&lt;header.unitsKilled&lt;&lt;endl;
+	str&lt;&lt;_(&quot;MetalUsed: &quot;)&lt;&lt;header.metalUsed&lt;&lt;endl;
+	str&lt;&lt;_(&quot;EnergyUsed: &quot;)&lt;&lt;header.energyUsed&lt;&lt;endl;
+	str&lt;&lt;_(&quot;MetalProduced: &quot;)&lt;&lt;header.metalProduced&lt;&lt;endl;
+	str&lt;&lt;_(&quot;EnergyProduced: &quot;)&lt;&lt;header.energyProduced&lt;&lt;endl;
+	str&lt;&lt;_(&quot;MetalExcess: &quot;)&lt;&lt;header.metalExcess&lt;&lt;endl;
+	str&lt;&lt;_(&quot;EnergyExcess: &quot;)&lt;&lt;header.energyExcess&lt;&lt;endl;
+	str&lt;&lt;_(&quot;MetalReceived: &quot;)&lt;&lt;header.metalReceived&lt;&lt;endl;
+	str&lt;&lt;_(&quot;EnergyReceived: &quot;)&lt;&lt;header.energyReceived&lt;&lt;endl;
+	str&lt;&lt;_(&quot;MetalSent: &quot;)&lt;&lt;header.metalSent&lt;&lt;endl;
+	str&lt;&lt;_(&quot;EnergySent: &quot;)&lt;&lt;header.energySent&lt;&lt;endl;
+	str&lt;&lt;_(&quot;DamageDealt: &quot;)&lt;&lt;header.damageDealt&lt;&lt;endl;
+	str&lt;&lt;_(&quot;DamageReceived: &quot;)&lt;&lt;header.damageReceived&lt;&lt;endl;
+	str&lt;&lt;_(&quot;UnitsProduced: &quot;)&lt;&lt;header.unitsProduced&lt;&lt;endl;
+	str&lt;&lt;_(&quot;UnitsDied: &quot;)&lt;&lt;header.unitsDied&lt;&lt;endl;
+	str&lt;&lt;_(&quot;UnitsReceived: &quot;)&lt;&lt;header.unitsReceived&lt;&lt;endl;
+	str&lt;&lt;_(&quot;UnitsSent: &quot;)&lt;&lt;header.unitsSent&lt;&lt;endl;
+	str&lt;&lt;_(&quot;UnitsCaptured: &quot;)&lt;&lt;header.unitsCaptured&lt;&lt;endl;
+	str&lt;&lt;_(&quot;UnitsOutCaptured: &quot;)&lt;&lt;header.unitsOutCaptured&lt;&lt;endl;
+	str&lt;&lt;_(&quot;UnitsKilled: &quot;)&lt;&lt;header.unitsKilled&lt;&lt;endl;
 	return str;
 }
 
 
-static void read_demofile(scoped_message&amp; message, const fs::wpath&amp; source_file)
+static void read_demofile(ScopedMessage&amp; message, const Path&amp; source_file)
 {
 	// Open the file for binary reading.
 	boost::filesystem::ifstream file(source_file, std::ios_base::binary);
@@ -294,7 +328,7 @@
 			fileHeader.headerSize != sizeof(DemoFileHeader) ||
 			fileHeader.playerStatElemSize != sizeof(PlayerStatistics) ||
 			fileHeader.teamStatElemSize != sizeof(TeamStatistics)) {
-		throw demofile_exception(source_file, L&quot;Corrupt demofile.&quot;);
+		throw DemofileException(source_file, _(&quot;Corrupt demofile.&quot;));
 	}
 
 	// Write out the DemoFileHeader.
@@ -306,7 +340,7 @@
 	// Loop through all players and read and output the statistics for each.
 	for (int playerNum = 0; playerNum &lt; fileHeader.numPlayers; ++playerNum) {
 		file.read((char*)&amp;playerStats, sizeof(playerStats));
-		message&lt;&lt;L&quot;-- Player statistics for player &quot;&lt;&lt;playerNum&lt;&lt;L&quot; --&quot;&lt;&lt;endl;
+		message&lt;&lt;_(&quot;-- Player statistics for player &quot;)&lt;&lt;playerNum&lt;&lt;_(&quot; --&quot;)&lt;&lt;endl;
 		message&lt;&lt;playerStats&lt;&lt;endl;
 	}
 
@@ -323,7 +357,7 @@
 		int time = 0;
 		for (int i = 0; i &lt; numStatsPerTeam[teamNum]; ++i) {
 			file.read((char*)&amp;teamStats, sizeof(teamStats));
-			message&lt;&lt;L&quot;-- Team statistics for team &quot;&lt;&lt;teamNum&lt;&lt;L&quot;, game second &quot;&lt;&lt;time&lt;&lt;L&quot; --&quot;&lt;&lt;endl;
+			message&lt;&lt;_(&quot;-- Team statistics for team &quot;)&lt;&lt;teamNum&lt;&lt;_(&quot;, game second &quot;)&lt;&lt;time&lt;&lt;_(&quot; --&quot;)&lt;&lt;endl;
 			message&lt;&lt;teamStats&lt;&lt;endl;
 			time += fileHeader.teamStatPeriod;
 		}


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000238.html">[Taspring-linux-commit] r5431 - trunk/Lobby/TASClient
</A></li>
	<LI>Next message: <A HREF="000240.html">[Taspring-linux-commit] r5433 - trunk
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#239">[ date ]</a>
              <a href="thread.html#239">[ thread ]</a>
              <a href="subject.html#239">[ subject ]</a>
              <a href="author.html#239">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
