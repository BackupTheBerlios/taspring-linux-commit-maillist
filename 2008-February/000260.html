<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r5453 - in trunk: Documentation rts	rts/Game/StartScripts rts/Sim/MoveTypes rts/Sim/Units	rts/Sim/Units/COB rts/Sim/Units/CommandAI
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-February/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5453%20-%20in%20trunk%3A%20Documentation%20rts%0A%09rts/Game/StartScripts%20rts/Sim/MoveTypes%20rts/Sim/Units%0A%09rts/Sim/Units/COB%20rts/Sim/Units/CommandAI&In-Reply-To=%3CE1JMLFX-0007aB-Pc%40proserver.fnord.lan%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000259.html">
   <LINK REL="Next"  HREF="000261.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r5453 - in trunk: Documentation rts	rts/Game/StartScripts rts/Sim/MoveTypes rts/Sim/Units	rts/Sim/Units/COB rts/Sim/Units/CommandAI</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5453%20-%20in%20trunk%3A%20Documentation%20rts%0A%09rts/Game/StartScripts%20rts/Sim/MoveTypes%20rts/Sim/Units%0A%09rts/Sim/Units/COB%20rts/Sim/Units/CommandAI&In-Reply-To=%3CE1JMLFX-0007aB-Pc%40proserver.fnord.lan%3E"
       TITLE="[Taspring-linux-commit] r5453 - in trunk: Documentation rts	rts/Game/StartScripts rts/Sim/MoveTypes rts/Sim/Units	rts/Sim/Units/COB rts/Sim/Units/CommandAI">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Tue Feb  5 11:41:59 CET 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000259.html">[Taspring-linux-commit] r5452 - trunk/Lobby/TASServer
</A></li>
        <LI>Next message: <A HREF="000261.html">[Taspring-linux-commit] r5454 - trunk/AI/Global/KAIK-0.13
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#260">[ date ]</a>
              <a href="thread.html#260">[ thread ]</a>
              <a href="subject.html#260">[ subject ]</a>
              <a href="author.html#260">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: przybyjw
Date: 2008-02-05 11:41:59 +0100 (Tue, 05 Feb 2008)
New Revision: 5453

Added:
   trunk/rts/Sim/MoveTypes/AAirMoveType.cpp
   trunk/rts/Sim/MoveTypes/AAirMoveType.h
Modified:
   trunk/Documentation/changelog.txt
   trunk/rts/
   trunk/rts/Game/StartScripts/AirScript.cpp
   trunk/rts/Sim/MoveTypes/AirMoveType.cpp
   trunk/rts/Sim/MoveTypes/AirMoveType.h
   trunk/rts/Sim/MoveTypes/TAAirMoveType.cpp
   trunk/rts/Sim/MoveTypes/TAAirMoveType.h
   trunk/rts/Sim/Units/COB/CobInstance.cpp
   trunk/rts/Sim/Units/CommandAI/AirCAI.cpp
   trunk/rts/Sim/Units/CommandAI/MobileCAI.cpp
   trunk/rts/Sim/Units/CommandAI/MobileCAI.h
   trunk/rts/Sim/Units/Unit.cpp
   trunk/rts/Sim/Units/UnitLoader.cpp
Log:
 - Make Idling units use the same criteria when selecting units to attack as fighting/patroling units.

 - Create class AAirMoveType that is a parent of CAirMoveType and CTAAirMoveType and inherits from CMoveType. Use it to create new function CMobileCAI::RefuelIfNeeded, which combines refueling code that existed in both CMobileCAI::SlowUpdate and CAirCAI::SlowUpdate.

Modified: trunk/Documentation/changelog.txt
===================================================================
--- trunk/Documentation/changelog.txt	2008-02-05 09:11:03 UTC (rev 5452)
+++ trunk/Documentation/changelog.txt	2008-02-05 10:41:59 UTC (rev 5453)
@@ -1,6 +1,11 @@
 Spring change log
 
+0.76b1+
 
+Spring Engine:
+ - Keep units in various situations from deciding to attack units they
+	shoulden't (noChaseCatagory, neutral, under water without water weapons).
+
 0.76b1
 
 Installer:


Property changes on: trunk/rts
___________________________________________________________________
Name: svn:ignore
   - .settings
.project
.externalToolBuilders
.cproject
Debug

   + .settings
.project
.externalToolBuilders
.cproject
Debug
spring.bmp
patch.diff


Modified: trunk/rts/Game/StartScripts/AirScript.cpp
===================================================================
--- trunk/rts/Game/StartScripts/AirScript.cpp	2008-02-05 09:11:03 UTC (rev 5452)
+++ trunk/rts/Game/StartScripts/AirScript.cpp	2008-02-05 10:41:59 UTC (rev 5453)
@@ -67,7 +67,7 @@
 				u=unitLoader.LoadUnit(FindUnit(armfig_name),float3(1650,300,2100+a*150),0,false,0,NULL);
 			u-&gt;pos.y=350;
 			u-&gt;experience=0.3f;
-			((CAirMoveType*)u-&gt;moveType)-&gt;SetState(CAirMoveType::AIRCRAFT_FLYING);
+			((CAirMoveType*)u-&gt;moveType)-&gt;SetState(AAirMoveType::AIRCRAFT_FLYING);
 			planes.push_back(u-&gt;id);
 			Command c2;
 			c2.id=CMD_MOVE_STATE;
@@ -84,7 +84,7 @@
 
 			if(gs-&gt;randFloat()&lt;0.5f){
 				u=unitLoader.LoadUnit(FindUnit(corvamp_name),float3(3880,300,2100+a*150),1,false,0,NULL);
-				((CAirMoveType*)u-&gt;moveType)-&gt;SetState(CAirMoveType::AIRCRAFT_FLYING);
+				((CAirMoveType*)u-&gt;moveType)-&gt;SetState(AAirMoveType::AIRCRAFT_FLYING);
 			}else{
 				u=unitLoader.LoadUnit(FindUnit(corape_name),float3(3880,300,2100+a*150),1,false,0,NULL);
 			}
@@ -109,7 +109,7 @@
 				u-&gt;pos.y=ground-&gt;GetHeight(1000+(num&amp;1)*5000,2100+num*120)+350;
 				u-&gt;experience=0.3f;
 				u-&gt;speed.x=2.8f;
-				((CAirMoveType*)u-&gt;moveType)-&gt;SetState(CAirMoveType::AIRCRAFT_FLYING);
+				((CAirMoveType*)u-&gt;moveType)-&gt;SetState(AAirMoveType::AIRCRAFT_FLYING);
 				*pi=u-&gt;id;
 
 				Command c;

Added: trunk/rts/Sim/MoveTypes/AAirMoveType.cpp
===================================================================
--- trunk/rts/Sim/MoveTypes/AAirMoveType.cpp	                        (rev 0)
+++ trunk/rts/Sim/MoveTypes/AAirMoveType.cpp	2008-02-05 10:41:59 UTC (rev 5453)
@@ -0,0 +1,54 @@
+#include &quot;StdAfx.h&quot;
+#include &quot;AAirMoveType.h&quot;
+
+
+CR_BIND_DERIVED_INTERFACE(AAirMoveType, CMoveType);
+
+CR_REG_METADATA(AAirMoveType, (
+		CR_MEMBER(goalPos),
+		CR_MEMBER(oldGoalPos),
+		CR_MEMBER(oldpos),
+		CR_MEMBER(reservedLandingPos),
+		CR_MEMBER(wantedHeight),
+		
+		CR_MEMBER(lastColWarning),
+		CR_MEMBER(lastColWarningType),
+		CR_MEMBER(collide),
+		
+		CR_MEMBER(repairBelowHealth),
+		CR_MEMBER(reservedPad),
+		CR_MEMBER(padStatus),
+		CR_MEMBER(autoLand),
+		
+		CR_RESERVED(16)
+		));
+
+AAirMoveType::AAirMoveType(CUnit* unit) :
+	CMoveType(unit),
+	aircraftState(AIRCRAFT_LANDED),
+	autoLand(true),
+	collide(true),
+	goalPos(owner? owner-&gt;pos:float3(0, 0, 0)),
+	lastColWarning(0),
+	lastColWarningType(0),
+	oldpos(0,0,0),
+	oldGoalPos(owner? owner-&gt;pos:float3(0, 0, 0)),
+	padStatus(0),
+	repairBelowHealth(0.30f),
+	reservedLandingPos(-1,-1,-1),
+	reservedPad(0),
+	wantedHeight(80)
+{
+}
+
+AAirMoveType::~AAirMoveType()
+{
+	if (reservedPad) {
+		airBaseHandler-&gt;LeaveLandingPad(reservedPad);
+		reservedPad = 0;
+	}
+}
+/*
+void AAirMoveType::SetState(AircraftState state){
+	assert(false);
+}*/

Added: trunk/rts/Sim/MoveTypes/AAirMoveType.h
===================================================================
--- trunk/rts/Sim/MoveTypes/AAirMoveType.h	                        (rev 0)
+++ trunk/rts/Sim/MoveTypes/AAirMoveType.h	2008-02-05 10:41:59 UTC (rev 5453)
@@ -0,0 +1,45 @@
+#ifndef AAIRMOVETYPE_H_
+#define AAIRMOVETYPE_H_
+
+#include &quot;MoveType.h&quot;
+#include &quot;Sim/Misc/AirBaseHandler.h&quot;
+
+// Supposed to be an abstract class. Do not create an instance of this class.
+// Use either CTAAirMoveType or CAirMoveType instead.
+class AAirMoveType : public CMoveType
+{
+	CR_DECLARE(AAirMoveType);
+public:
+	
+	enum AircraftState{
+		AIRCRAFT_LANDED,
+		AIRCRAFT_FLYING,
+		AIRCRAFT_LANDING,
+		AIRCRAFT_CRASHING,
+		AIRCRAFT_TAKEOFF,
+		AIRCRAFT_HOVERING       // this is what happens to aircraft with dontLand=1 in fbi
+	} aircraftState;
+	
+	AAirMoveType(CUnit* unit);
+	~AAirMoveType();
+	
+	float3 goalPos;
+	float3 oldGoalPos;				//goalpos to resume flying to after landing
+	float3 oldpos;
+	float3 reservedLandingPos;
+	
+	float wantedHeight;
+	
+	bool collide;             //mods can use this to disable plane collisions
+	CUnit* lastColWarning;		//unit found to be dangerously close to our path
+	int lastColWarningType;		//1=generally forward of us,2=directly in path
+	
+	float repairBelowHealth;
+	CAirBaseHandler::LandingPad* reservedPad;
+	int padStatus;						//0 flying toward,1 landing at,2 landed
+	bool autoLand;
+
+	virtual void SetState(AircraftState state) = 0;
+};
+
+#endif /*AAIRMOVETYPE_H_*/

Modified: trunk/rts/Sim/MoveTypes/AirMoveType.cpp
===================================================================
--- trunk/rts/Sim/MoveTypes/AirMoveType.cpp	2008-02-05 09:11:03 UTC (rev 5452)
+++ trunk/rts/Sim/MoveTypes/AirMoveType.cpp	2008-02-05 10:41:59 UTC (rev 5453)
@@ -19,7 +19,7 @@
 #include &quot;Sound.h&quot;
 #include &quot;mmgr.h&quot;
 
-CR_BIND_DERIVED(CAirMoveType, CMoveType, (NULL));
+CR_BIND_DERIVED(CAirMoveType, AAirMoveType, (NULL));
 CR_BIND(CAirMoveType::DrawLine, );
 CR_BIND(CAirMoveType::RudderInfo, );
 
@@ -31,7 +31,6 @@
 
 		CR_MEMBER(loopbackAttack),
 		CR_MEMBER(isFighter),
-		CR_MEMBER(collide),
 
 		CR_MEMBER(wingDrag),
 		CR_MEMBER(wingAngle),
@@ -44,26 +43,19 @@
 		CR_MEMBER(maxPitch),
 		CR_MEMBER(maxSpeed),
 		CR_MEMBER(turnRadius),
-		CR_MEMBER(wantedHeight),
 
 		CR_MEMBER(maxAcc),
 		CR_MEMBER(maxAileron),
 		CR_MEMBER(maxElevator),
 		CR_MEMBER(maxRudder),
 
-		CR_MEMBER(goalPos),
-
 		CR_MEMBER(inSupply),
 
-		CR_MEMBER(reservedLandingPos),
-
 		CR_MEMBER(mySide),
 		CR_MEMBER(crashAileron),
 		CR_MEMBER(crashElevator),
 		CR_MEMBER(crashRudder),
-
-		CR_MEMBER(oldpos),
-		CR_MEMBER(oldGoalPos),
+		
 		CR_MEMBER(oldSlowUpdatePos),
 
 		CR_MEMBER(lines),
@@ -81,14 +73,7 @@
 
 		CR_MEMBER(inefficientAttackTime),
 		CR_MEMBER(exitVector),
-
-		CR_MEMBER(lastColWarning),
-		CR_MEMBER(lastColWarningType),
-
-		CR_MEMBER(repairBelowHealth),
-		CR_MEMBER(reservedPad),
-		CR_MEMBER(padStatus),
-		CR_MEMBER(autoLand),
+		
 		CR_RESERVED(63)
 		));
 
@@ -100,7 +85,7 @@
 
 
 CAirMoveType::CAirMoveType(CUnit* owner):
-	CMoveType(owner),
+	AAirMoveType(owner),
 	wingDrag(0.07f),
 	wingAngle(0.1f),
 	frontToSpeed(0.04f),
@@ -111,30 +96,17 @@
 	maxAileron(0.04f),
 	maxElevator(0.02f),
 	maxRudder(0.01f),
-	goalPos(1000,0,1000),
-	wantedHeight(80),
 	invDrag(0.995f),
-	aircraftState(AIRCRAFT_LANDED),
 	inSupply(0),
 	subState(0),
 	myGravity(0.8f),
 	mySide(1),
 	isFighter(false),
-	collide(true),
-	oldpos(0,0,0),
-	oldGoalPos(0,1,0),
 	maneuver(0),
 	maneuverSubState(0),
 	inefficientAttackTime(0),
-	reservedLandingPos(-1,-1,-1),
 	oldSlowUpdatePos(-1,-1,-1),
-	lastColWarning(0),
-	lastColWarningType(0),
-	repairBelowHealth(0.30f),
-	padStatus(0),
-	reservedPad(0),
-	loopbackAttack(false),
-	autoLand(true)
+	loopbackAttack(false)
 {
 	turnRadius=150;
 	if (owner)owner-&gt;mapSquare+=1;						//to force los recalculation
@@ -163,12 +135,7 @@
 }
 
 CAirMoveType::~CAirMoveType(void)
-{
-	if(reservedPad){
-		airBaseHandler-&gt;LeaveLandingPad(reservedPad);
-		reservedPad=0;
-	}
-}
+{}
 
 
 
@@ -1038,8 +1005,9 @@
 #endif
 }
 
-void CAirMoveType::SetState(CAirMoveType::AircraftState state)
+void CAirMoveType::SetState(AAirMoveType::AircraftState state)
 {
+	assert(state != AIRCRAFT_HOVERING);
 	if(aircraftState==AIRCRAFT_CRASHING || state==aircraftState)
 		return;
 

Modified: trunk/rts/Sim/MoveTypes/AirMoveType.h
===================================================================
--- trunk/rts/Sim/MoveTypes/AirMoveType.h	2008-02-05 09:11:03 UTC (rev 5452)
+++ trunk/rts/Sim/MoveTypes/AirMoveType.h	2008-02-05 10:41:59 UTC (rev 5453)
@@ -4,23 +4,15 @@
 #ifndef __AIR_MOVE_TYPE_H__
 #define __AIR_MOVE_TYPE_H__
 
-#include &quot;MoveType.h&quot;
-#include &quot;Sim/Misc/AirBaseHandler.h&quot;
+#include &quot;AAirMoveType.h&quot;
 
 class CAirMoveType :
-	public CMoveType
+	public AAirMoveType
 {
 	CR_DECLARE(CAirMoveType);
 	CR_DECLARE_SUB(DrawLine);
 	CR_DECLARE_SUB(RudderInfo);
 public:
-	enum AircraftState{
-		AIRCRAFT_LANDED,
-		AIRCRAFT_FLYING,
-		AIRCRAFT_LANDING,
-		AIRCRAFT_CRASHING,
-		AIRCRAFT_TAKEOFF,
-	} aircraftState;
 
 	CAirMoveType(CUnit* owner);
 	~CAirMoveType(void);
@@ -33,7 +25,8 @@
 	void UpdateFlying(float wantedHeight,float engine);
 	void UpdateLanded();
 	void UpdateLanding();
-	void UpdateAirPhysics(float rudder, float aileron, float elevator,float engine,const float3&amp; engineVector);
+	void UpdateAirPhysics(float rudder, float aileron, float elevator,
+			float engine,const float3&amp; engineVector);
 	void SetState(AircraftState state);
 	void UpdateTakeOff(float wantedHeight);
 	void ImpulseAdded(void);
@@ -49,7 +42,6 @@
 
 	bool loopbackAttack;
 	bool isFighter;
-	bool collide;
 
 	float wingDrag;
 	float wingAngle;
@@ -62,26 +54,21 @@
 	float maxPitch;
 	float maxSpeed;
 	float turnRadius;
-	float wantedHeight;
 
 	float maxAcc;
 	float maxAileron;
 	float maxElevator;
 	float maxRudder;
 
-	float3 goalPos;
 
 	float inSupply;
 
-	float3 reservedLandingPos;
 
 	float mySide;		//used while landing
 	float crashAileron;
 	float crashElevator;
 	float crashRudder;
 
-	float3 oldpos;
-	float3 oldGoalPos;
 	float3 oldSlowUpdatePos;
 
 	struct DrawLine {
@@ -108,16 +95,7 @@
 	float lastAileronPos;
 	
 	float inefficientAttackTime;
-	float3 exitVector;							//used by fighters to turn away when closing in on ground targets
-
-	CUnit* lastColWarning;		//unit found to be dangerously close to our path
-	int lastColWarningType;		//1=generally forward of us,2=directly in path
-
-	float repairBelowHealth;
-	CAirBaseHandler::LandingPad* reservedPad;
-	int padStatus;						//0 flying toward,1 landing at,2 landed
-
-	bool autoLand;
+	float3 exitVector;	//used by fighters to turn away when closing in on ground targets
 };
 
 #endif // __AIR_MOVE_TYPE_H__

Modified: trunk/rts/Sim/MoveTypes/TAAirMoveType.cpp
===================================================================
--- trunk/rts/Sim/MoveTypes/TAAirMoveType.cpp	2008-02-05 09:11:03 UTC (rev 5452)
+++ trunk/rts/Sim/MoveTypes/TAAirMoveType.cpp	2008-02-05 10:41:59 UTC (rev 5453)
@@ -17,17 +17,13 @@
 #include &quot;Sim/Units/UnitTypes/TransportUnit.h&quot;
 #include &quot;Sim/Units/CommandAI/CommandAI.h&quot;
 
-CR_BIND_DERIVED(CTAAirMoveType, CMoveType, (NULL));
+CR_BIND_DERIVED(CTAAirMoveType, AAirMoveType, (NULL));
 
 CR_REG_METADATA(CTAAirMoveType, (
 	CR_MEMBER(dontCheckCol),
 
-	CR_MEMBER(goalPos),
-	CR_MEMBER(oldpos),
-	CR_MEMBER(wantedHeight),
 	CR_MEMBER(orgWantedHeight),
 
-	CR_MEMBER(reservedLandingPos),
 	CR_MEMBER(circlingPos),
 	CR_MEMBER(goalDistance),
 	CR_MEMBER(waitCounter),
@@ -54,25 +50,12 @@
 	CR_MEMBER(forceHeadingTo),
 
 	CR_MEMBER(maxDrift),
-
-	CR_MEMBER(lastColWarning),
-	CR_MEMBER(lastColWarningType),
-	CR_MEMBER(collide),
-
-	CR_MEMBER(repairBelowHealth),
-	CR_MEMBER(reservedPad),
-	CR_MEMBER(padStatus),
-	CR_MEMBER(oldGoalPos),
-
-	CR_MEMBER(autoLand),
 	CR_RESERVED(63)
 	));
 
 
 CTAAirMoveType::CTAAirMoveType(CUnit* owner) :
-	CMoveType(owner),
-	aircraftState(AIRCRAFT_LANDED),
-	wantedHeight(80),
+	AAirMoveType(owner),
 	altitudeRate(3.0f),
 	currentBank(0),
 	// we want to take off in direction of factory facing
@@ -81,7 +64,6 @@
 	forceHeading(false),
 	dontCheckCol(false),
 	dontLand(false),
-	collide(true),
 	lastMoveRate(0),
 	waitCounter(0),
 	deltaSpeed(ZeroVector),
@@ -92,19 +74,10 @@
 	flyState(FLY_CRUISING),
 	forceHeadingTo(wantedHeading),
 	goalDistance(1),
-	goalPos(owner? owner-&gt;pos:float3(0, 0, 0)),
-	oldGoalPos(owner? owner-&gt;pos:float3(0, 0, 0)),
 	turnRate(1),
 	wantedSpeed(ZeroVector),
-	lastColWarning(0),
-	lastColWarningType(0),
-	reservedLandingPos(-1, -1, -1),
 	maxDrift(1),
-	repairBelowHealth(0.30f),
-	padStatus(0),
-	reservedPad(0),
-	currentPitch(0),
-	autoLand(true)
+	currentPitch(0)
 {
 	if (owner) {
 		owner-&gt;dontUseWeapons = true;
@@ -113,10 +86,6 @@
 
 CTAAirMoveType::~CTAAirMoveType(void)
 {
-	if (reservedPad) {
-		airBaseHandler-&gt;LeaveLandingPad(reservedPad);
-		reservedPad = 0;
-	}
 }
 
 void CTAAirMoveType::SetGoal(float3 newPos, float distance)
@@ -226,8 +195,13 @@
 	distance -= 15;
 
 	// Ignore the exact same order
-	if ((aircraftState == AIRCRAFT_FLYING) &amp;&amp; (flyState == FLY_CIRCLING || flyState == FLY_ATTACKING) &amp;&amp; ((circlingPos - pos).SqLength2D() &lt; 64) &amp;&amp; (goalDistance == distance))
+	if ((aircraftState == AIRCRAFT_FLYING)
+			&amp;&amp; (flyState == FLY_CIRCLING || flyState == FLY_ATTACKING)
+			&amp;&amp; ((circlingPos - pos).SqLength2D() &lt; 64)
+			&amp;&amp; (goalDistance == distance))
+	{
 		return;
+	}
 
 	circlingPos = pos;
 	goalDistance = distance;
@@ -326,13 +300,15 @@
 
 
 
-// Move the unit around a bit.. and when it gets too far away from goal position it switches to normal flying instead
+// Move the unit around a bit.. and when it gets too far away from goal position
+// it switches to normal flying instead
 void CTAAirMoveType::UpdateHovering()
 {
 	float driftSpeed = owner-&gt;unitDef-&gt;dlHoverFactor;	
 	float3 dir = goalPos - owner-&gt;pos;
 
-	// move towards goal position if it's not immediately behind us when we have more waypoints to get to
+	// move towards goal position if it's not immediately behind us when we have
+	// more waypoints to get to
 	if (aircraftState != AIRCRAFT_LANDING &amp;&amp; (owner-&gt;commandAI-&gt;HasMoreMoveCommands() &amp;&amp;
 		dir.Length2D() &lt; 120) &amp;&amp; (goalPos - owner-&gt;pos).Normalize().distance(dir) &gt; 1) {
 		dir = owner-&gt;frontdir;
@@ -364,7 +340,8 @@
 	}
 
 	// are we there yet?
-	bool closeToGoal = (dir.SqLength2D() &lt; maxDrift * maxDrift) &amp;&amp; (fabs(ground-&gt;GetHeight(pos.x, pos.z) - pos.y + wantedHeight) &lt; maxDrift);
+	bool closeToGoal = (dir.SqLength2D() &lt; maxDrift * maxDrift)
+			&amp;&amp; (fabs(ground-&gt;GetHeight(pos.x, pos.z) - pos.y + wantedHeight) &lt; maxDrift);
 
 	if (flyState == FLY_ATTACKING)
 		closeToGoal = (dir.SqLength2D() &lt; 400);
@@ -373,7 +350,8 @@
 		// pretty close
 		switch (flyState) {
 			case FLY_CRUISING:
-				if (dontLand || (++waitCounter &lt; 55 &amp;&amp; dynamic_cast&lt;CTransportUnit*&gt;(owner)) || !autoLand) {
+				if (dontLand || (++waitCounter &lt; 55 &amp;&amp; dynamic_cast&lt;CTransportUnit*&gt;(owner))
+						|| !autoLand) {
 					// transport aircraft need some time to detect that they can pickup
 					if (dynamic_cast&lt;CTransportUnit*&gt;(owner)) {
 						wantedSpeed = ZeroVector;
@@ -762,7 +740,8 @@
 			if (reservedPad) {
 				CUnit* unit = reservedPad-&gt;GetUnit();
 				float3 relPos = unit-&gt;localmodel-&gt;GetPiecePos(reservedPad-&gt;GetPiece());
-				float3 pos = unit-&gt;pos + unit-&gt;frontdir * relPos.z + unit-&gt;updir * relPos.y + unit-&gt;rightdir * relPos.x;
+				float3 pos = unit-&gt;pos + unit-&gt;frontdir * relPos.z
+						+ unit-&gt;updir * relPos.y + unit-&gt;rightdir * relPos.x;
 
 				if (padStatus == 0) {
 					if (aircraftState != AIRCRAFT_FLYING &amp;&amp; aircraftState != AIRCRAFT_TAKEOFF)
@@ -791,9 +770,12 @@
 
 					owner-&gt;pos = pos;
 					owner-&gt;AddBuildPower(unit-&gt;unitDef-&gt;buildSpeed / 30, unit);
-					owner-&gt;currentFuel = min(owner-&gt;unitDef-&gt;maxFuel, owner-&gt;currentFuel + (owner-&gt;unitDef-&gt;maxFuel / (GAME_SPEED * owner-&gt;unitDef-&gt;refuelTime)));
+					owner-&gt;currentFuel = min(owner-&gt;unitDef-&gt;maxFuel,
+							owner-&gt;currentFuel + (owner-&gt;unitDef-&gt;maxFuel
+									/ (GAME_SPEED * owner-&gt;unitDef-&gt;refuelTime)));
 
-					if (owner-&gt;health &gt;= owner-&gt;maxHealth - 1 &amp;&amp; owner-&gt;currentFuel &gt;= owner-&gt;unitDef-&gt;maxFuel) {
+					if (owner-&gt;health &gt;= owner-&gt;maxHealth - 1
+							&amp;&amp; owner-&gt;currentFuel &gt;= owner-&gt;unitDef-&gt;maxFuel) {
 						airBaseHandler-&gt;LeaveLandingPad(reservedPad);
 						reservedPad = 0;
 						padStatus = 0;
@@ -833,7 +815,8 @@
 	// Turn and bank and move
 	UpdateHeading();
 	UpdateBanking(aircraftState == AIRCRAFT_HOVERING);			// updates dirs
-	owner-&gt;midPos = pos + frontdir * owner-&gt;relMidPos.z + updir * owner-&gt;relMidPos.y + rightdir * owner-&gt;relMidPos.x;
+	owner-&gt;midPos = pos + frontdir * owner-&gt;relMidPos.z + updir * owner-&gt;relMidPos.y
+			+ rightdir * owner-&gt;relMidPos.x;
 
 	// Push other units out of the way
 	if (pos != oldpos &amp;&amp; aircraftState != AIRCRAFT_TAKEOFF &amp;&amp; padStatus == 0) {
@@ -856,15 +839,20 @@
 
 					if ((*ui)-&gt;mass &gt;= 100000 || (*ui)-&gt;immobile) {
 						pos -= dif * (dist - totRad);
-						owner-&gt;midPos = pos + owner-&gt;frontdir * owner-&gt;relMidPos.z + owner-&gt;updir * owner-&gt;relMidPos.y + owner-&gt;rightdir * owner-&gt;relMidPos.x;
+						owner-&gt;midPos = pos + owner-&gt;frontdir * owner-&gt;relMidPos.z
+								+ owner-&gt;updir * owner-&gt;relMidPos.y
+								+ owner-&gt;rightdir * owner-&gt;relMidPos.x;
 						owner-&gt;speed *= 0.99f;
 					} else {
 						float part = owner-&gt;mass / (owner-&gt;mass + (*ui)-&gt;mass);
 						pos -= dif * (dist - totRad) * (1 - part);
-						owner-&gt;midPos = pos + owner-&gt;frontdir * owner-&gt;relMidPos.z + owner-&gt;updir * owner-&gt;relMidPos.y + owner-&gt;rightdir * owner-&gt;relMidPos.x;
+						owner-&gt;midPos = pos + owner-&gt;frontdir * owner-&gt;relMidPos.z
+								+ owner-&gt;updir * owner-&gt;relMidPos.y
+								+ owner-&gt;rightdir * owner-&gt;relMidPos.x;
 						CUnit* u = (CUnit*) (*ui);
 						u-&gt;pos += dif * (dist - totRad) * (part);
-						u-&gt;midPos = u-&gt;pos + u-&gt;frontdir * u-&gt;relMidPos.z + u-&gt;updir * u-&gt;relMidPos.y + u-&gt;rightdir * u-&gt;relMidPos.x;
+						u-&gt;midPos = u-&gt;pos + u-&gt;frontdir * u-&gt;relMidPos.z
+								+ u-&gt;updir * u-&gt;relMidPos.y + u-&gt;rightdir * u-&gt;relMidPos.x;
 						float colSpeed = -owner-&gt;speed.dot(dif) + u-&gt;speed.dot(dif);
 						owner-&gt;speed += dif * colSpeed * (1 - part);
 						u-&gt;speed -= dif * colSpeed * (part);
@@ -895,8 +883,10 @@
 	if (aircraftState != AIRCRAFT_LANDED &amp;&amp; owner-&gt;unitDef-&gt;maxFuel &gt; 0)
 		owner-&gt;currentFuel = max(0.f, owner-&gt;currentFuel - (16.f / GAME_SPEED));
 
-	if (!reservedPad &amp;&amp; aircraftState == AIRCRAFT_FLYING &amp;&amp; owner-&gt;health &lt; owner-&gt;maxHealth * repairBelowHealth) {
-		CAirBaseHandler::LandingPad* lp = airBaseHandler-&gt;FindAirBase(owner, owner-&gt;unitDef-&gt;minAirBasePower);
+	if (!reservedPad &amp;&amp; aircraftState == AIRCRAFT_FLYING 
+			&amp;&amp; owner-&gt;health &lt; owner-&gt;maxHealth * repairBelowHealth) {
+		CAirBaseHandler::LandingPad* lp = airBaseHandler-&gt;FindAirBase(
+				owner, owner-&gt;unitDef-&gt;minAirBasePower);
 
 		if (lp) {
 			AddDeathDependence(lp);
@@ -1003,7 +993,8 @@
 		if (forwardDif.SqLength() &lt; dist * dist) {
 			float frontLength = forwardDif.Length();
 			float3 ortoDif = dif - forwardDif;
-			// note: the radius is multiplied by two since we rely on aircraft having small spheres (see unitloader)
+			// note: the radius is multiplied by two since we rely on aircraft
+			// having small spheres (see unitloader)
 			float minOrtoDif = ((*ui)-&gt;radius + owner-&gt;radius) * 2 + frontLength * 0.05f + 5;
 
 			if (ortoDif.SqLength() &lt; minOrtoDif * minOrtoDif) {

Modified: trunk/rts/Sim/MoveTypes/TAAirMoveType.h
===================================================================
--- trunk/rts/Sim/MoveTypes/TAAirMoveType.h	2008-02-05 09:11:03 UTC (rev 5452)
+++ trunk/rts/Sim/MoveTypes/TAAirMoveType.h	2008-02-05 10:41:59 UTC (rev 5453)
@@ -1,23 +1,13 @@
 #ifndef TAAIRMOVETYPE_H
 #define TAAIRMOVETYPE_H
 
-#include &quot;MoveType.h&quot;
-#include &quot;Sim/Misc/AirBaseHandler.h&quot;
+#include &quot;AAirMoveType.h&quot;
 
 class CTAAirMoveType :
-	public CMoveType
+	public AAirMoveType
 {
 	CR_DECLARE(CTAAirMoveType);
 public:
-	enum AircraftState{
-		AIRCRAFT_LANDED,
-		AIRCRAFT_FLYING,
-		AIRCRAFT_LANDING,
-		AIRCRAFT_CRASHING,
-		AIRCRAFT_TAKEOFF,
-		AIRCRAFT_HOVERING       // this is what happens to aircraft with dontLand=1 in fbi
-	} aircraftState;
-
 	enum FlyState {
 		FLY_CRUISING,
 		FLY_CIRCLING,
@@ -25,15 +15,12 @@
 		FLY_LANDING
 	} flyState;
 
-	bool dontCheckCol;			//needed to get transport close enough to what is going to be transported, better way ?
-	bool collide;             //mods can use this to disable plane collisions
+	//needed to get transport close enough to what is going to be transported.
+	//better way ?
+	bool dontCheckCol;
 
-	float3 goalPos;
-	float3 oldpos;
-	float wantedHeight;
 	float orgWantedHeight;	//to reset altitude back
 	
-	float3 reservedLandingPos;
 	float3 circlingPos;
 	float goalDistance;			//Used when circling something
 	int waitCounter;			//need to pause between circling steps
@@ -63,15 +50,8 @@
 
 	float maxDrift;
 
-	CUnit* lastColWarning;		//unit found to be dangerously close to our path
-	int lastColWarningType;		//1=generally forward of us,2=directly in path
 
-	float repairBelowHealth;
-	CAirBaseHandler::LandingPad* reservedPad;
-	int padStatus;						//0 flying toward,1 landing at,2 landed
-	float3 oldGoalPos;				//goalpos to resume flying to after landing
 
-	bool autoLand;
 
 	CTAAirMoveType(CUnit* owner);
 	~CTAAirMoveType(void);

Modified: trunk/rts/Sim/Units/COB/CobInstance.cpp
===================================================================
--- trunk/rts/Sim/Units/COB/CobInstance.cpp	2008-02-05 09:11:03 UTC (rev 5452)
+++ trunk/rts/Sim/Units/COB/CobInstance.cpp	2008-02-05 10:41:59 UTC (rev 5453)
@@ -1599,11 +1599,11 @@
 		case CRASHING: {
 			if(dynamic_cast&lt;CAirMoveType*&gt;(unit-&gt;moveType)){
 				if(!!param){
-					((CAirMoveType*)unit-&gt;moveType)-&gt;SetState(CAirMoveType::AIRCRAFT_CRASHING);
+					((CAirMoveType*)unit-&gt;moveType)-&gt;SetState(AAirMoveType::AIRCRAFT_CRASHING);
 				} else {
 					unit-&gt;crashing=false;
-					((CAirMoveType*)unit-&gt;moveType)-&gt;aircraftState=CAirMoveType::AIRCRAFT_TAKEOFF;
-					((CAirMoveType*)unit-&gt;moveType)-&gt;SetState(CAirMoveType::AIRCRAFT_FLYING);
+					((CAirMoveType*)unit-&gt;moveType)-&gt;aircraftState=AAirMoveType::AIRCRAFT_TAKEOFF;
+					((CAirMoveType*)unit-&gt;moveType)-&gt;SetState(AAirMoveType::AIRCRAFT_FLYING);
 				}
 			}
 			break;

Modified: trunk/rts/Sim/Units/CommandAI/AirCAI.cpp
===================================================================
--- trunk/rts/Sim/Units/CommandAI/AirCAI.cpp	2008-02-05 09:11:03 UTC (rev 5452)
+++ trunk/rts/Sim/Units/CommandAI/AirCAI.cpp	2008-02-05 10:41:59 UTC (rev 5453)
@@ -262,63 +262,13 @@
 	CAirMoveType* myPlane=(CAirMoveType*) owner-&gt;moveType;
 
 	if(owner-&gt;unitDef-&gt;maxFuel &gt; 0){
-		if(myPlane-&gt;reservedPad){
-			return;
-		}else{
-			if(owner-&gt;currentFuel &lt;= 0){
-				owner-&gt;userAttackGround=false;
-				owner-&gt;userTarget=0;
-				inCommand=false;
-
-				CAirBaseHandler::LandingPad* lp = airBaseHandler-&gt;FindAirBase(
-					owner, owner-&gt;unitDef-&gt;minAirBasePower);
-				if(lp){
-					myPlane-&gt;AddDeathDependence(lp);
-					myPlane-&gt;reservedPad = lp;
-					myPlane-&gt;padStatus = 0;
-					myPlane-&gt;oldGoalPos = myPlane-&gt;goalPos;
-					return;
-				}
-				float3 landingPos = airBaseHandler-&gt;FindClosestAirBasePos(
-					owner, owner-&gt;unitDef-&gt;minAirBasePower);
-				if(landingPos != ZeroVector &amp;&amp; owner-&gt;pos.distance2D(landingPos) &gt; 300){
-					if(myPlane-&gt;aircraftState == CAirMoveType::AIRCRAFT_LANDED
-							&amp;&amp; owner-&gt;pos.distance2D(landingPos) &gt; 800) {
-						myPlane-&gt;SetState(CAirMoveType::AIRCRAFT_TAKEOFF);
-					}
-					myPlane-&gt;goalPos = landingPos;
-				} else {
-					if(myPlane-&gt;aircraftState == CAirMoveType::AIRCRAFT_FLYING)
-						myPlane-&gt;SetState(CAirMoveType::AIRCRAFT_LANDING);
-				}
-				return;
-			}
-			if(owner-&gt;currentFuel &lt; myPlane-&gt;repairBelowHealth * owner-&gt;unitDef-&gt;maxFuel){
-				if(commandQue.empty() || commandQue.front().id == CMD_PATROL){
-					CAirBaseHandler::LandingPad* lp =
-						airBaseHandler-&gt;FindAirBase(owner, owner-&gt;unitDef-&gt;minAirBasePower);
-					if(lp){
-						owner-&gt;userAttackGround=false;
-						owner-&gt;userTarget=0;
-						inCommand=false;
-						myPlane-&gt;AddDeathDependence(lp);
-						myPlane-&gt;reservedPad=lp;
-						myPlane-&gt;padStatus=0;
-						myPlane-&gt;oldGoalPos=myPlane-&gt;goalPos;
-						if(myPlane-&gt;aircraftState == CAirMoveType::AIRCRAFT_LANDED){
-							myPlane-&gt;SetState(CAirMoveType::AIRCRAFT_TAKEOFF);
-						}
-						return;
-					}
-				}
-			}
-		}
+		RefuelIfNeeded(myPlane);
 	}
 
 	if(commandQue.empty()){
-		if(myPlane-&gt;aircraftState == CAirMoveType::AIRCRAFT_FLYING
+		if(myPlane-&gt;aircraftState == AAirMoveType::AIRCRAFT_FLYING
 			&amp;&amp; !owner-&gt;unitDef-&gt;DontLand() &amp;&amp; myPlane-&gt;autoLand){
-			myPlane-&gt;SetState(CAirMoveType::AIRCRAFT_LANDING);
+			myPlane-&gt;SetState(AAirMoveType::AIRCRAFT_LANDING);
 		}
 
 		if(owner-&gt;unitDef-&gt;canAttack &amp;&amp; owner-&gt;fireState&gt;=2
@@ -327,7 +277,7 @@
 				float testRad=1000 * owner-&gt;moveState;
 				CUnit* enemy=helper-&gt;GetClosestEnemyAircraft(
 					owner-&gt;pos + (owner-&gt;speed * 10), testRad, owner-&gt;allyteam);
-				if(enemy &amp;&amp; !enemy-&gt;crashing){
+				if(IsValidTarget(enemy)) {
 					Command nc;
 					nc.id = CMD_ATTACK;
 					nc.params.push_back(enemy-&gt;id);
@@ -340,9 +290,7 @@
 			float testRad = 500 * owner-&gt;moveState;
 			CUnit* enemy = helper-&gt;GetClosestEnemyUnit(
 				owner-&gt;pos + (owner-&gt;speed * 20), testRad, owner-&gt;allyteam);
-			if(enemy &amp;&amp; (owner-&gt;hasUWWeapons || !enemy-&gt;isUnderWater)
-					&amp;&amp; !enemy-&gt;crashing
-					&amp;&amp; (myPlane-&gt;isFighter || !enemy-&gt;unitDef-&gt;canfly)){
+			if(IsValidTarget(enemy)) {
 				Command nc;
 				nc.id = CMD_ATTACK;
 				nc.params.push_back(enemy-&gt;id);
@@ -358,19 +306,19 @@
 	Command&amp; c = commandQue.front();
 
 	if (c.id == CMD_WAIT) {
-		if ((myPlane-&gt;aircraftState == CAirMoveType::AIRCRAFT_FLYING)
+		if ((myPlane-&gt;aircraftState == AAirMoveType::AIRCRAFT_FLYING)
 		    &amp;&amp; !owner-&gt;unitDef-&gt;DontLand() &amp;&amp; myPlane-&gt;autoLand) {
-			myPlane-&gt;SetState(CAirMoveType::AIRCRAFT_LANDING);
+			myPlane-&gt;SetState(AAirMoveType::AIRCRAFT_LANDING);
 		}
 		return;
 	}
 
 	if (c.id != CMD_STOP) {
-		if (myPlane-&gt;aircraftState == CAirMoveType::AIRCRAFT_LANDED) {
-			myPlane-&gt;SetState(CAirMoveType::AIRCRAFT_TAKEOFF);
+		if (myPlane-&gt;aircraftState == AAirMoveType::AIRCRAFT_LANDED) {
+			myPlane-&gt;SetState(AAirMoveType::AIRCRAFT_TAKEOFF);
 		}
-		if (myPlane-&gt;aircraftState == CAirMoveType::AIRCRAFT_LANDING) {
-			myPlane-&gt;SetState(CAirMoveType::AIRCRAFT_FLYING);
+		if (myPlane-&gt;aircraftState == AAirMoveType::AIRCRAFT_LANDING) {
+			myPlane-&gt;SetState(AAirMoveType::AIRCRAFT_FLYING);
 		}
 	}
 
@@ -635,7 +583,7 @@
 	const float3 pos(c.params[0], c.params[1], c.params[2]);
 	const float radius = c.params[3];
 	if(inCommand){
-		if(myPlane-&gt;aircraftState == CAirMoveType::AIRCRAFT_LANDED)
+		if(myPlane-&gt;aircraftState == AAirMoveType::AIRCRAFT_LANDED)
 			inCommand = false;
 		if(orderTarget &amp;&amp; orderTarget-&gt;pos.distance2D(pos) &gt; radius){
 			inCommand = false;
@@ -657,7 +605,7 @@
 		}
 	} else {
 		owner-&gt;commandShotCount = -1;
-		if(myPlane-&gt;aircraftState != CAirMoveType::AIRCRAFT_LANDED){
+		if(myPlane-&gt;aircraftState != AAirMoveType::AIRCRAFT_LANDED){
 			inCommand = true;
 			std::vector&lt;int&gt; eu;
 			helper-&gt;GetEnemyUnits(pos, radius, owner-&gt;allyteam, eu);
@@ -804,9 +752,9 @@
 void CAirCAI::StopMove()
 {
 	CAirMoveType* myPlane = (CAirMoveType*)owner-&gt;moveType;
-	if((myPlane-&gt;aircraftState == CAirMoveType::AIRCRAFT_FLYING)
+	if((myPlane-&gt;aircraftState == AAirMoveType::AIRCRAFT_FLYING)
 	   &amp;&amp; !owner-&gt;unitDef-&gt;DontLand() &amp;&amp; myPlane-&gt;autoLand) {
-		myPlane-&gt;SetState(CAirMoveType::AIRCRAFT_LANDING);
+		myPlane-&gt;SetState(AAirMoveType::AIRCRAFT_LANDING);
 	}
 }
 
@@ -819,8 +767,8 @@
 void CAirCAI::BuggerOff(float3 pos, float radius)
 {
 	CAirMoveType* myPlane=(CAirMoveType*)owner-&gt;moveType;
-	if(myPlane-&gt;aircraftState==CAirMoveType::AIRCRAFT_LANDED){
-		myPlane-&gt;SetState(CAirMoveType::AIRCRAFT_TAKEOFF);
+	if(myPlane-&gt;aircraftState==AAirMoveType::AIRCRAFT_LANDED){
+		myPlane-&gt;SetState(AAirMoveType::AIRCRAFT_TAKEOFF);
 	}
 }
 

Modified: trunk/rts/Sim/Units/CommandAI/MobileCAI.cpp
===================================================================
--- trunk/rts/Sim/Units/CommandAI/MobileCAI.cpp	2008-02-05 09:11:03 UTC (rev 5452)
+++ trunk/rts/Sim/Units/CommandAI/MobileCAI.cpp	2008-02-05 10:41:59 UTC (rev 5453)
@@ -259,62 +259,71 @@
 	CCommandAI::GiveAllowedCommand(c);
 }
 
-void CMobileCAI::SlowUpdate()
+void CMobileCAI::RefuelIfNeeded(AAirMoveType* myPlane)
 {
-	if(owner-&gt;unitDef-&gt;maxFuel&gt;0 &amp;&amp; dynamic_cast&lt;CTAAirMoveType*&gt;(owner-&gt;moveType)){
-		CTAAirMoveType* myPlane=(CTAAirMoveType*)owner-&gt;moveType;
-		if(myPlane-&gt;reservedPad){
+	if(myPlane-&gt;reservedPad){
+		return;
+	} else {
+		if(owner-&gt;currentFuel &lt;= 0){
+			StopMove();
+			owner-&gt;userAttackGround=false;
+			owner-&gt;userTarget=0;
+			inCommand=false;
+			CAirBaseHandler::LandingPad* lp = airBaseHandler-&gt;FindAirBase(
+				owner, owner-&gt;unitDef-&gt;minAirBasePower);
+			if(lp){
+				myPlane-&gt;AddDeathDependence(lp);
+				myPlane-&gt;reservedPad = lp;
+				myPlane-&gt;padStatus = 0;
+				myPlane-&gt;oldGoalPos = myPlane-&gt;goalPos;
+				return;
+			}
+			float3 landingPos = airBaseHandler-&gt;FindClosestAirBasePos(
+				owner, owner-&gt;unitDef-&gt;minAirBasePower);
+			if(landingPos != ZeroVector &amp;&amp; owner-&gt;pos.distance2D(landingPos) &gt; 300){
+				if(myPlane-&gt;aircraftState == AAirMoveType::AIRCRAFT_LANDED
+						&amp;&amp; owner-&gt;pos.distance2D(landingPos) &gt; 800) {
+					myPlane-&gt;SetState(AAirMoveType::AIRCRAFT_TAKEOFF);
+				}
+				StopMove();
+				SetGoal(landingPos,owner-&gt;pos);
+				//myPlane-&gt;goalPos = landingPos;
+			} else {
+				if(myPlane-&gt;aircraftState == AAirMoveType::AIRCRAFT_FLYING)
+					myPlane-&gt;SetState(AAirMoveType::AIRCRAFT_LANDING);
+			}
 			return;
-		} else {
-			if(owner-&gt;currentFuel &lt;= 0){
-				StopMove();
-				owner-&gt;userAttackGround=false;
-				owner-&gt;userTarget=0;
-				inCommand=false;
-				CAirBaseHandler::LandingPad* lp=airBaseHandler-&gt;FindAirBase(owner,
-						owner-&gt;unitDef-&gt;minAirBasePower);
+		}
+		if(owner-&gt;currentFuel &lt; myPlane-&gt;repairBelowHealth * owner-&gt;unitDef-&gt;maxFuel){
+			if(commandQue.empty() || commandQue.front().id == CMD_PATROL){
+				CAirBaseHandler::LandingPad* lp =
+					airBaseHandler-&gt;FindAirBase(owner, owner-&gt;unitDef-&gt;minAirBasePower);
 				if(lp){
+					StopMove();
+					owner-&gt;userAttackGround=false;
+					owner-&gt;userTarget=0;
+					inCommand=false;
 					myPlane-&gt;AddDeathDependence(lp);
 					myPlane-&gt;reservedPad=lp;
 					myPlane-&gt;padStatus=0;
 					myPlane-&gt;oldGoalPos=myPlane-&gt;goalPos;
+					if(myPlane-&gt;aircraftState == AAirMoveType::AIRCRAFT_LANDED){
+						myPlane-&gt;SetState(AAirMoveType::AIRCRAFT_TAKEOFF);
+					}
 					return;
 				}
-				float3 landingPos = airBaseHandler-&gt;FindClosestAirBasePos(owner,
-						owner-&gt;unitDef-&gt;minAirBasePower);
-				if(landingPos != ZeroVector &amp;&amp; owner-&gt;pos.distance2D(landingPos) &gt; 300){
-					inCommand=false;
-					StopMove();
-					SetGoal(landingPos,owner-&gt;pos);
-				} else {
-					if(myPlane-&gt;aircraftState == CTAAirMoveType::AIRCRAFT_FLYING)
-						myPlane-&gt;SetState(CTAAirMoveType::AIRCRAFT_LANDING);
-				}
-				return;
 			}
-			if(owner-&gt;currentFuel &lt; myPlane-&gt;repairBelowHealth*owner-&gt;unitDef-&gt;maxFuel){
-				if(commandQue.empty() || commandQue.front().id==CMD_PATROL){
-					CAirBaseHandler::LandingPad* lp=airBaseHandler-&gt;FindAirBase(owner,
-							owner-&gt;unitDef-&gt;minAirBasePower);
-					if(lp){
-						StopMove();
-						owner-&gt;userAttackGround=false;
-						owner-&gt;userTarget=0;
-						inCommand=false;
-						myPlane-&gt;AddDeathDependence(lp);
-						myPlane-&gt;reservedPad=lp;
-						myPlane-&gt;padStatus=0;
-						myPlane-&gt;oldGoalPos=myPlane-&gt;goalPos;
-						if(myPlane-&gt;aircraftState==CTAAirMoveType::AIRCRAFT_LANDED){
-							myPlane-&gt;SetState(CTAAirMoveType::AIRCRAFT_TAKEOFF);
-						}
-						return;
-					}
-				}
-			}
 		}
 	}
+}
 
+void CMobileCAI::SlowUpdate()
+{
+	if(owner-&gt;unitDef-&gt;maxFuel&gt;0 &amp;&amp; dynamic_cast&lt;AAirMoveType*&gt;(owner-&gt;moveType)){
+		AAirMoveType* myPlane=(AAirMoveType*)owner-&gt;moveType;
+		RefuelIfNeeded(myPlane);
+	}
+
 	if(!commandQue.empty() &amp;&amp; commandQue.front().timeOut &lt; gs-&gt;frameNum){
 		StopMove();
 		FinishCommand();
@@ -1028,7 +1037,7 @@
 	    (!owner-&gt;haveTarget || owner-&gt;weapons[0]-&gt;onlyForward)) {
 		CUnit* u = helper-&gt;GetClosestEnemyUnit(owner-&gt;pos,
 				owner-&gt;maxRange + 150 * owner-&gt;moveState * owner-&gt;moveState, owner-&gt;allyteam);
-		if(u &amp;&amp; !(owner-&gt;unitDef-&gt;noChaseCategory &amp; u-&gt;category) &amp;&amp; !u-&gt;neutral) {
+		if(IsValidTarget(u)) {
 			Command c;
 			c.id=CMD_ATTACK;
 			c.options=INTERNAL_ORDER;

Modified: trunk/rts/Sim/Units/CommandAI/MobileCAI.h
===================================================================
--- trunk/rts/Sim/Units/CommandAI/MobileCAI.h	2008-02-05 09:11:03 UTC (rev 5452)
+++ trunk/rts/Sim/Units/CommandAI/MobileCAI.h	2008-02-05 10:41:59 UTC (rev 5453)
@@ -2,6 +2,7 @@
 #define MOBILECAI_H
 
 #include &quot;CommandAI.h&quot;
+#include &quot;Sim/MoveTypes/AAirMoveType.h&quot;
 
 class CMobileCAI :
 	public CCommandAI
@@ -29,6 +30,8 @@
 	void ExecuteAttack(Command &amp;c);
 	void ExecuteDGun(Command &amp;c);
 	void ExecuteStop(Command &amp;c);
+	
+	void RefuelIfNeeded(AAirMoveType* myPlane);
 
 	virtual void Execute();
 	virtual void ExecuteGuard(Command &amp;c);

Modified: trunk/rts/Sim/Units/Unit.cpp
===================================================================
--- trunk/rts/Sim/Units/Unit.cpp	2008-02-05 09:11:03 UTC (rev 5452)
+++ trunk/rts/Sim/Units/Unit.cpp	2008-02-05 10:41:59 UTC (rev 5453)
@@ -1896,7 +1896,7 @@
 
 	if (dynamic_cast&lt;CAirMoveType*&gt;(moveType) &amp;&amp; !beingBuilt){
 		if (!selfDestruct &amp;&amp; !reclaimed &amp;&amp; gs-&gt;randFloat()&gt;recentDamage*0.7f/maxHealth+0.2f) {
-			((CAirMoveType*)moveType)-&gt;SetState(CAirMoveType::AIRCRAFT_CRASHING);
+			((CAirMoveType*)moveType)-&gt;SetState(AAirMoveType::AIRCRAFT_CRASHING);
 			health = maxHealth * 0.5f;
 			return;
 		}

Modified: trunk/rts/Sim/Units/UnitLoader.cpp
===================================================================
--- trunk/rts/Sim/Units/UnitLoader.cpp	2008-02-05 09:11:03 UTC (rev 5452)
+++ trunk/rts/Sim/Units/UnitLoader.cpp	2008-02-05 10:41:59 UTC (rev 5453)
@@ -279,7 +279,7 @@
 			mt-&gt;maxBank = ud-&gt;maxBank;
 			mt-&gt;maxPitch = ud-&gt;maxPitch;
 			mt-&gt;turnRadius = ud-&gt;turnRadius;
-			mt-&gt;wantedHeight = ud-&gt;wantedHeight*1.5f+(gs-&gt;randFloat()-0.3f)*15*(mt-&gt;isFighter?2:1);;
+			mt-&gt;wantedHeight = ud-&gt;wantedHeight*1.5f+(gs-&gt;randFloat()-0.3f)*15*(mt-&gt;isFighter?2:1);
 
 			mt-&gt;maxAcc = ud-&gt;maxAcc;
 			mt-&gt;maxAileron = ud-&gt;maxAileron;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000259.html">[Taspring-linux-commit] r5452 - trunk/Lobby/TASServer
</A></li>
	<LI>Next message: <A HREF="000261.html">[Taspring-linux-commit] r5454 - trunk/AI/Global/KAIK-0.13
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#260">[ date ]</a>
              <a href="thread.html#260">[ thread ]</a>
              <a href="subject.html#260">[ subject ]</a>
              <a href="author.html#260">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
