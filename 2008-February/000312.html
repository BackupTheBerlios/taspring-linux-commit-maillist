<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r5505 - in trunk/rts: System build/kdevelop
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-February/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5505%20-%20in%20trunk/rts%3A%20System%20build/kdevelop&In-Reply-To=%3CE1JQAP7-0002jn-Vv%40proserver.fnord.lan%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000311.html">
   <LINK REL="Next"  HREF="000313.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r5505 - in trunk/rts: System build/kdevelop</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5505%20-%20in%20trunk/rts%3A%20System%20build/kdevelop&In-Reply-To=%3CE1JQAP7-0002jn-Vv%40proserver.fnord.lan%3E"
       TITLE="[Taspring-linux-commit] r5505 - in trunk/rts: System build/kdevelop">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Sat Feb 16 00:55:41 CET 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000311.html">[Taspring-linux-commit] r5504 - in trunk/Lobby/AFLobby: . NSIS	src/aflobby
</A></li>
        <LI>Next message: <A HREF="000313.html">[Taspring-linux-commit] r5506 - in trunk/AI/Global/NTai/AI/NTai:	Core Tasks Units
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#312">[ date ]</a>
              <a href="thread.html#312">[ thread ]</a>
              <a href="subject.html#312">[ subject ]</a>
              <a href="author.html#312">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: Auswaschbar
Date: 2008-02-16 00:55:41 +0100 (Sat, 16 Feb 2008)
New Revision: 5505

Added:
   trunk/rts/System/SpringApp.cpp
   trunk/rts/System/SpringApp.h
Modified:
   trunk/rts/System/Main.cpp
   trunk/rts/build/kdevelop/rts.kdevelop
Log:
* gave SpringApp its own .h/.cpp file


Modified: trunk/rts/System/Main.cpp
===================================================================
--- trunk/rts/System/Main.cpp	2008-02-15 23:16:09 UTC (rev 5504)
+++ trunk/rts/System/Main.cpp	2008-02-15 23:55:41 UTC (rev 5505)
@@ -6,1084 +6,22 @@
  * everything else
  */
 #include &quot;StdAfx.h&quot;
-#include &lt;algorithm&gt;
-#include &lt;string&gt;
-#include &lt;time.h&gt;
-#include &lt;float.h&gt;
-#include &quot;bitops.h&quot;
 #include &quot;FPUCheck.h&quot;
 #include &quot;LogOutput.h&quot;
-#include &quot;NetProtocol.h&quot;
-#include &quot;MouseInput.h&quot;
-#include &quot;FileSystem/ArchiveScanner.h&quot;
-#include &quot;FileSystem/VFSHandler.h&quot;
-#include &quot;Game/Game.h&quot;
-#include &quot;Game/GameSetup.h&quot;
-#include &quot;Game/GameVersion.h&quot;
-#include &quot;Game/PreGame.h&quot;
-#include &quot;Game/StartScripts/ScriptHandler.h&quot;
-#include &quot;Game/Team.h&quot;
-#include &quot;Game/UI/KeyBindings.h&quot;
-#include &quot;Game/UI/MouseHandler.h&quot;
-#include &quot;Lua/LuaGaia.h&quot;
-#include &quot;Lua/LuaRules.h&quot;
-#include &quot;Lua/LuaOpenGL.h&quot;
-#include &quot;Platform/BaseCmd.h&quot;
-#include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;Platform/errorhandler.h&quot;
-#include &quot;Platform/FileSystem.h&quot;
-#include &quot;Rendering/GLContext.h&quot;
-#include &quot;Rendering/glFont.h&quot;
-#include &quot;Rendering/VerticalSync.h&quot;
-#include &quot;Rendering/GL/myGL.h&quot;
-#include &quot;Rendering/Textures/NamedTextures.h&quot;
-#include &quot;Rendering/Textures/TAPalette.h&quot;
-#include &quot;creg/creg.h&quot;
-#include &quot;mmgr.h&quot;
 
-#include &lt;GL/glu.h&gt;  // Header File For The GLu32 Library
-                     // Must come after Rendering/GL/myGL.h for GLEW
+#include &quot;SpringApp.h&quot;
 
 #include &lt;SDL.h&gt;     // Must come after Game/UI/MouseHandler.h for ButtonPress
-#include &lt;SDL_main.h&gt;
-#include &lt;SDL_syswm.h&gt;
 
-#include &lt;assert.h&gt;
-#include &lt;signal.h&gt;
-
 #ifdef WIN32
-#ifdef __GNUC__
-	#include &quot;Platform/Win/CrashHandler.h&quot;
-#else
-	// FIXME either remove totally or reintegrate properly
-	// so it can be used on MinGW too?
-	//#include &quot;CrashRpt.h&quot;
-	//#pragma comment(lib,&quot;../../../CrashRpt/lib/CrashRpt.lib&quot;)
+#include &quot;Platform/Win/win32.h&quot;
+#include &lt;winreg.h&gt;
+#include &lt;direct.h&gt;
+#include &quot;Platform/Win/seh.h&quot;
 #endif
-	#include &quot;Platform/Win/win32.h&quot;
-	#include &lt;winreg.h&gt;
-	#include &lt;direct.h&gt;
-	#include &quot;Platform/Win/seh.h&quot;
-#endif // WIN32
-#include &quot;Sim/Projectiles/ExplosionGenerator.h&quot;
 
 
-#ifdef WIN32
-/**
- * Win32 only: command line passed to WinMain() (not including exe filename)
- */
-static const char *win_lpCmdLine=0;
-#endif
-
-/**
- * @brief current active controller
- *
- * Pointer to the currently active controller
- * (could be a PreGame, could be a Game, etc)
- */
-CGameController* activeController=0;
-
-/**
- * @brief global quit
- *
- * Global boolean indicating whether the user
- * wants to quit
- */
-bool globalQuit = false;
-
-/**
- * @brief keys
- *
- * Array of possible keys, and which are being pressed
- */
-Uint8 *keys;
-
-/**
- * @brief fullscreen
- *
- * Whether or not the game is running in fullscreen
- */
-bool fullscreen;
-
-/**
- * @brief xres default
- *
- * Defines the default X resolution as 1024
- */
-#define XRES_DEFAULT 1024
-
-/**
- * @brief yres default
- *
- * Defines the default Y resolution as 768
- */
-#define YRES_DEFAULT 768
-
-/**
- * @brief Spring App
- *
- * Main Spring application class launched by main()
- */
-class SpringApp
-{
-public:
-	SpringApp (); 					//!&lt; Constructor
-	~SpringApp (); 					//!&lt; Destructor
-
-	int Run(int argc, char *argv[]); 		//!&lt; Run game loop
-
-protected:
-	bool Initialize (); 	//!&lt; Initialize app
-	void CheckCmdLineFile (int argc,char *argv[]); 	//!&lt; Check command line for files
-	void ParseCmdLine(); 				//!&lt; Parse command line
-	void CreateGameSetup (); 			//!&lt; Creates GameSetup
-	bool InitWindow (const char* title); 		//!&lt; Initializes window
-	void InitOpenGL (); 				//!&lt; Initializes OpenGL
-	bool SetSDLVideoMode(); 			//!&lt; Sets SDL video mode
-	void Shutdown (); 				//!&lt; Shuts down application
-	int Update (); 					//!&lt; Run simulation and draw
-	void UpdateSDLKeys (); 				//!&lt; Update SDL key array
-	bool GetDisplayGeometry();
-	void SetupViewportGeometry();
-
-	/**
-	 * @brief command line
-	 *
-	 * Pointer to instance of commandline parser
-	 */
-	BaseCmd *cmdline;
-
-	/**
-	 * @brief demofile
-	 *
-	 * Name of a demofile
-	 */
-	string demofile;
-
-	/**
-	 * @brief savefile
-	 *
-	 * Name of a savefile
-	 */
-	string savefile;
-
-	/**
-	 * @brief startscript
-	 *
-	 * Name of a start script
-	 */
-	string startscript;
-
-	/**
-	 * @brief screen width
-	 *
-	 * Game screen width
-	 */
-	int screenWidth;
-
-	/**
-	 * @brief screen height
-	 *
-	 * Game screen height
-	 */
-	int screenHeight;
-
-	/**
-	 * @brief FSAA
-	 *
-	 * Level of fullscreen anti-aliasing
-	 */
-	bool FSAA;
-
-	int2 prevMousePos;
-private:
-	static void SigAbrtHandler(int unused);
-};
-
-void SpringApp::SigAbrtHandler(int unused)
-{
-	// cause an exception if on windows
-	// TODO FIXME do a proper stacktrace dump here
-	#ifdef WIN32
-	*((int*)(0)) = 0;
-	#endif
-}
-
-/**
- * Initializes SpringApp variables
- */
-SpringApp::SpringApp ()
-{
-	cmdline = 0;
-	screenWidth = screenHeight = 0;
-	keys = 0;
-
-	fullscreen = true;
-	FSAA = false;
-
-	signal(SIGABRT, SigAbrtHandler);
-}
-
-/**
- * Destroys SpringApp variables
- */
-SpringApp::~SpringApp()
-{
-	if (cmdline) delete cmdline;
-	if (keys) delete[] keys;
-
-	creg::System::FreeClasses ();
-}
-
-#ifdef _CRASHRPT_H_
-/**
- * @brief crash callback
- * @return whether callback was successful
- * @param crState current state
- *
- * Callback function executed when
- * game crashes (win32 only)
- */
-bool crashCallback(void* crState)
-{
-	logOutput.RemoveAllSubscribers();
-	logOutput.Print(&quot;Spring has crashed&quot;);
-
-	// Stop writing to infolog.txt
-	logOutput.End();
-
-	// FIXME needs to be updated for new netcode
-	//bool wasRecording = false;
-	//if (net-&gt;recordDemo) {
-	//	delete net-&gt;recordDemo;
-	//	wasRecording = true;
-	//}
-
-	AddFile(&quot;infolog.txt&quot;, &quot;Spring information log&quot;);
-
-	//if (wasRecording)
-	//	AddFile(net-&gt;demoName.c_str(), &quot;Spring game demo&quot;);
-
-	SDL_Quit();
-
-	return true;
-}
-#endif
-
-/**
- * @brief Initializes the SpringApp instance
- * @return whether initialization was successful
- */
-bool SpringApp::Initialize ()
-{
-	logOutput.SetMirrorToStdout(!!configHandler.GetInt(&quot;StdoutDebug&quot;,0));
-
-	// Initialize class system
-	creg::System::InitializeClasses ();
-
-	// Initialize crash reporting
-#ifdef _WIN32
-#if defined(_CRASHRPT_H_)
-	Install( (LPGETLOGFILE) crashCallback, &quot;<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">taspringcrash at clan-sy.com</A>&quot;, &quot;Spring Crashreport&quot;);
-	if (!GetInstance())
-	{
-		ErrorMessageBox(&quot;Error installing crash reporter&quot;, &quot;CrashReport error:&quot;, MBF_OK);
-		return false;
-	}
-#elif defined(CRASHHANDLER_H)
-	CrashHandler::Install();
-#endif
-	InitializeSEH();
-#endif
-
-	ParseCmdLine();
-	FileSystemHandler::Initialize(true);
-
-	if (!InitWindow((&quot;Spring &quot; + std::string(VERSION_STRING)).c_str())) {
-		SDL_Quit();
-		return false;
-	}
-
-	mouseInput = IMouseInput::Get ();
-
-	// Global structures
-	ENTER_SYNCED;
-	gs=SAFE_NEW CGlobalSyncedStuff();
-	ENTER_UNSYNCED;
-	gu=SAFE_NEW CGlobalUnsyncedStuff();
-
-	if (cmdline-&gt;result(&quot;minimise&quot;)) {
-		gu-&gt;active = false;
-		SDL_WM_IconifyWindow();
-	}
-
-	// Enable auto quit?
-	int quit_time;
-	if (cmdline-&gt;result(&quot;quit&quot;, quit_time)) {
-		gu-&gt;autoQuit = true;
-		gu-&gt;quitTime = quit_time;
-	}
-
-	InitOpenGL();
-	palette.Init();
-
-	// Initialize keyboard
-	SDL_EnableUNICODE(1);
-	SDL_EnableKeyRepeat (SDL_DEFAULT_REPEAT_DELAY, SDL_DEFAULT_REPEAT_INTERVAL);
-	SDL_SetModState (KMOD_NONE);
-
-	keys = SAFE_NEW Uint8[SDLK_LAST];
-	memset (keys,0,sizeof(Uint8)*SDLK_LAST);
-
-	// Initialize font
-	const int charFirst = configHandler.GetInt(&quot;FontCharFirst&quot;, 32);
-	const int charLast  = configHandler.GetInt(&quot;FontCharLast&quot;, 255);
-	std::string fontFile = configHandler.GetString(&quot;FontFile&quot;, &quot;fonts/Luxi.ttf&quot;);
-
-	try {
-		font = SAFE_NEW CglFont(charFirst, charLast, fontFile.c_str());
-	} catch(content_error&amp;) {
-		// If the standard location fails, retry in fonts directory or vice versa.
-		if (fontFile.substr(0, 6) == &quot;fonts/&quot;)
-			fontFile = fontFile.substr(6);
-		else
-			fontFile = &quot;fonts/&quot; + fontFile;
-		font = SAFE_NEW CglFont(charFirst, charLast, fontFile.c_str());
-	}
-
-	// Initialize GLEW
-	LoadExtensions();
-	glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
-	SDL_GL_SwapBuffers();
-
-	// Initialize named texture handler
-	CNamedTextures::Init();
-
-	// Initialize Lua GL
-	LuaOpenGL::Init();
-
-	// Initialize ScriptHandler / LUA
-	CScriptHandler::Instance().StartLua();
-
-	// Create CGameSetup and CPreGame objects
-	CreateGameSetup ();
-
-	return true;
-}
-
-/**
- * @brief multisample test
- * @return whether the multisampling test was successful
- *
- * Tests if a user has requested FSAA, if it's a valid
- * FSAA mode, and if it's supported by the current GL context
- */
-static bool MultisampleTest(void)
-{
-	if (!GL_ARB_multisample)
-		return false;
-	GLuint fsaa = configHandler.GetInt(&quot;FSAA&quot;,0);
-	if (!fsaa)
-		return false;
-	SDL_GL_SetAttribute(SDL_GL_MULTISAMPLEBUFFERS,1);
-	GLuint fsaalevel = max(min(configHandler.GetInt(&quot;FSAALevel&quot;, 2), 8), 0);
-
-	make_even_number(fsaalevel);
-
-	SDL_GL_SetAttribute(SDL_GL_MULTISAMPLESAMPLES,fsaalevel);
-	return true;
-}
-
-/**
- * @brief multisample verify
- * @return whether verification passed
- *
- * Tests whether FSAA was actually enabled
- */
-static bool MultisampleVerify(void)
-{
-	GLint buffers, samples;
-	glGetIntegerv(GL_SAMPLE_BUFFERS_ARB, &amp;buffers);
-	glGetIntegerv(GL_SAMPLES_ARB, &amp;samples);
-	if (buffers &amp;&amp; samples) {
-		return true;
-	}
-	return false;
-}
-
-
-/**
- * @return whether window initialization succeeded
- * @param title char* string with window title
- *
- * Initializes the game window
- */
-bool SpringApp::InitWindow (const char* title)
-{
-	unsigned int sdlInitFlags = SDL_INIT_VIDEO | SDL_INIT_TIMER;
-#ifdef WIN32
-	// the crash reporter should be catching the errors
-	sdlInitFlags |= SDL_INIT_NOPARACHUTE;
-#endif
-	if ((SDL_Init(sdlInitFlags) == -1)) {
-		handleerror(NULL,&quot;Could not initialize SDL.&quot;,&quot;ERROR&quot;,MBF_OK|MBF_EXCL);
-		return false;
-	}
-
-	// Sets window manager properties
-	SDL_WM_SetIcon(SDL_LoadBMP(&quot;spring.bmp&quot;),NULL);
-	SDL_WM_SetCaption(title, title);
-
-	if (!SetSDLVideoMode ())
-		return false;
-
-	return true;
-}
-
-/**
- * @return whether setting the video mode was successful
- *
- * Sets SDL video mode options/settings
- */
-bool SpringApp::SetSDLVideoMode ()
-{
-	int sdlflags = SDL_OPENGL | SDL_RESIZABLE;
-
-	//conditionally_set_flag(sdlflags, SDL_FULLSCREEN, fullscreen);
-	sdlflags |= fullscreen ? SDL_FULLSCREEN : 0;
-
-	SDL_GL_SetAttribute(SDL_GL_RED_SIZE, 5);
-	SDL_GL_SetAttribute(SDL_GL_GREEN_SIZE, 5);
-	SDL_GL_SetAttribute(SDL_GL_BLUE_SIZE, 5);
-
-#ifdef __APPLE__
-	const int defaultDepthSize = 32;
-#else
-	const int defaultDepthSize = 16;
-#endif
-	SDL_GL_SetAttribute(SDL_GL_DEPTH_SIZE, configHandler.GetInt(&quot;DepthBufferBits&quot;, defaultDepthSize));
-	SDL_GL_SetAttribute(SDL_GL_STENCIL_SIZE, configHandler.GetInt(&quot;StencilBufferBits&quot;, 1));
-
-	SDL_GL_SetAttribute(SDL_GL_DOUBLEBUFFER, 1);
-
-	FSAA = MultisampleTest();
-
-	SDL_Surface *screen = SDL_SetVideoMode(screenWidth, screenHeight, 0, sdlflags);
-	if (!screen) {
-		char buf[1024];
-		SNPRINTF(buf, sizeof(buf), &quot;Could not set video mode:\n%s&quot;, SDL_GetError());
-		handleerror(NULL, buf, &quot;ERROR&quot;, MBF_OK|MBF_EXCL);
-		return false;
-	}
-
-#ifdef STREFLOP_H
-	// Something in SDL_SetVideoMode (OpenGL drivers?) messes with the FPU control word.
-	// Set single precision floating point math.
-	streflop_init&lt;streflop::Simple&gt;();
-#endif
-
-	if (FSAA) {
- 		FSAA = MultisampleVerify();
-	}
-
-	// setup GL smoothing
-	const int defaultSmooth = 0; // FSAA ? 0 : 3;  // until a few things get fixed
-	const int lineSmoothing = configHandler.GetInt(&quot;SmoothLines&quot;, defaultSmooth);
-	if (lineSmoothing &gt; 0) {
-		GLenum hint = GL_FASTEST;
-		if (lineSmoothing &gt;= 3) {
-			hint = GL_NICEST;
-		} else if (lineSmoothing &gt;= 2) {
-			hint = GL_DONT_CARE;
-		}
-		glEnable(GL_LINE_SMOOTH);
-		glHint(GL_LINE_SMOOTH_HINT, hint);
-	}
-	const int pointSmoothing = configHandler.GetInt(&quot;SmoothPoints&quot;, defaultSmooth);
-	if (pointSmoothing &gt; 0) {
-		GLenum hint = GL_FASTEST;
-		if (pointSmoothing &gt;= 3) {
-			hint = GL_NICEST;
-		} else if (pointSmoothing &gt;= 2) {
-			hint = GL_DONT_CARE;
-		}
-		glEnable(GL_POINT_SMOOTH);
-		glHint(GL_POINT_SMOOTH_HINT, hint);
-	}
-
-	// there must be a way to see if this is necessary, compare old/new context pointers?
-	if (!!configHandler.GetInt(&quot;FixAltTab&quot;, 0)) {
-		// free GL resources
-		GLContext::Free();
-
-		// initialize any GL resources that were lost
-		GLContext::Init();
-	}
-
-	// initialize the stencil
-	glClearStencil(0);
-	glClear(GL_STENCIL_BUFFER_BIT); SDL_GL_SwapBuffers();
-	glClear(GL_STENCIL_BUFFER_BIT); SDL_GL_SwapBuffers();
-
-	VSync.Init();
-
-	return true;
-}
-
-
-// origin for our coordinates is the bottom left corner
-bool SpringApp::GetDisplayGeometry()
-{
-	SDL_SysWMinfo info;
-	SDL_VERSION(&amp;info.version);
-
-	if (!SDL_GetWMInfo(&amp;info)) {
-		return false;
-	}
-
-#ifdef __APPLE__
-	return false;
-#elif !defined(_WIN32)
-	info.info.x11.lock_func();
-	{
-		Display* display = info.info.x11.display;
-		Window   window  = info.info.x11.window;
-
-		XWindowAttributes attrs;
-		XGetWindowAttributes(display, window, &amp;attrs);
-		const Screen* screen = attrs.screen;
-		gu-&gt;screenSizeX = WidthOfScreen(screen);
-		gu-&gt;screenSizeY = HeightOfScreen(screen);
-		gu-&gt;winSizeX = attrs.width;
-		gu-&gt;winSizeY = attrs.height;
-
-		Window tmp;
-		int xp, yp;
-		XTranslateCoordinates(display, window, attrs.root, 0, 0, &amp;xp, &amp;yp, &amp;tmp);
-		gu-&gt;winPosX = xp;
-		gu-&gt;winPosY = gu-&gt;screenSizeY - gu-&gt;winSizeY - yp;
-	}
-	info.info.x11.unlock_func();
-#else
-	gu-&gt;screenSizeX = GetSystemMetrics(SM_CXFULLSCREEN);
-	gu-&gt;screenSizeY = GetSystemMetrics(SM_CYFULLSCREEN);
-
-	RECT rect;
-	if (!GetClientRect(info.window, &amp;rect)) {
-		return false;
-	}
-
-	if((rect.right - rect.left)==0 || (rect.bottom - rect.top)==0)
-		return false;
-
-	gu-&gt;winSizeX = rect.right - rect.left;
-	gu-&gt;winSizeY = rect.bottom - rect.top;
-
-	// translate from client coords to screen coords
-	MapWindowPoints(info.window, HWND_DESKTOP, (LPPOINT)&amp;rect, 2);
-	gu-&gt;winPosX = rect.left;
-	gu-&gt;winPosY = gu-&gt;screenSizeY - gu-&gt;winSizeY - rect.top;
-#endif // _WIN32
-	return true;
-}
-
-
-void SpringApp::SetupViewportGeometry()
-{
-	if (!GetDisplayGeometry()) {
-		gu-&gt;screenSizeX = screenWidth;
-		gu-&gt;screenSizeY = screenHeight;
-		gu-&gt;winSizeX = screenWidth;
-		gu-&gt;winSizeY = screenHeight;
-		gu-&gt;winPosX = 0;
-		gu-&gt;winPosY = 0;
-	}
-
-	gu-&gt;dualScreenMode = !!configHandler.GetInt(&quot;DualScreenMode&quot;, 0);
-	if (gu-&gt;dualScreenMode) {
-		gu-&gt;dualScreenMiniMapOnLeft =
-			!!configHandler.GetInt(&quot;DualScreenMiniMapOnLeft&quot;, 0);
-	} else {
-		gu-&gt;dualScreenMiniMapOnLeft = false;
-	}
-
-	if (!gu-&gt;dualScreenMode) {
-		gu-&gt;viewSizeX = gu-&gt;winSizeX;
-		gu-&gt;viewSizeY = gu-&gt;winSizeY;
-		gu-&gt;viewPosX = 0;
-		gu-&gt;viewPosY = 0;
-	}
-	else {
-		gu-&gt;viewSizeX = gu-&gt;winSizeX / 2;
-		gu-&gt;viewSizeY = gu-&gt;winSizeY;
-		if (gu-&gt;dualScreenMiniMapOnLeft) {
-			gu-&gt;viewPosX = gu-&gt;winSizeX / 2;
-			gu-&gt;viewPosY = 0;
-		} else {
-			gu-&gt;viewPosX = 0;
-			gu-&gt;viewPosY = 0;
-		}
-	}
-
-	// NOTE:  gu-&gt;viewPosY is not currently used
-
-	gu-&gt;aspectRatio = (float)gu-&gt;viewSizeX / (float)gu-&gt;viewSizeY;
-}
-
-
-/**
- * Initializes OpenGL
- */
-void SpringApp::InitOpenGL ()
-{
-	SetupViewportGeometry();
-
-	glViewport(gu-&gt;viewPosX, gu-&gt;viewPosY, gu-&gt;viewSizeX, gu-&gt;viewSizeY);
-
-	gluPerspective(45.0f, (GLfloat)gu-&gt;viewSizeX / (GLfloat)gu-&gt;viewSizeY, 2.8f, MAX_VIEW_RANGE);
-
-	// Initialize some GL states
-	glShadeModel(GL_SMOOTH);
-	glClearDepth(1.0f);
-	glEnable(GL_DEPTH_TEST);
-	glDepthFunc(GL_LEQUAL);
-}
-
-/**
- * @return whether commandline parsing was successful
- *
- * Parse command line arguments
- */
-void SpringApp::ParseCmdLine()
-{
-	cmdline-&gt;addoption('f', &quot;fullscreen&quot;,     OPTPARM_NONE,   &quot;&quot;,  &quot;Run in fullscreen mode&quot;);
-	cmdline-&gt;addoption('w', &quot;window&quot;,         OPTPARM_NONE,   &quot;&quot;,  &quot;Run in windowed mode&quot;);
-	cmdline-&gt;addoption('m', &quot;minimise&quot;,       OPTPARM_NONE,   &quot;&quot;,  &quot;Start minimised&quot;);
-	cmdline-&gt;addoption('s', &quot;server&quot;,         OPTPARM_NONE,   &quot;&quot;,  &quot;Run as a server&quot;);
-	cmdline-&gt;addoption('c', &quot;client&quot;,         OPTPARM_NONE,   &quot;&quot;,  &quot;Run as a client&quot;);
-	cmdline-&gt;addoption('p', &quot;projectiledump&quot;, OPTPARM_NONE,   &quot;&quot;,  &quot;Dump projectile class info in projectiles.txt&quot;);
-	cmdline-&gt;addoption('t', &quot;textureatlas&quot;,   OPTPARM_NONE,   &quot;&quot;,  &quot;Dump each finalized textureatlas in textureatlasN.tga&quot;);
-	cmdline-&gt;addoption('q', &quot;quit&quot;,           OPTPARM_INT,    &quot;T&quot;, &quot;Quit immediately on game over or after T seconds&quot;);
-	cmdline-&gt;addoption('n', &quot;name&quot;,           OPTPARM_STRING, &quot;&quot;,  &quot;Set your player name&quot;);
-	cmdline-&gt;parse();
-
-#ifdef _DEBUG
-	fullscreen = false;
-#else
-	fullscreen = configHandler.GetInt(&quot;Fullscreen&quot;, 1) != 0;
-#endif
-
-	// mutually exclusive options that cause spring to quit immediately
-	if (cmdline-&gt;result(&quot;help&quot;)) {
-		cmdline-&gt;usage(&quot;Spring&quot;,VERSION_STRING);
-		exit(0);
-	} else if (cmdline-&gt;result(&quot;version&quot;)) {
-		std::cout &lt;&lt; &quot;Spring &quot; &lt;&lt; VERSION_STRING &lt;&lt; std::endl;
-		exit(0);
-	} else if (cmdline-&gt;result(&quot;projectiledump&quot;)) {
-		CCustomExplosionGenerator::OutputProjectileClassInfo();
-		exit(0);
-	}
-
-	// flags
-	if (cmdline-&gt;result(&quot;window&quot;)) {
-		fullscreen = false;
-	} else if (cmdline-&gt;result(&quot;fullscreen&quot;)) {
-		fullscreen = true;
-	}
-
-	if (cmdline-&gt;result(&quot;textureatlas&quot;)) {
-		CTextureAtlas::debug = true;
-	}
-
-	string name;
-	if (cmdline-&gt;result(&quot;name&quot;, name)) {
-		configHandler.SetString(&quot;name&quot;, name);
-	}
-
-	screenWidth = configHandler.GetInt(&quot;XResolution&quot;, XRES_DEFAULT);
-	screenHeight = configHandler.GetInt(&quot;YResolution&quot;, YRES_DEFAULT);
-}
-
-/**
- * @param argc argument count
- * @param argv array of argument strings
- *
- * Checks if a demo SDF file or a startscript has
- * been specified on the command line
- */
-void SpringApp::CheckCmdLineFile(int argc, char *argv[])
-{
-	// Check if the commandline parameter is specifying a demo file
-#ifdef _WIN32
-	// find the correct dir
-	char exe[128];
-	GetModuleFileName(0, exe, sizeof(exe));
-	int a,s = strlen(exe);
-	for (a=s-1;a&gt;0;a--)
-	    // Running in gdb causes the last dir separator to be a forward slash.
-		if (exe[a] == '\\' || exe[a] == '/') break;
-	if (a &gt; 0) {
-		string path(exe, exe+a);
-		if (path.at(0) == '&quot;')
-			path.append(1,'&quot;');
-		_chdir(path.c_str());
-	}
-
-	// If there are any options, they will start before the demo file name.
-
-	string cmdLineStr = win_lpCmdLine;
-	string::size_type offset = 0;
-	//Simply assumes that any argument coming after a argument starting with /q is a variable to /q.
-	for(int i=1; i &lt; argc &amp;&amp; (argv[i][0] == '/' || (argv[i-1][0] == '/' &amp;&amp; (argv[i-1][1] == 'q' || argv[i-1][1] == 'a'))); i++){
-		offset += strlen(argv[i]);
-		offset = cmdLineStr.find_first_not_of(' ', offset);
-		if(offset == string::npos)
-			break;
-	}
-
-	string command;
-	if(offset != string::npos)
-		command = cmdLineStr.substr(offset);
-
-
-	if (!command.empty()) {
-		if (command[0] == '&quot;' &amp;&amp; *command.rbegin() == '&quot;' &amp;&amp; command.length() &gt; 2)
-			command = command.substr(1, command.length()-2);
-		if (command.rfind(&quot;sdf&quot;) == command.size()-3) {
-			demofile = command;
-			logOutput &lt;&lt; &quot;Using demofile &quot; &lt;&lt; demofile.c_str() &lt;&lt; &quot;\n&quot;;
-		} else if (command.rfind(&quot;ssf&quot;) == command.size()-3) {
-			savefile = command;
-			logOutput &lt;&lt; &quot;Using savefile &quot; &lt;&lt; savefile.c_str() &lt;&lt; &quot;\n&quot;;
-		} else {
-			startscript = command;
-			logOutput &lt;&lt; &quot;Using script &quot; &lt;&lt; startscript.c_str() &lt;&lt; &quot;\n&quot;;
-		}
-	}
-#else
-	// is there a reason for not using this in windows?
-	for (int i = 1; i &lt; argc; i++)
-		if (argv[i][0] != '-')
-		{
-			string command(argv[i]);
-			int idx = command.rfind(&quot;sdf&quot;);
-			if (idx == command.size()-3) {
-				demofile = command;
-				logOutput &lt;&lt; &quot;Using demofile &quot; &lt;&lt; demofile.c_str() &lt;&lt; &quot;\n&quot;;
-			} else if (command.rfind(&quot;ssf&quot;) == command.size()-3) {
-				savefile = command;
-				logOutput &lt;&lt; &quot;Using savefile &quot; &lt;&lt; savefile.c_str() &lt;&lt; &quot;\n&quot;;
-			} else {
-				startscript = command;
-				logOutput &lt;&lt; &quot;Using script &quot; &lt;&lt; startscript.c_str() &lt;&lt; &quot;\n&quot;;
-			}
-		}
-#endif
-}
-
-/**
- * Initializes instance of GameSetup
- */
-void SpringApp::CreateGameSetup()
-{
-	ENTER_SYNCED;
-
-	if (!startscript.empty()) {
-		gameSetup = SAFE_NEW CGameSetup();
-		if (!gameSetup-&gt;Init(startscript)) {
-			delete gameSetup;
-			gameSetup = 0;
-		}
-	}
-
-	if (!gameSetup &amp;&amp; demofile.empty()) {
-		gs-&gt;noHelperAIs = !!configHandler.GetInt(&quot;NoHelperAIs&quot;, 0);
-		const string luaGaiaStr  = configHandler.GetString(&quot;LuaGaia&quot;,  &quot;1&quot;);
-		const string luaRulesStr = configHandler.GetString(&quot;LuaRules&quot;, &quot;1&quot;);
-		gs-&gt;useLuaGaia  = CLuaGaia::SetConfigString(luaGaiaStr);
-		gs-&gt;useLuaRules = CLuaRules::SetConfigString(luaRulesStr);
-		if (gs-&gt;useLuaGaia) {
-			gs-&gt;gaiaTeamID = gs-&gt;activeTeams;
-			gs-&gt;gaiaAllyTeamID = gs-&gt;activeAllyTeams;
-			gs-&gt;activeTeams++;
-			gs-&gt;activeAllyTeams++;
-			CTeam* team = gs-&gt;Team(gs-&gt;gaiaTeamID);
-			team-&gt;color[0] = 255;
-			team-&gt;color[1] = 255;
-			team-&gt;color[2] = 255;
-			team-&gt;color[3] = 255;
-			team-&gt;gaia = true;
-			gs-&gt;SetAllyTeam(gs-&gt;gaiaTeamID, gs-&gt;gaiaAllyTeamID);
-		}
-	}
-
-	ENTER_MIXED;
-
-	bool server = true;
-
-	if (!demofile.empty()) {
-		server = false;
-	}
-	else if (gameSetup) {
-		// first real player is demo host
-		server = (gameSetup-&gt;myPlayerNum == gameSetup-&gt;numDemoPlayers) &amp;&amp; !cmdline-&gt;result(&quot;client&quot;);
-	}
-	else {
-		server = !cmdline-&gt;result(&quot;client&quot;) || cmdline-&gt;result(&quot;server&quot;);
-	}
-
-#ifdef SYNCDEBUG
-	// initialize sync debugger as soon as we know whether we will be server
-	CSyncDebugger::GetInstance()-&gt;Initialize(server);
-#endif
-
-	if (!demofile.empty()) {
-		pregame = SAFE_NEW CPreGame(false, demofile, &quot;&quot;);
-	} else {
-		pregame = SAFE_NEW CPreGame(server, &quot;&quot;, savefile);
-	}
-}
-
-
-/**
- * @return return code of activecontroller draw function
- *
- * Draw function repeatedly called, it calls all the
- * other draw functions
- */
-int SpringApp::Update ()
-{
-	if (FSAA)
-		glEnable(GL_MULTISAMPLE_ARB);
-
-	mouseInput-&gt;Update();
-
-	int ret = 1;
-	if (activeController) {
-		if (!activeController-&gt;Update()) {
-			ret = 0;
-		} else {
-			ret = activeController-&gt;Draw();
-		}
-	}
-
-	VSync.Delay();
-	SDL_GL_SwapBuffers();
-
-	if (FSAA)
-		glDisable(GL_MULTISAMPLE_ARB);
-
-	return ret;
-}
-
-/**
- * Tests SDL keystates and sets values
- * in key array
- */
-void SpringApp::UpdateSDLKeys ()
-{
-	int numkeys;
-	Uint8 *state;
-	state = SDL_GetKeyState(&amp;numkeys);
-	memcpy(keys, state, sizeof(Uint8) * numkeys);
-
-	const SDLMod mods = SDL_GetModState();
-	keys[SDLK_LALT]   = (mods &amp; KMOD_ALT)   ? 1 : 0;
-	keys[SDLK_LCTRL]  = (mods &amp; KMOD_CTRL)  ? 1 : 0;
-	keys[SDLK_LMETA]  = (mods &amp; KMOD_META)  ? 1 : 0;
-	keys[SDLK_LSHIFT] = (mods &amp; KMOD_SHIFT) ? 1 : 0;
-}
-
-/**
- * @param argc argument count
- * @param argv array of argument strings
- *
- * Executes the application
- * (contains main game loop)
- */
-int SpringApp::Run (int argc, char *argv[])
-{
-	INIT_SYNCIFY;
-	CheckCmdLineFile (argc, argv);
-	cmdline = BaseCmd::initialize(argc,argv);
-/*
-	logOutput.Print (&quot;Testing error catching&quot;);
-	try {
-		int *i_=0;
-		*i_=1;
-		logOutput.Print (&quot;Error catching doesn't work!&quot;);
-	} catch(...) {
-		logOutput.Print (&quot;Error catching works!&quot;);
-	}
-*/
-	if (!Initialize ())
-		return -1;
-
-#ifdef WIN32
-	SDL_EventState (SDL_SYSWMEVENT, SDL_ENABLE);
-#endif
-
-	SDL_Event event;
-	bool done = false;
-
-	while (!done) {
-		ENTER_UNSYNCED;
-		while (SDL_PollEvent(&amp;event)) {
-			switch (event.type) {
-				case SDL_VIDEORESIZE: {
-					screenWidth = event.resize.w;
-					screenHeight = event.resize.h;
-#ifndef WIN32
-					// HACK   We don't want to break resizing on windows (again?),
-					//        so someone should test this very well before enabling it.
-					SetSDLVideoMode();
-#endif
-					InitOpenGL();
-					activeController-&gt;ResizeEvent();
-					break;
-				}
-				case SDL_VIDEOEXPOSE: {
-					// re-initialize the stencil
-					glClearStencil(0);
-					glClear(GL_STENCIL_BUFFER_BIT); SDL_GL_SwapBuffers();
-					glClear(GL_STENCIL_BUFFER_BIT); SDL_GL_SwapBuffers();
-					SetupViewportGeometry();
-					break;
-				}
-				case SDL_QUIT: {
-					done = true;
-					break;
-				}
-				case SDL_ACTIVEEVENT: {
-					if (event.active.state &amp; SDL_APPACTIVE) {
-						gu-&gt;active = !!event.active.gain;
-					}
-					break;
-				}
-				case SDL_MOUSEMOTION:
-				case SDL_MOUSEBUTTONDOWN:
-				case SDL_MOUSEBUTTONUP:
-				case SDL_SYSWMEVENT: {
-					mouseInput-&gt;HandleSDLMouseEvent (event);
-					break;
-				}
-				case SDL_KEYDOWN: {
-					int i = event.key.keysym.sym;
-
-					const bool isRepeat = !!keys[i];
-
-					UpdateSDLKeys ();
-
-					if (activeController) {
-						if (i &lt;= SDLK_DELETE) {
-							i = tolower(i);
-						}
-						else if (i == SDLK_RSHIFT) { i = SDLK_LSHIFT; }
-						else if (i == SDLK_RCTRL)  { i = SDLK_LCTRL;  }
-						else if (i == SDLK_RMETA)  { i = SDLK_LMETA;  }
-						else if (i == SDLK_RALT)   { i = SDLK_LALT;   }
-
-						if (keyBindings) {
-							const int fakeMetaKey = keyBindings-&gt;GetFakeMetaKey();
-							if (fakeMetaKey &gt;= 0) {
-								keys[SDLK_LMETA] |= keys[fakeMetaKey];
-							}
-						}
-
-						activeController-&gt;KeyPressed(i, isRepeat);
-
-						if (activeController-&gt;userWriting){
-							// use unicode for printed characters
-							i = event.key.keysym.unicode;
-							if ((i &gt;= SDLK_SPACE) &amp;&amp; (i &lt;= SDLK_DELETE)) {
-								CGameController* ac = activeController;
-								if (ac-&gt;ignoreNextChar || ac-&gt;ignoreChar == char(i)) {
-									ac-&gt;ignoreNextChar = false;
-								} else {
-									if (i &lt; SDLK_DELETE) {
-										const int len = (int)ac-&gt;userInput.length();
-										ac-&gt;writingPos = max(0, min(len, ac-&gt;writingPos));
-										char str[2] = { char(i), 0 };
-										ac-&gt;userInput.insert(ac-&gt;writingPos, str);
-										ac-&gt;writingPos++;
-									}
-								}
-							}
-						}
-					}
-					activeController-&gt;ignoreNextChar = false;
-					break;
-				}
-				case SDL_KEYUP: {
-					int i = event.key.keysym.sym;
-
-					UpdateSDLKeys();
-
-					if (activeController) {
-						if (i &lt;= SDLK_DELETE) {
-							i = tolower(i);
-						}
-						else if (i == SDLK_RSHIFT) { i = SDLK_LSHIFT; }
-						else if (i == SDLK_RCTRL)  { i = SDLK_LCTRL;  }
-						else if (i == SDLK_RMETA)  { i = SDLK_LMETA;  }
-						else if (i == SDLK_RALT)   { i = SDLK_LALT;   }
-
-						if (keyBindings) {
-							const int fakeMetaKey = keyBindings-&gt;GetFakeMetaKey();
-							if (fakeMetaKey &gt;= 0) {
-								keys[SDLK_LMETA] |= keys[fakeMetaKey];
-							}
-						}
-
-						activeController-&gt;KeyReleased(i);
-					}
-					break;
-				}
-				default:
-					break;
-			}
-		}
-		if (globalQuit)
-			break;
-
-		if (!Update())
-			break;
-	}
-	ENTER_MIXED;
-
-	// Shutdown
-	Shutdown();
-	return 0;
-}
-
-/**
- * Deallocates and shuts down game
- */
-void SpringApp::Shutdown()
-{
-	if (pregame)
-		delete pregame;			//in case we exit during init
-	if (game)
-		delete game;
-	if (gameSetup)
-		delete gameSetup;
-	delete font;
-	CNamedTextures::Kill();
-	GLContext::Free();
-	ConfigHandler::Deallocate();
-	UnloadExtensions();
-	delete mouseInput;
-	SDL_WM_GrabInput(SDL_GRAB_OFF);
-	SDL_Quit();
-	delete gs;
-	delete gu;
-	END_SYNCIFY;
-#ifdef USE_MMGR
-	m_dumpMemoryReport();
-#endif
-}
-
 // On msvc main() is declared as a non-throwing function.
 // Moving the catch clause to a seperate function makes it possible to re-throw the exception for the installed crash reporter
 int Run(int argc, char *argv[])
@@ -1154,11 +92,7 @@
  *
  * Main entry point function
  */
-#if defined(__APPLE__)
-int main( int argc, char *argv[] )
-#else
-int main( int argc, char *argv[ ], char *envp[ ] ) /* envp only on linux/bsd */
-#endif
+int main( int argc, char *argv[]) // , char *envp[ ] &lt;- not used
 {
 	return Run (argc,argv);
 }

Added: trunk/rts/System/SpringApp.cpp
===================================================================
--- trunk/rts/System/SpringApp.cpp	                        (rev 0)
+++ trunk/rts/System/SpringApp.cpp	2008-02-15 23:55:41 UTC (rev 5505)
@@ -0,0 +1,948 @@
+#include &quot;SpringApp.h&quot;
+
+#include &lt;signal.h&gt;
+#include &lt;SDL.h&gt;
+#include &lt;SDL_syswm.h&gt;
+
+#include &quot;StdAfx.h&quot;
+#include &quot;Game/GameVersion.h&quot;
+#include &quot;Game/GameSetup.h&quot;
+#include &quot;Game/GameController.h&quot;
+#include &quot;Game/PreGame.h&quot;
+#include &quot;Game/Game.h&quot;
+#include &quot;Game/Team.h&quot;
+#include &quot;Game/UI/KeyBindings.h&quot;
+#include &quot;Game/StartScripts/ScriptHandler.h&quot;
+#include &quot;Lua/LuaGaia.h&quot;
+#include &quot;Lua/LuaRules.h&quot;
+#include &quot;Lua/LuaOpenGL.h&quot;
+#include &quot;Platform/BaseCmd.h&quot;
+#include &quot;Platform/ConfigHandler.h&quot;
+#include &quot;Platform/errorhandler.h&quot;
+#include &quot;Platform/FileSystem.h&quot;
+#include &quot;Rendering/glFont.h&quot;
+#include &quot;Rendering/GLContext.h&quot;
+#include &quot;Rendering/GL/myGL.h&quot;
+#include &quot;Rendering/VerticalSync.h&quot;
+#include &quot;Rendering/Textures/TAPalette.h&quot;
+#include &quot;Rendering/Textures/NamedTextures.h&quot;
+#include &quot;Rendering/Textures/TextureAtlas.h&quot;
+#include &quot;Sim/Projectiles/ExplosionGenerator.h&quot;
+#include &quot;LogOutput.h&quot;
+#include &quot;MouseInput.h&quot;
+#include &quot;bitops.h&quot;
+#include &quot;Sync/Syncify.h&quot;
+
+#include &quot;mmgr.h&quot;
+
+#ifdef WIN32
+#ifdef __GNUC__
+	#include &quot;Platform/Win/CrashHandler.h&quot;
+#endif
+	#include &quot;Platform/Win/win32.h&quot;
+	#include &lt;winreg.h&gt;
+	#include &lt;direct.h&gt;
+	#include &quot;Platform/Win/seh.h&quot;
+#endif // WIN32
+
+using std::string;
+
+CGameController* activeController = 0;
+bool globalQuit = false;
+Uint8 *keys = 0;
+bool fullscreen = true;
+
+/**
+ * @brief xres default
+ *
+ * Defines the default X resolution as 1024
+ */
+const int XRES_DEFAULT = 1024;
+
+/**
+ * @brief yres default
+ *
+ * Defines the default Y resolution as 768
+ */
+const int YRES_DEFAULT = 768;
+
+void SpringApp::SigAbrtHandler(int unused)
+{
+	// cause an exception if on windows
+	// TODO FIXME do a proper stacktrace dump here
+	#ifdef WIN32
+	*((int*)(0)) = 0;
+	#endif
+}
+
+/**
+ * Initializes SpringApp variables
+ */
+SpringApp::SpringApp ()
+{
+	cmdline = 0;
+	screenWidth = screenHeight = 0;
+	FSAA = false;
+
+	signal(SIGABRT, SigAbrtHandler);
+}
+
+/**
+ * Destroys SpringApp variables
+ */
+SpringApp::~SpringApp()
+{
+	if (cmdline) delete cmdline;
+	if (keys) delete[] keys;
+
+	creg::System::FreeClasses ();
+}
+
+#ifdef _CRASHRPT_H_
+/**
+ * @brief crash callback
+ * @return whether callback was successful
+ * @param crState current state
+ *
+ * Callback function executed when
+ * game crashes (win32 only)
+ */
+bool crashCallback(void* crState)
+{
+	logOutput.RemoveAllSubscribers();
+	logOutput.Print(&quot;Spring has crashed&quot;);
+
+	// Stop writing to infolog.txt
+	logOutput.End();
+
+	// FIXME needs to be updated for new netcode
+	//bool wasRecording = false;
+	//if (net-&gt;recordDemo) {
+	//	delete net-&gt;recordDemo;
+	//	wasRecording = true;
+	//}
+
+	AddFile(&quot;infolog.txt&quot;, &quot;Spring information log&quot;);
+
+	//if (wasRecording)
+	//	AddFile(net-&gt;demoName.c_str(), &quot;Spring game demo&quot;);
+
+	SDL_Quit();
+
+	return true;
+}
+#endif
+
+/**
+ * @brief Initializes the SpringApp instance
+ * @return whether initialization was successful
+ */
+bool SpringApp::Initialize ()
+{
+	logOutput.SetMirrorToStdout(!!configHandler.GetInt(&quot;StdoutDebug&quot;,0));
+
+	// Initialize class system
+	creg::System::InitializeClasses ();
+
+	// Initialize crash reporting
+#ifdef _WIN32
+#if defined(_CRASHRPT_H_)
+	Install( (LPGETLOGFILE) crashCallback, &quot;<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">taspringcrash at clan-sy.com</A>&quot;, &quot;Spring Crashreport&quot;);
+	if (!GetInstance())
+	{
+		ErrorMessageBox(&quot;Error installing crash reporter&quot;, &quot;CrashReport error:&quot;, MBF_OK);
+		return false;
+	}
+#elif defined(CRASHHANDLER_H)
+	CrashHandler::Install();
+#endif
+	InitializeSEH();
+#endif
+
+	ParseCmdLine();
+	FileSystemHandler::Initialize(true);
+
+	if (!InitWindow((&quot;Spring &quot; + std::string(VERSION_STRING)).c_str())) {
+		SDL_Quit();
+		return false;
+	}
+
+	mouseInput = IMouseInput::Get ();
+
+	// Global structures
+	ENTER_SYNCED;
+	gs=SAFE_NEW CGlobalSyncedStuff();
+	ENTER_UNSYNCED;
+	gu=SAFE_NEW CGlobalUnsyncedStuff();
+
+	if (cmdline-&gt;result(&quot;minimise&quot;)) {
+		gu-&gt;active = false;
+		SDL_WM_IconifyWindow();
+	}
+
+	// Enable auto quit?
+	int quit_time;
+	if (cmdline-&gt;result(&quot;quit&quot;, quit_time)) {
+		gu-&gt;autoQuit = true;
+		gu-&gt;quitTime = quit_time;
+	}
+
+	InitOpenGL();
+	palette.Init();
+
+	// Initialize keyboard
+	SDL_EnableUNICODE(1);
+	SDL_EnableKeyRepeat (SDL_DEFAULT_REPEAT_DELAY, SDL_DEFAULT_REPEAT_INTERVAL);
+	SDL_SetModState (KMOD_NONE);
+
+	keys = SAFE_NEW Uint8[SDLK_LAST];
+	memset (keys,0,sizeof(Uint8)*SDLK_LAST);
+
+	// Initialize font
+	const int charFirst = configHandler.GetInt(&quot;FontCharFirst&quot;, 32);
+	const int charLast  = configHandler.GetInt(&quot;FontCharLast&quot;, 255);
+	std::string fontFile = configHandler.GetString(&quot;FontFile&quot;, &quot;fonts/Luxi.ttf&quot;);
+
+	try {
+		font = SAFE_NEW CglFont(charFirst, charLast, fontFile.c_str());
+	} catch(content_error&amp;) {
+		// If the standard location fails, retry in fonts directory or vice versa.
+		if (fontFile.substr(0, 6) == &quot;fonts/&quot;)
+			fontFile = fontFile.substr(6);
+		else
+			fontFile = &quot;fonts/&quot; + fontFile;
+		font = SAFE_NEW CglFont(charFirst, charLast, fontFile.c_str());
+	}
+
+	// Initialize GLEW
+	LoadExtensions();
+	glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
+	SDL_GL_SwapBuffers();
+
+	// Initialize named texture handler
+	CNamedTextures::Init();
+
+	// Initialize Lua GL
+	LuaOpenGL::Init();
+
+	// Initialize ScriptHandler / LUA
+	CScriptHandler::Instance().StartLua();
+
+	// Create CGameSetup and CPreGame objects
+	CreateGameSetup ();
+
+	return true;
+}
+
+/**
+ * @brief multisample test
+ * @return whether the multisampling test was successful
+ *
+ * Tests if a user has requested FSAA, if it's a valid
+ * FSAA mode, and if it's supported by the current GL context
+ */
+static bool MultisampleTest(void)
+{
+	if (!GL_ARB_multisample)
+		return false;
+	GLuint fsaa = configHandler.GetInt(&quot;FSAA&quot;,0);
+	if (!fsaa)
+		return false;
+	SDL_GL_SetAttribute(SDL_GL_MULTISAMPLEBUFFERS,1);
+	GLuint fsaalevel = max(min(configHandler.GetInt(&quot;FSAALevel&quot;, 2), 8), 0);
+
+	make_even_number(fsaalevel);
+
+	SDL_GL_SetAttribute(SDL_GL_MULTISAMPLESAMPLES,fsaalevel);
+	return true;
+}
+
+/**
+ * @brief multisample verify
+ * @return whether verification passed
+ *
+ * Tests whether FSAA was actually enabled
+ */
+static bool MultisampleVerify(void)
+{
+	GLint buffers, samples;
+	glGetIntegerv(GL_SAMPLE_BUFFERS_ARB, &amp;buffers);
+	glGetIntegerv(GL_SAMPLES_ARB, &amp;samples);
+	if (buffers &amp;&amp; samples) {
+		return true;
+	}
+	return false;
+}
+
+
+/**
+ * @return whether window initialization succeeded
+ * @param title char* string with window title
+ *
+ * Initializes the game window
+ */
+bool SpringApp::InitWindow (const char* title)
+{
+	unsigned int sdlInitFlags = SDL_INIT_VIDEO | SDL_INIT_TIMER;
+#ifdef WIN32
+	// the crash reporter should be catching the errors
+	sdlInitFlags |= SDL_INIT_NOPARACHUTE;
+#endif
+	if ((SDL_Init(sdlInitFlags) == -1)) {
+		handleerror(NULL,&quot;Could not initialize SDL.&quot;,&quot;ERROR&quot;,MBF_OK|MBF_EXCL);
+		return false;
+	}
+
+	// Sets window manager properties
+	SDL_WM_SetIcon(SDL_LoadBMP(&quot;spring.bmp&quot;),NULL);
+	SDL_WM_SetCaption(title, title);
+
+	if (!SetSDLVideoMode ())
+		return false;
+
+	return true;
+}
+
+/**
+ * @return whether setting the video mode was successful
+ *
+ * Sets SDL video mode options/settings
+ */
+bool SpringApp::SetSDLVideoMode ()
+{
+	int sdlflags = SDL_OPENGL | SDL_RESIZABLE;
+
+	//conditionally_set_flag(sdlflags, SDL_FULLSCREEN, fullscreen);
+	sdlflags |= fullscreen ? SDL_FULLSCREEN : 0;
+
+	SDL_GL_SetAttribute(SDL_GL_RED_SIZE, 5);
+	SDL_GL_SetAttribute(SDL_GL_GREEN_SIZE, 5);
+	SDL_GL_SetAttribute(SDL_GL_BLUE_SIZE, 5);
+
+#ifdef __APPLE__
+	const int defaultDepthSize = 32;
+#else
+	const int defaultDepthSize = 16;
+#endif
+	SDL_GL_SetAttribute(SDL_GL_DEPTH_SIZE, configHandler.GetInt(&quot;DepthBufferBits&quot;, defaultDepthSize));
+	SDL_GL_SetAttribute(SDL_GL_STENCIL_SIZE, configHandler.GetInt(&quot;StencilBufferBits&quot;, 1));
+
+	SDL_GL_SetAttribute(SDL_GL_DOUBLEBUFFER, 1);
+
+	FSAA = MultisampleTest();
+
+	SDL_Surface *screen = SDL_SetVideoMode(screenWidth, screenHeight, 0, sdlflags);
+	if (!screen) {
+		char buf[1024];
+		SNPRINTF(buf, sizeof(buf), &quot;Could not set video mode:\n%s&quot;, SDL_GetError());
+		handleerror(NULL, buf, &quot;ERROR&quot;, MBF_OK|MBF_EXCL);
+		return false;
+	}
+
+#ifdef STREFLOP_H
+	// Something in SDL_SetVideoMode (OpenGL drivers?) messes with the FPU control word.
+	// Set single precision floating point math.
+	streflop_init&lt;streflop::Simple&gt;();
+#endif
+
+	if (FSAA) {
+ 		FSAA = MultisampleVerify();
+	}
+
+	// setup GL smoothing
+	const int defaultSmooth = 0; // FSAA ? 0 : 3;  // until a few things get fixed
+	const int lineSmoothing = configHandler.GetInt(&quot;SmoothLines&quot;, defaultSmooth);
+	if (lineSmoothing &gt; 0) {
+		GLenum hint = GL_FASTEST;
+		if (lineSmoothing &gt;= 3) {
+			hint = GL_NICEST;
+		} else if (lineSmoothing &gt;= 2) {
+			hint = GL_DONT_CARE;
+		}
+		glEnable(GL_LINE_SMOOTH);
+		glHint(GL_LINE_SMOOTH_HINT, hint);
+	}
+	const int pointSmoothing = configHandler.GetInt(&quot;SmoothPoints&quot;, defaultSmooth);
+	if (pointSmoothing &gt; 0) {
+		GLenum hint = GL_FASTEST;
+		if (pointSmoothing &gt;= 3) {
+			hint = GL_NICEST;
+		} else if (pointSmoothing &gt;= 2) {
+			hint = GL_DONT_CARE;
+		}
+		glEnable(GL_POINT_SMOOTH);
+		glHint(GL_POINT_SMOOTH_HINT, hint);
+	}
+
+	// there must be a way to see if this is necessary, compare old/new context pointers?
+	if (!!configHandler.GetInt(&quot;FixAltTab&quot;, 0)) {
+		// free GL resources
+		GLContext::Free();
+
+		// initialize any GL resources that were lost
+		GLContext::Init();
+	}
+
+	// initialize the stencil
+	glClearStencil(0);
+	glClear(GL_STENCIL_BUFFER_BIT); SDL_GL_SwapBuffers();
+	glClear(GL_STENCIL_BUFFER_BIT); SDL_GL_SwapBuffers();
+
+	VSync.Init();
+
+	return true;
+}
+
+
+// origin for our coordinates is the bottom left corner
+bool SpringApp::GetDisplayGeometry()
+{
+	SDL_SysWMinfo info;
+	SDL_VERSION(&amp;info.version);
+
+	if (!SDL_GetWMInfo(&amp;info)) {
+		return false;
+	}
+
+#ifdef __APPLE__
+	return false;
+#elif !defined(_WIN32)
+	info.info.x11.lock_func();
+	{
+		Display* display = info.info.x11.display;
+		Window   window  = info.info.x11.window;
+
+		XWindowAttributes attrs;
+		XGetWindowAttributes(display, window, &amp;attrs);
+		const Screen* screen = attrs.screen;
+		gu-&gt;screenSizeX = WidthOfScreen(screen);
+		gu-&gt;screenSizeY = HeightOfScreen(screen);
+		gu-&gt;winSizeX = attrs.width;
+		gu-&gt;winSizeY = attrs.height;
+
+		Window tmp;
+		int xp, yp;
+		XTranslateCoordinates(display, window, attrs.root, 0, 0, &amp;xp, &amp;yp, &amp;tmp);
+		gu-&gt;winPosX = xp;
+		gu-&gt;winPosY = gu-&gt;screenSizeY - gu-&gt;winSizeY - yp;
+	}
+	info.info.x11.unlock_func();
+#else
+	gu-&gt;screenSizeX = GetSystemMetrics(SM_CXFULLSCREEN);
+	gu-&gt;screenSizeY = GetSystemMetrics(SM_CYFULLSCREEN);
+
+	RECT rect;
+	if (!GetClientRect(info.window, &amp;rect)) {
+		return false;
+	}
+
+	if((rect.right - rect.left)==0 || (rect.bottom - rect.top)==0)
+		return false;
+
+	gu-&gt;winSizeX = rect.right - rect.left;
+	gu-&gt;winSizeY = rect.bottom - rect.top;
+
+	// translate from client coords to screen coords
+	MapWindowPoints(info.window, HWND_DESKTOP, (LPPOINT)&amp;rect, 2);
+	gu-&gt;winPosX = rect.left;
+	gu-&gt;winPosY = gu-&gt;screenSizeY - gu-&gt;winSizeY - rect.top;
+#endif // _WIN32
+	return true;
+}
+
+
+void SpringApp::SetupViewportGeometry()
+{
+	if (!GetDisplayGeometry()) {
+		gu-&gt;screenSizeX = screenWidth;
+		gu-&gt;screenSizeY = screenHeight;
+		gu-&gt;winSizeX = screenWidth;
+		gu-&gt;winSizeY = screenHeight;
+		gu-&gt;winPosX = 0;
+		gu-&gt;winPosY = 0;
+	}
+
+	gu-&gt;dualScreenMode = !!configHandler.GetInt(&quot;DualScreenMode&quot;, 0);
+	if (gu-&gt;dualScreenMode) {
+		gu-&gt;dualScreenMiniMapOnLeft =
+			!!configHandler.GetInt(&quot;DualScreenMiniMapOnLeft&quot;, 0);
+	} else {
+		gu-&gt;dualScreenMiniMapOnLeft = false;
+	}
+
+	if (!gu-&gt;dualScreenMode) {
+		gu-&gt;viewSizeX = gu-&gt;winSizeX;
+		gu-&gt;viewSizeY = gu-&gt;winSizeY;
+		gu-&gt;viewPosX = 0;
+		gu-&gt;viewPosY = 0;
+	}
+	else {
+		gu-&gt;viewSizeX = gu-&gt;winSizeX / 2;
+		gu-&gt;viewSizeY = gu-&gt;winSizeY;
+		if (gu-&gt;dualScreenMiniMapOnLeft) {
+			gu-&gt;viewPosX = gu-&gt;winSizeX / 2;
+			gu-&gt;viewPosY = 0;
+		} else {
+			gu-&gt;viewPosX = 0;
+			gu-&gt;viewPosY = 0;
+		}
+	}
+
+	// NOTE:  gu-&gt;viewPosY is not currently used
+
+	gu-&gt;aspectRatio = (float)gu-&gt;viewSizeX / (float)gu-&gt;viewSizeY;
+}
+
+
+/**
+ * Initializes OpenGL
+ */
+void SpringApp::InitOpenGL ()
+{
+	SetupViewportGeometry();
+
+	glViewport(gu-&gt;viewPosX, gu-&gt;viewPosY, gu-&gt;viewSizeX, gu-&gt;viewSizeY);
+
+	gluPerspective(45.0f, (GLfloat)gu-&gt;viewSizeX / (GLfloat)gu-&gt;viewSizeY, 2.8f, MAX_VIEW_RANGE);
+
+	// Initialize some GL states
+	glShadeModel(GL_SMOOTH);
+	glClearDepth(1.0f);
+	glEnable(GL_DEPTH_TEST);
+	glDepthFunc(GL_LEQUAL);
+}
+
+/**
+ * @return whether commandline parsing was successful
+ *
+ * Parse command line arguments
+ */
+void SpringApp::ParseCmdLine()
+{
+	cmdline-&gt;addoption('f', &quot;fullscreen&quot;,     OPTPARM_NONE,   &quot;&quot;,  &quot;Run in fullscreen mode&quot;);
+	cmdline-&gt;addoption('w', &quot;window&quot;,         OPTPARM_NONE,   &quot;&quot;,  &quot;Run in windowed mode&quot;);
+	cmdline-&gt;addoption('m', &quot;minimise&quot;,       OPTPARM_NONE,   &quot;&quot;,  &quot;Start minimised&quot;);
+	cmdline-&gt;addoption('s', &quot;server&quot;,         OPTPARM_NONE,   &quot;&quot;,  &quot;Run as a server&quot;);
+	cmdline-&gt;addoption('c', &quot;client&quot;,         OPTPARM_NONE,   &quot;&quot;,  &quot;Run as a client&quot;);
+	cmdline-&gt;addoption('p', &quot;projectiledump&quot;, OPTPARM_NONE,   &quot;&quot;,  &quot;Dump projectile class info in projectiles.txt&quot;);
+	cmdline-&gt;addoption('t', &quot;textureatlas&quot;,   OPTPARM_NONE,   &quot;&quot;,  &quot;Dump each finalized textureatlas in textureatlasN.tga&quot;);
+	cmdline-&gt;addoption('q', &quot;quit&quot;,           OPTPARM_INT,    &quot;T&quot;, &quot;Quit immediately on game over or after T seconds&quot;);
+	cmdline-&gt;addoption('n', &quot;name&quot;,           OPTPARM_STRING, &quot;&quot;,  &quot;Set your player name&quot;);
+	cmdline-&gt;parse();
+
+#ifdef _DEBUG
+	fullscreen = false;
+#else
+	fullscreen = configHandler.GetInt(&quot;Fullscreen&quot;, 1) != 0;
+#endif
+
+	// mutually exclusive options that cause spring to quit immediately
+	if (cmdline-&gt;result(&quot;help&quot;)) {
+		cmdline-&gt;usage(&quot;Spring&quot;,VERSION_STRING);
+		exit(0);
+	} else if (cmdline-&gt;result(&quot;version&quot;)) {
+		std::cout &lt;&lt; &quot;Spring &quot; &lt;&lt; VERSION_STRING &lt;&lt; std::endl;
+		exit(0);
+	} else if (cmdline-&gt;result(&quot;projectiledump&quot;)) {
+		CCustomExplosionGenerator::OutputProjectileClassInfo();
+		exit(0);
+	}
+
+	// flags
+	if (cmdline-&gt;result(&quot;window&quot;)) {
+		fullscreen = false;
+	} else if (cmdline-&gt;result(&quot;fullscreen&quot;)) {
+		fullscreen = true;
+	}
+
+	if (cmdline-&gt;result(&quot;textureatlas&quot;)) {
+		CTextureAtlas::debug = true;
+	}
+
+	string name;
+	if (cmdline-&gt;result(&quot;name&quot;, name)) {
+		configHandler.SetString(&quot;name&quot;, name);
+	}
+
+	screenWidth = configHandler.GetInt(&quot;XResolution&quot;, XRES_DEFAULT);
+	screenHeight = configHandler.GetInt(&quot;YResolution&quot;, YRES_DEFAULT);
+}
+
+/**
+ * @param argc argument count
+ * @param argv array of argument strings
+ *
+ * Checks if a demo SDF file or a startscript has
+ * been specified on the command line
+ */
+void SpringApp::CheckCmdLineFile(int argc, char *argv[])
+{
+	// Check if the commandline parameter is specifying a demo file
+#ifdef _WIN32
+	// find the correct dir
+	char exe[128];
+	GetModuleFileName(0, exe, sizeof(exe));
+	int a,s = strlen(exe);
+	for (a=s-1;a&gt;0;a--)
+	    // Running in gdb causes the last dir separator to be a forward slash.
+		if (exe[a] == '\\' || exe[a] == '/') break;
+	if (a &gt; 0) {
+		string path(exe, exe+a);
+		if (path.at(0) == '&quot;')
+			path.append(1,'&quot;');
+		_chdir(path.c_str());
+	}
+
+	// If there are any options, they will start before the demo file name.
+
+	string cmdLineStr = win_lpCmdLine;
+	string::size_type offset = 0;
+	//Simply assumes that any argument coming after a argument starting with /q is a variable to /q.
+	for(int i=1; i &lt; argc &amp;&amp; (argv[i][0] == '/' || (argv[i-1][0] == '/' &amp;&amp; (argv[i-1][1] == 'q' || argv[i-1][1] == 'a'))); i++){
+		offset += strlen(argv[i]);
+		offset = cmdLineStr.find_first_not_of(' ', offset);
+		if(offset == string::npos)
+			break;
+	}
+
+	string command;
+	if(offset != string::npos)
+		command = cmdLineStr.substr(offset);
+
+
+	if (!command.empty()) {
+		if (command[0] == '&quot;' &amp;&amp; *command.rbegin() == '&quot;' &amp;&amp; command.length() &gt; 2)
+			command = command.substr(1, command.length()-2);
+		if (command.rfind(&quot;sdf&quot;) == command.size()-3) {
+			demofile = command;
+			logOutput &lt;&lt; &quot;Using demofile &quot; &lt;&lt; demofile.c_str() &lt;&lt; &quot;\n&quot;;
+		} else if (command.rfind(&quot;ssf&quot;) == command.size()-3) {
+			savefile = command;
+			logOutput &lt;&lt; &quot;Using savefile &quot; &lt;&lt; savefile.c_str() &lt;&lt; &quot;\n&quot;;
+		} else {
+			startscript = command;
+			logOutput &lt;&lt; &quot;Using script &quot; &lt;&lt; startscript.c_str() &lt;&lt; &quot;\n&quot;;
+		}
+	}
+#else
+	// is there a reason for not using this in windows?
+	for (int i = 1; i &lt; argc; i++)
+		if (argv[i][0] != '-')
+		{
+			string command(argv[i]);
+			int idx = command.rfind(&quot;sdf&quot;);
+			if (idx == command.size()-3) {
+				demofile = command;
+				logOutput &lt;&lt; &quot;Using demofile &quot; &lt;&lt; demofile.c_str() &lt;&lt; &quot;\n&quot;;
+			} else if (command.rfind(&quot;ssf&quot;) == command.size()-3) {
+				savefile = command;
+				logOutput &lt;&lt; &quot;Using savefile &quot; &lt;&lt; savefile.c_str() &lt;&lt; &quot;\n&quot;;
+			} else {
+				startscript = command;
+				logOutput &lt;&lt; &quot;Using script &quot; &lt;&lt; startscript.c_str() &lt;&lt; &quot;\n&quot;;
+			}
+		}
+#endif
+}
+
+/**
+ * Initializes instance of GameSetup
+ */
+void SpringApp::CreateGameSetup()
+{
+	ENTER_SYNCED;
+
+	if (!startscript.empty()) {
+		gameSetup = SAFE_NEW CGameSetup();
+		if (!gameSetup-&gt;Init(startscript)) {
+			delete gameSetup;
+			gameSetup = 0;
+		}
+	}
+
+	if (!gameSetup &amp;&amp; demofile.empty()) {
+		gs-&gt;noHelperAIs = !!configHandler.GetInt(&quot;NoHelperAIs&quot;, 0);
+		const string luaGaiaStr  = configHandler.GetString(&quot;LuaGaia&quot;,  &quot;1&quot;);
+		const string luaRulesStr = configHandler.GetString(&quot;LuaRules&quot;, &quot;1&quot;);
+		gs-&gt;useLuaGaia  = CLuaGaia::SetConfigString(luaGaiaStr);
+		gs-&gt;useLuaRules = CLuaRules::SetConfigString(luaRulesStr);
+		if (gs-&gt;useLuaGaia) {
+			gs-&gt;gaiaTeamID = gs-&gt;activeTeams;
+			gs-&gt;gaiaAllyTeamID = gs-&gt;activeAllyTeams;
+			gs-&gt;activeTeams++;
+			gs-&gt;activeAllyTeams++;
+			CTeam* team = gs-&gt;Team(gs-&gt;gaiaTeamID);
+			team-&gt;color[0] = 255;
+			team-&gt;color[1] = 255;
+			team-&gt;color[2] = 255;
+			team-&gt;color[3] = 255;
+			team-&gt;gaia = true;
+			gs-&gt;SetAllyTeam(gs-&gt;gaiaTeamID, gs-&gt;gaiaAllyTeamID);
+		}
+	}
+
+	ENTER_MIXED;
+
+	bool server = true;
+
+	if (!demofile.empty()) {
+		server = false;
+	}
+	else if (gameSetup) {
+		// first real player is demo host
+		server = (gameSetup-&gt;myPlayerNum == gameSetup-&gt;numDemoPlayers) &amp;&amp; !cmdline-&gt;result(&quot;client&quot;);
+	}
+	else {
+		server = !cmdline-&gt;result(&quot;client&quot;) || cmdline-&gt;result(&quot;server&quot;);
+	}
+
+#ifdef SYNCDEBUG
+	// initialize sync debugger as soon as we know whether we will be server
+	CSyncDebugger::GetInstance()-&gt;Initialize(server);
+#endif
+
+	if (!demofile.empty()) {
+		pregame = SAFE_NEW CPreGame(false, demofile, &quot;&quot;);
+	} else {
+		pregame = SAFE_NEW CPreGame(server, &quot;&quot;, savefile);
+	}
+}
+
+
+/**
+ * @return return code of activecontroller draw function
+ *
+ * Draw function repeatedly called, it calls all the
+ * other draw functions
+ */
+int SpringApp::Update ()
+{
+	if (FSAA)
+		glEnable(GL_MULTISAMPLE_ARB);
+
+	mouseInput-&gt;Update();
+
+	int ret = 1;
+	if (activeController) {
+		if (!activeController-&gt;Update()) {
+			ret = 0;
+		} else {
+			ret = activeController-&gt;Draw();
+		}
+	}
+
+	VSync.Delay();
+	SDL_GL_SwapBuffers();
+
+	if (FSAA)
+		glDisable(GL_MULTISAMPLE_ARB);
+
+	return ret;
+}
+
+/**
+ * Tests SDL keystates and sets values
+ * in key array
+ */
+void SpringApp::UpdateSDLKeys ()
+{
+	int numkeys;
+	Uint8 *state;
+	state = SDL_GetKeyState(&amp;numkeys);
+	memcpy(keys, state, sizeof(Uint8) * numkeys);
+
+	const SDLMod mods = SDL_GetModState();
+	keys[SDLK_LALT]   = (mods &amp; KMOD_ALT)   ? 1 : 0;
+	keys[SDLK_LCTRL]  = (mods &amp; KMOD_CTRL)  ? 1 : 0;
+	keys[SDLK_LMETA]  = (mods &amp; KMOD_META)  ? 1 : 0;
+	keys[SDLK_LSHIFT] = (mods &amp; KMOD_SHIFT) ? 1 : 0;
+}
+
+/**
+ * @param argc argument count
+ * @param argv array of argument strings
+ *
+ * Executes the application
+ * (contains main game loop)
+ */
+int SpringApp::Run (int argc, char *argv[])
+{
+	INIT_SYNCIFY;
+	CheckCmdLineFile (argc, argv);
+	cmdline = BaseCmd::initialize(argc,argv);
+/*
+	logOutput.Print (&quot;Testing error catching&quot;);
+	try {
+		int *i_=0;
+		*i_=1;
+		logOutput.Print (&quot;Error catching doesn't work!&quot;);
+	} catch(...) {
+		logOutput.Print (&quot;Error catching works!&quot;);
+	}
+*/
+	if (!Initialize ())
+		return -1;
+
+#ifdef WIN32
+	SDL_EventState (SDL_SYSWMEVENT, SDL_ENABLE);
+#endif
+
+	SDL_Event event;
+	bool done = false;
+
+	while (!done) {
+		ENTER_UNSYNCED;
+		while (SDL_PollEvent(&amp;event)) {
+			switch (event.type) {
+				case SDL_VIDEORESIZE: {
+					screenWidth = event.resize.w;
+					screenHeight = event.resize.h;
+#ifndef WIN32
+					// HACK   We don't want to break resizing on windows (again?),
+					//        so someone should test this very well before enabling it.
+					SetSDLVideoMode();
+#endif
+					InitOpenGL();
+					activeController-&gt;ResizeEvent();
+					break;
+				}
+				case SDL_VIDEOEXPOSE: {
+					// re-initialize the stencil
+					glClearStencil(0);
+					glClear(GL_STENCIL_BUFFER_BIT); SDL_GL_SwapBuffers();
+					glClear(GL_STENCIL_BUFFER_BIT); SDL_GL_SwapBuffers();
+					SetupViewportGeometry();
+					break;
+				}
+				case SDL_QUIT: {
+					done = true;
+					break;
+				}
+				case SDL_ACTIVEEVENT: {
+					if (event.active.state &amp; SDL_APPACTIVE) {
+						gu-&gt;active = !!event.active.gain;
+					}
+					break;
+				}
+				case SDL_MOUSEMOTION:
+				case SDL_MOUSEBUTTONDOWN:
+				case SDL_MOUSEBUTTONUP:
+				case SDL_SYSWMEVENT: {
+					mouseInput-&gt;HandleSDLMouseEvent (event);
+					break;
+				}
+				case SDL_KEYDOWN: {
+					int i = event.key.keysym.sym;
+
+					const bool isRepeat = !!keys[i];
+
+					UpdateSDLKeys ();
+
+					if (activeController) {
+						if (i &lt;= SDLK_DELETE) {
+							i = tolower(i);
+						}
+						else if (i == SDLK_RSHIFT) { i = SDLK_LSHIFT; }
+						else if (i == SDLK_RCTRL)  { i = SDLK_LCTRL;  }
+						else if (i == SDLK_RMETA)  { i = SDLK_LMETA;  }
+						else if (i == SDLK_RALT)   { i = SDLK_LALT;   }
+
+						if (keyBindings) {
+							const int fakeMetaKey = keyBindings-&gt;GetFakeMetaKey();
+							if (fakeMetaKey &gt;= 0) {
+								keys[SDLK_LMETA] |= keys[fakeMetaKey];
+							}
+						}
+
+						activeController-&gt;KeyPressed(i, isRepeat);
+
+						if (activeController-&gt;userWriting){
+							// use unicode for printed characters
+							i = event.key.keysym.unicode;
+							if ((i &gt;= SDLK_SPACE) &amp;&amp; (i &lt;= SDLK_DELETE)) {
+								CGameController* ac = activeController;
+								if (ac-&gt;ignoreNextChar || ac-&gt;ignoreChar == char(i)) {
+									ac-&gt;ignoreNextChar = false;
+								} else {
+									if (i &lt; SDLK_DELETE) {
+										const int len = (int)ac-&gt;userInput.length();
+										ac-&gt;writingPos = max(0, min(len, ac-&gt;writingPos));
+										char str[2] = { char(i), 0 };
+										ac-&gt;userInput.insert(ac-&gt;writingPos, str);
+										ac-&gt;writingPos++;
+									}
+								}
+							}
+						}
+					}
+					activeController-&gt;ignoreNextChar = false;
+					break;
+				}
+				case SDL_KEYUP: {
+					int i = event.key.keysym.sym;
+
+					UpdateSDLKeys();
+
+					if (activeController) {
+						if (i &lt;= SDLK_DELETE) {
+							i = tolower(i);
+						}
+						else if (i == SDLK_RSHIFT) { i = SDLK_LSHIFT; }
+						else if (i == SDLK_RCTRL)  { i = SDLK_LCTRL;  }
+						else if (i == SDLK_RMETA)  { i = SDLK_LMETA;  }
+						else if (i == SDLK_RALT)   { i = SDLK_LALT;   }
+
+						if (keyBindings) {
+							const int fakeMetaKey = keyBindings-&gt;GetFakeMetaKey();
+							if (fakeMetaKey &gt;= 0) {
+								keys[SDLK_LMETA] |= keys[fakeMetaKey];
+							}
+						}
+
+						activeController-&gt;KeyReleased(i);
+					}
+					break;
+				}
+				default:
+					break;
+			}
+		}
+		if (globalQuit)
+			break;
+
+		if (!Update())
+			break;
+	}
+	ENTER_MIXED;
+
+	// Shutdown
+	Shutdown();
+	return 0;
+}
+
+/**
+ * Deallocates and shuts down game
+ */
+void SpringApp::Shutdown()
+{
+	if (pregame)
+		delete pregame;			//in case we exit during init
+	if (game)
+		delete game;
+	if (gameSetup)
+		delete gameSetup;
+	delete font;
+	CNamedTextures::Kill();
+	GLContext::Free();
+	ConfigHandler::Deallocate();
+	UnloadExtensions();
+	delete mouseInput;
+	SDL_WM_GrabInput(SDL_GRAB_OFF);
+	SDL_Quit();
+	delete gs;
+	delete gu;
+	END_SYNCIFY;
+#ifdef USE_MMGR
+	m_dumpMemoryReport();
+#endif
+}

Added: trunk/rts/System/SpringApp.h
===================================================================
--- trunk/rts/System/SpringApp.h	                        (rev 0)
+++ trunk/rts/System/SpringApp.h	2008-02-15 23:55:41 UTC (rev 5505)
@@ -0,0 +1,128 @@
+#ifndef SPRING_APP
+#define SPRING_APP
+
+#include &lt;string&gt;
+#include &lt;SDL_types.h&gt;
+
+class BaseCmd;
+class CGameController;
+
+/**
+ * @brief Spring App
+ *
+ * Main Spring application class launched by main()
+ */
+class SpringApp
+{
+public:
+	SpringApp (); 					//!&lt; Constructor
+	~SpringApp (); 					//!&lt; Destructor
+
+	int Run(int argc, char *argv[]); 		//!&lt; Run game loop
+
+protected:
+	bool Initialize (); 	//!&lt; Initialize app
+	void CheckCmdLineFile (int argc,char *argv[]); 	//!&lt; Check command line for files
+	void ParseCmdLine(); 				//!&lt; Parse command line
+	void CreateGameSetup (); 			//!&lt; Creates GameSetup
+	bool InitWindow (const char* title); 		//!&lt; Initializes window
+	void InitOpenGL (); 				//!&lt; Initializes OpenGL
+	bool SetSDLVideoMode(); 			//!&lt; Sets SDL video mode
+	void Shutdown (); 				//!&lt; Shuts down application
+	int Update (); 					//!&lt; Run simulation and draw
+	void UpdateSDLKeys (); 				//!&lt; Update SDL key array
+	bool GetDisplayGeometry();
+	void SetupViewportGeometry();
+
+	/**
+	 * @brief command line
+	 *
+	 * Pointer to instance of commandline parser
+	 */
+	BaseCmd *cmdline;
+
+	/**
+	 * @brief demofile
+	 *
+	 * Name of a demofile
+	 */
+	std::string demofile;
+
+	/**
+	 * @brief savefile
+	 *
+	 * Name of a savefile
+	 */
+	std::string savefile;
+
+	/**
+	 * @brief startscript
+	 *
+	 * Name of a start script
+	 */
+	std::string startscript;
+
+	/**
+	 * @brief screen width
+	 *
+	 * Game screen width
+	 */
+	int screenWidth;
+
+	/**
+	 * @brief screen height
+	 *
+	 * Game screen height
+	 */
+	int screenHeight;
+
+	/**
+	 * @brief FSAA
+	 *
+	 * Level of fullscreen anti-aliasing
+	 */
+	bool FSAA;
+
+private:
+	static void SigAbrtHandler(int unused);
+};
+
+
+/**
+ * @brief current active controller
+ *
+ * Pointer to the currently active controller
+ * (could be a PreGame, could be a Game, etc)
+ */
+extern CGameController* activeController;
+
+/**
+ * @brief global quit
+ *
+ * Global boolean indicating whether the user
+ * wants to quit
+ */
+extern bool globalQuit;
+
+/**
+ * @brief keys
+ *
+ * Array of possible keys, and which are being pressed
+ */
+extern Uint8 *keys;
+
+/**
+ * @brief fullscreen
+ *
+ * Whether or not the game is running in fullscreen
+ */
+extern bool fullscreen;
+
+#ifdef WIN32
+/**
+ * Win32 only: command line passed to WinMain() (not including exe filename)
+ */
+static const char *win_lpCmdLine=0;
+#endif
+
+#endif

Modified: trunk/rts/build/kdevelop/rts.kdevelop
===================================================================
--- trunk/rts/build/kdevelop/rts.kdevelop	2008-02-15 23:16:09 UTC (rev 5504)
+++ trunk/rts/build/kdevelop/rts.kdevelop	2008-02-15 23:55:41 UTC (rev 5505)
@@ -138,10 +138,10 @@
     &lt;qt&gt;
       &lt;used&gt;false&lt;/used&gt;
       &lt;version&gt;3&lt;/version&gt;
-      &lt;root&gt;/usr/share/qt3&lt;/root&gt;
+      &lt;root&gt;/usr/qt/3&lt;/root&gt;
       &lt;includestyle&gt;3&lt;/includestyle&gt;
       &lt;designerintegration&gt;EmbeddedKDevDesigner&lt;/designerintegration&gt;
-      &lt;qmake&gt;/usr/bin/qmake-qt3&lt;/qmake&gt;
+      &lt;qmake&gt;/usr/qt/3/bin/qmake&lt;/qmake&gt;
       &lt;designer&gt;/usr/bin/designer&lt;/designer&gt;
       &lt;designerpluginpaths/&gt;
     &lt;/qt&gt;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000311.html">[Taspring-linux-commit] r5504 - in trunk/Lobby/AFLobby: . NSIS	src/aflobby
</A></li>
	<LI>Next message: <A HREF="000313.html">[Taspring-linux-commit] r5506 - in trunk/AI/Global/NTai/AI/NTai:	Core Tasks Units
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#312">[ date ]</a>
              <a href="thread.html#312">[ thread ]</a>
              <a href="subject.html#312">[ subject ]</a>
              <a href="author.html#312">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
