<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r5330 - in trunk/tools/springie: . Springie	Springie/Properties Springie/autohost Springie/client	Springie/doc Springie/spring Springie/utils
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-January/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5330%20-%20in%20trunk/tools/springie%3A%20.%20Springie%0A%09Springie/Properties%20Springie/autohost%20Springie/client%0A%09Springie/doc%20Springie/spring%20Springie/utils&In-Reply-To=%3CE1JEk1p-0004M9-7a%40proserver.fnord.lan%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000136.html">
   <LINK REL="Next"  HREF="000138.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r5330 - in trunk/tools/springie: . Springie	Springie/Properties Springie/autohost Springie/client	Springie/doc Springie/spring Springie/utils</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5330%20-%20in%20trunk/tools/springie%3A%20.%20Springie%0A%09Springie/Properties%20Springie/autohost%20Springie/client%0A%09Springie/doc%20Springie/spring%20Springie/utils&In-Reply-To=%3CE1JEk1p-0004M9-7a%40proserver.fnord.lan%3E"
       TITLE="[Taspring-linux-commit] r5330 - in trunk/tools/springie: . Springie	Springie/Properties Springie/autohost Springie/client	Springie/doc Springie/spring Springie/utils">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Tue Jan 15 12:32:25 CET 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000136.html">[Taspring-linux-commit] r5329 - branches/testserver
</A></li>
        <LI>Next message: <A HREF="000138.html">[Taspring-linux-commit] r5331 - in trunk/rts/lib/lua: . include
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#137">[ date ]</a>
              <a href="thread.html#137">[ thread ]</a>
              <a href="subject.html#137">[ subject ]</a>
              <a href="author.html#137">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: Licho
Date: 2008-01-15 12:32:24 +0100 (Tue, 15 Jan 2008)
New Revision: 5330

Modified:
   trunk/tools/springie/Springie.sln
   trunk/tools/springie/Springie/MainConfig.cs
   trunk/tools/springie/Springie/Program.cs
   trunk/tools/springie/Springie/Properties/Resources.Designer.cs
   trunk/tools/springie/Springie/Properties/Settings.Designer.cs
   trunk/tools/springie/Springie/Springie.csproj
   trunk/tools/springie/Springie/autohost/AutoHost.cs
   trunk/tools/springie/Springie/autohost/AutoHostConfig.cs
   trunk/tools/springie/Springie/autohost/AutoHost_commands.cs
   trunk/tools/springie/Springie/autohost/Polls.cs
   trunk/tools/springie/Springie/client/Battle.cs
   trunk/tools/springie/Springie/client/BattleDetails.cs
   trunk/tools/springie/Springie/client/TasClient.cs
   trunk/tools/springie/Springie/doc/devlog.txt
   trunk/tools/springie/Springie/doc/readme.txt
   trunk/tools/springie/Springie/spring/ConfigMaker.cs
   trunk/tools/springie/Springie/spring/UnitSync.cs
   trunk/tools/springie/Springie/utils/AutoUpdater.cs
Log:
* springie 1.02
Lots of changes, for details check readme.txt


Modified: trunk/tools/springie/Springie/MainConfig.cs
===================================================================
--- trunk/tools/springie/Springie/MainConfig.cs	2008-01-15 10:19:30 UTC (rev 5329)
+++ trunk/tools/springie/Springie/MainConfig.cs	2008-01-15 11:32:24 UTC (rev 5330)
@@ -8,7 +8,7 @@
 {
   public class MainConfig
   {
-    public const string SpringieVersion = &quot;Springie 0.99b7&quot;;
+    public const string SpringieVersion = &quot;Springie 1.03&quot;;
 
     bool autoUpdate = true;
     [Description(&quot;Should Springie automatically update itself to latest version?&quot;)]
@@ -21,15 +21,19 @@
 
 
 
-    string caVersion = &quot;288&quot;;
-    public string CaVersion
+
+    public enum CaUpdateMode {None, Stable, Latest};
+    CaUpdateMode caUpdating;
+    [Description(&quot;If you run CA updater on the server Springie can autorehost for stable or latest version of it&quot;)]
+    [Category(&quot;Springie&quot;)]
+    public CaUpdateMode CaUpdating
     {
-      get { return caVersion; }
-      set { caVersion = value; }
+      get { return caUpdating; }
+      set { caUpdating = value; }
     }
+
+   
     
-    
-    
     bool attemptToRecconnect = true;
     [Description(&quot;Should attempt to reconnect to server in case of failure?&quot;)]
     [Category(&quot;Server connection&quot;)]

Modified: trunk/tools/springie/Springie/Program.cs
===================================================================
--- trunk/tools/springie/Springie/Program.cs	2008-01-15 10:19:30 UTC (rev 5329)
+++ trunk/tools/springie/Springie/Program.cs	2008-01-15 11:32:24 UTC (rev 5330)
@@ -22,6 +22,7 @@
       Application.SetUnhandledExceptionMode(UnhandledExceptionMode.CatchException);
 
       Application.CurrentCulture = System.Globalization.CultureInfo.InvariantCulture;
+      System.Threading.Thread.CurrentThread.CurrentCulture = System.Globalization.CultureInfo.InvariantCulture;
      
       try {
         Application.EnableVisualStyles();

Modified: trunk/tools/springie/Springie/Properties/Resources.Designer.cs
===================================================================
--- trunk/tools/springie/Springie/Properties/Resources.Designer.cs	2008-01-15 10:19:30 UTC (rev 5329)
+++ trunk/tools/springie/Springie/Properties/Resources.Designer.cs	2008-01-15 11:32:24 UTC (rev 5330)
@@ -1,7 +1,7 @@
 &#65279;//------------------------------------------------------------------------------
 // &lt;auto-generated&gt;
 //     This code was generated by a tool.
-//     Runtime Version:2.0.50727.42
+//     Runtime Version:2.0.50727.1433
 //
 //     Changes to this file may cause incorrect behavior and will be lost if
 //     the code is regenerated.

Modified: trunk/tools/springie/Springie/Properties/Settings.Designer.cs
===================================================================
--- trunk/tools/springie/Springie/Properties/Settings.Designer.cs	2008-01-15 10:19:30 UTC (rev 5329)
+++ trunk/tools/springie/Springie/Properties/Settings.Designer.cs	2008-01-15 11:32:24 UTC (rev 5330)
@@ -1,7 +1,7 @@
 &#65279;//------------------------------------------------------------------------------
 // &lt;auto-generated&gt;
 //     This code was generated by a tool.
-//     Runtime Version:2.0.50727.42
+//     Runtime Version:2.0.50727.1433
 //
 //     Changes to this file may cause incorrect behavior and will be lost if
 //     the code is regenerated.
@@ -12,7 +12,7 @@
     
     
     [global::System.Runtime.CompilerServices.CompilerGeneratedAttribute()]
-    [global::System.CodeDom.Compiler.GeneratedCodeAttribute(&quot;Microsoft.VisualStudio.Editors.SettingsDesigner.SettingsSingleFileGenerator&quot;, &quot;8.0.0.0&quot;)]
+    [global::System.CodeDom.Compiler.GeneratedCodeAttribute(&quot;Microsoft.VisualStudio.Editors.SettingsDesigner.SettingsSingleFileGenerator&quot;, &quot;9.0.0.0&quot;)]
     internal sealed partial class Settings : global::System.Configuration.ApplicationSettingsBase {
         
         private static Settings defaultInstance = ((Settings)(global::System.Configuration.ApplicationSettingsBase.Synchronized(new Settings())));

Modified: trunk/tools/springie/Springie/Springie.csproj
===================================================================
--- trunk/tools/springie/Springie/Springie.csproj	2008-01-15 10:19:30 UTC (rev 5329)
+++ trunk/tools/springie/Springie/Springie.csproj	2008-01-15 11:32:24 UTC (rev 5330)
@@ -1,4 +1,4 @@
-&#65279;&lt;Project DefaultTargets=&quot;Build&quot; xmlns=&quot;<A HREF="http://schemas.microsoft.com/developer/msbuild/2003">http://schemas.microsoft.com/developer/msbuild/2003</A>&quot;&gt;
+&#65279;&lt;Project DefaultTargets=&quot;Build&quot; xmlns=&quot;<A HREF="http://schemas.microsoft.com/developer/msbuild/2003">http://schemas.microsoft.com/developer/msbuild/2003</A>&quot; ToolsVersion=&quot;3.5&quot;&gt;
   &lt;PropertyGroup&gt;
     &lt;Configuration Condition=&quot; '$(Configuration)' == '' &quot;&gt;Debug&lt;/Configuration&gt;
     &lt;Platform Condition=&quot; '$(Platform)' == '' &quot;&gt;AnyCPU&lt;/Platform&gt;
@@ -38,6 +38,12 @@
     &lt;AllowUnsafeBlocks&gt;False&lt;/AllowUnsafeBlocks&gt;
     &lt;NoStdLib&gt;False&lt;/NoStdLib&gt;
     &lt;TreatWarningsAsErrors&gt;false&lt;/TreatWarningsAsErrors&gt;
+    &lt;FileUpgradeFlags&gt;
+    &lt;/FileUpgradeFlags&gt;
+    &lt;UpgradeBackupLocation&gt;
+    &lt;/UpgradeBackupLocation&gt;
+    &lt;OldToolsVersion&gt;2.0&lt;/OldToolsVersion&gt;
+    &lt;ApplicationRevision&gt;0&lt;/ApplicationRevision&gt;
   &lt;/PropertyGroup&gt;
   &lt;PropertyGroup Condition=&quot; '$(Configuration)|$(Platform)' == 'Debug|AnyCPU' &quot;&gt;
     &lt;DebugSymbols&gt;true&lt;/DebugSymbols&gt;

Modified: trunk/tools/springie/Springie/autohost/AutoHost.cs
===================================================================
--- trunk/tools/springie/Springie/autohost/AutoHost.cs	2008-01-15 10:19:30 UTC (rev 5329)
+++ trunk/tools/springie/Springie/autohost/AutoHost.cs	2008-01-15 11:32:24 UTC (rev 5330)
@@ -246,10 +246,10 @@
       Battle b = tas.GetBattle();
 
       if (b != null &amp;&amp; b.ContainsUser(e.ServerParams[0], out u)) {
-        if (u.SyncStatus == SyncStatuses.Unsynced) {
+        /*if (u.SyncStatus == SyncStatuses.Unsynced) {
           SayBattle(&quot;kicking &quot; + u.name + &quot; - has incorrect spring or mod version&quot;);
           tas.Kick(u.name);
-        }
+        }*/
 
         if (KickSpectators &amp;&amp; u.IsSpectator == true &amp;&amp; u.name != tas.UserName) {
           SayBattle(config.KickSpectatorText);
@@ -274,6 +274,9 @@
     void tas_BattleMapChanged(object sender, TasEventArgs e)
     {
       if (config.DisplayMapLink) SayBattle(&quot;maplink: &quot; + linker.GetMapBounceLink(tas.GetBattle().Map.Name));
+      foreach (UserBattleStatus p in tas.GetBattle().Users) { //ring all people that host changed the map
+        tas.Ring(p.name);
+      }
     }
 
 
@@ -310,7 +313,8 @@
       }
     }
 
-    private void HandleMinRankKicking() {
+    private void HandleMinRankKicking()
+    {
       if (kickMinRank &amp;&amp; config.MinRank &gt; 0) {
         Battle b = tas.GetBattle();
         if (b != null) {
@@ -343,7 +347,7 @@
       HandleAutoLocking();
       HandleMinRankKicking();
 
-     
+
       if (minCpuSpeed &gt; 0) {
         User u;
         if (tas.GetExistingUser(name, out u)) {
@@ -753,7 +757,7 @@
             break;
 
 
-          case &quot;voteteboss&quot;:
+          case &quot;voteboss&quot;:
             StartVote(new VoteBoss(tas, spring, this), e, words);
             break;
 
@@ -799,6 +803,18 @@
             if (spring.IsRunning) spring.SayGame(&quot;.cheats&quot;);
             break;
 
+          case &quot;listoptions&quot;:
+            ComListOptions(e, words);
+            break;
+
+          case &quot;setoptions&quot;:
+            ComSetOption(e, words);
+            break;
+
+          case &quot;votesetoptions&quot;:
+            StartVote(new VoteSetOptions(tas, spring, this), e, words);
+            break;
+
         }
       }
     }

Modified: trunk/tools/springie/Springie/autohost/AutoHostConfig.cs
===================================================================
--- trunk/tools/springie/Springie/autohost/AutoHostConfig.cs	2008-01-15 10:19:30 UTC (rev 5329)
+++ trunk/tools/springie/Springie/autohost/AutoHostConfig.cs	2008-01-15 11:32:24 UTC (rev 5330)
@@ -374,6 +374,13 @@
 
       AddMissing(new CommandConfig(&quot;listpresets&quot;, 0, &quot;[&lt;presetname&gt;..] - lists all presets this server has (with name filtering)&quot;, 5), addedCommands);
 
+      AddMissing(new CommandConfig(&quot;listoptions&quot;, 1, &quot; - lists all mod/map options&quot;, 5), addedCommands);
+
+      AddMissing(new CommandConfig(&quot;setoptions&quot;, 1, &quot;&lt;name&gt;=&lt;value&gt;[,&lt;name&gt;=&lt;value&gt;] - applies mod/map options&quot;, 0), addedCommands);
+      
+      AddMissing(new CommandConfig(&quot;votesetoptions&quot;, 1, &quot;&lt;name&gt;=&lt;value&gt;[,&lt;name&gt;=&lt;value&gt;] - starts a vote to apply mod/map options&quot;, 0), addedCommands);
+
+
       AddMissing(new CommandConfig(&quot;preset&quot;, 2, &quot;[&lt;presetname&gt;..] - applies given preset to current battle&quot;), addedCommands);
 
       AddMissing(new CommandConfig(&quot;votepreset&quot;, 0, &quot;[&lt;presetname&gt;..] - starts a vote to apply given preset&quot;), addedCommands);

Modified: trunk/tools/springie/Springie/autohost/AutoHost_commands.cs
===================================================================
--- trunk/tools/springie/Springie/autohost/AutoHost_commands.cs	2008-01-15 10:19:30 UTC (rev 5329)
+++ trunk/tools/springie/Springie/autohost/AutoHost_commands.cs	2008-01-15 11:32:24 UTC (rev 5330)
@@ -598,10 +598,10 @@
 
     private static string GetClan(string name)
     {
-      string[] parts = name.Split(new char[] { '[', ']' }, StringSplitOptions.RemoveEmptyEntries);
-      if (parts.Length &gt;= 2) {
-        if (parts[0].Length &gt; parts[1].Length) return parts[1]; else return parts[0];
-      } return &quot;&quot;;
+      foreach (Match m in Regex.Matches(name, &quot;\\[([^\\]]+)\\]&quot;)) {
+        return m.Groups[1].Value;
+      }
+      return &quot;&quot;;
     }
 
     private void BalanceTeams(int teamCount, bool clanwise)
@@ -1190,6 +1190,70 @@
     }
 
 
+    private void ComListOptions(TasSayEventArgs e, string[] words)
+    {
+      Battle b = tas.GetBattle();
+      if (b.Mod.Options.Count == 0) {
+        Respond(e, &quot;this mod has no options&quot;);
+      } else {
+        foreach (UnitSync.Option opt in b.Mod.Options) {
+          Respond(e, opt.ToString());
+        }
+      }
+    }
 
+
+    public string GetOptionsString(TasSayEventArgs e, string[] words)
+    {
+      string s = Utils.Glue(words);
+      string result = &quot;&quot;;
+      string[] pairs = s.Split(new char[] { ',' });
+      if (pairs.Length == 0 || pairs[0].Length == 0) {
+        Respond(e, &quot;requires key=value format&quot;);
+        return &quot;&quot;;
+      }
+      foreach (string pair in pairs) {
+        string[] parts = pair.Split(new char[] { '=' }, 2);
+        if (parts.Length != 2) {
+          Respond(e, &quot;requires key=value format&quot;);
+          return &quot;&quot;;
+        }
+        Battle b = tas.GetBattle();
+        string key = parts[0];
+        string val = parts[1];
+
+        bool found = false;
+        foreach (UnitSync.Option o in b.Mod.Options) {
+
+          if (o.Key == key) {
+            found = true;
+            string res;
+            if (o.GetPair(val, out res)) {
+              if (result != &quot;&quot;) result += &quot;\t&quot;;
+              result += res;
+            } else {
+              Respond(e, &quot;Value &quot; + val + &quot; is not valid for this option&quot;);
+            }
+
+            break;
+          }
+        }
+        if (!found) {
+          Respond(e, &quot;No option called &quot; + key + &quot; found&quot;);
+          return &quot;&quot;;
+        }
+      }
+      return result;
+    }
+     
+
+
+
+
+    private void ComSetOption(TasSayEventArgs e, string[] words)
+    {
+      string ret = GetOptionsString(e, words);
+      if (ret != &quot;&quot;) tas.SetScriptTag(ret);
+    }
   }
 }

Modified: trunk/tools/springie/Springie/autohost/Polls.cs
===================================================================
--- trunk/tools/springie/Springie/autohost/Polls.cs	2008-01-15 10:19:30 UTC (rev 5329)
+++ trunk/tools/springie/Springie/autohost/Polls.cs	2008-01-15 11:32:24 UTC (rev 5330)
@@ -538,6 +538,48 @@
   }
 
 
+  /************************************************************************/
+  /*     VOTE SETOPTIONS                                                  */
+  /************************************************************************/
+  public class VoteSetOptions : AbstractPoll, IVotable
+  {
+    string scriptTagsFormat;
+    string wordFormat;
 
+    public VoteSetOptions(TasClient tas, Spring spring, AutoHost ah) : base(tas, spring, ah) { }
+
+    public bool Init(TasSayEventArgs e, string[] words)
+    {
+      wordFormat = Utils.Glue(words);
+      scriptTagsFormat = ah.GetOptionsString(e, words);
+      if (scriptTagsFormat == &quot;&quot;) return false;
+      else {
+        ah.SayBattle(&quot;Do you want to apply options &quot; +wordFormat+ &quot;? !vote 1 = yes, !vote 2 = no&quot;);
+        return true;
+      }
+    }
+
+
+    public bool Vote(TasSayEventArgs e, string[] words)
+    {
+      int vote;
+      if (!RegisterVote(e, words, out vote)) {
+        AutoHost.Respond(tas, spring, e, &quot;You must vote valid option/not be a spectator&quot;);
+        return false;
+      }
+
+      int winVote;
+      if (CheckEnd(out winVote)) {
+        if (winVote == 1) {
+          ah.SayBattle(&quot;vote successful - appling options &quot; + wordFormat);
+          tas.SetScriptTag(scriptTagsFormat);
+        } else {
+          ah.SayBattle(&quot;not enough votes for setoptions&quot;);
+        }
+        return true;
+      } else return false;
+    }
+  }
+
 }
 

Modified: trunk/tools/springie/Springie/client/Battle.cs
===================================================================
--- trunk/tools/springie/Springie/client/Battle.cs	2008-01-15 10:19:30 UTC (rev 5329)
+++ trunk/tools/springie/Springie/client/Battle.cs	2008-01-15 11:32:24 UTC (rev 5330)
@@ -21,8 +21,10 @@
     public bool IsLocked = false;
 
     public List&lt;UserBattleStatus&gt; Users = new List&lt;UserBattleStatus&gt;();
+    public Dictionary&lt;string, string&gt; ModOptions = new Dictionary&lt;string, string&gt;();
 
 
+
     public Dictionary&lt;int, BattleRect&gt; Rectangles = new Dictionary&lt;int, BattleRect&gt;();
 
     public List&lt;string&gt; DisabledUnits = new List&lt;string&gt;();

Modified: trunk/tools/springie/Springie/client/BattleDetails.cs
===================================================================
--- trunk/tools/springie/Springie/client/BattleDetails.cs	2008-01-15 10:19:30 UTC (rev 5329)
+++ trunk/tools/springie/Springie/client/BattleDetails.cs	2008-01-15 11:32:24 UTC (rev 5330)
@@ -15,7 +15,8 @@
   public enum BattleEndCondition : int
   {
     Continues = 0,
-    Ends = 1
+    Ends = 1,
+    Lineage = 2
   }
 
   [TypeConverter(typeof(BattleDetails.BattleDetailsConverter))]
@@ -50,7 +51,7 @@
       get { return startingEnergy; }
       set { startingEnergy = value; }
     }
-    int maxUnits = 500;
+    int maxUnits = 1000;
 
     [Category(&quot;Resources&quot;), Description(&quot;Maximum units&quot;)]
     public int MaxUnits
@@ -79,7 +80,7 @@
     }
 
 
-    int limitDgun = 1;
+    int limitDgun = 0;
 
     [Category(&quot;Game rules&quot;), Description(&quot;Limit dgun to start position&quot;)]
     public int LimitDgun
@@ -115,17 +116,58 @@
       if (ghostedBuildings &lt; 0) ghostedBuildings = Default.ghostedBuildings;
     }
 
-    public void AddToParamList(List&lt;object&gt; objList)
+    /// &lt;summary&gt;
+    /// parses itself from source tags
+    /// &lt;/summary&gt;
+    /// &lt;param name=&quot;source&quot;&gt;&lt;/param&gt;
+    public void Parse(string source, Dictionary&lt;string, string&gt; modOptions)
     {
+      foreach (string pair in source.Split('\t')) {
+        string[] arg = pair.Split(new char[]{'='}, 2);
+        if (arg.Length == 2) {
+          switch (arg[0]) {
+            case &quot;game/startmetal&quot;:
+              StartingMetal = int.Parse(arg[1]);
+              break;
+            case &quot;game/startenergy&quot;:
+              StartingEnergy = int.Parse(arg[1]);
+              break;
+            case &quot;game/maxunits&quot;:
+              MaxUnits = int.Parse(arg[1]);
+              break;
+            case &quot;game/startpostype&quot;:
+              StartPos = (BattleStartPos)int.Parse(arg[1]);
+              break;
+            case &quot;game/gamemode&quot;:
+              EndCondition = (BattleEndCondition)int.Parse(arg[1]);
+              break;
+            case &quot;game/limitdgun&quot;:
+              LimitDgun = int.Parse(arg[1]);
+              break;
+            case &quot;game/diminishingmms&quot;:
+              DiminishingMM = int.Parse(arg[1]);
+              break;
+            case &quot;game/ghostedbuildings&quot;:
+              GhostedBuildings = int.Parse(arg[1]);
+              break;
+            default:
+              if (arg[0].ToLower().StartsWith(&quot;game/modoptions/&quot;) || arg[0].ToLower().StartsWith(&quot;game\\modoptions\\&quot;)) {
+                string val = arg[0].Substring(16);
+                if (modOptions.ContainsKey(val)) modOptions[val] = arg[1];
+                else modOptions.Add(val, arg[1]);
+              }
+              break;
+          }
+        }
+      }
+    }
+
+
+
+    public string GetParamList()
+    {
       Validate();
-      objList.Add(startingMetal);
-      objList.Add(startingEnergy);
-      objList.Add(maxUnits);
-      objList.Add((int)startPos);
-      objList.Add((int)endCondition);
-      objList.Add(limitDgun);
-      objList.Add(diminishingMM);
-      objList.Add(ghostedBuildings);
+      return string.Format(&quot;GAME/StartMetal={0}\tGAME/StartEnergy={1}\tGAME/MaxUnits={2}\tGAME/StartPosType={3}\tGAME/GameMode={4}\tGAME/LimitDGun={5}\tGAME/DiminishingMMs={6}\tGAME/GhostedBuildings={7}&quot;, startingMetal, startingEnergy, maxUnits, (int)startPos, (int)endCondition, limitDgun, diminishingMM, ghostedBuildings);
     }
 
     #region ICloneable Members

Modified: trunk/tools/springie/Springie/client/TasClient.cs
===================================================================
--- trunk/tools/springie/Springie/client/TasClient.cs	2008-01-15 10:19:30 UTC (rev 5329)
+++ trunk/tools/springie/Springie/client/TasClient.cs	2008-01-15 11:32:24 UTC (rev 5330)
@@ -29,7 +29,7 @@
     int pingInterval = 10; // how often to ping server (in seconds)
     int lastUdpSourcePort = 0;
     Timer pingTimer;
-    Timer udpPunchingTimer = new Timer(400); 
+    Timer udpPunchingTimer = new Timer(400);
     MapInfo mapToChangeTo;
     bool lockToChangeTo;
 
@@ -86,8 +86,8 @@
     public event EventHandler&lt;TasEventArgs&gt; BattleUserIpRecieved;
     public event EventHandler&lt;TasEventArgs&gt; BattleMapChanged;
     public event EventHandler&lt;TasEventArgs&gt; BattleLockChanged;
+    public event EventHandler&lt;TasEventArgs&gt; BattleDisabledUnitsChanged;
     public event EventHandler&lt;TasEventArgs&gt; BattleDetailsChanged;
-    public event EventHandler&lt;TasEventArgs&gt; BattleDisabledUnitsChanged;
 
     public event EventHandler&lt;TasEventArgs&gt; BattleFound;
 
@@ -207,7 +207,7 @@
 
       if (Registry.GetValue(&quot;HKEY_LOCAL_MACHINE\\HARDWARE\\DESCRIPTION\\SYSTEM\\CentralProcessor\\0&quot;, &quot;VendorIdentifier&quot;, 0).ToString().Contains(&quot;AMD&quot;)) {
         Match m = Regex.Match(Registry.GetValue(&quot;HKEY_LOCAL_MACHINE\\HARDWARE\\DESCRIPTION\\SYSTEM\\CentralProcessor\\0&quot;, &quot;ProcessorNameString&quot;, 0).ToString(), &quot;[^0-9]*([0-9]*)&quot;);
-        if (m.Groups.Count &gt; 1 ) mhz2 = m.Groups[1].Value;
+        if (m.Groups.Count &gt; 1) mhz2 = m.Groups[1].Value;
 
         int i, o;
         int.TryParse(mhz2, out o);
@@ -292,16 +292,17 @@
       SendUdpPacket(lastUdpSourcePort, serverIp, serverUdpHolePunchingPort);
     }
 
-    private void SendUdpPacket(int sourcePort, IPAddress targetIp, int targetPort) {
+    private void SendUdpPacket(int sourcePort, IPAddress targetIp, int targetPort)
+    {
       IPAddress[] ret = Dns.GetHostAddresses(serverHost);
 
       Socket s = new Socket(AddressFamily.InterNetwork, SocketType.Dgram, ProtocolType.Udp);
-      
+
       IPEndPoint local = new IPEndPoint(IPAddress.Any, sourcePort);
       s.Bind(local);
       //s.ExclusiveAddressUse = false;
       lastUdpSourcePort = ((IPEndPoint)s.LocalEndPoint).Port;
-      
+
       s.Connect(targetIp, targetPort);
       s.Send(ASCIIEncoding.ASCII.GetBytes(UserName));
       s.Close();
@@ -356,7 +357,7 @@
       objList.Add(battle.Password);
       objList.Add(battle.HostPort);
       objList.Add(battle.MaxPlayers); ;
-      battle.Details.AddToParamList(objList);
+      //battle.Details.AddToParamList(objList);
       objList.Add(battle.Mod.Checksum);
       objList.Add(battle.Rank);
       objList.Add(battle.Map.Checksum);
@@ -481,12 +482,16 @@
     {
       if (battle != null) {
         List&lt;object&gt; objList = new List&lt;object&gt;();
-
-        bd.AddToParamList(objList);
-        con.SendCommand(0, &quot;UPDATEBATTLEDETAILS&quot;, objList.ToArray());
+        con.SendCommand(0, &quot;SETSCRIPTTAGS&quot;, bd.GetParamList());
       }
     }
 
+    public void SetScriptTag(string data)
+    {
+      con.SendCommand(0, &quot;SETSCRIPTTAGS&quot;, data);
+    }
+
+
     private void OnConnectionClosed(object sender, EventArgs args)
     {
       if (sender == con) {
@@ -567,6 +572,7 @@
     /// &lt;param name=&quot;args&quot;&gt;command arguments&lt;/param&gt;
     private void DispatchServerCommand(string command, string[] args)
     {
+      System.Threading.Thread.CurrentThread.CurrentCulture = System.Globalization.CultureInfo.InvariantCulture;
       try {
         switch (command) {
 
@@ -605,134 +611,135 @@
               if (args.Length &gt;= 3) c.topic = Utils.Glue(args, 2);
               existingChannels.Add(c.name, c);
             }
-            break;
+          break;
 
           case &quot;ENDOFCHANNELS&quot;: // end of channel list iteration
-            isChanScanning = false;
-            if (ChannelListDone != null) ChannelListDone(this, new TasEventArgs());
-            break;
+          isChanScanning = false;
+          if (ChannelListDone != null) ChannelListDone(this, new TasEventArgs());
+          break;
 
           case &quot;ADDUSER&quot;: // new user joined ta server
           {
-              User u = User.Create(args[0]);
-              u.country = args[1];
-              int.TryParse(args[2], out u.cpu);
-              //IPAddress.TryParse(args[3], out u.ip);
-              existingUsers.Add(u.name, u);
-              if (UserAdded != null) UserAdded(this, new TasEventArgs(args));
-            }
-            break;
+            User u = User.Create(args[0]);
+            u.country = args[1];
+            int.TryParse(args[2], out u.cpu);
+            //IPAddress.TryParse(args[3], out u.ip);
+            existingUsers.Add(u.name, u);
+            if (UserAdded != null) UserAdded(this, new TasEventArgs(args));
+          }
+          break;
 
           case &quot;REMOVEUSER&quot;:  // user left ta server
-            existingUsers.Remove(args[0]);
-            if (UserRemoved != null) UserRemoved(this, new TasEventArgs(args));
-            break;
+          existingUsers.Remove(args[0]);
+          if (UserRemoved != null) UserRemoved(this, new TasEventArgs(args));
+          break;
 
           case &quot;MOTD&quot;: // server motd
-            if (Said != null &amp;&amp; args.Length &gt; 0) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Server, TasSayEventArgs.Places.Motd, &quot;&quot;, &quot;&quot;, Utils.Glue(args, 0), false));
-            break;
+          if (Said != null &amp;&amp; args.Length &gt; 0) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Server, TasSayEventArgs.Places.Motd, &quot;&quot;, &quot;&quot;, Utils.Glue(args, 0), false));
+          break;
 
           case &quot;SERVERMSG&quot;: // server message
-            if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Server, TasSayEventArgs.Places.Normal, &quot;&quot;, &quot;&quot;, Utils.Glue(args, 0), false));
-            break;
+          if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Server, TasSayEventArgs.Places.Normal, &quot;&quot;, &quot;&quot;, Utils.Glue(args, 0), false));
+          break;
 
           case &quot;SERVERMSGBOX&quot;: // server messagebox
-            if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Server, TasSayEventArgs.Places.MessageBox, &quot;&quot;, &quot;&quot;, Utils.Glue(args, 0), false));
-            break;
+          if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Server, TasSayEventArgs.Places.MessageBox, &quot;&quot;, &quot;&quot;, Utils.Glue(args, 0), false));
+          break;
 
           case &quot;CHANNELMESSAGE&quot;: // server broadcast to channel
-            if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Server, TasSayEventArgs.Places.Channel, args[0], &quot;&quot;, Utils.Glue(args, 1), false));
-            break;
+          if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Server, TasSayEventArgs.Places.Channel, args[0], &quot;&quot;, Utils.Glue(args, 1), false));
+          break;
 
           case &quot;SAID&quot;: // someone said something in channel
-            if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Player, TasSayEventArgs.Places.Channel, args[0], args[1], Utils.Glue(args, 2), false));
-            break;
+          if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Player, TasSayEventArgs.Places.Channel, args[0], args[1], Utils.Glue(args, 2), false));
+          break;
 
           case &quot;SAIDEX&quot;: // someone said something with emote in channel
-            if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Player, TasSayEventArgs.Places.Channel, args[0], args[1], Utils.Glue(args, 2), true));
-            break;
+          if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Player, TasSayEventArgs.Places.Channel, args[0], args[1], Utils.Glue(args, 2), true));
+          break;
 
           case &quot;SAYPRIVATE&quot;: // sent back from sever when user sends private message
-            if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Player, TasSayEventArgs.Places.Normal, args[0], username, Utils.Glue(args, 1), false)); // channel = char partner name
-            break;
+          if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Player, TasSayEventArgs.Places.Normal, args[0], username, Utils.Glue(args, 1), false)); // channel = char partner name
+          break;
 
           case &quot;SAIDPRIVATE&quot;: // someone said something to me
-            if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Player, TasSayEventArgs.Places.Normal, args[0], args[0], Utils.Glue(args, 1), false));
-            break;
+          if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Player, TasSayEventArgs.Places.Normal, args[0], args[0], Utils.Glue(args, 1), false));
+          break;
 
           case &quot;SAIDBATTLE&quot;: // someone said something in battle
-            if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Player, TasSayEventArgs.Places.Battle, &quot;&quot;, args[0], Utils.Glue(args, 1), false));
-            break;
+          if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Player, TasSayEventArgs.Places.Battle, &quot;&quot;, args[0], Utils.Glue(args, 1), false));
+          break;
 
           case &quot;SAIDBATTLEEX&quot;: // someone said in battle with emote
-            if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Player, TasSayEventArgs.Places.Battle, &quot;&quot;, args[0], Utils.Glue(args, 1), true));
-            break;
+          if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Player, TasSayEventArgs.Places.Battle, &quot;&quot;, args[0], Utils.Glue(args, 1), true));
+          break;
 
           case &quot;BROADCAST&quot;: // server sends urgent broadcast
-            if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Server, TasSayEventArgs.Places.Broadcast, &quot;&quot;, &quot;&quot;, Utils.Glue(args, 0), false));
-            break;
+          if (Said != null) Said(this, new TasSayEventArgs(TasSayEventArgs.Origins.Server, TasSayEventArgs.Places.Broadcast, &quot;&quot;, &quot;&quot;, Utils.Glue(args, 0), false));
+          break;
 
           case &quot;REDIRECT&quot;: // server sends backup IP
-            // removed due to bugs         
-            break;
+          // removed due to bugs         
+          break;
 
           case &quot;CLIENTSTATUS&quot;: // client's status changed
           {
-              int status = 0;
-              int.TryParse(args[1], out status);
-              User u = existingUsers[args[0]];
-              u.FromInt(status);
-              
-              if (u.name == UserName &amp;&amp; (u.isInGame == true &amp;&amp; existingUsers[args[0]].isInGame == false)) {
-                existingUsers[args[0]] = u;
-                if (MyStatusChangedToInGame != null) MyStatusChangedToInGame(this, new TasEventArgs());
-              }
+            int status = 0;
+            int.TryParse(args[1], out status);
+            User u = existingUsers[args[0]];
+            u.FromInt(status);
 
+            if (u.name == UserName &amp;&amp; (u.isInGame == true &amp;&amp; existingUsers[args[0]].isInGame == false)) {
               existingUsers[args[0]] = u;
-              if (UserStatusChanged != null) UserStatusChanged(this, new TasEventArgs(args));
+              if (MyStatusChangedToInGame != null) MyStatusChangedToInGame(this, new TasEventArgs());
             }
-            break;
 
+            existingUsers[args[0]] = u;
+            if (UserStatusChanged != null) UserStatusChanged(this, new TasEventArgs(args));
+          }
+          break;
+
           case &quot;CLIENTS&quot;: // client list sent after channel join
-            string[] usrs = Utils.Glue(args, 1).Split(' ');
-            foreach (string s in usrs) {
-              joinedChannels[args[0]].channelUsers.Add(s);
-            }
-            if (ChannelUserAdded != null) ChannelUserAdded(this, new TasEventArgs(args[0]));
-            break;
+          string[] usrs = Utils.Glue(args, 1).Split(' ');
+          foreach (string s in usrs) {
+            joinedChannels[args[0]].channelUsers.Add(s);
+          }
+          if (ChannelUserAdded != null) ChannelUserAdded(this, new TasEventArgs(args[0]));
+          break;
 
           case &quot;JOINED&quot;: // user joined one of my channels
-            joinedChannels[args[0]].channelUsers.Add(args[1]);
-            if (ChannelUserAdded != null) ChannelUserAdded(this, new TasEventArgs(args[0]));
-            break;
+          joinedChannels[args[0]].channelUsers.Add(args[1]);
+          if (ChannelUserAdded != null) ChannelUserAdded(this, new TasEventArgs(args[0]));
+          break;
 
           case &quot;LEFT&quot;:  // user left one of my channels
-            joinedChannels[args[0]].channelUsers.Remove(args[1]);
-            if (ChannelUserRemoved != null) ChannelUserRemoved(this, new TasEventArgs(args[0], args[1], Utils.Glue(args, 2)));
-            break;
+          joinedChannels[args[0]].channelUsers.Remove(args[1]);
+          if (ChannelUserRemoved != null) ChannelUserRemoved(this, new TasEventArgs(args[0], args[1], Utils.Glue(args, 2)));
+          break;
 
           case &quot;CHANNELTOPIC&quot;: // channel topic update (after joining a channel)
           {
-              Channel c = joinedChannels[args[0]];
-              c.topicSetBy = args[1];
-              c.topicSetDate = ConvertMilisecondTime(args[2]);
-              c.topic = Utils.Glue(args, 3);
-              if (ChannelTopicChanged != null) ChannelTopicChanged(this, new TasEventArgs(args[0]));
-            }
-            break;
+            Channel c = joinedChannels[args[0]];
+            c.topicSetBy = args[1];
+            c.topicSetDate = ConvertMilisecondTime(args[2]);
+            c.topic = Utils.Glue(args, 3);
+            if (ChannelTopicChanged != null) ChannelTopicChanged(this, new TasEventArgs(args[0]));
+          }
+          break;
 
           case &quot;OPENBATTLEFAILED&quot;: // opening new battle has failed
-            if (BattleOpenFailed != null) BattleOpenFailed(this, new TasEventArgs(Utils.Glue(args)));
-            break;
+          if (BattleOpenFailed != null) BattleOpenFailed(this, new TasEventArgs(Utils.Glue(args)));
+          break;
 
           case &quot;OPENBATTLE&quot;: // openbattle ok
             {
-              battleID = int.Parse(args[0]);
-              UserBattleStatus self = new UserBattleStatus(username);
-              self.IsSpectator = true;
-              battle.Users.Add(self); // add self
-              if (BattleOpened != null) BattleOpened(this, new TasEventArgs(args[0]));
-            }
+            battleID = int.Parse(args[0]);
+            UserBattleStatus self = new UserBattleStatus(username);
+            self.IsSpectator = true;
+            battle.Users.Add(self); // add self
+            UpdateBattleDetails(battle.Details);
+            if (BattleOpened != null) BattleOpened(this, new TasEventArgs(args[0]));
+          }
             break;
 
           case &quot;REQUESTBATTLESTATUS&quot;: // server asks us to update our status
@@ -767,7 +774,7 @@
                 bs.SetFrom(int.Parse(args[1]), int.Parse(args[2]));
                 battle.Users[uindex] = bs;
                 UpdateSpectators();
-                  if (BattleUserStatusChanged != null) BattleUserStatusChanged(this, new TasEventArgs(args[0]));
+                if (BattleUserStatusChanged != null) BattleUserStatusChanged(this, new TasEventArgs(args[0]));
               }
             }
             break;
@@ -789,21 +796,6 @@
             }
             break;
 
-          case &quot;UPDATEBATTLEDETAILS&quot;: // updates internal battle details
-            if (battle != null) {
-              BattleDetails bd = new BattleDetails();
-              bd.StartingMetal = int.Parse(args[0]);
-              bd.StartingEnergy = int.Parse(args[1]);
-              bd.MaxUnits = int.Parse(args[2]);
-              bd.StartPos = (BattleStartPos)int.Parse(args[3]);
-              bd.EndCondition = (BattleEndCondition)int.Parse(args[4]);
-              bd.LimitDgun = int.Parse(args[5]);
-              bd.DiminishingMM = int.Parse(args[6]);
-              bd.GhostedBuildings = int.Parse(args[7]);
-              battle.Details = bd;
-              if (BattleDetailsChanged != null) BattleDetailsChanged(this, new TasEventArgs(args));
-            }
-            break;
 
           case &quot;BATTLEOPENED&quot;: {
               if (BattleFound != null) BattleFound(this, new TasEventArgs(args));
@@ -823,6 +815,17 @@
             }
             break;
 
+
+          case &quot;SETSCRIPTTAGS&quot;: // updates internal battle details
+            if (battle != null) {
+              BattleDetails bd = new BattleDetails();
+              bd.Parse(Utils.Glue(args), battle.ModOptions);
+              battle.Details = bd;
+              if (BattleDetailsChanged != null) BattleDetailsChanged(this, new TasEventArgs(args));
+            }
+            break;
+
+
           case &quot;UDPSOURCEPORT&quot;:
             udpPunchingTimer.Stop();
             if (startingAfterUdpPunch) {
@@ -840,7 +843,7 @@
                     SendUdpPacket(lastUdpSourcePort, ubs.ip, ubs.port);
                   }
                 }
-                
+
                 battle.HostPort = lastUdpSourcePort; // update source port for hosting and start it
                 ChangeMyStatus(false, true);
               }

Modified: trunk/tools/springie/Springie/doc/devlog.txt
===================================================================
--- trunk/tools/springie/Springie/doc/devlog.txt	2008-01-15 10:19:30 UTC (rev 5329)
+++ trunk/tools/springie/Springie/doc/devlog.txt	2008-01-15 11:32:24 UTC (rev 5330)
@@ -1,40 +1,16 @@
 ===============================
-SPRINGIE 1.00
+SPRINGIE 1.x?
 ===============================
 
-- map and mod download now supports direct URL. Download progress announcing removed. Springie automatically rehosts after mod download (if not in game).
 
-- reduced lobby updategamestatus spamming
-
-- spec command added (forces spectator)
-
-- specafk command added (turns all AFK players to spectators)
-
-- tempadmin renamed to boss
-
-- fixed admin duplication bug
-
-- fixed vista IP binding bug
-
-- fixed config saving bug
-
-- force start now starts even when not all people ready
-
-- autolock now locks unlocks game at the time you issue autolock command (and not just when player count changes)
-
-- added kickminrank [0/1] enables or disables automatic kicking of people based upon their rank
-
-- polls no longer count spectator votes
-
-- added !cheats command
-
 ===============
 TODO
 ===============
-* kick with reason - stop
+* CAutohostInterface or full dedicated server support
+* fix linux compatibility
 * <A HREF="http://replays.unknown-files.net/bot_upload.php?title=title&amp;description=description">http://replays.unknown-files.net/bot_upload.php?title=title&amp;description=description</A>
 * ranked servers
 * gui - add player lists by channel
 * demo upload
-* fix linux compatibility
+* kick with reason - stop
 * reenable alternative way to determine that game has ended (people in lobby not in game)

Modified: trunk/tools/springie/Springie/doc/readme.txt
===================================================================
--- trunk/tools/springie/Springie/doc/readme.txt	2008-01-15 10:19:30 UTC (rev 5329)
+++ trunk/tools/springie/Springie/doc/readme.txt	2008-01-15 11:32:24 UTC (rev 5330)
@@ -61,6 +61,8 @@
 
 !votekickspec - starts a vote to enables or disable automatic spectator kicking
 
+!votesetoptions &lt;name&gt;=&lt;value&gt;[,&lt;name&gt;=&lt;value&gt;] - starts a vote to apply options
+
 !vote &lt;number&gt; - casts your vote (you must say it in battle window)
 
 !endvote - ends current poll
@@ -107,6 +109,10 @@
 
 !rehost [&lt;filter&gt;] - rehosts game (optionally with new mod)
 
+!listoptions - lists all mod options
+
+!setoptions &lt;name&gt;=&lt;value&gt;[,&lt;name&gt;=&lt;value&gt;] - applies mod/map options
+
 --- ADMINISTERING -- 
 !admins - list privileged users
 
@@ -150,6 +156,31 @@
 CHANGELOG
 
 ===============================
+SPRINGIE 1.00
+===============================
+- fixed compatibility with lobby protocol 0.35 (for spring 0.76)
+- added support for mod/map options - !listoptions, !setoptions, !votesetoptions
+- fixed voteboss command bug
+- changed algorithm for detecting clan (for cbalance) - it now picks first string enclosed in [ ] and assumes its a clan tag
+- disabled automatic unsynced people kicking
+- springie now rings people when map changes
+- !spec command added (forces spectator)
+- !specafk command added (turns all AFK players to spectators)
+- added !kickminrank [0/1] enables or disables automatic kicking of people based upon their rank
+- tempadmin renamed to !boss
+- added !cheats command
+- map and mod download now supports direct URL. Download progress announcing removed. Springie automatically rehosts after mod download (if not in game).
+- added optional automatic Complete Annihilation updater (set CA version to something nonzero to begin updating)
+- reduced lobby updategamestatus spamming
+- !forcestart now starts even when not all people ready
+- !autolock now locks unlocks game at the time you issue autolock command (and not just when player count changes)
+- polls no longer count spectator votes
+- fixed admin duplication bug
+- fixed vista IP binding bug
+- fixed config saving bug
+
+
+===============================
 SPRINGIE 0.99
 ===============================
 - game now auto-starts when AutoLock limit is reached and all ready/teams ok

Modified: trunk/tools/springie/Springie/spring/ConfigMaker.cs
===================================================================
--- trunk/tools/springie/Springie/spring/ConfigMaker.cs	2008-01-15 10:19:30 UTC (rev 5329)
+++ trunk/tools/springie/Springie/spring/ConfigMaker.cs	2008-01-15 11:32:24 UTC (rev 5330)
@@ -29,8 +29,8 @@
       s.AppendLine();
       s.AppendFormat(&quot;  HostIP={0};\n&quot;, &quot;127.0.0.1&quot;);
       s.AppendFormat(&quot;  HostPort={0};\n&quot;, b.HostPort);
-      s.AppendFormat(&quot;  MinSpeed={0};\n&quot;, 1);
-      s.AppendFormat(&quot;  MaxSpeed={0};\n&quot;, 1);
+      //s.AppendFormat(&quot;  MinSpeed={0};\n&quot;, 1);
+      //s.AppendFormat(&quot;  MaxSpeed={0};\n&quot;, 1);
       s.AppendLine();
       s.AppendFormat(&quot;  MyPlayerNum={0};\n&quot;, 0);
 
@@ -98,6 +98,18 @@
         s.AppendFormat(&quot;    Limit{0}=0;\n&quot;, i);
       }
       s.AppendLine(&quot;  }&quot;);
+
+      s.AppendLine(&quot;  [modoptions]&quot;);
+      s.AppendLine(&quot;  {&quot;);
+      foreach(UnitSync.Option o in b.Mod.Options) {
+        string v = o.Default;
+        if (b.ModOptions.ContainsKey(o.Key)) v = b.ModOptions[o.Key];
+        s.AppendFormat(&quot;    {0}={1};\n&quot;,  o.Key, v);
+      }
+      s.AppendLine(&quot;  }&quot;);
+
+
+
       s.AppendLine(&quot;}&quot;);
 
       StreamWriter f = File.CreateText(filename);

Modified: trunk/tools/springie/Springie/spring/UnitSync.cs
===================================================================
--- trunk/tools/springie/Springie/spring/UnitSync.cs	2008-01-15 10:19:30 UTC (rev 5329)
+++ trunk/tools/springie/Springie/spring/UnitSync.cs	2008-01-15 11:32:24 UTC (rev 5330)
@@ -34,24 +34,26 @@
         else return null;
       } else return base.ConvertTo(context, culture, value, destinationType);
     }
-    
 
+
     public override StandardValuesCollection GetStandardValues(ITypeDescriptorContext context)
     {
       return new StandardValuesCollection(GetMod().Units);
     }
 
-    private ModInfo GetMod() {
+    private ModInfo GetMod()
+    {
       if (Program.main.Tas != null) {
         Client.Battle b = Program.main.Tas.GetBattle();
         if (b != null) return b.Mod;
-      } 
+      }
       return Program.main.Spring.UnitSync.GetModInfo(Program.main.AutoHost.config.DefaultMod);
     }
 
 
   }
 
+
   [TypeConverter(typeof(UnitConverter))]
   public struct UnitInfo
   {
@@ -65,7 +67,8 @@
       this.FullName = fullName;
     }
 
-    public static string[] ToStringList(UnitInfo[] src) {
+    public static string[] ToStringList(UnitInfo[] src)
+    {
       string[] result = new string[src.Length];
       for (int i = 0; i &lt; src.Length; ++i) {
         result[i] = src[i].Name;
@@ -73,7 +76,8 @@
       return result;
     }
 
-    public static UnitInfo[] FromStringList(string[] src, ModInfo mod) {
+    public static UnitInfo[] FromStringList(string[] src, ModInfo mod)
+    {
       List&lt;UnitInfo&gt; result = new List&lt;UnitInfo&gt;();
       for (int i = 0; i &lt; src.Length; ++i) {
         UnitInfo u;
@@ -86,11 +90,16 @@
   }
 
 
+
+
+
   /// &lt;summary&gt;
   /// Represents one mod. Detailed information are loaded on demand for given mod.
   /// &lt;/summary&gt;
   public class ModInfo
   {
+    public List&lt;UnitSync.Option&gt; Options = new List&lt;UnitSync.Option&gt;();
+
     string name;
     public string Name
     {
@@ -100,9 +109,10 @@
     protected string archiveName;
     public string ArchiveName
     {
-      get { 
-        CheckLoaded(); 
-        return archiveName; 
+      get
+      {
+        CheckLoaded();
+        return archiveName;
       }
       set { archiveName = value; }
     }
@@ -143,7 +153,8 @@
     }
 
 
-    public bool GetUnitInfo(string name, out UnitInfo res) {
+    public bool GetUnitInfo(string name, out UnitInfo res)
+    {
       for (int i = 0; i &lt; Units.Length; ++i) {
         if (Units[i].Name == name) {
           res = Units[i];
@@ -230,6 +241,130 @@
 
   public class UnitSync : IDisposable
   {
+    public struct ListOption
+    {
+      public string Name;
+      public string Description;
+      public string Key;
+      public ListOption(int optionIndex, int itemIndex)
+      {
+        Name = GetOptionListItemName(optionIndex, itemIndex);
+        Description = GetOptionListItemDesc(optionIndex, itemIndex);
+        Key = GetOptionListItemKey(optionIndex, itemIndex);
+      }
+    }
+
+    public class Option
+    {
+      public enum Type : int { Error = 0, Bool = 1, List = 2, Number = 3, String = 4 };
+      string Table = &quot;GAME\\MODOPTIONS\\&quot;;
+      public Type OptionType;
+      float min = float.MinValue, max = float.MinValue, step = 0, strMaxLen = 65535;
+      public List&lt;ListOption&gt; ListOptions = new List&lt;ListOption&gt;();
+
+      public string Name;
+      public string Key;
+      public string Description;
+      public string Default;
+
+      public Option(int idx) {
+        Name = GetOptionName(idx);
+        Key = GetOptionKey(idx);
+        Description = GetOptionDesc(idx);
+        OptionType = (Type)GetOptionType(idx);
+        strMaxLen = GetOptionStringMaxLen(idx);
+        min = GetOptionNumberMin(idx);
+        max = GetOptionNumberMax(idx);
+        step = GetOptionNumberStep(idx);
+        int listCount = GetOptionListCount(idx);
+        for (int i = 0; i &lt; listCount; i++) {
+          ListOption optl = new ListOption(idx, i);
+          ListOptions.Add(optl);
+        }
+        switch (OptionType) {
+          case Type.Bool: Default = GetOptionBoolDef(idx).ToString();
+            break;
+          case Type.Number: Default = GetOptionNumberDef(idx).ToString();
+            break;
+          case Type.String: Default = GetOptionStringDef(idx);
+            break;
+          case Type.List: Default = GetOptionListDef(idx);
+            break;
+        }
+      }
+
+      private string ConstructLine(string val)
+      {
+        return Table + Key + &quot;=&quot; + val;
+      }
+
+      public bool GetPair(string Value, out string result)
+      {
+        result = &quot;&quot;;
+        switch (OptionType) {
+          case Type.Bool:
+            if (Value != &quot;0&quot; &amp;&amp; Value != &quot;1&quot;) return false;
+            result = ConstructLine(Value);
+            return true;
+
+          case Type.Number:
+            double d;
+            if (!double.TryParse(Value, out d)) return false;
+            if (d &lt; min || d &gt; max) return false;
+            result = ConstructLine(Value);
+            return true;
+
+
+          case Type.String:
+            if (Value.Length &gt; strMaxLen) return false;
+            result = ConstructLine(Value);
+            return true;
+
+
+          case Type.List:
+            foreach (ListOption lop in ListOptions) {
+              if (lop.Key == Value) {
+                result = ConstructLine(lop.Key);
+                return true;
+              }
+            }
+            return false;
+
+        }
+
+        return false;
+      }
+
+      public override string ToString()
+      {
+        string pom = &quot;&quot;;
+        string typs = &quot;&quot;;
+        if (OptionType == Type.Number) {
+          typs = &quot;x&quot;;
+          pom += &quot; = &quot;;
+          if (min != float.MinValue) pom += &quot; &gt;=&quot; + min;
+          if (max != float.MaxValue) pom += &quot; &lt;=&quot; + max;
+        }
+        if (OptionType == Type.List) {
+          pom += &quot; = &quot;;
+          foreach (ListOption lop in ListOptions) {
+            pom += lop.Key + &quot;-&quot; + lop.Description + &quot; | &quot;;
+            typs += lop.Key + &quot;|&quot;;
+          }
+        }
+        if (OptionType == Type.Bool) {
+          typs += &quot;0|1&quot;;
+        }
+        if (OptionType == Type.String) {
+          typs += &quot;s&quot;;
+        }
+
+
+        return string.Format(&quot;{0}={1}  ({2}{3})&quot;, Key, typs, Description, pom);
+
+      }
+    }
+
     public UnitSync() : this(Directory.GetCurrentDirectory()) { }
 
     string path;
@@ -305,6 +440,7 @@
 
     internal void LoadModInfo(ModInfo mi)
     {
+      System.Threading.Thread.CurrentThread.CurrentCulture = System.Globalization.CultureInfo.InvariantCulture;
       string opath = Directory.GetCurrentDirectory();
       Directory.SetCurrentDirectory(path);
       int i = mi.ModId;
@@ -337,6 +473,11 @@
         mi.Units[x] = new UnitInfo(GetUnitName(x), GetFullUnitName(x));
       }
 
+      int opts = GetModOptionCount();
+      for (int x = 0; x &lt; opts; x++) {
+        Option o = new Option(x);
+        mi.Options.Add(o);
+      }
 
       Directory.SetCurrentDirectory(opath);
     }
@@ -503,7 +644,63 @@
     [DllImport(&quot;unitsync.dll&quot;)]
     static extern string GetFullUnitName(int index);
 
+    /************************************************************************/
+    /*     OPTIONS                                                          */
+    /************************************************************************/
+    [DllImport(&quot;unitsync.dll&quot;)]
+    static extern int GetMapOptionCount(string mapName);
 
+    [DllImport(&quot;unitsync.dll&quot;)]
+    static extern int GetModOptionCount();
+
+    [DllImport(&quot;unitsync.dll&quot;)]
+    static extern string GetOptionKey(int index);
+
+    [DllImport(&quot;unitsync.dll&quot;)]
+    static extern string GetOptionName(int index);
+
+    [DllImport(&quot;unitsync.dll&quot;)]
+    static extern string GetOptionDesc(int index);
+
+    [DllImport(&quot;unitsync.dll&quot;)]
+    static extern int GetOptionType(int index);
+
+    [DllImport(&quot;unitsync.dll&quot;)]
+    static extern float GetOptionNumberMin(int index);
+
+    [DllImport(&quot;unitsync.dll&quot;)]
+    static extern float GetOptionNumberMax(int index);
+
+    [DllImport(&quot;unitsync.dll&quot;)]
+    static extern float GetOptionNumberStep(int index);
+
+    [DllImport(&quot;unitsync.dll&quot;)]
+    static extern int GetOptionStringMaxLen(int index);
+
+    [DllImport(&quot;unitsync.dll&quot;)]
+    static extern int GetOptionListCount(int index);
+
+    [DllImport(&quot;unitsync.dll&quot;)]
+    static extern string GetOptionListItemKey(int index, int itemIndex);
+
+    [DllImport(&quot;unitsync.dll&quot;)]
+    static extern string GetOptionListItemName(int index, int itemIndex);
+
+    [DllImport(&quot;unitsync.dll&quot;)]
+    static extern string GetOptionListItemDesc(int index, int itemIndex);
+
+    [DllImport(&quot;unitsync.dll&quot;)]
+    static extern int GetOptionBoolDef(int index);
+
+    [DllImport(&quot;unitsync.dll&quot;)]
+    static extern float GetOptionNumberDef(int index);
+
+    [DllImport(&quot;unitsync.dll&quot;)]
+    static extern string GetOptionStringDef(int index);
+
+    [DllImport(&quot;unitsync.dll&quot;)]
+    static extern string GetOptionListDef(int index);
+
     /*
     //     INIT
     */

Modified: trunk/tools/springie/Springie/utils/AutoUpdater.cs
===================================================================
--- trunk/tools/springie/Springie/utils/AutoUpdater.cs	2008-01-15 10:19:30 UTC (rev 5329)
+++ trunk/tools/springie/Springie/utils/AutoUpdater.cs	2008-01-15 11:32:24 UTC (rev 5330)
@@ -76,6 +76,10 @@
     {
       if (enabled &amp;&amp; !spring.IsRunning) {
         timer.Enabled = false;
+        
+        UpdateCa();
+        
+
         using (WebClient wc = new WebClient()) {
           try {
             string remoteVersion = wc.DownloadString(updateSite + &quot;version.txt&quot;).Trim();
@@ -97,8 +101,6 @@
             }
           } catch (WebException) {
           }
-
-          //UpdateCa();
         }
         timer.Enabled = true;
       }
@@ -106,16 +108,20 @@
 
     private void UpdateCa()
     {
+      if (Program.main.config.CaUpdating == MainConfig.CaUpdateMode.None) return;
       using (WebClient wc = new WebClient()) {
         try {
           string remoteVersion = wc.DownloadString(&quot;<A HREF="http://files.caspring.org/snapshots/latest_revision">http://files.caspring.org/snapshots/latest_revision</A>&quot;).Trim();
-          if (!string.IsNullOrEmpty(remoteVersion) &amp;&amp; remoteVersion != Program.main.config.CaVersion.Trim()) {
-
-            tas.Say(TasClient.SayPlace.Battle, &quot;&quot;, &quot;Springie is now downloading new version of CA - &quot; + remoteVersion, true);
-            string url = String.Format(&quot;<A HREF="http://files.caspring.org/snapshots/r{0">http://files.caspring.org/snapshots/r{0</A>}/ca-r{0}.sdz&quot;, remoteVersion);
-            Program.main.config.CaVersion = remoteVersion;
-            Program.main.SaveConfig();
-            Program.main.AutoHost.ComDlMod(TasSayEventArgs.Default, new string[] { url });
+          if (!string.IsNullOrEmpty(remoteVersion)) {
+            spring.Reload(true, false);
+            foreach (string s in spring.UnitSync.ModList.Keys) {
+              if (s.Contains(remoteVersion)) {
+                if (Program.main.config.CaUpdating == MainConfig.CaUpdateMode.Stable &amp;&amp; s.Contains(&quot;STABLE&quot;)) {
+                  tas.Say(TasClient.SayPlace.Battle, &quot;&quot;, &quot;Springie is now rehosting to new version of CA - &quot; + remoteVersion, true);
+                  Program.main.AutoHost.ComRehost(TasSayEventArgs.Default, new string[] { remoteVersion });
+                }
+              }
+            }             
           }
         } catch (WebException) {
         }

Modified: trunk/tools/springie/Springie.sln
===================================================================
--- trunk/tools/springie/Springie.sln	2008-01-15 10:19:30 UTC (rev 5329)
+++ trunk/tools/springie/Springie.sln	2008-01-15 11:32:24 UTC (rev 5330)
@@ -1,6 +1,6 @@
 &#65279;
-Microsoft Visual Studio Solution File, Format Version 9.00
-# Visual Studio 2005
+Microsoft Visual Studio Solution File, Format Version 10.00
+# Visual Studio 2008
 Project(&quot;{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}&quot;) = &quot;Springie&quot;, &quot;Springie\Springie.csproj&quot;, &quot;{DD5A4F64-6C82-4F75-9EED-992378EC65FC}&quot;
 EndProject
 Global


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000136.html">[Taspring-linux-commit] r5329 - branches/testserver
</A></li>
	<LI>Next message: <A HREF="000138.html">[Taspring-linux-commit] r5331 - in trunk/rts/lib/lua: . include
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#137">[ date ]</a>
              <a href="thread.html#137">[ thread ]</a>
              <a href="subject.html#137">[ subject ]</a>
              <a href="author.html#137">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
