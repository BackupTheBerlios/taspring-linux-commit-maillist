<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r5289 - in branches/testserver: ChanServ	WebInterface WebInterface/inc
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-January/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5289%20-%20in%20branches/testserver%3A%20ChanServ%0A%09WebInterface%20WebInterface/inc&In-Reply-To=%3CE1JBrLy-0004fp-RC%40proserver.fnord.lan%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000096.html">
   <LINK REL="Next"  HREF="000098.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r5289 - in branches/testserver: ChanServ	WebInterface WebInterface/inc</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5289%20-%20in%20branches/testserver%3A%20ChanServ%0A%09WebInterface%20WebInterface/inc&In-Reply-To=%3CE1JBrLy-0004fp-RC%40proserver.fnord.lan%3E"
       TITLE="[Taspring-linux-commit] r5289 - in branches/testserver: ChanServ	WebInterface WebInterface/inc">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Mon Jan  7 13:45:18 CET 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000096.html">[Taspring-linux-commit] r5288 - in trunk/Lobby/AFLobby/src/aflobby:	. UI framework protocol protocol/tasserver
</A></li>
        <LI>Next message: <A HREF="000098.html">[Taspring-linux-commit] r5290 - branches/testserver
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#97">[ date ]</a>
              <a href="thread.html#97">[ thread ]</a>
              <a href="subject.html#97">[ subject ]</a>
              <a href="author.html#97">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: tvo
Date: 2008-01-07 13:45:18 +0100 (Mon, 07 Jan 2008)
New Revision: 5289

Added:
   branches/testserver/WebInterface/inc/HtmlFormParser.php
   branches/testserver/WebInterface/inc/curl_phpbb.class.php
   branches/testserver/WebInterface/inc/curl_phpbb.example.php
   branches/testserver/WebInterface/userid.php
Modified:
   branches/testserver/ChanServ/RemoteAccessServer.java
   branches/testserver/WebInterface/ban.delete.php
   branches/testserver/WebInterface/ban.process.php
   branches/testserver/WebInterface/inc/constants.inc
   branches/testserver/WebInterface/searchlog.php
   branches/testserver/WebInterface/userinfo.php
Log:
svn merge -r 5227:5288 <A HREF="https://spring.clan-sy.com/svn/spring/trunk/Lobby/TASServer">https://spring.clan-sy.com/svn/spring/trunk/Lobby/TASServer</A>



Modified: branches/testserver/ChanServ/RemoteAccessServer.java
===================================================================
--- branches/testserver/ChanServ/RemoteAccessServer.java	2008-01-07 12:37:31 UTC (rev 5288)
+++ branches/testserver/ChanServ/RemoteAccessServer.java	2008-01-07 12:45:18 UTC (rev 5289)
@@ -31,11 +31,28 @@
  * * LOGINBAD
  *   Sent by server as a response to a failed TESTLOGIN command.
  *   
+ * * OK
+ *   Sent by server as a response to commands that don't return anything else. 
+ *   Serves also as positive confirmation (also see &quot;NOTOK&quot; command).
+ *   
+ * * NOTOK
+ *   Sent by server as a response to commands that require some positive/negative response (in this case, the response is negative).
+ *   Also see &quot;OK&quot; command.  
+ *   
+ * * ISONLINE username
+ *   Queries the server trying to find out if user &lt;username&gt; is currently online.
+ *   Returns either OK or NOTOK (OK if user is online, NOTOK otherwise).  
+ *   
  * * GETACCESS username
  *   Sent by client trying to figure out access status of some user.
  *   Returns 1 for &quot;normal&quot;, 2 for &quot;moderator&quot;, 3 for &quot;admin&quot;.
  *   If user is not found, returns 0 as a result.
  *   If the operation fails for some reason, socket will simply get disconnected.
+ *
+ * * GENERATEUSERID username
+ *   Will send acquireuserid command to &lt;username&gt;. This command doesn't return anything, you won't
+ *   be notified if the command succeeded or not (but new notification will be added to TASServer if
+ *   specified user responded with a USERID command properly).  
  *   
  * * QUERYSERVER {server command}  
  *   This will forward the given command directly to server and then forward server's response back to the client.
@@ -65,7 +82,8 @@
 		&quot;RELOADUPDATEPROPERTIES&quot;,
 		&quot;GETLOBBYVERSION&quot;,
 		&quot;UPDATEMOTD&quot;,
-		&quot;RETRIEVELATESTBANLIST&quot;
+		&quot;RETRIEVELATESTBANLIST&quot;,
+		&quot;GETUSERID&quot;
 		};
 	
 	public Vector threads = new Vector(); // here we keep a list of all currently running client threads
@@ -251,6 +269,33 @@
 				return ; 
 			}
 			sendLine(&quot;&quot; + (access &amp; 0x7));
+		} else if (params[0].equals(&quot;GENERATEUSERID&quot;)) {
+			if (!identified) return ;
+			if (params.length != 2) return ; // malformed command
+			if (!ChanServ.isConnected()) {
+				kill();
+				return ;
+			}
+			queryTASServer(&quot;FORGEMSG &quot; + params[1] + &quot; ACQUIREUSERID&quot;);
+			sendLine(&quot;OK&quot;);
+		} else if (params[0].equals(&quot;ISONLINE&quot;)) {
+			if (!identified) return ;
+			if (params.length != 2) return ; // malformed command
+			if (!ChanServ.isConnected()) {
+				kill();
+				return ;
+			}
+
+			boolean success = false;
+			synchronized(ChanServ.clients) {
+				for (int i = 0; i &lt; ChanServ.clients.size(); i++) {
+					if (((Client)ChanServ.clients.get(i)).name.equals(params[1])) {
+						success = true;
+						break;
+					}
+				}
+			} // end of synchronized
+			sendLine(success ? &quot;OK&quot; : &quot;NOTOK&quot;);
 		} else if (params[0].equals(&quot;QUERYSERVER&quot;)) {
 			if (!identified) return ;
 			if (params.length &lt; 2) return ; // malformed command

Modified: branches/testserver/WebInterface/ban.delete.php
===================================================================
--- branches/testserver/WebInterface/ban.delete.php	2008-01-07 12:37:31 UTC (rev 5288)
+++ branches/testserver/WebInterface/ban.delete.php	2008-01-07 12:45:18 UTC (rev 5289)
@@ -36,7 +36,41 @@
     echo '  &lt;/table&gt;';
     echo '&lt;/FORM&gt;';
   }
+  
+  function forceUpdate()
+  {
+    $conn = new ServerConnection();
+    if (($res = $conn-&gt;connect()) !== true)
+    {
+      printError(&quot;&lt;p style='color: black; font-weight: bold'&gt;&quot; . &quot;Error: &quot; . $res . &quot;&lt;/p&gt;&quot;);
+      return false;
+    }
+    if (($conn-&gt;identify()) == false)
+    {
+      printError(&quot;&lt;p style='color: black; font-weight: bold'&gt;&quot; . &quot;Error while trying to authenticate with the server&quot; . &quot;&lt;/p&gt;&quot;);
+      return false;
+    }
 
+    if (($res = $conn-&gt;sendLine(&quot;queryserver RETRIEVELATESTBANLIST&quot;)) !== TRUE)
+    {
+      printError(&quot;&lt;p style='color: black; font-weight: bold'&gt;&quot; . &quot;Error while communicating with the server&quot; . &quot;&lt;/p&gt;&quot;);
+      return false;
+    }
+    if (($res = $conn-&gt;readLine()) === FALSE)
+    {
+      printError(&quot;&lt;p style='color: black; font-weight: bold'&gt;&quot; . &quot;Error while communicating with the server&quot; . &quot;&lt;/p&gt;&quot;);
+      return false;
+    }
+
+    $res = removeBeginning($res, 'SERVERMSG ');
+    echo &quot;&lt;p&gt;Server has successfully updated ban records from the database.&lt;/p&gt;&quot;;
+
+    // close connection with server:
+    $conn-&gt;close();
+    
+    return true;
+  }  
+
   if (!$_GET[&quot;id&quot;]) {
     returnError(&quot;Ban ID is missing!&quot;);
   } else if (!($_GET[&quot;confirm&quot;] == &quot;true&quot;)) {
@@ -71,7 +105,13 @@
     
     mysql_close($dbh);
     
-    echo &quot;&lt;p&gt;Ban entry successfully deleted.&lt;/p&gt;&quot;;
+    $temp = forceUpdate();
+    if ($temp === TRUE) {
+      echo &quot;&lt;p&gt;Ban entry successfully deleted.&lt;/p&gt;&quot;;
+    } else {
+      echo &quot;&lt;p&gt;Ban entry has been successfuly deleted from the database, however when forcing server-side update, it failed. This should not happen, but it is not a critical error. You should force server-side update manually to correct it.&lt;/p&gt;&quot;;
+    }
+    
     doneButton();
   }
 

Modified: branches/testserver/WebInterface/ban.process.php
===================================================================
--- branches/testserver/WebInterface/ban.process.php	2008-01-07 12:37:31 UTC (rev 5288)
+++ branches/testserver/WebInterface/ban.process.php	2008-01-07 12:45:18 UTC (rev 5289)
@@ -1,6 +1,7 @@
 &lt;?php require(&quot;inc/head.php&quot;) ?&gt;
 
 &lt;?php 
+  require_once('inc/curl_phpbb.class.php');
   
   function returnError($err_msg) 
   {
@@ -41,8 +42,40 @@
 
     // close connection with server:
     $conn-&gt;close();
-  }  
+  }
+
+  // will try to make a post in the private moderation forum to notify other moderators about this new ban entry
+  function postOnForum($message, &amp;$errormsg) {
+    global $constants;
+  
+    $forum_id = 17;
+    $topic_id = 4091;
     
+    // The ending backslash is required.
+    $phpbb = new curl_phpbb('<A HREF="http://spring.clan-sy.com/phpbb/">http://spring.clan-sy.com/phpbb/</A>');
+    
+    // Log in
+    $r = $phpbb-&gt;login($constants['forumposter_username'], $constants['forumposter_password']);
+    if (!$r) {
+      $errormsg = 'ErrCode: ' . implode(&quot; - &quot;, $phpbb-&gt;error);
+      return false;
+    }
+
+    // Post a topic reply
+    $r = $phpbb-&gt;topic_reply_advanced($topic_id, $forum_id, $message, &amp;$errormsg);
+    if (!$r) {
+      return false;
+    }
+
+    // Log out
+    $r = $phpbb-&gt;logout();
+    if (!$r) {
+      // ignore! We were still successful
+    }
+    
+    return true;
+  }
+    
   //$bandur; // ban duration. If 1, then we banned for limited time, if 2, we banned for indefinite time
   if ($_POST[&quot;R_bandDuration&quot;] == &quot;limited&quot;) $bandur = 1;
   else if ($_POST[&quot;R_bandDuration&quot;] == &quot;unlimited&quot;) $bandur = 2;
@@ -111,6 +144,22 @@
   $insert .= ', &quot;' . $priv_reason . '&quot;';
   $insert .= ', &quot;' . $pub_reason . '&quot;';
   $insert .= &quot;)&quot;;
+  
+  // construct $forumpost, which is what we'll post on the forum:
+  $forumpost = &quot;&lt;&quot; . $_SESSION['username'] . &quot;&gt; has just added new ban entry:\n\n[list]\n&quot;;
+  if ($_POST[&quot;C1&quot;] == 1) $forumpost .= &quot;[*]Banned username: [color=#0000FF]&quot; . $username . &quot;[/color]\n&quot;;
+  if ($bandur == 1) {
+    $forumpost .= &quot;[*]Banned until &quot; . date(&quot;Y-m-d, H:i:s&quot;, $enddate) . &quot;\n&quot;;
+  } else {
+  $forumpost .= &quot;[*]Banned indefinitely\n&quot;;
+  }
+  if ($_POST[&quot;C2&quot;] == 1) $forumpost .= &quot;[*]Banned IP: &quot; . ($ip_start == $ip_end ? $ip_start : $ip_start . &quot; - &quot; . $ip_end) . &quot;\n&quot;;
+  if ($_POST[&quot;C3&quot;] == 1) $forumpost .= &quot;[*]Banned User ID: &quot; . $user_id . &quot;\n&quot;;
+  $forumpost .= &quot;[/list]\n\n&quot;;
+  $forumpost .= &quot;When user tries to connect, he will see:\n&quot;;
+  $forumpost .= &quot;[quote]&quot;.$pub_reason.&quot;[/quote]\n&quot;;
+  $forumpost .= &quot;&lt;&quot; . $_SESSION['username'] . &quot;&gt; says this about it:\n&quot;;
+  $forumpost .= &quot;[quote]&quot;.$priv_reason.&quot;[/quote]\n&quot;;
 
   
   // now connect to the database and add new ban entry:
@@ -129,7 +178,12 @@
   mysql_close($dbh);
   
   echo &quot;&lt;p&gt;New ban entry has been successfully created. Now forcing TASServer to fetch new ban entries from the database ... &lt;/p&gt;&quot;;
-  forceUpdate();
+  forceUpdate(); 
+  if (!postOnForum($forumpost, &amp;$errormsg)) {
+    echo &quot;&lt;p style='color: red'&gt;Unable to post on the forum, you will have to post it manually. (error: &quot; . $errormsg . &quot;&lt;/p&gt;&quot;;
+  } else {
+    echo &quot;&lt;p&gt;Post has been added to forum successfully.&lt;/p&gt;&quot;;
+  }  
   echo &quot;&lt;a class='button1' href='ban.php'&gt;OK&lt;/a&gt;&quot;;
   
 ?&gt;

Copied: branches/testserver/WebInterface/inc/HtmlFormParser.php (from rev 5288, trunk/Lobby/TASServer/WebInterface/inc/HtmlFormParser.php)
===================================================================
--- branches/testserver/WebInterface/inc/HtmlFormParser.php	                        (rev 0)
+++ branches/testserver/WebInterface/inc/HtmlFormParser.php	2008-01-07 12:45:18 UTC (rev 5289)
@@ -0,0 +1,312 @@
+&lt;?php
+
+/**
+ * HTML Form Parser
+ * This will extract all forms and his elemets in an
+ * big assoc Array.
+ *
+ * @package HtmlFormParser
+ * @version $Id 1.0
+ * @author Peter Valicek &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">Sonny2 at gmx.DE</A>&gt;
+ * @copyright 2004 Peter Valicek Peter Valicek &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">Sonny2 at gmx.DE</A>&gt;
+ */
+
+class HtmlFormParser {
+	
+	/**
+	 * Core HTML Data
+	 * @access public
+	 * @var string
+	 * @see HtmlFormParser()
+	 */
+	var $html_data = '';
+	
+	/**
+	 * Param Array of all Elemets
+	 * @access private
+	 * @var array
+	 */
+	var $_return = array();
+	
+	/**
+	 * Form counter
+	 * @access private
+	 * @var int
+	 */
+	var $_counter = '';
+	
+	/**
+	 * Form button Counter
+	 * @access private
+	 * @var int
+	 * @see parseForms()
+	 */
+	var $button_counter = '';
+	
+	/**
+	 * unique identifiert for parsing
+	 * @access private
+	 * @var string
+	 * @see HtmlFormParser()
+	 */
+	var $_unique_id = '';
+	 
+	/**
+	 * HtmlFormParser Constructor
+	 * @access public
+	 * @param mixed $html_data Could be either an big array or an string
+	 */
+	function HtmlFormParser( $html_data ) {
+		if ( is_array($html_data) ) {
+			$this-&gt;html_data = join('', $html_data);
+		} else {
+			$this-&gt;html_data = $html_data;
+		}
+		$this-&gt;_return = array();
+		$this-&gt;_counter = 0;
+		$this-&gt;button_counter = 0;
+		$this-&gt;_unique_id = md5(time());
+	}
+	
+	/**
+	 * Parse all Forms in given Data
+	 * @access public
+	 * @return array
+	 */
+	function parseForms() {
+		if ( preg_match_all(&quot;/&lt;form.*&gt;.+&lt;\/form&gt;/isU&quot;, $this-&gt;html_data, $forms) ) {
+			foreach ( $forms[0] as $form ) {
+				/*
+				 * Form Details like method, action ..
+				 */
+				preg_match(&quot;/&lt;form.*name=[\&quot;']?([\w\s]*)[\&quot;']?[\s&gt;]/i&quot;, $form, $form_name);
+				$this-&gt;_return[$this-&gt;_counter]['form_data']['name'] = preg_replace(&quot;/[\&quot;'&lt;&gt;]/&quot;, &quot;&quot;, $form_name[1]);
+				preg_match(&quot;/&lt;form.*action=(\&quot;([^\&quot;]*)\&quot;|'([^']*)'|[^&gt;\s]*)([^&gt;]*)?&gt;/is&quot;, $form, $action);
+				$this-&gt;_return[$this-&gt;_counter]['form_data']['action'] = preg_replace(&quot;/[\&quot;'&lt;&gt;]/&quot;, &quot;&quot;, $action[1]);
+				preg_match(&quot;/&lt;form.*method=[\&quot;']?([\w\s]*)[\&quot;']?[\s&gt;]/i&quot;, $form, $method);
+				$this-&gt;_return[$this-&gt;_counter]['form_data']['method'] = preg_replace(&quot;/[\&quot;'&lt;&gt;]/&quot;, &quot;&quot;, $method[1]);
+				preg_match(&quot;/&lt;form.*enctype=(\&quot;([^\&quot;]*)\&quot;|'([^']*)'|[^&gt;\s]*)([^&gt;]*)?&gt;/is&quot;, $form, $enctype);
+				$this-&gt;_return[$this-&gt;_counter]['form_data']['enctype'] = preg_replace(&quot;/[\&quot;'&lt;&gt;]/&quot;, &quot;&quot;, $enctype[1]);
+				
+				/*
+				 * &lt;input type=hidden entries
+				 */
+				if ( preg_match_all(&quot;/&lt;input.*type=[\&quot;']?hidden[\&quot;']?.*&gt;$/im&quot;, $form, $hiddens) ) {					
+					foreach ( $hiddens[0] as $hidden ) {
+						$this-&gt;_return[$this-&gt;_counter]['form_elemets'][$this-&gt;_getName($hidden)] = array(
+																							'type'	=&gt; 'hidden',
+																							'value'	=&gt; $this-&gt;_getValue($hidden)
+																							);
+					}
+				}
+				
+				/*
+				 * &lt;input type=text entries
+				 */
+				if ( preg_match_all(&quot;/&lt;input.*type=[\&quot;']?text[\&quot;']?.*&gt;/iU&quot;, $form, $texts) ) { 
+					foreach ( $texts[0] as $text ) {
+						$this-&gt;_return[$this-&gt;_counter]['form_elemets'][$this-&gt;_getName($text)] = array(
+																							'type'	=&gt; 'text',
+																							'value'	=&gt; $this-&gt;_getValue($text)
+																							);
+					}
+				}
+				
+				/*
+				 * &lt;input type=password entries
+				 */
+				if ( preg_match_all(&quot;/&lt;input.*type=[\&quot;']?password[\&quot;']?.*&gt;/iU&quot;, $form, $passwords) ) { 
+					foreach ( $passwords[0] as $password ) {
+						$this-&gt;_return[$this-&gt;_counter]['form_elemets'][$this-&gt;_getName($password)] = array(
+																							'type'	=&gt; 'password',
+																							'value'	=&gt; $this-&gt;_getValue($password)
+																							);
+					}
+				}
+				
+				/*
+				 * &lt;textarea entries
+				 */
+				if ( preg_match_all(&quot;/&lt;textarea.*&gt;.*&lt;\/textarea&gt;/isU&quot;, $form, $textareas) ) {
+					foreach ( $textareas[0] as $textarea ) {
+						preg_match(&quot;/&lt;textarea.*&gt;(.*)&lt;\/textarea&gt;/isU&quot;, $textarea, $textarea_value);
+						$this-&gt;_return[$this-&gt;_counter]['form_elemets'][$this-&gt;_getName($textarea)] = array(
+																							'type'	=&gt; 'textarea',
+																							'value'	=&gt; $textarea_value[1]
+																							);
+					}
+				}
+				
+				/*
+				 * &lt;input type=checkbox entries
+				 */
+				if ( preg_match_all(&quot;/&lt;input.*type=[\&quot;']?checkbox[\&quot;']?.*&gt;/iU&quot;, $form, $checkboxes) ) {
+					foreach ( $checkboxes[0] as $checkbox ) {
+						if ( preg_match(&quot;/checked/i&quot;, $checkbox) ) {
+							$this-&gt;_return[$this-&gt;_counter]['form_elemets'][$this-&gt;_getName($checkbox)] = array(
+																							'type'	=&gt; 'checkbox',
+																							'value'	=&gt; 'on'
+																							);
+						} else {
+							$this-&gt;_return[$this-&gt;_counter]['form_elemets'][$this-&gt;_getName($checkbox)] = array(
+																							'type'	=&gt; 'checkbox',
+																							'value'	=&gt; ''
+																							);
+						}
+					}
+				}
+				
+				/*
+				 * &lt;input type=radio entries
+				 */
+				if ( preg_match_all(&quot;/&lt;input.*type=[\&quot;']?radio[\&quot;']?.*&gt;/iU&quot;, $form, $radios) ) {
+					foreach ( $radios[0] as $radio ) {
+						if ( preg_match(&quot;/checked/i&quot;, $radio) ) {
+							$this-&gt;_return[$this-&gt;_counter]['form_elemets'][$this-&gt;_getName($radio)] = array(
+																							'type'	=&gt; 'radio',
+																							'value'	=&gt; $this-&gt;_getValue($radio)
+																							);
+						}
+					}		
+				}
+				
+				/*
+				 * &lt;input type=submit entries
+				 */
+				if ( preg_match_all(&quot;/&lt;input.*type=[\&quot;']?submit[\&quot;']?.*&gt;/iU&quot;, $form, $submits) ) {
+					foreach ( $submits[0] as $submit ) {
+						$this-&gt;_return[$this-&gt;_counter]['buttons'][$this-&gt;button_counter] = array(
+																							'type'	=&gt; 'submit',
+																							'name'	=&gt; $this-&gt;_getName($submit),
+																							'value'	=&gt; $this-&gt;_getValue($submit)
+																							);
+						$this-&gt;button_counter++;
+					}
+				}
+				
+				/*
+				 * &lt;input type=button entries
+				 */
+				if ( preg_match_all(&quot;/&lt;input.*type=[\&quot;']?button[\&quot;']?.*&gt;/iU&quot;, $form, $buttons) ) {
+					foreach ( $buttons[0] as $button ) {
+						$this-&gt;_return[$this-&gt;_counter]['buttons'][$this-&gt;button_counter] = array(
+																							'type'	=&gt; 'button',
+																							'name'	=&gt; $this-&gt;_getName($button),
+																							'value'	=&gt; $this-&gt;_getValue($button)
+																							);
+						$this-&gt;button_counter++;
+					}
+				}
+				
+				/*
+				 * &lt;input type=reset entries
+				 */
+				if ( preg_match_all(&quot;/&lt;input.*type=[\&quot;']?reset[\&quot;']?.*&gt;/iU&quot;, $form, $resets) ) {
+					foreach ( $resets[0] as $reset ) {
+						$this-&gt;_return[$this-&gt;_counter]['buttons'][$this-&gt;button_counter] = array(
+																							'type'	=&gt; 'reset',
+																							'name'	=&gt; $this-&gt;_getName($reset),
+																							'value'	=&gt; $this-&gt;_getValue($reset)
+																							);
+						$this-&gt;button_counter++;
+					}
+				}
+				
+				/*
+				 * &lt;input type=image entries
+				 */
+				if ( preg_match_all(&quot;/&lt;input.*type=[\&quot;']?image[\&quot;']?.*&gt;/iU&quot;, $form, $images) ) {
+					foreach ( $images[0] as $image ) {
+						$this-&gt;_return[$this-&gt;_counter]['buttons'][$this-&gt;button_counter] = array(
+																							'type'	=&gt; 'reset',
+																							'name'	=&gt; $this-&gt;_getName($image),
+																							'value'	=&gt; $this-&gt;_getValue($image)
+																							);
+						$this-&gt;button_counter++;
+					}
+				}
+				
+				/*
+				 * &lt;input type=select entries
+				 * Here I have to go on step around to grep at first all select names and then
+				 * the content. Seems not to work in an other way
+				 */
+				if ( preg_match_all(&quot;/&lt;select.*&gt;.+&lt;\/select&gt;/isU&quot;, $form, $selects) ) {
+					foreach ( $selects[0] as $select ) {
+						if ( preg_match_all(&quot;/&lt;option.*&gt;.+&lt;\/option&gt;/isU&quot;, $select, $all_options) ) {
+							foreach ( $all_options[0] as $option ) {
+								if ( preg_match(&quot;/selected/i&quot;, $option) ) {
+									if ( preg_match(&quot;/value=[\&quot;'](.*)[\&quot;']\s/iU&quot;, $option, $option_value) ) {
+										$option_value = $option_value[1];
+										$found_selected = 1;
+									} else {
+										preg_match(&quot;/&lt;option.*&gt;(.*)&lt;\/option&gt;/isU&quot;, $option, $option_value);
+										$option_value = $option_value[1];
+										$found_selected = 1;
+									}
+								}
+							}
+							if ( !isset($found_selected) ) {
+								if ( preg_match(&quot;/value=[\&quot;'](.*)[\&quot;']/iU&quot;, $all_options[0][0], $option_value) ) {
+									$option_value = $option_value[1];
+								} else {
+									preg_match(&quot;/&lt;option&gt;(.*)&lt;\/option&gt;/iU&quot;, $all_options[0][0], $option_value);
+									$option_value = $option_value[1];
+								}
+							} else {
+								unset($found_selected);
+							}
+							$this-&gt;_return[$this-&gt;_counter]['form_elemets'][$this-&gt;_getName($select)] = array(
+																									'type'	=&gt; 'select',
+																									'value'	=&gt; trim($option_value)
+																									);
+						}
+					}
+				}
+
+				/*
+				 * Update the form counter if we have more then 1 form in the HTML table
+				 */
+				$this-&gt;_counter++;
+			}
+		}
+		return $this-&gt;_return;
+	}
+	
+	/**
+	 * Get Name from string
+	 * @access private
+	 * @param string
+	 * @return string
+	 */
+	function _getName( $string ) {
+		if ( preg_match(&quot;/name=[\&quot;']?([\w\s]*)[\&quot;']?[\s&gt;]/i&quot;, $string, $match) ) {
+			$val_match = preg_replace(&quot;/\&quot;'/&quot;, &quot;&quot;, trim($match[1]));
+			
+			unset($string);
+			return $val_match;
+		}
+	}
+	
+	/**
+	 * Get Value from string
+	 * @access private
+	 * @param string
+	 * @return string
+	 */
+	function _getValue( $string ) {
+		if ( preg_match(&quot;/value=(\&quot;([^\&quot;]*)\&quot;|'([^']*)'|[^&gt;\s]*)([^&gt;]*)?&gt;/is&quot;, $string, $match) ) {
+			$val_match = trim($match[1]);
+			
+			if ( strstr($val_match, '&quot;') ) {
+				$val_match = str_replace('&quot;', '', $val_match);
+			}
+			
+			unset($string);
+			return $val_match;
+		}
+	}
+
+}
+
+?&gt;
\ No newline at end of file

Modified: branches/testserver/WebInterface/inc/constants.inc
===================================================================
--- branches/testserver/WebInterface/inc/constants.inc	2008-01-07 12:37:31 UTC (rev 5288)
+++ branches/testserver/WebInterface/inc/constants.inc	2008-01-07 12:45:18 UTC (rev 5289)
@@ -10,6 +10,8 @@
   $constants['database_name'] = &quot;spring&quot;;
   $constants['database_username'] = &quot;anonymous&quot;;
   $constants['database_password'] = &quot;anonymous&quot;;
+  $constants['forumposter_username'] = &quot;anonymous&quot;;
+  $constants['forumposter_password'] = &quot;anonymous&quot;;
 
   /* restrictions for various pages (0 means no restrictions (default) which can be overriden with $restrict_default identifier
      to restrict such a page, 1 means &quot;normal user&quot; (user must be logged in to view the page),
@@ -25,6 +27,7 @@
   $restrictions['ban.list.php'] = 2;
   $restrictions['ban.delete.php'] = 2;
   $restrictions['userinfo.php'] = 2;
+  $restrictions['userid.php'] = 2;
   $restrictions['editmotd.php'] = 3;
   $restrictions['updating.php'] = 3;
   $restrictions['updating.delete.php'] = 3;

Copied: branches/testserver/WebInterface/inc/curl_phpbb.class.php (from rev 5288, trunk/Lobby/TASServer/WebInterface/inc/curl_phpbb.class.php)
===================================================================
--- branches/testserver/WebInterface/inc/curl_phpbb.class.php	                        (rev 0)
+++ branches/testserver/WebInterface/inc/curl_phpbb.class.php	2008-01-07 12:45:18 UTC (rev 5289)
@@ -0,0 +1,542 @@
+&lt;?php
+/*
+	@ Program	: phpBB CURL Library
+	@ Author	: Dean Newman, Afterlife(69)
+	@ Purpose	: Remote login and posting in phpBB
+	@ Filename	: curl_phpbb.class.php
+	@ Class		: curl_phpbb
+	@ About		: Function lib for login, posting and logout on remote phpbb's
+	@ Licence	: GNU/General Public Licence v2
+	@ Created	: 6/22/2006, 7:41pm
+	@ Updated	: 9/01/2006, 5:19pm
+	@ Updated	: 4/01/2008, 7:39pm
+*/
+
+/*
+	@ Changelog
+	@	9/01/2006: Added -&gt;read() functionality.
+  @	4/01/2008: (Betalord) -&gt; modified the script to work with phpbb3 forum. Not all methods were fixed though (only login and post reply)
+*/
+
+require_once &quot;HtmlFormParser.php&quot;;
+
+class curl_phpbb
+{
+	/*
+		@ Variable	: $curl (Resource)
+		@ About		: The cURL object used for the request
+		@ Type		: Private
+	*/
+	var $curl = null;
+
+	/*
+		@ Variable	: $cookie_name (String)
+		@ About		: The filename of the temp file used for storing cookies
+		@ Type		: Private
+	*/
+	var $cookie_name = array();
+
+	/*
+		@ Variable	: $phpbb_url (String)
+		@ About		: The address of the remote phpbb that is being connected to
+		@ Type		: Private
+	*/
+	var $phpbb_url = null;
+
+	/*
+		@ Variable	: $error (Array)
+		@ About		: The array including error code and message on errors
+		@ Type		: Public
+	*/
+	var $error = array();
+
+	/*
+		@ Function	: curl_phpbb() - Constructor
+		@ About		: Check if CURL is available and the url exists.
+		@ Type		: Public
+	*/
+	function curl_phpbb($phpbb_url, $cookie_name = 'tmpfile.tmp')
+	{
+		// Check CURL is present
+		if ( ! function_exists ( 'curl_init') )
+		{
+			// Output an error message
+			trigger_error('curl_phpbb::error, Sorry but it appears that CURL is not loaded, Please install it to continue.');
+			return false;
+		}
+		if ( empty($phpbb_url) )
+		{
+			// Output an error message
+			trigger_error('curl_phpbb::error, The phpBB location is required to continue, Please edit your script.');
+			return false;
+		}
+		// Set base location
+		$this-&gt;phpbb_url = $phpbb_url;
+		// Create temp file
+		$this-&gt;cookie_name = $cookie_name;
+	}
+  
+  /* similar to topic_reply, only that it also parses the &quot;post reply&quot; form (needed for phpbb3) */
+	function topic_reply_advanced($topic_id, $forum_id, $message, &amp;$errormsg)
+	{
+		global $_SERVER;
+  
+    // get the &quot;post a reply&quot; page:
+    $postReplyPage = $this-&gt;read('posting.php?mode=reply&amp;f=' . $forum_id . '&amp;t=' . $topic_id);
+    if (!$postReplyPage) {
+      $errormsg = &quot;Unable to retrieve 'post a reply' page&quot;;
+      return false;
+    }
+      
+    $parser =&amp; new HtmlFormParser($postReplyPage);
+    $parsed = $parser-&gt;parseForms();
+    
+    // Generate post string
+    $post_fields = $this-&gt;array_to_http(array(
+      'post'				=&gt; 'Submit',
+      
+      'f'		=&gt; $forum_id,
+      't'		=&gt; $topic_id,
+      
+//			'mode'				=&gt; 'reply',
+      'message'			=&gt; $message,
+      
+			'disable_smilies'	=&gt; 1,
+        
+      // parsed:
+      'topic_cur_post_id' =&gt; $parsed[0]['form_elemets']['topic_cur_post_id']['value'],
+      'creation_time' =&gt; $parsed[0]['form_elemets']['creation_time']['value'],
+      'form_token' =&gt; $parsed[0]['form_elemets']['form_token']['value'],
+      'subject' =&gt; $parsed[0]['form_elemets']['subject'],
+    ));
+
+		// Location
+		$url_vars = $this-&gt;array_to_http2(array(
+			'mode'	=&gt; 'reply',
+      'f'		=&gt; $forum_id,
+			't'		=&gt; $topic_id,
+		));
+		// Init curl
+		$this-&gt;curl = curl_init();
+		// Set options
+		curl_setopt ( $this-&gt;curl, CURLOPT_URL, $this-&gt;phpbb_url . 'posting.php?' . $url_vars ); // curl_setopt ( $this-&gt;curl, CURLOPT_URL, $this-&gt;phpbb_url . substr($parsed[0]['form_data']['action'], 2));
+		curl_setopt ( $this-&gt;curl, CURLOPT_POST, true );
+		curl_setopt ( $this-&gt;curl, CURLOPT_POSTFIELDS, $post_fields );
+		curl_setopt ( $this-&gt;curl, CURLOPT_RETURNTRANSFER, true );
+		curl_setopt ( $this-&gt;curl, CURLOPT_HEADER, false );
+		curl_setopt ( $this-&gt;curl, CURLOPT_COOKIE, $this-&gt;cookie_name );
+		curl_setopt ( $this-&gt;curl, CURLOPT_COOKIEJAR, $this-&gt;cookie_name );
+		curl_setopt ( $this-&gt;curl, CURLOPT_COOKIEFILE, $this-&gt;cookie_name );
+		curl_setopt ( $this-&gt;curl, CURLOPT_USERAGENT, $_SERVER['HTTP_USER_AGENT'] );
+		// Execute request
+		$result = curl_exec ( $this-&gt;curl );
+		// Get the result
+		if ( preg_match ( '#This message has been posted successfully.#', $result, $match ) )
+		{
+			$post_status = 1;
+		}
+		else if ( preg_match ( '#You cannot make another post so soon after your last; please try again in a short while.#', $result, $match ) )
+		{
+			$post_status = 0;
+		}
+		else
+		{
+			$post_status = 0;
+		}
+		// Error handling
+		if ( curl_errno ( $this-&gt;curl ) )
+		{
+			$this-&gt;error = array(
+				curl_errno($this-&gt;curl),
+				curl_error($this-&gt;curl),
+			);
+			curl_close ( $this-&gt;curl );
+      $errormsg = implode(&quot; - &quot;, $this-&gt;error);
+			return false;
+		}
+		// Close connection
+		curl_close ( $this-&gt;curl );
+		// Return result
+    if ($post_status == 0) {
+      $errormsg = &quot;Unknown or invalid response to post submission (post may still have been written)&quot;;
+      return false;
+    }
+    return true;
+	}
+  
+	/*
+		@ Function	: login() - Log In
+		@ About		: Does a remote login to the target phpBB and stores in cookie
+		@ Type		: Public
+	*/
+	function login($username, $password)
+	{
+		global $_SERVER;
+	
+		// Generate post string
+		$post_fields = $this-&gt;array_to_http(array(
+			'username'	=&gt; $username,
+			'password'	=&gt; $password,
+			'autologin'	=&gt; 1,
+			'redirect'	=&gt; 'index.php',
+			'login'		=&gt; 'Login',
+		));
+		// Init curl
+		$this-&gt;curl = curl_init();
+		// Set options
+		curl_setopt ( $this-&gt;curl, CURLOPT_URL, $this-&gt;phpbb_url . 'ucp.php?mode=login' );
+		curl_setopt ( $this-&gt;curl, CURLOPT_POST, true );
+		curl_setopt ( $this-&gt;curl, CURLOPT_POSTFIELDS, $post_fields );
+		curl_setopt ( $this-&gt;curl, CURLOPT_RETURNTRANSFER, true );
+		curl_setopt ( $this-&gt;curl, CURLOPT_HEADER, false );
+		curl_setopt ( $this-&gt;curl, CURLOPT_COOKIE, $this-&gt;cookie_name );
+		curl_setopt ( $this-&gt;curl, CURLOPT_COOKIEJAR, $this-&gt;cookie_name );
+		curl_setopt ( $this-&gt;curl, CURLOPT_COOKIEFILE, $this-&gt;cookie_name );
+		curl_setopt ( $this-&gt;curl, CURLOPT_USERAGENT, $_SERVER['HTTP_USER_AGENT'] );
+		// Execute request
+		$result = curl_exec ( $this-&gt;curl );
+		// Error handling
+		if ( curl_errno ( $this-&gt;curl ) )
+		{
+			$this-&gt;error = array(
+				curl_errno($this-&gt;curl),
+				curl_error($this-&gt;curl),
+			);
+			curl_close ( $this-&gt;curl );
+			return false;
+		}
+		// Close connection
+		curl_close ( $this-&gt;curl );
+		// Return result
+		return true;
+	}
+
+	/*
+		@ Function	: read() - Read a pages contents
+		@ About		: Returns the contents of a url
+		@ Type		: Public
+	*/
+	function read($page_url)
+	{
+		global $_SERVER;
+
+		// Init curl
+		$this-&gt;curl = curl_init();
+		// Set options
+		curl_setopt ( $this-&gt;curl, CURLOPT_URL, $this-&gt;phpbb_url . $page_url );
+		curl_setopt ( $this-&gt;curl, CURLOPT_POST, false );
+		curl_setopt ( $this-&gt;curl, CURLOPT_RETURNTRANSFER, true );
+		curl_setopt ( $this-&gt;curl, CURLOPT_HEADER, false );
+		curl_setopt ( $this-&gt;curl, CURLOPT_COOKIE, $this-&gt;cookie_name );
+		curl_setopt ( $this-&gt;curl, CURLOPT_COOKIEJAR, $this-&gt;cookie_name );
+		curl_setopt ( $this-&gt;curl, CURLOPT_COOKIEFILE, $this-&gt;cookie_name );
+		curl_setopt ( $this-&gt;curl, CURLOPT_USERAGENT, $_SERVER['HTTP_USER_AGENT'] );
+		// Execute request
+		$result = curl_exec ( $this-&gt;curl );
+		// Error handling
+		if ( curl_errno ( $this-&gt;curl ) )
+		{
+			$this-&gt;error = array(
+				curl_errno($this-&gt;curl),
+				curl_error($this-&gt;curl),
+			);
+			curl_close ( $this-&gt;curl );
+			return false;
+		}
+		// Close connection
+		curl_close ( $this-&gt;curl );
+		// Return result
+		return $result;
+	}
+
+	/*
+		@ Function	: new_topic() - New Topic
+		@ About		: Remotely posts a topic to the target phpBB forum.
+		@ Type		: Public
+	*/
+	function new_topic($forum_id, $message, $topic_title)
+	{
+		global $_SERVER;
+	
+		// Generate post string
+		$post_fields = $this-&gt;array_to_http(array(
+			'post'				=&gt; 'Submit',
+			'mode'				=&gt; 'newtopic',
+			'message'			=&gt; $message,
+			'f'					=&gt; $forum_id,
+			'subject'			=&gt; $topic_title,
+			'disable_bbcode'	=&gt; 0,
+			'disable_smilies'	=&gt; 0,
+			'attach_sig'		=&gt; 1,
+			'topictype'			=&gt; 0,
+		));
+		// Location
+		$url_vars = $this-&gt;array_to_http(array(
+			'mode'	=&gt; 'newtopic',
+			'f'		=&gt; $forum_id,
+		));
+		// Init curl
+		$this-&gt;curl = curl_init();
+		// Set options
+		curl_setopt ( $this-&gt;curl, CURLOPT_URL, $this-&gt;phpbb_url . 'posting.php?' . $url_vars );
+		curl_setopt ( $this-&gt;curl, CURLOPT_POST, true );
+		curl_setopt ( $this-&gt;curl, CURLOPT_POSTFIELDS, $post_fields );
+		curl_setopt ( $this-&gt;curl, CURLOPT_RETURNTRANSFER, true );
+		curl_setopt ( $this-&gt;curl, CURLOPT_HEADER, false );
+		curl_setopt ( $this-&gt;curl, CURLOPT_COOKIE, $this-&gt;cookie_name );
+		curl_setopt ( $this-&gt;curl, CURLOPT_COOKIEJAR, $this-&gt;cookie_name );
+		curl_setopt ( $this-&gt;curl, CURLOPT_COOKIEFILE, $this-&gt;cookie_name );
+		curl_setopt ( $this-&gt;curl, CURLOPT_USERAGENT, $_SERVER['HTTP_USER_AGENT'] );
+		// Execute request
+		$result = curl_exec ( $this-&gt;curl );
+		// Get the result
+		if ( preg_match ( '#&lt;td align=&quot;center&quot;&gt;&lt;span class=&quot;gen&quot;&gt;Your message has been entered successfully.&lt;br \/&gt;&lt;br \/&gt;#is', $result, $match ) )
+		{
+			$post_status = 1;
+		}
+		else if ( preg_match ( '#&lt;td align=&quot;center&quot;&gt;&lt;span class=&quot;gen&quot;&gt;You cannot make another post so soon after your last; please try again in a short while.&lt;\/span&gt;&lt;\/td&gt;&gt;#is', $result, $match ) )
+		{
+			$post_status = 0;
+		}
+		else
+		{
+			$post_status = 0;
+		}
+		// Error handling
+		if ( curl_errno ( $this-&gt;curl ) )
+		{
+			$this-&gt;error = array(
+				curl_errno($this-&gt;curl),
+				curl_error($this-&gt;curl),
+			);
+			curl_close ( $this-&gt;curl );
+			return false;
+		}
+		// Close connection
+		curl_close ( $this-&gt;curl );
+		// Return result
+		return $post_status;
+	}
+
+	/*
+		@ Function	: new_pm() - New PM
+		@ About		: Remotely sends a pm to a user of a phpbb forum.
+		@ Type		: Public
+	*/
+	function new_pm($username, $message, $topic_title)
+	{
+		global $_SERVER;
+	
+		// Generate post string
+		$post_fields = $this-&gt;array_to_http(array(
+			'post'				=&gt; 'Submit',
+			'mode'				=&gt; 'newtopic',
+			'message'			=&gt; $message,
+			'username'			=&gt; $username,
+			'subject'			=&gt; $topic_title,
+			'disable_bbcode'	=&gt; 0,
+			'disable_smilies'	=&gt; 0,
+			'attach_sig'		=&gt; 1,
+		));
+		// Location
+		$url_vars = $this-&gt;array_to_http(array(
+			'mode'	=&gt; 'post',
+			'u'		=&gt; $username,
+		));
+		// Init curl
+		$this-&gt;curl = curl_init();
+		// Set options
+		curl_setopt ( $this-&gt;curl, CURLOPT_URL, $this-&gt;phpbb_url . 'posting.php?' . $url_vars );
+		curl_setopt ( $this-&gt;curl, CURLOPT_POST, true );
+		curl_setopt ( $this-&gt;curl, CURLOPT_POSTFIELDS, $post_fields );
+		curl_setopt ( $this-&gt;curl, CURLOPT_RETURNTRANSFER, true );
+		curl_setopt ( $this-&gt;curl, CURLOPT_HEADER, false );
+		curl_setopt ( $this-&gt;curl, CURLOPT_COOKIE, $this-&gt;cookie_name );
+		curl_setopt ( $this-&gt;curl, CURLOPT_COOKIEJAR, $this-&gt;cookie_name );
+		curl_setopt ( $this-&gt;curl, CURLOPT_COOKIEFILE, $this-&gt;cookie_name );
+		curl_setopt ( $this-&gt;curl, CURLOPT_USERAGENT, $_SERVER['HTTP_USER_AGENT'] );
+		// Execute request
+		$result = curl_exec ( $this-&gt;curl );
+		// Get the result
+		if ( preg_match ( '#&lt;td align=&quot;center&quot;&gt;&lt;span class=&quot;gen&quot;&gt;Your message has been sent.&lt;br \/&gt;&lt;br \/&gt;#is', $result, $match ) )
+		{
+			$post_status = 1;
+		}
+		else if ( preg_match ( '#&lt;td align=&quot;center&quot;&gt;&lt;span class=&quot;gen&quot;&gt;You cannot make another post so soon after your last; please try again in a short while.&lt;\/span&gt;&lt;\/td&gt;&gt;#is', $result, $match ) )
+		{
+			$post_status = 0;
+		}
+		else
+		{
+			$post_status = 0;
+		}
+		// Error handling
+		if ( curl_errno ( $this-&gt;curl ) )
+		{
+			$this-&gt;error = array(
+				curl_errno($this-&gt;curl),
+				curl_error($this-&gt;curl),
+			);
+			curl_close ( $this-&gt;curl );
+			return false;
+		}
+		// Close connection
+		curl_close ( $this-&gt;curl );
+		// Return result
+		return $post_status;
+	}
+
+	/*
+		@ Function	: topic_reply() - Topic Reply
+		@ About		: Remotely replys a post to a topic to the target phpBB forum.
+		@ Type		: Public
+	*/
+	function topic_reply($topic_id, $message, $topic_title)
+	{
+		global $_SERVER;
+	
+		// Generate post string
+		$post_fields = $this-&gt;array_to_http(array(
+			'post'				=&gt; 'Submit',
+			'mode'				=&gt; 'reply',
+			'message'			=&gt; $message,
+			't'					=&gt; $topic_id,
+			'subject'			=&gt; $topic_title,
+			'disable_bbcode'	=&gt; 0,
+			'disable_smilies'	=&gt; 0,
+			'attach_sig'		=&gt; 1,
+			'topictype'			=&gt; 0,
+		));
+		// Location
+		$url_vars = $this-&gt;array_to_http(array(
+			'mode'	=&gt; 'reply',
+			't'		=&gt; $topic_id,
+		));
+		// Init curl
+		$this-&gt;curl = curl_init();
+		// Set options
+		curl_setopt ( $this-&gt;curl, CURLOPT_URL, $this-&gt;phpbb_url . 'posting.php?' . $url_vars );
+		curl_setopt ( $this-&gt;curl, CURLOPT_POST, true );
+		curl_setopt ( $this-&gt;curl, CURLOPT_POSTFIELDS, $post_fields );
+		curl_setopt ( $this-&gt;curl, CURLOPT_RETURNTRANSFER, true );
+		curl_setopt ( $this-&gt;curl, CURLOPT_HEADER, false );
+		curl_setopt ( $this-&gt;curl, CURLOPT_COOKIE, $this-&gt;cookie_name );
+		curl_setopt ( $this-&gt;curl, CURLOPT_COOKIEJAR, $this-&gt;cookie_name );
+		curl_setopt ( $this-&gt;curl, CURLOPT_COOKIEFILE, $this-&gt;cookie_name );
+		curl_setopt ( $this-&gt;curl, CURLOPT_USERAGENT, $_SERVER['HTTP_USER_AGENT'] );
+		// Execute request
+		$result = curl_exec ( $this-&gt;curl );
+		// Get the result
+		if ( preg_match ( '#&lt;td align=&quot;center&quot;&gt;&lt;span class=&quot;gen&quot;&gt;Your message has been entered successfully.&lt;br \/&gt;&lt;br \/&gt;#is', $result, $match ) )
+		{
+			$post_status = 1;
+		}
+		else if ( preg_match ( '#&lt;td align=&quot;center&quot;&gt;&lt;span class=&quot;gen&quot;&gt;You cannot make another post so soon after your last; please try again in a short while.&lt;\/span&gt;&lt;\/td&gt;&gt;#is', $result, $match ) )
+		{
+			$post_status = 0;
+		}
+		else
+		{
+			$post_status = 0;
+		}
+		// Error handling
+		if ( curl_errno ( $this-&gt;curl ) )
+		{
+			$this-&gt;error = array(
+				curl_errno($this-&gt;curl),
+				curl_error($this-&gt;curl),
+			);
+			curl_close ( $this-&gt;curl );
+			return false;
+		}
+		// Close connection
+		curl_close ( $this-&gt;curl );
+		// Return result
+		return $post_status;
+	}
+  
+	/*
+		@ Function	: logout() - Log Out
+		@ About		: Logs out of the target phpBB properly.
+		@ Type		: Public
+	*/
+	function logout()
+	{
+		global $_SERVER;
+	
+		// Generate post string
+		$urlopt = $this-&gt;array_to_http(array(
+			'logout'	=&gt; 'true',
+			'mode'		=&gt; 'logout',
+		));
+		// Init curl
+		$this-&gt;curl = curl_init();
+		// Set options
+		curl_setopt ( $this-&gt;curl, CURLOPT_URL, $this-&gt;phpbb_url . 'ucp.php?' . $urlopt );
+		curl_setopt ( $this-&gt;curl, CURLOPT_POST, false );
+		curl_setopt ( $this-&gt;curl, CURLOPT_RETURNTRANSFER, true );
+		curl_setopt ( $this-&gt;curl, CURLOPT_HEADER, false );
+		curl_setopt ( $this-&gt;curl, CURLOPT_COOKIE, $this-&gt;cookie_name );
+		curl_setopt ( $this-&gt;curl, CURLOPT_COOKIEJAR, $this-&gt;cookie_name );
+		curl_setopt ( $this-&gt;curl, CURLOPT_COOKIEFILE, $this-&gt;cookie_name );
+		curl_setopt ( $this-&gt;curl, CURLOPT_USERAGENT, $_SERVER['HTTP_USER_AGENT'] );
+		// Execute request
+		$result = curl_exec ( $this-&gt;curl );
+		// Error handling
+		if ( curl_errno ( $this-&gt;curl ) )
+		{
+			$this-&gt;error = array(
+				curl_errno($this-&gt;curl),
+				curl_error($this-&gt;curl),
+			);
+			curl_close ( $this-&gt;curl );
+			return false;
+		}
+		// Close connection
+		curl_close ( $this-&gt;curl );
+		// Delete cookie file
+		@unlink($this-&gt;cookie_name);
+		// Return result
+		return true;
+	}
+  
+	/*
+		@ Function	: getCurl() - return curl object
+		@ About		: Returns curl object
+		@ Type		: Public
+	*/  
+  function getCurl() {
+    return $this-&gt;curl;
+  }
+	
+	/*
+		@ Function	: array_to_http() - Converter
+		@ About		: Converts data from array to http string
+		@ Type		: Private
+	*/
+	function array_to_http($array)
+	{
+		$retvar = '';
+		while ( list ( $field, $data ) = @each ( $array ) )
+		{
+			$retvar .= ( empty($retvar) ) ? '' : '&amp;';
+			$retvar .= urlencode($field) . '=' . urlencode($data); 
+		}
+		return $retvar;
+	}
+  
+	function array_to_http2($array)
+	{
+		$retvar = '';
+		while ( list ( $field, $data ) = @each ( $array ) )
+		{
+			$retvar .= ( empty($retvar) ) ? '' : '&amp;';
+			$retvar .= urlencode($field) . '=' . urlencode($data); 
+		}
+		return $retvar;
+	}
+  
+  
+}
+
+?&gt;
\ No newline at end of file

Copied: branches/testserver/WebInterface/inc/curl_phpbb.example.php (from rev 5288, trunk/Lobby/TASServer/WebInterface/inc/curl_phpbb.example.php)
===================================================================
--- branches/testserver/WebInterface/inc/curl_phpbb.example.php	                        (rev 0)
+++ branches/testserver/WebInterface/inc/curl_phpbb.example.php	2008-01-07 12:45:18 UTC (rev 5289)
@@ -0,0 +1,32 @@
+&lt;?php
+/*
+
+// Init class
+include('curl_phpbb.class.php');
+
+// The ending backslash is required.
+$phpbb = new curl_phpbb('<A HREF="http://www.phpbb.com/phpBB/">http://www.phpbb.com/phpBB/</A>');
+
+// Log in
+$phpbb-&gt;login('username', 'password');
+
+// Send random_user a pm
+$r = $phpbb-&gt;new_pm('random_user', print_r($_SERVER, true), 'Hello user...');
+echo ( $r ) ? 'Posted' : 'Failed';
+
+// Post a topic
+$r = $phpbb-&gt;new_topic('16', 'This is just a test post!', 'Topic subject');
+echo ( $r ) ? 'Posted' : 'Failed';
+
+// Post a topic
+$r = $phpbb-&gt;topic_reply('343298', 'This is just a test post!', 'Post subject');
+echo ( $r ) ? 'Posted' : 'Failed';
+
+// Read index
+echo $phpbb-&gt;read('index.php');
+
+// Log out
+$phpbb-&gt;logout();
+
+*/
+?&gt;
\ No newline at end of file

Modified: branches/testserver/WebInterface/searchlog.php
===================================================================
--- branches/testserver/WebInterface/searchlog.php	2008-01-07 12:37:31 UTC (rev 5288)
+++ branches/testserver/WebInterface/searchlog.php	2008-01-07 12:45:18 UTC (rev 5289)
@@ -62,13 +62,16 @@
         $select .= &quot; WHERE stamp &gt; &quot; . $mindate;
       }
       
+      if (strlen($keyword) &gt; 0) {
+        if (($mindate != 0) || ($maxdate != 0))
+          $select .= &quot; AND line LIKE '%&quot; . $keyword . &quot;%'&quot;;
+        else
+          $select .= &quot; WHERE line LIKE '%&quot; . $keyword . &quot;%'&quot;;        
+      }
+      
       $result = mysql_query($select);
       while($row = mysql_fetch_row($result))
       {
-        if (strlen($keyword) &gt; 0) 
-          if (strpos($row[1], $keyword) === false) 
-            continue;
-
         echo &quot;[&quot; . date('Y-m-d H:i:s', $row[0]) . &quot;] &quot; . htmlspecialchars(rtrim($row[1])) . &quot;&lt;br&gt;&quot;;
         $count += 1;
       }     

Copied: branches/testserver/WebInterface/userid.php (from rev 5288, trunk/Lobby/TASServer/WebInterface/userid.php)
===================================================================
--- branches/testserver/WebInterface/userid.php	                        (rev 0)
+++ branches/testserver/WebInterface/userid.php	2008-01-07 12:45:18 UTC (rev 5289)
@@ -0,0 +1,92 @@
+&lt;?php require(&quot;inc/head.php&quot;) ?&gt;
+
+&lt;?php
+
+  $username = $_GET['username'];
+  if ($username == &quot;&quot;) {
+    printError(&quot;No username specified. Cancelling operation.&quot;);
+    return;
+  }
+    
+  $conn = new ServerConnection();
+  if (($res = $conn-&gt;connect()) !== true)
+  {
+    echo &quot;&lt;p style='color: black; font-weight: bold'&gt;&quot; . &quot;Error: &quot; . $res . &quot;&lt;/p&gt;&quot;;
+    return;
+  }
+
+  if (($conn-&gt;identify()) == false)
+  {
+    echo &quot;&lt;p style='color: black; font-weight: bold'&gt;&quot; . &quot;Error while trying to authenticate with the server&quot; . &quot;&lt;/p&gt;&quot;;
+    return;
+  }
+
+  if (($res = $conn-&gt;sendLine(&quot;queryserver GETUSERID &quot; . $username)) !== TRUE)
+  {
+    echo &quot;&lt;p style='color: black; font-weight: bold'&gt;&quot; . &quot;Error while communicating with the server&quot; . &quot;&lt;/p&gt;&quot;;
+    return;
+  }
+  if (($res = $conn-&gt;readLine()) === FALSE)
+  {
+    echo &quot;&lt;p style='color: black; font-weight: bold'&gt;&quot; . &quot;Error while communicating with the server&quot; . &quot;&lt;/p&gt;&quot;;
+    return;
+  }
+  $res = removeBeginning($res, 'SERVERMSG ');
+  $temp = strpos($res, &quot;Last user ID for &lt;&quot; . $username . &quot;&gt; was &quot;);
+  if ($temp === FALSE) {
+    echo &quot;&lt;p style='color: black; font-weight: bold'&gt;&quot; . &quot;Error while communicating with the server&quot; . &quot;&lt;/p&gt;&quot;;
+    return;
+  } else
+    $userid = removeBeginning($res, &quot;Last user ID for &lt;&quot; . $username . &quot;&gt; was &quot;);
+
+  if ($userid != &quot;0&quot;) {
+    printError(&quot;User has already an ID associated, installing it again would override the old one. Operation cancelled. (note: if you want to override the current ID anyway, you can still do it manually)&quot;);
+    echo &quot;&lt;br /&gt;&lt;br /&gt;&quot;;
+    goBackButton();
+    return;
+  }
+
+  if (($res = $conn-&gt;sendLine(&quot;ISONLINE &quot; . $username)) !== TRUE)
+  {
+    echo &quot;&lt;p style='color: black; font-weight: bold'&gt;&quot; . &quot;Error while communicating with the server&quot; . &quot;&lt;/p&gt;&quot;;
+    return;
+  }
+  if (($res = $conn-&gt;readLine()) === FALSE)
+  {
+    echo &quot;&lt;p style='color: black; font-weight: bold'&gt;&quot; . &quot;Error while communicating with the server&quot; . &quot;&lt;/p&gt;&quot;;
+    return;
+  }
+
+  if ($res != &quot;OK&quot;)
+  {
+    echo &quot;&lt;p style='color: black; font-weight: bold'&gt;&quot; . &quot;User is currently offline. Please try again when user is online. Operation cancelled.&quot; . &quot;&lt;/p&gt;&quot;;
+    goBackButton();
+    return;
+  }
+  
+  if (($res = $conn-&gt;sendLine(&quot;GENERATEUSERID &quot; . $username)) !== TRUE)
+  {
+    echo &quot;&lt;p style='color: black; font-weight: bold'&gt;&quot; . &quot;Error while communicating with the server&quot; . &quot;&lt;/p&gt;&quot;;
+    return;
+  }
+  if (($res = $conn-&gt;readLine()) === FALSE)
+  {
+    echo &quot;&lt;p style='color: black; font-weight: bold'&gt;&quot; . &quot;Error while communicating with the server&quot; . &quot;&lt;/p&gt;&quot;;
+    return;
+  }
+
+  if ($res != &quot;OK&quot;)
+  {
+    echo &quot;&lt;p style='color: black; font-weight: bold'&gt;&quot; . &quot;Error while communicating with the server&quot; . &quot;&lt;/p&gt;&quot;;
+    return;
+  }
+  
+  // close connection with server:
+  $conn-&gt;close();
+
+  echo &quot;&lt;p style='color: black; font-weight: bold'&gt;&quot; . &quot;Request to generate User ID for user &lt;&quot; . $username . &quot;&gt; has been dispatched. You will be notified of success via server notification system.&quot; . &quot;&lt;/p&gt;&quot;;
+  goBackButton();
+
+?&gt;
+
+&lt;?php require(&quot;inc/footer.php&quot;) ?&gt;
\ No newline at end of file

Modified: branches/testserver/WebInterface/userinfo.php
===================================================================
--- branches/testserver/WebInterface/userinfo.php	2008-01-07 12:37:31 UTC (rev 5288)
+++ branches/testserver/WebInterface/userinfo.php	2008-01-07 12:45:18 UTC (rev 5289)
@@ -4,12 +4,12 @@
 
   function displayInputForm()
   {
-    echo &quot;&lt;form action='{$PHP_SELF}' method='post'&gt;&quot;;
+    echo &quot;&lt;form action='{$PHP_SELF}' method='get'&gt;&quot;;
     echo '&lt;table class=&quot;table4&quot;&gt;';
     echo '&lt;tr&gt;';
     echo '  &lt;td&gt;';
-    echo &quot;  Info for (type in username): &lt;input type='text' name='username' /&gt;&quot;;
-    echo &quot;  &lt;input type='submit' value='Submit' name='submit' /&gt;&quot;;
+    echo &quot;  Info for (type in username): &lt;input type='text' name='username' value='&quot; . (isset($_GET['username']) ? $_GET['username'] : &quot;&quot;) . &quot;' /&gt;&quot;;
+    echo &quot;  &lt;input type='submit' value='Submit' /&gt;&quot;;
     echo '  &lt;/td&gt;';
     echo '&lt;/tr&gt;';
     echo '&lt;/table&gt;';
@@ -139,6 +139,25 @@
     default:
       $access = 'unknown (error?)';
     }
+    
+    if (($res = $conn-&gt;sendLine(&quot;queryserver GETUSERID &quot; . $username)) !== TRUE)
+    {
+      echo &quot;&lt;p style='color: black; font-weight: bold'&gt;&quot; . &quot;Error while communicating with the server&quot; . &quot;&lt;/p&gt;&quot;;
+      return;
+    }
+    if (($res = $conn-&gt;readLine()) === FALSE)
+    {
+      echo &quot;&lt;p style='color: black; font-weight: bold'&gt;&quot; . &quot;Error while communicating with the server&quot; . &quot;&lt;/p&gt;&quot;;
+      return;
+    }
+    $res = removeBeginning($res, 'SERVERMSG ');
+    $temp = strpos($res, &quot;Last user ID for &lt;&quot; . $username . &quot;&gt; was &quot;);
+    if ($temp === FALSE)
+      $userid = &quot;[Error querying server]&quot;;
+    else
+      $userid = removeBeginning($res, &quot;Last user ID for &lt;&quot; . $username . &quot;&gt; was &quot;);
+    if ($userid == &quot;0&quot;)
+      $userid = &quot;[UserID not installed]&quot;;
 
     // close connection with server:
     $conn-&gt;close();
@@ -193,20 +212,32 @@
     echo &quot;      &quot; . $lastLogin;
     echo &quot;    &lt;/td&gt;&quot;;
     echo &quot;  &lt;/tr&gt;&quot;;
+    echo &quot;  &lt;tr&gt;&quot;;
+    echo &quot;    &lt;td&gt;&quot;;
+    echo &quot;      User ID: &quot;;
+    echo &quot;    &lt;/td&gt;&quot;;
+    echo &quot;    &lt;td&gt;&quot;;
+    echo &quot;      &quot; . $userid;
+    echo &quot;    &lt;/td&gt;&quot;;
+    echo &quot;  &lt;/tr&gt;&quot;;
     echo &quot;&lt;/table&gt;&quot;;
   }
 
 
   // page contents begin here:
 
-  $username = $_POST['username'];
-  if ($username == &quot;&quot;) $username = $_GET['username'];
+  $username = $_GET['username'];
   if ($username == &quot;&quot;)
     displayInputForm();
   else {
     displayInputForm();
     echo &quot;&lt;br&gt;&lt;br&gt;&quot;;
     displayResultForm($username);
+    
+    // install user ID button:
+    echo &quot;&lt;br&gt;&lt;br&gt;&quot;;
+    echo &quot;&lt;a class='button1' href='userid.php?username=&quot; . $username . &quot;'&gt;Install user ID&lt;/a&gt;&quot;;
+    
   }
 
 


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000096.html">[Taspring-linux-commit] r5288 - in trunk/Lobby/AFLobby/src/aflobby:	. UI framework protocol protocol/tasserver
</A></li>
	<LI>Next message: <A HREF="000098.html">[Taspring-linux-commit] r5290 - branches/testserver
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#97">[ date ]</a>
              <a href="thread.html#97">[ thread ]</a>
              <a href="subject.html#97">[ subject ]</a>
              <a href="author.html#97">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
