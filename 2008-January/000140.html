<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r5333 - in trunk: AI/Group/CentralBuildAI	AI/Group/EconomyAI AI/Group/MexUpgraderAI AI/Group/RadarAI	AI/Group/SimpleFormationAI Lobby/TASServer game game/LuaUI	game/LuaUI/Widgets installer/builddata/springcontent/LuaGadgets	installer/builddata/springcontent/gamedata rts/ExternalAI	rts/Game rts/Game/UI rts/Lua rts/Sim/Misc rts/Sim/Units	rts/Sim/Units/COB rts/Sim/Units/CommandAI rts/System rts/System/Net
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-January/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5333%20-%20in%20trunk%3A%20AI/Group/CentralBuildAI%0A%09AI/Group/EconomyAI%20AI/Group/MexUpgraderAI%20AI/Group/RadarAI%0A%09AI/Group/SimpleFormationAI%20Lobby/TASServer%20game%20game/LuaUI%0A%09game/LuaUI/Widgets%20installer/builddata/springcontent/LuaGadgets%0A%09installer/builddata/springcontent/gamedata%20rts/ExternalAI%0A%09rts/Game%20rts/Game/UI%20rts/Lua%20rts/Sim/Misc%20rts/Sim/Units%0A%09rts/Sim/Units/COB%20rts/Sim/Units/CommandAI%20rts/System%20rts/System/Net&In-Reply-To=%3CE1JFBaG-0006if-E8%40proserver.fnord.lan%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000139.html">
   <LINK REL="Next"  HREF="000141.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r5333 - in trunk: AI/Group/CentralBuildAI	AI/Group/EconomyAI AI/Group/MexUpgraderAI AI/Group/RadarAI	AI/Group/SimpleFormationAI Lobby/TASServer game game/LuaUI	game/LuaUI/Widgets installer/builddata/springcontent/LuaGadgets	installer/builddata/springcontent/gamedata rts/ExternalAI	rts/Game rts/Game/UI rts/Lua rts/Sim/Misc rts/Sim/Units	rts/Sim/Units/COB rts/Sim/Units/CommandAI rts/System rts/System/Net</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5333%20-%20in%20trunk%3A%20AI/Group/CentralBuildAI%0A%09AI/Group/EconomyAI%20AI/Group/MexUpgraderAI%20AI/Group/RadarAI%0A%09AI/Group/SimpleFormationAI%20Lobby/TASServer%20game%20game/LuaUI%0A%09game/LuaUI/Widgets%20installer/builddata/springcontent/LuaGadgets%0A%09installer/builddata/springcontent/gamedata%20rts/ExternalAI%0A%09rts/Game%20rts/Game/UI%20rts/Lua%20rts/Sim/Misc%20rts/Sim/Units%0A%09rts/Sim/Units/COB%20rts/Sim/Units/CommandAI%20rts/System%20rts/System/Net&In-Reply-To=%3CE1JFBaG-0006if-E8%40proserver.fnord.lan%3E"
       TITLE="[Taspring-linux-commit] r5333 - in trunk: AI/Group/CentralBuildAI	AI/Group/EconomyAI AI/Group/MexUpgraderAI AI/Group/RadarAI	AI/Group/SimpleFormationAI Lobby/TASServer game game/LuaUI	game/LuaUI/Widgets installer/builddata/springcontent/LuaGadgets	installer/builddata/springcontent/gamedata rts/ExternalAI	rts/Game rts/Game/UI rts/Lua rts/Sim/Misc rts/Sim/Units	rts/Sim/Units/COB rts/Sim/Units/CommandAI rts/System rts/System/Net">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Wed Jan 16 17:57:48 CET 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000139.html">[Taspring-linux-commit] r5332 - in trunk/rts/lib/lua: . include
</A></li>
        <LI>Next message: <A HREF="000141.html">[Taspring-linux-commit] r5334 - trunk/rts/Lua
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#140">[ date ]</a>
              <a href="thread.html#140">[ thread ]</a>
              <a href="subject.html#140">[ subject ]</a>
              <a href="author.html#140">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: trepan
Date: 2008-01-16 17:57:46 +0100 (Wed, 16 Jan 2008)
New Revision: 5333

Removed:
   trunk/rts/Lua/LuaCob.cpp
   trunk/rts/Lua/LuaCob.h
Modified:
   trunk/AI/Group/CentralBuildAI/GroupAI.cpp
   trunk/AI/Group/EconomyAI/GroupAI.cpp
   trunk/AI/Group/MexUpgraderAI/GroupAI.cpp
   trunk/AI/Group/RadarAI/GroupAI.cpp
   trunk/AI/Group/SimpleFormationAI/GroupAI.cpp
   trunk/Lobby/TASServer/WebServer.java
   trunk/game/LuaUI/Widgets/camera_smooth_move.lua
   trunk/game/LuaUI/Widgets/cmd_doline.lua
   trunk/game/LuaUI/Widgets/gui_hilight_unit.lua
   trunk/game/LuaUI/debug.lua
   trunk/game/LuaUI/layout.lua
   trunk/game/LuaUI/main.lua
   trunk/game/LuaUI/setupdefs.lua
   trunk/game/teamcolors.lua
   trunk/installer/builddata/springcontent/LuaGadgets/README.txt
   trunk/installer/builddata/springcontent/gamedata/explosion_alias.lua
   trunk/rts/ExternalAI/Group.cpp
   trunk/rts/Game/Game.cpp
   trunk/rts/Game/SelectedUnits.cpp
   trunk/rts/Game/UI/GameSetupDrawer.cpp
   trunk/rts/Game/UI/KeyBindings.cpp
   trunk/rts/Game/UI/LuaUI.cpp
   trunk/rts/Game/UI/LuaUI.h
   trunk/rts/Game/UI/MouseHandler.cpp
   trunk/rts/Game/WordCompletion.cpp
   trunk/rts/Lua/LuaFBOs.cpp
   trunk/rts/Lua/LuaHandle.cpp
   trunk/rts/Lua/LuaHandle.h
   trunk/rts/Lua/LuaHandleSynced.cpp
   trunk/rts/Lua/LuaOpenGL.cpp
   trunk/rts/Lua/LuaPathFinder.h
   trunk/rts/Lua/LuaRules.cpp
   trunk/rts/Lua/LuaRules.h
   trunk/rts/Lua/LuaSyncedCall.cpp
   trunk/rts/Lua/LuaSyncedCtrl.cpp
   trunk/rts/Lua/LuaSyncedCtrl.h
   trunk/rts/Lua/LuaSyncedRead.cpp
   trunk/rts/Lua/LuaSyncedRead.h
   trunk/rts/Lua/LuaUnitDefs.cpp
   trunk/rts/Lua/LuaUnsyncedCall.cpp
   trunk/rts/Sim/Misc/FeatureHandler.cpp
   trunk/rts/Sim/Units/COB/CobThread.cpp
   trunk/rts/Sim/Units/COB/CobThread.h
   trunk/rts/Sim/Units/CommandAI/AirCAI.cpp
   trunk/rts/Sim/Units/CommandAI/BuilderCAI.cpp
   trunk/rts/Sim/Units/CommandAI/Command.cpp
   trunk/rts/Sim/Units/CommandAI/Command.h
   trunk/rts/Sim/Units/CommandAI/CommandAI.cpp
   trunk/rts/Sim/Units/CommandAI/FactoryCAI.cpp
   trunk/rts/Sim/Units/CommandAI/MobileCAI.cpp
   trunk/rts/Sim/Units/CommandAI/TransportCAI.cpp
   trunk/rts/Sim/Units/Unit.cpp
   trunk/rts/Sim/Units/Unit.h
   trunk/rts/System/BaseNetProtocol.cpp
   trunk/rts/System/BaseNetProtocol.h
   trunk/rts/System/Net/Net.cpp
   trunk/rts/System/Net/ProtocolDef.cpp
   trunk/rts/System/TdfParser.cpp
Log:
* Removed the LuaCob script, and redirected Cob2Lua calls to LuaRules
* Removed the unused CommandDesc 'hotkey' member
* Added the Spring.GetUnitIsDead() call-out
* Made Spring.GetPositionLosState() backwards compatible
* Added 'showPanelLabel = false' to layout.lua
* Removed some 0.75b2 lua compatibility code


Modified: trunk/AI/Group/CentralBuildAI/GroupAI.cpp
===================================================================
--- trunk/AI/Group/CentralBuildAI/GroupAI.cpp	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/AI/Group/CentralBuildAI/GroupAI.cpp	2008-01-16 16:57:46 UTC (rev 5333)
@@ -257,7 +257,6 @@
 	cd.id=CMD_STOP;
 	cd.name=&quot;Stop&quot;;
 	cd.action=&quot;stop&quot;;
-	cd.hotkey=&quot;s&quot;;
 	commands.push_back(cd);			//should always have a stop command since it is the default
 
 	set&lt;int&gt; alreadyFound;

Modified: trunk/AI/Group/EconomyAI/GroupAI.cpp
===================================================================
--- trunk/AI/Group/EconomyAI/GroupAI.cpp	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/AI/Group/EconomyAI/GroupAI.cpp	2008-01-16 16:57:46 UTC (rev 5333)
@@ -154,7 +154,6 @@
 	cd.type=CMDTYPE_ICON_AREA;
 	cd.name=&quot;Set area&quot;;
 	cd.action=&quot;repair&quot;;
-	cd.hotkey=&quot;r&quot;;
 	cd.tooltip=&quot;Set area: define an area where the Economy AI can build&quot;;
 	commands.push_back(cd);
 
@@ -163,7 +162,6 @@
 	cd.type=CMDTYPE_ICON;
 	cd.name=&quot;Stop&quot;;
 	cd.action=&quot;stop&quot;;
-	cd.hotkey=&quot;s&quot;;
 	cd.tooltip=&quot;Stop all units and remove all buildings sites&quot;;
 	commands.push_back(cd);
 
@@ -172,7 +170,6 @@
 	cd.type=CMDTYPE_ICON;
 	cd.name=&quot;Start&quot;;
 	cd.action=&quot;onoff&quot;;
-	cd.hotkey=&quot;x&quot;;
 	cd.tooltip=&quot;Begin building resources on the current building sites&quot;;
 	commands.push_back(cd);
 
@@ -181,7 +178,6 @@
 	cd.type=CMDTYPE_ICON_MODE;
 	cd.name=&quot;Max resource usage&quot;;
 	cd.action=&quot;reclaim&quot;;
-	cd.hotkey=&quot;e&quot;;
 	int stateInt = int((1.0f - maxResourcePercentage) / 0.25f);
 	char stateChar[1];
 	sprintf(stateChar,&quot;%i&quot;,stateInt);

Modified: trunk/AI/Group/MexUpgraderAI/GroupAI.cpp
===================================================================
--- trunk/AI/Group/MexUpgraderAI/GroupAI.cpp	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/AI/Group/MexUpgraderAI/GroupAI.cpp	2008-01-16 16:57:46 UTC (rev 5333)
@@ -211,13 +211,9 @@
 	cd.id=CMD_CHANGE_MODE;
 	cd.type=CMDTYPE_ICON_MODE;
 	cd.action=&quot;onoff&quot;;
-	cd.hotkey=&quot;x&quot;;
-	if(mode==manual)
-	{
+	if (mode == manual) {
 		cd.params.push_back(&quot;1&quot;);
-	}
-	else //automatic
-	{
+	} else { //automatic
 		cd.params.push_back(&quot;0&quot;);
 	}
 	cd.params.push_back(&quot;Auto&quot;);
@@ -230,7 +226,6 @@
 	cd.type=CMDTYPE_ICON_AREA;
 	cd.name=&quot;Area upgrade&quot;;
 	cd.action=&quot;repair&quot;;
-	cd.hotkey=&quot;r&quot;;
 	cd.tooltip=&quot;Area upgrade: drag out an area to upgrade all mexes there&quot;;
 	commands.push_back(cd);
 
@@ -239,7 +234,6 @@
 	cd.type=CMDTYPE_ICON;
 	cd.name=&quot;Stop&quot;;
 	cd.action=&quot;stop&quot;;
-	cd.hotkey=&quot;s&quot;;
 	commands.push_back(cd);
 
 	return commands;

Modified: trunk/AI/Group/RadarAI/GroupAI.cpp
===================================================================
--- trunk/AI/Group/RadarAI/GroupAI.cpp	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/AI/Group/RadarAI/GroupAI.cpp	2008-01-16 16:57:46 UTC (rev 5333)
@@ -84,7 +84,6 @@
 
 	cd.id=CMD_TEXT_ALERT;
 	cd.type=CMDTYPE_ICON_MODE;
-	cd.hotkey=&quot;t&quot;;
 	if(alertText)
 	{
 		cd.params.push_back(&quot;1&quot;);
@@ -101,13 +100,9 @@
 	cd.params.clear();
 	cd.id=CMD_MINIMAP_ALERT;
 	cd.type=CMDTYPE_ICON_MODE;
-	cd.hotkey=&quot;m&quot;;
-	if(alertMinimap)
-	{
+	if (alertMinimap) {
 		cd.params.push_back(&quot;1&quot;);
-	}
-	else
-	{
+	} else {
 		cd.params.push_back(&quot;0&quot;);
 	}
 	cd.params.push_back(&quot;Minimap off&quot;);
@@ -118,13 +113,9 @@
 	cd.params.clear();
 	cd.id=CMD_SHOW_GHOSTS;
 	cd.type=CMDTYPE_ICON_MODE;
-	cd.hotkey=&quot;g&quot;;
-	if(showGhosts)
-	{
+	if (showGhosts) {
 		cd.params.push_back(&quot;1&quot;);
-	}
-	else
-	{
+	} else {
 		cd.params.push_back(&quot;0&quot;);
 	}
 	cd.params.push_back(&quot;Ghosts off&quot;);

Modified: trunk/AI/Group/SimpleFormationAI/GroupAI.cpp
===================================================================
--- trunk/AI/Group/SimpleFormationAI/GroupAI.cpp	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/AI/Group/SimpleFormationAI/GroupAI.cpp	2008-01-16 16:57:46 UTC (rev 5333)
@@ -44,7 +44,6 @@
 	cd.type=CMDTYPE_ICON;
 	cd.name=&quot;Stop&quot;;
 	cd.action=&quot;stop&quot;;
-	cd.hotkey=&quot;s&quot;;
 	commands.push_back(cd);
 
 	cd.id=CMD_MOVE;
@@ -52,7 +51,6 @@
 	cd.name=&quot;Move&quot;;
 	cd.params.push_back(&quot;2000&quot;);
 	cd.action=&quot;move&quot;;
-	cd.hotkey=&quot;m&quot;;
 	cd.tooltip=&quot;Move: Click on the goal and hold mouse button while drawing out a front to form behind&quot;;
 	char c[40];
 	SNPRINTF(c,10,&quot;%d&quot;,(int)columnDist);

Modified: trunk/Lobby/TASServer/WebServer.java
===================================================================
--- trunk/Lobby/TASServer/WebServer.java	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/Lobby/TASServer/WebServer.java	2008-01-16 16:57:46 UTC (rev 5333)
@@ -380,29 +380,29 @@
     }
 
     static void fillMap() {
-        setSuffix(&quot;&quot;, &quot;content/unknown&quot;);
-        setSuffix(&quot;.uu&quot;, &quot;application/octet-stream&quot;);
-        setSuffix(&quot;.exe&quot;, &quot;application/octet-stream&quot;);
-        setSuffix(&quot;.ps&quot;, &quot;application/postscript&quot;);
-        setSuffix(&quot;.zip&quot;, &quot;application/zip&quot;);
-        setSuffix(&quot;.sh&quot;, &quot;application/x-shar&quot;);
-        setSuffix(&quot;.tar&quot;, &quot;application/x-tar&quot;);
-        setSuffix(&quot;.snd&quot;, &quot;audio/basic&quot;);
-        setSuffix(&quot;.au&quot;, &quot;audio/basic&quot;);
-        setSuffix(&quot;.wav&quot;, &quot;audio/x-wav&quot;);
-        setSuffix(&quot;.gif&quot;, &quot;image/gif&quot;);
-        setSuffix(&quot;.jpg&quot;, &quot;image/jpeg&quot;);
+        setSuffix(&quot;&quot;,      &quot;content/unknown&quot;);
+        setSuffix(&quot;.uu&quot;,   &quot;application/octet-stream&quot;);
+        setSuffix(&quot;.exe&quot;,  &quot;application/octet-stream&quot;);
+        setSuffix(&quot;.ps&quot;,   &quot;application/postscript&quot;);
+        setSuffix(&quot;.zip&quot;,  &quot;application/zip&quot;);
+        setSuffix(&quot;.sh&quot;,   &quot;application/x-shar&quot;);
+        setSuffix(&quot;.tar&quot;,  &quot;application/x-tar&quot;);
+        setSuffix(&quot;.snd&quot;,  &quot;audio/basic&quot;);
+        setSuffix(&quot;.au&quot;,   &quot;audio/basic&quot;);
+        setSuffix(&quot;.wav&quot;,  &quot;audio/x-wav&quot;);
+        setSuffix(&quot;.gif&quot;,  &quot;image/gif&quot;);
+        setSuffix(&quot;.jpg&quot;,  &quot;image/jpeg&quot;);
         setSuffix(&quot;.jpeg&quot;, &quot;image/jpeg&quot;);
-        setSuffix(&quot;.htm&quot;, &quot;text/html&quot;);
+        setSuffix(&quot;.htm&quot;,  &quot;text/html&quot;);
         setSuffix(&quot;.html&quot;, &quot;text/html&quot;);
         setSuffix(&quot;.text&quot;, &quot;text/plain&quot;);
-        setSuffix(&quot;.c&quot;, &quot;text/plain&quot;);
-        setSuffix(&quot;.cc&quot;, &quot;text/plain&quot;);
-        setSuffix(&quot;.c++&quot;, &quot;text/plain&quot;);
-        setSuffix(&quot;.h&quot;, &quot;text/plain&quot;);
-        setSuffix(&quot;.pl&quot;, &quot;text/plain&quot;);
-        setSuffix(&quot;.txt&quot;, &quot;text/plain&quot;);
-        setSuffix(&quot;.log&quot;, &quot;text/plain&quot;);
+        setSuffix(&quot;.c&quot;,    &quot;text/plain&quot;);
+        setSuffix(&quot;.cc&quot;,   &quot;text/plain&quot;);
+        setSuffix(&quot;.c++&quot;,  &quot;text/plain&quot;);
+        setSuffix(&quot;.h&quot;,    &quot;text/plain&quot;);
+        setSuffix(&quot;.pl&quot;,   &quot;text/plain&quot;);
+        setSuffix(&quot;.txt&quot;,  &quot;text/plain&quot;);
+        setSuffix(&quot;.log&quot;,  &quot;text/plain&quot;);
         setSuffix(&quot;.java&quot;, &quot;text/plain&quot;);
     }
 

Modified: trunk/game/LuaUI/Widgets/camera_smooth_move.lua
===================================================================
--- trunk/game/LuaUI/Widgets/camera_smooth_move.lua	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/game/LuaUI/Widgets/camera_smooth_move.lua	2008-01-16 16:57:46 UTC (rev 5333)
@@ -87,10 +87,8 @@
         return
       end
       -- clear the velocities
-      if cs[23] then -- FIXME (remove this line &amp; end)-- 0.75b2 compatibility
-        for p = 23,28 do
-          cs[p] = 0
-        end
+      for p = 23,28 do
+        cs[p] = 0
       end
     end
     if (cs.name == &quot;ta&quot;) then

Modified: trunk/game/LuaUI/Widgets/cmd_doline.lua
===================================================================
--- trunk/game/LuaUI/Widgets/cmd_doline.lua	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/game/LuaUI/Widgets/cmd_doline.lua	2008-01-16 16:57:46 UTC (rev 5333)
@@ -63,7 +63,6 @@
 
 
 function widget:Initialize()
-  widgetHandler:AddAction(&quot;doline&quot;,  RunCmd)  -- backwards compatible
   widgetHandler:AddAction(&quot;run&quot;,     RunCmd)
   widgetHandler:AddAction(&quot;echolua&quot;, EchoCmd, nil)
   widgetHandler:AddAction(&quot;echo&quot;,    EchoCmd, nil, &quot;t&quot;) -- text only

Modified: trunk/game/LuaUI/Widgets/gui_hilight_unit.lua
===================================================================
--- trunk/game/LuaUI/Widgets/gui_hilight_unit.lua	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/game/LuaUI/Widgets/gui_hilight_unit.lua	2008-01-16 16:57:46 UTC (rev 5333)
@@ -282,9 +282,6 @@
     return
   end
 
-  -- 0.75b2 compatibility
-  if (not spGetFeatureRadius) then return end
-
   local radius = spGetFeatureRadius(featureID)
   if (radius == nil) then
     return

Modified: trunk/game/LuaUI/debug.lua
===================================================================
--- trunk/game/LuaUI/debug.lua	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/game/LuaUI/debug.lua	2008-01-16 16:57:46 UTC (rev 5333)
@@ -13,7 +13,7 @@
 
 
 function PrintInCommand()
-  cmdIndex, cmdId, cmdType, name = Spring.GetActiveCommand()
+  local cmdIndex, cmdId, cmdType, name = Spring.GetActiveCommand()
   print(&quot;InCommand: &quot;, cmdIndex, cmdId, cmdType, name)
 end
 
@@ -30,8 +30,8 @@
 
 
 function PrintSelection()
-  udTable       = Spring.GetSelectedUnitsSorted()
-  selectedGroup = Spring.GetSelectedGroup()
+  local udTable       = Spring.GetSelectedUnitsSorted()
+  local selectedGroup = Spring.GetSelectedGroup()
   print(&quot;Selected Group = &quot; .. selectedGroup)
   print(&quot;Selected: &quot; .. udTable.n .. &quot; types&quot;)
   udTable.n = nil
@@ -39,7 +39,7 @@
      print('  ' .. udid .. '=' .. UnitDefs[udid].name .. ' count ' .. uTable.n)
     uTable.n = nil
     for _,uid in ipairs(uTable) do
-    	health, maxHealth, paralyze, capture, build = Spring.GetUnitHealth(uid)
+      local health, maxHealth, paralyze, capture, build = Spring.GetUnitHealth(uid)
       print('  ', uid, health, maxHealth, paralyze, capture, build)
       PrintCommandQueue(uid)
     end
@@ -54,13 +54,13 @@
 
 
 function PrintCommandQueue(uid)
-  queue = Spring.GetCommandQueue(uid)
+  local queue = Spring.GetCommandQueue(uid)
   if (queue ~= nil) then
-    msg = ''
-    count = 0
+    local msg = ''
+    local count = 0
     for i,cmd in pairs(queue) do
       if (cmd ~= CMD.SET_WANTED_MAX_SPEED) then
-        name = CommandNames[cmd]
+        local name = CommandNames[cmd]
         if (name ~= nil) then
           count = count + 1
           msg = msg .. '  ' .. CommandNames[cmd] .. ','
@@ -76,17 +76,17 @@
 
 
 function PrintGroups()
-  groupList, count = Spring.GetGroupList()
+  local groupList, count = Spring.GetGroupList()
   print(&quot;GetGroupList: &quot; .. tostring(count))
   for i, v in pairs(groupList) do
-  	local groupName = Spring.GetGroupAIName(i)
-  	if (groupName == nil) then groupName = &quot;&quot; end
+    local groupName = Spring.GetGroupAIName(i)
+    if (groupName == nil) then groupName = &quot;&quot; end
     print('  ' .. i .. '\t' .. v .. '\t' .. groupName)
   end
 
   for g, c in pairs(groupList) do
     print(&quot;Units in Group &quot; .. g)
-    udTable = Spring.GetGroupUnitsSorted(g)
+    local udTable = Spring.GetGroupUnitsSorted(g)
     print(&quot;  MyTeamUnits: &quot; .. udTable.n .. &quot; types&quot;)
     udTable.n = nil
     for udid,uTable in pairs(udTable) do
@@ -119,8 +119,8 @@
 
 
 function PrintTeamUnitsCounts(team)
-	print(&quot;Team Units Count:&quot; .. team)
-  countTable = Spring.GetTeamUnitsCounts(team)
+  print(&quot;Team Units Count:&quot; .. team)
+  local countTable = Spring.GetTeamUnitsCounts(team)
   if (countTable == nil) then
     return
   end
@@ -132,7 +132,7 @@
 
 
 function PrintAlliedUnits()
-  teamTable = Spring.GetTeamList(Spring.GetMyAllyTeamID())
+  local teamTable = Spring.GetTeamList(Spring.GetMyAllyTeamID())
 --  print(&quot;AlliedUnits: &quot; .. teamTable.n .. &quot; teams&quot;)
   teamTable.n = nil
   for n,tid in pairs(teamTable) do
@@ -142,11 +142,11 @@
 
 
 function PrintAllyTeamList()
-  allyTeamTable = Spring.GetAllyTeamList()
-	local msg = &quot;AllyTeams(&quot; .. allyTeamTable.n .. &quot;)&quot;
+  local allyTeamTable = Spring.GetAllyTeamList()
+  local msg = &quot;AllyTeams(&quot; .. allyTeamTable.n .. &quot;)&quot;
   allyTeamTable.n = nil
   for n,atid in pairs(allyTeamTable) do
-  	msg = msg .. &quot; &quot; .. atid
+    msg = msg .. &quot; &quot; .. atid
   end
   print(msg)
 end
@@ -163,10 +163,10 @@
     return
   end
 
-	local msg = &quot;Teams(&quot; .. teamTable.n .. &quot;)&quot;
+  local msg = &quot;Teams(&quot; .. teamTable.n .. &quot;)&quot;
   teamTable.n = nil
   for n,tid in pairs(teamTable) do
-  	msg = msg .. &quot; &quot; .. tid
+    msg = msg .. &quot; &quot; .. tid
   end
   print(msg)
 end
@@ -183,10 +183,10 @@
     return
   end
 
-	local msg = &quot;Players(&quot; .. playerTable.n .. &quot;)&quot;
+  local msg = &quot;Players(&quot; .. playerTable.n .. &quot;)&quot;
   playerTable.n = nil
   for n,pid in pairs(playerTable) do
-  	msg = msg .. &quot; &quot; .. pid
+    msg = msg .. &quot; &quot; .. pid
   end
   print(msg)
 end
@@ -198,34 +198,32 @@
     print('Ally team: ' .. atid)
     local tTable = Spring.GetTeamList(atid)
     for tn,tid in ipairs(tTable) do
-	    print('  Team: ' .. tid)
-	    local pTable = Spring.GetPlayerList(tid)
+      print('  Team: ' .. tid)
+      local pTable = Spring.GetPlayerList(tid)
       for pn,pid in ipairs(pTable) do
-      	local pname, active = Spring.GetPlayerInfo(pid)
-      	if (active) then
-	  	    print('    Player: ' .. pid .. &quot; &quot; .. pname)
-	  	  end
-  	  end
+        local pname, active = Spring.GetPlayerInfo(pid)
+        if (active) then
+          print('    Player: ' .. pid .. &quot; &quot; .. pname)
+        end
+      end
     end
   end
 end
 
 
 function PrintTeamInfo(teamID)
-  c = {}
-  num, leader, active, dead, isAI, side, c[0], c[1], c[2], c[3] = Spring.GetTeamInfo(teamID)
+  local num, leader, dead, isAI, side, allyTeam = Spring.GetTeamInfo(teamID)
   print('Team number: ' .. num)
   print('     leader: ' .. leader)
-  print('     active: ' .. tostring(active))
   print('       dead: ' .. tostring(dead))
   print('       isAI: ' .. tostring(isAI))
   print('       side: ' .. side)
-  print('      color: ' .. c[0]..' '..c[1]..' '..c[2]..' '..c[3])
+  print('   allyTeam: ' .. allyTeam)
 end
 
 
 function PrintTeamResources(teamID, type)
-  current, storage, pull, income, expense,
+  local current, storage, pull, income, expense,
     share, sent, received = Spring.GetTeamResources(teamID, type)
   if (current ~= nil) then
     print('Team number: ' .. teamID)
@@ -242,8 +240,8 @@
 
 
 function PrintTeamUnitStats(teamID)
-	kills, deaths, caps, losses, recv, sent = Spring.GetTeamUnitStats(teamID)
-	if (kills ~= nil) then
+  local kills, deaths, caps, losses, recv, sent = Spring.GetTeamUnitStats(teamID)
+  if (kills ~= nil) then
     print('Team number: ' .. teamID)
     print('  kills:  ' .. kills)
     print('  deaths: ' .. deaths)
@@ -251,12 +249,12 @@
     print('  losses: ' .. losses)
     print('  recv:   ' .. recv)
     print('  sent:   ' .. sent)
-	end
+  end
 end
 
 
 function PrintPlayerInfo(playerID)
-  name, active, spectator, team, allyteam, ping, cpuUsage = 
+  local name, active, spectator, team, allyteam, ping, cpuUsage = 
     Spring.GetPlayerInfo(playerID)
   print('   name:     '..name)
   print('   id:       '..playerID)
@@ -313,6 +311,8 @@
   print(&quot;Game.windMax               = &quot; .. Game.windMax)
   print(&quot;Game.mapX                  = &quot; .. Game.mapX)
   print(&quot;Game.mapY                  = &quot; .. Game.mapY)
+  print(&quot;Game.mapSizeX              = &quot; .. Game.mapSizeX)
+  print(&quot;Game.mapSizeZ              = &quot; .. Game.mapSizeZ)
   print(&quot;Game.mapName               = &quot; .. Game.mapName)
   print(&quot;Game.modName               = &quot; .. Game.modName)
   print(&quot;Game.limitDGun             = &quot; .. tostring(Game.limitDGun))

Modified: trunk/game/LuaUI/layout.lua
===================================================================
--- trunk/game/LuaUI/layout.lua	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/game/LuaUI/layout.lua	2008-01-16 16:57:46 UTC (rev 5333)
@@ -34,9 +34,12 @@
 end
 
 
+local showPanelLabel = false
+
+
 -- for DefaultHandler
 local FrameTex   = &quot;bitmaps/icons/frame_slate_128x96.png&quot;
-local FrameScale     = &quot;&amp;0.099x0.132&amp;&quot;
+local FrameScale = &quot;&amp;0.099x0.132&amp;&quot;
 local PageNumTex = &quot;bitmaps/circularthingy.tga&quot;
 
 
@@ -90,10 +93,13 @@
   local iconList = {}
 
   local cmdsFirst = (commands[1].id &gt;= 0)
-  if (cmdsFirst) then
-    menuName =   RedStr .. 'Commands'
-  else
-    menuName = GreenStr .. 'Build Orders'
+
+  if (showPanelLabel) then
+    if (cmdsFirst) then
+      menuName =   RedStr .. 'Commands'
+    else
+      menuName = GreenStr .. 'Build Orders'
+    end
   end
 
   local ipp = (xIcons * yIcons)  -- iconsPerPage
@@ -153,7 +159,7 @@
       iconList[pos] = cmdSlot
       pos = pos + 1
 
-      local cmdTex = cmd.texture or &quot;&quot; -- FIXME 0.75b2 compatibility
+      local cmdTex = cmd.texture
       if (#cmdTex &gt; 0) then
         if (cmdTex:byte(1) ~= 38) then  --  '&amp;' == 38
           reTexCmds[cmdSlot] = FrameScale..cmdTex..'&amp;'..FrameTex

Modified: trunk/game/LuaUI/main.lua
===================================================================
--- trunk/game/LuaUI/main.lua	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/game/LuaUI/main.lua	2008-01-16 16:57:46 UTC (rev 5333)
@@ -11,26 +11,6 @@
 --------------------------------------------------------------------------------
 --------------------------------------------------------------------------------
 
---
--- 0.75b2 compatibilty
---
-if (Spring.GetTeamColor == nil) then
-  local getTeamInfo = Spring.GetTeamInfo
-  Spring.GetTeamColor = function(teamID)
-    local _,_,_,_,_,_,r,g,b,a = getTeamInfo(teamID)
-    return r, g, b, a
-  end
-  Spring.GetTeamInfo = function(teamID)
-    local id, leader, active, isDead, isAi, side,
-          r, g, b, a, allyTeam = getTeamInfo(teamID)
-    return id, leader, active, isDead, isAi, side, allyTeam
-  end
-end
-
-
---------------------------------------------------------------------------------
---------------------------------------------------------------------------------
-
 Spring.SendCommands({&quot;ctrlpanel &quot; .. LUAUI_DIRNAME .. &quot;ctrlpanel.txt&quot;})
 
 VFS.Include(LUAUI_DIRNAME .. 'utils.lua', utilFile)
@@ -43,6 +23,7 @@
 include(&quot;layout.lua&quot;)   -- contains a simple LayoutButtons()
 include(&quot;widgets.lua&quot;)  -- the widget handler
 
+
 --------------------------------------------------------------------------------
 --
 -- print the header

Modified: trunk/game/LuaUI/setupdefs.lua
===================================================================
--- trunk/game/LuaUI/setupdefs.lua	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/game/LuaUI/setupdefs.lua	2008-01-16 16:57:46 UTC (rev 5333)
@@ -22,8 +22,10 @@
   ud.canParalyze    = false
   ud.canStockpile   = false
   ud.canAttackWater = false
-  for _,wt in ipairs(ud.weapons) do
+  ud.wDefs = {}
+  for i, wt in ipairs(ud.weapons) do
     local wd = WeaponDefs[wt.weaponDef]
+    ud.wDefs[i] = wd
     if (wd) then
       if (wd.isShield)    then ud.hasShield      = true end
       if (wd.paralyzer)   then ud.canParalyze    = true end

Modified: trunk/game/teamcolors.lua
===================================================================
--- trunk/game/teamcolors.lua	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/game/teamcolors.lua	2008-01-16 16:57:46 UTC (rev 5333)
@@ -18,6 +18,7 @@
 
 local debug = true and false
 
+local print = Spring.Echo
 
 --------------------------------------------------------------------------------
 --------------------------------------------------------------------------------

Modified: trunk/installer/builddata/springcontent/LuaGadgets/README.txt
===================================================================
--- trunk/installer/builddata/springcontent/LuaGadgets/README.txt	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/installer/builddata/springcontent/LuaGadgets/README.txt	2008-01-16 16:57:46 UTC (rev 5333)
@@ -1,2 +1,7 @@
 
 FIXME -- write something in here   ;-)
+
+TODO:
+- Add a command hook manager for AllowCommand() and CommandFallback()
+  (cmdID, unitID, and unitDef triggers; don't bother with team triggers?)
+- Switch away from gadget:func() calls  (just use gadget.func())

Modified: trunk/installer/builddata/springcontent/gamedata/explosion_alias.lua
===================================================================
--- trunk/installer/builddata/springcontent/gamedata/explosion_alias.lua	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/installer/builddata/springcontent/gamedata/explosion_alias.lua	2008-01-16 16:57:46 UTC (rev 5333)
@@ -35,21 +35,29 @@
     },
     projectiles = {
       beamlaser             = 'CBeamLaserProjectile',
+      bitmapmuzzleflame     = 'CBitmapMuzzleFlame',
       bubble                = 'CBubbleProjectile',
+      delayspawner          = 'CExpGenSpawner',
       dirt                  = 'CDirtProjectile',
       emg                   = 'CEmgProjectile',
       expl                  = 'CExplosiveProjectile',
+      explsphere            = 'CSpherePartSpawner',
       explspike             = 'CExploSpikeProjectile',
       fireball              = 'CFireBallProjectile',
       fire                  = 'CFireProjectile',
       flame                 = 'CFlameProjectile',
       flare                 = 'CFlareProjectile',
       geosquare             = 'CGeoSquareProjectile',
+      gfx                   = 'CGfxProjectile',
+      heatcloud             = 'CHeatCloudProjectile',
       lighting              = 'CLightingProjectile',
       missile               = 'CMissileProjectile',
       muzzleflame           = 'CMuzzleFlame',
       piece                 = 'CPieceProjectile',
       shieldpart            = 'CShieldPartProjectile',
+      simplegroundflash     = 'CSimpleGroundFlash',
+      simpleparticlespawner = 'CSphereParticleSpawner',
+      simpleparticlesystem  = 'CSimpleParticleSystem',
       smoke                 = 'CSmokeProjectile',
       smoke2                = 'CSmokeProjectile2',
       smoketrail            = 'CSmokeTrailProjectile',
@@ -58,15 +66,6 @@
       torpedo               = 'CTorpedoProjectile',
       tracer                = 'CTracerProjectile',
       wake                  = 'CWakeProjectile',
-      heatcloud             = 'CHeatCloudProjectile',
-      gfx                   = 'CGfxProjectile',
-      SimpleParticleSystem  = 'CSimpleParticleSystem',
-      BitmapMuzzleFlame     = 'CBitmapMuzzleFlame',
-      DelaySpawner          = 'CExpGenSpawner',
-      ExplosionSphere       = 'CSpherePartSpawner',
-      ExplosionSpike        = 'CExploSpikeProjectile',
-      SimpleParticleSpawner = 'CSphereParticleSpawner',
-      SimpleGroundFlash     = 'CSimpleGroundFlash',
     },
   }
 end

Modified: trunk/rts/ExternalAI/Group.cpp
===================================================================
--- trunk/rts/ExternalAI/Group.cpp	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/ExternalAI/Group.cpp	2008-01-16 16:57:46 UTC (rev 5333)
@@ -274,7 +274,6 @@
 			c.id   = i-&gt;id;
 			c.type = i-&gt;type;
 			c.action    = i-&gt;action.c_str();
-			c.hotkey    = i-&gt;hotkey.c_str();
 			c.name      = i-&gt;name.c_str();
 			c.iconname  = i-&gt;iconname.c_str();
 			c.mouseicon = i-&gt;mouseicon.c_str();
@@ -294,7 +293,6 @@
 	c.name=&quot;Select AI&quot;;
 	c.tooltip=&quot;Select the AI to use for this group from the available AIs&quot;;
 	c.showUnique=true;
-	c.hotkey=&quot;Ctrl+q&quot;;
 
 	char t[50];
 	sprintf(t,&quot;%i&quot;,currentAiNum+1);

Modified: trunk/rts/Game/Game.cpp
===================================================================
--- trunk/rts/Game/Game.cpp	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/Game/Game.cpp	2008-01-16 16:57:46 UTC (rev 5333)
@@ -73,7 +73,6 @@
 #include &quot;Rendering/UnitModels/3DOParser.h&quot;
 #include &quot;Rendering/UnitModels/UnitDrawer.h&quot;
 #include &quot;Lua/LuaCallInHandler.h&quot;
-#include &quot;Lua/LuaCob.h&quot;
 #include &quot;Lua/LuaGaia.h&quot;
 #include &quot;Lua/LuaRules.h&quot;
 #include &quot;Lua/LuaOpenGL.h&quot;
@@ -407,8 +406,6 @@
 
 	globalAI = SAFE_NEW CGlobalAIHandler();
 
-	PrintLoadMsg(&quot;Loading LuaCOB&quot;);
-	CLuaCob::LoadHandler();
 	if (gs-&gt;useLuaRules) {
 		PrintLoadMsg(&quot;Loading LuaRules&quot;);
 		CLuaRules::LoadHandler();
@@ -511,7 +508,6 @@
 	tracefile &lt;&lt; &quot;End game\n&quot;;
 #endif
 
-	CLuaCob::FreeHandler();
 	CLuaGaia::FreeHandler();
 	CLuaRules::FreeHandler();
 	LuaOpenGL::Free();
@@ -2066,7 +2062,6 @@
 	lastUpdateRaw = SDL_GetTicks();
 
  	if (luaUI)    { luaUI-&gt;CheckStack(); }
-	if (luaCob)   { luaCob-&gt;CheckStack(); }
 	if (luaGaia)  { luaGaia-&gt;CheckStack(); }
 	if (luaRules) { luaRules-&gt;CheckStack(); }
 
@@ -2489,7 +2484,6 @@
 	script-&gt;Update();
 
 	if (luaUI)    { luaUI-&gt;GameFrame(gs-&gt;frameNum); }
-	if (luaCob)   { luaCob-&gt;GameFrame(gs-&gt;frameNum); }
 	if (luaGaia)  { luaGaia-&gt;GameFrame(gs-&gt;frameNum); }
 	if (luaRules) { luaRules-&gt;GameFrame(gs-&gt;frameNum); }
 
@@ -4125,39 +4119,6 @@
 			}
 		}
 	}
-	else if ((s.find(&quot;.luacob&quot;) == 0) &amp;&amp; (gs-&gt;frameNum &gt; 1)) {
-		if (s ==  &quot;.luacob reload&quot;) {
-			if (player != 0) {
-				logOutput.Print(&quot;Only the host player can reload synced scripts\n&quot;);
-			} else if (!gs-&gt;cheatEnabled) {
-				logOutput.Print(&quot;Cheating required to reload synced scripts\n&quot;);
-			} else {
-				CLuaCob::FreeHandler();
-				CLuaCob::LoadHandler();
-				if (luaCob) {
-					logOutput.Print(&quot;LuaCob reloaded\n&quot;);
-				} else {
-					logOutput.Print(&quot;LuaCob reload failed\n&quot;);
-				}
-			}
-		}
-		else if (s == &quot;.luacob disable&quot;) {
-			if (player != 0) {
-				logOutput.Print(&quot;Only the host player can disable synced scripts\n&quot;);
-			} else if (!gs-&gt;cheatEnabled) {
-				logOutput.Print(&quot;Cheating required to disable synced scripts\n&quot;);
-			} else {
-				CLuaCob::FreeHandler();
-				logOutput.Print(&quot;LuaCob disabled\n&quot;);
-			}
-		}
-		else if (luaCob) {
-			luaCob-&gt;GotChatMsg(s.substr(strlen(&quot;.luacob&quot;)), player);
-		}
-		else {
-			logOutput.Print(&quot;LuaCob is not enabled\n&quot;);
-		}
-	}
 	else if (s.find(&quot;.save &quot;) == 0) {//.save [-y ]&lt;savename&gt;
 		if (filesystem.CreateDirectory(&quot;Saves&quot;)) {
 			bool saveoverride = s.find(&quot; -y &quot;) == 0;
@@ -4177,7 +4138,6 @@
 	else if ((s[0] == '.') &amp;&amp; (gs-&gt;frameNum &gt; 1)) {
 		if (luaRules &amp;&amp; luaRules-&gt;SyncedActionFallback(s, player)) { return; }
 		if (luaGaia  &amp;&amp; luaGaia-&gt;SyncedActionFallback(s, player))  { return; }
-		if (luaCob   &amp;&amp; luaCob-&gt;SyncedActionFallback(s, player))   { return; }
 	}
 }
 

Modified: trunk/rts/Game/SelectedUnits.cpp
===================================================================
--- trunk/rts/Game/SelectedUnits.cpp	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/Game/SelectedUnits.cpp	2008-01-16 16:57:46 UTC (rev 5333)
@@ -80,7 +80,6 @@
 		c.type=CMDTYPE_ICON;
 		c.name=&quot;Clear group&quot;;
 		c.tooltip=&quot;Removes the units from any group they belong to&quot;;
-		c.hotkey=&quot;Shift+q&quot;;
 		ac.commands.push_back(c);
 
 		return ac;
@@ -123,7 +122,6 @@
 				c.type    = CMDTYPE_COMBO_BOX;
 				c.name    = &quot;Select AI&quot;;
 				c.tooltip = &quot;Create a new group using the selected units and with the ai selected&quot;;
-				c.hotkey  = &quot;Ctrl+q&quot;;
 
 				c.params.push_back(&quot;0&quot;);
 				c.params.push_back(&quot;None&quot;);
@@ -142,7 +140,6 @@
 			c.type=CMDTYPE_ICON;
 			c.name=&quot;Add to group&quot;;
 			c.tooltip=&quot;Adds the selected to an existing group (of which one or more units is already selected)&quot;;
-			c.hotkey=&quot;q&quot;;
 			groupCommands.push_back(c);
 		}
 
@@ -155,7 +152,6 @@
 			c.type=CMDTYPE_ICON;
 			c.name=&quot;Select group&quot;;
 			c.tooltip=&quot;Select the group that these units belong to&quot;;
-			c.hotkey=&quot;q&quot;;
 			groupCommands.push_back(c);
 		}
 
@@ -168,7 +164,6 @@
 			c.type=CMDTYPE_ICON;
 			c.name=&quot;Clear group&quot;;
 			c.tooltip=&quot;Removes the units from any group they belong to&quot;;
-			c.hotkey=&quot;Shift+q&quot;;
 			groupCommands.push_back(c);
 		}
 	} // end if (!gs-&gt;noHelperAIs)

Modified: trunk/rts/Game/UI/GameSetupDrawer.cpp
===================================================================
--- trunk/rts/Game/UI/GameSetupDrawer.cpp	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/Game/UI/GameSetupDrawer.cpp	2008-01-16 16:57:46 UTC (rev 5333)
@@ -12,10 +12,12 @@
 #include &quot;LuaUI.h&quot;
 #include &quot;Rendering/glFont.h&quot;
 
-GameSetupDrawer* GameSetupDrawer::instance = 0;
-
 extern Uint8 *keys;
 
+
+GameSetupDrawer* GameSetupDrawer::instance = NULL;
+
+
 void GameSetupDrawer::Enable()
 {
 	assert(instance == 0);
@@ -24,6 +26,7 @@
 	instance = new GameSetupDrawer();
 }
 
+
 void GameSetupDrawer::Disable()
 {
 	if (instance)
@@ -33,6 +36,7 @@
 	}
 }
 
+
 GameSetupDrawer::GameSetupDrawer()
 {
 	if (gameSetup-&gt;startPosType == CGameSetup::StartPos_ChooseInGame &amp;&amp; !gameSetup-&gt;hostDemo) {
@@ -45,6 +49,7 @@
 {
 }
 
+
 void GameSetupDrawer::Draw()
 {
 	float xshift = 0.0f;
@@ -98,11 +103,11 @@
 
 	for (int a = 0; a &lt;= gameSetup-&gt;numPlayers; a++) {
 		const float* color;
-		const float red[4]    = { 1.0f ,0.2f, 0.2f, 1.0f };
-		const float green[4]  = { 0.2f, 1.0f, 0.2f, 1.0f };
+		const float    red[4] = { 1.0f, 0.2f, 0.2f, 1.0f };
+		const float  green[4] = { 0.2f, 1.0f, 0.2f, 1.0f };
 		const float yellow[4] = { 0.8f, 0.8f, 0.2f, 1.0f };
-		const float dark[4]   = { 0.2f, 0.2f, 0.2f, 0.8f };
-		const float white[4]  = { 1.0f, 1.0f, 1.0f, 1.0f };
+		const float  white[4] = { 1.0f, 1.0f, 1.0f, 1.0f };
+		const float   dark[4] = { 0.2f, 0.2f, 0.2f, 0.8f };
 		if (a == gameSetup-&gt;numPlayers) {
 			color = white; //blue;
 		} else if (!gs-&gt;players[a]-&gt;readyToStart) {
@@ -117,12 +122,12 @@
 		if (a == gameSetup-&gt;numPlayers) {
 			name = &quot;Players:&quot;;
 		} else {
-			name  = gs-&gt;players[a]-&gt;playerName.c_str();
+			name = gs-&gt;players[a]-&gt;playerName.c_str();
 		}
 		const float yScale = 0.028f;
 		const float xScale = yScale / gu-&gt;aspectRatio;
-		const float xPixel  = 1.0f / (xScale * (float)gu-&gt;viewSizeX);
-		const float yPixel  = 1.0f / (yScale * (float)gu-&gt;viewSizeY);
+		const float xPixel = 1.0f / (xScale * (float)gu-&gt;viewSizeX);
+		const float yPixel = 1.0f / (yScale * (float)gu-&gt;viewSizeY);
 		const float yPos = 0.5f - (0.5f * yScale * gameSetup-&gt;numPlayers) + (yScale * (float)a);
 		const float xPos = xScale;
 		glPushMatrix();
@@ -133,10 +138,12 @@
 	}
 }
 
+
 bool GameSetupDrawer::KeyPressed(unsigned short key, bool isRepeat)
 {
-	if (keys[SDLK_LCTRL] &amp;&amp; key == SDLK_RETURN)
+	if (keys[SDLK_LCTRL] &amp;&amp; (key == SDLK_RETURN)) {
 		gameSetup-&gt;forceReady = true;
+	}
 	return false;
 }
 

Modified: trunk/rts/Game/UI/KeyBindings.cpp
===================================================================
--- trunk/rts/Game/UI/KeyBindings.cpp	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/Game/UI/KeyBindings.cpp	2008-01-16 16:57:46 UTC (rev 5333)
@@ -794,7 +794,7 @@
 				const string unitName = action.command.substr(10);
 				const UnitDef* unitDef = unitDefHandler-&gt;GetUnitByName(unitName);
 				if (unitDef) {
-					comment = &quot;  // &quot; + unitDef-&gt;humanName + &quot; :: &quot; + unitDef-&gt;tooltip;
+					comment = &quot;  // &quot; + unitDef-&gt;humanName + &quot; - &quot; + unitDef-&gt;tooltip;
 				}
 			}
 			if (comment.empty()) {

Modified: trunk/rts/Game/UI/LuaUI.cpp
===================================================================
--- trunk/rts/Game/UI/LuaUI.cpp	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/Game/UI/LuaUI.cpp	2008-01-16 16:57:46 UTC (rev 5333)
@@ -319,7 +319,6 @@
 	REGISTER_LUA_CFUNC(GiveOrderArrayToUnitArray);
 
 	REGISTER_LUA_CFUNC(SendLuaUIMsg);
-	REGISTER_LUA_CFUNC(SendLuaCobMsg);
 	REGISTER_LUA_CFUNC(SendLuaGaiaMsg);
 	REGISTER_LUA_CFUNC(SendLuaRulesMsg);
 
@@ -2966,14 +2965,6 @@
 }
 
 
-int CLuaUI::SendLuaCobMsg(lua_State* L)
-{
-	const string msg = GetRawMsg(L, __FUNCTION__, 1);
-	net-&gt;SendLuaMsg(gu-&gt;myPlayerNum, LUA_HANDLE_ORDER_COB, 0, msg);
-	return 0;
-}
-
-
 int CLuaUI::SendLuaGaiaMsg(lua_State* L)
 {
 	const string msg = GetRawMsg(L, __FUNCTION__, 1);

Modified: trunk/rts/Game/UI/LuaUI.h
===================================================================
--- trunk/rts/Game/UI/LuaUI.h	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/Game/UI/LuaUI.h	2008-01-16 16:57:46 UTC (rev 5333)
@@ -215,7 +215,6 @@
 		static int GiveOrderArrayToUnitArray(lua_State* L);
 
 		static int SendLuaUIMsg(lua_State* L);
-		static int SendLuaCobMsg(lua_State* L);
 		static int SendLuaGaiaMsg(lua_State* L);
 		static int SendLuaRulesMsg(lua_State* L);
 

Modified: trunk/rts/Game/UI/MouseHandler.cpp
===================================================================
--- trunk/rts/Game/UI/MouseHandler.cpp	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/Game/UI/MouseHandler.cpp	2008-01-16 16:57:46 UTC (rev 5333)
@@ -528,7 +528,6 @@
 		glEnd();
 		glLineWidth(1.0f);
 
-
 		glPopAttrib();
 	}
 }

Modified: trunk/rts/Game/WordCompletion.cpp
===================================================================
--- trunk/rts/Game/WordCompletion.cpp	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/Game/WordCompletion.cpp	2008-01-16 16:57:46 UTC (rev 5333)
@@ -81,7 +81,6 @@
 	words[&quot;.give &quot;] = sl;
 	words[&quot;.kick &quot;] = sl;
 	words[&quot;.kickbynum &quot;] = sl;
-	words[&quot;.luacob &quot;] = sl;
 	words[&quot;.luagaia &quot;] = sl;
 	words[&quot;.luarules &quot;] = sl;
 	words[&quot;.nocost&quot;] = sl;

Deleted: trunk/rts/Lua/LuaCob.cpp
===================================================================
--- trunk/rts/Lua/LuaCob.cpp	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/Lua/LuaCob.cpp	2008-01-16 16:57:46 UTC (rev 5333)
@@ -1,221 +0,0 @@
-#include &quot;StdAfx.h&quot;
-// LuaCob.cpp: implementation of the CLuaCob class.
-//
-//////////////////////////////////////////////////////////////////////
-
-#include &quot;LuaCob.h&quot;
-#include &lt;set&gt;
-#include &lt;cctype&gt;
-
-#include &quot;LuaInclude.h&quot;
-
-#include &quot;LuaUtils.h&quot;
-#include &quot;LuaSyncedCtrl.h&quot;
-#include &quot;LuaSyncedRead.h&quot;
-#include &quot;LuaUnitDefs.h&quot;
-#include &quot;LuaWeaponDefs.h&quot;
-#include &quot;LuaOpenGL.h&quot;
-
-#include &quot;Sim/Units/CommandAI/Command.h&quot;
-#include &quot;Rendering/GL/myGL.h&quot;
-#include &quot;Rendering/UnitModels/UnitDrawer.h&quot;
-#include &quot;Sim/Units/Unit.h&quot;
-#include &quot;Sim/Units/UnitDef.h&quot;
-#include &quot;Sim/Units/COB/CobInstance.h&quot;
-#include &quot;System/LogOutput.h&quot;
-#include &quot;System/FileSystem/FileHandler.h&quot;
-#include &quot;System/Platform/FileSystem.h&quot;
-
-
-CLuaCob* luaCob = NULL;
-
-static const char* LuaCobSyncedFilename   = &quot;LuaCob/main.lua&quot;;
-static const char* LuaCobUnsyncedFilename = &quot;LuaCob/draw.lua&quot;;
-
-const int* CLuaCob::currentArgs = NULL;
-
-
-/******************************************************************************/
-/******************************************************************************/
-
-void CLuaCob::LoadHandler()
-{
-	if (luaCob) {
-		return;
-	}
-
-	SAFE_NEW CLuaCob();
-
-	if (luaCob-&gt;L == NULL) {
-		delete luaCob;
-	}
-}
-
-
-void CLuaCob::FreeHandler()
-{
-	delete luaCob;
-}
-
-
-/******************************************************************************/
-/******************************************************************************/
-
-CLuaCob::CLuaCob()
-: CLuaHandleSynced(&quot;LuaCob&quot;, LUA_HANDLE_ORDER_COB, CobCallback, &quot;.luacob &quot;)
-{
-	luaCob = this;
-
-	if (L == NULL) {
-		return;
-	}
-
-	fullCtrl = true;
-	fullRead = true;
-	ctrlTeam = AllAccessTeam;
-	readTeam = AllAccessTeam;
-	readAllyTeam = AllAccessTeam;
-	selectTeam = AllAccessTeam;
-
-	Init(LuaCobSyncedFilename, LuaCobUnsyncedFilename, SPRING_VFS_MOD);
-}
-
-
-CLuaCob::~CLuaCob()
-{
-	if (L != NULL) {
-		Shutdown();
-		KillLua();
-	}
-	luaCob = NULL;
-}
-
-
-bool CLuaCob::AddSyncedCode()
-{
-	lua_getglobal(L, &quot;Spring&quot;);
-	LuaPushNamedCFunc(L, &quot;UnpackCobArg&quot;, UnpackCobArg);
-	lua_pop(L, 1);
-	return true;
-}
-
-
-/******************************************************************************/
-
-int CLuaCob::UnpackCobArg(lua_State* L)
-{
-	if (currentArgs == NULL) {
-		luaL_error(L, &quot;Error in UnpackCobArg(), no current args&quot;);
-	}
-	const int arg = (int)luaL_checknumber(L, 1) - 1;
-	if ((arg &lt; 0) || (arg &gt;= MAX_LUA_COB_ARGS)) {
-		luaL_error(L, &quot;Error in UnpackCobArg(), bad index&quot;);
-	}
-	const int value = currentArgs[arg];
-	lua_pushnumber(L, UNPACKX(value));
-	lua_pushnumber(L, UNPACKZ(value));
-	return 2;
-}
-
-
-void CLuaCob::CobCallback(int retCode, void* p1, void* p2)
-{
-	if (luaCob) {
-		CobCallbackData cbd(retCode, *((int*)&amp;p1), *((float*)&amp;p2));
-		luaCob-&gt;cobCallbackEntries.push_back(cbd);
-	}
-}
-
-
-/******************************************************************************/
-/******************************************************************************/
-//
-// LuaCob Call-Ins
-//
-
-void CLuaCob::CallFunction(const LuaHashString&amp; name, const CUnit* unit,
-                           int&amp; argsCount, int args[MAX_LUA_COB_ARGS])
-{
-	static int callDepth = 0;
-	if (callDepth &gt;= 16) {
-		logOutput.Print(&quot;CLuaCob::CallFunction() call overflow: %s\n&quot;,
-		                name.GetString().c_str());
-		args[0] = 0; // failure
-		return;
-	}
-
-	if (!lua_checkstack(L, argsCount + 4)) {
-		logOutput.Print(&quot;CLuaCob::CallFunction() lua_checkstack() error: %s\n&quot;,
-		                name.GetString().c_str());
-		args[0] = 0; // failure
-		return;
-	}
-
-	const int top = lua_gettop(L);
-
-	if (!name.GetGlobalFunc(L)) {
-		logOutput.Print(&quot;CLuaCob::CallFunction() missing function: %s\n&quot;,
-		                name.GetString().c_str());
-		args[0] = 0; // failure
-		lua_settop(L, top);
-		return;
-	}
-
-	lua_pushnumber(L, unit-&gt;id);
-	lua_pushnumber(L, unit-&gt;unitDef-&gt;id);
-	lua_pushnumber(L, unit-&gt;team);
-	for (int a = 0; a &lt; argsCount; a++) {
-		lua_pushnumber(L, args[a]);
-	}
-
-	// call the routine
-	callDepth++;
-	const int* oldArgs = currentArgs;
-	currentArgs = args;
-
-	const bool error = !RunCallIn(name, 3 + argsCount, LUA_MULTRET);
-
-	currentArgs = oldArgs;
-	callDepth--;
-
-	// bail on error
-	if (error) {
-		args[0] = 0; // failure
-		lua_settop(L, top);
-		return;
-	}
-
-	// get the results
-	const int retArgs = min(lua_gettop(L), (MAX_LUA_COB_ARGS - 1));
-	for (int a = 1; a &lt;= retArgs; a++) {
-		if (lua_isnumber(L, a)) {
-			args[a] = (int)lua_tonumber(L, a);
-		}
-		else if (lua_isboolean(L, a)) {
-			args[a] = lua_toboolean(L, a) ? 1 : 0;
-		}
-		else if (lua_istable(L, a)) {
-			lua_rawgeti(L, a, 1);
-			lua_rawgeti(L, a, 2);
-			if (lua_isnumber(L, -2) &amp;&amp; lua_isnumber(L, -1)) {
-				const int x = (int)lua_tonumber(L, -2);
-				const int z = (int)lua_tonumber(L, -1);
-				args[a] = PACKXZ(x, z);
-			} else {
-				args[a] = 0;
-			}
-			lua_pop(L, 2);
-		}
-		else {
-			args[a] = 0;
-		}
-	}
-
-	args[0] = 1; // success
-	lua_settop(L, top);
-	return;
-}
-
-
-/******************************************************************************/
-/******************************************************************************/

Deleted: trunk/rts/Lua/LuaCob.h
===================================================================
--- trunk/rts/Lua/LuaCob.h	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/Lua/LuaCob.h	2008-01-16 16:57:46 UTC (rev 5333)
@@ -1,52 +0,0 @@
-#ifndef LUA_COB_H
-#define LUA_COB_H
-// LuaCob.h: interface for the CLuaCob class.
-//
-//////////////////////////////////////////////////////////////////////
-
-#include &lt;string&gt;
-#include &lt;vector&gt;
-using std::string;
-using std::vector;
-
-#include &quot;LuaHandleSynced.h&quot;
-
-
-class CUnit;
-struct lua_State;
-struct LuaHashString;
-
-
-#define MAX_LUA_COB_ARGS 10
-
-
-class CLuaCob : public CLuaHandleSynced
-{
-	public:
-		static void LoadHandler();
-		static void FreeHandler();
-
-		void CallFunction(const LuaHashString&amp; funcName, const CUnit* unit,
-		                  int&amp; argsCount, int args[MAX_LUA_COB_ARGS]);
-
-	protected:
-		bool AddSyncedCode();
-		bool AddUnsyncedCode() { return true; }
-
-	private:
-		CLuaCob();
-		~CLuaCob();
-
-	private:
-		static const int* currentArgs;
-
-	private:
-		static int UnpackCobArg(lua_State* L);
-		static void CobCallback(int retCode, void* p1, void* p2);
-};
-
-
-extern CLuaCob* luaCob;
-
-
-#endif /* LUA_COB_H */

Modified: trunk/rts/Lua/LuaFBOs.cpp
===================================================================
--- trunk/rts/Lua/LuaFBOs.cpp	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/Lua/LuaFBOs.cpp	2008-01-16 16:57:46 UTC (rev 5333)
@@ -336,19 +336,14 @@
 		const int table = (index &gt; 0) ? index : (lua_gettop(L) + index + 1);
 		int i = 1;
 		for (lua_rawgeti(L, table, i);
-				 lua_isnumber(L, -1);
+				 lua_israwnumber(L, -1);
 				 lua_pop(L, 1), i++, lua_rawgeti(L, table, i)) {
 			const GLenum buffer = (GLenum)lua_tonumber(L, -1);
 			buffers.push_back(buffer);
 		}
 		lua_pop(L, 1);
 
-		GLenum* bufs = SAFE_NEW GLenum[buffers.size()];
-		for (int b = 0; b &lt; buffers.size(); b++) {
-			bufs[b] = buffers[b];
-		}
-		glDrawBuffersARB(buffers.size(), bufs);
-		delete[] bufs;
+		glDrawBuffersARB(buffers.size(), buffers.data());
 
 		return true;
 	}

Modified: trunk/rts/Lua/LuaHandle.cpp
===================================================================
--- trunk/rts/Lua/LuaHandle.cpp	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/Lua/LuaHandle.cpp	2008-01-16 16:57:46 UTC (rev 5333)
@@ -7,7 +7,6 @@
 #include &lt;string&gt;
 
 #include &quot;Game/UI/LuaUI.h&quot;
-#include &quot;Lua/LuaCob.h&quot;
 #include &quot;Lua/LuaGaia.h&quot;
 #include &quot;Lua/LuaRules.h&quot;
 
@@ -744,11 +743,6 @@
 			}
 		}
 	}
-	else if (script == LUA_HANDLE_ORDER_COB) {
-		if (luaCob) {
-			luaCob-&gt;RecvLuaMsg(msg, playerID);
-		}
-	}
 	else if (script == LUA_HANDLE_ORDER_GAIA) {
 		if (luaGaia) {
 			luaGaia-&gt;RecvLuaMsg(msg, playerID);
@@ -1028,6 +1022,7 @@
 		// special team constants
 		HSTR_PUSH_NUMBER(L, &quot;NO_ACCESS_TEAM&quot;,  NoAccessTeam);
 		HSTR_PUSH_NUMBER(L, &quot;ALL_ACCESS_TEAM&quot;, AllAccessTeam);
+//FIXME		LuaArrays::PushEntries(L);
 	}
 	lua_rawset(L, -3);
 

Modified: trunk/rts/Lua/LuaHandle.h
===================================================================
--- trunk/rts/Lua/LuaHandle.h	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/Lua/LuaHandle.h	2008-01-16 16:57:46 UTC (rev 5333)
@@ -11,18 +11,18 @@
 using std::vector;
 using std::set;
 
+//FIXME#include &quot;LuaArrays.h&quot;
 #include &quot;LuaShaders.h&quot;
 #include &quot;LuaTextures.h&quot;
-//FIXME-BO: #include &quot;LuaVBOs.h&quot;
 #include &quot;LuaFBOs.h&quot;
 #include &quot;LuaRBOs.h&quot;
+//FIXME#include &quot;LuaVBOs.h&quot;
 #include &quot;LuaDisplayLists.h&quot;
 
 
 #define LUA_HANDLE_ORDER_RULES 0
-#define LUA_HANDLE_ORDER_COB   1
-#define LUA_HANDLE_ORDER_GAIA  2
-#define LUA_HANDLE_ORDER_UI    3
+#define LUA_HANDLE_ORDER_GAIA  1
+#define LUA_HANDLE_ORDER_UI    2
 
 
 class CUnit;
@@ -78,9 +78,10 @@
 
 		const LuaCobCallback  GetCallback() { return cobCallback; }
 
+//FIXME		LuaArrays&amp; GetArrays() { return arrays; }
 		LuaShaders&amp; GetShaders() { return shaders; }
 		LuaTextures&amp; GetTextures() { return textures; }
-//FIXME-BO: 		LuaVBOs&amp; GetVBOs() { return vbos; }
+//FIXME		LuaVBOs&amp; GetVBOs() { return vbos; }
 		LuaFBOs&amp; GetFBOs() { return fbos; }
 		LuaRBOs&amp; GetRBOs() { return rbos; }
 		CLuaDisplayLists&amp; GetDisplayLists() { return displayLists; }
@@ -197,9 +198,10 @@
 
 		LuaCobCallback cobCallback;
 
+//FIXME		LuaArrays arrays;
 		LuaShaders shaders;
 		LuaTextures textures;
-//FIXME-BO: 		LuaVBOs vbos;
+//FIXME		LuaVBOs vbos;
 		LuaFBOs fbos;
 		LuaRBOs rbos;
 		CLuaDisplayLists displayLists;
@@ -247,9 +249,10 @@
 		static const LuaCobCallback GetActiveCallback() {
 			return activeHandle-&gt;cobCallback;
 		}
+//FIXME		static LuaArrays&amp;   GetActiveArrays()   { return activeHandle-&gt;arrays; }
 		static LuaShaders&amp;  GetActiveShaders()  { return activeHandle-&gt;shaders; }
 		static LuaTextures&amp; GetActiveTextures() { return activeHandle-&gt;textures; }
-//FIXME-BO: 		static LuaVBOs&amp;     GetActiveVBOs()     { return activeHandle-&gt;vbos; }
+//FIXME		static LuaVBOs&amp;     GetActiveVBOs()     { return activeHandle-&gt;vbos; }
 		static LuaFBOs&amp;     GetActiveFBOs()     { return activeHandle-&gt;fbos; }
 		static LuaRBOs&amp;     GetActiveRBOs()     { return activeHandle-&gt;rbos; }
 		static CLuaDisplayLists&amp; GetActiveDisplayLists() {

Modified: trunk/rts/Lua/LuaHandleSynced.cpp
===================================================================
--- trunk/rts/Lua/LuaHandleSynced.cpp	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/Lua/LuaHandleSynced.cpp	2008-01-16 16:57:46 UTC (rev 5333)
@@ -410,7 +410,7 @@
 	unsyncedStr.GetRegistry(L);
 	if (!lua_istable(L, -1)) {
 		lua_settop(L, 0);
-		logOutput.Print(&quot;ERROR: missing UNSYNCED table for %s&quot;, name.c_str());
+//FIXME		logOutput.Print(&quot;ERROR: missing UNSYNCED table for %s&quot;, name.c_str());
 		return false;
 	}
 	const int unsynced = lua_gettop(L);

Modified: trunk/rts/Lua/LuaOpenGL.cpp
===================================================================
--- trunk/rts/Lua/LuaOpenGL.cpp	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/Lua/LuaOpenGL.cpp	2008-01-16 16:57:46 UTC (rev 5333)
@@ -25,7 +25,7 @@
 #include &quot;LuaHashString.h&quot;
 #include &quot;LuaShaders.h&quot;
 #include &quot;LuaTextures.h&quot;
-//FIXME-BO: #include &quot;LuaVBOs.h&quot;
+//FIXME#include &quot;LuaVBOs.h&quot;
 #include &quot;LuaFBOs.h&quot;
 #include &quot;LuaRBOs.h&quot;
 #include &quot;LuaDisplayLists.h&quot;
@@ -276,7 +276,7 @@
 	 	LuaRBOs::PushEntries(L);
 	}
 
-//FIXME-BO: 	LuaVBOs::PushEntries(L);
+//FIXME		LuaVBOs::PushEntries(L);
 
 	return true;
 }
@@ -2401,7 +2401,7 @@
 	for (lua_pushnil(L); lua_next(L, table) != 0; lua_pop(L, 1)) {
 		if (!lua_israwstring(L, -2)) { // the key
 			logOutput.Print(&quot;gl.Material: bad state type\n&quot;);
-			break;
+			return 0;;
 		}
 		const string key = lua_tostring(L, -2);
 

Modified: trunk/rts/Lua/LuaPathFinder.h
===================================================================
--- trunk/rts/Lua/LuaPathFinder.h	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/Lua/LuaPathFinder.h	2008-01-16 16:57:46 UTC (rev 5333)
@@ -4,10 +4,6 @@
 //
 //////////////////////////////////////////////////////////////////////
 
-#ifdef _MSC_VER
-#pragma warning(disable:4786)
-#endif
-
 #include &lt;vector&gt;
 
 

Modified: trunk/rts/Lua/LuaRules.cpp
===================================================================
--- trunk/rts/Lua/LuaRules.cpp	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/Lua/LuaRules.cpp	2008-01-16 16:57:46 UTC (rev 5333)
@@ -31,6 +31,7 @@
 #include &quot;Sim/Units/Unit.h&quot;
 #include &quot;Sim/Units/UnitDef.h&quot;
 #include &quot;Sim/Units/UnitHandler.h&quot;
+#include &quot;Sim/Units/COB/CobInstance.h&quot;
 #include &quot;System/LogOutput.h&quot;
 #include &quot;System/FileSystem/FileHandler.h&quot;
 #include &quot;System/Platform/FileSystem.h&quot;
@@ -43,6 +44,8 @@
 static const char* LuaRulesSyncedFilename   = &quot;LuaRules/main.lua&quot;;
 static const char* LuaRulesUnsyncedFilename = &quot;LuaRules/draw.lua&quot;;
 
+const int* CLuaRules::currentCobArgs = NULL;
+
 vector&lt;float&gt;    CLuaRules::gameParams;
 map&lt;string, int&gt; CLuaRules::gameParamsMap;
 
@@ -105,19 +108,19 @@
 		return;
 	}
 
-	haveCommandFallback        = HasCallIn(&quot;CommandFallback&quot;);
-	haveBuilderTerraformComplete=HasCallIn(&quot;BuilderTerraformComplete&quot;);
-	haveAllowCommand           = HasCallIn(&quot;AllowCommand&quot;);
-	haveAllowUnitCreation      = HasCallIn(&quot;AllowUnitCreation&quot;);
-	haveAllowUnitTransfer      = HasCallIn(&quot;AllowUnitTransfer&quot;);
-	haveAllowUnitBuildStep     = HasCallIn(&quot;AllowUnitBuildStep&quot;);
-	haveAllowFeatureCreation   = HasCallIn(&quot;AllowFeatureCreation&quot;);
-	haveAllowFeatureBuildStep  = HasCallIn(&quot;AllowFeatureBuildStep&quot;);
-	haveAllowResourceLevel     = HasCallIn(&quot;AllowResourceLevel&quot;);
-	haveAllowResourceTransfer  = HasCallIn(&quot;AllowResourceTransfer&quot;);
-	haveAllowDirectUnitControl = HasCallIn(&quot;AllowDirectUnitControl&quot;);
-	haveDrawUnit               = HasCallIn(&quot;DrawUnit&quot;);
-	haveAICallIn               = HasCallIn(&quot;AICallIn&quot;);
+	haveCommandFallback          = HasCallIn(&quot;CommandFallback&quot;);
+	haveBuilderTerraformComplete = HasCallIn(&quot;BuilderTerraformComplete&quot;);
+	haveAllowCommand             = HasCallIn(&quot;AllowCommand&quot;);
+	haveAllowUnitCreation        = HasCallIn(&quot;AllowUnitCreation&quot;);
+	haveAllowUnitTransfer        = HasCallIn(&quot;AllowUnitTransfer&quot;);
+	haveAllowUnitBuildStep       = HasCallIn(&quot;AllowUnitBuildStep&quot;);
+	haveAllowFeatureCreation     = HasCallIn(&quot;AllowFeatureCreation&quot;);
+	haveAllowFeatureBuildStep    = HasCallIn(&quot;AllowFeatureBuildStep&quot;);
+	haveAllowResourceLevel       = HasCallIn(&quot;AllowResourceLevel&quot;);
+	haveAllowResourceTransfer    = HasCallIn(&quot;AllowResourceTransfer&quot;);
+	haveAllowDirectUnitControl   = HasCallIn(&quot;AllowDirectUnitControl&quot;);
+	haveDrawUnit                 = HasCallIn(&quot;DrawUnit&quot;);
+	haveAICallIn                 = HasCallIn(&quot;AICallIn&quot;);
 
 	SetupUnsyncedFunction(&quot;DrawUnit&quot;);
 	SetupUnsyncedFunction(&quot;AICallIn&quot;);
@@ -395,7 +398,7 @@
 	HSTR_PUSH_BOOL(L, &quot;shift&quot;, !!(cmd.options &amp; SHIFT_KEY));
 	HSTR_PUSH_BOOL(L, &quot;right&quot;, !!(cmd.options &amp; RIGHT_MOUSE_KEY));
 
-   	lua_pushboolean(L, fromSynced);
+	lua_pushboolean(L, fromSynced);
 
 	// call the function
 	if (!RunCallIn(cmdStr, 7, 1)) {
@@ -798,6 +801,109 @@
 
 /******************************************************************************/
 /******************************************************************************/
+
+int CLuaRules::UnpackCobArg(lua_State* L)
+{
+	if (currentCobArgs == NULL) {
+		luaL_error(L, &quot;Error in UnpackCobArg(), no current args&quot;);
+	}
+	const int arg = (int)luaL_checknumber(L, 1) - 1;
+	if ((arg &lt; 0) || (arg &gt;= MAX_LUA_COB_ARGS)) {
+		luaL_error(L, &quot;Error in UnpackCobArg(), bad index&quot;);
+	}
+	const int value = currentCobArgs[arg];
+	lua_pushnumber(L, UNPACKX(value));
+	lua_pushnumber(L, UNPACKZ(value));
+	return 2;
+}
+
+
+void CLuaRules::Cob2Lua(const LuaHashString&amp; name, const CUnit* unit,
+                        int&amp; argsCount, int args[MAX_LUA_COB_ARGS])
+{
+	static int callDepth = 0;
+	if (callDepth &gt;= 16) {
+		logOutput.Print(&quot;CLuaRules::Cob2Lua() call overflow: %s\n&quot;,
+		                name.GetString().c_str());
+		args[0] = 0; // failure
+		return;
+	}
+
+	const int top = lua_gettop(L);
+
+	if (!lua_checkstack(L, top + argsCount + 4)) {
+		logOutput.Print(&quot;CLuaRules::Cob2Lua() lua_checkstack() error: %s\n&quot;,
+		                name.GetString().c_str());
+		args[0] = 0; // failure
+		return;
+	}
+
+	if (!name.GetGlobalFunc(L)) {
+		logOutput.Print(&quot;CLuaRules::Cob2Lua() missing function: %s\n&quot;,
+		                name.GetString().c_str());
+		args[0] = 0; // failure
+		lua_settop(L, top);
+		return;
+	}
+
+	lua_pushnumber(L, unit-&gt;id);
+	lua_pushnumber(L, unit-&gt;unitDef-&gt;id);
+	lua_pushnumber(L, unit-&gt;team);
+	for (int a = 0; a &lt; argsCount; a++) {
+		lua_pushnumber(L, args[a]);
+	}
+
+	// call the routine
+	callDepth++;
+	const int* oldArgs = currentCobArgs;
+	currentCobArgs = args;
+
+	const bool error = !RunCallIn(name, 3 + argsCount, LUA_MULTRET);
+
+	currentCobArgs = oldArgs;
+	callDepth--;
+
+	// bail on error
+	if (error) {
+		args[0] = 0; // failure
+		lua_settop(L, top);
+		return;
+	}
+
+	// get the results
+	const int retArgs = min(lua_gettop(L) - top, (MAX_LUA_COB_ARGS - 1));
+	for (int a = 1; a &lt;= retArgs; a++) {
+		if (lua_isnumber(L, a)) {
+			args[a] = (int)lua_tonumber(L, a);
+		}
+		else if (lua_isboolean(L, a)) {
+			args[a] = lua_toboolean(L, a) ? 1 : 0;
+		}
+		else if (lua_istable(L, a)) {
+			lua_rawgeti(L, a, 1);
+			lua_rawgeti(L, a, 2);
+			if (lua_isnumber(L, -2) &amp;&amp; lua_isnumber(L, -1)) {
+				const int x = (int)lua_tonumber(L, -2);
+				const int z = (int)lua_tonumber(L, -1);
+				args[a] = PACKXZ(x, z);
+			} else {
+				args[a] = 0;
+			}
+			lua_pop(L, 2);
+		}
+		else {
+			args[a] = 0;
+		}
+	}
+
+	args[0] = 1; // success
+	lua_settop(L, top);
+	return;
+}
+
+
+/******************************************************************************/
+/******************************************************************************/
 //
 // LuaRules Call-Outs
 //

Modified: trunk/rts/Lua/LuaRules.h
===================================================================
--- trunk/rts/Lua/LuaRules.h	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/Lua/LuaRules.h	2008-01-16 16:57:46 UTC (rev 5333)
@@ -14,6 +14,9 @@
 #include &quot;LuaHandleSynced.h&quot;
 
 
+#define MAX_LUA_COB_ARGS 10
+
+
 class CUnit;
 class CFeature;
 struct UnitDef;
@@ -56,6 +59,9 @@
 		                           const string&amp; type, float amount);
 		bool AllowDirectUnitControl(int playerID, const CUnit* unit);
 
+		void Cob2Lua(const LuaHashString&amp; funcName, const CUnit* unit,
+		             int&amp; argsCount, int args[MAX_LUA_COB_ARGS]);
+
 		// unsynced
 		bool DrawUnit(int unitID);
 		const char* AICallIn(const char* data, int inSize, int* outSize);
@@ -68,6 +74,8 @@
 		bool AddSyncedCode();
 		bool AddUnsyncedCode();
 
+		int UnpackCobArg(lua_State* L);
+
 		static void SetRulesParam(lua_State* L, const char* caller, int offset,
 		                          vector&lt;float&gt;&amp; params,
 		                          map&lt;string, int&gt;&amp; paramsMap);
@@ -115,6 +123,7 @@
 		static string configString;
 		static vector&lt;float&gt;    gameParams;
 		static map&lt;string, int&gt; gameParamsMap;
+		static const int* currentCobArgs;
 };
 
 

Modified: trunk/rts/Lua/LuaSyncedCall.cpp
===================================================================
--- trunk/rts/Lua/LuaSyncedCall.cpp	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/Lua/LuaSyncedCall.cpp	2008-01-16 16:57:46 UTC (rev 5333)
@@ -13,7 +13,6 @@
 
 #include &quot;LuaHandle.h&quot;
 #include &quot;Game/UI/LuaUI.h&quot;
-#include &quot;LuaCob.h&quot;
 #include &quot;LuaGaia.h&quot;
 #include &quot;LuaRules.h&quot;
 #include &quot;LuaHashString.h&quot;
@@ -107,7 +106,6 @@
 
 bool LuaSyncedCall::PushEntries(lua_State* L)
 {
-	PushCallHandler(L, (CLuaHandle**) &amp;luaCob,   &quot;LuaCob&quot;);
 	PushCallHandler(L, (CLuaHandle**) &amp;luaGaia,  &quot;LuaGaia&quot;);
 	PushCallHandler(L, (CLuaHandle**) &amp;luaRules, &quot;LuaRules&quot;);
 	return true;

Modified: trunk/rts/Lua/LuaSyncedCtrl.cpp
===================================================================
--- trunk/rts/Lua/LuaSyncedCtrl.cpp	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/Lua/LuaSyncedCtrl.cpp	2008-01-16 16:57:46 UTC (rev 5333)
@@ -10,7 +10,7 @@
 
 #include &quot;LuaInclude.h&quot;
 
-#include &quot;LuaCob.h&quot; // for MAX_LUA_COB_ARGS
+#include &quot;LuaRules.h&quot; // for MAX_LUA_COB_ARGS
 #include &quot;LuaHandleSynced.h&quot;
 #include &quot;LuaHashString.h&quot;
 #include &quot;LuaSyncedMoveCtrl.h&quot;
@@ -1152,37 +1152,42 @@
 	if (unit == NULL) {
 		return 0;
 	}
-	int weapon = (int)luaL_checknumber(L,2);
-	if (weapon &lt; 0 || weapon &gt;= unit-&gt;weapons.size()) {
+
+	const int weaponNum = (int)luaL_checknumber(L,2);
+	if ((weaponNum &lt; 0) || (weaponNum &gt;= unit-&gt;weapons.size())) {
 		return 0;
 	}
+	CWeapon* weapon = unit-&gt;weapons[weaponNum];
+
 	if (lua_istable(L,3)) {
 		const int table = 3;
 		for (lua_pushnil(L); lua_next(L, table) != 0; lua_pop(L, 1)) {
 			if (lua_israwstring(L, -2) &amp;&amp; lua_isnumber(L, -1)) {
 				const string key = lua_tostring(L, -2);
 				const float value = (float)lua_tonumber(L, -1);
+				// FIXME: KDR -- missing checks and updates?
 				if (key == &quot;reloadstate&quot;) {
-					unit-&gt;weapons[weapon]-&gt;reloadStatus = (int)value;
+					weapon-&gt;reloadStatus = (int)value;
 				}
 				else if (key == &quot;reloadtime&quot;) {
-					unit-&gt;weapons[weapon]-&gt;reloadTime = (int)(value*GAME_SPEED);
+					weapon-&gt;reloadTime = (int)(value * GAME_SPEED);
 				}
 				else if (key == &quot;accuracy&quot;) {
-					unit-&gt;weapons[weapon]-&gt;accuracy = value;
+					weapon-&gt;accuracy = value;
 				}
 				else if (key == &quot;sprayangle&quot;) {
-					unit-&gt;weapons[weapon]-&gt;sprayangle = value;
+					weapon-&gt;sprayangle = value;
 				}
 				else if (key == &quot;range&quot;) {
-					unit-&gt;weapons[weapon]-&gt;range = value;
+					weapon-&gt;range = value;
 				}
 				else if (key == &quot;projectilespeed&quot;) {
-					unit-&gt;weapons[weapon]-&gt;projectileSpeed = value;
+					weapon-&gt;projectileSpeed = value;
 				}
 			}
 		}
 	}
+
 	return 0;
 }
 
@@ -1448,27 +1453,17 @@
 	if (unit == NULL) {
 		return 0;
 	}
-	const int args = lua_gettop(L);
-	if (args &gt;= 4) {
-		float radius = 0.0f;
-		float speed = unit-&gt;maxSpeed * 2.0f;
-		const float3 pos((float)luaL_checknumber(L, 2),
-		                 (float)luaL_checknumber(L, 3),
-		                 (float)luaL_checknumber(L, 4));
-		if (args &gt;= 5) {
-			radius = (float)luaL_checknumber(L, 5);
-		}
-		if (args &gt;= 6) {
-			speed = (float)luaL_checknumber(L, 6);
-		}
+	if (unit-&gt;moveType == NULL) {
+		return 0;
+	}
+	const float3 pos((float)luaL_checknumber(L, 2),
+									 (float)luaL_checknumber(L, 3),
+									 (float)luaL_checknumber(L, 4));
+	const float radius = (float)luaL_optnumber(L, 5, 0.0f);
+	const float speed  = (float)luaL_optnumber(L, 6, unit-&gt;maxSpeed * 2.0f);
 
-		if (unit-&gt;moveType == NULL) return 0; //dropped quietly so the user doesn't have to check for buildings
+	unit-&gt;moveType-&gt;StartMoving(pos, radius, speed);
 
-		unit-&gt;moveType-&gt;StartMoving(pos, radius, speed);
-	}
-	else {
-		luaL_error(L, &quot;Too few arguments to SetUnitMoveGoal(unit, posx, posy, posz[, radius[, speed]])&quot;);
-	}
 	return 0;
 }
 

Modified: trunk/rts/Lua/LuaSyncedCtrl.h
===================================================================
--- trunk/rts/Lua/LuaSyncedCtrl.h	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/Lua/LuaSyncedCtrl.h	2008-01-16 16:57:46 UTC (rev 5333)
@@ -93,7 +93,7 @@
 		static int AdjustHeightMap(lua_State* L);
 		static int RevertHeightMap(lua_State* L);
 
-		// LuaCob and LuaRules  (fullCtrl)
+		// LuaRules  (fullCtrl)
 		static int EditUnitCmdDesc(lua_State* L);
 		static int InsertUnitCmdDesc(lua_State* L);
 		static int RemoveUnitCmdDesc(lua_State* L);

Modified: trunk/rts/Lua/LuaSyncedRead.cpp
===================================================================
--- trunk/rts/Lua/LuaSyncedRead.cpp	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/Lua/LuaSyncedRead.cpp	2008-01-16 16:57:46 UTC (rev 5333)
@@ -171,6 +171,7 @@
 	REGISTER_LUA_CFUNC(GetUnitLineage);
 	REGISTER_LUA_CFUNC(GetUnitNeutral);
 	REGISTER_LUA_CFUNC(GetUnitHealth);
+	REGISTER_LUA_CFUNC(GetUnitIsDead);
 	REGISTER_LUA_CFUNC(GetUnitIsStunned);
 	REGISTER_LUA_CFUNC(GetUnitResources);
 	REGISTER_LUA_CFUNC(GetUnitExperience);
@@ -239,6 +240,7 @@
 	REGISTER_LUA_CFUNC(GetPositionLosState);
 	REGISTER_LUA_CFUNC(GetClosestValidPosition);
 
+	REGISTER_LUA_CFUNC(GetUnitPieceMap);
 	REGISTER_LUA_CFUNC(GetUnitPieceList);
 	REGISTER_LUA_CFUNC(GetUnitPieceInfo);
 	REGISTER_LUA_CFUNC(GetUnitPiecePosition);
@@ -2425,6 +2427,17 @@
 }
 
 
+int LuaSyncedRead::GetUnitIsDead(lua_State* L)
+{
+	CUnit* unit = ParseUnit(L, __FUNCTION__, 1);
+	if (unit == NULL) {
+		return 0;
+	}
+	lua_pushboolean(L, unit-&gt;isDead);
+	return 1;
+}
+
+
 int LuaSyncedRead::GetUnitIsStunned(lua_State* L)
 {
 	CUnit* unit = ParseInLosUnit(L, __FUNCTION__, 1);
@@ -3842,20 +3855,20 @@
 	bool radar    = false;
 	if (allyTeamID &gt;= 0) {
 		inLos    = loshandler-&gt;InLos(pos, allyTeamID);
+		radar    = radarhandler-&gt;InRadar(pos, allyTeamID);
 		inAirLos = loshandler-&gt;InAirLos(pos, allyTeamID);
-		radar    = radarhandler-&gt;InRadar(pos, allyTeamID);
 	}
 	else {
 		for (int at = 0; at &lt; gs-&gt;activeAllyTeams; at++) {
 			inLos    = inLos    || loshandler-&gt;InLos(pos, at);
+			radar    = radar    || radarhandler-&gt;InRadar(pos, at);
 			inAirLos = inAirLos || loshandler-&gt;InAirLos(pos, at);
-			radar    = radar    || radarhandler-&gt;InRadar(pos, at);
 		}
 	}
 	lua_pushboolean(L, inLos || radar);
 	lua_pushboolean(L, inLos);
+	lua_pushboolean(L, radar);
 	lua_pushboolean(L, inAirLos);
-	lua_pushboolean(L, radar);
 
 	return 4;
 }
@@ -3877,6 +3890,24 @@
 /******************************************************************************/
 /******************************************************************************/
 
+int LuaSyncedRead::GetUnitPieceMap(lua_State* L)
+{
+	CUnit* unit = ParseUnit(L, __FUNCTION__, 1);
+	if (unit == NULL) {
+		return 0;
+	}
+	const LocalS3DOModel* localModel = unit-&gt;localmodel;
+	lua_newtable(L);
+	for (int i = 0; i &lt; localModel-&gt;numpieces; i++) {
+		const LocalS3DO&amp; lp = localModel-&gt;pieces[i];
+		lua_pushstring(L, lp.name.c_str());
+		lua_pushnumber(L, i + 1);
+		lua_rawset(L, -3);
+	}
+	return 1;
+}
+
+
 int LuaSyncedRead::GetUnitPieceList(lua_State* L)
 {
 	CUnit* unit = ParseUnit(L, __FUNCTION__, 1);

Modified: trunk/rts/Lua/LuaSyncedRead.h
===================================================================
--- trunk/rts/Lua/LuaSyncedRead.h	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/Lua/LuaSyncedRead.h	2008-01-16 16:57:46 UTC (rev 5333)
@@ -88,6 +88,7 @@
 		static int GetUnitLineage(lua_State* L);
 		static int GetUnitNeutral(lua_State* L);
 		static int GetUnitHealth(lua_State* L);
+		static int GetUnitIsDead(lua_State* L);
 		static int GetUnitIsStunned(lua_State* L);
 		static int GetUnitResources(lua_State* L);
 		static int GetUnitExperience(lua_State* L);
@@ -159,6 +160,7 @@
 		static int GetPositionLosState(lua_State* L);
 		static int GetClosestValidPosition(lua_State* L);
 
+		static int GetUnitPieceMap(lua_State* L);
 		static int GetUnitPieceList(lua_State* L);
 		static int GetUnitPieceInfo(lua_State* L);
 		static int GetUnitPiecePosition(lua_State* L);

Modified: trunk/rts/Lua/LuaUnitDefs.cpp
===================================================================
--- trunk/rts/Lua/LuaUnitDefs.cpp	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/Lua/LuaUnitDefs.cpp	2008-01-16 16:57:46 UTC (rev 5333)
@@ -817,8 +817,8 @@
 	ADD_BOOL(&quot;onOffable&quot;,         ud.onoffable);
 	ADD_BOOL(&quot;activateWhenBuilt&quot;, ud.activateWhenBuilt);
 
-	ADD_BOOL(&quot;reclaimable&quot;,           ud.reclaimable);
-	ADD_BOOL(&quot;capturable&quot;,            ud.capturable);
+	ADD_BOOL(&quot;reclaimable&quot;, ud.reclaimable);
+	ADD_BOOL(&quot;capturable&quot;,  ud.capturable);
 
 	ADD_BOOL(&quot;canDGun&quot;,               ud.canDGun);
 	ADD_BOOL(&quot;canCloak&quot;,              ud.canCloak);
@@ -868,8 +868,9 @@
 	ADD_FLOAT(&quot;maxElevator&quot;, ud.maxElevator);
 	ADD_FLOAT(&quot;maxRudder&quot;,   ud.maxRudder);
 
-	ADD_FLOAT(&quot;maxFuel&quot;, ud.maxFuel);
+	ADD_FLOAT(&quot;maxFuel&quot;,    ud.maxFuel);
 	ADD_FLOAT(&quot;refuelTime&quot;, ud.refuelTime);
+
 	ADD_FLOAT(&quot;minAirBasePower&quot;, ud.minAirBasePower);
 
 //	MoveData* movedata;
@@ -902,15 +903,15 @@
 	ADD_BOOL( &quot;decloakSpherical&quot;, ud.decloakSpherical);
 	ADD_BOOL( &quot;decloakOnFire&quot;,    ud.decloakOnFire);
 
-	ADD_BOOL( &quot;canKamikaze&quot;,   ud.canKamikaze);
+	ADD_BOOL( &quot;canKamikaze&quot;,  ud.canKamikaze);
 	ADD_FLOAT(&quot;kamikazeDist&quot;, ud.kamikazeDist);
 
-	ADD_BOOL(&quot;targfac&quot;,        ud.targfac);
+	ADD_BOOL(&quot;targfac&quot;, ud.targfac);
 
-	ADD_BOOL(&quot;needGeo&quot;,        ud.needGeo);
-	ADD_BOOL(&quot;isFeature&quot;,      ud.isFeature);
+	ADD_BOOL(&quot;needGeo&quot;,   ud.needGeo);
+	ADD_BOOL(&quot;isFeature&quot;, ud.isFeature);
 
-	ADD_BOOL(&quot;isCommander&quot;,    ud.isCommander);
+	ADD_BOOL(&quot;isCommander&quot;, ud.isCommander);
 
 	ADD_BOOL(&quot;hideDamage&quot;,     ud.hideDamage);
 	ADD_BOOL(&quot;showPlayerName&quot;, ud.showPlayerName);
@@ -936,6 +937,7 @@
 	ADD_INT(  &quot;flareSalvoDelay&quot;,  ud.flareSalvoDelay);
 
 	ADD_BOOL(&quot;smoothAnim&quot;, ud.smoothAnim);
+
 	ADD_BOOL(&quot;levelGround&quot;, ud.levelGround);
 
 	ADD_BOOL( &quot;useBuildingGroundDecal&quot;,  ud.useBuildingGroundDecal);
@@ -951,8 +953,8 @@
 	ADD_FLOAT(&quot;nanoColorB&quot;,   ud.nanoColor.z);
 
 //	std::vector&lt;CExplosionGenerator*&gt;  sfxExplGens;
-	ADD_STRING(&quot;pieceTrailCEGTag&quot;, ud.pieceTrailCEGTag);
-	ADD_INT(&quot;pieceTrailCEGRange&quot;, ud.pieceTrailCEGRange);
+	ADD_STRING(&quot;pieceTrailCEGTag&quot;,   ud.pieceTrailCEGTag);
+	ADD_INT(   &quot;pieceTrailCEGRange&quot;, ud.pieceTrailCEGRange);
 
 	return true;
 }

Modified: trunk/rts/Lua/LuaUnsyncedCall.cpp
===================================================================
--- trunk/rts/Lua/LuaUnsyncedCall.cpp	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/Lua/LuaUnsyncedCall.cpp	2008-01-16 16:57:46 UTC (rev 5333)
@@ -13,7 +13,6 @@
 
 #include &quot;LuaHandle.h&quot;
 #include &quot;Game/UI/LuaUI.h&quot;
-#include &quot;LuaCob.h&quot;
 #include &quot;LuaGaia.h&quot;
 #include &quot;LuaRules.h&quot;
 #include &quot;LuaHashString.h&quot;
@@ -107,7 +106,6 @@
 
 bool LuaUnsyncedCall::PushEntries(lua_State* L)
 {
-	PushCallHandler(L, (CLuaHandle**) &amp;luaCob,   &quot;LuaCob&quot;);
 	PushCallHandler(L, (CLuaHandle**) &amp;luaGaia,  &quot;LuaGaia&quot;);
 	PushCallHandler(L, (CLuaHandle**) &amp;luaRules, &quot;LuaRules&quot;);
 	PushCallHandler(L, (CLuaHandle**) &amp;luaUI,    &quot;LuaUI&quot;);

Modified: trunk/rts/Sim/Misc/FeatureHandler.cpp
===================================================================
--- trunk/rts/Sim/Misc/FeatureHandler.cpp	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/Sim/Misc/FeatureHandler.cpp	2008-01-16 16:57:46 UTC (rev 5333)
@@ -291,7 +291,7 @@
 			fd-&gt;burnable = 0;
 			fd-&gt;destructable = 0;
 			fd-&gt;reclaimable = false;
-			fd-&gt;geoThermal = 1;
+			fd-&gt;geoThermal = true;
 			fd-&gt;drawType = DRAWTYPE_NONE;	//geos are drawn into the ground texture and emit smoke to be visible
 			fd-&gt;modelType = 0;
 			fd-&gt;energy = 0;

Modified: trunk/rts/Sim/Units/COB/CobThread.cpp
===================================================================
--- trunk/rts/Sim/Units/COB/CobThread.cpp	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/Sim/Units/COB/CobThread.cpp	2008-01-16 16:57:46 UTC (rev 5333)
@@ -4,7 +4,7 @@
 #include &quot;CobFile.h&quot;
 #include &quot;CobInstance.h&quot;
 #include &quot;CobEngine.h&quot;
-#include &quot;Lua/LuaCob.h&quot;
+#include &quot;Lua/LuaRules.h&quot;
 
 #include &quot;LogOutput.h&quot;
 #include &quot;mmgr.h&quot;
@@ -938,7 +938,7 @@
 		stack.resize(size - r2);
 	}
 
-	if (!luaCob) {
+	if (!luaRules) {
 		luaArgs[0] = 0; // failure
 		return;
 	}
@@ -952,12 +952,12 @@
 
 #if COB_DEBUG &gt; 0
 	if (COB_DEBUG_FILTER) {
-		logOutput.Print(&quot;Calling LuaCob %s&quot;, hs.GetString().c_str());
+		logOutput.Print(&quot;Cob2Lua %s&quot;, hs.GetString().c_str());
 	}
 #endif
 
 	int argsCount = argCount;
-	luaCob-&gt;CallFunction(hs, owner-&gt;GetUnit(), argsCount, luaArgs);
+	luaRules-&gt;Cob2Lua(hs, owner-&gt;GetUnit(), argsCount, luaArgs);
 	retCode = luaArgs[0];
 }
 

Modified: trunk/rts/Sim/Units/COB/CobThread.h
===================================================================
--- trunk/rts/Sim/Units/COB/CobThread.h	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/Sim/Units/COB/CobThread.h	2008-01-16 16:57:46 UTC (rev 5333)
@@ -4,7 +4,7 @@
 #include &lt;vector&gt;
 #include &quot;Object.h&quot;
 #include &quot;CobInstance.h&quot;
-#include &quot;Lua/LuaCob.h&quot;
+#include &quot;Lua/LuaRules.h&quot;
 #include &quot;LogOutput.h&quot;
 
 class CCobFile;

Modified: trunk/rts/Sim/Units/CommandAI/AirCAI.cpp
===================================================================
--- trunk/rts/Sim/Units/CommandAI/AirCAI.cpp	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/Sim/Units/CommandAI/AirCAI.cpp	2008-01-16 16:57:46 UTC (rev 5333)
@@ -48,7 +48,6 @@
 	c.type=CMDTYPE_ICON_MAP;
 	c.name=&quot;Move&quot;;
 	c.mouseicon=c.name;
-	c.hotkey=&quot;m&quot;;
 	c.tooltip=&quot;Move: Commands the aircraft to fly to the location&quot;;
 	possibleCommands.push_back(c);
 
@@ -58,7 +57,6 @@
 		c.type=CMDTYPE_ICON_MAP;
 		c.name=&quot;Patrol&quot;;
 		c.mouseicon=c.name;
-		c.hotkey=&quot;p&quot;;
 		c.tooltip=&quot;Patrol: Sets the aircraft to patrol a path to one or more waypoints&quot;;
 		possibleCommands.push_back(c);
 	}
@@ -69,7 +67,6 @@
 		c.type = CMDTYPE_ICON_MAP;
 		c.name = &quot;Fight&quot;;
 		c.mouseicon=c.name;
-		c.hotkey = &quot;f&quot;;
 		c.tooltip = &quot;Fight: Order the aircraft to take action while moving to a position&quot;;
 		possibleCommands.push_back(c);
 	}*/
@@ -80,7 +77,6 @@
 		c.type=CMDTYPE_ICON_AREA;
 		c.name=&quot;Area attack&quot;;
 		c.mouseicon=c.name;
-		c.hotkey=&quot;a&quot;;
 		c.tooltip=&quot;Sets the aircraft to attack enemy units within a circle&quot;;
 		possibleCommands.push_back(c);
 	}/*
@@ -91,7 +87,6 @@
 		c.type=CMDTYPE_ICON_UNIT;
 		c.name=&quot;Guard&quot;;
 		c.mouseicon=c.name;
-		c.hotkey=&quot;g&quot;;
 		c.tooltip=&quot;Guard: Order a unit to guard another unit and attack units attacking it&quot;;
 		possibleCommands.push_back(c);
 	}*/
@@ -108,7 +103,6 @@
 	c.params.push_back(&quot;LandAt 50&quot;);
 	c.params.push_back(&quot;LandAt 80&quot;);
 	c.tooltip=&quot;Repair level: Sets at which health level an aircraft will try to find a repair pad&quot;;
-	c.hotkey=&quot;&quot;;
 	possibleCommands.push_back(c);
 	nonQueingCommands.insert(CMD_AUTOREPAIRLEVEL);
 */
@@ -123,7 +117,6 @@
 		c.params.push_back(&quot;Normal&quot;);
 		c.params.push_back(&quot;Loopback&quot;);
 		c.tooltip=&quot;Loopback attack: Sets if the aircraft should loopback after an attack instead of overflying target&quot;;
-		c.hotkey=&quot;&quot;;
 		possibleCommands.push_back(c);
 		nonQueingCommands.insert(CMD_LOOPBACKATTACK);
 	}

Modified: trunk/rts/Sim/Units/CommandAI/BuilderCAI.cpp
===================================================================
--- trunk/rts/Sim/Units/CommandAI/BuilderCAI.cpp	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/Sim/Units/CommandAI/BuilderCAI.cpp	2008-01-16 16:57:46 UTC (rev 5333)
@@ -83,7 +83,6 @@
 	if(owner-&gt;unitDef-&gt;canRepair){
 		c.id=CMD_REPAIR;
 		c.action=&quot;repair&quot;;
-		c.hotkey=&quot;r&quot;;
 		c.type=CMDTYPE_ICON_UNIT_OR_AREA;
 		c.name=&quot;Repair&quot;;
 		c.mouseicon=c.name;
@@ -92,7 +91,6 @@
 	} else if(owner-&gt;unitDef-&gt;canAssist){
 		c.id=CMD_REPAIR;
 		c.action=&quot;assist&quot;;
-		c.hotkey=&quot;r&quot;;
 		c.type=CMDTYPE_ICON_UNIT_OR_AREA;
 		c.name=&quot;Assist&quot;;
 		c.mouseicon=c.name;
@@ -103,7 +101,6 @@
 	if(owner-&gt;unitDef-&gt;canReclaim){
 		c.id=CMD_RECLAIM;
 		c.action=&quot;reclaim&quot;;
-		c.hotkey=&quot;e&quot;;
 		c.type=CMDTYPE_ICON_UNIT_FEATURE_OR_AREA;
 		c.name=&quot;Reclaim&quot;;
 		c.mouseicon=c.name;
@@ -114,7 +111,6 @@
 	if(owner-&gt;unitDef-&gt;canRestore){
 		c.id=CMD_RESTORE;
 		c.action=&quot;restore&quot;;
-		c.hotkey=&quot;&quot;;
 		c.type=CMDTYPE_ICON_AREA;
 		c.name=&quot;Restore&quot;;
 		c.mouseicon=c.name;
@@ -127,7 +123,6 @@
 	if(owner-&gt;unitDef-&gt;canResurrect){
 		c.id=CMD_RESURRECT;
 		c.action=&quot;resurrect&quot;;
-		c.hotkey=&quot;&quot;;
 		c.type=CMDTYPE_ICON_UNIT_FEATURE_OR_AREA;
 		c.name=&quot;Resurrect&quot;;
 		c.mouseicon=c.name;
@@ -137,7 +132,6 @@
 	if(owner-&gt;unitDef-&gt;canCapture){
 		c.id=CMD_CAPTURE;
 		c.action=&quot;capture&quot;;
-		c.hotkey=&quot;&quot;;
 		c.type=CMDTYPE_ICON_UNIT_OR_AREA;
 		c.name=&quot;Capture&quot;;
 		c.mouseicon=c.name;

Modified: trunk/rts/Sim/Units/CommandAI/Command.cpp
===================================================================
--- trunk/rts/Sim/Units/CommandAI/Command.cpp	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/Sim/Units/CommandAI/Command.cpp	2008-01-16 16:57:46 UTC (rev 5333)
@@ -24,7 +24,6 @@
 				CR_MEMBER(id),
 				CR_MEMBER(type),
 				CR_MEMBER(action),
-				CR_MEMBER(hotkey),
 				CR_MEMBER(name),
 				CR_MEMBER(iconname),
 				CR_MEMBER(mouseicon),

Modified: trunk/rts/Sim/Units/CommandAI/Command.h
===================================================================
--- trunk/rts/Sim/Units/CommandAI/Command.h	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/Sim/Units/CommandAI/Command.h	2008-01-16 16:57:46 UTC (rev 5333)
@@ -124,7 +124,6 @@
 
 	std::string name;       // command name
 	std::string action;     // the associated command action binding name
-	std::string hotkey;     // suggested hotkey  (not currently used?)
 	std::string iconname;   // button texture
 	std::string mouseicon;  // mouse cursor
 	std::string tooltip;    // tooltip text

Modified: trunk/rts/Sim/Units/CommandAI/CommandAI.cpp
===================================================================
--- trunk/rts/Sim/Units/CommandAI/CommandAI.cpp	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/Sim/Units/CommandAI/CommandAI.cpp	2008-01-16 16:57:46 UTC (rev 5333)
@@ -101,7 +101,6 @@
 	c.type=CMDTYPE_ICON;
 	c.name=&quot;Stop&quot;;
 	c.mouseicon=c.name;
-	c.hotkey=&quot;s&quot;;
 	c.tooltip=&quot;Stop: Cancel the units current actions&quot;;
 	possibleCommands.push_back(c);
 
@@ -111,7 +110,6 @@
 		c.type=CMDTYPE_ICON_UNIT_OR_MAP;
 		c.name=&quot;Attack&quot;;
 		c.mouseicon=c.name;
-		c.hotkey=&quot;a&quot;;
 		c.tooltip=&quot;Attack: Attacks an unit or a position on the ground&quot;;
 		possibleCommands.push_back(c);
 	}
@@ -122,7 +120,6 @@
 		c.type=CMDTYPE_ICON_MAP;
 		c.name=&quot;DGun&quot;;
 		c.mouseicon=c.name;
-		c.hotkey=&quot;d&quot;;
 		c.tooltip=&quot;DGun: Attacks using the units special weapon&quot;;
 		possibleCommands.push_back(c);
 	}
@@ -132,7 +129,6 @@
  	c.type=CMDTYPE_ICON;
  	c.name=&quot;Wait&quot;;
  	c.mouseicon=c.name;
- 	c.hotkey=&quot;w&quot;;
  	c.onlyKey=true;
  	c.tooltip=&quot;Wait: Tells the unit to wait until another units handles him&quot;;
  	possibleCommands.push_back(c);
@@ -143,7 +139,6 @@
 	c.type = CMDTYPE_NUMBER;
 	c.name = &quot;TimeWait&quot;;
 	c.mouseicon=c.name;
-	c.hotkey = &quot;&quot;;
 	c.onlyKey = true;
 	c.tooltip = &quot;TimeWait: Wait for a period of time before continuing&quot;;
 	c.params.push_back(&quot;1&quot;);  // min
@@ -157,7 +152,6 @@
 	c.type = CMDTYPE_ICON_UNIT_OR_RECTANGLE;
 	c.name = &quot;DeathWait&quot;;
 	c.mouseicon=c.name;
-	c.hotkey = &quot;&quot;;
 	c.onlyKey = true;
 	c.tooltip = &quot;DeathWait: Wait until units die before continuing&quot;;
 	possibleCommands.push_back(c);
@@ -167,7 +161,6 @@
 	c.type = CMDTYPE_NUMBER;
 	c.name = &quot;SquadWait&quot;;
 	c.mouseicon=c.name;
-	c.hotkey = &quot;&quot;;
 	c.onlyKey = true;
 	c.tooltip = &quot;SquadWait: Wait for a number of units to arrive before continuing&quot;;
 	c.params.push_back(&quot;2&quot;);   // min
@@ -180,7 +173,6 @@
 	c.type = CMDTYPE_ICON;
 	c.name = &quot;GatherWait&quot;;
 	c.mouseicon=c.name;
-	c.hotkey = &quot;&quot;;
 	c.onlyKey = true;
 	c.tooltip = &quot;GatherWait: Wait until all units arrive before continuing&quot;;
 	possibleCommands.push_back(c);
@@ -191,7 +183,6 @@
 		c.type = CMDTYPE_ICON;
 		c.name = &quot;SelfD&quot;;
 		c.mouseicon = c.name;
-		c.hotkey = &quot;Ctrl+d&quot;;
 		c.onlyKey = true;
 		c.tooltip = &quot;SelfD: Tells the unit to self destruct&quot;;
 		possibleCommands.push_back(c);
@@ -199,7 +190,6 @@
 //	nonQueingCommands.insert(CMD_SELFD);
 
 	c.onlyKey=false;
-	c.hotkey=&quot;&quot;;
 
 	if (!owner-&gt;unitDef-&gt;noAutoFire) {
 		if(!owner-&gt;unitDef-&gt;weapons.empty() || owner-&gt;unitDef-&gt;type==&quot;Factory&quot;/* || owner-&gt;unitDef-&gt;canKamikaze*/){
@@ -276,7 +266,6 @@
 		c.type=CMDTYPE_ICON_MODE;
 		c.name=&quot;Active state&quot;;
 		c.mouseicon=c.name;
-		c.hotkey=&quot;x&quot;;
 
 		if (owner-&gt;unitDef-&gt;activateWhenBuilt) {
 			c.params.push_back(&quot;1&quot;);
@@ -290,7 +279,6 @@
 		c.tooltip=&quot;Active State: Sets the active state of the unit to on or off&quot;;
 		possibleCommands.push_back(c);
 		nonQueingCommands.insert(CMD_ONOFF);
-		c.hotkey=&quot;&quot;;
 	}
 
 	if (owner-&gt;unitDef-&gt;canCloak) {
@@ -300,7 +288,6 @@
 		c.type=CMDTYPE_ICON_MODE;
 		c.name=&quot;Cloak state&quot;;
 		c.mouseicon=c.name;
-		c.hotkey=&quot;k&quot;;
 
 		if (owner-&gt;unitDef-&gt;startCloaked) {
 			c.params.push_back(&quot;1&quot;);
@@ -314,7 +301,6 @@
 		c.tooltip=&quot;Cloak State: Sets wheter the unit is cloaked or not&quot;;
 		possibleCommands.push_back(c);
 		nonQueingCommands.insert(CMD_CLOAK);
-		c.hotkey=&quot;&quot;;
 	}
 }
 
@@ -620,9 +606,11 @@
 
 	if (c.id == CMD_PATROL) {
 		CCommandQueue::iterator ci = commandQue.begin();
-		for(; ci != commandQue.end() &amp;&amp; ci-&gt;id!=CMD_PATROL; ci++);
-		if(ci==commandQue.end()){
-			if(commandQue.empty()){
+		for (; ci != commandQue.end() &amp;&amp; ci-&gt;id != CMD_PATROL; ci++) {
+			// just increment
+		}
+		if (ci == commandQue.end()) {
+			if (commandQue.empty()) {
 				Command c2;
 				c2.id = CMD_PATROL;
 				c2.params.push_back(owner-&gt;pos.x);
@@ -630,17 +618,18 @@
 				c2.params.push_back(owner-&gt;pos.z);
 				c2.options = c.options;
 				commandQue.push_back(c2);
-			} else {
+			}
+			else {
 				do {
 					ci--;
-					if(ci-&gt;params.size() &gt;=3){
+					if (ci-&gt;params.size() &gt;= 3) {
 						Command c2;
 						c2.id = CMD_PATROL;
 						c2.params = ci-&gt;params;
 						c2.options = c.options;
 						commandQue.push_back(c2);
 						break;
-					} else if(ci==commandQue.begin()){
+					} else if (ci == commandQue.begin()) {
 						Command c2;
 						c2.id = CMD_PATROL;
 						c2.params.push_back(owner-&gt;pos.x);
@@ -650,7 +639,8 @@
 						commandQue.push_back(c2);
 						break;
 					}
-				} while(ci!=commandQue.begin());
+				}
+				while (ci != commandQue.begin());
 			}
 		}
 	}
@@ -1368,7 +1358,6 @@
 	CommandDescription c;
 	c.id=CMD_STOCKPILE;
 	c.action=&quot;stockpile&quot;;
-	c.hotkey=&quot;&quot;;
 	c.type=CMDTYPE_ICON;
 	c.name=&quot;0/0&quot;;
 	c.tooltip=&quot;Stockpile: Queue up ammunition for later use&quot;;

Modified: trunk/rts/Sim/Units/CommandAI/FactoryCAI.cpp
===================================================================
--- trunk/rts/Sim/Units/CommandAI/FactoryCAI.cpp	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/Sim/Units/CommandAI/FactoryCAI.cpp	2008-01-16 16:57:46 UTC (rev 5333)
@@ -62,7 +62,6 @@
 	c.type=CMDTYPE_ICON_MAP;
 	c.name=&quot;Move&quot;;
 	c.mouseicon=c.name;
-	c.hotkey=&quot;m&quot;;
 	c.tooltip=&quot;Move: Order ready built units to move to a position&quot;;
 	possibleCommands.push_back(c);
 
@@ -72,7 +71,6 @@
 		c.type=CMDTYPE_ICON_MAP;
 		c.name=&quot;Patrol&quot;;
 		c.mouseicon=c.name;
-		c.hotkey=&quot;p&quot;;
 		c.tooltip=&quot;Patrol: Order ready built units to patrol to one or more waypoints&quot;;
 		possibleCommands.push_back(c);
 	}
@@ -83,7 +81,6 @@
 		c.type = CMDTYPE_ICON_MAP;
 		c.name = &quot;Fight&quot;;
 		c.mouseicon=c.name;
-		c.hotkey = &quot;f&quot;;
 		c.tooltip = &quot;Fight: Order ready built units to take action while moving to a position&quot;;
 		possibleCommands.push_back(c);
 	}
@@ -94,7 +91,6 @@
 		c.type=CMDTYPE_ICON_UNIT;
 		c.name=&quot;Guard&quot;;
 		c.mouseicon=c.name;
-		c.hotkey=&quot;g&quot;;
 		c.tooltip=&quot;Guard: Order ready built units to guard another unit and attack units attacking it&quot;;
 		possibleCommands.push_back(c);
 	}

Modified: trunk/rts/Sim/Units/CommandAI/MobileCAI.cpp
===================================================================
--- trunk/rts/Sim/Units/CommandAI/MobileCAI.cpp	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/Sim/Units/CommandAI/MobileCAI.cpp	2008-01-16 16:57:46 UTC (rev 5333)
@@ -98,7 +98,6 @@
 	c.type=CMDTYPE_ICON_UNIT;
 	c.name=&quot;Load units&quot;;
 	c.mouseicon=c.name;
-	c.hotkey=&quot;&quot;;
 	c.tooltip=&quot;Sets the unit to load itself onto a transport&quot;;
 	c.onlyKey = true;
 	possibleCommands.push_back(c);
@@ -110,7 +109,6 @@
 		c.type=CMDTYPE_ICON_FRONT;
 		c.name=&quot;Move&quot;;
 		c.mouseicon=c.name;
-		c.hotkey=&quot;m&quot;;
 		c.tooltip=&quot;Move: Order the unit to move to a position&quot;;
 		c.params.push_back(&quot;1000000&quot;); // max distance
 		possibleCommands.push_back(c);
@@ -123,7 +121,6 @@
 		c.type=CMDTYPE_ICON_MAP;
 		c.name=&quot;Patrol&quot;;
 		c.mouseicon=c.name;
-		c.hotkey=&quot;p&quot;;
 		c.tooltip=&quot;Patrol: Order the unit to patrol to one or more waypoints&quot;;
 		possibleCommands.push_back(c);
 		c.params.clear();
@@ -135,7 +132,6 @@
 		c.type = CMDTYPE_ICON_FRONT;
 		c.name = &quot;Fight&quot;;
 		c.mouseicon=c.name;
-		c.hotkey = &quot;f&quot;;
 		c.tooltip = &quot;Fight: Order the unit to take action while moving to a position&quot;;
 		possibleCommands.push_back(c);
 	}
@@ -146,7 +142,6 @@
 		c.type=CMDTYPE_ICON_UNIT;
 		c.name=&quot;Guard&quot;;
 		c.mouseicon=c.name;
-		c.hotkey=&quot;g&quot;;
 		c.tooltip=&quot;Guard: Order a unit to guard another unit and attack units attacking it&quot;;
 		possibleCommands.push_back(c);
 	}
@@ -165,7 +160,6 @@
 		c.params.push_back(&quot;LandAt 80&quot;);
 		c.tooltip=
 			&quot;Repair level: Sets at which health level an aircraft will try to find a repair pad&quot;;
-		c.hotkey=&quot;&quot;;
 		possibleCommands.push_back(c);
 		nonQueingCommands.insert(CMD_AUTOREPAIRLEVEL);
 
@@ -179,7 +173,6 @@
 		c.params.push_back(&quot; Fly &quot;);
 		c.params.push_back(&quot;Land&quot;);
 		c.tooltip=&quot;Land mode: Sets what aircraft will do on idle&quot;;
-		c.hotkey=&quot;&quot;;
 		possibleCommands.push_back(c);
 		nonQueingCommands.insert(CMD_IDLEMODE);
 	}

Modified: trunk/rts/Sim/Units/CommandAI/TransportCAI.cpp
===================================================================
--- trunk/rts/Sim/Units/CommandAI/TransportCAI.cpp	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/Sim/Units/CommandAI/TransportCAI.cpp	2008-01-16 16:57:46 UTC (rev 5333)
@@ -69,7 +69,6 @@
 	c.type=CMDTYPE_ICON_UNIT_OR_AREA;
 	c.name=&quot;Load units&quot;;
 	c.mouseicon=c.name;
-	c.hotkey=&quot;l&quot;;
 	c.tooltip=&quot;Sets the transport to load a unit or units within an area&quot;;
 	possibleCommands.push_back(c);
 
@@ -78,7 +77,6 @@
 	c.type=CMDTYPE_ICON_AREA;
 	c.name=&quot;Unload units&quot;;
 	c.mouseicon=c.name;
-	c.hotkey=&quot;u&quot;;
 	c.tooltip=&quot;Sets the transport to unload units in an area&quot;;
 	possibleCommands.push_back(c);
 }

Modified: trunk/rts/Sim/Units/Unit.cpp
===================================================================
--- trunk/rts/Sim/Units/Unit.cpp	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/Sim/Units/Unit.cpp	2008-01-16 16:57:46 UTC (rev 5333)
@@ -314,20 +314,21 @@
 	unitDef = def;
 	unitDefName = unitDef-&gt;name;
 
-	localmodel=NULL;
+	localmodel = NULL;
 	SetRadius(1.2f);
-	mapSquare=ground-&gt;GetSquare(pos);
+	mapSquare = ground-&gt;GetSquare(pos);
 	uh-&gt;AddUnit(this);
 	qf-&gt;MovedUnit(this);
-	oldRadarPos.x=-1;
+	oldRadarPos.x = -1;
 
-	for(int a=0;a&lt;MAX_TEAMS;++a)
-		losStatus[a]=0;
+	for (int a = 0; a &lt; MAX_TEAMS; ++a) {
+		losStatus[a] = 0;
+	}
 
-	losStatus[allyteam]=LOS_INTEAM | LOS_INLOS | LOS_INRADAR | LOS_PREVLOS | LOS_CONTRADAR;
+	losStatus[allyteam] = LOS_INTEAM | LOS_INLOS | LOS_INRADAR | LOS_PREVLOS | LOS_CONTRADAR;
 
-	posErrorVector=gs-&gt;randVector();
-	posErrorVector.y*=0.2f;
+	posErrorVector = gs-&gt;randVector();
+	posErrorVector.y *= 0.2f;
 #ifdef TRACE_SYNC
 	tracefile &lt;&lt; &quot;New unit: &quot;;
 	tracefile &lt;&lt; pos.x &lt;&lt; &quot; &quot; &lt;&lt; pos.y &lt;&lt; &quot; &quot; &lt;&lt; pos.z &lt;&lt; &quot; &quot; &lt;&lt; id &lt;&lt; &quot;\n&quot;;
@@ -484,7 +485,59 @@
 }
 
 
+inline void CUnit::UpdateLosStatus(int at)
+{
+	const int prevLosStatus = losStatus[at];
+	if ((prevLosStatus &amp; LOS_INTEAM) != 0) {
+		return; // allied -- no need to update
+	}
 
+	if (loshandler-&gt;InLos(this, at)) {
+		if ((prevLosStatus &amp; LOS_INLOS) == 0) {
+
+			if (beingBuilt) {
+				losStatus[at] |= (LOS_INLOS | LOS_INRADAR);
+			} else {
+				losStatus[at] |= (LOS_INLOS | LOS_INRADAR | LOS_PREVLOS | LOS_CONTRADAR);
+			}
+
+			if ((prevLosStatus &amp; LOS_INRADAR) == 0) {
+				luaCallIns.UnitEnteredRadar(this, at);
+				globalAI-&gt;UnitEnteredRadar(this, at);
+			}
+			luaCallIns.UnitEnteredLos(this, at);
+			globalAI-&gt;UnitEnteredLos(this, at);
+		}
+	}
+	else if (radarhandler-&gt;InRadar(this, at)) {
+		if ((prevLosStatus &amp; LOS_INLOS) != 0) {
+			losStatus[at] &amp;= ~LOS_INLOS;
+			luaCallIns.UnitLeftLos(this, at);
+			globalAI-&gt;UnitLeftLos(this, at);
+		}
+		else if ((prevLosStatus &amp; LOS_INRADAR) == 0) {
+			losStatus[at] |= LOS_INRADAR;
+			luaCallIns.UnitEnteredRadar(this, at);
+			globalAI-&gt;UnitEnteredRadar(this, at);
+		}
+	}
+	else {
+		if ((prevLosStatus &amp; LOS_INRADAR) != 0) {
+			losStatus[at] &amp;= ~(LOS_INLOS | LOS_INRADAR | LOS_CONTRADAR);
+			if ((prevLosStatus &amp; LOS_INLOS) != 0) {
+				luaCallIns.UnitLeftLos(this, at);
+				luaCallIns.UnitLeftRadar(this, at);
+				globalAI-&gt;UnitLeftLos(this, at);
+				globalAI-&gt;UnitLeftRadar(this, at);
+			} else {
+				luaCallIns.UnitLeftRadar(this, at);
+				globalAI-&gt;UnitLeftRadar(this, at);
+			}
+		}
+	}
+}
+
+
 void CUnit::SlowUpdate()
 {
 	--nextPosErrorUpdate;
@@ -498,54 +551,8 @@
 		nextPosErrorUpdate = 16;
 	}
 
-	for (int a = 0; a &lt; gs-&gt;activeAllyTeams; ++a) {
-		const int prevLosStatus = losStatus[a];
-		if (prevLosStatus &amp; LOS_INTEAM) {
-			continue; // allied, no need to update
-		}
-		else if (loshandler-&gt;InLos(this, a)) {
-			if (!(prevLosStatus &amp; LOS_INLOS)) {
-
-				if (beingBuilt) {
-					losStatus[a] |= (LOS_INLOS | LOS_INRADAR);
-				} else {
-					losStatus[a] |= (LOS_INLOS | LOS_INRADAR | LOS_PREVLOS | LOS_CONTRADAR);
-				}
-
-				if (!(prevLosStatus &amp; LOS_INRADAR)) {
-					luaCallIns.UnitEnteredRadar(this, a);
-					globalAI-&gt;UnitEnteredRadar(this, a);
-				}
-				luaCallIns.UnitEnteredLos(this, a);
-				globalAI-&gt;UnitEnteredLos(this, a);
-			}
-		}
-		else if (radarhandler-&gt;InRadar(this, a)) {
-			if ((prevLosStatus &amp; LOS_INLOS)) {
-				luaCallIns.UnitLeftLos(this, a);
-				globalAI-&gt;UnitLeftLos(this, a);
-				losStatus[a] &amp;= ~LOS_INLOS;
-			}
-			else if (!(prevLosStatus &amp; LOS_INRADAR)) {
-				luaCallIns.UnitEnteredRadar(this, a);
-				globalAI-&gt;UnitEnteredRadar(this, a);
-				losStatus[a] |= LOS_INRADAR;
-			}
-		}
-		else {
-			if ((prevLosStatus &amp; LOS_INRADAR)) {
-				if ((prevLosStatus &amp; LOS_INLOS)) {
-					luaCallIns.UnitLeftLos(this, a);
-					luaCallIns.UnitLeftRadar(this, a);
-					globalAI-&gt;UnitLeftLos(this, a);
-					globalAI-&gt;UnitLeftRadar(this, a);
-				} else {
-					luaCallIns.UnitLeftRadar(this, a);
-					globalAI-&gt;UnitLeftRadar(this, a);
-				}
-				losStatus[a] &amp;= ~(LOS_INLOS | LOS_INRADAR | LOS_CONTRADAR);
-			}
-		}
+	for (int at = 0; at &lt; gs-&gt;activeAllyTeams; ++at) {
+		UpdateLosStatus(at);
 	}
 	
 	repairAmount=0.0f;

Modified: trunk/rts/Sim/Units/Unit.h
===================================================================
--- trunk/rts/Sim/Units/Unit.h	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/Sim/Units/Unit.h	2008-01-16 16:57:46 UTC (rev 5333)
@@ -179,7 +179,9 @@
 	float terraformLeft;            //how much terraforming is left to do
 	int realLosRadius;				//set los to this when finished building
 	int realAirLosRadius;
+
 	int losStatus[MAX_TEAMS];	//indicate the los/radar status the allyteam has on this unit
+
 	bool inBuildStance;				//used by constructing unigs
 	bool stunned;							//if we are stunned by a weapon or for other reason
 	bool useHighTrajectory;		//tells weapons that support it to try to use a high trajectory
@@ -375,6 +377,7 @@
 protected:
 	void ChangeTeamReset();
 	void UpdateResources();
+	void UpdateLosStatus(int allyTeam);
 
 public:
 	virtual void KillUnit(bool SelfDestruct,bool reclaimed, CUnit *attacker);

Modified: trunk/rts/System/BaseNetProtocol.cpp
===================================================================
--- trunk/rts/System/BaseNetProtocol.cpp	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/System/BaseNetProtocol.cpp	2008-01-16 16:57:46 UTC (rev 5333)
@@ -5,6 +5,10 @@
 
 CBaseNetProtocol::CBaseNetProtocol()
 {
+  // RegisterMessage() length parameter:
+  //   &gt; 0:  if its fixed length
+  //   &lt; 0:  means the next x bytes represent the length
+
 	RegisterMessage(NETMSG_QUIT, 1);
 	RegisterMessage(NETMSG_NEWFRAME, 5);
 	RegisterMessage(NETMSG_STARTPLAYING, 1);
@@ -29,7 +33,7 @@
 	RegisterMessage(NETMSG_SHARE, 12);
 	RegisterMessage(NETMSG_SETSHARE, 11);
 	RegisterMessage(NETMSG_SENDPLAYERSTAT, 1);
-	RegisterMessage(NETMSG_PLAYERSTAT, 2+sizeof(CPlayer::Statistics));
+	RegisterMessage(NETMSG_PLAYERSTAT, 2 + sizeof(CPlayer::Statistics));
 	RegisterMessage(NETMSG_GAMEOVER, 1);
 	RegisterMessage(NETMSG_MAPDRAW, -1);
 	RegisterMessage(NETMSG_SYNCREQUEST, 5);

Modified: trunk/rts/System/BaseNetProtocol.h
===================================================================
--- trunk/rts/System/BaseNetProtocol.h	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/System/BaseNetProtocol.h	2008-01-16 16:57:46 UTC (rev 5333)
@@ -61,6 +61,7 @@
 	NETMSG_PLAYERINFO       = 38, // uchar myPlayerNum; float cpuUsage; int ping /*in frames*/;
 	NETMSG_PLAYERLEFT       = 39, // uchar myPlayerNum, bIntended /*0: lost connection, 1: left, 2: forced (kicked) */;
 	NETMSG_MODNAME          = 40, // uint checksum; std::string modName;   (e.g. `XTA v8.1')
+
 #ifdef SYNCDEBUG
 	NETMSG_SD_CHKREQUEST    = 41,
 	NETMSG_SD_CHKRESPONSE   = 42,
@@ -68,6 +69,7 @@
 	NETMSG_SD_BLKRESPONSE   = 44,
 	NETMSG_SD_RESET         = 45,
 #endif // SYNCDEBUG
+
 	NETMSG_LUAMSG           = 50, // uchar myPlayerNum, std::string msg
 };
 

Modified: trunk/rts/System/Net/Net.cpp
===================================================================
--- trunk/rts/System/Net/Net.cpp	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/System/Net/Net.cpp	2008-01-16 16:57:46 UTC (rev 5333)
@@ -152,7 +152,7 @@
 {
 #ifdef DEBUG
 	{
-		unsigned msglength = 0;
+		unsigned int msglength = 0;
 		unsigned char msgid = data[0];
 		ProtocolDef* proto = ProtocolDef::instance();
 		if (proto-&gt;HasFixedLength(msgid))
@@ -164,7 +164,7 @@
 			int length_t = proto-&gt;GetLength(msgid);
 			if (length_t == -1)
 			{
-				msglength = (unsigned)data[1];
+				msglength = (unsigned int)data[1];
 			}
 			else if (length_t == -2)
 			{
@@ -174,7 +174,7 @@
 		
 		if (length != msglength || length == 0)
 		{
-			throw network_error( str( boost::format(&quot;Message length error (ID %1% with length %2% should be %3%) while sending (CNet::SendData(char*, unsigned))&quot;) % (unsigned)data[0] % length % msglength ) );
+			throw network_error( str( boost::format(&quot;Message length error (ID %1% with length %2% should be %3%) while sending (CNet::SendData(char*, unsigned))&quot;) % (unsigned int)data[0] % length % msglength ) );
 		}
 	}
 #endif

Modified: trunk/rts/System/Net/ProtocolDef.cpp
===================================================================
--- trunk/rts/System/Net/ProtocolDef.cpp	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/System/Net/ProtocolDef.cpp	2008-01-16 16:57:46 UTC (rev 5333)
@@ -63,7 +63,7 @@
 	{
 		if (HasFixedLength(buf[0]))
 		{
-			if (bufLength &gt;= (unsigned)GetLength(buf[0]))
+			if (bufLength &gt;= (unsigned int)GetLength(buf[0]))
 				return GetLength(buf[0]);
 			else
 				return 0;
@@ -83,10 +83,10 @@
 				if (bufLength &lt;= 2)
 					return 0;
 				
-				var = *(unsigned int*)(buf+1);
+				var = *((unsigned short*)(buf + 1));
 			}
 			
-			if (bufLength &gt;= (unsigned)var)
+			if (bufLength &gt;= (unsigned int)var)
 				return var;
 			else
 				return 0;
@@ -94,4 +94,4 @@
 	}
 }
 
-}
+} // namespace netcode

Modified: trunk/rts/System/TdfParser.cpp
===================================================================
--- trunk/rts/System/TdfParser.cpp	2008-01-15 18:11:25 UTC (rev 5332)
+++ trunk/rts/System/TdfParser.cpp	2008-01-16 16:57:46 UTC (rev 5333)
@@ -138,7 +138,7 @@
       it !=e ; ++it ){
     std::string temp = boost::trim_copy( *it );
     if( ! temp.empty( ) ) {
-      ::logOutput.Print( &quot;Junk in &quot;+ filename +  &quot; :&quot; + temp );
+      ::logOutput.Print( &quot;TdfParser: Junk in &quot;+ filename +  &quot;: &quot; + temp );
     }
   }
 


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000139.html">[Taspring-linux-commit] r5332 - in trunk/rts/lib/lua: . include
</A></li>
	<LI>Next message: <A HREF="000141.html">[Taspring-linux-commit] r5334 - trunk/rts/Lua
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#140">[ date ]</a>
              <a href="thread.html#140">[ thread ]</a>
              <a href="subject.html#140">[ subject ]</a>
              <a href="author.html#140">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
