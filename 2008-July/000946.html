<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r6166 - in trunk: game/LuaUI rts/Game	rts/Lua rts/Rendering rts/Sim/MoveTypes rts/Sim/Units	rts/Sim/Units/UnitTypes rts/System rts/System/Platform
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-July/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6166%20-%20in%20trunk%3A%20game/LuaUI%20rts/Game%0A%09rts/Lua%20rts/Rendering%20rts/Sim/MoveTypes%20rts/Sim/Units%0A%09rts/Sim/Units/UnitTypes%20rts/System%20rts/System/Platform&In-Reply-To=%3C20080713162357.AF68C4951%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000945.html">
   <LINK REL="Next"  HREF="000947.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r6166 - in trunk: game/LuaUI rts/Game	rts/Lua rts/Rendering rts/Sim/MoveTypes rts/Sim/Units	rts/Sim/Units/UnitTypes rts/System rts/System/Platform</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6166%20-%20in%20trunk%3A%20game/LuaUI%20rts/Game%0A%09rts/Lua%20rts/Rendering%20rts/Sim/MoveTypes%20rts/Sim/Units%0A%09rts/Sim/Units/UnitTypes%20rts/System%20rts/System/Platform&In-Reply-To=%3C20080713162357.AF68C4951%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r6166 - in trunk: game/LuaUI rts/Game	rts/Lua rts/Rendering rts/Sim/MoveTypes rts/Sim/Units	rts/Sim/Units/UnitTypes rts/System rts/System/Platform">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Sun Jul 13 18:23:57 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000945.html">[Taspring-linux-commit] r6165 - trunk/rts/Lua
</A></li>
        <LI>Next message: <A HREF="000947.html">[Taspring-linux-commit] r6167 -	trunk/installer/builddata/springcontent/LuaGadgets
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#946">[ date ]</a>
              <a href="thread.html#946">[ thread ]</a>
              <a href="subject.html#946">[ subject ]</a>
              <a href="author.html#946">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: trepan
Date: 2008-07-13 18:23:56 +0200 (Sun, 13 Jul 2008)
New Revision: 6166

Modified:
   trunk/game/LuaUI/widgets.lua
   trunk/rts/Game/Game.cpp
   trunk/rts/Game/Game.h
   trunk/rts/Game/GameServer.cpp
   trunk/rts/Game/Team.cpp
   trunk/rts/Game/Team.h
   trunk/rts/Lua/LuaHandle.cpp
   trunk/rts/Lua/LuaHandle.h
   trunk/rts/Lua/LuaIO.cpp
   trunk/rts/Lua/LuaRules.cpp
   trunk/rts/Lua/LuaRules.h
   trunk/rts/Lua/LuaUnitRendering.cpp
   trunk/rts/Rendering/IconHandler.cpp
   trunk/rts/Sim/MoveTypes/GroundMoveType.cpp
   trunk/rts/Sim/Units/Unit.cpp
   trunk/rts/Sim/Units/UnitDefHandler.cpp
   trunk/rts/Sim/Units/UnitTypes/Builder.cpp
   trunk/rts/System/EventClient.cpp
   trunk/rts/System/EventClient.h
   trunk/rts/System/EventHandler.cpp
   trunk/rts/System/EventHandler.h
   trunk/rts/System/Platform/FileSystem.cpp
   trunk/rts/System/Platform/FileSystem.h
Log:

- added the UnitMoveFailed() call-in

- added the '/movewarnings [0|1]' action, and removed the
  (gs-&gt;frameNum % (GAME_FRAME * 3)) filter (better to not
  have the warnings at all then to have them be that
  inconsistent). The associated config parameter is:
  'MoveWarnings'

- renamed BuilderTerraformComplete() to TerraformComplete()

- added sync protection in EventHandler.cpp



Modified: trunk/game/LuaUI/widgets.lua
===================================================================
--- trunk/game/LuaUI/widgets.lua	2008-07-13 15:39:59 UTC (rev 6165)
+++ trunk/game/LuaUI/widgets.lua	2008-07-13 16:23:56 UTC (rev 6166)
@@ -136,6 +136,7 @@
   'UnitUnloaded',
   'UnitCloaked',
   'UnitDecloaked',
+  'UnitMoveFailed',
   'RecvLuaMsg',
   'StockpileChanged',
   'DrawGenesis',
@@ -1779,6 +1780,14 @@
 end
 
 
+function widgetHandler:UnitMoveFailed(unitID, unitDefID, unitTeam)
+  for _,w in ipairs(self.UnitMoveFailedList) do
+    w:UnitMoveFailed(unitID, unitDefID, unitTeam)
+  end
+  return
+end
+
+
 function widgetHandler:RecvLuaMsg(msg, playerID)
   local retval = false
   for _,w in ipairs(self.RecvLuaMsgList) do

Modified: trunk/rts/Game/Game.cpp
===================================================================
--- trunk/rts/Game/Game.cpp	2008-07-13 15:39:59 UTC (rev 6165)
+++ trunk/rts/Game/Game.cpp	2008-07-13 16:23:56 UTC (rev 6166)
@@ -198,6 +198,8 @@
 	CR_MEMBER(gameSoundVolume),
 	CR_MEMBER(unitReplyVolume),
 
+	CR_MEMBER(moveWarnings),
+
 //	CR_MEMBER(script),
 	CR_RESERVED(64),
 	CR_POSTLOAD(PostLoad)
@@ -298,6 +300,8 @@
 	sound-&gt;SetVolume(gameSoundVolume);
 	sound-&gt;SetUnitReplyVolume(unitReplyVolume);
 
+	moveWarnings = !!configHandler.GetInt(&quot;MoveWarnings&quot;, 1);
+
 	camera = SAFE_NEW CCamera();
 	cam2 = SAFE_NEW CCamera();
 	mouse = SAFE_NEW CMouseHandler();
@@ -1693,7 +1697,16 @@
 			drawFpsHUD = !!atoi(action.extra.c_str());
 		}
 	}
-
+	else if (cmd == &quot;movewarnings&quot;) {
+		if (action.extra.empty()) {
+			moveWarnings = !moveWarnings;
+		} else {
+			moveWarnings = !!atoi(action.extra.c_str());
+		}
+		configHandler.SetInt(&quot;MoveWarnings&quot;, moveWarnings ? 1 : 0);
+		logOutput.Print(string(&quot;movewarnings &quot;) +
+		                (moveWarnings ? &quot;enabled&quot; : &quot;disabled&quot;));
+	}
 	else if (cmd == &quot;mapmarks&quot;) {
 		if (action.extra.empty()) {
 			drawMapMarks = !drawMapMarks;
@@ -2762,6 +2775,7 @@
 		SCOPED_TIMER(&quot;Interface draw&quot;);
 		if (hideInterface) {
 			guihandler-&gt;Update();
+			luaInputReceiver-&gt;Draw();
 		}
 		else {
 			std::deque&lt;CInputReceiver*&gt;&amp; inputReceivers = GetInputReceivers();

Modified: trunk/rts/Game/Game.h
===================================================================
--- trunk/rts/Game/Game.h	2008-07-13 15:39:59 UTC (rev 6165)
+++ trunk/rts/Game/Game.h	2008-07-13 16:23:56 UTC (rev 6166)
@@ -108,6 +108,8 @@
 	float gameSoundVolume;
 	float unitReplyVolume;
 
+	bool moveWarnings;
+
 	unsigned char gameID[16];
 
 	CScript* script;

Modified: trunk/rts/Game/GameServer.cpp
===================================================================
--- trunk/rts/Game/GameServer.cpp	2008-07-13 15:39:59 UTC (rev 6165)
+++ trunk/rts/Game/GameServer.cpp	2008-07-13 16:23:56 UTC (rev 6166)
@@ -33,9 +33,6 @@
 #include &quot;Server/MsgStrings.h&quot;
 
 
-#if _MSC_VER 
-namespace std { using ::ceil; }
-#endif
 using netcode::RawPacket;
 
 
@@ -1264,7 +1261,7 @@
 
 			timeLeft += GAME_SPEED * internalSpeed * float(timeElapsed) / 1000.0f;
 			lastTick=currentTick;
-			newFrames = (timeLeft &gt; 0)? int(ceil(timeLeft)): 0;
+			newFrames = (timeLeft &gt; 0)? int(streflop::ceil(timeLeft)): 0;
 			timeLeft -= newFrames;
 		}
 	

Modified: trunk/rts/Game/Team.cpp
===================================================================
--- trunk/rts/Game/Team.cpp	2008-07-13 15:39:59 UTC (rev 6165)
+++ trunk/rts/Game/Team.cpp	2008-07-13 16:23:56 UTC (rev 6166)
@@ -470,3 +470,4 @@
 		}
 	}
 }
+

Modified: trunk/rts/Game/Team.h
===================================================================
--- trunk/rts/Game/Team.h	2008-07-13 15:39:59 UTC (rev 6165)
+++ trunk/rts/Game/Team.h	2008-07-13 16:23:56 UTC (rev 6166)
@@ -21,13 +21,14 @@
 	~CTeam();
 	void SlowUpdate();
 
+
 	void AddMetal(float amount);
 	void AddEnergy(float amount);
 	bool UseEnergy(float amount);
 	bool UseMetal(float amount);
 	bool UseEnergyUpkeep(float amount);
 	bool UseMetalUpkeep(float amount);
-	
+
 	void SetBaseMetalStorage(float storage) {metalStorage = storage;};
 	void SetBaseEnergyStorage(float storage) {energyStorage = storage;};
 	

Modified: trunk/rts/Lua/LuaHandle.cpp
===================================================================
--- trunk/rts/Lua/LuaHandle.cpp	2008-07-13 15:39:59 UTC (rev 6165)
+++ trunk/rts/Lua/LuaHandle.cpp	2008-07-13 16:23:56 UTC (rev 6166)
@@ -749,6 +749,14 @@
 }
 
 
+void CLuaHandle::UnitMoveFailed(const CUnit* unit)
+{
+	static const LuaHashString cmdStr(&quot;UnitMoveFailed&quot;);
+	UnitCallIn(cmdStr, unit);
+	return;
+}
+
+
 /******************************************************************************/
 
 void CLuaHandle::FeatureCreated(const CFeature* feature)
@@ -1918,6 +1926,9 @@
 			lua_pushliteral(L, &quot;unsynced&quot;);
 			lua_pushboolean(L, eventHandler.IsUnsynced(list[i]));
 			lua_rawset(L, -3);
+			lua_pushliteral(L, &quot;controller&quot;);
+			lua_pushboolean(L, eventHandler.IsController(list[i]));
+			lua_rawset(L, -3);
 		}
 		lua_rawset(L, -3);
 	}

Modified: trunk/rts/Lua/LuaHandle.h
===================================================================
--- trunk/rts/Lua/LuaHandle.h	2008-07-13 15:39:59 UTC (rev 6165)
+++ trunk/rts/Lua/LuaHandle.h	2008-07-13 16:23:56 UTC (rev 6166)
@@ -21,13 +21,13 @@
 #include &quot;LuaDisplayLists.h&quot;
 
 
-#define LUA_HANDLE_ORDER_RULES          0
-#define LUA_HANDLE_ORDER_UNITS          1
-#define LUA_HANDLE_ORDER_GAIA           2
-#define LUA_HANDLE_ORDER_RULES_UNSYNCED 3
-#define LUA_HANDLE_ORDER_UNITS_UNSYNCED 4
-#define LUA_HANDLE_ORDER_GAIA_UNSYNCED  5
-#define LUA_HANDLE_ORDER_UI             6
+#define LUA_HANDLE_ORDER_RULES            100
+#define LUA_HANDLE_ORDER_UNITS            200
+#define LUA_HANDLE_ORDER_GAIA             300
+#define LUA_HANDLE_ORDER_RULES_UNSYNCED  1100
+#define LUA_HANDLE_ORDER_UNITS_UNSYNCED  1200
+#define LUA_HANDLE_ORDER_GAIA_UNSYNCED   1300
+#define LUA_HANDLE_ORDER_UI              2000
 
 
 class CUnit;
@@ -95,10 +95,6 @@
 		virtual bool SyncedUpdateCallIn(const string&amp; name) { return false; }
 		virtual bool UnsyncedUpdateCallIn(const string&amp; name) { return false; }
 
-		void Update();
-
-		void ViewResize();
-
 		void Shutdown();
 
 		void GamePreload();
@@ -141,6 +137,8 @@
 		void UnitCloaked(const CUnit* unit);
 		void UnitDecloaked(const CUnit* unit);
 
+		void UnitMoveFailed(const CUnit* unit);
+
 		void FeatureCreated(const CFeature* feature);
 		void FeatureDestroyed(const CFeature* feature);
 
@@ -155,19 +153,8 @@
 		// LuaHandleSynced wraps this to set allowChanges
 		virtual bool RecvLuaMsg(const string&amp; msg, int playerID);
 
-		bool DefaultCommand(const CUnit* unit, const CFeature* feature, int&amp; cmd);
+		void Update();
 
-		void DrawGenesis();
-		void DrawWorld();
-		void DrawWorldPreUnit();
-		void DrawWorldShadow();
-		void DrawWorldReflection();
-		void DrawWorldRefraction();
-		void DrawScreenEffects();
-		void DrawScreen();
-		void DrawInMiniMap();
-
-		// moved from LuaUI
 		bool KeyPress(unsigned short key, bool isRepeat);
 		bool KeyRelease(unsigned short key);
 		bool MouseMove(int x, int y, int dx, int dy, int button);
@@ -177,6 +164,8 @@
 		bool IsAbove(int x, int y);
 		string GetTooltip(int x, int y);
 
+		bool DefaultCommand(const CUnit* unit, const CFeature* feature, int&amp; cmd);
+
 		bool ConfigCommand(const string&amp; command);
 
 		bool CommandNotify(const Command&amp; cmd);
@@ -197,7 +186,18 @@
 		                const float3* pos1,
 		                const string* labe);
 
+		void ViewResize();
 
+		void DrawGenesis();
+		void DrawWorld();
+		void DrawWorldPreUnit();
+		void DrawWorldShadow();
+		void DrawWorldReflection();
+		void DrawWorldRefraction();
+		void DrawScreenEffects();
+		void DrawScreen();
+		void DrawInMiniMap();
+
 	public: // custom call-in  (inter-script calls)
 		virtual bool HasSyncedXCall(const string&amp; funcName) { return false; }
 		virtual bool HasUnsyncedXCall(const string&amp; funcName) { return false; }

Modified: trunk/rts/Lua/LuaIO.cpp
===================================================================
--- trunk/rts/Lua/LuaIO.cpp	2008-07-13 15:39:59 UTC (rev 6165)
+++ trunk/rts/Lua/LuaIO.cpp	2008-07-13 16:23:56 UTC (rev 6166)
@@ -12,6 +12,8 @@
 using std::string;
 
 #include &quot;LuaHandle.h&quot;
+#include &quot;LuaInclude.h&quot;
+#include &quot;System/Platform/FileSystem.h&quot;
 
 
 /******************************************************************************/
@@ -50,13 +52,13 @@
 
 bool LuaIO::SafeExecPath(const string&amp; path)
 {
-	return true;
+	return false; // don't allow execution of external programs, yet
 }
 
 
 bool LuaIO::SafeReadPath(const string&amp; path)
 {
-	return IsSimplePath(path);
+	return filesystem.InReadDir(path);
 }
 
 
@@ -66,13 +68,10 @@
 #if !defined UNITSYNC &amp;&amp; !defined DEDICATED
 	const CLuaHandle* lh = CLuaHandle::GetActiveHandle();
 	if (lh != NULL) {
-		prefix = lh-&gt;GetName() + &quot;/&quot; + &quot;write&quot;;
+		prefix = lh-&gt;GetName() + &quot;/&quot; + &quot;Write&quot;;
 	}
 #endif
-	if (path.compare(0, prefix.size(), prefix) != 0) {
-		return false;
-	}
-	return true;
+	return filesystem.InWriteDir(path, prefix);
 }
 
 
@@ -120,7 +119,8 @@
 
 int LuaIO::system(lua_State* L, const char* command)
 {
-	return -1;
+	luaL_error(L, &quot;the system() call is not available&quot;);
+	return -1; //
 }
 
 

Modified: trunk/rts/Lua/LuaRules.cpp
===================================================================
--- trunk/rts/Lua/LuaRules.cpp	2008-07-13 15:39:59 UTC (rev 6165)
+++ trunk/rts/Lua/LuaRules.cpp	2008-07-13 16:23:56 UTC (rev 6166)
@@ -109,21 +109,21 @@
 		return;
 	}
 
-	haveCommandFallback          = HasCallIn(&quot;CommandFallback&quot;);
-	haveAllowCommand             = HasCallIn(&quot;AllowCommand&quot;);
-	haveAllowUnitCreation        = HasCallIn(&quot;AllowUnitCreation&quot;);
-	haveAllowUnitTransfer        = HasCallIn(&quot;AllowUnitTransfer&quot;);
-	haveAllowUnitBuildStep       = HasCallIn(&quot;AllowUnitBuildStep&quot;);
-	haveAllowFeatureCreation     = HasCallIn(&quot;AllowFeatureCreation&quot;);
-	haveAllowFeatureBuildStep    = HasCallIn(&quot;AllowFeatureBuildStep&quot;);
-	haveAllowResourceLevel       = HasCallIn(&quot;AllowResourceLevel&quot;);
-	haveAllowResourceTransfer    = HasCallIn(&quot;AllowResourceTransfer&quot;);
-	haveAllowDirectUnitControl   = HasCallIn(&quot;AllowDirectUnitControl&quot;);
-	haveAllowStartPosition       = HasCallIn(&quot;AllowStartPosition&quot;);
-	haveMoveCtrlNotify           = HasCallIn(&quot;MoveCtrlNotify&quot;);
-	haveBuilderTerraformComplete = HasCallIn(&quot;BuilderTerraformComplete&quot;);
-	haveDrawUnit                 = HasCallIn(&quot;DrawUnit&quot;);
-	haveAICallIn                 = HasCallIn(&quot;AICallIn&quot;);
+	haveCommandFallback        = HasCallIn(&quot;CommandFallback&quot;);
+	haveAllowCommand           = HasCallIn(&quot;AllowCommand&quot;);
+	haveAllowUnitCreation      = HasCallIn(&quot;AllowUnitCreation&quot;);
+	haveAllowUnitTransfer      = HasCallIn(&quot;AllowUnitTransfer&quot;);
+	haveAllowUnitBuildStep     = HasCallIn(&quot;AllowUnitBuildStep&quot;);
+	haveAllowFeatureCreation   = HasCallIn(&quot;AllowFeatureCreation&quot;);
+	haveAllowFeatureBuildStep  = HasCallIn(&quot;AllowFeatureBuildStep&quot;);
+	haveAllowResourceLevel     = HasCallIn(&quot;AllowResourceLevel&quot;);
+	haveAllowResourceTransfer  = HasCallIn(&quot;AllowResourceTransfer&quot;);
+	haveAllowDirectUnitControl = HasCallIn(&quot;AllowDirectUnitControl&quot;);
+	haveAllowStartPosition     = HasCallIn(&quot;AllowStartPosition&quot;);
+	haveMoveCtrlNotify         = HasCallIn(&quot;MoveCtrlNotify&quot;);
+	haveTerraformComplete      = HasCallIn(&quot;TerraformComplete&quot;);
+	haveDrawUnit               = HasCallIn(&quot;DrawUnit&quot;);
+	haveAICallIn               = HasCallIn(&quot;AICallIn&quot;);
 
 	SetupUnsyncedFunction(&quot;DrawUnit&quot;);
 	SetupUnsyncedFunction(&quot;AICallIn&quot;);
@@ -224,31 +224,31 @@
 bool CLuaRules::SyncedUpdateCallIn(const string&amp; name)
 {
 	if (name == &quot;CommandFallback&quot;) {
-		haveCommandFallback          = HasCallIn(&quot;CommandFallback&quot;);
+		haveCommandFallback        = HasCallIn(&quot;CommandFallback&quot;);
 	} else if (name == &quot;AllowCommand&quot;) {
-		haveAllowCommand             = HasCallIn(&quot;AllowCommand&quot;);
+		haveAllowCommand           = HasCallIn(&quot;AllowCommand&quot;);
 	} else if (name == &quot;AllowUnitCreation&quot;) {
-		haveAllowUnitCreation        = HasCallIn(&quot;AllowUnitCreation&quot;);
+		haveAllowUnitCreation      = HasCallIn(&quot;AllowUnitCreation&quot;);
 	} else if (name == &quot;AllowUnitTransfer&quot;) {
-		haveAllowUnitTransfer        = HasCallIn(&quot;AllowUnitTransfer&quot;);
+		haveAllowUnitTransfer      = HasCallIn(&quot;AllowUnitTransfer&quot;);
 	} else if (name == &quot;AllowUnitBuildStep&quot;) {
-		haveAllowUnitBuildStep       = HasCallIn(&quot;AllowUnitBuildStep&quot;);
+		haveAllowUnitBuildStep     = HasCallIn(&quot;AllowUnitBuildStep&quot;);
 	} else if (name == &quot;AllowFeatureCreation&quot;) {
-		haveAllowFeatureCreation     = HasCallIn(&quot;AllowFeatureCreation&quot;);
+		haveAllowFeatureCreation   = HasCallIn(&quot;AllowFeatureCreation&quot;);
 	} else if (name == &quot;AllowFeatureBuildStep&quot;) {
-		haveAllowFeatureBuildStep    = HasCallIn(&quot;AllowFeatureBuildStep&quot;);
+		haveAllowFeatureBuildStep  = HasCallIn(&quot;AllowFeatureBuildStep&quot;);
 	} else if (name == &quot;AllowResourceLevel&quot;) {
-		haveAllowResourceLevel       = HasCallIn(&quot;AllowResourceLevel&quot;);
+		haveAllowResourceLevel     = HasCallIn(&quot;AllowResourceLevel&quot;);
 	} else if (name == &quot;AllowResourceTransfer&quot;) {
-		haveAllowResourceTransfer    = HasCallIn(&quot;AllowResourceTransfer&quot;);
+		haveAllowResourceTransfer  = HasCallIn(&quot;AllowResourceTransfer&quot;);
 	} else if (name == &quot;AllowDirectUnitControl&quot;) {
-		haveAllowDirectUnitControl   = HasCallIn(&quot;AllowDirectUnitControl&quot;);
+		haveAllowDirectUnitControl = HasCallIn(&quot;AllowDirectUnitControl&quot;);
 	} else if (name == &quot;AllowStartPosition&quot;) {
-		haveAllowStartPosition       = HasCallIn(&quot;AllowStartPosition&quot;);
+		haveAllowStartPosition     = HasCallIn(&quot;AllowStartPosition&quot;);
 	} else if (name == &quot;MoveCtrlNotify&quot;) {
-		haveMoveCtrlNotify           = HasCallIn(&quot;MoveCtrlNotify&quot;);
-	} else if (name == &quot;BuilderTerraformComplete&quot;) {
-		haveBuilderTerraformComplete = HasCallIn(&quot;BuilderTerraformComplete&quot;);
+		haveMoveCtrlNotify         = HasCallIn(&quot;MoveCtrlNotify&quot;);
+	} else if (name == &quot;TerraformComplete&quot;) {
+		haveTerraformComplete      = HasCallIn(&quot;TerraformComplete&quot;);
 	} else {
 		return CLuaHandleSynced::SyncedUpdateCallIn(name);
 	}
@@ -757,15 +757,15 @@
 }
 
 
-bool CLuaRules::BuilderTerraformComplete(const CUnit* unit, const CUnit* build)
+bool CLuaRules::TerraformComplete(const CUnit* unit, const CUnit* build)
 {
-	if (!haveBuilderTerraformComplete) {
+	if (!haveTerraformComplete) {
 		return false; // the call is not defined
 	}
 
 	LUA_CALL_IN_CHECK(L);
 	lua_checkstack(L, 8);
-	static const LuaHashString cmdStr(&quot;BuilderTerraformComplete&quot;);
+	static const LuaHashString cmdStr(&quot;TerraformComplete&quot;);
 	if (!cmdStr.GetGlobalFunc(L)) {
 		return false; // the call is not defined
 	}

Modified: trunk/rts/Lua/LuaRules.h
===================================================================
--- trunk/rts/Lua/LuaRules.h	2008-07-13 15:39:59 UTC (rev 6165)
+++ trunk/rts/Lua/LuaRules.h	2008-07-13 16:23:56 UTC (rev 6166)
@@ -44,7 +44,6 @@
 		bool UnsyncedUpdateCallIn(const string&amp; name);
 
 		bool CommandFallback(const CUnit* unit, const Command&amp; cmd);
-		bool BuilderTerraformComplete(const CUnit* unit, const CUnit* build);
 		bool AllowCommand(const CUnit* unit, const Command&amp; cmd, bool fromSynced);
 		bool AllowUnitCreation(const UnitDef* unitDef,
 		                       const CUnit* builder, const float3* pos);
@@ -60,6 +59,8 @@
 		bool AllowDirectUnitControl(int playerID, const CUnit* unit);
 		bool AllowStartPosition(int playerID, const float3&amp; pos);
 
+		bool TerraformComplete(const CUnit* unit, const CUnit* build);
+
 		bool MoveCtrlNotify(const CUnit* unit, int data);
 
 		void Cob2Lua(const LuaHashString&amp; funcName, const CUnit* unit,
@@ -118,7 +119,7 @@
 		bool haveAllowDirectUnitControl;
 		bool haveAllowStartPosition;
 		bool haveMoveCtrlNotify;
-		bool haveBuilderTerraformComplete;
+		bool haveTerraformComplete;
 		bool haveDrawUnit;
 		bool haveAICallIn;
 

Modified: trunk/rts/Lua/LuaUnitRendering.cpp
===================================================================
--- trunk/rts/Lua/LuaUnitRendering.cpp	2008-07-13 15:39:59 UTC (rev 6165)
+++ trunk/rts/Lua/LuaUnitRendering.cpp	2008-07-13 16:23:56 UTC (rev 6166)
@@ -24,7 +24,6 @@
 #include &quot;Sim/Units/UnitDefHandler.h&quot;
 #include &quot;LogOutput.h&quot;
 
-namespace std {using ::tanf;} // for some reason MSVS needs this
 
 using std::min;
 using std::max;

Modified: trunk/rts/Rendering/IconHandler.cpp
===================================================================
--- trunk/rts/Rendering/IconHandler.cpp	2008-07-13 15:39:59 UTC (rev 6165)
+++ trunk/rts/Rendering/IconHandler.cpp	2008-07-13 16:23:56 UTC (rev 6166)
@@ -15,7 +15,6 @@
 #include &quot;mmgr.h&quot;
 
 using std::string;
-namespace std {using ::sqrtf;} // for some reason MSVS needs this
 
 CIconHandler* iconHandler = NULL;
 
@@ -177,7 +176,7 @@
 			const int index = ((y * 128) + x) * 4;
 			const int dx = (x - 64);
 			const int dy = (y - 64);
-			const float r = std::sqrtf((dx * dx) + (dy * dy)) / 64.0f;
+			const float r = streflop::sqrtf((dx * dx) + (dy * dy)) / 64.0f;
 			if (r &gt; 1.0f) {
 				si[index + 0] = 0;
 				si[index + 1] = 0;

Modified: trunk/rts/Sim/MoveTypes/GroundMoveType.cpp
===================================================================
--- trunk/rts/Sim/MoveTypes/GroundMoveType.cpp	2008-07-13 15:39:59 UTC (rev 6165)
+++ trunk/rts/Sim/MoveTypes/GroundMoveType.cpp	2008-07-13 16:23:56 UTC (rev 6166)
@@ -1,35 +1,37 @@
 #include &quot;StdAfx.h&quot;
 #include &quot;GroundMoveType.h&quot;
+#include &quot;ExternalAI/GlobalAIHandler.h&quot;
+#include &quot;Game/Camera.h&quot;
+#include &quot;Game/Game.h&quot;
+#include &quot;Game/GameHelper.h&quot;
+#include &quot;Game/Player.h&quot;
+#include &quot;Game/SelectedUnits.h&quot;
 #include &quot;Map/Ground.h&quot;
-#include &quot;Sim/Misc/QuadField.h&quot;
+#include &quot;Map/MapInfo.h&quot;
 #include &quot;Map/ReadMap.h&quot;
-#include &quot;Map/MapInfo.h&quot;
-#include &quot;Sim/Misc/LosHandler.h&quot;
-#include &quot;Game/GameHelper.h&quot;
-#include &quot;myMath.h&quot;
-#include &quot;LogOutput.h&quot;
-#include &quot;Sim/Units/UnitHandler.h&quot;
-#include &quot;Sync/SyncTracer.h&quot;
+#include &quot;MoveMath/MoveMath.h&quot;
+#include &quot;Rendering/GroundDecalHandler.h&quot;
 #include &quot;Rendering/UnitModels/3DModelParser.h&quot;
 #include &quot;Sim/Features/Feature.h&quot;
 #include &quot;Sim/Features/FeatureHandler.h&quot;
-#include &quot;Sim/Units/COB/CobInstance.h&quot;
-#include &quot;Sim/Units/COB/CobFile.h&quot;
-#include &quot;Sim/Units/UnitDef.h&quot;
-#include &quot;Sound.h&quot;
+#include &quot;Sim/Misc/GeometricObjects.h&quot;
+#include &quot;Sim/Misc/GroundBlockingObjectMap.h&quot;
+#include &quot;Sim/Misc/LosHandler.h&quot;
+#include &quot;Sim/Misc/QuadField.h&quot;
 #include &quot;Sim/Misc/RadarHandler.h&quot;
 #include &quot;Sim/Path/PathManager.h&quot;
-#include &quot;Game/Player.h&quot;
-#include &quot;Game/Camera.h&quot;
+#include &quot;Sim/Units/COB/CobFile.h&quot;
+#include &quot;Sim/Units/COB/CobInstance.h&quot;
 #include &quot;Sim/Units/CommandAI/CommandAI.h&quot;
-#include &quot;MoveMath/MoveMath.h&quot;
-#include &quot;Sim/Misc/GeometricObjects.h&quot;
+#include &quot;Sim/Units/UnitDef.h&quot;
+#include &quot;Sim/Units/UnitHandler.h&quot;
+#include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
 #include &quot;Sim/Weapons/Weapon.h&quot;
-#include &quot;Sim/Weapons/WeaponDefHandler.h&quot;
-#include &quot;Game/SelectedUnits.h&quot;
-#include &quot;Rendering/GroundDecalHandler.h&quot;
-#include &quot;ExternalAI/GlobalAIHandler.h&quot;
-#include &quot;Sim/Misc/GroundBlockingObjectMap.h&quot;
+#include &quot;Sync/SyncTracer.h&quot;
+#include &quot;System/EventHandler.h&quot;
+#include &quot;System/LogOutput.h&quot;
+#include &quot;System/Sound.h&quot;
+#include &quot;myMath.h&quot;
 #include &quot;mmgr.h&quot;
 
 CR_BIND_DERIVED(CGroundMoveType, AMoveType, (NULL));
@@ -1335,28 +1337,27 @@
 
 	StopEngine();
 
-	//Failure of finding a path means that this action
-	//has failed to reach it's goal.
+	// failure of finding a path means that
+	// this action has failed to reach it's goal.
 	progressState = Failed;
 
+	eventHandler.UnitMoveFailed(owner);
 	globalAI-&gt;UnitMoveFailed(owner);
 
-	//Sends a message to user.
+	// sends a message to user.
 	ENTER_UNSYNCED;
-	if (owner-&gt;team == gu-&gt;myTeam) {
-		// Playing &quot;can't&quot; sound.
+	if (game-&gt;moveWarnings &amp;&amp; (owner-&gt;team == gu-&gt;myTeam)) {
+		// playing &quot;cant&quot; sound.
 		int soundIdx = owner-&gt;unitDef-&gt;sounds.cant.getRandomIdx();
 		if (soundIdx &gt;= 0) {
 			sound-&gt;PlayUnitReply(
 				owner-&gt;unitDef-&gt;sounds.cant.getID(soundIdx), owner,
 				owner-&gt;unitDef-&gt;sounds.cant.getVolume(soundIdx));
 		}
-
-		if (!owner-&gt;commandAI-&gt;unimportantMove &amp;&amp; owner-&gt;pos.distance(goalPos) &gt; goalRadius + 150) {
-			if (gs-&gt;frameNum % (GAME_SPEED * 3) == 0) {
-				logOutput &lt;&lt; owner-&gt;unitDef-&gt;humanName.c_str() &lt;&lt; &quot;: Can't reach destination!\n&quot;;
-				logOutput.SetLastMsgPos(owner-&gt;pos);
-			}
+		if (!owner-&gt;commandAI-&gt;unimportantMove &amp;&amp;
+		    (owner-&gt;pos.distance(goalPos) &gt; (goalRadius + 150.0f))) {
+			logOutput.Print(owner-&gt;unitDef-&gt;humanName + &quot;: Can't reach destination!&quot;);
+			logOutput.SetLastMsgPos(owner-&gt;pos);
 		}
 	}
 	ENTER_SYNCED;

Modified: trunk/rts/Sim/Units/Unit.cpp
===================================================================
--- trunk/rts/Sim/Units/Unit.cpp	2008-07-13 15:39:59 UTC (rev 6165)
+++ trunk/rts/Sim/Units/Unit.cpp	2008-07-13 16:23:56 UTC (rev 6166)
@@ -245,7 +245,9 @@
 		// we have to wait for deathScriptFinished (but we want the delay
 		// in frames between CUnitKilledCB() and the CreateWreckage() call
 		// to be as short as possible to prevent visual position jumps)
-		featureHandler-&gt;CreateWreckage(pos, wreckName, heading, buildFacing, delayedWreckLevel, team, -1, true, unitDef-&gt;name,  deathSpeed);
+		featureHandler-&gt;CreateWreckage(pos, wreckName, heading, buildFacing,
+		                               delayedWreckLevel, team, -1, true,
+		                               unitDef-&gt;name, deathSpeed);
 	}
 
 	if (unitDef-&gt;isAirBase) {
@@ -1812,7 +1814,8 @@
 	}
 
 	if (dynamic_cast&lt;CAirMoveType*&gt;(moveType) &amp;&amp; !beingBuilt) {
-		if (unitDef-&gt;canCrash &amp;&amp; !selfDestruct &amp;&amp; !reclaimed &amp;&amp; gs-&gt;randFloat() &gt; recentDamage * 0.7f / maxHealth + 0.2f) {
+		if (unitDef-&gt;canCrash &amp;&amp; !selfDestruct &amp;&amp; !reclaimed &amp;&amp;
+		    (gs-&gt;randFloat() &gt; (recentDamage * 0.7f / maxHealth + 0.2f))) {
 			((CAirMoveType*) moveType)-&gt;SetState(AAirMoveType::AIRCRAFT_CRASHING);
 			health = maxHealth * 0.5f;
 			return;

Modified: trunk/rts/Sim/Units/UnitDefHandler.cpp
===================================================================
--- trunk/rts/Sim/Units/UnitDefHandler.cpp	2008-07-13 15:39:59 UTC (rev 6165)
+++ trunk/rts/Sim/Units/UnitDefHandler.cpp	2008-07-13 16:23:56 UTC (rev 6166)
@@ -761,11 +761,12 @@
 
 	// initialize the (per-unitdef) collision-volume
 	// all CUnit instances hold a copy of this object
-	ud.collisionVolume = SAFE_NEW CollisionVolume(ud.collisionVolumeType,
-		ud.collisionVolumeScales, ud.collisionVolumeOffsets, ud.collisionVolumeTest);
+	ud.collisionVolume = SAFE_NEW CollisionVolume(
+		ud.collisionVolumeType,
+		ud.collisionVolumeScales,
+		ud.collisionVolumeOffsets,
+		ud.collisionVolumeTest);
 
-
-
 	ud.seismicRadius    = udTable.GetInt(&quot;seismicDistance&quot;, 0);
 	ud.seismicSignature = udTable.GetFloat(&quot;seismicSignature&quot;, -1.0f);
 	if (ud.seismicSignature == -1.0f) {

Modified: trunk/rts/Sim/Units/UnitTypes/Builder.cpp
===================================================================
--- trunk/rts/Sim/Units/UnitTypes/Builder.cpp	2008-07-13 15:39:59 UTC (rev 6165)
+++ trunk/rts/Sim/Units/UnitTypes/Builder.cpp	2008-07-13 16:23:56 UTC (rev 6166)
@@ -160,7 +160,7 @@
 						terraforming=false;
 						mapDamage-&gt;RecalcArea(tx1,tx2,tz1,tz2);
 						curBuild-&gt;groundLevelled = true;
-						if (luaRules &amp;&amp; luaRules-&gt;BuilderTerraformComplete(this, curBuild)) {
+						if (luaRules &amp;&amp; luaRules-&gt;TerraformComplete(this, curBuild)) {
 							StopBuild();
 						}
 					}

Modified: trunk/rts/System/EventClient.cpp
===================================================================
--- trunk/rts/System/EventClient.cpp	2008-07-13 15:39:59 UTC (rev 6165)
+++ trunk/rts/System/EventClient.cpp	2008-07-13 16:23:56 UTC (rev 6166)
@@ -69,6 +69,8 @@
 void CEventClient::UnitCloaked(const CUnit* unit) { return; }
 void CEventClient::UnitDecloaked(const CUnit* unit) { return; }
 
+void CEventClient::UnitMoveFailed(const CUnit* unit) { return; }
+
 void CEventClient::FeatureCreated(const CFeature* feature) { return; }
 void CEventClient::FeatureDestroyed(const CFeature* feature) { return; }
 

Modified: trunk/rts/System/EventClient.h
===================================================================
--- trunk/rts/System/EventClient.h	2008-07-13 15:39:59 UTC (rev 6165)
+++ trunk/rts/System/EventClient.h	2008-07-13 16:23:56 UTC (rev 6166)
@@ -40,7 +40,7 @@
 		virtual int  GetReadAllyTeam() const { return NoAccessTeam; }
 		virtual bool GetFullRead()     const { return GetReadAllyTeam() == AllAccessTeam; }
 		inline bool CanReadAllyTeam(int allyTeam) {
-			return GetFullRead() || (GetReadAllyTeam() == allyTeam);
+			return (GetFullRead() || (GetReadAllyTeam() == allyTeam));
 		}
 
 	private:
@@ -53,7 +53,7 @@
 		virtual ~CEventClient();
 
 	public:
-		// Synced
+		// Synced events
 		virtual void GamePreload();
 		virtual void GameStart();
 		virtual void GameOver();
@@ -95,6 +95,8 @@
 		virtual void UnitCloaked(const CUnit* unit);
 		virtual void UnitDecloaked(const CUnit* unit);
 
+		virtual void UnitMoveFailed(const CUnit* unit);
+
 		virtual void FeatureCreated(const CFeature* feature);
 		virtual void FeatureDestroyed(const CFeature* feature);
 
@@ -106,24 +108,9 @@
 	
 		virtual bool Explosion(int weaponID, const float3&amp; pos, const CUnit* owner);
 
-		// Unsynced
+		// Unsynced events
 		virtual void Update();
 
-		virtual void ViewResize();
-
-		virtual bool DefaultCommand(const CUnit* unit, const CFeature* feature, int&amp; cmd);
-
-		virtual void DrawGenesis();
-		virtual void DrawWorld();
-		virtual void DrawWorldPreUnit();
-		virtual void DrawWorldShadow();
-		virtual void DrawWorldReflection();
-		virtual void DrawWorldRefraction();
-		virtual void DrawScreenEffects();
-		virtual void DrawScreen();
-		virtual void DrawInMiniMap();
-
-		// from LuaUI
 		virtual bool KeyPress(unsigned short key, bool isRepeat);
 		virtual bool KeyRelease(unsigned short key);
 		virtual bool MouseMove(int x, int y, int dx, int dy, int button);
@@ -133,6 +120,8 @@
 		virtual bool IsAbove(int x, int y);
 		virtual std::string GetTooltip(int x, int y);
 
+		virtual bool DefaultCommand(const CUnit* unit, const CFeature* feature, int&amp; cmd);
+
 		virtual bool CommandNotify(const Command&amp; cmd);
 
 		virtual bool AddConsoleLine(const std::string&amp; msg, int zone);
@@ -150,6 +139,18 @@
 		                        const float3* pos0,
 		                        const float3* pos1,
 		                        const std::string* label);
+
+		virtual void ViewResize();
+
+		virtual void DrawGenesis();
+		virtual void DrawWorld();
+		virtual void DrawWorldPreUnit();
+		virtual void DrawWorldShadow();
+		virtual void DrawWorldReflection();
+		virtual void DrawWorldRefraction();
+		virtual void DrawScreenEffects();
+		virtual void DrawScreen();
+		virtual void DrawInMiniMap();
 };
 
 

Modified: trunk/rts/System/EventHandler.cpp
===================================================================
--- trunk/rts/System/EventHandler.cpp	2008-07-13 15:39:59 UTC (rev 6165)
+++ trunk/rts/System/EventHandler.cpp	2008-07-13 16:23:56 UTC (rev 6166)
@@ -17,15 +17,15 @@
 /******************************************************************************/
 /******************************************************************************/
 
-#define SETUP_EVENT(name, props) SetupEvent(#name, &amp;list ## name, props)
-
 void CEventHandler::SetupEvent(const string&amp; eName,
                                EventClientList* list, int props)
 {
 	eventMap[eName] = EventInfo(eName, list, props);
 }
 
+#define SETUP_EVENT(name, props) SetupEvent(#name, &amp;list ## name, props)
 
+
 /******************************************************************************/
 /******************************************************************************/
 
@@ -33,10 +33,6 @@
 {
 	mouseOwner = NULL;
 
-	// unmanaged call-ins
-	eventMap[&quot;AIEvent&quot;] = EventInfo(&quot;AIEvent&quot;, NULL, UNSYNCED_BIT);
-	eventMap[&quot;DrawUnit&quot;] = EventInfo(&quot;DrawUnit&quot;, NULL, UNSYNCED_BIT);
-
 	// synced call-ins
 	SETUP_EVENT(GamePreload,   MANAGED_BIT);
 	SETUP_EVENT(GameStart,     MANAGED_BIT);
@@ -69,11 +65,13 @@
 	SETUP_EVENT(UnitLeftWater,    MANAGED_BIT);
 	SETUP_EVENT(UnitLeftAir,      MANAGED_BIT);
 
-	SETUP_EVENT(UnitLoaded,    MANAGED_BIT);
-	SETUP_EVENT(UnitUnloaded,  MANAGED_BIT);
-	SETUP_EVENT(UnitCloaked,   MANAGED_BIT);
-	SETUP_EVENT(UnitDecloaked, MANAGED_BIT);
+	SETUP_EVENT(UnitLoaded,     MANAGED_BIT);
+	SETUP_EVENT(UnitUnloaded,   MANAGED_BIT);
+	SETUP_EVENT(UnitCloaked,    MANAGED_BIT);
+	SETUP_EVENT(UnitDecloaked,  MANAGED_BIT);
 
+	SETUP_EVENT(UnitMoveFailed, MANAGED_BIT);
+
 	SETUP_EVENT(FeatureCreated,   MANAGED_BIT);
 	SETUP_EVENT(FeatureDestroyed, MANAGED_BIT);
 
@@ -86,19 +84,7 @@
 
 	// unsynced call-ins
 	SETUP_EVENT(Update,         MANAGED_BIT | UNSYNCED_BIT);
-	SETUP_EVENT(ViewResize,     MANAGED_BIT | UNSYNCED_BIT);
-	SETUP_EVENT(DefaultCommand, MANAGED_BIT | UNSYNCED_BIT);
 
-	SETUP_EVENT(DrawGenesis,         MANAGED_BIT | UNSYNCED_BIT);
-	SETUP_EVENT(DrawWorld,           MANAGED_BIT | UNSYNCED_BIT);
-	SETUP_EVENT(DrawWorldPreUnit,    MANAGED_BIT | UNSYNCED_BIT);
-	SETUP_EVENT(DrawWorldShadow,     MANAGED_BIT | UNSYNCED_BIT);
-	SETUP_EVENT(DrawWorldReflection, MANAGED_BIT | UNSYNCED_BIT);
-	SETUP_EVENT(DrawWorldRefraction, MANAGED_BIT | UNSYNCED_BIT);
-	SETUP_EVENT(DrawScreenEffects,   MANAGED_BIT | UNSYNCED_BIT);
-	SETUP_EVENT(DrawScreen,          MANAGED_BIT | UNSYNCED_BIT);
-	SETUP_EVENT(DrawInMiniMap,       MANAGED_BIT | UNSYNCED_BIT);
-
   SETUP_EVENT(KeyPress,       MANAGED_BIT | UNSYNCED_BIT);
   SETUP_EVENT(KeyRelease,     MANAGED_BIT | UNSYNCED_BIT);
   SETUP_EVENT(MouseMove,      MANAGED_BIT | UNSYNCED_BIT);
@@ -107,12 +93,45 @@
   SETUP_EVENT(MouseWheel,     MANAGED_BIT | UNSYNCED_BIT);
   SETUP_EVENT(IsAbove,        MANAGED_BIT | UNSYNCED_BIT);
   SETUP_EVENT(GetTooltip,     MANAGED_BIT | UNSYNCED_BIT);
+
+	SETUP_EVENT(DefaultCommand, MANAGED_BIT | UNSYNCED_BIT);
   SETUP_EVENT(CommandNotify,  MANAGED_BIT | UNSYNCED_BIT);
   SETUP_EVENT(AddConsoleLine, MANAGED_BIT | UNSYNCED_BIT);
   SETUP_EVENT(GroupChanged,   MANAGED_BIT | UNSYNCED_BIT);
   SETUP_EVENT(GameSetup,      MANAGED_BIT | UNSYNCED_BIT);
   SETUP_EVENT(WorldTooltip,   MANAGED_BIT | UNSYNCED_BIT);
   SETUP_EVENT(MapDrawCmd,     MANAGED_BIT | UNSYNCED_BIT);
+
+	SETUP_EVENT(ViewResize,     MANAGED_BIT | UNSYNCED_BIT);
+
+	SETUP_EVENT(DrawGenesis,         MANAGED_BIT | UNSYNCED_BIT);
+	SETUP_EVENT(DrawWorld,           MANAGED_BIT | UNSYNCED_BIT);
+	SETUP_EVENT(DrawWorldPreUnit,    MANAGED_BIT | UNSYNCED_BIT);
+	SETUP_EVENT(DrawWorldShadow,     MANAGED_BIT | UNSYNCED_BIT);
+	SETUP_EVENT(DrawWorldReflection, MANAGED_BIT | UNSYNCED_BIT);
+	SETUP_EVENT(DrawWorldRefraction, MANAGED_BIT | UNSYNCED_BIT);
+	SETUP_EVENT(DrawScreenEffects,   MANAGED_BIT | UNSYNCED_BIT);
+	SETUP_EVENT(DrawScreen,          MANAGED_BIT | UNSYNCED_BIT);
+	SETUP_EVENT(DrawInMiniMap,       MANAGED_BIT | UNSYNCED_BIT);
+
+	// unmanaged call-ins
+	SetupEvent(&quot;AIEvent&quot;,  NULL, UNSYNCED_BIT);
+	SetupEvent(&quot;DrawUnit&quot;, NULL, UNSYNCED_BIT);
+
+	// LuaRules
+	SetupEvent(&quot;CommandFallback&quot;,        NULL, CONTROL_BIT);
+	SetupEvent(&quot;AllowCommand&quot;,           NULL, CONTROL_BIT);
+	SetupEvent(&quot;AllowUnitCreation&quot;,      NULL, CONTROL_BIT);
+	SetupEvent(&quot;AllowUnitTransfer&quot;,      NULL, CONTROL_BIT);
+	SetupEvent(&quot;AllowUnitBuildStep&quot;,     NULL, CONTROL_BIT);
+	SetupEvent(&quot;AllowFeatureCreation&quot;,   NULL, CONTROL_BIT);
+	SetupEvent(&quot;AllowFeatureBuildStep&quot;,  NULL, CONTROL_BIT);
+	SetupEvent(&quot;AllowResourceLevel&quot;,     NULL, CONTROL_BIT);
+	SetupEvent(&quot;AllowResourceTransfer&quot;,  NULL, CONTROL_BIT);
+	SetupEvent(&quot;AllowDirectUnitControl&quot;, NULL, CONTROL_BIT);
+	SetupEvent(&quot;AllowStartPosition&quot;,     NULL, CONTROL_BIT);
+	SetupEvent(&quot;TerraformComplete&quot;,      NULL, CONTROL_BIT);
+	SetupEvent(&quot;MoveCtrlNotify&quot;,         NULL, CONTROL_BIT);
 }
 
 
@@ -206,6 +225,9 @@
 	if ((it == eventMap.end()) || (it-&gt;second.GetList() == NULL)) {
 		return false;
 	}
+	if (ec-&gt;GetSynced() &amp;&amp; it-&gt;second.HasPropBit(UNSYNCED_BIT)) {
+		return false;
+	}
 	ListInsert(*it-&gt;second.GetList(), ec);
 	return true;
 }

Modified: trunk/rts/System/EventHandler.h
===================================================================
--- trunk/rts/System/EventHandler.h	2008-07-13 15:39:59 UTC (rev 6165)
+++ trunk/rts/System/EventHandler.h	2008-07-13 16:23:56 UTC (rev 6166)
@@ -1,4 +1,4 @@
-#ifndef EVENT_HANDLER_H
+	#ifndef EVENT_HANDLER_H
 #define EVENT_HANDLER_H
 // EventHandler.h: interface for the CEventHandler class.
 //
@@ -40,7 +40,7 @@
 		bool IsController(const std::string&amp; ciName) const;
 
 	public:
-		// Synced
+		// Synced events
 		void GamePreload();
 		void GameStart();
 		void GameOver();
@@ -82,6 +82,8 @@
 		void UnitCloaked(const CUnit* unit);
 		void UnitDecloaked(const CUnit* unit);
 
+		void UnitMoveFailed(const CUnit* unit);
+
 		void FeatureCreated(const CFeature* feature);
 		void FeatureDestroyed(const CFeature* feature);
 
@@ -93,24 +95,10 @@
 		void StockpileChanged(const CUnit* unit,
 		                      const CWeapon* weapon, int oldCount);
 	
-		// Unsynced
+	public:
+		// Unsynced events
 		void Update();
 
-		void ViewResize();
-
-		bool DefaultCommand(const CUnit* unit, const CFeature* feature, int&amp; cmd);
-
-		void DrawGenesis();
-		void DrawWorld();
-		void DrawWorldPreUnit();
-		void DrawWorldShadow();
-		void DrawWorldReflection();
-		void DrawWorldRefraction();
-		void DrawScreenEffects();
-		void DrawScreen();
-		void DrawInMiniMap();
-
-		// from LuaUI
 		bool KeyPress(unsigned short key, bool isRepeat);
 		bool KeyRelease(unsigned short key);
 		bool MouseMove(int x, int y, int dx, int dy, int button);
@@ -120,6 +108,8 @@
 		bool IsAbove(int x, int y);
 		std::string GetTooltip(int x, int y);
 
+		bool DefaultCommand(const CUnit* unit, const CFeature* feature, int&amp; cmd);
+
 		bool CommandNotify(const Command&amp; cmd);
 
 		bool AddConsoleLine(const std::string&amp; msg, int zone);
@@ -138,6 +128,18 @@
 		                const float3* pos1,
 		                const std::string* label);
 
+		void ViewResize();
+
+		void DrawGenesis();
+		void DrawWorld();
+		void DrawWorldPreUnit();
+		void DrawWorldShadow();
+		void DrawWorldReflection();
+		void DrawWorldRefraction();
+		void DrawScreenEffects();
+		void DrawScreen();
+		void DrawInMiniMap();
+
 //FIXME		void ShockFront(float power, const float3&amp; pos, float areaOfEffect);
 
 	private:
@@ -221,6 +223,8 @@
 		EventClientList listUnitCloaked;
 		EventClientList listUnitDecloaked;
 
+		EventClientList listUnitMoveFailed;
+
 		EventClientList listFeatureCreated;
 		EventClientList listFeatureDestroyed;
 
@@ -234,10 +238,6 @@
 		// unsynced
 		EventClientList listUpdate;
 
-		EventClientList listViewResize;
-
-		EventClientList listDefaultCommand;
-
 		EventClientList listKeyPress;
 		EventClientList listKeyRelease;
 		EventClientList listMouseMove;
@@ -246,6 +246,8 @@
 		EventClientList listMouseWheel;
 		EventClientList listIsAbove;
 		EventClientList listGetTooltip;
+
+		EventClientList listDefaultCommand;
 		EventClientList listConfigCommand;
 		EventClientList listCommandNotify;
 		EventClientList listAddConsoleLine;
@@ -254,6 +256,8 @@
 		EventClientList listWorldTooltip;
 		EventClientList listMapDrawCmd;
 
+		EventClientList listViewResize;
+
 		EventClientList listDrawGenesis;
 		EventClientList listDrawWorld;
 		EventClientList listDrawWorldPreUnit;
@@ -290,26 +294,27 @@
 
 
 #define UNIT_CALLIN_NO_PARAM(name)                                 \
-	inline void CEventHandler:: Unit ## name (const CUnit* unit) \
+	inline void CEventHandler:: name (const CUnit* unit) \
 	{                                                                \
 		const int unitAllyTeam = unit-&gt;allyteam;                       \
-		const int count = listUnit ## name.size();                     \
+		const int count = list ## name.size();                     \
 		for (int i = 0; i &lt; count; i++) {                              \
-			CEventClient* ec = listUnit ## name [i];                       \
+			CEventClient* ec = list ## name [i];                       \
 			if (ec-&gt;CanReadAllyTeam(unitAllyTeam)) {                     \
-				ec-&gt; Unit ## name (unit);                                  \
+				ec-&gt; name (unit);                                  \
 			}                                                            \
 		}                                                              \
 	}
 
-UNIT_CALLIN_NO_PARAM(Finished)
-UNIT_CALLIN_NO_PARAM(Idle)
-UNIT_CALLIN_NO_PARAM(Cloaked)
-UNIT_CALLIN_NO_PARAM(Decloaked)
-UNIT_CALLIN_NO_PARAM(EnteredWater)
-UNIT_CALLIN_NO_PARAM(EnteredAir)
-UNIT_CALLIN_NO_PARAM(LeftWater)
-UNIT_CALLIN_NO_PARAM(LeftAir)
+UNIT_CALLIN_NO_PARAM(UnitFinished)
+UNIT_CALLIN_NO_PARAM(UnitIdle)
+UNIT_CALLIN_NO_PARAM(UnitCloaked)
+UNIT_CALLIN_NO_PARAM(UnitDecloaked)
+UNIT_CALLIN_NO_PARAM(UnitMoveFailed)
+UNIT_CALLIN_NO_PARAM(UnitEnteredWater)
+UNIT_CALLIN_NO_PARAM(UnitEnteredAir)
+UNIT_CALLIN_NO_PARAM(UnitLeftWater)
+UNIT_CALLIN_NO_PARAM(UnitLeftAir)
 
 
 #define UNIT_CALLIN_INT_PARAM(name)                                       \

Modified: trunk/rts/System/Platform/FileSystem.cpp
===================================================================
--- trunk/rts/System/Platform/FileSystem.cpp	2008-07-13 15:39:59 UTC (rev 6165)
+++ trunk/rts/System/Platform/FileSystem.cpp	2008-07-13 16:23:56 UTC (rev 6166)
@@ -390,6 +390,9 @@
 
 bool FileSystem::InReadDir(const std::string&amp; path)
 {
+	if (path.find(&quot;..&quot;) != std::string::npos) {
+		return false; // realpath() would be nice
+	}
 	const std::vector&lt;std::string&gt; readDirs = fs.GetDataDirectories();
 	return true;
 }

Modified: trunk/rts/System/Platform/FileSystem.h
===================================================================
--- trunk/rts/System/Platform/FileSystem.h	2008-07-13 15:39:59 UTC (rev 6165)
+++ trunk/rts/System/Platform/FileSystem.h	2008-07-13 16:23:56 UTC (rev 6166)
@@ -91,6 +91,8 @@
 		std::string glob_to_regex(const std::string&amp; glob) const;
 		std::string&amp; FixSlashes  (std::string&amp; path) const;
 		std::string&amp; ForwardSlashes(std::string&amp; path) const;
+
+		// access check functions
 		bool InReadDir(const std::string&amp; path);
 		bool InWriteDir(const std::string&amp; path, const std::string&amp; prefix = &quot;&quot;);
 


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000945.html">[Taspring-linux-commit] r6165 - trunk/rts/Lua
</A></li>
	<LI>Next message: <A HREF="000947.html">[Taspring-linux-commit] r6167 -	trunk/installer/builddata/springcontent/LuaGadgets
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#946">[ date ]</a>
              <a href="thread.html#946">[ thread ]</a>
              <a href="subject.html#946">[ subject ]</a>
              <a href="author.html#946">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
