<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r6102 - in trunk: . Documentation	rts/ExternalAI rts/Game rts/Game/UI rts/Lua rts/Map	rts/System rts/lib/gml tools/DedicatedServer
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-July/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6102%20-%20in%20trunk%3A%20.%20Documentation%0A%09rts/ExternalAI%20rts/Game%20rts/Game/UI%20rts/Lua%20rts/Map%0A%09rts/System%20rts/lib/gml%20tools/DedicatedServer&In-Reply-To=%3C20080704201333.A2226487A%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000881.html">
   <LINK REL="Next"  HREF="000883.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r6102 - in trunk: . Documentation	rts/ExternalAI rts/Game rts/Game/UI rts/Lua rts/Map	rts/System rts/lib/gml tools/DedicatedServer</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6102%20-%20in%20trunk%3A%20.%20Documentation%0A%09rts/ExternalAI%20rts/Game%20rts/Game/UI%20rts/Lua%20rts/Map%0A%09rts/System%20rts/lib/gml%20tools/DedicatedServer&In-Reply-To=%3C20080704201333.A2226487A%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r6102 - in trunk: . Documentation	rts/ExternalAI rts/Game rts/Game/UI rts/Lua rts/Map	rts/System rts/lib/gml tools/DedicatedServer">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Fri Jul  4 22:13:33 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000881.html">[Taspring-linux-commit] r6101 - in trunk/rts: Sim/Misc	Sim/MoveTypes Sim/MoveTypes/MoveMath Sim/Objects Sim/Path	Sim/Units build/vstudio8
</A></li>
        <LI>Next message: <A HREF="000883.html">[Taspring-linux-commit] r6103 - in trunk/rts: Game Sim/Misc	Sim/MoveTypes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#882">[ date ]</a>
              <a href="thread.html#882">[ thread ]</a>
              <a href="subject.html#882">[ subject ]</a>
              <a href="author.html#882">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: Auswaschbar
Date: 2008-07-04 22:13:30 +0200 (Fri, 04 Jul 2008)
New Revision: 6102

Removed:
   trunk/tools/DedicatedServer/GameSetup.cpp
   trunk/tools/DedicatedServer/GameSetup.h
Modified:
   trunk/CMakeLists.txt
   trunk/Documentation/Spring start.txt
   trunk/rts/ExternalAI/AICallback.cpp
   trunk/rts/Game/Game.cpp
   trunk/rts/Game/GameServer.cpp
   trunk/rts/Game/GameServer.h
   trunk/rts/Game/GameSetup.cpp
   trunk/rts/Game/GameSetupData.h
   trunk/rts/Game/Team.h
   trunk/rts/Game/UI/GameSetupDrawer.cpp
   trunk/rts/Game/UI/StartPosSelecter.cpp
   trunk/rts/Lua/LuaSyncedRead.cpp
   trunk/rts/Map/MapParser.cpp
   trunk/rts/System/GlobalStuff.cpp
   trunk/rts/System/GlobalStuff.h
   trunk/rts/System/SpringApp.cpp
   trunk/rts/lib/gml/gml.cpp
   trunk/tools/DedicatedServer/CMakeLists.txt
Log:
* made CGameSetup store all variables local instead of pushing them to global variables
* deleted copy of CGameSetup from dedicated server
* CTeam now has a readyToStart variable, just like players (was in CGameSetup before)
* NumPlayers tag from startscript is now optional (and only usefull for script debugging)


Modified: trunk/CMakeLists.txt
===================================================================
--- trunk/CMakeLists.txt	2008-07-03 03:12:06 UTC (rev 6101)
+++ trunk/CMakeLists.txt	2008-07-04 20:13:30 UTC (rev 6102)
@@ -6,6 +6,7 @@
 Set(COMPLETE_BUILD true)
 
 Add_Subdirectory(rts)
+Add_Subdirectory(AI)
 Add_Subdirectory(tools/DedicatedServer)
 Add_Subdirectory(tools/unitsync)
 
@@ -15,5 +16,8 @@
 	add_custom_target(gamedata ALL COMMAND call make_gamedata_arch.bat WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/installer)
 endif(UNIX OR CMAKE_CROSSCOMPILING)
 
-install (DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/game/ DESTINATION /opt/spring PATTERN &quot;.svn&quot; EXCLUDE)
+if (NOT CMAKE_INSTALL_PREFIX)
+	set(CMAKE_INSTALL_PREFIX /usr/local/games)
+endif (NOT CMAKE_INSTALL_PREFIX)
+install (DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/game/ DESTINATION ${CMAKE_INSTALL_PREFIX}/spring PATTERN &quot;.svn&quot; EXCLUDE)
 

Modified: trunk/Documentation/Spring start.txt
===================================================================
--- trunk/Documentation/Spring start.txt	2008-07-03 03:12:06 UTC (rev 6101)
+++ trunk/Documentation/Spring start.txt	2008-07-04 20:13:30 UTC (rev 6102)
@@ -53,7 +53,7 @@
 
 	MyPlayerNum=x;      //only variable that should vary between different players
 
-	NumPlayers=x;
+	NumPlayers=x;		// not mandatory, but can be used for debugging purposes
 	NumTeams=y;
 	NumAllyTeams=z;
 

Modified: trunk/rts/ExternalAI/AICallback.cpp
===================================================================
--- trunk/rts/ExternalAI/AICallback.cpp	2008-07-03 03:12:06 UTC (rev 6101)
+++ trunk/rts/ExternalAI/AICallback.cpp	2008-07-04 20:13:30 UTC (rev 6102)
@@ -67,17 +67,17 @@
 
 void CAICallback::SendStartPos(bool ready, float3 startPos)
 {
-	if (startPos.z &lt; gameSetup-&gt;startRectTop[GetMyAllyTeam()] * gs-&gt;mapy * 8)
-		startPos.z = gameSetup-&gt;startRectTop[GetMyAllyTeam()] * gs-&gt;mapy * 8;
+	if(startPos.z&lt;gameSetup-&gt;allyStartingData[gu-&gt;myAllyTeam].startRectTop *gs-&gt;mapy*8)
+		startPos.z=gameSetup-&gt;allyStartingData[gu-&gt;myAllyTeam].startRectTop*gs-&gt;mapy*8;
 
-	if (startPos.z &gt; gameSetup-&gt;startRectBottom[GetMyAllyTeam()] * gs-&gt;mapy * 8)
-		startPos.z = gameSetup-&gt;startRectBottom[GetMyAllyTeam()] * gs-&gt;mapy * 8;
+	if(startPos.z&gt;gameSetup-&gt;allyStartingData[gu-&gt;myAllyTeam].startRectBottom*gs-&gt;mapy*8)
+		startPos.z=gameSetup-&gt;allyStartingData[gu-&gt;myAllyTeam].startRectBottom*gs-&gt;mapy*8;
 
-	if (startPos.x &lt; gameSetup-&gt;startRectLeft[GetMyAllyTeam()] * gs-&gt;mapx * 8)
-		startPos.x = gameSetup-&gt;startRectLeft[GetMyAllyTeam()] * gs-&gt;mapx * 8;
+	if(startPos.x&lt;gameSetup-&gt;allyStartingData[gu-&gt;myAllyTeam].startRectLeft*gs-&gt;mapx*8)
+		startPos.x=gameSetup-&gt;allyStartingData[gu-&gt;myAllyTeam].startRectLeft*gs-&gt;mapx*8;
 
-	if (startPos.x &gt; gameSetup-&gt;startRectRight[GetMyAllyTeam()] * gs-&gt;mapx * 8)
-		startPos.x = gameSetup-&gt;startRectRight[GetMyAllyTeam()] * gs-&gt;mapx * 8;
+	if(startPos.x&gt;gameSetup-&gt;allyStartingData[gu-&gt;myAllyTeam].startRectRight*gs-&gt;mapx*8)
+		startPos.x=gameSetup-&gt;allyStartingData[gu-&gt;myAllyTeam].startRectRight*gs-&gt;mapx*8;
 
 	unsigned char readyness = ready? 1: 0;
 	net-&gt;Send(CBaseNetProtocol::Get().SendStartPos(gu-&gt;myPlayerNum, team, readyness, startPos.x, startPos.y, startPos.z));

Modified: trunk/rts/Game/Game.cpp
===================================================================
--- trunk/rts/Game/Game.cpp	2008-07-03 03:12:06 UTC (rev 6101)
+++ trunk/rts/Game/Game.cpp	2008-07-04 20:13:30 UTC (rev 6102)
@@ -3427,7 +3427,7 @@
 					           *(float*)&amp;inbuf[12]);
 					if (!luaRules || luaRules-&gt;AllowStartPosition(player, pos)) {
 						if (inbuf[3] != 2) {
-							gameSetup-&gt;readyTeams[team] = !!inbuf[3];
+							gs-&gt;Team(team)-&gt;readyToStart = !!inbuf[3];
 						}
 						gs-&gt;Team(team)-&gt;startPos = pos;
 						char label[128];

Modified: trunk/rts/Game/GameServer.cpp
===================================================================
--- trunk/rts/Game/GameServer.cpp	2008-07-03 03:12:06 UTC (rev 6101)
+++ trunk/rts/Game/GameServer.cpp	2008-07-04 20:13:30 UTC (rev 6102)
@@ -1042,7 +1042,7 @@
 			if (teams[a]) // its a player
 				Broadcast(CBaseNetProtocol::Get().SendStartPos(SERVER_PLAYER, a, 1, teams[a]-&gt;startpos.x, teams[a]-&gt;startpos.y, teams[a]-&gt;startpos.z));
 			else // maybe an AI?
-				Broadcast(CBaseNetProtocol::Get().SendStartPos(SERVER_PLAYER, a, 1, setup-&gt;startPos[a].x, setup-&gt;startPos[a].y, setup-&gt;startPos[a].z));
+				Broadcast(CBaseNetProtocol::Get().SendStartPos(SERVER_PLAYER, a, 1, setup-&gt;teamStartingData[a].startPos.x, setup-&gt;teamStartingData[a].startPos.y, setup-&gt;teamStartingData[a].startPos.z));
 		}
 	}
 
@@ -1379,9 +1379,9 @@
 		if (!teams[hisTeam]) // create new team
 		{
 			teams[hisTeam].reset(new GameTeam());
-			teams[hisTeam]-&gt;startpos = setup-&gt;startPos[hisTeam];
+			teams[hisTeam]-&gt;startpos = setup-&gt;teamStartingData[hisTeam].startPos;
 			teams[hisTeam]-&gt;readyToStart = (setup-&gt;startPosType != CGameSetupData::StartPos_ChooseInGame);
-			teams[hisTeam]-&gt;allyTeam = setup-&gt;teamAllyteam[hisTeam];
+			teams[hisTeam]-&gt;allyTeam = setup-&gt;teamStartingData[hisTeam].teamAllyteam;
 		}
 		players[hisNewNumber]-&gt;team = hisTeam;
 		if (!setup-&gt;playerStartingData[hisNewNumber].spectator)

Modified: trunk/rts/Game/GameServer.h
===================================================================
--- trunk/rts/Game/GameServer.h	2008-07-03 03:12:06 UTC (rev 6101)
+++ trunk/rts/Game/GameServer.h	2008-07-04 20:13:30 UTC (rev 6102)
@@ -40,7 +40,7 @@
 	bool readyToStart;
 	float cpuUsage;
 	int ping;
-	
+
 	unsigned team;
 
 	bool isLocal;

Modified: trunk/rts/Game/GameSetup.cpp
===================================================================
--- trunk/rts/Game/GameSetup.cpp	2008-07-03 03:12:06 UTC (rev 6101)
+++ trunk/rts/Game/GameSetup.cpp	2008-07-04 20:13:30 UTC (rev 6102)
@@ -1,17 +1,18 @@
 #include &quot;StdAfx.h&quot;
+
 #include &lt;algorithm&gt;
 #include &lt;cctype&gt;
 #include &lt;SDL_timer.h&gt;
+
+#ifndef DEDICATED
+	#include &quot;Team.h&quot;
+#endif
 #include &quot;GameSetup.h&quot;
-#include &quot;Player.h&quot;
 #include &quot;TdfParser.h&quot;
-#include &quot;Team.h&quot;
 #include &quot;FileSystem/ArchiveScanner.h&quot;
 #include &quot;FileSystem/FileHandler.h&quot;
 #include &quot;FileSystem/VFSHandler.h&quot;
 #include &quot;TdfParser.h&quot;
-#include &quot;Lua/LuaGaia.h&quot;
-#include &quot;Lua/LuaRules.h&quot;
 #include &quot;Lua/LuaParser.h&quot;
 #include &quot;Map/MapParser.h&quot;
 #include &quot;Map/ReadMap.h&quot;
@@ -74,7 +75,6 @@
 /**
 @brief Load startpositions from map
 @pre mapName, numTeams, teamStartNum initialized and the map loaded (LoadMap())
<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">- at todo</A> don't store in global variables directly
  */
 void CGameSetup::LoadStartPositionsFromMap()
 {
@@ -83,8 +83,7 @@
 	for(int a = 0; a &lt; numTeams; ++a) {
 		float3 pos(1000.0f, 100.0f, 1000.0f);
 		mapParser.GetStartPos(a, pos);
-		gs-&gt;Team(a)-&gt;startPos = pos;
-		startPos[a] = SFloat3(pos.x, pos.y, pos.z);
+		teamStartingData[a].startPos = SFloat3(pos.x, pos.y, pos.z);
 	}
 }
 
@@ -92,7 +91,6 @@
 @brief Load startpositions from map/script
 @pre numTeams and startPosType initialized
 @post readyTeams, teamStartNum and team start positions initialized
<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">- at todo</A> don't store in global variables directly
 
 Unlike the other functions, this is not called on Init() , instead we wait for CPreGame to call this. The reason is that the map is not known before CPreGame recieves the gamedata from the server.
  */
@@ -102,15 +100,20 @@
 	file.LoadBuffer(gameSetupText, gameSetupTextLength-1);
 	for (int a = 0; a &lt; numTeams; ++a) {
 		// Ready up automatically unless startPosType is choose in game
-		readyTeams[a] = (startPosType != StartPos_ChooseInGame);
-		teamStartNum[a] = a;
+		//teamStartingData[a].readyTeams = (startPosType != StartPos_ChooseInGame);
+		teamStartingData[a].teamStartNum = a;
 	}
 
 	if (startPosType == StartPos_Random) {
 		// Server syncs these later, so we can use unsynced rng
 		UnsyncedRNG rng;
 		rng.Seed(gameSetupTextLength ^ SDL_GetTicks());
+		int teamStartNum[MAX_TEAMS];
+		for (int i = 0; i &lt; MAX_TEAMS; ++i)
+			teamStartNum[i] = i;
 		std::random_shuffle(&amp;teamStartNum[0], &amp;teamStartNum[numTeams], rng);
+		for (int i = 0; i &lt; MAX_TEAMS; ++i)
+			teamStartingData[i].teamStartNum = teamStartNum[i];
 	}
 
 	LoadStartPositionsFromMap();
@@ -118,8 +121,7 @@
 	// Show that we havent selected start pos yet
 	if (startPosType == StartPos_ChooseInGame) {
 		for (int a = 0; a &lt; numTeams; ++a) {
-			gs-&gt;Team(a)-&gt;startPos.y = -500;
-			startPos[a].y = -500;
+			teamStartingData[a].startPos.y = -500;
 		}
 	}
 
@@ -133,13 +135,11 @@
 			std::string zpos = file.SGetValueDef(&quot;&quot;, s + &quot;StartPosZ&quot;);
 			if (!xpos.empty())
 			{
-				gs-&gt;Team(a)-&gt;startPos.x = atoi(xpos.c_str());
-				startPos[a].x = gs-&gt;Team(a)-&gt;startPos.x;
+				teamStartingData[a].startPos.x = atoi(xpos.c_str());
 			}
 			if (!zpos.empty())
 			{
-				gs-&gt;Team(a)-&gt;startPos.z = atoi(zpos.c_str());
-				startPos[a].z = gs-&gt;Team(a)-&gt;startPos.z;
+				teamStartingData[a].startPos.z = atoi(zpos.c_str());
 			}
 		}
 	}
@@ -149,7 +149,6 @@
 @brief Load players and remove gaps in the player numbering.
 @pre numPlayers initialized
 @post players loaded, numDemoPlayers initialized
<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">- at todo</A> don't store in global variables directly
  */
 void CGameSetup::LoadPlayers(const TdfParser&amp; file)
 {
@@ -168,14 +167,13 @@
 		}
 
 		// expects lines of form team=x rather than team=TEAMx
-		// team field is relocated in RemapTeams
-		gs-&gt;players[i]-&gt;team = atoi(file.SGetValueDef(&quot;0&quot;,   s + &quot;team&quot;).c_str());
-		playerStartingData[i].team = unsigned(gs-&gt;players[i]-&gt;team);
-		gs-&gt;players[i]-&gt;rank = atoi(file.SGetValueDef(&quot;-1&quot;,  s + &quot;rank&quot;).c_str());
-		gs-&gt;players[i]-&gt;playerName  = file.SGetValueDef(&quot;no name&quot;, s + &quot;name&quot;);
-		gs-&gt;players[i]-&gt;countryCode = file.SGetValueDef(&quot;&quot;,  s + &quot;countryCode&quot;);
-		gs-&gt;players[i]-&gt;spectator = !!atoi(file.SGetValueDef(&quot;0&quot;, s + &quot;spectator&quot;).c_str());
-		playerStartingData[i].spectator = gs-&gt;players[i]-&gt;spectator;
+		// team field is relocated in RemapTeams		
+		playerStartingData[i].team = static_cast&lt;unsigned&gt;(atoi(file.SGetValueDef(&quot;0&quot;,   s + &quot;team&quot;).c_str()));
+		playerStartingData[i].rank = atoi(file.SGetValueDef(&quot;-1&quot;,  s + &quot;rank&quot;).c_str());
+		playerStartingData[i].name  = file.SGetValueDef(&quot;no name&quot;, s + &quot;name&quot;);
+		playerStartingData[i].countryCode = file.SGetValueDef(&quot;&quot;,  s + &quot;countryCode&quot;);
+		playerStartingData[i].spectator = static_cast&lt;bool&gt;(atoi(file.SGetValueDef(&quot;0&quot;, s + &quot;spectator&quot;).c_str()));
+		playerStartingData[i].isFromDemo = static_cast&lt;bool&gt;(atoi(file.SGetValueDef(&quot;0&quot;,  s + &quot;IsFromDemo&quot;).c_str()));
 
 		int fromDemo;
 		file.GetDef(fromDemo, &quot;0&quot;, s + &quot;IsFromDemo&quot;);
@@ -186,7 +184,12 @@
 		++i;
 	}
 
-	if (playerRemap.size() != numPlayers)
+	int playerCount = -1;
+	file.GetDef(playerCount,   &quot;-1&quot;, &quot;GAME\\NumPlayers&quot;);
+	
+	if (playerCount == -1 || playerRemap.size() == playerCount)
+		numPlayers = playerRemap.size();
+	else
 		throw content_error(&quot;incorrect number of players in GameSetup script&quot;);
 }
 
@@ -194,7 +197,6 @@
 @brief Load teams and remove gaps in the team numbering.
 @pre numTeams, hostDemo initialized
 @post teams loaded
<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">- at todo</A> don't store in global variables directly
  */
 void CGameSetup::LoadTeams(const TdfParser&amp; file)
 {
@@ -217,37 +219,30 @@
 		// Read RGBColor, this overrides color if both had been set.
 		float3 color = file.GetFloat3(defaultCol, s + &quot;rgbcolor&quot;);
 		for (int b = 0; b &lt; 3; ++b) {
-			gs-&gt;Team(i)-&gt;color[b] = int(color[b] * 255);
+			teamStartingData[i].color[b] = int(color[b] * 255);
 		}
-		gs-&gt;Team(i)-&gt;color[3] = 255;
+		teamStartingData[i].color[3] = 255;
 
-		gs-&gt;Team(i)-&gt;handicap = atof(file.SGetValueDef(&quot;0&quot;, s + &quot;handicap&quot;).c_str()) / 100 + 1;
-		// leader field is relocated in RemapPlayers
-		gs-&gt;Team(i)-&gt;leader = atoi(file.SGetValueDef(&quot;0&quot;, s + &quot;teamleader&quot;).c_str());
-		gs-&gt;Team(i)-&gt;side = StringToLower(file.SGetValueDef(&quot;arm&quot;, s + &quot;side&quot;).c_str());
-		// allyteam field is relocated in RemapAllyteams
-		gs-&gt;SetAllyTeam(i, atoi(file.SGetValueDef(&quot;0&quot;, s + &quot;allyteam&quot;).c_str()));
-		teamAllyteam[i] = atoi(file.SGetValueDef(&quot;0&quot;, s + &quot;allyteam&quot;).c_str());
+		teamStartingData[i].handicap = atof(file.SGetValueDef(&quot;0&quot;, s + &quot;handicap&quot;).c_str()) / 100 + 1;
+		teamStartingData[i].leader = atoi(file.SGetValueDef(&quot;0&quot;, s + &quot;teamleader&quot;).c_str());
+		teamStartingData[i].side = StringToLower(file.SGetValueDef(&quot;arm&quot;, s + &quot;side&quot;).c_str());
+		teamStartingData[i].teamAllyteam = atoi(file.SGetValueDef(&quot;0&quot;, s + &quot;allyteam&quot;).c_str());
 
 		// Is this team (Lua) AI controlled?
 		// If this is a demo replay, non-Lua AIs aren't loaded.
 		const string aiDll = file.SGetValueDef(&quot;&quot;, s + &quot;aidll&quot;);
-		if (aiDll.substr(0, 6) == &quot;LuaAI:&quot;) {
-			gs-&gt;Team(i)-&gt;luaAI = aiDll.substr(6);
-		}
-		else {
-			if (hostDemo) {
-				gs-&gt;Team(i)-&gt;dllAI = &quot;&quot;;
-			} else {
-				gs-&gt;Team(i)-&gt;dllAI = aiDll;
-			}
-		}
+		teamStartingData[i].aiDll = aiDll;
 
 		teamRemap[a] = i;
 		++i;
 	}
 
-	if (teamRemap.size() != numTeams)
+	int teamCount = -1;
+	file.GetDef(teamCount,   &quot;-1&quot;, &quot;GAME\\NumTeams&quot;);
+	
+	if (teamCount == -1 || teamRemap.size() == teamCount)
+		numTeams = teamRemap.size();
+	else
 		throw content_error(&quot;incorrect number of teams in GameSetup script&quot;);
 }
 
@@ -255,7 +250,6 @@
 @brief Load allyteams and remove gaps in the allyteam numbering.
 @pre numAllyTeams initialized
 @post allyteams loaded
<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">- at todo</A> don't store in global variables directly
 */
 void CGameSetup::LoadAllyTeams(const TdfParser&amp; file)
 {
@@ -269,10 +263,10 @@
 		if (!file.SectionExist(s.substr(0, s.length() - 1)))
 			continue;
 
-		startRectTop[i]    = atof(file.SGetValueDef(&quot;0&quot;, s + &quot;StartRectTop&quot;).c_str());
-		startRectBottom[i] = atof(file.SGetValueDef(&quot;1&quot;, s + &quot;StartRectBottom&quot;).c_str());
-		startRectLeft[i]   = atof(file.SGetValueDef(&quot;0&quot;, s + &quot;StartRectLeft&quot;).c_str());
-		startRectRight[i]  = atof(file.SGetValueDef(&quot;1&quot;, s + &quot;StartRectRight&quot;).c_str());
+		allyStartingData[i].startRectTop    = atof(file.SGetValueDef(&quot;0&quot;, s + &quot;StartRectTop&quot;).c_str());
+		allyStartingData[i].startRectBottom = atof(file.SGetValueDef(&quot;1&quot;, s + &quot;StartRectBottom&quot;).c_str());
+		allyStartingData[i].startRectLeft   = atof(file.SGetValueDef(&quot;0&quot;, s + &quot;StartRectLeft&quot;).c_str());
+		allyStartingData[i].startRectRight  = atof(file.SGetValueDef(&quot;1&quot;, s + &quot;StartRectRight&quot;).c_str());
 
 		int numAllies = atoi(file.SGetValueDef(&quot;0&quot;, s + &quot;NumAllies&quot;).c_str());
 
@@ -280,7 +274,7 @@
 			char key[100];
 			sprintf(key, &quot;GAME\\ALLYTEAM%i\\Ally%i&quot;, a, b);
 			int other = atoi(file.SGetValueDef(&quot;0&quot;,key).c_str());
-			gs-&gt;SetAlly(a, other, true); // relocated in RemapAllyteams
+			allyStartingData[i].allies[other] = true;
 		}
 
 		allyteamRemap[a] = i;
@@ -297,10 +291,10 @@
 {
 	// relocate Team.TeamLeader field
 	for (int a = 0; a &lt; numTeams; ++a) {
-		if (playerRemap.find(gs-&gt;Team(a)-&gt;leader) == playerRemap.end()) {
+		if (playerRemap.find(teamStartingData[a].leader) == playerRemap.end()) {
 			throw content_error(&quot;invalid Team.TeamLeader in GameSetup script&quot;);
 		};
-		gs-&gt;Team(a)-&gt;leader = playerRemap[gs-&gt;Team(a)-&gt;leader];
+		teamStartingData[a].leader = playerRemap[teamStartingData[a].leader];
 	}
 
 	// relocate myPlayerNum
@@ -315,9 +309,8 @@
 {
 	// relocate Player.Team field
 	for (int a = 0; a &lt; numPlayers; ++a) {
-		if (teamRemap.find(gs-&gt;players[a]-&gt;team) == teamRemap.end())
+		if (teamRemap.find(playerStartingData[a].team) == teamRemap.end())
 			throw content_error(&quot;invalid Player.Team in GameSetup script&quot;);
-		gs-&gt;players[a]-&gt;team = teamRemap[gs-&gt;players[a]-&gt;team];
 		playerStartingData[a].team = teamRemap[playerStartingData[a].team];
 	}
 }
@@ -327,11 +320,10 @@
 {
 	// relocate Team.Allyteam field
 	for (int a = 0; a &lt; numTeams; ++a) {
-		if (allyteamRemap.find(gs-&gt;AllyTeam(a)) == allyteamRemap.end()) {
+		if (allyteamRemap.find(teamStartingData[a].teamAllyteam) == allyteamRemap.end()) {
 			throw content_error(&quot;invalid Team.Allyteam in GameSetup script&quot;);
 		}
-		gs-&gt;SetAllyTeam(a, allyteamRemap[gs-&gt;AllyTeam(a)]);
-		teamAllyteam[a] = allyteamRemap[teamAllyteam[a]];
+		teamStartingData[a].teamAllyteam = allyteamRemap[teamStartingData[a].teamAllyteam];
 	}
 
 	// relocate gs-&gt;allies matrix
@@ -339,7 +331,7 @@
 		for (int b = 0; b &lt; MAX_TEAMS; ++b) {
 			if (allyteamRemap.find(a) != allyteamRemap.end() &amp;&amp;
 				allyteamRemap.find(b) != allyteamRemap.end()) {
-				gs-&gt;SetAlly(allyteamRemap[a], allyteamRemap[b], gs-&gt;Ally(a, b));
+				allyStartingData[allyteamRemap[a]].allies[allyteamRemap[b]] = allyStartingData[a].allies[b];
 			}
 		}
 	}
@@ -371,6 +363,10 @@
 	baseMod     = file.SGetValueDef(&quot;&quot;,  &quot;GAME\\Gametype&quot;);
 	mapName     = file.SGetValueDef(&quot;&quot;,  &quot;GAME\\MapName&quot;);
 	luaGaiaStr  = file.SGetValueDef(&quot;1&quot;, &quot;GAME\\LuaGaia&quot;);
+	if (luaGaiaStr == &quot;0&quot;)
+		useLuaGaia = false;
+	else
+		useLuaGaia = true;
 	luaRulesStr = file.SGetValueDef(&quot;1&quot;, &quot;GAME\\LuaRules&quot;);
 	saveName    = file.SGetValueDef(&quot;&quot;,  &quot;GAME\\Savefile&quot;);
 	demoName    = file.SGetValueDef(&quot;&quot;,  &quot;GAME\\Demofile&quot;);
@@ -390,8 +386,6 @@
 	file.GetDef(minSpeed, &quot;0.3&quot;, &quot;GAME\\MinSpeed&quot;);
 
 	file.GetDef(myPlayerNum,  &quot;0&quot;, &quot;GAME\\MyPlayerNum&quot;);
-	file.GetDef(numPlayers,   &quot;2&quot;, &quot;GAME\\NumPlayers&quot;);
-	file.GetDef(numTeams,     &quot;2&quot;, &quot;GAME\\NumTeams&quot;);
 	file.GetDef(numAllyTeams, &quot;2&quot;, &quot;GAME\\NumAllyTeams&quot;);
 	file.GetDef(fixedAllies, &quot;1&quot;, &quot;GAME\\FixedAllies&quot;);
 
@@ -425,54 +419,6 @@
 	// Postprocessing
 	baseMod = archiveScanner-&gt;ModArchiveToModName(baseMod);
 
-	gu-&gt;myPlayerNum = myPlayerNum;
-	gu-&gt;myTeam = gs-&gt;players[myPlayerNum]-&gt;team;
-	gu-&gt;myAllyTeam = gs-&gt;AllyTeam(gu-&gt;myTeam);
-
-	gu-&gt;spectating = gs-&gt;players[myPlayerNum]-&gt;spectator;
-	gu-&gt;spectatingFullView   = gu-&gt;spectating;
-	gu-&gt;spectatingFullSelect = gu-&gt;spectating;
-
-	gs-&gt;gameMode = gameMode;
-	gs-&gt;noHelperAIs = !!noHelperAIs;
-
-	gs-&gt;useLuaGaia  = CLuaGaia::SetConfigString(luaGaiaStr);
-	gs-&gt;useLuaRules = CLuaRules::SetConfigString(luaRulesStr);
-
-	gs-&gt;activeTeams = numTeams;
-	gs-&gt;activeAllyTeams = numAllyTeams;
-
-	if (gs-&gt;useLuaGaia) {
-		// Gaia adjustments
-		gs-&gt;gaiaTeamID = gs-&gt;activeTeams;
-		gs-&gt;gaiaAllyTeamID = gs-&gt;activeAllyTeams;
-		gs-&gt;activeTeams++;
-		gs-&gt;activeAllyTeams++;
-		teamStartNum[gs-&gt;gaiaTeamID] = gs-&gt;gaiaTeamID;
-
-		// Setup the gaia team
-		CTeam* team = gs-&gt;Team(gs-&gt;gaiaTeamID);
-		team-&gt;color[0] = 255;
-		team-&gt;color[1] = 255;
-		team-&gt;color[2] = 255;
-		team-&gt;color[3] = 255;
-		team-&gt;gaia = true;
-		readyTeams[gs-&gt;gaiaTeamID] = true;
-		gs-&gt;players[numPlayers]-&gt;team = gs-&gt;gaiaTeamID;
-		gs-&gt;SetAllyTeam(gs-&gt;gaiaTeamID, gs-&gt;gaiaAllyTeamID);
-	}
-
-	for(int a = 0; a &lt; gs-&gt;activeTeams; ++a) {
-		gs-&gt;Team(a)-&gt;metal = startMetal;
-		gs-&gt;Team(a)-&gt;metalIncome = startMetal; // for the endgame statistics
-
-		gs-&gt;Team(a)-&gt;energy = startEnergy;
-		gs-&gt;Team(a)-&gt;energyIncome = startEnergy;
-	}
-
-	assert(gs-&gt;activeTeams &lt;= MAX_TEAMS);
-	assert(gs-&gt;activeAllyTeams &lt;= MAX_TEAMS);
-
 	return true;
 }
 

Modified: trunk/rts/Game/GameSetupData.h
===================================================================
--- trunk/rts/Game/GameSetupData.h	2008-07-03 03:12:06 UTC (rev 6101)
+++ trunk/rts/Game/GameSetupData.h	2008-07-04 20:13:30 UTC (rev 6102)
@@ -31,6 +31,7 @@
 	std::string mapName;
 	std::string baseMod;
 	std::string scriptName;
+	bool useLuaGaia;
 	std::string luaGaiaStr;
 	std::string luaRulesStr;
 	
@@ -49,21 +50,39 @@
 	struct PlayerData
 	{
 		unsigned team;
+		int rank;
+		std::string name;
+		std::string countryCode;
 		bool spectator;
+		bool isFromDemo;
 	};
 	PlayerData playerStartingData[MAX_PLAYERS];
-	/// Initial startposition (read-only)
-	SFloat3 startPos[MAX_TEAMS];
-	bool readyTeams[MAX_TEAMS];
-	int teamStartNum[MAX_TEAMS];
-	int teamAllyteam[MAX_TEAMS];
-	float startRectTop[MAX_TEAMS];
-	float startRectBottom[MAX_TEAMS];
-	float startRectLeft[MAX_TEAMS];
-	float startRectRight[MAX_TEAMS];
 	
+	struct TeamData
+	{
+		unsigned leader;
+		unsigned char color[4];
+		float handicap;
+		std::string side;
+		SFloat3 startPos;
+		int teamStartNum;
+		int teamAllyteam;
+		std::string aiDll;
+	};
+	TeamData teamStartingData[MAX_TEAMS];
+	
+	struct AllyTeamData
+	{
+		float startRectTop;
+		float startRectBottom;
+		float startRectLeft;
+		float startRectRight;
+		bool allies[MAX_TEAMS];
+	};
+	AllyTeamData allyStartingData[MAX_TEAMS];
+	
 	std::map&lt;std::string, int&gt; restrictedUnits;
-	
+
 	std::map&lt;std::string, std::string&gt; mapOptions;
 	std::map&lt;std::string, std::string&gt; modOptions;
 	

Modified: trunk/rts/Game/Team.h
===================================================================
--- trunk/rts/Game/Team.h	2008-07-03 03:12:06 UTC (rev 6101)
+++ trunk/rts/Game/Team.h	2008-07-04 20:13:30 UTC (rev 6102)
@@ -52,6 +52,7 @@
 	void RemoveUnit(CUnit* unit,RemoveType type);
 
 	int teamNum;
+	bool readyToStart;
 	bool isDead;
 	bool gaia;
 	int leader;

Modified: trunk/rts/Game/UI/GameSetupDrawer.cpp
===================================================================
--- trunk/rts/Game/UI/GameSetupDrawer.cpp	2008-07-03 03:12:06 UTC (rev 6101)
+++ trunk/rts/Game/UI/GameSetupDrawer.cpp	2008-07-04 20:13:30 UTC (rev 6102)
@@ -10,6 +10,7 @@
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;../CameraHandler.h&quot;
 #include &quot;../Player.h&quot;
+#include &quot;../Team.h&quot;
 #include &quot;../GameSetup.h&quot;
 #include &quot;StartPosSelecter.h&quot;
 #include &quot;Lua/LuaCallInHandler.h&quot;
@@ -85,7 +86,7 @@
 		char buf[64];
 		sprintf(buf, &quot;Starting in %i&quot;, readyCountdown / 1000);
 		state = buf;
-	} else if (!gameSetup-&gt;readyTeams[gu-&gt;myTeam]) {
+	} else if (!gs-&gt;Team(gu-&gt;myTeam)-&gt;readyToStart) {
 		state = &quot;Choose start pos&quot;;
 	} else if (gu-&gt;myPlayerNum==0) {
 		state = &quot;Waiting for players, Ctrl+Return to force start&quot;;
@@ -98,7 +99,7 @@
 	for (int a = 0; a &lt; gameSetup-&gt;numPlayers; a++) {
 		if (!gs-&gt;players[a]-&gt;readyToStart) {
 			playerStates[a] = &quot;missing&quot;;
-		} else if (!gameSetup-&gt;readyTeams[gs-&gt;players[a]-&gt;team]) {
+		} else if (!gs-&gt;Team(gs-&gt;players[a]-&gt;team)-&gt;readyToStart) {
 			playerStates[a] = &quot;notready&quot;;
 		} else {
 			playerStates[a] = &quot;ready&quot;;
@@ -133,7 +134,7 @@
 			color = white; //blue;
 		} else if (!gs-&gt;players[a]-&gt;readyToStart) {
 			color = red;
-		} else if (!gameSetup-&gt;readyTeams[gs-&gt;players[a]-&gt;team]) {
+		} else if (!gs-&gt;Team(gs-&gt;players[a]-&gt;team)-&gt;readyToStart) {
 			color = yellow;
 		} else {
 			color = green;

Modified: trunk/rts/Game/UI/StartPosSelecter.cpp
===================================================================
--- trunk/rts/Game/UI/StartPosSelecter.cpp	2008-07-03 03:12:06 UTC (rev 6101)
+++ trunk/rts/Game/UI/StartPosSelecter.cpp	2008-07-04 20:13:30 UTC (rev 6102)
@@ -60,17 +60,17 @@
 	inMapDrawer-&gt;SendErase(startPos);
 	startPos = camera-&gt;pos + mouse-&gt;dir * dist;
 
-	if(startPos.z&lt;gameSetup-&gt;startRectTop[gu-&gt;myAllyTeam]*gs-&gt;mapy*8)
-		startPos.z=gameSetup-&gt;startRectTop[gu-&gt;myAllyTeam]*gs-&gt;mapy*8;
+	if(startPos.z&lt;gameSetup-&gt;allyStartingData[gu-&gt;myAllyTeam].startRectTop *gs-&gt;mapy*8)
+		startPos.z=gameSetup-&gt;allyStartingData[gu-&gt;myAllyTeam].startRectTop*gs-&gt;mapy*8;
 
-	if(startPos.z&gt;gameSetup-&gt;startRectBottom[gu-&gt;myAllyTeam]*gs-&gt;mapy*8)
-		startPos.z=gameSetup-&gt;startRectBottom[gu-&gt;myAllyTeam]*gs-&gt;mapy*8;
+	if(startPos.z&gt;gameSetup-&gt;allyStartingData[gu-&gt;myAllyTeam].startRectBottom*gs-&gt;mapy*8)
+		startPos.z=gameSetup-&gt;allyStartingData[gu-&gt;myAllyTeam].startRectBottom*gs-&gt;mapy*8;
 
-	if(startPos.x&lt;gameSetup-&gt;startRectLeft[gu-&gt;myAllyTeam]*gs-&gt;mapx*8)
-		startPos.x=gameSetup-&gt;startRectLeft[gu-&gt;myAllyTeam]*gs-&gt;mapx*8;
+	if(startPos.x&lt;gameSetup-&gt;allyStartingData[gu-&gt;myAllyTeam].startRectLeft*gs-&gt;mapx*8)
+		startPos.x=gameSetup-&gt;allyStartingData[gu-&gt;myAllyTeam].startRectLeft*gs-&gt;mapx*8;
 
-	if(startPos.x&gt;gameSetup-&gt;startRectRight[gu-&gt;myAllyTeam]*gs-&gt;mapx*8)
-		startPos.x=gameSetup-&gt;startRectRight[gu-&gt;myAllyTeam]*gs-&gt;mapx*8;
+	if(startPos.x&gt;gameSetup-&gt;allyStartingData[gu-&gt;myAllyTeam].startRectRight*gs-&gt;mapx*8)
+		startPos.x=gameSetup-&gt;allyStartingData[gu-&gt;myAllyTeam].startRectRight*gs-&gt;mapx*8;
 
 	net-&gt;Send(CBaseNetProtocol::Get().SendStartPos(gu-&gt;myPlayerNum, gu-&gt;myTeam, 0, startPos.x, startPos.y, startPos.z));
 
@@ -93,11 +93,11 @@
 	glDisable(GL_TEXTURE_2D);
 	glEnable(GL_DEPTH_TEST);
 	glBegin(GL_QUADS);
-	float by=gameSetup-&gt;startRectTop[gu-&gt;myAllyTeam]*gs-&gt;mapy*8;
-	float bx=gameSetup-&gt;startRectLeft[gu-&gt;myAllyTeam]*gs-&gt;mapx*8;
+	float by= gameSetup-&gt;allyStartingData[gu-&gt;myAllyTeam].startRectTop *gs-&gt;mapy*8;
+	float bx= gameSetup-&gt;allyStartingData[gu-&gt;myAllyTeam].startRectLeft *gs-&gt;mapx*8;
 
-	float dy=(gameSetup-&gt;startRectBottom[gu-&gt;myAllyTeam]-gameSetup-&gt;startRectTop[gu-&gt;myAllyTeam])*gs-&gt;mapy*8/10;
-	float dx=(gameSetup-&gt;startRectRight[gu-&gt;myAllyTeam]-gameSetup-&gt;startRectLeft[gu-&gt;myAllyTeam])*gs-&gt;mapx*8/10;
+	float dy = (gameSetup-&gt;allyStartingData[gu-&gt;myAllyTeam].startRectBottom - gameSetup-&gt;allyStartingData[gu-&gt;myAllyTeam].startRectTop) *gs-&gt;mapy*8/10;
+	float dx = (gameSetup-&gt;allyStartingData[gu-&gt;myAllyTeam].startRectRight - gameSetup-&gt;allyStartingData[gu-&gt;myAllyTeam].startRectLeft) *gs-&gt;mapx*8/10;
 
 	for(int a=0;a&lt;10;++a){	//draw start rect restrictions
 		float3 pos1(bx+a*dx,0,by);

Modified: trunk/rts/Lua/LuaSyncedRead.cpp
===================================================================
--- trunk/rts/Lua/LuaSyncedRead.cpp	2008-07-03 03:12:06 UTC (rev 6101)
+++ trunk/rts/Lua/LuaSyncedRead.cpp	2008-07-04 20:13:30 UTC (rev 6102)
@@ -868,10 +868,10 @@
 	if ((allyTeam &lt; 0) || (allyTeam &gt;= gs-&gt;activeAllyTeams)) {
 		luaL_error(L, &quot;Bad allyTeam (%i) in GetAllyTeamStartBox()&quot;, allyTeam);
 	}
-	const float xmin = (gs-&gt;mapx * 8.0f) * gameSetup-&gt;startRectLeft[allyTeam];
-	const float zmin = (gs-&gt;mapy * 8.0f) * gameSetup-&gt;startRectTop[allyTeam];
-	const float xmax = (gs-&gt;mapx * 8.0f) * gameSetup-&gt;startRectRight[allyTeam];
-	const float zmax = (gs-&gt;mapy * 8.0f) * gameSetup-&gt;startRectBottom[allyTeam];
+	const float xmin = (gs-&gt;mapx * 8.0f) * gameSetup-&gt;allyStartingData[allyTeam].startRectLeft;
+	const float zmin = (gs-&gt;mapy * 8.0f) * gameSetup-&gt;allyStartingData[allyTeam].startRectTop;
+	const float xmax = (gs-&gt;mapx * 8.0f) * gameSetup-&gt;allyStartingData[allyTeam].startRectRight;
+	const float zmax = (gs-&gt;mapy * 8.0f) * gameSetup-&gt;allyStartingData[allyTeam].startRectBottom;
 	lua_pushnumber(L, xmin);
 	lua_pushnumber(L, zmin);
 	lua_pushnumber(L, xmax);

Modified: trunk/rts/Map/MapParser.cpp
===================================================================
--- trunk/rts/Map/MapParser.cpp	2008-07-03 03:12:06 UTC (rev 6101)
+++ trunk/rts/Map/MapParser.cpp	2008-07-04 20:13:30 UTC (rev 6102)
@@ -41,7 +41,7 @@
 	parser-&gt;AddString(&quot;fullName&quot;, &quot;maps/&quot; + mapName);
 	parser-&gt;AddString(&quot;configFile&quot;, mapConfig);
 	parser-&gt;EndTable();
-#ifndef UNITSYNC
+#if !defined UNITSYNC &amp;&amp; !defined DEDICATED
 	// this should not be included with unitsync:
 	// 1. avoids linkage with LuaSyncedRead
 	// 2. MapOptions are not valid during unitsync map parsing

Modified: trunk/rts/System/GlobalStuff.cpp
===================================================================
--- trunk/rts/System/GlobalStuff.cpp	2008-07-03 03:12:06 UTC (rev 6101)
+++ trunk/rts/System/GlobalStuff.cpp	2008-07-04 20:13:30 UTC (rev 6102)
@@ -6,12 +6,16 @@
  * unsynced global stuff
  */
 #include &quot;StdAfx.h&quot;
+#include &lt;cstring&gt;
 #include &quot;Sim/Projectiles/ProjectileHandler.h&quot;
 #include &quot;Game/GameHelper.h&quot;
+#include &quot;Game/GameSetupData.h&quot;
 #include &quot;Sync/SyncTracer.h&quot;
 #include &quot;Game/Team.h&quot;
 #include &quot;Game/Player.h&quot;
 #include &quot;Rendering/Textures/TAPalette.h&quot;
+#include &quot;Lua/LuaGaia.h&quot;
+#include &quot;Lua/LuaRules.h&quot;
 #include &quot;SDL_types.h&quot;
 #include &quot;SDL_timer.h&quot;
 #include &quot;mmgr.h&quot;
@@ -147,6 +151,82 @@
 	}
 }
 
+void CGlobalSyncedStuff::LoadFromSetup(const CGameSetupData* setup)
+{
+	gameMode = setup-&gt;gameMode;
+	noHelperAIs = !!setup-&gt;noHelperAIs;
+
+	useLuaGaia  = CLuaGaia::SetConfigString(setup-&gt;luaGaiaStr);
+	useLuaRules = CLuaRules::SetConfigString(setup-&gt;luaRulesStr);
+
+	activeTeams = setup-&gt;numTeams;
+	activeAllyTeams = setup-&gt;numAllyTeams;
+	
+	assert(activeTeams &lt;= MAX_TEAMS);
+	assert(activeAllyTeams &lt;= MAX_TEAMS);
+	
+	for (unsigned i = 0; i &lt; static_cast&lt;unsigned&gt;(setup-&gt;numPlayers); ++i)
+	{
+		gs-&gt;players[i]-&gt;team = setup-&gt;playerStartingData[i].team;
+		gs-&gt;players[i]-&gt;rank = setup-&gt;playerStartingData[i].rank;
+		gs-&gt;players[i]-&gt;playerName  = setup-&gt;playerStartingData[i].name;
+		gs-&gt;players[i]-&gt;countryCode = setup-&gt;playerStartingData[i].countryCode;
+		gs-&gt;players[i]-&gt;spectator = setup-&gt;playerStartingData[i].spectator;
+	}
+	
+	for (unsigned i = 0; i &lt; static_cast&lt;unsigned&gt;(activeTeams); ++i)
+	{
+		teams[i]-&gt;metal = setup-&gt;startMetal;
+		teams[i]-&gt;metalIncome = setup-&gt;startMetal; // for the endgame statistics
+
+		teams[i]-&gt;energy = setup-&gt;startEnergy;
+		teams[i]-&gt;energyIncome = setup-&gt;startEnergy;
+
+		teams[i]-&gt;startPos.x = setup-&gt;teamStartingData[i].startPos.x;
+		teams[i]-&gt;startPos.y = setup-&gt;teamStartingData[i].startPos.y;
+		teams[i]-&gt;startPos.z = setup-&gt;teamStartingData[i].startPos.z;
+		teams[i]-&gt;readyToStart = (setup-&gt;startPosType != CGameSetupData::StartPos_ChooseInGame);
+		std::memcpy(teams[i]-&gt;color, setup-&gt;teamStartingData[i].color, 4);
+		teams[i]-&gt;handicap = setup-&gt;teamStartingData[i].handicap;
+		teams[i]-&gt;leader = setup-&gt;teamStartingData[i].leader;
+		teams[i]-&gt;side = setup-&gt;teamStartingData[i].side;
+		SetAllyTeam(i, setup-&gt;teamStartingData[i].teamAllyteam);
+		if (setup-&gt;teamStartingData[i].aiDll.substr(0, 6) == &quot;LuaAI:&quot;) {
+			gs-&gt;Team(i)-&gt;luaAI = setup-&gt;teamStartingData[i].aiDll.substr(6);
+		}
+		else {
+			if (setup-&gt;hostDemo)
+				teams[i]-&gt;dllAI = &quot;&quot;;
+			else
+				teams[i]-&gt;dllAI = setup-&gt;teamStartingData[i].aiDll;
+		}
+		for (unsigned t = 0; t &lt; static_cast&lt;unsigned&gt;(MAX_TEAMS); ++t)
+		{
+			allies[i][t] = setup-&gt;allyStartingData[i].allies[t];
+		}
+	}
+
+	if (useLuaGaia) {
+		//TODO duplicated in SpringApp::CreateGameSetup()
+		// Gaia adjustments
+		gaiaTeamID = activeTeams;
+		gaiaAllyTeamID = activeAllyTeams;
+		activeTeams++;
+		activeAllyTeams++;
+
+		// Setup the gaia team
+		CTeam* team = gs-&gt;Team(gs-&gt;gaiaTeamID);
+		team-&gt;color[0] = 255;
+		team-&gt;color[1] = 255;
+		team-&gt;color[2] = 255;
+		team-&gt;color[3] = 255;
+		team-&gt;gaia = true;
+		team-&gt;readyToStart = true;
+		players[setup-&gt;numPlayers]-&gt;team = gaiaTeamID;
+		SetAllyTeam(gaiaTeamID, gaiaAllyTeamID);
+	}
+}
+
 /**
  * @return synced random integer
  *
@@ -278,6 +358,14 @@
 	return ret;
 }
 
+void CGlobalUnsyncedStuff::LoadFromSetup(const CGameSetupData* setup)
+{
+	myPlayerNum = setup-&gt;myPlayerNum;
+	myTeam = setup-&gt;playerStartingData[myPlayerNum].team;
+	myAllyTeam = setup-&gt;teamStartingData[myPlayerNum].teamAllyteam;
 
+	spectating = setup-&gt;playerStartingData[myPlayerNum].spectator;
+	spectatingFullView   = setup-&gt;playerStartingData[myPlayerNum].spectator;
+	spectatingFullSelect = setup-&gt;playerStartingData[myPlayerNum].spectator;
+}
 
-

Modified: trunk/rts/System/GlobalStuff.h
===================================================================
--- trunk/rts/System/GlobalStuff.h	2008-07-03 03:12:06 UTC (rev 6101)
+++ trunk/rts/System/GlobalStuff.h	2008-07-04 20:13:30 UTC (rev 6102)
@@ -127,6 +127,7 @@
 class CUnit;
 class CPlayer;
 class LuaParser;
+class CGameSetupData;
 
 /**
  * @brief Global synced stuff
@@ -140,6 +141,7 @@
 	CR_DECLARE(CGlobalSyncedStuff);
 	CGlobalSyncedStuff();  //!&lt; Constructor
 	~CGlobalSyncedStuff(); //!&lt; Destructor
+	void LoadFromSetup(const CGameSetupData*);
 
 	int    randInt();    //!&lt; synced random int
 	float  randFloat();  //!&lt; synced random float
@@ -461,6 +463,8 @@
 	float  usRandFloat();  //!&lt; Unsynced random float
 	float3 usRandVector(); //!&lt; Unsynced random vector
 
+	void LoadFromSetup(const CGameSetupData*);
+
 	/**
 	 * Does the user want team colored nanospray if the mod allows it?
 	 */

Modified: trunk/rts/System/SpringApp.cpp
===================================================================
--- trunk/rts/System/SpringApp.cpp	2008-07-03 03:12:06 UTC (rev 6101)
+++ trunk/rts/System/SpringApp.cpp	2008-07-04 20:13:30 UTC (rev 6102)
@@ -721,6 +721,11 @@
 			delete gameSetup;
 			gameSetup = 0;
 		}
+		else
+		{
+			gs-&gt;LoadFromSetup(gameSetup);
+			gu-&gt;LoadFromSetup(gameSetup);
+		}
 	}
 
 	if (!gameSetup &amp;&amp; demofile.empty()) {

Modified: trunk/rts/lib/gml/gml.cpp
===================================================================
--- trunk/rts/lib/gml/gml.cpp	2008-07-03 03:12:06 UTC (rev 6101)
+++ trunk/rts/lib/gml/gml.cpp	2008-07-04 20:13:30 UTC (rev 6102)
@@ -32,6 +32,7 @@
 // If a function is not yet supported by GML, a compile error pointing to 'GML_FUNCTION_NOT_IMPLEMENTED' will occur
 
 #include &quot;gmlcls.h&quot;
+#include &quot;gml.h&quot;
 
 #define EXEC_RUN (BYTE *)NULL
 #define EXEC_SYNC (BYTE *)-1
@@ -882,8 +883,6 @@
 //	GML_DEBUG(&quot;Execute &quot;,procs);
 }
 
-extern void gmlUpdateServers();
-
 // Execute - executes all GL commands in the current read queue.
 // Execution is synced (this means it will stop at certain points
 // to return values to the worker thread)

Modified: trunk/tools/DedicatedServer/CMakeLists.txt
===================================================================
--- trunk/tools/DedicatedServer/CMakeLists.txt	2008-07-03 03:12:06 UTC (rev 6101)
+++ trunk/tools/DedicatedServer/CMakeLists.txt	2008-07-04 20:13:30 UTC (rev 6102)
@@ -40,10 +40,21 @@
 ENDIF (UNIX)
 
 AUX_SOURCE_DIRECTORY(../../rts/System/FileSystem/ fsfiles)
-SET(system_files ${fsfiles} ${platformfiles} ../../rts/System/TdfParser ../../rts/System/Platform/FileSystem ../../rts/System/Platform/ConfigHandler ../../rts/System/LogOutput)
+SET(system_files 
+	${fsfiles}
+	${platformfiles}
+	../../rts/System/TdfParser
+	../../rts/System/Platform/FileSystem
+	../../rts/System/Platform/ConfigHandler
+	../../rts/System/LogOutput
+	../../rts/System/BaseNetProtocol
+	../../rts/System/Demo
+	../../rts/System/DemoReader
+	../../rts/System/AutohostInterface
+	../../rts/System/UnsyncedRNG )
 
 AUX_SOURCE_DIRECTORY(../../rts/Game/Server serverfiles)
-ADD_LIBRARY(server SHARED ${system_files} ${serverfiles} ../../rts/Game/GameServer GameSetup ../../rts/Game/GameSetupData ../../rts/Game/GameData ../../rts/Game/GameVersion ../../rts/Game/CommandMessage ../../rts/Game/ChatMessage ../../rts/Game/Console ../../rts/Game/Action ../../rts/System/DemoReader ../../rts/System/Demo ../../rts/System/AutohostInterface  ../../rts/System/BaseNetProtocol ../../rts/System/UnsyncedRNG ../../rts/Lua/LuaParser ../../rts/Lua/LuaUtils)
+ADD_LIBRARY(server SHARED ${system_files} ${serverfiles} ../../rts/Game/GameServer ../../rts/Game/GameSetup ../../rts/Game/GameSetupData ../../rts/Game/GameData ../../rts/Game/GameVersion ../../rts/Game/CommandMessage ../../rts/Game/ChatMessage ../../rts/Game/Console ../../rts/Game/Action ../../rts/Lua/LuaParser ../../rts/Lua/LuaUtils ../../rts/Map/MapParser ../../rts/Rendering/Textures/TAPalette)
 TARGET_LINK_LIBRARIES(server SDL boost_thread-mt net hpiutil2 7zip minizip lua boost_regex-mt)
 
 ADD_EXECUTABLE(dedicated main)

Deleted: trunk/tools/DedicatedServer/GameSetup.cpp
===================================================================
--- trunk/tools/DedicatedServer/GameSetup.cpp	2008-07-03 03:12:06 UTC (rev 6101)
+++ trunk/tools/DedicatedServer/GameSetup.cpp	2008-07-04 20:13:30 UTC (rev 6102)
@@ -1,397 +0,0 @@
-#include &lt;algorithm&gt;
-#include &lt;cctype&gt;
-
-#include &quot;UnsyncedRNG.h&quot;
-#include &quot;GameSetup.h&quot;
-#include &quot;GameVersion.h&quot;
-#include &quot;LogOutput.h&quot;
-#include &quot;Player.h&quot;
-#include &quot;TdfParser.h&quot;
-#include &quot;Team.h&quot;
-#include &quot;FileSystem/ArchiveScanner.h&quot;
-#include &quot;FileSystem/FileHandler.h&quot;
-#include &quot;FileSystem/VFSHandler.h&quot;
-#include &quot;TdfParser.h&quot;
-#include &quot;Lua/LuaGaia.h&quot;
-#include &quot;Lua/LuaRules.h&quot;
-#include &quot;Lua/LuaParser.h&quot;
-#include &quot;Map/ReadMap.h&quot;
-#include &quot;Rendering/Textures/TAPalette.h&quot;
-
-
-using namespace std;
-
-CGameSetup::CGameSetup()
-{
-}
-
-CGameSetup::~CGameSetup()
-{
-}
-
-bool CGameSetup::Init(std::string setupFile)
-{
-	if(setupFile.empty())
-		return false;
-	CFileHandler fh(setupFile);
-	if (!fh.FileExists())
-		return false;
-	char* c=SAFE_NEW char[fh.FileSize()];
-	fh.Read(c,fh.FileSize());
-
-	bool ret=Init(c,fh.FileSize());
-
-	delete[] c;
-
-	return ret;
-}
-
-/**
<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">- at brief</A> Determine if the map is inside an archive, and possibly map needed archives
<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">- at pre</A> mapName initialized
<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">- at post</A> map archives (if any) have been mapped into the VFS
- */
-void CGameSetup::LoadMap()
-{
-	CFileHandler* f = SAFE_NEW CFileHandler(&quot;maps/&quot; + mapName);
-	if (!f-&gt;FileExists()) {
-		vector&lt;string&gt; ars = archiveScanner-&gt;GetArchivesForMap(mapName);
-		if (ars.empty())
-			throw content_error(&quot;Couldn't find any map archives for map '&quot; + mapName + &quot;'.&quot;);
-		for (vector&lt;string&gt;::iterator i = ars.begin(); i != ars.end(); ++i) {
-			if (!vfsHandler-&gt;AddArchive(*i, false))
-				throw content_error(&quot;Couldn't load archive '&quot; + *i + &quot;' for map '&quot; + mapName + &quot;'.&quot;);
-		}
-	}
-	delete f;
-}
-
-/**
<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">- at brief</A> Load unit restrictions
<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">- at post</A> restrictedUnits initialized
- */
-void CGameSetup::LoadUnitRestrictions(const TdfParser&amp; file)
-{
-	int numRestrictions;
-	file.GetDef(numRestrictions, &quot;0&quot;, &quot;GAME\\NumRestrictions&quot;);
-
-	for (int i = 0; i &lt; numRestrictions; ++i) {
-		char key[100];
-		sprintf(key, &quot;GAME\\RESTRICT\\Unit%d&quot;, i);
-		string resName = file.SGetValueDef(&quot;&quot;, key);
-		sprintf(key, &quot;GAME\\RESTRICT\\Limit%d&quot;, i);
-		int resLimit;
-		file.GetDef(resLimit, &quot;0&quot;, key);
-
-		restrictedUnits[resName] = resLimit;
-	}
-}
-
-/**
<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">- at brief</A> Load startpositions from map
<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">- at pre</A> mapName, numTeams, teamStartNum initialized and the map loaded (LoadMap())
<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">- at todo</A> don't store in global variables directly
- */
-void CGameSetup::LoadStartPositionsFromMap()
-{
-	std::string mapname = mapName;
-	if (mapname.length() &lt; 3)
-		throw content_error(&quot;mapname '&quot; + mapname + &quot;' too short&quot;);
-
-	std::string extension = mapname.substr(mapname.length()-3);
-	if (extension == &quot;smf&quot;)
-		mapname=  std::string(&quot;maps/&quot;)+mapname.substr(0,mapname.find_last_of('.'))+&quot;.smd&quot;;
-	else if(extension == &quot;sm3&quot;)
-		mapname=  std::string(&quot;maps/&quot;)+mapname;
-	else
-		throw content_error(&quot;CReadMap::GetTDFName(): Unknown extension: &quot; + extension);
-
-	TdfParser p2;
-	p2.LoadFile(mapname);
-
-	for(int a=0;a&lt;numTeams;++a){
-		float x,z;
-		char teamName[50];
-		sprintf(teamName, &quot;TEAM%i&quot;, teamStartNum[a]);
-		p2.GetDef(x, &quot;1000&quot;, string(&quot;MAP\\&quot;) + teamName + &quot;\\StartPosX&quot;);
-		p2.GetDef(z, &quot;1000&quot;, string(&quot;MAP\\&quot;) + teamName + &quot;\\StartPosZ&quot;);
-		startPos[a] = SFloat3(x, 100, z);
-	}
-}
-
-/**
<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">- at brief</A> Load startpositions from map/script
<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">- at pre</A> numTeams and startPosType initialized
<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">- at post</A> readyTeams, teamStartNum and team start positions initialized
<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">- at todo</A> don't store in global variables directly
- */
-void CGameSetup::LoadStartPositions(const TdfParser&amp; file)
-{
-	for (int a = 0; a &lt; numTeams; ++a) {
-		// Ready up automatically unless startPosType is choose in game
-		readyTeams[a] = (startPosType != StartPos_ChooseInGame);
-		teamStartNum[a] = a;
-	}
-
-	if (startPosType == StartPos_Random) {
-		// Server syncs these later, so we can use unsynced rng
-		UnsyncedRNG rng;
-		std::random_shuffle(&amp;teamStartNum[0], &amp;teamStartNum[numTeams], rng);
-	}
-
-	LoadStartPositionsFromMap();
-
-	// Show that we havent selected start pos yet
-	if (startPosType == StartPos_ChooseInGame) {
-		for (int a = 0; a &lt; numTeams; ++a)
-		{
-			startPos[a].y = -500;
-		}
-	}
-
-	// Load start position from gameSetup script
-	if (startPosType == StartPos_ChooseBeforeGame) {
-		for (int a = 0; a &lt; numTeams; ++a) {
-			char section[50];
-			sprintf(section, &quot;GAME\\TEAM%i\\&quot;, a);
-			string s(section);
-			std::string xpos = file.SGetValueDef(&quot;&quot;, s + &quot;StartPosX&quot;);
-			std::string zpos = file.SGetValueDef(&quot;&quot;, s + &quot;StartPosZ&quot;);
-			if (!xpos.empty())
-			{
-				startPos[a].x = atoi(xpos.c_str());
-			}
-			if (!zpos.empty())
-			{
-				startPos[a].y = atoi(zpos.c_str());
-			}
-		}
-	}
-}
-
-/**
<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">- at brief</A> Load players and remove gaps in the player numbering.
<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">- at pre</A> numPlayers initialized
<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">- at post</A> players loaded, numDemoPlayers initialized
<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">- at todo</A> don't store in global variables directly
- */
-void CGameSetup::LoadPlayers(const TdfParser&amp; file)
-{
-	numDemoPlayers = 0;
-	// i = player index in game (no gaps), a = player index in script
-	int i = 0;
-	for (int a = 0; a &lt; MAX_PLAYERS; ++a) {
-		char section[50];
-		sprintf(section, &quot;GAME\\PLAYER%i\\&quot;, a);
-		string s(section);
-
-		if (!file.SectionExist(s.substr(0, s.length() - 1)))
-			continue;
-
-		playerStartingData[i].team = unsigned(atoi(file.SGetValueDef(&quot;0&quot;,   s + &quot;team&quot;).c_str()));
-		playerStartingData[i].spectator = !!atoi(file.SGetValueDef(&quot;0&quot;, s + &quot;spectator&quot;).c_str());
-
-		int fromDemo;
-		file.GetDef(fromDemo, &quot;0&quot;, s + &quot;IsFromDemo&quot;);
-		if (fromDemo)
-			numDemoPlayers++;
-
-		playerRemap[a] = i;
-		++i;
-	}
-
-	if (playerRemap.size() != numPlayers)
-		throw content_error(&quot;incorrect number of players in GameSetup script&quot;);
-}
-
-/**
<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">- at brief</A> Load teams and remove gaps in the team numbering.
<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">- at pre</A> numTeams, hostDemo initialized
<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">- at post</A> teams loaded
<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">- at todo</A> don't store in global variables directly
- */
-void CGameSetup::LoadTeams(const TdfParser&amp; file)
-{
-	// i = team index in game (no gaps), a = team index in script
-	int i = 0;
-	for (int a = 0; a &lt; MAX_TEAMS; ++a) {
-		char section[50];
-		sprintf(section, &quot;GAME\\TEAM%i\\&quot;, a);
-		string s(section);
-
-		if (!file.SectionExist(s.substr(0, s.length() - 1)))
-			continue;
-
-		// Get default color from palette (based on &quot;color&quot; tag)
-		// int colorNum = atoi(file.SGetValueDef(&quot;0&quot;, s + &quot;color&quot;).c_str());
-		// colorNum %= palette.NumTeamColors();
-		// float3 defaultCol(palette.teamColor[colorNum][0] / 255.0f, palette.teamColor[colorNum][1] / 255.0f, palette.teamColor[colorNum][2] / 255.0f);
-
-		const string aiDll = file.SGetValueDef(&quot;&quot;, s + &quot;aidll&quot;);
-		teamAllyteam[i] = atoi(file.SGetValueDef(&quot;0&quot;, s + &quot;allyteam&quot;).c_str());
-
-		//if (aiDll.substr(0, 6) == &quot;LuaAI:&quot;) {
-		//} else {
-		//	if (hostDemo) {
-		//		aiDlls[i] = &quot;&quot;;
-		//	} else {
-		//		aiDlls[i] = aiDll;
-		//	}
-		//}
-
-		teamRemap[a] = i;
-		++i;
-	}
-
-	if (teamRemap.size() != numTeams)
-		throw content_error(&quot;incorrect number of teams in GameSetup script&quot;);
-}
-
-/**
<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">- at brief</A> Load allyteams and remove gaps in the allyteam numbering.
<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">- at pre</A> numAllyTeams initialized
<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">- at post</A> allyteams loaded
<A HREF="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">- at todo</A> don't store in global variables directly
-*/
-void CGameSetup::LoadAllyTeams(const TdfParser&amp; file)
-{
-	// i = allyteam index in game (no gaps), a = allyteam index in script
-	int i = 0;
-	for (int a = 0; a &lt; MAX_TEAMS; ++a) {
-		char section[50];
-		sprintf(section,&quot;GAME\\ALLYTEAM%i\\&quot;,a);
-		string s(section);
-
-		if (!file.SectionExist(s.substr(0, s.length() - 1)))
-			continue;
-
-		startRectTop[i]    = atof(file.SGetValueDef(&quot;0&quot;, s + &quot;StartRectTop&quot;).c_str());
-		startRectBottom[i] = atof(file.SGetValueDef(&quot;1&quot;, s + &quot;StartRectBottom&quot;).c_str());
-		startRectLeft[i]   = atof(file.SGetValueDef(&quot;0&quot;, s + &quot;StartRectLeft&quot;).c_str());
-		startRectRight[i]  = atof(file.SGetValueDef(&quot;1&quot;, s + &quot;StartRectRight&quot;).c_str());
-
-		allyteamRemap[a] = i;
-		++i;
-	}
-
-	if (allyteamRemap.size() != numAllyTeams)
-		throw content_error(&quot;incorrect number of allyteams in GameSetup script&quot;);
-}
-
-/** @brief Update all player indices to refer to the right player. */
-void CGameSetup::RemapPlayers()
-{
-	// relocate myPlayerNum
-	if (playerRemap.find(myPlayerNum) == playerRemap.end())
-		throw content_error(&quot;invalid MyPlayerNum in GameSetup script&quot;);
-	myPlayerNum = playerRemap[myPlayerNum];
-}
-
-/** @brief Update all team indices to refer to the right team. */
-void CGameSetup::RemapTeams()
-{
-	// relocate Player.Team field
-	for (int a = 0; a &lt; numPlayers; ++a) {
-		playerStartingData[a].team = teamRemap[playerStartingData[a].team];
-	}
-}
-
-/** @brief Update all allyteam indices to refer to the right allyteams. */
-void CGameSetup::RemapAllyteams()
-{
-	// relocate gs-&gt;allies matrix
-	for (int a = 0; a &lt; MAX_TEAMS; ++a) {
-		for (int b = 0; b &lt; MAX_TEAMS; ++b) {
-			teamAllyteam[a] = allyteamRemap[teamAllyteam[a]];
-
-			if (allyteamRemap.find(a) != allyteamRemap.end() &amp;&amp;
-				allyteamRemap.find(b) != allyteamRemap.end()) {
-			}
-		}
-	}
-}
-
-bool CGameSetup::Init(const char* buf, int size)
-{
-	// Copy buffer contents
-	gameSetupText = SAFE_NEW char[size];
-	memcpy(gameSetupText, buf, size);
-	gameSetupTextLength = size;
-
-	// Parse
-	TdfParser file;
-	file.LoadBuffer(buf, size);
-
-	if(!file.SectionExist(&quot;GAME&quot;))
-		return false;
-
-	// Technical parameters
-	file.GetDef(hostip,     &quot;0&quot;, &quot;GAME\\HostIP&quot;);
-	file.GetDef(hostport,   &quot;0&quot;, &quot;GAME\\HostPort&quot;);
-	file.GetDef(sourceport, &quot;0&quot;, &quot;GAME\\SourcePort&quot;);
-	file.GetDef(autohostport, &quot;0&quot;, &quot;GAME\\AutohostPort&quot;);
-
-	// Game parameters
-	scriptName  = file.SGetValueDef(&quot;Commanders&quot;, &quot;GAME\\ScriptName&quot;);
-	baseMod     = file.SGetValueDef(&quot;&quot;,  &quot;GAME\\Gametype&quot;);
-	mapName     = file.SGetValueDef(&quot;&quot;,  &quot;GAME\\MapName&quot;);
-	luaGaiaStr  = file.SGetValueDef(&quot;1&quot;, &quot;GAME\\LuaGaia&quot;);
-	luaRulesStr = file.SGetValueDef(&quot;1&quot;, &quot;GAME\\LuaRules&quot;);
-	saveName    = file.SGetValueDef(&quot;&quot;,  &quot;GAME\\Savefile&quot;);
-	demoName    = file.SGetValueDef(&quot;&quot;,  &quot;GAME\\Demofile&quot;);
-	hostDemo    = !demoName.empty();
-
-	file.GetDef(gameMode,         &quot;0&quot;, &quot;GAME\\GameMode&quot;);
-	file.GetDef(noHelperAIs,      &quot;0&quot;, &quot;GAME\\NoHelperAIs&quot;);
-	file.GetDef(maxUnits,       &quot;500&quot;, &quot;GAME\\MaxUnits&quot;);
-	file.GetDef(limitDgun,        &quot;0&quot;, &quot;GAME\\LimitDgun&quot;);
-	file.GetDef(diminishingMMs,   &quot;0&quot;, &quot;GAME\\DiminishingMMs&quot;);
-	file.GetDef(disableMapDamage, &quot;0&quot;, &quot;GAME\\DisableMapDamage&quot;);
-	file.GetDef(ghostedBuildings, &quot;1&quot;, &quot;GAME\\GhostedBuildings&quot;);
-	file.GetDef(startMetal,    &quot;1000&quot;, &quot;GAME\\StartMetal&quot;);
-	file.GetDef(startEnergy,   &quot;1000&quot;, &quot;GAME\\StartEnergy&quot;);
-
-	file.GetDef(maxSpeed, &quot;3.0&quot;, &quot;GAME\\MaxSpeed&quot;);
-	file.GetDef(minSpeed, &quot;0.3&quot;, &quot;GAME\\MinSpeed&quot;);
-
-	file.GetDef(myPlayerNum,  &quot;0&quot;, &quot;GAME\\MyPlayerNum&quot;);
-	file.GetDef(numPlayers,   &quot;2&quot;, &quot;GAME\\NumPlayers&quot;);
-	file.GetDef(numTeams,     &quot;2&quot;, &quot;GAME\\NumTeams&quot;);
-	file.GetDef(numAllyTeams, &quot;2&quot;, &quot;GAME\\NumAllyTeams&quot;);
-
-	// Read the map &amp; mod options
-	if (file.SectionExist(&quot;GAME\\MapOptions&quot;)) {
-		mapOptions = file.GetAllValues(&quot;GAME\\MapOptions&quot;);
-	}
-	if (file.SectionExist(&quot;GAME\\ModOptions&quot;)) {
-		modOptions = file.GetAllValues(&quot;GAME\\ModOptions&quot;);
-	}
-
-	// Read startPosType (with clamping)
-	int startPosTypeInt;
-	file.GetDef(startPosTypeInt, &quot;0&quot;, &quot;GAME\\StartPosType&quot;);
-	if (startPosTypeInt &lt; 0 || startPosTypeInt &gt; StartPos_Last)
-		startPosTypeInt = 0;
-	startPosType = (StartPosType)startPosTypeInt;
-
-	// Read subsections
-	LoadPlayers(file);
-	LoadTeams(file);
-	LoadAllyTeams(file);
-
-	// Relocate indices (for gap removing)
-	RemapPlayers();
-	RemapTeams();
-	RemapAllyteams();
-
-	LoadUnitRestrictions(file);
-
-	LoadMap();
-	LoadStartPositions(file);
-
-	// Postprocessing
-	baseMod = archiveScanner-&gt;ModArchiveToModName(baseMod);
-
-	return true;
-}
-

Deleted: trunk/tools/DedicatedServer/GameSetup.h
===================================================================
--- trunk/tools/DedicatedServer/GameSetup.h	2008-07-03 03:12:06 UTC (rev 6101)
+++ trunk/tools/DedicatedServer/GameSetup.h	2008-07-04 20:13:30 UTC (rev 6102)
@@ -1,37 +0,0 @@
-#ifndef __GAME_SETUP_H__
-#define __GAME_SETUP_H__
-
-#include &lt;string&gt;
-
-#include &quot;GameSetupData.h&quot;
-
-class TdfParser;
-
-/**
- * @brief just a copy of the original, but removed some unneeded stuff
- */
-class CGameSetup : public CGameSetupData
-{
-public:
-	CGameSetup();
-	~CGameSetup();
-	bool Init(std::string setupFile);
-
-	bool Init(const char* buf, int size);
-
-private:
-	void LoadMap();
-	void LoadStartPositionsFromMap();
-
-	void LoadStartPositions(const TdfParser&amp; file);
-	void LoadUnitRestrictions(const TdfParser&amp; file);
-	void LoadPlayers(const TdfParser&amp; file);
-	void LoadTeams(const TdfParser&amp; file);
-	void LoadAllyTeams(const TdfParser&amp; file);
-
-	void RemapPlayers();
-	void RemapTeams();
-	void RemapAllyteams();
-};
-
-#endif // __GAME_SETUP_H__


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000881.html">[Taspring-linux-commit] r6101 - in trunk/rts: Sim/Misc	Sim/MoveTypes Sim/MoveTypes/MoveMath Sim/Objects Sim/Path	Sim/Units build/vstudio8
</A></li>
	<LI>Next message: <A HREF="000883.html">[Taspring-linux-commit] r6103 - in trunk/rts: Game Sim/Misc	Sim/MoveTypes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#882">[ date ]</a>
              <a href="thread.html#882">[ thread ]</a>
              <a href="subject.html#882">[ subject ]</a>
              <a href="author.html#882">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
