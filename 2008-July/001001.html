<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r6221 - in branches/0.77-branch:	Lobby/TASClient Lobby/TASClient/Python/scripts rts/Game	rts/Game/UI rts/Lua rts/Sim/Units/CommandAI rts/Sim/Units/UnitTypes
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-July/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6221%20-%20in%20branches/0.77-branch%3A%0A%09Lobby/TASClient%20Lobby/TASClient/Python/scripts%20rts/Game%0A%09rts/Game/UI%20rts/Lua%20rts/Sim/Units/CommandAI%20rts/Sim/Units/UnitTypes&In-Reply-To=%3C20080730135634.1845648A3%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001000.html">
   <LINK REL="Next"  HREF="001002.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r6221 - in branches/0.77-branch:	Lobby/TASClient Lobby/TASClient/Python/scripts rts/Game	rts/Game/UI rts/Lua rts/Sim/Units/CommandAI rts/Sim/Units/UnitTypes</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r6221%20-%20in%20branches/0.77-branch%3A%0A%09Lobby/TASClient%20Lobby/TASClient/Python/scripts%20rts/Game%0A%09rts/Game/UI%20rts/Lua%20rts/Sim/Units/CommandAI%20rts/Sim/Units/UnitTypes&In-Reply-To=%3C20080730135634.1845648A3%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r6221 - in branches/0.77-branch:	Lobby/TASClient Lobby/TASClient/Python/scripts rts/Game	rts/Game/UI rts/Lua rts/Sim/Units/CommandAI rts/Sim/Units/UnitTypes">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Wed Jul 30 15:56:33 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001000.html">[Taspring-linux-commit] r6220 - trunk/rts/Game/UI
</A></li>
        <LI>Next message: <A HREF="001002.html">[Taspring-linux-commit] r6222 - branches/0.77-branch/rts/Game
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1001">[ date ]</a>
              <a href="thread.html#1001">[ thread ]</a>
              <a href="subject.html#1001">[ subject ]</a>
              <a href="author.html#1001">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: Auswaschbar
Date: 2008-07-30 15:56:30 +0200 (Wed, 30 Jul 2008)
New Revision: 6221

Modified:
   branches/0.77-branch/Lobby/TASClient/BattleFormUnit.dfm
   branches/0.77-branch/Lobby/TASClient/BattleFormUnit.pas
   branches/0.77-branch/Lobby/TASClient/ColorPicker.dfm
   branches/0.77-branch/Lobby/TASClient/ColorPicker.pas
   branches/0.77-branch/Lobby/TASClient/LobbyScriptUnit.pas
   branches/0.77-branch/Lobby/TASClient/MainUnit.dfm
   branches/0.77-branch/Lobby/TASClient/MainUnit.pas
   branches/0.77-branch/Lobby/TASClient/Misc.pas
   branches/0.77-branch/Lobby/TASClient/PreferencesFormUnit.pas
   branches/0.77-branch/Lobby/TASClient/Python/scripts/stick.py
   branches/0.77-branch/Lobby/TASClient/TASClient.dof
   branches/0.77-branch/Lobby/TASClient/TASClient.res
   branches/0.77-branch/Lobby/TASClient/Utility.pas
   branches/0.77-branch/rts/Game/Game.cpp
   branches/0.77-branch/rts/Game/UI/SelectionKeyHandler.cpp
   branches/0.77-branch/rts/Lua/LuaHandleSynced.cpp
   branches/0.77-branch/rts/Lua/LuaUnsyncedCtrl.h
   branches/0.77-branch/rts/Sim/Units/CommandAI/BuilderCAI.cpp
   branches/0.77-branch/rts/Sim/Units/UnitTypes/Builder.cpp
Log:
* merge all patches until 6220 to 0.77-branch


Modified: branches/0.77-branch/Lobby/TASClient/BattleFormUnit.dfm
===================================================================
--- branches/0.77-branch/Lobby/TASClient/BattleFormUnit.dfm	2008-07-30 12:03:47 UTC (rev 6220)
+++ branches/0.77-branch/Lobby/TASClient/BattleFormUnit.dfm	2008-07-30 13:56:30 UTC (rev 6221)
@@ -1,6 +1,6 @@
 object BattleForm: TBattleForm
-  Left = 356
-  Top = 52
+  Left = 433
+  Top = 342
   Width = 787
   Height = 586
   Caption = 'Battle window'
@@ -4042,7 +4042,7 @@
             Underline = True
           end&gt;
         HideSelection = False
-        LangOptions = [loAutoFont]
+        LangOptions = []
         Language = 1036
         ReadOnly = True
         ScrollBars = ssVertical
@@ -5088,7 +5088,7 @@
   end
   object TBXTeamColorSet: TTBXColorSet
     ColCount = 5
-    RowCount = 2
+    RowCount = 4
     OnGetColorInfo = TBXTeamColorSetGetColorInfo
     Left = 656
     Top = 376

Modified: branches/0.77-branch/Lobby/TASClient/BattleFormUnit.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/BattleFormUnit.pas	2008-07-30 12:03:47 UTC (rev 6220)
+++ branches/0.77-branch/Lobby/TASClient/BattleFormUnit.pas	2008-07-30 13:56:30 UTC (rev 6221)
@@ -494,7 +494,7 @@
     procedure SpTBXItem12Click(Sender: TObject);
     procedure VDTDisabledUnitsDrawNode(Sender: TBaseVirtualTree;
       const PaintInfo: TVTPaintInfo);
-    procedure ChaTExRichEditDblClick(Sender: TObject);
+    procedure ChatExRichEditDblClick(Sender: TObject);
     procedure Button1Click(Sender: TObject);
     procedure ChatRichEditMouseDown(Sender: TObject; Button: TMouseButton;
       Shift: TShiftState; X, Y: Integer);
@@ -2383,6 +2383,7 @@
 
   InputEdit.Align := alBottom;
   ChatRichEdit.Align := alClient;
+  ChatRichEdit.OnDblClick := ChatExRichEditDblClick;
 
   mask := SendMessage(ChatRichEdit.Handle, EM_GETEVENTMASK, 0, 0);
   SendMessage(ChatRichEdit.Handle, EM_SETEVENTMASK, 0, mask or ENM_LINK);
@@ -6260,7 +6261,7 @@
 var
   i: Integer;
 begin
-  if not (BattleState.Status = Hosting) then Exit; // this should not happen though
+  if not (BattleState.Status = Hosting) then Exit;
 
   if not AllowBattleDetailsUpdate then Exit;
 
@@ -6354,6 +6355,7 @@
       TLuaOption(ModOptionsList[i]).SetValue(Ini.ReadString('ModOptions', TLuaOption(ModOptionsList[i]).Key, TLuaOption(ModOptionsList[i]).DefaultValue));
   end;
   Ini.Free;
+  SendLuaOptionsDetailsToServer;
 end;
 
 procedure TBattleForm.SaveMapOptionsAsDefault;
@@ -6389,6 +6391,7 @@
       TLuaOption(MapOptionsList[i]).SetValue(Ini.ReadString('MapOptions', TLuaOption(MapOptionsList[i]).Key, TLuaOption(MapOptionsList[i]).DefaultValue));
   end;
   Ini.Free;
+  SendLuaOptionsDetailsToServer;
 end;
 
 procedure TBattleForm.btSetAsDefaultMDOClick(Sender: TObject);
@@ -6516,7 +6519,7 @@
     case Column of
       0:
       begin
-        if TBitmap(UnitBitmaps[Node.Index]).Width &gt; 0 then
+        if TBitmap(UnitBitmaps[nodeIndex]).Width &gt; 0 then
         begin
           availableWidth := R.Right-R.Left;
           availableHeight := R.Bottom-R.Top;
@@ -6545,7 +6548,7 @@
   end;
 end;
 
-procedure TBattleForm.ChaTExRichEditDblClick(Sender: TObject);
+procedure TBattleForm.ChatExRichEditDblClick(Sender: TObject);
 var
    ci, //Character Index
    lix, //Line Index

Modified: branches/0.77-branch/Lobby/TASClient/ColorPicker.dfm
===================================================================
--- branches/0.77-branch/Lobby/TASClient/ColorPicker.dfm	2008-07-30 12:03:47 UTC (rev 6220)
+++ branches/0.77-branch/Lobby/TASClient/ColorPicker.dfm	2008-07-30 13:56:30 UTC (rev 6221)
@@ -3,7 +3,7 @@
   Top = 230
   BorderStyle = bsDialog
   Caption = 'ColorPickerForm'
-  ClientHeight = 398
+  ClientHeight = 409
   ClientWidth = 497
   Color = clBtnFace
   Constraints.MaxHeight = 1000
@@ -23,7 +23,7 @@
     Left = 0
     Top = 0
     Width = 497
-    Height = 398
+    Height = 409
     Caption = 'Color Picker'
     Options.Minimize = False
     Options.Maximize = False
@@ -31,7 +31,7 @@
       Left = 8
       Top = 32
       Width = 481
-      Height = 361
+      Height = 369
       Caption = 'SpTBXPanel1'
       TabOrder = 1
       Borders = False
@@ -70,7 +70,7 @@
       end
       object rdH: TSpTBXRadioButton
         Left = 384
-        Top = 82
+        Top = 74
         Width = 32
         Height = 15
         Caption = 'H :'
@@ -81,7 +81,7 @@
       end
       object txtH: TSpTBXEdit
         Left = 416
-        Top = 80
+        Top = 72
         Width = 41
         Height = 21
         TabOrder = 1
@@ -90,7 +90,7 @@
       end
       object SpTBXLabel1: TSpTBXLabel
         Left = 464
-        Top = 80
+        Top = 72
         Width = 5
         Height = 20
         Caption = #176
@@ -108,7 +108,7 @@
       end
       object SpTBXLabel2: TSpTBXLabel
         Left = 461
-        Top = 104
+        Top = 96
         Width = 12
         Height = 16
         Caption = '%'
@@ -126,7 +126,7 @@
       end
       object SpTBXLabel3: TSpTBXLabel
         Left = 461
-        Top = 128
+        Top = 120
         Width = 12
         Height = 16
         Caption = '%'
@@ -144,7 +144,7 @@
       end
       object txtS: TSpTBXEdit
         Left = 416
-        Top = 104
+        Top = 96
         Width = 41
         Height = 21
         TabOrder = 5
@@ -153,7 +153,7 @@
       end
       object rdS: TSpTBXRadioButton
         Left = 384
-        Top = 106
+        Top = 98
         Width = 31
         Height = 15
         Caption = 'S :'
@@ -162,7 +162,7 @@
       end
       object rdL: TSpTBXRadioButton
         Left = 384
-        Top = 130
+        Top = 122
         Width = 30
         Height = 15
         Caption = 'L :'
@@ -171,7 +171,7 @@
       end
       object txtL: TSpTBXEdit
         Left = 416
-        Top = 128
+        Top = 120
         Width = 41
         Height = 21
         TabOrder = 8
@@ -180,7 +180,7 @@
       end
       object SpTBXLabel4: TSpTBXLabel
         Left = 400
-        Top = 170
+        Top = 154
         Width = 14
         Height = 13
         Caption = 'R :'
@@ -192,7 +192,7 @@
       end
       object txtR: TSpTBXEdit
         Left = 416
-        Top = 168
+        Top = 152
         Width = 41
         Height = 21
         TabOrder = 10
@@ -201,7 +201,7 @@
       end
       object SpTBXLabel5: TSpTBXLabel
         Left = 400
-        Top = 194
+        Top = 178
         Width = 14
         Height = 13
         Caption = 'G :'
@@ -213,7 +213,7 @@
       end
       object txtG: TSpTBXEdit
         Left = 416
-        Top = 192
+        Top = 176
         Width = 41
         Height = 21
         TabOrder = 12
@@ -222,7 +222,7 @@
       end
       object SpTBXLabel6: TSpTBXLabel
         Left = 400
-        Top = 218
+        Top = 202
         Width = 13
         Height = 13
         Caption = 'B :'
@@ -234,7 +234,7 @@
       end
       object txtB: TSpTBXEdit
         Left = 416
-        Top = 216
+        Top = 200
         Width = 41
         Height = 21
         TabOrder = 14
@@ -243,7 +243,7 @@
       end
       object SpTBXLabel7: TSpTBXLabel
         Left = 394
-        Top = 250
+        Top = 234
         Width = 16
         Height = 13
         Caption = '#'
@@ -261,7 +261,7 @@
       end
       object txtColorHex: TSpTBXEdit
         Left = 408
-        Top = 248
+        Top = 232
         Width = 49
         Height = 21
         Hint = 'Hit Enter to validate'
@@ -273,7 +273,7 @@
       end
       object btReset: TSpTBXButton
         Left = 313
-        Top = 328
+        Top = 344
         Width = 145
         Height = 25
         Caption = 'Reset all colors to default'
@@ -287,7 +287,7 @@
       end
       object btCancel: TSpTBXButton
         Left = 160
-        Top = 328
+        Top = 344
         Width = 81
         Height = 25
         Caption = 'Cancel'
@@ -302,7 +302,7 @@
       end
       object btDone: TSpTBXButton
         Left = 82
-        Top = 328
+        Top = 344
         Width = 73
         Height = 25
         Caption = 'Done'
@@ -327,10 +327,10 @@
         TabOrder = 20
       end
       object ColorToolbar: TSpTBXToolbar
-        Left = 376
-        Top = 280
-        Width = 90
-        Height = 36
+        Left = 384
+        Top = 264
+        Width = 72
+        Height = 72
         Caption = 'ColorToolbar'
         TabOrder = 21
         object TBXColorPalette1: TTBXColorPalette

Modified: branches/0.77-branch/Lobby/TASClient/ColorPicker.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/ColorPicker.pas	2008-07-30 12:03:47 UTC (rev 6220)
+++ branches/0.77-branch/Lobby/TASClient/ColorPicker.pas	2008-07-30 13:56:30 UTC (rev 6221)
@@ -154,6 +154,7 @@
     Canvas.Brush.Style := bsClear;
     Canvas.Ellipse(curMainX-5,curMainY-5,curMainX+5,curMainY+5);
     ColorPanel.Color := Misc.Hsl(currentHue,Round(curMainX/3),Round((300-curMainY)/3));
+    ColorPanel.Refresh;
     Refresh;
   end;
   if RefreshHSL then begin
@@ -399,7 +400,7 @@
     txtG.Text := IntToStr(Misc.ColorToG(Color));
     txtB.Text := IntToStr(Misc.ColorToB(Color));
     RefreshRGBColor;
-    for i:=0 to 9 do
+    for i:=0 to High(MainUnit.TeamColors) do
     if MainUnit.TeamColors[i] = Color then
     begin
       FSelectedColorIndex := i;

Modified: branches/0.77-branch/Lobby/TASClient/LobbyScriptUnit.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/LobbyScriptUnit.pas	2008-07-30 12:03:47 UTC (rev 6220)
+++ branches/0.77-branch/Lobby/TASClient/LobbyScriptUnit.pas	2008-07-30 13:56:30 UTC (rev 6221)
@@ -5,7 +5,8 @@
   Windows, Messages, SysUtils, Variants, Graphics,
   Misc,ExtCtrls, WrapDelphi, WrapDelphiClasses,PythonEngine,
   PythonGUIInputOutput, Forms, StrUtils,Classes, JclDebug,
-  WSocket,MainUnit, class_TIntegerList;
+  WSocket,MainUnit, class_TIntegerList, RichEdit2, ExRichEdit,
+  SyncObjs;
 
 type
   {$METHODINFO ON}
@@ -22,7 +23,12 @@
       pyBattles: PPyObject;
       pyReplays: PPyObject;
       pyGroups: PPyObject;
+      pyTextBoxes: PPyObject;
+      pyColors: PPyObject;
       pyCurrentBattle: PPyObject;
+      textBoxStringList: TStringList;
+      textBoxList: TList;
+      CS: TCriticalSection;
 
     protected
       function GetPyBattle(Battle: TBattle): PPyObject;
@@ -31,7 +37,10 @@
       function GetPyUser(user: TClient): PPyObject;
       function GetPyGroup(group: TClientGroup): PPyObject;
       procedure RefreshPythonLists;
+      procedure RefreshTextBoxesLists;
       procedure ClearRefs;
+      procedure LockCallback;
+      procedure UnlockCallback;
 
     public
       // tasclient special functions
@@ -57,6 +66,7 @@
       function GetGroups: Variant;
       function GetMaps: Variant;
       function GetMods: Variant;
+      function GetTextBoxList: Variant;
       function HostBattle(nbPlayers: integer; RankLimit: Integer; ModName: string; Description: string; Password: string; UDPHostPort: integer; NatTraversal: integer) : Boolean;
       function HostReplay(replayFile: string; nbPlayers: integer; RankLimit: Integer; Description: string; Password: string; UDPHostPort: integer; NatTraversal: integer) : Boolean;
       function JoinBattle(battleId: integer; Password: String) : Boolean;
@@ -65,6 +75,8 @@
       function SetMyReadyStatus(b: Boolean): Boolean;
       procedure SetMyBattleStatus(spec: boolean);
       function GetCurrentBattle: Variant;
+      function AddToTextBox(textBox : string; msg : string; color : integer): boolean;
+      function GetColors: Variant;
 
       constructor Create;
       destructor Destroy;
@@ -99,6 +111,8 @@
   procedure ReleaseMainThread;
   procedure PyDict_SetItemStringDecRef(dp: PPyObject; Key: PAnsiChar; const V : Variant);
   procedure PyDict_SetItemDecRef(dp: PPyObject; Key: PPyObject; const V : Variant);
+  procedure PostMsgs;
+  procedure JoinBattle;
 var
   MainThreadState: PPyThreadState;
   MainInterpreterState: PPyInterpreterState;
@@ -107,10 +121,17 @@
   ScriptJoining: Boolean;
   ScriptStart: Boolean;
   StartBattleSuccess: Boolean;
+  MsgList: TStringList;
+  MsgColor: TIntegerList;
+  RichEditList: TList;
+  MainThreadFocused: Boolean;
+  JoinBattleId: integer;
+  JoinBattlePassword: string;
 
 implementation
 
-uses PythonScriptDebugFormUnit, Utility, MapListFormUnit, HostBattleFormUnit, BattleFormUnit, ReplaysUnit;
+uses PythonScriptDebugFormUnit, Utility, MapListFormUnit, HostBattleFormUnit,
+BattleFormUnit, ReplaysUnit, PreferencesFormUnit;
 
 constructor TCallback.Create;
 begin
@@ -118,6 +139,29 @@
   pyBattleList := TList.Create;
   pyGroupList := TList.Create;
   userRefCountList := TIntegerList.Create;
+  textBoxStringList := TStringList.Create;
+  textBoxList := TList.Create;
+  CS := TCriticalSection.Create;
+
+  with GetPythonEngine do
+  begin
+    pyColors := PyDict_New();
+    PyDict_SetItemStringDecRef(pyColors,'Normal',Colors.Normal);
+    PyDict_SetItemStringDecRef(pyColors,'Data',Colors.Data);
+    PyDict_SetItemStringDecRef(pyColors,'Error',Colors.Error);
+    PyDict_SetItemStringDecRef(pyColors,'Info',Colors.Info);
+    PyDict_SetItemStringDecRef(pyColors,'MinorInfo',Colors.MinorInfo);
+    PyDict_SetItemStringDecRef(pyColors,'ChanJoin',Colors.ChanJoin);
+    PyDict_SetItemStringDecRef(pyColors,'ChanLeft',Colors.ChanLeft);
+    PyDict_SetItemStringDecRef(pyColors,'MOTD',Colors.MOTD);
+    PyDict_SetItemStringDecRef(pyColors,'SayEx',Colors.SayEx);
+    PyDict_SetItemStringDecRef(pyColors,'Topic',Colors.Topic);
+    PyDict_SetItemStringDecRef(pyColors,'ClientAway',Colors.ClientAway);
+    PyDict_SetItemStringDecRef(pyColors,'MapModUnavailable',Colors.MapModUnavailable);
+    PyDict_SetItemStringDecRef(pyColors,'BotText',Colors.BotText);
+    PyDict_SetItemStringDecRef(pyColors,'MyText',Colors.MyText);
+    PyDict_SetItemStringDecRef(pyColors,'AdminText',Colors.AdminText);
+  end;
 end;
 
 destructor TCallback.Destroy;
@@ -227,6 +271,31 @@
   PostMessage(PythonScriptDebugForm.Handle, WM_REFRESHOUTPUT, 0, 0);
 end;}
 
+procedure TCallback.RefreshTextBoxesLists;
+var
+  i : integer;
+begin
+  textBoxStringList.Clear;
+  textBoxList.Clear;
+
+  textBoxStringList.Add('$local');
+  textBoxList.Add(MainForm.PageControl1.Pages[0] as TMyTabSheet);
+  textBoxStringList.Add('$batte');
+  textBoxList.Add(nil);
+  textBoxStringList.Add('$current');
+  if BattleForm.Active then
+    textBoxList.Add(nil)
+  else
+    textBoxList.Add(MainForm.PageControl1.ActivePage as TMyTabSheet);
+
+
+  for i:=1 to MainForm.PageControl1.PageCount-1 do
+  begin
+    textBoxStringList.Add(MainForm.PageControl1.Pages[i].Caption);
+    textBoxList.Add(MainForm.PageControl1.Pages[i] as TMyTabSheet);
+  end;
+end;
+
 procedure TCallback.RefreshPythonLists;
 var
   i,j,k: integer;
@@ -301,6 +370,10 @@
         end;
         PyDict_SetItemString(PPyObject(pyBattleList[i]),'Users',battleClients);
         Py_XDECREF(battleClients);
+
+        k := MainForm.GetClientIndexEx(TClient(Clients[0]).Name,AllClients);
+        PyDict_SetItemString(PPyObject(pyBattleList[i]),'Hoster',PPyObject(pyUserList[k]));
+        userRefCountList.Items[k] := userRefCountList.Items[k]+1;
       end;
 
     // add users to groups
@@ -313,10 +386,10 @@
           k := MainForm.GetClientIndexEx(Clients[j],AllClients);
 
           if k = -1 then
-            PyDict_SetItemStringDecRef(battleClients,Pchar(Clients[j]),'Not connected')
+            PyDict_SetItemStringDecRef(groupUsers,Pchar(Clients[j]),'Not connected')
           else
           begin
-            PyDict_SetItemString(battleClients,Pchar(Clients[j]),PPyObject(pyUserList[k]));
+            PyDict_SetItemString(groupUsers,Pchar(Clients[j]),PPyObject(pyUserList[k]));
             userRefCountList.Items[k] := userRefCountList.Items[k]+1;
           end;
         end;
@@ -335,6 +408,7 @@
 var
   i: integer;
 begin
+  LockCallback;
   with GetPythonEngine do
   begin
     ClearRefs;
@@ -344,9 +418,10 @@
 
     for i:=0 to AllClients.Count-1 do
       PyDict_SetItemString(pyUsers,PChar(TClient(AllClients[i]).Name),PPyObject(pyUserList[i]));
-      
+
     Result := PyObjectAsVariant(pyUsers);
   end;
+  UnlockCallback;
 end;
 
 function TCallback.GetCurrentBattle: Variant;
@@ -354,11 +429,15 @@
   i: integer;
   pyO: PPyObject;
 begin
+  LockCallback;
   with GetPythonEngine do
   begin
     Result := PyObjectAsVariant(Py_None);
     if BattleState.Status = None then
+    begin
+      UnlockCallback;
       Exit;
+    end;
     ClearRefs;
     pyCurrentBattle := PyDict_New();
 
@@ -381,6 +460,7 @@
 
     Result := PyObjectAsVariant(pyCurrentBattle);
   end;
+  UnlockCallback;
 end;
 
 function TCallback.GetPyUser(user: TClient): PPyObject;
@@ -546,6 +626,7 @@
   i: integer;
   pyO: PPyObject;
 begin
+  LockCallback;
   if ReplaysForm.LoadingPanel.Visible then Exit;
 
   with GetPythonEngine do
@@ -562,12 +643,14 @@
 
     Result := PyObjectAsVariant(pyReplays);
   end;
+  UnlockCallback;
 end;
 
 function TCallback.GetBattles: Variant;
 var
   i: integer;
 begin
+  LockCallback;
   with GetPythonEngine do
   begin
     ClearRefs;
@@ -580,8 +663,18 @@
 
     Result := PyObjectAsVariant(pyBattles);
   end;
+  UnlockCallback;
 end;
 
+procedure TCallback.LockCallback;
+begin
+  CS.Acquire;
+end;
+procedure TCallback.UnlockCallback;
+begin
+  CS.Release;
+end;
+
 procedure TCallback.ClearRefs;
 begin
   with GetPythonEngine do
@@ -593,6 +686,7 @@
     Py_XDECREF(pyMaps);
     Py_XDECREF(pyReplays);
     Py_XDECREF(pyCurrentBattle);
+    Py_XDECREF(pyTextBoxes);
   end;
 end;
 
@@ -600,6 +694,7 @@
 var
   i: integer;
 begin
+  LockCallback;
   with GetPythonEngine do
   begin
     ClearRefs;
@@ -612,8 +707,14 @@
 
     Result := PyObjectAsVariant(pyGroups);
   end;
+  UnlockCallback;
 end;
 
+function TCallback.GetColors: Variant;
+begin
+  Result := GetPythonEngine.PyObjectAsVariant(pyColors);
+end;
+
 function TCallback.GetMaps: Variant;
 var
   pyMap: PPyObject;
@@ -621,6 +722,7 @@
   pyPositions: PPyObject;
   i,j: integer;
 begin
+  LockCallback;
   with GetPythonEngine do
   begin
     ClearRefs;
@@ -665,6 +767,7 @@
 
     Result := PyObjectAsVariant(pyMaps);
   end;
+  UnlockCallback;
 end;
 
 function TCallback.GetMods: Variant;
@@ -672,6 +775,7 @@
   pyMod: PPyObject;
   i: integer;
 begin
+  LockCallback;
   with GetPythonEngine do
   begin
     ClearRefs;
@@ -688,23 +792,39 @@
 
     Result := PyObjectAsVariant(pyMods);
   end;
+  UnlockCallback;
 end;
 
+procedure JoinBattle;
+begin
+  MainForm.JoinBattle(MainForm.GetBattle(JoinBattleId),false,JoinBattlePassword);
+end;
+
 function TCallback.JoinBattle(battleId: integer; Password: String) : Boolean;
+var
+  b : TBattle;
 begin
   Result := True;
 
-  ReleaseMainThread;
   if BattleState.Status &lt;&gt; None then
   begin
     Result := False;
-    AcquireMainThread;
     Exit;
   end;
 
-  MainForm.JoinBattle(MainForm.GetBattle(battleId),false,Password);
-
-  Result := BattleState.Status = Joined;
+  ReleaseMainThread;
+  ScriptJoining := True;
+  b := MainForm.GetBattle(battleId);
+  if b &lt;&gt; nil then
+  begin
+    JoinBattleId := battleId;
+    JoinBattlePassword := Password;
+    PostMessage(MainForm.Handle,WM_SCRIPT,2,0);
+    ScriptJoining := False;
+    Result := True;
+  end
+  else
+    Result := False;
   AcquireMainThread;
 end;
 
@@ -802,9 +922,7 @@
 begin
   if BattleState.Status &lt;&gt; None then
   begin
-    ReleaseMainThread;
-    BattleForm.DisconnectButtonClick;
-    AcquireMainThread;
+    PostMessage(MainForm.Handle,WM_SCRIPT,1,0);
   end;
 end;
 function TCallback.StartBattle: Boolean;
@@ -845,6 +963,43 @@
   AcquireMainThread;
 end;
 
+function TCallback.GetTextBoxList: Variant;
+begin
+  LockCallback;
+  with GetPythonEngine do
+  begin
+    ClearRefs;
+
+    RefreshTextBoxesLists;
+
+    pyTextBoxes := StringsToPyList(textBoxStringList);
+
+    Result := PyObjectAsVariant(pyTextBoxes)
+  end;
+  UnlockCallback;
+end;
+
+function TCallback.AddToTextBox(textBox : string; msg : string; color : integer): boolean;
+var
+  i: integer;
+begin
+  RefreshTextBoxesLists;
+
+  i := textBoxStringList.IndexOf(textBox);
+
+  Result := i &gt; -1;
+  if Result then
+  begin
+    MsgList.BeginUpdate;
+    RichEditList.Add(textBoxList[i]);
+    MsgList.Add(msg);
+    MsgColor.Add(color);
+    MsgList.EndUpdate;
+
+    PostMessage(MainForm.Handle,WM_SCRIPT,0,0);
+  end;
+end;
+
 { TPyPoint }
 
 // We override the constructors
@@ -867,6 +1022,11 @@
   Result := TCallback;
 end;
 
+class procedure RegisterMethods( PythonType : TPythonType );
+begin
+
+end;
+
 function  TPyCallback.Repr : PPyObject;
 begin
   with GetPythonEngine, DelphiObject as TCallback do
@@ -914,12 +1074,38 @@
 
 procedure AcquireMainThread;
 begin
-   GetPythonEngine.PyEval_AcquireThread(MainThreadState);
+  if Preferences.DisableScripts then Exit;
+  if GetCurrentThreadId &lt;&gt; MainThreadID then Exit;
+  if MainThreadFocused then Exit;
+  GetPythonEngine.PyEval_AcquireThread(MainThreadState);
+  MainThreadFocused := True;
 end;
 
+procedure PostMsgs;
+var
+  i : integer;
+begin
+  for i:=0 to MsgList.Count -1 do
+  begin
+    if RichEditList[i] = nil then // battleform
+      BattleForm.AddTextToChat(MsgList[i],MsgColor.Items[i],0)
+    else
+      MainForm.AddTextToChatWindow(TMyTabSheet(RichEditList[i]),MsgList[i],MsgColor.Items[i] );
+  end;
+  MsgList.BeginUpdate;
+  MsgList.Clear;
+  RichEditList.Clear;
+  MsgColor.Clear;
+  MsgList.EndUpdate;
+end;
+
 procedure ReleaseMainThread;
 begin
-   GetPythonEngine.PyEval_ReleaseThread(MainThreadState);
+  if Preferences.DisableScripts then Exit;
+  if GetCurrentThreadId &lt;&gt; MainThreadID then Exit;
+  if not MainThreadFocused then Exit;
+  GetPythonEngine.PyEval_ReleaseThread(MainThreadState);
+  MainThreadFocused := False;
 end;
 
 procedure PyDict_SetItemStringDecRef(dp: PPyObject; Key: PAnsiChar; const V : Variant);

Modified: branches/0.77-branch/Lobby/TASClient/MainUnit.dfm
===================================================================
--- branches/0.77-branch/Lobby/TASClient/MainUnit.dfm	2008-07-30 12:03:47 UTC (rev 6220)
+++ branches/0.77-branch/Lobby/TASClient/MainUnit.dfm	2008-07-30 13:56:30 UTC (rev 6221)
@@ -1,6 +1,6 @@
 object MainForm: TMainForm
-  Left = 631
-  Top = 286
+  Left = 621
+  Top = 205
   Width = 808
   Height = 549
   Caption = '.'

Modified: branches/0.77-branch/Lobby/TASClient/MainUnit.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/MainUnit.pas	2008-07-30 12:03:47 UTC (rev 6220)
+++ branches/0.77-branch/Lobby/TASClient/MainUnit.pas	2008-07-30 13:56:30 UTC (rev 6221)
@@ -206,7 +206,7 @@
   TBX, SpTBXControls, TBXDkPanels, SpTBXFormPopupMenu,IniFiles,StrUtils,
   TntStdCtrls, SpTBXEditors, Mask, JvExMask, JvSpin,TntComCtrls,JclUnicode,
   GR32_Image, SpTBXTabs, PythonEngine, AtomPythonEngine,VarPyth, PythonGUIInputOutput,
-  WrapDelphi,RichEdit2, ExRichEdit, JvComponentBase, JvMTComponents;
+  WrapDelphi,RichEdit2, ExRichEdit, JvComponentBase, JvMTComponents, class_TIntegerList;
 
 const
   CountryNames: array[0..240] of string = (
@@ -491,7 +491,7 @@
     AdminText: TColor;
   end;
 
-  TTeamColors = array[0..9] of TColor;
+  TTeamColors = array[0..19] of TColor;
 
 const
 
@@ -506,6 +506,16 @@
   $0000FFFF, // yellow
   $00323232, // black
   $00DCC898, // ltblue
+  $0083ABAB,  // tan
+  $0083ABAB,  // tan
+  $0083ABAB,  // tan
+  $0083ABAB,  // tan
+  $0083ABAB,  // tan
+  $0083ABAB,  // tan
+  $0083ABAB,  // tan
+  $0083ABAB,  // tan
+  $0083ABAB,  // tan
+  $0083ABAB,  // tan
   $0083ABAB  // tan
   );
 
@@ -564,6 +574,7 @@
   WM_LOAD_NEXT_MINIMAP = WM_USER + 11; // used with loding missing minimaps from MapListForm (this message is sent to InitWaitForm)
   WM_AFTERCREATE = WM_USER + 12; // we send this signal once we've finished creating all forms. We will do some post-initialization here
   WM_REFRESHOUTPUT = WM_USER + 13; // used to refresh script debug output
+  WM_SCRIPT = WM_USER + 14; // used to add a msg from a script to a textbox (tab RichEdit or battleform)
 
   QUEUE_LENGTH = 4096;
 
@@ -1289,6 +1300,7 @@
     procedure OnConnectMessage(var Msg: TMessage); message WM_CONNECT;
     procedure OnForceReconnectMessage(var Msg: TMessage); message WM_FORCERECONNECT;
     procedure OnConnectToNextHostMessage(var Msg: TMessage); message WM_CONNECT_TO_NEXT_HOST;
+    procedure OnScriptMessage(var Msg: TMessage); message WM_SCRIPT;
     procedure WMAfterCreate(var AMsg: TMessage); message WM_AFTERCREATE; // we will do some post-initialization here
 
     function LoadImagesDynamically: Boolean;
@@ -1401,7 +1413,6 @@
     procedure PageControl1Change(Sender: TObject);
     procedure FormShow(Sender: TObject);
     procedure ClientsListBoxDblClick(Sender: TObject);
-    procedure BattleScreenSpeedButtonClick(Sender: TObject);
     procedure SocketLineLimitExceeded(Sender: TObject; RcvdLength: Integer;
       var ClearData: Boolean);
     procedure VDTBattlesDrawNode(Sender: TBaseVirtualTree;
@@ -3773,6 +3784,7 @@
   tmpre.WantTabs := False;
   tmpre.HideSelection := False;
   tmpre.IncludeOLE := False;
+  tmpre.LangOptions := [];
   tmpre.PopupMenu := RichEditPopupMenu;
   tmpre.OnMouseDown := RichEditMouseDown;
   tmpre.AutoURLDetect := adDefault;
@@ -5416,6 +5428,11 @@
         InitWaitForm.TakeAction := 0; // change mod
         InitWaitForm.ChangeToMod := Battle.ModName;
         InitWaitForm.ShowModal; // this changes mod (see OnFormActivate event)
+          // now let's update units:
+        InitWaitForm.ChangeCaption(MSG_GETUNITS);
+        InitWaitForm.TakeAction := 1; // load unit lists
+        InitWaitForm.ShowModal; // this loads unit lists (see OnFormActivate event)
+        
         Status.Synced := GetModHash(Battle.ModName) = Battle.HashCode;
         if not Status.Synced then
           BattleForm.AddTextToChat('Your mod differs from the host''s one.',Colors.Error,1);
@@ -6954,6 +6971,22 @@
   end;
 end;
 
+procedure TMainForm.OnScriptMessage(var Msg: TMessage);
+begin
+  case Msg.WParam of
+    0: // AddToTextBox
+      LobbyScriptUnit.PostMsgs;
+    1: // LeaveBattle
+    begin
+      BattleForm.DisconnectButtonClick;
+    end;
+    2: // JoinBattle
+    begin
+      LobbyScriptUnit.JoinBattle;
+    end;
+  end;
+end;
+
 procedure TMainForm.TryToSendDataDirectly(s: string); // deprecated - use TryToSendCommand method instead!
 begin;
   if Status.ConnectionState &lt;&gt; Connected then
@@ -7428,11 +7461,6 @@
   OpenPrivateChat(ClientName);
 end;
 
-procedure TMainForm.BattleScreenSpeedButtonClick(Sender: TObject);
-begin
-
-end;
-
 procedure TMainForm.SocketLineLimitExceeded(Sender: TObject;
   RcvdLength: Integer; var ClearData: Boolean);
 begin
@@ -7632,6 +7660,7 @@
   if BattleForm.IsBattleActive then
   begin
     //MessageDlg('You must first disconnect from current battle!', mtInformation, [mbOK], 0);
+    if LobbyScriptUnit.ScriptJoining then Exit;
     if MessageDlg('Do you want to disconnect from the current battle to join this one ?',mtConfirmation, [mbYes,mbNo], 0) = mrYes then
       BattleForm.DisconnectButtonClick(nil)
     else
@@ -7646,6 +7675,7 @@
 
     if ModList.IndexOf(Battle.ModName) = -1 then
     begin
+      if not LobbyScriptUnit.ScriptJoining then
       if MessageDlg('Can''t join: you don''t have the right mod! Do you want to download it now?', mtInformation, [mbYes, mbNo], 0) = mrYes then begin
         //Misc.ParseDelimited(s1,Battle.ModName,' ','.');
         url := '<A HREF="http://spring.jobjol.nl/search_result.php?search=">http://spring.jobjol.nl/search_result.php?search=</A>'+Battle.ModName+'&amp;select=select_all';
@@ -7659,36 +7689,43 @@
   // is battle in progress?
   if Battle.IsBattleInProgress then
   begin
-    MessageDlg('Can''t join: battle is in progress!', mtInformation, [mbOK], 0);
+    if not LobbyScriptUnit.ScriptJoining then
+      MessageDlg('Can''t join: battle is in progress!', mtInformation, [mbOK], 0);
     Exit;
   end;
 
   // is battle locked?
   if Battle.Locked then
   begin
-    MessageDlg('Can''t join: battle is locked!', mtInformation, [mbOK], 0);
+    if not LobbyScriptUnit.ScriptJoining then
+      MessageDlg('Can''t join: battle is locked!', mtInformation, [mbOK], 0);
     Exit;
   end;
 
   // is this battle replay and battle is full?
   if (Battle.BattleType = 1) and (Battle.IsBattleFull) then
   begin
-    MessageDlg('Can''t join: battle is full!', mtInformation, [mbOK], 0);
+    if not LobbyScriptUnit.ScriptJoining then
+      MessageDlg('Can''t join: battle is full!', mtInformation, [mbOK], 0);
     Exit;
   end;
 
   // is our rank to low to join this battle?
-  if Battle.RankLimit &gt; Status.MyRank then
-    if MessageDlg('This battle requires a rank of &lt;' + Ranks[Battle.RankLimit] + '&gt;.' +#13+
-                  'It is impolite to join a battle which requires a rank which you don''t have.' +#13+#13+
-                  'Do you wish to attempt to join this battle anyway?', mtWarning, [mbNo, mbYes], 0) = mrNo then Exit;
+  if not LobbyScriptUnit.ScriptJoining then
+    if Battle.RankLimit &gt; Status.MyRank then
+      if MessageDlg('This battle requires a rank of &lt;' + Ranks[Battle.RankLimit] + '&gt;.' +#13+
+                    'It is impolite to join a battle which requires a rank which you don''t have.' +#13+#13+
+                    'Do you wish to attempt to join this battle anyway?', mtWarning, [mbNo, mbYes], 0) = mrNo then Exit;
 
   if Battle.Password and (Password = '') then
   begin
     if Battle.IsLadderBattle then
       Password := LADDER_BATTLE_PASSWORD
     else
-      if not InputQuery('Password', 'Password:', Password) then Exit;
+      if LobbyScriptUnit.ScriptJoining then
+        Exit
+      else if not InputQuery('Password', 'Password:', Password) then
+        Exit;
   end;
 
   JoinAsSpectator := SpecatorMode;
@@ -7702,7 +7739,8 @@
     res := InitWaitForm.ShowModal;
     if res &lt;&gt; mrOK then
     begin
-      MessageDlg('Unable to acquire UDP source port from server. Try choosing another NAT traversal technique!', mtWarning, [mbOK], 0);
+      if not LobbyScriptUnit.ScriptJoining then
+        MessageDlg('Unable to acquire UDP source port from server. Try choosing another NAT traversal technique!', mtWarning, [mbOK], 0);
       Exit;
     end;
   end;
@@ -8435,7 +8473,7 @@
 begin
   if Preferences.UseSoundNotifications then
     if not Preferences.DisableAllSounds then PlayResSound('notify');
-  if (BattleState.Status &lt;&gt; None) and (Status.Me.InBattle) then
+  if (BattleState.Status &lt;&gt; None) and (Status.Me.GetInGameStatus) then
     Exit;
   DA := TJvDesktopAlert.Create(Self);
   DA.HeaderText := HeaderText;
@@ -8769,7 +8807,7 @@
   while Ini.SectionExists(IntToStr(i)) do begin
     cg := TClientGroup.Create('empty',0);
     cg.Name := Ini.ReadString(IntToStr(i), 'Name', 'Empty');
-    cg.Color := StrToInt(Ini.ReadString(IntToStr(i), 'Color', 'Empty'));
+    cg.Color := StrToInt(Ini.ReadString(IntToStr(i), 'Color', '0'));
     cg.AutoKick := StrToBool(Ini.ReadString(IntToStr(i), 'AutoKick', '0'));
     cg.AutoSpec := StrToBool(Ini.ReadString(IntToStr(i), 'AutoSpec', '0'));
     cg.NotifyOnHost := StrToBool(Ini.ReadString(IntToStr(i), 'NotifyOnHost', '0'));
@@ -9943,6 +9981,8 @@
     RichEditSelectedClient := SelectedBattle.Clients[0];
     ClientPopupMenuInitPopup(nil,nil);
     mnuBattleHost.Caption := RichEditSelectedClient.Name;
+    mnuBattleDlMap.Enabled := Utility.MapList.IndexOf(SelectedBattle.Map) = -1;
+    mnuBattleDlMod.Enabled := Utility.ModList.IndexOf(SelectedBattle.ModName) = -1;
   end;
   mnuBattleHost.Visible := VDTBattles.FocusedNode &lt;&gt; nil;
   mnuBattleAddToFilters.Visible := VDTBattles.FocusedNode &lt;&gt; nil;
@@ -9955,9 +9995,6 @@
   else
     mnuQuickJoinPanel.Caption := 'Show Quick join panel';
 
-  mnuBattleDlMap.Enabled := Utility.MapList.IndexOf(SelectedBattle.Map) = -1;
-  mnuBattleDlMod.Enabled := Utility.ModList.IndexOf(SelectedBattle.ModName) = -1;
-
   VDTBattles.Repaint;
 end;
 
@@ -10436,30 +10473,34 @@
 
 procedure TMainForm.initLobbyScript;
 begin
-
+  if Preferences.DisableScripts then Exit;
   SysModule.path := NewPythonList;
   SysModule.path.append('.\'+SCRIPTS_FOLDER);
 
-  try
-    handlers := Import('handlers');
+  with PyEngine do
+  begin
+    try
+      handlers := Import('handlers');
 
-    with PyEngine do
-    begin
+
       LobbyScriptUnit.MainInterpreterState := PyThreadState_Get.interp;
       LobbyScriptUnit.MainThreadState := PyThreadState_Get;
       LobbyScriptUnit.ScriptHostingRunning := False;
       LobbyScriptUnit.ScriptHostingReplayRunning := False;
       LobbyScriptUnit.ScriptJoining := False;
       LobbyScriptUnit.ScriptStart := False;
+      LobbyScriptUnit.MsgList := TStringList.Create;
+      LobbyScriptUnit.RichEditList := TList.Create;
+      LobbyScriptUnit.MsgColor := TIntegerList.Create;
 
       handlers._load;
 
       PyEval_ReleaseThread(LobbyScriptUnit.MainThreadState);
+    except
+      Preferences.DisableScripts := True;
+      AddMainLog('An error occured when initializing the scripts.',Colors.Error);
     end;
-  except
   end;
-
-
 end;
 
 procedure TMainForm.PyInOutSendData(Sender: TObject;

Modified: branches/0.77-branch/Lobby/TASClient/Misc.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/Misc.pas	2008-07-30 12:03:47 UTC (rev 6220)
+++ branches/0.77-branch/Lobby/TASClient/Misc.pas	2008-07-30 13:56:30 UTC (rev 6221)
@@ -397,6 +397,8 @@
 
   Text := Tnt_WideStringReplace(Text,#$0B,' ',[rfReplaceAll]);
 
+
+
   // save the scroll pos
   SelStart := RichEdit.SelStart;
   SelLength := RichEdit.SelLength;
@@ -410,7 +412,6 @@
        RichEdit.SelText   := '';
     end;
 
-
     RichEdit.SelLength := 0;
     RichEdit.SelStart := RichEdit.GetTextLen;
 
@@ -434,7 +435,10 @@
     if not Scroll or (p.Y &lt; Max(0,pMax.Y-20)) then
       SendMessage(RichEdit.Handle, WM_USER + 222 {EM_SETSCROLLPOS}, 0, LPARAM(@p))
     else
+    begin
       RichEdit.ScrollToBottom;
+      RichEdit.ScrollPageDown;
+    end;
 
   except
   end;

Modified: branches/0.77-branch/Lobby/TASClient/PreferencesFormUnit.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/PreferencesFormUnit.pas	2008-07-30 12:03:47 UTC (rev 6220)
+++ branches/0.77-branch/Lobby/TASClient/PreferencesFormUnit.pas	2008-07-30 13:56:30 UTC (rev 6221)
@@ -77,6 +77,8 @@
     ChatLogsLimit: integer;
 
     SPSkin: string;
+
+    DisableScripts: Boolean;
   end;
 
   TPreferencesForm = class(TForm)
@@ -259,7 +261,7 @@
   end;
 
 const
-  DEFAULT_PREFERENCES: TPreferences = (ServerIP:'taspringmaster.clan-sy.com'; ServerPort:'8200'; TabStyle:0; TimeStamps: True; Username:''; Password:''; ConnectOnStartup: False; SortStyle: 1; BattleSortStyle: 1; BattleSortDirection: 0; BattleClientSortStyle: 2;FilterJoinLeftMessages: False;FilterBattleJoinLeftMessages: False; ShowFlags: True; MarkUnknownMaps: True; TaskbarButtons: True; JoinMainChannel: True; ReconnectToBackup: True; SaveLogs: True; UseSoundNotifications: True;AutoCompletionFromCurrentChannel: False; CheckForNewVersion: False; UseProxy: False; HighlightColor: 'Green'; UseNotificationsForHighlights: True; UseIgnoreList: False; WarnIfUsingNATTraversing: True; AutoFocusOnPM: True; MapSortStyle: 1; ThemeType: thtTBX; Theme: 'Miranda'; DisableAllSounds: False; SortLocal: False; DisplayQuickJoinPanel : True; LimitChatLogs: False; ChatLogsLimit: 800; SPSkin: 'default.ssk');
+  DEFAULT_PREFERENCES: TPreferences = (ServerIP:'taspringmaster.clan-sy.com'; ServerPort:'8200'; TabStyle:0; TimeStamps: True; Username:''; Password:''; ConnectOnStartup: False; SortStyle: 1; BattleSortStyle: 1; BattleSortDirection: 0; BattleClientSortStyle: 2;FilterJoinLeftMessages: False;FilterBattleJoinLeftMessages: False; ShowFlags: True; MarkUnknownMaps: True; TaskbarButtons: True; JoinMainChannel: True; ReconnectToBackup: True; SaveLogs: True; UseSoundNotifications: True;AutoCompletionFromCurrentChannel: False; CheckForNewVersion: False; UseProxy: False; HighlightColor: 'Green'; UseNotificationsForHighlights: True; UseIgnoreList: False; WarnIfUsingNATTraversing: True; AutoFocusOnPM: True; MapSortStyle: 1; ThemeType: thtTBX; Theme: 'Miranda'; DisableAllSounds: False; SortLocal: False; DisplayQuickJoinPanel : True; LimitChatLogs: False; ChatLogsLimit: 800; SPSkin: 'default.ssk'; DisableScripts : False);
 
 var
   PreferencesForm: TPreferencesForm;

Modified: branches/0.77-branch/Lobby/TASClient/Python/scripts/stick.py
===================================================================
--- branches/0.77-branch/Lobby/TASClient/Python/scripts/stick.py	2008-07-30 12:03:47 UTC (rev 6220)
+++ branches/0.77-branch/Lobby/TASClient/Python/scripts/stick.py	2008-07-30 13:56:30 UTC (rev 6221)
@@ -1,73 +1,107 @@
+import time,thread
 import lobbyscript
+
 api = lobbyscript.Callback()
 
 stickingNick = ''
 specMode = 0
 battleJoinedAndStatusChanged = 0
-stickJoin = 0
+stickJoin = False
 
+colors = api.GetColors()
+
+# exit stick mode if the sticked user left
+def in_REMOVEUSER(nick):
+  global stickingNick
+  if nick == stickingNick:
+    stickingNick = ''
+    api.AddToTextBox('$current','Exiting stick mode ('+nick+' left).',colors['Info'])
+
+
+# we're joining a battle and we start waiting for 2 in_CLIENTBATTLESTATUS 
 def in_JOINBATTLE(data):
   global battleJoinedAndStatusChanged
   global specMode
   global stickJoin
-  if specMode and stickJoin:
-    stickJoin = 0
+  if specMode != '0' and stickJoin:
+    stickJoin = False
     battleJoinedAndStatusChanged = 2
-  
+
+def in_FORCEQUITBATTLE():
+  global stickingNick
+  stickingNick = ''
+  api.AddToTextBox('$current','Exiting stick mode (You were kicked from the battle).',colors['Info'])
+
+# when joining a battle we wait for the two CLIENTBATTLESTATUS from server 
+# and then we set us to spectator if the option is checked 
 def in_CLIENTBATTLESTATUS(nick, status, color):
   global battleJoinedAndStatusChanged
   global specMode
-  if specMode:
-    if nick == api.GetMyUser()['Name']:
-      battleJoinedAndStatusChanged -= 1
-      if battleJoinedAndStatusChanged==0:
-        api.SetMyBattleStatus(1)
+  if specMode == '1':
+    if nick == api.GetMyUser()['Name'] and battleJoinedAndStatusChanged &gt; 0: 
+      battleJoinedAndStatusChanged -= 1   
+      api.SetMyBattleStatus(1)
+        
 
-def in_BATTLEOPENED(a,b,c,nick,d,e,f,g,battleId,data):
-  if stickingNick == nick:
-    if api.GetCurrentBattle() != None:
-      api.LeaveBattle()
-    global stickJoin
-    stickJoin = 1
-    api.JoinBattle(battleId,'')
+# the timer tryin to connect you to the sticked user
+def timer_2():
+  global stickingNick
+  global specMode
+  global stickJoin
+  
+  if stickingNick != '': 
+    curBat = api.GetCurrentBattle()
+    if curBat != None:
+      curBat = dict(curBat)
+    users = dict(api.GetUsers())
+    if stickingNick in users:
+      if 'Battle' in users[stickingNick]:
+        if curBat != None:
+          if curBat['Battle']['Id'] == users[stickingNick]['Battle']['Id']:
+            return
+          else:
+            api.LeaveBattle()
+        mods = dict(api.GetMods())
+        if users[stickingNick]['Battle']['ModName'] in mods:
+          stickJoin = True
+          api.JoinBattle(users[stickingNick]['Battle']['Id'],'')
+      else:
+        api.LeaveBattle()
 
-def in_JOINEDBATTLE(battleId, nick):
-  if stickingNick == nick:
-    if api.GetCurrentBattle() != None:
-      api.LeaveBattle()
-    global stickJoin
-    stickJoin = 1
-    api.JoinBattle(battleId,'')
-    
-def in_LEFTBATTLE(battleId, nick):
-  if stickingNick == nick:
-    if api.GetCurrentBattle() != None:
-      api.LeaveBattle()
-      
 def cmd_unstick():
   global stickingNick
   stickingNick = ''
-  print 'Exiting stick mode.' 
+  api.AddToTextBox('$current','Exiting stick mode.',colors['Info'])
+  return True
 
-def cmd_stick(nick, spec):
+def cmd_stick(data):
+  args = data.split(' ')
+
+
+  if len(args) != 2:
+      api.AddToTextBox('$current',&quot;Stick usage : /stick user joinAsSpec={0/1} (Ex : '/stick haxor465 1' will join as spectator every battle the player haxor465 joins.&quot;,colors['Error'])
+      return 1
+  nick = args[0]
+  spec = args[1]
   global stickingNick
   global specMode
   
   if stickingNick != '':
-    print 'Exiting stick mode.'
+    api.AddToTextBox('$current','Exiting stick mode.',colors['Info'])
  
   users = api.GetUsers()
   if nick in users:
     stickingNick = nick
     specMode = spec
-    print 'Entering sticking mode on : '+nick
+    if specMode == '1':
+      api.AddToTextBox('$current','Entering spectator sticking mode on : '+nick,colors['Info'])
+    else:
+      api.AddToTextBox('$current','Entering sticking mode on : '+nick,colors['Info'])
+    api.AddToTextBox('$current','Type /unstick to leave that mode.',colors['Info'])
     
-    if 'Battle' in users[nick]:
-      if api.GetCurrentBattle() != None:
-        api.LeaveBattle()
-      api.JoinBattle(users[nick]['Battle']['Id'],'')
   else:
     stickingNick = ''
-    print 'User does not exist.'
+    api.AddToTextBox('$current',&quot;User '&quot;+nick+&quot;' does not exist.&quot;,colors['Error'])
 
+  # the command won't be processed by the lobby
   return True
\ No newline at end of file

Modified: branches/0.77-branch/Lobby/TASClient/TASClient.dof
===================================================================
--- branches/0.77-branch/Lobby/TASClient/TASClient.dof	2008-07-30 12:03:47 UTC (rev 6220)
+++ branches/0.77-branch/Lobby/TASClient/TASClient.dof	2008-07-30 13:56:30 UTC (rev 6221)
@@ -115,7 +115,7 @@
 MajorVer=0
 MinorVer=3
 Release=0
-Build=366
+Build=378
 Debug=0
 PreRelease=0
 Special=0
@@ -126,7 +126,7 @@
 [Version Info Keys]
 CompanyName=
 FileDescription=TA Spring lobby client
-FileVersion=0.3.0.366
+FileVersion=0.3.0.378
 InternalName=
 LegalCopyright=
 LegalTrademarks=
@@ -141,5 +141,6 @@
 Count=1
 Item0=C:\Program Files\TASpring
 [HistoryLists\hlOutputDirectorry]
-Count=1
-Item0=C:\Program Files\TASpring
+Count=2
+Item0=C:\Program Files\Spring
+Item1=C:\Program Files\TASpring

Modified: branches/0.77-branch/Lobby/TASClient/TASClient.res
===================================================================
(Binary files differ)

Modified: branches/0.77-branch/Lobby/TASClient/Utility.pas
===================================================================
--- branches/0.77-branch/Lobby/TASClient/Utility.pas	2008-07-30 12:03:47 UTC (rev 6220)
+++ branches/0.77-branch/Lobby/TASClient/Utility.pas	2008-07-30 13:56:30 UTC (rev 6221)
@@ -520,6 +520,9 @@
 begin
   UnitNames.Clear;
   UnitList.Clear;
+  for i:=0 to UnitBitmaps.Count-1 do
+    TBitmap(UnitBitmaps[i]).Free;
+  UnitBitmaps.Clear;
 
   // first process all units (this may take some time):
   while ProcessUnitsNoChecksum &lt;&gt; 0 do;

Modified: branches/0.77-branch/rts/Game/Game.cpp
===================================================================
--- branches/0.77-branch/rts/Game/Game.cpp	2008-07-30 12:03:47 UTC (rev 6220)
+++ branches/0.77-branch/rts/Game/Game.cpp	2008-07-30 13:56:30 UTC (rev 6221)
@@ -498,7 +498,7 @@
 	if (!saveFile) {
 		UnloadStartPicture();
 	}
-	
+
 	net-&gt;loading = false;
 	thread.join();
 	logOutput.Print(&quot;Spring %s&quot;,VERSION_STRING);
@@ -568,7 +568,7 @@
 	delete pathManager;        pathManager        = NULL;
 	delete groundDecals;       groundDecals       = NULL;
 	delete ground;             ground             = NULL;
-	delete luaInputReceiver;   luaInputReceiver   = NULL; 
+	delete luaInputReceiver;   luaInputReceiver   = NULL;
 	delete inMapDrawer;        inMapDrawer        = NULL;
 	delete net;                net                = NULL;
 	delete radarhandler;       radarhandler       = NULL;
@@ -2499,7 +2499,7 @@
 	SCOPED_TIMER(&quot;Draw world&quot;);
 
 	CBaseGroundDrawer* gd = readmap-&gt;GetGroundDrawer();
-	
+
 	if (drawSky) {
 		sky-&gt;Draw();
 	}
@@ -3563,8 +3563,8 @@
 							logOutput.Print(&quot;Got invalid unitid %i in netselect msg&quot;,unitid);
 							break;
 						}
-						if (uh-&gt;units[unitid] &amp;&amp;
-						    (uh-&gt;units[unitid]-&gt;team == gs-&gt;players[player]-&gt;team) ||
+						if ((uh-&gt;units[unitid] &amp;&amp;
+						    (uh-&gt;units[unitid]-&gt;team == gs-&gt;players[player]-&gt;team)) ||
 						    gs-&gt;godMode) {
 							selected.push_back(unitid);
 						}
@@ -3746,7 +3746,10 @@
 					for (ui = netSelUnits.begin(); ui != netSelUnits.end(); ++ui){
 						CUnit* unit = uh-&gt;units[*ui];
 						if (unit &amp;&amp; unit-&gt;team==team1 &amp;&amp; !unit-&gt;beingBuilt) {
-							unit-&gt;ChangeTeam(team2, CUnit::ChangeGiven);
+#ifdef DIRECT_CONTROL_ALLOWED
+							if (!unit-&gt;directControl)
+#endif
+								unit-&gt;ChangeTeam(team2, CUnit::ChangeGiven);
 						}
 					}
 					netSelUnits.clear();

Modified: branches/0.77-branch/rts/Game/UI/SelectionKeyHandler.cpp
===================================================================
--- branches/0.77-branch/rts/Game/UI/SelectionKeyHandler.cpp	2008-07-30 12:03:47 UTC (rev 6220)
+++ branches/0.77-branch/rts/Game/UI/SelectionKeyHandler.cpp	2008-07-30 13:56:30 UTC (rev 6221)
@@ -256,12 +256,10 @@
 				}
 			}
 		} else if(s==&quot;Commander&quot;){
-			unsigned int comCat=CCategoryHandler::Instance()-&gt;GetCategory(&quot;COMMANDER&quot;);
-
 			std::list&lt;CUnit*&gt;::iterator ui=selection.begin();
 			while (ui!=selection.end()) {
 				bool filterTrue=false;
-				if ((*ui)-&gt;category &amp; comCat){	//fix with better test for commander
+				if((*ui)-&gt;unitDef-&gt;isCommander){
 					filterTrue=true;
 				}
 				if (filterTrue ^ _not) {
@@ -286,12 +284,11 @@
 				}
 			}
 		} else if(s==&quot;Aircraft&quot;){
-			unsigned int acCat=CCategoryHandler::Instance()-&gt;GetCategory(&quot;VTOL&quot;);
 
 			std::list&lt;CUnit*&gt;::iterator ui=selection.begin();
 			while (ui != selection.end()) {
 				bool filterTrue=false;
-				if ((*ui)-&gt;category &amp; acCat){
+				if ((*ui)-&gt;unitDef-&gt;canfly){
 					filterTrue=true;
 				}
 				if (filterTrue ^ _not) {

Modified: branches/0.77-branch/rts/Lua/LuaHandleSynced.cpp
===================================================================
--- branches/0.77-branch/rts/Lua/LuaHandleSynced.cpp	2008-07-30 12:03:47 UTC (rev 6220)
+++ branches/0.77-branch/rts/Lua/LuaHandleSynced.cpp	2008-07-30 13:56:30 UTC (rev 6221)
@@ -193,15 +193,15 @@
 
 	LuaPushNamedNumber(L, &quot;COBSCALE&quot;, COBSCALE);
 	
-	// load our libraries
+	// load our libraries  (LuaSyncedCtrl overrides some LuaUnsyncedCtrl entries)
 	if (!AddEntriesToTable(L, &quot;VFS&quot;,         LuaVFS::PushSynced)           ||
 	    !AddEntriesToTable(L, &quot;UnitDefs&quot;,    LuaUnitDefs::PushEntries)     ||
 	    !AddEntriesToTable(L, &quot;WeaponDefs&quot;,  LuaWeaponDefs::PushEntries)   ||
 	    !AddEntriesToTable(L, &quot;FeatureDefs&quot;, LuaFeatureDefs::PushEntries)  ||
 	    !AddEntriesToTable(L, &quot;Script&quot;,      LuaSyncedCall::PushEntries)   ||
+	    !AddEntriesToTable(L, &quot;Spring&quot;,      LuaUnsyncedCtrl::PushEntries) ||
 	    !AddEntriesToTable(L, &quot;Spring&quot;,      LuaSyncedCtrl::PushEntries)   ||
 	    !AddEntriesToTable(L, &quot;Spring&quot;,      LuaSyncedRead::PushEntries)   ||
-	    !AddEntriesToTable(L, &quot;Spring&quot;,      LuaUnsyncedCtrl::PushEntries) ||
 	    !AddEntriesToTable(L, &quot;Game&quot;,        LuaConstGame::PushEntries)    ||
 	    !AddEntriesToTable(L, &quot;CMD&quot;,         LuaConstCMD::PushEntries)     ||
 	    !AddEntriesToTable(L, &quot;CMDTYPE&quot;,     LuaConstCMDTYPE::PushEntries)) {

Modified: branches/0.77-branch/rts/Lua/LuaUnsyncedCtrl.h
===================================================================
--- branches/0.77-branch/rts/Lua/LuaUnsyncedCtrl.h	2008-07-30 12:03:47 UTC (rev 6220)
+++ branches/0.77-branch/rts/Lua/LuaUnsyncedCtrl.h	2008-07-30 13:56:30 UTC (rev 6221)
@@ -8,6 +8,8 @@
 
 struct lua_State;
 
+// MinGW defines this for a WINAPI function
+#undef SendMessage
 
 class LuaUnsyncedCtrl {
 	public:

Modified: branches/0.77-branch/rts/Sim/Units/CommandAI/BuilderCAI.cpp
===================================================================
--- branches/0.77-branch/rts/Sim/Units/CommandAI/BuilderCAI.cpp	2008-07-30 12:03:47 UTC (rev 6220)
+++ branches/0.77-branch/rts/Sim/Units/CommandAI/BuilderCAI.cpp	2008-07-30 13:56:30 UTC (rev 6221)
@@ -236,7 +236,7 @@
 	if (obj == NULL) {
 		return false;
 	}
-	
+
 	switch (cmd.id) {
 		case CMD_REPAIR:
 		case CMD_RECLAIM:
@@ -359,7 +359,7 @@
 	}
 
 	map&lt;int, string&gt;::iterator boi = buildOptions.find(c.id);
-	if (boi != buildOptions.end()) {
+	if (!owner-&gt;beingBuilt &amp;&amp; boi != buildOptions.end()) {
 		const UnitDef* ud = unitDefHandler-&gt;GetUnitByName(boi-&gt;second);
 		const float radius = GetUnitDefRadius(ud, c.id);
 		if (inCommand) {

Modified: branches/0.77-branch/rts/Sim/Units/UnitTypes/Builder.cpp
===================================================================
--- branches/0.77-branch/rts/Sim/Units/UnitTypes/Builder.cpp	2008-07-30 12:03:47 UTC (rev 6220)
+++ branches/0.77-branch/rts/Sim/Units/UnitTypes/Builder.cpp	2008-07-30 13:56:30 UTC (rev 6221)
@@ -328,7 +328,7 @@
 			} else {
 				curCapture-&gt;captureProgress = captureProgressTemp;
 				CreateNanoParticle(curCapture-&gt;midPos,curCapture-&gt;radius*0.7f,false);
-				if(curCapture-&gt;captureProgress &gt; 1.0f){
+				if(curCapture-&gt;captureProgress &gt;= 1.0f){
 					if (!curCapture-&gt;ChangeTeam(team, CUnit::ChangeCaptured)) {
 						// capture failed
 						ENTER_MIXED;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001000.html">[Taspring-linux-commit] r6220 - trunk/rts/Game/UI
</A></li>
	<LI>Next message: <A HREF="001002.html">[Taspring-linux-commit] r6222 - branches/0.77-branch/rts/Game
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1001">[ date ]</a>
              <a href="thread.html#1001">[ thread ]</a>
              <a href="subject.html#1001">[ subject ]</a>
              <a href="author.html#1001">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
