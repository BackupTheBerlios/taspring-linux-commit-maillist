<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r5907 - in trunk/rts: ExternalAI Game	Game/UI Lua Rendering/UnitModels Sim/Features Sim/Misc	Sim/Units Sim/Units/COB Sim/Weapons System System/Net	System/Net/Test
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-May/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5907%20-%20in%20trunk/rts%3A%20ExternalAI%20Game%0A%09Game/UI%20Lua%20Rendering/UnitModels%20Sim/Features%20Sim/Misc%0A%09Sim/Units%20Sim/Units/COB%20Sim/Weapons%20System%20System/Net%0A%09System/Net/Test&In-Reply-To=%3C20080518021355.50FC64179%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000686.html">
   <LINK REL="Next"  HREF="000688.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r5907 - in trunk/rts: ExternalAI Game	Game/UI Lua Rendering/UnitModels Sim/Features Sim/Misc	Sim/Units Sim/Units/COB Sim/Weapons System System/Net	System/Net/Test</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5907%20-%20in%20trunk/rts%3A%20ExternalAI%20Game%0A%09Game/UI%20Lua%20Rendering/UnitModels%20Sim/Features%20Sim/Misc%0A%09Sim/Units%20Sim/Units/COB%20Sim/Weapons%20System%20System/Net%0A%09System/Net/Test&In-Reply-To=%3C20080518021355.50FC64179%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r5907 - in trunk/rts: ExternalAI Game	Game/UI Lua Rendering/UnitModels Sim/Features Sim/Misc	Sim/Units Sim/Units/COB Sim/Weapons System System/Net	System/Net/Test">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Sun May 18 04:13:55 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000686.html">[Taspring-linux-commit] r5906 -	site/trunk/www-root/forums/styles/spring/template
</A></li>
        <LI>Next message: <A HREF="000688.html">[Taspring-linux-commit] r5908 - trunk/rts/Sim/Units
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#687">[ date ]</a>
              <a href="thread.html#687">[ thread ]</a>
              <a href="subject.html#687">[ subject ]</a>
              <a href="author.html#687">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: trepan
Date: 2008-05-18 04:13:53 +0200 (Sun, 18 May 2008)
New Revision: 5907

Modified:
   trunk/rts/ExternalAI/AICallback.cpp
   trunk/rts/Game/CameraHandler.h
   trunk/rts/Game/Console.cpp
   trunk/rts/Game/Console.h
   trunk/rts/Game/Game.cpp
   trunk/rts/Game/Game.h
   trunk/rts/Game/GameServer.h
   trunk/rts/Game/PreGame.cpp
   trunk/rts/Game/PreGame.h
   trunk/rts/Game/UI/KeyBindings.h
   trunk/rts/Game/UI/MiniMap.cpp
   trunk/rts/Lua/LuaFeatureDefs.cpp
   trunk/rts/Lua/LuaSyncedCtrl.cpp
   trunk/rts/Lua/LuaSyncedCtrl.h
   trunk/rts/Lua/LuaSyncedRead.cpp
   trunk/rts/Lua/LuaWeaponDefs.cpp
   trunk/rts/Rendering/UnitModels/UnitDrawer.cpp
   trunk/rts/Sim/Features/FeatureDef.h
   trunk/rts/Sim/Features/FeatureHandler.cpp
   trunk/rts/Sim/Misc/LosHandler.h
   trunk/rts/Sim/Units/COB/CobInstance.cpp
   trunk/rts/Sim/Units/Unit.cpp
   trunk/rts/Sim/Units/Unit.h
   trunk/rts/Sim/Weapons/WeaponDefHandler.cpp
   trunk/rts/Sim/Weapons/WeaponDefHandler.h
   trunk/rts/System/AutohostInterface.h
   trunk/rts/System/Net/Connection.cpp
   trunk/rts/System/Net/Connection.h
   trunk/rts/System/Net/LocalConnection.cpp
   trunk/rts/System/Net/Net.cpp
   trunk/rts/System/Net/Net.h
   trunk/rts/System/Net/Test/main.cpp
   trunk/rts/System/Net/UDPConnectedSocket.h
   trunk/rts/System/Net/UDPConnection.cpp
   trunk/rts/System/NetProtocol.h
Log:
* Added the following LuaSyncedCtrl call-outs:
    - SetUnitLosMask(unitID, allyTeamID, number | table) -&gt; nil
    - SetUnitLosState(unitID, allyTeamID, number | table) -&gt; nil
  - If a mask bit is enabled, than the engine will not update
    the corresponding state bit (think of them as 'lock' bits)
  - If a table is used, entries should be of the form:
    { string = boolean } -- 'false' to clear, 'true' to set
    ex:  SetUnitLosState(3, 2, { los = true, radar = false })
  - The valid strings are 'los', 'radar', 'prevLos', and 'contRadar'
      prevLos:    previous LOS
      contRadar:  continuous radar  (since prevLos contact)
      *** These 2 dictate whether or not a unit type is known
* Replaced LOS_INTEAM with the LOS_xxx_MASK bits
* Changed the losStatus array from 'int' to 'unsigned short'
* Minimap and UnitDrawer now rely on the losStatus for unit
  visibility, and do not take the allyTeam shortcut

* Added the 'customParams' table to both featureDefs and weaponDefs
  (accessible via the lua FeatureDefs and WeaponDefs' tables)

* Did some indent/whitespace clean-up in Game.cpp

* Globally replaced  s/Recieve/Receive


Modified: trunk/rts/ExternalAI/AICallback.cpp
===================================================================
--- trunk/rts/ExternalAI/AICallback.cpp	2008-05-17 23:59:04 UTC (rev 5906)
+++ trunk/rts/ExternalAI/AICallback.cpp	2008-05-18 02:13:53 UTC (rev 5907)
@@ -556,8 +556,8 @@
 			if (gs-&gt;Ally(unit-&gt;allyteam, allyTeam)) {
 				return unitDef;
 			}
-			const int losStatus = unit-&gt;losStatus[allyTeam];
-			const int prevMask = (LOS_PREVLOS | LOS_CONTRADAR);
+			const unsigned short losStatus = unit-&gt;losStatus[allyTeam];
+			const unsigned short prevMask = (LOS_PREVLOS | LOS_CONTRADAR);
 			if (((losStatus &amp; LOS_INLOS) != 0) ||
 					((losStatus &amp; prevMask) == prevMask)) {
 				const UnitDef* decoyDef = unitDef-&gt;decoyDef;

Modified: trunk/rts/Game/CameraHandler.h
===================================================================
--- trunk/rts/Game/CameraHandler.h	2008-05-17 23:59:04 UTC (rev 5906)
+++ trunk/rts/Game/CameraHandler.h	2008-05-18 02:13:53 UTC (rev 5907)
@@ -11,7 +11,7 @@
 class CCameraController;
 
 
-class CCameraHandler : public CommandReciever
+class CCameraHandler : public CommandReceiver
 {
 public:
 	CCameraHandler();

Modified: trunk/rts/Game/Console.cpp
===================================================================
--- trunk/rts/Game/Console.cpp	2008-05-17 23:59:04 UTC (rev 5906)
+++ trunk/rts/Game/Console.cpp	2008-05-18 02:13:53 UTC (rev 5907)
@@ -3,9 +3,9 @@
 #include &quot;LogOutput.h&quot;
 #include &quot;Action.h&quot;
 
-void CommandReciever::RegisterAction(const std::string&amp; name)
+void CommandReceiver::RegisterAction(const std::string&amp; name)
 {
-	Console::Instance().AddCommandReciever(name, this);
+	Console::Instance().AddCommandReceiver(name, this);
 }
 
 Console&amp; Console::Instance()
@@ -14,7 +14,7 @@
 	return myInstance;
 }
 
-void Console::AddCommandReciever(const std::string&amp; name, CommandReciever* rec)
+void Console::AddCommandReceiver(const std::string&amp; name, CommandReceiver* rec)
 {
 	if (commandMap.find(name) != commandMap.end())
 		logOutput.Print(&quot;Overwriting command: %s&quot;, name.c_str());
@@ -26,14 +26,14 @@
 	if (action.command == &quot;commands&quot;)
 	{
 		logOutput.Print(&quot;Registered commands:&quot;);
-		for (std::map&lt;const std::string, CommandReciever*&gt;::iterator it = commandMap.begin(); it != commandMap.end(); ++it)
+		for (std::map&lt;const std::string, CommandReceiver*&gt;::iterator it = commandMap.begin(); it != commandMap.end(); ++it)
 		{
 			logOutput.Print(it-&gt;first);
 		}
 		return true;
 	}
 	
-	std::map&lt;const std::string, CommandReciever*&gt;::iterator it = commandMap.find(action.command);
+	std::map&lt;const std::string, CommandReceiver*&gt;::iterator it = commandMap.find(action.command);
 	if (it == commandMap.end())
 		return false;
 	else

Modified: trunk/rts/Game/Console.h
===================================================================
--- trunk/rts/Game/Console.h	2008-05-17 23:59:04 UTC (rev 5906)
+++ trunk/rts/Game/Console.h	2008-05-18 02:13:53 UTC (rev 5907)
@@ -9,11 +9,11 @@
 /**
 @brief this class can recieve commands (actions)
  */
-class CommandReciever
+class CommandReceiver
 {
 public:
-	CommandReciever() {};
-	virtual ~CommandReciever() {};
+	CommandReceiver() {};
+	virtual ~CommandReceiver() {};
 	
 	/**
 	@brief callback function for all registered commands
@@ -40,9 +40,9 @@
 	/**
 	@brief register a command
 	@param name the name of the command (e.g. &quot;cheat&quot;)
-	@param rec the CommandReciever who want to recieve the command
+	@param rec the CommandReceiver who want to recieve the command
 	*/
-	void AddCommandReciever(const std::string&amp; name, CommandReciever* rec);
+	void AddCommandReceiver(const std::string&amp; name, CommandReceiver* rec);
 	
 	/**
 	@brief Execute an action
@@ -52,7 +52,7 @@
 private:
 	Console();
 	~Console();
-	std::map&lt;const std::string, CommandReciever*&gt; commandMap;
+	std::map&lt;const std::string, CommandReceiver*&gt; commandMap;
 };
 
 #endif

Modified: trunk/rts/Game/Game.cpp
===================================================================
--- trunk/rts/Game/Game.cpp	2008-05-17 23:59:04 UTC (rev 5906)
+++ trunk/rts/Game/Game.cpp	2008-05-18 02:13:53 UTC (rev 5907)
@@ -928,13 +928,13 @@
 	}
 	else if (cmd == &quot;w&quot;) {
 		const int pos = action.extra.find_first_of(&quot; &quot;);
-		if (pos != std::string::npos)
-		{
+		if (pos != std::string::npos) {
 			const int playernum = gs-&gt;Player(action.extra.substr(0, pos));
-			if (playernum &gt;= 0)
+			if (playernum &gt;= 0) {
 				SendNetChat(action.extra.substr(pos+1), playernum);
-			else
+			} else {
 				logOutput.Print(&quot;Player not found: %s&quot;, action.extra.substr(0, pos).c_str());
+			}
 		}
 	}
 	else if (cmd == &quot;echo&quot;) {
@@ -942,24 +942,21 @@
 	}
 	else if (cmd == &quot;setf&quot;) {
 		const int pos = action.extra.find_first_of(&quot; &quot;);
-		if (pos != std::string::npos)
-		{
+		if (pos != std::string::npos) {
 			const std::string varName = action.extra.substr(0, pos);
 			configHandler.SetFloat(varName, atof(action.extra.substr(pos+1).c_str()));
 		}
 	}
 	else if (cmd == &quot;seti&quot;) {
 		const int pos = action.extra.find_first_of(&quot; &quot;);
-		if (pos != std::string::npos)
-		{
+		if (pos != std::string::npos) {
 			const std::string varName = action.extra.substr(0, pos);
 			configHandler.SetInt(varName, atoi(action.extra.substr(pos+1).c_str()));
 		}
 	}
 	else if (cmd == &quot;sets&quot;) {
 		const int pos = action.extra.find_first_of(&quot; &quot;);
-		if (pos != std::string::npos)
-		{
+		if (pos != std::string::npos) {
 			const std::string varName = action.extra.substr(0, pos);
 			configHandler.SetString(varName, action.extra.substr(pos+1));
 		}
@@ -1936,7 +1933,7 @@
 	}
 }
 
-void CGame::ActionRecieved(const Action&amp; action, int playernum)
+void CGame::ActionReceived(const Action&amp; action, int playernum)
 {
 	if (action.command == &quot;cheat&quot;) {
 		SetBoolArg(gs-&gt;cheatEnabled, action.extra);
@@ -2178,29 +2175,30 @@
 		if (gs-&gt;useLuaRules) {
 			if (action.extra == &quot;reload&quot;) {
 				if (!gs-&gt;cheatEnabled) {
-					logOutput.Print(&quot;Cheating required to reload synced scripts\n&quot;);
+					logOutput.Print(&quot;Cheating required to reload synced scripts&quot;);
 				} else {
 					CLuaRules::FreeHandler();
 					CLuaRules::LoadHandler();
-					if (luaRules)
-						logOutput.Print(&quot;LuaRules reloaded\n&quot;);
-					else
-						logOutput.Print(&quot;LuaRules reload failed\n&quot;);
+					if (luaRules) {
+						logOutput.Print(&quot;LuaRules reloaded&quot;);
+					} else {
+						logOutput.Print(&quot;LuaRules reload failed&quot;);
+					}
 				}
 			}
 			else if (action.extra == &quot;disable&quot;) {
 				if (!gs-&gt;cheatEnabled) {
-					logOutput.Print(&quot;Cheating required to disable synced scripts\n&quot;);
+					logOutput.Print(&quot;Cheating required to disable synced scripts&quot;);
 				} else {
 					CLuaRules::FreeHandler();
-					logOutput.Print(&quot;LuaRules disabled\n&quot;);
+					logOutput.Print(&quot;LuaRules disabled&quot;);
 				}
 			}
 			else if (luaRules) {
 				luaRules-&gt;GotChatMsg(action.extra, playernum);
 			}
 			else {
-				logOutput.Print(&quot;LuaRules is not enabled\n&quot;);
+				logOutput.Print(&quot;LuaRules is not enabled&quot;);
 			}
 		}
 	}
@@ -2208,30 +2206,30 @@
 		if (gs-&gt;useLuaGaia) {
 			if (action.extra == &quot;reload&quot;) {
 				if (!gs-&gt;cheatEnabled) {
-					logOutput.Print(&quot;Cheating required to reload synced scripts\n&quot;);
+					logOutput.Print(&quot;Cheating required to reload synced scripts&quot;);
 				} else {
 					CLuaGaia::FreeHandler();
 					CLuaGaia::LoadHandler();
 					if (luaGaia) {
-						logOutput.Print(&quot;LuaGaia reloaded\n&quot;);
+						logOutput.Print(&quot;LuaGaia reloaded&quot;);
 					} else {
-						logOutput.Print(&quot;LuaGaia reload failed\n&quot;);
+						logOutput.Print(&quot;LuaGaia reload failed&quot;);
 					}
 				}
 			}
 			else if (action.extra == &quot;disable&quot;) {
 				if (!gs-&gt;cheatEnabled) {
-					logOutput.Print(&quot;Cheating required to disable synced scripts\n&quot;);
+					logOutput.Print(&quot;Cheating required to disable synced scripts&quot;);
 				} else {
 					CLuaGaia::FreeHandler();
-					logOutput.Print(&quot;LuaGaia disabled\n&quot;);
+					logOutput.Print(&quot;LuaGaia disabled&quot;);
 				}
 			}
 			else if (luaGaia) {
 				luaGaia-&gt;GotChatMsg(action.extra, playernum);
 			}
 			else {
-				logOutput.Print(&quot;LuaGaia is not enabled\n&quot;);
+				logOutput.Print(&quot;LuaGaia is not enabled&quot;);
 			}
 		}
 	}
@@ -3181,12 +3179,11 @@
 
 			case NETMSG_STARTPLAYING: {
 				unsigned timeToStart = *(unsigned*)(inbuf+1);
-				if (timeToStart &gt; 0)
-				{
+				if (timeToStart &gt; 0) {
 					GameSetupDrawer::StartCountdown(timeToStart);
+				} else {
+					StartPlaying();
 				}
-				else
-					StartPlaying();
 				AddTraffic(-1, packetCode, dataLength);
 				break;
 			}
@@ -3226,8 +3223,9 @@
 				*gs-&gt;players[player]-&gt;currentStats = *(CPlayer::Statistics*)&amp;inbuf[2];
 				if (gameOver) {
 					CDemoRecorder* record = net-&gt;GetDemoRecorder();
-					if (record != NULL)
+					if (record != NULL) {
 						record-&gt;SetPlayerStats(player, *gs-&gt;players[player]-&gt;currentStats);
+					}
 				}
 				AddTraffic(player, packetCode, dataLength);
 				break;
@@ -3292,8 +3290,9 @@
 				gs-&gt;players[player]-&gt;playerName=(char*)(&amp;inbuf[3]);
 				gs-&gt;players[player]-&gt;readyToStart=true;
 				gs-&gt;players[player]-&gt;active=true;
-				if (net-&gt;GetDemoRecorder())
+				if (net-&gt;GetDemoRecorder()) {
 					net-&gt;GetDemoRecorder()-&gt;SetMaxPlayerNum(inbuf[2]);
+				}
 				wordCompletion-&gt;AddWord(gs-&gt;players[player]-&gt;playerName, false, false, false); // required?
 				AddTraffic(player, packetCode, dataLength);
 				break;
@@ -3316,14 +3315,15 @@
 			case NETMSG_STARTPOS:{
 				unsigned player = inbuf[1];
 				int team = inbuf[2];
-				if(team&gt;=gs-&gt;activeTeams || team&lt;0 || !gameSetup){
+				if ((team &gt;= gs-&gt;activeTeams) || (team &lt; 0) || !gameSetup) {
 					logOutput.Print(&quot;Got invalid team num %i in startpos msg&quot;,team);
 				} else {
-					if(inbuf[3]!=2)
-						gameSetup-&gt;readyTeams[team]=!!inbuf[3];
-					gs-&gt;Team(team)-&gt;startPos.x=*(float*)&amp;inbuf[4];
-					gs-&gt;Team(team)-&gt;startPos.y=*(float*)&amp;inbuf[8];
-					gs-&gt;Team(team)-&gt;startPos.z=*(float*)&amp;inbuf[12];
+					if (inbuf[3] != 2) {
+						gameSetup-&gt;readyTeams[team] = !!inbuf[3];
+					}
+					gs-&gt;Team(team)-&gt;startPos.x = *(float*)&amp;inbuf[4];
+					gs-&gt;Team(team)-&gt;startPos.y = *(float*)&amp;inbuf[8];
+					gs-&gt;Team(team)-&gt;startPos.z = *(float*)&amp;inbuf[12];
 				}
 				AddTraffic(player, packetCode, dataLength);
 				break;
@@ -3338,8 +3338,9 @@
 			case NETMSG_GAMEID: {
 				const unsigned char* p = &amp;inbuf[1];
 				CDemoRecorder* record = net-&gt;GetDemoRecorder();
-				if (record != NULL)
+				if (record != NULL) {
 					record-&gt;SetGameID(p);
+				}
 				logOutput.Print(
 				  &quot;GameID: %02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x&quot;,
 				  p[ 0], p[ 1], p[ 2], p[ 3], p[ 4], p[ 5], p[ 6], p[ 7],
@@ -3353,15 +3354,11 @@
 #ifndef SYNCCHECK
 				net-&gt;SendKeyFrame(serverframenum-1);
 #endif
-				if (gs-&gt;frameNum == (serverframenum - 1))
-				{
+				if (gs-&gt;frameNum == (serverframenum - 1)) {
 					// everything ok, fall through
+				} else {
+					break; // error
 				}
-				else
-				{
-					// error
-					break;
-				}
 			}
 			case NETMSG_NEWFRAME: {
 				timeLeft -= 1.0f;
@@ -3374,7 +3371,7 @@
 #endif
 				AddTraffic(-1, packetCode, dataLength);
 
-				if(creatingVideo &amp;&amp; net-&gt;localDemoPlayback){
+				if (creatingVideo &amp;&amp; net-&gt;localDemoPlayback) {
 					POP_CODE_MODE;
 					return;
 				}
@@ -3382,15 +3379,16 @@
 			}
 
 			case NETMSG_COMMAND: {
-				int player=inbuf[3];
-				if(player&gt;=MAX_PLAYERS || player&lt;0){
+				int player = inbuf[3];
+				if ((player &gt;= MAX_PLAYERS) || (player &lt; 0)) {
 					logOutput.Print(&quot;Got invalid player num %i in command msg&quot;,player);
 				} else {
 					Command c;
 					c.id=*((int*)&amp;inbuf[4]);
 					c.options=inbuf[8];
-					for(int a=0;a&lt;((*((short int*)&amp;inbuf[1])-9)/4);++a)
+					for(int a = 0; a &lt; ((*((short int*)&amp;inbuf[1])-9)/4); ++a) {
 						c.params.push_back(*((float*)&amp;inbuf[9+a*4]));
+					}
 					selectedUnits.NetOrder(c,player);
 				}
 				AddTraffic(player, packetCode, dataLength);
@@ -3399,20 +3397,21 @@
 
 			case NETMSG_SELECT: {
 				int player=inbuf[3];
-				if(player&gt;=MAX_PLAYERS || player&lt;0){
+				if ((player &gt;= MAX_PLAYERS) || (player &lt; 0)) {
 					logOutput.Print(&quot;Got invalid player num %i in netselect msg&quot;,player);
 				} else {
 					vector&lt;int&gt; selected;
-					for(int a=0;a&lt;((*((short int*)&amp;inbuf[1])-4)/2);++a){
+					for (int a = 0; a &lt; ((*((short int*)&amp;inbuf[1])-4)/2); ++a) {
 						int unitid=*((short int*)&amp;inbuf[4+a*2]);
 						if(unitid&gt;=MAX_UNITS || unitid&lt;0){
 							logOutput.Print(&quot;Got invalid unitid %i in netselect msg&quot;,unitid);
 							break;
 						}
 						if (uh-&gt;units[unitid] &amp;&amp;
-													(uh-&gt;units[unitid]-&gt;team == gs-&gt;players[player]-&gt;team) || gs-&gt;godMode) {
+						    (uh-&gt;units[unitid]-&gt;team == gs-&gt;players[player]-&gt;team) ||
+						    gs-&gt;godMode) {
 							selected.push_back(unitid);
-													}
+						}
 					}
 					selectedUnits.NetSelect(selected, player);
 				}
@@ -3420,8 +3419,6 @@
 				break;
 			}
 
-
-
 			case NETMSG_AICOMMAND: {
 				const int player = inbuf[3];
 				if (player &gt;= MAX_PLAYERS || player &lt; 0) {
@@ -3440,8 +3437,9 @@
 				c.options = inbuf[10];
 
 				// insert the command parameters
-				for (int a = 0; a &lt; ((*((short int*) &amp;inbuf[1]) - 11) / 4); ++a)
+				for (int a = 0; a &lt; ((*((short int*) &amp;inbuf[1]) - 11) / 4); ++a) {
 					c.params.push_back(*((float*) &amp;inbuf[11 + a * 4]));
+				}
 
 				selectedUnits.AiOrder(unitid,c);
 				AddTraffic(player, packetCode, dataLength);
@@ -3531,10 +3529,9 @@
 						u-&gt;ChangeTeam(dstTeam, CUnit::ChangeGiven);
 					}
 				}
-			} break;
+				break;
+			}
 
-
-
 			case NETMSG_LUAMSG: {
 				const int player = inbuf[3];
 				if ((player &lt; 0) || (player &gt;= MAX_PLAYERS)) {
@@ -3552,8 +3549,8 @@
 			case NETMSG_SYNCREQUEST: {
 				// TODO rename this net message, change error msg, etc.
 				ENTER_MIXED;
-				int frame=*((int*)&amp;inbuf[1]);
-				if(frame!=gs-&gt;frameNum){
+				int frame = *((int*)&amp;inbuf[1]);
+				if (frame != gs-&gt;frameNum) {
 					logOutput.Print(&quot;Sync request for wrong frame (%i instead of %i)&quot;, frame, gs-&gt;frameNum);
 				}
 				net-&gt;SendCPUUsage(profiler.profile[&quot;Sim time&quot;].percent);
@@ -3563,16 +3560,16 @@
 			}
 
 			case NETMSG_SHARE: {
-				int player=inbuf[1];
-				if(player&gt;=MAX_PLAYERS || player&lt;0){
+				int player = inbuf[1];
+				if ((player &gt;= MAX_PLAYERS) || (player &lt; 0)){
 					logOutput.Print(&quot;Got invalid player num %i in share msg&quot;,player);
 					break;
 				}
-				int team1=gs-&gt;players[player]-&gt;team;
-				int team2=inbuf[2];
-				bool shareUnits=!!inbuf[3];
-				float metalShare=std::min(*(float*)&amp;inbuf[4],(float)gs-&gt;Team(team1)-&gt;metal);
-				float energyShare=std::min(*(float*)&amp;inbuf[8],(float)gs-&gt;Team(team1)-&gt;energy);
+				int team1 = gs-&gt;players[player]-&gt;team;
+				int team2 = inbuf[2];
+				bool shareUnits = !!inbuf[3];
+				float metalShare = std::min(*(float*)&amp;inbuf[4], (float)gs-&gt;Team(team1)-&gt;metal);
+				float energyShare = std::min(*(float*)&amp;inbuf[8], (float)gs-&gt;Team(team1)-&gt;energy);
 
 				if (metalShare != 0.0f) {
 					if (!luaRules || luaRules-&gt;AllowResourceTransfer(team1, team2, &quot;m&quot;, metalShare)) {
@@ -3587,13 +3584,16 @@
 					}
 				}
 
-				if(shareUnits){
-					for(vector&lt;int&gt;::iterator ui=selectedUnits.netSelected[player].begin();ui!=selectedUnits.netSelected[player].end();++ui){
-						if(uh-&gt;units[*ui] &amp;&amp; uh-&gt;units[*ui]-&gt;team==team1 &amp;&amp; !uh-&gt;units[*ui]-&gt;beingBuilt){
-							uh-&gt;units[*ui]-&gt;ChangeTeam(team2,CUnit::ChangeGiven);
+				if (shareUnits) {
+					vector&lt;int&gt;&amp; netSelUnits = selectedUnits.netSelected[player];
+					vector&lt;int&gt;::const_iterator ui;
+					for (ui = netSelUnits.begin(); ui != netSelUnits.end(); ++ui){
+						CUnit* unit = uh-&gt;units[*ui];
+						if (unit &amp;&amp; unit-&gt;team==team1 &amp;&amp; !unit-&gt;beingBuilt) {
+							unit-&gt;ChangeTeam(team2, CUnit::ChangeGiven);
 						}
 					}
-					selectedUnits.netSelected[player].clear();
+					netSelUnits.clear();
 				}
 				AddTraffic(player, packetCode, dataLength);
 				break;
@@ -3602,14 +3602,14 @@
 			case NETMSG_SETSHARE: {
 				int player=inbuf[1];
 				int team=inbuf[2];
-				if(team&gt;=gs-&gt;activeTeams || team&lt;0){
+				if ((team &gt;= gs-&gt;activeTeams) || (team &lt; 0)) {
 					logOutput.Print(&quot;Got invalid team num %i in setshare msg&quot;,team);
 				} else {
 					float metalShare=*(float*)&amp;inbuf[3];
 					float energyShare=*(float*)&amp;inbuf[7];
 
 					if (!luaRules || luaRules-&gt;AllowResourceLevel(team, &quot;m&quot;, metalShare)) {
-						gs-&gt;Team(team)-&gt;metalShare  = metalShare;
+						gs-&gt;Team(team)-&gt;metalShare = metalShare;
 					}
 					if (!luaRules || luaRules-&gt;AllowResourceLevel(team, &quot;e&quot;, energyShare)) {
 						gs-&gt;Team(team)-&gt;energyShare = energyShare;
@@ -3629,31 +3629,31 @@
 				const int fromTeam = gs-&gt;players[player]-&gt;team;
 
 				unsigned numPlayersInTeam = 0;
-				for (int a=0;a&lt;MAX_PLAYERS;++a)
-					if (gs-&gt;players[a]-&gt;active &amp;&amp; gs-&gt;players[a]-&gt;team == fromTeam)
+				for (int a = 0; a &lt; MAX_PLAYERS; ++a) {
+					if (gs-&gt;players[a]-&gt;active &amp;&amp; (gs-&gt;players[a]-&gt;team == fromTeam)) {
 						++numPlayersInTeam;
+					}
+				}
 
 				switch (action)
 				{
 					case TEAMMSG_SELFD: {
-						if (numPlayersInTeam == 1)
-						{
+						if (numPlayersInTeam == 1) {
 							gs-&gt;Team(fromTeam)-&gt;SelfDestruct();
 							gs-&gt;Team(fromTeam)-&gt;leader = -1;
+						} else {
+							gs-&gt;players[player]-&gt;StartSpectating();
 						}
-						else
-							gs-&gt;players[player]-&gt;StartSpectating();
 						break;
 					}
 					case TEAMMSG_GIVEAWAY: {
 						const int toTeam = inbuf[3];
-						if (numPlayersInTeam == 1)
-						{
+						if (numPlayersInTeam == 1) {
 							gs-&gt;Team(fromTeam)-&gt;GiveEverythingTo(toTeam);
 							gs-&gt;Team(fromTeam)-&gt;leader = -1;
+						} else {
+							gs-&gt;players[player]-&gt;StartSpectating();
 						}
-						else
-							gs-&gt;players[player]-&gt;StartSpectating();
 						break;
 					}
 					case TEAMMSG_RESIGN: {
@@ -3663,8 +3663,9 @@
 							unitTracker.Disable();
 							CLuaUI::UpdateTeams();
 						}
-						if (numPlayersInTeam == 1)
+						if (numPlayersInTeam == 1) {
 							gs-&gt;Team(fromTeam)-&gt;leader = -1;
+						}
 						logOutput.Print(&quot;Player %i resigned and is now spectating!&quot;, player);
 						break;
 					}
@@ -3676,15 +3677,16 @@
 						if (player == gu-&gt;myPlayerNum) {
 							gu-&gt;myTeam = newTeam;
 							gu-&gt;myAllyTeam = gs-&gt;AllyTeam(gu-&gt;myTeam);
-							gu-&gt;spectating = false;
+							gu-&gt;spectating           = false;
 							gu-&gt;spectatingFullView   = false;
 							gu-&gt;spectatingFullSelect = false;
 							selectedUnits.ClearSelected();
 							unitTracker.Disable();
 							CLuaUI::UpdateTeams();
 						}
-						if (gs-&gt;Team(newTeam)-&gt;leader == -1)
+						if (gs-&gt;Team(newTeam)-&gt;leader == -1) {
 							gs-&gt;Team(newTeam)-&gt;leader = player;
+						}
 						break;
 					}
 					default: {
@@ -3698,23 +3700,24 @@
 				const int player = inbuf[1];
 				const int whichAllyTeam = inbuf[2];
 				const bool allied = static_cast&lt;bool&gt;(inbuf[3]);
-				if (whichAllyTeam &lt; MAX_TEAMS &amp;&amp; whichAllyTeam &gt;= 0)
+				if (whichAllyTeam &lt; MAX_TEAMS &amp;&amp; whichAllyTeam &gt;= 0) {
 					gs-&gt;SetAlly(gs-&gt;AllyTeam(gs-&gt;players[player]-&gt;team), whichAllyTeam, allied);
-				else
+				} else {
 					logOutput.Print(&quot;Player %i sent out wrong allyTeam index in alliance message&quot;, player);
+				}
 				break;
 			}
 			case NETMSG_CCOMMAND: {
 				CommandMessage msg(packet);
-				ActionRecieved(msg.action, msg.player);
+				ActionReceived(msg.action, msg.player);
 				break;
 			}
 
 #ifdef DIRECT_CONTROL_ALLOWED
 			case NETMSG_DIRECT_CONTROL: {
-				int player=inbuf[1];
+				int player = inbuf[1];
 
-				if(player&gt;=MAX_PLAYERS || player&lt;0){
+				if ((player &gt;= MAX_PLAYERS) || (player &lt; 0)) {
 					logOutput.Print(&quot;Got invalid player num %i in direct control msg&quot;,player);
 					break;
 				}
@@ -3741,10 +3744,10 @@
 							unit-&gt;directControl=&amp;gs-&gt;players[player]-&gt;myControl;
 							gs-&gt;players[player]-&gt;playerControlledUnit=unit;
 							ENTER_UNSYNCED;
-							if(player==gu-&gt;myPlayerNum){
-								gu-&gt;directControl=unit;
+							if (player == gu-&gt;myPlayerNum) {
+								gu-&gt;directControl = unit;
 								mouse-&gt;wasLocked = mouse-&gt;locked;
-								if(!mouse-&gt;locked){
+								if (!mouse-&gt;locked) {
 									mouse-&gt;locked = true;
 									mouse-&gt;HideMouse();
 								}
@@ -3762,13 +3765,13 @@
 			}
 
 			case NETMSG_DC_UPDATE: {
-				int player=inbuf[1];
-				if(player&gt;=MAX_PLAYERS || player&lt;0){
+				int player = inbuf[1];
+				if ((player &gt;= MAX_PLAYERS) || (player &lt; 0)){
 					logOutput.Print(&quot;Got invalid player num %i in dc update msg&quot;,player);
 					break;
 				}
-				DirectControlStruct* dc=&amp;gs-&gt;players[player]-&gt;myControl;
-				CUnit* unit=gs-&gt;players[player]-&gt;playerControlledUnit;
+				DirectControlStruct* dc = &amp;gs-&gt;players[player]-&gt;myControl;
+				CUnit* unit = gs-&gt;players[player]-&gt;playerControlledUnit;
 
 				dc-&gt;forward    = !!(inbuf[2] &amp; (1 &lt;&lt; 0));
 				dc-&gt;back       = !!(inbuf[2] &amp; (1 &lt;&lt; 1));
@@ -3820,15 +3823,17 @@
 	ASSERT_UNSYNCED_MODE;
 	//move camera if arrow keys pressed
 #ifdef DIRECT_CONTROL_ALLOWED
-	if(gu-&gt;directControl){
-		CUnit* owner=gu-&gt;directControl;
+	if (gu-&gt;directControl) {
+		CUnit* owner = gu-&gt;directControl;
 
 		std::vector&lt;int&gt; args;
 		args.push_back(0);
 		owner-&gt;cob-&gt;Call(COBFN_AimFromPrimary/*/COBFN_QueryPrimary+weaponNum/**/,args);
-		float3 relPos=owner-&gt;localmodel-&gt;GetPiecePos(args[0]);
-		float3 pos=owner-&gt;pos+owner-&gt;frontdir*relPos.z+owner-&gt;updir*relPos.y+owner-&gt;rightdir*relPos.x;
-		pos+=UpVector*7;
+		float3 relPos = owner-&gt;localmodel-&gt;GetPiecePos(args[0]);
+		float3 pos = owner-&gt;pos + owner-&gt;frontdir * relPos.z
+		                        + owner-&gt;updir    * relPos.y
+		                        + owner-&gt;rightdir * relPos.x;
+		pos += UpVector * 7;
 
 		camHandler-&gt;GetCurrentController().SetPos(pos);
 	} else
@@ -3900,7 +3905,7 @@
 
 	camHandler-&gt;GetCurrentController().Update();
 
-	if(chatting &amp;&amp; !userWriting){
+	if (chatting &amp;&amp; !userWriting) {
 		consoleHistory-&gt;AddLine(userInput);
 		string msg = userInput;
 		string pfx = &quot;&quot;;
@@ -3918,16 +3923,16 @@
 		writingPos = 0;
 	}
 
-	if(inMapDrawer-&gt;wantLabel &amp;&amp; !userWriting){
-		if(userInput.size()&gt;200){	//avoid troubles with to long lines
-			userInput=userInput.substr(0,200);
+	if (inMapDrawer-&gt;wantLabel &amp;&amp; !userWriting) {
+		if (userInput.size() &gt; 200) {	//avoid troubles with to long lines
+			userInput = userInput.substr(0, 200);
 			writingPos = (int)userInput.length();
 		}
 		inMapDrawer-&gt;CreatePoint(inMapDrawer-&gt;waitingPoint,userInput);
-		inMapDrawer-&gt;wantLabel=false;
-		userInput=&quot;&quot;;
+		inMapDrawer-&gt;wantLabel = false;
+		userInput = &quot;&quot;;
 		writingPos = 0;
-		ignoreChar=0;
+		ignoreChar = 0;
 	}
 }
 
@@ -3936,8 +3941,9 @@
 {
 	std::ofstream file(gameServer ? &quot;memdump.txt&quot; : &quot;memdumpclient.txt&quot;);
 
-	if (file.bad() || !file.is_open())
+	if (file.bad() || !file.is_open()) {
 		return;
+	}
 
 	file &lt;&lt; &quot;Frame &quot; &lt;&lt; gs-&gt;frameNum &lt;&lt;&quot;\n&quot;;
 	std::list&lt;CUnit*&gt;::iterator usi;
@@ -4184,9 +4190,9 @@
 	SAFE_NEW CEndGameBox();
 	CDemoRecorder* record = net-&gt;GetDemoRecorder();
 	if (record != NULL) {
-	// Write CPlayer::Statistics and CTeam::Statistics to demo
+		// Write CPlayer::Statistics and CTeam::Statistics to demo
 		int numPlayers;
-	// FIXME: ugh, there should be a better way to figure out number of players ...
+		// FIXME: ugh, there should be a better way to figure out number of players ...
 		if (gameSetup != NULL) {
 			numPlayers = gameSetup-&gt;numPlayers;
 		} else {
@@ -4195,9 +4201,10 @@
 				++numPlayers;
 		}
 		int numTeams = gs-&gt;activeAllyTeams;
-		if (gs-&gt;useLuaGaia)
+		if (gs-&gt;useLuaGaia) {
 			--numTeams;
-	// Figure out who won the game.
+		}
+		// Figure out who won the game.
 		int winner = -1;
 		for (int i = 0; i &lt; numTeams; ++i) {
 			if (!gs-&gt;Team(i)-&gt;isDead) {
@@ -4205,13 +4212,15 @@
 				break;
 			}
 		}
-	// Finally pass it on to the CDemoRecorder.
+		// Finally pass it on to the CDemoRecorder.
 		record-&gt;SetTime(gs-&gt;frameNum / 30, (int)gu-&gt;gameTime);
 		record-&gt;InitializeStats(numPlayers, numTeams, winner);
-		for (int i = 0; i &lt; numPlayers; ++i)
+		for (int i = 0; i &lt; numPlayers; ++i) {
 			record-&gt;SetPlayerStats(i, *gs-&gt;players[i]-&gt;currentStats);
-		for (int i = 0; i &lt; numTeams; ++i)
+		}
+		for (int i = 0; i &lt; numTeams; ++i) {
 			record-&gt;SetTeamStats(i, gs-&gt;Team(i)-&gt;statHistory);
+		}
 	}
 }
 
@@ -4245,8 +4254,10 @@
 
 void CGame::HandleChatMsg(const ChatMessage&amp; msg)
 {
-	if (msg.fromPlayer &lt; 0 || (msg.fromPlayer &gt;= MAX_PLAYERS &amp;&amp; msg.fromPlayer != SERVER_PLAYER))
+	if ((msg.fromPlayer &lt; 0) ||
+	    ((msg.fromPlayer &gt;= MAX_PLAYERS) &amp;&amp; (msg.fromPlayer != SERVER_PLAYER))) {
 		return;
+	}
 
 	CScriptHandler::Instance().chosenScript-&gt;GotChatMsg(msg.msg, msg.fromPlayer);
 	string s = msg.msg;
@@ -4620,12 +4631,9 @@
 bool CGame::HasLag() const
 {
 	unsigned timeNow = SDL_GetTicks();
-	if (!gs-&gt;paused &amp;&amp; timeNow &gt; lastFrameTime + 500.0f / gs-&gt;speedFactor)
-	{
+	if (!gs-&gt;paused &amp;&amp; (timeNow &gt; (lastFrameTime + (500.0f / gs-&gt;speedFactor)))) {
 		return true;
-	}
-	else
-	{
+	} else {
 		return false;
 	}
 }

Modified: trunk/rts/Game/Game.h
===================================================================
--- trunk/rts/Game/Game.h	2008-05-17 23:59:04 UTC (rev 5906)
+++ trunk/rts/Game/Game.h	2008-05-18 02:13:53 UTC (rev 5907)
@@ -128,7 +128,7 @@
 	void HandleChatMsg(const ChatMessage&amp; msg);
 	
 	/// synced actions (recieved from server) go in here
-	void ActionRecieved(const Action&amp;, int playernum);
+	void ActionReceived(const Action&amp;, int playernum);
 
 	void DrawInputText();
 	void ParseInputTextGeometry(const std::string&amp; geo);

Modified: trunk/rts/Game/GameServer.h
===================================================================
--- trunk/rts/Game/GameServer.h	2008-05-17 23:59:04 UTC (rev 5906)
+++ trunk/rts/Game/GameServer.h	2008-05-18 02:13:53 UTC (rev 5907)
@@ -54,7 +54,7 @@
 @brief Server class for game handling
 This class represents a gameserver. It is responsible for recieving, checking and forwarding gamedata to the clients. It keeps track of the sync, cpu and other stats and informs all clients about events.
 */
-class CGameServer : public CommandReciever
+class CGameServer : public CommandReceiver
 {
 	friend class CLoadSaveHandler;     //For initialize server state after load
 public:

Modified: trunk/rts/Game/PreGame.cpp
===================================================================
--- trunk/rts/Game/PreGame.cpp	2008-05-17 23:59:04 UTC (rev 5906)
+++ trunk/rts/Game/PreGame.cpp	2008-05-18 02:13:53 UTC (rev 5907)
@@ -448,7 +448,7 @@
 				logOutput.Print(&quot;Became player %i&quot;, gu-&gt;myPlayerNum);
 			} break;
 			case NETMSG_GAMEDATA: {
-				GameDataRecieved(packet);
+				GameDataReceived(packet);
 				return;
 			}
 			default: {
@@ -619,7 +619,7 @@
 	}
 }
 
-void CPreGame::GameDataRecieved(boost::shared_ptr&lt;const netcode::RawPacket&gt; packet)
+void CPreGame::GameDataReceived(boost::shared_ptr&lt;const netcode::RawPacket&gt; packet)
 {
 	gameData = new GameData(packet);
 	

Modified: trunk/rts/Game/PreGame.h
===================================================================
--- trunk/rts/Game/PreGame.h	2008-05-17 23:59:04 UTC (rev 5906)
+++ trunk/rts/Game/PreGame.h	2008-05-18 02:13:53 UTC (rev 5907)
@@ -26,7 +26,7 @@
  * 
  * ForClients:
  * 1. Connect to the server
- * 2. Recieve GameData from server
+ * 2. Receive GameData from server
  * 3. Start the CGame with the information provided by server
  * */
 class CPreGame : public CGameController
@@ -66,7 +66,7 @@
 	/// Map all required archives depending on selected mod(s)
 	static void LoadMod(const std::string&amp; modName);
 
-	void GameDataRecieved(boost::shared_ptr&lt;const netcode::RawPacket&gt; packet);
+	void GameDataReceived(boost::shared_ptr&lt;const netcode::RawPacket&gt; packet);
 	
 	const bool server;
 	enum State {

Modified: trunk/rts/Game/UI/KeyBindings.h
===================================================================
--- trunk/rts/Game/UI/KeyBindings.h	2008-05-17 23:59:04 UTC (rev 5906)
+++ trunk/rts/Game/UI/KeyBindings.h	2008-05-18 02:13:53 UTC (rev 5907)
@@ -19,7 +19,7 @@
 class CSimpleParser;
 
 
-class CKeyBindings : public CommandReciever
+class CKeyBindings : public CommandReceiver
 {
 	public:
 		CKeyBindings();

Modified: trunk/rts/Game/UI/MiniMap.cpp
===================================================================
--- trunk/rts/Game/UI/MiniMap.cpp	2008-05-17 23:59:04 UTC (rev 5906)
+++ trunk/rts/Game/UI/MiniMap.cpp	2008-05-18 02:13:53 UTC (rev 5907)
@@ -1398,10 +1398,10 @@
 	scale = 1.0f;
 
 	if (useIcons) {
-		if ((unit-&gt;allyteam == gu-&gt;myAllyTeam) ||
-				(unit-&gt;losStatus[gu-&gt;myAllyTeam] &amp; LOS_INLOS) ||
-				((unit-&gt;losStatus[gu-&gt;myAllyTeam] &amp; LOS_PREVLOS) &amp;&amp;
-				 (unit-&gt;losStatus[gu-&gt;myAllyTeam] &amp; LOS_CONTRADAR)) ||
+		const unsigned short losStatus = unit-&gt;losStatus[gu-&gt;myAllyTeam];
+		const unsigned short prevMask = (LOS_PREVLOS | LOS_CONTRADAR);
+		if ((losStatus &amp; LOS_INLOS) ||
+				((losStatus &amp; prevMask) == prevMask) ||
 				gu-&gt;spectatingFullView) {
 			CIcon* icon = iconHandler-&gt;GetIcon(unit-&gt;unitDef-&gt;iconType);
 			if (icon-&gt;radiusAdjust) {

Modified: trunk/rts/Lua/LuaFeatureDefs.cpp
===================================================================
--- trunk/rts/Lua/LuaFeatureDefs.cpp	2008-05-17 23:59:04 UTC (rev 5906)
+++ trunk/rts/Lua/LuaFeatureDefs.cpp	2008-05-18 02:13:53 UTC (rev 5907)
@@ -46,8 +46,8 @@
 static int FeatureDefMetatable(lua_State* L);
 
 // special access functions
-static int FeatureDefToID(lua_State* L, const void* data);
 static int DrawTypeString(lua_State* L, const void* data);
+static int CustomParamsTable(lua_State* L, const void* data);
 
 
 /******************************************************************************/
@@ -313,13 +313,16 @@
 }
 
 
-static int FeatureDefToID(lua_State* L, const void* data)
+static int CustomParamsTable(lua_State* L, const void* data)
 {
-	const FeatureDef* fd = *((const FeatureDef**)data);
-	if (fd == NULL) {
-		return 0;
+	const map&lt;string, string&gt;&amp; params = *((const map&lt;string, string&gt;*)data);
+	lua_newtable(L);
+	map&lt;string, string&gt;::const_iterator it;
+	for (it = params.begin(); it != params.end(); ++it) {
+		lua_pushstring(L, it-&gt;first.c_str());
+		lua_pushstring(L, it-&gt;second.c_str());
+		lua_rawset(L, -3);
 	}
-	lua_pushnumber(L, fd-&gt;id);
 	return 1;
 }
 
@@ -391,8 +394,10 @@
 	const FeatureDef fd;
 	const char* start = ADDRESS(fd);
 
-	ADD_FUNCTION(&quot;drawTypeString&quot;,  fd.drawType, DrawTypeString);
+	ADD_FUNCTION(&quot;drawTypeString&quot;, fd.drawType,     DrawTypeString);
 
+	ADD_FUNCTION(&quot;customParams&quot;,   fd.customParams, CustomParamsTable);
+
 	ADD_FUNCTION(&quot;height&quot;,  fd, ModelHeight);
 	ADD_FUNCTION(&quot;radius&quot;,  fd, ModelRadius);
 	ADD_FUNCTION(&quot;minx&quot;,    fd, ModelMinx);

Modified: trunk/rts/Lua/LuaSyncedCtrl.cpp
===================================================================
--- trunk/rts/Lua/LuaSyncedCtrl.cpp	2008-05-17 23:59:04 UTC (rev 5906)
+++ trunk/rts/Lua/LuaSyncedCtrl.cpp	2008-05-18 02:13:53 UTC (rev 5907)
@@ -117,6 +117,8 @@
 	REGISTER_LUA_CFUNC(SetUnitStockpile);
 	REGISTER_LUA_CFUNC(SetUnitWeaponState);
 	REGISTER_LUA_CFUNC(SetUnitExperience);
+	REGISTER_LUA_CFUNC(SetUnitLosMask);
+	REGISTER_LUA_CFUNC(SetUnitLosState);
 	REGISTER_LUA_CFUNC(SetUnitCloak);
 	REGISTER_LUA_CFUNC(SetUnitStealth);
 	REGISTER_LUA_CFUNC(SetUnitAlwaysVisible);
@@ -1208,6 +1210,84 @@
 }
 
 
+static unsigned char ParseLosBits(lua_State* L, int index, unsigned char bits)
+{
+	if (lua_isnumber(L, index)) {
+		return (unsigned char)lua_tonumber(L, index);
+	}
+	else if (lua_istable(L, index)) {
+		for (lua_pushnil(L); lua_next(L, index) != 0; lua_pop(L, 1)) {
+			if (!lua_israwstring(L, -2)) { luaL_error(L, &quot;bad key type&quot;);   }
+			if (!lua_isboolean(L, -1))   { luaL_error(L, &quot;bad value type&quot;); }
+			const string key = lua_tostring(L, -2);
+			const bool set = lua_toboolean(L, -1);
+			if (key == &quot;los&quot;) {
+				if (set) { bits |=  LOS_INLOS; }
+				else     { bits &amp;= ~LOS_INLOS; }
+			}
+			else if (key == &quot;radar&quot;) {
+				if (set) { bits |=  LOS_INRADAR; }
+				else     { bits &amp;= ~LOS_INRADAR; }
+			}
+			else if (key == &quot;prevLos&quot;) {
+				if (set) { bits |=  LOS_PREVLOS; }
+				else     { bits &amp;= ~LOS_PREVLOS; }
+			}
+			else if (key == &quot;contRadar&quot;) {
+				if (set) { bits |=  LOS_CONTRADAR; }
+				else     { bits &amp;= ~LOS_CONTRADAR; }
+			}
+		}
+		return bits;
+	}
+ 	luaL_error(L, &quot;ERROR: expected number or table&quot;);
+	return 0;
+}
+
+
+int LuaSyncedCtrl::SetUnitLosMask(lua_State* L)
+{
+	CUnit* unit = ParseUnit(L, __FUNCTION__, 1);
+	if (unit == NULL) {
+		return 0;
+	}
+	const int allyTeam = luaL_checkint(L, 2);
+	if ((allyTeam &lt; 0) || (allyTeam &gt;= MAX_TEAMS)) {
+		luaL_error(L, &quot;bad allyTeam&quot;);
+	}
+	const unsigned short losStatus = unit-&gt;losStatus[allyTeam];
+	const unsigned char  oldMask = losStatus &gt;&gt; 8;
+	const unsigned char  newMask = ParseLosBits(L, 3, oldMask);
+	const unsigned short state = (newMask &lt;&lt; 8) | (losStatus &amp; 0x00FF);
+
+	unit-&gt;losStatus[allyTeam] = state;
+	unit-&gt;SetLosStatus(allyTeam, unit-&gt;CalcLosStatus(allyTeam));
+
+	return 0;
+}
+
+
+int LuaSyncedCtrl::SetUnitLosState(lua_State* L)
+{
+	CUnit* unit = ParseUnit(L, __FUNCTION__, 1);
+	if (unit == NULL) {
+		return 0;
+	}
+	const int allyTeam = luaL_checkint(L, 2);
+	if ((allyTeam &lt; 0) || (allyTeam &gt;= MAX_TEAMS)) {
+		luaL_error(L, &quot;bad allyTeam&quot;);
+	}
+	const unsigned short losStatus = unit-&gt;losStatus[allyTeam];
+	const unsigned char  oldState = losStatus &amp; 0xFF;
+	const unsigned char  newState = ParseLosBits(L, 3, oldState);
+	const unsigned short state = (losStatus &amp; 0xFF00) | newState;
+
+	unit-&gt;SetLosStatus(allyTeam, state);
+
+	return 0;
+}
+
+
 int LuaSyncedCtrl::SetUnitCloak(lua_State* L)
 {
 	CUnit* unit = ParseUnit(L, __FUNCTION__, 1);

Modified: trunk/rts/Lua/LuaSyncedCtrl.h
===================================================================
--- trunk/rts/Lua/LuaSyncedCtrl.h	2008-05-17 23:59:04 UTC (rev 5906)
+++ trunk/rts/Lua/LuaSyncedCtrl.h	2008-05-18 02:13:53 UTC (rev 5907)
@@ -56,6 +56,8 @@
 		static int SetUnitStockpile(lua_State* L);
 		static int SetUnitWeaponState(lua_State* L);
 		static int SetUnitExperience(lua_State* L);
+		static int SetUnitLosMask(lua_State* L);
+		static int SetUnitLosState(lua_State* L);
 		static int SetUnitCloak(lua_State* L);
 		static int SetUnitStealth(lua_State* L);
 		static int SetUnitAlwaysVisible(lua_State* L);

Modified: trunk/rts/Lua/LuaSyncedRead.cpp
===================================================================
--- trunk/rts/Lua/LuaSyncedRead.cpp	2008-05-17 23:59:04 UTC (rev 5906)
+++ trunk/rts/Lua/LuaSyncedRead.cpp	2008-05-18 02:13:53 UTC (rev 5907)
@@ -336,8 +336,8 @@
 	if (readAllyTeam &lt; 0) {
 		return fullRead;
 	}
-	const int losStatus = unit-&gt;losStatus[readAllyTeam];
-	const int prevMask = (LOS_PREVLOS | LOS_CONTRADAR);
+	const unsigned short losStatus = unit-&gt;losStatus[readAllyTeam];
+	const unsigned short prevMask = (LOS_PREVLOS | LOS_CONTRADAR);
 	if ((losStatus &amp; LOS_INLOS) ||
 	    ((losStatus &amp; prevMask) == prevMask)) {
 		return true;
@@ -2775,16 +2775,18 @@
 		if (!fullRead) {
 			return 0;
 		}
-		const int args = lua_gettop(L); // number of arguments
-		if ((args &lt; 2) || !lua_isnumber(L, 2)) {
-			return 0;
-		}
-		allyTeam = (int)lua_tonumber(L, 2);
+		allyTeam = luaL_checkint(L, 2);
 	}
 	if ((allyTeam &lt; 0) || (allyTeam &gt;= gs-&gt;activeAllyTeams)) {
 		return 0;
 	}
-	const int losStatus = unit-&gt;losStatus[allyTeam];
+	const unsigned short losStatus = unit-&gt;losStatus[allyTeam];
+
+	if (fullRead &amp;&amp; lua_isboolean(L, 3) &amp;&amp; lua_toboolean(L, 3)) {
+		lua_pushnumber(L, losStatus);
+		return 1;
+	}
+	
 	lua_newtable(L);
 	if (losStatus &amp; LOS_INLOS) {
 		HSTR_PUSH_BOOL(L, &quot;los&quot;, true);

Modified: trunk/rts/Lua/LuaWeaponDefs.cpp
===================================================================
--- trunk/rts/Lua/LuaWeaponDefs.cpp	2008-05-17 23:59:04 UTC (rev 5906)
+++ trunk/rts/Lua/LuaWeaponDefs.cpp	2008-05-18 02:13:53 UTC (rev 5907)
@@ -48,6 +48,7 @@
 
 static int VisualsTable(lua_State* L, const void* data);
 static int DamagesArray(lua_State* L, const void* data);
+static int CustomParamsTable(lua_State* L, const void* data);
 static int GuiSoundSetTable(lua_State* L, const void* data);
 static int CategorySetFromBits(lua_State* L, const void* data);
 static int CategorySetFromString(lua_State* L, const void* data);
@@ -366,6 +367,20 @@
 }
 
 
+static int CustomParamsTable(lua_State* L, const void* data)
+{
+	const map&lt;string, string&gt;&amp; params = *((const map&lt;string, string&gt;*)data);
+	lua_newtable(L);
+	map&lt;string, string&gt;::const_iterator it;
+	for (it = params.begin(); it != params.end(); ++it) {
+		lua_pushstring(L, it-&gt;first.c_str());
+		lua_pushstring(L, it-&gt;second.c_str());
+		lua_rawset(L, -3);
+	}
+	return 1;
+}
+
+
 static int GuiSoundSetTable(lua_State* L, const void* data)
 {
 	const GuiSoundSet&amp; soundSet = *((const GuiSoundSet*) data);
@@ -404,6 +419,7 @@
 	ADD_FUNCTION(&quot;hitSound&quot;,  wd.soundhit,  GuiSoundSetTable);
 	ADD_FUNCTION(&quot;fireSound&quot;, wd.firesound, GuiSoundSetTable);
 
+	ADD_FUNCTION(&quot;customParams&quot;,         wd.customParams,   CustomParamsTable);
 	ADD_FUNCTION(&quot;noFeatureCollide&quot;,     wd.collisionFlags, NoFeatureCollide);
 	ADD_FUNCTION(&quot;noFriendlyCollide&quot;,    wd.collisionFlags, NoFriendlyCollide);
 	ADD_FUNCTION(&quot;noNeutralCollide&quot;,     wd.collisionFlags, NoNeutralCollide);

Modified: trunk/rts/Rendering/UnitModels/UnitDrawer.cpp
===================================================================
--- trunk/rts/Rendering/UnitModels/UnitDrawer.cpp	2008-05-17 23:59:04 UTC (rev 5906)
+++ trunk/rts/Rendering/UnitModels/UnitDrawer.cpp	2008-05-18 02:13:53 UTC (rev 5907)
@@ -302,9 +302,8 @@
 			continue;
 		}
 		if (camera-&gt;InView(unit-&gt;midPos, unit-&gt;radius + 30)) {
-			if (gs-&gt;Ally(unit-&gt;allyteam,gu-&gt;myAllyTeam)       ||
-			    (unit-&gt;losStatus[gu-&gt;myAllyTeam] &amp; LOS_INLOS) ||
-			    gu-&gt;spectatingFullView) {
+			const unsigned short losStatus = unit-&gt;losStatus[gu-&gt;myAllyTeam];
+			if ((losStatus &amp; LOS_INLOS) || gu-&gt;spectatingFullView) {
 
 				if (drawReflection) {
 					float3 zeroPos;
@@ -348,7 +347,7 @@
 					}
 				}
 			}
-			else if (unit-&gt;losStatus[gu-&gt;myAllyTeam] &amp; LOS_PREVLOS) {
+			else if (losStatus &amp; LOS_PREVLOS) {
 				unit-&gt;isIcon = true;
 
 				if ((!gameSetup || gameSetup-&gt;ghostedBuildings) &amp;&amp; !(unit-&gt;mobility)) {
@@ -367,15 +366,15 @@
 						unit-&gt;isIcon = false;
 					}
 				}
-				if ((unit-&gt;losStatus[gu-&gt;myAllyTeam] &amp; LOS_INRADAR)) {
-					if (!(unit-&gt;losStatus[gu-&gt;myAllyTeam] &amp; LOS_CONTRADAR)) {
+				if (losStatus &amp; LOS_INRADAR) {
+					if (!(losStatus &amp; LOS_CONTRADAR)) {
 						drawRadarIcon.push_back(unit);
 					} else if (unit-&gt;isIcon) {
 						// this prevents us from drawing icons on top of ghosted buildings
 						drawIcon.push_back(unit);
 					}
 				}
-			} else if ((unit-&gt;losStatus[gu-&gt;myAllyTeam] &amp; LOS_INRADAR)) {
+			} else if (losStatus &amp; LOS_INRADAR) {
 				drawRadarIcon.push_back(unit);
 			}
 		}
@@ -587,10 +586,9 @@
 	for (usi = uh-&gt;activeUnits.begin(); usi != uh-&gt;activeUnits.end(); ++usi) {
 		CUnit* unit = *usi;
 
-		if ((gs-&gt;Ally(unit-&gt;allyteam, gu-&gt;myAllyTeam)     ||
-			(unit-&gt;losStatus[gu-&gt;myAllyTeam] &amp; LOS_INLOS) ||
-			gu-&gt;spectatingFullView)
-		    &amp;&amp; camera-&gt;InView(unit-&gt;midPos, unit-&gt;radius + 700)) {
+		const unsigned short losStatus = unit-&gt;losStatus[gu-&gt;myAllyTeam];
+		if (((losStatus &amp; LOS_INLOS) || gu-&gt;spectatingFullView) &amp;&amp;
+		    camera-&gt;InView(unit-&gt;midPos, unit-&gt;radius + 700)) {
 
 			// FIXME: test against the shadow projection intersection
 			float sqDist = (unit-&gt;pos-camera-&gt;pos).SqLength();
@@ -835,8 +833,8 @@
 	// cloaked units and living ghosted buildings (stored in same vector)
 	for (vector&lt;CUnit*&gt;::iterator ui = dC.begin(); ui != dC.end(); ++ui) {
 		CUnit* unit = *ui;
-
-		if ((unit-&gt;losStatus[gu-&gt;myAllyTeam] &amp; LOS_INLOS) || gu-&gt;spectatingFullView) {
+		const unsigned short losStatus = unit-&gt;losStatus[gu-&gt;myAllyTeam];
+		if ((losStatus &amp; LOS_INLOS) || gu-&gt;spectatingFullView) {
 			if (is_s3o) {
 				SetBasicS3OTeamColour(unit-&gt;team);
 				texturehandler-&gt;SetS3oTexture(unit-&gt;model-&gt;textureType);
@@ -844,11 +842,11 @@
 			DrawUnitNow(unit);
 		} else {
 			// ghosted enemy units
-			if (unit-&gt;losStatus[gu-&gt;myAllyTeam] &amp; LOS_CONTRADAR)
+			if (losStatus &amp; LOS_CONTRADAR) {
 				glColor4f(0.9f, 0.9f, 0.9f, 0.5f);
-			else
+			} else {
 				glColor4f(0.6f, 0.6f, 0.6f, 0.4f);
-
+			}
 			glPushMatrix();
 			glTranslatef3(unit-&gt;pos);
 			glRotatef(unit-&gt;buildFacing * 90.0f, 0, 1, 0);

Modified: trunk/rts/Sim/Features/FeatureDef.h
===================================================================
--- trunk/rts/Sim/Features/FeatureDef.h	2008-05-17 23:59:04 UTC (rev 5906)
+++ trunk/rts/Sim/Features/FeatureDef.h	2008-05-18 02:13:53 UTC (rev 5907)
@@ -1,10 +1,15 @@
 #ifndef FEATURE_DEF_H
 #define FEATURE_DEF_H
 
+#include &lt;string&gt;
+#include &lt;map&gt;
+
+
 #define DRAWTYPE_3DO 0
 #define DRAWTYPE_TREE 1
 #define DRAWTYPE_NONE -1
 
+
 struct S3DOModel;
 struct CollisionVolume;
 
@@ -69,6 +74,8 @@
 	int xsize;
 	/// each size is 8 units
 	int ysize;
+
+	std::map&lt;std::string, std::string&gt; customParams;
 };
 
 #endif

Modified: trunk/rts/Sim/Features/FeatureHandler.cpp
===================================================================
--- trunk/rts/Sim/Features/FeatureHandler.cpp	2008-05-17 23:59:04 UTC (rev 5906)
+++ trunk/rts/Sim/Features/FeatureHandler.cpp	2008-05-18 02:13:53 UTC (rev 5907)
@@ -222,9 +222,9 @@
 
 	fd-&gt;deathFeature = fdTable.GetString(&quot;featureDead&quot;, &quot;&quot;);
 
-	fd-&gt;metal     = fdTable.GetFloat(&quot;metal&quot;,  0.0f);
-	fd-&gt;energy    = fdTable.GetFloat(&quot;energy&quot;, 0.0f);
-	fd-&gt;maxHealth = fdTable.GetFloat(&quot;damage&quot;, 0.0f);
+	fd-&gt;metal       = fdTable.GetFloat(&quot;metal&quot;,  0.0f);
+	fd-&gt;energy      = fdTable.GetFloat(&quot;energy&quot;, 0.0f);
+	fd-&gt;maxHealth   = fdTable.GetFloat(&quot;damage&quot;, 0.0f);
 	fd-&gt;reclaimTime = fdTable.GetFloat(&quot;reclaimTime&quot;, (fd-&gt;metal + fd-&gt;energy));
 
 	fd-&gt;drawType = DRAWTYPE_3DO;
@@ -242,17 +242,16 @@
 
 	// these take precedence over the old sphere tags as well as
 	// feature-&gt;radius (for feature &lt;--&gt; projectile interactions)
-	fd-&gt;collisionVolumeType = fdTable.GetString(&quot;collisionVolumeType&quot;, &quot;&quot;);
-	fd-&gt;collisionVolumeScales = fdTable.GetFloat3(&quot;collisionVolumeScales&quot;, ZeroVector);
+	fd-&gt;collisionVolumeType    = fdTable.GetString(&quot;collisionVolumeType&quot;, &quot;&quot;);
+	fd-&gt;collisionVolumeScales  = fdTable.GetFloat3(&quot;collisionVolumeScales&quot;, ZeroVector);
 	fd-&gt;collisionVolumeOffsets = fdTable.GetFloat3(&quot;collisionVolumeOffsets&quot;, ZeroVector);
-	fd-&gt;collisionVolumeTest = fdTable.GetInt(&quot;collisionVolumeTest&quot;, COLVOL_TEST_CONT);
+	fd-&gt;collisionVolumeTest    = fdTable.GetInt(&quot;collisionVolumeTest&quot;, COLVOL_TEST_CONT);
 
 	// initialize the (per-featuredef) collision-volume,
 	// all CFeature instances hold a copy of this object
 	fd-&gt;collisionVolume = SAFE_NEW CollisionVolume(fd-&gt;collisionVolumeType,
-		fd-&gt;collisionVolumeScales, fd-&gt;collisionVolumeOffsets, fd-&gt;collisionVolumeTest);
+	fd-&gt;collisionVolumeScales, fd-&gt;collisionVolumeOffsets, fd-&gt;collisionVolumeTest);
 
-
 	fd-&gt;upright = fdTable.GetBool(&quot;upright&quot;, false);
 
 	// our resolution is double TA's
@@ -263,6 +262,9 @@
 	fd-&gt;mass = fdTable.GetFloat(&quot;mass&quot;, defMass);
 	fd-&gt;mass = max(0.001f, fd-&gt;mass);
 
+	// custom parameters table
+	fdTable.SubTable(&quot;customParams&quot;).GetMap(fd-&gt;customParams);
+
 	AddFeatureDef(name, fd);
 
 	fi = featureDefs.find(name);

Modified: trunk/rts/Sim/Misc/LosHandler.h
===================================================================
--- trunk/rts/Sim/Misc/LosHandler.h	2008-05-17 23:59:04 UTC (rev 5906)
+++ trunk/rts/Sim/Misc/LosHandler.h	2008-05-18 02:13:53 UTC (rev 5907)
@@ -58,10 +58,10 @@
 	void FreeInstance(LosInstance* instance);
 
 	bool InLos(const CUnit* unit, int allyTeam) {
+		if (unit-&gt;alwaysVisible)
+			return true;
 		if (unit-&gt;isCloaked)
 			return false;
-		if (unit-&gt;alwaysVisible)
-			return true;
 		if (unit-&gt;useAirLos) {
 			const int rowIdx = std::max(0, std::min(airSizeY - 1, ((int(unit-&gt;pos.z * invAirDiv))))) * airSizeX;
 			const int colIdx = std::max(0, std::min(airSizeX - 1, ((int(unit-&gt;pos.x * invAirDiv)))));

Modified: trunk/rts/Sim/Units/COB/CobInstance.cpp
===================================================================
--- trunk/rts/Sim/Units/COB/CobInstance.cpp	2008-05-17 23:59:04 UTC (rev 5906)
+++ trunk/rts/Sim/Units/COB/CobInstance.cpp	2008-05-18 02:13:53 UTC (rev 5907)
@@ -666,6 +666,7 @@
 			break;}
 		case 257:	//damaged unit smoke
 			SAFE_NEW CSmokeProjectile(pos,gu-&gt;usRandVector()*0.5f+UpVector*1.1f,60,4,0.5f,unit,0.5f);
+			// FIXME -- needs a 'break'?
 		case 258:		//damaged unit smoke
 			SAFE_NEW CSmokeProjectile(pos,gu-&gt;usRandVector()*0.5f+UpVector*1.1f,60,4,0.5f,unit,0.6f);
 			break;
@@ -1229,7 +1230,6 @@
 		const int weaponID = p1 - 1;
 		const int targetID = p2;
 		const bool userTarget = !!p3;
-		//logOutput.Print(&quot;SET_WEAPON_UNIT_TARGET: %i %i %i\n&quot;, weaponID, targetID, p3);		 // FIXME
 		if ((weaponID &lt; 0) || (weaponID &gt;= unit-&gt;weapons.size())) {
 			return 0;
 		}
@@ -1237,7 +1237,6 @@
 		if (weapon == NULL) { return 0; }
 		if ((targetID &lt; 0) || (targetID &gt;= MAX_UNITS)) { return 0; }
 		CUnit* target = (targetID == 0) ? NULL : uh-&gt;units[targetID];
-		//logOutput.Print(&quot;SET_WEAPON_UNIT_TARGET2\n&quot;);		 // FIXME
 		return weapon-&gt;AttackUnit(target, userTarget) ? 1 : 0;
 	}
 	case SET_WEAPON_GROUND_TARGET: {
@@ -1246,7 +1245,6 @@
 		                          float(p3) / float(COBSCALE),
 		                          float(UNPACKZ(p2)));
 		const bool userTarget = !!p4;
-		//logOutput.Print(&quot;SET_WEAPON_GROUND_TARGET: %i %f %f %f\n&quot;, weaponID, pos.x, pos.y, pos.z);//FIXME
 		if ((weaponID &lt; 0) || (weaponID &gt;= unit-&gt;weapons.size())) {
 			return 0;
 		}

Modified: trunk/rts/Sim/Units/Unit.cpp
===================================================================
--- trunk/rts/Sim/Units/Unit.cpp	2008-05-17 23:59:04 UTC (rev 5906)
+++ trunk/rts/Sim/Units/Unit.cpp	2008-05-18 02:13:53 UTC (rev 5907)
@@ -330,7 +330,8 @@
 		losStatus[a] = 0;
 	}
 
-	losStatus[allyteam] = LOS_INTEAM | LOS_INLOS | LOS_INRADAR | LOS_PREVLOS | LOS_CONTRADAR;
+	losStatus[allyteam] = LOS_ALL_MASK_BITS |
+		LOS_INLOS | LOS_INRADAR | LOS_PREVLOS | LOS_CONTRADAR;
 
 	posErrorVector = gs-&gt;randVector();
 	posErrorVector.y *= 0.2f;
@@ -542,13 +543,88 @@
 }
 
 
+void CUnit::SetLosStatus(int at, unsigned short newStatus)
+{
+	const unsigned short currStatus = losStatus[at];
+	const unsigned short diffBits = (currStatus ^ newStatus);
+
+	if (diffBits) {
+		if (diffBits &amp; LOS_INLOS) {
+			if (newStatus &amp; LOS_INLOS) {
+				luaCallIns.UnitEnteredLos(this, at);
+				globalAI-&gt;UnitEnteredLos(this, at);
+			} else {
+				luaCallIns.UnitLeftLos(this, at);
+				globalAI-&gt;UnitLeftLos(this, at);
+			}
+		}	
+
+		if (diffBits &amp; LOS_INRADAR) {
+			if (newStatus &amp; LOS_INRADAR) {
+				luaCallIns.UnitEnteredRadar(this, at);
+				globalAI-&gt;UnitEnteredRadar(this, at);
+			} else {
+				luaCallIns.UnitLeftRadar(this, at);
+				globalAI-&gt;UnitLeftRadar(this, at);
+			}
+		}
+	}
+
+	losStatus[at] = newStatus;
+}
+
+
+unsigned short CUnit::CalcLosStatus(int at)
+{
+	const unsigned short currStatus = losStatus[at];
+
+	const bool inLos = loshandler-&gt;InLos(this, at);
+	const bool inRadar = inLos || radarhandler-&gt;InRadar(this, at);
+
+	unsigned short newStatus = currStatus;
+	unsigned short mask = ~(currStatus &gt;&gt; 8);
+
+	if (inLos) {
+		if (!beingBuilt) {
+			newStatus |= (mask &amp; (LOS_INLOS   | LOS_INRADAR |
+			                      LOS_PREVLOS | LOS_CONTRADAR));
+		} else {
+			// we are being built, do not set LOS_PREVLOS
+			// since we do not want ghosts for nanoframes
+			newStatus |=  (mask &amp; (LOS_INLOS   | LOS_INRADAR));
+			newStatus &amp;= ~(mask &amp; (LOS_PREVLOS | LOS_CONTRADAR));
+		}
+	}
+	else if (inRadar) {
+		newStatus |=  (mask &amp; LOS_INRADAR);
+		newStatus &amp;= ~(mask &amp; LOS_INLOS);
+	}
+	else {
+		newStatus &amp;= ~(mask &amp; (LOS_INLOS | LOS_INRADAR | LOS_CONTRADAR));
+	}
+
+	return newStatus;
+}
+
+
 inline void CUnit::UpdateLosStatus(int at)
 {
-	const int prevLosStatus = losStatus[at];
-	if ((prevLosStatus &amp; LOS_INTEAM) != 0) {
-		return; // allied -- no need to update
+	const unsigned short currStatus = losStatus[at];
+	if ((currStatus &amp; LOS_ALL_MASK_BITS) == LOS_ALL_MASK_BITS) {
+		return; // no need to update, all changes are masked
 	}
+	SetLosStatus(at, CalcLosStatus(at));
+}
 
+
+/* FIXME
+inline void CUnit::UpdateLosStatus(int at)
+{
+	const unsigned short prevLosStatus = losStatus[at];
+	if ((prevLosStatus &amp; LOS_ALL_MASK_BITS) == LOS_ALL_MASK_BITS) {
+		return; // no need to update
+	}
+
 	if (loshandler-&gt;InLos(this, at)) {
 		if ((prevLosStatus &amp; LOS_INLOS) == 0) {
 			// we were not previously in LOS for this allyteam
@@ -602,6 +678,7 @@
 		}
 	}
 }
+*/
 
 
 void CUnit::SlowUpdate()
@@ -1173,13 +1250,14 @@
 	}
 }
 
-void CUnit::ChangeLos(int l,int airlos)
+
+void CUnit::ChangeLos(int l, int airlos)
 {
 	loshandler-&gt;FreeInstance(los);
 	los=0;
 	losRadius=l;
 	airLosRadius=airlos;
-	loshandler-&gt;MoveUnit(this,false);
+	loshandler-&gt;MoveUnit(this, false);
 }
 
 
@@ -1266,7 +1344,9 @@
 	neutral = false;
 
 	loshandler-&gt;MoveUnit(this,false);
-	losStatus[allyteam] = LOS_INTEAM | LOS_INLOS | LOS_INRADAR | LOS_PREVLOS | LOS_CONTRADAR;
+	losStatus[allyteam] = LOS_ALL_MASK_BITS |
+		LOS_INLOS | LOS_INRADAR | LOS_PREVLOS | LOS_CONTRADAR;
+
 	qf-&gt;MovedUnit(this);
 	if (hasRadarCapacity) {
 		radarhandler-&gt;MoveUnit(this);

Modified: trunk/rts/Sim/Units/Unit.h
===================================================================
--- trunk/rts/Sim/Units/Unit.h	2008-05-17 23:59:04 UTC (rev 5906)
+++ trunk/rts/Sim/Units/Unit.h	2008-05-18 02:13:53 UTC (rev 5907)
@@ -41,10 +41,18 @@
 #define LOS_INRADAR    (1 &lt;&lt; 1)  // the unit is currently in radar from the allyteam
 #define LOS_PREVLOS    (1 &lt;&lt; 2)  // the unit has previously been in los from the allyteam
 #define LOS_CONTRADAR  (1 &lt;&lt; 3)  // the unit has continously been in radar since it was last inlos by the allyteam
-#define LOS_INTEAM     (1 &lt;&lt; 4)  // the unit is part of this allyteam
 
+// LOS mask bits  (masked bits are not automatically updated)
+#define LOS_INLOS_MASK     (1 &lt;&lt; 8)   // do not update LOS_INLOS
+#define LOS_INRADAR_MASK   (1 &lt;&lt; 9)   // do not update LOS_INRADAR
+#define LOS_PREVLOS_MASK   (1 &lt;&lt; 10)  // do not update LOS_PREVLOS
+#define LOS_CONTRADAR_MASK (1 &lt;&lt; 11)  // do not update LOS_CONTRADAR
 
-enum ScriptCloakBits {
+#define LOS_ALL_MASK_BITS \
+	(LOS_INLOS_MASK | LOS_INRADAR_MASK | LOS_PREVLOS_MASK | LOS_CONTRADAR_MASK)
+
+
+enum ScriptCloakBits { // FIXME -- not implemented
 	// always set to 0 if not enabled
 	SCRIPT_CLOAK_ENABLED          = (1 &lt;&lt; 0),
 	SCRIPT_CLOAK_IGNORE_ENERGY    = (1 &lt;&lt; 1),
@@ -74,7 +82,7 @@
 	                      const float3&amp; impulse, int weaponId = -1);
 	virtual void Kill(float3&amp; impulse);
 	virtual void FinishedBuilding(void);
-	void ChangeLos(int l,int airlos);
+	void ChangeLos(int l, int airlos);
 	bool AddBuildPower(float amount,CUnit* builder);		//negative amount=reclaim, return= true -&gt; build power was succesfully applied
 	void Activate();		//turn the unit on
 	void Deactivate();		//turn the unit off
@@ -124,6 +132,9 @@
 		return ((gs-&gt;useLuaGaia &amp;&amp; team == gs-&gt;gaiaTeamID) || (team == MAX_TEAMS - 1) || neutral);
 	}
 
+	void SetLosStatus(int allyTeam, unsigned short newStatus);
+	unsigned short CalcLosStatus(int allyTeam);
+
 	enum ChangeType{
 		ChangeGiven,
 		ChangeCaptured
@@ -183,7 +194,7 @@
 	int realLosRadius;				//set los to this when finished building
 	int realAirLosRadius;
 
-	int losStatus[MAX_TEAMS];	//indicate the los/radar status the allyteam has on this unit
+	unsigned short losStatus[MAX_TEAMS];	//indicate the los/radar status the allyteam has on this unit
 
 	bool inBuildStance;				//used by constructing unigs
 	bool stunned;							//if we are stunned by a weapon or for other reason

Modified: trunk/rts/Sim/Weapons/WeaponDefHandler.cpp
===================================================================
--- trunk/rts/Sim/Weapons/WeaponDefHandler.cpp	2008-05-17 23:59:04 UTC (rev 5906)
+++ trunk/rts/Sim/Weapons/WeaponDefHandler.cpp	2008-05-18 02:13:53 UTC (rev 5907)
@@ -605,6 +605,9 @@
 			}
 		}
 	}
+
+	// custom parameters table
+	wdTable.SubTable(&quot;customParams&quot;).GetMap(wd.customParams);
 }
 
 

Modified: trunk/rts/Sim/Weapons/WeaponDefHandler.h
===================================================================
--- trunk/rts/Sim/Weapons/WeaponDefHandler.h	2008-05-17 23:59:04 UTC (rev 5906)
+++ trunk/rts/Sim/Weapons/WeaponDefHandler.h	2008-05-18 02:13:53 UTC (rev 5907)
@@ -224,6 +224,8 @@
 	float dynDamageMin;
 	float dynDamageRange;
 	bool dynDamageInverted;
+
+	std::map&lt;std::string, std::string&gt; customParams;
 };
 
 

Modified: trunk/rts/System/AutohostInterface.h
===================================================================
--- trunk/rts/System/AutohostInterface.h	2008-05-17 23:59:04 UTC (rev 5906)
+++ trunk/rts/System/AutohostInterface.h	2008-05-18 02:13:53 UTC (rev 5907)
@@ -39,7 +39,7 @@
 	void Warning(const std::string&amp; message);
 	
 	/**
-	@brief Recieve a chat message from the autohost
+	@brief Receive a chat message from the autohost
 	There should be only 1 message per UDP-Packet, and it will use the hosts playernumber to inject this message
 	*/
 	std::string GetChatMessage() const;

Modified: trunk/rts/System/Net/Connection.cpp
===================================================================
--- trunk/rts/System/Net/Connection.cpp	2008-05-17 23:59:04 UTC (rev 5906)
+++ trunk/rts/System/Net/Connection.cpp	2008-05-18 02:13:53 UTC (rev 5907)
@@ -12,7 +12,7 @@
 {
 }
 
-unsigned CConnection::GetDataRecieved() const
+unsigned CConnection::GetDataReceived() const
 {
 	return dataRecv;
 }

Modified: trunk/rts/System/Net/Connection.h
===================================================================
--- trunk/rts/System/Net/Connection.h	2008-05-17 23:59:04 UTC (rev 5906)
+++ trunk/rts/System/Net/Connection.h	2008-05-18 02:13:53 UTC (rev 5907)
@@ -45,7 +45,7 @@
 	virtual void Flush(const bool forced = false)=0;
 	virtual bool CheckTimeout() const = 0;
 	
-	unsigned GetDataRecieved() const;
+	unsigned GetDataReceived() const;
 	
 	virtual std::string Statistics() const = 0;
 	virtual NetAddress GetPeerName() const = 0;

Modified: trunk/rts/System/Net/LocalConnection.cpp
===================================================================
--- trunk/rts/System/Net/LocalConnection.cpp	2008-05-17 23:59:04 UTC (rev 5906)
+++ trunk/rts/System/Net/LocalConnection.cpp	2008-05-18 02:13:53 UTC (rev 5907)
@@ -77,7 +77,7 @@
 std::string CLocalConnection::Statistics() const
 {
 	std::string msg = &quot;Statistics for local connection:\n&quot;;
-	msg += str( boost::format(&quot;Recieved: %1% bytes\n&quot;) %dataRecv );
+	msg += str( boost::format(&quot;Received: %1% bytes\n&quot;) %dataRecv );
 	msg += str( boost::format(&quot;Sent: %1% bytes\n&quot;) %dataSent );
 	return msg;
 }

Modified: trunk/rts/System/Net/Net.cpp
===================================================================
--- trunk/rts/System/Net/Net.cpp	2008-05-17 23:59:04 UTC (rev 5906)
+++ trunk/rts/System/Net/Net.cpp	2008-05-18 02:13:53 UTC (rev 5907)
@@ -98,7 +98,7 @@
 {
 	for (connVec::const_iterator  i = connections.begin(); i &lt; connections.end(); ++i)
 	{
-		if ((*i) &amp;&amp; (*i)-&gt;GetDataRecieved() &gt; 0)
+		if ((*i) &amp;&amp; (*i)-&gt;GetDataReceived() &gt; 0)
 		{
 			return true;
 		}

Modified: trunk/rts/System/Net/Net.h
===================================================================
--- trunk/rts/System/Net/Net.h	2008-05-17 23:59:04 UTC (rev 5906)
+++ trunk/rts/System/Net/Net.h	2008-05-18 02:13:53 UTC (rev 5907)
@@ -142,7 +142,7 @@
 	boost::shared_ptr&lt;const RawPacket&gt; Peek(const unsigned conNum, unsigned ahead) const;
 
 	/**
-	@brief Recieve data from a client
+	@brief Receive data from a client
 	@param conNum The number to recieve from
 	@return a smart RawPacket pointer with the data inside (or empty when no data)
 	@throw network_error When conNum is not a valid connection ID
@@ -187,7 +187,7 @@
 	/// did someone tried to connect?
 	bool HasIncomingConnection() const;
 	
-	/// Recieve data from first unbound connection to check if we allow him in our game
+	/// Receive data from first unbound connection to check if we allow him in our game
 	boost::shared_ptr&lt;const RawPacket&gt; GetData();
 	
 	/// everything seems fine, accept him

Modified: trunk/rts/System/Net/Test/main.cpp
===================================================================
--- trunk/rts/System/Net/Test/main.cpp	2008-05-17 23:59:04 UTC (rev 5906)
+++ trunk/rts/System/Net/Test/main.cpp	2008-05-18 02:13:53 UTC (rev 5907)
@@ -97,7 +97,7 @@
 		boost::shared_ptr&lt;const netcode::RawPacket&gt; ret  = server-&gt;GetData(1);
 		if (ret)
 		{
-			std::cout &lt;&lt; &quot;Recieved &quot; &lt;&lt; ret-&gt;length &lt;&lt; &quot; bytes UDP client message &quot; &lt;&lt; (int)ret-&gt;data[1] &lt;&lt; std::endl;
+			std::cout &lt;&lt; &quot;Received &quot; &lt;&lt; ret-&gt;length &lt;&lt; &quot; bytes UDP client message &quot; &lt;&lt; (int)ret-&gt;data[1] &lt;&lt; std::endl;
 			ret.reset();
 		}
 		else
@@ -111,7 +111,7 @@
 		ret = client-&gt;GetData(1);
 		if (ret)
 		{
-			std::cout &lt;&lt; &quot;Recieved &quot; &lt;&lt; ret-&gt;length &lt;&lt; &quot; bytes UDP server message &quot; &lt;&lt; (int)ret-&gt;data[1] &lt;&lt; std::endl;
+			std::cout &lt;&lt; &quot;Received &quot; &lt;&lt; ret-&gt;length &lt;&lt; &quot; bytes UDP server message &quot; &lt;&lt; (int)ret-&gt;data[1] &lt;&lt; std::endl;
 			ret.reset();
 		}
 		else
@@ -124,7 +124,7 @@
 		ret = server-&gt;GetData(1);
 		if (ret)
 		{
-			std::cout &lt;&lt; &quot;Recieved &quot; &lt;&lt; ret-&gt;length &lt;&lt; &quot; bytes UDP client message&quot; &lt;&lt; std::endl;
+			std::cout &lt;&lt; &quot;Received &quot; &lt;&lt; ret-&gt;length &lt;&lt; &quot; bytes UDP client message&quot; &lt;&lt; std::endl;
 			ret.reset();
 		}
 		else

Modified: trunk/rts/System/Net/UDPConnectedSocket.h
===================================================================
--- trunk/rts/System/Net/UDPConnectedSocket.h	2008-05-17 23:59:04 UTC (rev 5906)
+++ trunk/rts/System/Net/UDPConnectedSocket.h	2008-05-18 02:13:53 UTC (rev 5907)
@@ -27,7 +27,7 @@
 	void Send(const unsigned char* const buf, const unsigned dataLength) const;
 	
 	/**
-	@brief Recieve some data
+	@brief Receive some data
 	*/
 	unsigned Recv(unsigned char* buf, const unsigned bufLength) const;
 

Modified: trunk/rts/System/Net/UDPConnection.cpp
===================================================================
--- trunk/rts/System/Net/UDPConnection.cpp	2008-05-17 23:59:04 UTC (rev 5906)
+++ trunk/rts/System/Net/UDPConnection.cpp	2008-05-18 02:13:53 UTC (rev 5907)
@@ -268,7 +268,7 @@
 std::string UDPConnection::Statistics() const
 {
 	std::string msg = &quot;Statistics for UDP connection:\n&quot;;
-	msg += str( boost::format(&quot;Recieved: %1% bytes in %2% packets (%3% bytes/package)\n&quot;) %dataRecv %recvPackets %((float)dataRecv / (float)recvPackets));
+	msg += str( boost::format(&quot;Received: %1% bytes in %2% packets (%3% bytes/package)\n&quot;) %dataRecv %recvPackets %((float)dataRecv / (float)recvPackets));
 	msg += str( boost::format(&quot;Sent: %1% bytes in %2% packets (%3% bytes/package)\n&quot;) %dataSent %sentPackets %((float)dataSent / (float)sentPackets));
 	msg += str( boost::format(&quot;Relative protocol overhead: %1% up, %2% down\n&quot;) %((float)sentOverhead / (float)dataSent) %((float)recvOverhead / (float)dataRecv) );
 	msg += str( boost::format(&quot;%1% incoming packets had been dropped, %2% outgoing packets had to be resent\n&quot;) %droppedPackets %resentPackets);

Modified: trunk/rts/System/NetProtocol.h
===================================================================
--- trunk/rts/System/NetProtocol.h	2008-05-17 23:59:04 UTC (rev 5906)
+++ trunk/rts/System/NetProtocol.h	2008-05-18 02:13:53 UTC (rev 5907)
@@ -39,11 +39,11 @@
 	boost::shared_ptr&lt;const netcode::RawPacket&gt; Peek(unsigned ahead) const;
 
 	/**
-	@brief Recieve data from Client
+	@brief Receive data from Client
 	@return The data packet, or 0 if there is no data
 	@throw network_error If there is no such connection
 	
-	Recieves only one message (even if there are more in the recieve buffer), so call this until you get a 0 in return
+	Receives only one message (even if there are more in the recieve buffer), so call this until you get a 0 in return
 	 */
 	boost::shared_ptr&lt;const netcode::RawPacket&gt; GetData();
 	


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000686.html">[Taspring-linux-commit] r5906 -	site/trunk/www-root/forums/styles/spring/template
</A></li>
	<LI>Next message: <A HREF="000688.html">[Taspring-linux-commit] r5908 - trunk/rts/Sim/Units
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#687">[ date ]</a>
              <a href="thread.html#687">[ thread ]</a>
              <a href="subject.html#687">[ subject ]</a>
              <a href="author.html#687">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
