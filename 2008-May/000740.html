<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r5960 - in trunk: game/LuaUI	game/LuaUI/Widgets installer/builddata/springcontent/LuaGadgets	installer/builddata/springcontent/gamedata rts/Game	rts/Game/Camera rts/Game/StartScripts rts/Game/UI rts/Lua	rts/Map rts/Rendering rts/Rendering/Env rts/Rendering/GL	rts/Rendering/Textures rts/Sim/Projectiles
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-May/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5960%20-%20in%20trunk%3A%20game/LuaUI%0A%09game/LuaUI/Widgets%20installer/builddata/springcontent/LuaGadgets%0A%09installer/builddata/springcontent/gamedata%20rts/Game%0A%09rts/Game/Camera%20rts/Game/StartScripts%20rts/Game/UI%20rts/Lua%0A%09rts/Map%20rts/Rendering%20rts/Rendering/Env%20rts/Rendering/GL%0A%09rts/Rendering/Textures%20rts/Sim/Projectiles&In-Reply-To=%3C20080527224103.9AC7043DA%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000739.html">
   <LINK REL="Next"  HREF="000741.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r5960 - in trunk: game/LuaUI	game/LuaUI/Widgets installer/builddata/springcontent/LuaGadgets	installer/builddata/springcontent/gamedata rts/Game	rts/Game/Camera rts/Game/StartScripts rts/Game/UI rts/Lua	rts/Map rts/Rendering rts/Rendering/Env rts/Rendering/GL	rts/Rendering/Textures rts/Sim/Projectiles</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5960%20-%20in%20trunk%3A%20game/LuaUI%0A%09game/LuaUI/Widgets%20installer/builddata/springcontent/LuaGadgets%0A%09installer/builddata/springcontent/gamedata%20rts/Game%0A%09rts/Game/Camera%20rts/Game/StartScripts%20rts/Game/UI%20rts/Lua%0A%09rts/Map%20rts/Rendering%20rts/Rendering/Env%20rts/Rendering/GL%0A%09rts/Rendering/Textures%20rts/Sim/Projectiles&In-Reply-To=%3C20080527224103.9AC7043DA%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r5960 - in trunk: game/LuaUI	game/LuaUI/Widgets installer/builddata/springcontent/LuaGadgets	installer/builddata/springcontent/gamedata rts/Game	rts/Game/Camera rts/Game/StartScripts rts/Game/UI rts/Lua	rts/Map rts/Rendering rts/Rendering/Env rts/Rendering/GL	rts/Rendering/Textures rts/Sim/Projectiles">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Wed May 28 00:41:03 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000739.html">[Taspring-linux-commit] r5959 - trunk/rts/Game/UI
</A></li>
        <LI>Next message: <A HREF="000741.html">[Taspring-linux-commit] r5961 - in branches/gml/rts: . ExternalAI	Game Game/Camera Game/StartScripts Game/UI Lua Map	Map/SM3/terrain Map/SMF Rendering Rendering/Env Rendering/GL	Rendering/Textures Rendering/UnitModels Sim Sim/Features	Sim/Misc Sim/Projectiles Sim/Units Sim/Units/COB Sim/Weapons	System System/FileSystem System/Net System/Net/Test build	build/cmake build/vstudio8 lib lib/gml lib/lua lib/lua/src	lib/streflop
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#740">[ date ]</a>
              <a href="thread.html#740">[ thread ]</a>
              <a href="subject.html#740">[ subject ]</a>
              <a href="author.html#740">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: trepan
Date: 2008-05-28 00:41:01 +0200 (Wed, 28 May 2008)
New Revision: 5960

Modified:
   trunk/game/LuaUI/Widgets/gui_comm_ends.lua
   trunk/game/LuaUI/Widgets/gui_game_setup.lua
   trunk/game/LuaUI/fonts.lua
   trunk/installer/builddata/springcontent/LuaGadgets/gadgets.lua
   trunk/installer/builddata/springcontent/gamedata/resources.lua
   trunk/rts/Game/Camera/FreeController.cpp
   trunk/rts/Game/CameraHandler.cpp
   trunk/rts/Game/CameraHandler.h
   trunk/rts/Game/StartScripts/CommanderScript2.cpp
   trunk/rts/Game/Team.cpp
   trunk/rts/Game/UI/GameSetupDrawer.cpp
   trunk/rts/Game/UI/KeyAutoBinder.cpp
   trunk/rts/Game/UI/LuaUI.cpp
   trunk/rts/Lua/LuaFeatureDefs.cpp
   trunk/rts/Lua/LuaParser.cpp
   trunk/rts/Lua/LuaParser.h
   trunk/rts/Lua/LuaUnitDefs.cpp
   trunk/rts/Lua/LuaUtils.cpp
   trunk/rts/Lua/LuaWeaponDefs.cpp
   trunk/rts/Map/MapInfo.cpp
   trunk/rts/Rendering/Env/AdvTreeGenerator.cpp
   trunk/rts/Rendering/Env/BasicTreeDrawer.cpp
   trunk/rts/Rendering/FontTexture.cpp
   trunk/rts/Rendering/GL/myGL.cpp
   trunk/rts/Rendering/GroundDecalHandler.cpp
   trunk/rts/Rendering/Textures/NamedTextures.cpp
   trunk/rts/Sim/Projectiles/ProjectileHandler.cpp
Log:

- changed resources.lua format so that it does not have
  to have a &lt; resources = { } &gt; top level table
  (consistent with the other lua def scripts)

- added CamModeName as an alternate for CamMode
  (should still be backwards compatible for settings programs)

- better initialization for FreeCamera's  'pos' and 'dir'

- added some untested code for proxied gadget events
  (KeyPress, KeyRelease, etc...)  there's also a little widget
  that goes along with this so that the user can control whether
  or not the gadget code can steal their clicks

- changed to NEAREST filtering for gui_game_setup.lua's font rendering



Modified: trunk/game/LuaUI/Widgets/gui_comm_ends.lua
===================================================================
--- trunk/game/LuaUI/Widgets/gui_comm_ends.lua	2008-05-27 22:28:07 UTC (rev 5959)
+++ trunk/game/LuaUI/Widgets/gui_comm_ends.lua	2008-05-27 22:41:01 UTC (rev 5960)
@@ -45,9 +45,12 @@
 local floor = math.floor
 
 
-local font = &quot;LuaUI/Fonts/FreeSansBold_30&quot;
-local fh = fontHandler.UseFont(font)
+local font = 'FreeMonoBold'
+local fontSize = 32
+local fontName = LUAUI_DIRNAME..'Fonts/'..font..'_'..fontSize
 
+local fh = fontHandler.UseFont(fontName)
+
 local vsx, vsy = widgetHandler:GetViewSizes()
 function widget:ViewResize(viewSizeX, viewSizeY)
   vsx = viewSizeX
@@ -74,7 +77,7 @@
     glScale(1.5, 1.5, 1)
     glRotate(30 * math.sin(math.pi * 0.5 * timer), 0, 0, 1)
     if (fh) then
-      fh = fontHandler.UseFont(font)
+      fh = fontHandler.UseFont(fontName)
       fontHandler.DrawCentered(msg)
     else
       glText(msg, 0, 0, 24, &quot;oc&quot;)

Modified: trunk/game/LuaUI/Widgets/gui_game_setup.lua
===================================================================
--- trunk/game/LuaUI/Widgets/gui_game_setup.lua	2008-05-27 22:28:07 UTC (rev 5959)
+++ trunk/game/LuaUI/Widgets/gui_game_setup.lua	2008-05-27 22:41:01 UTC (rev 5960)
@@ -53,6 +53,7 @@
 local font = 'FreeMonoBold'
 local fontSize = 16
 local fontGap  = 3
+local fontName = ':n:'..LUAUI_DIRNAME..'Fonts/'..font..'_'..fontSize
 
 local stateColorStrs = {
   missing  = string.char(255, 255,   1,   1),
@@ -140,7 +141,7 @@
     local str = colorStr .. ' '
     str = str .. name
     --str = str .. WhiteStr .. '  (' .. string.lower(flag.name) .. ')'
-    if (fontHandler.UseFont('LuaUI/Fonts/'..font..'_'..fontSize)) then
+    if (fontHandler.UseFont(fontName)) then
       fontHandler.Draw(str, xt, y)
     else 
       gl.Text(str, xt, y, fontSize, 'o')

Modified: trunk/game/LuaUI/fonts.lua
===================================================================
--- trunk/game/LuaUI/fonts.lua	2008-05-27 22:28:07 UTC (rev 5959)
+++ trunk/game/LuaUI/fonts.lua	2008-05-27 22:41:01 UTC (rev 5960)
@@ -88,16 +88,19 @@
 
 local function CreateFontFiles(fontName)
   local _, _, name, size = string.find(fontName, '^(.*)_(%d*)$')
-  if (name and size) then
-    local fullName
-    if (VFS.FileExists(name .. '.ttf', VFS.RAW_ONLY)) then
-      fullName = name .. '.ttf'
-    elseif (VFS.FileExists(name .. '.otf', VFS.RAW_ONLY)) then
-      fullName = name .. '.otf'
-    else
-      return
-    end
-    print('CreateFontFiles = ' .. fullName .. '.ttf, ' .. size)
+  if ((not name) or (not size)) then
+    return false
+  end
+  local fullName
+  if (VFS.FileExists(name .. '.ttf', VFS.RAW_ONLY)) then
+    fullName = name .. '.ttf'
+  elseif (VFS.FileExists(name .. '.otf', VFS.RAW_ONLY)) then
+    fullName = name .. '.otf'
+  else
+    return false
+  end
+  print('CreateFontFiles = ' .. fullName .. '.ttf, ' .. size)
+  return
     Spring.MakeFont(fullName, {
       height = tonumber(size),
       minChar = 0,
@@ -112,8 +115,6 @@
       debug =
     --]]
     })
-  end
-  return
 end
 
 
@@ -274,8 +275,8 @@
     end
     if (strlen(color) == 4) then
       glColor(strbyte(color, 2) / 255,
-               strbyte(color, 3) / 255,
-               strbyte(color, 4) / 255)
+              strbyte(color, 3) / 255,
+              strbyte(color, 4) / 255)
     end
   end
 end
@@ -360,7 +361,7 @@
 --------------------------------------------------------------------------------
 
 local function LoadFont(fontName)
-  print('LoadFont:' .. fontName)
+  print('LoadFont:  ' .. fontName)
 
   if (fonts[fontName]) then
     return nil  -- already loaded
@@ -371,7 +372,7 @@
   if (options) then
     baseName = bn
   else
-    options = &quot;&quot;
+    options = ''
   end
 
   if (not HaveFontFiles(baseName)) then
@@ -439,6 +440,7 @@
   local tmpFont = activeFont
   if (UseFont(name)) then
     DefaultFontName = name
+    defaultFont = activeFont
   end
   activeFont = tmpFont
 end

Modified: trunk/installer/builddata/springcontent/LuaGadgets/gadgets.lua
===================================================================
--- trunk/installer/builddata/springcontent/LuaGadgets/gadgets.lua	2008-05-27 22:28:07 UTC (rev 5959)
+++ trunk/installer/builddata/springcontent/LuaGadgets/gadgets.lua	2008-05-27 22:41:01 UTC (rev 5960)
@@ -19,7 +19,7 @@
 
 local SAFEWRAP = 0
 -- 0: disabled
--- 1: enabled, but can be overriden by widget.GetInfo().unsafe
+-- 1: enabled, but can be overriden by gadget.GetInfo().unsafe
 -- 2: always enabled
 
 
@@ -77,6 +77,8 @@
   yViewSize    = 1,
   xViewSizeOld = 1,
   yViewSizeOld = 1,
+
+  mouseOwner = nil,
 }
 
 
@@ -159,6 +161,16 @@
   'DrawScreen',
   'DrawInMiniMap',
   'RecvFromSynced',
+
+  -- proxied call-ins
+  'KeyPress',
+  'KeyRelease',
+  'MousePress',
+  'MouseRelease',
+  'MouseMove',
+  'MouseWheel',
+  'IsAbove',
+  'GetTooltip',
 }
 
 
@@ -404,6 +416,16 @@
     end
   end
 
+  -- for proxied call-ins
+  gh.IsMouseOwner = function (_)
+    return (self.mouseOwner == gadget)
+  end
+  gh.DisownMouse  = function (_)
+    if (self.mouseOwner == gadget) then
+      self.mouseOwner = nil
+    end
+  end
+
   return gadget
 end
 
@@ -459,7 +481,7 @@
       return unpack(r)
     else
       if (funcName ~= 'Shutdown') then
-        gadgetHandler:RemoveWidget(g)
+        gadgetHandler:RemoveGadget(g)
       else
         Spring.Echo('Error in Shutdown')
       end
@@ -472,7 +494,7 @@
 end
 
 
-local function SafeWrapWidget(gadget)
+local function SafeWrapGadget(gadget)
   if (SAFEWRAP &lt;= 0) then
     return
   elseif (SAFEWRAP == 1) then
@@ -555,7 +577,7 @@
   end
 
   ArrayRemove(self.gadgets, gadget)
-  self:RemoveWidgetGlobals(gadget)
+  self:RemoveGadgetGlobals(gadget)
   actionHandler.RemoveGadgetActions(gadget)
   for _,listname in ipairs(callInLists) do
     ArrayRemove(self[listname..'List'], gadget)
@@ -809,7 +831,7 @@
 end
 
 
-function gadgetHandler:RemoveWidgetGlobals(owner)
+function gadgetHandler:RemoveGadgetGlobals(owner)
   local count = 0
   for name, o in pairs(self.globals) do
     if (o == owner) then
@@ -1200,11 +1222,10 @@
 end
 
 
-function gadgetHandler:UnitExperience(unitID,     unitDefID,     unitTeam,
+function gadgetHandler:UnitExperience(unitID, unitDefID, unitTeam,
                                       experience, oldExperience)
   for _,g in ipairs(self.UnitExperienceList) do
-    g:UnitExperience(unitID,     unitDefID,     unitTeam,
-                    experience, oldExperience)
+    g:UnitExperience(unitID, unitDefID, unitTeam, experience, oldExperience)
   end
   return
 end
@@ -1472,6 +1493,99 @@
 --------------------------------------------------------------------------------
 --------------------------------------------------------------------------------
 
+function gadgetHandler:KeyPress(key, mods, isRepeat, label, unicode)
+  for _,g in ipairs(self.KeyPressList) do
+    if (g:KeyPress(key, mods, isRepeat, label, unicode)) then
+      return true
+    end
+  end
+  return false
+end
+
+
+function gadgetHandler:KeyRelease(key, mods, label, unicode)
+  for _,g in ipairs(self.KeyReleaseList) do
+    if (g:KeyRelease(key, mods, label, unicode)) then
+      return true
+    end
+  end
+  return false
+end
+
+
+function gadgetHandler:MousePress(x, y, button)
+  local mo = self.mouseOwner
+  if (mo) then
+    mo:MousePress(x, y, button)
+    return true  --  already have an active press
+  end
+  for _,g in ipairs(self.MousePressList) do
+    if (g:MousePress(x, y, button)) then
+      self.mouseOwner = g
+      return true
+    end
+  end
+  return false
+end
+
+
+function gadgetHandler:MouseMove(x, y, dx, dy, button)
+  local mo = self.mouseOwner
+  if (mo and mo.MouseMove) then
+    return mo:MouseMove(x, y, dx, dy, button)
+  end
+end
+
+
+function gadgetHandler:MouseRelease(x, y, button)
+  local mo = self.mouseOwner
+  local mx, my, lmb, mmb, rmb = Spring.GetMouseState()
+  if (not (lmb or mmb or rmb)) then
+    self.mouseOwner = nil
+  end
+  if (mo and mo.MouseRelease) then
+    return mo:MouseRelease(x, y, button)
+  end
+  return -1
+end
+
+
+function gadgetHandler:MouseWheel(up, value)
+  for _,g in ipairs(self.MouseWheelList) do
+    if (g:MouseWheel(up, value)) then
+      return true
+    end
+  end
+  return false
+end
+
+
+function gadgetHandler:IsAbove(x, y)
+  for _,g in ipairs(self.IsAboveList) do
+    if (g:IsAbove(x, y)) then
+      return true
+    end
+  end
+  return false
+end
+
+
+function gadgetHandler:GetTooltip(x, y)
+  for _,g in ipairs(self.GetTooltipList) do
+    if (g:IsAbove(x, y)) then
+      local tip = g:GetTooltip(x, y)
+      if (string.len(tip) &gt; 0) then
+        return tip
+      end
+    end
+  end
+  return ''
+end
+
+
+--------------------------------------------------------------------------------
+--------------------------------------------------------------------------------
+
 gadgetHandler:Initialize()
 
 --------------------------------------------------------------------------------

Modified: trunk/installer/builddata/springcontent/gamedata/resources.lua
===================================================================
--- trunk/installer/builddata/springcontent/gamedata/resources.lua	2008-05-27 22:28:07 UTC (rev 5959)
+++ trunk/installer/builddata/springcontent/gamedata/resources.lua	2008-05-27 22:41:01 UTC (rev 5960)
@@ -13,78 +13,80 @@
 
 local TDF = VFS.Include('gamedata/parse_tdf.lua')
 
-local resourcesroot, err = TDF.Parse('gamedata/resources.tdf')
+local tdfResources, err = TDF.Parse('gamedata/resources.tdf')
 
 --------------------------------------------------------------------------------
 
-
-if (resourcesroot == nil) then
-   -- load the defaults
-	resourcesroot = {
-		resources = { -- this is a bit overkill but it maintains backwards compatobility with resources.tdf
-			graphics = {
-				smoke = {
-					smoke00	=	'smoke/smoke00.tga',
-					smoke01	=	'smoke/smoke01.tga',
-					smoke02	=	'smoke/smoke02.tga',
-					smoke03	=	'smoke/smoke03.tga',
-					smoke04	=	'smoke/smoke04.tga',
-					smoke05	=	'smoke/smoke05.tga',
-					smoke06	=	'smoke/smoke06.tga',
-					smoke07	=	'smoke/smoke07.tga',
-					smoke08	=	'smoke/smoke08.tga',
-					smoke09	=	'smoke/smoke09.tga',
-					smoke10	=	'smoke/smoke10.tga',
-					smoke11	=	'smoke/smoke11.tga',
-				},
-				scars = {
-					scar1	=	'scars/scar1.bmp',
-					scar2	=	'scars/scar2.bmp',
-					scar3	=	'scars/scar3.bmp',
-					scar4	=	'scars/scar4.bmp',
-				},
-				trees = {
-					bark		=	'Bark.bmp',
-					leaf		=	'bleaf.bmp',
-					gran1		=	'gran.bmp',
-					gran2		=	'gran2.bmp',
-					birch1	=	'birch1.bmp',
-					birch2	=	'birch2.bmp',
-					birch3	=	'birch3.bmp',
-				},
-				maps = {
-					detailtex	=	'detailtex2.bmp',
-					watertex	=	'ocean.jpg',
-				},
-				groundfx = {
-					groundflash	=	'groundflash.tga',
-					groundring	=	'groundring.tga',
-					seismic			=	'circles.tga',
-				},
-				projectiletextures = {
-					circularthingy	=	'circularthingy.tga',
-					laserend				=	'laserend.tga',
-					laserfalloff		=	'laserfalloff.tga',
-					randdots				=	'randdots.tga',
-					smoketrail			=	'smoketrail.tga',
-					wake						=	'wake.tga',
-					flare						=	'flare.tga',
-					explo						=	'explo.tga',
-					explofade				=	'explofade.tga',
-					heatcloud				=	'explo.tga',
-					flame						=	'flame.tga',
-					muzzleside			=	'muzzleside.tga',
-					muzzlefront			=	'muzzlefront.tga',
-					largebeam				=	'largelaserfalloff.tga',
-				},
-			}
-		}
-	}
+if (tdfResources) then
+  return tdfResources.resources
 end
 
+
+-- default resources
+local defResources = {
+  graphics = {
+    smoke = {
+      smoke00 = 'smoke/smoke00.tga',
+      smoke01 = 'smoke/smoke01.tga',
+      smoke02 = 'smoke/smoke02.tga',
+      smoke03 = 'smoke/smoke03.tga',
+      smoke04 = 'smoke/smoke04.tga',
+      smoke05 = 'smoke/smoke05.tga',
+      smoke06 = 'smoke/smoke06.tga',
+      smoke07 = 'smoke/smoke07.tga',
+      smoke08 = 'smoke/smoke08.tga',
+      smoke09 = 'smoke/smoke09.tga',
+      smoke10 = 'smoke/smoke10.tga',
+      smoke11 = 'smoke/smoke11.tga',
+    },
+    scars = {
+      scar1 = 'scars/scar1.bmp',
+      scar2 = 'scars/scar2.bmp',
+      scar3 = 'scars/scar3.bmp',
+      scar4 = 'scars/scar4.bmp',
+    },
+    trees = {
+      bark   = 'Bark.bmp',
+      leaf   = 'bleaf.bmp',
+      gran1  = 'gran.bmp',
+      gran2  = 'gran2.bmp',
+      birch1 = 'birch1.bmp',
+      birch2 = 'birch2.bmp',
+      birch3 = 'birch3.bmp',
+    },
+    maps = {
+      detailtex = 'detailtex2.bmp',
+      watertex  = 'ocean.jpg',
+    },
+    groundfx = {
+      groundflash = 'groundflash.tga',
+      groundring  = 'groundring.tga',
+      seismic     = 'circles.tga',
+    },
+    projectiletextures = {
+      circularthingy = 'circularthingy.tga',
+      laserend       = 'laserend.tga',
+      laserfalloff   = 'laserfalloff.tga',
+      randdots       = 'randdots.tga',
+      smoketrail     = 'smoketrail.tga',
+      wake           = 'wake.tga',
+      flare          = 'flare.tga',
+      explo          = 'explo.tga',
+      explofade      = 'explofade.tga',
+      heatcloud      = 'explo.tga',
+      flame          = 'flame.tga',
+      muzzleside     = 'muzzleside.tga',
+      muzzlefront    = 'muzzlefront.tga',
+      largebeam      = 'largelaserfalloff.tga',
+    },
+  },
+}
+
+
 --------------------------------------------------------------------------------
+--------------------------------------------------------------------------------
 
-return resourcesroot
+return defResources
 
 --------------------------------------------------------------------------------
 --------------------------------------------------------------------------------

Modified: trunk/rts/Game/Camera/FreeController.cpp
===================================================================
--- trunk/rts/Game/Camera/FreeController.cpp	2008-05-27 22:28:07 UTC (rev 5959)
+++ trunk/rts/Game/Camera/FreeController.cpp	2008-05-27 22:41:01 UTC (rev 5960)
@@ -20,32 +20,40 @@
 //
 
 CFreeController::CFreeController()
-	: dir(0.0f, 0.0f, 0.0f),
-	vel(0.0f, 0.0f, 0.0f),
-	avel(0.0f, 0.0f, 0.0f),
-	prevVel(0.0f, 0.0f, 0.0f),
-	prevAvel(0.0f, 0.0f, 0.0f),
-	tracking(false),
-	trackPos(0.0f, 0.0f, 0.0f),
-	trackRadius(0.0f),
-	gndLock(false)
+: vel(0.0f, 0.0f, 0.0f),
+  avel(0.0f, 0.0f, 0.0f),
+  prevVel(0.0f, 0.0f, 0.0f),
+  prevAvel(0.0f, 0.0f, 0.0f),
+  tracking(false),
+  trackPos(0.0f, 0.0f, 0.0f),
+  trackRadius(0.0f),
+  gndLock(false)
 {
-	enabled      = !!configHandler.GetInt(&quot;CamFreeEnabled&quot;,   0);
-	invertAlt    = !!configHandler.GetInt(&quot;CamFreeInvertAlt&quot;, 0);
-	goForward    = !!configHandler.GetInt(&quot;CamFreeGoForward&quot;, 0);
-	fov          = configHandler.GetFloat(&quot;CamFreeFOV&quot;,           45.0f);
-	scrollSpeed  = configHandler.GetFloat(&quot;CamFreeScrollSpeed&quot;,  500.0f);
-	gravity      = configHandler.GetFloat(&quot;CamFreeGravity&quot;,     -500.0f);
-	slide        = configHandler.GetFloat(&quot;CamFreeSlide&quot;,          0.5f);
-	gndOffset    = configHandler.GetFloat(&quot;CamFreeGroundOffset&quot;,  16.0f);
-	tiltSpeed    = configHandler.GetFloat(&quot;CamFreeTiltSpeed&quot;,    150.0f);
-	tiltSpeed    = tiltSpeed * (PI / 180.0);
-	autoTilt     = configHandler.GetFloat(&quot;CamFreeAutoTilt&quot;,     150.0f);
-	autoTilt     = autoTilt * (PI / 180.0);
-	velTime      = configHandler.GetFloat(&quot;CamFreeVelTime&quot;,        1.5f);
-	velTime      = max(0.1f, velTime);
-	avelTime     = configHandler.GetFloat(&quot;CamFreeAngVelTime&quot;,     1.0f);
-	avelTime     = max(0.1f, avelTime);
+	dir = float3(0.0f, -2.0f, -1.0f);
+	dir.Normalize();
+	if (camera) {
+		const float hDist = sqrtf((dir.x * dir.x) + (dir.z * dir.z));
+		camera-&gt;rot.y = atan2f(dir.x, dir.z);
+		camera-&gt;rot.x = atan2f(dir.y, hDist);
+	}
+	pos -= (dir * 1000.0f);
+
+	enabled     = !!configHandler.GetInt(&quot;CamFreeEnabled&quot;,   0);
+	invertAlt   = !!configHandler.GetInt(&quot;CamFreeInvertAlt&quot;, 0);
+	goForward   = !!configHandler.GetInt(&quot;CamFreeGoForward&quot;, 0);
+	fov         = configHandler.GetFloat(&quot;CamFreeFOV&quot;,           45.0f);
+	scrollSpeed = configHandler.GetFloat(&quot;CamFreeScrollSpeed&quot;,  500.0f);
+	gravity     = configHandler.GetFloat(&quot;CamFreeGravity&quot;,     -500.0f);
+	slide       = configHandler.GetFloat(&quot;CamFreeSlide&quot;,          0.5f);
+	gndOffset   = configHandler.GetFloat(&quot;CamFreeGroundOffset&quot;,  16.0f);
+	tiltSpeed   = configHandler.GetFloat(&quot;CamFreeTiltSpeed&quot;,    150.0f);
+	tiltSpeed   = tiltSpeed * (PI / 180.0);
+	autoTilt    = configHandler.GetFloat(&quot;CamFreeAutoTilt&quot;,     150.0f);
+	autoTilt    = autoTilt * (PI / 180.0);
+	velTime     = configHandler.GetFloat(&quot;CamFreeVelTime&quot;,        1.5f);
+	velTime     = max(0.1f, velTime);
+	avelTime    = configHandler.GetFloat(&quot;CamFreeAngVelTime&quot;,     1.0f);
+	avelTime    = max(0.1f, avelTime);
 }
 
 

Modified: trunk/rts/Game/CameraHandler.cpp
===================================================================
--- trunk/rts/Game/CameraHandler.cpp	2008-05-27 22:28:07 UTC (rev 5959)
+++ trunk/rts/Game/CameraHandler.cpp	2008-05-27 22:41:01 UTC (rev 5960)
@@ -1,3 +1,6 @@
+
+#include &quot;StdAfx.h&quot;
+
 #include &quot;CameraHandler.h&quot;
 
 #include &quot;Game/Action.h&quot;
@@ -33,8 +36,19 @@
 	camCtrls.push_back(new SmoothController());       // 5
 	camCtrls.push_back(new COverviewController());    // 6
 
-	const unsigned int mode = std::min(configHandler.GetInt(&quot;CamMode&quot;, 1),
-	                                   (int)camControllers.size() - 1);
+	for (unsigned int i = 0; i &lt; camCtrls.size(); i++) {
+		nameMap[camCtrls[i]-&gt;GetName()] = i;
+	}
+
+	int modeIndex;
+	const std::string modeName = configHandler.GetString(&quot;CamModeName&quot;, &quot;&quot;);
+	if (!modeName.empty()) {
+		modeIndex = GetModeIndex(modeName);
+	} else {
+		modeIndex = configHandler.GetInt(&quot;CamMode&quot;, 1);
+	}
+	const unsigned int mode =
+		(unsigned int)std::max(0, std::min(modeIndex, (int)camCtrls.size() - 1));
 	currCamCtrlNum = mode;
 	currCamCtrl = camControllers[currCamCtrlNum];
 
@@ -102,9 +116,9 @@
 }
 
 
-void CCameraHandler::SetCameraMode(unsigned mode)
+void CCameraHandler::SetCameraMode(unsigned int mode)
 {
-	if ((mode &gt;= camControllers.size()) || (mode == static_cast&lt;unsigned&gt;(currCamCtrlNum))) {
+	if ((mode &gt;= camControllers.size()) || (mode == static_cast&lt;unsigned int&gt;(currCamCtrlNum))) {
 		return;
 	}
 
@@ -119,6 +133,26 @@
 }
 
 
+void CCameraHandler::SetCameraMode(const std::string&amp; modeName)
+{
+	const int modeNum = GetModeIndex(modeName);
+	if (modeNum &gt;= 0) {
+		SetCameraMode(modeNum);
+	}
+	// do nothing if the name is not matched
+}
+
+
+int CCameraHandler::GetModeIndex(const std::string&amp; name) const
+{
+	std::map&lt;std::string, unsigned int&gt;::const_iterator it = nameMap.find(name);
+	if (it != nameMap.end()) {
+		return it-&gt;second;
+	}
+	return -1;
+}
+
+
 void CCameraHandler::PushMode()
 {
 	controllerStack.push(GetCurrentControllerNum());
@@ -170,7 +204,7 @@
 
 void CCameraHandler::ToggleOverviewCamera()
 {
-	const unsigned ovCamNum = camControllers.size() - 1;
+	const unsigned int ovCamNum = camControllers.size() - 1;
 	if (controllerStack.empty()) {
 		PushMode();
 		SetCameraMode(ovCamNum);

Modified: trunk/rts/Game/CameraHandler.h
===================================================================
--- trunk/rts/Game/CameraHandler.h	2008-05-27 22:28:07 UTC (rev 5959)
+++ trunk/rts/Game/CameraHandler.h	2008-05-27 22:41:01 UTC (rev 5960)
@@ -20,16 +20,19 @@
 	~CCameraHandler();
 	
 	void UpdateCam();
-	void SetCameraMode(unsigned mode);
+	void SetCameraMode(unsigned int mode);
+	void SetCameraMode(const std::string&amp; mode);
 	void PushMode();
 	void PopMode();
 	void CameraTransition(float time);
-	
+
 	void ToggleState();
 	void ToggleOverviewCamera();
 	
 	void SaveView(const std::string&amp; name);
 	bool LoadView(const std::string&amp; name);
+
+	int GetModeIndex(const std::string&amp; modeName) const;
 	
 	/**
 	@brief write current camera settings in a vector
@@ -52,9 +55,9 @@
 	
 private:
 	std::vector&lt;CCameraController*&gt; camControllers;
-	std::stack&lt;unsigned&gt; controllerStack;
+	std::stack&lt;unsigned int&gt; controllerStack;
 	CCameraController* currCamCtrl;
-	unsigned currCamCtrlNum;
+	unsigned int currCamCtrlNum;
 	
 	float cameraTime;
 	float cameraTimeLeft;
@@ -63,6 +66,7 @@
 	
 	bool LoadViewData(const ViewData&amp; vd);
 	std::map&lt;std::string, ViewData&gt; views;
+	std::map&lt;std::string, unsigned int&gt; nameMap;
 };
 
 extern CCameraHandler* camHandler;

Modified: trunk/rts/Game/StartScripts/CommanderScript2.cpp
===================================================================
--- trunk/rts/Game/StartScripts/CommanderScript2.cpp	2008-05-27 22:28:07 UTC (rev 5959)
+++ trunk/rts/Game/StartScripts/CommanderScript2.cpp	2008-05-27 22:41:01 UTC (rev 5960)
@@ -12,15 +12,18 @@
 
 extern std::string stupidGlobalMapname;
 
+
 CCommanderScript2::CCommanderScript2()
 : CScript(std::string(&quot;Cmds 1000 res&quot;))
 {
 }
 
+
 CCommanderScript2::~CCommanderScript2(void)
 {
 }
 
+
 void CCommanderScript2::Update(void)
 {
 	switch(gs-&gt;frameNum){

Modified: trunk/rts/Game/Team.cpp
===================================================================
--- trunk/rts/Game/Team.cpp	2008-05-27 22:28:07 UTC (rev 5959)
+++ trunk/rts/Game/Team.cpp	2008-05-27 22:41:01 UTC (rev 5960)
@@ -103,36 +103,36 @@
 //////////////////////////////////////////////////////////////////////
 
 CTeam::CTeam()
-: 	gaia(false),
-	metal(200000),
-	energy(900000),
-	metalPull(0),     prevMetalPull(0),
-	metalIncome(0),   prevMetalIncome(0),
-	metalExpense(0),  prevMetalExpense(0),
-	metalUpkeep(0),   prevMetalUpkeep(0),
-	energyPull(0),    prevEnergyPull(0),
-	energyIncome(0),  prevEnergyIncome(0),
-	energyExpense(0), prevEnergyExpense(0),
-	energyUpkeep(0),  prevEnergyUpkeep(0),
-	metalStorage(1000000),
-	energyStorage(1000000),
-	metalShare(0.99f),
-	energyShare(0.95f),
-	delayedMetalShare(0),
-	delayedEnergyShare(0),
-	metalSent(0),
-	metalReceived(0),
-	energySent(0),
-	energyReceived(0),
-	side(&quot;arm&quot;),
-	luaAI(&quot;&quot;),
-	startPos(100,100,100),
-	handicap(1),
-	leader(-1),
-	lineageRoot(-1),
-	isDead(false),
-	lastStatSave(0),
-	numCommanders(0)
+: gaia(false),
+  metal(200000),
+  energy(900000),
+  metalPull(0),     prevMetalPull(0),
+  metalIncome(0),   prevMetalIncome(0),
+  metalExpense(0),  prevMetalExpense(0),
+  metalUpkeep(0),   prevMetalUpkeep(0),
+  energyPull(0),    prevEnergyPull(0),
+  energyIncome(0),  prevEnergyIncome(0),
+  energyExpense(0), prevEnergyExpense(0),
+  energyUpkeep(0),  prevEnergyUpkeep(0),
+  metalStorage(1000000),
+  energyStorage(1000000),
+  metalShare(0.99f),
+  energyShare(0.95f),
+  delayedMetalShare(0),
+  delayedEnergyShare(0),
+  metalSent(0),
+  metalReceived(0),
+  energySent(0),
+  energyReceived(0),
+  side(&quot;arm&quot;),
+  luaAI(&quot;&quot;),
+  startPos(100,100,100),
+  handicap(1),
+  leader(-1),
+  lineageRoot(-1),
+  isDead(false),
+  lastStatSave(0),
+  numCommanders(0)
 {
 	memset(&amp;currentStats,0,sizeof(currentStats));
 	statHistory.push_back(currentStats);

Modified: trunk/rts/Game/UI/GameSetupDrawer.cpp
===================================================================
--- trunk/rts/Game/UI/GameSetupDrawer.cpp	2008-05-27 22:28:07 UTC (rev 5959)
+++ trunk/rts/Game/UI/GameSetupDrawer.cpp	2008-05-27 22:41:01 UTC (rev 5960)
@@ -32,8 +32,7 @@
 
 void GameSetupDrawer::Disable()
 {
-	if (instance)
-	{
+	if (instance) {
 		delete instance;
 		instance = 0;
 	}
@@ -41,12 +40,16 @@
 
 void GameSetupDrawer::StartCountdown(unsigned time)
 {
-	if (instance)
-	{
+	if (instance) {
 		instance-&gt;lastTick = SDL_GetTicks();
 		instance-&gt;readyCountdown = (int)time;
-		int mode = configHandler.GetInt(&quot;CamMode&quot;, 1);
-		camHandler-&gt;SetCameraMode(mode);
+		const std::string modeName = configHandler.GetString(&quot;CamModeName&quot;, &quot;&quot;);
+		if (!modeName.empty()) {
+			camHandler-&gt;SetCameraMode(modeName);
+		} else {
+			const int modeIndex = configHandler.GetInt(&quot;CamMode&quot;, 1);
+			camHandler-&gt;SetCameraMode(modeIndex);
+		}
 	}
 }
 
@@ -68,13 +71,11 @@
 
 void GameSetupDrawer::Draw()
 {
-	if (readyCountdown &gt; 0)
-	{
+	if (readyCountdown &gt; 0) {
 		readyCountdown -= (SDL_GetTicks() - lastTick);
 		lastTick = SDL_GetTicks();
 	}
-	else if (readyCountdown &lt; 0)
-	{
+	else if (readyCountdown &lt; 0) {
 		GameSetupDrawer::Disable();
 	}
 
@@ -155,8 +156,7 @@
 
 bool GameSetupDrawer::KeyPressed(unsigned short key, bool isRepeat)
 {
-	if (keys[SDLK_LCTRL] &amp;&amp; (key == SDLK_RETURN))
-	{
+	if (keys[SDLK_LCTRL] &amp;&amp; (key == SDLK_RETURN)) {
 		// tell the server to force-start the game
 		net-&gt;SendStartPlaying(0);
 	}

Modified: trunk/rts/Game/UI/KeyAutoBinder.cpp
===================================================================
--- trunk/rts/Game/UI/KeyAutoBinder.cpp	2008-05-27 22:28:07 UTC (rev 5959)
+++ trunk/rts/Game/UI/KeyAutoBinder.cpp	2008-05-27 22:41:01 UTC (rev 5960)
@@ -206,8 +206,8 @@
 
 	vector&lt;UnitDefHolder&gt; defs;
 
-	const std::map &lt;std::string, int&gt;&amp; udMap = unitDefHandler-&gt;unitID;
-	std::map&lt; std::string, int&gt;::const_iterator udIt;
+	const std::map&lt;std::string, int&gt;&amp; udMap = unitDefHandler-&gt;unitID;
+	std::map&lt;std::string, int&gt;::const_iterator udIt;
 	for (udIt = udMap.begin(); udIt != udMap.end(); udIt++) {
 	  const UnitDef* ud = unitDefHandler-&gt;GetUnitByID(udIt-&gt;second);
 		if (ud == NULL) {

Modified: trunk/rts/Game/UI/LuaUI.cpp
===================================================================
--- trunk/rts/Game/UI/LuaUI.cpp	2008-05-27 22:28:07 UTC (rev 5959)
+++ trunk/rts/Game/UI/LuaUI.cpp	2008-05-27 22:41:01 UTC (rev 5960)
@@ -2333,8 +2333,8 @@
 			}
 		}
 	}
-	FontTexture::Execute();
-	return 0;
+	lua_pushboolean(L, FontTexture::Execute());
+	return 1;
 }
 
 

Modified: trunk/rts/Lua/LuaFeatureDefs.cpp
===================================================================
--- trunk/rts/Lua/LuaFeatureDefs.cpp	2008-05-27 22:28:07 UTC (rev 5959)
+++ trunk/rts/Lua/LuaFeatureDefs.cpp	2008-05-27 22:41:01 UTC (rev 5960)
@@ -59,9 +59,9 @@
 	  InitParamMap();
 	}
 
-	const std::map&lt;std::string, const FeatureDef*&gt;&amp; featureDefs =
+	const map&lt;string, const FeatureDef*&gt;&amp; featureDefs =
 		featureHandler-&gt;GetFeatureDefs();
-	std::map&lt;std::string, const FeatureDef*&gt;::const_iterator fdIt;
+	map&lt;string, const FeatureDef*&gt;::const_iterator fdIt;
 	for (fdIt = featureDefs.begin(); fdIt != featureDefs.end(); fdIt++) {
 	  const FeatureDef* fd = fdIt-&gt;second;
 		if (fd == NULL) {
@@ -106,7 +106,7 @@
 }
 
 
-bool LuaFeatureDefs::IsDefaultParam(const std::string&amp; word)
+bool LuaFeatureDefs::IsDefaultParam(const string&amp; word)
 {
 	if (paramMap.empty()) {
 	  InitParamMap();

Modified: trunk/rts/Lua/LuaParser.cpp
===================================================================
--- trunk/rts/Lua/LuaParser.cpp	2008-05-27 22:28:07 UTC (rev 5959)
+++ trunk/rts/Lua/LuaParser.cpp	2008-05-27 22:41:01 UTC (rev 5960)
@@ -31,6 +31,9 @@
 #endif
 
 
+static const bool lowerKeys = true;
+
+
 /******************************************************************************/
 /******************************************************************************/
 
@@ -716,7 +719,8 @@
 
 LuaTable LuaTable::SubTable(const string&amp; mixedKey) const
 {
-	const string key = StringToLower(mixedKey);
+	
+	const string key = !lowerKeys ? mixedKey : StringToLower(mixedKey);
 
 	LuaTable subTable;
 	subTable.path = path + &quot;.&quot; + key;
@@ -810,7 +814,7 @@
 
 bool LuaTable::PushValue(const string&amp; mixedKey) const
 {
-	const string key = StringToLower(mixedKey);
+	const string key = !lowerKeys ? mixedKey : StringToLower(mixedKey);
 	if (!PushTable()) {
 		return false;
 	}

Modified: trunk/rts/Lua/LuaParser.h
===================================================================
--- trunk/rts/Lua/LuaParser.h	2008-05-27 22:28:07 UTC (rev 5959)
+++ trunk/rts/Lua/LuaParser.h	2008-05-27 22:41:01 UTC (rev 5960)
@@ -67,6 +67,21 @@
 		float3 GetFloat3(const string&amp; key, const float3&amp; def) const;
 		string GetString(const string&amp; key, const string&amp; def) const;
 
+		/* not having these makes for better code, imo
+		LuaTable operator[](int key)           const { return SubTable(key); }
+		LuaTable operator[](const string&amp; key) const { return SubTable(key); }
+		int    operator()(int key, int def)           const { return GetInt(key, def);    }
+		bool   operator()(int key, bool def)          const { return GetBool(key, def);   }
+		float  operator()(int key, float def)         const { return GetFloat(key, def);  }
+		float3 operator()(int key, const float3&amp; def) const { return GetFloat3(key, def); }
+		string operator()(int key, const string&amp; def) const { return GetString(key, def); }
+		int    operator()(const string&amp; key, int def)           const { return GetInt(key, def);    }
+		bool   operator()(const string&amp; key, bool def)          const { return GetBool(key, def);   }
+		float  operator()(const string&amp; key, float def)         const { return GetFloat(key, def);  }
+		float3 operator()(const string&amp; key, const float3&amp; def) const { return GetFloat3(key, def); }
+		string operator()(const string&amp; key, const string&amp; def) const { return GetString(key, def); }
+		*/
+
 	private:
 		LuaTable(LuaParser* parser); // for LuaParser::GetRoot()
 

Modified: trunk/rts/Lua/LuaUnitDefs.cpp
===================================================================
--- trunk/rts/Lua/LuaUnitDefs.cpp	2008-05-27 22:28:07 UTC (rev 5959)
+++ trunk/rts/Lua/LuaUnitDefs.cpp	2008-05-27 22:41:01 UTC (rev 5960)
@@ -88,8 +88,8 @@
 	  InitParamMap();
 	}
 
-	const std::map &lt;std::string, int&gt;&amp; udMap = unitDefHandler-&gt;unitID;
-	std::map&lt; std::string, int&gt;::const_iterator udIt;
+	const map&lt;string, int&gt;&amp; udMap = unitDefHandler-&gt;unitID;
+	map&lt;string, int&gt;::const_iterator udIt;
 	for (udIt = udMap.begin(); udIt != udMap.end(); udIt++) {
 	  const UnitDef* ud = unitDefHandler-&gt;GetUnitByID(udIt-&gt;second);
 		if (ud == NULL) {
@@ -134,7 +134,7 @@
 }
 
 
-bool LuaUnitDefs::IsDefaultParam(const std::string&amp; word)
+bool LuaUnitDefs::IsDefaultParam(const string&amp; word)
 {
 	if (paramMap.empty()) {
 	  InitParamMap();
@@ -484,7 +484,7 @@
 	HSTR_PUSH_STRING(L, &quot;name&quot;, md.modelname);
 	HSTR_PUSH(L, &quot;textures&quot;);
 	lua_newtable(L);
-	std::map&lt;std::string, std::string&gt;::const_iterator it;
+	map&lt;string, string&gt;::const_iterator it;
 	for (it = md.textures.begin(); it != md.textures.end(); ++it) {
 		LuaPushNamedString(L, it-&gt;first, it-&gt;second);
 	}
@@ -909,7 +909,7 @@
 	ADD_FLOAT(&quot;nanoColorG&quot;,   ud.nanoColor.y);
 	ADD_FLOAT(&quot;nanoColorB&quot;,   ud.nanoColor.z);
 
-//	std::vector&lt;CExplosionGenerator*&gt;  sfxExplGens;
+//	vector&lt;CExplosionGenerator*&gt;  sfxExplGens;
 	ADD_STRING(&quot;pieceTrailCEGTag&quot;,   ud.pieceTrailCEGTag);
 	ADD_INT(   &quot;pieceTrailCEGRange&quot;, ud.pieceTrailCEGRange);
 

Modified: trunk/rts/Lua/LuaUtils.cpp
===================================================================
--- trunk/rts/Lua/LuaUtils.cpp	2008-05-27 22:28:07 UTC (rev 5959)
+++ trunk/rts/Lua/LuaUtils.cpp	2008-05-27 22:41:01 UTC (rev 5960)
@@ -34,22 +34,31 @@
 
 static bool CopyPushData(lua_State* dst, lua_State* src, int index)
 {
-	if (lua_isboolean(src, index)) {
-		lua_pushboolean(dst, lua_toboolean(src, index));
+	const int type = lua_type(src, index);
+	switch (type) {
+		case LUA_TBOOLEAN: {
+			lua_pushboolean(dst, lua_toboolean(src, index));
+			break;
+		}
+		case LUA_TNUMBER: {
+			lua_pushnumber(dst, lua_tonumber(src, index));
+			break;
+		}
+		case LUA_TSTRING: {
+			size_t len;
+			const char* data = lua_tolstring(src, index, &amp;len);
+			lua_pushlstring(dst, data, len);
+			break;
+		}
+		case LUA_TTABLE: {
+			CopyPushTable(dst, src, index);
+			break;
+		}
+		default: {
+			lua_pushnil(dst); // unhandled type
+			return false;
+		}
 	}
-	else if (lua_israwnumber(src, index)) {
-		lua_pushnumber(dst, lua_tonumber(src, index));
-	}
-	else if (lua_israwstring(src, index)) {
-		lua_pushstring(dst, lua_tostring(src, index));
-	}
-	else if (lua_istable(src, index)) {
-		CopyPushTable(dst, src, index);
-	}
-	else {
-		lua_pushnil(dst); // unhandled type
-		return false;
-	}
 	return true;
 }
 

Modified: trunk/rts/Lua/LuaWeaponDefs.cpp
===================================================================
--- trunk/rts/Lua/LuaWeaponDefs.cpp	2008-05-27 22:28:07 UTC (rev 5959)
+++ trunk/rts/Lua/LuaWeaponDefs.cpp	2008-05-27 22:41:01 UTC (rev 5960)
@@ -63,8 +63,8 @@
 	  InitParamMap();
 	}
 
-	const std::map&lt;std::string, int&gt;&amp; weaponMap = weaponDefHandler-&gt;weaponID;
-	std::map&lt;std::string, int&gt;::const_iterator wit;
+	const map&lt;string, int&gt;&amp; weaponMap = weaponDefHandler-&gt;weaponID;
+	map&lt;string, int&gt;::const_iterator wit;
 	for (wit = weaponMap.begin(); wit != weaponMap.end(); wit++) {
 		const WeaponDef* wd = &amp;weaponDefHandler-&gt;weaponDefs[wit-&gt;second];
 		if (wd == NULL) {

Modified: trunk/rts/Map/MapInfo.cpp
===================================================================
--- trunk/rts/Map/MapInfo.cpp	2008-05-27 22:28:07 UTC (rev 5959)
+++ trunk/rts/Map/MapInfo.cpp	2008-05-27 22:41:01 UTC (rev 5960)
@@ -208,7 +208,7 @@
 	// SMF specific settings
 	mapDefParser-&gt;GetDef(smf.detailTexName, &quot;&quot;, &quot;MAP\\DetailTex&quot;);
 
-	const LuaTable mapsTable = resourcesParser-&gt;GetRoot().SubTable(&quot;resources&quot;).SubTable(&quot;graphics&quot;).SubTable(&quot;maps&quot;);
+	const LuaTable mapsTable = resourcesParser-&gt;GetRoot().SubTable(&quot;graphics&quot;).SubTable(&quot;maps&quot;);
 	
 	if (smf.detailTexName.empty())
 		smf.detailTexName = &quot;bitmaps/&quot; + mapsTable.GetString(&quot;detailtex&quot;,&quot;detailtex2.bmp&quot;);

Modified: trunk/rts/Rendering/Env/AdvTreeGenerator.cpp
===================================================================
--- trunk/rts/Rendering/Env/AdvTreeGenerator.cpp	2008-05-27 22:28:07 UTC (rev 5959)
+++ trunk/rts/Rendering/Env/AdvTreeGenerator.cpp	2008-05-27 22:41:01 UTC (rev 5960)
@@ -35,10 +35,11 @@
 	memset(tree[0][0],128,256*2048*4);
 
 	LuaParser resourcesParser(&quot;gamedata/resources.lua&quot;, SPRING_VFS_MOD_BASE, SPRING_VFS_ZIP);
-	if (!resourcesParser.Execute() || !resourcesParser.IsValid())
+	if (!resourcesParser.Execute()) {
 		logOutput.Print(resourcesParser.GetErrorLog());
+	}
 
-	const LuaTable treesTable = resourcesParser.GetRoot().SubTable(&quot;resources&quot;).SubTable(&quot;graphics&quot;).SubTable(&quot;trees&quot;);
+	const LuaTable treesTable = resourcesParser.GetRoot().SubTable(&quot;graphics&quot;).SubTable(&quot;trees&quot;);
 
 	CBitmap bm;
 	std::string fn(&quot;bitmaps/&quot;+treesTable.GetString(&quot;bark&quot;, &quot;Bark.bmp&quot;));

Modified: trunk/rts/Rendering/Env/BasicTreeDrawer.cpp
===================================================================
--- trunk/rts/Rendering/Env/BasicTreeDrawer.cpp	2008-05-27 22:28:07 UTC (rev 5959)
+++ trunk/rts/Rendering/Env/BasicTreeDrawer.cpp	2008-05-27 22:41:01 UTC (rev 5960)
@@ -24,10 +24,11 @@
 	lastListClean=0;
 
 	LuaParser resourcesParser(&quot;gamedata/resources.lua&quot;, SPRING_VFS_MOD_BASE, SPRING_VFS_ZIP);
-	if (!resourcesParser.Execute() || !resourcesParser.IsValid())
+	if (!resourcesParser.Execute()) {
 		logOutput.Print(resourcesParser.GetErrorLog());
+	}
 	
-	const LuaTable treesTable = resourcesParser.GetRoot().SubTable(&quot;resources&quot;).SubTable(&quot;graphics&quot;).SubTable(&quot;trees&quot;);
+	const LuaTable treesTable = resourcesParser.GetRoot().SubTable(&quot;graphics&quot;).SubTable(&quot;trees&quot;);
 		
 	CBitmap TexImage;
 	std::string fn(&quot;bitmaps/&quot;+treesTable.GetString(&quot;gran1&quot;, &quot;gran.bmp&quot;));

Modified: trunk/rts/Rendering/FontTexture.cpp
===================================================================
--- trunk/rts/Rendering/FontTexture.cpp	2008-05-27 22:28:07 UTC (rev 5959)
+++ trunk/rts/Rendering/FontTexture.cpp	2008-05-27 22:41:01 UTC (rev 5960)
@@ -233,7 +233,7 @@
 	error = FT_Init_FreeType(&amp;library);
 	if (error) {
 		logOutput.Print(&quot;freetype library init failed: %i\n&quot;, error);
-		return 1;
+		return false;
 	}
 
 	if (inputData.empty()) {
@@ -247,12 +247,12 @@
 	if (error == FT_Err_Unknown_File_Format) {
 		logOutput.Print(&quot;bad font file type\n&quot;);
 		FT_Done_FreeType(library);
-		return 1;
+		return false;
 	}
 	else if (error) {
 		logOutput.Print(&quot;unknown font file error: %i\n&quot;, error);
 		FT_Done_FreeType(library);
-		return 1;
+		return false;
 	}
 
 	if (face-&gt;num_fixed_sizes &lt;= 0) {
@@ -261,7 +261,7 @@
 			logOutput.Print(&quot;FT_Set_Pixel_Sizes() error: %i\n&quot;, error);
 			FT_Done_Face(face);
 			FT_Done_FreeType(library);
-			return 1;
+			return false;
 		}
 	} else {
 		height = face-&gt;available_sizes[0].height;

Modified: trunk/rts/Rendering/GL/myGL.cpp
===================================================================
--- trunk/rts/Rendering/GL/myGL.cpp	2008-05-27 22:28:07 UTC (rev 5959)
+++ trunk/rts/Rendering/GL/myGL.cpp	2008-05-27 22:41:01 UTC (rev 5960)
@@ -131,7 +131,7 @@
 	}else if (GLEW_VERSION_1_4) {
 		// This required GL-1.4
 		// instead of using glu, we rely on glTexImage2D to create the Mipmaps.
-		glTexParameteri(GL_TEXTURE_2D,GL_GENERATE_MIPMAP,true);
+		glTexParameteri(GL_TEXTURE_2D, GL_GENERATE_MIPMAP, GL_TRUE);
 		glTexImage2D(target, 0, internalFormat, width, height, 0, format, type, data);
 	} else
 		gluBuild2DMipmaps(target, internalFormat, width, height, format, type, data);

Modified: trunk/rts/Rendering/GroundDecalHandler.cpp
===================================================================
--- trunk/rts/Rendering/GroundDecalHandler.cpp	2008-05-27 22:28:07 UTC (rev 5959)
+++ trunk/rts/Rendering/GroundDecalHandler.cpp	2008-05-27 22:41:01 UTC (rev 5960)
@@ -41,11 +41,13 @@
 	unsigned char* buf=SAFE_NEW unsigned char[512*512*4];
 	memset(buf,0,512*512*4);
 
-	LuaParser resourcesParser(&quot;gamedata/resources.lua&quot;, SPRING_VFS_MOD_BASE, SPRING_VFS_ZIP);
-	if (!resourcesParser.Execute() || !resourcesParser.IsValid())
+	LuaParser resourcesParser(&quot;gamedata/resources.lua&quot;,
+	                          SPRING_VFS_MOD_BASE, SPRING_VFS_ZIP);
+	if (!resourcesParser.Execute()) {
 		logOutput.Print(resourcesParser.GetErrorLog());
+	}
 	
-	const LuaTable scarsTable = resourcesParser.GetRoot().SubTable(&quot;resources&quot;).SubTable(&quot;graphics&quot;).SubTable(&quot;scars&quot;);
+	const LuaTable scarsTable = resourcesParser.GetRoot().SubTable(&quot;graphics&quot;).SubTable(&quot;scars&quot;);
 	LoadScar(&quot;bitmaps/&quot; + scarsTable.GetString(&quot;scar2&quot;, &quot;scars/scar2.bmp&quot;), buf, 0,   0);
 	LoadScar(&quot;bitmaps/&quot; + scarsTable.GetString(&quot;scar3&quot;, &quot;scars/scar3.bmp&quot;), buf, 256, 0);
 	LoadScar(&quot;bitmaps/&quot; + scarsTable.GetString(&quot;scar1&quot;, &quot;scars/scar1.bmp&quot;), buf, 0,   256);

Modified: trunk/rts/Rendering/Textures/NamedTextures.cpp
===================================================================
--- trunk/rts/Rendering/Textures/NamedTextures.cpp	2008-05-27 22:28:07 UTC (rev 5959)
+++ trunk/rts/Rendering/Textures/NamedTextures.cpp	2008-05-27 22:41:01 UTC (rev 5960)
@@ -149,6 +149,8 @@
 			glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR_MIPMAP_LINEAR);
 		}
 
+//		glBuildMipmaps(GL_TEXTURE_2D, GL_RGBA8, bitmap.xsize, bitmap.ysize,
+//									 GL_RGBA, GL_UNSIGNED_BYTE, bitmap.mem);
 		gluBuild2DMipmaps(GL_TEXTURE_2D, GL_RGBA8, bitmap.xsize, bitmap.ysize,
 		                  GL_RGBA, GL_UNSIGNED_BYTE, bitmap.mem);
 	}

Modified: trunk/rts/Sim/Projectiles/ProjectileHandler.cpp
===================================================================
--- trunk/rts/Sim/Projectiles/ProjectileHandler.cpp	2008-05-27 22:28:07 UTC (rev 5959)
+++ trunk/rts/Sim/Projectiles/ProjectileHandler.cpp	2008-05-27 22:41:01 UTC (rev 5960)
@@ -69,10 +69,13 @@
 	// used to block resources_map.tdf from loading textures
 	std::set&lt;std::string&gt; blockMapTexNames;
 
-	LuaParser resourcesParser(&quot;gamedata/resources.lua&quot;, SPRING_VFS_MOD_BASE, SPRING_VFS_ZIP);
-	if (!resourcesParser.Execute() || !resourcesParser.IsValid())
+	LuaParser resourcesParser(&quot;gamedata/resources.lua&quot;,
+	                          SPRING_VFS_MOD_BASE, SPRING_VFS_ZIP);
+	if (!resourcesParser.Execute()) {
 		logOutput.Print(resourcesParser.GetErrorLog());
-	const LuaTable ptTable = resourcesParser.GetRoot().SubTable(&quot;resources&quot;).SubTable(&quot;graphics&quot;).SubTable(&quot;projectiletextures&quot;);
+	}
+	const LuaTable rootTable = resourcesParser.GetRoot();
+	const LuaTable ptTable = rootTable.SubTable(&quot;graphics&quot;).SubTable(&quot;projectileTextures&quot;);
 	//add all textures in projectiletextures section
 	std::map&lt;std::string, std::string&gt; ptex;
 	ptTable.GetMap(ptex);
@@ -80,7 +83,7 @@
 	for(std::map&lt;std::string,std::string&gt;::iterator pi=ptex.begin(); pi!=ptex.end(); ++pi)
 	{
 		textureAtlas-&gt;AddTexFromFile(pi-&gt;first, &quot;bitmaps/&quot; + pi-&gt;second);
-		blockMapTexNames.insert(pi-&gt;first);
+		blockMapTexNames.insert(StringToLower(pi-&gt;first));
 	}
 	//add all texture from sections within projectiletextures section
 	std::vector&lt;std::string&gt; seclist; 
@@ -94,17 +97,17 @@
 			for(std::map&lt;std::string,std::string&gt;::iterator pi=ptex2.begin(); pi!=ptex2.end(); ++pi)
 			{
 				textureAtlas-&gt;AddTexFromFile(pi-&gt;first, &quot;bitmaps/&quot; + pi-&gt;second);
-				blockMapTexNames.insert(pi-&gt;first);
+				blockMapTexNames.insert(StringToLower(pi-&gt;first));
 			}
 		}
 	}
 
-	const LuaTable smokeTable = resourcesParser.GetRoot().SubTable(&quot;resources&quot;).SubTable(&quot;smoke&quot;);
+	const LuaTable smokeTable = rootTable.SubTable(&quot;smoke&quot;);
 	for (int i = 0; i &lt; 12; i++) {
 		char num[10];
 		sprintf(num, &quot;%02i&quot;, i);
 		textureAtlas-&gt;AddTexFromFile(std::string(&quot;ismoke&quot;) + num, std::string(&quot;bitmaps/&quot;)+smokeTable.GetString(std::string(&quot;smoke&quot;)+num, std::string(&quot;smoke/smoke&quot;) + num +&quot;.tga&quot;));
-		blockMapTexNames.insert(std::string(&quot;ismoke&quot;) + num);
+		blockMapTexNames.insert(StringToLower(std::string(&quot;ismoke&quot;) + num));
 	}
 
 	char tex[128][128][4];
@@ -151,16 +154,19 @@
 	blockMapTexNames.insert(&quot;plasmatexture&quot;);
 
 	// allow map specified atlas textures for gaia unit projectiles
-	LuaParser resources_mapParser(&quot;gamedata/resources_map.lua&quot;, SPRING_VFS_MOD_BASE, SPRING_VFS_ZIP);
-	if (resources_mapParser.IsValid()) {
-		const LuaTable mapTable = resources_mapParser.GetRoot().SubTable(&quot;resources&quot;).SubTable(&quot;graphics&quot;).SubTable(&quot;projectiletextures&quot;);
+	LuaParser mapResParser(&quot;gamedata/resources_map.lua&quot;,
+	                              SPRING_VFS_MOD_BASE, SPRING_VFS_ZIP);
+	if (mapResParser.IsValid()) {
+		const LuaTable mapRoot = mapResParser.GetRoot();
+		const LuaTable mapTable = mapRoot.SubTable(&quot;projectileTextures&quot;);
 		//add all textures in projectiletextures section 
 		std::map&lt;std::string,std::string&gt; mptex;
 		mapTable.GetMap(mptex);
 		std::map&lt;std::string,std::string&gt;::iterator pi;
 		for (pi = mptex.begin(); pi != mptex.end(); ++pi) {
-			if (blockMapTexNames.find(pi-&gt;first) == blockMapTexNames.end())
+			if (blockMapTexNames.find(StringToLower(pi-&gt;first)) == blockMapTexNames.end()) {
 				textureAtlas-&gt;AddTexFromFile(pi-&gt;first, &quot;bitmaps/&quot; + pi-&gt;second);
+			}
 		}
 		//add all texture from sections within projectiletextures section
 		mapTable.GetKeys(seclist);
@@ -172,8 +178,9 @@
 				mapSubTable.GetMap(ptex2);
 				for(std::map&lt;std::string,std::string&gt;::iterator pi=ptex2.begin(); pi!=ptex2.end(); ++pi)
 				{
-					if (blockMapTexNames.find(pi-&gt;first) == blockMapTexNames.end())
+					if (blockMapTexNames.find(StringToLower(pi-&gt;first)) == blockMapTexNames.end()) {
 						textureAtlas-&gt;AddTexFromFile(pi-&gt;first, &quot;bitmaps/&quot; + pi-&gt;second);
+					}
 				}
 			}
 		}
@@ -201,24 +208,26 @@
 		smoketex[i] = textureAtlas-&gt;GetTexture(std::string(&quot;ismoke&quot;) + num);
 	}
 
-	sbtrailtex        = textureAtlas-&gt;GetTextureWithBackup(&quot;sbtrailtexture&quot;,         &quot;smoketrail&quot;    );
-	missiletrailtex   = textureAtlas-&gt;GetTextureWithBackup(&quot;missiletrailtexture&quot;,    &quot;smoketrail&quot;    );
-	muzzleflametex    = textureAtlas-&gt;GetTextureWithBackup(&quot;muzzleflametexture&quot;,     &quot;explo&quot;         );
-	repulsetex        = textureAtlas-&gt;GetTextureWithBackup(&quot;repulsetexture&quot;,         &quot;explo&quot;         );
-	dguntex           = textureAtlas-&gt;GetTextureWithBackup(&quot;dguntexture&quot;,            &quot;flare&quot;         );
-	flareprojectiletex= textureAtlas-&gt;GetTextureWithBackup(&quot;flareprojectiletexture&quot;, &quot;flare&quot;         );
-	sbflaretex        = textureAtlas-&gt;GetTextureWithBackup(&quot;sbflaretexture&quot;,         &quot;flare&quot;         );
-	missileflaretex   = textureAtlas-&gt;GetTextureWithBackup(&quot;missileflaretexture&quot;,    &quot;flare&quot;         );
-	beamlaserflaretex = textureAtlas-&gt;GetTextureWithBackup(&quot;beamlaserflaretexture&quot;,  &quot;flare&quot;         );
-	bubbletex         = textureAtlas-&gt;GetTextureWithBackup(&quot;bubbletexture&quot;,          &quot;circularthingy&quot;);
-	geosquaretex      = textureAtlas-&gt;GetTextureWithBackup(&quot;geosquaretexture&quot;,       &quot;circularthingy&quot;);
-	gfxtex            = textureAtlas-&gt;GetTextureWithBackup(&quot;gfxtexture&quot;,             &quot;circularthingy&quot;);
-	projectiletex     = textureAtlas-&gt;GetTextureWithBackup(&quot;projectiletexture&quot;,      &quot;circularthingy&quot;);
-	repulsegfxtex     = textureAtlas-&gt;GetTextureWithBackup(&quot;repulsegfxtexture&quot;,      &quot;circularthingy&quot;);
-	sphereparttex     = textureAtlas-&gt;GetTextureWithBackup(&quot;sphereparttexture&quot;,      &quot;circularthingy&quot;);
-	torpedotex        = textureAtlas-&gt;GetTextureWithBackup(&quot;torpedotexture&quot;,         &quot;circularthingy&quot;);
-	wrecktex          = textureAtlas-&gt;GetTextureWithBackup(&quot;wrecktexture&quot;,           &quot;circularthingy&quot;);
-	plasmatex         = textureAtlas-&gt;GetTextureWithBackup(&quot;plasmatexture&quot;,          &quot;circularthingy&quot;);
+#define GETTEX(t, b) textureAtlas-&gt;GetTextureWithBackup((t), (b))
+	sbtrailtex         = GETTEX(&quot;sbtrailtexture&quot;,         &quot;smoketrail&quot;    );
+	missiletrailtex    = GETTEX(&quot;missiletrailtexture&quot;,    &quot;smoketrail&quot;    );
+	muzzleflametex     = GETTEX(&quot;muzzleflametexture&quot;,     &quot;explo&quot;         );
+	repulsetex         = GETTEX(&quot;repulsetexture&quot;,         &quot;explo&quot;         );
+	dguntex            = GETTEX(&quot;dguntexture&quot;,            &quot;flare&quot;         );
+	flareprojectiletex = GETTEX(&quot;flareprojectiletexture&quot;, &quot;flare&quot;         );
+	sbflaretex         = GETTEX(&quot;sbflaretexture&quot;,         &quot;flare&quot;         );
+	missileflaretex    = GETTEX(&quot;missileflaretexture&quot;,    &quot;flare&quot;         );
+	beamlaserflaretex  = GETTEX(&quot;beamlaserflaretexture&quot;,  &quot;flare&quot;         );
+	bubbletex          = GETTEX(&quot;bubbletexture&quot;,          &quot;circularthingy&quot;);
+	geosquaretex       = GETTEX(&quot;geosquaretexture&quot;,       &quot;circularthingy&quot;);
+	gfxtex             = GETTEX(&quot;gfxtexture&quot;,             &quot;circularthingy&quot;);
+	projectiletex      = GETTEX(&quot;projectiletexture&quot;,      &quot;circularthingy&quot;);
+	repulsegfxtex      = GETTEX(&quot;repulsegfxtexture&quot;,      &quot;circularthingy&quot;);
+	sphereparttex      = GETTEX(&quot;sphereparttexture&quot;,      &quot;circularthingy&quot;);
+	torpedotex         = GETTEX(&quot;torpedotexture&quot;,         &quot;circularthingy&quot;);
+	wrecktex           = GETTEX(&quot;wrecktexture&quot;,           &quot;circularthingy&quot;);
+	plasmatex          = GETTEX(&quot;plasmatexture&quot;,          &quot;circularthingy&quot;);
+#undef GETTEX
 
 	groundFXAtlas = SAFE_NEW CTextureAtlas(2048, 2048);
 	//add all textures in groundfx section


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000739.html">[Taspring-linux-commit] r5959 - trunk/rts/Game/UI
</A></li>
	<LI>Next message: <A HREF="000741.html">[Taspring-linux-commit] r5961 - in branches/gml/rts: . ExternalAI	Game Game/Camera Game/StartScripts Game/UI Lua Map	Map/SM3/terrain Map/SMF Rendering Rendering/Env Rendering/GL	Rendering/Textures Rendering/UnitModels Sim Sim/Features	Sim/Misc Sim/Projectiles Sim/Units Sim/Units/COB Sim/Weapons	System System/FileSystem System/Net System/Net/Test build	build/cmake build/vstudio8 lib lib/gml lib/lua lib/lua/src	lib/streflop
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#740">[ date ]</a>
              <a href="thread.html#740">[ thread ]</a>
              <a href="subject.html#740">[ subject ]</a>
              <a href="author.html#740">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
