<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r5930 - in trunk: game/LuaUI/Widgets	installer/builddata/springcontent/gamedata rts/Game	rts/Game/Camera rts/Lua rts/System
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-May/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5930%20-%20in%20trunk%3A%20game/LuaUI/Widgets%0A%09installer/builddata/springcontent/gamedata%20rts/Game%0A%09rts/Game/Camera%20rts/Lua%20rts/System&In-Reply-To=%3C20080525022832.AB54E45CD%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000709.html">
   <LINK REL="Next"  HREF="000711.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r5930 - in trunk: game/LuaUI/Widgets	installer/builddata/springcontent/gamedata rts/Game	rts/Game/Camera rts/Lua rts/System</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5930%20-%20in%20trunk%3A%20game/LuaUI/Widgets%0A%09installer/builddata/springcontent/gamedata%20rts/Game%0A%09rts/Game/Camera%20rts/Lua%20rts/System&In-Reply-To=%3C20080525022832.AB54E45CD%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r5930 - in trunk: game/LuaUI/Widgets	installer/builddata/springcontent/gamedata rts/Game	rts/Game/Camera rts/Lua rts/System">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Sun May 25 04:28:31 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000709.html">[Taspring-linux-commit] r5929 - trunk
</A></li>
        <LI>Next message: <A HREF="000711.html">[Taspring-linux-commit] r5931 -	trunk/installer/builddata/springcontent/gamedata
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#710">[ date ]</a>
              <a href="thread.html#710">[ thread ]</a>
              <a href="subject.html#710">[ subject ]</a>
              <a href="author.html#710">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: trepan
Date: 2008-05-25 04:28:30 +0200 (Sun, 25 May 2008)
New Revision: 5930

Added:
   trunk/installer/builddata/springcontent/gamedata/messages.lua
Modified:
   trunk/game/LuaUI/Widgets/camera_ctrl.lua
   trunk/game/LuaUI/Widgets/camera_smooth_move.lua
   trunk/rts/Game/Camera/CameraController.cpp
   trunk/rts/Game/Camera/CameraController.h
   trunk/rts/Game/Camera/FPSController.cpp
   trunk/rts/Game/Camera/FPSController.h
   trunk/rts/Game/Camera/FreeController.cpp
   trunk/rts/Game/Camera/FreeController.h
   trunk/rts/Game/Camera/LuaCameraCtrl.h
   trunk/rts/Game/Camera/OverheadController.cpp
   trunk/rts/Game/Camera/OverheadController.h
   trunk/rts/Game/Camera/OverviewController.cpp
   trunk/rts/Game/Camera/OverviewController.h
   trunk/rts/Game/Camera/RotOverheadController.cpp
   trunk/rts/Game/Camera/RotOverheadController.h
   trunk/rts/Game/Camera/SmoothController.cpp
   trunk/rts/Game/Camera/SmoothController.h
   trunk/rts/Game/Camera/TWController.cpp
   trunk/rts/Game/Camera/TWController.h
   trunk/rts/Game/CameraHandler.cpp
   trunk/rts/Game/CameraHandler.h
   trunk/rts/Game/Game.cpp
   trunk/rts/Game/Team.cpp
   trunk/rts/Lua/LuaUnsyncedCtrl.cpp
   trunk/rts/Lua/LuaUnsyncedRead.cpp
   trunk/rts/System/Messages.cpp
   trunk/rts/System/Messages.h
Log:

- changed the CCameraController GetState / SetState calls to
  use named maps rather than vectors of floats.
- changed the lua GetCameraState() and SetCameraState() call-outs
  to use named maps for their parameters (they were broken, again)
- updated the camera_smooth_move.lua and camera_ctrl.lua widgets
  for the previous changes

- Fixed the team death messages (caused by r5787)
- Changed 'messages.tdf' to 'messages.lua'
  (TdfParser is on its last legs  ;-)



Modified: trunk/game/LuaUI/Widgets/camera_ctrl.lua
===================================================================
--- trunk/game/LuaUI/Widgets/camera_ctrl.lua	2008-05-25 00:54:20 UTC (rev 5929)
+++ trunk/game/LuaUI/Widgets/camera_ctrl.lua	2008-05-25 02:28:30 UTC (rev 5930)
@@ -13,11 +13,11 @@
 
 function widget:GetInfo()
   return {
-    name      = &quot;CameraControl&quot;,
-    desc      = &quot;Low level access to camera parameters&quot;,
-    author    = &quot;trepan&quot;,
-    date      = &quot;Mar 21, 2007&quot;,
-    license   = &quot;GNU GPL, v2 or later&quot;,
+    name      = 'CameraControl',
+    desc      = 'Low level access to camera parameters',
+    author    = 'trepan',
+    date      = 'Mar 21, 2007',
+    license   = 'GNU GPL, v2 or later',
     layer     = 1,     --  after the normal widgets
     enabled   = false  --  loaded by default?
   }
@@ -33,72 +33,22 @@
 --------------------------------------------------------------------------------
 --------------------------------------------------------------------------------
 
-local function GetCamereTable()
-  local cs = Spring.GetCameraState()
-  if (cs == nil) then
-    return nil
-  end
+local fullNames = {
+  fps  = 'First Person Shooter (FPS)',
+  free = 'Free Camera',
+  ov   = 'Overview',
+  rot  = 'Rotatable Camera',
+  ta   = 'Total Annihilation Overhead Camera',
+  tw   = 'Total War Camera',
+}
 
-  local ct = {
-    px = 2, py = 3, pz = 4  --  available to all modes, and 1 is 'num'
-  }
-  
-  if (cs.name == 'ov') then    -- Overview
-    ct.fullName = &quot;Overview&quot;
-  elseif ((cs.name == 'fps') or (cs.name == 'rot')) then   -- FPS and Rotating
-    if (cs.name == 'fps') then
-      ct.fullName = &quot;First Person Shooter (FPS)&quot;
-    else
-      ct.fullName = &quot;Rotatable Camera&quot;
-    end
-    ct.dx        = 5
-    ct.dy        = 6
-    ct.dz        = 7
-    ct.rx        = 8
-    ct.ry        = 9
-    ct.rz        = 10
-    ct.oldHeight = 11
-  elseif (cs.name == 'ta') then    -- Total Annihilation
-    ct.fullName = &quot;Total Annihilation Overhead Camera&quot;
-    ct.dx      = 5
-    ct.dy      = 6
-    ct.dz      = 7
-    ct.height  = 8
-    ct.zscale  = 9
-    ct.flipped = 10
-  elseif (cs.name == 'tw') then    -- Total War 
-    ct.fullName = &quot;Total War Camera&quot;
-    ct.rx = 5
-    ct.ry = 6
-    ct.rz = 7
-  elseif (cs.name == 'free') then  -- Free Camera
-    ct.fullName = &quot;Free Camera&quot;
-    ct.dx          = 5
-    ct.dy          = 6
-    ct.dz          = 7
-    ct.rx          = 8
-    ct.ry          = 9
-    ct.rz          = 10
-    ct.fov         = 11
-    ct.gndOffset   = 12
-    ct.gravity     = 13
-    ct.slide       = 14
-    ct.scrollSpeed = 15
-    ct.tiltSpeed   = 16
-    ct.velTime     = 17
-    ct.avelTime    = 18
-    ct.autoTilt    = 19
-    ct.goForward   = 20
-    ct.invertAlt   = 21
-    ct.gndLock     = 22
-    ct.vx          = 23
-    ct.vy          = 24
-    ct.vz          = 25
-    ct.avx         = 26
-    ct.avy         = 27
-    ct.avz         = 28
+
+local function GetFullName(cs)
+  local fullName = fullNames[cs.name]
+  if (fullName) then
+    return fullName
   end
-  return ct, cs
+  return cs.name
 end
 
 
@@ -106,55 +56,51 @@
 
 local function CamCtrl(cmd, line, words)
   local wc = #words
-  local ct, cs = GetCamereTable()
-  if (ct == nil) then
-    Spring.Echo(&quot;Couldn't get the camera state&quot;)
+  local cs = Spring.GetCameraState()
+
+  if (cs == nil) then
+    Spring.Echo('Could not get the camera state')
     return true
   end
 
   if (wc == 0) then  --  print the parameters names
-    Spring.Echo(ct.fullName .. &quot; Parameters:&quot;)
+    Spring.Echo(GetFullName(cs) .. ' Parameters:')
     local array = {}
-    for k,v in pairs(ct) do
-      if (type(v) == &quot;number&quot;) then
+    for k,v in pairs(cs) do
+      if ((type(k) == 'string') and (k ~= 'name')) then
         table.insert(array, k)
       end
     end
     table.sort(array)
-    Spring.Echo(table.concat(array, &quot; &quot;))
+    Spring.Echo(table.concat(array, ' '))
 
   elseif (wc == 1) then  --  print a parameters value
-    Spring.Echo(ct.fullName)
-    local param = ct[words[1]]
-    if ((param == nil) or (type(param) ~= 'number')) then
-      Spring.Echo(&quot;  bad parameter name: &quot; .. words[1])
+    Spring.Echo(GetFullName(cs))
+    local value = cs[words[1]]
+    if (type(value) ~= 'number') then
+      Spring.Echo('  bad parameter name: ' .. words[1])
       return true
     end
-    Spring.Echo(&quot;  &quot; .. words[1] .. &quot; = &quot; .. tostring(cs[param]))
+    Spring.Echo('  ' .. words[1] .. ' = ' .. value)
 
   elseif (wc &gt;= 2) then  --  set a parameters value
-    Spring.Echo(ct.fullName)
-    local param = ct[words[1]]
-    if ((param == nil) or (type(param) ~= 'number')) then
-      Spring.Echo(&quot;  bad parameter name: &quot; .. words[1])
+    Spring.Echo(GetFullName(cs))
+    local value = cs[words[1]]
+    if (type(value) ~= 'number') then
+      Spring.Echo('  bad parameter name: ' .. words[1])
       return true
     end
-    local value = tonumber(words[2])
-    if (value == nil) then
-      Spring.Echo(&quot;  bad value: &quot; .. words[2])
-      return true
-    end
-    cs[param] = tonumber(value)
+    cs[words[1]] = tonumber(words[2])
     local camTime = 0
     if (wc &gt;= 3) then  --  specified transition time?
       camTime = tonumber(words[3])
       if (camTime == nil) then
-        Spring.Echo(&quot;  bad camTime: &quot; .. words[3])
+        Spring.Echo('  bad camTime: ' .. words[3])
         return true
       end
     end
     Spring.SetCameraState(cs, camTime)
-    Spring.Echo(&quot;  set &quot; .. words[1] .. &quot; to &quot; .. value)
+    Spring.Echo('  set ' .. words[1] .. ' to ' .. value)
   end
 
   return true
@@ -162,7 +108,7 @@
 
 
 function widget:Initialize()
-  widgetHandler:AddAction(&quot;cam&quot;, CamCtrl)
+  widgetHandler:AddAction('cam', CamCtrl)
 end
 
 

Modified: trunk/game/LuaUI/Widgets/camera_smooth_move.lua
===================================================================
--- trunk/game/LuaUI/Widgets/camera_smooth_move.lua	2008-05-25 00:54:20 UTC (rev 5929)
+++ trunk/game/LuaUI/Widgets/camera_smooth_move.lua	2008-05-25 02:28:30 UTC (rev 5930)
@@ -87,18 +87,17 @@
         return
       end
       -- clear the velocities
-      for p = 22,27 do
-        cs[p] = 0
-      end
+      cs.vx  = 0; cs.vy  = 0; cs.vz  = 0
+      cs.avx = 0; cs.avy = 0; cs.avz = 0
     end
-    if (cs.name == &quot;ta&quot;) then
-      local flip = -cs[9]
+    if (cs.name == 'ta') then
+      local flip = -cs.flipped
       -- simple, forward and right are locked
-      cs[1] = cs[1] + (speed * flip * (x - mx))
+      cs.px = cs.px + (speed * flip * (x - mx))
       if (false) then
-        cs[2] = cs[2] + (speed * flip * (my - y))
+        cs.py = cs.py + (speed * flip * (my - y))
       else
-        cs[3] = cs[3] + (speed * flip * (my - y))
+        cs.pz = cs.pz + (speed * flip * (my - y))
       end
     else
       -- forward, up, right, top, bottom, left, right
@@ -113,12 +112,12 @@
       local drz = cr[3] / len
       local mxm = (speed * (x - mx))
       local mym = (speed * (y - my))
-      cs[1] = cs[1] + (mxm * drx) + (mym * dfx)
-      cs[3] = cs[3] + (mxm * drz) + (mym * dfz)
+      cs.px = cs.px + (mxm * drx) + (mym * dfx)
+      cs.pz = cs.pz + (mxm * drz) + (mym * dfz)
     end
     spSetCameraState(cs, 0)
     if (mmb) then
-      spSetMouseCursor(&quot;none&quot;)
+      spSetMouseCursor('none')
     end
   end
 end
@@ -129,7 +128,7 @@
     return false
   end
   local cs = spGetCameraState()
-  if (blockModeSwitching and (cs.name ~= &quot;ta&quot;) and (cs.name ~= &quot;free&quot;)) then
+  if (blockModeSwitching and (cs.name ~= 'ta') and (cs.name ~= 'free')) then
     local a,c,m,s = spGetModKeyState()
     return (c or s)  --  block the mode toggling
   end
@@ -144,7 +143,7 @@
     mx = vsx * 0.5
     my = vsy * 0.5
     spWarpMouse(mx, my)
-    spSendCommands({&quot;trackoff&quot;})
+    spSendCommands({'trackoff'})
   end
   return true
 end

Added: trunk/installer/builddata/springcontent/gamedata/messages.lua
===================================================================
--- trunk/installer/builddata/springcontent/gamedata/messages.lua	                        (rev 0)
+++ trunk/installer/builddata/springcontent/gamedata/messages.lua	2008-05-25 02:28:30 UTC (rev 5930)
@@ -0,0 +1,54 @@
+--------------------------------------------------------------------------------
+--------------------------------------------------------------------------------
+--
+--  file:    messages.lua
+--  brief:   messages.tdf lua parser
+--  author:  Craig Lawrence, Dave Rodgers
+--
+--  Copyright (C) 2007.
+--  Licensed under the terms of the GNU GPL, v2 or later.
+--
+--------------------------------------------------------------------------------
+--------------------------------------------------------------------------------
+
+local TDF = VFS.Include('gamedata/parse_tdf.lua')
+
+--------------------------------------------------------------------------------
+--------------------------------------------------------------------------------
+
+if (not VFS.FileExists('gamedata/messages.tdf')) then
+  return false
+end
+
+local tdfMsgs, err = TDF.Parse('gamedata/messages.tdf')
+if (tdfMsgs == nil) then
+  error('Error parsing messages.tdf: ' .. err)
+end
+if (type(tdfMsgs.messages) ~= 'table') then
+  error('Missing &quot;messages&quot; table')
+end
+
+local luaMsgs = {}
+
+for label, msgs in pairs(tdfMsgs.messages) do
+  if ((type(label) == 'string') and
+      (type(msgs)  == 'table')) then
+    print('MSG: ' .. label)
+    local msgArray = {}
+    for _, msg in pairs(msgs) do
+      if (type(msg) == 'string') then
+        table.insert(msgArray, msg)
+        print('  ' .. msg)
+      end
+    end
+    luaMsgs[label:lower()] = msgArray -- lower case keys
+  end
+end
+
+
+--------------------------------------------------------------------------------
+
+return luaMsgs
+
+--------------------------------------------------------------------------------
+--------------------------------------------------------------------------------

Modified: trunk/rts/Game/Camera/CameraController.cpp
===================================================================
--- trunk/rts/Game/Camera/CameraController.cpp	2008-05-25 00:54:20 UTC (rev 5929)
+++ trunk/rts/Game/Camera/CameraController.cpp	2008-05-25 02:28:30 UTC (rev 5930)
@@ -15,3 +15,29 @@
 CCameraController::~CCameraController(void)
 {
 }
+
+
+bool CCameraController::SetStateBool(const StateMap&amp; sm,
+                                     const std::string&amp; name, bool&amp; var)
+{
+	StateMap::const_iterator it = sm.find(name);
+	if (it != sm.end()) {
+		const float value = it-&gt;second;
+		var = (value &gt; 0.0f);
+		return true;
+	}
+	return false;
+}
+
+
+bool CCameraController::SetStateFloat(const StateMap&amp; sm,
+                                      const std::string&amp; name, float&amp; var)
+{
+	StateMap::const_iterator it = sm.find(name);
+	if (it != sm.end()) {
+		const float value = it-&gt;second;
+		var = value;
+		return true;
+	}
+	return false;
+}

Modified: trunk/rts/Game/Camera/CameraController.h
===================================================================
--- trunk/rts/Game/Camera/CameraController.h	2008-05-25 00:54:20 UTC (rev 5929)
+++ trunk/rts/Game/Camera/CameraController.h	2008-05-25 02:28:30 UTC (rev 5930)
@@ -3,12 +3,17 @@
 
 #include &lt;string&gt;
 #include &lt;vector&gt;
+#include &lt;map&gt;
 
 #include &quot;float3.h&quot;
 
+
 class CCameraController
 {
 public:
+	typedef std::map&lt;std::string, float&gt; StateMap;
+
+public:
 	CCameraController();
 	virtual ~CCameraController(void);
 
@@ -32,14 +37,18 @@
 	virtual float3 SwitchFrom() const =0;			//return pos that to send to new controllers SetPos
 	virtual void SwitchTo(bool showText=true)=0;
 	
-	virtual void GetState(std::vector&lt;float&gt;&amp; fv) const = 0;
-	virtual bool SetState(const std::vector&lt;float&gt;&amp; fv, unsigned startPos=0) = 0;
+	virtual void GetState(StateMap&amp; sm) const = 0;
+	virtual bool SetState(const StateMap&amp; sm) = 0;
 	virtual void SetTrackingInfo(const float3&amp; pos, float radius) { SetPos(pos); }
 
 	/// should this mode appear when we toggle the camera controller?
 	bool enabled;
 	
 protected:
+	bool SetStateBool(const StateMap&amp; sm, const std::string&amp; name, bool&amp; var);
+	bool SetStateFloat(const StateMap&amp; sm, const std::string&amp; name, float&amp; var);
+
+protected:
 	float fov;
 	float mouseScale;
 	float scrollSpeed;

Modified: trunk/rts/Game/Camera/FPSController.cpp
===================================================================
--- trunk/rts/Game/Camera/FPSController.cpp	2008-05-25 00:54:20 UTC (rev 5929)
+++ trunk/rts/Game/Camera/FPSController.cpp	2008-05-25 02:28:30 UTC (rev 5930)
@@ -7,6 +7,7 @@
 
 using namespace std;
 
+
 CFPSController::CFPSController()
 	: oldHeight(300)
 {
@@ -15,12 +16,14 @@
 	fov = configHandler.GetFloat(&quot;FPSFOV&quot;, 45.0f);
 }
 
+
 void CFPSController::KeyMove(float3 move)
 {
 	move*=move.z*400;
 	pos+=(camera-&gt;forward*move.y+camera-&gt;right*move.x)*scrollSpeed;
 }
 
+
 void CFPSController::MouseMove(float3 move)
 {
 	camera-&gt;rot.y -= mouseScale*move.x;
@@ -32,16 +35,19 @@
 		camera-&gt;rot.x=-PI*0.4999f;
 }
 
+
 void CFPSController::ScreenEdgeMove(float3 move)
 {
 	KeyMove(move);
 }
 
+
 void CFPSController::MouseWheelMove(float move)
 {
 	pos += camera-&gt;up * move;
 }
 
+
 float3 CFPSController::GetPos()
 {
 #ifdef DIRECT_CONTROL_ALLOWED
@@ -67,6 +73,7 @@
 	return pos;
 }
 
+
 float3 CFPSController::GetDir()
 {
 	dir.x = (float)(cos(camera-&gt;rot.x) * sin(camera-&gt;rot.y));
@@ -76,6 +83,7 @@
 	return dir;
 }
 
+
 void CFPSController::SetPos(const float3&amp; newPos)
 {
 	CCameraController::SetPos(newPos);
@@ -88,51 +96,61 @@
 	}
 }
 
+
 void CFPSController::SetDir(const float3&amp; newDir)
 {
 	dir = newDir;
 }
 
+
 float3 CFPSController::SwitchFrom() const
 {
 	return pos;
 }
 
+
 void CFPSController::SwitchTo(bool showText)
 {
-	if(showText)
+	if (showText) {
 		logOutput.Print(&quot;Switching to FPS style camera&quot;);
+  }
 }
 
-void CFPSController::GetState(std::vector&lt;float&gt;&amp; fv) const
+
+void CFPSController::GetState(StateMap&amp; sm) const
 {
-	fv.push_back(/*  1 */ pos.x);
-	fv.push_back(/*  2 */ pos.y);
-	fv.push_back(/*  3 */ pos.z);
-	fv.push_back(/*  4 */ dir.x);
-	fv.push_back(/*  5 */ dir.y);
-	fv.push_back(/*  6 */ dir.z);
-	fv.push_back(/*  7 */ camera-&gt;rot.x);
-	fv.push_back(/*  8 */ camera-&gt;rot.y);
-	fv.push_back(/*  9 */ camera-&gt;rot.z);
-	fv.push_back(/* 10 */ oldHeight);
+	sm[&quot;px&quot;] = pos.x;
+	sm[&quot;py&quot;] = pos.y;
+	sm[&quot;pz&quot;] = pos.z;
+
+	sm[&quot;dx&quot;] = dir.x;
+	sm[&quot;dy&quot;] = dir.y;
+	sm[&quot;dz&quot;] = dir.z;
+
+	sm[&quot;rx&quot;] = camera-&gt;rot.x;
+	sm[&quot;ry&quot;] = camera-&gt;rot.y;
+	sm[&quot;rz&quot;] = camera-&gt;rot.z;
+
+	sm[&quot;oldHeight&quot;] = oldHeight;
 }
 
-bool CFPSController::SetState(const std::vector&lt;float&gt;&amp; fv, unsigned startPos)
+
+bool CFPSController::SetState(const StateMap&amp; sm)
 {
-	if (fv.size() != 10+startPos) {
-		return false;
-	}
-	pos.x = fv[startPos++];
-	pos.y = fv[startPos++];
-	pos.z = fv[startPos++];
-	dir.x = fv[startPos++];
-	dir.y = fv[startPos++];
-	dir.z = fv[startPos++];
-	camera-&gt;rot.x = fv[startPos++];
-	camera-&gt;rot.y = fv[startPos++];
-	camera-&gt;rot.z = fv[startPos++];
-	oldHeight = fv[startPos++];
+	SetStateFloat(sm, &quot;px&quot;, pos.x);
+	SetStateFloat(sm, &quot;py&quot;, pos.y);
+	SetStateFloat(sm, &quot;pz&quot;, pos.z);
+
+	SetStateFloat(sm, &quot;dx&quot;, dir.x);
+	SetStateFloat(sm, &quot;dy&quot;, dir.y);
+	SetStateFloat(sm, &quot;dz&quot;, dir.z);
+
+	SetStateFloat(sm, &quot;rx&quot;, camera-&gt;rot.x);
+	SetStateFloat(sm, &quot;ry&quot;, camera-&gt;rot.y);
+	SetStateFloat(sm, &quot;rz&quot;, camera-&gt;rot.z);
+
+	SetStateFloat(sm, &quot;oldHeight&quot;, oldHeight);
+
 	return true;
 }
 

Modified: trunk/rts/Game/Camera/FPSController.h
===================================================================
--- trunk/rts/Game/Camera/FPSController.h	2008-05-25 00:54:20 UTC (rev 5929)
+++ trunk/rts/Game/Camera/FPSController.h	2008-05-25 02:28:30 UTC (rev 5930)
@@ -25,8 +25,8 @@
 	float3 SwitchFrom() const;
 	void SwitchTo(bool showText);
 
-	void GetState(std::vector&lt;float&gt;&amp; fv) const;
-	bool SetState(const std::vector&lt;float&gt;&amp; fv, unsigned startPos=0);
+	void GetState(StateMap&amp; sm) const;
+	bool SetState(const StateMap&amp; sm);
 
 private:
 	float oldHeight;

Modified: trunk/rts/Game/Camera/FreeController.cpp
===================================================================
--- trunk/rts/Game/Camera/FreeController.cpp	2008-05-25 00:54:20 UTC (rev 5929)
+++ trunk/rts/Game/Camera/FreeController.cpp	2008-05-25 02:28:30 UTC (rev 5930)
@@ -392,73 +392,79 @@
 }
 
 
-void CFreeController::GetState(std::vector&lt;float&gt;&amp; fv) const
+void CFreeController::GetState(StateMap&amp; sm) const
 {
-	fv.push_back(/*  1 */ pos.x);
-	fv.push_back(/*  2 */ pos.y);
-	fv.push_back(/*  3 */ pos.z);
-	fv.push_back(/*  4 */ dir.x);
-	fv.push_back(/*  5 */ dir.y);
-	fv.push_back(/*  6 */ dir.z);
-	fv.push_back(/*  7 */ camera-&gt;rot.x);
-	fv.push_back(/*  8 */ camera-&gt;rot.y);
-	fv.push_back(/*  9 */ camera-&gt;rot.z);
+	sm[&quot;px&quot;] = pos.x;
+	sm[&quot;py&quot;] = pos.y;
+	sm[&quot;pz&quot;] = pos.z;
 
-	fv.push_back(/* 10 */ fov);
-	fv.push_back(/* 11 */ gndOffset);
-	fv.push_back(/* 12 */ gravity);
-	fv.push_back(/* 13 */ slide);
-	fv.push_back(/* 14 */ scrollSpeed);
-	fv.push_back(/* 15 */ tiltSpeed);
-	fv.push_back(/* 16 */ velTime);
-	fv.push_back(/* 17 */ avelTime);
-	fv.push_back(/* 18 */ autoTilt);
-	fv.push_back(/* 19 */ goForward ? 1.0f : -1.0f);
-	fv.push_back(/* 20 */ invertAlt ? 1.0f : -1.0f);
-	fv.push_back(/* 21 */ gndLock   ? 1.0f : -1.0f);
+	sm[&quot;dx&quot;] = dir.x;
+	sm[&quot;dy&quot;] = dir.y;
+	sm[&quot;dz&quot;] = dir.z;
 
-	fv.push_back(/* 22 */ prevVel.x);
-	fv.push_back(/* 23 */ prevVel.y);
-	fv.push_back(/* 24 */ prevVel.z);
-	fv.push_back(/* 25 */ prevAvel.x);
-	fv.push_back(/* 26 */ prevAvel.y);
-	fv.push_back(/* 27 */ prevAvel.z);
+	sm[&quot;rx&quot;] = camera-&gt;rot.x;
+	sm[&quot;ry&quot;] = camera-&gt;rot.y;
+	sm[&quot;rz&quot;] = camera-&gt;rot.z;
+
+	sm[&quot;fov&quot;]         = fov;
+	sm[&quot;gndOffset&quot;]   = gndOffset;
+	sm[&quot;gravity&quot;]     = gravity;
+	sm[&quot;slide&quot;]       = slide;
+	sm[&quot;scrollSpeed&quot;] = scrollSpeed;
+	sm[&quot;tiltSpeed&quot;]   = tiltSpeed;
+	sm[&quot;velTime&quot;]     = velTime;
+	sm[&quot;avelTime&quot;]    = avelTime;
+	sm[&quot;autoTilt&quot;]    = autoTilt;
+
+	sm[&quot;goForward&quot;]   = goForward ? +1.0f : -1.0f;
+	sm[&quot;invertAlt&quot;]   = invertAlt ? +1.0f : -1.0f;
+	sm[&quot;gndLock&quot;]     = gndLock   ? +1.0f : -1.0f;
+
+	sm[&quot;vx&quot;] = prevVel.x;
+	sm[&quot;vy&quot;] = prevVel.y;
+	sm[&quot;vz&quot;] = prevVel.z;
+
+	sm[&quot;avx&quot;] = prevAvel.x;
+	sm[&quot;avy&quot;] = prevAvel.y;
+	sm[&quot;avz&quot;] = prevAvel.z;
 }
 
 
-bool CFreeController::SetState(const std::vector&lt;float&gt;&amp; fv, unsigned startPos)
+bool CFreeController::SetState(const StateMap&amp; sm)
 {
-	if (fv.size() != 27+startPos) {
-		return false;
-	}
-	pos.x = fv[startPos++];
-	pos.y = fv[startPos++];
-	pos.z = fv[startPos++];
-	dir.x = fv[startPos++];
-	dir.y = fv[startPos++];
-	dir.z = fv[startPos++];
-	camera-&gt;rot.x = fv[startPos++];
-	camera-&gt;rot.y = fv[startPos++];
-	camera-&gt;rot.z = fv[startPos++];
+	SetStateFloat(sm, &quot;px&quot;, pos.x);
+	SetStateFloat(sm, &quot;py&quot;, pos.y);
+	SetStateFloat(sm, &quot;pz&quot;, pos.z);
 
-	fov         =  fv[startPos++];
-	gndOffset   =  fv[startPos++];
-	gravity     =  fv[startPos++];
-	slide       =  fv[startPos++];
-	scrollSpeed =  fv[startPos++];
-	tiltSpeed   =  fv[startPos++];
-	velTime     =  fv[startPos++];
-	avelTime    =  fv[startPos++];
-	autoTilt    =  fv[startPos++];
-	goForward   = (fv[startPos++] &gt; 0.0f);
-	invertAlt   = (fv[startPos++] &gt; 0.0f);
-	gndLock     = (fv[startPos++] &gt; 0.0f);
-	prevVel.x   =  fv[startPos++];
-	prevVel.y   =  fv[startPos++];
-	prevVel.z   =  fv[startPos++];
-	prevAvel.x  =  fv[startPos++];
-	prevAvel.y  =  fv[startPos++];
-	prevAvel.z  =  fv[startPos++];
+	SetStateFloat(sm, &quot;dx&quot;, dir.x);
+	SetStateFloat(sm, &quot;dy&quot;, dir.y);
+	SetStateFloat(sm, &quot;dz&quot;, dir.z);
 
+	SetStateFloat(sm, &quot;rx&quot;, camera-&gt;rot.x);
+	SetStateFloat(sm, &quot;ry&quot;, camera-&gt;rot.y);
+	SetStateFloat(sm, &quot;rz&quot;, camera-&gt;rot.z);
+
+	SetStateFloat(sm, &quot;fov&quot;,         fov);
+	SetStateFloat(sm, &quot;gndOffset&quot;,   gndOffset);
+	SetStateFloat(sm, &quot;gravity&quot;,     gravity);
+	SetStateFloat(sm, &quot;slide&quot;,       slide);
+	SetStateFloat(sm, &quot;scrollSpeed&quot;, scrollSpeed);
+	SetStateFloat(sm, &quot;tiltSpeed&quot;,   tiltSpeed);
+	SetStateFloat(sm, &quot;velTime&quot;,     velTime);
+	SetStateFloat(sm, &quot;avelTime&quot;,    avelTime);
+	SetStateFloat(sm, &quot;autoTilt&quot;,    autoTilt);
+
+	SetStateBool (sm, &quot;goForward&quot;,   goForward);
+	SetStateBool (sm, &quot;invertAlt&quot;,   invertAlt);
+	SetStateBool (sm, &quot;gndLock&quot;,     gndLock);
+
+	SetStateFloat(sm, &quot;vx&quot;, prevVel.x);
+	SetStateFloat(sm, &quot;vy&quot;, prevVel.y);
+	SetStateFloat(sm, &quot;vz&quot;, prevVel.z);
+
+	SetStateFloat(sm, &quot;avx&quot;, prevAvel.x);
+	SetStateFloat(sm, &quot;avy&quot;, prevAvel.y);
+	SetStateFloat(sm, &quot;avz&quot;, prevAvel.z);
+
 	return true;
 }

Modified: trunk/rts/Game/Camera/FreeController.h
===================================================================
--- trunk/rts/Game/Camera/FreeController.h	2008-05-25 00:54:20 UTC (rev 5929)
+++ trunk/rts/Game/Camera/FreeController.h	2008-05-25 02:28:30 UTC (rev 5930)
@@ -30,8 +30,8 @@
 	float3 SwitchFrom() const;
 	void SwitchTo(bool showText);
 
-	void GetState(std::vector&lt;float&gt;&amp; fv) const;
-	bool SetState(const std::vector&lt;float&gt;&amp; fv, unsigned startPos=0);
+	void GetState(StateMap&amp; sm) const;
+	bool SetState(const StateMap&amp; sm);
 
 private:
 	float3 dir;

Modified: trunk/rts/Game/Camera/LuaCameraCtrl.h
===================================================================
--- trunk/rts/Game/Camera/LuaCameraCtrl.h	2008-05-25 00:54:20 UTC (rev 5929)
+++ trunk/rts/Game/Camera/LuaCameraCtrl.h	2008-05-25 02:28:30 UTC (rev 5930)
@@ -29,8 +29,8 @@
 	float3 SwitchFrom() const; // return pos that to send to new controllers SetPos
 	void SwitchTo(bool showText);
 
-	void GetState(std::vector&lt;float&gt;&amp; fv) const;
-	bool SetState(const std::vector&lt;float&gt;&amp; fv, unsigned startPos=0);
+	void GetState(StateMap&amp; sm) const;
+	bool SetState(const StateMap&amp; sm);
 
 private:
 	float3 dir;

Modified: trunk/rts/Game/Camera/OverheadController.cpp
===================================================================
--- trunk/rts/Game/Camera/OverheadController.cpp	2008-05-25 00:54:20 UTC (rev 5929)
+++ trunk/rts/Game/Camera/OverheadController.cpp	2008-05-25 02:28:30 UTC (rev 5930)
@@ -151,32 +151,34 @@
 		logOutput.Print(&quot;Switching to Overhead (TA) style camera&quot;);
 }
 
-void COverheadController::GetState(std::vector&lt;float&gt;&amp; fv) const
+void COverheadController::GetState(StateMap&amp; sm) const
 {
-	fv.push_back(/* 1 */ pos.x);
-	fv.push_back(/* 2 */ pos.y);
-	fv.push_back(/* 3 */ pos.z);
-	fv.push_back(/* 4 */ dir.x);
-	fv.push_back(/* 5 */ dir.y);
-	fv.push_back(/* 6 */ dir.z);
-	fv.push_back(/* 7 */ height);
-	fv.push_back(/* 8 */ zscale);
-	fv.push_back(/* 9 */ flipped ? +1.0f : -1.0f);
+	sm[&quot;px&quot;] = pos.x;
+	sm[&quot;py&quot;] = pos.y;
+	sm[&quot;pz&quot;] = pos.z;
+
+	sm[&quot;dx&quot;] = dir.x;
+	sm[&quot;dy&quot;] = dir.y;
+	sm[&quot;dz&quot;] = dir.z;
+
+	sm[&quot;height&quot;]  = height;
+	sm[&quot;zscale&quot;]  = zscale;
+	sm[&quot;flipped&quot;] = flipped ? +1.0f : -1.0f;
 }
 
-bool COverheadController::SetState(const std::vector&lt;float&gt;&amp; fv, unsigned startPos)
+bool COverheadController::SetState(const StateMap&amp; sm)
 {
-	if (fv.size() != 9+startPos) {
-		return false;
-	}
-	pos.x   =  fv[startPos++];
-	pos.y   =  fv[startPos++];
-	pos.z   =  fv[startPos++];
-	dir.x   =  fv[startPos++];
-	dir.y   =  fv[startPos++];
-	dir.z   =  fv[startPos++];
-	height  =  fv[startPos++];
-	zscale  =  fv[startPos++];
-	flipped = (fv[startPos++] &gt; 0.0f);
+	SetStateFloat(sm, &quot;px&quot;, pos.x);
+	SetStateFloat(sm, &quot;py&quot;, pos.y);
+	SetStateFloat(sm, &quot;pz&quot;, pos.z);
+
+	SetStateFloat(sm, &quot;dx&quot;, dir.x);
+	SetStateFloat(sm, &quot;dy&quot;, dir.y);
+	SetStateFloat(sm, &quot;dz&quot;, dir.z);
+
+	SetStateFloat(sm, &quot;height&quot;, height);
+	SetStateFloat(sm, &quot;zscale&quot;, zscale);
+	SetStateBool (sm, &quot;flipped&quot;, flipped);
+
 	return true;
 }

Modified: trunk/rts/Game/Camera/OverheadController.h
===================================================================
--- trunk/rts/Game/Camera/OverheadController.h	2008-05-25 00:54:20 UTC (rev 5929)
+++ trunk/rts/Game/Camera/OverheadController.h	2008-05-25 02:28:30 UTC (rev 5930)
@@ -22,8 +22,8 @@
 	float3 SwitchFrom() const;
 	void SwitchTo(bool showText);
 
-	void GetState(std::vector&lt;float&gt;&amp; fv) const;
-	bool SetState(const std::vector&lt;float&gt;&amp; fv, unsigned startPos=0);
+	void GetState(StateMap&amp; sm) const;
+	bool SetState(const StateMap&amp; sm);
 
 	bool flipped;
 

Modified: trunk/rts/Game/Camera/OverviewController.cpp
===================================================================
--- trunk/rts/Game/Camera/OverviewController.cpp	2008-05-25 00:54:20 UTC (rev 5929)
+++ trunk/rts/Game/Camera/OverviewController.cpp	2008-05-25 02:28:30 UTC (rev 5930)
@@ -71,20 +71,17 @@
 	}
 }
 
-void COverviewController::GetState(std::vector&lt;float&gt;&amp; fv) const
+void COverviewController::GetState(StateMap&amp; sm) const
 {
-	fv.push_back(/* 1 */ pos.x);
-	fv.push_back(/* 2 */ pos.y);
-	fv.push_back(/* 3 */ pos.z);
+	sm[&quot;px&quot;] = pos.x;
+	sm[&quot;py&quot;] = pos.y;
+	sm[&quot;pz&quot;] = pos.z;
 }
 
-bool COverviewController::SetState(const std::vector&lt;float&gt;&amp; fv, unsigned startPos)
+bool COverviewController::SetState(const StateMap&amp; sm)
 {
-	if (fv.size() != 3+startPos) {
-		return false;
-	}
-	pos.x = fv[startPos++];
-	pos.y = fv[startPos++];
-	pos.z = fv[startPos++];
+	SetStateFloat(sm, &quot;px&quot;, pos.x);
+	SetStateFloat(sm, &quot;py&quot;, pos.y);
+	SetStateFloat(sm, &quot;pz&quot;, pos.z);
 	return true;
 }

Modified: trunk/rts/Game/Camera/OverviewController.h
===================================================================
--- trunk/rts/Game/Camera/OverviewController.h	2008-05-25 00:54:20 UTC (rev 5929)
+++ trunk/rts/Game/Camera/OverviewController.h	2008-05-25 02:28:30 UTC (rev 5930)
@@ -24,8 +24,8 @@
 	float3 SwitchFrom() const;
 	void SwitchTo(bool showText);
 
-	void GetState(std::vector&lt;float&gt;&amp; fv) const;
-	bool SetState(const std::vector&lt;float&gt;&amp; fv, unsigned startPos=0);
+	void GetState(StateMap&amp; sm) const;
+	bool SetState(const StateMap&amp; sm);
 
 private:
 	bool minimizeMinimap;

Modified: trunk/rts/Game/Camera/RotOverheadController.cpp
===================================================================
--- trunk/rts/Game/Camera/RotOverheadController.cpp	2008-05-25 00:54:20 UTC (rev 5929)
+++ trunk/rts/Game/Camera/RotOverheadController.cpp	2008-05-25 02:28:30 UTC (rev 5930)
@@ -15,6 +15,7 @@
 	fov = configHandler.GetFloat(&quot;RotOverheadFOV&quot;, 45.0f);
 }
 
+
 void CRotOverheadController::KeyMove(float3 move)
 {
 	move*=sqrt(move.z)*400;
@@ -28,6 +29,7 @@
 	pos+=(flatForward*move.y+camera-&gt;right*move.x)*scrollSpeed;
 }
 
+
 void CRotOverheadController::MouseMove(float3 move)
 {
 	camera-&gt;rot.y -= mouseScale*move.x;
@@ -39,11 +41,13 @@
 		camera-&gt;rot.x=-PI*0.4999f;
 }
 
+
 void CRotOverheadController::ScreenEdgeMove(float3 move)
 {
 	KeyMove(move);
 }
 
+
 void CRotOverheadController::MouseWheelMove(float move)
 {
 	const float gheight = ground-&gt;GetHeight(pos.x,pos.z);
@@ -52,6 +56,7 @@
 	pos.y = height + gheight;
 }
 
+
 float3 CRotOverheadController::GetPos()
 {
 	if(pos.x&lt;0.01f)
@@ -72,6 +77,7 @@
 	return pos;
 }
 
+
 float3 CRotOverheadController::GetDir()
 {
 	dir.x=(float)(sin(camera-&gt;rot.y)*cos(camera-&gt;rot.x));
@@ -81,52 +87,61 @@
 	return dir;
 }
 
+
 void CRotOverheadController::SetPos(const float3&amp; newPos)
 {
 	CCameraController::SetPos(newPos);
 	pos.y = ground-&gt;GetHeight(pos.x, pos.z) + oldHeight;
 }
 
+
 float3 CRotOverheadController::SwitchFrom() const
 {
 	return pos;
 }
 
+
 void CRotOverheadController::SwitchTo(bool showText)
 {
 	if(showText)
 		logOutput.Print(&quot;Switching to Rotatable overhead camera&quot;);
 }
 
-void CRotOverheadController::GetState(std::vector&lt;float&gt;&amp; fv) const
+
+void CRotOverheadController::GetState(StateMap&amp; sm) const
 {
-	fv.push_back(/*  1 */ pos.x);
-	fv.push_back(/*  2 */ pos.y);
-	fv.push_back(/*  3 */ pos.z);
-	fv.push_back(/*  4 */ dir.x);
-	fv.push_back(/*  5 */ dir.y);
-	fv.push_back(/*  6 */ dir.z);
-	fv.push_back(/*  7 */ camera-&gt;rot.x);
-	fv.push_back(/*  8 */ camera-&gt;rot.y);
-	fv.push_back(/*  9 */ camera-&gt;rot.z);
-	fv.push_back(/* 10 */ oldHeight);
+	sm[&quot;px&quot;] = pos.x;
+	sm[&quot;py&quot;] = pos.y;
+	sm[&quot;pz&quot;] = pos.z;
+
+	sm[&quot;dx&quot;] = dir.x;
+	sm[&quot;dy&quot;] = dir.y;
+	sm[&quot;dz&quot;] = dir.z;
+
+	sm[&quot;rx&quot;] = camera-&gt;rot.x;
+	sm[&quot;ry&quot;] = camera-&gt;rot.y;
+	sm[&quot;rz&quot;] = camera-&gt;rot.z;
+
+	sm[&quot;oldHeight&quot;] = oldHeight;
 }
 
-bool CRotOverheadController::SetState(const std::vector&lt;float&gt;&amp; fv, unsigned startPos)
+
+bool CRotOverheadController::SetState(const StateMap&amp; sm)
 {
-	if (fv.size() != 10+startPos) {
-		return false;
-	}
-	pos.x = fv[startPos++];
-	pos.y = fv[startPos++];
-	pos.z = fv[startPos++];
-	dir.x = fv[startPos++];
-	dir.y = fv[startPos++];
-	dir.z = fv[startPos++];
-	camera-&gt;rot.x = fv[startPos++];
-	camera-&gt;rot.y = fv[startPos++];
-	camera-&gt;rot.z = fv[startPos++];
-	oldHeight = fv[startPos++];
+	SetStateFloat(sm, &quot;px&quot;, pos.x);
+	SetStateFloat(sm, &quot;py&quot;, pos.y);
+	SetStateFloat(sm, &quot;pz&quot;, pos.z);
+
+	SetStateFloat(sm, &quot;dx&quot;, dir.x);
+	SetStateFloat(sm, &quot;dy&quot;, dir.y);
+	SetStateFloat(sm, &quot;dz&quot;, dir.z);
+
+	SetStateFloat(sm, &quot;rx&quot;, camera-&gt;rot.x);
+	SetStateFloat(sm, &quot;ry&quot;, camera-&gt;rot.y);
+	SetStateFloat(sm, &quot;rz&quot;, camera-&gt;rot.z);
+
+	SetStateFloat(sm, &quot;oldHeight&quot;, oldHeight);
+
 	return true;
 }
 

Modified: trunk/rts/Game/Camera/RotOverheadController.h
===================================================================
--- trunk/rts/Game/Camera/RotOverheadController.h	2008-05-25 00:54:20 UTC (rev 5929)
+++ trunk/rts/Game/Camera/RotOverheadController.h	2008-05-25 02:28:30 UTC (rev 5930)
@@ -24,8 +24,8 @@
 	float3 SwitchFrom() const;
 	void SwitchTo(bool showText);
 
-	void GetState(std::vector&lt;float&gt;&amp; fv) const;
-	bool SetState(const std::vector&lt;float&gt;&amp; fv, unsigned startPos=0);
+	void GetState(StateMap&amp; sm) const;
+	bool SetState(const StateMap&amp; sm);
 
 private:
 	float oldHeight;

Modified: trunk/rts/Game/Camera/SmoothController.cpp
===================================================================
--- trunk/rts/Game/Camera/SmoothController.cpp	2008-05-25 00:54:20 UTC (rev 5929)
+++ trunk/rts/Game/Camera/SmoothController.cpp	2008-05-25 02:28:30 UTC (rev 5930)
@@ -15,6 +15,7 @@
 
 extern Uint8 *keys;
 
+
 SmoothController::SmoothController()
 	: flipped(false),zscale(0.5f),
 	height(500),
@@ -35,6 +36,7 @@
 {
 }
 
+
 void SmoothController::KeyMove(float3 move)
 {
 	if (flipped) {
@@ -60,6 +62,7 @@
 	}
 }
 
+
 void SmoothController::MouseMove(float3 move)
 {
 	if (flipped) {
@@ -74,6 +77,7 @@
 	lastMove = (thisMove+lastMove)/2.0f;
 }
 
+
 void SmoothController::ScreenEdgeMove(float3 move)
 {
 	if (flipped) {
@@ -99,6 +103,7 @@
 	}
 }
 
+
 void SmoothController::MouseWheelMove(float move)
 {
 	// tilt the camera if LCTRL is pressed
@@ -153,6 +158,7 @@
 	}
 }
 
+
 float3 SmoothController::GetPos()
 {
 	maxHeight = 9.5f * std::max(gs-&gt;mapx,gs-&gt;mapy);		//map not created when constructor run
@@ -180,52 +186,59 @@
 	return cpos;
 }
 
+
 float3 SmoothController::GetDir()
 {
 	return dir;
 }
 
+
 float3 SmoothController::SwitchFrom() const
 {
 	return pos;
 }
 
+
 void SmoothController::SwitchTo(bool showText)
 {
 	if(showText)
 		logOutput.Print(&quot;Switching to smooth camera&quot;);
 }
 
-void SmoothController::GetState(std::vector&lt;float&gt;&amp; fv) const
+
+void SmoothController::GetState(StateMap&amp; sm) const
 {
-	fv.push_back(/* 1 */ pos.x);
-	fv.push_back(/* 2 */ pos.y);
-	fv.push_back(/* 3 */ pos.z);
-	fv.push_back(/* 4 */ dir.x);
-	fv.push_back(/* 5 */ dir.y);
-	fv.push_back(/* 6 */ dir.z);
-	fv.push_back(/* 7 */ height);
-	fv.push_back(/* 8 */ zscale);
-	fv.push_back(/* 9 */ flipped ? +1.0f : -1.0f);
+	sm[&quot;px&quot;] = pos.x;
+	sm[&quot;py&quot;] = pos.y;
+	sm[&quot;pz&quot;] = pos.z;
+
+	sm[&quot;dx&quot;] = dir.x;
+	sm[&quot;dy&quot;] = dir.y;
+	sm[&quot;dz&quot;] = dir.z;
+
+	sm[&quot;height&quot;]  = height;
+	sm[&quot;zscale&quot;]  = zscale;
+	sm[&quot;flipped&quot;] = flipped ? +1.0f : -1.0f;
 }
 
-bool SmoothController::SetState(const std::vector&lt;float&gt;&amp; fv, unsigned startPos)
+bool SmoothController::SetState(const StateMap&amp; sm)
 {
-	if (fv.size() != 9+startPos) {
-		return false;
-	}
-	pos.x   =  fv[startPos++];
-	pos.y   =  fv[startPos++];
-	pos.z   =  fv[startPos++];
-	dir.x   =  fv[startPos++];
-	dir.y   =  fv[startPos++];
-	dir.z   =  fv[startPos++];
-	height  =  fv[startPos++];
-	zscale  =  fv[startPos++];
-	flipped = (fv[startPos++] &gt; 0.0f);
+	SetStateFloat(sm, &quot;px&quot;, pos.x);
+	SetStateFloat(sm, &quot;py&quot;, pos.y);
+	SetStateFloat(sm, &quot;pz&quot;, pos.z);
+
+	SetStateFloat(sm, &quot;dx&quot;, dir.x);
+	SetStateFloat(sm, &quot;dy&quot;, dir.y);
+	SetStateFloat(sm, &quot;dz&quot;, dir.z);
+
+	SetStateFloat(sm, &quot;height&quot;,  height);
+	SetStateFloat(sm, &quot;zscale&quot;,  zscale);
+	SetStateBool (sm, &quot;flipped&quot;, flipped);
+
 	return true;
 }
 
+
 void SmoothController::Move(const float3&amp; move, const unsigned timeDiff)
 {
 	if ((move.x != 0 || move.z != 0) &amp;&amp; speedFactor &lt; maxSpeedFactor)

Modified: trunk/rts/Game/Camera/SmoothController.h
===================================================================
--- trunk/rts/Game/Camera/SmoothController.h	2008-05-25 00:54:20 UTC (rev 5929)
+++ trunk/rts/Game/Camera/SmoothController.h	2008-05-25 02:28:30 UTC (rev 5930)
@@ -27,8 +27,8 @@
 	float3 SwitchFrom() const;
 	void SwitchTo(bool showText);
 
-	void GetState(std::vector&lt;float&gt;&amp; fv) const;
-	bool SetState(const std::vector&lt;float&gt;&amp; fv, unsigned startPos=0);
+	void GetState(StateMap&amp; sm) const;
+	bool SetState(const StateMap&amp; sm);
 
 	bool flipped;
 

Modified: trunk/rts/Game/Camera/TWController.cpp
===================================================================
--- trunk/rts/Game/Camera/TWController.cpp	2008-05-25 00:54:20 UTC (rev 5929)
+++ trunk/rts/Game/Camera/TWController.cpp	2008-05-25 02:28:30 UTC (rev 5930)
@@ -10,6 +10,7 @@
 
 extern Uint8 *keys;
 
+
 CTWController::CTWController()
 {
 	scrollSpeed = configHandler.GetInt(&quot;TWScrollSpeed&quot;,10) * 0.1f;
@@ -17,6 +18,7 @@
 	fov = configHandler.GetFloat(&quot;TWFOV&quot;, 45.0f);
 }
 
+
 void CTWController::KeyMove(float3 move)
 {
 	float3 flatForward=camera-&gt;forward;
@@ -27,6 +29,7 @@
 	pos+=(flatForward*move.y+camera-&gt;right*move.x)*scrollSpeed;
 }
 
+
 void CTWController::MouseMove(float3 move)
 {
 	float dist=-camera-&gt;rot.x*1500;
@@ -39,6 +42,7 @@
 	pos+=-(flatForward*move.y-camera-&gt;right*move.x)*scrollSpeed;
 }
 
+
 void CTWController::ScreenEdgeMove(float3 move)
 {
 	if(mouse-&gt;lasty&lt;gu-&gt;viewSizeY/3){
@@ -48,11 +52,13 @@
 	KeyMove(move);
 }
 
+
 void CTWController::MouseWheelMove(float move)
 {
 	camera-&gt;rot.x-=move*0.001f;
 }
 
+
 float3 CTWController::GetPos()
 {
 	if(pos.x&lt;0.01f)
@@ -86,6 +92,7 @@
 	return cpos;
 }
 
+
 float3 CTWController::GetDir()
 {
 	float3 dir;
@@ -96,37 +103,39 @@
 	return dir;
 }
 
+
 float3 CTWController::SwitchFrom() const
 {
 	return pos;
 }
 
+
 void CTWController::SwitchTo(bool showText)
 {
-	if(showText)
+	if (showText) {
 		logOutput.Print(&quot;Switching to Total War style camera&quot;);
+	}
 }
 
-void CTWController::GetState(std::vector&lt;float&gt;&amp; fv) const
+
+void CTWController::GetState(StateMap&amp; sm) const
 {
-	fv.push_back(/* 1 */ pos.x);
-	fv.push_back(/* 2 */ pos.y);
-	fv.push_back(/* 3 */ pos.z);
-	fv.push_back(/* 4 */ camera-&gt;rot.x);
-	fv.push_back(/* 5 */ camera-&gt;rot.y);
-	fv.push_back(/* 6 */ camera-&gt;rot.z);
+	sm[&quot;px&quot;] = pos.x;
+	sm[&quot;py&quot;] = pos.y;
+	sm[&quot;pz&quot;] = pos.z;
+	sm[&quot;rx&quot;] = camera-&gt;rot.x;
+	sm[&quot;ry&quot;] = camera-&gt;rot.y;
+	sm[&quot;rz&quot;] = camera-&gt;rot.z;
 }
 
-bool CTWController::SetState(const std::vector&lt;float&gt;&amp; fv, unsigned startPos)
+
+bool CTWController::SetState(const StateMap&amp; sm)
 {
-	if (fv.size() != 6+startPos) {
-		return false;
-	}
-	pos.x = fv[startPos++];
-	pos.y = fv[startPos++];
-	pos.z = fv[startPos++];
-	camera-&gt;rot.x = fv[startPos++];
-	camera-&gt;rot.y = fv[startPos++];
-	camera-&gt;rot.z = fv[startPos++];
+	SetStateFloat(sm, &quot;px&quot;, pos.x);
+	SetStateFloat(sm, &quot;py&quot;, pos.y);
+	SetStateFloat(sm, &quot;pz&quot;, pos.z);
+	SetStateFloat(sm, &quot;rx&quot;, camera-&gt;rot.x);
+	SetStateFloat(sm, &quot;ry&quot;, camera-&gt;rot.y);
+	SetStateFloat(sm, &quot;rz&quot;, camera-&gt;rot.z);
 	return true;
 }

Modified: trunk/rts/Game/Camera/TWController.h
===================================================================
--- trunk/rts/Game/Camera/TWController.h	2008-05-25 00:54:20 UTC (rev 5929)
+++ trunk/rts/Game/Camera/TWController.h	2008-05-25 02:28:30 UTC (rev 5930)
@@ -22,8 +22,8 @@
 	float3 SwitchFrom() const;
 	void SwitchTo(bool showText);
 
-	void GetState(std::vector&lt;float&gt;&amp; fv) const;
-	bool SetState(const std::vector&lt;float&gt;&amp; fv, unsigned startPos=0);
+	void GetState(StateMap&amp; sm) const;
+	bool SetState(const StateMap&amp; sm);
 };
 
 

Modified: trunk/rts/Game/CameraHandler.cpp
===================================================================
--- trunk/rts/Game/CameraHandler.cpp	2008-05-25 00:54:20 UTC (rev 5929)
+++ trunk/rts/Game/CameraHandler.cpp	2008-05-25 02:28:30 UTC (rev 5930)
@@ -1,5 +1,7 @@
 #include &quot;CameraHandler.h&quot;
 
+#include &quot;Game/Action.h&quot;
+#include &quot;Game/Camera.h&quot;
 #include &quot;Game/Camera/CameraController.h&quot;
 #include &quot;Game/Camera/FPSController.h&quot;
 #include &quot;Game/Camera/OverheadController.h&quot;
@@ -8,8 +10,6 @@
 #include &quot;Game/Camera/FreeController.h&quot;
 #include &quot;Game/Camera/OverviewController.h&quot;
 #include &quot;Game/Camera/TWController.h&quot;
-#include &quot;Game/Camera.h&quot;
-#include &quot;Game/Action.h&quot;
 #include &quot;Platform/ConfigHandler.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;GlobalStuff.h&quot;
@@ -23,30 +23,39 @@
 	cameraTime=0.0f;
 	cameraTimeLeft=0.0f;
 	
-	//fps camera must always be the first one in the list
+	// FPS camera must always be the first one in the list
 	std::vector&lt;CCameraController*&gt;&amp; camCtrls = camControllers;
-	camCtrls.push_back(new CFPSController()); // 0  (first)
-	camCtrls.push_back(new COverheadController()); // 1
-	camCtrls.push_back(new CTWController()); // 2
+	camCtrls.push_back(new CFPSController());         // 0
+	camCtrls.push_back(new COverheadController());    // 1
+	camCtrls.push_back(new CTWController());          // 2
 	camCtrls.push_back(new CRotOverheadController()); // 3
-	camCtrls.push_back(new CFreeController()); // 4
-	camCtrls.push_back(new SmoothController()); // 5
-	camCtrls.push_back(new COverviewController()); // 6
+	camCtrls.push_back(new CFreeController());        // 4
+	camCtrls.push_back(new SmoothController());       // 5
+	camCtrls.push_back(new COverviewController());    // 6
 
-	const unsigned mode = std::min(static_cast&lt;unsigned&gt;(configHandler.GetInt(&quot;CamMode&quot;, 1)), camControllers.size()-1);
+	const unsigned int mode = std::min(configHandler.GetInt(&quot;CamMode&quot;, 1),
+	                                   (int)camControllers.size() - 1);
 	currCamCtrlNum = mode;
 	currCamCtrl = camControllers[currCamCtrlNum];
 
 	const double z = 0.0; // casting problems...
-	cameraTimeFactor = std::max(z, atof(configHandler.GetString(&quot;CamTimeFactor&quot;, &quot;1.0&quot;).c_str()));
+	cameraTimeFactor   = std::max(z, atof(configHandler.GetString(&quot;CamTimeFactor&quot;,   &quot;1.0&quot;).c_str()));
 	cameraTimeExponent = std::max(z, atof(configHandler.GetString(&quot;CamTimeExponent&quot;, &quot;4.0&quot;).c_str()));
 
-	RegisterAction(&quot;viewfps&quot;);		RegisterAction(&quot;viewta&quot;);
-	RegisterAction(&quot;viewtw&quot;);		RegisterAction(&quot;viewrot&quot;);
-	RegisterAction(&quot;viewfree&quot;);		RegisterAction(&quot;viewov&quot;);
-	RegisterAction(&quot;viewlua&quot;);		RegisterAction(&quot;viewtaflip&quot;);
-	RegisterAction(&quot;viewsave&quot;);		RegisterAction(&quot;viewload&quot;);
+	RegisterAction(&quot;viewfps&quot;);
+	RegisterAction(&quot;viewta&quot;);
+	RegisterAction(&quot;viewtw&quot;);
+	RegisterAction(&quot;viewrot&quot;);
+	RegisterAction(&quot;viewfree&quot;);
+	RegisterAction(&quot;viewov&quot;);
+	RegisterAction(&quot;viewlua&quot;);
+
+	RegisterAction(&quot;viewtaflip&quot;);
+
 	RegisterAction(&quot;toggleoverview&quot;);
+
+	RegisterAction(&quot;viewsave&quot;);
+	RegisterAction(&quot;viewload&quot;);
 }
 
 
@@ -178,7 +187,7 @@
 	if (name.empty())
 		return;
 	ViewData vd;
-	vd.push_back(currCamCtrlNum);
+	vd[&quot;mode&quot;] = currCamCtrlNum;
 	currCamCtrl-&gt;GetState(vd);
 	views[name] = vd;
 	return;
@@ -187,8 +196,9 @@
 
 bool CCameraHandler::LoadView(const std::string&amp; name)
 {
-	if (name.empty())
+	if (name.empty()) {
 		return false;
+	}
 
 	std::map&lt;std::string, ViewData&gt;::const_iterator it = views.find(name);
 	if (it == views.end()) {
@@ -199,50 +209,54 @@
 	ViewData current;
 	GetState(current);
 	
-	if (saved == current) // load a view twice to return to old settings
-	{
-		 if (name != &quot;__old_view&quot;) // safety: should not happen, but who knows?
+	if (saved == current) { // load a view twice to return to old settings
+		 if (name != &quot;__old_view&quot;) { // safety: should not happen, but who knows?
 			 return LoadView(&quot;__old_view&quot;);
-		 else
+		 } else {
 			 return false;
+			}
 	}
-	else
-	{
-		if (name != &quot;__old_view&quot;)
+	else {
+		if (name != &quot;__old_view&quot;) {
 			SaveView(&quot;__old_view&quot;);
+		}
 		return LoadViewData(saved);
 	}
 }
 
-void CCameraHandler::GetState(std::vector&lt;float&gt;&amp; fv) const
+
+void CCameraHandler::GetState(CCameraController::StateMap&amp; sm) const
 {
-	fv.clear();
-	fv.push_back(static_cast&lt;float&gt;(currCamCtrlNum));
-	currCamCtrl-&gt;GetState(fv);
+	sm.clear();
+	sm[&quot;mode&quot;] = (float)currCamCtrlNum;
+	currCamCtrl-&gt;GetState(sm);
 }
 
-bool CCameraHandler::SetState(const std::vector&lt;float&gt;&amp; fv)
+
+bool CCameraHandler::SetState(const CCameraController::StateMap&amp; sm)
 {
-	if (fv.empty())
-		return false;
-	
-	const unsigned savedController = static_cast&lt;unsigned&gt;(fv[0]);
-	if (savedController &gt;= camControllers.size())
-		return false;
-	if (savedController != currCamCtrlNum)
-	{
-		currCamCtrlNum = savedController;
-		currCamCtrl = camControllers[savedController];
-		currCamCtrl-&gt;SwitchTo();
+	CCameraController::StateMap::const_iterator it = sm.find(&quot;mode&quot;);
+	if (it != sm.end()) {
+		const unsigned int camMode = (unsigned int)it-&gt;second;
+		if (camMode &gt;= camControllers.size()) {
+			return false;
+		}
+		if (camMode != currCamCtrlNum) {
+			currCamCtrlNum = camMode;
+			currCamCtrl = camControllers[camMode];
+			currCamCtrl-&gt;SwitchTo();
+		}
 	}
-	return currCamCtrl-&gt;SetState(fv, 1);
+	return currCamCtrl-&gt;SetState(sm);
 }
 
+
 const std::string CCameraHandler::GetCurrentControllerName() const
 {
 	return currCamCtrl-&gt;GetName();
 }
 
+
 void CCameraHandler::PushAction(const Action&amp; action)
 {
 	const std::string cmd = action.command;
@@ -288,8 +302,7 @@
 		}
 	}
 	else if (cmd == &quot;viewsave&quot;) {
-		if (!action.extra.empty())
-		{
+		if (!action.extra.empty()) {
 			SaveView(action.extra);
 			logOutput.Print(&quot;Saved view: &quot; + action.extra);
 		}
@@ -303,27 +316,28 @@
 	}
 }
 
+
 bool CCameraHandler::LoadViewData(const ViewData&amp; vd)
 {
-	if (vd.empty())
+	if (vd.empty()) {
 		return false;
+	}
 
-	const unsigned currentMode = currCamCtrlNum;
-	const unsigned wantedMode = static_cast&lt;unsigned&gt;(vd[0]);
-
-	if ((wantedMode &gt;= 0) &amp;&amp; (wantedMode &lt; camControllers.size())) {
-		if (wantedMode != currentMode)
-		{
-			currCamCtrl-&gt;SwitchFrom();
-			currCamCtrlNum = wantedMode;
-			currCamCtrl = camControllers[currCamCtrlNum];
-			const bool showMode = (currentMode != wantedMode);
+	ViewData::const_iterator it = vd.find(&quot;mode&quot;);
+	if (it != vd.end()) {
+		const unsigned int camMode = (unsigned int)it-&gt;second;
+		if (camMode &gt;= camControllers.size()) {
+			return false;
+		}
+		const unsigned int currentMode = currCamCtrlNum;
+		if (camMode != currCamCtrlNum) {
+			currCamCtrlNum = camMode;
+			currCamCtrl = camControllers[camMode];
+			const bool showMode = (camMode != currentMode);
 			currCamCtrl-&gt;SwitchTo(showMode);
 			CameraTransition(1.0f);
 		}
-		return currCamCtrl-&gt;SetState(vd, 1);
 	}
-	else
-		return false;
+	return currCamCtrl-&gt;SetState(vd);
 }
 

Modified: trunk/rts/Game/CameraHandler.h
===================================================================
--- trunk/rts/Game/CameraHandler.h	2008-05-25 00:54:20 UTC (rev 5929)
+++ trunk/rts/Game/CameraHandler.h	2008-05-25 02:28:30 UTC (rev 5930)
@@ -7,14 +7,15 @@
 #include &lt;stack&gt;
 
 #include &quot;Console.h&quot;
+#include &quot;Camera/CameraController.h&quot;
 
-class CCameraController;
 
-
 class CCameraHandler : public CommandReceiver
 {
-	typedef std::vector&lt;float&gt; ViewData;
 public:
+	typedef CCameraController::StateMap ViewData;
+
+public:
 	CCameraHandler();
 	~CCameraHandler();
 	
@@ -32,16 +33,15 @@
 	
 	/**
 	@brief write current camera settings in a vector
-	@param fv vector to hold the data, will be cleared, first float = controller number
 	*/
-	void GetState(ViewData&amp; fv) const;
+	void GetState(CCameraController::StateMap&amp; sm) const;
 	
 	/**
 	@brief restore a camera state
 	@param fv the state to set
 	@return false when vector has wrong size or garbage data, true when aplied without errors
 	*/
-	bool SetState(const ViewData&amp; fv);
+	bool SetState(const CCameraController::StateMap&amp; sm);
 	
 	CCameraController&amp; GetCurrentController() {return *currCamCtrl;};
 	int GetCurrentControllerNum() const {return currCamCtrlNum;};

Modified: trunk/rts/Game/Game.cpp
===================================================================
--- trunk/rts/Game/Game.cpp	2008-05-25 00:54:20 UTC (rev 5929)
+++ trunk/rts/Game/Game.cpp	2008-05-25 02:28:30 UTC (rev 5930)
@@ -2343,11 +2343,11 @@
 	time(&amp;fpstimer);
 
 	if (difftime(fpstimer, starttime) != 0) {		//do once every second
-		fps=thisFps;
-		thisFps=0;
+		fps = thisFps;
+		thisFps = 0;
 
-		starttime=fpstimer;
-		oldframenum=gs-&gt;frameNum;
+		starttime = fpstimer;
+		oldframenum = gs-&gt;frameNum;
 
 		if (!gameServer) {
 			consumeSpeed = ((float)(GAME_SPEED * gs-&gt;speedFactor + leastQue - 2));
@@ -2362,18 +2362,22 @@
 		CInputReceiver::CollectGarbage();
 	}
 
-	if (!skipping)
+	if (!skipping) {
 		UpdateUI();
+	}
+
 	net-&gt;Update();
 
 #ifdef DEBUG
-	if(gameServer)
-		gameServer-&gt;gameClientUpdated=true;
+	if (gameServer) {
+		gameServer-&gt;gameClientUpdated = true;
+	}
 #endif
 
 #ifdef SYNCIFY		//syncify doesnt support multithreading ...
-	if (gameServer)
+	if (gameServer) {
 		gameServer-&gt;Update();
+	}
 #endif
 
 	if(creatingVideo &amp;&amp; playing &amp;&amp; gameServer){
@@ -2381,24 +2385,22 @@
 	}
 
 	ClientReadNet();
-	if(!net-&gt;IsActiveConnection() &amp;&amp; !gameOver){
+	if (!net-&gt;IsActiveConnection() &amp;&amp; !gameOver) {
 		logOutput.Print(&quot;Lost connection to gameserver&quot;);
-		gameOver=true;
+		gameOver = true;
 		luaCallIns.GameOver();
 		GameEnd();
 	}
 
-	if( gameServer &amp;&amp; !gameServer-&gt;GameHasStarted() &amp;&amp; !gameSetup)
-	{
+	if (gameServer &amp;&amp; !gameServer-&gt;GameHasStarted() &amp;&amp; !gameSetup) {
 		bool allReady = true;
-		for(int a=0;a&lt;gs-&gt;activePlayers;a++) {
+		for (int a = 0; a &lt; gs-&gt;activePlayers; a++) {
 			if(gs-&gt;players[a]-&gt;active &amp;&amp; !gs-&gt;players[a]-&gt;readyToStart) {
-				allReady=false;
+				allReady = false;
 				break;
 			}
 		}
-		if (allReady &amp;&amp; (keys[SDLK_RETURN] || script-&gt;onlySinglePlayer))
-		{
+		if (allReady &amp;&amp; (keys[SDLK_RETURN] || script-&gt;onlySinglePlayer)) {
 			chatting = false;
 			userWriting = false;
 			writingPos = 0;
@@ -2603,11 +2605,13 @@
 	camHandler-&gt;UpdateCam();
 	mouse-&gt;UpdateCursors();
 
-	if(unitTracker.Enabled())
+	if (unitTracker.Enabled()) {
 		unitTracker.SetCam();
+	}
 
-	if(playing &amp;&amp; (hideInterface || script-&gt;wantCameraControl))
+	if (playing &amp;&amp; (hideInterface || script-&gt;wantCameraControl)) {
 		script-&gt;SetCamera();
+	}
 
 	CBaseGroundDrawer* gd;
 	{
@@ -2679,7 +2683,7 @@
 	}
 
 #ifdef DIRECT_CONTROL_ALLOWED
-	if(gu-&gt;directControl){
+	if (gu-&gt;directControl) {
 		DrawDirectControlHud();
 	}
 #endif
@@ -2711,16 +2715,19 @@
 
 	glEnable(GL_TEXTURE_2D);
 
-	if(gu-&gt;drawdebug){
+	if (gu-&gt;drawdebug) {
 		//skriv ut fps etc
 		glColor4f(1,1,0.5f,0.8f);
-		font-&gt;glFormatAt(0.03f, 0.02f, 1.0f, &quot;FPS %d Frame %d Part %d(%d)&quot;,fps,gs-&gt;frameNum,ph-&gt;ps.size(),ph-&gt;currentParticles);
+		font-&gt;glFormatAt(0.03f, 0.02f, 1.0f, &quot;FPS %d Frame %d Part %d(%d)&quot;,
+		                 fps, gs-&gt;frameNum, ph-&gt;ps.size(), ph-&gt;currentParticles);
 
-		if(playing)
-			font-&gt;glFormatAt(0.03f, 0.07f, 0.7f, &quot;xpos: %5.0f ypos: %5.0f zpos: %5.0f speed %2.2f&quot;,camera-&gt;pos.x,camera-&gt;pos.y,camera-&gt;pos.z,gs-&gt;speedFactor);
+		if (playing) {
+			font-&gt;glFormatAt(0.03f, 0.07f, 0.7f, &quot;xpos: %5.0f ypos: %5.0f zpos: %5.0f speed %2.2f&quot;,
+			                 camera-&gt;pos.x, camera-&gt;pos.y, camera-&gt;pos.z, gs-&gt;speedFactor);
+		}
 	}
 
-	if( gameServer &amp;&amp; gameServer-&gt;WaitsOnCon() &amp;&amp;!gameSetup){
+	if (gameServer &amp;&amp; gameServer-&gt;WaitsOnCon() &amp;&amp; !gameSetup) {
 		glColor3f(1.0f, 1.0f, 1.0f);
 		font-&gt;glPrintCentered (0.5f, 0.5f, 1.5f, &quot;Waiting for connections. Press return to start&quot;);
 	}
@@ -2774,7 +2781,7 @@
 		}
 	}
 
-	if (playerRoster.GetSortType() != PlayerRoster::Disabled){
+	if (playerRoster.GetSortType() != PlayerRoster::Disabled) {
 		char buf[128];
 		const float fontScale = 1.0f;
 		int count;
@@ -2831,12 +2838,12 @@
 	lastMoveUpdate = start;
 
 #ifndef NO_AVI
-	if(creatingVideo){
-		gu-&gt;lastFrameTime=1.0f/GAME_SPEED;
+	if (creatingVideo) {
+		gu-&gt;lastFrameTime = 1.0f/GAME_SPEED;
 		if(!aviGenerator-&gt;readOpenglPixelDataThreaded()){
 			creatingVideo = false;
 			delete aviGenerator;
-			aviGenerator = 0;
+			aviGenerator = NULL;
 		}
 //		logOutput.Print(&quot;Saved avi frame size %i %i&quot;,ih-&gt;biWidth,ih-&gt;biHeight);
 	}

Modified: trunk/rts/Game/Team.cpp
===================================================================
--- trunk/rts/Game/Team.cpp	2008-05-25 00:54:20 UTC (rev 5929)
+++ trunk/rts/Game/Team.cpp	2008-05-25 02:28:30 UTC (rev 5930)
@@ -254,10 +254,12 @@
 
 void CTeam::Died()
 {
-	if (leader &gt;= 0)
-		logOutput.Print(CMessages::Tr(&quot;Team %i (%s) is no more&quot;).c_str(), teamNum, gs-&gt;players[leader]-&gt;playerName.c_str());
-	else
-		logOutput.Print(CMessages::Tr(&quot;Team %i is no more&quot;).c_str(), teamNum);
+	if (leader &gt;= 0) {
+		logOutput.Print(CMessages::Tr(&quot;Team%i(%s) is no more&quot;).c_str(),
+		                teamNum, gs-&gt;players[leader]-&gt;playerName.c_str());
+	} else {
+		logOutput.Print(CMessages::Tr(&quot;Team%i is no more&quot;).c_str(), teamNum);
+	}
 	isDead = true;
 	luaCallIns.TeamDied(teamNum);
 	net-&gt;SendTeamDied(gu-&gt;myPlayerNum, teamNum);

Modified: trunk/rts/Lua/LuaUnsyncedCtrl.cpp
===================================================================
--- trunk/rts/Lua/LuaUnsyncedCtrl.cpp	2008-05-25 00:54:20 UTC (rev 5929)
+++ trunk/rts/Lua/LuaUnsyncedCtrl.cpp	2008-05-25 02:28:30 UTC (rev 5930)
@@ -18,8 +18,8 @@
 #include &quot;LuaUtils.h&quot;
 
 #include &quot;Game/Camera.h&quot;
-#include &quot;Game/Camera/CameraController.h&quot;
 #include &quot;Game/CameraHandler.h&quot;
+#include &quot;Game/Camera/CameraController.h&quot;
 #include &quot;Game/Game.h&quot;
 #include &quot;Game/SelectedUnits.h&quot;
 #include &quot;Game/Team.h&quot;
@@ -600,35 +600,25 @@
 		return 0;
 	}
 
-	const int args = lua_gettop(L); // number of arguments
-	if ((args != 2) || !lua_istable(L, 1) || !lua_isnumber(L, 2)) {
+	if (!lua_istable(L, 1)) {
 		luaL_error(L, &quot;Incorrect arguments to SetCameraState(table, camTime)&quot;);
 	}
 
-	const int table = 1;
-	const float camTime = (float)lua_tonumber(L, 2);
-	vector&lt;float&gt; camState;
+	const float camTime = (float)luaL_checknumber(L, 2);
+	
+	CCameraController::StateMap camState;
 
-	lua_pushstring(L, &quot;mode&quot;);
-	lua_gettable(L, table);
-	if (lua_isnumber(L, -1)) {
-		const int camNum = (int)lua_tonumber(L, -1);
-		camState.push_back(camNum);
-		camHandler-&gt;CameraTransition(camTime);
-	}
-
-	int index = 1;
-	while (true) {
-		lua_rawgeti(L, table, index);
-		if (!lua_isnumber(L, -1)) {
-			lua_pop(L, 1);
-			break;
+	const int table = 1;
+	for (lua_pushnil(L); lua_next(L, table) != 0; lua_pop(L, 1)) {
+		if (lua_israwstring(L, -2)) {
+			const string key = lua_tostring(L, -2);
+			if (lua_isnumber(L, -1)) {
+				camState[key] = (float)lua_tonumber(L, -1);
+			}
+			else if (lua_isboolean(L, -1)) {
+				camState[key] = lua_toboolean(L, -1) ? +1.0f : -1.0f;
+			}
 		}
-		else {
-			camState.push_back((float)lua_tonumber(L, -1));
-			lua_pop(L, 1);
-			index++;
-		}
 	}
 
 	lua_pushboolean(L, camHandler-&gt;SetState(camState));

Modified: trunk/rts/Lua/LuaUnsyncedRead.cpp
===================================================================
--- trunk/rts/Lua/LuaUnsyncedRead.cpp	2008-05-25 00:54:20 UTC (rev 5929)
+++ trunk/rts/Lua/LuaUnsyncedRead.cpp	2008-05-25 02:28:30 UTC (rev 5930)
@@ -652,19 +652,17 @@
 	CheckNoArgs(L, __FUNCTION__);
 
 	lua_newtable(L);
-	vector&lt;float&gt; camState;
-	camHandler-&gt;GetState(camState);
-	
-	lua_pushstring(L, &quot;mode&quot;);
-	lua_pushnumber(L, camState[0]);
-	lua_rawset(L, -3);
+
 	lua_pushstring(L, &quot;name&quot;);
 	lua_pushstring(L, camHandler-&gt;GetCurrentControllerName().c_str());
 	lua_rawset(L, -3);
-	
-	for (int i = 1; i &lt; (int)camState.size(); i++) {
-		lua_pushnumber(L, i + 1);
-		lua_pushnumber(L, camState[i]);
+
+	CCameraController::StateMap camState;
+	CCameraController::StateMap::const_iterator it;
+	camHandler-&gt;GetState(camState);
+	for (it = camState.begin(); it != camState.end(); ++it) {
+		lua_pushstring(L, it-&gt;first.c_str());
+		lua_pushnumber(L, it-&gt;second);
 		lua_rawset(L, -3);
 	}
 

Modified: trunk/rts/System/Messages.cpp
===================================================================
--- trunk/rts/System/Messages.cpp	2008-05-25 00:54:20 UTC (rev 5929)
+++ trunk/rts/System/Messages.cpp	2008-05-25 02:28:30 UTC (rev 5930)
@@ -5,14 +5,24 @@
 #include &lt;assert.h&gt;
 #include &lt;locale&gt;
 #include &lt;cctype&gt;
+#include &lt;string&gt;
+#include &lt;vector&gt;
+#include &lt;map&gt;
 #include &quot;GlobalStuff.h&quot;
 #include &quot;LogOutput.h&quot;
 #include &quot;Messages.h&quot;
-#include &quot;TdfParser.h&quot;
+#include &quot;Lua/LuaParser.h&quot;
+#include &quot;FileSystem/FileHandler.h&quot;
 #include &quot;mmgr.h&quot;
 
+using std::string;
+using std::vector;
+using std::map;
+
+
 CMessages::CMessages(): loaded(false) {}
 
+
 /** Return a pointer to the single instance of CMessages. */
 CMessages* CMessages::GetInstance()
 {
@@ -20,46 +30,66 @@
 	return &instance;
 }
 
+
 /** Load the messages from gamedata/messages.tdf into memory. */
 void CMessages::Load()
 {
-	try {
-		TdfParser tdfparser(&quot;gamedata/messages.tdf&quot;);
-		// Grab a list of messages.  Each message is one section.
-		std::vector&lt;std::string&gt; section_list = tdfparser.GetSectionList(&quot;messages&quot;);
-		// Load the possible translations for every message.
-		for (std::vector&lt;std::string&gt;::const_iterator sit = section_list.begin(); sit != section_list.end(); ++sit) {
-			const std::map&lt;std::string, std::string&gt;&amp; allvalues = tdfparser.GetAllValues(&quot;messages\\&quot; + *sit);
-			for (std::map&lt;std::string, std::string&gt;::const_iterator it = allvalues.begin(); it != allvalues.end(); ++it) {
-				tr[*sit].push_back(it-&gt;second);
+	LuaParser luaParser(&quot;gamedata/messages.lua&quot;,
+	                    SPRING_VFS_MOD_BASE, SPRING_VFS_MOD_BASE);
+	if (!luaParser.Execute()) {
+		// Show parse errors in the infolog.
+		logOutput.Print(string(&quot;ERROR: messages.lua: &quot;) + luaParser.GetErrorLog());
+		return;
+	}
+
+	const LuaTable root = luaParser.GetRoot();
+
+	vector&lt;string&gt; labels;
+	root.GetKeys(labels);
+
+	for (int i = 0; i &lt; labels.size(); i++) {
+		const string label = StringToLower(labels[i]);
+		const LuaTable msgTable = root.SubTable(label);
+		if (!msgTable.IsValid()) {
+			continue;
+		}
+		vector&lt;string&gt; msgs;
+		for (int i = 1; true; i++) {
+			const string msg = msgTable.GetString(i, &quot;&quot;);
+			if (msg.empty()) {
+				break;
 			}
+			msgs.push_back(msg);
 		}
-	} catch (const TdfParser::parse_error&amp; e) {
-		// Show parse errors in the infolog.
-		logOutput.Print(&quot;%s:%d: %s&quot;, e.get_filename().c_str(), e.get_line(), e.what());
-	} catch (const content_error&amp;) {
-		// Ignore non-existant file.
+		if (!msgs.empty()) {
+			tr[label] = msgs;
+		}
 	}
+		
 	loaded = true;
 }
 
+
 /** Translate \p msg. If multiple messages are available it picks one at random.
 Returns \p msg if no messages are available. */
-std::string CMessages::Translate(const std::string&amp; msg) const
+string CMessages::Translate(const string&amp; msg) const
 {
-	// TdfParser puts everything in lowercase.
-	std::string lowerd = StringToLower(msg);
-	message_map_t::const_iterator it = tr.find(lowerd);
-	if (it == tr.end())
+	// all keys are lowercase
+	const string lower = StringToLower(msg);
+	message_map_t::const_iterator it = tr.find(lower);
+	if (it == tr.end()) {
 		return msg;
+	}
 	return Pick(it-&gt;second);
 }
 
+
 /** Returns a message from \p vec at random. */
-std::string CMessages::Pick(const message_list_t&amp; vec) const
+string CMessages::Pick(const message_list_t&amp; vec) const
 {
 	assert(!vec.empty());
-	if (vec.size() == 1)
+	if (vec.size() == 1) {
 		return vec[0];
+	}
 	return vec[gu-&gt;usRandInt() % vec.size()];
 }

Modified: trunk/rts/System/Messages.h
===================================================================
--- trunk/rts/System/Messages.h	2008-05-25 00:54:20 UTC (rev 5929)
+++ trunk/rts/System/Messages.h	2008-05-25 02:28:30 UTC (rev 5930)
@@ -28,8 +28,9 @@
 public:
 	static inline std::string Tr(const std::string&amp; msg) {
 		CMessages* inst = GetInstance();
-		if (!inst-&gt;loaded)
+		if (!inst-&gt;loaded) {
 			inst-&gt;Load();
+		}
 		return inst-&gt;Translate(msg);
 	}
 };


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000709.html">[Taspring-linux-commit] r5929 - trunk
</A></li>
	<LI>Next message: <A HREF="000711.html">[Taspring-linux-commit] r5931 -	trunk/installer/builddata/springcontent/gamedata
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#710">[ date ]</a>
              <a href="thread.html#710">[ thread ]</a>
              <a href="subject.html#710">[ subject ]</a>
              <a href="author.html#710">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
