<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r5895 - in trunk/rts: Game System	System/Net System/Net/Test
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-May/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5895%20-%20in%20trunk/rts%3A%20Game%20System%0A%09System/Net%20System/Net/Test&In-Reply-To=%3C20080516181437.384E447CE%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000674.html">
   <LINK REL="Next"  HREF="000676.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r5895 - in trunk/rts: Game System	System/Net System/Net/Test</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5895%20-%20in%20trunk/rts%3A%20Game%20System%0A%09System/Net%20System/Net/Test&In-Reply-To=%3C20080516181437.384E447CE%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r5895 - in trunk/rts: Game System	System/Net System/Net/Test">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Fri May 16 20:14:36 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000674.html">[Taspring-linux-commit] r5894 - in branches/gml/rts: . ExternalAI	ExternalAI/GlobalAICInterface Game Game/Camera Game/Server	Game/StartScripts Game/UI Lua Map Map/SM3 Map/SM3/terrain	Map/SMF Rendering Rendering/Env Rendering/GL	Rendering/Textures Rendering/UnitModels Sim/Features Sim/Misc	Sim/MoveTypes Sim/MoveTypes/MoveMath Sim/Objects Sim/Path	Sim/Projectiles Sim/Projectiles/Unsynced	Sim/Projectiles/WeaponProjectiles Sim/Units Sim/Units/COB	Sim/Units/CommandAI Sim/Units/UnitTypes Sim/Weapons System	System/FileSystem System/Net System/Platform/Linux	System/Platform/Win System/Script build/scons build/vstudio8 lib/gml
</A></li>
        <LI>Next message: <A HREF="000676.html">[Taspring-linux-commit] r5896 - branches/gml/rts/lib/gml
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#675">[ date ]</a>
              <a href="thread.html#675">[ thread ]</a>
              <a href="subject.html#675">[ subject ]</a>
              <a href="author.html#675">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: Auswaschbar
Date: 2008-05-16 20:14:35 +0200 (Fri, 16 May 2008)
New Revision: 5895

Modified:
   trunk/rts/Game/ChatMessage.cpp
   trunk/rts/Game/ChatMessage.h
   trunk/rts/Game/CommandMessage.cpp
   trunk/rts/Game/CommandMessage.h
   trunk/rts/Game/Game.cpp
   trunk/rts/Game/GameData.cpp
   trunk/rts/Game/GameData.h
   trunk/rts/Game/GameServer.cpp
   trunk/rts/Game/PreGame.cpp
   trunk/rts/Game/PreGame.h
   trunk/rts/System/BaseNetProtocol.cpp
   trunk/rts/System/BaseNetProtocol.h
   trunk/rts/System/Net/Connection.h
   trunk/rts/System/Net/LocalConnection.cpp
   trunk/rts/System/Net/LocalConnection.h
   trunk/rts/System/Net/Net.cpp
   trunk/rts/System/Net/Net.h
   trunk/rts/System/Net/PackPacket.cpp
   trunk/rts/System/Net/PackPacket.h
   trunk/rts/System/Net/Test/CMakeLists.txt
   trunk/rts/System/Net/Test/main.cpp
   trunk/rts/System/Net/UDPConnection.cpp
   trunk/rts/System/Net/UDPConnection.h
   trunk/rts/System/Net/UnpackPacket.cpp
   trunk/rts/System/Net/UnpackPacket.h
   trunk/rts/System/NetProtocol.cpp
   trunk/rts/System/NetProtocol.h
Log:
* all network-sending code uses RawPackets
* use boost::smart_ptr for RawPackets
  -&gt; easier, safer, less code ...


Modified: trunk/rts/Game/ChatMessage.cpp
===================================================================
--- trunk/rts/Game/ChatMessage.cpp	2008-05-16 01:17:06 UTC (rev 5894)
+++ trunk/rts/Game/ChatMessage.cpp	2008-05-16 18:14:35 UTC (rev 5895)
@@ -10,7 +10,7 @@
 {
 }
 
-ChatMessage::ChatMessage(const netcode::RawPacket&amp; data)
+ChatMessage::ChatMessage(boost::shared_ptr&lt;const netcode::RawPacket&gt; data)
 {
 	UnpackPacket packet(data);
 	unsigned char ID;

Modified: trunk/rts/Game/ChatMessage.h
===================================================================
--- trunk/rts/Game/ChatMessage.h	2008-05-16 01:17:06 UTC (rev 5894)
+++ trunk/rts/Game/ChatMessage.h	2008-05-16 18:14:35 UTC (rev 5895)
@@ -1,6 +1,8 @@
 #ifndef CHAT_MESSAGE_H
 #define CHAT_MESSAGE_H
 
+#include &lt;boost/shared_ptr.hpp&gt;
+
 #include &quot;Action.h&quot;
 
 namespace netcode {
@@ -11,7 +13,7 @@
 {
 public:
 	ChatMessage(int fromP, int dest, const std::string&amp; chat);
-	ChatMessage(const netcode::RawPacket&amp; packet);
+	ChatMessage(boost::shared_ptr&lt;const netcode::RawPacket&gt; packet);
 
 	const netcode::RawPacket* Pack() const;
 

Modified: trunk/rts/Game/CommandMessage.cpp
===================================================================
--- trunk/rts/Game/CommandMessage.cpp	2008-05-16 01:17:06 UTC (rev 5894)
+++ trunk/rts/Game/CommandMessage.cpp	2008-05-16 18:14:35 UTC (rev 5895)
@@ -20,7 +20,7 @@
 	player = playernum;
 }
 
-CommandMessage::CommandMessage(const netcode::RawPacket&amp; pckt)
+CommandMessage::CommandMessage(boost::shared_ptr&lt;const netcode::RawPacket&gt; pckt)
 {
 	UnpackPacket packet(pckt);
 	unsigned char ID;

Modified: trunk/rts/Game/CommandMessage.h
===================================================================
--- trunk/rts/Game/CommandMessage.h	2008-05-16 01:17:06 UTC (rev 5894)
+++ trunk/rts/Game/CommandMessage.h	2008-05-16 18:14:35 UTC (rev 5895)
@@ -2,6 +2,7 @@
 #define COMMANDMESSAGE_H
 
 #include &lt;string&gt;
+#include &lt;boost/shared_ptr.hpp&gt;
 
 #include &quot;Action.h&quot;
 
@@ -15,7 +16,7 @@
 public:
 	CommandMessage(const std::string&amp; cmd, int playernum);
 	CommandMessage(const Action&amp; action, int playernum);
-	CommandMessage(const netcode::RawPacket&amp; packet);
+	CommandMessage(boost::shared_ptr&lt;const netcode::RawPacket&gt;);
 
 	const netcode::RawPacket* Pack() const;
 

Modified: trunk/rts/Game/Game.cpp
===================================================================
--- trunk/rts/Game/Game.cpp	2008-05-16 01:17:06 UTC (rev 5894)
+++ trunk/rts/Game/Game.cpp	2008-05-16 18:14:35 UTC (rev 5895)
@@ -3086,7 +3086,7 @@
 	PUSH_CODE_MODE;
 	ENTER_SYNCED;
 
-	const RawPacket* packet = NULL;
+	boost::shared_ptr&lt;const netcode::RawPacket&gt; packet;
 
 	// compute new timeLeft to &quot;smooth&quot; out SimFrame() calls
 	if(!gameServer){
@@ -3103,7 +3103,7 @@
 		// we still have to process (in variable &quot;que&quot;)
 		int que = 0; // Number of NETMSG_NEWFRAMEs waiting to be processed.
 		unsigned ahead = 0;
-		while ((packet = net-&gt;Peek(ahead)) != NULL)
+		while ((packet = net-&gt;Peek(ahead)))
 		{
 			if (packet-&gt;data[0] == NETMSG_NEWFRAME || packet-&gt;data[0] == NETMSG_KEYFRAME)
 				++que;
@@ -3121,7 +3121,7 @@
 	}
 
 	// really process the messages
-	while (timeLeft &gt; 0.0f &amp;&amp; (packet = net-&gt;GetData()) != NULL)
+	while (timeLeft &gt; 0.0f &amp;&amp; (packet = net-&gt;GetData()))
 	{
 		const unsigned char* inbuf = packet-&gt;data;
 		const unsigned dataLength = packet-&gt;length;
@@ -3300,7 +3300,7 @@
 			}
 
 			case NETMSG_CHAT: {
-				ChatMessage msg(*packet);
+				ChatMessage msg(packet);
 				HandleChatMsg(msg);
 				AddTraffic(msg.fromPlayer, packetCode, dataLength);
 				break;
@@ -3705,7 +3705,7 @@
 				break;
 			}
 			case NETMSG_CCOMMAND: {
-				CommandMessage msg(*packet);
+				CommandMessage msg(packet);
 				ActionRecieved(msg.action, msg.player);
 				break;
 			}
@@ -3808,7 +3808,6 @@
 				break;
 			}
 		}
-		delete packet;
 	}
 
 	POP_CODE_MODE;

Modified: trunk/rts/Game/GameData.cpp
===================================================================
--- trunk/rts/Game/GameData.cpp	2008-05-16 01:17:06 UTC (rev 5894)
+++ trunk/rts/Game/GameData.cpp	2008-05-16 18:14:35 UTC (rev 5895)
@@ -14,7 +14,7 @@
 	modChecksum = 0;
 }
 
-GameData::GameData(const netcode::RawPacket&amp; pckt)
+GameData::GameData(boost::shared_ptr&lt;const RawPacket&gt; pckt)
 {
 	UnpackPacket packet(pckt);
 	unsigned char ID;

Modified: trunk/rts/Game/GameData.h
===================================================================
--- trunk/rts/Game/GameData.h	2008-05-16 01:17:06 UTC (rev 5894)
+++ trunk/rts/Game/GameData.h	2008-05-16 18:14:35 UTC (rev 5895)
@@ -2,6 +2,7 @@
 #define GAMEDATA_H
 
 #include &lt;string&gt;
+#include &lt;boost/shared_ptr.hpp&gt;
 
 namespace netcode {
 	class RawPacket;
@@ -11,7 +12,7 @@
 {
 public:
 	GameData();
-	GameData(const netcode::RawPacket&amp; packet);
+	GameData(boost::shared_ptr&lt;const netcode::RawPacket&gt;);
 	
 	const netcode::RawPacket* Pack() const;
 	

Modified: trunk/rts/Game/GameServer.cpp
===================================================================
--- trunk/rts/Game/GameServer.cpp	2008-05-16 01:17:06 UTC (rev 5894)
+++ trunk/rts/Game/GameServer.cpp	2008-05-16 18:14:35 UTC (rev 5895)
@@ -469,32 +469,30 @@
 	// handle new connections
 	while (serverNet-&gt;HasIncomingConnection())
 	{
-		RawPacket* packet = serverNet-&gt;GetData();
-		const unsigned char* inbuf = packet-&gt;data;
+		boost::shared_ptr&lt;const RawPacket&gt; packet = serverNet-&gt;GetData();
 		
-		if (packet-&gt;length &gt;= 3 &amp;&amp; inbuf[0] == NETMSG_ATTEMPTCONNECT &amp;&amp; inbuf[2] == NETWORK_VERSION)
+		if (packet-&gt;length &gt;= 3 &amp;&amp; packet-&gt;data[0] == NETMSG_ATTEMPTCONNECT &amp;&amp; packet-&gt;data[2] == NETWORK_VERSION)
 		{
-			const unsigned wantedNumber = inbuf[1];
+			const unsigned wantedNumber = packet-&gt;data[1];
 			BindConnection(wantedNumber);
 		}
 		else
 		{
 			if (packet-&gt;length &gt;= 3) {
-				Warning(str(format(ConnectionReject) %inbuf[0] %inbuf[2] %packet-&gt;length));
+				Warning(str(format(ConnectionReject) %packet-&gt;data[0] %packet-&gt;data[2] %packet-&gt;length));
 			}
 			else {
 				Warning(&quot;Connection attempt rejected: Packet too short&quot;);
 			}
 			serverNet-&gt;RejectIncomingConnection();
 		}
-		delete packet;
 	}
 
 	for(unsigned a=0; (int)a &lt;= serverNet-&gt;MaxConnectionID(); a++)
 	{
 		if (serverNet-&gt;IsActiveConnection(a))
 		{
-			RawPacket* packet = 0;
+			boost::shared_ptr&lt;const RawPacket&gt; packet;
 			bool quit = false;
 			while (!quit &amp;&amp; (packet = serverNet-&gt;GetData(a)))
 			{
@@ -578,7 +576,7 @@
 					}
 
 					case NETMSG_CHAT: {
-						ChatMessage msg(*packet);
+						ChatMessage msg(packet);
 						if (static_cast&lt;unsigned&gt;(msg.fromPlayer) != a ) {
 							Warning(str(format(WrongPlayer) %(unsigned)NETMSG_CHAT %a %(unsigned)msg.fromPlayer));
 						} else {
@@ -623,7 +621,7 @@
 							Warning(str(format(WrongPlayer) %(unsigned)inbuf[0] %a %(unsigned)inbuf[3]));
 						} else {
 							if (!demoReader)
-								serverNet-&gt;RawSend(inbuf,*((short int*)&amp;inbuf[1])); //forward data
+								serverNet-&gt;SendData(packet); //forward data
 						}
 						break;
 
@@ -632,8 +630,7 @@
 							Warning(str(format(WrongPlayer) %(unsigned)inbuf[0] %a %(unsigned)inbuf[3]));
 						} else {
 							if (!demoReader)
-								// forward data
-								serverNet-&gt;RawSend(inbuf,*((short int*)&amp;inbuf[1]));
+								serverNet-&gt;SendData(packet); //forward data
 						}
 						break;
 
@@ -646,8 +643,7 @@
 							Warning(str(format(NoHelperAI) %players[a]-&gt;name %a));
 						}
 						else if (!demoReader) {
-							// forward data
-							serverNet-&gt;RawSend(inbuf, *((short int*) &amp;inbuf[1]));
+							serverNet-&gt;SendData(packet); //forward data
 						}
 					} break;
 
@@ -659,8 +655,7 @@
 							Warning(str(format(NoHelperAI) %players[a]-&gt;name %a));
 						}
 						else if (!demoReader) {
-							// forward data
-							serverNet-&gt;RawSend(inbuf, *((short int*) &amp;inbuf[1]));
+							serverNet-&gt;SendData(packet); //forward data
 						}
 					} break;
 
@@ -670,8 +665,7 @@
 						} else if (noHelperAIs) {
 							Warning(str(format(NoHelperAI) %players[a]-&gt;name %a));
 						} else if (!demoReader) {
-							// forward data
-							serverNet-&gt;RawSend(inbuf, *((short int*) &amp;inbuf[1]));
+							serverNet-&gt;SendData(packet); //forward data
 						}
 					} break;
 
@@ -681,7 +675,7 @@
 							Warning(str(format(WrongPlayer) %(unsigned)inbuf[0] %a %(unsigned)inbuf[3]));
 						}
 						else if (!demoReader) {
-							serverNet-&gt;RawSend(inbuf,*((short int*)&amp;inbuf[1])); //forward data
+							serverNet-&gt;SendData(packet); //forward data
 						}
 						break;
 
@@ -725,12 +719,12 @@
 						if(inbuf[1]!=a){
 							Warning(str(format(WrongPlayer) %(unsigned)inbuf[0] %a %(unsigned)inbuf[1]));
 						} else {
-							serverNet-&gt;RawSend(inbuf,sizeof(CPlayer::Statistics)+2); //forward data
+							serverNet-&gt;SendData(packet); //forward data
 						}
 						break;
 
 					case NETMSG_MAPDRAW:
-						serverNet-&gt;RawSend(inbuf,inbuf[1]); //forward data
+						serverNet-&gt;SendData(packet); //forward data
 						break;
 
 #ifdef DIRECT_CONTROL_ALLOWED
@@ -854,7 +848,7 @@
 						break;
 					}
 					case NETMSG_CCOMMAND: {
-						CommandMessage msg(*packet);
+						CommandMessage msg(packet);
 						if (static_cast&lt;unsigned&gt;(msg.player) == a)
 						{
 							if ((commandBlacklist.find(msg.action.command) != commandBlacklist.end()) &amp;&amp; players[a]-&gt;hasRights)
@@ -889,7 +883,6 @@
 						}
 						break;
 				}
-				delete packet;
 			}
 		}
 		else if (players[a])

Modified: trunk/rts/Game/PreGame.cpp
===================================================================
--- trunk/rts/Game/PreGame.cpp	2008-05-16 01:17:06 UTC (rev 5894)
+++ trunk/rts/Game/PreGame.cpp	2008-05-16 18:14:35 UTC (rev 5895)
@@ -438,27 +438,24 @@
 		return;
 	}
 
-	RawPacket* packet = 0;
-	while ( (packet = net-&gt;GetData()) )
+	boost::shared_ptr&lt;const RawPacket&gt; packet;
+	while ((packet = net-&gt;GetData()))
 	{
 		const unsigned char* inbuf = packet-&gt;data;
 		switch (inbuf[0]) {
 			case NETMSG_SETPLAYERNUM: {
-				gu-&gt;myPlayerNum = inbuf[1];
+				gu-&gt;myPlayerNum = packet-&gt;data[1];
 				logOutput.Print(&quot;Became player %i&quot;, gu-&gt;myPlayerNum);
 			} break;
 			case NETMSG_GAMEDATA: {
 				GameDataRecieved(packet);
-				delete packet;
 				return;
-				break;
 			}
 			default: {
-				logOutput.Print(&quot;Unknown net-msg recieved from CPreGame: %i&quot;, int(inbuf[0]));
+				logOutput.Print(&quot;Unknown net-msg recieved from CPreGame: %i&quot;, int(packet-&gt;data[0]));
 				break;
 			}
 		}
-		delete packet;
 	}
 }
 
@@ -469,23 +466,24 @@
 
 	gu-&gt;myPlayerNum = scanner.GetFileHeader().maxPlayerNum + 1;
 
-	RawPacket* buf = 0;
-	while ( (buf = scanner.GetData(static_cast&lt;float&gt;(INT_MAX))) ) {
+	boost::shared_ptr&lt;const RawPacket&gt; buf(scanner.GetData(static_cast&lt;float&gt;(INT_MAX)));
+	while ( buf )
+	{
 		if (buf-&gt;data[0] == NETMSG_GAMEDATA)
 		{
-			GameData *data = new GameData(*buf);
+			GameData *data = new GameData(boost::shared_ptr&lt;const RawPacket&gt;(buf));
 			good_fpu_control_registers(&quot;before CGameServer creation&quot;);
 			gameServer = new CGameServer(springDefaultPort, data, gameSetup, demoName);
 			gameServer-&gt;AddLocalClient();
 			good_fpu_control_registers(&quot;after CGameServer creation&quot;);
-			delete buf;
 			break;
 		}
-		delete buf;
+		
 		if (scanner.ReachedEnd())
 		{
 			throw content_error(&quot;End of demo reached and no game data found&quot;);
 		}
+		buf.reset(scanner.GetData(static_cast&lt;float&gt;(INT_MAX)));
 	}
 }
 
@@ -621,9 +619,9 @@
 	}
 }
 
-void CPreGame::GameDataRecieved(RawPacket* packet)
+void CPreGame::GameDataRecieved(boost::shared_ptr&lt;const netcode::RawPacket&gt; packet)
 {
-	gameData = new GameData(*packet);
+	gameData = new GameData(packet);
 	
 	gs-&gt;SetRandSeed(gameData-&gt;GetRandomSeed());
 	logOutput &lt;&lt; &quot;Using map &quot; &lt;&lt; gameData-&gt;GetMap() &lt;&lt; &quot;\n&quot;;

Modified: trunk/rts/Game/PreGame.h
===================================================================
--- trunk/rts/Game/PreGame.h	2008-05-16 01:17:06 UTC (rev 5894)
+++ trunk/rts/Game/PreGame.h	2008-05-16 18:14:35 UTC (rev 5895)
@@ -2,6 +2,7 @@
 #define PREGAME_H
 
 #include &lt;string&gt;
+#include &lt;boost/shared_ptr.hpp&gt;
 
 #include &quot;GameController.h&quot;
 
@@ -65,7 +66,7 @@
 	/// Map all required archives depending on selected mod(s)
 	static void LoadMod(const std::string&amp; modName);
 
-	void GameDataRecieved(netcode::RawPacket* packet);
+	void GameDataRecieved(boost::shared_ptr&lt;const netcode::RawPacket&gt; packet);
 	
 	const bool server;
 	enum State {

Modified: trunk/rts/System/BaseNetProtocol.cpp
===================================================================
--- trunk/rts/System/BaseNetProtocol.cpp	2008-05-16 01:17:06 UTC (rev 5894)
+++ trunk/rts/System/BaseNetProtocol.cpp	2008-05-16 18:14:35 UTC (rev 5895)
@@ -57,95 +57,96 @@
 	SendQuit();
 }
 
-void CBaseNetProtocol::RawSend(const uchar* data, const unsigned length)
-{
-	SendData(data, length);
-}
-
 void CBaseNetProtocol::SendKeyFrame(int frameNum)
 {
-	SendData&lt;int&gt;(NETMSG_KEYFRAME, frameNum);
+	PackPacket* packet = new PackPacket(5, NETMSG_KEYFRAME);
+	*packet &lt;&lt; frameNum;
+	SendData(packet);
 }
 
 void CBaseNetProtocol::SendNewFrame()
 {
-	unsigned char msg = NETMSG_NEWFRAME;
-	SendData(&amp;msg, 1);
+	SendData(new PackPacket(1, NETMSG_NEWFRAME));
 }
 
 
 void CBaseNetProtocol::SendQuit()
 {
-	SendData(NETMSG_QUIT);
+	SendData(new PackPacket(1, NETMSG_QUIT));
 }
 
 void CBaseNetProtocol::SendQuit(unsigned playerNum)
 {
-	unsigned char a = NETMSG_QUIT;
-	SendData(&amp;a, 1, playerNum);
+	SendData(new PackPacket(5, NETMSG_QUIT), playerNum);
 }
 
 void CBaseNetProtocol::SendStartPlaying(unsigned countdown)
 {
-	SendData&lt;unsigned&gt;(NETMSG_STARTPLAYING, countdown);
+	PackPacket* packet = new PackPacket(5, NETMSG_STARTPLAYING);
+	*packet &lt;&lt; countdown;
+	SendData(packet);
 }
 
 void CBaseNetProtocol::SendSetPlayerNum(uchar myPlayerNum, uchar connNumber)
 {
-	uchar msg[2] = {NETMSG_SETPLAYERNUM, myPlayerNum};
-	SendData(msg, 2, connNumber);
+	PackPacket* packet = new PackPacket(2, NETMSG_SETPLAYERNUM);
+	*packet &lt;&lt; myPlayerNum;
+	SendData(packet, connNumber);
 }
 
 void CBaseNetProtocol::SendPlayerName(uchar myPlayerNum, const std::string&amp; playerName)
 {
 	unsigned size = 3 + playerName.size() + 1;
-	PackPacket* packet = new PackPacket(size);
-	*packet &lt;&lt; static_cast&lt;uchar&gt;(NETMSG_PLAYERNAME) &lt;&lt; static_cast&lt;uchar&gt;(size) &lt;&lt; myPlayerNum &lt;&lt; playerName;
+	PackPacket* packet = new PackPacket(size, NETMSG_PLAYERNAME);
+	*packet &lt;&lt; static_cast&lt;uchar&gt;(size) &lt;&lt; myPlayerNum &lt;&lt; playerName;
 	SendData(packet);
 }
 
-void CBaseNetProtocol::SendRandSeed(uint randSeed)
+void CBaseNetProtocol::SendRandSeed(unsigned randSeed)
 {
-	SendData&lt;uint&gt;(NETMSG_RANDSEED, randSeed);
+	PackPacket* packet = new PackPacket(5, NETMSG_RANDSEED);
+	*packet &lt;&lt; randSeed;
+	SendData(packet);
 }
 
-void CBaseNetProtocol::SendRandSeed(uint randSeed, int toPlayer)
+void CBaseNetProtocol::SendRandSeed(unsigned randSeed, int toPlayer)
 {
-	uchar data[5] = {NETMSG_RANDSEED};
-	*(int*)(data + 1) = randSeed;
-	SendData(data, 5, toPlayer);
+	PackPacket* packet = new PackPacket(5, NETMSG_RANDSEED);
+	*packet &lt;&lt; randSeed;
+	SendData(packet, toPlayer);
 }
 
 // NETMSG_GAMEID = 9, char gameID[16];
 void CBaseNetProtocol::SendGameID(const uchar* buf)
 {
-	uchar data[17];
-	data[0] = NETMSG_GAMEID;
-	memcpy(&amp;data[1], buf, 16);
-	SendData(data, 17);
+	PackPacket* packet = new PackPacket(17, NETMSG_GAMEID);
+	memcpy(packet-&gt;GetWritingPos(), buf, 16);
+	SendData(packet);
 }
 
 
 void CBaseNetProtocol::SendCommand(uchar myPlayerNum, int id, uchar options, const std::vector&lt;float&gt;&amp; params)
 {
 	unsigned size = 9 + params.size() * sizeof(float);
-	PackPacket* packet = new PackPacket(size);
-	*packet &lt;&lt; static_cast&lt;uchar&gt;(NETMSG_COMMAND) &lt;&lt; static_cast&lt;unsigned short&gt;(size) &lt;&lt; myPlayerNum &lt;&lt; id &lt;&lt; options &lt;&lt; params;
+	PackPacket* packet = new PackPacket(size, NETMSG_COMMAND);
+	*packet &lt;&lt; static_cast&lt;unsigned short&gt;(size) &lt;&lt; myPlayerNum &lt;&lt; id &lt;&lt; options &lt;&lt; params;
 	SendData(packet);
 }
 
 void CBaseNetProtocol::SendSelect(uchar myPlayerNum, const std::vector&lt;short&gt;&amp; selectedUnitIDs)
 {
 	unsigned size = 4 + selectedUnitIDs.size() * sizeof(short);
-	PackPacket* packet = new PackPacket(size);
-	*packet &lt;&lt; static_cast&lt;uchar&gt;(NETMSG_SELECT) &lt;&lt; static_cast&lt;unsigned short&gt;(size) &lt;&lt; myPlayerNum &lt;&lt; selectedUnitIDs;
+	PackPacket* packet = new PackPacket(size, NETMSG_SELECT);
+	*packet &lt;&lt; static_cast&lt;unsigned short&gt;(size) &lt;&lt; myPlayerNum &lt;&lt; selectedUnitIDs;
 	SendData(packet);
 }
 
 
 void CBaseNetProtocol::SendPause(uchar myPlayerNum, uchar bPaused)
 {
-	SendData&lt;uchar, uchar&gt;(NETMSG_PAUSE, myPlayerNum, bPaused);
+	PackPacket* packet = new PackPacket(3, NETMSG_PAUSE);
+	*packet &lt;&lt; myPlayerNum &lt;&lt; bPaused;
+	SendData(packet);
 }
 
 
@@ -153,197 +154,215 @@
 void CBaseNetProtocol::SendAICommand(uchar myPlayerNum, short unitID, int id, uchar options, const std::vector&lt;float&gt;&amp; params)
 {
 	unsigned size = 11 + params.size() * sizeof(float);
-	PackPacket* packet = new PackPacket(size);
-	*packet &lt;&lt; static_cast&lt;uchar&gt;(NETMSG_AICOMMAND) &lt;&lt; static_cast&lt;unsigned short&gt;(size) &lt;&lt; myPlayerNum &lt;&lt; unitID &lt;&lt; id &lt;&lt; options &lt;&lt; params;
+	PackPacket* packet = new PackPacket(size, NETMSG_AICOMMAND);
+	*packet &lt;&lt; static_cast&lt;unsigned short&gt;(size) &lt;&lt; myPlayerNum &lt;&lt; unitID &lt;&lt; id &lt;&lt; options &lt;&lt; params;
 	SendData(packet);
 }
 
-void CBaseNetProtocol::SendAICommands(uchar myPlayerNum, short unitIDCount, ...)
-{
-	// FIXME: needs special care; sits in CSelectedUnits::SendCommandsToUnits().
-}
-
 void CBaseNetProtocol::SendAIShare(uchar myPlayerNum, uchar sourceTeam, uchar destTeam, float metal, float energy, const std::vector&lt;short&gt;&amp; unitIDs)
 {
 	short totalNumBytes = (1 + sizeof(short)) + (3 + (2 * sizeof(float)) + (unitIDs.size() * sizeof(short)));
 
-	PackPacket* packet = new PackPacket(totalNumBytes);
-	*packet &lt;&lt; static_cast&lt;uchar&gt;(NETMSG_AISHARE) &lt;&lt; totalNumBytes &lt;&lt; myPlayerNum &lt;&lt; sourceTeam &lt;&lt; destTeam &lt;&lt; metal &lt;&lt; energy &lt;&lt; unitIDs;
+	PackPacket* packet = new PackPacket(totalNumBytes, NETMSG_AISHARE);
+	*packet &lt;&lt; totalNumBytes &lt;&lt; myPlayerNum &lt;&lt; sourceTeam &lt;&lt; destTeam &lt;&lt; metal &lt;&lt; energy &lt;&lt; unitIDs;
 	SendData(packet);
 }
 
-
-
 void CBaseNetProtocol::SendUserSpeed(uchar myPlayerNum, float userSpeed)
 {
-	SendData&lt;uchar, float&gt; (NETMSG_USER_SPEED, myPlayerNum, userSpeed);
+	PackPacket* packet = new PackPacket(6, NETMSG_USER_SPEED);
+	*packet &lt;&lt; myPlayerNum &lt;&lt; userSpeed;
+	SendData(packet);
 }
 
 void CBaseNetProtocol::SendInternalSpeed(float internalSpeed)
 {
-	SendData&lt;float&gt; (NETMSG_INTERNAL_SPEED, internalSpeed);
+	PackPacket* packet = new PackPacket(5, NETMSG_INTERNAL_SPEED);
+	*packet &lt;&lt; internalSpeed;
+	SendData(packet);
 }
 
 void CBaseNetProtocol::SendCPUUsage(float cpuUsage)
 {
-	SendData&lt;float&gt; (NETMSG_CPU_USAGE, cpuUsage);
+	PackPacket* packet = new PackPacket(5, NETMSG_CPU_USAGE);
+	*packet &lt;&lt; cpuUsage;
+	SendData(packet);
 }
 
 
 void CBaseNetProtocol::SendDirectControl(uchar myPlayerNum)
 {
-	SendData&lt;uchar&gt; (NETMSG_DIRECT_CONTROL, myPlayerNum);
+	PackPacket* packet = new PackPacket(2, NETMSG_DIRECT_CONTROL);
+	*packet &lt;&lt; myPlayerNum;
+	SendData(packet);
 }
 
 void CBaseNetProtocol::SendDirectControlUpdate(uchar myPlayerNum, uchar status, short heading, short pitch)
 {
-	SendData&lt;uchar, uchar, short, short&gt; (NETMSG_DC_UPDATE, myPlayerNum, status, heading, pitch);
+	PackPacket* packet = new PackPacket(7, NETMSG_DC_UPDATE);
+	*packet &lt;&lt; myPlayerNum &lt;&lt; status &lt;&lt; heading &lt;&lt; pitch;
+	SendData(packet);
 }
 
 
 void CBaseNetProtocol::SendAttemptConnect(uchar myPlayerNum, uchar networkVersion)
 {
-	SendData&lt;uchar, uchar&gt; (NETMSG_ATTEMPTCONNECT, myPlayerNum, networkVersion);
+	PackPacket* packet = new PackPacket(3, NETMSG_ATTEMPTCONNECT);
+	*packet &lt;&lt; myPlayerNum &lt;&lt; networkVersion;
+	SendData(packet);
 }
 
 
 void CBaseNetProtocol::SendShare(uchar myPlayerNum, uchar shareTeam, uchar bShareUnits, float shareMetal, float shareEnergy)
 {
-	SendData&lt;uchar, uchar, uchar, float, float&gt; (NETMSG_SHARE, myPlayerNum, shareTeam, bShareUnits, shareMetal, shareEnergy);
+	PackPacket* packet = new PackPacket(12, NETMSG_SHARE);
+	*packet &lt;&lt; myPlayerNum &lt;&lt; shareTeam &lt;&lt; bShareUnits &lt;&lt; shareMetal &lt;&lt; shareEnergy;
+	SendData(packet);
 }
 
 void CBaseNetProtocol::SendSetShare(uchar myPlayerNum, uchar myTeam, float metalShareFraction, float energyShareFraction)
 {
-	SendData&lt;uchar, uchar, float, float&gt;(NETMSG_SETSHARE, myPlayerNum, myTeam, metalShareFraction, energyShareFraction);
+	PackPacket* packet = new PackPacket(11, NETMSG_SETSHARE);
+	*packet &lt;&lt; myPlayerNum &lt;&lt; myTeam &lt;&lt; metalShareFraction &lt;&lt; energyShareFraction;
+	SendData(packet);
 }
 
 
 void CBaseNetProtocol::SendSendPlayerStat()
 {
-	SendData(NETMSG_SENDPLAYERSTAT);
+	SendData(new PackPacket(1, NETMSG_SENDPLAYERSTAT));
 }
 
 void CBaseNetProtocol::SendPlayerStat(uchar myPlayerNum, const CPlayer::Statistics&amp; currentStats)
 {
-	SendData&lt;uchar, CPlayer::Statistics&gt;(NETMSG_PLAYERSTAT, myPlayerNum, currentStats);
+	PackPacket* packet = new PackPacket(2 + sizeof(CPlayer::Statistics), NETMSG_PLAYERSTAT);
+	*packet &lt;&lt; myPlayerNum &lt;&lt; currentStats;
+	SendData(packet);
 }
 
-
 void CBaseNetProtocol::SendGameOver()
 {
-	SendData(NETMSG_GAMEOVER);
+	SendData(new PackPacket(1, NETMSG_GAMEOVER));
 }
 
-
-
 // NETMSG_MAPDRAW = 31, uchar messageSize =  8, myPlayerNum, command = CInMapDraw::NET_ERASE; short x, z;
 void CBaseNetProtocol::SendMapErase(uchar myPlayerNum, short x, short z)
 {
-	SendData&lt;uchar, uchar, uchar, short, short&gt;(NETMSG_MAPDRAW, 8, myPlayerNum, CInMapDraw::NET_ERASE, x, z);
+	PackPacket* packet = new PackPacket(8, NETMSG_MAPDRAW);
+	*packet &lt;&lt; static_cast&lt;uchar&gt;(8) &lt;&lt; myPlayerNum &lt;&lt; static_cast&lt;uchar&gt;(CInMapDraw::NET_ERASE) &lt;&lt; x &lt;&lt; z;
+	SendData(packet);
 }
 
 // NETMSG_MAPDRAW = 31, uchar messageSize = 12, myPlayerNum, command = CInMapDraw::NET_LINE; short x1, z1, x2, z2;
 void CBaseNetProtocol::SendMapDrawLine(uchar myPlayerNum, short x1, short z1, short x2, short z2)
 {
-	SendData&lt;uchar, uchar, uchar, short, short, short, short&gt;(NETMSG_MAPDRAW, 12, myPlayerNum, CInMapDraw::NET_LINE, x1, z1, x2, z2);
+	PackPacket* packet = new PackPacket(12, NETMSG_MAPDRAW);
+	*packet &lt;&lt; static_cast&lt;uchar&gt;(12) &lt;&lt; myPlayerNum &lt;&lt; static_cast&lt;uchar&gt;(CInMapDraw::NET_LINE) &lt;&lt; x1 &lt;&lt; z1 &lt;&lt; x2 &lt;&lt; z2;
+	SendData(packet);
 }
 
 // NETMSG_MAPDRAW = 31, uchar messageSize, uchar myPlayerNum, command = CInMapDraw::NET_POINT; short x, z; std::string label;
 void CBaseNetProtocol::SendMapDrawPoint(uchar myPlayerNum, short x, short z, const std::string&amp; label)
 {
 	unsigned size = 8 + label.size() + 1;
-	PackPacket* packet = new PackPacket(size);
-	*packet &lt;&lt; static_cast&lt;uchar&gt;(NETMSG_MAPDRAW) &lt;&lt; static_cast&lt;uchar&gt;(size) &lt;&lt; myPlayerNum &lt;&lt; static_cast&lt;uchar&gt;(CInMapDraw::NET_POINT) &lt;&lt; x &lt;&lt; z &lt;&lt; label;
+	PackPacket* packet = new PackPacket(size, NETMSG_MAPDRAW);
+	*packet &lt;&lt; static_cast&lt;uchar&gt;(size) &lt;&lt; myPlayerNum &lt;&lt; static_cast&lt;uchar&gt;(CInMapDraw::NET_POINT) &lt;&lt; x &lt;&lt; z &lt;&lt; label;
 	SendData(packet);
 }
 
-
-
 void CBaseNetProtocol::SendSyncRequest(int frameNum)
 {
-	SendData&lt;int&gt;(NETMSG_SYNCREQUEST, frameNum);
+	PackPacket* packet = new PackPacket(5, NETMSG_SYNCREQUEST);
+	*packet &lt;&lt; frameNum;
+	SendData(packet);
 }
 
 void CBaseNetProtocol::SendSyncResponse(uchar myPlayerNum, int frameNum, uint checksum)
 {
-	SendData&lt;uchar, int, uint&gt;(NETMSG_SYNCRESPONSE, myPlayerNum, frameNum, checksum);
+	PackPacket* packet = new PackPacket(10, NETMSG_SYNCRESPONSE);
+	*packet &lt;&lt; myPlayerNum &lt;&lt; frameNum &lt;&lt; checksum;
+	SendData(packet);
 }
 
 void CBaseNetProtocol::SendSystemMessage(uchar myPlayerNum, const std::string&amp; message)
 {
 	unsigned size = 3 + message.size() + 1;
-	PackPacket* packet = new PackPacket(size);
-	*packet &lt;&lt; static_cast&lt;uchar&gt;(NETMSG_SYSTEMMSG) &lt;&lt; static_cast&lt;uchar&gt;(size) &lt;&lt; myPlayerNum &lt;&lt; message;
+	PackPacket* packet = new PackPacket(size, NETMSG_SYSTEMMSG);
+	*packet &lt;&lt; static_cast&lt;uchar&gt;(size) &lt;&lt; myPlayerNum &lt;&lt; message;
 	SendData(packet);
 }
 
 void CBaseNetProtocol::SendStartPos(uchar myPlayerNum, uchar teamNum, uchar ready, float x, float y, float z)
 {
-	SendData&lt;uchar, uchar, uchar, float, float, float&gt;(NETMSG_STARTPOS, myPlayerNum, teamNum, ready, x, y, z);
+	PackPacket* packet = new PackPacket(16, NETMSG_STARTPOS);
+	*packet &lt;&lt; myPlayerNum &lt;&lt; teamNum &lt;&lt; ready &lt;&lt; x &lt;&lt; y &lt;&lt; z;
+	SendData(packet);
 }
 
 void CBaseNetProtocol::SendPlayerInfo(uchar myPlayerNum, float cpuUsage, int ping)
 {
-	SendData&lt;uchar, float, int&gt;(NETMSG_PLAYERINFO, myPlayerNum, cpuUsage, ping);
+	PackPacket* packet = new PackPacket(10, NETMSG_PLAYERINFO);
+	*packet &lt;&lt; myPlayerNum &lt;&lt; cpuUsage &lt;&lt; ping;
+	SendData(packet);
 }
 
 void CBaseNetProtocol::SendPlayerLeft(uchar myPlayerNum, uchar bIntended)
 {
-	SendData&lt;uchar, uchar&gt;(NETMSG_PLAYERLEFT, myPlayerNum, bIntended);
+	PackPacket* packet = new PackPacket(3, NETMSG_PLAYERLEFT);
+	*packet &lt;&lt; myPlayerNum &lt;&lt; bIntended;
+	SendData(packet);
 }
 
 // NETMSG_LUAMSG = 50, uchar myPlayerNum; std::string modName; (e.g. `custom msg')
 void CBaseNetProtocol::SendLuaMsg(uchar myPlayerNum, uchar script, uchar mode,
                                   const std::string&amp; msg)
 {
-	// avoid the trailing '\0' processing
-	const unsigned short msgLen = msg.size() + 6;
-	const char* msgPtr = (char*) &msgLen;
-	std::string data;
-	data.push_back((char)NETMSG_LUAMSG);
-	data.push_back(msgPtr[0]);
-	data.push_back(msgPtr[1]);
-	data.push_back(myPlayerNum);
-	data.push_back(script);
-	data.push_back(mode);
-	data.append(msg);
-	SendData((const unsigned char*) data.data(), msgLen);
+	unsigned short size = 6 + msg.size()+1;
+	PackPacket* packet = new PackPacket(size, NETMSG_LUAMSG);
+	*packet &lt;&lt; size &lt;&lt; myPlayerNum &lt;&lt; script &lt;&lt; mode &lt;&lt; msg;
+	SendData(packet);
 }
 
 void CBaseNetProtocol::SendSelfD(uchar myPlayerNum)
 {
-	unsigned char msg[4] = {NETMSG_TEAM, myPlayerNum, TEAMMSG_SELFD, 0};
-	SendData(msg, 4);
+	PackPacket* packet = new PackPacket(4, NETMSG_TEAM);
+	*packet &lt;&lt; myPlayerNum &lt;&lt; static_cast&lt;uchar&gt;(TEAMMSG_SELFD) &lt;&lt; static_cast&lt;uchar&gt;(0);
+	SendData(packet);
 }
 
 void CBaseNetProtocol::SendGiveAwayEverything(uchar myPlayerNum, uchar giveTo)
 {
-	unsigned char msg[4] = {NETMSG_TEAM, myPlayerNum, TEAMMSG_GIVEAWAY, giveTo};
-	SendData(msg, 4);
+	PackPacket* packet = new PackPacket(4, NETMSG_TEAM);
+	*packet &lt;&lt; myPlayerNum &lt;&lt; static_cast&lt;uchar&gt;(TEAMMSG_GIVEAWAY) &lt;&lt; giveTo;
+	SendData(packet);
 }
 
 void CBaseNetProtocol::SendResign(uchar myPlayerNum)
 {
-	unsigned char msg[4] = {NETMSG_TEAM, myPlayerNum, TEAMMSG_RESIGN, 0};
-	SendData(msg, 4);
+	PackPacket* packet = new PackPacket(4, NETMSG_TEAM);
+	*packet &lt;&lt; myPlayerNum &lt;&lt; static_cast&lt;uchar&gt;(TEAMMSG_RESIGN) &lt;&lt; static_cast&lt;uchar&gt;(0);
+	SendData(packet);
 }
 
 void CBaseNetProtocol::SendJoinTeam(uchar myPlayerNum, uchar wantedTeamNum)
 {
-	unsigned char msg[4] = {NETMSG_TEAM, myPlayerNum, TEAMMSG_JOIN_TEAM, wantedTeamNum};
-	SendData(msg, 4);
+	PackPacket* packet = new PackPacket(4, NETMSG_TEAM);
+	*packet &lt;&lt; myPlayerNum &lt;&lt; static_cast&lt;uchar&gt;(TEAMMSG_JOIN_TEAM) &lt;&lt; wantedTeamNum;
+	SendData(packet);
 }
 
 void CBaseNetProtocol::SendTeamDied(uchar myPlayerNum, uchar whichTeam)
 {
-	unsigned char msg[4] = {NETMSG_TEAM, myPlayerNum, TEAMMSG_TEAM_DIED, whichTeam};
-	SendData(msg, 4);
+	PackPacket* packet = new PackPacket(4, NETMSG_TEAM);
+	*packet &lt;&lt; myPlayerNum &lt;&lt; static_cast&lt;uchar&gt;(TEAMMSG_TEAM_DIED) &lt;&lt; whichTeam;
+	SendData(packet);
 }
 
 void CBaseNetProtocol::SendSetAllied(uchar myPlayerNum, uchar whichAllyTeam, uchar state)
 {
-	unsigned char msg[4] = {NETMSG_ALLIANCE, myPlayerNum, whichAllyTeam, state};
-	SendData(msg, 4);
+	PackPacket* packet = new PackPacket(4, NETMSG_ALLIANCE);
+	*packet &lt;&lt; myPlayerNum &lt;&lt; whichAllyTeam &lt;&lt; state;
+	SendData(packet);
 }
 
 /* FIXME: add these:

Modified: trunk/rts/System/BaseNetProtocol.h
===================================================================
--- trunk/rts/System/BaseNetProtocol.h	2008-05-16 01:17:06 UTC (rev 5894)
+++ trunk/rts/System/BaseNetProtocol.h	2008-05-16 18:14:35 UTC (rev 5895)
@@ -102,13 +102,6 @@
 	CBaseNetProtocol();
 	~CBaseNetProtocol();
 
-	/**
-	@brief  Broadcast raw data to all clients
-	Should not be used. Use Send*(...) instead, only redirects to CNet::SendData(char*, int);
-	@todo make everything use the Send* functions
-	*/
-	void RawSend(const uchar* data,const unsigned length);
-
 	void SendKeyFrame(int frameNum);
 	void SendNewFrame();
 	void SendQuit();
@@ -124,7 +117,6 @@
 	void SendPause(uchar myPlayerNum, uchar bPaused);
 
 	void SendAICommand(uchar myPlayerNum, short unitID, int id, uchar options, const std::vector&lt;float&gt;&amp; params);
-	void SendAICommands(uchar myPlayerNum, short unitIDCount, ...);
 	void SendAIShare(uchar myPlayerNum, uchar sourceTeam, uchar destTeam, float metal, float energy, const std::vector&lt;short&gt;&amp; unitIDs);
 
 	void SendUserSpeed(uchar myPlayerNum, float userSpeed);

Modified: trunk/rts/System/Net/Connection.h
===================================================================
--- trunk/rts/System/Net/Connection.h	2008-05-16 01:17:06 UTC (rev 5894)
+++ trunk/rts/System/Net/Connection.h	2008-05-16 18:14:35 UTC (rev 5895)
@@ -2,6 +2,7 @@
 #define CONNECTION_H
 
 #include &lt;string&gt;
+#include &lt;boost/shared_ptr.hpp&gt;
 
 #include &quot;RawPacket.h&quot;
 
@@ -25,8 +26,7 @@
 	CConnection();
 	virtual ~CConnection();
 	
-	virtual void SendData(const unsigned char *data, const unsigned length)=0;
-	virtual void SendData(const RawPacket* data)=0;
+	virtual void SendData(boost::shared_ptr&lt;const RawPacket&gt; data)=0;
 
 	/**
 	@brief Take a look at the messages that will be returned by GetData().
@@ -34,13 +34,13 @@
 	@param ahead How many packets to look ahead. A typical usage would be:
 	for (int ahead = 0; (packet = conn-&gt;Peek(ahead)) != NULL; ++ahead) {}
 	*/
-	virtual const RawPacket* Peek(unsigned ahead) const = 0;
+	virtual boost::shared_ptr&lt;const RawPacket&gt; Peek(unsigned ahead) const = 0;
 	
 	/**
 	@brief New method of data gathering
 	@return A RawPacket holding the data, or 0 if no data
 	*/
-	virtual RawPacket* GetData()=0;
+	virtual boost::shared_ptr&lt;const RawPacket&gt; GetData()=0;
 
 	virtual void Flush(const bool forced = false)=0;
 	virtual bool CheckTimeout() const = 0;

Modified: trunk/rts/System/Net/LocalConnection.cpp
===================================================================
--- trunk/rts/System/Net/LocalConnection.cpp	2008-05-16 01:17:06 UTC (rev 5894)
+++ trunk/rts/System/Net/LocalConnection.cpp	2008-05-16 18:14:35 UTC (rev 5895)
@@ -9,7 +9,7 @@
 
 // static stuff
 unsigned CLocalConnection::Instances = 0;
-CLocalConnection::MsgQueue CLocalConnection::Data[2];
+std::deque&lt; boost::shared_ptr&lt;const RawPacket&gt; &gt; CLocalConnection::Data[2];
 boost::mutex CLocalConnection::Mutex[2];
 
 CLocalConnection::CLocalConnection()
@@ -25,48 +25,44 @@
 CLocalConnection::~CLocalConnection()
 {
 	Instances--;
-	while (!Data[instance].empty())
-	{
-		delete Data[instance].front();
-		Data[instance].pop_front();
-	}
 }
 
-void CLocalConnection::SendData(const unsigned char *data, const unsigned length)
+void CLocalConnection::SendData(boost::shared_ptr&lt;const RawPacket&gt; data)
 {
-	SendData(new RawPacket(data, length));
-}
-
-void CLocalConnection::SendData(const RawPacket* data)
-{
 	dataSent += data-&gt;length;
 	boost::mutex::scoped_lock scoped_lock(Mutex[OtherInstance()]);
 	Data[OtherInstance()].push_back(data);
 }
 
-const RawPacket* CLocalConnection::Peek(unsigned ahead) const
+boost::shared_ptr&lt;const RawPacket&gt; CLocalConnection::Peek(unsigned ahead) const
 {
 	boost::mutex::scoped_lock scoped_lock(Mutex[instance]);
 
 	if (ahead &lt; Data[instance].size())
 		return Data[instance][ahead];
-
-	return NULL;
+	else
+	{
+		boost::shared_ptr&lt;const RawPacket&gt; empty;
+		return empty;
+	}
 }
 
-RawPacket* CLocalConnection::GetData()
+boost::shared_ptr&lt;const RawPacket&gt; CLocalConnection::GetData()
 {
 	boost::mutex::scoped_lock scoped_lock(Mutex[instance]);
 	
 	if (!Data[instance].empty())
 	{
-		const RawPacket* next = Data[instance].front();
+		boost::shared_ptr&lt;const RawPacket&gt; next = Data[instance].front();
 		Data[instance].pop_front();
 		dataRecv += next-&gt;length;
-		return const_cast&lt;RawPacket*&gt;(next);
+		return next;
 	}
 	else
-		return NULL;
+	{
+		boost::shared_ptr&lt;const RawPacket&gt; empty;
+		return empty;
+	}
 }
 
 void CLocalConnection::Flush(const bool forced)

Modified: trunk/rts/System/Net/LocalConnection.h
===================================================================
--- trunk/rts/System/Net/LocalConnection.h	2008-05-16 01:17:06 UTC (rev 5894)
+++ trunk/rts/System/Net/LocalConnection.h	2008-05-16 18:14:35 UTC (rev 5895)
@@ -25,23 +25,18 @@
 	virtual ~CLocalConnection();
 	
 	/**
-	@brief Send data to other instance
-	*/
-	virtual void SendData(const unsigned char *data, const unsigned length);
-	
-	/**
 	@brief Send packet to other instance
 	
 	Use this, since it doesn't need memcpy'ing
 	 */
-	virtual void SendData(const RawPacket* data);
+	virtual void SendData(boost::shared_ptr&lt;const RawPacket&gt; data);
 
-	virtual const RawPacket* Peek(unsigned ahead) const;
+	virtual boost::shared_ptr&lt;const RawPacket&gt; Peek(unsigned ahead) const;
 
 	/**
 	@brief Get data
 	*/
-	virtual RawPacket* GetData();
+	virtual boost::shared_ptr&lt;const RawPacket&gt; GetData();
 
 	/// does nothing
 	virtual void Flush(const bool forced = false);
@@ -53,9 +48,7 @@
 	virtual NetAddress GetPeerName() const;
 
 private:
-	typedef std::deque&lt;const RawPacket*&gt; MsgQueue;
-
-	static MsgQueue Data[2];
+	static std::deque&lt; boost::shared_ptr&lt;const RawPacket&gt; &gt; Data[2];
 	static boost::mutex Mutex[2];
 
 	unsigned OtherInstance() const;

Modified: trunk/rts/System/Net/Net.cpp
===================================================================
--- trunk/rts/System/Net/Net.cpp	2008-05-16 01:17:06 UTC (rev 5894)
+++ trunk/rts/System/Net/Net.cpp	2008-05-16 18:14:35 UTC (rev 5895)
@@ -130,7 +130,7 @@
 	return connections[number]-&gt;GetPeerName();
 }
 
-const RawPacket* CNet::Peek(const unsigned conNum, unsigned ahead) const
+boost::shared_ptr&lt;const RawPacket&gt; CNet::Peek(const unsigned conNum, unsigned ahead) const
 {
 	if (int(conNum) &lt;= MaxConnectionID() &amp;&amp; (bool)connections[conNum])
 	{
@@ -142,7 +142,7 @@
 	}
 }
 
-RawPacket* CNet::GetData(const unsigned conNum)
+boost::shared_ptr&lt;const RawPacket&gt; CNet::GetData(const unsigned conNum)
 {
 	if (int(conNum) &lt;= MaxConnectionID() &amp;&amp; (bool)connections[conNum])
 	{
@@ -154,12 +154,12 @@
 	}
 }
 
-void CNet::SendData(const unsigned char *data, const unsigned length)
+void CNet::SendData(boost::shared_ptr&lt;const RawPacket&gt; data)
 {
 #ifdef DEBUG
 	{
 		unsigned int msglength = 0;
-		unsigned char msgid = data[0];
+		unsigned char msgid = data-&gt;data[0];
 		ProtocolDef* proto = ProtocolDef::instance();
 		if (proto-&gt;HasFixedLength(msgid))
 		{
@@ -170,58 +170,33 @@
 			int length_t = proto-&gt;GetLength(msgid);
 			if (length_t == -1)
 			{
-				msglength = (unsigned int)data[1];
+				msglength = (unsigned int)(data-&gt;data[1]);
 			}
 			else if (length_t == -2)
 			{
-				msglength = *((short*)(data+1));
+				msglength = *((short*)(data-&gt;data+1));
 			}
 		}
 		
-		if (length != msglength || length == 0)
+		if (data-&gt;length != msglength || data-&gt;length == 0)
 		{
-			throw network_error( str( boost::format(&quot;Message length error (ID %1% with length %2% should be %3%) while sending (CNet::SendData(char*, unsigned))&quot;) % (unsigned int)data[0] % length % msglength ) );
+			throw network_error( str( boost::format(&quot;Message length error (ID %1% with length %2% should be %3%) while sending (CNet::SendData(char*, unsigned))&quot;) % (unsigned int)(data-&gt;data[0]) % data-&gt;length % msglength ) );
 		}
 	}
 #endif
-
 	for (connVec::iterator it = connections.begin(); it != connections.end(); ++it)
 	{
-		if(*it){
-			(*it)-&gt;SendData(data,length);
-		}
+		if(*it)
+			(*it)-&gt;SendData(data);
 	}
 }
 
-void CNet::SendData(const RawPacket* data)
+void CNet::SendData(boost::shared_ptr&lt;const RawPacket&gt; data, const unsigned playerNum)
 {
-	SendData(data-&gt;data, data-&gt;length);
-	delete data;
-}
-
-void CNet::SendData(const unsigned char* data,const unsigned length, const unsigned playerNum)
-{
 	if (int(playerNum) &lt;= MaxConnectionID() &amp;&amp; connections[playerNum])
-	{
-		connections[playerNum]-&gt;SendData(data,length);
-	}
-	else
-	{
-		throw network_error(&quot;Cant send data (wrong connection number)&quot;);
-	}
-}
-
-void CNet::SendData(const RawPacket* data, const unsigned playerNum)
-{
-	if (int(playerNum) &lt;= MaxConnectionID() &amp;&amp; connections[playerNum])
-	{
 		connections[playerNum]-&gt;SendData(data);
-	}
 	else
-	{
-		delete data;
-		throw network_error(&quot;Cant send data (wrong connection number)&quot;);
-	}
+		throw network_error(&quot;Can't send data (wrong connection number)&quot;);
 }
 
 void CNet::FlushNet()
@@ -296,23 +271,17 @@
 	return (localConnBuf || (udplistener &amp;&amp; udplistener-&gt;HasIncomingConnections()));
 }
 
-RawPacket* CNet::GetData()
+boost::shared_ptr&lt;const RawPacket&gt; CNet::GetData()
 {
 	if (localConnBuf)
-	{
-		RawPacket* data = localConnBuf-&gt;GetData();
-		return data;
-	}
+		return localConnBuf-&gt;GetData();
 	else if (udplistener &amp;&amp; udplistener-&gt;HasIncomingConnections())
 	{
 		boost::shared_ptr&lt;UDPConnection&gt; locked(udplistener-&gt;PreviewConnection());
-		RawPacket* data = locked-&gt;GetData();
-		return data;
+		return locked-&gt;GetData();
 	}
 	else
-	{
 		throw network_error(&quot;No Connection waiting (no data recieved)&quot;);
-	}
 }
 
 unsigned CNet::AcceptIncomingConnection(const unsigned wantedNumber)

Modified: trunk/rts/System/Net/Net.h
===================================================================
--- trunk/rts/System/Net/Net.h	2008-05-16 01:17:06 UTC (rev 5894)
+++ trunk/rts/System/Net/Net.h	2008-05-16 18:14:35 UTC (rev 5895)
@@ -137,40 +137,39 @@
 	@return A RawPacket holding the data, or 0 if no data
 	@param conNum The number to recieve from
 	@param ahead How many packets to look ahead. A typical usage would be:
-	for (int ahead = 0; (packet = net-&gt;Peek(conNum, ahead)) != NULL; ++ahead) {}
+	for (int ahead = 0; (packet = net-&gt;Peek(conNum, ahead)); ++ahead) {}
 	*/
-	const RawPacket* Peek(const unsigned conNum, unsigned ahead) const;
+	boost::shared_ptr&lt;const RawPacket&gt; Peek(const unsigned conNum, unsigned ahead) const;
 
 	/**
 	@brief Recieve data from a client
 	@param conNum The number to recieve from
-	@return a RawPacket* with the data inside (or 0 when there is no data) (YOU! need to delete it after using)
+	@return a smart RawPacket pointer with the data inside (or empty when no data)
 	@throw network_error When conNum is not a valid connection ID
 	*/
-	RawPacket* GetData(const unsigned conNum);
+	boost::shared_ptr&lt;const RawPacket&gt; GetData(const unsigned conNum);
 	
 	/**
 	@brief Broadcast data to all clients
-	@param data The data
-	@param length length of the data
+	@param data The smart packet pointer
 	@throw network_error Only when DEBUG is set: When the message identifier (data[0]) is not registered (through RegisterMessage())
 	*/
-	void SendData(const unsigned char* data,const unsigned length);
-	void SendData(const RawPacket* data);
-	
+	void SendData(boost::shared_ptr&lt;const RawPacket&gt; data);
+	void SendData(const RawPacket* const data)
+	{
+		SendData(boost::shared_ptr&lt;const RawPacket&gt;(data));
+	};
+
 	/**
 	@brief Send data to one client in particular
+	@param data The smart packet pointer
 	@throw network_error When playerNum is no valid connection ID
-	*/
-	void SendData(const unsigned char* data,const unsigned length, const unsigned playerNum);
-	
-	/**
-	@brief Send data to one client in particular
-	@param data the RawPacket I will take care of, DO NOT DELETE IT
-	@throw network_error When playerNum is no valid connection ID
-	@todo there are too much SendData functions here
 	 */
-	void SendData(const RawPacket* data, const unsigned playerNum);
+	void SendData(boost::shared_ptr&lt;const RawPacket&gt; data, const unsigned playerNum);
+	void SendData(const RawPacket* const data, const unsigned playerNum)
+	{
+		SendData(boost::shared_ptr&lt;const RawPacket&gt;(data), playerNum);
+	};
 	
 	/**
 	@brief send all waiting data
@@ -189,7 +188,7 @@
 	bool HasIncomingConnection() const;
 	
 	/// Recieve data from first unbound connection to check if we allow him in our game
-	RawPacket* GetData();
+	boost::shared_ptr&lt;const RawPacket&gt; GetData();
 	
 	/// everything seems fine, accept him
 	unsigned AcceptIncomingConnection(const unsigned wantedNumber=0);
@@ -197,97 +196,6 @@
 	/// we dont want you in our game
 	void RejectIncomingConnection();
 	
-protected:
-	/** Send a net message without any parameters. */
-	void SendData(const unsigned char msg) {
-		SendData(&amp;msg, sizeof(msg));
-	}
-
-	/** Send a net message with one parameter. */
-	template&lt;typename A&gt;
-	void SendData(const unsigned char msg, const A a) {
-		const int size = 1 + sizeof(A);
-		unsigned char buf[size];
-		buf[0] = msg;
-		*(A*)&amp;buf[1] = a;
-		SendData(buf, size);
-	}
-
-	template&lt;typename A, typename B&gt;
-	void SendData(const unsigned char msg, const A a, const B b) {
-		const int size = 1 + sizeof(A) + sizeof(B);
-		unsigned char buf[size];
-		buf[0] = msg;
-		*(A*)&amp;buf[1] = a;
-		*(B*)&amp;buf[1 + sizeof(A)] = b;
-		SendData(buf, size);
-	}
-
-	template&lt;typename A, typename B, typename C&gt;
-	void SendData(const unsigned char msg, const A a, const B b, const C c) {
-		const int size = 1 + sizeof(A) + sizeof(B) + sizeof(C);
-		unsigned char buf[size];
-		buf[0] = msg;
-		*(A*)&amp;buf[1] = a;
-		*(B*)&amp;buf[1 + sizeof(A)] = b;
-		*(C*)&amp;buf[1 + sizeof(A) + sizeof(B)] = c;
-		SendData(buf, size);
-	}
-
-	template&lt;typename A, typename B, typename C, typename D&gt;
-	void SendData(const unsigned char msg, const A a, const B b, const C c, const D d) {
-		const int size = 1 + sizeof(A) + sizeof(B) + sizeof(C) + sizeof(D);
-		unsigned char buf[size];
-		buf[0] = msg;
-		*(A*)&amp;buf[1] = a;
-		*(B*)&amp;buf[1 + sizeof(A)] = b;
-		*(C*)&amp;buf[1 + sizeof(A) + sizeof(B)] = c;
-		*(D*)&amp;buf[1 + sizeof(A) + sizeof(B) + sizeof(C)] = d;
-		SendData(buf, size);
-	}
-
-	template&lt;typename A, typename B, typename C, typename D, typename E&gt;
-	void SendData(const unsigned char msg, A a, B b, C c, D d, E e) {
-		const int size = 1 + sizeof(A) + sizeof(B) + sizeof(C) + sizeof(D) + sizeof(E);
-		unsigned char buf[size];
-		buf[0] = msg;
-		*(A*)&amp;buf[1] = a;
-		*(B*)&amp;buf[1 + sizeof(A)] = b;
-		*(C*)&amp;buf[1 + sizeof(A) + sizeof(B)] = c;
-		*(D*)&amp;buf[1 + sizeof(A) + sizeof(B) + sizeof(C)] = d;
-		*(E*)&amp;buf[1 + sizeof(A) + sizeof(B) + sizeof(C) + sizeof(D)] = e;
-		SendData(buf, size);
-	}
-
-	template&lt;typename A, typename B, typename C, typename D, typename E, typename F&gt;
-	void SendData(const unsigned char msg, A a, B b, C c, D d, E e, F f) {
-		const int size = 1 + sizeof(A) + sizeof(B) + sizeof(C) + sizeof(D) + sizeof(E) + sizeof(F);
-		unsigned char buf[size];
-		buf[0] = msg;
-		*(A*)&amp;buf[1] = a;
-		*(B*)&amp;buf[1 + sizeof(A)] = b;
-		*(C*)&amp;buf[1 + sizeof(A) + sizeof(B)] = c;
-		*(D*)&amp;buf[1 + sizeof(A) + sizeof(B) + sizeof(C)] = d;
-		*(E*)&amp;buf[1 + sizeof(A) + sizeof(B) + sizeof(C) + sizeof(D)] = e;
-		*(F*)&amp;buf[1 + sizeof(A) + sizeof(B) + sizeof(C) + sizeof(D) + sizeof(E)] = f;
-		SendData(buf, size);
-	}
-
-	template&lt;typename A, typename B, typename C, typename D, typename E, typename F, typename G&gt;
-	void SendData(const unsigned char msg, A a, B b, C c, D d, E e, F f, G g) {
-		const int size = 1 + sizeof(A) + sizeof(B) + sizeof(C) + sizeof(D) + sizeof(E) + sizeof(F) + sizeof(G);
-		unsigned char buf[size];
-		buf[0] = msg;
-		*(A*)&amp;buf[1] = a;
-		*(B*)&amp;buf[1 + sizeof(A)] = b;
-		*(C*)&amp;buf[1 + sizeof(A) + sizeof(B)] = c;
-		*(D*)&amp;buf[1 + sizeof(A) + sizeof(B) + sizeof(C)] = d;
-		*(E*)&amp;buf[1 + sizeof(A) + sizeof(B) + sizeof(C) + sizeof(D)] = e;
-		*(F*)&amp;buf[1 + sizeof(A) + sizeof(B) + sizeof(C) + sizeof(D) + sizeof(E)] = f;
-		*(G*)&amp;buf[1 + sizeof(A) + sizeof(B) + sizeof(C) + sizeof(D) + sizeof(E) + sizeof(F)] = g;
-		SendData(buf, size);
-	}
-	
 private:
 	typedef boost::shared_ptr&lt;CConnection&gt; connPtr;
 	typedef std::vector&lt; connPtr &gt; connVec;

Modified: trunk/rts/System/Net/PackPacket.cpp
===================================================================
--- trunk/rts/System/Net/PackPacket.cpp	2008-05-16 01:17:06 UTC (rev 5894)
+++ trunk/rts/System/Net/PackPacket.cpp	2008-05-16 18:14:35 UTC (rev 5895)
@@ -7,6 +7,11 @@
 {
 }
 
+PackPacket::PackPacket(const unsigned length, unsigned char msgID) : RawPacket(length), pos(0)
+{
+	*this &lt;&lt; msgID;
+}
+
 PackPacket&amp; PackPacket::operator&lt;&lt;(const std::string&amp; text)
 {
 	unsigned size = text.size()+1;

Modified: trunk/rts/System/Net/PackPacket.h
===================================================================
--- trunk/rts/System/Net/PackPacket.h	2008-05-16 01:17:06 UTC (rev 5894)
+++ trunk/rts/System/Net/PackPacket.h	2008-05-16 18:14:35 UTC (rev 5895)
@@ -15,6 +15,7 @@
 {
 public:
 	PackPacket(const unsigned length);
+	PackPacket(const unsigned length, unsigned char msgID);
 	
 	template &lt;typename T&gt;
 	PackPacket&amp; operator&lt;&lt;(const T&amp; t) {
@@ -36,6 +37,8 @@
 		return *this;
 	};
 	
+	unsigned char* GetWritingPos() {return data+pos;};
+	
 private:
 	unsigned pos;
 };

Modified: trunk/rts/System/Net/Test/CMakeLists.txt
===================================================================
--- trunk/rts/System/Net/Test/CMakeLists.txt	2008-05-16 01:17:06 UTC (rev 5894)
+++ trunk/rts/System/Net/Test/CMakeLists.txt	2008-05-16 18:14:35 UTC (rev 5895)
@@ -1,8 +1,8 @@
 PROJECT(UnitTester)
 SET(CMAKE_CXX_FLAGS &quot;-g -O1 -Wall&quot;)
 INCLUDE_DIRECTORIES(../ /usr/include/SDL)
-ADD_DEFINITIONS(-DDEBUG)
+ADD_DEFINITIONS(-DDEBUG -D_DEBUG)
 
-AUX_SOURCE_DIRECTORY(../ netfiles)
+AUX_SOURCE_DIRECTORY(${CMAKE_CURRENT_SOURCE_DIR}/../ netfiles)
 ADD_EXECUTABLE(UnitTest main ${netfiles})
 TARGET_LINK_LIBRARIES(UnitTest SDL boost_thread)

Modified: trunk/rts/System/Net/Test/main.cpp
===================================================================
--- trunk/rts/System/Net/Test/main.cpp	2008-05-16 01:17:06 UTC (rev 5894)
+++ trunk/rts/System/Net/Test/main.cpp	2008-05-16 18:14:35 UTC (rev 5895)
@@ -2,10 +2,11 @@
 #include &lt;string.h&gt;
 #include &lt;iostream&gt;
 #include &lt;assert.h&gt;
+#include &lt;boost/shared_ptr.hpp&gt;
 
 const unsigned int serverportnum = 5000;
-RawPacket* data1 = 0;
-RawPacket* data2 = 0;
+boost::shared_ptr&lt;const netcode::RawPacket&gt; data1;
+boost::shared_ptr&lt;const netcode::RawPacket&gt; data2;
 
 bool TestLocal(netcode::CNet* server, unsigned freeNumber)
 {
@@ -22,26 +23,24 @@
 	localclient-&gt;Update();
 	
 	
-	localclient-&gt;SendData(data1-&gt;data, data1-&gt;length);
+	localclient-&gt;SendData(data1);
 	localclient-&gt;FlushNet();
 	server-&gt;Update();
 	localclient-&gt;Update();
-	RawPacket* ret = server-&gt;GetData(0);
+	boost::shared_ptr&lt;const netcode::RawPacket&gt; ret = server-&gt;GetData(0);
 	if (!ret || ret-&gt;length != 10 || (int)ret-&gt;data[1] != 6)
 	{
-		std::cout &lt;&lt; &quot;Server dont recieved message&quot; &lt;&lt; std::endl;
+		std::cout &lt;&lt; &quot;Server dont recieved message&quot; &lt;&lt; ret-&gt;length &lt;&lt; std::endl;
 		return false;
 	}
-	delete ret; ret = 0;
-	
-	server-&gt;SendData(data1-&gt;data, data1-&gt;length);
+		
+	server-&gt;SendData(data1);
 	ret = localclient-&gt;GetData(0);
 	if (!ret || ret-&gt;length != 10 || (int)ret-&gt;data[1] != 6)
 	{
 		std::cout &lt;&lt; &quot;Client dont recieved message&quot; &lt;&lt; std::endl;
 		return false;
 	}
-	delete ret; ret = 0;
 	
 	std::cout &lt;&lt; localclient-&gt;GetConnectionStatistics(0);
 	delete localclient;
@@ -57,12 +56,12 @@
 	unsigned char buffer[10];
 	memset(buffer, 0, 10);
 	buffer[1] = 6;
-	data1 = new RawPacket(buffer, 10);
+	data1.reset(new RawPacket(buffer, 10));
 	
 	unsigned char bigbuffer[1000];
 	memset(bigbuffer, 0, 1000);
 	bigbuffer[0]=2;
-	data2 = new RawPacket(bigbuffer, 1000);
+	data2.reset(new RawPacket(bigbuffer, 1000));
 	
 	std::cout &lt;&lt; &quot;Starting Server and local Client&quot; &lt;&lt; std::endl;
 	netcode::CNet* server = new netcode::CNet();
@@ -73,7 +72,7 @@
 	server-&gt;RegisterMessage((unsigned char)0, 10);
 	server-&gt;RegisterMessage((unsigned char)1, 100);
 	server-&gt;RegisterMessage((unsigned char)2, 1000);
-	server-&gt;SendData(data1-&gt;data, data1-&gt;length);
+	server-&gt;SendData(data1);
 	
 	if (!TestLocal(server, 0))
 	{
@@ -90,21 +89,21 @@
 	client-&gt;RegisterMessage((unsigned char)2, 1000);
 	
 	{
-		client-&gt;SendData(data1-&gt;data, data1-&gt;length);
+		client-&gt;SendData(data1);
 		client-&gt;Update();
 		server-&gt;Update();
 		server-&gt;AcceptIncomingConnection(1);
 		server-&gt;Update();
-		RawPacket* ret  = server-&gt;GetData(1);
+		boost::shared_ptr&lt;const netcode::RawPacket&gt; ret  = server-&gt;GetData(1);
 		if (ret)
 		{
 			std::cout &lt;&lt; &quot;Recieved &quot; &lt;&lt; ret-&gt;length &lt;&lt; &quot; bytes UDP client message &quot; &lt;&lt; (int)ret-&gt;data[1] &lt;&lt; std::endl;
-			delete ret; ret = 0;
+			ret.reset();
 		}
 		else
 			return 1;
 		
-		server-&gt;SendData(data1-&gt;data, data1-&gt;length);
+		server-&gt;SendData(data1);
 		sleep(1);	// buffer wont be flushed without this
 		server-&gt;Update();
 		client-&gt;Update();
@@ -113,12 +112,12 @@
 		if (ret)
 		{
 			std::cout &lt;&lt; &quot;Recieved &quot; &lt;&lt; ret-&gt;length &lt;&lt; &quot; bytes UDP server message &quot; &lt;&lt; (int)ret-&gt;data[1] &lt;&lt; std::endl;
-			delete ret; ret = 0;
+			ret.reset();
 		}
 		else
 			return 1;
 		
-		client-&gt;SendData(data2-&gt;data, data2-&gt;length);
+		client-&gt;SendData(data2);
 		server-&gt;Update();
 		client-&gt;Update();
 		server-&gt;Update();
@@ -126,7 +125,7 @@
 		if (ret)
 		{
 			std::cout &lt;&lt; &quot;Recieved &quot; &lt;&lt; ret-&gt;length &lt;&lt; &quot; bytes UDP client message&quot; &lt;&lt; std::endl;
-			delete ret; ret = 0;
+			ret.reset();
 		}
 		else
 			return 1;
@@ -140,7 +139,5 @@
 	delete server;
 	std::cout &lt;&lt; client-&gt;GetConnectionStatistics(1);
 	delete client;
-	
-	delete data1; delete data2; // so valgrind doesn't complain
 	return 0;
 }

Modified: trunk/rts/System/Net/UDPConnection.cpp
===================================================================
--- trunk/rts/System/Net/UDPConnection.cpp	2008-05-16 01:17:06 UTC (rev 5894)
+++ trunk/rts/System/Net/UDPConnection.cpp	2008-05-16 18:14:35 UTC (rev 5895)
@@ -35,48 +35,41 @@
 {
 	if (fragmentBuffer)
 		delete fragmentBuffer;
-
-	while (!msgQueue.empty())
-	{
-		delete msgQueue.front();
-		msgQueue.pop_front();
-	}
 }
 
-void UDPConnection::SendData(const unsigned char *data, const unsigned length)
+void UDPConnection::SendData(boost::shared_ptr&lt;const RawPacket&gt; data)
 {
-	if(outgoingLength+length&gt;=UDPBufferSize){
+	if(outgoingLength + data-&gt;length &gt;= UDPBufferSize){
 		throw network_error(&quot;Buffer overflow in UDPConnection (SendData)&quot;);
 	}
-	memcpy(&amp;outgoingData[outgoingLength],data,length);
-	outgoingLength+=length;
+	memcpy(&amp;outgoingData[outgoingLength], data-&gt;data, data-&gt;length);
+	outgoingLength += data-&gt;length;
 }
 
-void UDPConnection::SendData(const RawPacket* data)
+boost::shared_ptr&lt;const RawPacket&gt; UDPConnection::Peek(unsigned ahead) const
 {
-	//TODO make UDPConnection completely packet-based
-	SendData(data-&gt;data, data-&gt;length);
-	delete data;
-}
-
-const RawPacket* UDPConnection::Peek(unsigned ahead) const
-{
 	if (ahead &lt; msgQueue.size())
 		return msgQueue[ahead];
-
-	return NULL;
+	else
+	{
+		boost::shared_ptr&lt;const RawPacket&gt; empty;
+		return empty;
+	}
 }
 
-RawPacket* UDPConnection::GetData()
+boost::shared_ptr&lt;const RawPacket&gt; UDPConnection::GetData()
 {
 	if (!msgQueue.empty())
 	{
-		RawPacket* msg = msgQueue.front();
+		boost::shared_ptr&lt;const RawPacket&gt; msg = msgQueue.front();
 		msgQueue.pop_front();
 		return msg;
 	}
 	else
-		return NULL;
+	{
+		boost::shared_ptr&lt;const RawPacket&gt; empty;
+		return empty;
+	}
 }
 
 void UDPConnection::Update()
@@ -214,7 +207,7 @@
 				if (bufLength &gt;= pos + msglength)
 				{
 					// yes =&gt; add to msgQueue and keep going
-					msgQueue.push_back(new RawPacket(buf + pos, msglength));
+					msgQueue.push_back(boost::shared_ptr&lt;const RawPacket&gt;(new RawPacket(buf + pos, msglength)));
 					pos += msglength;
 				}
 				else

Modified: trunk/rts/System/Net/UDPConnection.h
===================================================================
--- trunk/rts/System/Net/UDPConnection.h	2008-05-16 01:17:06 UTC (rev 5894)
+++ trunk/rts/System/Net/UDPConnection.h	2008-05-16 18:14:35 UTC (rev 5895)
@@ -32,22 +32,19 @@
 	UDPConnection(boost::shared_ptr&lt;UDPSocket&gt; NetSocket, const std::string&amp; address, const unsigned port);
 	virtual ~UDPConnection();
 
-	/// use this if you want data to be sent
-	virtual void SendData(const unsigned char *data, const unsigned length);
-	
 	/**
 	@brief Send packet to other instance
 	*/
-	virtual void SendData(const RawPacket* data);
+	virtual void SendData(boost::shared_ptr&lt;const RawPacket&gt; data);
 
-	virtual const RawPacket* Peek(unsigned ahead) const;
+	virtual boost::shared_ptr&lt;const RawPacket&gt; Peek(unsigned ahead) const;
 
 	/**
 	@brief use this to recieve ready data
 	@return a network message encapsulated in a RawPacket,
 	or NULL if there are no more messages available.
 	*/
-	virtual RawPacket* GetData();
+	virtual boost::shared_ptr&lt;const RawPacket&gt; GetData();
 
 	/**
 	@brief update internals
@@ -76,8 +73,6 @@
 	static const unsigned hsize;
 
 private:
-	typedef std::deque&lt;RawPacket*&gt; MsgQueue;
-
 	void Init();
 	
 	unsigned lastSendTime;
@@ -105,7 +100,7 @@
 	int lastInOrder;
 	int lastNak;
 	unsigned lastNakTime;
-	MsgQueue msgQueue;
+	std::deque&lt; boost::shared_ptr&lt;const RawPacket&gt; &gt; msgQueue;
 
 	/** Our socket.
 	*/

Modified: trunk/rts/System/Net/UnpackPacket.cpp
===================================================================
--- trunk/rts/System/Net/UnpackPacket.cpp	2008-05-16 01:17:06 UTC (rev 5894)
+++ trunk/rts/System/Net/UnpackPacket.cpp	2008-05-16 18:14:35 UTC (rev 5895)
@@ -3,7 +3,7 @@
 namespace netcode
 {
 
-UnpackPacket::UnpackPacket(const RawPacket&amp; packet) : pckt(packet), pos(0)
+UnpackPacket::UnpackPacket(boost::shared_ptr&lt;const RawPacket&gt; packet) : pckt(packet), pos(0)
 {
 }
 

Modified: trunk/rts/System/Net/UnpackPacket.h
===================================================================
--- trunk/rts/System/Net/UnpackPacket.h	2008-05-16 01:17:06 UTC (rev 5894)
+++ trunk/rts/System/Net/UnpackPacket.h	2008-05-16 18:14:35 UTC (rev 5895)
@@ -2,6 +2,7 @@
 #define UNPACK_PACKET_H
 
 #include &lt;string&gt;
+#include &lt;boost/shared_ptr.hpp&gt;
 
 #include &quot;RawPacket.h&quot;
 
@@ -11,14 +12,14 @@
 class UnpackPacket
 {
 public:
-	UnpackPacket(const RawPacket&amp;);
+	UnpackPacket(boost::shared_ptr&lt;const RawPacket&gt;);
 	
 	template &lt;typename T&gt;
-	void operator&gt;&gt;(T&amp; t) {t = *(T*)(pckt.data+pos); pos += sizeof(T);};
-	void operator&gt;&gt;(std::string&amp; text) {text = std::string((char*)(pckt.data + pos)); pos += text.size()+1;};
+	void operator&gt;&gt;(T&amp; t) {t = *(T*)(pckt-&gt;data+pos); pos += sizeof(T);};
+	void operator&gt;&gt;(std::string&amp; text) {text = std::string((char*)(pckt-&gt;data + pos)); pos += text.size()+1;};
 	
 private:
-	const RawPacket&amp; pckt;
+	boost::shared_ptr&lt;const RawPacket&gt; pckt;
 	unsigned pos;
 };
 

Modified: trunk/rts/System/NetProtocol.cpp
===================================================================
--- trunk/rts/System/NetProtocol.cpp	2008-05-16 01:17:06 UTC (rev 5894)
+++ trunk/rts/System/NetProtocol.cpp	2008-05-16 18:14:35 UTC (rev 5895)
@@ -57,19 +57,17 @@
 	return CNet::IsActiveConnection(serverSlot);
 }
 
-const RawPacket* CNetProtocol::Peek(unsigned ahead) const
+boost::shared_ptr&lt;const netcode::RawPacket&gt; CNetProtocol::Peek(unsigned ahead) const
 {
 	return CNet::Peek(serverSlot, ahead);
 }
 
-RawPacket* CNetProtocol::GetData()
+boost::shared_ptr&lt;const netcode::RawPacket&gt; CNetProtocol::GetData()
 {
-	RawPacket* ret = CNet::GetData(serverSlot);
+	boost::shared_ptr&lt;const netcode::RawPacket&gt; ret = CNet::GetData(serverSlot);
 	
 	if (record &amp;&amp; ret)
-	{
 		record-&gt;SaveToDemo(ret-&gt;data, ret-&gt;length);
-	}
 	
 	return ret;
 }

Modified: trunk/rts/System/NetProtocol.h
===================================================================
--- trunk/rts/System/NetProtocol.h	2008-05-16 01:17:06 UTC (rev 5894)
+++ trunk/rts/System/NetProtocol.h	2008-05-16 18:14:35 UTC (rev 5895)
@@ -36,7 +36,7 @@
 	@param ahead How many packets to look ahead. A typical usage would be:
 	for (int ahead = 0; (packet = net-&gt;Peek(ahead)) != NULL; ++ahead) {}
 	*/
-	const RawPacket* Peek(unsigned ahead) const;
+	boost::shared_ptr&lt;const netcode::RawPacket&gt; Peek(unsigned ahead) const;
 
 	/**
 	@brief Recieve data from Client
@@ -45,7 +45,7 @@
 	
 	Recieves only one message (even if there are more in the recieve buffer), so call this until you get a 0 in return
 	 */
-	RawPacket* GetData();
+	boost::shared_ptr&lt;const netcode::RawPacket&gt; GetData();
 	
 	CDemoRecorder* GetDemoRecorder() const { return record; }
 


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000674.html">[Taspring-linux-commit] r5894 - in branches/gml/rts: . ExternalAI	ExternalAI/GlobalAICInterface Game Game/Camera Game/Server	Game/StartScripts Game/UI Lua Map Map/SM3 Map/SM3/terrain	Map/SMF Rendering Rendering/Env Rendering/GL	Rendering/Textures Rendering/UnitModels Sim/Features Sim/Misc	Sim/MoveTypes Sim/MoveTypes/MoveMath Sim/Objects Sim/Path	Sim/Projectiles Sim/Projectiles/Unsynced	Sim/Projectiles/WeaponProjectiles Sim/Units Sim/Units/COB	Sim/Units/CommandAI Sim/Units/UnitTypes Sim/Weapons System	System/FileSystem System/Net System/Platform/Linux	System/Platform/Win System/Script build/scons build/vstudio8 lib/gml
</A></li>
	<LI>Next message: <A HREF="000676.html">[Taspring-linux-commit] r5896 - branches/gml/rts/lib/gml
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#675">[ date ]</a>
              <a href="thread.html#675">[ thread ]</a>
              <a href="subject.html#675">[ subject ]</a>
              <a href="author.html#675">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
