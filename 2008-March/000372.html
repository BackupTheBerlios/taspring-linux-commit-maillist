<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r5591 - in trunk/AI/Global/NTai/AI: .	NTai/Agents NTai/Core NTai/Helpers/Terrain NTai/Helpers/Units	NTai/Tasks NTai/Units NTai/Units/Behaviours
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-March/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5591%20-%20in%20trunk/AI/Global/NTai/AI%3A%20.%0A%09NTai/Agents%20NTai/Core%20NTai/Helpers/Terrain%20NTai/Helpers/Units%0A%09NTai/Tasks%20NTai/Units%20NTai/Units/Behaviours&In-Reply-To=%3C20080317204318.43A864676%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000371.html">
   <LINK REL="Next"  HREF="000373.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r5591 - in trunk/AI/Global/NTai/AI: .	NTai/Agents NTai/Core NTai/Helpers/Terrain NTai/Helpers/Units	NTai/Tasks NTai/Units NTai/Units/Behaviours</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5591%20-%20in%20trunk/AI/Global/NTai/AI%3A%20.%0A%09NTai/Agents%20NTai/Core%20NTai/Helpers/Terrain%20NTai/Helpers/Units%0A%09NTai/Tasks%20NTai/Units%20NTai/Units/Behaviours&In-Reply-To=%3C20080317204318.43A864676%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r5591 - in trunk/AI/Global/NTai/AI: .	NTai/Agents NTai/Core NTai/Helpers/Terrain NTai/Helpers/Units	NTai/Tasks NTai/Units NTai/Units/Behaviours">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Mon Mar 17 21:43:17 CET 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000371.html">[Taspring-linux-commit] r5590 - trunk/tools/DedicatedServer
</A></li>
        <LI>Next message: <A HREF="000373.html">[Taspring-linux-commit] r5592 - in trunk/rts: Game System System/Net
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#372">[ date ]</a>
              <a href="thread.html#372">[ thread ]</a>
              <a href="subject.html#372">[ subject ]</a>
              <a href="author.html#372">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: tnowell
Date: 2008-03-17 21:43:16 +0100 (Mon, 17 Mar 2008)
New Revision: 5591

Removed:
   trunk/AI/Global/NTai/AI/NTai/Core/CGlobalProxy.cpp
   trunk/AI/Global/NTai/AI/NTai/Core/CGlobalProxy.h
Modified:
   trunk/AI/Global/NTai/AI/AI.vcproj
   trunk/AI/Global/NTai/AI/NTai/Agents/CManufacturer.h
   trunk/AI/Global/NTai/AI/NTai/Agents/Chaser.cpp
   trunk/AI/Global/NTai/AI/NTai/Core/CMessage.cpp
   trunk/AI/Global/NTai/AI/NTai/Core/CMessage.h
   trunk/AI/Global/NTai/AI/NTai/Core/Global.cpp
   trunk/AI/Global/NTai/AI/NTai/Core/Global.h
   trunk/AI/Global/NTai/AI/NTai/Core/IModule.h
   trunk/AI/Global/NTai/AI/NTai/Core/include.h
   trunk/AI/Global/NTai/AI/NTai/Helpers/Terrain/CBuildingPlacer.cpp
   trunk/AI/Global/NTai/AI/NTai/Helpers/Terrain/CBuildingPlacer.h
   trunk/AI/Global/NTai/AI/NTai/Helpers/Units/Actions.cpp
   trunk/AI/Global/NTai/AI/NTai/Tasks/CConsoleTask.cpp
   trunk/AI/Global/NTai/AI/NTai/Tasks/CConsoleTask.h
   trunk/AI/Global/NTai/AI/NTai/Tasks/CKeywordConstructionTask.cpp
   trunk/AI/Global/NTai/AI/NTai/Tasks/CKeywordConstructionTask.h
   trunk/AI/Global/NTai/AI/NTai/Tasks/CLeaveBuildSpotTask.cpp
   trunk/AI/Global/NTai/AI/NTai/Tasks/CLeaveBuildSpotTask.h
   trunk/AI/Global/NTai/AI/NTai/Tasks/CUnitConstructionTask.cpp
   trunk/AI/Global/NTai/AI/NTai/Tasks/CUnitConstructionTask.h
   trunk/AI/Global/NTai/AI/NTai/Tasks/ITask.h
   trunk/AI/Global/NTai/AI/NTai/Units/Behaviours/AttackBehaviour.cpp
   trunk/AI/Global/NTai/AI/NTai/Units/Behaviours/CDGunBehaviour.cpp
   trunk/AI/Global/NTai/AI/NTai/Units/Behaviours/CRetreatBehaviour.cpp
   trunk/AI/Global/NTai/AI/NTai/Units/Behaviours/CRetreatBehaviour.h
   trunk/AI/Global/NTai/AI/NTai/Units/CUnit.cpp
   trunk/AI/Global/NTai/AI/NTai/Units/CUnit.h
Log:
- reverted to a previous revision
- added a few fixes from previous commits that have been undone

Modified: trunk/AI/Global/NTai/AI/AI.vcproj
===================================================================
--- trunk/AI/Global/NTai/AI/AI.vcproj	2008-03-17 19:53:35 UTC (rev 5590)
+++ trunk/AI/Global/NTai/AI/AI.vcproj	2008-03-17 20:43:16 UTC (rev 5591)
@@ -189,14 +189,6 @@
 				&gt;
 			&lt;/File&gt;
 			&lt;File
-				RelativePath=&quot;.\NTai\Core\CGlobalProxy.cpp&quot;
-				&gt;
-			&lt;/File&gt;
-			&lt;File
-				RelativePath=&quot;.\NTai\Core\CGlobalProxy.h&quot;
-				&gt;
-			&lt;/File&gt;
-			&lt;File
 				RelativePath=&quot;.\NTai\Helpers\grid\CGridCell.cpp&quot;
 				&gt;
 			&lt;/File&gt;

Modified: trunk/AI/Global/NTai/AI/NTai/Agents/CManufacturer.h
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Agents/CManufacturer.h	2008-03-17 19:53:35 UTC (rev 5590)
+++ trunk/AI/Global/NTai/AI/NTai/Agents/CManufacturer.h	2008-03-17 20:43:16 UTC (rev 5591)
@@ -7,12 +7,13 @@
 	class CBPlan: public boost::noncopyable{ // This is not used for factories building units.
 	public:
 		CBPlan();
+	//	CBPlan();
 		~CBPlan();
 
 		bool IsValid(){
 			return valid;
 		}
-
+		//bool HasBuilder(int i);
 		void AddBuilder(int i);
 		bool HasBuilders();
 		void RemoveBuilder(int i);
@@ -31,6 +32,8 @@
 	private:
 		bool valid;
 		int bcount;
+		//boost::mutex plan_mutex;
+		//set&lt;int&gt; builders;				// the builder
 
 	};
 
@@ -59,21 +62,22 @@
 		map&lt;string,btype&gt; types;
 		map&lt;btype,string&gt; typenames;
 
-		// retrieves the associated tasktype
-		btype GetTaskType(string s);
+		btype GetTaskType(string s);						// retrieves the associated tasktype
+		string GetTaskName(btype type);						// retrieves the associated taskname
 
-		// retrieves the associated taskname
-		string GetTaskName(btype type);
-
-		// registers this pair so it can be logged and used in the tasklists
-		void RegisterTaskPair(string name, btype type);
-
+		void RegisterTaskPair(string name, btype type);		// registers this pair so it can be logged and used in the tasklists
 		void RegisterTaskTypes();
 
 		bool CanBuild(int uid,const UnitDef* ud, string name);
 
 		deque&lt;CBPlan* &gt;* BPlans;
 
+		//bool WipePlansForBuilder(int unit);
+
+		//int WhatIsUnitBuilding(int builder);
+
+		//bool UnitTargetStartedBuilding(int builder);
+
 		deque&lt;CBPlan* &gt;::iterator OverlappingPlans(float3 pos,const UnitDef* ud);
 
 		uint getplans();

Modified: trunk/AI/Global/NTai/AI/NTai/Agents/Chaser.cpp
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Agents/Chaser.cpp	2008-03-17 19:53:35 UTC (rev 5590)
+++ trunk/AI/Global/NTai/AI/NTai/Agents/Chaser.cpp	2008-03-17 20:43:16 UTC (rev 5591)
@@ -15,29 +15,24 @@
 	void Chaser::InitAI(Global* GLI){
 		G = GLI;
 		NLOG(&quot;Chaser::InitAI&quot;);
-		
-
 		enemynum=0;
+		G-&gt;Get_mod_tdf()-&gt;GetDef(threshold, &quot;5&quot;, &quot;AI\\initial_threat_value&quot;);
+		G-&gt;Get_mod_tdf()-&gt;GetDef(thresh_increase, &quot;1&quot;, &quot;AI\\increase_threshold_value&quot;);
+		G-&gt;Get_mod_tdf()-&gt;GetDef(thresh_percentage_incr, &quot;1&quot;, &quot;AI\\increase_threshold_percentage&quot;);
+		G-&gt;Get_mod_tdf()-&gt;GetDef(max_threshold, &quot;1&quot;, &quot;AI\\maximum_attack_group_size&quot;);
 
-		TdfParser* t = G-&gt;Get_mod_tdf();
-
-		t-&gt;GetDef(threshold, &quot;5&quot;, &quot;AI\\initial_threat_value&quot;);
-		t-&gt;GetDef(thresh_increase, &quot;1&quot;, &quot;AI\\increase_threshold_value&quot;);
-		t-&gt;GetDef(thresh_percentage_incr, &quot;1&quot;, &quot;AI\\increase_threshold_percentage&quot;);
-		t-&gt;GetDef(max_threshold, &quot;1&quot;, &quot;AI\\maximum_attack_group_size&quot;);
-
-		float3 mapdim = float3((float)G-&gt;cb-&gt;GetMapWidth()*SQUARE_SIZE, 0, (float)G-&gt;cb-&gt;GetMapHeight()*SQUARE_SIZE);
+		float3 mapdim= float3((float)G-&gt;cb-&gt;GetMapWidth()*SQUARE_SIZE, 0, (float)G-&gt;cb-&gt;GetMapHeight()*SQUARE_SIZE);
 		Grid.Initialize(mapdim, float3(1024, 0, 1024), true);
 		Grid.ApplyModifierOnUpdate(0.9f, (15 SECONDS));
 		Grid.SetDefaultGridValue(5.0f);
 		Grid.SetMinimumValue(10.0f);
 
-		CTokenizer&lt;CIsComma&gt;::Tokenize(fire_at_will, t-&gt;SGetValueMSG(&quot;AI\\fire_at_will&quot;), CIsComma());
-		CTokenizer&lt;CIsComma&gt;::Tokenize(return_fire, t-&gt;SGetValueMSG(&quot;AI\\return_fire&quot;), CIsComma());
-		CTokenizer&lt;CIsComma&gt;::Tokenize(hold_fire, t-&gt;SGetValueMSG(&quot;AI\\hold_fire&quot;), CIsComma());
-		CTokenizer&lt;CIsComma&gt;::Tokenize(roam, t-&gt;SGetValueMSG(&quot;AI\\roam&quot;), CIsComma());
-		CTokenizer&lt;CIsComma&gt;::Tokenize(maneouvre, t-&gt;SGetValueMSG(&quot;AI\\maneouvre&quot;), CIsComma());
-		CTokenizer&lt;CIsComma&gt;::Tokenize(hold_pos, t-&gt;SGetValueMSG(&quot;AI\\hold_pos&quot;), CIsComma());
+		CTokenizer&lt;CIsComma&gt;::Tokenize(fire_at_will, G-&gt;Get_mod_tdf()-&gt;SGetValueMSG(&quot;AI\\fire_at_will&quot;), CIsComma());
+		CTokenizer&lt;CIsComma&gt;::Tokenize(return_fire, G-&gt;Get_mod_tdf()-&gt;SGetValueMSG(&quot;AI\\return_fire&quot;), CIsComma());
+		CTokenizer&lt;CIsComma&gt;::Tokenize(hold_fire, G-&gt;Get_mod_tdf()-&gt;SGetValueMSG(&quot;AI\\hold_fire&quot;), CIsComma());
+		CTokenizer&lt;CIsComma&gt;::Tokenize(roam, G-&gt;Get_mod_tdf()-&gt;SGetValueMSG(&quot;AI\\roam&quot;), CIsComma());
+		CTokenizer&lt;CIsComma&gt;::Tokenize(maneouvre, G-&gt;Get_mod_tdf()-&gt;SGetValueMSG(&quot;AI\\maneouvre&quot;), CIsComma());
+		CTokenizer&lt;CIsComma&gt;::Tokenize(hold_pos, G-&gt;Get_mod_tdf()-&gt;SGetValueMSG(&quot;AI\\hold_pos&quot;), CIsComma());
 
 	}
 

Deleted: trunk/AI/Global/NTai/AI/NTai/Core/CGlobalProxy.cpp
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Core/CGlobalProxy.cpp	2008-03-17 19:53:35 UTC (rev 5590)
+++ trunk/AI/Global/NTai/AI/NTai/Core/CGlobalProxy.cpp	2008-03-17 20:43:16 UTC (rev 5591)
@@ -1,258 +0,0 @@
-#include &quot;include.h&quot;
-
-namespace ntai {
-
-	CGlobalProxy::CGlobalProxy(Global* GL){
-		//
-		G = GL;
-	}
-
-	CGlobalProxy::~CGlobalProxy(){
-		//
-	}
-
-
-	// Interface functions
-
-	// initialize the AI
-	bool CGlobalProxy::Init(){
-		//
-		return true;
-	}
-
-	void CGlobalProxy::RecieveMessage(CMessage &amp;message){
-		//
-
-		if(message.IsType(&quot;update&quot;)){
-			//
-			if(message.GetFrame() == (1 SECOND)){
-				NLOG(&quot;STARTUP BANNER IN Global::Update()&quot;);
-
-				if(G-&gt;L.FirstInstance()){
-					
-					string s = string(&quot;:: &quot;) + AI_NAME + string(&quot; by Tom J. Nowell&quot;);
-					
-					G-&gt;cb-&gt;SendTextMsg(s.c_str(), 0);
-					G-&gt;cb-&gt;SendTextMsg(&quot;:: Copyright (C) 2005-2008 AF Tom J. Nowell&quot;, 0);
-					
-					string q = string(&quot; :: &quot;) + G-&gt;Get_mod_tdf()-&gt;SGetValueMSG(&quot;AI\\message&quot;);
-					
-					if(q != string(&quot;&quot;)){
-						G-&gt;cb-&gt;SendTextMsg(q.c_str(), 0);
-					}
-
-					G-&gt;cb-&gt;SendTextMsg(&quot;Please check www.darkstars.co.uk for updates&quot;, 0);
-				}
-
-				int* ax = new int[10000];
-				int anum = G-&gt;cb-&gt;GetFriendlyUnits(ax);
-				
-				G-&gt;ComName = string(&quot;&quot;);
-		        
-				if(anum !=0){
-					for(int a = 0; a&lt;anum; a++){
-						if(G-&gt;cb-&gt;GetUnitTeam(ax[a]) == G-&gt;cb-&gt;GetMyTeam()){
-							const UnitDef* ud = G-&gt;GetUnitDef(ax[a]);
-							if(ud!=0){
-								//
-								G-&gt;ComName = ud-&gt;name;
-								G-&gt;Cached-&gt;comID=ax[a];
-								break;
-							}
-						}
-					}
-				}
-				delete[] ax;
-			}
-
-			G-&gt;OrderRouter-&gt;Update();
-
-			if(message.GetFrame()%(2 MINUTES) == 0){
-				G-&gt;SaveUnitData();
-			}
-
-			G-&gt;Actions-&gt;Update();
-				
-			G-&gt;Ch-&gt;Update();
-		} else if (message.IsType(&quot;unitdamaged&quot;)){
-			int damaged = message.GetParameter(0);
-			int attacker = message.GetParameter(1);
-			
-			const UnitDef* uda = G-&gt;GetUnitDef(damaged);
-
-			if(uda != 0){
-				float e = G-&gt;GetEfficiency(uda-&gt;name, uda-&gt;power);
-				e -= 10000/uda-&gt;metalCost;
-				G-&gt;SetEfficiency(uda-&gt;name, e);
-
-				
-				const UnitDef* udb = G-&gt;GetUnitDef(attacker);
-
-				if(udb != 0){
-					float e = G-&gt;GetEfficiency(udb-&gt;name, udb-&gt;power);
-					e += 10000/uda-&gt;metalCost;
-					G-&gt;SetEfficiency(udb-&gt;name, e);
-
-				}
-			}
-
-			int damage = message.GetParameter(2);
-			
-			float3 dir;
-
-			dir.x = message.GetParameter(3);
-			dir.y = message.GetParameter(4);
-			dir.z = message.GetParameter(5);
-
-			G-&gt;Actions-&gt;UnitDamaged(damaged, attacker, damage, dir);
-
-
-			G-&gt;Ch-&gt;UnitDamaged(damaged, attacker, damage, dir);
-
-		} else if (message.IsType(&quot;unitfinished&quot;)){
-			//
-			int unit = message.GetParameter(0);
-
-			CUnitTypeData* u = G-&gt;UnitDefLoader-&gt;GetUnitTypeDataByUnitId(unit);
-			if(u ==0){
-				return;
-			}
-
-			const UnitDef* ud = u-&gt;GetUnitDef();
-
-			if(ud!=0){
-				if(ud-&gt;isCommander){
-					G-&gt;Cached-&gt;comID = unit;
-				}
-
-				G-&gt;max_energy_use += ud-&gt;energyUpkeep;
-
-				// prepare unitname
-				string t = u-&gt;GetName();
-
-				// solo build cleanup
-
-				// Regardless of wether the unit is subject to this behaviour the value of
-				// solobuildactive will always be false, so why bother running a check?
-				u-&gt;SetSoloBuildActive(false);
-
-				if(ud-&gt;movedata == 0){
-					if(!ud-&gt;canfly){
-						if(!ud-&gt;builder){
-							float3 upos = G-&gt;GetUnitPos(unit);
-							if(upos != UpVector){
-								G-&gt;DTHandler-&gt;AddRing(upos, 500.0f, float(PI_2) / 6.0f);
-								G-&gt;DTHandler-&gt;AddRing(upos, 700.0f, float(-PI_2) / 6.0f);
-							}
-						}
-					}
-				}
-			}
-
-			G-&gt;Manufacturer-&gt;UnitFinished(unit);
-
-			G-&gt;Ch-&gt;UnitFinished(unit);
-
-		} else if(message.IsType(&quot;##.verbose&quot;)){
-			if(G-&gt;L.Verbose()){
-				G-&gt;L.iprint(&quot;Verbose turned on&quot;);
-			} else {
-				G-&gt;L.iprint(&quot;Verbose turned off&quot;);
-			}
-
-		}else if(message.IsType(&quot;##.crash&quot;)){
-			G-&gt;Crash();
-
-		}else if(message.IsType(&quot;##.end&quot;)){
-			exit(0);
-
-		}else if(message.IsType(&quot;##.break&quot;)){
-			if(G-&gt;L.FirstInstance()){
-				G-&gt;L.print(&quot;The user initiated debugger break&quot;);
-			}
-
-		}else if(message.IsType(&quot;##.isfirst&quot;)){
-			if(G-&gt;L.FirstInstance()){
-				G-&gt;L.iprint(&quot; info :: This is the first NTai instance&quot;);
-			}
-
-		}else if(message.IsType(&quot;##.save&quot;)){
-			if(G-&gt;L.FirstInstance()){
-				G-&gt;SaveUnitData();
-			}
-
-		}else if(message.IsType(&quot;##.reload&quot;)){
-			if(G-&gt;L.FirstInstance()){
-				G-&gt;LoadUnitData();
-			}
-
-		}else if(message.IsType(&quot;##.flush&quot;)){
-			G-&gt;L.Flush();
-
-		}else if(message.IsType(&quot;##.threat&quot;)){
-			G-&gt;Ch-&gt;MakeTGA();
-
-		}else if(message.IsType(&quot;##.aicheat&quot;)){
-
-			 //chcb = G-&gt;gcb-&gt;GetCheatInterface();
-			 if(G-&gt;Cached-&gt;cheating== false){
-
-				 G-&gt;Cached-&gt;cheating = true;
-				 G-&gt;chcb-&gt;SetMyHandicap(1000.0f);
-
-				 if(G-&gt;L.FirstInstance()){
-					 G-&gt;L.iprint(&quot;Make sure you've typed .cheat for full cheating!&quot;);
-				 }
-				 
-				 // Spawn 4 commanders around the starting position
-				 CUnitTypeData* ud = G-&gt;UnitDefLoader-&gt;GetUnitTypeDataByName(G-&gt;ComName);
-				 if(ud != 0){
-
-					 float3 pos = G-&gt;Map-&gt;basepos;
-					 pos = G-&gt;cb-&gt;ClosestBuildSite(ud-&gt;GetUnitDef(), pos, 1000.0f, 0);
-					 
-					 int ij = G-&gt;chcb-&gt;CreateUnit(G-&gt;ComName.c_str(), pos);
-					 
-					 if(ij != 0){
-						 G-&gt;Actions-&gt;RandomSpiral(ij);
-					 }
-
-					 float3 epos = pos;
-					 epos.z -= 1300.0f;
-					 float angle = float(G-&gt;mrand()%320);
-					 pos = G-&gt;Map-&gt;Rotate(epos, angle, pos);
-					 pos = G-&gt;cb-&gt;ClosestBuildSite(ud-&gt;GetUnitDef(), pos, 1000, 300, 1);
-
-					 ij = G-&gt;chcb-&gt;CreateUnit(G-&gt;ComName.c_str(), pos);
-
-					 if(ij != 0){
-						 G-&gt;Actions-&gt;RandomSpiral(ij);
-					 }
-
-					 epos = pos;
-					 epos.z -= 900.0f;
-
-					 angle = float(G-&gt;mrand()%320);
-
-					 pos = G-&gt;Map-&gt;Rotate(epos, angle, pos);
-					 pos = G-&gt;cb-&gt;ClosestBuildSite(ud-&gt;GetUnitDef(), pos, 1000, 300, 0);
-					 ///
-					 ij = G-&gt;chcb-&gt;CreateUnit(G-&gt;ComName.c_str(), pos);
-
-					 if(ij != 0){
-						 G-&gt;Actions-&gt;RandomSpiral(ij);
-					 }
-				 }
-
-			 } else if(G-&gt;Cached-&gt;cheating){
-				 G-&gt;Cached-&gt;cheating  = false;
-
-				 if(G-&gt;L.FirstInstance()){
-					 G-&gt;L.iprint(&quot;cheating is now disabled therefore NTai will no longer cheat&quot;);
-				 }
-			 }
-		 }
-
-	}
-
-}

Deleted: trunk/AI/Global/NTai/AI/NTai/Core/CGlobalProxy.h
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Core/CGlobalProxy.h	2008-03-17 19:53:35 UTC (rev 5590)
+++ trunk/AI/Global/NTai/AI/NTai/Core/CGlobalProxy.h	2008-03-17 20:43:16 UTC (rev 5591)
@@ -1,18 +0,0 @@
-namespace ntai {
-
-	// ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
-
-	class CGlobalProxy : public IModule{
-	public:
-		CGlobalProxy(Global* GL);
-		virtual ~CGlobalProxy();
-
-		bool Init();
-
-		void RecieveMessage(CMessage &amp;message);
-
-	private:
-		Global* G;
-	};
-
-}

Modified: trunk/AI/Global/NTai/AI/NTai/Core/CMessage.cpp
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Core/CMessage.cpp	2008-03-17 19:53:35 UTC (rev 5590)
+++ trunk/AI/Global/NTai/AI/NTai/Core/CMessage.cpp	2008-03-17 20:43:16 UTC (rev 5591)
@@ -11,16 +11,11 @@
 }
 
 CMessage::CMessage(string my_type, vector&lt;float&gt; &amp;myparameters){
-	message_type = my_type;
 	parameters = myparameters;
 	frame = 0;
 	lifetime = -1;
 }
 
-bool CMessage::IsType(std::string type){
-	return (type == message_type);
-}
-
 vector&lt;float&gt; CMessage::GetParameters(){
 	return parameters;
 }

Modified: trunk/AI/Global/NTai/AI/NTai/Core/CMessage.h
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Core/CMessage.h	2008-03-17 19:53:35 UTC (rev 5590)
+++ trunk/AI/Global/NTai/AI/NTai/Core/CMessage.h	2008-03-17 20:43:16 UTC (rev 5591)
@@ -4,17 +4,15 @@
 
 class CMessage {
 public:
-	CMessage(std::string my_type);
-	CMessage(std::string my_type, std::vector&lt;float&gt; &amp;myparameters);
+	CMessage(string my_type);
+	CMessage(string my_type, vector&lt;float&gt; &amp;myparameters);
 
-	bool IsType(std::string type);
+	vector&lt;float&gt; GetParameters();
 
-	std::vector&lt;float&gt; GetParameters();
-
 	float GetParameter(int i);
 	void* GetOtherParameters();
 
-	std::string GetType();
+	string GetType();
 	void SetType(string type);
 
 	int GetFrame();
@@ -36,7 +34,7 @@
 private:
 	int frame;
 	int lifetime; // -1 indefinate
-	std::string message_type;
-	std::vector&lt;float&gt; parameters;
+	string message_type;
+	vector&lt;float&gt; parameters;
 	void* otherstuff;
 };

Modified: trunk/AI/Global/NTai/AI/NTai/Core/Global.cpp
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Core/Global.cpp	2008-03-17 19:53:35 UTC (rev 5590)
+++ trunk/AI/Global/NTai/AI/NTai/Core/Global.cpp	2008-03-17 20:43:16 UTC (rev 5591)
@@ -16,11 +16,13 @@
 	map&lt;string, float&gt; builderefficiency;
 	map&lt;string, int&gt; lastbuilderefficiencyupdate;
 
+	// ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
 
 	TdfParser* Global::Get_mod_tdf(){
 		return info-&gt;mod_tdf;
 	}
 
+	// ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
 
 	void trim(string &amp;str){
 		string::size_type pos = str.find_last_not_of(' ');
@@ -33,12 +35,8 @@
 	}
 
 	bool ValidUnitID(int id){
-		if(id &lt; 0){
-			return false;
-		}
-		if(id &gt; MAX_UNITS+1){
-			return false;
-		}
+		if(id &lt; 0) return false;
+		if(id &gt; MAX_UNITS+1) return false;
 		return true;
 	}
 
@@ -47,12 +45,10 @@
 		gcb = callback;
 		cb = gcb-&gt;GetAICallback();
 		if(cb == 0){
-			throw string(&quot; fatal error cb ==0&quot;);
+			throw string(&quot; error cb ==0&quot;);
 		}
-
 		CLOG(&quot;Started Global::Global class constructor&quot;);
 		CLOG(&quot;Starting CCached initialisation&quot;);
-		
 		Cached = new CCached;
 		Cached-&gt;comID = 0;
 		Cached-&gt;randadd = 0;
@@ -134,8 +130,9 @@
 				 triangles.push_back(triangle);
 			 }
 		 }*/
-
+		//if(L.FirstInstance() == true){
 		L &lt;&lt; &quot; :: Found &quot; &lt;&lt; M-&gt;m-&gt;NumSpotsFound &lt;&lt; &quot; Metal Spots&quot; &lt;&lt; endline;
+		//}
 		UnitDefLoader = new CUnitDefLoader(G);
 		L.print(&quot;Unitdef loader constructed&quot;);
 
@@ -217,14 +214,14 @@
 		END_EXCEPTION_HANDLING(&quot;CMessage message(\&quot;enemydamaged\&quot;); FireEvent(message);&quot;)*/
 	}
 
+	// ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
+
 	void Global::Update(){
 		bool paused = false;
 
 		NLOG(&quot;Global::Update()&quot;);
 		cb-&gt;GetValue(AIVAL_GAME_PAUSED, &amp;paused);
-		if(paused){
-			return;
-		}
+		if(paused) return;
 		START_EXCEPTION_HANDLING
 
 		if(!handlers.empty()){
@@ -259,10 +256,72 @@
 
 		}
 
-		
+		if(cb-&gt;GetCurrentFrame() == (1 SECOND)){
+			NLOG(&quot;STARTUP BANNER IN Global::Update()&quot;);
 
+			if(L.FirstInstance()){
+				string s = string(&quot;:: &quot;) + AI_NAME + string(&quot; by AF&quot;);
+				cb-&gt;SendTextMsg(s.c_str(), 0);
+				cb-&gt;SendTextMsg(&quot;:: Copyright (C) 2006 AF&quot;, 0);
+				string q = string(&quot; :: &quot;) + Get_mod_tdf()-&gt;SGetValueMSG(&quot;AI\\message&quot;);
+				if(q != string(&quot;&quot;)){
+					cb-&gt;SendTextMsg(q.c_str(), 0);
+				}
+				cb-&gt;SendTextMsg(&quot;Please check www.darkstars.co.uk for updates&quot;, 0);
+			}
+
+			int* ax = new int[10000];
+			int anum =cb-&gt;GetFriendlyUnits(ax);
+			
+			ComName = string(&quot;&quot;);
+	        
+			if(anum !=0){
+				for(int a = 0; a&lt;anum; a++){
+					if(cb-&gt;GetUnitTeam(ax[a]) == cb-&gt;GetMyTeam()){
+						const UnitDef* ud = GetUnitDef(ax[a]);
+						if(ud!=0){
+							//
+							ComName = ud-&gt;name;
+							Cached-&gt;comID=ax[a];
+						}
+					}
+				}
+			}
+			delete[] ax;
+		}
+		END_EXCEPTION_HANDLING(&quot;Startup Banner and getting commander name&quot;)
+
 		START_EXCEPTION_HANDLING
+		OrderRouter-&gt;Update();
+		END_EXCEPTION_HANDLING(&quot;OrderRouter-&gt;Update()&quot;)
 
+		//if( EVERY_((2 SECONDS)) &amp;&amp; (Cached-&gt;cheating == true) ){
+		//	float a = cb-&gt;GetEnergyStorage() - cb-&gt;GetEnergy();
+		//	if( a &gt; 50) chcb-&gt;GiveMeEnergy(a);
+		//	a = cb-&gt;GetMetalStorage() - cb-&gt;GetMetal();
+		//	if(a &gt; 50) chcb-&gt;GiveMeMetal(a);
+		//}
+
+		START_EXCEPTION_HANDLING
+		if(EVERY_((2 MINUTES))){
+			//L.print(&quot;saving UnitData&quot;);
+			SaveUnitData();
+			/*if(!SaveUnitData()){
+			 L.print(&quot;UnitData saved&quot;);
+			 }else{
+			 L.print(&quot;UnitData not saved&quot;);
+			 }*/
+		}
+		END_EXCEPTION_HANDLING(&quot;SaveUnitData()&quot;)
+
+		//EXCEPTION_HANDLER(Pl-&gt;Update(),&quot;Pl-&gt;Update()&quot;,NA)
+
+		START_EXCEPTION_HANDLING
+		Actions-&gt;Update();
+		END_EXCEPTION_HANDLING(&quot;Actions-&gt;Update()&quot;)
+
+		START_EXCEPTION_HANDLING
+
 		CMessage message(&quot;update&quot;);
 
 		// a lifetime of 15 frames, so there should never be more than
@@ -274,10 +333,11 @@
 		END_EXCEPTION_HANDLING(&quot;CMessage message(\&quot;update\&quot;); FireEvent(message);&quot;)
 
 		//EXCEPTION_HANDLER(Manufacturer-&gt;Update(),&quot;Manufacturer-&gt;Update()&quot;,NA)
-		
+		Ch-&gt;Update();
 
 	}
 
+	// ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
 
 	void Global::SortSolobuilds(int unit){
 		Cached-&gt;enemies.erase(unit);
@@ -336,6 +396,7 @@
 
 	}
 
+	// ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
 	void Global::EnemyDestroyed(int enemy, int attacker){
 
 		if(ValidUnitID(attacker)){
@@ -376,9 +437,54 @@
 
 	void Global::UnitFinished(int unit){
 
+		//START_EXCEPTION_HANDLING
+		CUnitTypeData* u = this-&gt;UnitDefLoader-&gt;GetUnitTypeDataByUnitId(unit);
+		if(u ==0){
+			return;
+		}
+		const UnitDef* ud = u-&gt;GetUnitDef();
+		if(ud!=0){
+			if(ud-&gt;isCommander){
+				G-&gt;Cached-&gt;comID = unit;
+			}
+			max_energy_use += ud-&gt;energyUpkeep;
+
+			// prepare unitname
+			string t = u-&gt;GetName();
+
+			// solo build cleanup
+
+			// Regardless of wether the unit is subject to this behaviour the value of
+			// solobuildactive will always be false, so why bother running a check?
+			u-&gt;SetSoloBuildActive(false);
+
+			if(ud-&gt;movedata == 0){
+				if(!ud-&gt;canfly){
+					if(!ud-&gt;builder){
+						float3 upos = GetUnitPos(unit);
+						if(upos != UpVector){
+							DTHandler-&gt;AddRing(upos, 500.0f, float(PI_2) / 6.0f);
+							DTHandler-&gt;AddRing(upos, 700.0f, float(-PI_2) / 6.0f);
+						}
+					}
+				}
+			}
+		}
+		//END_EXCEPTION_HANDLING(&quot;Sorting solobuild additions and DT Rings in Global::UnitFinished &quot;)
+
+		//START_EXCEPTION_HANDLING
+		Manufacturer-&gt;UnitFinished(unit);
+		//END_EXCEPTION_HANDLING(&quot;Manufacturer-&gt;UnitFinished&quot;)
+
+		//START_EXCEPTION_HANDLING
+		Ch-&gt;UnitFinished(unit);
+		//END_EXCEPTION_HANDLING(&quot;Ch-&gt;UnitFinished&quot;)
+
+		//START_EXCEPTION_HANDLING
 		CMessage message(&quot;unitfinished&quot;);
 		message.AddParameter(unit);
 		FireEvent(message);
+		//END_EXCEPTION_HANDLING(&quot;CMessage message(\&quot;unitfinished\&quot;);&quot;)
 
 	}
 
@@ -386,7 +492,17 @@
 
 	void Global::UnitMoveFailed(int unit){
 
+		/*
+
 		START_EXCEPTION_HANDLING
+		Manufacturer-&gt;UnitMoveFailed(unit);
+		END_EXCEPTION_HANDLING(&quot;Manufacturer-&gt;UnitIdle in UnitMoveFailed&quot;)
+
+		START_EXCEPTION_HANDLING
+		Ch-&gt;UnitMoveFailed(unit);
+		END_EXCEPTION_HANDLING(&quot;Ch-&gt;UnitIdle in UnitMoveFailed&quot;)*/
+
+		START_EXCEPTION_HANDLING
 		CMessage message(&quot;unitmovefailed&quot;);
 		message.AddParameter(unit);
 		FireEvent(message);
@@ -397,23 +513,23 @@
 	// ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
 
 	void Global::UnitIdle(int unit){
-
 		if(!ValidUnitID(unit)){
 			L.print(&quot;CManufacturer::UnitIdle negative uid, aborting&quot;);
 			return;
 		}
-		
 		if(GetCurrentFrame() &lt; 5 SECONDS){
 			return;
 		}
-
 		START_EXCEPTION_HANDLING
 		CMessage message(&quot;unitidle&quot;);
 		message.AddParameter(unit);
 		FireEvent(message);
 		END_EXCEPTION_HANDLING(&quot;CMessage message(\&quot;unitidle\&quot;); FireEvent(message);&quot;)
 
+		//EXCEPTION_HANDLER(Manufacturer-&gt;UnitIdle(unit),&quot;Manufacturer-&gt;UnitIdle&quot;,NA)
 
+		//EXCEPTION_HANDLER(Actions-&gt;UnitIdle(unit),&quot;Actions-&gt;UnitIdle&quot;,NA)
+
 		START_EXCEPTION_HANDLING
 		Ch-&gt;UnitIdle(unit);
 		END_EXCEPTION_HANDLING(&quot;Ch-&gt;UnitIdle&quot;)
@@ -442,41 +558,172 @@
 	void Global::UnitDamaged(int damaged, int attacker, float damage, float3 dir){
 		NLOG(&quot;Global::UnitDamaged&quot;);
 
-		if(damage &lt;= 0){
-			return;
-		}
+		if(damage &lt;= 0) return;
+		if(!ValidUnitID(damaged)) return;
+		if(!ValidUnitID(attacker)) return;
 
-		if(!ValidUnitID(damaged)){
+		//START_EXCEPTION_HANDLING
+		if(cb-&gt;GetUnitAllyTeam(attacker) == cb-&gt;GetUnitAllyTeam(damaged)){
 			return;
 		}
+		//END_EXCEPTION_HANDLING(&quot;Global::UnitDamaged, filtering out bad calls&quot;)
 
-		if(!ValidUnitID(attacker)){
-			return;
+		//START_EXCEPTION_HANDLING
+		const UnitDef* uda = GetUnitDef(attacker);
+
+		if(uda != 0){
+			float e = GetEfficiency(uda-&gt;name, uda-&gt;power);
+			e += 10000/uda-&gt;metalCost;
+			SetEfficiency(uda-&gt;name, e);
 		}
+		const UnitDef* udb = GetUnitDef(damaged);
 
-		if(cb-&gt;GetUnitAllyTeam(attacker) == cb-&gt;GetUnitAllyTeam(damaged)){
-			return;
+		if(udb != 0){
+			float e = GetEfficiency(udb-&gt;name, udb-&gt;power);
+			e -= 10000/uda-&gt;metalCost;
+			SetEfficiency(udb-&gt;name, e);
+			/*if(udb-&gt;builder &amp;&amp; UnitDefHelper-&gt;IsMobile(udb)&amp;&amp;udb-&gt;weapons.empty()){
+				// if ti isnt currently building something then retreat
+				const CCommandQueue* uc = cb-&gt;GetCurrentUnitCommands(damaged);
+				if(uc != 0){
+					//
+					if(uc-&gt;front().id &gt;= 0){
+						G-&gt;Actions-&gt;Retreat(damaged);
+					}
+				}
+			}*/
 		}
+		//END_EXCEPTION_HANDLING(&quot;Global::UnitDamaged, threat value handling&quot;)
 
+		//START_EXCEPTION_HANDLING
+		Actions-&gt;UnitDamaged(damaged, attacker, damage, dir);
+		//END_EXCEPTION_HANDLING(&quot;Actions-&gt;UnitDamaged()&quot;)
+
+		Ch-&gt;UnitDamaged(damaged, attacker, damage, dir);
+
+		/*START_EXCEPTION_HANDLING*/
 		CMessage message(&quot;unitdamaged&quot;);
-
 		message.AddParameter(damaged);
 		message.AddParameter(attacker);
 		message.AddParameter(damage);
 		message.AddParameter(dir);
-
 		FireEvent(message);
-
+		/*END_EXCEPTION_HANDLING(&quot;CMessage message(\&quot;unitdamaged\&quot;); FireEvent(message);&quot;)*/
 	}
 
 	// ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
 	void Global::GotChatMsg(const char* msg, int player){
 		L.Message(msg, player);
-		
-		CMessage message(&quot;##&quot;+string(msg));
+		string tmsg = msg;
+		if(tmsg == string(&quot;.verbose&quot;)){
+			if(L.Verbose()){
+				L.iprint(&quot;Verbose turned on&quot;);
+			} else L.iprint(&quot;Verbose turned off&quot;);
+		}else if(tmsg == string(&quot;.crash&quot;)){
+			Crash();
+		}else if(tmsg == string(&quot;.end&quot;)){
+			exit(0);
+		}else if(tmsg == string(&quot;.break&quot;)){
+			if(L.FirstInstance() == true){
+				L.print(&quot;The user initiated debugger break&quot;);
+			}
+		}else if(tmsg == string(&quot;.isfirst&quot;)){
+			if(L.FirstInstance() == true) L.iprint(&quot; info :: This is the first NTai instance&quot;);
+		}else if(tmsg == string(&quot;.save&quot;)){
+			if(L.FirstInstance() == true) SaveUnitData();
+		}else if(tmsg == string(&quot;.reload&quot;)){
+			if(L.FirstInstance() == true) LoadUnitData();
+		}else if(tmsg == string(&quot;.flush&quot;)){
+			L.Flush();
+		}else if(tmsg == string(&quot;.threat&quot;)){
+			Ch-&gt;MakeTGA();
+		}/*else if(tmsg == string(&quot;.gridtest&quot;)){
+		 if(Ch-&gt;gridmaintainer==false) return;
+		 float cellvalue = 0;
+		 Ch-&gt;Grid-&gt;SetValuebyIndex(10,299.0f);
+		 cellvalue = Ch-&gt;Grid-&gt;GetValue(10);
+		 if(cellvalue==299.0f){
+		 G-&gt;L.iprint(&quot;Test 1 PASSED&quot;);
+		 }else{
+		 G-&gt;L.iprint(&quot;Test1 FAILED&quot;);
+		 }
+		 cellvalue=0;
+		 float3 mpos = float3(2048,0,2048);
+		 Ch-&gt;Grid-&gt;SetValuebyMap(mpos,999.0f);
+		 cellvalue=Ch-&gt;Grid-&gt;GetValuebyMap(mpos);
+		 if(cellvalue == 999.0f){
+		 L.iprint(&quot;Test 2 PASSED&quot;);
+		 }else{
+		 G-&gt;L.iprint(&quot;Test 2 FAILED&quot;);
+		 }
+		 if(Ch-&gt;Grid-&gt;GridtoMap(Ch-&gt;Grid-&gt;MaptoGrid(mpos)) == mpos){
+		 G-&gt;L.iprint(&quot;Test 3 PASSED&quot;);
+		 }else{
+		 G-&gt;L.iprint(&quot;Test 3 FAILED&quot;);
+		 }
+		 cellvalue=0;
+		 float3 gpos = float3(4,0,4);
+		 Ch-&gt;Grid-&gt;SetValuebyGrid(gpos,799.0f);
+		 cellvalue=Ch-&gt;Grid-&gt;GetValuebyGrid(gpos);
+		 if(cellvalue == 799.0f){
+		 L.iprint(&quot;Test 4 PASSED&quot;);
+		 }else{
+		 G-&gt;L.iprint(&quot;Test 4 FAILED&quot;);
+		 }
+		 if(Ch-&gt;Grid-&gt;MaptoGrid(Ch-&gt;Grid-&gt;GridtoMap(gpos)) == gpos){
+		 G-&gt;L.iprint(&quot;Test 5 PASSED&quot;);
+		 }else{
+		 G-&gt;L.iprint(&quot;Test 5 FAILED&quot;);
+		 }
+		 if(Ch-&gt;Grid-&gt;IndextoGrid(Ch-&gt;Grid-&gt;GetIndex(gpos)) == gpos){
+		 G-&gt;L.iprint(&quot;Test 6 PASSED&quot;);
+		 }else{
+		 G-&gt;L.iprint(&quot;Test 6 FAILED&quot;);
+		 }
+		 Ch-&gt;MakeTGA();
+		 }*/else if(tmsg == string(&quot;.aicheat&quot;)){
+			 //chcb = G-&gt;gcb-&gt;GetCheatInterface();
+			 if(Cached-&gt;cheating== false){
+				 Cached-&gt;cheating = true;
+				 chcb-&gt;SetMyHandicap(1000.0f);
+				 if(L.FirstInstance() == true) L.iprint(&quot;Make sure you've typed .cheat for full cheating!&quot;);
+				 // Spawn 4 commanders around the starting position
+				 CUnitTypeData* ud = this-&gt;UnitDefLoader-&gt;GetUnitTypeDataByName(ComName);
+				 if(ud != 0){
+					 float3 pos = Map-&gt;basepos;
+					 pos = cb-&gt;ClosestBuildSite(ud-&gt;GetUnitDef(), pos, 1000.0f, 0);
+					 int ij = chcb-&gt;CreateUnit(ComName.c_str(), pos);
+					 if(ij != 0) Actions-&gt;RandomSpiral(ij);
+					 float3 epos = pos;
+					 epos.z -= 1300.0f;
+					 float angle = float(mrand()%320);
+					 pos = G-&gt;Map-&gt;Rotate(epos, angle, pos);
+					 pos =  cb-&gt;ClosestBuildSite(ud-&gt;GetUnitDef(), pos, 1000, 300, 1);
+					 ///float3 ClosestBuildSite(const UnitDef* unitdef,float3 pos,float searchRadius,int minDist, int facing);
+					 ij = chcb-&gt;CreateUnit(ComName.c_str(), pos);
+					 if(ij != 0) Actions-&gt;RandomSpiral(ij);
+					 epos = pos;
+					 epos.z -= 900.0f;
+
+					 angle = float(mrand()%320);
+					 pos = G-&gt;Map-&gt;Rotate(epos, angle, pos);
+					 pos =  cb-&gt;ClosestBuildSite(ud-&gt;GetUnitDef(), pos, 1000, 300, 0);
+					 ///
+					 ij = chcb-&gt;CreateUnit(ComName.c_str(), pos);
+					 if(ij != 0){
+						 Actions-&gt;RandomSpiral(ij);
+					 }
+				 }
+			 }else if(Cached-&gt;cheating == true){
+				 Cached-&gt;cheating  = false;
+				 if(L.FirstInstance() == true)L.iprint(&quot;cheating is now disabled therefore NTai will no longer cheat&quot;);
+			 }
+		 }
+		//START_EXCEPTION_HANDLING
+		CMessage message(string(&quot;##&quot;)+msg);
 		message.AddParameter(player);
 		FireEvent(message);
-
+		//END_EXCEPTION_HANDLING(&quot;CMessage message(\&quot;msg gotmsg\&quot;); FireEvent(message);&quot;)
 	}
 
 	// ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
@@ -537,7 +784,7 @@
 	// ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
 
 	void Global::InitAI(IAICallback* callback, int team){
-		L.print(&quot;Initializing&quot;);
+		L.print(&quot;Initialisising&quot;);
 
 		mrand.seed(uint(time(NULL)*team));
 		string filename = info-&gt;datapath + slash + string(&quot;NTai.tdf&quot;);
@@ -685,11 +932,6 @@
 
 		Ch-&gt;InitAI(this);
 		L.print(&quot;Chaser Init'd&quot;);
-
-		gproxy = boost::shared_ptr&lt;IModule&gt;(new CGlobalProxy(this));
-		gproxy-&gt;Init();
-		RegisterMessageHandler(gproxy);
-
 	}
 
 	int Global::GetCurrentFrame(){
@@ -795,26 +1037,53 @@
 
 	int Global::GetEnemyUnits(int* units, const float3 &amp;pos, float radius){
 		NLOG(&quot;Global::GetEnemyUnits :: A&quot;);
+		//if(Cached-&gt;cheating == true){
 		return chcb-&gt;GetEnemyUnits(units, pos, radius);
+		/*}else{
+		 return cb-&gt;GetEnemyUnits(units,pos,radius);
+		 }*/
 	}
 
 
 	int Global::GetEnemyUnitsInRadarAndLos(int* units){
 		NLOG(&quot;Global::GetEnemyUnitsinradarandLOS :: B&quot;);
+		/*if(GetCurrentFrame() - Cached-&gt;lastcacheupdate&gt;  30){
+		 if(Cached-&gt;cheating == true){
+		 Cached-&gt;enemy_number = chcb-&gt;GetEnemyUnits(Cached-&gt;encache);
+		 for(uint h = 0; h &lt; Cached-&gt;enemy_number; h++){
+		 units[h] = Cached-&gt;encache[h];
+		 }
+		 Cached-&gt;lastcacheupdate = cb-&gt;GetCurrentFrame();
+		 return Cached-&gt;enemy_number;
+		 }else{
+		 return cb-&gt;GetEnemyUnitsInRadarAndLos(Cached-&gt;encache);
+		 }
+		 }
+		 if(Cached-&gt;cheating == true){*/
 		return chcb-&gt;GetEnemyUnits(units);
-
+		/*	Cached-&gt;enemy_number = chcb-&gt;GetEnemyUnits(Cached-&gt;encache);
+		 for(uint h = 0; h &lt; Cached-&gt;enemy_number; h++){
+		 units[h] = Cached-&gt;encache[h];
+		 }
+		 ///*}else{
+		 Cached-&gt;enemy_number = cb-&gt;GetEnemyUnitsInRadarAndLos(Cached-&gt;encache);
+		 }*/
+		//return Cached-&gt;enemy_number;*/
 	}
 
 	int Global::GetEnemyUnits(int* units){
 		NLOG(&quot;Global::GetEnemyUnits :: B&quot;);
-		if(GetCurrentFrame() - Cached-&gt;lastcacheupdate &gt; 30){
+		if(GetCurrentFrame() - Cached-&gt;lastcacheupdate&gt;  30){
+			//if(Cached-&gt;cheating == true){
 			Cached-&gt;enemy_number = chcb-&gt;GetEnemyUnits(Cached-&gt;encache);
-			Cached-&gt;lastcacheupdate = cb-&gt;GetCurrentFrame();
+			/*	}else{
+			 Cached-&gt;enemy_number = cb-&gt;GetEnemyUnits(Cached-&gt;encache);
+			 }
+			 */	Cached-&gt;lastcacheupdate = cb-&gt;GetCurrentFrame();
 		}
 		for(uint h = 0; h &lt; Cached-&gt;enemy_number; h++){
 			units[h] = Cached-&gt;encache[h];
 		}
-
 		return Cached-&gt;enemy_number;
 	}
 
@@ -937,14 +1206,10 @@
 	}
 
 	bool Global::LoadUnitData(){
-
 		if(G-&gt;L.FirstInstance()){
-
 			int unum = cb-&gt;GetNumUnitDefs();
-
 			const UnitDef** ulist = new const UnitDef*[unum];
 			cb-&gt;GetUnitDefList(ulist);
-
 			for(int i = 0; i &lt; unum; i++){
 				const UnitDef* pud = ulist[i];
 
@@ -966,11 +1231,10 @@
 				ef *= 2;
 
 				if(pud-&gt;weapons.empty() == false){
-
 					for(vector&lt;UnitDef::UnitDefWeapon&gt;::const_iterator k = pud-&gt;weapons.begin();k != pud-&gt;weapons.end();++k){
-
+						//ef += k-&gt;def-&gt;
 						float av=0;
-						int numTypes;
+						int numTypes;// = cb-&gt;getk-&gt;def-&gt;damages.numTypes;
 						cb-&gt;GetValue(AIVAL_NUMDAMAGETYPES, &amp;numTypes);
 						for(int a=0;a&lt;numTypes;++a){
 							if(a == 0){
@@ -1018,7 +1282,7 @@
 
 				cq.GetDef(firstload, &quot;1&quot;, &quot;AI\\firstload&quot;);
 
-				if(firstload){
+				if(firstload == true){
 					L.iprint(&quot; This is the first time this mod has been loaded, up. Take this first game to train NTai up, and be careful of throwing the same units at it over and over again&quot;);
 					firstload = false;
 
@@ -1033,7 +1297,6 @@
 
 				loaded = true;
 				return true;
-
 			} else{
 
 				for(int i = 0; i &lt; unum; i++){
@@ -1044,12 +1307,9 @@
 					}else{
 						ts += 20*ulist[i]-&gt;weapons.size();
 					}
-
 					string eu = ulist[i]-&gt;name;
-					
 					tolowercase(eu);
 					trim(eu);
-					
 					efficiency[eu] = ts;
 				}
 
@@ -1066,7 +1326,7 @@
 	bool Global::SaveUnitData(){
 		NLOG(&quot;Global::SaveUnitData()&quot;);
 
-		if(L.FirstInstance()){
+		if(L.FirstInstance() == true){
 			ofstream off;
 
 			string filename = info-&gt;datapath;
@@ -1079,13 +1339,9 @@
 			off.open(filename.c_str());
 
 			if(off.is_open() == true){
+				off &lt;&lt; &quot;[AI]&quot; &lt;&lt; endl &lt;&lt; &quot;{&quot; &lt;&lt; endl &lt;&lt; &quot;    // &quot; &lt;&lt; AI_NAME &lt;&lt; &quot; AF :: unit efficiency cache file&quot; &lt;&lt; endl &lt;&lt; endl;
 
-				off &lt;&lt; &quot;[AI]&quot; &lt;&lt; endl;
-				off &lt;&lt; &quot;{&quot; &lt;&lt; endl;
-				off &lt;&lt; &quot;    // &quot; &lt;&lt; AI_NAME &lt;&lt; &quot; AF :: unit efficiency cache file&quot; &lt;&lt; endl;
-				off &lt;&lt; endl;
-
-				off &lt;&lt; &quot;    version=&quot;&lt;&lt; AI_NAME &lt;&lt;&quot;;&quot; &lt;&lt; endl;
+				off &lt;&lt; &quot;    version=XE9.79;&quot; &lt;&lt; endl;
 				off &lt;&lt; &quot;    firstload=&quot; &lt;&lt; firstload &lt;&lt; &quot;;&quot; &lt;&lt; endl;
 				off &lt;&lt; &quot;    modname=&quot; &lt;&lt; G-&gt;cb-&gt;GetModName() &lt;&lt; &quot;;&quot; &lt;&lt; endl;
 				off &lt;&lt; &quot;    iterations=&quot; &lt;&lt; iterations &lt;&lt; &quot;;&quot; &lt;&lt; endl;
@@ -1094,13 +1350,10 @@
 				off &lt;&lt; &quot;    [VALUES]&quot; &lt;&lt; endl &lt;&lt; &quot;    {&quot; &lt;&lt; endl;
 
 				for(map&lt;string, float&gt;::const_iterator i = efficiency.begin(); i != efficiency.end(); ++i){
-					off &lt;&lt; &quot;        &quot;&lt;&lt; i-&gt;first &lt;&lt; &quot;=&quot; &lt;&lt; i-&gt;second &lt;&lt; &quot;;&quot;;
-					off &lt;&lt; &quot;// &quot; &lt;&lt; unit_names[i-&gt;first] &lt;&lt; &quot; :: &quot;&lt;&lt; unit_descriptions[i-&gt;first]&lt;&lt;endl;
+					off &lt;&lt; &quot;        &quot;&lt;&lt; i-&gt;first &lt;&lt; &quot;=&quot; &lt;&lt; i-&gt;second &lt;&lt; &quot;;    // &quot; &lt;&lt; unit_names[i-&gt;first] &lt;&lt; &quot; :: &quot;&lt;&lt; unit_descriptions[i-&gt;first]&lt;&lt;endl;
 				}
-
 				off &lt;&lt; &quot;    }&quot; &lt;&lt; endl;
-				off &lt;&lt; &quot;    [NAMES]&quot; &lt;&lt; endl;
-				off &lt;&lt; &quot;    {&quot;&lt;&lt; endl;
+				off &lt;&lt; &quot;    [NAMES]&quot; &lt;&lt; endl &lt;&lt; &quot;    {&quot;&lt;&lt; endl;
 
 				for(map&lt;string, float&gt;::const_iterator i = efficiency.begin(); i != efficiency.end(); ++i){
 					off &lt;&lt; &quot;        &quot;&lt;&lt; i-&gt;first &lt;&lt; &quot;=&quot; &lt;&lt; unit_names[i-&gt;first] &lt;&lt; &quot;;&quot; &lt;&lt;endl;
@@ -1108,8 +1361,7 @@
 
 				off &lt;&lt; &quot;    }&quot; &lt;&lt; endl;
 
-				off &lt;&lt; &quot;    [DESCRIPTIONS]&quot; &lt;&lt; endl;
-				off &lt;&lt; &quot;    {&quot;&lt;&lt; endl;
+				off &lt;&lt; &quot;    [DESCRIPTIONS]&quot; &lt;&lt; endl &lt;&lt; &quot;    {&quot;&lt;&lt; endl;
 
 				for(map&lt;string, float&gt;::const_iterator i = efficiency.begin(); i != efficiency.end(); ++i){
 					off &lt;&lt; &quot;        &quot;&lt;&lt; i-&gt;first &lt;&lt; &quot;=&quot; &lt;&lt; unit_descriptions[i-&gt;first] &lt;&lt; &quot;;&quot;&lt;&lt;endl;
@@ -1117,41 +1369,31 @@
 
 				off &lt;&lt; &quot;    }&quot; &lt;&lt; endl;
 				off &lt;&lt; &quot;}&quot; &lt;&lt; endl;
-
 				off.close();
 
 				saved = true;
 				return true;
-
 			}else{
 				G-&gt;L.print(&quot;failed to save :&quot; + filename);
 				off.close();
-
 				return false;
 			}
 		}
-
 		return false;
 	}
 
 	float Global::GetTargettingWeight(string unit, string target){
-
 		float tempscore = 0;
 
-		if(!info-&gt;hardtarget){
-
+		if(info-&gt;hardtarget == false){
 			tempscore = GetEfficiency(target);
-
 		}else{
-
 			string fh = unit + &quot;\\target_weights\\&quot; + target;
 			string fg = unit + &quot;\\target_weights\\undefined&quot;;
 
 			float fz = GetEfficiency(target);
 			string tempdef = Get_mod_tdf()-&gt;SGetValueDef(to_string(fz), fg.c_str());
-			
-			// load &quot;unitname\\target_weights\\enemyunitname&quot; to retirieve targetting weights
-			tempscore = (float)atof(Get_mod_tdf()-&gt;SGetValueDef(tempdef, fh).c_str()); 
+			tempscore = (float)atof(Get_mod_tdf()-&gt;SGetValueDef(tempdef, fh).c_str()); // load &quot;unitname\\target_weights\\enemyunitname&quot; to retirieve targetting weights
 		}
 
 		return tempscore;
@@ -1208,7 +1450,7 @@
 	}
 
 	void Global::FireEvent(CMessage &amp;message){
-		if(message.IsType(&quot;&quot;)){
+		if(message.GetType() == string(&quot;&quot;)){
 			return;
 		}
 
@@ -1233,6 +1475,8 @@
 
 }
 
+// ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
+
 /** Random note
 unitdef-&gt;type can be one of the following:
  MetalExtractor

Modified: trunk/AI/Global/NTai/AI/NTai/Core/Global.h
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Core/Global.h	2008-03-17 19:53:35 UTC (rev 5590)
+++ trunk/AI/Global/NTai/AI/NTai/Core/Global.h	2008-03-17 20:43:16 UTC (rev 5591)
@@ -1,8 +1,9 @@
-// ||||||||||||||||||||||||||||||||||||||||||||||||
+// ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
 // Global class implementation.
 
-#include &quot;CGlobalProxy.h&quot;
 
+// ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
+//using namespace std;
 namespace ntai {
 
 	void trim(string &amp;str);
@@ -10,262 +11,91 @@
 	bool ValidUnitID(int id);
 
 
+	// ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
+
 	class Global{
 	public:
 		//destructor/constructor
 		virtual ~Global(); // destructor
 		Global(IGlobalAICallback* callback); // constructor
 
-		/* 
-		 * A class that implements what this class implements
-		 * using events so that theyre correctly throttle
-		 */
-		boost::shared_ptr&lt;IModule&gt; gproxy;
+		CMetalHandler* M; // mex positioning
+		Log L; // Logging class
 
-		/*
-		 * mex positioning
-		 */
-		CMetalHandler* M; 
+		Planning* Pl; // Deals with planning things, (only feasible() is actually used)
+		Global* G; // pointer to this class so that macros work
 
-		/*
-		 * Logging class
-		 */
-		Log L; 
-
-		/*
-		 * Deals with planning things, (only feasible() is
-		 * actually used)
-		 */
-		Planning* Pl;
-
-		/*
-		 * pointer to this class so that macros work
-		 */
-		Global* G;
-
 		IAICheats* chcb;
+		IAICallback* cb;// engine callback interface
+		IGlobalAICallback* gcb;// global AI engine callback interface
 
-		/*
-		 * engine callback interface
-		 */
-		IAICallback* cb;
-
-		/*
-		 * global AI engine callback interface
-		 */
-		IGlobalAICallback* gcb;
-
-		/*
-		 * Chaser Agent, deals with attacking and things such
-		 * as kamikaze units/dgunning/stockpiling missiles/several
-		 * attack unit behaviours
-		 */
-		Chaser* Ch;
-
+		Chaser* Ch;// Chaser Agent, deals with attacking and things such as kamikaze units/dgunning/stockpiling missiles/several attack unit behaviours
 		CUnitDefLoader* UnitDefLoader;
 
-		/*
-		 * Construction helper
-		 */
-		boost::shared_ptr&lt;CManufacturer&gt; Manufacturer;
-
-		/*
-		 * Building placement algorithm
-		 */
-		boost::shared_ptr&lt;CBuildingPlacer&gt; BuildingPlacer;
-
-		/*
-		 * Construction rules (AAI/OTAI/JCAI style building selection)
-		 */
-		CEconomy* Economy;
-
-		/* 
-		 * Handles the caching of orders sent to the engine, aswell
-		 * as a few other things like delayed orders etc...
-		 */
-		COrderRouter* OrderRouter;
+		boost::shared_ptr&lt;CManufacturer&gt; Manufacturer; // Construction helper
+		boost::shared_ptr&lt;CBuildingPlacer&gt; BuildingPlacer; // Building placement algorithm
+		CEconomy* Economy; // Construction rules (AAI/OTAI/JCAI style building selection)
+		COrderRouter* OrderRouter; // Handles the caching of orders sent to the engine, aswell as a few other things like delayed orders etc...
 		
 		CMap* Map;
-
 		CActions* Actions;
 		
-		/* 
-		 * Cached data or other data used across the AI at runtime
-		 */
-		CCached* Cached;
+		CCached* Cached; // cached data or other data used across the AI at runtime
+		CConfigData* info; // stuff loaded from configs that ideally should not change
 
-		/*
-		 * stuff loaded from configs that ideally should not change
-
-		 */
-		CConfigData* info;
-
-		/*
-		 * handles dragon teeth rings
-		 */
-		CDTHandler* DTHandler;
-		
+		CDTHandler* DTHandler; // handles dragon teeth rings
 		CRadarHandler* RadarHandler;
+		//CTaskFactory* TaskFactory;
 
 
-		/*
-		 * unitname -&gt; human name
-		 */
-		std::map&lt;std::string,std::string&gt; unit_names;
+		std::map&lt;std::string,std::string&gt; unit_names; //unitname -&gt; human name
+		std::map&lt;std::string,std::string&gt; unit_descriptions; //unitname -&gt; human name
 
-		/*
-		 * unitname -&gt; human name
-		 */
-		std::map&lt;std::string,std::string&gt; unit_descriptions;
 
-
 		float max_energy_use;
 
 
 		std::set&lt;int&gt; idlenextframe;
-
-
 		// Interface functions
-
-		/*
-		 * initialize the AI
-		 */
-		void InitAI(IAICallback* callback, int team);
-
-		/*
-		 * a unit has been created, but this is currently not used.....
-		 */
-		void UnitCreated(int unit);
-
-		/*
-		 * a unit has been finished (finished being built)
-		 */
-		void UnitFinished(int unit);
-
-		/*
-		 * a unit has been destroyed
-		 */
-		void UnitDestroyed(int unit, int attacker);
-
-		/*
-		 * an enemy has entered LOS
-		 */
-		void EnemyEnterLOS(int enemy);
-
-		/*
-		 * An enemy has left LOS
-		 */
-		void EnemyLeaveLOS(int enemy);
-
-		/*
-		 * an enemy has entered radar
-		 */
-		void EnemyEnterRadar(int enemy);
-
-		/*
-		 * an enemy has left radar
-		 */
-		void EnemyLeaveRadar(int enemy);
-
-		/*
-		 * 
-		 */
+		void InitAI(IAICallback* callback, int team); // initialize the AI
+		void UnitCreated(int unit); // a unit has been created, but this is currently not used.....
+		void UnitFinished(int unit); // a unit has been finished (finished being built)
+		void UnitDestroyed(int unit, int attacker); // a unit has been destroyed
+		void EnemyEnterLOS(int enemy); // an enemy has entered LOS
+		void EnemyLeaveLOS(int enemy); // An enemy has left LOS
+		void EnemyEnterRadar(int enemy); // an enemy has entered radar
+		void EnemyLeaveRadar(int enemy); // an enemy has left radar
 		void EnemyDamaged(int damaged,int attacker,float damage,float3 dir);
-
-		/*
-		 * an enemy has been destroyed
-		 */
-		void EnemyDestroyed(int enemy,int attacker);
-
-		/*
-		 * a unit is now idle
-		 */
-		void UnitIdle(int unit);
-
-		/*
-		 * received a console message
-		 */
-		void GotChatMsg(const char* msg, int player);
-
-		/*
-		 * a unit has been damaged
-		 */
-		void UnitDamaged(int damaged, int attacker, float damage,float3 dir);
-
-		/*
-		 * a unit has failed to move to its given location
-		 */
-		void UnitMoveFailed(int unit);
-
-		/*
-		 * called every game frame (usually 30 frames per second)
-		 */
-		void Update();// 
-
+		void EnemyDestroyed(int enemy,int attacker); // an enemy has been destroyed
+		void UnitIdle(int unit); // a unit is now idle
+		void GotChatMsg(const char* msg, int player); // received a console message
+		void UnitDamaged(int damaged, int attacker, float damage,float3 dir); // a unit has been damaged
+		void UnitMoveFailed(int unit); // a unit has failed to mvoe to its given location
+		void Update();// called every frame (usually 30 frames per second)
 		void SortSolobuilds(int unit);
 
 		std::string ComName;
+		void Crash();// Used to crash NTAI when the user types the &quot;.crash&quot; command
 
-		/*
-		 * Used to crash NTAI when the user types the &quot;.crash&quot; command
-		 */
-		void Crash();
-
 		bool InLOS(float3 pos);
 
 		int GetEnemyUnits(int* units, const float3 &amp;pos, float radius);
-
 		int GetEnemyUnits(int* units);
-
 		int GetEnemyUnitsInRadarAndLos(int* units);
-
-		/*
-		 * returns enemies in LOS (faster than the callback function)
-		 */
-		std::set&lt;int&gt; LOSGetEnemy(){
+		std::set&lt;int&gt; LOSGetEnemy(){// returns enemies in LOS (faster than the callback function)
 			return Cached-&gt;enemies;
 		}
-		
-		/*
-		 * reads a file in from the given path and shoves it in the
-		 * buffer string provided
-		 */
-		bool ReadFile(string filename, string* buffer); // 
-		
-		/*
-		 * returns a TdfParser object loaded with the contents of
-		 * mod.tdf
-		 */
-		TdfParser* Get_mod_tdf();
+		bool ReadFile(string filename, string* buffer); // reads a file in from the given path and shoves it in the buffer string provided
+		TdfParser* Get_mod_tdf();// returns a TdfParser object loaded with the contents of mod.tdf
 
 		//learning stuff
-		
 		void SetEfficiency(std::string s, float e);
-		
-		/*
-		 * returns the efficiency of the unit with name s.
-		 */
-		float GetEfficiency(std::string s, float def_value=500.0f);
-		
-		/*
-		 * returns the efficiency of the unit with name s,
-		 * but not including those in the vector constructors
-		 * if it's a builder to prevent recursive loops.
-		 */
-		float GetEfficiency(std::string s,std::set&lt;std::string&gt;&amp; doneconstructors,int techlevel=1);
-		
+		float GetEfficiency(std::string s, float def_value=500.0f); // returns the efficiency of the unit with name s.
+		float GetEfficiency(std::string s,std::set&lt;std::string&gt;&amp; doneconstructors,int techlevel=1); // returns the efficiency of the unit with name s, but not including those in the vector constructors if it's a builder to prevent recursive loops
 		float GetTargettingWeight(std::string unit, std::string target);
+		bool LoadUnitData(); // loads unit efficiency data from the learning file
+		bool SaveUnitData(); // saves unit efficiency data back to file
 
-		/*
-		 * loads unit efficiency data from the learning file
-		 */
-		bool LoadUnitData();
-		
-		/*
-		 * saves unit efficiency data back to file
-		 */
-		bool SaveUnitData();
-
 		int GetCurrentFrame();
 		const UnitDef* GetEnemyDef(int enemy);
 
@@ -280,10 +110,7 @@
 			}*/
 		}
 
-		/*
-		 * 1 = true, 2 = false, 0 = find out for us/dunno
-		 */
-		float3 GetUnitPos(int unitid,int enemy=0);
+		float3 GetUnitPos(int unitid,int enemy=0);// 1 = true, 2 = false, 0 = find out for us/wedunno
 
 		MTRand_int32 mrand;
 
@@ -304,3 +131,4 @@
 	};
 
 }
+// ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||

Modified: trunk/AI/Global/NTai/AI/NTai/Core/IModule.h
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Core/IModule.h	2008-03-17 19:53:35 UTC (rev 5590)
+++ trunk/AI/Global/NTai/AI/NTai/Core/IModule.h	2008-03-17 20:43:16 UTC (rev 5591)
@@ -12,7 +12,7 @@
 		IModule(Global* GL);
 		virtual ~IModule();
 		virtual void RecieveMessage(CMessage &amp;message)=0;
-		virtual bool Init()=0;//boost::shared_ptr&lt;IModule&gt; me
+		virtual bool Init()=0;
 		virtual void End(){}
 		virtual bool IsValid(){
 			return valid;
@@ -25,11 +25,6 @@
 		virtual void DestroyModule();
 
 		virtual void operator()(){}
-
-		virtual bool Succeeded(){
-			return true;
-		}
-
 		Global* G;
 	protected:
 		bool valid;

Modified: trunk/AI/Global/NTai/AI/NTai/Core/include.h
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Core/include.h	2008-03-17 19:53:35 UTC (rev 5590)
+++ trunk/AI/Global/NTai/AI/NTai/Core/include.h	2008-03-17 20:43:16 UTC (rev 5591)
@@ -117,9 +117,8 @@
 
 // Global classes
 
-
 #include &quot;Global.h&quot;											// (the root object representing the AI itself)
 
 // The name NTAI gives to the spring engine.
-const char AI_NAME[]= {&quot;NTai XE9.8+&quot;};
+const char AI_NAME[]= {&quot;NTai XE9.79+&quot;};
 

Modified: trunk/AI/Global/NTai/AI/NTai/Helpers/Terrain/CBuildingPlacer.cpp
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Helpers/Terrain/CBuildingPlacer.cpp	2008-03-17 19:53:35 UTC (rev 5590)
+++ trunk/AI/Global/NTai/AI/NTai/Helpers/Terrain/CBuildingPlacer.cpp	2008-03-17 20:43:16 UTC (rev 5591)
@@ -19,7 +19,7 @@
 	}
 
 	void CBuildingPlacer::RecieveMessage(CMessage &amp;message){
-		/*if(message.GetType()==string(&quot;unitcreated&quot;)){
+		if(message.GetType()==string(&quot;unitcreated&quot;)){
 			int uid = (int)message.GetParameter(0);
 			float3 p = G-&gt;GetUnitPos(uid);
 			if(this-&gt;tempgeo.empty()==false){
@@ -30,32 +30,25 @@
 					}
 				}
 			}
-		}else
-		if(message.GetType()==string(&quot;unitdestroyed&quot;)){
+		}else if(message.GetType()==string(&quot;unitdestroyed&quot;)){
 			int uid = (int)message.GetParameter(0);
 			tempgeo.erase(uid);
 		}else if(message.GetType()==string(&quot;unitidle&quot;)){
 			int uid = (int)message.GetParameter(0);
 			tempgeo.erase(uid);
-		} */
-		if(message.IsType(&quot;update&quot;)){
+		}
+		if(message.GetType()==string(&quot;update&quot;)){
 			if(G-&gt;L.IsVerbose()){
 				if(message.GetFrame()%35 == 0){
-
 					map&lt;int, boost::shared_ptr&lt;CGridCell&gt; &gt; n = blockingmap.GetGrid();
-					
 					if(!n.empty()){
-
 						for(map&lt;int, boost::shared_ptr&lt;CGridCell&gt; &gt;::iterator i = n.begin(); i != n.end(); ++i){
-							
 							boost::shared_ptr&lt;CGridCell&gt; c = i-&gt;second;
 							int j = c-&gt;GetIndex();
-
 							float3 pos = blockingmap.GridtoMap(blockingmap.IndextoGrid(j));
 							pos.y = G-&gt;cb-&gt;GetElevation(pos.x, pos.z);
 							//pos.y -= 20; // move it down into the ground so it doesnt obscure low lying units
 							if(G-&gt;cb-&gt;PosInCamera(pos, 1000)){
-
 								if(G-&gt;UnitDefLoader-&gt;HasUnit(&quot;lttank&quot;)!= 0){
 									G-&gt;cb-&gt;DrawUnit(&quot;lttank&quot;, pos, 1, 35, 0, true, false, 0);
 								}else if(G-&gt;UnitDefLoader-&gt;HasUnit(&quot;armpw&quot;)!= 0){
@@ -67,9 +60,9 @@
 								}else if(G-&gt;UnitDefLoader-&gt;HasUnit(&quot;bit&quot;)!= 0){
 									G-&gt;cb-&gt;DrawUnit(&quot;bit&quot;, pos, 1, 35, 0, true, false, 0);
 								}
-
+								//G-&gt;cb-&gt;DrawUnit(&quot;armpw&quot;,pos,1,35,0,false,false,0);
+								//G-&gt;cb-&gt;DrawUnit(&quot;arm_peewee&quot;,pos,1,35,0,false,false,0);
 							}
-
 							//int k = G-&gt;cb-&gt;CreateLineFigure(pos,pos+float3(16,50,0),10,1,10,0);
 							//G-&gt;cb-&gt;SetFigureColor(k,1,0,0,0.5);
 						}
@@ -80,6 +73,7 @@
 	}
 
 	bool CBuildingPlacer::Init(){
+		const float* slope = G-&gt;cb-&gt;GetSlopeMap();
 		float3 mapdim= float3((float)G-&gt;cb-&gt;GetMapWidth()*SQUARE_SIZE*2, 0, (float)G-&gt;cb-&gt;GetMapHeight()*SQUARE_SIZE*2);
 
 		int smaxW = G-&gt;cb-&gt;GetMapWidth()/16;
@@ -87,15 +81,12 @@
 
 		int* f = new int[10000];
 		int fnum = 0;
-
 		fnum = G-&gt;cb-&gt;GetFeatures(f, 9999);
-
 		if(fnum &gt; 0){
-
+			//
 			for(int i = 0; i &lt; fnum; ++i){
-
+				//
 				const FeatureDef* fd = G-&gt;cb-&gt;GetFeatureDef(f[i]);
-
 				if(fd != 0){
 					if(fd-&gt;geoThermal){
 						float3 fpos = G-&gt;cb-&gt;GetFeaturePos(f[i]);
@@ -106,22 +97,45 @@
 				}
 			}
 		}
+		/*slopemap.Initialize(mapdim,float3(32,0,32),true);
+		 slopemap.SetDefaultGridValue(0);
+		 slopemap.SetMinimumValue(0);
+		 slopemap.UseArray(slope,smaxW*smaxH,smaxH,smaxW);*/
 
-		delete[] f;
+		/*	geomap.Initialize(mapdim,float3(124,0,124),true);
+		 geomap.SetDefaultGridValue(0);
+		 geomap.SetMinimumValue(0);*/
 
-		if(geolist.empty()){
-			//
-			G-&gt;L.print(&quot;This map does not have identifiablegeothermal vents&quot;);
-		}
-		
+		/*const float* heightmaparray = G-&gt;cb-&gt;GetHeightMap();
+		lowheightmap.Initialize(mapdim, float3(32, 0, 32), true);
+		lowheightmap.SetDefaultGridValue(0);
+		lowheightmap.SetMinimumValue(0);
+		lowheightmap.UseArrayLowValues(heightmaparray, smaxW*smaxH*2, smaxH*2, smaxW*2);
 
+		highheightmap.Initialize(mapdim, float3(32, 0, 32), true);
+		highheightmap.SetDefaultGridValue(0);
+		highheightmap.SetMinimumValue(0);
+		highheightmap.UseArrayHighValues(heightmaparray, smaxW*smaxH*2, smaxH*2, smaxW*2);*/
+
 		blockingmap.Initialize(mapdim, float3(32, 0, 32), true);
 		blockingmap.SetDefaultGridValue(0);
 		blockingmap.SetMinimumValue(1);
 
+		/*G-&gt;RegisterMessageHandler(&quot;unitcreated&quot;, me);
+		G-&gt;RegisterMessageHandler(&quot;unitdestroyed&quot;, me);
+		G-&gt;RegisterMessageHandler(&quot;unitidle&quot;, me);
+		G-&gt;RegisterMessageHandler(&quot;update&quot;, me);*/
 		return true;
 	}
 
+	/*float3 CBuildingPlacer::GetBuildPos(float3 builderpos, const UnitDef* builder, const UnitDef* building, float freespace){
+		if(G-&gt;UnitDefHelper-&gt;IsFactory(builder)&amp;&amp;(!G-&gt;UnitDefHelper-&gt;IsHub(builder))){
+			if(G-&gt;UnitDefHelper-&gt;IsMobile(building)){
+				return builderpos;
+			}
+		}
+		return findfreespace(building, builderpos, freespace, 1000);
+	}*/
 
 	class CBuildAlgorithm : public IModule{
 	public:
@@ -138,22 +152,13 @@
 			valid(true),
 			G(G){ }
 
-		void RecieveMessage(CMessage &amp;message){
-		}
-		
-		bool Init(){
-			return true;
-		}
-
+		void RecieveMessage(CMessage &amp;message){}
+		bool Init(){ return true;}
 		void operator()(){
-
-			if(!reciever-&gt;IsValid()){
-				return;
-			}
-
+			//boost::mutex::scoped_lock lock(io_mutex[building-&gt;id]);
+			if(!reciever-&gt;IsValid()) return;
 			float3 bestPosition = UpVector;
 			float bestDistance = 500000.0f;
-
 			if(G-&gt;L.IsVerbose()){
 				AIHCAddMapPoint ac;
 				ac.label=new char[11];
@@ -166,10 +171,8 @@
 			if(builder-&gt;IsHub()){
 				search_radius = builder-&gt;GetUnitDef()-&gt;buildDistance;
 			}
-
 			CUBuild b;
 			b.Init(G, builder, 0);
-
 			int e=0;
 			vector&lt;float3&gt; cells = blockingmap-&gt;GetCellsInRadius(builderpos, search_radius, e);
 
@@ -242,7 +245,6 @@
 						// update best position/distance
 						bestPosition = gpos;
 						bestDistance = distance;
-
 					}else{
 						continue;
 					}
@@ -298,8 +300,17 @@
 	};
 
 	void CBuildingPlacer::GetBuildPosMessage(IModule* reciever, int builderID, float3 builderpos, CUnitTypeData* builder, CUnitTypeData* building, float freespace){
-
-		if(!reciever-&gt;IsValid()==false){
+		/*if(G-&gt;UnitDefHelper-&gt;IsFactory(builder)&amp;&amp;(!G-&gt;UnitDefHelper-&gt;IsHub(builder))){
+		 if(G-&gt;UnitDefHelper-&gt;IsMobile(building)){
+		 CMessage m(&quot;buildposition&quot;);
+		 m.AddParameter(builderpos);
+		 //if(reciever-&gt;IsValid()){
+		 reciever-&gt;RecieveMessage(m);
+		 //}
+		 return;
+		 }
+		 }*/
+		if(reciever-&gt;IsValid()==false){
 			// oh noes! invalid module
 			CMessage m(&quot;buildposition&quot;);
 			m.AddParameter(UpVector);
@@ -312,7 +323,6 @@
 
 		float3 q = UpVector;
 		if(building-&gt;IsMex()){
-
 			q = G-&gt;M-&gt;getNearestPatch(builderpos, 0.7f, building-&gt;GetUnitDef()-&gt;extractsMetal, building-&gt;GetUnitDef());
 			if((G-&gt;Map-&gt;CheckFloat3(q) == false)||(builder-&gt;IsHub()&amp;&amp;(builder-&gt;GetUnitDef()-&gt;buildDistance &lt; q.distance2D(builderpos)))){
 				//G-&gt;L.print(&quot;zero mex co-ordinates intercepted&quot;);
@@ -422,18 +432,17 @@
 		}else if(building-&gt;GetUnitDef()-&gt;needGeo){
 
 			NLOG(&quot;CBuildingPlacer::GetBuildPosMessage geo&quot;);
-			//int* f = new int[20000];
-			//int fnum = 0;
+			int* f = new int[20000];
+			int fnum = 0;
 
-			//if(builder-&gt;IsHub()){
-			//	fnum = G-&gt;cb-&gt;GetFeatures(f, 19999, builderpos, builder-&gt;GetUnitDef()-&gt;buildDistance);
-			//}else{
-			//	fnum = G-&gt;cb-&gt;GetFeatures(f, 19999);
-			//}
+			if(builder-&gt;IsHub()){
+				fnum = G-&gt;cb-&gt;GetFeatures(f, 19999, builderpos, builder-&gt;GetUnitDef()-&gt;buildDistance);
+			}else{
+				fnum = G-&gt;cb-&gt;GetFeatures(f, 19999);
+			}
 
 			float3 result = UpVector;
 
-			//if(fnum &gt;0){
 			if(!geolist.empty()){
 
 				float gsearchdistance;
@@ -442,30 +451,29 @@
 				G-&gt;Get_mod_tdf()-&gt;GetDef(gsearchdistance, &quot;3000&quot;, &quot;AI\\geotherm\\searchdistance&quot;);
 				G-&gt;Get_mod_tdf()-&gt;GetDef(genemydist, &quot;600&quot;, &quot;AI\\geotherm\\noenemiesdistance&quot;);
 
-				float nearest_dist = 90000000;
+				float nearest_dist = 10000000;
 				int* a = new int[20000];
 
 				for(vector&lt;float3&gt;::iterator it = geolist.begin(); it != geolist.end(); ++it){
-					float3 gpos = *it;
-					float d = gpos.distance2D(builderpos);
+					float d = it-&gt;distance2D(builderpos);
 					if(d &lt; nearest_dist){
-						/*if(tempgeo.empty()==false){
+						if(tempgeo.empty()==false){
 							for(map&lt;int, float3&gt;::iterator i = tempgeo.begin(); i != tempgeo.end(); ++i){
-								if(i-&gt;second.distance2D(gpos) &lt; 100){
+								if(i-&gt;second.distance2D((*it)) &lt; 100){
 									continue;
 								}
 							}
-						}*/
+						}
 
-						if(G-&gt;cb-&gt;GetFriendlyUnits(a,gpos,100)&gt; 0){
+						if(G-&gt;cb-&gt;GetFriendlyUnits(a,*it,100)&gt; 0){
 							continue;
 						}
 
 						if(it-&gt;distance2D(builderpos) &lt; gsearchdistance){
 
-							if(G-&gt;cb-&gt;CanBuildAt(building-&gt;GetUnitDef(), gpos)&amp;&amp;(G-&gt;chcb-&gt;GetEnemyUnits(a, gpos, genemydist)&lt;1)){
+							if(G-&gt;cb-&gt;CanBuildAt(building-&gt;GetUnitDef(), *it)&amp;&amp;(G-&gt;chcb-&gt;GetEnemyUnits(a, *it, genemydist)&lt;1)){
 								nearest_dist = d;
-								result = gpos;
+								result = *it;
 							}
 
 						}
@@ -480,8 +488,8 @@
 			CMessage m(&quot;buildposition&quot;);
 			m.AddParameter(result);
 			reciever-&gt;RecieveMessage(m);
-			//tempgeo[builderID] = result;
-			//delete[] f;
+			tempgeo[builderID] = result;
+			delete[] f;
 
 			return;
 		}

Modified: trunk/AI/Global/NTai/AI/NTai/Helpers/Terrain/CBuildingPlacer.h
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Helpers/Terrain/CBuildingPlacer.h	2008-03-17 19:53:35 UTC (rev 5590)
+++ trunk/AI/Global/NTai/AI/NTai/Helpers/Terrain/CBuildingPlacer.h	2008-03-17 20:43:16 UTC (rev 5591)
@@ -17,9 +17,9 @@
 		void UnBlock(float3 pos, float radius);
 
 		CGridManager blockingmap;
-		//map&lt;int,float3&gt; tempgeo;
+		map&lt;int,float3&gt; tempgeo;
 		vector&lt;float3&gt; geolist;
 
 	protected:
 	};
-}
+}

Modified: trunk/AI/Global/NTai/AI/NTai/Helpers/Units/Actions.cpp
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Helpers/Units/Actions.cpp	2008-03-17 19:53:35 UTC (rev 5590)
+++ trunk/AI/Global/NTai/AI/NTai/Helpers/Units/Actions.cpp	2008-03-17 20:43:16 UTC (rev 5591)
@@ -381,25 +381,19 @@
         delete [] en;
         return false;
     }
-
 }
 
 void CActions::ScheduleIdle(int unit){
     NLOG(&quot;CActions::ScheduleIdle&quot;);
-
     if(ValidUnitID(unit)){
-
         TCommand tc(unit, &quot;schedule idle unit&quot;);
         tc.created = G-&gt;cb-&gt;GetCurrentFrame();
         tc.ID(CMD_IDLE);
-
         if(G-&gt;OrderRouter-&gt;GiveOrder(tc, false)== false){
             G-&gt;L.print(&quot;GiveOrder on scedule idle failed!!&quot;);
         }
     }
-
 }
-
 bool CActions::DGun(int uid, int enemy){
     NLOG(&quot;CActions::DGun&quot;);
 
@@ -409,39 +403,30 @@
     tc.c.timeOut = 3 SECONDS+(G-&gt;cb-&gt;GetCurrentFrame()%300) + G-&gt;cb-&gt;GetCurrentFrame(); // dont let this command get in the way of the commanders taskqueue with a never ending vendetta that can never be fulfilled
 
     tc.created = G-&gt;cb-&gt;GetCurrentFrame();
-
     if(G-&gt;OrderRouter-&gt;GiveOrder(tc, true)==false){
 		// GiveOrder returned an error
         return false; 
-
     }else{
         // Command successful, This unit is now dgunning
         return true;
-
     }
-
 }
-
 bool CActions::Reclaim(int uid, int enemy){
     NLOG(&quot;CActions::Reclaim&quot;);
-
     TCommand tc(uid, &quot;cmd_recl CActions::Reclaim&quot;);
     tc.ID(CMD_RECLAIM);
     tc.Push(enemy);
     tc.created = G-&gt;cb-&gt;GetCurrentFrame();
-
     return G-&gt;OrderRouter-&gt;GiveOrder(tc, true);
 }
 
 bool CActions::AreaReclaim(int uid, float3 pos, int radius){
     NLOG(&quot;CActions::AreaReclaim&quot;);
-
     TCommand tc(uid, &quot;cmd_recl CActions::AreaReclaim&quot;);
     tc.ID(CMD_RECLAIM);
     tc.PushFloat3(pos);
     tc.Push(radius);
     tc.created = G-&gt;cb-&gt;GetCurrentFrame();
-
     return G-&gt;OrderRouter-&gt;GiveOrder(tc, true);
 }
 
@@ -450,7 +435,7 @@
 	
 	CUnitTypeData* utd = G-&gt;UnitDefLoader-&gt;GetUnitTypeDataByUnitId(uid);
     
-	if(utd == 0){
+	if(utd == 0 ){
         G-&gt;L.print(&quot;Dgunning failed, utd == 0&quot;);
         return false;
     }
@@ -460,8 +445,7 @@
     }
 
     float3 compos = G-&gt;GetUnitPos(uid);
-
-    if(!G-&gt;Map-&gt;CheckFloat3(compos)){
+    if(G-&gt;Map-&gt;CheckFloat3(compos)==false){
         return false;
     }
     
@@ -470,7 +454,6 @@
     int e = G-&gt;GetEnemyUnits(en, compos, G-&gt;cb-&gt;GetUnitMaxRange(uid)*1.3f); // get all enemy units within weapons range atm
     
 	if(e&gt;0){
-
         for(int i = 0; i &lt; e; i++){
             
 			if(ValidUnitID(en[i])==false){

Modified: trunk/AI/Global/NTai/AI/NTai/Tasks/CConsoleTask.cpp
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Tasks/CConsoleTask.cpp	2008-03-17 19:53:35 UTC (rev 5590)
+++ trunk/AI/Global/NTai/AI/NTai/Tasks/CConsoleTask.cpp	2008-03-17 20:43:16 UTC (rev 5591)
@@ -3,7 +3,6 @@
 CConsoleTask::CConsoleTask(Global* GL){
 	//
 	valid = false;
-	succeed = true;
 }
 
 CConsoleTask::CConsoleTask(Global* GL, string message){
@@ -25,7 +24,3 @@
 	End();
 	return true;
 }
-
-bool CConsoleTask::Succeeded(){
-	return succeed;
-}

Modified: trunk/AI/Global/NTai/AI/NTai/Tasks/CConsoleTask.h
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Tasks/CConsoleTask.h	2008-03-17 19:53:35 UTC (rev 5590)
+++ trunk/AI/Global/NTai/AI/NTai/Tasks/CConsoleTask.h	2008-03-17 20:43:16 UTC (rev 5591)
@@ -7,9 +7,7 @@
 		CConsoleTask(Global* GL, string message);
 		void RecieveMessage(CMessage &amp;message);
 		bool Init();
-		bool Succeeded();
 	protected:
-		bool succeed;
 		string mymessage;
 	};
 }

Modified: trunk/AI/Global/NTai/AI/NTai/Tasks/CKeywordConstructionTask.cpp
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Tasks/CKeywordConstructionTask.cpp	2008-03-17 19:53:35 UTC (rev 5590)
+++ trunk/AI/Global/NTai/AI/NTai/Tasks/CKeywordConstructionTask.cpp	2008-03-17 20:43:16 UTC (rev 5591)
@@ -10,17 +10,13 @@
 	if(utd == 0){
 		valid = false;
 	}
-	succeed = valid;
 }
 
 void CKeywordConstructionTask::RecieveMessage(CMessage &amp;message){
 	NLOG(&quot;CKeywordConstructionTask::RecieveMessage&quot;);
-	
-	if (!valid){
-		return;
-	}
+	if (!valid) return;
 
-	if(message.IsType(&quot;unitidle&quot;)){
+	if(message.GetType() == string(&quot;unitidle&quot;)){
 		if(message.GetParameter(0) == unit){
 			if((type == B_GUARDIAN)
 				||(type == B_GUARDIAN_MOBILES)
@@ -31,14 +27,14 @@
 				return;
 			}
 		}
-	}else if(message.IsType(&quot;type?&quot;)){
+	}else if(message.GetType() == string(&quot;type?&quot;)){
 		message.SetType(&quot; keywordtask: &quot;+G-&gt;Manufacturer-&gt;GetTaskName(this-&gt;type));
-	}else if(message.IsType(&quot;unitdestroyed&quot;)){
+	}else	if(message.GetType() == string(&quot;unitdestroyed&quot;)){
 		if(message.GetParameter(0) == unit){
 			End();
 			return;
 		}
-	}else if(message.IsType(&quot;buildposition&quot;)){
+	}else	if(message.GetType() == string(&quot;buildposition&quot;)){
 		// continue construction
 		//
 
@@ -50,12 +46,10 @@
 			if(pos==UpVector){
 				G-&gt;L.print(&quot;CKeywordConstructionTask::RecieveMessage BuildPlacement returned UpVector or some other nasty position&quot;);
 				End();
-				succeed = false;
 				return;
 			}else if (G-&gt;cb-&gt;CanBuildAt(building-&gt;GetUnitDef(),pos,0)==false){
 				G-&gt;L.print(&quot;CKeywordConstructionTask::RecieveMessage BuildPlacement returned a position that cant eb built upon&quot;);
 				End();
-				succeed = false;
 				return;
 			}
 		}
@@ -72,10 +66,9 @@
 			qi-&gt;builders.insert(unit);
 			return false;
 			}
-			}else*/
-			if ((*qi)-&gt;utd == building){
-				G-&gt;L.print(&quot;CKeywordConstructionTask::RecieveMessage overlapping plans that're the same item but not started, moving pos to make it build quicker&quot;);
-				pos = (*qi)-&gt;pos;
+			}else*/ if ((*qi)-&gt;utd == building){
+			G-&gt;L.print(&quot;CKeywordConstructionTask::RecieveMessage overlapping plans that're the same item but not started, moving pos to make it build quicker&quot;);
+			pos = (*qi)-&gt;pos;
 			}
 		}
 
@@ -88,7 +81,6 @@
 		if(!G-&gt;OrderRouter-&gt;GiveOrder(tc)){
 			G-&gt;L.print(&quot;CKeywordConstructionTask::RecieveMessage Failed Order G-&gt;OrderRouter-&gt;GiveOrder(tc)== false:: &quot; + building-&gt;GetUnitDef()-&gt;name);
 			End();
-			succeed = false;
 			return;
 
 		}else{
@@ -135,7 +127,6 @@
 				if(!G-&gt;Pl-&gt;feasable(building,utd)){
 					G-&gt;L.print(&quot;unfeasable &quot; + building-&gt;GetUnitDef()-&gt;name);
 					End();
-					succeed = false;
 					return;
 				}else{
 					NLOG(&quot;CKeywordConstructionTask::Build  &quot;+building-&gt;GetUnitDef()-&gt;name+&quot; is feasable&quot;);
@@ -183,7 +174,6 @@
 	if(building-&gt;GetSoloBuildActive()){
 		NLOG(&quot;CKeywordConstructionTask::Build  G-&gt;Cached-&gt;solobuilds.find(name)!= G-&gt;Cached-&gt;solobuilds.end()&quot;);
 		End();
-		succeed = false;
 		return;
 	}
 
@@ -204,7 +194,6 @@
 		if(!fk){
 			G-&gt;L.print(&quot;CKeywordConstructionTask::Build  unfeasable &quot; + building-&gt;GetUnitDef()-&gt;name);
 			End();
-			succeed = false;
 			return;
 		}
 	}
@@ -215,7 +204,6 @@
 	if(G-&gt;Map-&gt;CheckFloat3(unitpos) == false){
 		NLOG(&quot;CKeywordConstructionTask::Build  mark 2# bad float exit&quot;);
 		End();
-		succeed = false;
 		return;
 	}
 	
@@ -239,7 +227,7 @@
 						if(G-&gt;cb-&gt;UnitBeingBuilt(funits[i])==true){
 							delete [] funits;
 							NLOG(&quot;CKeywordConstructionTask::Build  exit on repair&quot;);
-							succeed = G-&gt;Actions-&gt;Repair(unit,funits[i]);
+							G-&gt;Actions-&gt;Repair(unit,funits[i]);
 							End();
 							return;
 						}
@@ -277,13 +265,11 @@
 						if(G-&gt;cb-&gt;UnitBeingBuilt(kj)==true){
 							NLOG(&quot;CKeywordConstructionTask::Build  exit on repair&quot;);
 							if(!G-&gt;Actions-&gt;Repair(unit,kj)){
-								succeed = false;
 								End();
 							}
 							return;
 						}else{
 							NLOG(&quot;CKeywordConstructionTask::Build  return false&quot;);
-							succeed = false;
 							End();
 							return;
 						}
@@ -324,7 +310,6 @@
 	if(type == B_RANDMOVE){
 		if(G-&gt;Actions-&gt;RandomSpiral(unit)==false){
 			End();
-			succeed = false;
 			return false;
 		}else{
 			return true;
@@ -332,7 +317,6 @@
 	} else if(type == B_RETREAT){
 		if(!G-&gt;Actions-&gt;Retreat(unit)){
 			End();
-			succeed = false;
 			return false;
 		}else{
 			return true;
@@ -340,7 +324,6 @@
 	} else if(type == B_GUARDIAN){
 		if(!G-&gt;Actions-&gt;RepairNearby(unit,1200)){
 			End();
-			succeed = false;
 			return false;
 		}else{
 			return true;
@@ -348,7 +331,6 @@
 	} else if(type == B_GUARDIAN_MOBILES){
 		if(!G-&gt;Actions-&gt;RepairNearbyUnfinishedMobileUnits(unit,1200)){
 			End();
-			succeed = false;
 			return false;
 		}else{
 			return true;
@@ -356,7 +338,6 @@
 	} else if(type == B_RESURECT){
 		if(!G-&gt;Actions-&gt;RessurectNearby(unit)){
 			End();
-			succeed = false;
 			return false;
 		}else{
 			return true;
@@ -366,7 +347,6 @@
 		type = G-&gt;Economy-&gt;Get(!(type == B_RULE),!(B_RULE_EXTREME_NOFACT == type));
 		if(type == B_NA){
 			valid = false;
-			succeed = false;
 			End();
 			return false;
 		}
@@ -383,13 +363,11 @@
 		}else{
 			G-&gt;L.print(&quot;B_RULE_EXTREME skipped bad return&quot;);
 			End();
-			succeed = false;
 			return false;
 		}
 	}else if(type  == B_OFFENSIVE_REPAIR_RETREAT){
 		if(G-&gt;Actions-&gt;OffensiveRepairRetreat(unit,800)==false){
 			End();
-			succeed = false;
 			return false;
 		}else{
 			return true;
@@ -399,7 +377,6 @@
 			if(G-&gt;Actions-&gt;RepairNearby(unit,1000)==false){
 				if(G-&gt;Actions-&gt;RepairNearby(unit,2600)==false){
 					End();
-					succeed = false;
 					return false;
 				}else{
 					return true;
@@ -414,7 +391,6 @@
 	}else if(type  == B_RECLAIM){
 		if(!G-&gt;Actions-&gt;ReclaimNearby(unit,400)){
 			End();
-			succeed = false;
 			return false;
 		}else{
 			return true;
@@ -423,7 +399,6 @@
 		float3 upos = G-&gt;GetUnitPos(unit);
 		if(G-&gt;Map-&gt;CheckFloat3(upos)==false){
 			End();
-			succeed = false;
 			return false;
 		}
 		int* funits = new int[6000];
@@ -454,30 +429,27 @@
 					}
 				}
 			}
-			delete [] funits;
 			if(ValidUnitID(closest)){
+				delete [] funits;
 				if(!G-&gt;Actions-&gt;Guard(unit,closest)){
 					End();
-					succeed = false;
 					return false;
 				}else{
 					return true;
 				}
 			}else{
+				delete [] funits;
 				End();
-				succeed = false;
 				return false;
 			}
 		}
 		delete [] funits;
 		End();
-		succeed = false;
 		return false;
 	}else if(type  == B_GUARD_LIKE_CON){
 		float3 upos = G-&gt;GetUnitPos(unit);
 		if(G-&gt;Map-&gt;CheckFloat3(upos)==false){
 			End();
-			succeed = false;
 			return false;
 		}
 		int* funits = new int[5005];
@@ -502,19 +474,17 @@
 					}
 				}
 			}
-			delete [] funits;
-
 			if(ValidUnitID(closest)){
+				delete [] funits;
 				if(!G-&gt;Actions-&gt;Guard(unit,closest)){
 					End();
-					succeed = false;
 					return false;
 				}else{
 					return true;
 				}
 			}else{
+				delete [] funits;
 				End();
-				succeed = false;
 				return false;
 			}
 		}
@@ -530,7 +500,6 @@
 		if(targ == string(&quot;&quot;)){
 			G-&gt;L &lt;&lt; &quot;if(targ == string(\&quot;\&quot;)) for &quot;&lt;&lt; G-&gt;Manufacturer-&gt;GetTaskName(type)&lt;&lt; endline;
 			End();
-			succeed = false;
 			return false;
 		}else{
 			CUnitTypeData* udk = G-&gt;UnitDefLoader-&gt;GetUnitTypeDataByName(targ);
@@ -540,7 +509,6 @@
 		}
 	}
 	End();
-	succeed = false;
 	return false;
 }
 
@@ -551,7 +519,3 @@
 	//FireEventListener(message);
 //	G-&gt;RemoveHandler(me);
 }
-
-bool CKeywordConstructionTask::Succeeded(){
-	return succeed;
-}

Modified: trunk/AI/Global/NTai/AI/NTai/Tasks/CKeywordConstructionTask.h
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Tasks/CKeywordConstructionTask.h	2008-03-17 19:53:35 UTC (rev 5590)
+++ trunk/AI/Global/NTai/AI/NTai/Tasks/CKeywordConstructionTask.h	2008-03-17 20:43:16 UTC (rev 5591)
@@ -6,9 +6,7 @@
 		bool Init();
 		void Build();
 		void End();
-		bool Succeeded();
 	protected:
-		bool succeed;
 		int unit;
 		btype type;
 		CUnitTypeData* building;

Modified: trunk/AI/Global/NTai/AI/NTai/Tasks/CLeaveBuildSpotTask.cpp
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Tasks/CLeaveBuildSpotTask.cpp	2008-03-17 19:53:35 UTC (rev 5590)
+++ trunk/AI/Global/NTai/AI/NTai/Tasks/CLeaveBuildSpotTask.cpp	2008-03-17 20:43:16 UTC (rev 5591)
@@ -10,35 +10,32 @@
 		if(utd == 0){
 			valid = false;
 		}
-		succeed = valid;
 	}
 
 	void CLeaveBuildSpotTask::RecieveMessage(CMessage &amp;message){
 		if(!valid){
-			return;
+			return;// false;
 		}
 
-		if(message.IsType(&quot;unitidle&quot;)){
+		if(message.GetType() == string(&quot;unitidle&quot;)){
 			if(message.GetParameter(0) == unit){
 				End();
 				//CMessage message2(string(&quot;taskfinished&quot;));
 				//FireEventListener(message2);
 			}
-		}else if(message.IsType(&quot;type?&quot;)){
+		}else if(message.GetType() == string(&quot;type?&quot;)){
 			message.SetType(&quot; leave buildspot task&quot;);
 		}
 	}
 
 	bool CLeaveBuildSpotTask::Init(){
 		if(!valid){
-			succeed = false;
 			return false;
 		}
 
 		if(utd-&gt;IsFactory()){
 			if(!utd-&gt;IsMobile()){
 				End();
-				succeed = false;
 				return false;
 			}
 		}
@@ -51,7 +48,6 @@
 
 		if(!G-&gt;Map-&gt;CheckFloat3(pos)){
 			End();
-			succeed = false;
 			return false;
 		}
 
@@ -102,7 +98,6 @@
 		if(utd-&gt;IsFactory()){
 			End();
 		}
-		succeed = rvalue;
 		return rvalue;
 	}
 
@@ -110,9 +105,4 @@
 		NLOG(&quot;CLeaveBuildSpotTask::End&quot;);
 		valid = false;
 	}
-
-	bool CLeaveBuildSpotTask::Succeeded(){
-		return succeed;
-	}
-
 }

Modified: trunk/AI/Global/NTai/AI/NTai/Tasks/CLeaveBuildSpotTask.h
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Tasks/CLeaveBuildSpotTask.h	2008-03-17 19:53:35 UTC (rev 5590)
+++ trunk/AI/Global/NTai/AI/NTai/Tasks/CLeaveBuildSpotTask.h	2008-03-17 20:43:16 UTC (rev 5591)
@@ -6,9 +6,7 @@
 		void RecieveMessage(CMessage &amp;message);
 		bool Init();
 		void End();
-		bool Succeeded();
 	protected:
-		bool succeed;
 		string mymessage;
 		int unit;
 		CUnitTypeData* utd;

Modified: trunk/AI/Global/NTai/AI/NTai/Tasks/CUnitConstructionTask.cpp
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Tasks/CUnitConstructionTask.cpp	2008-03-17 19:53:35 UTC (rev 5590)
+++ trunk/AI/Global/NTai/AI/NTai/Tasks/CUnitConstructionTask.cpp	2008-03-17 20:43:16 UTC (rev 5591)
@@ -18,8 +18,6 @@
 		valid = false;
 	}
 
-	succeed = true;
-
 	G-&gt;L.print(&quot;CUnitConstructionTask::CUnitConstructionTask object created | params: building :: &quot;+this-&gt;building-&gt;GetUnitDef()-&gt;name+&quot; using builder::&quot;+ this-&gt;builder-&gt;GetUnitDef()-&gt;name);
 }
 
@@ -29,44 +27,36 @@
 
 void CUnitConstructionTask::RecieveMessage(CMessage &amp;message){
 	if(!valid){
-		return;
+		return;// false;
 	}
 
 	NLOG(&quot;CUnitConstructionTask::RecieveMessage&quot;);
-
-	if(message.IsType(&quot;unitidle&quot;)){
+	if(message.GetType() == string(&quot;unitidle&quot;)){
 		if(message.GetParameter(0) == unit){
 			End();
 			return;
 		}
-
-	} else if(message.IsType(&quot;unitdestroyed&quot;)){
+	} else if(message.GetType() == string(&quot;unitdestroyed&quot;)){
 		if(message.GetParameter(0) == unit){
 			End();
 			return;
 		}
-
-	}else if(message.IsType(&quot;type?&quot;)){
+	}else if(message.GetType() == string(&quot;type?&quot;)){
 		message.SetType(&quot; build:&quot;+building-&gt;GetUnitDef()-&gt;name);
-	}else if(message.IsType(&quot;buildposition&quot;)){
+	}else if(message.GetType() == string(&quot;buildposition&quot;)){
 		// continue construction
 		//
-
 		TCommand tc(unit,&quot;CBuild&quot;);
 		tc.ID(-building-&gt;GetUnitDef()-&gt;id);
-
 		float3 pos = message.GetFloat3();
-		
 		if(!building-&gt;IsMobile()){
 			if(pos==UpVector){
 				G-&gt;L.print(&quot;BuildPlacement returned UpVector or some other nasty position, a build location wasn't found!&quot;);
 				End();
-				succeed = false;
 				return;
 			} else if (G-&gt;cb-&gt;CanBuildAt(building-&gt;GetUnitDef(),pos,0)==false){
 				G-&gt;L.print(&quot;CUnitConstructionTask::RecieveMessage BuildPlacement returned a position that cant be built upon&quot;);
 				End();
-				succeed = false;
 				return;
 			}
 		}
@@ -102,7 +92,6 @@
 
 		if(G-&gt;OrderRouter-&gt;GiveOrder(tc)== false){
 			G-&gt;L.print(&quot;CUnitConstructionTask::RecieveMessage Failed Order G-&gt;OrderRouter-&gt;GiveOrder(tc)== false:: &quot; + builder-&gt;GetUnitDef()-&gt;name);
-			succeed = false;
 			End();
 			return;
 		}else{
@@ -154,7 +143,7 @@
 				if(G-&gt;Pl-&gt;feasable(building,builder) == false){
 					
 					G-&gt;L.print(&quot;CUnitConstructionTask::Init  unfeasable &quot; + building-&gt;GetUnitDef()-&gt;name);
-					succeed = false;
+					
 					End();
 					return false;
 				}else{
@@ -183,7 +172,6 @@
 	if(G-&gt;Pl-&gt;GetEnergyIncome() &gt; emax){
 		G-&gt;L.print(&quot;CUnitConstructionTask::Init  emax &quot; + building-&gt;GetUnitDef()-&gt;name);
 		End();
-		succeed = false;
 		return false;
 	}
 
@@ -198,7 +186,6 @@
 	if(G-&gt;Pl-&gt;GetEnergyIncome() &lt; emin){
 		G-&gt;L.print(&quot;CUnitConstructionTask::Init  emin &quot; + building-&gt;GetUnitDef()-&gt;name);
 		End();
-		succeed = false;
 		return false;
 	}
 
@@ -208,7 +195,6 @@
 	if(building-&gt;GetSoloBuildActive()){
 		NLOG(&quot;CUnitConstructionTask::Build  G-&gt;Cached-&gt;solobuilds.find(name)!= G-&gt;Cached-&gt;solobuilds.end()&quot;);
 		End();
-		succeed = false;
 		return false;
 	}
 
@@ -216,7 +202,6 @@
 	if(building-&gt;GetSingleBuildActive()){
 		G-&gt;L.print(&quot;CUnitConstructionTask::Build  singlebuild &quot; + building-&gt;GetUnitDef()-&gt;name);
 		End();
-		succeed = false;
 		return true;
 	}
 
@@ -233,7 +218,6 @@
 		if(fk == false){
 			G-&gt;L.print(&quot;CUnitConstructionTask::Init  unfeasable &quot; + building-&gt;GetUnitDef()-&gt;name);
 			End();
-			succeed = false;
 			return false;
 		}
 	}
@@ -243,7 +227,6 @@
 	if(G-&gt;Map-&gt;CheckFloat3(unitpos) == false){
 		NLOG(&quot;CUnitConstructionTask::Init  mark 2# bad float exit&quot;);
 		End();
-		succeed = false;
 		return false;
 	}
 
@@ -264,7 +247,6 @@
 							NLOG(&quot;CUnitConstructionTask::Init  exit on repair&quot;);
 							if(!G-&gt;Actions-&gt;Repair(unit,funits[i])){
 								End();
-								succeed = false;
 								return false;
 							}else{
 								End();
@@ -300,8 +282,7 @@
 							NLOG(&quot;CUnitConstructionTask::Init  exit on repair&quot;);
 							if(!G-&gt;Actions-&gt;Repair(unit,kj)){
 								End();
-								succeed = false;
-								return false;
+								return true;
 							}else{
 								End();
 								return true;
@@ -309,7 +290,6 @@
 						}else{
 							NLOG(&quot;CUnitConstructionTask::Init  return false&quot;);
 							End();
-							succeed = false;
 							return false;
 						}
 					}
@@ -327,7 +307,3 @@
 	NLOG(&quot;CUnitConstructionTask::End&quot;);
 	valid = false;
 }
-
-bool CUnitConstructionTask::Succeeded(){
-	return succeed;
-}

Modified: trunk/AI/Global/NTai/AI/NTai/Tasks/CUnitConstructionTask.h
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Tasks/CUnitConstructionTask.h	2008-03-17 19:53:35 UTC (rev 5590)
+++ trunk/AI/Global/NTai/AI/NTai/Tasks/CUnitConstructionTask.h	2008-03-17 20:43:16 UTC (rev 5591)
@@ -6,10 +6,7 @@
 		void RecieveMessage(CMessage &amp;message);
 		bool Init();
 		void End();
-
-		bool Succeeded();
 	protected:
-		bool succeed;
 		string mymessage;
 		int unit;
 		CUnitTypeData* builder;

Modified: trunk/AI/Global/NTai/AI/NTai/Tasks/ITask.h
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Tasks/ITask.h	2008-03-17 19:53:35 UTC (rev 5590)
+++ trunk/AI/Global/NTai/AI/NTai/Tasks/ITask.h	2008-03-17 20:43:16 UTC (rev 5591)
@@ -9,5 +9,4 @@
 	virtual bool IsValid()=0;
 	virtual bool SetValid(bool isvalid)=0;
 	virtual btype GetType()=0;
-	virtual bool Succeeded()=0;
 };

Modified: trunk/AI/Global/NTai/AI/NTai/Units/Behaviours/AttackBehaviour.cpp
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Units/Behaviours/AttackBehaviour.cpp	2008-03-17 19:53:35 UTC (rev 5590)
+++ trunk/AI/Global/NTai/AI/NTai/Units/Behaviours/AttackBehaviour.cpp	2008-03-17 20:43:16 UTC (rev 5591)
@@ -1,6 +1,7 @@
 #include &quot;../../Core/include.h&quot;
 
 CAttackBehaviour::CAttackBehaviour(Global* GL, int uid){
+	//
 	G = GL;
 	engaged = false;
 	unit = G-&gt;GetUnit(uid);
@@ -16,30 +17,25 @@
 }
 
 void CAttackBehaviour::RecieveMessage(CMessage &amp;message){
-
-	if(message.IsType(&quot;update&quot;)){
-		
+	if(message.GetType() == string(&quot;update&quot;)){
 		if(engaged){
 			return;
 		}
-
-		if(message.GetFrame()%(120 FRAMES) == 0){
+		if(EVERY_(120 FRAMES)){
 			
 			float3 pos = G-&gt;GetUnitPos(uid);
-
-			if(!G-&gt;Map-&gt;CheckFloat3(pos)){
+			if(G-&gt;Map-&gt;CheckFloat3(pos)==false){
 				return;
 			}
 
 			engaged = G-&gt;Actions-&gt;AttackNear(uid, 3.5f);
-
 		}
-	}else if(message.IsType(&quot;unitdestroyed&quot;)){
-		if(message.GetParameter(0) == uid){
+	}else if(message.GetType() == string(&quot;unitdestroyed&quot;)){
+		if(message.GetParameter(0)== uid){
 			End();
 		}
-	}else if(message.IsType(&quot;unitidle&quot;)){
-		if(message.GetParameter(0) == uid){
+	}else if(message.GetType() == string(&quot;unitidle&quot;)){
+		if(message.GetParameter(0)== uid){
 			engaged=false;
 		}
 	}

Modified: trunk/AI/Global/NTai/AI/NTai/Units/Behaviours/CDGunBehaviour.cpp
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Units/Behaviours/CDGunBehaviour.cpp	2008-03-17 19:53:35 UTC (rev 5590)
+++ trunk/AI/Global/NTai/AI/NTai/Units/Behaviours/CDGunBehaviour.cpp	2008-03-17 20:43:16 UTC (rev 5591)
@@ -17,18 +17,18 @@
 }
 
 void CDGunBehaviour::RecieveMessage(CMessage &amp;message){
-	if(message.IsType(&quot;update&quot;)){
+	if(message.GetType() == string(&quot;update&quot;)){
 		if(message.GetFrame() % (64) == 0){
 			if(!active){
 				active = G-&gt;Actions-&gt;DGunNearby(uid);
 			}
 		}
-	}else if(message.IsType(&quot;unitdestroyed&quot;)){
+	}else if(message.GetType() == string(&quot;unitdestroyed&quot;)){
 		if(message.GetParameter(0)== uid){
 			End();
 			return;
 		}
-	}else if(message.IsType(&quot;unitidle&quot;)){
+	}else if(message.GetType() == string(&quot;unitidle&quot;)){
 		if(message.GetParameter(0)== uid){
 			active=false;
 		}

Modified: trunk/AI/Global/NTai/AI/NTai/Units/Behaviours/CRetreatBehaviour.cpp
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Units/Behaviours/CRetreatBehaviour.cpp	2008-03-17 19:53:35 UTC (rev 5590)
+++ trunk/AI/Global/NTai/AI/NTai/Units/Behaviours/CRetreatBehaviour.cpp	2008-03-17 20:43:16 UTC (rev 5591)
@@ -17,20 +17,17 @@
 }
 
 void CRetreatBehaviour::RecieveMessage(CMessage &amp;message){
-
-	if(message.IsType(&quot;unitdamaged&quot;)){
+	if(message.GetType() == string(&quot;unitdamaged&quot;)){
 		if(message.GetParameter(0) == uid){
 			damage += message.GetParameter(2);
 		}
-
-	}else if(message.IsType(&quot;update&quot;)){
-		if(message.GetFrame() % (64) == 0){
+	}else if(message.GetType() == string(&quot;update&quot;)){
+		if(G-&gt;GetCurrentFrame() % (64) == 0){
 			float d = damage;
 			damage = 0;
 
 			if(!active){
 				float3 dpos = G-&gt;GetUnitPos(uid);
-
 				if(G-&gt;Map-&gt;CheckFloat3(dpos) == false){
 					return;
 				}
@@ -53,16 +50,14 @@
 				}
 			}
 		}
-	}else if(message.IsType(&quot;unitdestroyed&quot;)){
+	}else if(message.GetType() == string(&quot;unitdestroyed&quot;)){
 		if(message.GetParameter(0)== uid){
 			End();
 			return;
 		}
-
-	}else if(message.IsType(&quot;unitidle&quot;)){
+	}else if(message.GetType() == string(&quot;unitidle&quot;)){
 		if(message.GetParameter(0)== uid){
 			active=false;
 		}
 	}
-
 }

Modified: trunk/AI/Global/NTai/AI/NTai/Units/Behaviours/CRetreatBehaviour.h
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Units/Behaviours/CRetreatBehaviour.h	2008-03-17 19:53:35 UTC (rev 5590)
+++ trunk/AI/Global/NTai/AI/NTai/Units/Behaviours/CRetreatBehaviour.h	2008-03-17 20:43:16 UTC (rev 5591)
@@ -1,4 +1,3 @@
-
 namespace ntai {
 	class CRetreatBehaviour : public IBehaviour{
 	public:

Modified: trunk/AI/Global/NTai/AI/NTai/Units/CUnit.cpp
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Units/CUnit.cpp	2008-03-17 19:53:35 UTC (rev 5590)
+++ trunk/AI/Global/NTai/AI/NTai/Units/CUnit.cpp	2008-03-17 20:43:16 UTC (rev 5591)
@@ -37,7 +37,6 @@
 		birth = G-&gt;GetCurrentFrame();
 		nolist=false;
 		under_construction = true;
-		idle_timer = 0;
 	}
 
 	CUnit::~CUnit(){
@@ -62,29 +61,12 @@
 		if(!IsValid()){
 			return;
 		}
-		if(message.IsType(&quot;update&quot;)){
-			if(under_construction){
-				return;
-			}
-			if(idle_timer &gt;0){
-				//
-				idle_timer--;
-				return;
-			}
-
-			if(EVERY_((GetAge()%32+17))){
+		if(message.GetType() == string(&quot;update&quot;)){
+			if(under_construction) return;
+			if(EVERY_((GetAge()%16+17))){
 				if(!tasks.empty()){
-					IModule* t = tasks.front().get();
-					if(t-&gt;IsValid()==false){
-						
+					if(tasks.front()-&gt;IsValid()==false){
 						G-&gt;L.print(&quot;next task?&quot;);
-						
-						if(t-&gt;Succeeded()==false){
-							if(idle_timer == 0){
-								idle_timer = 64;
-								return;
-							}
-						}
 						tasks.erase(tasks.begin());
 						if(tasks.empty()==false){
 							boost::shared_ptr&lt;IModule&gt; t = tasks.front();
@@ -94,40 +76,41 @@
 					}
 				}
 			}
-
-		}else if(message.IsType(&quot;&quot;)){
+			/*if(EVERY_(32)){
+				float3 p = G-&gt;GetUnitPos(uid);
+				G-&gt;cb-&gt;CreateLineFigure(p,p+float3(30,40,30),5,0,32,0);
+				float3 p2 = G-&gt;cb-&gt;GetMousePos();
+				if(p2.distance2D(p)&lt;30){
+					CMessage m(&quot;type?&quot;);
+					tasks.front()-&gt;RecieveMessage(m);
+					G-&gt;cb-&gt;SendTextMsg(m.GetType().c_str(),1);
+				}
+			}*/
+		}else if(message.GetType() == string(&quot;&quot;)){
 			return;
-		}else if(message.IsType(&quot;unitfinished&quot;)){
+		}else if(message.GetType() == string(&quot;unitfinished&quot;)){
 			if(message.GetParameter(0) == this-&gt;uid){
 				under_construction = false;
 				LoadBehaviours();
 			}
-		}else if(message.IsType(&quot;unitdestroyed&quot;)){
+		}else if(message.GetType() == string(&quot;unitdestroyed&quot;)){
 			if(message.GetParameter(0) == uid){
-
 				if(!utd-&gt;IsMobile()){
 					G-&gt;BuildingPlacer-&gt;UnBlock(G-&gt;GetUnitPos(uid),utd);
 				}
-
 				if(!tasks.empty()){
 					tasks.erase(tasks.begin(),tasks.end());
 					tasks.clear();
 				}
-
 				if(!behaviours.empty()){
 					behaviours.erase(behaviours.begin(),behaviours.end());
 					behaviours.clear();
 				}
-
 				this-&gt;End();
 				return;
 			}
 		}
-
-		if(under_construction){
-			return;
-		}
-
+		if(under_construction) return;
 		if(!nolist){
 			if(tasks.empty()){
 				if(LoadTaskList()){
@@ -135,7 +118,7 @@
 					t-&gt;Init();
 					G-&gt;RegisterMessageHandler(t);
 				}
-
+				//executenext = !tasks.empty();
 			}
 		}
 	}
@@ -152,12 +135,12 @@
 
 	bool CUnit::operator==(int unit){
 		NLOG(&quot;CUnit::operator==&quot;);
-
-		if(valid == false){
+		if(valid == false) return false;
+		if(unit == uid){
+			return true;
+		}else{
 			return false;
 		}
-
-		return (unit == uid);
 	}
 
 	int CUnit::GetID(){
@@ -167,9 +150,12 @@
 
 	bool CUnit::AddTask(boost::shared_ptr&lt;IModule&gt; &amp;t){
 		NLOG(&quot;CBuilder::AddTask&quot;);
-		
-		tasks.push_back(t);
-		return true;
+		//if(t-&gt;IsValid()){
+			//t-&gt;AddListener(me);
+			tasks.push_back(t);
+			return true;
+		//}
+		//return false;
 	}
 
 	bool CUnit::LoadTaskList(){
@@ -189,7 +175,7 @@
 		string u = utd-&gt;GetName();
 		if(sl != string(&quot;&quot;)){
 			CTokenizer&lt;CIsComma&gt;::Tokenize(vl, sl, CIsComma());
-
+			//vl = bds::set_cont(vl,sl.c_str());
 			if(vl.empty() == false){
 				int randnum = G-&gt;mrand()%vl.size();
 				u = vl.at(min(randnum,max(int(vl.size()-1),1)));
@@ -210,6 +196,7 @@
 		vector&lt;string&gt; v;
 
 		CTokenizer&lt;CIsComma&gt;::Tokenize(v, s, CIsComma());
+		//v = bds::set_cont(v,s.c_str());
 
 		if(v.empty() == false){
 			G-&gt;L.print(&quot;loading contents of  tasklist :: &quot; + u + &quot; :: filling tasklist with #&quot; + to_string(v.size()) + &quot; items&quot;);
@@ -234,14 +221,10 @@
 					}
 					polate = !polate;
 				}
-
 				string q = *vi;
-
 				trim(q);
 				tolowercase(q);
-
 				CUnitTypeData* b = G-&gt;UnitDefLoader-&gt;GetUnitTypeDataByName(q);
-
 				if(b != 0){
 					boost::shared_ptr&lt;IModule&gt; t(new CUnitConstructionTask(G,uid,utd,b));
 					AddTask(t);
@@ -275,7 +258,6 @@
 					AddTask(t);
 				} else{
 					btype x = G-&gt;Manufacturer-&gt;GetTaskType(q);
-
 					if( x != B_NA){
 						boost::shared_ptr&lt;IModule&gt; t(new CKeywordConstructionTask(G,this-&gt;uid,x));
 						AddTask(t);
@@ -285,7 +267,6 @@
 				}
 
 			}
-
 			if(utd-&gt;GetUnitDef()-&gt;isCommander){
 				G-&gt;Map-&gt;basepos = G-&gt;GetUnitPos(GetID());
 			}

Modified: trunk/AI/Global/NTai/AI/NTai/Units/CUnit.h
===================================================================
--- trunk/AI/Global/NTai/AI/NTai/Units/CUnit.h	2008-03-17 19:53:35 UTC (rev 5590)
+++ trunk/AI/Global/NTai/AI/NTai/Units/CUnit.h	2008-03-17 20:43:16 UTC (rev 5591)
@@ -9,7 +9,6 @@
 		CUnit(){
 			G = 0;
 			valid=false;
-			idle_timer=0;
 		}
 		CUnit(Global* GL);
 		CUnit(Global* GL, int uid);
@@ -34,8 +33,6 @@
 		bool doingplan;
 		uint curplan;
 	protected:
-
-		int idle_timer;
 		bool under_construction;
 		list&lt; boost::shared_ptr&lt;IModule&gt; &gt; tasks;
 		list&lt; boost::shared_ptr&lt;IBehaviour&gt; &gt; behaviours;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000371.html">[Taspring-linux-commit] r5590 - trunk/tools/DedicatedServer
</A></li>
	<LI>Next message: <A HREF="000373.html">[Taspring-linux-commit] r5592 - in trunk/rts: Game System System/Net
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#372">[ date ]</a>
              <a href="thread.html#372">[ thread ]</a>
              <a href="subject.html#372">[ subject ]</a>
              <a href="author.html#372">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
