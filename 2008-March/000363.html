<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r5582 - trunk/Lobby/TASClient
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-March/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5582%20-%20trunk/Lobby/TASClient&In-Reply-To=%3C20080313181317.4E4A345D3%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000362.html">
   <LINK REL="Next"  HREF="000364.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r5582 - trunk/Lobby/TASClient</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5582%20-%20trunk/Lobby/TASClient&In-Reply-To=%3C20080313181317.4E4A345D3%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r5582 - trunk/Lobby/TASClient">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Thu Mar 13 19:13:16 CET 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000362.html">[Taspring-linux-commit] r5581 - trunk/rts/Sim/MoveTypes
</A></li>
        <LI>Next message: <A HREF="000364.html">[Taspring-linux-commit] r5583 - trunk/tools/unitsync
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#363">[ date ]</a>
              <a href="thread.html#363">[ thread ]</a>
              <a href="subject.html#363">[ subject ]</a>
              <a href="author.html#363">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: satirik
Date: 2008-03-13 19:13:15 +0100 (Thu, 13 Mar 2008)
New Revision: 5582

Modified:
   trunk/Lobby/TASClient/BattleFormUnit.dfm
   trunk/Lobby/TASClient/BattleFormUnit.pas
   trunk/Lobby/TASClient/MainUnit.dfm
   trunk/Lobby/TASClient/MainUnit.pas
   trunk/Lobby/TASClient/TASClient.dof
   trunk/Lobby/TASClient/TASClient.res
   trunk/Lobby/TASClient/Utility.pas
Log:
- 'Load mod's default option' 'Load default' and 'Set as default' added to map and mod options tab

Modified: trunk/Lobby/TASClient/BattleFormUnit.dfm
===================================================================
--- trunk/Lobby/TASClient/BattleFormUnit.dfm	2008-03-12 22:02:38 UTC (rev 5581)
+++ trunk/Lobby/TASClient/BattleFormUnit.dfm	2008-03-13 18:13:15 UTC (rev 5582)
@@ -1,6 +1,6 @@
 object BattleForm: TBattleForm
-  Left = 445
-  Top = 200
+  Left = 859
+  Top = 303
   Width = 758
   Height = 548
   Caption = 'Battle window'
@@ -4380,12 +4380,11 @@
         Height = 257
         Anchors = [akLeft, akTop, akRight]
         Color = clBtnFace
-        ActiveTabIndex = 0
+        ActiveTabIndex = 3
         OnActiveTabChange = SpTBXTabControl1ActiveTabChange
         HiddenItems = &lt;&gt;
         object GameOptionsTab: TSpTBXTabItem
           Caption = 'Game options'
-          Checked = True
         end
         object DisabledUnitsTab: TSpTBXTabItem
           Caption = 'Disabled Units (0)'
@@ -4395,72 +4394,8 @@
         end
         object ModTab: TSpTBXTabItem
           Caption = 'Mod options'
+          Checked = True
         end
-        object ModTabSheet: TSpTBXTabSheet
-          Left = 0
-          Top = 23
-          Width = 393
-          Height = 234
-          Caption = 'Mod options'
-          ImageIndex = -1
-          TabItem = 'ModTab'
-          object Bevel3: TBevel
-            Left = 2
-            Top = 0
-            Width = 389
-            Height = 4
-            Align = alTop
-            Shape = bsSpacer
-          end
-          object ModOptionsScrollBox: TTntScrollBox
-            Left = 2
-            Top = 4
-            Width = 389
-            Height = 228
-            VertScrollBar.Smooth = True
-            VertScrollBar.Tracking = True
-            Align = alClient
-            BorderStyle = bsNone
-            Ctl3D = False
-            ParentCtl3D = False
-            TabOrder = 0
-          end
-        end
-        object MapTabSheet: TSpTBXTabSheet
-          Left = 0
-          Top = 23
-          Width = 393
-          Height = 234
-          Caption = 'Map options'
-          ImageIndex = -1
-          TabItem = 'MapTab'
-          object Bevel4: TBevel
-            Left = 2
-            Top = 0
-            Width = 389
-            Height = 4
-            Align = alTop
-            Shape = bsSpacer
-          end
-          object MapOptionsScrollBox: TTntScrollBox
-            Left = 2
-            Top = 4
-            Width = 389
-            Height = 228
-            VertScrollBar.Smooth = True
-            VertScrollBar.Tracking = True
-            Align = alClient
-            BiDiMode = bdLeftToRight
-            BorderStyle = bsNone
-            Color = clBtnFace
-            Ctl3D = False
-            ParentBiDiMode = False
-            ParentBackground = True
-            ParentColor = False
-            ParentCtl3D = False
-            TabOrder = 0
-          end
-        end
         object SpTBXTabSheet1: TSpTBXTabSheet
           Left = 0
           Top = 23
@@ -4503,6 +4438,86 @@
             end
           end
         end
+        object MapTabSheet: TSpTBXTabSheet
+          Left = 0
+          Top = 23
+          Width = 393
+          Height = 234
+          Caption = 'Map options'
+          ImageIndex = -1
+          DesignSize = (
+            393
+            234)
+          TabItem = 'MapTab'
+          object MapOptionsScrollBox: TTntScrollBox
+            Left = 2
+            Top = 48
+            Width = 389
+            Height = 184
+            VertScrollBar.Smooth = True
+            VertScrollBar.Tracking = True
+            Anchors = [akLeft, akTop, akRight, akBottom]
+            BiDiMode = bdLeftToRight
+            BorderStyle = bsNone
+            Color = clBtnFace
+            Ctl3D = False
+            ParentBiDiMode = False
+            ParentBackground = True
+            ParentColor = False
+            ParentCtl3D = False
+            TabOrder = 0
+          end
+          object panelMapOptionsDefault: TSpTBXPanel
+            Left = 5
+            Top = 4
+            Width = 382
+            Height = 41
+            Align = alCustom
+            TabOrder = 1
+            object btLoadDefaultMPO: TSpTBXButton
+              Left = 136
+              Top = 8
+              Width = 113
+              Height = 25
+              Caption = 'Load default'
+              TabOrder = 0
+              OnClick = btLoadDefaultMPOClick
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object btSetAsDefaultMPO: TSpTBXButton
+              Left = 256
+              Top = 8
+              Width = 113
+              Height = 25
+              Caption = 'Set as default'
+              TabOrder = 1
+              OnClick = btSetAsDefaultMPOClick
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object btLoadMapsDefaultMPO: TSpTBXButton
+              Left = 16
+              Top = 8
+              Width = 113
+              Height = 25
+              Caption = 'Load map'#39's default'
+              TabOrder = 2
+              OnClick = btLoadMapsDefaultMPOClick
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+          end
+        end
         object SpTBXTabSheet2: TSpTBXTabSheet
           Left = 0
           Top = 23
@@ -4773,6 +4788,81 @@
             LinkFont.Style = [fsUnderline]
           end
         end
+        object ModTabSheet: TSpTBXTabSheet
+          Left = 0
+          Top = 23
+          Width = 393
+          Height = 234
+          Caption = 'Mod options'
+          ImageIndex = -1
+          DesignSize = (
+            393
+            234)
+          TabItem = 'ModTab'
+          object ModOptionsScrollBox: TTntScrollBox
+            Left = 2
+            Top = 48
+            Width = 389
+            Height = 184
+            VertScrollBar.Smooth = True
+            VertScrollBar.Tracking = True
+            Anchors = [akLeft, akTop, akRight, akBottom]
+            BorderStyle = bsNone
+            Ctl3D = False
+            ParentCtl3D = False
+            TabOrder = 0
+          end
+          object panelModOptionsDefault: TSpTBXPanel
+            Left = 5
+            Top = 4
+            Width = 381
+            Height = 41
+            Align = alCustom
+            TabOrder = 1
+            object btLoadDefaultMDO: TSpTBXButton
+              Left = 136
+              Top = 8
+              Width = 113
+              Height = 25
+              Caption = 'Load default'
+              TabOrder = 0
+              OnClick = btLoadDefaultMDOClick
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object btSetAsDefaultMDO: TSpTBXButton
+              Left = 256
+              Top = 8
+              Width = 113
+              Height = 25
+              Caption = 'Set as default'
+              TabOrder = 1
+              OnClick = btSetAsDefaultMDOClick
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object btLoadModsDefaultMDO: TSpTBXButton
+              Left = 16
+              Top = 8
+              Width = 113
+              Height = 25
+              Caption = 'Load mod'#39's default'
+              TabOrder = 2
+              OnClick = btLoadModsDefaultMDOClick
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+          end
+        end
       end
       object lblTeamNbr: TSpTBXLabel
         Left = 445

Modified: trunk/Lobby/TASClient/BattleFormUnit.pas
===================================================================
--- trunk/Lobby/TASClient/BattleFormUnit.pas	2008-03-12 22:02:38 UTC (rev 5581)
+++ trunk/Lobby/TASClient/BattleFormUnit.pas	2008-03-13 18:13:15 UTC (rev 5582)
@@ -45,6 +45,7 @@
     procedure OnDescriptionButtonClick(Sender: TObject);virtual;
 
   public
+    DefaultValue: String;
     KeyPrefix: String;
     Key: String;
     Name: String;
@@ -54,6 +55,7 @@
     procedure OnChange(Sender: TObject);virtual;
     procedure Enable;virtual;
     procedure Disable;virtual;
+    procedure setToDefault();virtual;
     function toString:String;virtual;
     destructor Destroy; override;
   end;
@@ -64,13 +66,12 @@
   protected
     Panel: TPanel;
     CheckBox: TSpTBXCheckBox;
-
   public
-    DefaultValue: Boolean;
     function GetComponent(AOwner: TWinControl):TWinControl;override;
     procedure SetValue(v: String);override;
     procedure Enable;override;
     procedure Disable;override;
+    procedure setToDefault();override;
     function toString:String;override;
     destructor Destroy; override;
   end;
@@ -81,14 +82,13 @@
   protected
     Panel: TPanel;
     InputEdit: TSpTBXEdit;
-
   public
-    DefaultValue: String;
     MaxStringLength: Integer;
     function GetComponent(AOwner: TWinControl):TWinControl;override;
     procedure SetValue(v: String);override;
     procedure Enable;override;
     procedure Disable;override;
+    procedure setToDefault();override;
     function toString:String;override;
     destructor Destroy; override;
   end;
@@ -99,9 +99,7 @@
   protected
     Panel: TPanel;
     InputEdit: TJvSpinEdit;
-
   public
-    DefaultValue: Double;
     MinValue: Double;
     MaxValue: Double;
     StepValue: Double;
@@ -109,6 +107,7 @@
     procedure SetValue(v: String);override;
     procedure Enable;override;
     procedure Disable;override;
+    procedure setToDefault();override;
     procedure OnChange(Sender: TObject);override;
     function toString:String;override;
     destructor Destroy; override;
@@ -118,12 +117,10 @@
   private
     Panel: TPanel;
     ComboBox: TSpTBXComboBox;
-
   protected
     procedure OnDescriptionButtonClick(Sender: TObject);override;
 
   public
-    DefaultValue: String;
     NameList: TStringList;
     KeyList: TStringList;
     DescriptionList: TStringList;
@@ -132,6 +129,7 @@
     procedure SetValue(v: String);override;
     procedure Enable;override;
     procedure Disable;override;
+    procedure setToDefault();override;
     function toString:String;override;
     destructor Destroy; override;
   end;
@@ -267,8 +265,6 @@
     LoadDefaultButton: TSpTBXButton;
     SetDefaultButton: TSpTBXButton;
     ReadyButton: TSpTBXButton;
-    Bevel3: TBevel;
-    Bevel4: TBevel;
     SpTBXSeparatorItem5: TSpTBXSeparatorItem;
     mnuRemoveFromGroup: TSpTBXItem;
     mnuAddToGroup: TSpTBXSubmenuItem;
@@ -276,6 +272,14 @@
     SpTBXSeparatorItem6: TSpTBXSeparatorItem;
     ModOptionsScrollBox: TTntScrollBox;
     MapOptionsScrollBox: TTntScrollBox;
+    panelModOptionsDefault: TSpTBXPanel;
+    btLoadDefaultMDO: TSpTBXButton;
+    btSetAsDefaultMDO: TSpTBXButton;
+    btLoadModsDefaultMDO: TSpTBXButton;
+    panelMapOptionsDefault: TSpTBXPanel;
+    btLoadDefaultMPO: TSpTBXButton;
+    btSetAsDefaultMPO: TSpTBXButton;
+    btLoadMapsDefaultMPO: TSpTBXButton;
 
     procedure CreateParams(var Params: TCreateParams); override;
 
@@ -471,6 +475,12 @@
       Shift: TShiftState; X, Y: Integer);
     procedure VDTBattleClientsMouseDown(Sender: TObject;
       Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
+    procedure btLoadModsDefaultMDOClick(Sender: TObject);
+    procedure btLoadMapsDefaultMPOClick(Sender: TObject);
+    procedure btSetAsDefaultMDOClick(Sender: TObject);
+    procedure btSetAsDefaultMPOClick(Sender: TObject);
+    procedure btLoadDefaultMDOClick(Sender: TObject);
+    procedure btLoadDefaultMPOClick(Sender: TObject);
   private
     History: TStringList;
     HistoryIndex: Integer;
@@ -494,6 +504,10 @@
     property CurrentMapIndex: Integer read FCurrentMapIndex; // only ChangeMap method may change it!
     property AmIReady: Boolean read FMyReadyStatus write SetMyReadyStatus;
     procedure RefreshTeamNbr;
+    procedure SaveModOptionsAsDefault;
+    procedure LoadModOptionsDefault(modName: string);
+    procedure SaveMapOptionsAsDefault;
+    procedure LoadMapOptionsDefault;
   end;
 
   TBattleParticipation = (None, Hosting, Joined);
@@ -630,6 +644,8 @@
 end;
 
 procedure TBattleForm.SetMyReadyStatus(Status: Boolean);
+var
+  i:integer;
 begin
   FMyReadyStatus := Status;
 
@@ -652,6 +668,20 @@
     if BattleState.Status = Hosting then
     begin
       LoadDefaultButton.Enabled := not Status;
+      for i := 0 to ModOptionsList.Count-1 do
+        if Status then
+          TLuaOption(ModOptionsList[i]).Disable
+        else
+          TLuaOption(ModOptionsList[i]).Enable;
+      for i := 0 to MapOptionsList.Count-1 do
+        if Status then
+          TLuaOption(MapOptionsList[i]).Disable
+        else
+          TLuaOption(MapOptionsList[i]).Enable;
+      btLoadDefaultMDO.Enabled := not Status;
+      btLoadModsDefaultMDO.Enabled := not Status;
+      btLoadDefaultMPO.Enabled := not Status;
+      btLoadMapsDefaultMPO.Enabled := not Status;
       StartPosRadioGroup.Enabled := not Status;
       GameEndRadioGroup.Enabled := not Status;
       if Status then DisableControlAndChildren(ResourcesGroupBox) else EnableControlAndChildren(ResourcesGroupBox);
@@ -663,6 +693,10 @@
 
       if BattleState.LadderIndex &gt;= 0 then begin
         LoadDefaultButton.Enabled := False;
+        btLoadDefaultMDO.Enabled := False;
+        btLoadModsDefaultMDO.Enabled := False;
+        btLoadDefaultMPO.Enabled := False;
+        btLoadMapsDefaultMPO.Enabled := False;
         with TLadder(LadderList[BattleState.LadderIndex]) do begin
           StartPosRadioGroup.Enabled := StartPosRadioGroup.Enabled and (StartPos = 255);
           GameEndRadioGroup.Enabled := GameEndRadioGroup.Enabled and (GameMode = 255);
@@ -967,6 +1001,8 @@
   // load mod options
   LoadLuaOptions(True,'');
   DisplayLuaOptions(ModOptionsList,ModOptionsScrollBox);
+  LoadModOptionsDefault(ModName);
+  panelModOptionsDefault.Visible := ModOptionsList.Count &gt; 0;
   ModTab.Caption := 'Mod options ('+IntToStr(ModOptionsList.Count)+')';
 end;
 
@@ -1058,6 +1094,8 @@
   // load map options
   LoadLuaOptions(False,GetMapItem(MapIndex).MapName);
   DisplayLuaOptions(BattleForm.MapOptionsList,BattleForm.MapOptionsScrollBox);
+  LoadMapOptionsDefault;
+  panelMapOptionsDefault.Visible := MapOptionsList.Count &gt; 0;
   MapTab.Caption := 'Map options ('+IntToStr(BattleForm.MapOptionsList.Count)+')';
 
   SendLuaOptionsDetailsToServer;
@@ -1252,6 +1290,10 @@
   AdminButton.Enabled := False;
   LockedCheckBox.Checked := Battle.Locked;
   LoadDefaultButton.Enabled := False;
+  btLoadDefaultMDO.Enabled := False;
+  btLoadModsDefaultMDO.Enabled := False;
+  btLoadDefaultMPO.Enabled := False;
+  btLoadMapsDefaultMPO.Enabled := False;
   AutoStartRectsApplyItem.Enabled := False;
   AutoStartRectsOptionsItem.Enabled := False;
   LadderRulesButton.Enabled := BattleState.Battle.IsLadderBattle;
@@ -1359,6 +1401,10 @@
   AdminButton.Enabled := False;
   LockedCheckBox.Checked := Battle.Locked;
   LoadDefaultButton.Enabled := False;
+  btLoadDefaultMDO.Enabled := False;
+  btLoadModsDefaultMDO.Enabled := False;
+  btLoadDefaultMPO.Enabled := False;
+  btLoadMapsDefaultMPO.Enabled := False;
   AutoStartRectsApplyItem.Enabled := False;
   AutoStartRectsOptionsItem.Enabled := False;
   LadderRulesButton.Enabled := False;
@@ -1514,6 +1560,8 @@
   begin
     LoadLuaOptions(False,TMapItem(MapListForm.Maps[CurrentMapIndex]).MapName);
     DisplayLuaOptions(BattleForm.MapOptionsList,BattleForm.MapOptionsScrollBox);
+    LoadMapOptionsDefault;
+    panelMapOptionsDefault.Visible := MapOptionsList.Count &gt; 0;
   end;
   MapTab.Caption := 'Map options ('+IntToStr(BattleForm.MapOptionsList.Count)+')';
 
@@ -1561,6 +1609,10 @@
   AdminButton.Enabled := True;
   LockedCheckBox.Checked := False;
   LoadDefaultButton.Enabled := False;
+  btLoadDefaultMDO.Enabled := False;
+  btLoadModsDefaultMDO.Enabled := False;
+  btLoadDefaultMPO.Enabled := False;
+  btLoadMapsDefaultMPO.Enabled := False;
   AutoStartRectsApplyItem.Enabled := False;
   AutoStartRectsOptionsItem.Enabled := False;
   LadderRulesButton.Enabled := BattleState.Battle.IsLadderBattle;
@@ -1602,6 +1654,8 @@
   // load map options
   LoadLuaOptions(False,TMapItem(MapListForm.Maps[CurrentMapIndex]).MapName);
   DisplayLuaOptions(BattleForm.MapOptionsList,BattleForm.MapOptionsScrollBox);
+  LoadMapOptionsDefault;
+  panelMapOptionsDefault.Visible := MapOptionsList.Count &gt; 0;
   MapTab.Caption := 'Map options ('+IntToStr(BattleForm.MapOptionsList.Count)+')';
 
   // disable mod options
@@ -1660,6 +1714,10 @@
   LockedCheckBox.Enabled := False;
   AdminButton.Enabled := False;
   LoadDefaultButton.Enabled := False;
+  btLoadDefaultMDO.Enabled := False;
+  btLoadModsDefaultMDO.Enabled := False;
+  btLoadDefaultMPO.Enabled := False;
+  btLoadMapsDefaultMPO.Enabled := False;
   AutoStartRectsApplyItem.Enabled := False;
   AutoStartRectsOptionsItem.Enabled := False;
   LadderRulesButton.Enabled := False;
@@ -1685,6 +1743,8 @@
     Utility.UnLoadLuaOptions(ModOptionsList);
   if MapOptionsList &lt;&gt; nil then
     Utility.UnLoadLuaOptions(MapOptionsList);
+  panelModOptionsDefault.Visible := false;
+  panelMapOptionsDefault.Visible := false;
   ModTabSheet.Caption := 'Mod options (0)';
   MapTabSheet.Caption := 'Map options (0)';
   if UnknownScriptTagList.CompleteKeyList &lt;&gt; nil then
@@ -1972,6 +2032,7 @@
   // now let's write the script file:
 
   Script.AddOrChangeKeyValue('GAME/Mapname',BattleState.Battle.Map);
+  //Script.AddOrChangeKeyValue('GAME/Maphash',Utility.MapChecksums[Utility.MapList.indexOf(BattleState.Battle.Map)]);
   Script.AddOrChangeKeyValue('GAME/StartMetal',IntToStr(MetalTracker.Value));
   Script.AddOrChangeKeyValue('GAME/StartEnergy',IntToStr(EnergyTracker.Value));
   Script.AddOrChangeKeyValue('GAME/MaxUnits',IntToStr(UnitsTracker.Value));
@@ -4892,7 +4953,6 @@
     end;
   end;
   Ini.Free;
-
 end;
 
 procedure TBattleForm.mnuSaveBoxesClick(Sender: TObject);
@@ -5661,7 +5721,7 @@
       InputEdit.Increment := StepValue;
       InputEdit.Decimal := 4;
     end;
-    InputEdit.Value := DefaultValue;
+    InputEdit.Value := StrToFloat(DefaultValue);
     InputEdit.Hint := Description;
     InputEdit.ShowHint := True;
     InputEdit.Width := 170;
@@ -5702,7 +5762,7 @@
     CheckBox.Height := 15;
     CheckBox.Hint := Description;
     CheckBox.ShowHint := True;
-    CheckBox.Checked := DefaultValue;
+    CheckBox.Checked := StrToBool(DefaultValue);
     CheckBox.OnClick := self.OnChange;
 
     MakeDescriptionButton(Panel);
@@ -5802,26 +5862,51 @@
     Value := v;
 end;
 
+procedure TLuaOption.setToDefault;
+begin
+    Value := DefaultValue;
+end;
+
 procedure TLuaOptionString.SetValue(v: String);
 begin
     InputEdit.Text := v;
 end;
 
+procedure TLuaOptionString.setToDefault;
+begin
+    InputEdit.Text := DefaultValue;
+end;
+
 procedure TLuaOptionList.SetValue(v: String);
 begin
   ComboBox.ItemIndex := Max(0,KeyList.IndexOf(v));
 end;
 
+procedure TLuaOptionList.setToDefault;
+begin
+  ComboBox.ItemIndex := Max(0,KeyList.IndexOf(DefaultValue));
+end;
+
 procedure TLuaOptionBool.SetValue(v: String);
 begin
     CheckBox.Checked := StrToBool(v);
 end;
 
+procedure TLuaOptionBool.setToDefault;
+begin
+    CheckBox.Checked := StrToBool(DefaultValue);
+end;
+
 procedure TLuaOptionNumber.SetValue(v: String);
 begin
     InputEdit.Text := v;
 end;
 
+procedure TLuaOptionNumber.setToDefault;
+begin
+    InputEdit.Text := DefaultValue;
+end;
+
 procedure TLuaOption.Enable;
 begin
   // nothing
@@ -5999,4 +6084,114 @@
     PlayerControlPopupMenuInitPopup(nil,nil);
 end;
 
+procedure TBattleForm.btLoadModsDefaultMDOClick(Sender: TObject);
+var
+  i:integer;
+begin
+  for i:=0 to ModOptionsList.Count -1 do
+    TLuaOption(ModOptionsList[i]).setToDefault;
+
+  SendLuaOptionsDetailsToServer;
+end;
+
+procedure TBattleForm.btLoadMapsDefaultMPOClick(Sender: TObject);
+var
+  i:integer;
+begin
+  for i:=0 to MapOptionsList.Count -1 do
+    TLuaOption(MapOptionsList[i]).setToDefault;
+
+  SendLuaOptionsDetailsToServer;
+end;
+
+procedure TBattleForm.SaveModOptionsAsDefault;
+var
+  Filename : String;
+  Ini : TIniFile;
+  i:integer;
+begin
+  try
+    Filename := MODS_CACHE_FOLDER + '\' + BattleState.Battle.ModName +'.ini';
+    if FileExists(Filename) then
+      DeleteFile(Filename);
+    Ini := TIniFile.Create(Filename);
+    for i:=0 to ModOptionsList.Count -1 do
+      Ini.WriteString('ModOptions', TLuaOption(ModOptionsList[i]).Key, TLuaOption(ModOptionsList[i]).toString);
+    Ini.Free;
+  except
+    Exit;
+  end;
+end;
+
+procedure TBattleForm.LoadModOptionsDefault(modName: string);
+var
+  Filename: string;
+  Ini : TIniFile;
+  i: Integer;
+begin
+  Filename := MODS_CACHE_FOLDER + '\' + modName +'.ini';
+  Ini := TIniFile.Create(Filename);
+  if Ini.SectionExists('ModOptions') then
+  begin
+    for i:=0 to ModOptionsList.Count -1 do
+      TLuaOption(ModOptionsList[i]).SetValue(Ini.ReadString('ModOptions', TLuaOption(ModOptionsList[i]).Key, TLuaOption(ModOptionsList[i]).DefaultValue));
+  end;
+  Ini.Free;
+end;
+
+procedure TBattleForm.SaveMapOptionsAsDefault;
+var
+  Filename : String;
+  Ini : TIniFile;
+  i:integer;
+begin
+  try
+    Filename := MAPS_CACHE_FOLDER + '\' + Utility.MapChecksums[CurrentMapIndex] +'.options';
+    if FileExists(Filename) then
+      DeleteFile(Filename);
+    Ini := TIniFile.Create(Filename);
+    for i:=0 to MapOptionsList.Count -1 do
+      Ini.WriteString('MapOptions', TLuaOption(MapOptionsList[i]).Key, TLuaOption(MapOptionsList[i]).toString);
+    Ini.Free;
+  except
+    Exit;
+  end;
+end;
+
+procedure TBattleForm.LoadMapOptionsDefault;
+var
+  Filename: string;
+  Ini : TIniFile;
+  i: Integer;
+begin
+  Filename := MAPS_CACHE_FOLDER + '\' + Utility.MapChecksums[CurrentMapIndex] +'.options';
+  Ini := TIniFile.Create(Filename);
+  if Ini.SectionExists('MapOptions') then
+  begin
+    for i:=0 to MapOptionsList.Count -1 do
+      TLuaOption(MapOptionsList[i]).SetValue(Ini.ReadString('MapOptions', TLuaOption(MapOptionsList[i]).Key, TLuaOption(MapOptionsList[i]).DefaultValue));
+  end;
+  Ini.Free;
+end;
+
+procedure TBattleForm.btSetAsDefaultMDOClick(Sender: TObject);
+begin
+  SaveModOptionsAsDefault;
+end;
+
+procedure TBattleForm.btSetAsDefaultMPOClick(Sender: TObject);
+begin
+  SaveMapOptionsAsDefault;
+end;
+
+procedure TBattleForm.btLoadDefaultMDOClick(Sender: TObject);
+begin
+  LoadModOptionsDefault(BattleState.Battle.ModName);
+end;
+
+procedure TBattleForm.btLoadDefaultMPOClick(Sender: TObject);
+begin
+  LoadMapOptionsDefault;
+end;
+
 end.

Modified: trunk/Lobby/TASClient/MainUnit.dfm
===================================================================
--- trunk/Lobby/TASClient/MainUnit.dfm	2008-03-12 22:02:38 UTC (rev 5581)
+++ trunk/Lobby/TASClient/MainUnit.dfm	2008-03-13 18:13:15 UTC (rev 5582)
@@ -1,6 +1,6 @@
 object MainForm: TMainForm
-  Left = 821
-  Top = 145
+  Left = 452
+  Top = 260
   Width = 789
   Height = 548
   Caption = 'TASClient'

Modified: trunk/Lobby/TASClient/MainUnit.pas
===================================================================
--- trunk/Lobby/TASClient/MainUnit.pas	2008-03-12 22:02:38 UTC (rev 5581)
+++ trunk/Lobby/TASClient/MainUnit.pas	2008-03-13 18:13:15 UTC (rev 5582)
@@ -508,7 +508,7 @@
 
 const
   VERSION_NUMBER = '0.37'; // Must be float value! (with a period as a decimal seperator)
-  BETA_NUMBER = 244;
+  BETA_NUMBER = 245;
   CHECK_BETA_LOBBY_URL = '<A HREF="http://www.climachine.com/spring/TASClient.txt">http://www.climachine.com/spring/TASClient.txt</A>';
   PROGRAM_VERSION = 'TASClient ' + VERSION_NUMBER + ' beta';
   KEEP_ALIVE_INTERVAL = 10000; // in milliseconds. Tells us what should be the maximum &quot;silence&quot; time before we send a ping to the server.
@@ -530,6 +530,7 @@
   CACHE_FOLDER = LOBBY_FOLDER + '\' + 'cache';
   ONLINE_CACHE_FOLDER = CACHE_FOLDER + '\' + 'online'; // we store images of minimaps (downloaded from content site) in it (see OnlineMapsForm)
   MAPS_CACHE_FOLDER = CACHE_FOLDER + '\' + 'maps'; // we store info of local maps there plus minimaps
+  MODS_CACHE_FOLDER = CACHE_FOLDER + '\' + 'mods'; // we store info of local mods there like default mod options
   LOG_FOLDER = LOBBY_FOLDER + '\' + 'logs'; // this is where we store chat logs
   VAR_FOLDER = LOBBY_FOLDER + '\' + 'var';
   FIRST_UDP_SOURCEPORT = 8300; // udp source port (used with &quot;fixed source ports&quot; NAT traversal technique) of the second (first one is host) client in clients list of the battle. Third client uses this+1 port, fourth one this+2, etc.
@@ -3208,6 +3209,17 @@
       end;
     end;
 
+    if not DirectoryExists(ExtractFilePath(Application.ExeName) + MODS_CACHE_FOLDER) then
+    begin
+      MessageDlg('Program has detected that &quot;' + MODS_CACHE_FOLDER + '&quot; folder does not exist. It will be now created.', mtInformation, [mbOK], 0);
+      if not CreateDir(ExtractFilePath(Application.ExeName) + MODS_CACHE_FOLDER) then
+      begin
+        MessageDlg('Unable to create directory. Program will now exit ...', mtError, [mbOK], 0);
+        Application.Terminate;
+        Exit;
+      end;
+    end;
+
     if not DirectoryExists(ExtractFilePath(Application.ExeName) + LOG_FOLDER) then
     begin
       MessageDlg('Program has detected that &quot;' + LOG_FOLDER + '&quot; folder does not exist. It will be now created.', mtInformation, [mbOK], 0);
@@ -7844,8 +7856,8 @@
   // auto select item on right click:
   if Button = mbRight then
   begin
+    ClientsListBox.ItemIndex := ClientsListBox.ItemAtPos(Point(X, Y), True);
     ClientPopupMenuInitPopup(nil,nil);
-    ClientsListBox.ItemIndex := ClientsListBox.ItemAtPos(Point(X, Y), True);
   end;
 end;
 

Modified: trunk/Lobby/TASClient/TASClient.dof
===================================================================
--- trunk/Lobby/TASClient/TASClient.dof	2008-03-12 22:02:38 UTC (rev 5581)
+++ trunk/Lobby/TASClient/TASClient.dof	2008-03-13 18:13:15 UTC (rev 5582)
@@ -115,7 +115,7 @@
 MajorVer=0
 MinorVer=3
 Release=0
-Build=244
+Build=245
 Debug=0
 PreRelease=0
 Special=0
@@ -126,7 +126,7 @@
 [Version Info Keys]
 CompanyName=
 FileDescription=TA Spring lobby client
-FileVersion=0.3.0.244
+FileVersion=0.3.0.245
 InternalName=
 LegalCopyright=
 LegalTrademarks=

Modified: trunk/Lobby/TASClient/TASClient.res
===================================================================
(Binary files differ)

Modified: trunk/Lobby/TASClient/Utility.pas
===================================================================
--- trunk/Lobby/TASClient/Utility.pas	2008-03-12 22:02:38 UTC (rev 5581)
+++ trunk/Lobby/TASClient/Utility.pas	2008-03-13 18:13:15 UTC (rev 5582)
@@ -570,7 +570,7 @@
       begin
         New(o);
         o^ := TLuaOptionBool.Create;
-        TLuaOptionBool(o^).DefaultValue := GetOptionBoolDef(i);
+        TLuaOptionBool(o^).DefaultValue := BoolToStr(GetOptionBoolDef(i));
       end;
       2: // list
       begin
@@ -593,7 +593,7 @@
         o^ := TLuaOptionNumber.Create;
         with TLuaOptionNumber(o^) do
         begin
-          DefaultValue := GetOptionNumberDef(i);
+          DefaultValue := FloatToStr(GetOptionNumberDef(i));
           MinValue := GetOptionNumberMin(i);
           MaxValue := GetOptionNumberMax(i);
           StepValue := RoundTo(GetOptionNumberStep(i),-4);


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000362.html">[Taspring-linux-commit] r5581 - trunk/rts/Sim/MoveTypes
</A></li>
	<LI>Next message: <A HREF="000364.html">[Taspring-linux-commit] r5583 - trunk/tools/unitsync
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#363">[ date ]</a>
              <a href="thread.html#363">[ thread ]</a>
              <a href="subject.html#363">[ subject ]</a>
              <a href="author.html#363">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
