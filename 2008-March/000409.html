<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r5628 - in trunk/Lobby/TASClient: .	LobbyComponents
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2008-March/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5628%20-%20in%20trunk/Lobby/TASClient%3A%20.%0A%09LobbyComponents&In-Reply-To=%3C20080330195328.8AD9A4697%40progate.clan-sy.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000408.html">
   <LINK REL="Next"  HREF="000410.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r5628 - in trunk/Lobby/TASClient: .	LobbyComponents</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r5628%20-%20in%20trunk/Lobby/TASClient%3A%20.%0A%09LobbyComponents&In-Reply-To=%3C20080330195328.8AD9A4697%40progate.clan-sy.com%3E"
       TITLE="[Taspring-linux-commit] r5628 - in trunk/Lobby/TASClient: .	LobbyComponents">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Sun Mar 30 21:53:28 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000408.html">[Taspring-linux-commit] r5627 - trunk/rts/Sim/Projectiles
</A></li>
        <LI>Next message: <A HREF="000410.html">[Taspring-linux-commit] r5629 - trunk/rts/Game
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#409">[ date ]</a>
              <a href="thread.html#409">[ thread ]</a>
              <a href="subject.html#409">[ subject ]</a>
              <a href="author.html#409">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: satirik
Date: 2008-03-30 21:53:26 +0200 (Sun, 30 Mar 2008)
New Revision: 5628

Modified:
   trunk/Lobby/TASClient/BattleFormUnit.dfm
   trunk/Lobby/TASClient/BattleFormUnit.pas
   trunk/Lobby/TASClient/GpIFF.pas
   trunk/Lobby/TASClient/HighlightingUnit.pas
   trunk/Lobby/TASClient/HostBattleFormUnit.dfm
   trunk/Lobby/TASClient/HostBattleFormUnit.pas
   trunk/Lobby/TASClient/LobbyComponents/RichEditURL.pas
   trunk/Lobby/TASClient/MainUnit.dfm
   trunk/Lobby/TASClient/MainUnit.pas
   trunk/Lobby/TASClient/Misc.pas
   trunk/Lobby/TASClient/PreferencesFormUnit.dfm
   trunk/Lobby/TASClient/SearchFormUnit.dfm
   trunk/Lobby/TASClient/SearchFormUnit.pas
   trunk/Lobby/TASClient/TASClient.dof
   trunk/Lobby/TASClient/TASClient.res
Log:
- changed TEdit in TSpTBXEdit and TRichEdit in TTntRichEdit for the chat in both battle screen and main form
- updated download links to <A HREF="http://spring.jobjol.nl/">http://spring.jobjol.nl/</A> (search form, auto redirect if you don't have the mod or map etc) i took that site because it has the most features
- changed the ladder rules download to use the new allrules.php script which is much faster than the previous way (1s instead of 10 to download the ladder list)

Modified: trunk/Lobby/TASClient/BattleFormUnit.dfm
===================================================================
--- trunk/Lobby/TASClient/BattleFormUnit.dfm	2008-03-30 17:51:59 UTC (rev 5627)
+++ trunk/Lobby/TASClient/BattleFormUnit.dfm	2008-03-30 19:53:26 UTC (rev 5628)
@@ -1,6 +1,6 @@
 object BattleForm: TBattleForm
-  Left = 757
-  Top = 87
+  Left = 868
+  Top = 62
   Width = 758
   Height = 548
   Caption = 'Battle window'
@@ -3943,38 +3943,26 @@
           0000}
         Visible = False
       end
-      object InputEdit: TEdit
-        Left = 32
-        Top = 90
-        Width = 441
-        Height = 23
-        Font.Charset = DEFAULT_CHARSET
-        Font.Color = clWindowText
-        Font.Height = -11
-        Font.Name = 'Fixedsys'
-        Font.Style = []
-        ParentFont = False
-        TabOrder = 1
+      object InputEdit: TSpTBXEdit
+        Left = 272
+        Top = 16
+        Width = 241
+        Height = 21
+        TabOrder = 0
         OnKeyDown = InputEditKeyDown
         OnKeyPress = InputEditKeyPress
       end
-      object ChatRichEdit: TRichEditURL
-        Left = 80
-        Top = 8
-        Width = 225
+      object ChatRichEdit: TTntRichEditURL
+        Left = 88
+        Top = 0
+        Width = 129
         Height = 65
         TabStop = False
-        Font.Charset = DEFAULT_CHARSET
-        Font.Color = clWindowText
-        Font.Height = -11
-        Font.Name = 'Fixedsys'
-        Font.Style = []
         HideSelection = False
-        ParentFont = False
         PlainText = True
         ReadOnly = True
         ScrollBars = ssVertical
-        TabOrder = 0
+        TabOrder = 1
         OnMouseDown = ChatRichEditMouseDown
         OnURLClick = ChatRichEditURLClick
       end
@@ -4379,18 +4367,18 @@
         Height = 257
         Anchors = [akLeft, akTop, akRight]
         Color = clBtnFace
-        ActiveTabIndex = 0
+        ActiveTabIndex = 2
         OnActiveTabChange = SpTBXTabControl1ActiveTabChange
         HiddenItems = &lt;&gt;
         object GameOptionsTab: TSpTBXTabItem
           Caption = 'Game options'
-          Checked = True
         end
         object DisabledUnitsTab: TSpTBXTabItem
           Caption = 'Disabled Units (0)'
         end
         object MapTab: TSpTBXTabItem
           Caption = 'Map options'
+          Checked = True
         end
         object ModTab: TSpTBXTabItem
           Caption = 'Mod options'
@@ -4437,86 +4425,6 @@
             end
           end
         end
-        object MapTabSheet: TSpTBXTabSheet
-          Left = 0
-          Top = 23
-          Width = 393
-          Height = 234
-          Caption = 'Map options'
-          ImageIndex = -1
-          DesignSize = (
-            393
-            234)
-          TabItem = 'MapTab'
-          object MapOptionsScrollBox: TTntScrollBox
-            Left = 2
-            Top = 48
-            Width = 388
-            Height = 184
-            VertScrollBar.Smooth = True
-            VertScrollBar.Tracking = True
-            Anchors = [akLeft, akTop, akRight, akBottom]
-            BiDiMode = bdLeftToRight
-            BorderStyle = bsNone
-            Color = clBtnFace
-            Ctl3D = False
-            ParentBiDiMode = False
-            ParentBackground = True
-            ParentColor = False
-            ParentCtl3D = False
-            TabOrder = 0
-          end
-          object panelMapOptionsDefault: TSpTBXPanel
-            Left = 5
-            Top = 4
-            Width = 382
-            Height = 41
-            Align = alCustom
-            TabOrder = 1
-            object btLoadDefaultMPO: TSpTBXButton
-              Left = 136
-              Top = 8
-              Width = 113
-              Height = 25
-              Caption = 'Load default'
-              TabOrder = 0
-              OnClick = btLoadDefaultMPOClick
-              LinkFont.Charset = DEFAULT_CHARSET
-              LinkFont.Color = clBlue
-              LinkFont.Height = -11
-              LinkFont.Name = 'MS Sans Serif'
-              LinkFont.Style = [fsUnderline]
-            end
-            object btSetAsDefaultMPO: TSpTBXButton
-              Left = 256
-              Top = 8
-              Width = 113
-              Height = 25
-              Caption = 'Set as default'
-              TabOrder = 1
-              OnClick = btSetAsDefaultMPOClick
-              LinkFont.Charset = DEFAULT_CHARSET
-              LinkFont.Color = clBlue
-              LinkFont.Height = -11
-              LinkFont.Name = 'MS Sans Serif'
-              LinkFont.Style = [fsUnderline]
-            end
-            object btLoadMapsDefaultMPO: TSpTBXButton
-              Left = 16
-              Top = 8
-              Width = 113
-              Height = 25
-              Caption = 'Load map'#39's default'
-              TabOrder = 2
-              OnClick = btLoadMapsDefaultMPOClick
-              LinkFont.Charset = DEFAULT_CHARSET
-              LinkFont.Color = clBlue
-              LinkFont.Height = -11
-              LinkFont.Name = 'MS Sans Serif'
-              LinkFont.Style = [fsUnderline]
-            end
-          end
-        end
         object ModTabSheet: TSpTBXTabSheet
           Left = 0
           Top = 23
@@ -4867,6 +4775,86 @@
             LinkFont.Style = [fsUnderline]
           end
         end
+        object MapTabSheet: TSpTBXTabSheet
+          Left = 0
+          Top = 23
+          Width = 393
+          Height = 234
+          Caption = 'Map options'
+          ImageIndex = -1
+          DesignSize = (
+            393
+            234)
+          TabItem = 'MapTab'
+          object MapOptionsScrollBox: TTntScrollBox
+            Left = 2
+            Top = 48
+            Width = 388
+            Height = 184
+            VertScrollBar.Smooth = True
+            VertScrollBar.Tracking = True
+            Anchors = [akLeft, akTop, akRight, akBottom]
+            BiDiMode = bdLeftToRight
+            BorderStyle = bsNone
+            Color = clBtnFace
+            Ctl3D = False
+            ParentBiDiMode = False
+            ParentBackground = True
+            ParentColor = False
+            ParentCtl3D = False
+            TabOrder = 0
+          end
+          object panelMapOptionsDefault: TSpTBXPanel
+            Left = 5
+            Top = 4
+            Width = 382
+            Height = 41
+            Align = alCustom
+            TabOrder = 1
+            object btLoadDefaultMPO: TSpTBXButton
+              Left = 136
+              Top = 8
+              Width = 113
+              Height = 25
+              Caption = 'Load default'
+              TabOrder = 0
+              OnClick = btLoadDefaultMPOClick
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object btSetAsDefaultMPO: TSpTBXButton
+              Left = 256
+              Top = 8
+              Width = 113
+              Height = 25
+              Caption = 'Set as default'
+              TabOrder = 1
+              OnClick = btSetAsDefaultMPOClick
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+            object btLoadMapsDefaultMPO: TSpTBXButton
+              Left = 16
+              Top = 8
+              Width = 113
+              Height = 25
+              Caption = 'Load map'#39's default'
+              TabOrder = 2
+              OnClick = btLoadMapsDefaultMPOClick
+              LinkFont.Charset = DEFAULT_CHARSET
+              LinkFont.Color = clBlue
+              LinkFont.Height = -11
+              LinkFont.Name = 'MS Sans Serif'
+              LinkFont.Style = [fsUnderline]
+            end
+          end
+        end
       end
       object lblTeamNbr: TSpTBXLabel
         Left = 445

Modified: trunk/Lobby/TASClient/BattleFormUnit.pas
===================================================================
--- trunk/Lobby/TASClient/BattleFormUnit.pas	2008-03-30 17:51:59 UTC (rev 5627)
+++ trunk/Lobby/TASClient/BattleFormUnit.pas	2008-03-30 19:53:26 UTC (rev 5628)
@@ -24,7 +24,7 @@
   ImageEx, JvSticker, JvExExtCtrls, JvImage, JvShape, JvLabel, TBXLists,
   SpTBXLists, ImgList, SpTBXjanTracker, SpTBXFormPopupMenu,IniFiles,
   HttpProt,MsMultiPartFormData, JvComponentBase, JvDSADialogs, Spin, Mask,
-  JvExMask, JvSpin, TntStdCtrls, TntForms;
+  JvExMask, JvSpin, TntStdCtrls, TntForms, TntComCtrls,RichEdit;
 
 type
 
@@ -173,8 +173,6 @@
     LockedCheckBox: TSpTBXCheckBox;
     Panel2: TPanel;
     NoMapImage: TImage;
-    InputEdit: TEdit;
-    ChatRichEdit: TRichEditURL;
     Splitter1: TSplitter;
     Panel1: TPanel;
     MyOptionsGroupBox: TSpTBXGroupBox;
@@ -280,6 +278,8 @@
     btLoadDefaultMPO: TSpTBXButton;
     btSetAsDefaultMPO: TSpTBXButton;
     btLoadMapsDefaultMPO: TSpTBXButton;
+    InputEdit: TSpTBXEdit;
+    ChatRichEdit: TTntRichEditURL;
 
     procedure CreateParams(var Params: TCreateParams); override;
 
@@ -464,7 +464,6 @@
     function GetLuaOption(optList: TList;key: string): TLuaOption;
     procedure ChangeScriptTagValue(completeKey: String; value: String);
     procedure SendLuaOptionsDetailsToServer;
-    procedure Button1Click(Sender: TObject);
     procedure FormResize(Sender: TObject);
     procedure SpTBXTabControl1ActiveTabChange(Sender: TObject;
       TabIndex: Integer);
@@ -2282,6 +2281,7 @@
 procedure TBattleForm.FormCreate(Sender: TObject);
 var
   i:integer;
+  mask: Word;
 begin
   Left := 10;
   Top := 10;
@@ -2292,6 +2292,9 @@
 
   InputEdit.Align := alBottom;
   ChatRichEdit.Align := alClient;
+  mask := SendMessage(ChatRichEdit.Handle, EM_GETEVENTMASK, 0, 0);
+  SendMessage(ChatRichEdit.Handle, EM_SETEVENTMASK, 0, mask or ENM_LINK);
+  SendMessage(ChatRichEdit.Handle, EM_AUTOURLDETECT, Integer(True), 0);
 
   MapImage.Picture.Bitmap.Assign(NoMapImage.Picture.Bitmap);
   ChangeMapToNoMap('Loading...');
@@ -2428,9 +2431,9 @@
       end
       else
         url := StringReplace(BattleState.Battle.Map,'.smf','',[rfReplaceAll, rfIgnoreCase]);
-        url := StringReplace(url,'_','*',[rfReplaceAll, rfIgnoreCase]);
-        url := StringReplace(url,'-','*',[rfReplaceAll, rfIgnoreCase]);
-        url := '<A HREF="http://www.unknown-files.net/spring/search/*">http://www.unknown-files.net/spring/search/*</A>' + url+'/';
+        {url := StringReplace(url,'_',' ',[rfReplaceAll, rfIgnoreCase]);
+        url := StringReplace(url,'-',' ',[rfReplaceAll, rfIgnoreCase]);}
+        url := '<A HREF="http://spring.jobjol.nl/search_result.php?search=">http://spring.jobjol.nl/search_result.php?search=</A>' + url+'&amp;select=select_all';
         FixURL(url);
         Misc.OpenURLInDefaultBrowser(url);
     end;
@@ -6053,14 +6056,6 @@
     TLuaOption(MapOptionsList[i]).OnChange(nil);
 end;
 
-procedure TBattleForm.Button1Click(Sender: TObject);
-var
-  url: string;
-begin
-  ModTab.FontSettings.Bold := tsTrue;
-  ModTab.FontSettings.Color := clHighlight;
-end;
-
 procedure TBattleForm.FormResize(Sender: TObject);
 begin
   FixFormSizeConstraints(BattleForm);

Modified: trunk/Lobby/TASClient/GpIFF.pas
===================================================================
--- trunk/Lobby/TASClient/GpIFF.pas	2008-03-30 17:51:59 UTC (rev 5627)
+++ trunk/Lobby/TASClient/GpIFF.pas	2008-03-30 19:53:26 UTC (rev 5628)
@@ -42,7 +42,8 @@
 
 interface
 
-  function IFF(condit: boolean; iftrue, iffalse: string): string; overload;
+  function IFF(condit: boolean; iftrue, iffalse: WideString): WideString; overload;
+  function IFF(condit: boolean; iftrue, iffalse: String): String; overload;
   function IFF(condit: boolean; iftrue, iffalse: integer): integer; overload;
   function IFF(condit: boolean; iftrue, iffalse: real): real; overload;
   function IFF(condit: boolean; iftrue, iffalse: boolean): boolean; overload;
@@ -50,7 +51,7 @@
 
 implementation
 
-  function IFF(condit: boolean; iftrue, iffalse: string): string;
+  function IFF(condit: boolean; iftrue, iffalse: WideString): WideString;
   begin
     if condit then
       Result := iftrue
@@ -58,6 +59,14 @@
       Result := iffalse;
   end; { IFF }
 
+  function IFF(condit: boolean; iftrue, iffalse: String): String;
+  begin
+    if condit then
+      Result := iftrue
+    else
+      Result := iffalse;
+  end; { IFF }
+
   function IFF(condit: boolean; iftrue, iffalse: integer): integer;
   begin
     if condit then

Modified: trunk/Lobby/TASClient/HighlightingUnit.pas
===================================================================
--- trunk/Lobby/TASClient/HighlightingUnit.pas	2008-03-30 17:51:59 UTC (rev 5627)
+++ trunk/Lobby/TASClient/HighlightingUnit.pas	2008-03-30 19:53:26 UTC (rev 5628)
@@ -6,7 +6,7 @@
   Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
   Dialogs, StdCtrls, CheckLst, JvExCheckLst, JvCheckListBox, Buttons,
   ExtCtrls, ComCtrls, StrUtils, JvExStdCtrls, JvCombobox, JvColorCombo,
-  TntCheckLst, SpTBXEditors, SpTBXControls, TBXDkPanels, SpTBXItem;
+  TntCheckLst, SpTBXEditors, SpTBXControls, TBXDkPanels, SpTBXItem,TntComCtrls;
 
 type
   THighlightingForm = class(TForm)
@@ -24,7 +24,7 @@
     JvColorComboBox1: TJvColorComboBox;
 
     procedure CreateParams(var Params: TCreateParams); override;
-    function CheckLastLineForHighlights(RichEdit: TRichEdit; ChatTextPos: Integer): Boolean;
+    function CheckLastLineForHighlights(RichEdit: TTntRichEdit; ChatTextPos: Integer): Boolean;
     procedure CloseButtonClick(Sender: TObject);
     procedure SaveHighlightsToFile(FileName: string);
     procedure LoadHighlightsFromFile(FileName: string);
@@ -134,7 +134,7 @@
 // will highlight all keywords and automatically pop-up notifications (if set so).
 // Returns TRUE if any word has been highlighted.
 // For ChatTextPos argument, see Misc.AddTextToRichEdit's comments!
-function THighlightingForm.CheckLastLineForHighlights(RichEdit: TRichEdit; ChatTextPos: Integer): Boolean;
+function THighlightingForm.CheckLastLineForHighlights(RichEdit: TTntRichEdit; ChatTextPos: Integer): Boolean;
 var
   i: Integer;
   sn, su: string; // string normal, string uppercase

Modified: trunk/Lobby/TASClient/HostBattleFormUnit.dfm
===================================================================
--- trunk/Lobby/TASClient/HostBattleFormUnit.dfm	2008-03-30 17:51:59 UTC (rev 5627)
+++ trunk/Lobby/TASClient/HostBattleFormUnit.dfm	2008-03-30 19:53:26 UTC (rev 5628)
@@ -1,6 +1,6 @@
 object HostBattleForm: THostBattleForm
-  Left = 386
-  Top = 194
+  Left = 813
+  Top = 311
   BorderStyle = bsDialog
   Caption = 'Host battle'
   ClientHeight = 355

Modified: trunk/Lobby/TASClient/HostBattleFormUnit.pas
===================================================================
--- trunk/Lobby/TASClient/HostBattleFormUnit.pas	2008-03-30 17:51:59 UTC (rev 5627)
+++ trunk/Lobby/TASClient/HostBattleFormUnit.pas	2008-03-30 19:53:26 UTC (rev 5628)
@@ -68,15 +68,17 @@
   TLadderListThread = class(TDialogThread)
   private
     DownloadLadderDetailsIndex : integer;
+    DownloadAllRulesAtOnce : boolean;
     procedure Refresh;
     function DownloadLadderDetails(ladderIndex : integer):boolean;
+    function DownloadAllLadderDetails: boolean;
     procedure OnTerminateProcedure(Sender : TObject);
 
   protected
     procedure Execute; override;
     
   public
-    constructor Create(Suspended : Boolean;ladderIndex: integer);
+    constructor Create(Suspended : Boolean;ladderIndex: integer; getAllRulesAtOnce: boolean);
   end;
 var
   HostBattleForm: THostBattleForm;
@@ -663,7 +665,7 @@
   HostButton.Caption := 'Host Ladder';
 
   if LadderComboBox.Items.Count =0 then
-    ThreadLL := TLadderListThread.Create(False,-1)
+    ThreadLL := TLadderListThread.Create(False,-1,true)
   else
     ApplyLadderParams(TLadder(LadderList[LadderComboBox.ItemIndex]));
 end;
@@ -693,12 +695,13 @@
   end;
 end;
 
-constructor TLadderListThread.Create(Suspended : Boolean;ladderIndex: integer);
+constructor TLadderListThread.Create(Suspended : Boolean;ladderIndex: integer; getAllRulesAtOnce: boolean);
 begin
    FreeOnTerminate := True;
    inherited Create(Suspended);
    OnTerminate := OnTerminateProcedure;
    DownloadLadderDetailsIndex := ladderIndex;
+   DownloadAllRulesAtOnce := getAllRulesAtOnce;
 end;
 
 procedure TLadderListThread.Execute;
@@ -706,6 +709,8 @@
   if DownloadLadderDetailsIndex &gt; -1 then begin
     DownloadLadderDetails(DownloadLadderDetailsIndex);
   end
+  else if DownloadALlRulesAtOnce then
+    DownloadAllLadderDetails
   else
     Refresh;
 end;
@@ -796,7 +801,7 @@
     ApplyLadderParams(TLadder(LadderList[0]));
     parse1.Clear;
     HostButton.Enabled := True;
-    RefreshButton.Enabled := True
+    RefreshButton.Enabled := True;
   end;
 end;
 
@@ -916,6 +921,159 @@
   end;
 end;
 
+function TLadderListThread.DownloadAllLadderDetails: boolean;
+var
+  html:string;
+  parse1,parse2 : TStrings;
+  i,j,k,l : integer;
+  paramName,paramValue: string;
+  nbRulesLines: integer;
+  ladder : ^TLadder;
+  laddername,ladderid:string;
+begin
+  Result := True;
+  parse1 := TStringList.Create;
+  parse2 := TStringList.Create;
+  with HostBattleForm do begin
+    LadderComboBox.Clear;
+    LadderComboBox.Items.Add('Loading ladder list ...');
+    LadderComboBox.ItemIndex := 0;
+    HostButton.Enabled := False;
+    RefreshButton.Enabled := False;
+
+    if Preferences.UseProxy then
+    begin
+      HttpCli1.Proxy := Preferences.ProxyAddress;
+      HttpCli1.ProxyPort := IntToStr(Preferences.ProxyPort);
+      HttpCli1.ProxyUsername := Preferences.ProxyUsername;
+      HttpCli1.ProxyPassword := Preferences.ProxyPassword
+    end
+    else HttpCli1.Proxy := '';
+    HttpCli1.URL := LADDER_PREFIX_URL + 'allrules.php';
+    HttpCli1.RcvdStream := TMemoryStream.Create;
+    try
+      HttpCli1.Get;
+    except
+      MainForm.AddMainLog('Error: Ladder server unavailable.', Colors.Error);
+      LadderComboBox.Items.Strings[0] := 'Error: Ladder server unavailable.';
+      LadderComboBox.ItemIndex := 0;
+      RefreshButton.Enabled := True;
+      HostButton.Enabled := True;
+      LadderList.Clear;
+      Exit;
+    end;
+    HttpCli1.RcvdStream.Seek(0,0);
+    SetLength(html, HttpCli1.RcvdStream.Size);
+    HttpCli1.RcvdStream.ReadBuffer(Pointer(html)^, HttpCli1.RcvdStream.Size);
+    HttpCli1.RcvdStream.Free;
+
+    // parse the html result
+    Misc.ParseDelimited(parse1,html,' ','');
+    if (parse1[0] = 'error') or (parse1[0] = 'notice') then
+    begin
+      parse1.Delete(0);
+      MessageDlgThread(Misc.JoinStringList(parse1,' '),mtError,[mbOK],0)
+    end
+    else
+    begin
+      parse1.Clear;
+      Misc.ParseDelimited(parse1,html,#$A,'');
+        for i:=0 to parse1.Count-1 do
+          if parse1[i] &lt;&gt; '' then begin
+          try
+            k := Pos(' ',PChar(parse1[i]));
+            paramValue := MidStr(parse1[i],k+1,5000000);
+            paramName := Copy(parse1[i],1,k-1);
+            if paramValue = 'any' then
+              paramValue := '-1';
+            if paramName = 'ladder' then
+            begin
+              Misc.ParseDelimited(parse2,paramValue,' ','');
+              ladderid := parse2[0];
+              parse2.Delete(0);
+              laddername := JoinStringList(parse2,' ');
+              New(ladder);
+              ladder^ := TLadder.Create(StrToInt(ladderid),laddername);
+            end
+            else if paramName = 'mod' then
+              ladder^.ModName := paramValue
+            else if paramName = 'min_players_per_allyteam' then
+              ladder^.MinPlayersPerAllyTeam := StrToInt(paramValue)
+            else if paramName = 'max_players_per_allyteam' then
+              ladder^.MaxPlayersPerAllyTeam := StrToInt(paramValue)
+            else if paramName = 'startpos' then
+              ladder^.StartPos := StrToInt(paramValue)
+            else if paramName = 'gamemode' then
+              ladder^.GameMode := StrToInt(paramValue)
+            else if paramName = 'dgun' then
+              ladder^.DGun := StrToInt(paramValue)
+            else if paramName = 'ghost' then
+              ladder^.Ghost := StrToInt(paramValue)
+            else if paramName = 'diminish' then
+              ladder^.Diminish := StrToInt(paramValue)
+            else if paramName = 'metal' then
+              if paramValue &lt;&gt; '-1' then begin
+                Misc.ParseDelimited(parse2,paramValue,' ','');
+                ladder^.MetalMin := Max(0,StrToInt(parse2[0]));
+                ladder^.MetalMax := Min(10000,StrToInt(parse2[1]));
+              end
+              else
+                ladder^.MetalMin := StrToInt(paramValue)
+            else if paramName = 'energy' then
+              if paramValue &lt;&gt; '-1' then begin
+                Misc.ParseDelimited(parse2,paramValue,' ','');
+                ladder^.EnergyMin := Max(0,StrToInt(parse2[0]));
+                ladder^.EnergyMax := Min(10000,StrToInt(parse2[1]));
+              end
+              else
+                ladder^.EnergyMin := StrToInt(paramValue)
+            else if paramName = 'units' then
+              if paramValue &lt;&gt; '-1' then begin
+                Misc.ParseDelimited(parse2,paramValue,' ','');
+                ladder^.UnitsMin := Max(10,StrToInt(parse2[0]));
+                ladder^.UnitsMax := Min(5000,StrToInt(parse2[1]));
+              end
+              else
+                ladder^.UnitsMin := StrToInt(paramValue)
+            else if paramName = 'rules' then
+              begin
+                Misc.ParseDelimited(parse2,paramValue,' ','');
+                nbRulesLines := StrToInt(parse2[0]);
+                parse2.Delete(0);
+                ladder^.Rules := JoinStringList(parse2,' ');
+                for j:=i+1 to i+nbRulesLines-1 do
+                  ladder^.Rules := ladder^.Rules + parse1[j];
+                if ladder^.Rules = '' then
+                  ladder^.Rules := 'No rules set for this ladder.';
+                LadderList.Add(ladder^);
+              end
+            else if paramName = 'restricted' then
+                if paramValue &lt;&gt; 'none' then
+                  Misc.ParseDelimited(ladder^.Restricted,paramValue,',','')
+          Except
+            MessageDlgThread('An error occured while parsing the ladder details !',mtError,[mbOk],0);
+            Result := False;
+            LadderComboBox.Items.Strings[0] := 'Error: Ladders details download failed.';
+            LadderComboBox.ItemIndex := 0;
+            RefreshButton.Enabled := True;
+            HostButton.Enabled := True;
+            LadderList.Clear;
+            Exit;
+          end;
+        end;
+    end;
+
+    LadderComboBox.Clear;
+    for j:=0 to LadderList.Count -1 do
+      LadderComboBox.Items.Add(TLadder(LadderList[j]).Name);
+    LadderComboBox.ItemIndex := 0;
+    ApplyLadderParams(TLadder(LadderList[0]));
+    parse1.Clear;
+    HostButton.Enabled := True;
+    RefreshButton.Enabled := True;
+  end;
+end;
+
 procedure TLadderListThread.OnTerminateProcedure(Sender: TObject);
 begin
   // nothing
@@ -926,7 +1084,7 @@
   ThreadLL : TLadderListThread;
 begin
   LadderList.Clear;
-  ThreadLL := TLadderListThread.Create(False,-1);
+  ThreadLL := TLadderListThread.Create(False,-1,true);
 end;
 
 procedure THostBattleForm.LadderComboBoxChange(Sender: TObject);

Modified: trunk/Lobby/TASClient/LobbyComponents/RichEditURL.pas
===================================================================
--- trunk/Lobby/TASClient/LobbyComponents/RichEditURL.pas	2008-03-30 17:51:59 UTC (rev 5627)
+++ trunk/Lobby/TASClient/LobbyComponents/RichEditURL.pas	2008-03-30 19:53:26 UTC (rev 5628)
@@ -1,7 +1,7 @@
 {
 Article: 
 
-TRichEditURL - hyperlink aware RichEdit
+TTntRichEditURL - hyperlink aware TntRichEdit
 
 <A HREF="http://delphi.about.com/library/weekly/aa051804a.htm">http://delphi.about.com/library/weekly/aa051804a.htm</A>
 
@@ -27,7 +27,7 @@
 type
   TURLClickEvent = procedure(Sender :TObject; const URL: string) of object;
 
-  TRichEditURL = class(TRichEdit)
+  TTntRichEditURL = class(TTntRichEdit)
   private
     FOnURLClick: TURLClickEvent;
     procedure CNNotify(var Msg: TWMNotify); message CN_NOTIFY;
@@ -45,17 +45,17 @@
 
 procedure Register;
 begin
-  RegisterComponents('Spring lobby', [TRichEditURL]);
+  RegisterComponents('Spring lobby', [TTntRichEditURL]);
 end;
 
 
 { TRichEditURL }
-procedure TRichEditURL.DoURLClick(const URL : string);
+procedure TTntRichEditURL.DoURLClick(const URL : string);
 begin
   if Assigned(FOnURLClick) then OnURLClick(Self, URL);
 end; (*DoURLClick*)
 
-procedure TRichEditURL.CNNotify(var Msg: TWMNotify);
+procedure TTntRichEditURL.CNNotify(var Msg: TWMNotify);
 var
   p: TENLink;
   sURL: string;
@@ -77,7 +77,7 @@
  inherited;
 end; (*CNNotify*)
 
-procedure TRichEditURL.CreateWnd;
+procedure TTntRichEditURL.CreateWnd;
 var
   mask: Word;
 begin

Modified: trunk/Lobby/TASClient/MainUnit.dfm
===================================================================
--- trunk/Lobby/TASClient/MainUnit.dfm	2008-03-30 17:51:59 UTC (rev 5627)
+++ trunk/Lobby/TASClient/MainUnit.dfm	2008-03-30 19:53:26 UTC (rev 5628)
@@ -1,6 +1,6 @@
 object MainForm: TMainForm
-  Left = 260
-  Top = 386
+  Left = 413
+  Top = 133
   Width = 789
   Height = 548
   Caption = 'TASClient'
@@ -823,7 +823,7 @@
           Top = 8
           Width = 97
           Height = 25
-          Caption = 'Search UF'
+          Caption = 'Search files'
           DropDownMenu = SearchFormPopupMenu
           LinkFont.Charset = DEFAULT_CHARSET
           LinkFont.Color = clBlue
@@ -5859,8 +5859,8 @@
   end
   object BattleListPopupMenu: TSpTBXPopupMenu
     OnInitPopup = BattleListPopupMenuInitPopup
-    Left = 276
-    Top = 246
+    Left = 280
+    Top = 248
     object mnuBattleHost: TSpTBXSubmenuItem
       Caption = 'Host'
       LinkSubitems = PlayerSubMenu
@@ -5900,9 +5900,11 @@
     end
     object mnuBattleDlMap: TSpTBXItem
       Caption = 'Download map'
+      OnClick = mnuBattleDlMapClick
     end
     object mnuBattleDlMod: TSpTBXItem
       Caption = 'Download mod'
+      OnClick = mnuBattleDlModClick
     end
     object SpTBXSeparatorItem14: TSpTBXSeparatorItem
     end

Modified: trunk/Lobby/TASClient/MainUnit.pas
===================================================================
--- trunk/Lobby/TASClient/MainUnit.pas	2008-03-30 17:51:59 UTC (rev 5627)
+++ trunk/Lobby/TASClient/MainUnit.pas	2008-03-30 19:53:26 UTC (rev 5628)
@@ -204,7 +204,7 @@
   HttpProt, GraphicEx, Registry, JvComponent, JvBaseDlg, JvDesktopAlert,
   JvDesktopAlertForm, DateUtils, Winsock, TBXToolPals, SpTBXItem, TB2Item,
   TBX, SpTBXControls, TBXDkPanels, SpTBXFormPopupMenu,IniFiles,StrUtils,
-  TntStdCtrls, SpTBXEditors, Mask, JvExMask, JvSpin;
+  TntStdCtrls, SpTBXEditors, Mask, JvExMask, JvSpin,TntComCtrls;
 
 const
   CountryNames: array[0..240] of string = (
@@ -508,7 +508,7 @@
 
 const
   VERSION_NUMBER = '0.37'; // Must be float value! (with a period as a decimal seperator)
-  BETA_NUMBER = 260;
+  BETA_NUMBER = 261;
   CHECK_BETA_LOBBY_URL = '<A HREF="http://tasclient.no-ip.org/TASClient.txt">http://tasclient.no-ip.org/TASClient.txt</A>';
   PROGRAM_VERSION = 'TASClient ' + VERSION_NUMBER + ' beta';
   KEEP_ALIVE_INTERVAL = 10000; // in milliseconds. Tells us what should be the maximum &quot;silence&quot; time before we send a ping to the server.
@@ -519,8 +519,8 @@
   MAX_MSG_ID = 65535; // when sending commands to the server they may be assigned an unique ID, MAX_MSG_ID is the maximum value of this ID (note that you may assign IDs any way you want, random, consecutive, or even not at all). Currently this program assigns consecutive IDs, so once it reaches this value, the next will be 0, then 1 etc.
 
   LOG_FILENAME = 'log.txt';
-  MODS_PAGE_LINK = '<A HREF="http://www.unknown-files.net/spring/category/14/Mods/">http://www.unknown-files.net/spring/category/14/Mods/</A>';
-  MAPS_PAGE_LINK = '<A HREF="http://www.unknown-files.net/spring/category/13/Maps/">http://www.unknown-files.net/spring/category/13/Maps/</A>';
+  MODS_PAGE_LINK = '<A HREF="http://spring.jobjol.nl/files.php?subcategory_id=5">http://spring.jobjol.nl/files.php?subcategory_id=5</A>';
+  MAPS_PAGE_LINK = '<A HREF="http://spring.jobjol.nl/files.php?subcategory_id=2">http://spring.jobjol.nl/files.php?subcategory_id=2</A>';
   WIKI_PAGE_LINK = '<A HREF="http://taspring.clan-sy.com/wiki/Main_Page">http://taspring.clan-sy.com/wiki/Main_Page</A>';
   LADDER_PREFIX_URL = '<A HREF="http://blendax.informatik.uni-bremen.de/jan/spring/ladder/lobby/">http://blendax.informatik.uni-bremen.de/jan/spring/ladder/lobby/</A>'; //'<A HREF="http://springladder.no-ip.org/lobby/">http://springladder.no-ip.org/lobby/</A>';
   AWAY_TIME = 300000; // in milliseconds. After this period of time (of inactivity), client will set its state to &quot;away&quot;
@@ -1136,6 +1136,8 @@
     procedure VDTBattlesMouseDown(Sender: TObject; Button: TMouseButton;
       Shift: TShiftState; X, Y: Integer);
     procedure SpTBXItem3Click(Sender: TObject);
+    procedure mnuBattleDlMapClick(Sender: TObject);
+    procedure mnuBattleDlModClick(Sender: TObject);
 
   published
     MainTitleBar: TSpTBXTitleBar;
@@ -1247,7 +1249,7 @@
     procedure TryToSendDataDirectly(s: string); // deprecated - use TryToSendCommand method instead!
     procedure TryToLogin(Username, Password: string);
     procedure TryToRegister(Username, Password: string); // try to register new account
-    procedure TryToAutoCompleteClientName(Edit: TEdit; Clients: TList);
+    procedure TryToAutoCompleteClientName(Edit: TSpTBXEdit; Clients: TList);
 
     procedure SortClientsList(List: TList; SortStyle: Byte);
     procedure SortBattlesList(SortStyle: Byte; Ascending: Boolean);
@@ -1339,10 +1341,10 @@
     procedure TryToConnect; overload;
     procedure TryToConnect(ServerAddress, ServerPort: string); overload;
 
-    procedure AddMainLog(Text: string; Color: TColor); overload;
-    procedure AddMainLog(Text: string; Color: TColor; AmbiguousCommandID: Integer); overload;
-    procedure AddTextToChatWindow(Chat: TMyTabSheet; Text: string; Color: TColor); overload;
-    procedure AddTextToChatWindow(Chat: TMyTabSheet; Text: string; Color: TColor; ChatTextPos: Integer); overload;
+    procedure AddMainLog(Text: WideString; Color: TColor); overload;
+    procedure AddMainLog(Text: WideString; Color: TColor; AmbiguousCommandID: Integer); overload;
+    procedure AddTextToChatWindow(Chat: TMyTabSheet; Text: WideString; Color: TColor); overload;
+    procedure AddTextToChatWindow(Chat: TMyTabSheet; Text: WideString; Color: TColor; ChatTextPos: Integer); overload;
   end;
 
   TConnectionState = (Disconnected, Connecting, Connected);
@@ -1758,15 +1760,15 @@
   end;
 
   // TAB when input TEdit has focus:
-  if (Msg.CharCode = 9) and (Screen.ActiveControl.ClassType = TEdit) and (Screen.ActiveControl.Name = 'InputEdit') then
+  if (Msg.CharCode = 9) and (Screen.ActiveControl.ClassType = TSpTBXEdit) and (Screen.ActiveControl.Name = 'InputEdit') then
   begin
     Handled := True;
     if (PageControl1.ActivePage.Caption = LOCAL_TAB) or (Screen.ActiveForm.Name = 'BattleForm') then
-      TryToAutoCompleteClientName(TEdit(Screen.ActiveControl), AllClients)
+      TryToAutoCompleteClientName(TSpTBXEdit(Screen.ActiveControl), AllClients)
     else if PageControl1.ActivePage.Caption[1] = '#' then // a channel tab
-      TryToAutoCompleteClientName(TEdit(Screen.ActiveControl), (PageControl1.ActivePage as TMyTabSheet).Clients)
+      TryToAutoCompleteClientName(TSpTBXEdit(Screen.ActiveControl), (PageControl1.ActivePage as TMyTabSheet).Clients)
     else // a private chat tab
-      TryToAutoCompleteClientName(TEdit(Screen.ActiveControl), (PageControl1.ActivePage as TMyTabSheet).Clients);
+      TryToAutoCompleteClientName(TSpTBXEdit(Screen.ActiveControl), (PageControl1.ActivePage as TMyTabSheet).Clients);
 
     Exit;
   end;
@@ -3011,7 +3013,7 @@
 var
   p: TENLink;
   sURL: string;
-  CE : TRichEdit;
+  CE : TTntRichEdit;
 begin
   if (Msg.Msg = WM_NOTIFY) then
   begin
@@ -3021,7 +3023,7 @@
       if (p.Msg = WM_LBUTTONDOWN) then
       begin
         try
-          CE := TRichEdit(Self.Controls[1] as TRichEdit);
+          CE := TTntRichEdit(Self.Controls[1] as TTntRichEdit);
           SendMessage(CE.Handle, EM_EXSETSEL, 0, Longint(@(p.chrg)));
           sURL := CE.SelText;
           Misc.OpenURLInDefaultBrowser(sURL);
@@ -3300,9 +3302,9 @@
     ReplaysUnit.TReadReplaysThrd.Create(False); // start reading replays from disk
 
     // reenable auto URL detection for $local because it's doesn't work the first time
-    mask := SendMessage(((PageControl1.Pages[0] as TMyTabSheet).Controls[1] as TRichEdit).Handle, EM_GETEVENTMASK, 0, 0);
-    SendMessage(((PageControl1.Pages[0] as TMyTabSheet).Controls[1] as TRichEdit).Handle, EM_SETEVENTMASK, 0, mask or ENM_LINK);
-    SendMessage(((PageControl1.Pages[0] as TMyTabSheet).Controls[1] as TRichEdit).Handle, EM_AUTOURLDETECT, Integer(True), 0);
+    mask := SendMessage(((PageControl1.Pages[0] as TMyTabSheet).Controls[1] as TTntRichEdit).Handle, EM_GETEVENTMASK, 0, 0);
+    SendMessage(((PageControl1.Pages[0] as TMyTabSheet).Controls[1] as TTntRichEdit).Handle, EM_SETEVENTMASK, 0, mask or ENM_LINK);
+    SendMessage(((PageControl1.Pages[0] as TMyTabSheet).Controls[1] as TTntRichEdit).Handle, EM_AUTOURLDETECT, Integer(True), 0);
 
     ReplaysForm.LoadReplayFiltersFromFile;
     ReplaysForm.UpdateReplayFilters;
@@ -3376,12 +3378,12 @@
   and we (for example) don't want to highlight nicknames in &quot;&lt;xyz&gt;&quot; part of the line, but only after that part (keywords will
   get highlighted only in chat part of the text, not the header). If you don't specify ChatTextPos parameter, it is assumed
   that the entire line is the chat text. }
-procedure TMainForm.AddTextToChatWindow(Chat: TMyTabSheet; Text: string; Color: TColor; ChatTextPos: Integer);
+procedure TMainForm.AddTextToChatWindow(Chat: TMyTabSheet; Text: WideString; Color: TColor; ChatTextPos: Integer);
 var
-  re: TRichEdit;
-  s: string;
+  re: TTntRichEdit;
+  s: WideString;
 begin
-  re := Chat.Controls[1] as TRichEdit;
+  re := Chat.Controls[1] as TTntRichEdit;
   if Preferences.TimeStamps then
   begin
     s := '[' + TimeToStr(Now) + '] ';
@@ -3395,17 +3397,17 @@
     Chat.Highlighted := True;
 end;
 
-procedure TMainForm.AddTextToChatWindow(Chat: TMyTabSheet; Text: string; Color: TColor);
+procedure TMainForm.AddTextToChatWindow(Chat: TMyTabSheet; Text: WideString; Color: TColor);
 begin
   AddTextToChatWindow(Chat, Text, Color, 1);
 end;
 
-procedure TMainForm.AddMainLog(Text: string; Color: TColor);
+procedure TMainForm.AddMainLog(Text: WideString; Color: TColor);
 begin
   AddTextToChatWindow(PageControl1.Pages[0] as TMyTabSheet, Text, Color);
 end;
 
-procedure TMainForm.AddMainLog(Text: string; Color: TColor; AmbiguousCommandID: Integer);
+procedure TMainForm.AddMainLog(Text: WideString; Color: TColor; AmbiguousCommandID: Integer);
 begin
   AddMainLog(Text + ' [#' + IntToStr(AmbiguousCommandID) + ']', Color);
 end;
@@ -3414,8 +3416,8 @@
 function TMainForm.AddTabWindow(Caption: string; SetFocus: Boolean): Integer;
 var
   tmpts: TMyTabSheet;
-  tmpre: TRichEdit;
-  tmped: TEdit;
+  tmpre: TTntRichEdit;
+  tmped: TSpTBXEdit;
   mask: Word;
   FileName: string;
 begin
@@ -3425,7 +3427,7 @@
 
   tmpts.Caption := Caption;
 
-  tmped := TEdit.Create(tmpts);
+  tmped := TSpTBXEdit.Create(tmpts);
   tmped.Parent := tmpts;
   tmped.Name := 'InputEdit'; // don't change this name! (there are some references to it in the code)
   tmped.Text := '';
@@ -3437,7 +3439,7 @@
 
   tmpts.PageControl := PageControl1;
 
-  tmpre := TRichEdit.Create(tmpts);
+  tmpre := TTntRichEdit.Create(tmpts);
   tmpre.Parent := tmpts;
   tmpre.Font.Assign(CommonFont);
   tmpre.ScrollBars := ssVertical;
@@ -5040,7 +5042,7 @@
           begin
             for i:=0 to LadderList.Count -1 do
               if TLadder(LadderList[i]).id = Battle.GetLadderId then begin
-                LadderListThread := TLadderListThread.Create(False,i);
+                LadderListThread := TLadderListThread.Create(False,i,false);
                 BattleState.LadderIndex := i;
                 LMThread := TLadderMapThread.Create(False);
                 break;
@@ -5049,7 +5051,7 @@
               New(Ladder);
               Ladder^ := TLadder.Create(Battle.GetLadderId,'');
               LadderList.Add(Ladder^);
-              LadderListThread := TLadderListThread.Create(False,LadderList.IndexOf(Ladder^));
+              LadderListThread := TLadderListThread.Create(False,LadderList.IndexOf(Ladder^),false);
               BattleState.LadderIndex := LadderList.IndexOf(Ladder^);
               LMThread := TLadderMapThread.Create(False);
               BattleForm.RefreshLadderRanks;
@@ -6161,7 +6163,7 @@
 begin
   if Button = mbRight then
   begin
-   with TRichEdit(Sender) do
+   with TTntRichEdit(Sender) do
    begin
      Pt := Point(X, Y) ;
      ci := Perform(Messages.EM_CHARFROMPOS, 0, Integer(@Pt)) ;
@@ -6186,7 +6188,7 @@
        ModerationSubmenuItem.Visible := Status.Me.GetAccess; // only moderators may see moderation menu!
        MuteSubitemMenu.Visible := LeftStr(PageControl1.ActivePage.Caption,1) = '#';
        mnuUnmute.Visible := LeftStr(PageControl1.ActivePage.Caption,1) = '#';
-       ClientPopupMenu.Popup(TRichEdit(Sender).ClientToScreen(pt).X,TRichEdit(Sender).ClientToScreen(pt).Y);
+       ClientPopupMenu.Popup(TTntRichEdit(Sender).ClientToScreen(pt).X,TTntRichEdit(Sender).ClientToScreen(pt).Y);
        RichEditSelectedClient := nil;
      end;
    end;
@@ -6208,7 +6210,7 @@
 procedure TMainForm.InputEditKeyDown(Sender: TObject; var Key: Word;
   Shift: TShiftState);
 var
-  s: string;
+  s: WideString;
   sl: TStringList;
   tmp: string;
 begin
@@ -6221,11 +6223,11 @@
 
   if Key = 13 then
   begin
-    s := (Sender as TEdit).Text;
+    s := (Sender as TSpTBXEdit).Text;
     (Sender as TEdit).Text := '';
     if s = '' then Exit;
 
-    with ((Sender as TEdit).Parent as TMyTabSheet) do
+    with ((Sender as TSpTBXEdit).Parent as TMyTabSheet) do
     begin
       History.Add(s);
       HistoryIndex := History.Count;
@@ -6236,7 +6238,6 @@
       ProcessCommand(Copy(s, 2, Length(s)-1), False);
       Exit;
     end;
-
     if ((Sender as TEdit).Parent as TMyTabSheet).Caption[1] = '$' then
     begin
       sl := StringParser.ParseString(s, ' ');
@@ -6245,9 +6246,9 @@
       else
         TryToSendCommand(sl[0]);
     end
-    else if ((Sender as TEdit).Parent as TMyTabSheet).Caption[1] = '#' then
-      TryToSendCommand('SAY', Copy(((Sender as TEdit).Parent as TMyTabSheet).Caption, 2, Length(((Sender as TEdit).Parent as TMyTabSheet).Caption)) + ' ' + s)
-    else TryToSendCommand('SAYPRIVATE', ((Sender as TEdit).Parent as TMyTabSheet).Caption + ' ' + s);
+    else if ((Sender as TSpTBXEdit).Parent as TMyTabSheet).Caption[1] = '#' then
+      TryToSendCommand('SAY',Copy(((Sender as TSpTBXEdit).Parent as TMyTabSheet).Caption, 2, Length(((Sender as TSpTBXEdit).Parent as TMyTabSheet).Caption))+' '+s)
+    else TryToSendCommand('SAYPRIVATE', ((Sender as TSpTBXEdit).Parent as TMyTabSheet).Caption + ' ' + s);
   end
   else if Key = VK_UP then
   begin
@@ -6567,7 +6568,7 @@
 end;
 
 // &quot;Edit&quot; must be from TMyTabSheet container! (this method uses clients
-procedure TMainForm.TryToAutoCompleteClientName(Edit: TEdit; Clients: TList);
+procedure TMainForm.TryToAutoCompleteClientName(Edit: TSpTBXEdit; Clients: TList);
 var
   s: string;
   text: string;
@@ -7107,8 +7108,7 @@
     begin
       if MessageDlg('Can''t join: you don''t have the right mod! Do you want to download it now?', mtInformation, [mbYes, mbNo], 0) = mrYes then begin
         //Misc.ParseDelimited(s1,Battle.ModName,' ','.');
-        url := '<A HREF="http://www.unknown-files.net/spring/search/*">http://www.unknown-files.net/spring/search/*</A>'+StringReplace(Battle.ModName,' ','*',[rfReplaceAll]);
-        url := url + '/';
+        url := '<A HREF="http://spring.jobjol.nl/search_result.php?search=">http://spring.jobjol.nl/search_result.php?search=</A>'+Battle.ModName+'&amp;select=select_all';
         FixURL(url);
         Misc.OpenURLInDefaultBrowser(url);
       end;
@@ -7309,7 +7309,7 @@
 
 procedure TMainForm.Clearwindow1Click(Sender: TObject);
 begin
-  (PageControl1.ActivePage.Controls[1] as TRichEdit).Lines.Clear;
+  (PageControl1.ActivePage.Controls[1] as TTntRichEdit).Lines.Clear;
 end;
 
 procedure TMainForm.ReplaysButtonClick(Sender: TObject);
@@ -8213,7 +8213,7 @@
 
 procedure TMainForm.mnuUnknownFilesClick(Sender: TObject);
 begin
-  Misc.OpenURLInDefaultBrowser('<A HREF="http://www.unknown-files.net/spring/">http://www.unknown-files.net/spring/</A>');
+  Misc.OpenURLInDefaultBrowser('<A HREF="http://spring.jobjol.nl">http://spring.jobjol.nl</A>');
 end;
 
 procedure TMainForm.mnuBugTrackerClick(Sender: TObject);
@@ -8420,7 +8420,7 @@
 
 procedure TMainForm.Copy1Click(Sender: TObject);
 begin
-  (PageControl1.ActivePage.Controls[1] as TRichEdit).CopyToClipboard;
+  (PageControl1.ActivePage.Controls[1] as TTntRichEdit).CopyToClipboard;
 end;
 
 procedure TMainForm.mnuIgnoreClick(Sender: TObject);
@@ -8914,12 +8914,12 @@
 var
   i: Integer;
    p: TPoint;
-   re : TRichEdit;
+   re : TTntRichEdit;
 begin
   FixFormSizeConstraints(MainForm);
   for i:=0 to PageControl1.PageCount-1 do
   begin
-    re := PageControl1.Pages[i].Controls[1] as TRichEdit;
+    re := PageControl1.Pages[i].Controls[1] as TTntRichEdit;
     re.SelLength := 0;
     re.SelStart := 0;
     re.SelStart := Length(re.text);
@@ -9065,7 +9065,7 @@
   try
     HttpCli2.Get;
   except
-    if Pos('Warning: Ladder server unavailable.',((PageControl1.Pages[0] as TMyTabSheet).Controls[1] as TRichEdit).Lines.GetText) = 0 then
+    if Pos('Warning: Ladder server unavailable.',((PageControl1.Pages[0] as TMyTabSheet).Controls[1] as TTntRichEdit).Lines.Text) = 0 then
       MainForm.AddMainLog('Warning: Ladder server unavailable.', Colors.Normal);
     Exit;
   end;
@@ -9087,7 +9087,7 @@
     try
       Misc.ParseDelimited(parse2,MidStr(parse1[i],Pos(' ',parse1[i]),MaxInt),#9,'');
     except
-      if Pos('Warning: Error while parsing top players ladder page.',((PageControl1.Pages[0] as TMyTabSheet).Controls[1] as TRichEdit).Lines.GetText) = 0 then
+      if Pos('Warning: Error while parsing top players ladder page.',((PageControl1.Pages[0] as TMyTabSheet).Controls[1] as TTntRichEdit).Lines.Text) = 0 then
         MainForm.AddMainLog('Warning: Error while parsing top players ladder page.', Colors.Normal);
       parse1.Free;
       parse2.Free;
@@ -9096,7 +9096,7 @@
     end;
     if parse2.Count &lt;&gt; 2 then
     begin
-      if Pos('Warning: Error while parsing top players ladder page.',((PageControl1.Pages[0] as TMyTabSheet).Controls[1] as TRichEdit).Lines.GetText) = 0 then
+      if Pos('Warning: Error while parsing top players ladder page.',((PageControl1.Pages[0] as TMyTabSheet).Controls[1] as TTntRichEdit).Lines.Text) = 0 then
         MainForm.AddMainLog('Warning: Error while parsing top players ladder page.', Colors.Normal);
       parse1.Free;
       parse2.Free;
@@ -9106,7 +9106,7 @@
     Misc.ParseDelimited(parse3,TrimRight(TrimLeft(parse2[1])),' ','');
     if parse3.Count &lt;&gt; 3 then
     begin
-      if Pos('Warning: Error while parsing top players ladder page.',((PageControl1.Pages[0] as TMyTabSheet).Controls[1] as TRichEdit).Lines.GetText) = 0 then
+      if Pos('Warning: Error while parsing top players ladder page.',((PageControl1.Pages[0] as TMyTabSheet).Controls[1] as TTntRichEdit).Lines.Text) = 0 then
         MainForm.AddMainLog('Warning: Error while parsing top players ladder page.', Colors.Normal);
       parse1.Free;
       parse2.Free;
@@ -9167,8 +9167,11 @@
 end;
 
 procedure TMainForm.Button1Click(Sender: TObject);
+var
+  s: string;
+  s2 : WideString;
 begin
-  MessageDlg(((PageControl1.Pages[0] as TMyTabSheet).Controls[1] as TRichEdit).Lines.GetText,mtInformation,[mbOk],0);
+  AddMainLog('  ' + BattleForm.InputEdit.Text+'d',Colors.Normal);
 end;
 
 procedure TMainForm.BattleListPopupMenuInitPopup(Sender: TObject;
@@ -9413,4 +9416,25 @@
     Misc.OpenURLInDefaultBrowser('<A HREF="http://spring.clan-sy.com/websvn/log.php?repname=spring&amp;path=%2Ftrunk%2FLobby%2FTASClient%2F">http://spring.clan-sy.com/websvn/log.php?repname=spring&amp;path=%2Ftrunk%2FLobby%2FTASClient%2F</A>');
 end;
 
+procedure TMainForm.mnuBattleDlMapClick(Sender: TObject);
+var
+  url: string;
+begin
+  url := StringReplace(SelectedBattle.Map,'.smf','',[rfReplaceAll, rfIgnoreCase]);
+  {url := StringReplace(url,'_',' ',[rfReplaceAll, rfIgnoreCase]);
+  url := StringReplace(url,'-',' ',[rfReplaceAll, rfIgnoreCase]); }
+  url := '<A HREF="http://spring.jobjol.nl/search_result.php?search=">http://spring.jobjol.nl/search_result.php?search=</A>' + url+'&amp;select=select_all';
+  FixURL(url);
+  Misc.OpenURLInDefaultBrowser(url);
+end;
+
+procedure TMainForm.mnuBattleDlModClick(Sender: TObject);
+var
+  url: string;
+begin
+  url := '<A HREF="http://spring.jobjol.nl/search_result.php?search=">http://spring.jobjol.nl/search_result.php?search=</A>'+SelectedBattle.ModName+'&amp;select=select_all';
+  FixURL(url);
+  Misc.OpenURLInDefaultBrowser(url);
+end;
+
 end.

Modified: trunk/Lobby/TASClient/Misc.pas
===================================================================
--- trunk/Lobby/TASClient/Misc.pas	2008-03-30 17:51:59 UTC (rev 5627)
+++ trunk/Lobby/TASClient/Misc.pas	2008-03-30 19:53:26 UTC (rev 5628)
@@ -11,7 +11,7 @@
 
 uses
   SpTBXItem,JvSpin,Dialogs, Classes, ComCtrls, Windows, Graphics, MMSystem, Controls, Registry, SysUtils,
-  WSocket, Winsock, ESBDates, GpTimeZone, JvColorCombo, Forms,StdCtrls,HttpProt;
+  WSocket, Winsock, ESBDates, GpTimeZone, JvColorCombo, Forms,StdCtrls,HttpProt,TntComCtrls;
 
 type
   TVerticalAlign=(alVTop,alVCenter,alVBottom);
@@ -41,7 +41,7 @@
 function BoolToInt(b: Boolean): Integer;
 function IntToBool(i: Integer): Boolean;
 function HexToInt(HexStr: String): Integer;
-procedure AddTextToRichEdit(RichEdit: TRichEdit; Text: string; TextColor: TColor; Scroll: Boolean; ChatTextPos: Integer);
+procedure AddTextToRichEdit(RichEdit: TTntRichEdit; Text: WideString; TextColor: TColor; Scroll: Boolean; ChatTextPos: Integer);
 procedure PlayResSound(RESName: string);
 procedure EnableControlAndChildren(Control: TWinControl); // enable group of controls
 procedure DisableControlAndChildren(Control: TWinControl); // disable group of controls
@@ -323,7 +323,7 @@
   get highlighted only in chat part of the text, not the header). If you don't specify ChatTextPos parameter, it is assumed
   that the entire line is the chat text.
 }
-procedure AddTextToRichEdit(RichEdit: TRichEdit; Text: string; TextColor: TColor; Scroll: Boolean; ChatTextPos: Integer);
+procedure AddTextToRichEdit(RichEdit: TTntRichEdit; Text: WideString; TextColor: TColor; Scroll: Boolean; ChatTextPos: Integer);
 var
   SelStart, SelLength: Integer;
   p: TPoint;

Modified: trunk/Lobby/TASClient/PreferencesFormUnit.dfm
===================================================================
--- trunk/Lobby/TASClient/PreferencesFormUnit.dfm	2008-03-30 17:51:59 UTC (rev 5627)
+++ trunk/Lobby/TASClient/PreferencesFormUnit.dfm	2008-03-30 19:53:26 UTC (rev 5628)
@@ -33,11 +33,11 @@
     TBXStyleBackground = True
     object SpTBXTabControl1: TSpTBXTabControl
       Left = 8
-      Top = 40
+      Top = 32
       Width = 361
       Height = 305
       Color = clBtnFace
-      ActiveTabIndex = 2
+      ActiveTabIndex = 1
       TabAutofit = True
       HiddenItems = &lt;&gt;
       object SpTBXTabItem6: TSpTBXTabItem
@@ -46,11 +46,11 @@
       end
       object SpTBXTabItem5: TSpTBXTabItem
         Caption = 'Account'
+        Checked = True
         CustomWidth = 59
       end
       object SpTBXTabItem4: TSpTBXTabItem
         Caption = 'Program'
-        Checked = True
         CustomWidth = 59
       end
       object SpTBXTabItem3: TSpTBXTabItem
@@ -369,127 +369,6 @@
           end
         end
       end
-      object SpTBXTabSheet5: TSpTBXTabSheet
-        Left = 0
-        Top = 23
-        Width = 361
-        Height = 282
-        Caption = 'Account'
-        ImageIndex = -1
-        TabItem = 'SpTBXTabItem5'
-        object GroupBox2: TSpTBXGroupBox
-          Left = 16
-          Top = 8
-          Width = 329
-          Height = 257
-          Caption = 'Account details'
-          Color = clNone
-          ParentColor = False
-          TabOrder = 0
-          object RegisterAccountButton: TSpTBXSpeedButton
-            Left = 56
-            Top = 144
-            Width = 185
-            Height = 25
-            Caption = 'Create new account'
-            OnClick = RegisterAccountButtonClick
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
-          object Label4: TSpTBXLabel
-            Left = 24
-            Top = 40
-            Width = 51
-            Height = 13
-            Caption = 'Username:'
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
-          object Label5: TSpTBXLabel
-            Left = 24
-            Top = 72
-            Width = 49
-            Height = 13
-            Caption = 'Password:'
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
-          object UsernameEdit: TSpTBXEdit
-            Left = 120
-            Top = 40
-            Width = 121
-            Height = 21
-            TabOrder = 0
-            OnChange = UsernameEditChange
-          end
-          object PasswordEdit: TSpTBXEdit
-            Left = 120
-            Top = 72
-            Width = 121
-            Height = 21
-            TabOrder = 1
-            PasswordCharW = '*'
-          end
-          object LadderPasswordEdit: TSpTBXEdit
-            Left = 120
-            Top = 104
-            Width = 121
-            Height = 21
-            Enabled = False
-            TabOrder = 5
-            PasswordCharW = '*'
-          end
-          object SpTBXLabel1: TSpTBXLabel
-            Left = 24
-            Top = 104
-            Width = 87
-            Height = 13
-            Caption = 'Ladder password :'
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
-          object ChangeLadderPasswordButton: TSpTBXButton
-            Left = 248
-            Top = 104
-            Width = 41
-            Height = 21
-            Caption = 'Edit'
-            TabOrder = 7
-            OnClick = ChangeLadderPasswordButtonClick
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
-          object RegisterLadderAccountButton: TSpTBXButton
-            Left = 56
-            Top = 176
-            Width = 185
-            Height = 25
-            Caption = 'Create new ladder account'
-            TabOrder = 8
-            OnClick = RegisterLadderAccountButtonClick
-            LinkFont.Charset = DEFAULT_CHARSET
-            LinkFont.Color = clBlue
-            LinkFont.Height = -11
-            LinkFont.Name = 'MS Sans Serif'
-            LinkFont.Style = [fsUnderline]
-          end
-        end
-      end
       object SpTBXTabSheet6: TSpTBXTabSheet
         Left = 0
         Top = 23
@@ -792,6 +671,127 @@
           end
         end
       end
+      object SpTBXTabSheet5: TSpTBXTabSheet
+        Left = 0
+        Top = 23
+        Width = 361
+        Height = 282
+        Caption = 'Account'
+        ImageIndex = -1
+        TabItem = 'SpTBXTabItem5'
+        object GroupBox2: TSpTBXGroupBox
+          Left = 16
+          Top = 8
+          Width = 329
+          Height = 257
+          Caption = 'Account details'
+          Color = clNone
+          ParentColor = False
+          TabOrder = 0
+          object RegisterAccountButton: TSpTBXSpeedButton
+            Left = 56
+            Top = 144
+            Width = 185
+            Height = 25
+            Caption = 'Create new account'
+            OnClick = RegisterAccountButtonClick
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
+          end
+          object Label4: TSpTBXLabel
+            Left = 24
+            Top = 40
+            Width = 51
+            Height = 13
+            Caption = 'Username:'
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
+          end
+          object Label5: TSpTBXLabel
+            Left = 24
+            Top = 72
+            Width = 49
+            Height = 13
+            Caption = 'Password:'
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
+          end
+          object UsernameEdit: TSpTBXEdit
+            Left = 120
+            Top = 40
+            Width = 121
+            Height = 21
+            TabOrder = 0
+            OnChange = UsernameEditChange
+          end
+          object PasswordEdit: TSpTBXEdit
+            Left = 120
+            Top = 72
+            Width = 121
+            Height = 21
+            TabOrder = 1
+            PasswordCharW = '*'
+          end
+          object LadderPasswordEdit: TSpTBXEdit
+            Left = 120
+            Top = 104
+            Width = 121
+            Height = 21
+            Enabled = False
+            TabOrder = 5
+            PasswordCharW = '*'
+          end
+          object SpTBXLabel1: TSpTBXLabel
+            Left = 24
+            Top = 104
+            Width = 87
+            Height = 13
+            Caption = 'Ladder password :'
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
+          end
+          object ChangeLadderPasswordButton: TSpTBXButton
+            Left = 248
+            Top = 104
+            Width = 41
+            Height = 21
+            Caption = 'Edit'
+            TabOrder = 7
+            OnClick = ChangeLadderPasswordButtonClick
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
+          end
+          object RegisterLadderAccountButton: TSpTBXButton
+            Left = 56
+            Top = 176
+            Width = 185
+            Height = 25
+            Caption = 'Create new ladder account'
+            TabOrder = 8
+            OnClick = RegisterLadderAccountButtonClick
+            LinkFont.Charset = DEFAULT_CHARSET
+            LinkFont.Color = clBlue
+            LinkFont.Height = -11
+            LinkFont.Name = 'MS Sans Serif'
+            LinkFont.Style = [fsUnderline]
+          end
+        end
+      end
     end
     object ApplyAndCloseButton: TSpTBXButton
       Left = 16

Modified: trunk/Lobby/TASClient/SearchFormUnit.dfm
===================================================================
--- trunk/Lobby/TASClient/SearchFormUnit.dfm	2008-03-30 17:51:59 UTC (rev 5627)
+++ trunk/Lobby/TASClient/SearchFormUnit.dfm	2008-03-30 19:53:26 UTC (rev 5628)
@@ -84,8 +84,9 @@
     ItemHeight = 13
     ItemIndex = 0
     TabOrder = 5
-    Text = 'Title'
+    Text = 'All'
     Items.Strings = (
+      'All'
       'Title'
       'File Name'
       'Description')

Modified: trunk/Lobby/TASClient/SearchFormUnit.pas
===================================================================
--- trunk/Lobby/TASClient/SearchFormUnit.pas	2008-03-30 17:51:59 UTC (rev 5627)
+++ trunk/Lobby/TASClient/SearchFormUnit.pas	2008-03-30 19:53:26 UTC (rev 5628)
@@ -42,10 +42,12 @@
 var
   url: string;
 begin
+  url := '<A HREF="http://spring.jobjol.nl/search_result.php?search=">http://spring.jobjol.nl/search_result.php?search=</A>' + KeywordEdit.Text;
   case CategorySearchBox.ItemIndex of
-    0: url := '<A HREF="http://www.unknown-files.net/spring/search/">http://www.unknown-files.net/spring/search/</A>' + KeywordEdit.Text + '/title/'; // title
-    1: url := '<A HREF="http://www.unknown-files.net/spring/search/">http://www.unknown-files.net/spring/search/</A>' + KeywordEdit.Text + '/filename/'; // file name
-    2: url := '<A HREF="http://www.unknown-files.net/spring/search/">http://www.unknown-files.net/spring/search/</A>' + KeywordEdit.Text + '/description/'; // description
+    0: url := url + '&amp;select=select_all'; // all
+    1: url := url + '&amp;select=select_file_subject'; // title
+    2: url := url + '&amp;select=select_file_name'; // file name
+    3: url := url + '&amp;select=select_file_description'; // description
   end; // case
   FixURL(url);
   Misc.OpenURLInDefaultBrowser(url);

Modified: trunk/Lobby/TASClient/TASClient.dof
===================================================================
--- trunk/Lobby/TASClient/TASClient.dof	2008-03-30 17:51:59 UTC (rev 5627)
+++ trunk/Lobby/TASClient/TASClient.dof	2008-03-30 19:53:26 UTC (rev 5628)
@@ -115,7 +115,7 @@
 MajorVer=0
 MinorVer=3
 Release=0
-Build=260
+Build=261
 Debug=0
 PreRelease=0
 Special=0
@@ -126,7 +126,7 @@
 [Version Info Keys]
 CompanyName=
 FileDescription=TA Spring lobby client
-FileVersion=0.3.0.260
+FileVersion=0.3.0.261
 InternalName=
 LegalCopyright=
 LegalTrademarks=

Modified: trunk/Lobby/TASClient/TASClient.res
===================================================================
(Binary files differ)


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000408.html">[Taspring-linux-commit] r5627 - trunk/rts/Sim/Projectiles
</A></li>
	<LI>Next message: <A HREF="000410.html">[Taspring-linux-commit] r5629 - trunk/rts/Game
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#409">[ date ]</a>
              <a href="thread.html#409">[ thread ]</a>
              <a href="subject.html#409">[ subject ]</a>
              <a href="author.html#409">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
