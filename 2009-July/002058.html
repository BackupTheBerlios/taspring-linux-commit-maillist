<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r7288 - Lobby/TASClient
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2009-July/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r7288%20-%20Lobby/TASClient&In-Reply-To=%3C20090710225607.8A6643B6F0%40it-l.eu%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002057.html">
   <LINK REL="Next"  HREF="002059.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r7288 - Lobby/TASClient</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r7288%20-%20Lobby/TASClient&In-Reply-To=%3C20090710225607.8A6643B6F0%40it-l.eu%3E"
       TITLE="[Taspring-linux-commit] r7288 - Lobby/TASClient">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Sat Jul 11 00:56:07 CEST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="002057.html">[Taspring-linux-commit] r7287 - Lobby/TASClient
</A></li>
        <LI>Next message: <A HREF="002059.html">[Taspring-linux-commit] r7289 - Lobby/TASClient
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2058">[ date ]</a>
              <a href="thread.html#2058">[ thread ]</a>
              <a href="subject.html#2058">[ subject ]</a>
              <a href="author.html#2058">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: satirik
Date: 2009-07-11 00:56:05 +0200 (Sat, 11 Jul 2009)
New Revision: 7288

Modified:
   Lobby/TASClient/BattleFormUnit.dfm
   Lobby/TASClient/BattleFormUnit.pas
   Lobby/TASClient/HostBattleFormUnit.dfm
   Lobby/TASClient/HostBattleFormUnit.pas
   Lobby/TASClient/HostInfoUnit.dfm
   Lobby/TASClient/HostInfoUnit.pas
   Lobby/TASClient/MainUnit.dfm
   Lobby/TASClient/MainUnit.pas
   Lobby/TASClient/MapListFormUnit.pas
   Lobby/TASClient/MenuFormUnit.pas
   Lobby/TASClient/PreferencesFormUnit.dfm
   Lobby/TASClient/PreferencesFormUnit.pas
   Lobby/TASClient/ReplaysUnit.pas
   Lobby/TASClient/TASClient.dof
   Lobby/TASClient/TASClient.res
   Lobby/TASClient/Utility.pas
Log:
* doesn't switch tab and focus when joining autojoin channels (faster logging in)
* relay host added, you can now host behind a rooter without redirecting the ports
* no more map hash in hexa
* script.txt map hash is unsigned int now
* joining script only contains the needed var

Modified: Lobby/TASClient/BattleFormUnit.dfm
===================================================================
--- Lobby/TASClient/BattleFormUnit.dfm	2009-07-07 21:26:06 UTC (rev 7287)
+++ Lobby/TASClient/BattleFormUnit.dfm	2009-07-10 22:56:05 UTC (rev 7288)
@@ -1,8 +1,8 @@
 object BattleForm: TBattleForm
-  Left = 650
-  Top = 108
-  Width = 945
-  Height = 589
+  Left = 319
+  Top = 17
+  Width = 858
+  Height = 640
   Caption = 'Battle window'
   Color = clBtnFace
   Constraints.MaxHeight = 750
@@ -24,13 +24,13 @@
   object SpTBXTitleBar1: TSpTBXTitleBar
     Left = 0
     Top = 0
-    Width = 937
-    Height = 562
+    Width = 850
+    Height = 613
     Caption = 'Battle window'
     object Panel3: TSpTBXPanel
       Left = 4
-      Top = 517
-      Width = 929
+      Top = 568
+      Width = 842
       Height = 41
       Align = alBottom
       Color = clNone
@@ -39,7 +39,7 @@
       BorderType = pbrRaised
       TBXStyleBackground = True
       DesignSize = (
-        929
+        842
         41)
       object StartButton: TSpTBXButton
         Left = 120
@@ -133,7 +133,7 @@
         LinkFont.Style = [fsUnderline]
       end
       object LadderRulesButton: TSpTBXButton
-        Left = 827
+        Left = 740
         Top = 8
         Width = 97
         Height = 25
@@ -165,7 +165,7 @@
         ThemeType = thtTBX
       end
       object SSProfileButton: TSpTBXButton
-        Left = 723
+        Left = 636
         Top = 8
         Width = 97
         Height = 25
@@ -186,8 +186,8 @@
     object Panel2: TPanel
       Left = 4
       Top = 426
-      Width = 929
-      Height = 91
+      Width = 842
+      Height = 142
       Align = alClient
       TabOrder = 2
       object NoMapImage: TImage
@@ -4075,12 +4075,12 @@
     object Panel1: TPanel
       Left = 4
       Top = 30
-      Width = 929
+      Width = 842
       Height = 275
       Align = alTop
       TabOrder = 3
       object Panel5: TPanel
-        Left = 509
+        Left = 422
         Top = 1
         Width = 419
         Height = 273
@@ -4094,7 +4094,7 @@
           Height = 273
           Align = alClient
           Color = clBtnFace
-          ActiveTabIndex = 1
+          ActiveTabIndex = 0
           ThemeType = tttNone
           OnActiveTabChange = SpTBXTabControl1ActiveTabChange
           HiddenItems = &lt;
@@ -4105,6 +4105,7 @@
               Height = 35
             end&gt;
           object QuickLookTab: TSpTBXTabItem
+            Checked = True
             ImageIndex = 1
             Images = MainForm.ArrowList
             CustomWidth = 40
@@ -4113,7 +4114,6 @@
           object GameOptionsTab: TSpTBXTabItem
             Caption = 'Game options'
             Wrapping = twWrap
-            Checked = True
             CustomWidth = 80
             CustomHeight = 35
             ThemeType = tttNone
@@ -4136,88 +4136,6 @@
             CustomWidth = 94
             ThemeType = tttNone
           end
-          object MapTabSheet: TSpTBXTabSheet
-            Left = 0
-            Top = 39
-            Width = 419
-            Height = 234
-            Caption = 'Map options'
-            ImageIndex = -1
-            Item = MapTab
-            TabControl = SpTBXTabControl1
-            DesignSize = (
-              419
-              234)
-            TabItem = 'MapTab'
-            object MapOptionsScrollBox: TTntScrollBox
-              Left = 8
-              Top = 48
-              Width = 402
-              Height = 184
-              VertScrollBar.Smooth = True
-              VertScrollBar.Tracking = True
-              Anchors = [akLeft, akTop, akRight, akBottom]
-              BiDiMode = bdLeftToRight
-              BorderStyle = bsNone
-              Color = clBtnFace
-              Ctl3D = False
-              ParentBiDiMode = False
-              ParentBackground = True
-              ParentColor = False
-              ParentCtl3D = False
-              TabOrder = 0
-            end
-            object panelMapOptionsDefault: TSpTBXPanel
-              Left = 8
-              Top = 4
-              Width = 402
-              Height = 41
-              Align = alCustom
-              TabOrder = 1
-              object btLoadDefaultMPO: TSpTBXButton
-                Left = 149
-                Top = 8
-                Width = 113
-                Height = 25
-                Caption = 'Load default'
-                TabOrder = 0
-                OnClick = btLoadDefaultMPOClick
-                LinkFont.Charset = DEFAULT_CHARSET
-                LinkFont.Color = clBlue
-                LinkFont.Height = -11
-                LinkFont.Name = 'MS Sans Serif'
-                LinkFont.Style = [fsUnderline]
-              end
-              object btSetAsDefaultMPO: TSpTBXButton
-                Left = 269
-                Top = 8
-                Width = 113
-                Height = 25
-                Caption = 'Set as default'
-                TabOrder = 1
-                OnClick = btSetAsDefaultMPOClick
-                LinkFont.Charset = DEFAULT_CHARSET
-                LinkFont.Color = clBlue
-                LinkFont.Height = -11
-                LinkFont.Name = 'MS Sans Serif'
-                LinkFont.Style = [fsUnderline]
-              end
-              object btLoadMapsDefaultMPO: TSpTBXButton
-                Left = 29
-                Top = 8
-                Width = 113
-                Height = 25
-                Caption = 'Load map'#39's default'
-                TabOrder = 2
-                OnClick = btLoadMapsDefaultMPOClick
-                LinkFont.Charset = DEFAULT_CHARSET
-                LinkFont.Color = clBlue
-                LinkFont.Height = -11
-                LinkFont.Name = 'MS Sans Serif'
-                LinkFont.Style = [fsUnderline]
-              end
-            end
-          end
           object SpTBXTabSheet1: TSpTBXTabSheet
             Left = 0
             Top = 39
@@ -4371,31 +4289,6 @@
               end
             end
           end
-          object SpTBXTabSheet6: TSpTBXTabSheet
-            Left = 0
-            Top = 39
-            Width = 419
-            Height = 234
-            ImageIndex = 1
-            Item = QuickLookTab
-            TabControl = SpTBXTabControl1
-            TabItem = 'QuickLookTab'
-            object QuickLookRichEdit: TRichEdit
-              Left = 2
-              Top = 0
-              Width = 415
-              Height = 232
-              Align = alClient
-              BorderStyle = bsNone
-              Color = clBtnFace
-              ParentShowHint = False
-              ReadOnly = True
-              ScrollBars = ssVertical
-              ShowHint = True
-              TabOrder = 0
-              OnMouseMove = QuickLookRichEditMouseMove
-            end
-          end
           object SpTBXTabSheet2: TSpTBXTabSheet
             Left = 0
             Top = 39
@@ -4632,12 +4525,119 @@
               LinkFont.Style = [fsUnderline]
             end
           end
+          object MapTabSheet: TSpTBXTabSheet
+            Left = 0
+            Top = 39
+            Width = 419
+            Height = 234
+            Caption = 'Map options'
+            ImageIndex = -1
+            Item = MapTab
+            TabControl = SpTBXTabControl1
+            DesignSize = (
+              419
+              234)
+            TabItem = 'MapTab'
+            object MapOptionsScrollBox: TTntScrollBox
+              Left = 8
+              Top = 48
+              Width = 402
+              Height = 184
+              VertScrollBar.Smooth = True
+              VertScrollBar.Tracking = True
+              Anchors = [akLeft, akTop, akRight, akBottom]
+              BiDiMode = bdLeftToRight
+              BorderStyle = bsNone
+              Color = clBtnFace
+              Ctl3D = False
+              ParentBiDiMode = False
+              ParentBackground = True
+              ParentColor = False
+              ParentCtl3D = False
+              TabOrder = 0
+            end
+            object panelMapOptionsDefault: TSpTBXPanel
+              Left = 8
+              Top = 4
+              Width = 402
+              Height = 41
+              Align = alCustom
+              TabOrder = 1
+              object btLoadDefaultMPO: TSpTBXButton
+                Left = 149
+                Top = 8
+                Width = 113
+                Height = 25
+                Caption = 'Load default'
+                TabOrder = 0
+                OnClick = btLoadDefaultMPOClick
+                LinkFont.Charset = DEFAULT_CHARSET
+                LinkFont.Color = clBlue
+                LinkFont.Height = -11
+                LinkFont.Name = 'MS Sans Serif'
+                LinkFont.Style = [fsUnderline]
+              end
+              object btSetAsDefaultMPO: TSpTBXButton
+                Left = 269
+                Top = 8
+                Width = 113
+                Height = 25
+                Caption = 'Set as default'
+                TabOrder = 1
+                OnClick = btSetAsDefaultMPOClick
+                LinkFont.Charset = DEFAULT_CHARSET
+                LinkFont.Color = clBlue
+                LinkFont.Height = -11
+                LinkFont.Name = 'MS Sans Serif'
+                LinkFont.Style = [fsUnderline]
+              end
+              object btLoadMapsDefaultMPO: TSpTBXButton
+                Left = 29
+                Top = 8
+                Width = 113
+                Height = 25
+                Caption = 'Load map'#39's default'
+                TabOrder = 2
+                OnClick = btLoadMapsDefaultMPOClick
+                LinkFont.Charset = DEFAULT_CHARSET
+                LinkFont.Color = clBlue
+                LinkFont.Height = -11
+                LinkFont.Name = 'MS Sans Serif'
+                LinkFont.Style = [fsUnderline]
+              end
+            end
+          end
+          object SpTBXTabSheet6: TSpTBXTabSheet
+            Left = 0
+            Top = 39
+            Width = 419
+            Height = 234
+            ImageIndex = 1
+            Item = QuickLookTab
+            TabControl = SpTBXTabControl1
+            TabItem = 'QuickLookTab'
+            object QuickLookRichEdit: TRichEdit
+              Left = 2
+              Top = 0
+              Width = 415
+              Height = 232
+              Align = alClient
+              BorderStyle = bsNone
+              Color = clBtnFace
+              ParentShowHint = False
+              ReadOnly = True
+              ScrollBars = ssVertical
+              ShowHint = True
+              TabOrder = 0
+              OnMouseMove = QuickLookRichEditMouseMove
+            end
+          end
         end
       end
       object Panel6: TPanel
         Left = 1
         Top = 1
-        Width = 508
+        Width = 421
         Height = 273
         Align = alClient
         BevelOuter = bvNone
@@ -4646,7 +4646,7 @@
         object MapPanel: TSpTBXPanel
           Left = 0
           Top = 0
-          Width = 508
+          Width = 421
           Height = 273
           Align = alClient
           Color = clNone
@@ -4655,7 +4655,7 @@
           OnMouseMove = MapPanelMouseMove
           TBXStyleBackground = True
           object MapOptionsPanel: TSpTBXPanel
-            Left = 352
+            Left = 265
             Top = 2
             Width = 154
             Height = 222
@@ -4861,7 +4861,7 @@
           object SpTBXPanel3: TSpTBXPanel
             Left = 2
             Top = 224
-            Width = 504
+            Width = 417
             Height = 47
             Caption = 'MapDescPanel'
             Align = alBottom
@@ -4869,7 +4869,7 @@
             object MapDescLabel: TSpTBXLabel
               Left = 2
               Top = 2
-              Width = 500
+              Width = 413
               Height = 43
               Caption = 'MapDescLabel'
               Align = alClient
@@ -4888,7 +4888,7 @@
           object MapsTabs: TSpTBXTabControl
             Left = 2
             Top = 2
-            Width = 350
+            Width = 263
             Height = 222
             Align = alClient
             Color = clBtnFace
@@ -4897,8 +4897,8 @@
             HiddenItems = &lt;
               item
                 Name = 'RessourcesMapTab'
-                Left = 62
-                Width = 69
+                Left = 52
+                Width = 89
                 Height = 19
               end&gt;
             object MinimapTab: TSpTBXTabItem
@@ -4914,7 +4914,7 @@
             object SpTBXTabSheet5: TSpTBXTabSheet
               Left = 0
               Top = 23
-              Width = 350
+              Width = 263
               Height = 199
               Caption = 'HeightMap'
               ImageIndex = -1
@@ -4924,7 +4924,7 @@
               object HeightMapPanel: TSpTBXPanel
                 Left = 2
                 Top = 0
-                Width = 346
+                Width = 259
                 Height = 197
                 Caption = 'HeightMapPanel'
                 Align = alClient
@@ -8701,7 +8701,7 @@
             object SpTBXTabSheet4: TSpTBXTabSheet
               Left = 0
               Top = 23
-              Width = 350
+              Width = 263
               Height = 199
               Caption = 'RessourcesMap'
               ImageIndex = -1
@@ -8711,7 +8711,7 @@
               object MetalMapPanel: TSpTBXPanel
                 Left = 2
                 Top = 0
-                Width = 346
+                Width = 259
                 Height = 197
                 Caption = 'MetalMapPanel'
                 Align = alClient
@@ -12488,7 +12488,7 @@
             object SpTBXTabSheet3: TSpTBXTabSheet
               Left = 0
               Top = 23
-              Width = 350
+              Width = 263
               Height = 199
               Caption = 'Minimap'
               ImageIndex = -1
@@ -12498,7 +12498,7 @@
               object MinimapPanel: TSpTBXPanel
                 Left = 2
                 Top = 0
-                Width = 346
+                Width = 259
                 Height = 197
                 Align = alClient
                 TabOrder = 0
@@ -12506,12 +12506,12 @@
                 Borders = False
                 TBXStyleBackground = True
                 DesignSize = (
-                  346
+                  259
                   197)
                 object MapImage: TImageEx
                   Left = 0
                   Top = 0
-                  Width = 214
+                  Width = 127
                   Height = 80
                   Cursor = crHandPoint
                   Hint = 'No map'
@@ -12533,7 +12533,7 @@
     object Panel4: TSpTBXPanel
       Left = 4
       Top = 311
-      Width = 929
+      Width = 842
       Height = 109
       Caption = 'Panel4'
       Align = alTop
@@ -12541,12 +12541,12 @@
       BorderType = pbrRaised
       TBXStyleBackground = True
       DesignSize = (
-        929
+        842
         109)
       object VDTBattleClients: TVirtualDrawTree
         Left = 8
         Top = 8
-        Width = 619
+        Width = 532
         Height = 94
         Anchors = [akLeft, akTop, akRight, akBottom]
         DragImageKind = diMainColumnOnly
@@ -12617,7 +12617,7 @@
           end
           item
             Position = 6
-            Width = 150
+            Width = 63
             WideText = 'Player Bonus'
           end
           item
@@ -12639,7 +12639,7 @@
           end&gt;
       end
       object lblTeamNbr: TSpTBXLabel
-        Left = 632
+        Left = 545
         Top = 8
         Width = 44
         Height = 13
@@ -12656,7 +12656,7 @@
         LinkFont.Style = [fsUnderline]
       end
       object MyOptionsGroupBox: TSpTBXGroupBox
-        Left = 679
+        Left = 592
         Top = 5
         Width = 242
         Height = 92
@@ -12778,7 +12778,7 @@
     object Splitter2: TSpTBXSplitter
       Left = 4
       Top = 305
-      Width = 929
+      Width = 842
       Height = 6
       Cursor = crSizeNS
       Caption = 'Splitter1'
@@ -12787,7 +12787,7 @@
     object SpTBXSplitter2: TSpTBXSplitter
       Left = 4
       Top = 420
-      Width = 929
+      Width = 842
       Height = 6
       Cursor = crSizeNS
       Caption = 'SpTBXSplitter2'
@@ -12835,11 +12835,15 @@
     object ForceTeamSpin: TTBXSpinEditItem
       Caption = 'Set id'
       EditCaption = 'Set id'
+      EditWidth = 4
+      MaxLength = 3
       OnValueChange = ForceTeamSpinValueChange
     end
     object ForceAllySpin: TTBXSpinEditItem
       Caption = 'Set team'
       EditCaption = 'Set team'
+      EditWidth = 4
+      MaxLength = 3
       OnValueChange = ForceAllySpinValueChange
     end
     object SetTeamColorItem: TSpTBXSubmenuItem
@@ -12864,9 +12868,11 @@
       AutoCheck = True
       Caption = 'Bonus'
       EditCaption = 'Bonus'
-      OnChange = HandicapSpinEditItemChange
+      EditWidth = 48
+      MaxLength = 3
       Increment = 10.000000000000000000
       MaxValue = 100.000000000000000000
+      OnValueChange = HandicapSpinEditItemValueChange
     end
     object KickPlayerItem: TSpTBXItem
       Caption = 'Kick player (bot)'

Modified: Lobby/TASClient/BattleFormUnit.pas
===================================================================
--- Lobby/TASClient/BattleFormUnit.pas	2009-07-07 21:26:06 UTC (rev 7287)
+++ Lobby/TASClient/BattleFormUnit.pas	2009-07-10 22:56:05 UTC (rev 7288)
@@ -340,8 +340,9 @@
     procedure SendReplayScriptToServer;
     procedure SendBattleDetailsToServer;
     procedure SendBattleInfoToServer;
-    function GenerateNormalScriptFile(FileName: string):Boolean;
-    function GenerateReplayScriptFile(FileName: string):Boolean;
+    function GenerateJoinScriptFile(FileName: string):TScript;
+    function GenerateNormalHostScriptFile(FileName: string;relayHostScript: boolean=false):TScript;
+    function GenerateReplayHostScriptFile(FileName: string):TScript;
     procedure PunchThroughNAT; // only used when hosting using &quot;hole punching&quot; technique. See comments at method's implementation for more info.
 
     function ChooseColorDialog(UnderControl: TControl; DefaultColorIndex: Integer): Integer;
@@ -450,7 +451,6 @@
     procedure ForceTeamColorPaletteCellClick(Sender: TTBXCustomToolPalette;
       var ACol, ARow: Integer; var AllowChange: Boolean);
     procedure SetTeamColorItemClick(Sender: TObject);
-    procedure HandicapSpinEditItemChange(Sender: TObject; const Text: String);
     procedure MySideButtonClick(Sender: TObject);
     procedure ReadyButtonClick(Sender: TObject);
     procedure SpTBXItem4Click(Sender: TObject);
@@ -554,6 +554,8 @@
     procedure VDTBattleClientsDragAllowed(Sender: TBaseVirtualTree;
       Node: PVirtualNode; Column: TColumnIndex; var Allowed: Boolean);
     procedure Button1Click(Sender: TObject);
+    procedure HandicapSpinEditItemValueChange(
+      Sender: TTBXCustomSpinEditItem; const AValue: Extended);
   private
     History: TWideStringList;
     HistoryIndex: Integer;
@@ -956,7 +958,7 @@
 begin
   if not (BattleState.Status = Hosting) then Exit; // this should not happen though
 
-  MainForm.TryToSendCommand('UPDATEBATTLEINFO', IntToStr(BattleState.Battle.SpectatorCount) + ' ' + IntToStr(BoolToInt(LockedCheckBox.Checked)) + ' ' + IntToStr(Misc.HexToInt(Utility.MapChecksums[CurrentMapIndex])) + ' ' + Utility.MapList[CurrentMapIndex]);
+  MainForm.TryToSendCommand('UPDATEBATTLEINFO', IntToStr(BattleState.Battle.SpectatorCount) + ' ' + IntToStr(BoolToInt(LockedCheckBox.Checked)) + ' ' + IntToStr(Utility.MapChecksums.Items[CurrentMapIndex]) + ' ' + Utility.MapList[CurrentMapIndex]);
 end;
 
 
@@ -1199,7 +1201,7 @@
       mapSynced := True;
       modSynced := True;
 
-      if not (CurrentMapIndex = -1) and not (Utility.MapChecksums[CurrentMapIndex] = IntToHex(BattleState.Battle.MapHash,8)) then
+      if not (CurrentMapIndex = -1) and not (Utility.MapChecksums.Items[CurrentMapIndex] = BattleState.Battle.MapHash) then
       begin
         mapSynced := False;
         if BattleState.Status &lt;&gt; None then
@@ -1447,7 +1449,7 @@
   i,j: Integer;
   v,springexe: string;
   script:string;
-  scriptGenerationResult: boolean;
+  scriptGenerationResult: TScript;
   r: string;
   params: string;
 begin
@@ -1466,6 +1468,7 @@
   end;
 
   if (BattleState.Status = Hosting) then
+  begin
     case BattleState.Battle.NATType of
     0: ;
     1: PunchThroughNAT;
@@ -1477,16 +1480,22 @@
          MainForm.AddMainLog(_('Error while sending UDP packet to ') + TClient(BattleState.Battle.Clients[i]).Name + ' (IP=' + TClient(BattleState.Battle.Clients[i]).IP + ')', Colors.Error);
        end;
     end;
+  end;
 
   BattleForm.AmIReady := False; // status is automatically updated in this property's &quot;setter&quot;
 
 //***  DeleteFile(ExtractFilePath(Application.ExeName) + 'script.txt'); // no problem if file does not exist (function will return FALSE in that case)
 
-  if BattleState.Battle.BattleType = 0 then
-    scriptGenerationResult := GenerateNormalScriptFile(ExtractFilePath(Application.ExeName) + 'script.txt')
-  else scriptGenerationResult := GenerateReplayScriptFile(ExtractFilePath(Application.ExeName) + 'script.txt');
-
-  if not scriptGenerationResult then
+  if (BattleState.Status = Hosting) and (HostBattleForm.relayHoster = nil) then
+  begin
+    if BattleState.Battle.BattleType = 0 then
+      scriptGenerationResult := GenerateNormalHostScriptFile(ExtractFilePath(Application.ExeName) + 'script.txt')
+    else
+      scriptGenerationResult := GenerateReplayHostScriptFile(ExtractFilePath(Application.ExeName) + 'script.txt');
+  end
+  else
+    scriptGenerationResult := GenerateJoinScriptFile(ExtractFilePath(Application.ExeName) + 'script.txt');
+  if scriptGenerationResult = nil then
     Exit;
 
   FillChar(BattleState.Process.proc_info, sizeof(TProcessInformation), 0);
@@ -1779,7 +1788,6 @@
   if Battle = nil then Exit;
 
   BattleState.Battle := Battle;
-  BattleState.BanList := TStringList.Create;
 
   BattleState.DisabledUnits.Clear;
   PopulateDisabledUnitsVDT;
@@ -1852,7 +1860,7 @@
   // load map options
   if CurrentMapIndex &gt; -1 then
   begin
-    if (Utility.ModValidMaps.Count &gt; 0) and (Utility.ModValidMaps.IndexOf(TMapItem(Utility.MapList[CurrentMapIndex]).MapName) = -1) then
+    if (Utility.ModValidMaps&lt;&gt;nil) and (Utility.ModValidMaps.Count &gt; 0) and (Utility.ModValidMaps.IndexOf(TMapItem(Utility.MapList[CurrentMapIndex]).MapName) = -1) then
       ChangeMap(Utility.MapList.IndexOf(MapSelectionForm.MapListBox.Items[0]));
 
     LoadLuaOptions(False,TMapItem(MapListForm.Maps[CurrentMapIndex]).MapName);
@@ -1894,7 +1902,6 @@
   if Battle = nil then Exit;
 
   BattleState.Battle := Battle;
-  BattleState.BanList := TStringList.Create;
 
   BattleState.DisabledUnits.Clear;
   PopulateDisabledUnitsVDT;
@@ -1991,6 +1998,7 @@
   begin
     AddTextToChat(_('Battle closed'), Colors.Info, 1);
     if not Preferences.DisableAllSounds then PlayResSound('battle');
+    HostBattleForm.relayHoster := nil;
   end;
 
   PopulatePopupMenuMapList;
@@ -2002,6 +2010,8 @@
 
   MapSelectionForm.MapListBox.Enabled := True;
 
+  BattleState.BanList.Clear;
+
   StartPosRadioGroup.Enabled := False;
   GameEndRadioGroup.Enabled := False;
   DisableControlAndChildren(ResourcesGroupBox);
@@ -2217,18 +2227,53 @@
 
   Result := True;
 
-end;     
+end;
 
-function TBattleForm.GenerateNormalScriptFile(FileName: string):Boolean;
+function TBattleForm.GenerateJoinScriptFile(FileName: string):TScript;
 var
   f: TextFile;
+  Script: TScript;
+  tryToRewriteScript: Boolean;
+begin
+  Script := TScript.Create('');
+  Script.AddOrChangeKeyValue('GAME/IsHost','0');
+  Script.AddOrChangeKeyValue('GAME/HostIP',BattleState.Battle.IP);
+  Script.AddOrChangeKeyValue('GAME/HostPort',IntToStr(BattleState.Battle.Port));
+  Script.AddOrChangeKeyValue('GAME/MyPlayerName',Status.Me.Name);
+
+// write down the script
+  repeat
+  try
+    AssignFile(f, FileName);
+    Rewrite(f);
+    Write(f, Script.Script);
+    CloseFile(f);
+    tryToRewriteScript := False;
+    Result := Script;
+  except
+    Result := nil;
+    Script.Free;
+    try
+      CloseFile(f);
+    except
+      //
+    end;
+    tryToRewriteScript := MessageDlg(CANT_WRITE_SCRIPT_MSG,mtError,[mbYes,mbNo],0) = mrYes;
+  end;
+  until not tryToRewriteScript;
+end;
+
+function TBattleForm.GenerateNormalHostScriptFile(FileName: string; relayHostScript: boolean=false):TScript;
+var
+  f: TextFile;
   NumberOfTeams: Integer;
   i, j: Integer;
   ModFileName: string;
   MyPlayerNum: Integer;
   Script: TScript;
   tryToRewriteScript: Boolean;
-
+  mapHash: Cardinal;
+  modHash: Cardinal;
   // &quot;purging&quot; is needed for one reason: there mustn't be any gaps between team/ally numbers
 
 begin
@@ -2245,12 +2290,16 @@
   ModFileName := ModArchiveList[i];
 
   // get my player number:
-  MyPlayerNum := BattleState.Battle.Clients.IndexOf(Status.Me);
+  if relayHostScript then
+    MyPlayerNum := BattleState.Battle.Clients.IndexOf(HostBattleForm.relayHoster)
+  else
+    MyPlayerNum := BattleState.Battle.Clients.IndexOf(Status.Me);
 
   // now let's write the script file:
 
   Script.AddOrChangeKeyValue('GAME/Mapname',BattleState.Battle.Map);
-  Script.AddOrChangeKeyValue('GAME/Maphash',IntToStr(Misc.HexToInt(Utility.MapChecksums[Utility.MapList.indexOf(BattleState.Battle.Map)])));
+  mapHash := Utility.MapChecksums.Items[Utility.MapList.indexOf(BattleState.Battle.Map)];
+  Script.AddOrChangeKeyValue('GAME/Maphash',IntToStr(mapHash));
   if MetalTracker.Visible then
     Script.AddOrChangeKeyValue('GAME/modoptions/StartMetal',IntToStr(MetalTracker.Value));
   if EnergyTracker.Visible then
@@ -2261,12 +2310,13 @@
   if GameEndRadioGroup.Visible then
     Script.AddOrChangeKeyValue('GAME/modoptions/GameMode',IntToStr(GameEndRadioGroup.ItemIndex));
   Script.AddOrChangeKeyValue('GAME/GameType',BattleState.Battle.ModName);
-  Script.AddOrChangeKeyValue('GAME/ModHash',IntToStr(GetModHash(BattleState.Battle.ModName)));
+  modHash := GetModHash(BattleState.Battle.ModName);
+  Script.AddOrChangeKeyValue('GAME/ModHash',IntToStr(modHash));
 
-  if BattleState.Status = Hosting then
+  if relayHostScript or ((BattleState.Status = Hosting) and (HostBattleForm.relayHoster = nil)) then
   begin
     Script.AddOrChangeKeyValue('GAME/HostIP','localhost');
-    if BattleState.Battle.NATType = 1 then
+    if not relayHostScript and (BattleState.Battle.NATType = 1) then
       Script.AddOrChangeKeyValue('GAME/HostPort',IntToStr(NATTraversal.MyPrivateUDPSourcePort))
     else
       Script.AddOrChangeKeyValue('GAME/HostPort',IntToStr(BattleState.Battle.Port));
@@ -2277,15 +2327,23 @@
     Script.AddOrChangeKeyValue('GAME/HostPort',IntToStr(BattleState.Battle.Port));
   end;
 
-  if not (BattleState.Status = Hosting) then
+  if not relayHostScript and (not (BattleState.Status = Hosting) or (HostBattleForm.relayHoster &lt;&gt; nil)) then
     case BattleState.Battle.NATType of
     0: ; // use default (system assigned) port
     1: Script.AddOrChangeKeyValue('GAME/SourcePort',IntToStr(NATTraversal.MyPrivateUDPSourcePort));
     2: Script.AddOrChangeKeyValue('GAME/SourcePort',IntToStr(FIRST_UDP_SOURCEPORT + MyPlayerNum - 1{skip the host}));
     end; // of case sentence
   Script.AddOrChangeKeyValue('GAME/MyPlayerNum',IntToStr(MyPlayerNum));
-  Script.AddOrChangeKeyValue('GAME/MyPlayerName',Status.Me.Name);
-  Script.AddOrChangeKeyValue('GAME/IsHost',BoolToStr(BattleState.Status = Hosting));
+  if relayHostScript then
+  begin
+    Script.AddOrChangeKeyValue('GAME/MyPlayerName',HostBattleForm.relayHoster.Name);
+    Script.AddOrChangeKeyValue('GAME/IsHost','1');
+  end
+  else
+  begin
+    Script.AddOrChangeKeyValue('GAME/MyPlayerName',Status.Me.Name);
+    Script.AddOrChangeKeyValue('GAME/IsHost',BoolToStr((BattleState.Status = Hosting) and (HostBattleForm.relayHoster = nil)));
+  end;
   Script.AddOrChangeKeyValue('GAME/NumPlayers',IntToStr(BattleState.Battle.Clients.Count));
 
   // players:
@@ -2407,9 +2465,10 @@
     Write(f, Script.Script);
     CloseFile(f);
     tryToRewriteScript := False;
-    Result := True;
+    Result := Script;
   except
-    Result := False;
+    Result := nil;
+    Script.Free;
     try
       CloseFile(f);
     except
@@ -2418,10 +2477,9 @@
     tryToRewriteScript := MessageDlg(CANT_WRITE_SCRIPT_MSG,mtError,[mbYes,mbNo],0) = mrYes;
   end;
   until not tryToRewriteScript;
-  Script.Free;
 end;
 
-function TBattleForm.GenerateReplayScriptFile(FileName: string):Boolean;
+function TBattleForm.GenerateReplayHostScriptFile(FileName: string):TScript;
 var
   f: TextFile;
   i: Integer;
@@ -2481,9 +2539,10 @@
     Write(f,  Script.Script);
     CloseFile(f);
     tryToRewriteScript := False;
-    Result := True;
+    Result := Script;
   except
-    Result := False;
+    Result := nil;
+    Script.Free;
     try
       CloseFile(f);
     except
@@ -2492,7 +2551,6 @@
     tryToRewriteScript := MessageDlg(CANT_WRITE_SCRIPT_MSG,mtError,[mbYes,mbNo],0) = mrYes;
   end;
   until not tryToRewriteScript;
-  Script.Free;
 end;
 
 procedure TBattleForm.FormCreate(Sender: TObject);
@@ -2609,6 +2667,9 @@
 procedure TBattleForm.StartButtonClick(Sender: TObject);
 var
   res: Integer;
+  i: integer;
+  scriptGenerationResult: TScript;
+  sl:TStringList;
 begin
   if not isBattleReadyToStart then
   begin
@@ -2649,7 +2710,22 @@
     end;
   end;
   LobbyScriptUnit.StartBattleSuccess := True;
-  PostMessage(BattleForm.Handle, WM_STARTGAME, 0, 0);
+
+  if (BattleState.Status = Hosting) and (HostBattleForm.relayHoster &lt;&gt; nil) then
+  begin
+    scriptGenerationResult := GenerateNormalHostScriptFile(ExtractFilePath(Application.ExeName) + 'script.txt',True);
+    if scriptGenerationResult = nil then
+      Exit;
+    sl := TStringList.Create;
+    ParseDelimited(sl,scriptGenerationResult.Script,EOL,'');
+    MainForm.TryToSendCommand('SAYPRIVATE',HostBattleForm.relayHoster.Name+' !cleanstartscript');
+    for i:=0 to sl.Count-1 do
+      MainForm.TryToSendCommand('SAYPRIVATE',HostBattleForm.relayHoster.Name+' !appendscriptline '+sl[i]);
+    MainForm.TryToSendCommand('SAYPRIVATE',HostBattleForm.relayHoster.Name+' !startgame');
+    sl.Free;
+  end
+  else
+    PostMessage(BattleForm.Handle, WM_STARTGAME, 0, 0);
 end;
 
 procedure TBattleForm.HostButtonClick(Sender: TObject);
@@ -3348,6 +3424,8 @@
     else
     begin
       AddTextToChat('Back from the game', Colors.Info, 1);
+      if HostBattleForm.relayHoster.GetInGameStatus then
+        AddTextToChat('(You can force the autohost to stop the game using /forcequit)', Colors.Info, 1);
       Status.AmIInGame := False;
       MainForm.TryToSendCommand('MYSTATUS', '0'); // let's tell the server we returned from the game
 
@@ -4825,23 +4903,6 @@
     TTBXColorPaletteHack(ForceTeamColorPalette).SelectedCell := Point(-1, -1);
 end;
 
-procedure TBattleForm.HandicapSpinEditItemChange(Sender: TObject;
-  const Text: String);
-var
-  Value: Integer;
-begin
-  try
-    Value := StrToInt(Text);
-  except
-    Exit;
-  end;
-
-  if (Value &lt; 0) or (Value &gt; 100) then Exit;
-
-  // finally:
-  HandicapSpinEditItem.Value := Value;
-end;
-
 procedure TBattleForm.SetBotSideItemClick(Sender: TObject);
 var
   RealIndex: Integer;
@@ -6549,7 +6610,7 @@
       TLuaOption(ModOptionsList[i]).OnChange(nil);
 
   for i:=0 to MapOptionsList.Count -1 do
-    if TLuaOption(ModOptionsList[i]).ClassType &lt;&gt; TLuaOptionSection then
+    if TLuaOption(MapOptionsList[i]).ClassType &lt;&gt; TLuaOptionSection then
       TLuaOption(MapOptionsList[i]).OnChange(nil);
 end;
 
@@ -6637,7 +6698,7 @@
   i:integer;
 begin
   try
-    Filename := MAPS_CACHE_FOLDER + '\' + Utility.MapChecksums[CurrentMapIndex] +'.options';
+    Filename := MAPS_CACHE_FOLDER + '\' + IntToStr(Utility.MapChecksums.Items[CurrentMapIndex]) +'.options';
     if FileExists(Filename) then
       DeleteFile(Filename);
     Ini := TIniFile.Create(Filename);
@@ -6655,7 +6716,7 @@
   Ini : TIniFile;
   i: Integer;
 begin
-  Filename := MAPS_CACHE_FOLDER + '\' + Utility.MapChecksums[CurrentMapIndex] +'.options';
+  Filename := MAPS_CACHE_FOLDER + '\' + IntToStr(Utility.MapChecksums.Items[CurrentMapIndex]) +'.options';
   Ini := TIniFile.Create(Filename);
   if Ini.SectionExists('MapOptions') then
   begin
@@ -7127,12 +7188,12 @@
     for i:=0 to MapOptionsList.Count-1 do
       if TLuaOption(MapOptionsList[i]).ClassType &lt;&gt; TLuaOptionSection then
         if TLuaOption(MapOptionsList[i]).ClassType = TLuaOptionBool then
-          AddLine(TLuaOption(MapOptionsList[i]).Name,BoolToStr(TLuaOption(MapOptionsList[i]).toString &lt;&gt; '0',true),TLuaOption(MapOptionsList[i]).toString &lt;&gt; TLuaOption(MapOptionsList[i]).DefaultValue,TLuaOption(MapOptionsList[i]).hasChanged,TLuaOption(MapOptionsList[i]).getDescription)
+          AddLine(TLuaOption(MapOptionsList[i]).Name,BoolToStr(TLuaOption(MapOptionsList[i]).toString &lt;&gt; '0',true),TLuaOption(MapOptionsList[i]).isDefault,TLuaOption(MapOptionsList[i]).hasChanged,TLuaOption(MapOptionsList[i]).getDescription)
         else
           if TLuaOption(MapOptionsList[i]).ClassType = TLuaOptionList then
-            AddLine(TLuaOption(MapOptionsList[i]).Name,TLuaOptionList(MapOptionsList[i]).nameToString,TLuaOption(MapOptionsList[i]).toString &lt;&gt; TLuaOption(MapOptionsList[i]).DefaultValue,TLuaOption(MapOptionsList[i]).hasChanged,TLuaOption(MapOptionsList[i]).getDescription)
+            AddLine(TLuaOption(MapOptionsList[i]).Name,TLuaOptionList(MapOptionsList[i]).nameToString,TLuaOption(MapOptionsList[i]).isDefault,TLuaOption(MapOptionsList[i]).hasChanged,TLuaOption(MapOptionsList[i]).getDescription)
           else
-            AddLine(TLuaOption(MapOptionsList[i]).Name,TLuaOption(MapOptionsList[i]).toString,TLuaOption(MapOptionsList[i]).toString &lt;&gt; TLuaOption(MapOptionsList[i]).DefaultValue,TLuaOption(MapOptionsList[i]).hasChanged,TLuaOption(MapOptionsList[i]).getDescription);
+            AddLine(TLuaOption(MapOptionsList[i]).Name,TLuaOption(MapOptionsList[i]).toString,TLuaOption(MapOptionsList[i]).isDefault,TLuaOption(MapOptionsList[i]).hasChanged,TLuaOption(MapOptionsList[i]).getDescription);
   end;
 
   if BattleState.DisabledUnits.Count &gt; 0 then
@@ -7347,4 +7408,21 @@
 //  MessageDlg(FloatToStr(Utility.GetMapMaxHeight(PChar(Utility.MapList[CurrentMapIndex]))-Utility.GetMapMaxHeight(PChar(Utility.MapList[CurrentMapIndex]))),mtInformation,[mbOk],0);
 end;
 
+procedure TBattleForm.HandicapSpinEditItemValueChange(
+  Sender: TTBXCustomSpinEditItem; const AValue: Extended);
+var
+  Value: Integer;
+begin
+  try
+    Value := StrToInt(Text);
+  except
+    Exit;
+  end;
+
+  if (Value &lt; 0) or (Value &gt; 100) then Exit;
+
+  // finally:
+  HandicapSpinEditItem.Value := Value;
+end;
+
 end.

Modified: Lobby/TASClient/HostBattleFormUnit.dfm
===================================================================
--- Lobby/TASClient/HostBattleFormUnit.dfm	2009-07-07 21:26:06 UTC (rev 7287)
+++ Lobby/TASClient/HostBattleFormUnit.dfm	2009-07-10 22:56:05 UTC (rev 7288)
@@ -1,9 +1,9 @@
 object HostBattleForm: THostBattleForm
-  Left = 373
+  Left = 378
   Top = 118
   BorderStyle = bsDialog
   Caption = 'Host battle'
-  ClientHeight = 355
+  ClientHeight = 380
   ClientWidth = 331
   Color = clBtnFace
   Constraints.MaxHeight = 750
@@ -24,7 +24,7 @@
     Left = 0
     Top = 0
     Width = 331
-    Height = 355
+    Height = 380
     Caption = 'Host battle'
     FixedSize = True
     Options.Minimize = False
@@ -92,7 +92,7 @@
     end
     object SpeedButton1: TSpTBXSpeedButton
       Left = 152
-      Top = 312
+      Top = 344
       Width = 33
       Height = 25
       Caption = '?'
@@ -224,7 +224,7 @@
     end
     object HostButton: TTBXButton
       Left = 56
-      Top = 312
+      Top = 344
       Width = 89
       Height = 25
       AutoSize = False
@@ -237,7 +237,7 @@
     end
     object CancelButton: TSpTBXButton
       Left = 192
-      Top = 312
+      Top = 344
       Width = 73
       Height = 25
       Caption = 'Cancel'
@@ -311,10 +311,18 @@
       LinkFont.Name = 'MS Sans Serif'
       LinkFont.Style = [fsUnderline]
     end
+    object RelayHostCheckBox: TSpTBXCheckBox
+      Left = 16
+      Top = 304
+      Width = 68
+      Height = 15
+      Caption = 'Relay host'
+      TabOrder = 24
+    end
   end
   object HostPopupMenu: TPopupMenu
     Left = 88
-    Top = 280
+    Top = 312
     object Host1: TMenuItem
       AutoHotkeys = maAutomatic
       Caption = 'Host'

Modified: Lobby/TASClient/HostBattleFormUnit.pas
===================================================================
--- Lobby/TASClient/HostBattleFormUnit.pas	2009-07-07 21:26:06 UTC (rev 7287)
+++ Lobby/TASClient/HostBattleFormUnit.pas	2009-07-10 22:56:05 UTC (rev 7288)
@@ -41,6 +41,7 @@
     HttpCli1: THttpCli;
     RefreshButton: TSpTBXButton;
     RefreshModListButton: TSpTBXButton;
+    RelayHostCheckBox: TSpTBXCheckBox;
 
     procedure CreateParams(var Params: TCreateParams); override;
     procedure TryToHostBattle(ladderIndex: integer);
@@ -64,6 +65,11 @@
   private
     { Private declarations }
   public
+    relayHoster: TClient;
+    relayHosterName: string;
+    relayHostManagerName: string;
+    relayHostOpenBattleCmd: string;
+    relayHostPassword: string;
     replay: TReplay;
   end;
   TLadderListThread = class(TTASClientThread)
@@ -137,7 +143,7 @@
 begin
   try
     i := StrToInt(Trim(PortEdit.Text));
-  if (i &lt; 1024) or (i &gt; 65535) then raise Exception.Create('Number out of range');
+  if not RelayHostCheckBox.Checked and ((i &lt; 1024) or (i &gt; 65535)) then raise Exception.Create('Number out of range');
   except
     if not LobbyScriptUnit.ScriptHostingRunning and not LobbyScriptUnit.ScriptHostingReplayRunning then
       MessageDlg(_('Port number must be a whole number within a proper range (1024..65535)'), mtError, [mbOK], 0);
@@ -158,19 +164,22 @@
     Exit;
   end;
 
-  ReInitLib;
-  LoadMod(Utility.ModArchiveList[Utility.ModList.IndexOf(ModsComboBox.Items[ModsComboBox.ItemIndex])]);
+  if not RelayHostCheckBox.Checked then
+  begin
+    ReInitLib;
+    LoadMod(Utility.ModArchiveList[Utility.ModList.IndexOf(ModsComboBox.Items[ModsComboBox.ItemIndex])]);
 
-  if Utility.ModValidMaps.Count &gt; 0 then
-  begin
-    i:=0;
-    while (i &lt; Utility.ModValidMaps.Count) and (Utility.MapList.IndexOf(Utility.ModValidMaps[i]) = -1) do
-      i := i+1;
-    if i = Utility.ModValidMaps.Count then
+    if Utility.ModValidMaps.Count &gt; 0 then
     begin
-      if not LobbyScriptUnit.ScriptHostingRunning and not LobbyScriptUnit.ScriptHostingReplayRunning then
-        MessageDlg(_('Cannot proceed: this mod requires one of the following map :')+EOL+Misc.JoinStringList(Utility.ModValidMaps,' ; '), mtWarning, [mbOK], 0);
-      Exit;
+      i:=0;
+      while (i &lt; Utility.ModValidMaps.Count) and (Utility.MapList.IndexOf(Utility.ModValidMaps[i]) = -1) do
+        i := i+1;
+      if i = Utility.ModValidMaps.Count then
+      begin
+        if not LobbyScriptUnit.ScriptHostingRunning and not LobbyScriptUnit.ScriptHostingReplayRunning then
+          MessageDlg(_('Cannot proceed: this mod requires one of the following map :')+EOL+Misc.JoinStringList(Utility.ModValidMaps,' ; '), mtWarning, [mbOK], 0);
+        Exit;
+      end;
     end;
   end;
 
@@ -188,19 +197,22 @@
   // loading default battle preferences
   PreferencesForm.LoadDefaultBattlePreferencesFromRegistry;
 
-  // we have to change mod and update unit list:
-  InitWaitForm.ChangeCaption(MSG_MODCHANGE);
-  InitWaitForm.TakeAction := 0; // change mod
-  InitWaitForm.ChangeToMod := ModsComboBox.Text;
-  InitWaitForm.ShowModal; // this changes mod (see OnFormActivate event)
-  // now let's update units:
-  InitWaitForm.ChangeCaption(MSG_GETUNITS);
-  InitWaitForm.TakeAction := 1; // load unit lists
-  InitWaitForm.ShowModal; // this loads unit lists (see OnFormActivate event)
-  //DisableUnitsForm.VDTUnits.RootNodeCount := UnitNames.Count;
-  DisableUnitsForm.PopulateUnitList;
+  if not RelayHostCheckBox.Checked then
+  begin
+    // we have to change mod and update unit list:
+    InitWaitForm.ChangeCaption(MSG_MODCHANGE);
+    InitWaitForm.TakeAction := 0; // change mod
+    InitWaitForm.ChangeToMod := ModsComboBox.Text;
+    InitWaitForm.ShowModal; // this changes mod (see OnFormActivate event)
+    // now let's update units:
+    InitWaitForm.ChangeCaption(MSG_GETUNITS);
+    InitWaitForm.TakeAction := 1; // load unit lists
+    InitWaitForm.ShowModal; // this loads unit lists (see OnFormActivate event)
+    //DisableUnitsForm.VDTUnits.RootNodeCount := UnitNames.Count;
+    DisableUnitsForm.PopulateUnitList;
+  end;
 
-  with BattleForm do begin
+  {*with BattleForm do begin
     MetalTracker.Minimum := 0;
     MetalTracker.Maximum := 10000;
     EnergyTracker.Minimum := 0;
@@ -240,7 +252,7 @@
           end;
         end;
       end;
-  end;
+  end; *}
 
   s := '';
   // type:
@@ -283,7 +295,7 @@
   // rank limit:
   s := s + IntToStr(RankComboBox.ItemIndex) + ' ';
   // map hash:
-  s := s + IntToStr(Misc.HexToInt(Utility.MapChecksums[BattleForm.CurrentMapIndex])) + ' ';
+  s := s + IntToStr(Utility.MapChecksums.Items[BattleForm.CurrentMapIndex]) + ' ';
   // map:
   s := s + Utility.MapList[BattleForm.CurrentMapIndex] + #9;
   // title (description):
@@ -303,16 +315,33 @@
     CheckPasswordThread := TLadderCheckAccountThread.Create(False,Preferences.LadderPassword,true);
 
   // send the command:
-  MainForm.TryToSendCommand('OPENBATTLE', s);
-
-  if WaitForAckForm.ShowModal = mrOK then
-  begin // success
+  if RelayHostCheckBox.Checked then
+  begin
+    relayHostOpenBattleCmd := '!openbattle '+s;
+    relayHostPassword := PasswordEdit.Text;
     BattleState.AutoSendDescription := AutoSendDescCheckbox.Checked;
     BattleState.AutoKickRankLimit := BattleForm.mnuLimitRankAutoKick.Checked;
-    Close;
+    if MainForm.GetClient('RelayHostManagerList') = nil then
+      MessageDlg(_('RelayHostManager offline, you can''t relay host unilt it gets back online'),mtError,[mbOk],0)
+    else
+    begin
+      MainForm.TryToSendCommand('SAYPRIVATE','RelayHostManagerList !listmanagers');
+      Close;
+    end;
   end
   else
-  begin // failure
+  begin
+    MainForm.TryToSendCommand('OPENBATTLE', s);
+
+    if WaitForAckForm.ShowModal = mrOK then
+    begin // success
+      BattleState.AutoSendDescription := AutoSendDescCheckbox.Checked;
+      BattleState.AutoKickRankLimit := BattleForm.mnuLimitRankAutoKick.Checked;
+      Close;
+    end
+    else
+    begin // failure
+    end;
   end;
 end;
 
@@ -414,7 +443,7 @@
   // rank limit:
   s := s + IntToStr(RankComboBox.ItemIndex) + ' ';
   // map hash:
-  s := s + IntToStr(Misc.HexToInt(Utility.MapChecksums[Utility.MapList.IndexOf(replay.Script.ReadKeyValue('GAME/mapname'))])) + ' ';
+  s := s + IntToStr(Utility.MapChecksums.Items[Utility.MapList.IndexOf(replay.Script.ReadKeyValue('GAME/mapname'))]) + ' ';
   // map:
   s := s + replay.Script.ReadKeyValue('GAME/mapname') + #9;
   // title (description):
@@ -453,6 +482,8 @@
 
   PlayersTracker.Maximum := MAX_TEAMS;
 
+  relayHoster := nil;
+
   RankComboBox.Items.Add('(No limit)');
   for i := 1 to High(Ranks) do RankComboBox.Items.Add(Ranks[i]);
   RankComboBox.ItemIndex := 0;
@@ -497,6 +528,8 @@
 begin
   replay := nil;
 
+  RelayHostCheckBox.Visible := True;
+
   ModsComboBox.Enabled := True;
   RankComboBox.Enabled := True;
 
@@ -529,6 +562,8 @@
 
 procedure THostBattleForm.HostReplay1Click(Sender: TObject);
 begin
+  RelayHostCheckBox.Visible := False;
+
   ReplaysForm.WatchButton.Visible := False;
   ReplaysForm.HostReplayButton.Visible := True;
 
@@ -677,6 +712,8 @@
 begin
   replay := nil;
 
+  RelayHostCheckBox.Visible := False;
+
   ModsComboBox.Enabled := True;
   RankComboBox.Enabled := True;
 

Modified: Lobby/TASClient/HostInfoUnit.dfm
===================================================================
--- Lobby/TASClient/HostInfoUnit.dfm	2009-07-07 21:26:06 UTC (rev 7287)
+++ Lobby/TASClient/HostInfoUnit.dfm	2009-07-10 22:56:05 UTC (rev 7288)
@@ -1,13 +1,13 @@
 object HostInfoForm: THostInfoForm
-  Left = 374
-  Top = 294
+  Left = 741
+  Top = 289
   BorderStyle = bsDialog
   Caption = 'Help'
-  ClientHeight = 324
+  ClientHeight = 373
   ClientWidth = 370
   Color = clBtnFace
-  Constraints.MaxHeight = 1000
-  Constraints.MaxWidth = 1680
+  Constraints.MaxHeight = 750
+  Constraints.MaxWidth = 1280
   Font.Charset = DEFAULT_CHARSET
   Font.Color = clWindowText
   Font.Height = -11
@@ -23,7 +23,7 @@
     Left = 0
     Top = 0
     Width = 370
-    Height = 324
+    Height = 373
     Caption = 'Help'
     FixedSize = True
     Options.Minimize = False
@@ -49,7 +49,7 @@
     end
     object Label2: TSpTBXLabel
       Left = 16
-      Top = 72
+      Top = 128
       Width = 337
       Height = 33
       Caption = 
@@ -71,7 +71,7 @@
     end
     object Label3: TSpTBXLabel
       Left = 16
-      Top = 224
+      Top = 280
       Width = 172
       Height = 13
       Cursor = crHandPoint
@@ -91,7 +91,7 @@
     end
     object Label4: TSpTBXLabel
       Left = 16
-      Top = 120
+      Top = 176
       Width = 337
       Height = 33
       Caption = 
@@ -113,7 +113,7 @@
     end
     object Label5: TSpTBXLabel
       Left = 16
-      Top = 248
+      Top = 304
       Width = 156
       Height = 13
       Cursor = crHandPoint
@@ -133,7 +133,7 @@
     end
     object Label6: TSpTBXLabel
       Left = 16
-      Top = 168
+      Top = 224
       Width = 321
       Height = 33
       Caption = 
@@ -155,7 +155,7 @@
     end
     object Button1: TSpTBXButton
       Left = 144
-      Top = 288
+      Top = 336
       Width = 83
       Height = 25
       Caption = 'Close'
@@ -168,5 +168,28 @@
       LinkFont.Name = 'MS Sans Serif'
       LinkFont.Style = [fsUnderline]
     end
+    object SpTBXLabel1: TSpTBXLabel
+      Left = 16
+      Top = 64
+      Width = 329
+      Height = 41
+      Caption = 
+        '* If you can'#39't host because you are behind a rooter and can'#39't fo' +
+        'rward the port and NAT traversal doesn'#39't work, you can relay the' +
+        ' hosting throw an automated host'
+      AutoSize = False
+      Font.Charset = DEFAULT_CHARSET
+      Font.Color = clWindowText
+      Font.Height = -12
+      Font.Name = 'Arial'
+      Font.Style = []
+      ParentFont = False
+      Wrapping = twWrap
+      LinkFont.Charset = DEFAULT_CHARSET
+      LinkFont.Color = clBlue
+      LinkFont.Height = -11
+      LinkFont.Name = 'MS Sans Serif'
+      LinkFont.Style = [fsUnderline]
+    end
   end
 end

Modified: Lobby/TASClient/HostInfoUnit.pas
===================================================================
--- Lobby/TASClient/HostInfoUnit.pas	2009-07-07 21:26:06 UTC (rev 7287)
+++ Lobby/TASClient/HostInfoUnit.pas	2009-07-10 22:56:05 UTC (rev 7288)
@@ -16,6 +16,7 @@
     Label5: TSpTBXLabel;
     Label6: TSpTBXLabel;
     Button1: TSpTBXButton;
+    SpTBXLabel1: TSpTBXLabel;
 
     procedure CreateParams(var Params: TCreateParams); override;
 

Modified: Lobby/TASClient/MainUnit.dfm
===================================================================
--- Lobby/TASClient/MainUnit.dfm	2009-07-07 21:26:06 UTC (rev 7287)
+++ Lobby/TASClient/MainUnit.dfm	2009-07-10 22:56:05 UTC (rev 7288)
@@ -1,8 +1,8 @@
 object MainForm: TMainForm
-  Left = 500
-  Top = 189
+  Left = 378
+  Top = 131
   Width = 850
-  Height = 538
+  Height = 546
   Caption = '.'
   Color = clBtnFace
   Constraints.MaxHeight = 750
@@ -25,7 +25,7 @@
     Left = 0
     Top = 0
     Width = 842
-    Height = 511
+    Height = 519
     Caption = 'TASClient'
     TBXStyleBackground = True
     object DefaultSideImage: TImage
@@ -207,7 +207,7 @@
       Left = 4
       Top = 112
       Width = 834
-      Height = 395
+      Height = 403
       Caption = 'Panel1'
       Align = alClient
       TabOrder = 1
@@ -215,7 +215,7 @@
       TBXStyleBackground = True
       object Panel3: TPanel
         Left = 2
-        Top = 123
+        Top = 131
         Width = 830
         Height = 270
         Align = alBottom
@@ -915,7 +915,7 @@
       end
       object Splitter2: TSpTBXSplitter
         Left = 2
-        Top = 117
+        Top = 125
         Width = 830
         Height = 6
         Cursor = crSizeNS
@@ -930,7 +930,7 @@
         Left = 2
         Top = 2
         Width = 830
-        Height = 115
+        Height = 123
         Align = alClient
         TabOrder = 2
         Borders = False
@@ -938,7 +938,7 @@
           Left = 2
           Top = 2
           Width = 636
-          Height = 111
+          Height = 119
           Align = alClient
           Constraints.MinHeight = 1
           MultiLine = True
@@ -953,7 +953,7 @@
           Left = 648
           Top = 2
           Width = 180
-          Height = 111
+          Height = 119
           Align = alRight
           Color = clNone
           Constraints.MinWidth = 1
@@ -966,7 +966,7 @@
             Left = 2
             Top = 52
             Width = 176
-            Height = 57
+            Height = 65
             Style = lbOwnerDrawFixed
             Align = alClient
             DragMode = dmAutomatic
@@ -1108,7 +1108,7 @@
           Left = 638
           Top = 2
           Width = 10
-          Height = 111
+          Height = 119
           Cursor = crSizeWE
           Caption = 'Splitter1'
           Align = alRight

Modified: Lobby/TASClient/MainUnit.pas
===================================================================
--- Lobby/TASClient/MainUnit.pas	2009-07-07 21:26:06 UTC (rev 7287)
+++ Lobby/TASClient/MainUnit.pas	2009-07-10 22:56:05 UTC (rev 7288)
@@ -4,191 +4,6 @@
 
   For protocol description + notes see &quot;trunk/Documentation/Lobby/LobbyProtocol.txt&quot; (in SVN repository)
 
-  ------ LINKS ------
-  * <A HREF="http://community.borland.com/soapbox/techvoyage/article/1,1795,10280,00.html">http://community.borland.com/soapbox/techvoyage/article/1,1795,10280,00.html</A>
-    (object pascal style guide)
-
-  * <A HREF="http://www.latiumsoftware.com/en/delphi/00003.php">http://www.latiumsoftware.com/en/delphi/00003.php</A>
-    (how to execute application and wait until it is finished but also allowing main app to run meanwhile)
-
-  * <A HREF="http://www.latiumsoftware.com/en/delphi/00024.php">http://www.latiumsoftware.com/en/delphi/00024.php</A>
-    <A HREF="http://www.delphi3000.com/articles/article_951.asp?SK=">http://www.delphi3000.com/articles/article_951.asp?SK=</A>
-    <A HREF="http://delphi.about.com/od/objectpascalide/l/aa021301c.htm">http://delphi.about.com/od/objectpascalide/l/aa021301c.htm</A>
-    (how to embed audio files in .exe and play them)
-
-  * <A HREF="http://delphi.about.com/od/adptips2004/a/bltip0904_3.htm">http://delphi.about.com/od/adptips2004/a/bltip0904_3.htm</A>
-    (how to catch keys globally in app)
-
-  * <A HREF="http://www.latiumsoftware.com/en/delphi/00004.php">http://www.latiumsoftware.com/en/delphi/00004.php</A>
-    (how to read/write to registry)
-
-  * <A HREF="http://www.jansfreeware.com/articles/delphiresource.html">http://www.jansfreeware.com/articles/delphiresource.html</A>
-    <A HREF="http://www.cpcug.org/user/clemenzi/technical/Languages/Delphi/Resources.html">http://www.cpcug.org/user/clemenzi/technical/Languages/Delphi/Resources.html</A>
-    (how to load/store data in resource files)
-
-  * <A HREF="http://flags.byodkm.de/">http://flags.byodkm.de/</A>
-    (world flags - images)
-
-  * <A HREF="http://appsapps.zapto.org/proggies/savesize.txt">http://appsapps.zapto.org/proggies/savesize.txt</A>
-    (how to get form's &quot;normal&quot; width, height, left and top values, even when form is maximized)
-
-  * <A HREF="http://delphi.about.com/od/vclusing/l/aa111803a.htm">http://delphi.about.com/od/vclusing/l/aa111803a.htm</A>
-    (how to add hyperlink functionality to TExRichEdit)
-
-  * <A HREF="http://delphi.about.com/od/formsdialogs/l/aa073101b.htm">http://delphi.about.com/od/formsdialogs/l/aa073101b.htm</A>
-    (great article on how to change various form's attributes, like changing visibility of form
-     in taskbar, form's transparency, etc.)
-
-  * <A HREF="http://www.cpcug.org/user/clemenzi/technical/Languages/RichEdit.htm">http://www.cpcug.org/user/clemenzi/technical/Languages/RichEdit.htm</A>
-    (explains some tricks and shows some problems using Windows API component &quot;RichEdit&quot;)
-    
-  * <A HREF="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/shellcc/platform/commctls/richedit/richeditcontrols.asp">http://msdn.microsoft.com/library/default.asp?url=/library/en-us/shellcc/platform/commctls/richedit/richeditcontrols.asp</A>
-    (MSDN reference about EM_GETSCROLLPOS and EM_SETSCROLLPOS messages)
-
-  * <A HREF="http://www.elists.org/pipermail/twsocket/2004-March/025141.html">http://www.elists.org/pipermail/twsocket/2004-March/025141.html</A>
-    (about wsoTCPNoDelay option in TWSocket)
-
-  * <A HREF="http://coding.derkeiler.com/Archive/Delphi/borland.public.delphi.language.objectpascal/2003-11/0223.html">http://coding.derkeiler.com/Archive/Delphi/borland.public.delphi.language.objectpascal/2003-11/0223.html</A>
-    (issue with DecimalSeparator getting changed by WM_WININICHANGE message)
-
-  * <A HREF="http://groups.google.com/group/borland.public.delphi.nativeapi.win32/browse_thread/thread/f5cd2161d871edc9/d7e78910e68dfccf">http://groups.google.com/group/borland.public.delphi.nativeapi.win32/browse_thread/thread/f5cd2161d871edc9/d7e78910e68dfccf</A>
-    (an explanation and code showing how to fix problem with hints and showmessage and alike causing main form to receive
-     focus when using taskbar buttons for all forms)
-
-  * <A HREF="http://www.efg2.com/Lab/Library/UseNet/1999/0909.txt">http://www.efg2.com/Lab/Library/UseNet/1999/0909.txt</A>
-    (MD5 algorithm implementation)
-
-  * <A HREF="http://www.cityinthesky.co.uk/cryptography.html">http://www.cityinthesky.co.uk/cryptography.html</A>
-    (another open-source MD5 implementation and also some other algorithms)
-
-  * <A HREF="http://www.howtodothings.com/viewarticle.aspx?article=490">http://www.howtodothings.com/viewarticle.aspx?article=490</A>
-    (how to get local IP properly. Most of the examples I found on net
-    are examples of bad programming, such as <A HREF="http://www.scalabium.com/faq/dct0037.htm.">http://www.scalabium.com/faq/dct0037.htm.</A>
-    It IS important to do WSACleanUp even if some error occured, and also
-    checking for WSAStartUp result before doing anything else is good practice)
-
-  * <A HREF="http://www.brynosaurus.com/pub/net/p2pnat/">http://www.brynosaurus.com/pub/net/p2pnat/</A>
-    <A HREF="http://www.potaroo.net/ietf/idref/draft-ford-natp2p/">http://www.potaroo.net/ietf/idref/draft-ford-natp2p/</A>
-    <A HREF="http://www.newport-networks.com/whitepapers/nat-traversal1.html">http://www.newport-networks.com/whitepapers/nat-traversal1.html</A>
-    (about NAT traversal)
-
-  * <A HREF="http://www.thedelphimagazine.com/samples/1175/article.htm">http://www.thedelphimagazine.com/samples/1175/article.htm</A>
-    <A HREF="http://gp.17slon.com/gp/gptimezone.htm">http://gp.17slon.com/gp/gptimezone.htm</A>
-    (about converting between different time zones. I am using
-     this library to convert from UTC to local time)
-
-  * <A HREF="http://users.pandora.be/sonal.nv/ics/faq/TWSocket.html#BroadcastvsMulticastAE">http://users.pandora.be/sonal.nv/ics/faq/TWSocket.html#BroadcastvsMulticastAE</A>
-    (how to change send/receive buffer's size with TWSocket)
-
-  * <A HREF="http://www.experts-exchange.com/Programming/Programming_Languages/Delphi/Q_21351618.html">http://www.experts-exchange.com/Programming/Programming_Languages/Delphi/Q_21351618.html</A>
-    (how to do OnMouseEnter/OnMouseLeave events)
-
-  ------ WARNING ------
-  * Due to a bug in TjanTracker component, thumb is not positioned correctly
-    when you open the project (it gets positioned correctly once you run the
-    program). If you change its value in design-time, it will get updated
-    and thumb will get positioned correctly.
-  * TAB characters are delimiters between sentences when command requires more                                                 
-    than one parameter of type &quot;sentence&quot;. This is why program must replace
-    all TABs with spaces, when sending commands with multiple sentences as
-    arguments. All messaging commands require only one parameter of type &quot;sentence&quot;
-    so there is no need to remove TABs from this messages.
-  * Do not to try to load jpeg file into NoMapImage, since it won't work properly
-    when assigning TPicture (or TBitmap) object. You must use normal bitmap.
-  * &quot;online maps&quot;: make sure minimap's (TImage) Top property is assigned last
-    when removing maps or reordering them, since minimap is the largest of visual
-    components of a map (label and download buttons bottom are higher than minimap's).
-    If not, some wierd bug will arise: when being at the bottom of &quot;online maps&quot; page,
-    try to remove first item from the list. The last item will not be removed, only
-    its label will be moved higher. This is due to vertical scrollbar's position
-    being changed when the lowest visual component is being moved up.
-
-  ------ REMEMBER ------
-  * when adding new common dialogs (TOpenDialog, TSaveDialog, ...) always manually set Option.ofNoChangeDir to True!
-    (if not, current working dir will change and unitsync.dll won't find files since it will use new working dir)
-    Also see <A HREF="http://qc.borland.com/wc/qcmain.aspx?d=1282">http://qc.borland.com/wc/qcmain.aspx?d=1282</A>
-  * never change ActivePageIndex manually, since it doesn't trigger OnChange event! Always use ChangeActivePageAndUpdate method!
-  * team indexes and ally team indexes are not zero-based! They all start at 1. When saved to the script.txt, they get converted
-    to zero-based indexes.
-  * you can send lines of any length. I've tested it with 600+ KB long strings and it worked (in both directions)
-  * modders should put side images within &quot;SidePics&quot; folder in archive file (sdz/sd7). Side images should
-    be 16x16, 24-bit BMP files.
-
-  ------ 3RD-PARTY COMPONENTS ------
-  - TVirtualStringTree/TVirtualDrawTree, see <A HREF="http://www.lischke-online.de/VirtualTreeview/">http://www.lischke-online.de/VirtualTreeview/</A>
-  - TjanTracker (modified!) (sources included)
-  - TWSocket (ICS), see <A HREF="http://www.overbyte.be/frame_index.html?redirTo=/ssl.html">http://www.overbyte.be/frame_index.html?redirTo=/ssl.html</A>
-  - GraphicEx, see <A HREF="http://www.soft-gems.net/Graphics.php">http://www.soft-gems.net/Graphics.php</A>
-  - RichEditURL (included with these sources. See RichEditURL.pas for more details and links)
-  - ImageEx (included with these sources. See ImageEx.pas for more details and links)
-  - JEDI Visual Component Library (<A HREF="http://homepages.borland.com/jedi/jvcl/">http://homepages.borland.com/jedi/jvcl/</A>)
-  - MD5 algorithm implementation from <A HREF="http://www.efg2.com/Lab/Library/UseNet/1999/0909.txt">http://www.efg2.com/Lab/Library/UseNet/1999/0909.txt</A> (included with these sources)
-  - SZCodeBaseX 1.3.2 (<A HREF="http://www.szutils.net/Delphi/Delphi.php">http://www.szutils.net/Delphi/Delphi.php</A>), included with these sources
-  - DSiWin32 - collection of Win32 wrappers and helpful functions (<A HREF="http://17slon.com/gp/gp/files/dsiwin32.htm">http://17slon.com/gp/gp/files/dsiwin32.htm</A>)
-  - Toolbar2000 2.1.8 (<A HREF="http://www.jrsoftware.org/tb2k.php">http://www.jrsoftware.org/tb2k.php</A>)
-  - Patch for TB2K 2.1.8 (<A HREF="http://club.telepolis.com/silverpointdev/sptbxlib/tbxpatch218.zip">http://club.telepolis.com/silverpointdev/sptbxlib/tbxpatch218.zip</A>)
-  - TBX 2.1 Beta 1 (<A HREF="http://www.g32.org/tbx/index.html">http://www.g32.org/tbx/index.html</A>)
-  - TntWare Delphi Unicode Controls 2.2.3 or above (<A HREF="http://www.tntware.com/delphicontrols/unicode/">http://www.tntware.com/delphicontrols/unicode/</A>)
-  - SpTBXLib 1.8 (<A HREF="http://club.telepolis.com/silverpointdev/sptbxlib/index.htm">http://club.telepolis.com/silverpointdev/sptbxlib/index.htm</A>)
-  - Additional TBX themes (<A HREF="http://www.rmklever.com/zipfiles/TBXThemes21.zip">http://www.rmklever.com/zipfiles/TBXThemes21.zip</A>)
-  + See &quot;! readme !.txt&quot; on further instructions on how to install some of these components
-
-  ------ MY NOTES ------
-  * Don't forget to manually set Scaled property of each new form to FALSE!
-  * Don't forget to manually set Caption, UseTBXBackground, FixedSize and system menu properties when adding TSpTBXTitlebar!
-  * When creating a patcher, use this registry location for default dir:
-    HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths\SpringClient.exe
-  * Hints are not done yet, currently there could be a problem if hints would use some other font than VDTBattles
-  .Canvas.Font,
-    since there is no way to get HintCanvas in OnGetHintSize event. See this post: <A HREF="http://www.lischke-online.de/support/forums/viewtopic.php?t=1124">http://www.lischke-online.de/support/forums/viewtopic.php?t=1124</A>
-  * Program may raise all kind of exceptions(errors) on startup if you don't have enough memory available in windows
-  * I am not sure if it is wise to use OnlineMaps (TList) in OnlineMapsForm withouth any thread synchronization. It may probably
-    cause crashes in some rare cases!
-  * Don't forget to override CreateParams method of each new form that is shown as modal form from battle screen!
-  * Don't change items order in RichEditPopupMenu, unless you change OnPopup event implementation!
-  * Make sure that &quot;locked&quot; property gets set to False when hosting a battle, since server assumes it's set to False.
-  * In order to make JclDebug functionality work, here is a short description from JclDebug's readme file:
-   1. Close all running instances of Delphi
-   2. Install JCL and IDE experts by the JCL Installer
-   3. Run Delphi IDE and open your project
-   4. Remove any TApplication.OnException handlers from your project (if
-      any).
-   5. Add new Exception Dialog by selecting File | New | Other ... |
-      Dialogs tab, Select 'Exception Dialog' or 'Exception Dialog with
-      Send' icon, Click OK button, Save the form (use
-      ExceptionDialog.pas name, for example)
-   6. Check Project | Insert JCL Debug data menu item
-   7. Do Project | Build
-  * If position of original clients within client list should be changed, one must make sure that OnDblClick and
-    OnDrawItem are accordingly modified!
-  * EM_SETSCROLLPOS and EM_GETSCROLLPOS are available only since RichEdit 3.0, so it won't work under WINE in Linux.
-    There is an alternative though, search google for EM_GETFIRSTVISIBLELINE message.
-  * When adding new NAT traversal methods, modify these methods accordingly:
-    + THostBattleForm.JvHostArrowButtonClick(Sender: TObject)
-    + THostBattleForm.NATRadioGroupClick(Sender: TObject)
-    + THostBattleForm.TryToHostBattle
-    + THostBattleForm.TryToHostReplay
-    + TBattleForm.GenerateNormalScriptFile(FileName: string)
-    + TBattleForm.GenerateReplayScriptFile(FileName: string)
-    + TBattleForm.OnStartGameMessage(var Msg: TMessage)
-  * If SpTBX/TNT controls were ever to be removed, one should accordingly modify:
-    + NotificationsUnit: replace WideString-s with AnsiString-s
-    + PreferencesForm: remove &quot;Skins&quot; tab and skin detection
-  * For checksums I use signed integers, although for example unitsync.dll returns hash codes / checksums
-    as unsigned ints, the reason I use signed integers is due to the fact Java doesn't have
-    unsigned numerical data types (lobby server is written in Java). To store unsigned 32-bit ints
-    in java you have to use signed 64-bit integers, which is a waste of space most of the time.
-  * When using TBX/SpTBX components, remember that they use WideStrings instead of AnsiStrings,
-    casting those strings to PChar will not work properly - that was the bug with watching replays
-    not working since I casted WideString to PChar and gave that to ShellExecute!
-  * MapListForm's map items use doublebuffered TMapItemPanel-s. Not sure how does that impact performance (probably takes some memory etc.)!
-
-  ------ CHANGELOG ------
-
-  [moved to a separate file: trunk\Documentation\lobbychangelog.txt (SVN repository)]
-
-}
-
 { see &quot;$DEFINE DONTUSETTL2&quot; in Misc.pas! }
 { use TTL=2 when sending udp packets to keep ports open? Currently disabled because some players may be
   behind several layers of NAT and packets with TTL=2 may never reach those routers. }
@@ -213,8 +28,29 @@
   XMLDoc, ActnList, JvgHint, OpenGL1x;
 
 const
-  CommandList : array[0..36] of string =
+  RelayedCommands : array[0..17] of string =
    (
+      'UPDATEBATTLEINFO',
+      'SETSCRIPTTAGS',
+      'REMOVESTARTRECT',
+      'ADDSTARTRECT',
+      'REMOVESTARTRECT',
+      'ADDSTARTRECT',
+      'ENABLEALLUNITS',
+      'DISABLEUNITS',
+      'SETSCRIPTTAGS',
+      'FORCETEAMNO',
+      'FORCEALLYNO',
+      'FORCETEAMCOLOR',
+      'FORCESPECTATORMODE',
+      'KICKFROMBATTLE',
+      'HANDICAP',
+      'REMOVEBOT',
+      'UPDATEBOT',
+      'RING'
+    );
+  CommandList : array[0..37] of string =
+   (
       'CONNECT',
       'QUIT',
       'JOIN',
@@ -251,7 +87,8 @@
       'MSG',
       'HOOK',
       'SCRIPTSDEBUGWINDOW',
-      'FORCESTART'
+      'FORCESTART',
+      'FORCEQUIT'
    ) ;
   CountryNames: array[0..240] of string = (
   'Unknown country xx',
@@ -1818,6 +1655,8 @@
   BattleSorting: integer;
   BattleSortingDirection: Boolean;
 
+  SwitchToNewChatRoom : Boolean = false;
+
   function Dequeue: WideString; forward;
   function Enqueue(s: WideString): Integer; forward;
   function ClientSortCompare(Item1, Item2: Pointer): Integer;
@@ -2975,7 +2814,9 @@
   i: Integer;
 begin
   Result := False;
-  for i := 0 to Clients.Count-1 do if TClient(Clients[i]).GetSync &lt;&gt; 1 then Exit;
+  for i := 0 to Clients.Count-1 do
+    if (TClient(Clients[i]).GetSync &lt;&gt; 1) and (TClient(Clients[i]).GetMode = 1) then
+      Exit;
   Result := True;
 end;
 
@@ -3667,6 +3508,8 @@
   Left := 10;
   Top := 10;
 
+  BattleState.BanList := TStringList.Create;
+
   autoCompletionHint := THintWindow.Create(MainForm);
 
   MainLogCS := TCriticalSection.Create;
@@ -4523,6 +4366,10 @@
       Sleep(1000);
       MainForm.Close;
     end
+    else if (sl[0] = 'FORCEQUIT') and (HostBattleForm.relayHoster &lt;&gt; nil) then
+    begin
+      TryToSendCommand('SAYPRIVATE',HostBattleForm.relayHoster.Name+' #/quitforce');
+    end
     else if (sl[0] = 'FORCESTART') and CameFromBattleScreen and BattleForm.IsBattleActive then
     begin
       if (BattleState.Status=Hosting) and (BattleState.Battle.NATType = 1) then  // &quot;hole punching&quot; method
@@ -4554,7 +4401,6 @@
         AddMainLog(_('Cannot join - bad or no argument (don''t forget to put &quot;#&quot; in front of a channel''s name!)'), Colors.Error);
         Exit;
       end;
-
       if sl.Count = 2 then tmp := '' else tmp := ' ' + MakeSentenceWS(sl, 2);
       TryToSendCommand('JOIN', Copy(sl[1], 2, Length(sl[1])-1) + tmp);
     end
@@ -4977,7 +4823,8 @@
   Battle: TBattle;
   Client: TClient;
   Bot: TBot;
-  tmp, tmp2, hash, url: WideString;
+  tmp, tmp2, url: WideString;
+  hash: integer;
   tmpInt, tmpInt2, tmpInt3,tmpInt4: Integer;
   tmpBool, tmpBool2: Boolean;
   changed: Boolean;
@@ -5338,6 +5185,21 @@
       end;
 
       if (Status.ReceivingLoginInfo) and (Status.LastCommandReceived = 'MOTD') then LoginProgressForm.UpdateCaption(_('Receiving user list ...'));
+
+      if sl[1] = HostBattleForm.relayHosterName then
+      begin
+        HostBattleForm.relayHosterName := '';
+        HostBattleForm.relayHoster := GetClient(sl[1]);
+        if HostBattleForm.relayHoster = nil then
+        begin
+          MessageDlg(_('Couldn''t relay the host : hoster spawned does not exist'),mtWarning,[mbOk],0);
+          AddMainLog(_('Couldn''t relay the host : hoster spawned does not exist'),Colors.Error);
+        end
+        else
+        begin
+          TryToSendCommand('SAYPRIVATE',sl[1]+' '+HostBattleForm.relayHostOpenBattleCmd);
+        end;
+      end;
     end
     else if sl[0] = 'REMOVEUSER' then
     begin
@@ -5528,6 +5390,8 @@
         Exit;
       end;
 
+      if HostBattleForm.relayHoster &lt;&gt; nil then Exit;
+
       try
         index := StrToInt(sl[1]);
         Rect.Left := Round(StrToInt(sl[2])/2);
@@ -5546,7 +5410,7 @@
         Exit;
       end;
 
-      if BattleState.Status = Hosting then
+      if (BattleState.Status = Hosting) and (HostBattleForm.relayHoster = nil) then
       begin
         // this could happen due to lag (we could get this command from our previous battle, where we didn't host)
         AddMainLog(_('Error: Server sent ambiguous command!'), Colors.Error);
@@ -5585,6 +5449,8 @@
         Exit;
       end;
 
+      if HostBattleForm.relayHoster &lt;&gt; nil then Exit;
+
       if not BattleForm.IsBattleActive then
       begin
         // not a big problem. This can happen because of lag (we could get this command just after we left the battle)
@@ -5592,7 +5458,7 @@
         Exit;
       end;
 
-      if BattleState.Status = Hosting then
+      if (BattleState.Status = Hosting) and (HostBattleForm.relayHoster = nil) then
       begin
         // this could happen due to lag (we could get this command from our previous battle, where we didn't host)
         AddMainLog(_('Error: Server sent ambiguous command!'), Colors.Error);
@@ -5625,10 +5491,12 @@
       else
       begin
         i := GetTabWindowPageIndex('#' + sl[1]);
-        if i = -1 then i := AddTabWindow('#' + sl[1], True)
-        else ChangeActivePageAndUpdate(PageControl1, i);
+        if i = -1 then
+          i := AddTabWindow('#' + sl[1], SwitchToNewChatRoom)
+        else
+          ChangeActivePageAndUpdate(PageControl1, i);
 
-        AddTextToChatWindow(PageControl1.Pages[i] as TMyTabSheet, _('* Now talking in ') + PageControl1.ActivePage.Caption, Colors.ChanJoin);
+        AddTextToChatWindow(PageControl1.Pages[i] as TMyTabSheet, _('* Now talking in ') + PageControl1.ActivePage.Caption, Colors.ChanJoin,True);
       end;
     end
     else if sl[0] = 'CLIENTS' then
@@ -5779,17 +5647,17 @@
       Misc.ParseDelimited(sl2,tmp2,'\n','');
 
       if sl2.Count = 1 then
-        AddTextToChatWindow(PageControl1.Pages[i] as TMyTabSheet, _('* Topic is ''') + tmp2 + '''', Colors.Topic)
+        AddTextToChatWindow(PageControl1.Pages[i] as TMyTabSheet, _('* Topic is ''') + tmp2 + '''', Colors.Topic,True)
       else
       begin
-        AddTextToChatWindow(PageControl1.Pages[i] as TMyTabSheet, _('* Topic is ''') + sl2[0], Colors.Topic);
+        AddTextToChatWindow(PageControl1.Pages[i] as TMyTabSheet, _('* Topic is ''') + sl2[0], Colors.Topic,True);
         for j:=1 to sl2.Count-1 do
           if j=sl2.Count-1 then
-            AddTextToChatWindow(PageControl1.Pages[i] as TMyTabSheet, sl2[j] + '''', Colors.Topic)
+            AddTextToChatWindow(PageControl1.Pages[i] as TMyTabSheet, sl2[j] + '''', Colors.Topic,True)
           else
-            AddTextToChatWindow(PageControl1.Pages[i] as TMyTabSheet, sl2[j], Colors.Topic);
+            AddTextToChatWindow(PageControl1.Pages[i] as TMyTabSheet, sl2[j], Colors.Topic,True);
       end;
-      AddTextToChatWindow(PageControl1.Pages[i] as TMyTabSheet, _('* Set by ') + sl[2] + _(' on ') + tmp, Colors.Topic);
+      AddTextToChatWindow(PageControl1.Pages[i] as TMyTabSheet, _('* Set by ') + sl[2] + _(' on ') + tmp, Colors.Topic,True);
     end
     else if sl[0] = 'SAID' then
     begin
@@ -5799,15 +5667,17 @@
         Exit;
       end;
 
-      // are we ignoring this user?
-      if Preferences.UseIgnoreList then
-        if IgnoreListForm.IgnoringUser(sl[2]) then Exit; // don't display the message
-
       try
         Client := GetClient(sl[2]);
       except
         Client := nil;
       end;
+
+      // are we ignoring this user?
+      if Preferences.UseIgnoreList then
+        if IgnoreListForm.IgnoringUser(Client.Name) then Exit; // don't display the message
+
+
       if Client &lt;&gt; nil then
         tmpClientGroup := Client.GetGroup
       else
@@ -5878,6 +5748,50 @@
         Exit;
       end;
 
+      if sl[1] = HostBattleForm.relayHostManagerName then
+      begin
+        HostBattleForm.relayHosterName := '';
+        HostBattleForm.relayHostManagerName := '';
+        if sl[2] = #1 then
+        begin
+          MessageDlg(_('Couldn''t relay the host : ')+MakeSentenceWS(sl,3),mtError,[mbOk],0);
+          AddMainLog(_('Couldn''t relay the host : ')+MakeSentenceWS(sl,3),Colors.Error);
+          Exit;
+        end
+        else
+        begin
+          HostBattleForm.relayHosterName := sl[2];
+          Exit;
+        end;
+      end;
+      if sl[1] = 'RelayHostManagerList' then
+      begin
+        if sl[2] = 'managerlist' then
+        begin
+          sl2 := TWideStringList.Create;
+          ParseDelimited(sl2,sl[3],#9,'');
+          for i:=0 to sl2.Count-1 do
+          begin
+            client := GetClient(sl2[i]);
+            if (client &lt;&gt; nil) and not Client.GetInGameStatus and not Client.GetAwayStatus then
+              break;
+          end;
+
+          if i &lt; sl2.Count then
+          begin
+            HostBattleForm.relayHostManagerName := sl2[i];
+            MainForm.TryToSendCommand('SAYPRIVATE',sl2[i]+' !spawn');
+          end
+          else
+          begin
+            MessageDlg(_('No relay host are available, please try again later.'),mtWarning,[mbOk],0);
+            AddMainLog(_('No relay host are available, please try again later.'),Colors.Error);
+          end;
+
+          Exit;
+        end;
+      end;
+
       // are we ignoring this user?
       if Preferences.UseIgnoreList then
         if IgnoreListForm.IgnoringUser(sl[1]) then
@@ -5920,6 +5834,12 @@
         Exit;
       end;
 
+      if (HostBattleForm.relayHoster &lt;&gt; nil) and (sl[1] = HostBattleForm.relayHoster.Name) then
+        Exit;
+      if sl[1] = HostBattleForm.relayHostManagerName then
+        Exit;
+      if (sl[1] = 'RelayHostManagerList') and (sl[2] = '!listmanagers') then Exit;
+
       i := GetTabWindowPageIndex(sl[1]);
       if i = -1 then
       begin
@@ -6037,7 +5957,16 @@
 
       tmpBool := False;
       Misc.ShowAndSetFocus(BattleForm.InputEdit);
-      if Battle.BattleType = 0 then tmpBool := BattleForm.JoinBattle(i) else tmpBool := BattleForm.JoinBattleReplay(i);
+      if Battle.BattleType = 0 then
+        if (HostBattleForm.relayHoster &lt;&gt; nil) and (TClient(Battle.Clients[0]).Name = HostBattleForm.relayHoster.Name) then
+        begin
+          TryToSendCommand('SAYPRIVATE',HostBattleForm.relayHoster.Name+' !redirectspring 1');
+          tmpBool := BattleForm.HostBattle(i)
+        end
+        else
+          tmpBool := BattleForm.JoinBattle(i)
+      else
+        tmpBool := BattleForm.JoinBattleReplay(i);
       if tmpBool then
       begin
         Status.BattleStatusRequestReceived := False;
@@ -6198,6 +6127,9 @@
       end;
 
       if (Status.ReceivingLoginInfo) and (Status.LastCommandReceived = 'ADDUSER') then LoginProgressForm.UpdateCaption(_('Receiving battle list ...'));
+
+      if Client = HostBattleForm.relayHoster then
+        JoinBattle(Battle,false,HostBattleForm.relayHostPassword);
     end
     else if sl[0] = 'BATTLECLOSED' then
     begin
@@ -6483,7 +6415,7 @@
       begin
         for i := 0 to Battles.Count-1 do if TClient(TBattle(Battles[i]).Clients[0]).Name = Client.Name then
         begin
-          if (BattleFormUnit.BattleState.Status = Joined) and (BattleState.Battle.ID = TBattle(Battles[i]).ID) and (Client.GetInGameStatus) and changed and (not Status.AmIInGame) then
+          if (BattleState.Battle &lt;&gt; nil) and (BattleState.Battle.ID = TBattle(Battles[i]).ID) and (Client.GetInGameStatus) and changed and (not Status.AmIInGame) then
           begin
             PostMessage(BattleForm.Handle, WM_STARTGAME, 0, 0);
             // if founder of the battle we are participating in just went in-game, we must launch the game too!
@@ -7142,7 +7074,7 @@
 
       for i := 0 to (sl.Count-1) div 3 - 1 do
       begin
-        hash := sl[1 + i*3];
+        hash := StrToInt(sl[1 + i*3]);
         mapitem := FindMapItem(hash);
         if mapitem = nil then Continue;
 
@@ -7360,6 +7292,7 @@
 
   if Key = 13 then
   begin
+    SwitchToNewChatRoom := true;
     msgLines := TWideStringList.Create;
     for i:=0 to (Sender as TTntMemo).Lines.Count-1 do
     begin
@@ -7482,6 +7415,7 @@
   cList: TList;
   realIndex: integer;
 begin
+  if Status.ReceivingLoginInfo then Exit;
   if PageControl1.ActivePage.Caption = LOCAL_TAB then
     cList := AllClients
   else
@@ -7710,6 +7644,16 @@
   end
   else Result := -1;
 
+  if (HostBattleForm.relayHoster &lt;&gt; nil) and BattleForm.IsBattleActive then
+    for i:=0 to High(RelayedCommands) do
+      if UpperCase(RelayedCommands[i]) = Command then
+      begin
+        SendParams := True;
+        Params := HostBattleForm.relayHoster.Name + ' !'+LowerCase(Command)+' '+Params;
+        Command := 'SAYPRIVATE';
+        break;
+      end;
+
   s := IFF(AssignID, '#' + IntToStr(Result) + ' ', '') + UpperCase(Command) + IFF(SendParams, ' ' + Params, '');
 
   if Status.ConnectionState &lt;&gt; Connected then
@@ -7730,13 +7674,12 @@
         s := LeftStr(s,i-1);
       if s = '' then
       begin
-        ReleaseMainThread;
         exit;
       end;
     end;
-  except
+  finally
+    ReleaseMainThread;
   end;
-  ReleaseMainThread;
 
   try
     sUTF8 := UTF8Encode(s+EOL);
@@ -8205,7 +8148,8 @@
   end;
 
   i := GetTabWindowPageIndex(ClientName);
-  if i = -1 then i := AddTabWindow(ClientName, True) // switch focus to new tab
+  if i = -1 then
+    i := AddTabWindow(ClientName, True) // switch focus to new tab
   else
     if PageControl1.Pages[i].Visible then
       ChangeActivePageAndUpdate(PageControl1, i);
@@ -9218,7 +9162,7 @@
           Font.Style := [];
           TextOut(120, 10+TextHeight(MapName), _('Map size: ')+IntToStr(MapInfo.Width div 64)+'x'+IntToStr(MapInfo.Height div 64));
           TextOut(120, 10+TextHeight(MapName)*2, _('Max. metal: ')+FloatToStr(RoundTo(MapInfo.MaxMetal,-3)));
-          TextOut(120, 10+TextHeight(MapName)*3, _('Wind (min/max/avg): ')+IntToStr(MapInfo.MinWind)+'-'+IntToStr(MapInfo.MaxWind));
+          TextOut(120, 10+TextHeight(MapName)*3, _('Wind (min/max/avg): ')+IntToStr(MapInfo.MinWind)+'-'+IntToStr(MapInfo.MaxWind)+ '-' + IntToStr(Floor((MapInfo.MaxWind+MapInfo.MinWind)/2)));
           DrawMultilineText(MapInfo.Description,HintCanvas,Rect(120,10+10+TextHeight(MapName)*4,R.Right-10,R.Bottom-5),alHLeft,alVTop,JustLeft,true);
         end;
       end
@@ -9968,7 +9912,8 @@
 begin
   HostButtonMenuIndex := 0;
   BattleForm.HostButton.OnClick(nil);
-  Misc.ShowAndSetFocus(BattleForm.InputEdit);
+  if not HostBattleForm.RelayHostCheckBox.Checked then
+    Misc.ShowAndSetFocus(BattleForm.InputEdit);
 end;
 
 procedure TMainForm.mnuHostLadderBattleClick(Sender: TObject);

Modified: Lobby/TASClient/MapListFormUnit.pas
===================================================================
--- Lobby/TASClient/MapListFormUnit.pas	2009-07-07 21:26:06 UTC (rev 7287)
+++ Lobby/TASClient/MapListFormUnit.pas	2009-07-10 22:56:05 UTC (rev 7288)
@@ -105,7 +105,7 @@
     Index: Integer; // index of this map in Utility.pas' MapList list
 
     MapName: string;
-    MapHash: string; // in hexadecimal form
+    MapHash: integer; // in hexadecimal form
 
     MapInfoLoaded: Boolean;
     MapImageLoaded: Boolean;
@@ -168,7 +168,7 @@
 
   function CompareMapItems(Item1, Item2: Pointer): Integer;
   function GetMapItem(Index: Integer): TMapItem;
-  function FindMapItem(Hash: string): TMapItem; // returns nil if not found
+  function FindMapItem(Hash: integer): TMapItem; // returns nil if not found
 
 var
   MapListForm: TMapListForm;
@@ -199,7 +199,7 @@
   Result := TMapItem(MapListForm.Maps[Index]);
 end;
 
-function FindMapItem(Hash: string): TMapItem; // returns nil if not found
+function FindMapItem(Hash: integer): TMapItem; // returns nil if not found
 var
   i: Integer;
 begin
@@ -248,7 +248,7 @@
 begin
   Self.Index := Index;
   Self.MapName := Utility.MapList[Index];
-  Self.MapHash := Utility.MapChecksums[Index];
+  Self.MapHash := Utility.MapChecksums.Items[Index];
 
   MyGrade := 0;
   GlobalGrade := 0;
@@ -473,7 +473,7 @@
 begin
   Result := False;
 
-  Filename := MAPS_CACHE_FOLDER + '\' + MapHash + '.info';
+  Filename := MAPS_CACHE_FOLDER + '\' + IntToStr(MapHash) + '.info';
   if not FileExists(Filename) then Exit;
 
   try
@@ -526,7 +526,7 @@
 begin
   Result := False;
 
-  Filename := MAPS_CACHE_FOLDER + '\' + MapHash + '.info';
+  Filename := MAPS_CACHE_FOLDER + '\' + IntToStr(MapHash) + '.info';
 
   try
     Stream := TFileStream.Create(FileName, fmCreate);
@@ -567,7 +567,7 @@
 begin
   Result := False;
 
-  Filename := MAPS_CACHE_FOLDER + '\' + MapHash + '.mini';
+  Filename := MAPS_CACHE_FOLDER + '\' + IntToStr(MapHash) + '.mini';
   if not FileExists(Filename) then Exit;
 
   try
@@ -590,7 +590,7 @@
 begin
   Result := False;
 
-  Filename := MAPS_CACHE_FOLDER + '\' + MapHash + '.mini';
+  Filename := MAPS_CACHE_FOLDER + '\' + IntToStr(MapHash) + '.mini';
 
   try
     Stream := TFileStream.Create(FileName, fmCreate);
@@ -971,7 +971,7 @@
   // generate MAPGRADES command:
   params := '';
   for i := 0 to Maps.Count-1 do
-    params := params + ' ' + GetMapItem(i).MapHash + ' ' + IntToStr(GetMapItem(i).MyGrade);
+    params := params + ' ' + IntToStr(GetMapItem(i).MapHash) + ' ' + IntToStr(GetMapItem(i).MyGrade);
   Delete(params, 1, 1); // remove the first space character 
   MainForm.TryToSendCommand('MAPGRADES', params);
 

Modified: Lobby/TASClient/MenuFormUnit.pas
===================================================================
--- Lobby/TASClient/MenuFormUnit.pas	2009-07-07 21:26:06 UTC (rev 7287)
+++ Lobby/TASClient/MenuFormUnit.pas	2009-07-10 22:56:05 UTC (rev 7288)
@@ -570,7 +570,7 @@
       with TMapItem(MapListForm.SortedMaps[i]) do
       begin
         tmp := StringReplace(tmp,'[MapID]',IntToStr(Index),[rfReplaceAll,rfIgnoreCase]);
-        tmp := StringReplace(tmp,'[MapMiniMapUrl]',ExtractFilePath(Application.ExeName)+MAPS_CACHE_FOLDER+'\'+MapHash+'.mini',[rfReplaceAll,rfIgnoreCase]);
+        tmp := StringReplace(tmp,'[MapMiniMapUrl]',ExtractFilePath(Application.ExeName)+MAPS_CACHE_FOLDER+'\'+IntToStr(MapHash)+'.mini',[rfReplaceAll,rfIgnoreCase]);
         tmp := StringReplace(tmp,'[MapName]',MapName,[rfReplaceAll,rfIgnoreCase]);
         tmp := StringReplace(tmp,'[MapDescription]',MapInfo.Description,[rfReplaceAll,rfIgnoreCase]);
         tmp := StringReplace(tmp,'[MapTidalStrength]',IntToStr(MapInfo.TidalStrength),[rfReplaceAll,rfIgnoreCase]);
@@ -1226,7 +1226,7 @@
   script := TScript.Create('');
 
   script.AddOrChangeKeyValue('GAME/Mapname',Utility.MapList[BattleForm.CurrentMapIndex]);
-  Script.AddOrChangeKeyValue('GAME/Maphash',IntToStr(Misc.HexToInt(Utility.MapChecksums[BattleForm.CurrentMapIndex])));
+  Script.AddOrChangeKeyValue('GAME/Maphash',IntToStr(Utility.MapChecksums.Items[BattleForm.CurrentMapIndex]));
   if BattleForm.CurrentModName = '' then
   begin
     MessageDlg(_('You must select a mod first.'),mtWarning,[mbOk],0);

Modified: Lobby/TASClient/PreferencesFormUnit.dfm
===================================================================
--- Lobby/TASClient/PreferencesFormUnit.dfm	2009-07-07 21:26:06 UTC (rev 7287)
+++ Lobby/TASClient/PreferencesFormUnit.dfm	2009-07-10 22:56:05 UTC (rev 7288)
@@ -3,7 +3,7 @@
   Top = 126
   BorderStyle = bsDialog
   Caption = 'Preferences'
-  ClientHeight = 483
+  ClientHeight = 403
   ClientWidth = 415
   Color = clBtnFace
   Constraints.MaxHeight = 750
@@ -25,7 +25,7 @@
     Left = 0
     Top = 0
     Width = 415
-    Height = 483
+    Height = 403
     Caption = 'Preferences'
     FixedSize = True
     Options.Minimize = False

Modified: Lobby/TASClient/PreferencesFormUnit.pas
===================================================================
--- Lobby/TASClient/PreferencesFormUnit.pas	2009-07-07 21:26:06 UTC (rev 7287)
+++ Lobby/TASClient/PreferencesFormUnit.pas	2009-07-10 22:56:05 UTC (rev 7288)
@@ -520,6 +520,7 @@
     try HostBattleForm.ModsComboBox.ItemIndex := Max(0, HostBattleForm.ModsComboBox.Items.IndexOf(Misc.GetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\HostBattleForm', 'Mod'))); except end;
     try HostBattleForm.NATRadioGroup.ItemIndex := Misc.GetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\HostBattleForm', 'NATTechnique'); except end;
     try HostBattleForm.PlayersTracker.Value := Misc.GetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\HostBattleForm', 'NbPlayer'); except end;
+    try HostBattleForm.RelayHostCheckBox.Checked := Misc.GetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\HostBattleForm', 'RelayHost'); except end;
 
     try MapListForm.Left := Misc.GetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\MapListForm', 'Left'); except end;
     try MapListForm.Top := Misc.GetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\MapListForm', 'Top'); except end;
@@ -630,6 +631,7 @@
     Misc.SetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\HostBattleForm', 'Mod', rdString, HostBattleForm.ModsComboBox.Text);
     Misc.SetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\HostBattleForm', 'NATTechnique', rdInteger, HostBattleForm.NATRadioGroup.ItemIndex);
     Misc.SetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\HostBattleForm', 'NbPlayer', rdInteger, HostBattleForm.PlayersTracker.Value);
+    Misc.SetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Forms\HostBattleForm', 'RelayHost', rdInteger, Misc.BoolToInt(HostBattleForm.RelayHostCheckBox.Checked));
 
 
     Pl.Length := SizeOf(TWindowPlacement);

Modified: Lobby/TASClient/ReplaysUnit.pas
===================================================================
--- Lobby/TASClient/ReplaysUnit.pas	2009-07-07 21:26:06 UTC (rev 7287)
+++ Lobby/TASClient/ReplaysUnit.pas	2009-07-10 22:56:05 UTC (rev 7288)
@@ -2861,9 +2861,9 @@
           Font.Style := [fsBold];
           TextOut(120, 10, MapName);
           Font.Style := [];
-          TextOut(120, 10+TextHeight(MapName), 'Map size: '+IntToStr(MapInfo.Width div 64)+'x'+IntToStr(MapInfo.Height div 64));
-          TextOut(120, 10+TextHeight(MapName)*2, 'Max. metal: '+FloatToStr(RoundTo(MapInfo.MaxMetal,-3)));
-          TextOut(120, 10+TextHeight(MapName)*3, 'Wind (min/max/avg): '+IntToStr(MapInfo.MinWind)+'-'+IntToStr(MapInfo.MaxWind)+ '-' + IntToStr(Floor((MapInfo.MaxWind+MapInfo.MinWind)/2)));
+          TextOut(120, 10+TextHeight(MapName), _('Map size: ')+IntToStr(MapInfo.Width div 64)+'x'+IntToStr(MapInfo.Height div 64));
+          TextOut(120, 10+TextHeight(MapName)*2, _('Max. metal: ')+FloatToStr(RoundTo(MapInfo.MaxMetal,-3)));
+          TextOut(120, 10+TextHeight(MapName)*3, _('Wind (min/max/avg): ')+IntToStr(MapInfo.MinWind)+'-'+IntToStr(MapInfo.MaxWind)+ '-' + IntToStr(Floor((MapInfo.MaxWind+MapInfo.MinWind)/2)));
           DrawMultilineText(MapInfo.Description,HintCanvas,Rect(120,10+10+TextHeight(MapName)*4,R.Right-10,R.Bottom-5),alHLeft,alVTop,JustLeft,true);
         end;
       end;

Modified: Lobby/TASClient/TASClient.dof
===================================================================
--- Lobby/TASClient/TASClient.dof	2009-07-07 21:26:06 UTC (rev 7287)
+++ Lobby/TASClient/TASClient.dof	2009-07-10 22:56:05 UTC (rev 7288)
@@ -100,7 +100,7 @@
 DebugSourceDirs=
 UsePackages=0
 [Parameters]
-RunParams=-inifile &quot;C:\Program Files\Spring\TASClient.ini&quot;
+RunParams=
 HostApplication=C:\Program Files\Spring\TASClient.exe
 Launcher=
 UseLauncher=0
@@ -115,7 +115,7 @@
 MajorVer=0
 MinorVer=50
 Release=0
-Build=635
+Build=637
 Debug=0
 PreRelease=0
 Special=0
@@ -126,7 +126,7 @@
 [Version Info Keys]
 CompanyName=
 FileDescription=Spring RTS Engine lobby client
-FileVersion=0.50.0.635
+FileVersion=0.50.0.637
 InternalName=
 LegalCopyright=
 LegalTrademarks=

Modified: Lobby/TASClient/TASClient.res
===================================================================
(Binary files differ)

Modified: Lobby/TASClient/Utility.pas
===================================================================
--- Lobby/TASClient/Utility.pas	2009-07-07 21:26:06 UTC (rev 7287)
+++ Lobby/TASClient/Utility.pas	2009-07-10 22:56:05 UTC (rev 7288)
@@ -8,7 +8,7 @@
 interface
 
 uses
-  Windows, Graphics, Classes, SyncObjs, Controls,Math,MainUnit,OpenIL,gnugettext;
+  Windows, Graphics, Classes, SyncObjs, Controls,Math,MainUnit,OpenIL,gnugettext,class_TIntegerList;
 
 type
 
@@ -236,7 +236,7 @@
   SideImageList: TImageList; // images of sides. Also see SideList
 
   MapList: TStringList;
-  MapChecksums: TStringList;
+  MapChecksums: TIntegerList;
   MapMainArchive: TStringList;
 
   LastInitSuccess: Boolean = True; // check this var to see if last call to InitLib/ReInitLib was successful!
@@ -375,16 +375,16 @@
        MainForm.AddMainLog(Format(_('Skipping map file: %s (bad checksum)'),[MapName]), Colors.Error);
        Continue;
      end;
-     if MapCheckSums.IndexOf(IntToHex(CheckSum, 8)) &lt;&gt; -1 then
+     if MapCheckSums.IndexOf(CheckSum) &lt;&gt; -1 then
      begin
-       MainForm.AddMainLog(Format(_('Skipping map file: &quot;%s&quot;, duplicate checksum of file &quot;%s&quot;'),[MapName, ExtractFileName(MapMainArchive[MapCheckSums.IndexOf(IntToHex(CheckSum, 8))])]), Colors.Error);
+       MainForm.AddMainLog(Format(_('Skipping map file: &quot;%s&quot;, duplicate checksum of file &quot;%s&quot;'),[MapName, ExtractFileName(MapMainArchive[MapCheckSums.IndexOf(CheckSum)])]), Colors.Error);
        Continue;
      end;
 
      // add map to the map list:
      if UpdateSplashScreen then SplashScreenForm.UpdateText(_('loading map (') + MapName + ')');
      MapList.Add(MapName);
-     MapCheckSums.Add(IntToHex(CheckSum, 8));
+     MapCheckSums.Add(CheckSum);
      MapMainArchive.Add(GetMapArchiveName(0));
      MapListForm.AddMap;
 
@@ -1137,7 +1137,7 @@
   SideList.CaseSensitive := False;
   SideImageList := TImageList.CreateSize(16, 16);
   MapList := TStringList.Create;
-  MapChecksums := TStringList.Create;
+  MapChecksums := TIntegerList.Create;
   MapMainArchive := TStringList.Create;
 
 finalization


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002057.html">[Taspring-linux-commit] r7287 - Lobby/TASClient
</A></li>
	<LI>Next message: <A HREF="002059.html">[Taspring-linux-commit] r7289 - Lobby/TASClient
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2058">[ date ]</a>
              <a href="thread.html#2058">[ thread ]</a>
              <a href="subject.html#2058">[ subject ]</a>
              <a href="author.html#2058">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
