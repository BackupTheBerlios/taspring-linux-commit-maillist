<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Taspring-linux-commit] r7563 - Lobby/TASClient
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/taspring-linux-commit/2011-January/index.html" >
   <LINK REL="made" HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r7563%20-%20Lobby/TASClient&In-Reply-To=%3C20110104004006.ECC1F230C4%40it-l.eu%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="002334.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Taspring-linux-commit] r7563 - Lobby/TASClient</H1>
    <B>taspring-linux-commit at lists.berlios.de</B> 
    <A HREF="mailto:taspring-linux-commit%40lists.berlios.de?Subject=Re%3A%20%5BTaspring-linux-commit%5D%20r7563%20-%20Lobby/TASClient&In-Reply-To=%3C20110104004006.ECC1F230C4%40it-l.eu%3E"
       TITLE="[Taspring-linux-commit] r7563 - Lobby/TASClient">taspring-linux-commit at lists.berlios.de
       </A><BR>
    <I>Tue Jan  4 01:40:05 CET 2011</I>
    <P><UL>
        
        <LI>Next message: <A HREF="002334.html">[Taspring-linux-commit] r7564 - Lobby/TASClient
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2333">[ date ]</a>
              <a href="thread.html#2333">[ thread ]</a>
              <a href="subject.html#2333">[ subject ]</a>
              <a href="author.html#2333">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: satirik
Date: 2011-01-04 01:40:03 +0100 (Tue, 04 Jan 2011)
New Revision: 7563

Modified:
   Lobby/TASClient/BattleFormUnit.dfm
   Lobby/TASClient/BattleFormUnit.pas
   Lobby/TASClient/IgnoreListUnit.dfm
   Lobby/TASClient/IgnoreListUnit.pas
   Lobby/TASClient/LobbyScriptUnit.pas
   Lobby/TASClient/MainUnit.dfm
   Lobby/TASClient/MainUnit.pas
   Lobby/TASClient/ManageGroups.dfm
   Lobby/TASClient/ManageGroups.pas
   Lobby/TASClient/PreferencesFormUnit.pas
   Lobby/TASClient/TASClient.dof
   Lobby/TASClient/TASClient.res
Log:
* asc/desc option added to players list sorting
* all the players data are stored in one single file now : UsersData.ini (renames.ini and ignorelist.dat are not used anymore but will be automatically imported)
* a player can be renamed to his current name (to force his name even if he renames)
* players' name history are stored and displayed in the players hints
* offline players are now displayed in the groups users list

Modified: Lobby/TASClient/BattleFormUnit.dfm
===================================================================
--- Lobby/TASClient/BattleFormUnit.dfm	2010-12-26 15:57:24 UTC (rev 7562)
+++ Lobby/TASClient/BattleFormUnit.dfm	2011-01-04 00:40:03 UTC (rev 7563)
@@ -1,6 +1,6 @@
 object BattleForm: TBattleForm
-  Left = 620
-  Top = 330
+  Left = 796
+  Top = 324
   Width = 923
   Height = 638
   Caption = 'Battle window'
@@ -12758,10 +12758,11 @@
         Align = alClient
         BiDiMode = bdLeftToRight
         ParentBiDiMode = False
-        ActiveTabIndex = 2
+        ActiveTabIndex = 0
         OnActiveTabChange = SpTBXTabControl1ActiveTabChange
         HiddenItems = &lt;&gt;
         object QuickLookTab: TSpTBXTabItem
+          Checked = True
           ImageIndex = 1
           Images = MainForm.ArrowList
           CustomWidth = 40
@@ -12775,7 +12776,6 @@
         object DisabledUnitsTab: TSpTBXTabItem
           Caption = 'Disabled Units (0)'
           Wrapping = twWrap
-          Checked = True
           CustomWidth = 94
         end
         object MapTab: TSpTBXTabItem
@@ -12922,6 +12922,77 @@
             end
           end
         end
+        object SpTBXTabSheet1: TSpTBXTabSheet
+          Left = 0
+          Top = 39
+          Width = 417
+          Height = 234
+          Caption = 'Disabled Units (0)'
+          ImageIndex = -1
+          DesignSize = (
+            417
+            234)
+          TabItem = 'DisabledUnitsTab'
+          object UnitsGroupBox: TSpTBXGroupBox
+            Left = 8
+            Top = 4
+            Width = 401
+            Height = 227
+            Caption = 'Disabled units'
+            Anchors = [akLeft, akTop, akBottom]
+            TabOrder = 0
+            TBXStyleBackground = True
+            DesignSize = (
+              401
+              227)
+            object VDTDisabledUnits: TVirtualDrawTree
+              Left = 16
+              Top = 32
+              Width = 369
+              Height = 183
+              Anchors = [akLeft, akTop, akRight, akBottom]
+              DefaultNodeHeight = 64
+              Header.AutoSizeIndex = 1
+              Header.DefaultHeight = 17
+              Header.Font.Charset = DEFAULT_CHARSET
+              Header.Font.Color = clWindowText
+              Header.Font.Height = -11
+              Header.Font.Name = 'MS Sans Serif'
+              Header.Font.Style = []
+              Header.Options = [hoAutoResize, hoColumnResize, hoDrag]
+              TabOrder = 0
+              TreeOptions.MiscOptions = [toAcceptOLEDrop, toCheckSupport, toFullRepaintOnResize, toInitOnSave, toToggleOnDblClick, toWheelPanning, toEditOnClick]
+              TreeOptions.PaintOptions = [toHideFocusRect, toHotTrack, toShowButtons, toShowDropmark, toThemeAware, toUseBlendedImages]
+              TreeOptions.SelectionOptions = [toFullRowSelect]
+              OnDrawNode = VDTDisabledUnitsDrawNode
+              Columns = &lt;
+                item
+                  Position = 0
+                  Width = 64
+                  WideText = 'Icon'
+                end
+                item
+                  Position = 1
+                  Width = 201
+                  WideText = 'FullName'
+                end
+                item
+                  Position = 2
+                  Width = 100
+                  WideText = 'Code name'
+                end&gt;
+            end
+            object AddUnitsSpeedButton: TSpTBXButton
+              Left = 232
+              Top = 10
+              Width = 153
+              Height = 22
+              Caption = 'Add more units'
+              TabOrder = 1
+              OnClick = AddUnitsSpeedButtonClick
+            end
+          end
+        end
         object SpTBXTabSheet2: TSpTBXTabSheet
           Left = 0
           Top = 39
@@ -13138,77 +13209,6 @@
             OnMouseMove = QuickLookRichEditMouseMove
           end
         end
-        object SpTBXTabSheet1: TSpTBXTabSheet
-          Left = 0
-          Top = 39
-          Width = 417
-          Height = 234
-          Caption = 'Disabled Units (0)'
-          ImageIndex = -1
-          DesignSize = (
-            417
-            234)
-          TabItem = 'DisabledUnitsTab'
-          object UnitsGroupBox: TSpTBXGroupBox
-            Left = 8
-            Top = 4
-            Width = 401
-            Height = 227
-            Caption = 'Disabled units'
-            Anchors = [akLeft, akTop, akBottom]
-            TabOrder = 0
-            TBXStyleBackground = True
-            DesignSize = (
-              401
-              227)
-            object VDTDisabledUnits: TVirtualDrawTree
-              Left = 16
-              Top = 32
-              Width = 369
-              Height = 183
-              Anchors = [akLeft, akTop, akRight, akBottom]
-              DefaultNodeHeight = 64
-              Header.AutoSizeIndex = 1
-              Header.DefaultHeight = 17
-              Header.Font.Charset = DEFAULT_CHARSET
-              Header.Font.Color = clWindowText
-              Header.Font.Height = -11
-              Header.Font.Name = 'MS Sans Serif'
-              Header.Font.Style = []
-              Header.Options = [hoAutoResize, hoColumnResize, hoDrag]
-              TabOrder = 0
-              TreeOptions.MiscOptions = [toAcceptOLEDrop, toCheckSupport, toFullRepaintOnResize, toInitOnSave, toToggleOnDblClick, toWheelPanning, toEditOnClick]
-              TreeOptions.PaintOptions = [toHideFocusRect, toHotTrack, toShowButtons, toShowDropmark, toThemeAware, toUseBlendedImages]
-              TreeOptions.SelectionOptions = [toFullRowSelect]
-              OnDrawNode = VDTDisabledUnitsDrawNode
-              Columns = &lt;
-                item
-                  Position = 0
-                  Width = 64
-                  WideText = 'Icon'
-                end
-                item
-                  Position = 1
-                  Width = 201
-                  WideText = 'FullName'
-                end
-                item
-                  Position = 2
-                  Width = 100
-                  WideText = 'Code name'
-                end&gt;
-            end
-            object AddUnitsSpeedButton: TSpTBXButton
-              Left = 232
-              Top = 10
-              Width = 153
-              Height = 22
-              Caption = 'Add more units'
-              TabOrder = 1
-              OnClick = AddUnitsSpeedButtonClick
-            end
-          end
-        end
       end
     end
   end

Modified: Lobby/TASClient/BattleFormUnit.pas
===================================================================
--- Lobby/TASClient/BattleFormUnit.pas	2010-12-26 15:57:24 UTC (rev 7562)
+++ Lobby/TASClient/BattleFormUnit.pas	2011-01-04 00:40:03 UTC (rev 7563)
@@ -5739,6 +5739,7 @@
   RealIndex: Integer;
   WhatToDraw: TClientNodeType;
   h: String;
+  nameHistory: TWideStringList;
 begin
   if (Node = nil) then
     Exit;
@@ -5761,6 +5762,12 @@
           h := h + ' - ' + Utility.SideList[TClient(BattleState.Battle.Clients[RealIndex]).GetSide];
         if TClient(BattleState.Battle.Clients[RealIndex]).GetGroup &lt;&gt; nil then
           h := h + ', ' + TClient(BattleState.Battle.Clients[RealIndex]).GetGroup.Name;
+
+        // name history
+        nameHistory := TClient.GetNameHistory(TClient(BattleState.Battle.Clients[RealIndex]).Id);
+        if nameHistory.Count &gt; 0 then
+          h := h + _(' (A.K.A. : ') + nameHistory.CommaText + ')';
+
         Canvas.Font := VDTBattleClients.Font;
         TextOut(5, 2, h);
       except
@@ -5797,6 +5804,7 @@
   RealIndex: Integer;
   WhatToDraw: TClientNodeType;
   h: String;
+  nameHistory: TWideStringList;
 begin
   if (Node = nil) then
     Exit;
@@ -5815,6 +5823,12 @@
           h := h + ' - ' + Utility.SideList[TClient(BattleState.Battle.Clients[RealIndex]).GetSide];
         if TClient(BattleState.Battle.Clients[RealIndex]).GetGroup &lt;&gt; nil then
           h := h + ', ' + TClient(BattleState.Battle.Clients[RealIndex]).GetGroup.Name;
+
+        // name history
+        nameHistory := TClient.GetNameHistory(TClient(BattleState.Battle.Clients[RealIndex]).Id);
+        if nameHistory.Count &gt; 0 then
+          h := h + _(' (A.K.A. : ') + nameHistory.CommaText + ')';
+
         Canvas.Font := VDTBattleClients.Font;
         R := Rect(0, 0, Round(Canvas.TextWidth(h)), 18);
       except

Modified: Lobby/TASClient/IgnoreListUnit.dfm
===================================================================
--- Lobby/TASClient/IgnoreListUnit.dfm	2010-12-26 15:57:24 UTC (rev 7562)
+++ Lobby/TASClient/IgnoreListUnit.dfm	2011-01-04 00:40:03 UTC (rev 7563)
@@ -1,8 +1,8 @@
 object IgnoreListForm: TIgnoreListForm
-  Left = 479
-  Top = 149
+  Left = 1183
+  Top = 694
   Width = 307
-  Height = 417
+  Height = 295
   BorderIcons = [biSystemMenu]
   Caption = 'Ignore list'
   Color = clBtnFace
@@ -15,31 +15,20 @@
   Font.Style = []
   OldCreateOrder = False
   Position = poOwnerFormCenter
-  OnClose = FormClose
   OnCreate = FormCreate
+  OnShow = FormShow
   PixelsPerInch = 96
   TextHeight = 13
   object SpTBXTitleBar1: TSpTBXTitleBar
     Left = 0
     Top = 0
     Width = 299
-    Height = 390
+    Height = 268
     Caption = 'Ignore list'
     Active = False
     FixedSize = True
     Options.Minimize = False
     Options.Maximize = False
-    object SpTBXLabel1: TSpTBXLabel
-      Left = 24
-      Top = 280
-      Width = 249
-      Height = 49
-      Caption = 
-        'Note: ignoring a user means filtering out his channel and privat' +
-        'e messages, but not his battle window messages'
-      AutoSize = False
-      Wrapping = twWrap
-    end
     object EnableIgnoresCheckBox: TSpTBXCheckBox
       Left = 24
       Top = 48
@@ -52,20 +41,27 @@
       Font.Name = 'MS Sans Serif'
       Font.Style = [fsBold]
       ParentFont = False
-      TabOrder = 2
+      TabOrder = 1
     end
     object DoneButton: TSpTBXButton
       Left = 104
-      Top = 344
+      Top = 232
       Width = 89
       Height = 25
       Caption = 'Done'
-      TabOrder = 3
+      TabOrder = 2
       OnClick = DoneButtonClick
       Cancel = True
     end
-    object IgnoreListBox: TSpTBXCheckListBox
+    object SpTBXLabel3: TSpTBXLabel
       Left = 24
+      Top = 72
+      Width = 215
+      Height = 13
+      Caption = '(To remove item, select it and press DELETE)'
+    end
+    object IgnoreListBox: TSpTBXListBox
+      Left = 24
       Top = 88
       Width = 249
       Height = 137
@@ -73,40 +69,5 @@
       TabOrder = 4
       OnKeyUp = IgnoreListBoxKeyUp
     end
-    object AddIgnoreEdit: TSpTBXEdit
-      Left = 24
-      Top = 232
-      Width = 177
-      Height = 21
-      TabOrder = 5
-    end
-    object AddButton: TSpTBXSpeedButton
-      Left = 200
-      Top = 232
-      Width = 73
-      Height = 22
-      Caption = 'Add'
-      OnClick = AddButtonClick
-    end
-    object SpTBXLabel2: TSpTBXLabel
-      Left = 24
-      Top = 256
-      Width = 169
-      Height = 13
-      Caption = '(all names are case-sensitive)'
-      Font.Charset = DEFAULT_CHARSET
-      Font.Color = clWindowText
-      Font.Height = -11
-      Font.Name = 'MS Sans Serif'
-      Font.Style = [fsBold]
-      ParentFont = False
-    end
-    object SpTBXLabel3: TSpTBXLabel
-      Left = 24
-      Top = 72
-      Width = 215
-      Height = 13
-      Caption = '(To remove item, select it and press DELETE)'
-    end
   end
 end

Modified: Lobby/TASClient/IgnoreListUnit.pas
===================================================================
--- Lobby/TASClient/IgnoreListUnit.pas	2010-12-26 15:57:24 UTC (rev 7562)
+++ Lobby/TASClient/IgnoreListUnit.pas	2011-01-04 00:40:03 UTC (rev 7563)
@@ -5,38 +5,27 @@
 uses
   Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
   Dialogs, SpTBXItem, SpTBXControls, StdCtrls, CheckLst,
-  TntCheckLst, SpTBXEditors,Misc, StrUtils,MainUnit;
+  TntCheckLst, SpTBXEditors,Misc, StrUtils,MainUnit, TntStdCtrls;
 
 type
   TIgnoreListForm = class(TForm)
     SpTBXTitleBar1: TSpTBXTitleBar;
-    SpTBXLabel1: TSpTBXLabel;
     EnableIgnoresCheckBox: TSpTBXCheckBox;
     DoneButton: TSpTBXButton;
-    IgnoreListBox: TSpTBXCheckListBox;
-    AddIgnoreEdit: TSpTBXEdit;
-    AddButton: TSpTBXSpeedButton;
-    SpTBXLabel2: TSpTBXLabel;
+    IgnoreListBox: TSpTBXListBox;
     SpTBXLabel3: TSpTBXLabel;
 
     procedure CreateParams(var Params: TCreateParams); override;
-
-    procedure SaveIgnoreListToFile(FileName: string);
-    procedure LoadIgnoreListFromFile(FileName: string);
-    function IgnoringUser(client: TClient): Boolean; // are we ignoring user Username?
-    procedure AddToIgnoreList(Username: string);
-    procedure RemoveFromIgnoreList(Client: TClient);
-
     procedure DoneButtonClick(Sender: TObject);
-    procedure AddButtonClick(Sender: TObject);
     procedure IgnoreListBoxKeyUp(Sender: TObject; var Key: Word;
       Shift: TShiftState);
     procedure FormCreate(Sender: TObject);
-    procedure FormClose(Sender: TObject; var Action: TCloseAction);
+    procedure FormShow(Sender: TObject);
   private
     { Private declarations }
   public
-    { Public declarations }
+    procedure LoadIgnoreListFromFile(FileName: string);
+    function AddOfflineClientToIgnoreList(userName: WideString):Boolean;
   end;
 
 var
@@ -60,39 +49,20 @@
   end;
 end;
 
-procedure TIgnoreListForm.SaveIgnoreListToFile(FileName: string);
-var
-  f: TextFile;
-  i: Integer;
-begin
-  {$I+}
-  try
-    AssignFile(f, FileName);
-    Rewrite(f);
-
-    for i := 0 to IgnoreListBox.Items.Count-1 do
-    begin
-      if IgnoreListBox.Checked[i] then Write(f, #1) else Write(f, #0);
-      Writeln(f, IgnoreListBox.Items[i]);
-    end;
-
-    CloseFile(f);
-  except
-    Exit;
-  end;
-end;
-
 procedure TIgnoreListForm.LoadIgnoreListFromFile(FileName: string);
 var
   f: TextFile;
   s: string;
   checked: Boolean;
+  sl: TStringList;
 begin
   {$I+}
   try
     AssignFile(f, FileName);
     Reset(f);
 
+    sl := TStringList.Create;
+
     while not Eof(f) do
     begin
       Readln(f, s);
@@ -100,118 +70,87 @@
 
       checked := s[1] = #1;
       s := Copy(s, 2, Length(s)-1);
-      IgnoreListBox.Items.Add(s);
-      IgnoreListBox.Checked[IgnoreListBox.Items.Count-1] := checked;
+
+      sl.Delimiter := ' ';
+      sl.DelimitedText := s;
+      TClient.SetIsIgnored(StrToInt(sl[0]),checked);
     end;
 
-    CloseFile(f);
   except
     Exit;
   end;
 end;
 
+function TIgnoreListForm.AddOfflineClientToIgnoreList(userName: WideString):Boolean;
+var
+  sl: TStringList;
+  i: integer;
+begin
+  Result := False;
+  try
+    sl := TStringList.Create;
+    ClientsDataIni.ReadSections(sl);
+    for i:=0 to sl.Count-1 do
+    begin
+      if LowerCase(userName) = TClient.GetLatestName(StrToInt(sl[i])) then
+      begin
+        TClient.SetIsIgnored(StrToInt(sl[i]),True);
+        Result := True;
+        Exit;
+      end;
+    end;
+  except
+    MainForm.AddMainLog(_('Error: Corrupted clients data file.'),Colors.Error);
+  end;
+end;
+
 procedure TIgnoreListForm.DoneButtonClick(Sender: TObject);
 begin
   Preferences.UseIgnoreList := EnableIgnoresCheckBox.Checked;
   Close;
 end;
 
-procedure TIgnoreListForm.AddButtonClick(Sender: TObject);
-begin
-  IgnoreListBox.Items.Add(AddIgnoreEdit.Text);
-  IgnoreListBox.Checked[IgnoreListBox.Items.Count-1] := True;
-  AddIgnoreEdit.Text := '';
-end;
-
 procedure TIgnoreListForm.IgnoreListBoxKeyUp(Sender: TObject;
   var Key: Word; Shift: TShiftState);
+var
+  client: TClient;
 begin
   if IgnoreListBox.ItemIndex = -1 then Exit;
 
   if Key = VK_DELETE then
-    IgnoreListBox.Items.Delete(IgnoreListBox.ItemIndex);
-end;
-
-function TIgnoreListForm.IgnoringUser(client: TClient): Boolean; // are we ignoring user Username?
-var
-  i,j: Integer;
-  Id: integer;
-  Username: string;
-begin
-  for i := 0 to IgnoreListBox.Count-1 do
   begin
-    j := Pos(' ',IgnoreListBox.Items[i]);
-    if j&gt;0 then
-    begin
-      Id := StrToInt(LeftStr(IgnoreListBox.Items[i],j-1));
-      if Id = client.Id then
-      begin
-        Result := IgnoreListBox.Checked[i];
-        Exit;
-      end;
-    end
+    client := MainForm.GetClient(IgnoreListBox.Items[IgnoreListBox.ItemIndex]);
+    if client &lt;&gt; nil then
+      client.isIgnored := False
     else
-      if LowerCase(IgnoreListBox.Items[i]) = LowerCase(client.Name) then
-      begin
-        Result := IgnoreListBox.Checked[i];
-        IgnoreListBox.Items[i] := IntToStr(client.Id)+' '+client.Name;
-        Exit;
-      end;
+      AddOfflineClientToIgnoreList(IgnoreListBox.Items[IgnoreListBox.ItemIndex]);
   end;
-
-  Result := False;
 end;
 
-procedure TIgnoreListForm.AddToIgnoreList(Username: string);
-var
-  i: Integer;
-  client: TClient;
-  idStr: string;
+procedure TIgnoreListForm.FormCreate(Sender: TObject);
 begin
-  client := MainForm.GetClient(Username);
-  if client &lt;&gt; nil then
-  begin
-    idStr := IntToStr(client.Id);
-    for i:=0 to IgnoreListBox.Count-1 do
-      if LeftStr(IgnoreListBox.Items[i],Length(idStr)) = idStr then
-       Exit;
-
-    IgnoreListBox.Items.Add(IntToStr(client.Id)+' '+Username)
-  end
-  else
-  begin
-    for i:=0 to IgnoreListBox.Count-1 do
-      if LowerCase(RightStr(IgnoreListBox.Items[i],Length(Username))) = LowerCase(Username) then
-       Exit;
-    IgnoreListBox.Items.Add(Username);
-  end;
-  IgnoreListBox.Checked[IgnoreListBox.Items.Count-1] := True;
-  SaveIgnoreListToFile(ExtractFilePath(Application.ExeName) + VAR_FOLDER + '\ignorelist.dat');
+  TranslateComponent(self);
 end;
 
-procedure TIgnoreListForm.RemoveFromIgnoreList(Client: TClient);
+procedure TIgnoreListForm.FormShow(Sender: TObject);
 var
-  i: Integer;
-  idStr: string;
+  sl: TStringList;
+  i: integer;
 begin
-  idStr := IntToStr(client.Id);
-  for i:=0 to IgnoreListBox.Count-1 do
-    if LeftStr(IgnoreListBox.Items[i],Length(idStr)) = idStr then
+  IgnoreListBox.Clear;
+  sl := TStringList.Create;
+  try
+    ClientsDataIni.ReadSections(sl);
+    for i:=0 to sl.Count-1 do
     begin
-      IgnoreListBox.Items.Delete(i);
-      SaveIgnoreListToFile(ExtractFilePath(Application.ExeName) + VAR_FOLDER + '\ignorelist.dat');
+      if TClient.GetIsIgnored(StrToInt(sl[i])) then
+      begin
+        IgnoreListBox.Items.Add(TClient.GetLatestName(StrToInt(sl[i])));
+      end;
     end;
+  except
+    MainForm.AddMainLog(_('Error: Corrupted clients data file.'),Colors.Error);
+  end;
 end;
 
-procedure TIgnoreListForm.FormCreate(Sender: TObject);
-begin
-  TranslateComponent(self);
-end;
-
-procedure TIgnoreListForm.FormClose(Sender: TObject;
-  var Action: TCloseAction);
-begin
-  IgnoreListForm.SaveIgnoreListToFile(ExtractFilePath(Application.ExeName) + VAR_FOLDER + '\ignorelist.dat');
-end;
-
 end.

Modified: Lobby/TASClient/LobbyScriptUnit.pas
===================================================================
--- Lobby/TASClient/LobbyScriptUnit.pas	2010-12-26 15:57:24 UTC (rev 7562)
+++ Lobby/TASClient/LobbyScriptUnit.pas	2011-01-04 00:40:03 UTC (rev 7563)
@@ -1987,15 +1987,12 @@
       end;
       if client.InBattle and BattleForm.IsBattleActive and (BattleState.Battle.Clients.IndexOf(client) &gt; -1) and (Preferences.BattleClientSortStyle = 0) then
         BattleForm.SortClientList(Preferences.BattleClientSortStyle,Preferences.BattleClientSortDirection,True);
-    end;
-    i := RenamesIds.IndexOf(userId);
-    if i&gt;-1 then
-      RenamesNames[i] := displayName
+    end
     else
     begin
-      RenamesIds.Add(userId);
-      RenamesNames.Add(displayName);
+      TClient.SetDisplayName(userId,displayName);
     end;
+
   UnlockGUI;
 end;
 

Modified: Lobby/TASClient/MainUnit.dfm
===================================================================
--- Lobby/TASClient/MainUnit.dfm	2010-12-26 15:57:24 UTC (rev 7562)
+++ Lobby/TASClient/MainUnit.dfm	2011-01-04 00:40:03 UTC (rev 7563)
@@ -1,6 +1,6 @@
 object MainForm: TMainForm
-  Left = 593
-  Top = 437
+  Left = 841
+  Top = 443
   Width = 883
   Height = 553
   Caption = 'TASClient'
@@ -344,6 +344,8 @@
                 TabOrder = 1
                 OnClick = SortLabelClick
                 DropDownMenu = SortPopupMenu
+                Images = ArrowList
+                ImageIndex = 0
               end
             end
           end
@@ -5302,8 +5304,8 @@
   end
   object ClientPopupMenu2: TSpTBXPopupMenu
     AutoHotkeys = maManual
-    Left = 576
-    Top = 192
+    Left = 680
+    Top = 168
     object PlayerSubMenu: TSpTBXSubmenuItem
       Caption = 'PlayerSubMenu'
       object mnuOpenPrivateChat: TSpTBXItem
@@ -5902,13 +5904,13 @@
     AutoHotkeys = maManual
     OnPopup = ClientPopupMenuPopup
     LinkSubitems = PlayerSubMenu
-    Left = 540
-    Top = 190
+    Left = 644
+    Top = 166
   end
   object SearchPlayerFormPopupMenu: TSpTBXFormPopupMenu
     OnPopup = SearchPlayerFormPopupMenuPopup
-    Left = 700
-    Top = 158
+    Left = 780
+    Top = 134
   end
   object HttpCli3: THttpCli
     LocalAddr = '0.0.0.0'
@@ -6089,44 +6091,71 @@
   end
   object SortPopupMenu: TSpTBXPopupMenu
     AutoHotkeys = maManual
-    Left = 728
-    Top = 164
+    OnPopup = SortPopupMenuPopup
+    Left = 808
+    Top = 132
     object Nosorting1: TSpTBXItem
       Caption = 'Don'#39't sort'
       AutoCheck = True
+      Checked = True
       GroupIndex = 1
       RadioItem = True
+      OnClick = SortMenuItemClick
     end
     object Sortbyname1: TSpTBXItem
+      Tag = 1
       Caption = 'Sort by name'
       AutoCheck = True
       GroupIndex = 1
       RadioItem = True
+      OnClick = SortMenuItemClick
     end
     object Sortbystatus1: TSpTBXItem
+      Tag = 2
       Caption = 'Sort by status'
       AutoCheck = True
       GroupIndex = 1
       RadioItem = True
+      OnClick = SortMenuItemClick
     end
     object Sortbyrank1: TSpTBXItem
+      Tag = 3
       Caption = 'Sort by rank'
       AutoCheck = True
       GroupIndex = 1
       RadioItem = True
+      OnClick = SortMenuItemClick
     end
     object Sortbycountry1: TSpTBXItem
+      Tag = 4
       Caption = 'Sort by country'
       AutoCheck = True
       GroupIndex = 1
       RadioItem = True
+      OnClick = SortMenuItemClick
     end
     object Sortbygroup1: TSpTBXItem
+      Tag = 5
       Caption = 'Sort by group'
       AutoCheck = True
       GroupIndex = 1
       RadioItem = True
+      OnClick = SortMenuItemClick
     end
+    object SpTBXSeparatorItem29: TSpTBXSeparatorItem
+    end
+    object mnuAscSort: TSpTBXItem
+      Caption = 'Ascending'
+      GroupIndex = 2
+      RadioItem = True
+      OnClick = mnuAscSortClick
+    end
+    object mnuDescSort: TSpTBXItem
+      Caption = 'Descending'
+      GroupIndex = 2
+      RadioItem = True
+      OnClick = mnuDescSortClick
+    end
   end
   object ConnectionStateLightImageList: TImageList
     Height = 32

Modified: Lobby/TASClient/MainUnit.pas
===================================================================
--- Lobby/TASClient/MainUnit.pas	2010-12-26 15:57:24 UTC (rev 7562)
+++ Lobby/TASClient/MainUnit.pas	2011-01-04 00:40:03 UTC (rev 7563)
@@ -413,7 +413,7 @@
   );
 
 const
-  VERSION_NUMBER = '0.83'; // Must be float value! (with a period as a decimal seperator)
+  VERSION_NUMBER = '0.84'; // Must be float value! (with a period as a decimal seperator)
   AUTOUPDATE_URL = '<A HREF="http://tasclient.no-ip.org/TASClient_update_v5.txt">http://tasclient.no-ip.org/TASClient_update_v5.txt</A>';
   PROGRAM_VERSION = 'TASClient ' + VERSION_NUMBER;
   KEEP_ALIVE_INTERVAL = 10000; // in milliseconds. Tells us what should be the maximum &quot;silence&quot; time before we send a ping to the server.
@@ -446,6 +446,7 @@
   TIPS_FILE = VAR_FOLDER+'\tips.txt';
   RENAMES_FILE = VAR_FOLDER+'\renames.ini';
   SPRING_SETTINGS_PROFILE_FILE = VAR_FOLDER + '\SpringSettingsProfiles.ini';
+  CLIENTS_DATA_FILE = VAR_FOLDER + '\UsersData.ini';
   FILTERS_FOLDER = VAR_FOLDER + '\filters';
   REPLAY_FILTERS_FOLDER = VAR_FOLDER + '\replayFilters';
   SPSKIN_FOLDER = LOBBY_FOLDER + '\SPThemes';
@@ -660,7 +661,7 @@
 
     constructor Create(Name: string; Color: Integer);
     destructor Destroy;
-    procedure AddClient(nickName: string);
+    function AddClient(nickName: string): Boolean;
     procedure RemoveClient(nickName: string);
 
     procedure GroupUpdated;
@@ -669,12 +670,20 @@
   TBattle = class;
 
   TClient = class
-  private
+  protected
     Group: TClientGroup;
+    FIsRenamed: Boolean;
+    FDisplayName: WideString;
+    FIgnored: Boolean;
+
+    // internal properties functions
+    function IGetDisplayName: WideString;
+    procedure ISetDisplayName(displayName: WideString);
+    procedure ISetIsIgnored(ignored: Boolean);
   public
     Id: integer;
     Name: WideString; // client's username
-    DisplayName: WideString;
+
     RecentNames: string; // use for modos with FINDIP
     FStatus: Integer; // client's status (normal, in game)
     FBattleStatus: Integer; // only used for clients participating in the same battle as the player
@@ -756,6 +765,22 @@
     function GetCustomIconId(iconType: integer): integer;
     procedure SetCustomIconId(iconType: integer; id: integer);
 
+    property isRenamed: Boolean read FIsRenamed;
+    property DisplayName : WideString read IGetDisplayName write ISetDisplayName;
+    property isIgnored : Boolean read FIgnored write ISetIsIgnored;
+
+    class function GetLatestName(id: integer):WideString;
+    class function GetDisplayName(id: integer):WideString;
+    class function GetIsRenamed(id: integer): Boolean;
+    class function GetNameHistory(id: integer): TWideStringList;
+    class function GetIsIgnored(id: integer): Boolean;
+    class function GetIdByLatestName(latestName: WideString): Integer;
+
+    class procedure SetLatestName(id: integer; name: WideString);
+    class procedure SetDisplayName(id: integer; displayName: WideString);
+    class procedure SetIsRenamed(id: integer; isRenamed: Boolean);
+    class procedure SetNameHistory(id: integer; NameHistory: TWideStringList);
+    class procedure SetIsIgnored(id: integer; isIgnored: Boolean);
   end;
 
   TTASClientThread = class(TThread) //TDialogThread
@@ -1299,6 +1324,9 @@
     SpTBXItem7: TSpTBXItem;
     TBControlItem1: TTBControlItem;
     tmrCumulativeDataSentHistory: TTimer;
+    SpTBXSeparatorItem29: TSpTBXSeparatorItem;
+    mnuDescSort: TSpTBXItem;
+    mnuAscSort: TSpTBXItem;
     procedure mnuOpenPrivateChatClick(Sender: TObject);
     procedure mnuSelectBattleClick(Sender: TObject);
     procedure mnuPlayWithClick(Sender: TObject);
@@ -1497,6 +1525,9 @@
     procedure SpTBXItem7Click(Sender: TObject);
     procedure Button1Click(Sender: TObject);
     procedure tmrCumulativeDataSentHistoryTimer(Sender: TObject);
+    procedure mnuAscSortClick(Sender: TObject);
+    procedure mnuDescSortClick(Sender: TObject);
+    procedure SortPopupMenuPopup(Sender: TObject);
   published
     MainTitleBar: TSpTBXTitleBar;
     ButtonImageList: TImageList;
@@ -1623,11 +1654,11 @@
     procedure TryToAutoCompleteWord(Edit: TTntMemo; Clients: TList);
     function TryToAutoCompleteCommand(word: string; pos: integer;Edit: TTntMemo):string;
 
-    procedure SortClientsList(List: TList; SortStyle: Integer);
-    procedure SortClientInList(client: TClient;List: TList; SortStyle: Integer);
+    procedure SortClientsList(List: TList; SortStyle: Integer; SortAsc: Boolean);
+    procedure SortClientInList(client: TClient;List: TList; SortStyle: Integer; SortAsc: Boolean);
     procedure SortBattlesList(BattleList: TList; SortStyle: Integer; Ascending: Boolean; CountMe: Boolean = True);
     procedure RefreshBattlesNodes;
-    function CompareClients(Client1: TClient; Client2: TClient; SortStyle: Integer): Shortint; // used with SortClientsList method (and other methods?)
+    function CompareClients(Client1: TClient; Client2: TClient; SortStyle: Integer; SortAsc: Boolean): Shortint; // used with SortClientsList method (and other methods?)
     function CompareBattles(Battle1, Battle2: TBattle; SortStyle: Integer; SortDirection: Boolean; CountMe: Boolean = False): Shortint;
 
     function isBattleVisible(Battle:TBattle;Filters: TPresetFilters; countMe: Boolean = True):Boolean;
@@ -1668,7 +1699,6 @@
     procedure UpdateFilters(pFilters: TPresetFilters);
     procedure CopyFilters(srcFilters: TPresetFilters; var dstFilters: TPresetFilters);
 
-    procedure SaveRenames;
     procedure LoadRenames;
     procedure PrintUnitsyncErrors;
   published
@@ -1782,8 +1812,7 @@
     All other clients lists (in channels, battles) contain objects linking to actual objects in this list. Never free
     any clients in any list except in this one, since freeing them in any other list will also free them in this list! }
   AllClients: TList;
-  RenamesIds: TIntegerList;
-  RenamesNames: TWideStringList;
+  ClientsDataIni: TIniFile;
 
   ClientGroups: TList;
 
@@ -2580,7 +2609,7 @@
     //SortClientsList(AllClients,Preferences.SortStyle);
     i := AllClients.Count-1;
     while i &gt; 0 do
-      if CompareClients(AllClients[i], AllClients[i-1], Preferences.SortStyle) &lt; 0 then
+      if CompareClients(AllClients[i], AllClients[i-1], Preferences.SortStyle, Preferences.SortAsc) &lt; 0 then
       begin
         // swap:
         tmp := AllClients[i];
@@ -2758,18 +2787,32 @@
 constructor TClient.Create(Name: WideString; Status: Integer; Country: string; CPU: Integer; id: integer);
 var
   i,j: integer;
+  latestName: WideString;
+  nameHistory: TWideStringList;
 begin
   Self.Id := id;
   Self.Name := Name;
-  i := RenamesIds.IndexOf(id);
+  Self.FDisplayName := GetDisplayName(id);
+  Self.FIsRenamed := GetIsRenamed(id);
+  latestName := GetLatestName(id);
+  nameHistory := GetNameHistory(id);
+  if LowerCase(Name) &lt;&gt; LowerCase(latestName) then
+  begin
+    if nameHistory.IndexOf(latestName) = -1 then
+    begin
+      nameHistory.Add(latestName);
+      SetNameHistory(id,nameHistory);
+    end;
+
+  end;
+  i := nameHistory.IndexOf(Name);
   if i &gt; -1 then
   begin
-    Self.DisplayName := RenamesNames[i];
-    RenamesNames.Delete(i);
-    RenamesIds.Delete(i);
-  end
-  else
-    Self.DisplayName := Name;
+    nameHistory.Delete(i);
+    SetNameHistory(id,nameHistory);
+  end;
+  nameHistory.Free;
+  SetLatestName(id,Name);
   Self.Status := Status;
   Self.BattleStatus := 0;
   Self.InBattle := False;
@@ -2824,17 +2867,6 @@
     else
       raise Exception.Create('Trying to delete a TClient with non nil Battle');
   end;
-  if Name &lt;&gt; DisplayName then
-  begin
-    j := RenamesIds.IndexOf(Id);
-    if j &gt; -1 then
-      RenamesNames[j] := DisplayName
-    else
-    begin
-      RenamesIds.Add(Id);
-      RenamesNames.Add(DisplayName);
-    end;
-  end;
   inherited;
 end;
 
@@ -3078,11 +3110,11 @@
     if Preferences.SortStyle = 2 then
     begin
       for i := 1 {start from 1 to skip LOCAL_TAB} to MainForm.ChatTabs.Count-1 do
-        MainForm.SortClientInList(Self,TMyTabSheet(MainForm.ChatTabs[i]).Clients, Preferences.SortStyle);
+        MainForm.SortClientInList(Self,TMyTabSheet(MainForm.ChatTabs[i]).Clients, Preferences.SortStyle, Preferences.SortAsc);
       if (Battle &lt;&gt; nil) and (Battle = MainForm.selectedBattlePlayers) then
-        MainForm.SortClientInList(Self,Battle.SortedClients, Preferences.SortStyle);
+        MainForm.SortClientInList(Self,Battle.SortedClients, Preferences.SortStyle, Preferences.SortAsc);
       if Preferences.SortLocal then
-        MainForm.SortClientInList(Self,AllClients, Preferences.SortStyle);
+        MainForm.SortClientInList(Self,AllClients, Preferences.SortStyle, Preferences.SortAsc);
     end;
 end;
 
@@ -3097,11 +3129,11 @@
     if Preferences.SortStyle = 2 then
     begin
       for i := 1 {start from 1 to skip LOCAL_TAB} to MainForm.ChatTabs.Count-1 do
-        MainForm.SortClientInList(Self,TMyTabSheet(MainForm.ChatTabs[i]).Clients, Preferences.SortStyle);
+        MainForm.SortClientInList(Self,TMyTabSheet(MainForm.ChatTabs[i]).Clients, Preferences.SortStyle, Preferences.SortAsc);
       if (Battle &lt;&gt; nil) and (Battle = MainForm.selectedBattlePlayers) then
-        MainForm.SortClientInList(Self,Battle.SortedClients, Preferences.SortStyle);
+        MainForm.SortClientInList(Self,Battle.SortedClients, Preferences.SortStyle, Preferences.SortAsc);
       if Preferences.SortLocal then
-        MainForm.SortClientInList(Self,AllClients, Preferences.SortStyle);
+        MainForm.SortClientInList(Self,AllClients, Preferences.SortStyle, Preferences.SortAsc);
     end;
 end;
 
@@ -3112,6 +3144,34 @@
   FBattleStatus := bs;
 end;
 
+function TClient.IGetDisplayName: WideString;
+begin
+  if FIsRenamed then
+    Result := FDisplayName
+  else
+    Result := Name;
+end;
+
+procedure TClient.ISetDisplayName(displayName: WideString);
+begin
+  if displayName = '' then
+  begin
+    FIsRenamed := False;
+    TClient.SetIsRenamed(Id,False);
+    Exit;
+  end;
+  FIsRenamed := True;
+  FDisplayName := displayName;
+  TClient.SetDisplayName(Id,displayName);
+  TClient.SetIsRenamed(Id,True);
+end;
+
+procedure TClient.ISetIsIgnored(ignored: Boolean);
+begin
+  FIgnored := ignored;
+  TClient.SetIsIgnored(Id,ignored);
+end;
+
 { TBot }
 
 procedure TBot.Assign(Bot: TBot);
@@ -4064,6 +4124,7 @@
 
   TranslateComponent(self);
 
+
   if MainUnit.Debug.Enabled then
     Misc.TryToAddLog(MainUnit.StartDebugLog,'Initializing variables ...');
 
@@ -4147,8 +4208,6 @@
     Misc.TryToAddLog(MainUnit.StartDebugLog,'Initializing variables ...');
 
   AllClients := TList.Create;
-  RenamesIds := TIntegerList.Create;
-  RenamesNames := TWideStringList.Create;
 
   ClientGroups := TList.Create;
 
@@ -4162,6 +4221,24 @@
   AutoJoinBattles := TList.Create;
 
   if MainUnit.Debug.Enabled then
+    Misc.TryToAddLog(MainUnit.StartDebugLog,'Loading clients data ...');
+
+  if not FileExists(CLIENTS_DATA_FILE) then // old files import
+  begin
+    ClientsDataIni := TIniFile.Create(CLIENTS_DATA_FILE);
+    if MainUnit.Debug.Enabled then
+      Misc.TryToAddLog(MainUnit.StartDebugLog,'Loading ignore list ...');
+    IgnoreListForm.LoadIgnoreListFromFile(ExtractFilePath(Application.ExeName) + VAR_FOLDER + '\ignorelist.dat');
+
+    if MainUnit.Debug.Enabled then
+      Misc.TryToAddLog(MainUnit.StartDebugLog,'Loading renames ...');
+    LoadRenames;
+  end
+  else
+    ClientsDataIni := TIniFile.Create(CLIENTS_DATA_FILE);
+
+
+  if MainUnit.Debug.Enabled then
     Misc.TryToAddLog(MainUnit.StartDebugLog,'Loading docking settings ...');
 
   DockHandler.TabType := ttText;
@@ -4217,15 +4294,6 @@
 
   ReplayList := TList.Create;
 
-  for i := 0 to SortPopupMenu.Items.Count-1 do
-  with SortPopupMenu do
-  begin
-    Items[i].Tag := i;
-    Items[i].RadioItem := True;
-    Items[i].OnClick := SortMenuItemClick;
-  end;
-  SortPopupMenu.Items[0].Checked := True;
-
   if MainUnit.Debug.Enabled then
     Misc.TryToAddLog(MainUnit.StartDebugLog,'Initializing flag bitmaps ...');
 
@@ -4286,9 +4354,6 @@
     if MainUnit.Debug.Enabled then
       Misc.TryToAddLog(MainUnit.StartDebugLog,'Loading highlights ...');
     HighlightingForm.LoadHighlightsFromFile(ExtractFilePath(Application.ExeName) + VAR_FOLDER + '\highlights.dat');
-    if MainUnit.Debug.Enabled then
-      Misc.TryToAddLog(MainUnit.StartDebugLog,'Loading ignore list ...');
-    IgnoreListForm.LoadIgnoreListFromFile(ExtractFilePath(Application.ExeName) + VAR_FOLDER + '\ignorelist.dat');
 
     // we must apply themetype and theme now and not before, since some forms
     // or controls may yet not have been created earlier:
@@ -4364,9 +4429,6 @@
     end;
 
     if MainUnit.Debug.Enabled then
-      Misc.TryToAddLog(MainUnit.StartDebugLog,'Loading renames ...');
-    LoadRenames;
-    if MainUnit.Debug.Enabled then
       Misc.TryToAddLog(MainUnit.StartDebugLog,'Loading groups ...');
     LoadGroups;
     if MainUnit.Debug.Enabled then
@@ -4953,7 +5015,7 @@
   i := ClientList.Count-1;
   // sort:
   while i &gt; 0 do
-    if CompareClients(ClientList[i], ClientList[i-1], Preferences.SortStyle) &lt; 0 then
+    if CompareClients(ClientList[i], ClientList[i-1], Preferences.SortStyle, Preferences.SortAsc) &lt; 0 then
     begin
       // swap:
       tmp := ClientList[i];
@@ -5588,18 +5650,22 @@
         begin
           if MessageDlg(_('User &lt;') + tmp + _('&gt; is not online, do you wish to add him to ignore list anyway?'), mtConfirmation, [mbYes, mbNo], 0) = mrYes then
           begin
-            IgnoreListForm.AddToIgnoreList(tmp);
-            IgnoreListForm.ShowModal;
+            if IgnoreListForm.AddOfflineClientToIgnoreList(tmp) then
+              IgnoreListForm.ShowModal
+            else
+              AddMainLog(_('Error: Unknown UserName.'),Colors.Error);
           end;
         end
         else
         begin
-          IgnoreListForm.AddToIgnoreList(tmp);
-          IgnoreListForm.ShowModal;
+            if IgnoreListForm.AddOfflineClientToIgnoreList(tmp) then
+              IgnoreListForm.ShowModal
+            else
+              AddMainLog(_('Error: Unknown UserName.'),Colors.Error);
         end;
       end;
     end
-    else AddMainLog(_('Unknown command!'), Colors.Error);
+    else AddMainLog(_('Error: Unknown command!'), Colors.Error);
 
   finally
     if sl &lt;&gt; nil then sl.Free;
@@ -5779,9 +5845,9 @@
 
       // we must do some graphical updating now since we ignored it while receiving login info (to speed the login process):
       if Preferences.SortLocal then
-        SortClientsList(AllClients,Preferences.SortStyle);
+        SortClientsList(AllClients,Preferences.SortStyle, Preferences.SortAsc);
       for i := 1 {start from 1 to skip LOCAL_TAB} to ChatTabs.Count-1 do
-        SortClientsList(TMyTabSheet(MainForm.ChatTabs[i]).Clients, Preferences.SortStyle);
+        SortClientsList(TMyTabSheet(MainForm.ChatTabs[i]).Clients, Preferences.SortStyle, Preferences.SortAsc);
       UpdateClientsListBox;
       VDTBattles.Invalidate;
       LadderCupsRefreshTimer(nil);
@@ -6577,7 +6643,7 @@
 
       // are we ignoring this user?
       if Preferences.UseIgnoreList then
-        if IgnoreListForm.IgnoringUser(Client) then Exit; // don't display the message
+        if Client.IsIgnored then Exit; // don't display the message
 
 
       if Client &lt;&gt; nil then
@@ -6630,7 +6696,7 @@
 
       // are we ignoring this user?
       if Preferences.UseIgnoreList then
-        if IgnoreListForm.IgnoringUser(Client) then Exit; // don't display the message
+        if Client.isIgnored then Exit; // don't display the message
 
       tmpClientGroup := Client.GetGroup;
       if tmpClientGroup &lt;&gt; nil then
@@ -6729,7 +6795,7 @@
 
       // are we ignoring this user?
       if Preferences.UseIgnoreList then
-        if IgnoreListForm.IgnoringUser(Client) then
+        if Client.isIgnored then
           Exit; // don't display the message
 
       tmpClientGroup := Client.GetGroup;
@@ -6816,7 +6882,7 @@
 
       // are we ignoring this user?
       if Preferences.UseIgnoreList then
-        if IgnoreListForm.IgnoringUser(Client) then Exit; // don't display the message
+        if Client.isIgnored then Exit; // don't display the message
 
       tmp := MakeSentenceWS(sl, 2);
       tmp2 := '&lt;' + Client.DisplayName + '&gt; ' + tmp;
@@ -7333,7 +7399,7 @@
       if Battle = selectedBattlePlayers then
       begin
         Battle.SortedClients.Add(Client);
-        SortClientInList(Client,Battle.SortedClients,Preferences.SortStyle);
+        SortClientInList(Client,Battle.SortedClients,Preferences.SortStyle, Preferences.SortAsc);
       end;
       UpdateBattlePlayersListBox(Battle,Client);
 
@@ -9041,7 +9107,7 @@
   try
   for i:=0 to Clients.Count-1 do
   begin
-    if TClient(Clients[i]).DisplayName &lt;&gt; TClient(Clients[i]).Name then
+    if TClient(Clients[i]).isRenamed then
       SortedClientsList.Add(TClient(Clients[i]).DisplayName);
     SortedClientsList.Add(TClient(Clients[i]).Name);
   end;
@@ -9838,10 +9904,9 @@
 
 procedure TMainForm.FormClose(Sender: TObject; var Action: TCloseAction);
 begin
-  OutputDebugString('toto1');
   if Status.LoggedIn then
     TryToDisconnect;
-  OutputDebugString('toto2');
+    
   ClearAllClientsList;
 
   AcquireMainThread;
@@ -9853,7 +9918,6 @@
   KeepAliveTimer.Enabled := False;
   LadderCupsRefresh.Enabled := False;
 
-  OutputDebugString('toto3');
   if Debug.Log then (TMyTabSheet(MainForm.ChatTabs[0]).FindChildControl('RichEdit') as TExRichEdit).Lines.SaveToFile(ExtractFilePath(Application.ExeName) + LOG_FILENAME);
   if FiltersButton.ImageIndex = 1 then
   begin
@@ -9866,21 +9930,19 @@
   NotificationsForm.SaveNotificationListToFile(ExtractFilePath(Application.ExeName) + VAR_FOLDER + '\notify.dat');
   PerformForm.SaveCommandListToFile(ExtractFilePath(Application.ExeName) + VAR_FOLDER + '\perform.dat');
   HighlightingForm.SaveHighlightsToFile(ExtractFilePath(Application.ExeName) + VAR_FOLDER + '\highlights.dat');
-  IgnoreListForm.SaveIgnoreListToFile(ExtractFilePath(Application.ExeName) + VAR_FOLDER + '\ignorelist.dat');
-   OutputDebugString('toto4');
   SaveFiltersToFile(CurrentFilters);
   AutoJoinForm.SaveAutoJoinPreset(AUTOJOIN_PRESETS_FOLDER + '\current.ini');
   ReplaysForm.SaveReplayFiltersToFile(REPLAY_FILTERS_FOLDER + '\current.ini');
   if RunningWithMainMenu then
     MenuForm.SaveSettings;
   SaveGroups;
-  SaveRenames;
-  OutputDebugString('toto5');
+  ClientsDataIni.Free;
+
   if Preferences.EnableSpringDownloader then
     CloseSpringDownloader;
 
   Misc.SetRegistryData(HKEY_CURRENT_USER,TASCLIENT_REGISTRY_KEY,'Crashed',rdInteger,Misc.BoolToInt(False));
-  OutputDebugString('toto6');
+
   Application.Terminate;
 end;
 
@@ -10024,7 +10086,7 @@
   SortPopupMenu.Popup(p.x, p.y);
 end;
 
-function TMainForm.CompareClients(Client1: TClient; Client2: TClient; SortStyle: Integer): Shortint;
+function TMainForm.CompareClients(Client1: TClient; Client2: TClient; SortStyle: Integer; SortAsc: Boolean): Shortint;
 var
   group1,group2: TCLientGroup;
 begin
@@ -10052,6 +10114,9 @@
   else
     Result := 0;
   end;
+
+  if not SortAsc then
+    Result := Result * -1;
 end;
 
 function TMainForm.CompareBattles(Battle1, Battle2: TBattle; SortStyle: Integer; SortDirection: Boolean; CountMe: Boolean = False): Shortint;
@@ -10140,14 +10205,14 @@
   Result := asc*Result;
 end;
 
-procedure TMainForm.SortClientsList(List: TList; SortStyle: Integer);
+procedure TMainForm.SortClientsList(List: TList; SortStyle: Integer; SortAsc: Boolean);
 begin
   List.Sort(ClientSortCompare);
 end;
 
 function ClientSortCompare(Item1, Item2: Pointer): Integer;
 begin
-  Result := MainForm.CompareClients(TClient(Item1), TClient(Item2), Preferences.SortStyle);
+  Result := MainForm.CompareClients(TClient(Item1), TClient(Item2), Preferences.SortStyle,Preferences.SortAsc);
 end;
 function BattleSortCompare(Item1, Item2: Pointer): Integer;
 begin
@@ -10160,7 +10225,7 @@
     Result := -1;
 end;
 
-procedure TMainForm.SortClientInList(client: TClient;List: TList; SortStyle: Integer);
+procedure TMainForm.SortClientInList(client: TClient;List: TList; SortStyle: Integer; SortAsc: Boolean);
 var
   i, index: Integer;
   tmp: TClient;
@@ -10169,7 +10234,7 @@
   if index = -1 then Exit;
 
   for i := Index+1 to List.Count-1 do
-    if (CompareClients(TClient(List[index]), TClient(List[i]), SortStyle) &gt; 0) then
+    if (CompareClients(TClient(List[index]), TClient(List[i]), SortStyle, SortAsc) &gt; 0) then
     begin
         // swap:
         tmp := List[i];
@@ -10180,7 +10245,7 @@
     else break;
 
   for i := Index-1 downto 0 do begin
-    if (CompareClients(TClient(List[index]), TClient(List[i]), SortStyle) &lt; 0) then
+    if (CompareClients(TClient(List[index]), TClient(List[i]), SortStyle, SortAsc) &lt; 0) then
     begin
         // swap:
         tmp := List[i];
@@ -10262,7 +10327,7 @@
       if enabled then
       begin
         if filterType = HostName then
-          if TClient(Battle.Clients[0]).Name &lt;&gt; TClient(Battle.Clients[0]).DisplayName then
+          if TClient(Battle.Clients[0]).isRenamed then
             tmpStr := TClient(Battle.Clients[0]).Name+' '+TClient(Battle.Clients[0]).DisplayName
           else
             tmpStr := TClient(Battle.Clients[0]).Name
@@ -10275,7 +10340,7 @@
         else if filterType = Players then
           tmpStr := Battle.ClientsToString(' ',True)+' '+Battle.ClientsToString(' ',False)
         else if filterType = AllBattle then
-          tmpStr := 'Description=&quot;'+Battle.Description+'&quot; Host=&quot;'+IFF(TClient(Battle.Clients[0]).Name &lt;&gt; TClient(Battle.Clients[0]).DisplayName,TClient(Battle.Clients[0]).Name+' '+TClient(Battle.Clients[0]).DisplayName,TClient(Battle.Clients[0]).Name)+'&quot; Map=&quot;'+Battle.Map+'&quot; Mod=&quot;'+Battle.ModName+'&quot; Players=&quot;'+Battle.ClientsToString(' ',True)+' '+Battle.ClientsToString(' ',False)+'&quot;'
+          tmpStr := 'Description=&quot;'+Battle.Description+'&quot; Host=&quot;'+IFF(TClient(Battle.Clients[0]).isRenamed,TClient(Battle.Clients[0]).Name+' '+TClient(Battle.Clients[0]).DisplayName,TClient(Battle.Clients[0]).Name)+'&quot; Map=&quot;'+Battle.Map+'&quot; Mod=&quot;'+Battle.ModName+'&quot; Players=&quot;'+Battle.ClientsToString(' ',True)+' '+Battle.ClientsToString(' ',False)+'&quot;'
         else
           raise Exception.Create(_('Filter type not handled.'));
 
@@ -10444,6 +10509,9 @@
 begin
   //(Sender as TSpTBXItem).Checked := True;
   Preferences.SortStyle := (Sender as TSpTBXItem).Tag;
+  Preferences.SortAsc := True;
+  SortPopupMenu.Items[Preferences.SortStyle].Checked := True;
+  SortLabel.ImageIndex := 0;
   SortLabel.Caption := (Sender as TSpTBXItem).Caption;
   ResortClientsLists;
 end;
@@ -10707,6 +10775,7 @@
   i: integer;
   realIndex: integer;
   cList: TList;
+  nameHistory: TWideStringList;
 begin
   if MainForm.Active and (SkinManager.GetSkinType = sknSkin) then
     TTntListBox(Sender).Repaint;
@@ -10756,6 +10825,11 @@
         (Sender as TTntListBox).Hint := (Sender as TTntListBox).Hint + ', ' + lobbyScriptUnit.PlayerIconTypeNames[i] + '=' + TStringList(lobbyScriptUnit.PlayerIconTypeIconsNames[i]).Strings[tmp2]
       end;
     end;
+
+    // name history
+    nameHistory := TClient.GetNameHistory(TClient(cList[realIndex]).Id);
+    if nameHistory.Count &gt; 0 then
+      (Sender as TTntListBox).Hint := (Sender as TTntListBox).Hint + _(' (A.K.A. : ') + nameHistory.CommaText + ')';
   except
   end;
 
@@ -11103,10 +11177,13 @@
   ReleaseMainThread;
 end;
 
-procedure TClientGroup.AddClient(nickName: string);
+function TClientGroup.AddClient(nickName: string): Boolean;
 var
   c: TClient;
+  id: integer;
 begin
+  Result := False;
+
   c := MainForm.GetClient(nickName);
   if c &lt;&gt; nil then
   begin
@@ -11114,8 +11191,15 @@
     c.SetGroup(Self);
   end
   else
-    Clients.Add(nickName);
+  begin
+    id := TClient.GetIdByLatestName(nickName);
+    if id = 0 then
+      Exit;
+    ClientsIds.Add(id);
+  end;
   MainForm.SaveGroups;
+
+  Result := True;
 end;
 procedure TClientGroup.RemoveClient(nickName: string);
 var
@@ -11128,7 +11212,9 @@
     c.SetGroup(nil);
   end
   else
-    Clients.Delete(Clients.IndexOf(nickName));
+  begin
+    ClientsIds.Remove(TClient.GetIdByLatestName(nickName))
+  end;
 end;
 
 procedure TMainForm.mnuManageGroupsClick(Sender: TObject);
@@ -11183,12 +11269,12 @@
   i:integer;
 begin
   if Preferences.SortLocal then
-    SortClientsList(AllClients, Preferences.SortStyle);
+    SortClientsList(AllClients, Preferences.SortStyle, Preferences.SortAsc);
 
   for i := 1 {start from 1 to skip LOCAL_TAB} to ChatTabs.Count-1 do
-    SortClientsList(TMyTabSheet(MainForm.ChatTabs[i]).Clients, Preferences.SortStyle);
+    SortClientsList(TMyTabSheet(MainForm.ChatTabs[i]).Clients, Preferences.SortStyle, Preferences.SortAsc);
   if selectedBattlePlayers &lt;&gt; nil then
-    SortClientsList(selectedBattlePlayers.SortedClients,Preferences.SortStyle);
+    SortClientsList(selectedBattlePlayers.SortedClients,Preferences.SortStyle, Preferences.SortAsc);
   UpdateClientsListBox;
   BattlePlayersListBox.Invalidate;
 end;
@@ -11198,11 +11284,11 @@
   i:integer;
 begin
   if Preferences.SortLocal then
-    SortClientInList(client,AllClients, Preferences.SortStyle);
+    SortClientInList(client,AllClients, Preferences.SortStyle, Preferences.SortAsc);
   for i := 1 {start from 1 to skip LOCAL_TAB} to ChatTabs.Count-1 do
-    SortClientInList(client,TMyTabSheet(MainForm.ChatTabs[i]).Clients, Preferences.SortStyle);
+    SortClientInList(client,TMyTabSheet(MainForm.ChatTabs[i]).Clients, Preferences.SortStyle, Preferences.SortAsc);
   if (client.Battle &lt;&gt; nil) and (client.Battle = selectedBattlePlayers) then
-    SortClientInList(client,client.Battle.SortedClients, Preferences.SortStyle);
+    SortClientInList(client,client.Battle.SortedClients, Preferences.SortStyle, Preferences.SortAsc);
   UpdateClientsListBox;
 end;
 
@@ -11599,12 +11685,12 @@
   //if ClientsListBox.ItemIndex = -1 then Exit; // I don't think this can actually happen, since we must click in ListBox and so select an item
 
   if mnuIgnore.Checked then
-    IgnoreListForm.RemoveFromIgnoreList(GetClient(SelectedUserName))
+    GetClient(SelectedUserName).isIgnored := False
   else
   begin
     IgnoreListForm.EnableIgnoresCheckBox.Checked := True;
     Preferences.UseIgnoreList := True;
-    IgnoreListForm.AddToIgnoreList(SelectedUserName);
+    GetClient(SelectedUserName).isIgnored := True;
   end;
 end;
 
@@ -14279,7 +14365,7 @@
   client: TClient;
 begin
   client := GetClient(SelectedUserName);
-  client.DisplayName := InputBox(_('Rename user'),_('New name :'),client.Name);
+  client.DisplayName := InputBox(_('Rename user'),_('New name (leave empty to disable renaming) :'),client.DisplayName);
   SortClientInLists(client);
   UpdateClientsListBox;
   if Preferences.BattleSortStyle = 5 then
@@ -14295,24 +14381,6 @@
   end;
 end;
 
-procedure TMainForm.SaveRenames;
-var
-  FileName: String;
-  Ini : TIniFile;
-  i:integer;
-begin
-  try
-    FileName := ExtractFilePath(Application.ExeName) + RENAMES_FILE;
-    if FileExists(FileName) then
-      DeleteFile(FileName);
-    Ini := TIniFile.Create(FileName);
-    for i:=0 to RenamesIds.Count-1 do
-      Ini.WriteString('Renames',IntToStr(RenamesIds.Items[i]),RenamesNames[i]);
-    Ini.Free;
-  except
-    MainForm.AddMainLog(_('An error occured while saving the Renames file.'),Colors.Error);
-  end;
-end;
 procedure TMainForm.LoadRenames;
 var
   FileName: String;
@@ -14325,20 +14393,16 @@
     Ini := TIniFile.Create(FileName);
     sl := TStringList.Create;
     Ini.ReadSection('Renames',sl);
-    RenamesIds.Clear;
     for i:=0 to sl.Count-1 do
-      RenamesIds.Add(StrToInt(sl[i]));
-    sl.Clear;
-    ini.ReadSectionValues('Renames',sl);
-    RenamesNames.Clear;
-    for i:=0 to sl.Count-1 do
-      RenamesNames.Add(MidStr(sl[i],1+Pos('=',sl[i]),99999));
+    begin
+      TClient.SetDisplayName(StrToInt(sl[i]),Ini.ReadString('Renames',sl[i],''));
+      TClient.SetIsRenamed(StrToInt(sl[i]),True);
+    end;
+
     sl.Free;
     Ini.Free;
   except
     MainForm.AddMainLog(_('An error occured while loading the Renames file.'),Colors.Error);
-    RenamesIds.Clear;
-    RenamesNames.Clear;
   end;
 end;
 
@@ -14395,7 +14459,7 @@
     mnuRemoveFromGroup.Enabled := False;
   end;
 
-  mnuIgnore.Checked := IgnoreListForm.IgnoringUser(Client);
+  mnuIgnore.Checked := Client.isIgnored;
 
   mnuManageGroups.Enabled := ClientGroups.Count &gt; 0;
 
@@ -14696,7 +14760,7 @@
   begin
     selectedBattlePlayers := battle;
     selectedBattlePlayers.SortedClients.Assign(selectedBattlePlayers.Clients);
-    SortClientsList(selectedBattlePlayers.SortedClients,Preferences.SortStyle);
+    SortClientsList(selectedBattlePlayers.SortedClients,Preferences.SortStyle, Preferences.SortAsc);
     UpdateBattlePlayersListBox(nil,nil);
   end;
 end;
@@ -14718,4 +14782,109 @@
     Status.CumulativeDataSentHistory.Delete(0);
 end;
 
+procedure TMainForm.mnuAscSortClick(Sender: TObject);
+begin
+  SortLabel.ImageIndex := 0;
+  Preferences.SortAsc := True;
+  ResortClientsLists;
+end;
+
+procedure TMainForm.mnuDescSortClick(Sender: TObject);
+begin
+  SortLabel.ImageIndex := 1;
+  Preferences.SortAsc := False;
+  ResortClientsLists;
+end;
+
+procedure TMainForm.SortPopupMenuPopup(Sender: TObject);
+begin
+  mnuAscSort.Checked := Preferences.SortAsc;
+  mnuDescSort.Checked := not Preferences.SortAsc;
+end;
+
+class function TClient.GetDisplayName(id: integer):WideString;
+begin
+  Result := '';
+  if id &lt;= 0 then Exit;
+  Result := ClientsDataIni.ReadString(IntToStr(id),'DisplayName','');
+end;
+
+class function TClient.GetIsRenamed(id: integer): Boolean;
+begin
+  Result := False;
+  if id &lt;= 0 then Exit;
+  Result := ClientsDataIni.ReadBool(IntToStr(id),'IsRenamed',False);
+end;
+
+class function TClient.GetNameHistory(id: integer): TWideStringList;
+begin
+  Result := TWideStringList.Create;
+  if id &lt;= 0 then Exit;
+  Result.CommaText := ClientsDataIni.ReadString(IntToStr(id),'NameHistory','');
+end;
+
+class function TClient.GetIsIgnored(id: integer): Boolean;
+begin
+  Result := False;
+  if id &lt;= 0 then Exit;
+  Result := ClientsDataIni.ReadBool(IntToStr(id),'IsIgnored',False);
+end;
+
+class procedure TClient.SetDisplayName(id: integer; displayName: WideString);
+begin
+  if id &lt;= 0 then Exit;
+  ClientsDataIni.WriteString(IntToStr(id),'DisplayName',displayName);
+end;
+
+class procedure TClient.SetIsRenamed(id: integer; isRenamed: Boolean);
+begin
+  if id &lt;= 0 then Exit;
+  ClientsDataIni.WriteBool(IntToStr(id),'IsRenamed',isRenamed);
+end;
+
+class procedure TClient.SetNameHistory(id: integer; NameHistory: TWideStringList);
+begin
+  if id &lt;= 0 then Exit;
+  ClientsDataIni.WriteString(IntToStr(id),'NameHistory',NameHistory.CommaText);
+end;
+
+class procedure TClient.SetIsIgnored(id: integer; isIgnored: Boolean);
+begin
+  if id &lt;= 0 then Exit;
+  ClientsDataIni.WriteBool(IntToStr(id),'IsIgnored',isIgnored);
+end;
+
+class function TClient.GetLatestName(id: integer):WideString;
+begin
+  Result := '';
+  if id &lt;= 0 then Exit;
+  Result := ClientsDataIni.ReadString(IntToStr(id),'LatestName','');
+end;
+
+class procedure TClient.SetLatestName(id: integer; name: WideString);
+begin
+  if id &lt;= 0 then Exit;
+  ClientsDataIni.WriteString(IntToStr(id),'LatestName',name);
+end;
+
+class function TClient.GetIdByLatestName(latestName: WideString): Integer;
+var
+  strIds: TStringList;
+  i: integer;
+begin
+  Result := 0;
+  strIds := TStringList.Create;
+  try
+    ClientsDataIni.ReadSections(strIds);
+    for i:=0 to strIds.Count-1 do
+      if LowerCase(GetLatestName(StrToInt(strIds[i]))) = LowerCase(latestName) then
+      begin
+        Result := StrToInt(strIds[i]);
+        Exit;
+      end;
+  except
+    MainForm.AddMainLog(_('Error: Corrupted clients data file.'),Colors.Error);
+  end;
+end;
+
 end.

Modified: Lobby/TASClient/ManageGroups.dfm
===================================================================
--- Lobby/TASClient/ManageGroups.dfm	2010-12-26 15:57:24 UTC (rev 7562)
+++ Lobby/TASClient/ManageGroups.dfm	2011-01-04 00:40:03 UTC (rev 7563)
@@ -1,6 +1,6 @@
 object ManageGroupsForm: TManageGroupsForm
-  Left = 455
-  Top = 632
+  Left = 505
+  Top = 469
   BorderIcons = [biSystemMenu]
   BorderStyle = bsSingle
   Caption = 'Manage groups'

Modified: Lobby/TASClient/ManageGroups.pas
===================================================================
--- Lobby/TASClient/ManageGroups.pas	2010-12-26 15:57:24 UTC (rev 7562)
+++ Lobby/TASClient/ManageGroups.pas	2011-01-04 00:40:03 UTC (rev 7563)
@@ -127,15 +127,15 @@
 procedure TManageGroupsForm.cmbGroupsChange(Sender: TObject);
 var
   i: Integer;
-  c: TClient;
+  latestName: WideString;
 begin
   lstClients.Clear;
   lstClients.Items.AddStrings(TClientGroup(ClientGroups[cmbGroups.ItemIndex]).Clients);
   for i:=0 to TClientGroup(ClientGroups[cmbGroups.ItemIndex]).ClientsIds.Count-1 do
   begin
-    c := MainForm.GetClientById(TClientGroup(ClientGroups[cmbGroups.ItemIndex]).ClientsIds.Items[i]);
-    if c&lt;&gt;nil then
-      lstClients.Items.Add(c.Name);
+    latestName := TClient.GetLatestName(TClientGroup(ClientGroups[cmbGroups.ItemIndex]).ClientsIds.Items[i]);
+    if latestName &lt;&gt; '' then
+      lstClients.Items.Add(latestName);
   end;
   ColorPanel.Color := TClientGroup(ClientGroups[cmbGroups.ItemIndex]).Color;
   txtName.Text := TClientGroup(ClientGroups[cmbGroups.ItemIndex]).Name;
@@ -277,9 +277,13 @@
   client: TClient;
 begin
   InputString := '';
-  if InputQuery(_('New group ...'), _('Enter the group name :'), InputString) and (InputString &lt;&gt; '') then
+  if InputQuery(_('New group ...'), _('Enter the player name :'), InputString) and (InputString &lt;&gt; '') then
   begin
-    TClientGroup(ClientGroups[cmbGroups.ItemIndex]).AddClient(InputString);
+    if not TClientGroup(ClientGroups[cmbGroups.ItemIndex]).AddClient(InputString) then
+    begin
+      MessageDlg(_('Unknown user.'),mtError,[mbOK],0);
+      Exit;
+    end;
     lstClients.Items.Add(InputString);
     lstClients.Refresh;
 

Modified: Lobby/TASClient/PreferencesFormUnit.pas
===================================================================
--- Lobby/TASClient/PreferencesFormUnit.pas	2010-12-26 15:57:24 UTC (rev 7562)
+++ Lobby/TASClient/PreferencesFormUnit.pas	2011-01-04 00:40:03 UTC (rev 7563)
@@ -47,6 +47,7 @@
 
     ConnectOnStartup: Boolean;
 
+    SortAsc: Boolean;
     SortStyle: Integer; // 0 - No sorting, 1 - Sort by name, 2 - Sort by status, 3 - Sort by rank, 4 - Sort by country
     BattleSortStyle: Integer; // 0 - Don't sort, 1 - Sort by status (open, full, in-game), 2 - sort by mod, 3 - sort by players, 4 - sort by map, 5 - sort by host, 6 - sort by description
                            // (use BattleSortStyleToColumn/ColumnToBattleSortStyle to transform between battle treeview column index and battle sort style)
@@ -301,7 +302,7 @@
 
 const
   DEFAULT_PREFERENCES: TPreferences = (ServerIP:'springrts.com'; ServerPort:'8200'; TabStyle:0; TimeStamps: True; Username:''; Password:'';
-                                        RememberPasswords: False; ConnectOnStartup: False; SortStyle: 1; BattleSortStyle: 1; BattleSortDirection: 0;
+                                        RememberPasswords: False; ConnectOnStartup: False; SortAsc: True ;SortStyle: 1; BattleSortStyle: 1; BattleSortDirection: 0;
                                         BattleClientSortStyle: 2;FilterJoinLeftMessages: False;FilterBattleJoinLeftMessages: False; ShowFlags: True;
                                         MarkUnknownMaps: False; TaskbarButtons: True; JoinMainChannel: True; ReconnectToBackup: True; SaveLogs: True;
                                         UseSoundNotifications: True;AutoCompletionFromCurrentChannel: False; AutoUpdateToBeta: False;DisplayUnitsIconsAndNames: False;
@@ -361,6 +362,7 @@
     try Preferences.LadderPassword := Misc.GetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Preferences', 'LadderPassword'); except end;
     try Preferences.ConnectOnStartup := Misc.GetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Preferences', 'ConnectOnStartup'); except end;
     try Preferences.SortStyle := Misc.GetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Preferences', 'SortStyle'); except end;
+    try Preferences.SortAsc := Misc.GetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Preferences', 'SortAsc'); except end;
     try Preferences.BattleSortStyle := Misc.GetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Preferences', 'BattleSortStyle'); except end;
     try Preferences.BattleSortDirection := Misc.GetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Preferences', 'BattleSortDirection'); except end;
     try Preferences.BattleClientSortStyle := Misc.GetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Preferences', 'BattleClientSortStyle'); except end;
@@ -781,6 +783,7 @@
     Misc.SetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Preferences', 'UseLogonForm', rdInteger, Misc.BoolToInt(Preferences.UseLogonForm));
     Misc.SetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Preferences', 'ConnectOnStartup', rdInteger, Misc.BoolToInt(Preferences.ConnectOnStartup));
     Misc.SetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Preferences', 'SortStyle', rdInteger, Preferences.SortStyle);
+    Misc.SetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Preferences', 'SortAsc', rdInteger, Preferences.SortAsc);
     Misc.SetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Preferences', 'BattleSortStyle', rdInteger, Preferences.BattleSortStyle);
     Misc.SetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Preferences', 'BattleSortDirection', rdInteger, Preferences.BattleSortDirection);
     Misc.SetRegistryData(HKEY_CURRENT_USER, TASCLIENT_REGISTRY_KEY+'\Preferences', 'BattleClientSortStyle', rdInteger, Preferences.BattleClientSortStyle);
@@ -1389,6 +1392,8 @@
   CheckBox2.Checked := p.ConnectOnStartup;
 
   MainForm.SortPopupMenu.Items[p.SortStyle].Checked := True;
+  MainForm.mnuAscSort.Checked := p.SortAsc;
+  MainForm.SortLabel.ImageIndex := IfThen(p.SortAsc,0,1);
   MainForm.SortLabel.Caption := TSpTBXItem(MainForm.SortPopupMenu.Items[p.SortStyle]).Caption;
   MainForm.VDTBattles.Header.SortColumn := BattleSortStyleToColumn(p.BattleSortStyle);
   if p.BattleSortDirection = 0 then MainForm.VDTBattles.Header.SortDirection := sdAscending else MainForm.VDTBattles.Header.SortDirection := sdDescending;

Modified: Lobby/TASClient/TASClient.dof
===================================================================
--- Lobby/TASClient/TASClient.dof	2010-12-26 15:57:24 UTC (rev 7562)
+++ Lobby/TASClient/TASClient.dof	2011-01-04 00:40:03 UTC (rev 7563)
@@ -113,9 +113,9 @@
 IncludeVerInfo=1
 AutoIncBuild=1
 MajorVer=0
-MinorVer=83
+MinorVer=84
 Release=0
-Build=1190
+Build=1196
 Debug=0
 PreRelease=0
 Special=0
@@ -126,7 +126,7 @@
 [Version Info Keys]
 CompanyName=
 FileDescription=Spring RTS Engine lobby client
-FileVersion=0.83.0.1190
+FileVersion=0.84.0.1196
 InternalName=
 LegalCopyright=
 LegalTrademarks=

Modified: Lobby/TASClient/TASClient.res
===================================================================
(Binary files differ)


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message: <A HREF="002334.html">[Taspring-linux-commit] r7564 - Lobby/TASClient
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2333">[ date ]</a>
              <a href="thread.html#2333">[ thread ]</a>
              <a href="subject.html#2333">[ subject ]</a>
              <a href="author.html#2333">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/taspring-linux-commit">More information about the Taspring-linux-commit
mailing list</a><br>
</body></html>
